<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Pro JW (V21 - Box Mode Fix)</title>
    <style>
        :root { --primary: #3498db; --success: #27ae60; --dark: #2c3e50; --bg: #f4f4f9; --pergunta: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: var(--bg); overflow: hidden; }
        .tabs-bar { display: flex; flex-wrap: wrap; background: #ddd; padding: 5px; gap: 3px; border-bottom: 2px solid #bbb; overflow-y: auto; max-height: 120px; }
        .tab { padding: 5px 8px; background: #eee; border: 1px solid #aaa; cursor: pointer; font-weight: bold; font-size: 0.7em; border-radius: 3px; min-width: 25px; text-align: center; }
        .tab.active { background: var(--primary); color: white; border-color: var(--dark); }
        .tab.has-text { border-bottom: 3px solid #f1c40f; } .tab.has-blocks { border-bottom: 3px solid var(--success); }
        .panel { flex: 1; padding: 15px; display: flex; flex-direction: column; overflow-y: auto; }
        .left { border-right: 2px solid #ddd; max-width: 38%; background: white; }
        .right { background: #f8f9fa; }
        h2 { margin: 0 0 10px 0; font-size: 1.1em; color: var(--dark); }
        label { font-size: 0.7em; font-weight: bold; color: #666; margin-top: 8px; display: block; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { flex: 1; min-height: 150px; resize: none; font-family: monospace; font-size: 0.85em; }
        .block-item { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px; margin-bottom: 6px; display: flex; gap: 10px; align-items: flex-start; }
        .type-pergunta { border-left: 5px solid var(--pergunta); } .type-paragrafo { border-left: 5px solid var(--primary); }
        .type-subtema { border-left: 5px solid var(--dark); background: #f0f4f8; } .type-rodape { border-left: 5px solid #95a5a6; color: #666; font-style: italic; background: #f9f9f9; }
        .page-wrapper { display: flex; flex-direction: column; align-items: center; width: 45px; flex-shrink: 0; }
        .page-input { width: 100%; text-align: center; font-weight: bold; border: 2px solid #ddd; padding: 3px; font-size: 0.8em; }
        .page-input.manual { border-color: var(--success); background: #eafaf1; }
        .badge { font-size: 0.55em; text-transform: uppercase; font-weight: bold; color: #aaa; }
        .content-text { flex: 1; font-size: 0.85em; line-height: 1.4; white-space: pre-wrap; }
        .type-label { font-size: 0.6em; font-weight: 900; text-transform: uppercase; margin-right: 5px; padding: 2px 4px; border-radius: 3px; background: rgba(0,0,0,0.05); }
        .num-tag { background: #333; color: white; padding: 1px 5px; border-radius: 4px; font-size: 0.75em; margin-right: 5px; font-weight: bold; }
        .num-tag-sub { background: #8e44ad; color: white; padding: 1px 5px; border-radius: 4px; font-size: 0.75em; margin-right: 5px; font-weight: bold; }
        .num-tag-auto { background: var(--primary); color: white; padding: 1px 5px; border-radius: 4px; font-size: 0.75em; margin-right: 5px; font-weight: bold; border: 1px dashed white; }
        .btn-generate { background: var(--success); height: 50px; font-size: 1.1em; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; }
        #jsonOutput { background: #222; color: #0f0; height: 100px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="panel left">
    <div class="tabs-bar" id="tabsBar"></div>
    <div style="flex:1; display:flex; flex-direction:column; padding-top:10px;">
        <h2 id="editorTitle">Cap√≠tulo 1</h2>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>N¬∫ Cap√≠tulo</label><input type="number" id="chapNum"></div>
            <div style="flex:3"><label>T√≠tulo</label><input type="text" id="chapTitle"></div>
        </div>
        <label>Conte√∫do</label>
        <textarea id="rawInput" placeholder="Cole o texto aqui..."></textarea>
        <label>Sa√≠da JSON:</label>
        <textarea id="jsonOutput" readonly></textarea>
    </div>
</div>

<div class="panel right">
    <h2>Pr√©-visualiza√ß√£o</h2>
    <div id="previewContainer" style="flex:1; overflow-y:auto; border: 1px solid #ddd; padding: 10px; background: #fff;"></div>
    <button class="btn-generate" onclick="finalizeAll()">üèÅ Gerar e Copiar Tudo (JSON)</button>
</div>

<script>
    const TOTAL_CAPS = 50;
    const MIN_PARA_LENGTH = 120; 
    let articles = Array.from({ length: TOTAL_CAPS }, (_, i) => ({ num: i + 1, title: "", raw: "", blocks: [] }));
    let currentIdx = 0;

    function initTabs() {
        const bar = document.getElementById('tabsBar'); bar.innerHTML = '';
        articles.forEach((art, i) => {
            const btn = document.createElement('div');
            const hasText = art.raw.trim().length > 0; const hasBlocks = art.blocks.length > 0;
            btn.className = `tab ${i === currentIdx ? 'active' : ''} ${hasText ? 'has-text' : ''} ${hasBlocks ? 'has-blocks' : ''}`;
            btn.textContent = i + 1; btn.onclick = () => switchTab(i); bar.appendChild(btn);
        });
    }

    function switchTab(newIdx) {
        saveCurrentData(); currentIdx = newIdx;
        const art = articles[currentIdx];
        document.getElementById('chapNum').value = art.num; document.getElementById('chapTitle').value = art.title;
        document.getElementById('rawInput').value = art.raw; document.getElementById('editorTitle').textContent = `Cap√≠tulo ${currentIdx + 1}`;
        initTabs(); renderPreview();
    }

    function saveCurrentData() {
        articles[currentIdx].num = document.getElementById('chapNum').value;
        articles[currentIdx].title = document.getElementById('chapTitle').value;
        articles[currentIdx].raw = document.getElementById('rawInput').value;
        if (articles[currentIdx].raw.trim() !== "") autoProcess(currentIdx);
    }

    function autoProcess(idx) {
        const raw = articles[idx].raw;
        let tempBlocks = []; let isFootnote = false; let subCounter = 0;
        let lastParaNum = 0; let paragraphsFound = 0;
        let isInsideBox = false;

        raw.split(/\n+/).forEach(line => {
            let txt = line.trim(); if (!txt) return;
            
            // Ativa modo rodap√©
            if (txt.toLowerCase().includes('[nota') || txt.toLowerCase().includes('[rodap√©]')) { isFootnote = true; return; }

            // DETE√á√ÉO DE QUADRO (BOX MODE)
            // Se o texto for "PRINC√çPIOS DA B√çBLIA", "RESUMO" ou similar, entramos no modo quadro
            const boxHeaders = ["PRINC√çPIOS DA B√çBLIA", "RESUMO", "COMO RESPONDERIA?", "QUADRO", "ENTENDA MELHOR"];
            if (boxHeaders.some(h => txt.toUpperCase().includes(h))) { isInsideBox = true; }

            let type = '', cleanText = txt, numberRef = null, isInferred = false;

            if (isFootnote) {
                type = 'rodape'; 
                const noteMatch = txt.match(/^(\d+)\.\s+(.*)/);
                if (noteMatch) { numberRef = noteMatch[1]; cleanText = noteMatch[2]; }
            } else {
                const qMatch = txt.match(/^(\d+[\d\s\.,\-\(a-z\)]*?\.)\s+(.*)/);
                const pMatch = txt.match(/^(\d+)\s+(.*)/);

                // Se detetar um "1 " ou "1. " e j√° tivermos muitos par√°grafos, √© um reset (Box detectado)
                if ((qMatch || pMatch) && paragraphsFound > 10) {
                    const num = parseInt((qMatch ? qMatch[1] : pMatch[1]).match(/\d+/)[0]);
                    if (num === 1) isInsideBox = true;
                }

                if (isInsideBox) {
                    // DENTRO DO QUADRO: Tudo √© subtema, mesmo que comece com n√∫mero
                    type = 'subtema'; subCounter++; numberRef = subCounter.toString();
                } else if (qMatch) {
                    type = 'pergunta'; numberRef = qMatch[1].replace(/\.$/, ''); cleanText = qMatch[2];
                } else if (pMatch) {
                    type = 'paragrafo'; numberRef = pMatch[1]; cleanText = pMatch[2];
                    lastParaNum = parseInt(pMatch[1]); paragraphsFound++;
                } else {
                    const isCitation = txt.startsWith('‚Äú') || txt.startsWith('"') || txt.includes(' ‚Äî ');
                    if (!isCitation && txt.length > MIN_PARA_LENGTH && paragraphsFound === 0) {
                        type = 'paragrafo'; numberRef = "1"; isInferred = true; paragraphsFound++; lastParaNum = 1;
                    } else if (!isCitation && txt.length > MIN_PARA_LENGTH && paragraphsFound > 0) {
                        // Se j√° come√ß√°mos os par√°grafos, continua a numera√ß√£o
                        type = 'paragrafo'; paragraphsFound++; numberRef = paragraphsFound.toString(); isInferred = true;
                    } else {
                        type = 'subtema'; subCounter++; numberRef = subCounter.toString();
                    }
                }
            }
            tempBlocks.push({ type, text: cleanText, number: numberRef, inferred: isInferred });
        });
        articles[idx].blocks = tempBlocks;
    }

    function renderPreview() {
        const container = document.getElementById('previewContainer'); container.innerHTML = '';
        const blocks = articles[currentIdx].blocks;
        if (blocks.length === 0) return;
        blocks.forEach((block, index) => {
            const div = document.createElement('div'); div.className = `block-item type-${block.type}`;
            let numTag = block.number ? `<span class="${block.type==='subtema'?'num-tag-sub':(block.inferred?'num-tag-auto':'num-tag')}">${block.type==='subtema'?'ST':''}${block.number}</span>` : '';
            div.innerHTML = `<div class="page-wrapper"><span class="badge">P√ÅG</span><input type="text" class="page-input" id="p-${index}" value="${block.manualPage || ''}" oninput="articles[currentIdx].blocks[${index}].manualPage = this.value; updateCascading();"></div><div class="content-text"><span class="type-label">${block.type}</span>${numTag} ${block.text}</div>`;
            container.appendChild(div);
        });
        updateCascading();
    }

    function updateCascading() {
        let last = "";
        articles[currentIdx].blocks.forEach((_, i) => {
            const input = document.getElementById(`p-${i}`); if (!input) return;
            if (input.value.trim() !== "") { last = input.value.trim(); input.classList.add('manual'); }
            else { input.classList.remove('manual'); input.placeholder = last || "‚¨á"; }
        });
    }

    function finalizeAll() {
        saveCurrentData();
        const finalExport = articles.filter(art => art.raw.trim() !== "").map(art => {
            let currentPg = null;
            const conteudo = art.blocks.map(b => {
                if (b.manualPage) currentPg = parseInt(b.manualPage);
                return { tipo: b.type, texto: b.text, pagina: currentPg, numero_ref: b.number };
            });
            return { capitulo: parseInt(art.num), titulo: art.title, conteudo: conteudo };
        });
        const jsonStr = JSON.stringify(finalExport, null, 4);
        document.getElementById('jsonOutput').value = jsonStr;
        navigator.clipboard.writeText(jsonStr).then(() => { alert("JSON de todos os cap√≠tulos copiado!"); });
    }
    initTabs();
</script>
</body>
</html>
