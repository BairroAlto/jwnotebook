<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca - NotaBook</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczPH9OhQSJZR7u-h_UGu-_iJzdj7gWv6TYb5aUWISpPJ9ytdkeqRo1cr-VwNnKLThljiM_iv3KlSU9qfj7icHOhGI8Ehaq6Z2VX9rJC8B1Xqmk7Lthcq8y8V9w37yZ7G-ayEhKUnO4aW4gSEk7Fv1HiQ=w582-h461-s-no-gm?authuser=4">

<style>
   :root {
        --bg-color: #000000;
        --tile-color: #252528;
        --text-color: #ffffff;
        --accent-color: #3498db;
        --border-color: #333;
        --text-size-pct: 100%; 
        --panel-color: #1f1f22;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        height: 45px;
        flex-shrink: 0;
        z-index: 100;
    }

    #back-btn { background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; margin-right: 15px; }
    #page-title { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; flex-grow: 1; text-align: center; }

    #main-layout { flex: 1; overflow: hidden; position: relative; display: flex; }
    
    /* Contentor de Leitura */
    .container { 
        flex: 1; 
        overflow-y: auto; 
        padding: 15px; 
        transition: width 0.3s ease;
    }
    
    .section-title { font-size: 0.75rem; font-weight: 800; color: #888; margin: 20px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; }

    /* --- GRELHA --- */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding-bottom: 40px; }
    
    .pub-card {
        background-color: var(--tile-color);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        aspect-ratio: 2/2.5;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; padding: 15px; border-top: 4px solid var(--accent-color);
    }
    .pub-card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
    .pub-card.type-pub { border-top-color: #9b59b6; }
    .pub-title { font-size: 0.9rem; font-weight: bold; color: #e0e0e0; line-height: 1.3; }

    /* --- CAP√çTULOS --- */
    .chapter-list { display: flex; flex-direction: column; gap: 8px; }
    .chapter-item {
        background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #333;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .chapter-item:hover { border-color: var(--accent-color); }
    .chapter-item b { color: var(--accent-color); margin-right: 10px; }

    /* --- LEITOR & TEXTO --- */
    .reader-content {
        max-width: 800px; margin: 0 auto; font-size: var(--text-size-pct); line-height: 1.7;
        /* Permitir sele√ß√£o */
        user-select: text !important; -webkit-user-select: text !important;
    }
    
    /* Blocos de texto */
    .block-paragrafo, .block-pergunta, .block-subtema, .block-rodape {
        position: relative;
        user-select: text !important; -webkit-user-select: text !important;
    }

    .block-subtema { color: var(--accent-color); font-size: 1.4em; font-weight: bold; margin: 30px 0 15px 0; }
    .block-pergunta { color: #e67e22; font-weight: bold; background: rgba(230, 126, 34, 0.05); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .block-paragrafo { margin-bottom: 15px; text-align: justify; color: #ccc; }
    .block-rodape { color: #888; font-size: 0.85em; opacity: 0.6; font-style: italic; margin-top: 10px; padding: 5px 10px; border-left: 1px solid #444; text-align: left; }

    /* N√∫mero do Par√°grafo */
 .ref-num {
    display: inline-block;
    color: #ffffff; /* Branco por defeito */
    font-size: 0.75em;
    font-weight: 800;
    margin-right: 8px;
    border: 1px solid #444; /* Borda cinza discreta */
    padding: 0 5px;
    border-radius: 3px;
    transition: all 0.3s ease;
    cursor: default;
    user-select: none;
}
    
    /* N√∫mero com dados associados */
.ref-num.has-data {
    color: #3498db !important; /* Azul */
    border-color: #3498db !important;
    background: rgba(52, 152, 219, 0.1);
    cursor: pointer;
    text-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
}

.ref-num.has-data:hover {
    background: rgba(52, 152, 219, 0.2);
    transform: scale(1.1);
}

    /* --- DESTAQUES (Picotado) --- */
    .highlight-picotado {
        background-image: linear-gradient(to right, var(--accent-color) 50%, transparent 50%);
        background-position: bottom; background-size: 6px 3px; background-repeat: repeat-x;
        padding-bottom: 2px; text-decoration: none !important;
        cursor: pointer; position: relative; z-index: 1;
    }
    
    /* --- BARRA FLUTUANTE DE SELE√á√ÉO --- */
    #selection-toolbar {
        position: absolute; z-index: 9999; background-color: #252528; border: 1px solid #444;
        border-radius: 8px; padding: 5px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        gap: 10px; align-items: center;
    }
    #selection-toolbar button {
        background: #333; border: none; color: #fff; padding: 6px 12px; border-radius: 4px;
        cursor: pointer; font-size: 0.9rem;
    }
    #selection-toolbar button:hover { background: var(--accent-color); }

    @media (max-width: 768px) {
        #selection-toolbar {
            position: fixed !important; top: auto !important; bottom: 20px !important;
            left: 50% !important; transform: translateX(-50%) !important; width: 90%; justify-content: center;
        }
    }

    /* --- PAINEL LATERAL (4¬™ COLUNA) --- */
    #side-panel {
        width: 0; background-color: #1f1f22; border-left: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        transition: width 0.3s ease; flex-shrink: 0; z-index: 1000;
        position: relative;
    }
    #side-panel.open { width: 400px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
    
    @media (max-width: 768px) {
        #side-panel {
            position: fixed; bottom: 0; left: 0; right: 0; top: auto;
            width: 100vw !important; height: 0; border-radius: 20px 20px 0 0;
            transition: height 0.3s ease;
        }
        #side-panel.open { height: 75vh; width: 100vw !important; }
    }

    .side-header {
        padding: 10px 15px; border-bottom: 1px solid #333; display: flex;
        justify-content: space-between; align-items: center; background: #252528;
    }
    .side-content { flex: 1; overflow-y: auto; padding: 15px; }

    /* Card no Painel */
    .detail-card {
        background: rgba(255,255,255,0.03); border: 1px solid #333;
        border-radius: 4px; padding: 12px; margin-bottom: 10px;
        font-size: 0.95rem; line-height: 1.5; color: #ddd;
    }

    /* --- MODAL NOTA FLASH --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 11000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 500px; border-radius: 8px;
        border: 1px solid #333; padding: 15px; display: flex; flex-direction: column;
    }
    .flash-editor {
        min-height: 100px; background: rgba(0,0,0,0.2); border: 1px solid #333;
        padding: 10px; color: #fff; margin-bottom: 10px; white-space: pre-wrap;
    }
    
    /* Seletor de Cores */
    .color-picker-container { display: flex; gap: 8px; margin-bottom: 15px; }
    .color-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-btn.selected { border-color: white; transform: scale(1.1); }

    /* Loader */
    #global-auth-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; }
    .global-spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* --- ESTILOS DA TOOLBAR FLASH (Igual √† B√≠blia) --- */
.flash-toolbar {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
}

.flash-toolbar button {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.flash-toolbar button:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Dropdown √† direita */
#flash-type-select {
    margin-left: auto; /* Empurra para a direita */
    background: #252528;
    color: #fff;
    border: 1px solid #444;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    outline: none;
    cursor: pointer;
}

/* Bolas de Cor */
.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px;
    overflow-x: auto;
}

.color-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-btn:hover { transform: scale(1.1); }
.color-btn.selected { border-color: white; transform: scale(1.2); }

/* --- ESTILOS DO MODAL DE LINKS & CODEX --- */
.codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.serie-wrapper {
    flex: 1;
}

.codex-label {
    display: block;
    font-size: 0.7rem;
    font-weight: bold;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.codex-input-modern {
    width: 100%;
    background: #151515;
    border: 1px solid #444;
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    outline: none;
}
.codex-input-modern:focus { border-color: var(--accent-color); }

.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
}

.pages-container, .paragraphs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    min-height: 30px;
}

/* Chips (P√≠lulas) de n√∫meros */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: #333;
    border: 1px solid #555;
    border-radius: 15px;
    padding: 2px 8px;
    font-size: 0.85rem;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: white;
    width: 35px;
    text-align: center;
    outline: none;
    font-family: monospace;
}

.btn-unit-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-weight: bold;
    margin-left: 2px;
    padding: 0 4px;
}

/* Bot√£o Redondo (+) */
.btn-unit-add {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px dashed #666;
    color: #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-unit-add:hover {
    background: var(--accent-color);
    color: white;
    border-style: solid;
}

.remove-codex-row {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
}
.remove-codex-row:hover { opacity: 1; }

/* Contexto da Refer√™ncia */
#flash-links-context {
    background: rgba(52, 152, 219, 0.1);
    border-left: 4px solid #3498db;
    padding: 8px 12px;
    margin-bottom: 15px;
    color: #ddd;
    font-size: 0.9rem;
    border-radius: 0 4px 4px 0;
}

/* --- ESTILOS DE NAVEGA√á√ÉO DE CAP√çTULOS --- */
.nav-arrow {
    background: none;
    border: none;
    color: #888;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 10px;
    transition: color 0.2s, transform 0.2s;
    vertical-align: middle;
}
.nav-arrow:hover {
    color: var(--accent-color);
    transform: scale(1.2);
}


.nav-cap-btn {
    background-color: #333;
    color: #ccc;
    border: 1px solid #444;
    padding: 10px 0;
    text-align: center;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9rem;
}
.nav-cap-btn:hover { background-color: #444; color: white; }
.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Estilo para o t√≠tulo da publica√ß√£o no corpo */
.pub-body-title {
    font-size: 1.2rem;
    font-weight: 800;
    color: #888;
    text-align: center;
    margin-bottom: 5px;
}

/* Navega√ß√£o secund√°ria (abaixo do t√≠tulo) */
.secondary-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.secondary-nav .nav-arrow {
    font-size: 1.4rem;
    color: #888;
}

.secondary-nav span {
    font-size: 1.1rem;
    color: #eee;
    cursor: pointer;
    border-bottom: 1px dotted #555;
}

/* T√≠tulo do Cap√≠tulo em Azul (Imagem 2) */
.reader-chapter-title {
    color: #3498db; /* Azul da sua paleta */
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 25px;
    line-height: 1.2;
    text-align: left; /* Alinhado √† esquerda como na imagem */
}

/* Ajuste no t√≠tulo do livro (cinza em cima) */
.pub-body-title {
    font-size: 1rem;
    font-weight: 800;
    color: #777;
    text-align: left;
    margin-bottom: 8px;
    text-transform: none;
}

/* --- PAINEL DE NAVEGA√á√ÉO DE CAP√çTULOS --- */
#chapter-nav-panel {
    position: fixed;
    top: 50px; /* Logo abaixo do header */
    left: 50%;
    transform: translateX(-50%);
    width: 95%;
    max-width: 500px;
    background-color: #1f1f22;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.9);
    z-index: 10000; /* Acima de tudo */
    padding: 12px;
    
    display: none; /* Escondido por padr√£o */
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 8px;
    
    max-height: 60vh;
    overflow-y: auto;
}

/* Estilo dos bot√µes de n√∫meros dentro do painel */
.nav-cap-btn {
    background-color: #333;
    color: #ccc;
    border: 1px solid #444;
    padding: 12px 0;
    text-align: center;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.95rem;
    transition: all 0.2s;
}

.nav-cap-btn:hover {
    background-color: #444;
    color: white;
}

.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Classe utilit√°ria para esconder */
.hidden { display: none !important; }

/* Estilo do sublinhado picotado (Destaque) */
.highlight-picotado {
    background-position: bottom;
    background-size: 6px 3px;
    background-repeat: repeat-x;
    padding-bottom: 2px;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
    text-decoration: none !important;
    display: inline;
    cursor: pointer;
    position: relative;
    z-index: 1;
}

.ref-num {
    cursor: pointer !important; /* Todos s√£o clic√°veis agora */
    transition: all 0.2s ease;
}

.ref-num:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #666;
}

/* Estilo do bot√£o +üìù dentro do painel */
.btn-panel-create {
    background: var(--accent-color);
    border: none;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85rem;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
}

.btn-panel-create:hover {
    background: #2980b9;
    transform: scale(1.05);
}

/* Bot√£o Compacto no Cabe√ßalho */
.btn-header-create {
    background: linear-gradient(135deg, #3498db, #2980b9);
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.8rem;
    cursor: pointer;
    margin-left: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    /* Anima√ß√£o de Brilho */
    animation: pulse-glow-blue 2s infinite;
    transition: transform 0.2s;
}

.btn-header-create:hover {
    transform: scale(1.1);
}

/* Anima√ß√£o do Brilho (Glow) */
@keyframes pulse-glow-blue {
    0% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
    50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
    100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
}

/* Ajuste no Header do Painel Lateral para alinhar tudo */
.side-header {
    padding: 10px 15px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center; /* Alinha verticalmente t√≠tulo, bot√£o e fechar */
    background: #252528;
}

#side-title-container {
    display: flex;
    align-items: center;
    flex-grow: 1; /* Empurra o bot√£o 'x' para a ponta direita */
}

/* Ajuste do formul√°rio quando dentro do painel lateral */
.side-content .flash-editor {
    min-height: 200px;
    font-size: 0.9rem;
}

.side-content .flash-toolbar {
    flex-wrap: wrap; /* Permite que os bot√µes quebrem linha se o painel for estreito */
}

/* Esconder o t√≠tulo original do painel quando em modo de edi√ß√£o no PC */
.editing-mode #side-title-container {
    display: none;
}

.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px 2px;
    overflow-x: auto; /* Permite deslizar para o lado se n√£o couber */
    scrollbar-width: none; /* Esconde scrollbar no Firefox */
}
.color-picker-container::-webkit-scrollbar {
    display: none; /* Esconde scrollbar no Chrome/Safari */
}

.color-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0; /* Impede que as bolas fiquem ovais */
    border: 2px solid transparent;
    transition: transform 0.2s;
}
.color-btn.selected {
    border-color: white;
    transform: scale(1.2);
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

/* --- INPUT DE T√çTULO PROFISSIONAL --- */
.flash-input-title {
    width: 100%;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid #444 !important; /* Linha fina do Bible */
    color: #e67e22 !important; /* Cor laranja de estudo */
    font-size: 1.2rem !important;
    font-weight: bold !important;
    margin-bottom: 15px !important;
    padding: 5px 0 !important;
    outline: none !important;
}

.flash-input-title::placeholder {
    color: #444;
}

/* --- DESIGN DE LINKS INTEGRADO --- */
.flash-url-row, .codex-row {
    background: rgba(0,0,0,0.2) !important;
    border: 1px solid #333 !important;
    border-radius: 4px !important;
    padding: 8px !important;
    margin-bottom: 10px !important;
    display: flex;
    align-items: center;
    gap: 10px;
}

.flash-url-row input, .codex-input-modern {
    background: transparent !important;
    border: none !important;
    color: #fff !important;
    outline: none !important;
    font-size: 0.9rem !important;
    flex: 1;
}

/* Bot√£o de fechar/remover nos links */
.btn-remove-row {
    background: none !important;
    border: none !important;
    color: #e74c3c !important;
    font-weight: bold !important;
    cursor: pointer !important;
    font-size: 1.2rem !important;
}

/* --- ABAS (TABS) DESIGN BIBLE.HTML --- */
.store-tabs-header {
    display: flex;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    padding: 0 5px;
}

.store-tab-btn {
    flex: 1;
    background: none;
    border: none;
    color: #666;
    padding: 12px 0;
    font-size: 0.85rem;
    font-weight: bold;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.store-tab-btn.active {
    color: #fff;
    border-bottom-color: var(--accent-color);
}

/* --- INPUTS E LINHAS (URL / CODEX) --- */
.flash-url-row, .codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.flash-url-row input, .codex-input-modern {
    background: #111 !important;
    border: 1px solid #333 !important;
    color: white !important;
    padding: 8px 12px !important;
    border-radius: 4px !important;
    font-size: 0.9rem !important;
    outline: none;
}

/* --- CODEX AVAN√áADO (BOT√ïES A, M, T, C) --- */
.manual-controls {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.btn-control-small {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: bold;
}

.btn-control-small.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Toggle Switch (Interruptor) */
.setting-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
}
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #444; transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(16px); }

/* --- ESTILO DO TOGGLE SWITCH (BIBLE STYLE) --- */
.setting-switch {
    position: relative;
    display: inline-block;
    width: 38px;
    height: 20px;
    flex-shrink: 0;
}

.setting-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #333;
    transition: .3s;
    border-radius: 20px;
    border: 1px solid #444;
}

.slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 2px;
    bottom: 2px;
    background-color: #777;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

input:checked + .slider:before {
    transform: translateX(18px);
    background-color: white;
}

/* Pontos de cor na Toolbar */
.color-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.2s;
}
.color-dot:hover { transform: scale(1.3); }

/* Estilo do texto destacado (Sublinhado com cor de fundo) */
.direct-highlight {
    background-color: var(--highlight-bg);
    border-bottom: 2px solid var(--highlight-color);
    padding-bottom: 1px;
    cursor: pointer;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
}

/* Ajuste mobile para a toolbar n√£o estoirar */
@media (max-width: 768px) {
    #selection-toolbar {
        flex-wrap: wrap;
        height: auto !important;
        padding: 10px;
    }
    #toolbar-colors {
        margin-top: 5px;
        width: 100%;
        justify-content: center;
    }
}


</style>


</head>


    <!-- ESCUDO DE CARREGAMENTO INICIAL -->
    <div id="global-auth-shield">
        <div class="global-spinner"></div>
    </div>

    <!-- CABE√áALHO -->
    <header>
        <button id="back-btn">‚¨Ö</button>
        <!-- O t√≠tulo aqui ser√° preenchido via JS com < CAP√çTULO X > -->
        <div id="page-title">Biblioteca</div>
        <div style="width: 30px;"></div>
    </header>

    <div id="main-layout">
        <!-- √ÅREA PRINCIPAL (LEITURA) -->
        <div class="container" id="content-container">
            <!-- Vistas Din√¢micas (Grid Livros, Cap√≠tulos, Texto) -->
        </div>

        <!-- PAINEL LATERAL (NOTAS) -->
  <aside id="side-panel">
    <div class="side-header">
        <div id="side-title-container" style="display: flex; align-items: center; gap: 10px; flex-grow: 1;">
            <span id="side-title" style="color: var(--accent-color); font-weight: bold;">Notas</span>
            <!-- O bot√£o +üìù ser√° injetado aqui via JS -->
        </div>
        <button onclick="window.closeSidePanel()" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;line-height:1;">√ó</button>
    </div>

    <!-- ABAS SEMPRE VIS√çVEIS -->
    <div class="sidebar-tabs" id="library-ref-tabs" style="display: none;">
        <button class="tab-btn active" data-ref-tab="puzzle" title="Quadro">üß©</button>
        <button class="tab-btn" data-ref-tab="links" title="Links">‚ö°</button>
        <button class="tab-btn" data-ref-tab="dossie" title="Micas">üìº</button>
    </div>

    <div class="side-content" id="side-content">
        <!-- Aqui aparece ou o formul√°rio de cria√ß√£o ou a lista de refer√™ncias -->
    </div>
</aside>
    </div>

    <!-- BARRA DE SELE√á√ÉO FLUTUANTE -->
   <div id="selection-toolbar">
    <button id="btn-copy" title="Copiar">üìë</button>
    <button id="btn-flash-note" title="Nota Flash">‚úç</button>
    
    <!-- Separador -->
    <div style="width: 1px; height: 20px; background: #444; margin: 0 5px;"></div>
    
    <!-- Cores de Destaque -->
    <div id="toolbar-colors" style="display: flex; gap: 8px; align-items: center; padding: 0 5px;">
        <div class="color-dot" data-color="#e74c3c" style="background:#e74c3c" title="Vermelho"></div>
        <div class="color-dot" data-color="#e67e22" style="background:#e67e22" title="Laranja"></div>
        <div class="color-dot" data-color="#f1c40f" style="background:#f1c40f" title="Amarelo"></div>
        <div class="color-dot" data-color="#2ecc71" style="background:#2ecc71" title="Verde"></div>
        <div class="color-dot" data-color="#3498db" style="background:#3498db" title="Azul"></div>
        <div class="color-dot" data-color="#9b59b6" style="background:#9b59b6" title="Roxo"></div>
        <div class="color-dot" data-color="#95a5a6" style="background:#95a5a6" title="Cinzento"></div>
        <div class="color-dot" data-color="#8d6e63" style="background:#8d6e63" title="Castanho"></div>
        <button id="btn-remove-highlight" title="Retirar Cor" style="background:none; border:1px solid #666; color:#888; width:22px; height:22px; border-radius:50%; padding:0; font-size:10px; display:flex; align-items:center; justify-content:center;">‚úï</button>
    </div>
</div>


    <!-- MODAL DE CRIA√á√ÉO DE NOTA -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <div style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <button onclick="window.closeFlashModal()" style="background:none; border:none; color:#888; font-size:18px; cursor:pointer; margin-right:10px;">‚¨Ö</button>
                <h3 style="color:#e67e22; margin:0;">Nova Nota</h3>
                <button onclick="window.closeFlashModal()" style="margin-left:auto; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota..." style="font-size:1.2em; margin-bottom:15px;">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')" title="Negrito"><b>B</b></button>
                <button onclick="document.execCommand('italic')" title="It√°lico"><i>I</i></button>
                <button onclick="document.execCommand('underline')" title="Sublinhado"><u>U</u></button>
                <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                <button id="btn-flash-topics" onclick="window.openTopicsModal()" title="T√≥picos">üìã</button>
                <button id="btn-flash-links" onclick="window.openFlashLinkManager()" title="Gest√£o de Links">‚ö°</button>
                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            <div class="color-picker-container" id="color-picker"></div>

            <div style="margin-top: 5px; font-size: 0.8rem; color: #888; display:flex; align-items:center; gap:5px;">
                <span style="font-size:1.2em;">üìö</span> Codex: 
                <span id="flash-codex-info" style="color: #3498db; font-weight:bold;"></span>
            </div>

            <button id="btn-save-flash" onclick="window.saveLibraryFlashNote()" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1rem;">
                GRAVAR NOTA
            </button>
        </div>
    </div>

    <!-- MODAL DE T√ìPICOS -->
    <div id="flash-topics-modal" class="modal-overlay" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
            <div class="side-header">
                <h3>T√≥picos do Bloco</h3>
                <button onclick="document.getElementById('flash-topics-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div style="display: flex; flex: 1; overflow: hidden;">
                <div style="flex: 1; border-right: 1px solid #333; padding: 10px; overflow-y: auto;">
                    <h4 style="color:#e67e22; font-size:0.8rem; margin-bottom:10px;">T√ìPICOS</h4>
                    <ul id="flash-topics-list" style="list-style:none;">Carregando...</ul>
                </div>
                <div style="flex: 1; padding: 10px; overflow-y: auto;">
                    <h4 style="color:#3498db; font-size:0.8rem; margin-bottom:10px;" id="flash-sub-title">SUBT√ìPICOS</h4>
                    <ul id="flash-subtopics-list" style="list-style:none;">
                        <li style="color:#888; font-style:italic;">Selecione um t√≥pico.</li>
                    </ul>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
                <button onclick="document.getElementById('flash-topics-modal').style.display='none'" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LINKS -->
    <div id="flash-links-modal" class="modal-overlay" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
            <div class="side-header">
                <h3>Gest√£o de Links</h3>
                <button onclick="document.getElementById('flash-links-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div style="padding: 15px 15px 0 15px;">
                <div id="flash-links-context"></div>
            </div>
            <div class="store-tabs-header" style="padding: 10px 15px; border-bottom: 1px solid #333; display: flex; gap: 10px;">
                <button class="store-tab-btn active" onclick="window.switchFlashLinkTab('refs')">Refer√™ncias</button>
                <button class="store-tab-btn" onclick="window.switchFlashLinkTab('codex')">Codex</button>
                <button class="store-tab-btn" onclick="window.switchFlashLinkTab('cats')">Categorias</button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 15px;">
                <div id="flash-tab-refs">
                    <input type="text" id="flash-link-title" class="flash-input-title" style="font-size:1rem;" placeholder="T√≠tulo do Grupo...">
                    <div id="flash-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <button onclick="window.addFlashUrlField()" style="margin-top:10px; padding:6px 12px; background:#333; border:1px solid #555; color:#ccc; cursor:pointer; border-radius:4px;">+ Adicionar URL</button>
                </div>
                <div id="flash-tab-codex" style="display:none;">
                    <div id="flash-codex-rows-container"></div>
                    <button onclick="window.createFlashCodexRow()" style="width:100%; margin-top:15px; padding:10px; background:rgba(230, 126, 34, 0.1); border:1px dashed #e67e22; color:#e67e22; cursor:pointer; border-radius:6px;">+ Nova Linha Codex</button>
                </div>
                <div id="flash-tab-cats" style="display:none;">
    
    <!-- Barra de Pesquisa -->
    <div style="margin-bottom: 15px;">
        <label class="codex-label">PESQUISAR T√ìPICO OU LIVRO</label>
        <input type="text" id="flash-cat-search" class="codex-input-modern" 
               placeholder="Ex: Amor, Daniel, Resgate..." 
               oninput="window.searchFlashCategories(this.value)">
    </div>

    <!-- Toggle Switch: Escolher entre T√≥picos ou B√≠blia -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px; padding:10px; background:rgba(255,255,255,0.03); border-radius:6px; border:1px solid #333;">
        <label class="setting-switch">
            <input type="checkbox" id="flash-bible-toggle">
            <span class="slider"></span>
        </label>
        <span style="font-size:0.85rem; color:#ccc; font-weight: 500;">Pesquisar na B√≠blia (Global)</span>
    </div>

    <!-- √Årea de Resultados da Pesquisa -->
    <div id="flash-cat-results" style="max-height:200px; overflow-y:auto; border:1px solid #333; border-radius:6px; background:#111; margin-bottom:20px;">
        <!-- Injetado via JS -->
    </div>

    <!-- √Årea de Itens Selecionados (Chips/P√≠lulas) -->
    <label class="codex-label">VINCULADOS A ESTA NOTA</label>
    <div id="flash-cat-selected" style="display:flex; flex-wrap:wrap; gap:8px; padding-top:5px;">
        <!-- Injetado via JS -->
    </div>
</div>
</div>


    <!-- PAINEL DE NAVEGA√á√ÉO R√ÅPIDA DE CAP√çTULOS (GRELHA) -->
    <div id="chapter-nav-panel" class="hidden"></div>



<script type="module">
import { db, auth } from './js/firebase-config.js';
import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';

// --- ESTADO GLOBAL ---
let currentBookData = null;
let currentPubId = null;   
let currentChapter = null; 
let currentSectionId = null; 
let navStack = [];
let currentFlashTopics = {}; 
let currentFlashLinks = {};
let activeTopicIdForFlash = null;
let currentChapterHighlights = {};

// Estado de Sele√ß√£o e Destaque
let currentSelectionText = "";
let currentSelectedParagraphs = []; 
let selectedColorHex = '#3498db';
let userCustomHighlights = {};


const container = document.getElementById('content-container');


const HIGHLIGHT_COLORS = [
    { name: 'Laranja', hex: '#e67e22' },
    { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' },
    { name: 'Verde', hex: '#2ecc71' },
    { name: 'Rosa', hex: '#ff7979' },
    { name: 'Roxo', hex: '#9b59b6' },
    { name: 'Vermelho', hex: '#e74c3c' },
    { name: 'Vinho', hex: '#822118' },
    { name: 'Castanho', hex: '#8d6e63' },
    { name: 'Cinzento', hex: '#95a5a6' }
];
const SIGLAS_REVISTAS = ['w', 'g', 'mwb', 'km', 'wp'];
const SIGLAS_MULTIMEDIA = ['jwbvod', 'mwbv', 'jwb'];
const MAGAZINE_FOLDERS = {
    'w': 'sentinelas',
    'g': 'despertai',
    'wp': 'sentinelas_publico' // Exemplo caso cries esta pasta
};
// --- CORES PADR√ÉO PARA O SELETOR ---
const DEFAULT_HIGHLIGHTS = [
    { code: "#B12823", name: "Vermelho Tijolo" },
    { code: "#AC4A0B", name: "Laranja Outono" },
    { code: "#D8B200", name: "Amarelo Dourado" },
    { code: "#436C21", name: "Verde Lima" },
    { code: "#006042", name: "Verde Esmeralda" },
    { code: "#1F7AC4", name: "Azul Oceano" },
    { code: "#B53E69", name: "Rosa Suave" },
    { code: "#8438D7", name: "Roxo Ametista" },
    { code: "#A08F8E", name: "Cinza Quente" }
];


// --- 1. INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
onAuthStateChanged(auth, async (user) => {
    const shield = document.getElementById('global-auth-shield');
    if (!user) { window.location.href = "404.html"; return; }

    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().aceite !== "on") { 
            window.location.href = "index.html"; 
            return; 
        }

        if (shield) shield.style.display = 'none';

        // Verifica se h√° par√¢metros no URL para abrir direto um cap√≠tulo
        const params = new URLSearchParams(window.location.search);
        if (params.has('book') && params.has('cap')) {
            const bookId = params.get('book');
            const capNum = params.get('cap');
            const success = await loadPublication('books', bookId);
            if (success) {
                const idx = currentBookData.capitulos.findIndex(c => String(c.capitulo) === String(capNum));
                renderReading(idx !== -1 ? idx : 0, 'books', bookId);
            }
        } else {
            showRoot(); 
        }
    } catch (e) { console.error(e); }
});

// --- 2. CARREGAMENTO DE DADOS ---
async function loadPublication(sectionId, pubId) {
    container.innerHTML = '<div class="global-spinner" style="margin:50px auto;"></div>';
    try {
        currentPubId = pubId;
        const response = await fetch(`./js/${sectionId}/${pubId}.json`);
        if (!response.ok) throw new Error("Erro de rede");
        currentBookData = await response.json();
        return true;
    } catch (e) {
        container.innerHTML = `<p style="text-align:center;color:red;padding:20px;">Erro ao carregar publica√ß√£o.</p>`;
        return false;
    }
}

// --- 3. RENDERIZA√á√ÉO DA LEITURA ---
function renderReading(chapterIdx, sectionId, pubId) {
    // 1. Limpar estados de sele√ß√£o e fechar pain√©is de navega√ß√£o
    hideSelectionToolbar();
    const navPanel = document.getElementById('chapter-nav-panel');
    if (navPanel) { navPanel.style.display = 'none'; navPanel.classList.add('hidden'); }

    const cap = currentBookData.capitulos[chapterIdx];
    if (!cap) return;
    
    // 2. Definir Estado Global Atual
    currentSectionId = sectionId;
    currentPubId = pubId; 
    currentChapter = cap.capitulo;

    // 3. Gerar HTML do Cabe√ßalho de Navega√ß√£o
    const getNavHTML = () => `
        <button class="nav-arrow" onclick="window.changeChapter(-1)">‚ùÆ</button>
        <span onclick="window.toggleChapterNav(event)" style="cursor:pointer; border-bottom: 1px dotted #666;">
            ARTIGO ${currentChapter}
        </span>
        <button class="nav-arrow" onclick="window.changeChapter(1)">‚ùØ</button>
    `;

    // 4. Construir o corpo do texto
    let html = `
        <div class="reader-content" id="reader-area">
            <div class="pub-body-title">${currentBookData.titulo}</div>
            <div class="reader-chapter-title">${cap.titulo}</div>
    `;

    cap.conteudo.forEach(block => {
        const pNum = block.numero_ref;
        const blockId = pNum ? `id="p-${pNum}"` : '';
        const dataAttr = pNum ? `data-pnum="${pNum}"` : '';
        const isCantico = block.texto && block.texto.startsWith("C√ÇNTICO");

        if (block.tipo === 'subtema') {
            html += `<div class="block-subtema">${block.texto}</div>`;
        } 
        else if (block.tipo === 'pergunta') {
            const safeText = encodeURIComponent(block.texto);
            html += `
                <div class="block-pergunta" style="cursor:pointer;" 
                     onclick="window.openQuestionEditor('${block.numero_ref}', decodeURIComponent('${safeText}'))">
                    ${block.texto}
                </div>`;
        }
        else if (block.tipo === 'rodape' || isCantico) {
            const style = isCantico ? 'color:#e67e22; font-weight:bold; border:none; text-align:center;' : '';
            html += `<div class="block-rodape" style="${style}">${block.texto}</div>`;
        }
        else {
            // Par√°grafo Normal com o n√∫mero clic√°vel para abrir o painel lateral
            html += `
                <div ${blockId} ${dataAttr} class="block-paragrafo">
                    ${pNum ? `<span class="ref-num" onclick="window.openSidePanel('${pNum}')">${pNum}</span>` : ''}
                    ${block.texto}
                </div>`;
        }
    });

    html += `</div>`;
    
    // 5. Injetar no DOM
    container.innerHTML = html;
    container.scrollTop = 0;
    
    // 6. Atualizar t√≠tulo no Header
    document.getElementById('page-title').innerHTML = getNavHTML();
    
    // 7. CARREGAMENTO DOS DADOS (Com atraso para garantir renderiza√ß√£o)
    // Isso garante que o navegador j√° criou os elementos ID="p-1" etc antes de pint√°-los
    setTimeout(() => {
        loadLibraryDataForChapter(pubId, currentChapter);
    }, 60);
}

// --- 4. NAVEGA√á√ÉO DE CAP√çTULOS ---

// Navega√ß√£o por setas (‚ùÆ e ‚ùØ)
window.changeChapter = (delta) => {
    if (!currentBookData) return;
    
    const currentIdx = currentBookData.capitulos.findIndex(c => 
        String(c.capitulo || (currentBookData.capitulos.indexOf(c) + 1)) === String(currentChapter)
    );

    const newIdx = currentIdx + delta;

    if (newIdx >= 0 && newIdx < currentBookData.capitulos.length) {
        renderReading(newIdx, currentSectionId, currentPubId);
    }
};

// Abrir/Fechar a Grelha de Cap√≠tulos
window.toggleChapterNav = (event) => {
     hideSelectionToolbar();
    if (event) event.stopPropagation();

    const panel = document.getElementById('chapter-nav-panel');
    
    // Se j√° estiver aberto, fecha
    if (panel.style.display === 'grid') {
        panel.style.display = 'none';
        panel.classList.add('hidden');
        return;
    }

    if (currentBookData && currentBookData.capitulos) {
        panel.innerHTML = '';
        
        // Ajuste de layout din√¢mico: bot√µes largos para "pp. 2-7" e pequenos para "1, 2, 3"
        const isMagazine = currentBookData.capitulos[0].capitulo.toString().includes('p');
        panel.style.gridTemplateColumns = isMagazine 
            ? "repeat(auto-fill, minmax(80px, 1fr))" 
            : "repeat(auto-fill, minmax(45px, 1fr))";

        currentBookData.capitulos.forEach((cap, idx) => {
            const capLabel = cap.capitulo || (idx + 1);
            const btn = document.createElement('div');
            btn.className = 'nav-cap-btn';
            
            // Destaca o atual
            if (String(capLabel) === String(currentChapter)) {
                btn.classList.add('active');
            }
            
            btn.innerText = capLabel;
            
            btn.onclick = () => {
                panel.style.display = 'none';
                panel.classList.add('hidden');
                renderReading(idx, currentSectionId, currentPubId);
            };
            
            panel.appendChild(btn);
        });
        
        panel.classList.remove('hidden');
        panel.style.display = 'grid';
    }
};

// --- FECHAR O PAINEL AO CLICAR FORA ---
window.addEventListener('click', (e) => {
    const panel = document.getElementById('chapter-nav-panel');
    // Se o painel estiver aberto e o clique for fora dele
    if (panel && panel.style.display === 'grid' && !panel.contains(e.target)) {
        panel.style.display = 'none';
        panel.classList.add('hidden');
    }
});


// --- 5. SISTEMA DE SELE√á√ÉO E NOTAS FLASH ---

// Monitorizar sele√ß√£o de texto
document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const toolbar = document.getElementById('selection-toolbar');

    // Se a sele√ß√£o for limpa ou for apenas um clique (colapsada)
    if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.style.display = 'none';
        return;
    }

    const range = selection.getRangeAt(0);
    const text = selection.toString().trim();
    const reader = document.getElementById('reader-area');

    if (reader && reader.contains(range.commonAncestorContainer) && text.length > 5) { 
        currentSelectionText = text;
        
        // Descobrir quais par√°grafos est√£o na sele√ß√£o
        currentSelectedParagraphs = [];
        const paragraphs = document.querySelectorAll('.block-paragrafo');
        paragraphs.forEach(p => {
            const nodeRange = document.createRange();
            nodeRange.selectNode(p);
            const intersects = range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
                               range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
            if (intersects) {
                const pNum = p.getAttribute('data-pnum');
                if (pNum) currentSelectedParagraphs.push(pNum);
            }
        });

        // Posicionar barra flutuante
        const rect = range.getBoundingClientRect();
        if (window.innerWidth <= 768) {
            toolbar.style.position = 'fixed'; toolbar.style.bottom = '20px';
            toolbar.style.left = '50%'; toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.top = 'auto';
        } else {
            toolbar.style.position = 'absolute';
            toolbar.style.top = `${window.scrollY + rect.top - 50}px`;
            toolbar.style.left = `${window.scrollX + rect.left}px`;
            toolbar.style.transform = 'none';
        }
        toolbar.style.display = 'flex';
        } else {
        toolbar.style.display = 'none';
    }
});

// Bot√£o Copiar da barra
document.getElementById('btn-copy').onclick = () => {
    navigator.clipboard.writeText(currentSelectionText);
    document.getElementById('selection-toolbar').style.display = 'none';
};

// Bot√£o Nota Flash da barra
document.getElementById('btn-flash-note').onclick = () => {
    window.openFlashModal();
    document.getElementById('selection-toolbar').style.display = 'none';
};

// Abrir Modal de Nota
window.openFlashModal = () => {
    const modal = document.getElementById('flash-note-modal');
    modal.style.display = 'flex';
    document.getElementById('flash-title').value = '';
    document.getElementById('flash-editor').innerHTML = '';
    
    let codexStr = `${currentPubId} ${currentChapter}`;
    if (currentSelectedParagraphs.length > 0) codexStr += `:${currentSelectedParagraphs.join('-')}`;
    document.getElementById('flash-codex-info').textContent = codexStr;

    // DIFEREN√áA 2: Aqui as cores devem aparecer (para o picotado)
    const picker = document.getElementById('color-picker');
    if (picker) {
        picker.style.display = 'flex';
        renderColorPicker('color-picker'); 
    }
};

window.closeFlashModal = () => {
    document.getElementById('flash-note-modal').style.display = 'none';
};

window.renderColorPicker = (containerId) => {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    
    DEFAULT_HIGHLIGHTS.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.code;
        if (window.selectedColorHex === c.code) btn.classList.add('selected');
        btn.onclick = () => {
            container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            window.selectedColorHex = c.code;
        };
        container.appendChild(btn);
    });
};

// Grava√ß√£o da Nota na Biblioteca
window.saveQuestionAnswer = async (docId, encodedQText) => {
    const btn = document.getElementById('btn-save-question');
    const editor = document.getElementById('flash-editor');
    const qText = decodeURIComponent(encodedQText);
    
    if (btn.disabled) return;
    btn.disabled = true;

    try {
        const { collection, addDoc, doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        const qId = window.activeQuestionId;
        // LIMPEZA: Remove espa√ßos em branco no in√≠cio e fim do HTML
        const content = editor.innerHTML.trim(); 
        const color = window.selectedColorHex || '#2ecc71';
        
        // --- MONTAGEM DO HTML COM O ATRIBUTO DE DESTAQUE ---
        const boxHtml = `
            <div class="mini-note-wrapper question-mode" id="box_${Date.now()}" 
                 data-topics='{}' data-shared="false" data-box-links='{}' 
                 data-highlight="${color}" contenteditable="false">
                <textarea class="mini-note-title-input">${qText}</textarea>
                <div class="mini-note-toolbar" contenteditable="false">
                    <button>üîê</button><div class="toolbar-btn-group"><button>üî∫</button><button>üîª</button></div>
                    <button class="has-links">‚ö°</button><button>üß¨</button><button>üé®</button><button>üìã</button><button>üóëÔ∏è</button>
                </div>
                <div class="mini-note-content" contenteditable="true">${content}</div>
            </div><p><br></p>
        `;

        const noteData = {
            nome: qText,
            conteudo: boxHtml,
            tipo: 'nota',
            oque: 'back',
            qId: qId,
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ultimaedicao: serverTimestamp()
        };

        if (docId && docId !== "null" && docId !== "undefined") {
            await updateDoc(doc(db, 'pastas', docId), noteData);
        } else {
            noteData.createdAt = serverTimestamp();
            await addDoc(collection(db, 'pastas'), noteData);
        }

        btn.textContent = "‚úÖ GUARDADO";
        setTimeout(() => { btn.disabled = false; btn.textContent = "ATUALIZAR RESPOSTA"; }, 2000);
        
        loadLibraryDataForChapter(currentPubId, currentChapter);

    } catch (e) {
        console.error(e);
        btn.disabled = false;
    }
};

// --- 6. GEST√ÉO DE DADOS DO UTILIZADOR (HIGHLIGHTS) ---

async function loadLibraryDataForChapter(pubId, chapter) {
    const capituloId = `${pubId}_${chapter}`;
    const prefix = `${pubId} ${chapter}:`;
    
    // Reset local
    currentChapterHighlights = {}; 

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // 1. Buscar Destaques (Cores s√≥lidas) e Notas (Picotados) em paralelo para ser mais r√°pido
        const [snapCores, snapNotas] = await Promise.all([
            getDocs(query(collection(db, 'trechosbiblicos'), 
                where('userId', '==', auth.currentUser.uid),
                where('capituloId', '==', capituloId))),
            getDocs(query(collection(db, 'livros'), 
                where('userId', '==', auth.currentUser.uid),
                where('nome', '>=', prefix), where('nome', '<=', prefix + '\uf8ff')))
        ]);

        // Processar cores s√≥lidas
        snapCores.forEach(docSnap => {
            const data = docSnap.data();
            data.textosbiblicos.forEach(ref => {
                const pNum = ref.split(':').pop();
                const pId = `p-${pNum}`;
                if (!currentChapterHighlights[pId]) currentChapterHighlights[pId] = [];
                currentChapterHighlights[pId].push({
                    texto: data.nome,
                    cor: data.cor,
                    temNota: (data.noteIds && data.noteIds.length > 0)
                });
            });
        });

        // Processar Notas (Flash Notes)
        snapNotas.forEach(docSnap => {
            const data = docSnap.data();
            const pNum = data.paragrafo;
            const pId = `p-${pNum}`;
            
            if (!currentChapterHighlights[pId]) currentChapterHighlights[pId] = [];
            
            // Se tem puzzleBoard, este par√°grafo tem dados (N√∫mero fica Azul)
            if (data.puzzleBoard && data.puzzleBoard.length > 0) {
                // Marcamos que este par√°grafo espec√≠fico tem dados para o n√∫mero ficar azul
                currentChapterHighlights[pId].hasNoteData = true;

                data.puzzleBoard.forEach(item => {
                    if (item.highlightRef) {
                        currentChapterHighlights[pId].push({
                            texto: item.highlightRef,
                            cor: item.noteColor || '#3498db',
                            temNota: true
                        });
                    }
                });
            }
        });

        // CHAVE DO SUCESSO: Chama a pintura visual
        window.refreshVisualHighlights();

    } catch (e) { 
        console.error("Erro ao carregar dados:", e); 
    }
}

window.applyHighlightToUI = (text, color, refId) => {
    const reader = document.getElementById('reader-area');
    if (!reader) return;
    const paragraphs = reader.querySelectorAll('.block-paragrafo');
    paragraphs.forEach(p => {
        if (p.textContent.includes(text) && !p.innerHTML.includes('highlight-picotado')) {
            const safeText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeText})`, 'g');
            p.innerHTML = p.innerHTML.replace(regex, `<span class="highlight-picotado" style="background-image: linear-gradient(to right, ${color} 50%, transparent 50%);" onclick="window.openSidePanel('${refId}')">$1</span>`);
        }
    });
};

// --- 7. VISTAS DE NAVEGA√á√ÉO DA BIBLIOTECA ---

function showRoot() {
     hideSelectionToolbar();
    navStack = []; 
    container.innerHTML = `
        <h2 class="section-title">Cole√ß√µes</h2>
        <div class="grid">
            <div class="pub-card type-book" onclick="showList('books')">
                <span style="font-size:3em;">üìö</span>
                <span class="pub-title">Livros</span>
            </div>
            <div class="pub-card type-pub" onclick="showList('magazines')">
                <span style="font-size:3em;">üì∞</span>
                <span class="pub-title">Publica√ß√µes & Revistas</span>
            </div>
        </div>
    `;
    updateHeader("Biblioteca", () => window.location.href = "note.html");
}

// N√≠vel 2: Lista de Publica√ß√µes na Sec√ß√£o
// N√≠vel 2: Lista Din√¢mica extra√≠da do siglas-data.js
function showList(category) {
     hideSelectionToolbar();
    navStack.push(() => showRoot());
    const isBooks = category === 'books';
    const title = isBooks ? 'Livros' : 'Publica√ß√µes';
    
    container.innerHTML = `<h2 class="section-title">${title}</h2><div class="grid" id="dynamic-grid"></div>`;
    const grid = document.getElementById('dynamic-grid');

    // Varre o ficheiro siglas-data.js automaticamente
    Object.entries(SIGLAS_PUBLICACOES).forEach(([id, fullName]) => {
        const isMagazine = SIGLAS_REVISTAS.includes(id);
        const isMultimedia = SIGLAS_MULTIMEDIA.includes(id);

        // Ignora multimedia por agora
        if (isMultimedia) return;

        // Filtra: Se escolheu "Livros", s√≥ mostra o que N√ÉO √© revista. 
        // Se escolheu "Publica√ß√µes", mostra apenas as revistas.
        if (isBooks && isMagazine) return;
        if (!isBooks && !isMagazine) return;

        const card = document.createElement('div');
        card.className = `pub-card ${isBooks ? 'type-book' : 'type-pub'}`;
        card.innerHTML = `
            <div style="font-size:0.7em; opacity:0.5; margin-bottom:5px;">${id.toUpperCase()}</div>
            <span class="pub-title">${fullName}</span>
        `;

        card.onclick = () => {
            if (isMagazine) {
                // Fluxo din√¢mico de Revistas (Anos > Meses)
                showYears(id, fullName);
            } else {
                // Fluxo de Livros (Tenta carregar o JSON de /books/ ou /publicacoes/)
                // Primeiro tenta na pasta books, se falhar o loadPublication trata o erro
                loadPublication('books', id).then(ok => { 
                    if(ok) showChapters('books', id); 
                    else {
                        // Tenta na pasta publicacoes se n√£o encontrar em books
                        loadPublication('publicacoes', id).then(ok2 => {
                            if(ok2) showChapters('publicacoes', id);
                        });
                    }
                });
            }
        };
        grid.appendChild(card);
    });

    updateHeader(title, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel 3 (Especial): Sele√ß√£o de Anos para Revistas
function showYears(sigla, fullName) {
    navStack.push(() => showList(sigla === 'w' ? {id:'publicacoes', name:'Publica√ß√µes', color:'type-pub', items:['w','g']} : {id:'publicacoes', name:'Publica√ß√µes'}));
    container.innerHTML = `<h2 class="section-title">${fullName} - Selecionar Ano</h2><div class="grid" id="year-grid"></div>`;
    const grid = document.getElementById('year-grid');

    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= 1950; i--) {
        const card = document.createElement('div');
        card.className = 'pub-card type-pub';
        card.style.aspectRatio = "1/1";
        card.innerHTML = `<span class="pub-title">${i}</span>`;
        card.onclick = () => showMonths(sigla, i);
        grid.appendChild(card);
    }
    updateHeader(fullName, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel 4 (Especial): Sele√ß√£o de Meses
function showMonths(sigla, year) {
    navStack.push(() => showYears(sigla, SIGLAS_PUBLICACOES[sigla]));
    const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    
    container.innerHTML = `<h2 class="section-title">Ano ${year}</h2><div class="grid" id="month-grid"></div>`;
    const grid = document.getElementById('month-grid');

    meses.forEach((mes, idx) => {
        const mesNum = (idx + 1).toString().padStart(2, '0');
        const card = document.createElement('div');
        card.className = 'pub-card type-pub';
        card.style.aspectRatio = "1/1";
        card.innerHTML = `<span class="pub-title">${mes}</span>`;
        card.onclick = () => showArticles(sigla, year, mesNum, mes);
        grid.appendChild(card);
    });
    updateHeader(`Ano ${year}`, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel 5 (Especial): Sele√ß√£o de Artigos (Fetch do JSON din√¢mico)
async function showArticles(sigla, year, mesNum, mesNome) {
    navStack.push(() => showMonths(sigla, year));
    container.innerHTML = '<div class="global-spinner" style="margin:50px auto;"></div>';

    try {
        // 1. Determina a pasta correta no servidor
        const subFolder = MAGAZINE_FOLDERS[sigla] || 'sentinelas';
        const path = `./js/publicacoes/${subFolder}/${year}/${mesNum}.json`;
        
        const response = await fetch(path);
        if (!response.ok) throw new Error("Ficheiro n√£o encontrado");
        const data = await response.json();
        
        const artigos = data.artigos;

        container.innerHTML = `<h2 class="section-title">Artigos de ${mesNome}</h2><div class="chapter-list"></div>`;
        const list = container.querySelector('.chapter-list');

        // 2. Prepara os dados globais da publica√ß√£o
        currentBookData = {
            titulo: `${SIGLAS_PUBLICACOES[sigla]} - ${mesNome}/${year}`,
            capitulos: artigos.map(a => ({
                capitulo: a.referencia.split(' ').pop(), // Ex: "pp. 2-7"
                titulo: a.titulo,
                conteudo: a.conteudo
            }))
        };

        // 3. Gera o ID Complexo para o Firestore (Ex: W24_05)
        const complexId = sigla.toUpperCase() + year.toString().slice(-2) + "_" + mesNum;

        artigos.forEach((art, idx) => {
            const item = document.createElement('div');
            item.className = 'chapter-item';
            item.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <small style="color:#888; font-weight:bold;">${art.referencia}</small>
                    <span style="text-align:left;">${art.titulo}</span>
                </div>
                <span>‚ûî</span>
            `;
            item.onclick = () => {
                // Atualizamos o ID global e abrimos o leitor
                currentPubId = complexId;
                renderReading(idx, 'publicacoes', complexId);
            };
            list.appendChild(item);
        });

    } catch (e) {
        console.error("Erro ao carregar JSON:", e);
        container.innerHTML = `<p style="text-align:center;color:#666;padding:20px;">Ficheiro n√£o encontrado em: <br><small>${year}/${mesNum}.json</small></p>`;
    }
    updateHeader(`${mesNome} ${year}`, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel Final: Lista de Cap√≠tulos para Livros Est√°ticos
function showChapters(sectionId, pubId) {
    navStack.push(() => showList(sectionId === 'books' ? {id:'books', name:'Livros', color:'type-book', items:[]} : {id:'publicacoes', name:'Publica√ß√µes'}));
    
    container.innerHTML = `<h2 class="section-title">Sum√°rio</h2><div class="chapter-list"></div>`;
    const list = container.querySelector('.chapter-list');

    currentBookData.capitulos.forEach((cap, idx) => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.innerHTML = `<span><b>${cap.capitulo || idx+1}</b> ${cap.titulo}</span> <span>‚ûî</span>`;
        item.onclick = () => renderReading(idx, sectionId, pubId);
        list.appendChild(item);
    });
    updateHeader(currentBookData.titulo, () => { const last = navStack.pop(); if (last) last(); });
}

function updateHeader(title, backAction) {
    document.getElementById('page-title').innerHTML = title;
    document.getElementById('back-btn').onclick = backAction;
}



// --- 3. ATUALIZA√á√ÉO DA FUN√á√ÉO OPEN SIDE PANEL (COM FILTRO) ---
window.openSidePanel = async (pNum) => {
    const panel = document.getElementById('side-panel');
    const tabs = document.getElementById('library-ref-tabs');
    const titleContainer = document.getElementById('side-title-container');
    const refName = `${currentPubId} ${currentChapter}:${pNum}`;

    panel.classList.add('open');
    tabs.style.display = 'flex'; 
    
    panel.dataset.currentRef = refName;
    panel.dataset.pNum = pNum;

    // 1. REINJECTAR O BOT√ÉO DE CRIAR NO CABE√áALHO
    titleContainer.innerHTML = `
        <span id="side-title" style="color: var(--accent-color); font-weight: bold;">Par√°grafo ${pNum}</span>
        <button class="btn-header-create" onclick="window.prepareNoteFromPanel('${pNum}')" 
                style="background:var(--accent-color); border:none; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.8rem; margin-left:10px;">
            + üìù
        </button>
    `;

    // 2. Reset visual das abas
    document.querySelectorAll('#library-ref-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-ref-tab="puzzle"]').classList.add('active');

    // 3. Carregar o Quadro por defeito
    window.renderLibraryRefTab('puzzle');
};


// Dentro de saveLibraryFlashNote, ap√≥s o sucesso da grava√ß√£o:
currentSelectedParagraphs.forEach(pNum => {
    const numEl = document.querySelector(`.block-paragrafo[data-pnum="${pNum}"] .ref-num`);
    if (numEl) {
        numEl.classList.add('has-data');
        numEl.onclick = () => window.openSidePanel(pNum);
    }
});


// --- NOVO: Fun√ß√£o para preparar a nota vinda do painel lateral ---
window.prepareNoteFromPanel = (pNum) => {
    const tabs = document.getElementById('library-ref-tabs');
    const content = document.getElementById('side-content');
    const sideTitle = document.getElementById('side-title');

    tabs.style.display = 'none';
    sideTitle.textContent = "Nova Nota";

    currentSelectedParagraphs = [pNum];
    currentSelectionText = ""; 

    content.innerHTML = window.getFlashNoteFormHTML(pNum);

    // DIFEREN√áA 1: Se pNum existe (clique no n√∫mero), N√ÉO renderiza picker de cores
    const picker = document.getElementById('inline-color-picker');
    if (picker) picker.style.display = 'none';
};



window.getFlashNoteFormHTML = (pNum) => {
    const codexStr = `${currentPubId} ${currentChapter}:${pNum}`;
    
    return `
        <div class="note-creation-form" style="padding: 5px;">
            <!-- T√≠tulo id√™ntico ao Bible.html -->
            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="document.execCommand('underline')"><u>U</u></button>
                <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                <button onclick="window.openTopicsModal()">üìã</button>
                <button onclick="window.openFlashLinkManager()">‚ö°</button>
                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            
            <!-- As cores aparecem aqui -->
            <div class="color-picker-container" id="inline-color-picker"></div>

            <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                üîó Anexado a: <span style="color: #3498db; font-weight:bold;">${codexStr}</span>
            </div>

            <button id="btn-save-flash" onclick="window.saveLibraryFlashNote(this)" 
                    style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                GRAVAR NOTA
            </button>
        </div>
    `;
};

// --- GEST√ÉO DE LINKS: DESIGN MAIS LIMPO ---
window.addFlashUrlField = (val = "") => {
    const div = document.createElement('div');
    div.className = 'flash-url-row';
    div.innerHTML = `
        <span style="opacity:0.5;">üîó</span>
        <input type="text" placeholder="https://..." value="${val}">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-urls-list').appendChild(div);
};

// Quando carregar as categorias selecionadas, use o novo design de Chip:
function renderFlashCategoryChip(cat) {
    const container = document.getElementById('flash-cat-selected');
    const chip = document.createElement('div');
    chip.className = 'flash-cat-chip';
    chip.innerHTML = `<span>#</span> ${cat.name} <span style="opacity:0.5; margin-left:5px;">&times;</span>`;
    chip.onclick = () => {
        chip.remove();
        // L√≥gica para remover do array global...
    };
    container.appendChild(chip);
}

// 1. Abrir o Gerenciador de Links com Design Bible
window.openFlashLinkManager = function() {
    const modal = document.getElementById('flash-links-modal');
    modal.style.display = 'flex';
    
    // Contexto visual (Anexado a...)
    const contextDiv = document.getElementById('flash-links-context');
    contextDiv.innerHTML = `<span style="opacity:0.5; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Contexto da Nota</span>
                            <strong style="color:#eee;">${currentPubId} ${currentChapter}:${currentSelectedParagraphs.join(',')}</strong>`;

    // Limpeza e Restaura√ß√£o de Dados
    document.getElementById('flash-urls-list').innerHTML = '';
    document.getElementById('flash-codex-rows-container').innerHTML = '';
    document.getElementById('flash-cat-selected').innerHTML = '';

    // Se houver links salvos, restaura (Exatamente como no Bible)
    if (currentFlashLinks.urls) {
        Object.values(currentFlashLinks.urls).forEach(url => window.addFlashUrlField(url));
    }
    
    if (currentFlashLinks.codex && currentFlashLinks.codex.length > 0) {
        currentFlashLinks.codex.forEach(row => window.createFlashCodexRow(row));
    } else {
        window.createFlashCodexRow(); // Adiciona uma vazia por padr√£o
    }

    window.switchFlashLinkTab('refs');
};

// 2. Criar Linha de Codex Complexa (Design Bible)
window.createFlashCodexRow = function(data = null) {
    const container = document.getElementById('flash-codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    row.innerHTML = `
        <button class="remove-codex-row" onclick="this.parentElement.remove()">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                <div class="manual-controls">
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Ano">A</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="M√™s">M</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Tempo">T</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Cap√≠tulo">C</button>
                </div>
            </div>
        </div>
        <div class="codex-content-grid">
            <div>
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div>
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(row);

    // Preencher unidades se houver dados
    if (data) {
        const pCont = row.querySelector('.pages-container');
        const pgCont = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addFlashCodexUnit(pCont, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addFlashCodexUnit(pgCont, 'Par', p));
    }
};

// 3. Adicionar Unidade (P√≠lula de n√∫mero)
window.addFlashCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.insertBefore(unit, container.lastChild);
};

window.switchFlashLinkTab = (tab) => {
    // 1. Atualizar visual dos bot√µes (abas)
    document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
    
    // Procura o bot√£o que foi clicado ou corresponde √† aba e ativa-o
    const buttons = document.querySelectorAll('.store-tab-btn');
    if(tab === 'refs') buttons[0].classList.add('active');
    if(tab === 'codex') buttons[1].classList.add('active');
    if(tab === 'cats') buttons[2].classList.add('active');

    // 2. Alternar a visibilidade dos pain√©is
    const panels = ['refs', 'codex', 'cats'];
    panels.forEach(p => {
        const el = document.getElementById(`flash-tab-${p}`);
        if (el) el.style.display = 'none';
    });

    const targetPanel = document.getElementById(`flash-tab-${tab}`);
    if (targetPanel) targetPanel.style.display = 'block';
};

// Altera a cor da borda do editor conforme o tipo de nota selecionado
window.changeFlashBorder = (selectElement) => {
    // Procura o editor no documento (funciona tanto no Modal como no Painel Lateral)
    const editor = document.getElementById('flash-editor');
    if (!editor) return;

    const type = selectElement.value;

    if (type === 'question') {
        // Estilo para QUEST√ÉO (Verde)
        editor.style.borderLeft = '4px solid #2ecc71';
        editor.style.backgroundColor = 'rgba(46, 204, 113, 0.05)';
    } else {
        // Estilo para SUBNOTA / PADR√ÉO (Azul)
        editor.style.borderLeft = '4px solid #3498db';
        editor.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
    }
};

// --- SISTEMA DE PESQUISA DE CATEGORIAS (IGUAL AO BIBLE.HTML) ---

window.searchFlashCategories = async (text) => {
    if (text.length < 2) {
        document.getElementById('flash-cat-results').innerHTML = '';
        return;
    }
    
    const searchText = text.toLowerCase();
    const resDiv = document.getElementById('flash-cat-results');
    const isGlobalBible = document.getElementById('flash-bible-toggle').checked;
    
    resDiv.innerHTML = '<div style="padding:10px; color:#888; font-size:0.8rem;">A procurar...</div>';
    
    let resultsArray = [];
    let type = '';

    try {
        if (isGlobalBible) {
            // MODO B√çBLIA: Pesquisa na lista local de livros (BIBLE_DATA deve estar importado)
            type = 'bible_public';
            // BIBLE_DATA √© o array importado no topo do teu script
            const { BIBLE_DATA } = await import('./js/bible-data.js');
            const matches = BIBLE_DATA.filter(b => 
                b.nome.toLowerCase().includes(searchText)
            );
            resultsArray = matches.map(b => ({ id: b.nome, nome: b.nome }));
        } else {
            // MODO T√ìPICOS: Pesquisa no Firestore
            type = 'topic';
            const { collection, query, where, getDocs, limit, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Procura t√≥picos do utilizador atual
            const q = query(
                collection(db, "topicos"),
                where("userId", "==", auth.currentUser.uid),
                where("nome", ">=", text.charAt(0).toUpperCase() + text.slice(1)), // Primeira letra mai√∫scula
                limit(10)
            );
            
            const snap = await getDocs(q);
            snap.forEach(doc => {
                resultsArray.push({ id: doc.id, ...doc.data() });
            });
        }

        // Renderiza√ß√£o dos Resultados
        resDiv.innerHTML = '';
        if (resultsArray.length === 0) {
            resDiv.innerHTML = '<div style="padding:10px; color:#666; font-size:0.8rem;">Sem resultados.</div>';
            return;
        }

        resultsArray.forEach(d => {
            const div = document.createElement('div');
            div.style.cssText = "padding:10px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;";
            
            const icon = type === 'bible_public' ? 'üåç' : 'üè∑Ô∏è';
            div.innerHTML = `<span>${icon} ${d.nome}</span> <button style="background:var(--accent-color); border:none; color:white; border-radius:4px; padding:2px 8px; cursor:pointer;">+</button>`;
            
            div.onclick = () => {
                const catObj = { id: d.id, name: d.nome, type: type };
                window.addFlashCategoryChip(catObj);
                resDiv.innerHTML = '';
                document.getElementById('flash-cat-search').value = '';
            };
            resDiv.appendChild(div);
        });

    } catch(e) { 
        console.error("Erro na pesquisa:", e);
        resDiv.innerHTML = '<div style="padding:10px; color:red;">Erro ao pesquisar.</div>';
    }
};

// Adiciona a "p√≠lula" visual da categoria selecionada
window.addFlashCategoryChip = (cat) => {
    if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
    
    // Evita duplicados
    if (currentFlashLinks.categories.some(c => c.name === cat.name)) return;
    
    currentFlashLinks.categories.push(cat);
    window.renderFlashCategoryChips();
};

// Desenha todos os chips na √°rea de "Selecionados"
window.renderFlashCategoryChips = () => {
    const container = document.getElementById('flash-cat-selected');
    if (!container) return;
    
    container.innerHTML = '';
    const categories = currentFlashLinks.categories || [];
    
    categories.forEach(cat => {
        const chip = document.createElement('div');
        chip.className = 'flash-cat-chip'; // J√° tens o CSS para isto
        chip.innerHTML = `<span>#</span> ${cat.name} <span style="margin-left:8px; opacity:0.5; font-size:1.1rem;">&times;</span>`;
        
        chip.onclick = () => {
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => c.name !== cat.name);
            window.renderFlashCategoryChips();
        };
        
        container.appendChild(chip);
    });
};

function hideSelectionToolbar() {
    const toolbar = document.getElementById('selection-toolbar');
    if (toolbar) {
        toolbar.style.display = 'none';
    }
    // Opcional: Limpa a sele√ß√£o azul do navegador para evitar que a barra volte a aparecer
    // window.getSelection().removeAllRanges();
}

// --- L√ìGICA DE DESTAQUE DIRETO (CORES) ---

// 1. Delegar cliques nas cores da toolbar
document.getElementById('toolbar-colors').addEventListener('click', async (e) => {
    const dot = e.target.closest('.color-dot');
    const removeBtn = e.target.closest('#btn-remove-highlight');

    if (dot) {
        const color = dot.dataset.color;
        await applyDirectHighlight(color);
    } else if (removeBtn) {
        await removeDirectHighlight();
    }
    
    // Esconde a toolbar ap√≥s a a√ß√£o
    document.getElementById('selection-toolbar').style.display = 'none';
});

// Fun√ß√£o para aplicar e salvar o destaque
async function applyDirectHighlight(hexColor) {
    if (!currentSelectionText) return;

    try {
        const { collection, addDoc, query, where, getDocs, updateDoc, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // Criar um ID √∫nico para o cap√≠tulo (ex: W25_12_pp. 2-7)
        const capituloId = `${currentPubId}_${currentChapter}`;

        const q = query(collection(db, 'trechosbiblicos'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '==', currentSelectionText),
            where('capituloId', '==', capituloId) // Busca espec√≠fica
        );
        const snap = await getDocs(q);

        if (!snap.empty) {
            await updateDoc(doc(db, 'trechosbiblicos', snap.docs[0].id), { 
                cor: hexColor,
                ultimaEdicao: serverTimestamp() 
            });
        } else {
            await addDoc(collection(db, 'trechosbiblicos'), {
                userId: auth.currentUser.uid,
                nome: currentSelectionText,
                cor: hexColor,
                capituloId: capituloId, // NOVO CAMPO para facilitar a busca
                textosbiblicos: currentSelectedParagraphs.map(p => `${currentPubId} ${currentChapter}:${p}`),
                createdAt: serverTimestamp()
            });
        }

        loadLibraryDataForChapter(currentPubId, currentChapter);
        window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao destacar:", e);
    }
}

// Fun√ß√£o para remover o destaque do Firebase
async function removeDirectHighlight() {
    if (!currentSelectionText) return;

    try {
        const { collection, query, where, getDocs, deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(collection(db, 'trechosbiblicos'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '==', currentSelectionText)
        );
        const snap = await getDocs(q);

        for (const d of snap.docs) {
            // S√≥ remove se n√£o tiver notas vinculadas (seguran√ßa)
            // Se quiser apagar sempre, retire a condi√ß√£o do if
            if (!d.data().noteIds || d.data().noteIds.length === 0) {
                await deleteDoc(doc(db, 'trechosbiblicos', d.id));
            }
        }

        loadLibraryDataForChapter(currentPubId, currentChapter);
        window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao remover destaque:", e);
    }
}

// --- ATUALIZA√á√ÉO DO MOTOR VISUAL ---
// Vamos modificar o refreshVisualHighlights para suportar este estilo s√≥lido
const originalRefresh = window.refreshVisualHighlights;
window.refreshVisualHighlights = () => {
    const reader = document.getElementById('reader-area');
    if (!reader) return;

    // 1. Limpar estados anteriores dos n√∫meros
    document.querySelectorAll('.ref-num').forEach(num => num.classList.remove('has-data'));

    // 2. Percorrer o mapa de destaques
    for (const [pId, highlights] of Object.entries(currentChapterHighlights)) {
        const paragraphEl = document.getElementById(pId);
        if (!paragraphEl) continue;

        // A. Iluminar o N√∫mero do Par√°grafo (Azul) se houver notas
        if (highlights.hasNoteData) {
            const numEl = paragraphEl.querySelector('.ref-num');
            if (numEl) numEl.classList.add('has-data');
        }

        // B. Aplicar Destaques no Texto (S√≥lido ou Picotado)
        // Usamos um Set para n√£o repetir o mesmo texto no mesmo par√°grafo
        const uniqueHighlights = highlights.filter((v, i, a) => a.findIndex(t => t.texto === v.texto) === i);

        uniqueHighlights.forEach(h => {
            if (!h.texto) return;

            const innerHTML = paragraphEl.innerHTML;
            const escapedText = h.texto.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // Regex melhorada: evita substituir texto dentro de tags HTML j√° criadas
            const regex = new RegExp(`(${escapedText})(?![^<]*>|[^<>]*<\/span>)`, 'gi');

            if (regex.test(innerHTML)) {
                let className = h.temNota ? 'highlight-picotado' : 'direct-highlight';
                let style = h.temNota 
                    ? `background-image: linear-gradient(to right, ${h.cor} 50%, transparent 50%)`
                    : `background-color: ${h.cor}44; border-bottom: 2px solid ${h.cor};`;

                paragraphEl.innerHTML = paragraphEl.innerHTML.replace(regex, 
                    `<span class="${className}" style="${style}" onclick="window.openSidePanel('${paragraphEl.getAttribute('data-pnum')}')">$1</span>`
                );
            }
        });
    }
};


window.removeDirectHighlight = async (specificText = null) => {
    const textToRemove = specificText || currentSelectionText;
    if (!textToRemove) return;

    try {
        const { collection, query, where, getDocs, deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const capituloId = `${currentPubId}_${currentChapter}`;
        const q = query(collection(db, 'trechosbiblicos'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '==', textToRemove),
            where('capituloId', '==', capituloId)
        );
        const snap = await getDocs(q);

        for (const d of snap.docs) {
            // Se tiver notas (picotado), n√£o removemos o registro, apenas a cor
            if (d.data().noteIds && d.data().noteIds.length > 0) {
                const { updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await updateDoc(doc(db, 'trechosbiblicos', d.id), { cor: null });
            } else {
                // Se for s√≥ uma cor simples, apaga o documento
                await deleteDoc(doc(db, 'trechosbiblicos', d.id));
            }
        }

        // Feedback visual e fechar pain√©is
        loadLibraryDataForChapter(currentPubId, currentChapter);
        document.getElementById('side-panel').classList.remove('open');
        window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao remover destaque:", e);
    }
};


// Gestor de Troca de Abas na Biblioteca
document.getElementById('library-ref-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    document.querySelectorAll('#library-ref-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window.renderLibraryRefTab(btn.dataset.refTab);
});

window.renderLibraryRefTab = async function(tab) {
    const tabs = document.getElementById('library-ref-tabs');
    tabs.style.display = 'flex'; // Garante que as abas voltam a aparecer se o user as trocar
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('side-content');
    const refName = panel.dataset.currentRef;
    
    content.innerHTML = '<div style="padding:40px;text-align:center;"><div class="global-spinner"></div></div>';

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(collection(db, 'livros'), where('nome', '==', refName), where('userId', '==', auth.currentUser.uid));
        const snap = await getDocs(q);

        if (snap.empty) {
            content.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5;">Sem dados vinculados.</p>';
            return;
        }

        const data = snap.docs[0].data();
        content.innerHTML = ''; // Limpa o spinner

        // --- RENDERIZAR ABA PUZZLE (QUADRO) ---
        if (tab === 'puzzle') {
            const board = data.puzzleBoard || [];
            if (board.length === 0) content.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5;">Quadro vazio.</p>';
            board.forEach(item => {
                const card = document.createElement('div');
                card.className = 'detail-card';
                card.style.borderLeft = `4px solid ${item.noteColor || '#4a90e2'}`;
                
                // Se for uma refer√™ncia a uma nota, o snippet vem codificado
                let body = item.type === 'text' ? item.content : decodeURIComponent(item.snippet);
                // Limpeza b√°sica para tirar as toolbars de edi√ß√£o que possam vir no HTML
                body = body.replace(/<div class="mini-note-toolbar".*?<\/div>/g, '');

                card.innerHTML = `
                    <small style="color:var(--accent-color); font-weight:bold; display:block; margin-bottom:5px;">${item.noteName || 'Nota'}</small>
                    <div style="font-size:0.9em; line-height:1.4;">${body}</div>
                `;
                content.appendChild(card);
            });
        }

        // --- RENDERIZAR ABA LINKS (DOC.) ---
        else if (tab === 'links') {
            const links = data.panelLinks || [];
            if (links.length === 0) content.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5;">Sem links ou codex.</p>';
            links.forEach(item => {
                const div = document.createElement('div');
                div.className = 'detail-card';
                div.style.borderLeft = item.type === 'codex' ? '4px solid #d35400' : '4px solid #795548';
                
                if (item.type === 'codex') {
                    div.innerHTML = `<strong>üìö ${item.serie}</strong><br><small>${item.total}</small>`;
                } else {
                    const urls = item.urls ? Object.values(item.urls) : [item.url];
                    const linksHTML = urls.map(u => `<div style="color:var(--accent-color); cursor:pointer; margin-top:5px;" onclick="window.open('${u}', '_blank')">üîó ${u}</div>`).join('');
                    div.innerHTML = `<strong>${item.title}</strong>${linksHTML}`;
                }
                content.appendChild(div);
            });
        }

        // --- RENDERIZAR ABA DOSSI√ä (MICAS) ---
        else if (tab === 'dossie') {
            const dossie = data.dossie || [];
            if (dossie.length === 0) content.innerHTML = '<p style="text-align:center; padding:20px; opacity:0.5;">Dossi√™ vazio.</p>';
            
            dossie.forEach(mica => {
                const details = document.createElement('details');
                details.className = 'toggle-section';
                details.style.borderLeft = `4px solid ${mica.color}`;
                details.innerHTML = `
                    <summary><strong style="color:${mica.color}">üìÇ ${mica.name}</strong></summary>
                    <div class="toggle-content">
                        ${mica.items.map(item => `
                            <div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #333;">
                                <small style="color:var(--accent-color); font-weight:bold;">üìÑ ${item.noteName}</small>
                                <div style="font-size:0.85em; opacity:0.8;">${decodeURIComponent(item.snippet).replace(/<div class="mini-note-toolbar".*?<\/div>/g, '')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                content.appendChild(details);
            });
        }

    } catch (e) {
        console.error("Erro ao carregar aba de refer√™ncias:", e);
        content.innerHTML = '<p style="color:red; text-align:center;">Erro de liga√ß√£o.</p>';
    }
};


window.openQuestionEditor = async (qNum, qText) => {
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('side-content');
    const titleContainer = document.getElementById('side-title-container');

    const qId = `${currentPubId}_Q${qNum}`;
    window.activeQuestionId = qId; 
    
    panel.classList.add('open');
    document.getElementById('library-ref-tabs').style.display = 'none';
    
    // Carregar nomes das cores antes de abrir
    await loadUserColorNames();

    titleContainer.innerHTML = `<span style="color:#2ecc71; font-weight:bold;">Pergunta ${qNum}</span>`;

    content.innerHTML = `
        <div class="note-creation-form" style="padding: 10px;">
            <h2 style="font-size:1.1em; color:white; margin-bottom:15px; line-height:1.4;">${qText}</h2>
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="window.toggleQuestionColorGrid()" title="Cores Destaque">üé®</button>
                <button onclick="window.openFlashLinkManager()" title="Links">‚ö°</button>
            </div>

            <!-- Grid de Cores igual ao note.html -->
            <div id="q-color-grid" style="display:none; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #252528; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444;">
                ${window.generateQuestionColorGridHTML()}
            </div>

      <div id="flash-editor" class="flash-editor" contenteditable="true" 
     placeholder="Escreva a sua resposta aqui..."
     style="border-left: 4px solid ${window.selectedColorHex || '#2ecc71'}; min-height:250px; padding:15px; outline:none;"></div>

            <button id="btn-save-question" onclick="window.saveQuestionAnswer('null', '${encodeURIComponent(qText)}')" 
                    style="width:100%; margin-top:20px; padding:15px; background:#2ecc71; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                GRAVAR RESPOSTA
            </button>
        </div>
    `;
};

// Gera o HTML do 3x3 com nomes sincronizados
window.generateQuestionColorGridHTML = () => {
    return DEFAULT_HIGHLIGHTS.map(c => {
        const displayName = userCustomHighlights[c.code] || c.name;
        return `
            <div onclick="window.selectQuestionColor('${c.code}')" style="display:flex; flex-direction:column; align-items:center; cursor:pointer; gap:5px;">
                <div style="width:30px; height:30px; border-radius:50%; background:${c.code}; border:2px solid ${window.selectedColorHex === c.code ? 'white' : 'transparent'}"></div>
                <span style="font-size:10px; text-align:center; color:#888;">${displayName}</span>
            </div>
        `;
    }).join('');
};

window.toggleQuestionColorGrid = () => {
    const grid = document.getElementById('q-color-grid');
    grid.style.display = grid.style.display === 'none' ? 'grid' : 'none';
};

window.selectQuestionColor = (hex) => {
    // Definimos qual √© a cor "b√°sica" para as perguntas
    const COR_BASICA = '#2ecc71'; 

    // Se a cor clicada j√° for a que est√° selecionada, voltamos ao b√°sico
    if (window.selectedColorHex === hex) {
        window.selectedColorHex = COR_BASICA;
    } else {
        // Caso contr√°rio, aplicamos a nova cor
        window.selectedColorHex = hex;
    }

    // Atualiza a borda do editor
    const editor = document.getElementById('flash-editor');
    if (editor) {
        editor.style.borderLeft = `4px solid ${window.selectedColorHex}`;
    }

    // Atualiza o HTML do grid para que a borda branca (indicador de sele√ß√£o) mude de s√≠tio
    const grid = document.getElementById('q-color-grid');
    if (grid) {
        grid.innerHTML = window.generateQuestionColorGridHTML();
    }

    // Fecha o grid ap√≥s a sele√ß√£o (opcional, se preferires que fique aberto retira a linha abaixo)
    window.toggleQuestionColorGrid(); 
};


window.openHighlightModal = () => {
    // Podes reaproveitar o modal de cores existente ou criar um popup simples
    // Para simplificar, vamos disparar o renderColorPicker e mostrar a div
    const picker = document.getElementById('color-picker');
    // Se quiseres que apare√ßa como um modal, usa:
    // document.getElementById('flash-note-modal').style.display = 'flex';
    // Mas o ideal aqui √© um prompt de cores ou abrir o modal de destaques se o tiveres.
    renderColorPicker(); 
    alert("Escolha a cor nas bolas que apareceram em baixo!"); 
    // Ou podes abrir um pequeno overlay s√≥ com as cores.
};


window.openListCategory = async (type, title, contextId = null) => {
    // 1. Monitoriza√ß√£o e Logs de Navega√ß√£o
    console.log(`%cüöÄ [Lists] Abrindo: ${type} | ${title}`, "background: #222; color: #bada55; padding: 2px 5px; font-weight: bold;");
    
    // 2. Gest√£o da Pilha de Navega√ß√£o (Stack) para o bot√£o Voltar
    const lastInStack = listsStack[listsStack.length - 1];
    if (!lastInStack || lastInStack.title !== title) {
        listsStack.push({ type, title, contextId });
    }
    
    if (typeof updateListsHeader === 'function') updateListsHeader();
    
    const ul = document.getElementById('lists-content');
    if (!ul) return;

    // Ativar Spinner de carregamento visual
    ul.innerHTML = `
        <div class="sidebar-loading">
            <div class="spinner"></div>
            <span>A organizar ${title}...</span>
        </div>`;

    const myUid = auth.currentUser.uid;
    const IDs_REVISTAS = ["w", "g", "wp", "km", "mwb"];

    try {
        const { collection, query, where, getDocs, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // ============================================================
        // CASO 1: CONTE√öDO DE ARTIGO (A SENTINELA OU LIVROS)
        // ============================================================
        if (type === 'sentinela-content' || type === 'book-chapter') {
            let artigo;
            let bookTitle = "";
            let mesNum = "";
            let bookId = "";

            if (type === 'sentinela-content') {
                const { ano, mesNum: m, artIdx } = contextId;
                const response = await fetch(`./js/publicacoes/sentinelas/${ano}/${m}.json`);
                const data = await response.json();
                const lista = data.artigos ? data.artigos : [data];
                artigo = lista[artIdx];
                bookTitle = artigo.titulo;
                mesNum = m;
                bookId = 'sentinela';
            } else {
                const { bookId: bId, capIdx } = contextId;
                const response = await fetch(`./js/books/${bId}.json`);
                const data = await response.json();
                artigo = data.capitulos[capIdx];
                bookTitle = data.titulo;
                bookId = bId;
            }

            ul.innerHTML = "";
            const hLi = document.createElement('li');
            hLi.className = 'list-group-header';
            hLi.textContent = bookTitle;
            ul.appendChild(hLi);
            
            let isInsideReview = false; // Deteta se entrou na sec√ß√£o "Como responderia?"

            artigo.conteudo.forEach((bloco) => {
                const li = document.createElement('li');
                let textoOriginal = bloco.texto;

                // A. Aplicar Links B√≠blicos Invis√≠veis (Ghost)
                let textoProcessado = typeof linkifyBibleReferences === 'function' 
                    ? linkifyBibleReferences(textoOriginal) 
                    : textoOriginal;

                // B. Aplicar Destaques (Highlights) vindos da Library
                if (window.currentArticleHighlights && window.currentArticleHighlights.length > 0) {
                    window.currentArticleHighlights.forEach(h => {
                        if (textoProcessado.includes(h.nome)) {
                            const escapedH = h.nome.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            // Regex para n√£o quebrar tags HTML j√° existentes
                            const regH = new RegExp(`(${escapedH})(?![^<]*>|[^<>]*<\/span>)`, 'gi');
                            const style = `background-color: ${h.cor}44; border-bottom: 2px solid ${h.cor};`;
                            textoProcessado = textoProcessado.replace(regH, `<span style="${style}">$1</span>`);
                        }
                    });
                }

                // C. L√≥gica de Renderiza√ß√£o por tipo de bloco
                if (bloco.tipo === 'subtema') {
                    if (textoOriginal.toUpperCase().includes("COMO RESPONDERIA")) isInsideReview = true;
                    li.style.cssText = `padding:20px 10px 5px 10px; font-weight:bold; color:var(--accent-color); font-size:1em; ${isInsideReview ? 'color:#9b59b6; border-bottom:1px solid #9b59b633;' : ''}`;
                    li.innerHTML = textoProcessado;
                    ul.appendChild(li);
                    return;
                }

                if (bloco.tipo === 'cantico') {
                    li.style.cssText = "padding:15px 10px; text-align:center; font-style:italic; color:#e67e22; border-bottom:1px solid #333; cursor:pointer;";
                    li.innerHTML = `üéµ ${textoProcessado}`;
                    li.onclick = () => window.openBookParagraphPanel(bookId, bookTitle, artigo.capitulo || mesNum, "cantico", textoOriginal, true, "üéµ");
                } 
               else if (bloco.tipo === 'pergunta') {
    const safeText = encodeURIComponent(bloco.texto);
    li.className = 'toc-item-row';
    li.style.cssText = "font-size:0.95em; line-height:1.5; padding:12px 10px; border-bottom:1px solid rgba(128,128,128,0.1); cursor:pointer; display:block;";
    li.innerHTML = `<span style="color:#d3869b; font-weight:bold;">${bloco.numero_ref}.</span> ${textoProcessado}`;
    
    // Agora chama o editor especializado
    li.onclick = () => window.openQuestionEditor(bloco.numero_ref, decodeURIComponent(safeText));
}
                else {
                    // --- MODO PAR√ÅGRAFO NORMAL ---
                    li.className = 'toc-item-row';
                    li.style.cssText = "font-size:0.95em; line-height:1.5; padding:12px 10px; border-bottom:1px solid rgba(128,128,128,0.1); cursor:pointer; display:block;";
                    
                    if (isInsideReview) {
                        li.innerHTML = `<span style="color:#9b59b6; font-weight:800; font-size:0.75em; display:block;">RECAPITULA√á√ÉO</span>${textoProcessado}`;
                    } else {
                        li.innerHTML = `<span class="paragraph-badge">pr ${bloco.numero_ref || '?'}</span>${textoProcessado}`;
                    }

                    li.onclick = () => {
                        const primaryRef = bloco.numero_ref ? bloco.numero_ref.split(',')[0].trim() : '0';
                        window.openBookParagraphPanel(bookId, bookTitle, artigo.capitulo || mesNum, primaryRef, textoOriginal, true, bloco.numero_ref);
                    };
                }
                ul.appendChild(li);
            });
            return;
        }

        // ============================================================
        // CASO 2: LISTA DE DESTAQUES (CORES)
        // ============================================================
        if (type === 'destaque') {
            ul.innerHTML = '<li class="list-group-header">Filtrar por Cor</li>';
            const colors = (globalHighlightsCache && Object.keys(globalHighlightsCache).length > 0) 
                ? Object.entries(globalHighlightsCache).map(([name, code]) => ({ name, code }))
                : DEFAULT_HIGHLIGHTS;
            
            colors.forEach(color => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="width:16px; height:16px; background:${color.code}; border-radius:50%; margin-right:12px; border:1px solid rgba(255,255,255,0.2);"></span> ${color.name}`;
                li.onclick = () => window.showHighlightRef(color.code, color.name);
                ul.appendChild(li);
            });
        }

        // ============================================================
        // CASO 3: T√ìPICOS E MARCADORES
        // ============================================================
        else if (type === 'topico' || type === 'marcadores') {
            const coll = type === 'topico' ? 'topicos' : 'marcadores';
            const q = query(collection(db, coll), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            ul.innerHTML = "";
            snap.forEach(docSnap => {
                const li = document.createElement('li');
                const icon = type === 'topico' ? 'üìë' : 'üîñ';
                li.innerHTML = `<span>${icon} ${docSnap.data().nome}</span>`;
                li.onclick = () => {
                    if (type === 'topico') window.showTopicRef(docSnap.id, docSnap.data().nome, 'topico');
                    else window.showMarkerReferencesPanel(docSnap.id, docSnap.data().nome);
                };
                ul.appendChild(li);
            });
        }

        // ============================================================
        // CASO 4: LIVROS (TOC PRINCIPAL)
        // ============================================================
        else if (type === 'livros') {
            ul.innerHTML = '';
            // Artigos da Sentinela
            const liW = document.createElement('li');
            liW.innerHTML = `<span class="list-icon">üìÖ</span> A Sentinela (Anos)`;
            liW.onclick = () => window.openListCategory('sentinela-years', 'Anos da Sentinela', 'w');
            ul.appendChild(liW);

            // Livros est√°ticos do cat√°logo
            Object.keys(SIGLAS_PUBLICACOES).forEach(id => {
                if (!IDs_REVISTAS.includes(id)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="list-icon">üìî</span> ${SIGLAS_PUBLICACOES[id]}`;
                    li.onclick = () => window.openListCategory('book-toc', SIGLAS_PUBLICACOES[id], id);
                    ul.appendChild(li);
                }
            });
        }

        // Fallback para tipos simples (Personagens, Locais, etc.)
        else {
            const coll = ENTITY_CONFIG[type]?.collection;
            if (coll) {
                const q = query(collection(db, coll), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                ul.innerHTML = "";
                snap.forEach(docSnap => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>üîπ ${docSnap.data().nome}</span>`;
                    li.onclick = () => window.showReferencesPanel(docSnap.id, docSnap.data().nome, type);
                    ul.appendChild(li);
                });
            }
        }

    } catch (error) {
        console.error("‚ùå Erro ao renderizar categoria:", error);
        ul.innerHTML = '<li style="color:red; padding:20px; text-align:center;">Erro ao carregar dados.</li>';
    }
};


// Fun√ß√£o para carregar os nomes das cores do Firestore
async function loadUserColorNames() {
    if (!auth.currentUser) return;
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            userCustomHighlights = docSnap.data().colors || {};
        }
    } catch (e) { console.error("Erro ao carregar nomes das cores:", e); }
}





// Fun√ß√µes de T√≥picos e Links (Simplificadas para o exemplo, mantendo as chamadas nos modais)
window.openTopicsModal = () => { document.getElementById('flash-topics-modal').style.display = 'flex'; };
window.openFlashLinkManager = () => { document.getElementById('flash-links-modal').style.display = 'flex'; };
window.closeSidePanel = () => { document.getElementById('side-panel').classList.remove('open'); };
window.showRoot = showRoot;
window.showList = showList;
window.showYears = showYears;
window.showMonths = showMonths;
window.showArticles = showArticles;
window.showChapters = showChapters;
window.loadPublication = loadPublication;
window.changeChapter = changeChapter;
window.toggleChapterNav = toggleChapterNav;
window.renderReading = renderReading;


</script>
</body>
</html>
