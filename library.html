<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca - NotaBook</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczPH9OhQSJZR7u-h_UGu-_iJzdj7gWv6TYb5aUWISpPJ9ytdkeqRo1cr-VwNnKLThljiM_iv3KlSU9qfj7icHOhGI8Ehaq6Z2VX9rJC8B1Xqmk7Lthcq8y8V9w37yZ7G-ayEhKUnO4aW4gSEk7Fv1HiQ=w582-h461-s-no-gm?authuser=4">

<style>
   :root {
        --bg-color: #000000;
        --tile-color: #252528;
        --text-color: #ffffff;
        --accent-color: #3498db;
        --border-color: #333;
        --text-size-pct: 100%; 
        --panel-color: #1f1f22;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        height: 45px;
        flex-shrink: 0;
        z-index: 100;
    }

    #back-btn { background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; margin-right: 15px; }
    #page-title { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; flex-grow: 1; text-align: center; }

    #main-layout { flex: 1; overflow: hidden; position: relative; display: flex; }
    
    /* Contentor de Leitura */
    .container { 
        flex: 1; 
        overflow-y: auto; 
        padding: 15px; 
        transition: width 0.3s ease;
    }
    
    .section-title { font-size: 0.75rem; font-weight: 800; color: #888; margin: 20px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; }

    /* --- GRELHA --- */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding-bottom: 40px; }
    
    .pub-card {
        background-color: var(--tile-color);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        aspect-ratio: 2/2.5;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; padding: 15px; border-top: 4px solid var(--accent-color);
    }
    .pub-card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
    .pub-card.type-pub { border-top-color: #9b59b6; }
    .pub-title { font-size: 0.9rem; font-weight: bold; color: #e0e0e0; line-height: 1.3; }

    /* --- CAP√çTULOS --- */
    .chapter-list { display: flex; flex-direction: column; gap: 8px; }
    .chapter-item {
        background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #333;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .chapter-item:hover { border-color: var(--accent-color); }
    .chapter-item b { color: var(--accent-color); margin-right: 10px; }

    /* --- LEITOR & TEXTO --- */
    .reader-content {
        max-width: 800px; margin: 0 auto; font-size: var(--text-size-pct); line-height: 1.7;
        /* Permitir sele√ß√£o */
        user-select: text !important; -webkit-user-select: text !important;
    }
    
    /* Blocos de texto */
    .block-paragrafo, .block-pergunta, .block-subtema, .block-rodape {
        position: relative;
        user-select: text !important; -webkit-user-select: text !important;
    }

    .block-subtema { color: var(--accent-color); font-size: 1.4em; font-weight: bold; margin: 30px 0 15px 0; }
    .block-pergunta { color: #e67e22; font-weight: bold; background: rgba(230, 126, 34, 0.05); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .block-paragrafo { margin-bottom: 15px; text-align: justify; color: #ccc; }
    .block-rodape { color: #888; font-size: 0.85em; opacity: 0.6; font-style: italic; margin-top: 10px; padding: 5px 10px; border-left: 1px solid #444; text-align: left; }

    /* N√∫mero do Par√°grafo */
 .ref-num {
    display: inline-block;
    color: #ffffff; /* Branco por defeito */
    font-size: 0.75em;
    font-weight: 800;
    margin-right: 8px;
    border: 1px solid #444; /* Borda cinza discreta */
    padding: 0 5px;
    border-radius: 3px;
    transition: all 0.3s ease;
    cursor: default;
    user-select: none;
}
    
    /* N√∫mero com dados associados */
.ref-num.has-data {
    color: #3498db !important; /* Azul */
    border-color: #3498db !important;
    background: rgba(52, 152, 219, 0.1);
    cursor: pointer;
    text-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
}

.ref-num.has-data:hover {
    background: rgba(52, 152, 219, 0.2);
    transform: scale(1.1);
}

    /* --- DESTAQUES (Picotado) --- */
    .highlight-picotado {
        background-image: linear-gradient(to right, var(--accent-color) 50%, transparent 50%);
        background-position: bottom; background-size: 6px 3px; background-repeat: repeat-x;
        padding-bottom: 2px; text-decoration: none !important;
        cursor: pointer; position: relative; z-index: 1;
    }
    
    /* --- BARRA FLUTUANTE DE SELE√á√ÉO --- */
    #selection-toolbar {
        position: absolute; z-index: 9999; background-color: #252528; border: 1px solid #444;
        border-radius: 8px; padding: 5px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        gap: 10px; align-items: center;
    }
    #selection-toolbar button {
        background: #333; border: none; color: #fff; padding: 6px 12px; border-radius: 4px;
        cursor: pointer; font-size: 0.9rem;
    }
    #selection-toolbar button:hover { background: var(--accent-color); }

    @media (max-width: 768px) {
        #selection-toolbar {
            position: fixed !important; top: auto !important; bottom: 20px !important;
            left: 50% !important; transform: translateX(-50%) !important; width: 90%; justify-content: center;
        }
    }

    /* --- PAINEL LATERAL (4¬™ COLUNA) --- */
    #side-panel {
        width: 0; background-color: #1f1f22; border-left: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        transition: width 0.3s ease; flex-shrink: 0; z-index: 1000;
        position: relative;
    }
    #side-panel.open { width: 400px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
    
    @media (max-width: 768px) {
        #side-panel {
            position: fixed; bottom: 0; left: 0; right: 0; top: auto;
            width: 100vw !important; height: 0; border-radius: 20px 20px 0 0;
            transition: height 0.3s ease;
        }
        #side-panel.open { height: 75vh; width: 100vw !important; }
    }

    .side-header {
        padding: 10px 15px; border-bottom: 1px solid #333; display: flex;
        justify-content: space-between; align-items: center; background: #252528;
    }
    .side-content { flex: 1; overflow-y: auto; padding: 15px; }

    /* Card no Painel */
    .detail-card {
        background: rgba(255,255,255,0.03); border: 1px solid #333;
        border-radius: 4px; padding: 12px; margin-bottom: 10px;
        font-size: 0.95rem; line-height: 1.5; color: #ddd;
    }

    /* --- MODAL NOTA FLASH --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 11000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 500px; border-radius: 8px;
        border: 1px solid #333; padding: 15px; display: flex; flex-direction: column;
    }
    .flash-editor {
        min-height: 100px; background: rgba(0,0,0,0.2); border: 1px solid #333;
        padding: 10px; color: #fff; margin-bottom: 10px; white-space: pre-wrap;
    }
    
    /* Seletor de Cores */
    .color-picker-container { display: flex; gap: 8px; margin-bottom: 15px; }
    .color-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-btn.selected { border-color: white; transform: scale(1.1); }

    /* Loader */
    #global-auth-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; }
    .global-spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* --- ESTILOS DA TOOLBAR FLASH (Igual √† B√≠blia) --- */
.flash-toolbar {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
}

.flash-toolbar button {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.flash-toolbar button:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Dropdown √† direita */
#flash-type-select {
    margin-left: auto; /* Empurra para a direita */
    background: #252528;
    color: #fff;
    border: 1px solid #444;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    outline: none;
    cursor: pointer;
}

/* Bolas de Cor */
.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px;
    overflow-x: auto;
}

.color-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-btn:hover { transform: scale(1.1); }
.color-btn.selected { border-color: white; transform: scale(1.2); }

/* --- ESTILOS DO MODAL DE LINKS & CODEX --- */
.codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.serie-wrapper {
    flex: 1;
}

.codex-label {
    display: block;
    font-size: 0.7rem;
    font-weight: bold;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.codex-input-modern {
    width: 100%;
    background: #151515;
    border: 1px solid #444;
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    outline: none;
}
.codex-input-modern:focus { border-color: var(--accent-color); }

.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
}

.pages-container, .paragraphs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    min-height: 30px;
}

/* Chips (P√≠lulas) de n√∫meros */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: #333;
    border: 1px solid #555;
    border-radius: 15px;
    padding: 2px 8px;
    font-size: 0.85rem;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: white;
    width: 35px;
    text-align: center;
    outline: none;
    font-family: monospace;
}

.btn-unit-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-weight: bold;
    margin-left: 2px;
    padding: 0 4px;
}

/* Bot√£o Redondo (+) */
.btn-unit-add {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px dashed #666;
    color: #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-unit-add:hover {
    background: var(--accent-color);
    color: white;
    border-style: solid;
}

.remove-codex-row {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
}
.remove-codex-row:hover { opacity: 1; }

/* Contexto da Refer√™ncia */
#flash-links-context {
    background: rgba(52, 152, 219, 0.1);
    border-left: 4px solid #3498db;
    padding: 8px 12px;
    margin-bottom: 15px;
    color: #ddd;
    font-size: 0.9rem;
    border-radius: 0 4px 4px 0;
}

/* --- ESTILOS DE NAVEGA√á√ÉO DE CAP√çTULOS --- */
.nav-arrow {
    background: none;
    border: none;
    color: #888;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 10px;
    transition: color 0.2s, transform 0.2s;
    vertical-align: middle;
}
.nav-arrow:hover {
    color: var(--accent-color);
    transform: scale(1.2);
}

#chapter-nav-panel {
    position: fixed;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    width: 95%;
    max-width: 500px;
    background-color: #1f1f22;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.9);
    z-index: 2000;
    padding: 10px;
    display: none; /* Controlado via JS */
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 8px;
    max-height: 60vh;
    overflow-y: auto;
}

.nav-cap-btn {
    background-color: #333;
    color: #ccc;
    border: 1px solid #444;
    padding: 10px 0;
    text-align: center;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9rem;
}
.nav-cap-btn:hover { background-color: #444; color: white; }
.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Estilo para o t√≠tulo da publica√ß√£o no corpo */
.pub-body-title {
    font-size: 1.2rem;
    font-weight: 800;
    color: #888;
    text-align: center;
    margin-bottom: 5px;
}

/* Navega√ß√£o secund√°ria (abaixo do t√≠tulo) */
.secondary-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.secondary-nav .nav-arrow {
    font-size: 1.4rem;
    color: #888;
}

.secondary-nav span {
    font-size: 1.1rem;
    color: #eee;
    cursor: pointer;
    border-bottom: 1px dotted #555;
}

/* T√≠tulo do Cap√≠tulo em Azul (Imagem 2) */
.reader-chapter-title {
    color: #3498db; /* Azul da sua paleta */
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 25px;
    line-height: 1.2;
    text-align: left; /* Alinhado √† esquerda como na imagem */
}

/* Ajuste no t√≠tulo do livro (cinza em cima) */
.pub-body-title {
    font-size: 1rem;
    font-weight: 800;
    color: #777;
    text-align: left;
    margin-bottom: 8px;
    text-transform: none;
}

/* --- PAINEL DE NAVEGA√á√ÉO DE CAP√çTULOS --- */
#chapter-nav-panel {
    position: fixed;
    top: 50px; /* Logo abaixo do header */
    left: 50%;
    transform: translateX(-50%);
    width: 95%;
    max-width: 500px;
    background-color: #1f1f22;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.9);
    z-index: 10000; /* Acima de tudo */
    padding: 12px;
    
    display: none; /* Escondido por padr√£o */
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 8px;
    
    max-height: 60vh;
    overflow-y: auto;
}

/* Estilo dos bot√µes de n√∫meros dentro do painel */
.nav-cap-btn {
    background-color: #333;
    color: #ccc;
    border: 1px solid #444;
    padding: 12px 0;
    text-align: center;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.95rem;
    transition: all 0.2s;
}

.nav-cap-btn:hover {
    background-color: #444;
    color: white;
}

.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Classe utilit√°ria para esconder */
.hidden { display: none !important; }

/* Estilo do sublinhado picotado (Destaque) */
.highlight-picotado {
    background-position: bottom;
    background-size: 6px 3px;
    background-repeat: repeat-x;
    padding-bottom: 2px;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
    text-decoration: none !important;
    display: inline;
    cursor: pointer;
    position: relative;
    z-index: 1;
}

.ref-num {
    cursor: pointer !important; /* Todos s√£o clic√°veis agora */
    transition: all 0.2s ease;
}

.ref-num:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #666;
}

/* Estilo do bot√£o +üìù dentro do painel */
.btn-panel-create {
    background: var(--accent-color);
    border: none;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85rem;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
}

.btn-panel-create:hover {
    background: #2980b9;
    transform: scale(1.05);
}

/* Bot√£o Compacto no Cabe√ßalho */
.btn-header-create {
    background: linear-gradient(135deg, #3498db, #2980b9);
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.8rem;
    cursor: pointer;
    margin-left: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    /* Anima√ß√£o de Brilho */
    animation: pulse-glow-blue 2s infinite;
    transition: transform 0.2s;
}

.btn-header-create:hover {
    transform: scale(1.1);
}

/* Anima√ß√£o do Brilho (Glow) */
@keyframes pulse-glow-blue {
    0% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
    50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
    100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
}

/* Ajuste no Header do Painel Lateral para alinhar tudo */
.side-header {
    padding: 10px 15px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center; /* Alinha verticalmente t√≠tulo, bot√£o e fechar */
    background: #252528;
}

#side-title-container {
    display: flex;
    align-items: center;
    flex-grow: 1; /* Empurra o bot√£o 'x' para a ponta direita */
}

/* Ajuste do formul√°rio quando dentro do painel lateral */
.side-content .flash-editor {
    min-height: 200px;
    font-size: 0.9rem;
}

.side-content .flash-toolbar {
    flex-wrap: wrap; /* Permite que os bot√µes quebrem linha se o painel for estreito */
}

/* Esconder o t√≠tulo original do painel quando em modo de edi√ß√£o no PC */
.editing-mode #side-title-container {
    display: none;
}

.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px 2px;
    overflow-x: auto; /* Permite deslizar para o lado se n√£o couber */
    scrollbar-width: none; /* Esconde scrollbar no Firefox */
}
.color-picker-container::-webkit-scrollbar {
    display: none; /* Esconde scrollbar no Chrome/Safari */
}

.color-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0; /* Impede que as bolas fiquem ovais */
    border: 2px solid transparent;
    transition: transform 0.2s;
}
.color-btn.selected {
    border-color: white;
    transform: scale(1.2);
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

/* --- INPUT DE T√çTULO PROFISSIONAL --- */
.flash-input-title {
    width: 100%;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid #444 !important; /* Linha fina do Bible */
    color: #e67e22 !important; /* Cor laranja de estudo */
    font-size: 1.2rem !important;
    font-weight: bold !important;
    margin-bottom: 15px !important;
    padding: 5px 0 !important;
    outline: none !important;
}

.flash-input-title::placeholder {
    color: #444;
}

/* --- DESIGN DE LINKS INTEGRADO --- */
.flash-url-row, .codex-row {
    background: rgba(0,0,0,0.2) !important;
    border: 1px solid #333 !important;
    border-radius: 4px !important;
    padding: 8px !important;
    margin-bottom: 10px !important;
    display: flex;
    align-items: center;
    gap: 10px;
}

.flash-url-row input, .codex-input-modern {
    background: transparent !important;
    border: none !important;
    color: #fff !important;
    outline: none !important;
    font-size: 0.9rem !important;
    flex: 1;
}

/* Bot√£o de fechar/remover nos links */
.btn-remove-row {
    background: none !important;
    border: none !important;
    color: #e74c3c !important;
    font-weight: bold !important;
    cursor: pointer !important;
    font-size: 1.2rem !important;
}

/* --- ABAS (TABS) DESIGN BIBLE.HTML --- */
.store-tabs-header {
    display: flex;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    padding: 0 5px;
}

.store-tab-btn {
    flex: 1;
    background: none;
    border: none;
    color: #666;
    padding: 12px 0;
    font-size: 0.85rem;
    font-weight: bold;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.store-tab-btn.active {
    color: #fff;
    border-bottom-color: var(--accent-color);
}

/* --- INPUTS E LINHAS (URL / CODEX) --- */
.flash-url-row, .codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.flash-url-row input, .codex-input-modern {
    background: #111 !important;
    border: 1px solid #333 !important;
    color: white !important;
    padding: 8px 12px !important;
    border-radius: 4px !important;
    font-size: 0.9rem !important;
    outline: none;
}

/* --- CODEX AVAN√áADO (BOT√ïES A, M, T, C) --- */
.manual-controls {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.btn-control-small {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: bold;
}

.btn-control-small.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Toggle Switch (Interruptor) */
.setting-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
}
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #444; transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(16px); }

/* --- ESTILO DO TOGGLE SWITCH (BIBLE STYLE) --- */
.setting-switch {
    position: relative;
    display: inline-block;
    width: 38px;
    height: 20px;
    flex-shrink: 0;
}

.setting-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #333;
    transition: .3s;
    border-radius: 20px;
    border: 1px solid #444;
}

.slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 2px;
    bottom: 2px;
    background-color: #777;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

input:checked + .slider:before {
    transform: translateX(18px);
    background-color: white;
}

</style>


</head>
<body>

    <!-- ESCUDO DE CARREGAMENTO INICIAL -->
    <div id="global-auth-shield">
        <div class="global-spinner"></div>
    </div>

    <!-- CABE√áALHO -->
    <header>
        <button id="back-btn">‚¨Ö</button>
        <!-- O t√≠tulo aqui ser√° preenchido via JS com < CAP√çTULO X > -->
        <div id="page-title">Biblioteca</div>
        <div style="width: 30px;"></div>
    </header>

    <div id="main-layout">
        <!-- √ÅREA PRINCIPAL (LEITURA) -->
        <div class="container" id="content-container">
            <!-- Vistas Din√¢micas (Grid Livros, Cap√≠tulos, Texto) -->
        </div>

        <!-- PAINEL LATERAL (NOTAS) -->
       <aside id="side-panel">
    <div class="side-header">
        <div id="side-title-container">
            <span id="side-title" style="color: var(--accent-color); font-weight: bold;">Notas</span>
            <!-- O bot√£o +üìù ser√° injetado aqui via JS -->
        </div>
        <button onclick="window.closeSidePanel()" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;line-height:1;">√ó</button>
    </div>
    <div class="side-content" id="side-content">
        <!-- Notas injetadas aqui -->
    </div>
</aside>
    </div>

    <!-- BARRA DE SELE√á√ÉO FLUTUANTE -->
    <div id="selection-toolbar">
        <button id="btn-copy">üìë Copiar</button>
        <button id="btn-flash-note">‚úç Nota Flash</button>
    </div>

    <!-- MODAL DE CRIA√á√ÉO DE NOTA -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <div style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <button onclick="window.closeFlashModal()" style="background:none; border:none; color:#888; font-size:18px; cursor:pointer; margin-right:10px;">‚¨Ö</button>
                <h3 style="color:#e67e22; margin:0;">Nova Nota</h3>
                <button onclick="window.closeFlashModal()" style="margin-left:auto; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota..." style="font-size:1.2em; margin-bottom:15px;">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')" title="Negrito"><b>B</b></button>
                <button onclick="document.execCommand('italic')" title="It√°lico"><i>I</i></button>
                <button onclick="document.execCommand('underline')" title="Sublinhado"><u>U</u></button>
                <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                <button id="btn-flash-topics" onclick="window.openTopicsModal()" title="T√≥picos">üìã</button>
                <button id="btn-flash-links" onclick="window.openFlashLinkManager()" title="Gest√£o de Links">‚ö°</button>
                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            <div class="color-picker-container" id="color-picker"></div>

            <div style="margin-top: 5px; font-size: 0.8rem; color: #888; display:flex; align-items:center; gap:5px;">
                <span style="font-size:1.2em;">üìö</span> Codex: 
                <span id="flash-codex-info" style="color: #3498db; font-weight:bold;"></span>
            </div>

            <button id="btn-save-flash" onclick="window.saveLibraryFlashNote()" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1rem;">
                GRAVAR NOTA
            </button>
        </div>
    </div>

    <!-- MODAL DE T√ìPICOS -->
    <div id="flash-topics-modal" class="modal-overlay" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
            <div class="side-header">
                <h3>T√≥picos do Bloco</h3>
                <button onclick="document.getElementById('flash-topics-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div style="display: flex; flex: 1; overflow: hidden;">
                <div style="flex: 1; border-right: 1px solid #333; padding: 10px; overflow-y: auto;">
                    <h4 style="color:#e67e22; font-size:0.8rem; margin-bottom:10px;">T√ìPICOS</h4>
                    <ul id="flash-topics-list" style="list-style:none;">Carregando...</ul>
                </div>
                <div style="flex: 1; padding: 10px; overflow-y: auto;">
                    <h4 style="color:#3498db; font-size:0.8rem; margin-bottom:10px;" id="flash-sub-title">SUBT√ìPICOS</h4>
                    <ul id="flash-subtopics-list" style="list-style:none;">
                        <li style="color:#888; font-style:italic;">Selecione um t√≥pico.</li>
                    </ul>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
                <button onclick="document.getElementById('flash-topics-modal').style.display='none'" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LINKS -->
    <div id="flash-links-modal" class="modal-overlay" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
            <div class="side-header">
                <h3>Gest√£o de Links</h3>
                <button onclick="document.getElementById('flash-links-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div style="padding: 15px 15px 0 15px;">
                <div id="flash-links-context"></div>
            </div>
            <div class="store-tabs-header" style="padding: 10px 15px; border-bottom: 1px solid #333; display: flex; gap: 10px;">
                <button class="store-tab-btn active" onclick="window.switchFlashLinkTab('refs')">Refer√™ncias</button>
                <button class="store-tab-btn" onclick="window.switchFlashLinkTab('codex')">Codex</button>
                <button class="store-tab-btn" onclick="window.switchFlashLinkTab('cats')">Categorias</button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 15px;">
                <div id="flash-tab-refs">
                    <input type="text" id="flash-link-title" class="flash-input-title" style="font-size:1rem;" placeholder="T√≠tulo do Grupo...">
                    <div id="flash-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <button onclick="window.addFlashUrlField()" style="margin-top:10px; padding:6px 12px; background:#333; border:1px solid #555; color:#ccc; cursor:pointer; border-radius:4px;">+ Adicionar URL</button>
                </div>
                <div id="flash-tab-codex" style="display:none;">
                    <div id="flash-codex-rows-container"></div>
                    <button onclick="window.createFlashCodexRow()" style="width:100%; margin-top:15px; padding:10px; background:rgba(230, 126, 34, 0.1); border:1px dashed #e67e22; color:#e67e22; cursor:pointer; border-radius:6px;">+ Nova Linha Codex</button>
                </div>
                <div id="flash-tab-cats" style="display:none;">
    
    <!-- Barra de Pesquisa -->
    <div style="margin-bottom: 15px;">
        <label class="codex-label">PESQUISAR T√ìPICO OU LIVRO</label>
        <input type="text" id="flash-cat-search" class="codex-input-modern" 
               placeholder="Ex: Amor, Daniel, Resgate..." 
               oninput="window.searchFlashCategories(this.value)">
    </div>

    <!-- Toggle Switch: Escolher entre T√≥picos ou B√≠blia -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px; padding:10px; background:rgba(255,255,255,0.03); border-radius:6px; border:1px solid #333;">
        <label class="setting-switch">
            <input type="checkbox" id="flash-bible-toggle">
            <span class="slider"></span>
        </label>
        <span style="font-size:0.85rem; color:#ccc; font-weight: 500;">Pesquisar na B√≠blia (Global)</span>
    </div>

    <!-- √Årea de Resultados da Pesquisa -->
    <div id="flash-cat-results" style="max-height:200px; overflow-y:auto; border:1px solid #333; border-radius:6px; background:#111; margin-bottom:20px;">
        <!-- Injetado via JS -->
    </div>

    <!-- √Årea de Itens Selecionados (Chips/P√≠lulas) -->
    <label class="codex-label">VINCULADOS A ESTA NOTA</label>
    <div id="flash-cat-selected" style="display:flex; flex-wrap:wrap; gap:8px; padding-top:5px;">
        <!-- Injetado via JS -->
    </div>
</div>

    <!-- PAINEL DE NAVEGA√á√ÉO R√ÅPIDA DE CAP√çTULOS (GRELHA) -->
    <div id="chapter-nav-panel" class="hidden"></div>

    

    <script type="module">
import { db, auth } from './js/firebase-config.js';
import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';

// --- ESTADO GLOBAL ---
let currentBookData = null;
let currentPubId = null;   
let currentChapter = null; 
let currentSectionId = null; 
let navStack = [];
let currentFlashTopics = {}; 
let currentFlashLinks = {};
let activeTopicIdForFlash = null;
let currentChapterHighlights = {};

// Estado de Sele√ß√£o e Destaque
let currentSelectionText = "";
let currentSelectedParagraphs = []; 
let selectedColorHex = '#3498db';

const container = document.getElementById('content-container');


const HIGHLIGHT_COLORS = [
    { name: 'Laranja', hex: '#e67e22' },
    { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' },
    { name: 'Verde', hex: '#2ecc71' },
    { name: 'Rosa', hex: '#ff7979' },
    { name: 'Roxo', hex: '#9b59b6' },
    { name: 'Vermelho', hex: '#e74c3c' },
    { name: 'Vinho', hex: '#822118' },
    { name: 'Castanho', hex: '#8d6e63' },
    { name: 'Cinzento', hex: '#95a5a6' }
];

// --- 1. INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
onAuthStateChanged(auth, async (user) => {
    const shield = document.getElementById('global-auth-shield');
    if (!user) { window.location.href = "404.html"; return; }

    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().aceite !== "on") { 
            window.location.href = "index.html"; 
            return; 
        }

        if (shield) shield.style.display = 'none';

        // Verifica se h√° par√¢metros no URL para abrir direto um cap√≠tulo
        const params = new URLSearchParams(window.location.search);
        if (params.has('book') && params.has('cap')) {
            const bookId = params.get('book');
            const capNum = params.get('cap');
            const success = await loadPublication('books', bookId);
            if (success) {
                const idx = currentBookData.capitulos.findIndex(c => String(c.capitulo) === String(capNum));
                renderReading(idx !== -1 ? idx : 0, 'books', bookId);
            }
        } else {
            showRoot(); 
        }
    } catch (e) { console.error(e); }
});

// --- 2. CARREGAMENTO DE DADOS ---
async function loadPublication(sectionId, pubId) {
    container.innerHTML = '<div class="global-spinner" style="margin:50px auto;"></div>';
    try {
        currentPubId = pubId;
        const response = await fetch(`./js/${sectionId}/${pubId}.json`);
        if (!response.ok) throw new Error("Erro de rede");
        currentBookData = await response.json();
        return true;
    } catch (e) {
        container.innerHTML = `<p style="text-align:center;color:red;padding:20px;">Erro ao carregar publica√ß√£o.</p>`;
        return false;
    }
}

// --- 3. RENDERIZA√á√ÉO DA LEITURA ---
function renderReading(chapterIdx, sectionId, pubId) {
    const cap = currentBookData.capitulos[chapterIdx];
    if (!cap) return;
    
    currentSectionId = sectionId;
    currentChapter = cap.capitulo || (chapterIdx + 1);

    // Gest√£o do Hist√≥rico para o bot√£o Voltar
    if (navStack.length === 0 || navStack[navStack.length-1].name !== "showChapters") {
        navStack.push(() => showChapters(sectionId, pubId));
    }
    
    // 1. Prepara o HTML da Navega√ß√£o (Setas + T√≠tulo clic√°vel)
    // isUpper define se o texto aparece como "CAP√çTULO" (Header) ou "Cap√≠tulo" (Corpo)
    const getNavHTML = (isUpper = false) => `
        <button class="nav-arrow" onclick="window.changeChapter(-1)">‚ùÆ</button>
        <span onclick="window.toggleChapterNav(event)" style="cursor:pointer; border-bottom: 1px dotted #666;">
            ${isUpper ? 'CAP√çTULO' : 'Cap√≠tulo'} ${currentChapter}
        </span>
        <button class="nav-arrow" onclick="window.changeChapter(1)">‚ùØ</button>
    `;

    // 2. Monta o Corpo do Leitor (Layout conforme as imagens)
    let html = `
        <div class="reader-content" id="reader-area">
            <!-- T√≠tulo da Publica√ß√£o (Cinza) -->
            <div class="pub-body-title">${currentBookData.titulo}</div>
            
            <!-- T√≠tulo do Cap√≠tulo em Azul (Imagem 2) -->
            <div class="reader-chapter-title">Cap. ${currentChapter}: ${cap.titulo}</div>
    `;

    // 3. Renderiza√ß√£o dos blocos de conte√∫do
    cap.conteudo.forEach(block => {
        const pNum = block.numero_ref ? String(block.numero_ref).split(',')[0].trim() : null;
        const blockId = pNum ? `id="p-${pNum}"` : '';
        const dataAttr = pNum ? `data-pnum="${pNum}"` : '';

        if (block.tipo === 'subtema') {
            html += `<div class="block-subtema">${block.texto}</div>`;
        } else if (block.tipo === 'pergunta') {
            html += `<div class="block-pergunta">${block.texto}</div>`;
        } else if (block.tipo === 'paragrafo') {
            // N√∫mero do par√°grafo √© SEMPRE clic√°vel (abre painel com bot√£o +üìù)
            html += `
                <div ${blockId} ${dataAttr} class="block-paragrafo">
                    <span class="ref-num" onclick="window.openSidePanel('${pNum}')">
                        ${block.numero_ref || ''}
                    </span>
                    ${block.texto}
                </div>`;
        } else if (block.tipo === 'rodape') {
            html += `<div class="block-rodape">${block.texto}</div>`;
        }
    });

    html += `</div>`;

    // Injeta no contentor principal
    container.innerHTML = html;
    container.scrollTop = 0;
    
    // 4. Injeta a navega√ß√£o no Header Superior (Mai√∫sculas)
    const pageTitleEl = document.getElementById('page-title');
    if (pageTitleEl) {
        pageTitleEl.innerHTML = getNavHTML(true);
    }
    
    // Configura o bot√£o de voltar do Header
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
        backBtn.onclick = () => {
            const last = navStack.pop();
            if (last) last();
        };
    }

    // 5. Carrega dados do Firebase (Pinta de azul os n√∫meros com notas e desenha picotados)
    loadLibraryDataForChapter(currentPubId, currentChapter);
}

// --- 4. NAVEGA√á√ÉO DE CAP√çTULOS ---

// Navega√ß√£o por setas (‚ùÆ e ‚ùØ)
window.changeChapter = (delta) => {
    if (!currentBookData) return;
    
    const currentIdx = currentBookData.capitulos.findIndex(c => 
        String(c.capitulo || (currentBookData.capitulos.indexOf(c) + 1)) === String(currentChapter)
    );

    const newIdx = currentIdx + delta;

    if (newIdx >= 0 && newIdx < currentBookData.capitulos.length) {
        renderReading(newIdx, currentSectionId, currentPubId);
    }
};

// Abrir/Fechar a Grelha de Cap√≠tulos
window.toggleChapterNav = (event) => {
    // Impede que o clique feche o painel imediatamente (propaga√ß√£o)
    if (event) event.stopPropagation();

    const panel = document.getElementById('chapter-nav-panel');
    
    // Se o painel j√° estiver vis√≠vel, fecha-o
    if (panel.style.display === 'grid') {
        panel.style.display = 'none';
        panel.classList.add('hidden');
        return;
    }

    // Se tivermos os dados da publica√ß√£o carregados
    if (currentBookData && currentBookData.capitulos) {
        panel.innerHTML = ''; // Limpa o conte√∫do anterior

        // Cria um bot√£o para cada cap√≠tulo
        currentBookData.capitulos.forEach((cap, idx) => {
            const capNum = cap.capitulo || (idx + 1);
            
            const btn = document.createElement('div');
            btn.className = 'nav-cap-btn';
            
            // Destaca o cap√≠tulo onde estamos atualmente
            if (String(capNum) === String(currentChapter)) {
                btn.classList.add('active');
            }
            
            btn.innerText = capNum;
            
            // Ao clicar num n√∫mero da grelha
            btn.onclick = () => {
                panel.style.display = 'none';
                panel.classList.add('hidden');
                // Chama a fun√ß√£o de leitura para o cap√≠tulo selecionado
                renderReading(idx, currentSectionId, currentPubId);
            };
            
            panel.appendChild(btn);
        });
        
        // Mostra o painel em modo Grid
        panel.classList.remove('hidden');
        panel.style.display = 'grid';
    }
};

// --- FECHAR O PAINEL AO CLICAR FORA ---
window.addEventListener('click', (e) => {
    const panel = document.getElementById('chapter-nav-panel');
    // Se o painel estiver aberto e o clique for fora dele
    if (panel && panel.style.display === 'grid' && !panel.contains(e.target)) {
        panel.style.display = 'none';
        panel.classList.add('hidden');
    }
});


// --- 5. SISTEMA DE SELE√á√ÉO E NOTAS FLASH ---

// Monitorizar sele√ß√£o de texto
document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const toolbar = document.getElementById('selection-toolbar');

    if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.style.display = 'none';
        return;
    }

    const range = selection.getRangeAt(0);
    const text = selection.toString().trim();
    const reader = document.getElementById('reader-area');

    if (reader && reader.contains(range.commonAncestorContainer) && text.length > 0) {
        currentSelectionText = text;
        
        // Descobrir quais par√°grafos est√£o na sele√ß√£o
        currentSelectedParagraphs = [];
        const paragraphs = document.querySelectorAll('.block-paragrafo');
        paragraphs.forEach(p => {
            const nodeRange = document.createRange();
            nodeRange.selectNode(p);
            const intersects = range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
                               range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
            if (intersects) {
                const pNum = p.getAttribute('data-pnum');
                if (pNum) currentSelectedParagraphs.push(pNum);
            }
        });

        // Posicionar barra flutuante
        const rect = range.getBoundingClientRect();
        if (window.innerWidth <= 768) {
            toolbar.style.position = 'fixed'; toolbar.style.bottom = '20px';
            toolbar.style.left = '50%'; toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.top = 'auto';
        } else {
            toolbar.style.position = 'absolute';
            toolbar.style.top = `${window.scrollY + rect.top - 50}px`;
            toolbar.style.left = `${window.scrollX + rect.left}px`;
            toolbar.style.transform = 'none';
        }
        toolbar.style.display = 'flex';
    }
});

// Bot√£o Copiar da barra
document.getElementById('btn-copy').onclick = () => {
    navigator.clipboard.writeText(currentSelectionText);
    document.getElementById('selection-toolbar').style.display = 'none';
};

// Bot√£o Nota Flash da barra
document.getElementById('btn-flash-note').onclick = () => {
    window.openFlashModal();
    document.getElementById('selection-toolbar').style.display = 'none';
};

// Abrir Modal de Nota
window.openFlashModal = () => {
    const modal = document.getElementById('flash-note-modal');
    modal.style.display = 'flex';
    document.getElementById('flash-title').value = '';
    document.getElementById('flash-editor').innerHTML = '';
    
    let codexStr = `${currentPubId} ${currentChapter}`;
    if (currentSelectedParagraphs.length > 0) codexStr += `:${currentSelectedParagraphs.join('-')}`;
    document.getElementById('flash-codex-info').textContent = codexStr;

    renderColorPicker();
};

window.closeFlashModal = () => {
    document.getElementById('flash-note-modal').style.display = 'none';
};

window.renderColorPicker = () => {
    // Procura por qualquer um dos IDs poss√≠veis (do modal ou do painel lateral)
    const container = document.getElementById('inline-color-picker') || document.getElementById('color-picker');
    
    if (!container) return;

    container.innerHTML = '';
    HIGHLIGHT_COLORS.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.hex;
        
        // Marca como selecionada se for a cor atual
        if (selectedColorHex === c.hex) btn.classList.add('selected');
        
        btn.onclick = () => {
            // Remove sele√ß√£o dos outros
            const allBtns = container.querySelectorAll('.color-btn');
            allBtns.forEach(b => b.classList.remove('selected'));
            
            // Adiciona ao atual
            btn.classList.add('selected');
            selectedColorHex = c.hex;
        };
        container.appendChild(btn);
    });
};

// Grava√ß√£o da Nota na Biblioteca
window.saveLibraryFlashNote = async () => {
    const btn = document.getElementById('btn-save-flash');
    const title = document.getElementById('flash-title').value.trim();
    const content = document.getElementById('flash-editor').innerHTML;
    const noteType = document.getElementById('flash-type-select').value;

    if (!title) return alert("O t√≠tulo √© obrigat√≥rio!");
    btn.textContent = "A gravar..."; btn.disabled = true;

    try {
        let wrapperClass = (noteType === 'question') ? "mini-note-wrapper question-mode" : "mini-note-wrapper";
        const safeTopics = JSON.stringify(currentFlashTopics || {}).replace(/"/g, '&quot;');
        const safeBoxLinks = JSON.stringify(currentFlashLinks || {}).replace(/"/g, '&quot;');

        const subNoteHtml = `
            <div class="${wrapperClass}" id="box_${Date.now()}" 
                 data-topics='${safeTopics}' data-shared="false" data-box-links='${safeBoxLinks}' contenteditable="false">
                <textarea class="mini-note-title-input" rows="1">${title}</textarea>
                <div class="mini-note-toolbar" contenteditable="false">
                    <button>üîê</button><div class="toolbar-btn-group"><button>üî∫</button><button>üîª</button></div>
                    <button class="has-links">‚ö°</button><button>üß¨</button><button>üé®</button><button>üìã</button><button>üóëÔ∏è</button>
                </div>
                <div class="mini-note-content" contenteditable="true">${content}</div>
            </div><p><br></p>
        `;

        const noteRef = await addDoc(collection(db, 'pastas'), {
            nome: title, conteudo: subNoteHtml, tipo: 'nota', oque: 'flash',
            userId: auth.currentUser.uid, estado: 'ativa', createdAt: serverTimestamp(), ultimaedicao: serverTimestamp()
        });

        const puzzleItem = {
            type: 'ref', noteId: noteRef.id, noteName: title,
            snippet: encodeURIComponent(subNoteHtml), addedAt: Date.now(),
            noteColor: selectedColorHex, highlightRef: currentSelectionText
        };

        const promises = currentSelectedParagraphs.map(async (pNum) => {
            const docName = `${currentPubId} ${currentChapter}:${pNum}`;
            const q = query(collection(db, 'livros'), where('nome', '==', docName), where('userId', '==', auth.currentUser.uid));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                await addDoc(collection(db, 'livros'), {
                    nome: docName, livro: currentBookData.titulo, bookId: currentPubId,
                    capitulo: currentChapter, paragrafo: pNum, userId: auth.currentUser.uid,
                    createdAt: serverTimestamp(), puzzleBoard: [puzzleItem], dossie: [], panelLinks: []
                });
            } else {
                await updateDoc(doc(db, 'livros', snap.docs[0].id), { puzzleBoard: arrayUnion(puzzleItem) });
            }
        });

        await Promise.all(promises);
        window.closeFlashModal();
        if(currentSelectionText) window.applyHighlightToUI(currentSelectionText, selectedColorHex, `${currentPubId} ${currentChapter}:${currentSelectedParagraphs[0]}`);

    } catch (e) { console.error(e); alert("Erro ao gravar."); }
    finally { btn.textContent = "GRAVAR NOTA"; btn.disabled = false; }
};

// --- 6. GEST√ÉO DE DADOS DO UTILIZADOR (HIGHLIGHTS) ---

async function loadLibraryDataForChapter(pubId, chapter) {
    const prefix = `${pubId} ${chapter}:`;
    currentChapterHighlights = {}; 

    // Atribui o clique a TODOS os n√∫meros logo no in√≠cio
    document.querySelectorAll('.ref-num').forEach(el => {
        const pNum = el.closest('.block-paragrafo').getAttribute('data-pnum');
        el.classList.remove('has-data');
        el.onclick = () => window.openSidePanel(pNum);
    });

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(collection(db, 'livros'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '>=', prefix), 
            where('nome', '<=', prefix + '\uf8ff')
        );
        
        const snapshot = await getDocs(q);
        
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const pNum = data.paragrafo;
            const pId = `p-${pNum}`;
            
            // 2. Mapeia destaques (picotados)
            if (data.puzzleBoard && data.puzzleBoard.length > 0) {
                if (!currentChapterHighlights[pId]) currentChapterHighlights[pId] = [];
                
                data.puzzleBoard.forEach(item => {
                    if (item.highlightRef) {
                        currentChapterHighlights[pId].push({
                            texto: item.highlightRef,
                            cor: item.noteColor || '#3498db'
                        });
                    }
                });

                // 3. PINTA DE AZUL: Apenas se o puzzleBoard tiver itens
                const numEl = document.querySelector(`.block-paragrafo[data-pnum="${pNum}"] .ref-num`);
                if (numEl) {
                    numEl.classList.add('has-data');
                    // Ativa o clique para abrir o painel lateral
                    numEl.onclick = (e) => {
                        e.stopPropagation();
                        window.openSidePanel(pNum);
                    };
                }
            }
        });

        // Renderiza os sublinhados picotados no texto
        window.refreshVisualHighlights();

    } catch (e) { 
        console.error("Erro ao carregar dados do cap√≠tulo:", e); 
    }
}

window.applyHighlightToUI = (text, color, refId) => {
    const reader = document.getElementById('reader-area');
    if (!reader) return;
    const paragraphs = reader.querySelectorAll('.block-paragrafo');
    paragraphs.forEach(p => {
        if (p.textContent.includes(text) && !p.innerHTML.includes('highlight-picotado')) {
            const safeText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeText})`, 'g');
            p.innerHTML = p.innerHTML.replace(regex, `<span class="highlight-picotado" style="background-image: linear-gradient(to right, ${color} 50%, transparent 50%);" onclick="window.openSidePanel('${refId}')">$1</span>`);
        }
    });
};

// --- 7. VISTAS DE NAVEGA√á√ÉO DA BIBLIOTECA ---

function showRoot() {
    navStack = [];
    container.innerHTML = '<h2 class="section-title">Cole√ß√µes</h2><div class="grid" id="root-grid"></div>';
    const grid = document.getElementById('root-grid');
    const SECTIONS = [
        { id: 'books', name: 'Livros', icon: 'üìö', color: 'type-book', items: ['cf', 'jy', 'ia', 'ip-1', 'ip-2', 're', 'dp', 'rr'] },
        { id: 'publicacoes', name: 'Publica√ß√µes', icon: 'üì∞', color: 'type-pub', items: ['lff', 'od', 'th', 'mwb'] }
    ];
    SECTIONS.forEach(sec => {
        const card = document.createElement('div');
        card.className = `pub-card ${sec.color}`;
        card.innerHTML = `<span style="font-size:3em;">${sec.icon}</span><span class="pub-title">${sec.name}</span>`;
        card.onclick = () => showList(sec);
        grid.appendChild(card);
    });
    updateHeader("Biblioteca", () => window.location.href = "note.html");
}

function showList(section) {
    navStack.push(() => showRoot());
    container.innerHTML = `<h2 class="section-title">${section.name}</h2><div class="grid" id="list-grid"></div>`;
    const grid = document.getElementById('list-grid');
    section.items.forEach(id => {
        const card = document.createElement('div');
        card.className = `pub-card ${section.color}`;
        const fullName = SIGLAS_PUBLICACOES[id] || id.toUpperCase();
        card.innerHTML = `<div style="font-size:0.7em; opacity:0.5; margin-bottom:5px;">${id.toUpperCase()}</div><span class="pub-title">${fullName}</span>`;
        card.onclick = () => loadPublication(section.id, id).then(ok => { if(ok) showChapters(section.id, id); });
        grid.appendChild(card);
    });
    updateHeader(section.name, () => { const last = navStack.pop(); if (last) last(); });
}

function showChapters(sectionId, pubId) {
    navStack.push(() => showList(sectionId === 'books' ? {id:'books', name:'Livros'} : {id:'publicacoes', name:'Publica√ß√µes'}));
    container.innerHTML = `<h2 class="section-title">Cap√≠tulos</h2><div class="chapter-list"></div>`;
    const list = container.querySelector('.chapter-list');
    currentBookData.capitulos.forEach((cap, idx) => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.innerHTML = `<span><b>${cap.capitulo || idx+1}</b> ${cap.titulo}</span> <span>‚ûî</span>`;
        item.onclick = () => renderReading(idx, sectionId, pubId);
        list.appendChild(item);
    });
    updateHeader(currentBookData.titulo, () => { const last = navStack.pop(); if (last) last(); });
}

function updateHeader(title, backAction) {
    document.getElementById('page-title').innerHTML = title;
    document.getElementById('back-btn').onclick = backAction;
}


// --- 1. FUN√á√ÉO PARA REFRESCAR DESTAQUES VISUAIS (O MOTOR) ---
window.refreshVisualHighlights = () => {
    // Limpeza: Remove picotados antigos para evitar duplica√ß√£o (mantendo o texto)
    document.querySelectorAll('.highlight-picotado').forEach(span => {
        const parent = span.parentNode;
        parent.replaceChild(document.createTextNode(span.textContent), span);
        parent.normalize();
    });

    // Aplica os destaques baseados nos dados carregados
    for (const [pId, highlights] of Object.entries(currentChapterHighlights)) {
        const paragraphEl = document.getElementById(pId);
        if (!paragraphEl) continue;

        highlights.forEach(h => {
            const textToHighlight = h.texto;
            const color = h.cor;
            const safeText = encodeURIComponent(textToHighlight);
            const safeColor = encodeURIComponent(color);

            // Usa TreeWalker para encontrar e substituir apenas n√≥s de texto (seguro para HTML)
            const walker = document.createTreeWalker(paragraphEl, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const nodesToReplace = [];

            while (node = walker.nextNode()) {
                if (node.nodeValue.includes(textToHighlight)) {
                    nodesToReplace.push(node);
                }
            }

            nodesToReplace.forEach(textNode => {
                const parts = textNode.nodeValue.split(textToHighlight);
                const fragment = document.createDocumentFragment();
                
                parts.forEach((part, i) => {
                    fragment.appendChild(document.createTextNode(part));
                    if (i < parts.length - 1) {
                        const span = document.createElement('span');
                        span.className = 'highlight-picotado';
                        span.style.backgroundImage = `linear-gradient(to right, ${color} 50%, transparent 50%)`;
                        span.textContent = textToHighlight;
                        // Ao clicar, abre o painel lateral focando neste trecho
                        span.onclick = (e) => {
                            e.stopPropagation();
                            window.openSidePanel(paragraphEl.getAttribute('data-pnum'), textToHighlight);
                        };
                        fragment.appendChild(span);
                    }
                });
                textNode.parentNode.replaceChild(fragment, textNode);
            });
        });
    }
};




// --- 3. ATUALIZA√á√ÉO DA FUN√á√ÉO OPEN SIDE PANEL (COM FILTRO) ---
window.openSidePanel = async (pNum, filterText = null) => {
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('side-content');
    const title = document.getElementById('side-title');
    const titleContainer = document.getElementById('side-title-container');
    const refName = `${currentPubId} ${currentChapter}:${pNum}`;

    panel.classList.add('open');
    
    // 1. Atualiza o T√≠tulo
    title.innerHTML = filterText ? `Trecho em Par. ${pNum}` : `Par√°grafo ${pNum}`;

    // 2. Remove bot√£o antigo se existir e injeta o novo bot√£o brilhante ao lado do t√≠tulo
    const existingBtn = titleContainer.querySelector('.btn-header-create');
    if (existingBtn) existingBtn.remove();

    const createBtn = document.createElement('button');
    createBtn.className = 'btn-header-create';
    createBtn.innerHTML = '+ üìù';
    createBtn.onclick = () => window.prepareNoteFromPanel(pNum);
    titleContainer.appendChild(createBtn);

    // 3. Prepara o conte√∫do do corpo
    content.innerHTML = '<div id="side-notes-list"><div style="padding:40px;text-align:center;"><div class="global-spinner"></div></div></div>';

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(collection(db, 'livros'), where('nome', '==', refName), where('userId', '==', auth.currentUser.uid));
        const snap = await getDocs(q);

        const listContainer = document.getElementById('side-notes-list');

        if (snap.empty) {
            listContainer.innerHTML = '<p style="text-align:center;color:#666;padding-top:40px;font-style:italic;">Sem notas associadas.</p>';
            return;
        }

        const data = snap.docs[0].data();
        let notesToShow = data.puzzleBoard || [];

        if (filterText) {
            notesToShow = notesToShow.filter(n => n.highlightRef === filterText);
        }

        let html = '';
        notesToShow.forEach(item => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = decodeURIComponent(item.snippet);
            const noteContent = tempDiv.querySelector('.mini-note-content')?.innerHTML || tempDiv.innerHTML;

            html += `
                <div class="detail-card" style="border-left: 4px solid ${item.noteColor || '#3498db'}">
                    <strong style="color:#fff; display:block; margin-bottom:5px;">${item.noteName}</strong>
                    <div>${noteContent}</div>
                </div>`;
        });

        listContainer.innerHTML = html || '<p>Sem notas.</p>';

    } catch (e) { console.error(e); }
};


// Dentro de saveLibraryFlashNote, ap√≥s o sucesso da grava√ß√£o:
currentSelectedParagraphs.forEach(pNum => {
    const numEl = document.querySelector(`.block-paragrafo[data-pnum="${pNum}"] .ref-num`);
    if (numEl) {
        numEl.classList.add('has-data');
        numEl.onclick = () => window.openSidePanel(pNum);
    }
});


// --- NOVO: Fun√ß√£o para preparar a nota vinda do painel lateral ---
window.prepareNoteFromPanel = (pNum) => {
    // Define o contexto
    currentSelectedParagraphs = [pNum];
    currentSelectionText = ""; 
    
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
        // --- VERS√ÉO MOBILE: POPUP (Modal) ---
        const modal = document.getElementById('flash-note-modal');
        // Limpamos o conte√∫do do modal e injetamos o formul√°rio
        const modalContent = modal.querySelector('.modal-content');
        modalContent.innerHTML = `
            <div style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h3 style="color:#e67e22; margin:0;">Nova Nota</h3>
                <button onclick="window.closeFlashModal()" style="margin-left:auto; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            ${window.getFlashNoteFormHTML(pNum)}
        `;
        modal.style.display = 'flex';
    } else {
        // --- VERS√ÉO PC: DENTRO DO PAINEL LATERAL ---
        const sideContent = document.getElementById('side-content');
        const sideTitle = document.getElementById('side-title');
        const titleContainer = document.getElementById('side-title-container');

        // Mudamos o t√≠tulo do painel
        sideTitle.textContent = "Nova Nota";
        // Escondemos o bot√£o "+" brilhante para n√£o duplicar
        const btnPlus = titleContainer.querySelector('.btn-header-create');
        if (btnPlus) btnPlus.style.display = 'none';

        // Injetamos o formul√°rio no conte√∫do do painel
        sideContent.innerHTML = window.getFlashNoteFormHTML(pNum);
    }

    // Inicializa as cores ap√≥s injetar o HTML
    renderColorPicker(); 
};

window.getFlashNoteFormHTML = (pNum) => {
    const codexStr = `${currentPubId} ${currentChapter}:${pNum}`;
    
    return `
        <div class="note-creation-form" style="padding: 5px;">
            <!-- T√≠tulo id√™ntico ao Bible.html -->
            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="document.execCommand('underline')"><u>U</u></button>
                <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                <button onclick="window.openTopicsModal()">üìã</button>
                <button onclick="window.openFlashLinkManager()">‚ö°</button>
                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            
            <!-- As cores aparecem aqui -->
            <div class="color-picker-container" id="inline-color-picker"></div>

            <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                üîó Anexado a: <span style="color: #3498db; font-weight:bold;">${codexStr}</span>
            </div>

            <button id="btn-save-flash" onclick="window.saveLibraryFlashNote(this)" 
                    style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                GRAVAR NOTA
            </button>
        </div>
    `;
};

// --- GEST√ÉO DE LINKS: DESIGN MAIS LIMPO ---
window.addFlashUrlField = (val = "") => {
    const div = document.createElement('div');
    div.className = 'flash-url-row';
    div.innerHTML = `
        <span style="opacity:0.5;">üîó</span>
        <input type="text" placeholder="https://..." value="${val}">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-urls-list').appendChild(div);
};

// Quando carregar as categorias selecionadas, use o novo design de Chip:
function renderFlashCategoryChip(cat) {
    const container = document.getElementById('flash-cat-selected');
    const chip = document.createElement('div');
    chip.className = 'flash-cat-chip';
    chip.innerHTML = `<span>#</span> ${cat.name} <span style="opacity:0.5; margin-left:5px;">&times;</span>`;
    chip.onclick = () => {
        chip.remove();
        // L√≥gica para remover do array global...
    };
    container.appendChild(chip);
}

// 1. Abrir o Gerenciador de Links com Design Bible
window.openFlashLinkManager = function() {
    const modal = document.getElementById('flash-links-modal');
    modal.style.display = 'flex';
    
    // Contexto visual (Anexado a...)
    const contextDiv = document.getElementById('flash-links-context');
    contextDiv.innerHTML = `<span style="opacity:0.5; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Contexto da Nota</span>
                            <strong style="color:#eee;">${currentPubId} ${currentChapter}:${currentSelectedParagraphs.join(',')}</strong>`;

    // Limpeza e Restaura√ß√£o de Dados
    document.getElementById('flash-urls-list').innerHTML = '';
    document.getElementById('flash-codex-rows-container').innerHTML = '';
    document.getElementById('flash-cat-selected').innerHTML = '';

    // Se houver links salvos, restaura (Exatamente como no Bible)
    if (currentFlashLinks.urls) {
        Object.values(currentFlashLinks.urls).forEach(url => window.addFlashUrlField(url));
    }
    
    if (currentFlashLinks.codex && currentFlashLinks.codex.length > 0) {
        currentFlashLinks.codex.forEach(row => window.createFlashCodexRow(row));
    } else {
        window.createFlashCodexRow(); // Adiciona uma vazia por padr√£o
    }

    window.switchFlashLinkTab('refs');
};

// 2. Criar Linha de Codex Complexa (Design Bible)
window.createFlashCodexRow = function(data = null) {
    const container = document.getElementById('flash-codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    row.innerHTML = `
        <button class="remove-codex-row" onclick="this.parentElement.remove()">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                <div class="manual-controls">
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Ano">A</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="M√™s">M</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Tempo">T</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Cap√≠tulo">C</button>
                </div>
            </div>
        </div>
        <div class="codex-content-grid">
            <div>
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div>
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(row);

    // Preencher unidades se houver dados
    if (data) {
        const pCont = row.querySelector('.pages-container');
        const pgCont = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addFlashCodexUnit(pCont, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addFlashCodexUnit(pgCont, 'Par', p));
    }
};

// 3. Adicionar Unidade (P√≠lula de n√∫mero)
window.addFlashCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.insertBefore(unit, container.lastChild);
};

window.switchFlashLinkTab = (tab) => {
    // 1. Atualizar visual dos bot√µes (abas)
    document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
    
    // Procura o bot√£o que foi clicado ou corresponde √† aba e ativa-o
    const buttons = document.querySelectorAll('.store-tab-btn');
    if(tab === 'refs') buttons[0].classList.add('active');
    if(tab === 'codex') buttons[1].classList.add('active');
    if(tab === 'cats') buttons[2].classList.add('active');

    // 2. Alternar a visibilidade dos pain√©is
    const panels = ['refs', 'codex', 'cats'];
    panels.forEach(p => {
        const el = document.getElementById(`flash-tab-${p}`);
        if (el) el.style.display = 'none';
    });

    const targetPanel = document.getElementById(`flash-tab-${tab}`);
    if (targetPanel) targetPanel.style.display = 'block';
};

// Altera a cor da borda do editor conforme o tipo de nota selecionado
window.changeFlashBorder = (selectElement) => {
    // Procura o editor no documento (funciona tanto no Modal como no Painel Lateral)
    const editor = document.getElementById('flash-editor');
    if (!editor) return;

    const type = selectElement.value;

    if (type === 'question') {
        // Estilo para QUEST√ÉO (Verde)
        editor.style.borderLeft = '4px solid #2ecc71';
        editor.style.backgroundColor = 'rgba(46, 204, 113, 0.05)';
    } else {
        // Estilo para SUBNOTA / PADR√ÉO (Azul)
        editor.style.borderLeft = '4px solid #3498db';
        editor.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
    }
};

// --- SISTEMA DE PESQUISA DE CATEGORIAS (IGUAL AO BIBLE.HTML) ---

window.searchFlashCategories = async (text) => {
    if (text.length < 2) {
        document.getElementById('flash-cat-results').innerHTML = '';
        return;
    }
    
    const searchText = text.toLowerCase();
    const resDiv = document.getElementById('flash-cat-results');
    const isGlobalBible = document.getElementById('flash-bible-toggle').checked;
    
    resDiv.innerHTML = '<div style="padding:10px; color:#888; font-size:0.8rem;">A procurar...</div>';
    
    let resultsArray = [];
    let type = '';

    try {
        if (isGlobalBible) {
            // MODO B√çBLIA: Pesquisa na lista local de livros (BIBLE_DATA deve estar importado)
            type = 'bible_public';
            // BIBLE_DATA √© o array importado no topo do teu script
            const { BIBLE_DATA } = await import('./js/bible-data.js');
            const matches = BIBLE_DATA.filter(b => 
                b.nome.toLowerCase().includes(searchText)
            );
            resultsArray = matches.map(b => ({ id: b.nome, nome: b.nome }));
        } else {
            // MODO T√ìPICOS: Pesquisa no Firestore
            type = 'topic';
            const { collection, query, where, getDocs, limit, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Procura t√≥picos do utilizador atual
            const q = query(
                collection(db, "topicos"),
                where("userId", "==", auth.currentUser.uid),
                where("nome", ">=", text.charAt(0).toUpperCase() + text.slice(1)), // Primeira letra mai√∫scula
                limit(10)
            );
            
            const snap = await getDocs(q);
            snap.forEach(doc => {
                resultsArray.push({ id: doc.id, ...doc.data() });
            });
        }

        // Renderiza√ß√£o dos Resultados
        resDiv.innerHTML = '';
        if (resultsArray.length === 0) {
            resDiv.innerHTML = '<div style="padding:10px; color:#666; font-size:0.8rem;">Sem resultados.</div>';
            return;
        }

        resultsArray.forEach(d => {
            const div = document.createElement('div');
            div.style.cssText = "padding:10px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;";
            
            const icon = type === 'bible_public' ? 'üåç' : 'üè∑Ô∏è';
            div.innerHTML = `<span>${icon} ${d.nome}</span> <button style="background:var(--accent-color); border:none; color:white; border-radius:4px; padding:2px 8px; cursor:pointer;">+</button>`;
            
            div.onclick = () => {
                const catObj = { id: d.id, name: d.nome, type: type };
                window.addFlashCategoryChip(catObj);
                resDiv.innerHTML = '';
                document.getElementById('flash-cat-search').value = '';
            };
            resDiv.appendChild(div);
        });

    } catch(e) { 
        console.error("Erro na pesquisa:", e);
        resDiv.innerHTML = '<div style="padding:10px; color:red;">Erro ao pesquisar.</div>';
    }
};

// Adiciona a "p√≠lula" visual da categoria selecionada
window.addFlashCategoryChip = (cat) => {
    if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
    
    // Evita duplicados
    if (currentFlashLinks.categories.some(c => c.name === cat.name)) return;
    
    currentFlashLinks.categories.push(cat);
    window.renderFlashCategoryChips();
};

// Desenha todos os chips na √°rea de "Selecionados"
window.renderFlashCategoryChips = () => {
    const container = document.getElementById('flash-cat-selected');
    if (!container) return;
    
    container.innerHTML = '';
    const categories = currentFlashLinks.categories || [];
    
    categories.forEach(cat => {
        const chip = document.createElement('div');
        chip.className = 'flash-cat-chip'; // J√° tens o CSS para isto
        chip.innerHTML = `<span>#</span> ${cat.name} <span style="margin-left:8px; opacity:0.5; font-size:1.1rem;">&times;</span>`;
        
        chip.onclick = () => {
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => c.name !== cat.name);
            window.renderFlashCategoryChips();
        };
        
        container.appendChild(chip);
    });
};

// Fun√ß√µes de T√≥picos e Links (Simplificadas para o exemplo, mantendo as chamadas nos modais)
window.openTopicsModal = () => { document.getElementById('flash-topics-modal').style.display = 'flex'; };
window.openFlashLinkManager = () => { document.getElementById('flash-links-modal').style.display = 'flex'; };
window.closeSidePanel = () => { document.getElementById('side-panel').classList.remove('open'); };


</script>
</body>
</html>
