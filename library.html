<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca - NotaBook</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczPH9OhQSJZR7u-h_UGu-_iJzdj7gWv6TYb5aUWISpPJ9ytdkeqRo1cr-VwNnKLThljiM_iv3KlSU9qfj7icHOhGI8Ehaq6Z2VX9rJC8B1Xqmk7Lthcq8y8V9w37yZ7G-ayEhKUnO4aW4gSEk7Fv1HiQ=w582-h461-s-no-gm?authuser=4">

<style>
   :root {
        --bg-color: #000000;
        --tile-color: #252528;
        --text-color: #ffffff;
        --accent-color: #3498db;
        --border-color: #333;
        --text-size-pct: 100%; 
        --panel-color: #1f1f22;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        height: 45px;
        flex-shrink: 0;
        z-index: 100;
    }

    #back-btn { background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; margin-right: 15px; }
    #page-title { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; flex-grow: 1; text-align: center; }

    #main-layout { flex: 1; overflow: hidden; position: relative; display: flex; }
    
    /* Contentor de Leitura */
    .container { 
        flex: 1; 
        overflow-y: auto; 
        padding: 15px; 
        transition: width 0.3s ease;
    }
    
    .section-title { font-size: 0.75rem; font-weight: 800; color: #888; margin: 20px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; }

    /* --- GRELHA --- */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding-bottom: 40px; }
    
    .pub-card {
        background-color: var(--tile-color);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        aspect-ratio: 2/2.5;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; padding: 15px; border-top: 4px solid var(--accent-color);
    }
    .pub-card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
    .pub-card.type-pub { border-top-color: #9b59b6; }
    .pub-title { font-size: 0.9rem; font-weight: bold; color: #e0e0e0; line-height: 1.3; }

    /* --- CAP√çTULOS --- */
    .chapter-list { display: flex; flex-direction: column; gap: 8px; }
    .chapter-item {
        background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #333;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .chapter-item:hover { border-color: var(--accent-color); }
    .chapter-item b { color: var(--accent-color); margin-right: 10px; }

    /* --- LEITOR & TEXTO --- */
    .reader-content {
        max-width: 800px; margin: 0 auto; font-size: var(--text-size-pct); line-height: 1.7;
        /* Permitir sele√ß√£o */
        user-select: text !important; -webkit-user-select: text !important;
    }
    
    /* Blocos de texto */
    .block-paragrafo, .block-pergunta, .block-subtema, .block-rodape {
        position: relative;
        user-select: text !important; -webkit-user-select: text !important;
    }

    .block-subtema { color: var(--accent-color); font-size: 1.4em; font-weight: bold; margin: 30px 0 15px 0; }
    .block-pergunta { color: #e67e22; font-weight: bold; background: rgba(230, 126, 34, 0.05); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .block-paragrafo { margin-bottom: 15px; text-align: justify; color: #ccc; }
    .block-rodape { color: #888; font-size: 0.85em; opacity: 0.6; font-style: italic; margin-top: 10px; padding: 5px 10px; border-left: 1px solid #444; text-align: left; }

    /* N√∫mero do Par√°grafo */
 .ref-num {
    display: inline-block;
    color: #ffffff; /* Branco por defeito */
    font-size: 0.75em;
    font-weight: 800;
    margin-right: 8px;
    border: 1px solid #444; /* Borda cinza discreta */
    padding: 0 5px;
    border-radius: 3px;
    transition: all 0.3s ease;
    cursor: default;
    user-select: none;
}
    
    /* N√∫mero com dados associados */
.ref-num.has-data {
    color: #3498db !important; /* Azul */
    border-color: #3498db !important;
    background: rgba(52, 152, 219, 0.1);
    cursor: pointer;
    text-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
}

.ref-num.has-data:hover {
    background: rgba(52, 152, 219, 0.2);
    transform: scale(1.1);
}

    /* --- DESTAQUES (Picotado) --- */
    .highlight-picotado {
        background-image: linear-gradient(to right, var(--accent-color) 50%, transparent 50%);
        background-position: bottom; background-size: 6px 3px; background-repeat: repeat-x;
        padding-bottom: 2px; text-decoration: none !important;
        cursor: pointer; position: relative; z-index: 1;
    }
    
    /* --- BARRA FLUTUANTE DE SELE√á√ÉO --- */
    #selection-toolbar {
        position: absolute; z-index: 9999; background-color: #252528; border: 1px solid #444;
        border-radius: 8px; padding: 5px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        gap: 10px; align-items: center;
    }
    #selection-toolbar button {
        background: #333; border: none; color: #fff; padding: 6px 12px; border-radius: 4px;
        cursor: pointer; font-size: 0.9rem;
    }
    #selection-toolbar button:hover { background: var(--accent-color); }

    @media (max-width: 768px) {
        #selection-toolbar {
            position: fixed !important; top: auto !important; bottom: 20px !important;
            left: 50% !important; transform: translateX(-50%) !important; width: 90%; justify-content: center;
        }
    }

    /* --- PAINEL LATERAL (4¬™ COLUNA) --- */
    #side-panel {
        width: 0; background-color: #1f1f22; border-left: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        transition: width 0.3s ease; flex-shrink: 0; z-index: 1000;
        position: relative;
    }
    #side-panel.open { width: 400px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
    
    @media (max-width: 768px) {
        #side-panel {
            position: fixed; bottom: 0; left: 0; right: 0; top: auto;
            width: 100vw !important; height: 0; border-radius: 20px 20px 0 0;
            transition: height 0.3s ease;
        }
        #side-panel.open { height: 75vh; width: 100vw !important; }
    }

    .side-header {
        padding: 10px 15px; border-bottom: 1px solid #333; display: flex;
        justify-content: space-between; align-items: center; background: #252528;
    }
    .side-content { flex: 1; overflow-y: auto; padding: 15px; }


    /* --- MODAL NOTA FLASH --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 11000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 500px; border-radius: 8px;
        border: 1px solid #333; padding: 15px; display: flex; flex-direction: column;
    }
    .flash-editor {
        min-height: 100px; background: rgba(0,0,0,0.2); border: 1px solid #333;
        padding: 10px; color: #fff; margin-bottom: 10px; white-space: pre-wrap;
    }
    
    /* Seletor de Cores */
    .color-picker-container { display: flex; gap: 8px; margin-bottom: 15px; }
    .color-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-btn.selected { border-color: white; transform: scale(1.1); }

    /* Loader */
    #global-auth-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; }
    .global-spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* --- ESTILOS DA TOOLBAR FLASH (Igual √† B√≠blia) --- */
.flash-toolbar {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
}

.flash-toolbar button {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.flash-toolbar button:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Dropdown √† direita */
#flash-type-select {
    margin-left: auto; /* Empurra para a direita */
    background: #252528;
    color: #fff;
    border: 1px solid #444;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    outline: none;
    cursor: pointer;
}

/* Bolas de Cor */
.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px;
    overflow-x: auto;
}

.color-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-btn:hover { transform: scale(1.1); }
.color-btn.selected { border-color: white; transform: scale(1.2); }

/* --- ESTILOS DO MODAL DE LINKS & CODEX --- */
.codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.serie-wrapper {
    flex: 1;
}

.codex-label {
    display: block;
    font-size: 0.7rem;
    font-weight: bold;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.codex-input-modern {
    width: 100%;
    background: #151515;
    border: 1px solid #444;
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    outline: none;
}
.codex-input-modern:focus { border-color: var(--accent-color); }

.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
}

.pages-container, .paragraphs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    min-height: 30px;
}

/* Chips (P√≠lulas) de n√∫meros */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: #333;
    border: 1px solid #555;
    border-radius: 15px;
    padding: 2px 8px;
    font-size: 0.85rem;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: white;
    width: 35px;
    text-align: center;
    outline: none;
    font-family: monospace;
}

.btn-unit-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-weight: bold;
    margin-left: 2px;
    padding: 0 4px;
}

/* Bot√£o Redondo (+) */
.btn-unit-add {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px dashed #666;
    color: #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-unit-add:hover {
    background: var(--accent-color);
    color: white;
    border-style: solid;
}

.remove-codex-row {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
}
.remove-codex-row:hover { opacity: 1; }

/* Contexto da Refer√™ncia */
#flash-links-context {
    background: rgba(52, 152, 219, 0.1);
    border-left: 4px solid #3498db;
    padding: 8px 12px;
    margin-bottom: 15px;
    color: #ddd;
    font-size: 0.9rem;
    border-radius: 0 4px 4px 0;
}

/* --- ESTILOS DE NAVEGA√á√ÉO DE CAP√çTULOS --- */
.nav-arrow {
    background: none;
    border: none;
    color: #888;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 10px;
    transition: color 0.2s, transform 0.2s;
    vertical-align: middle;
}
.nav-arrow:hover {
    color: var(--accent-color);
    transform: scale(1.2);
}


.nav-cap-btn {
    background: #333 !important;
    color: white !important;
    border: 1px solid #444 !important;
    padding: 15px 5px !important;
    text-align: center !important;
    border-radius: 6px !important;
    font-weight: bold !important;
}
.nav-cap-btn:hover { background-color: #444; color: white; }
.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Estilo para o t√≠tulo da publica√ß√£o no corpo */
.pub-body-title {
    font-size: 1.2rem;
    font-weight: 800;
    color: #888;
    text-align: center;
    margin-bottom: 5px;
}

/* Navega√ß√£o secund√°ria (abaixo do t√≠tulo) */
.secondary-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.secondary-nav .nav-arrow {
    font-size: 1.4rem;
    color: #888;
}

.secondary-nav span {
    font-size: 1.1rem;
    color: #eee;
    cursor: pointer;
    border-bottom: 1px dotted #555;
}

/* T√≠tulo do Cap√≠tulo em Azul (Imagem 2) */
.reader-chapter-title {
    color: #3498db; /* Azul da sua paleta */
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 25px;
    line-height: 1.2;
    text-align: left; /* Alinhado √† esquerda como na imagem */
}

/* Ajuste no t√≠tulo do livro (cinza em cima) */
.pub-body-title {
    font-size: 1rem;
    font-weight: 800;
    color: #777;
    text-align: left;
    margin-bottom: 8px;
    text-transform: none;
}

/* --- PAINEL DE NAVEGA√á√ÉO DE CAP√çTULOS --- */
#chapter-nav-panel {
    position: fixed !important;
    top: 60px !important; 
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 90vw !important;
    max-width: 500px !important;
    background-color: #252528 !important; 
    border: 2px solid #3498db !important;
    border-radius: 12px !important;
    box-shadow: 0 10px 100px rgba(0,0,0,0.9) !important;
    z-index: 2147483647 !important; 
    padding: 15px !important;
    overflow-y: auto !important;
    max-height: 70vh !important;
    
    /* Estado padr√£o: Escondido */
    display: none; 
}

/* Classe para mostrar o painel */
#chapter-nav-panel.active {
    display: grid !important;
    animation: slideDownFade 0.2s ease-out;
}

@keyframes slideDownFade {
    from { opacity: 0; transform: translate(-50%, -10px); }
    to { opacity: 1; transform: translate(-50%, 0); }
}

/* Remova o !important da classe .hidden para n√£o travar o JS */
.hidden { display: none; }



.nav-cap-btn:hover {
    background-color: #444;
    color: white;
}

.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Classe utilit√°ria para esconder */
.hidden { display: none !important; }

/* Estilo do sublinhado picotado (Destaque) */
.highlight-picotado {
    background-position: bottom;
    background-size: 6px 3px;
    background-repeat: repeat-x;
    padding-bottom: 2px;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
    text-decoration: none !important;
    display: inline;
    cursor: pointer;
    position: relative;
    z-index: 1;
}

.ref-num {
    cursor: pointer !important; /* Todos s√£o clic√°veis agora */
    transition: all 0.2s ease;
}

.ref-num:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #666;
}

/* Estilo do bot√£o +üìù dentro do painel */
.btn-panel-create {
    background: var(--accent-color);
    border: none;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85rem;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
}

.btn-panel-create:hover {
    background: #2980b9;
    transform: scale(1.05);
}

/* Bot√£o Compacto no Cabe√ßalho */
.btn-header-create {
    background: linear-gradient(135deg, #3498db, #2980b9);
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.8rem;
    cursor: pointer;
    margin-left: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    /* Anima√ß√£o de Brilho */
    animation: pulse-glow-blue 2s infinite;
    transition: transform 0.2s;
}

.btn-header-create:hover {
    transform: scale(1.1);
}

/* Anima√ß√£o do Brilho (Glow) */
@keyframes pulse-glow-blue {
    0% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
    50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
    100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
}

/* Ajuste no Header do Painel Lateral para alinhar tudo */
.side-header {
    padding: 10px 15px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center; /* Alinha verticalmente t√≠tulo, bot√£o e fechar */
    background: #252528;
}

#side-title-container {
    display: flex;
    align-items: center;
    flex-grow: 1; /* Empurra o bot√£o 'x' para a ponta direita */
}

/* Ajuste do formul√°rio quando dentro do painel lateral */
.side-content .flash-editor {
    min-height: 200px;
    font-size: 0.9rem;
}

.side-content .flash-toolbar {
    flex-wrap: wrap; /* Permite que os bot√µes quebrem linha se o painel for estreito */
}

/* Esconder o t√≠tulo original do painel quando em modo de edi√ß√£o no PC */
.editing-mode #side-title-container {
    display: none;
}

.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px 2px;
    overflow-x: auto; /* Permite deslizar para o lado se n√£o couber */
    scrollbar-width: none; /* Esconde scrollbar no Firefox */
}
.color-picker-container::-webkit-scrollbar {
    display: none; /* Esconde scrollbar no Chrome/Safari */
}

.color-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0; /* Impede que as bolas fiquem ovais */
    border: 2px solid transparent;
    transition: transform 0.2s;
}
.color-btn.selected {
    border-color: white;
    transform: scale(1.2);
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

/* --- INPUT DE T√çTULO PROFISSIONAL --- */
.flash-input-title {
    width: 100%;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid #444 !important; /* Linha fina do Bible */
    color: #e67e22 !important; /* Cor laranja de estudo */
    font-size: 1.2rem !important;
    font-weight: bold !important;
    margin-bottom: 15px !important;
    padding: 5px 0 !important;
    outline: none !important;
}

.flash-input-title::placeholder {
    color: #444;
}

/* --- DESIGN DE LINKS INTEGRADO --- */
.flash-url-row, .codex-row {
    background: rgba(0,0,0,0.2) !important;
    border: 1px solid #333 !important;
    border-radius: 4px !important;
    padding: 8px !important;
    margin-bottom: 10px !important;
    display: flex;
    align-items: center;
    gap: 10px;
}

.flash-url-row input, .codex-input-modern {
    background: transparent !important;
    border: none !important;
    color: #fff !important;
    outline: none !important;
    font-size: 0.9rem !important;
    flex: 1;
}

/* Bot√£o de fechar/remover nos links */
.btn-remove-row {
    background: none !important;
    border: none !important;
    color: #e74c3c !important;
    font-weight: bold !important;
    cursor: pointer !important;
    font-size: 1.2rem !important;
}

/* --- ABAS (TABS) DESIGN BIBLE.HTML --- */
.store-tabs-header {
    display: flex;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    padding: 0 5px;
}

.store-tab-btn {
    flex: 1;
    background: none;
    border: none;
    color: #666;
    padding: 12px 0;
    font-size: 0.85rem;
    font-weight: bold;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.store-tab-btn.active {
    color: #fff;
    border-bottom-color: var(--accent-color);
}

/* --- INPUTS E LINHAS (URL / CODEX) --- */
.flash-url-row, .codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.flash-url-row input, .codex-input-modern {
    background: #111 !important;
    border: 1px solid #333 !important;
    color: white !important;
    padding: 8px 12px !important;
    border-radius: 4px !important;
    font-size: 0.9rem !important;
    outline: none;
}

/* --- CODEX AVAN√áADO (BOT√ïES A, M, T, C) --- */
.manual-controls {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.btn-control-small {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: bold;
}

.btn-control-small.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Toggle Switch (Interruptor) */
.setting-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
}
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #444; transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(16px); }

/* --- ESTILO DO TOGGLE SWITCH (BIBLE STYLE) --- */
.setting-switch {
    position: relative;
    display: inline-block;
    width: 38px;
    height: 20px;
    flex-shrink: 0;
}

.setting-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #333;
    transition: .3s;
    border-radius: 20px;
    border: 1px solid #444;
}

.slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 2px;
    bottom: 2px;
    background-color: #777;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

input:checked + .slider:before {
    transform: translateX(18px);
    background-color: white;
}

/* Pontos de cor na Toolbar */
.color-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.2s;
}
.color-dot:hover { transform: scale(1.3); }

/* Estilo do texto destacado (Sublinhado com cor de fundo) */
.direct-highlight {
    background-color: var(--highlight-bg);
    border-bottom: 2px solid var(--highlight-color);
    padding-bottom: 1px;
    cursor: pointer;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
}

/* Ajuste mobile para a toolbar n√£o estoirar */
@media (max-width: 768px) {
    #selection-toolbar {
        flex-wrap: wrap;
        height: auto !important;
        padding: 10px;
    }
    #toolbar-colors {
        margin-top: 5px;
        width: 100%;
        justify-content: center;
    }
}

/* --- DESIGN FIEL AO NOTEBOOK NO PAINEL LATERAL --- */
#side-panel {
    width: 0; 
    background-color: #1a1a1d; /* Fundo id√™ntico ao NoteBook */
    border-left: 1px solid #333;
    display: flex; 
    flex-direction: column; 
    overflow: hidden;
    transition: width 0.3s ease; 
    flex-shrink: 0; 
    z-index: 1000;
}

/* Barra de Abas do Painel */
.sidebar-tabs {
    display: flex;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    position: sticky;
    top: 0;
    z-index: 10;
}

.tab-btn {
    flex: 1;
    background: none;
    border: none;
    padding: 12px 0;
    cursor: pointer;
    color: #666;
    font-size: 1.1rem;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
}

.tab-btn:hover { color: #aaa; }

.tab-btn.active {
    color: #fff;
    border-bottom-color: #3498db; /* Azul do NoteBook */
    background: linear-gradient(to top, rgba(52, 152, 219, 0.1), transparent);
}

/* Estilo das Micas (Dossi√©) no Dossi√™ */
.mica-folder {
    background-color: #1e1e20;
    border: 1px solid #333;
    border-radius: 6px;
    margin-bottom: 10px;
    overflow: hidden;
}

.mica-header {
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 0.9rem;
    background: rgba(255,255,255,0.02);
}

.mica-content {
    background: #141416;
    padding: 10px;
}


/* R√≥tulo pequeno no topo do card (ex: SUBNOTA, QUEST√ÉO) */
.card-label {
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
    display: block;
    opacity: 0.8;
}


.card-note-title:hover { text-decoration: underline; color: var(--accent-color); }



.card-options-btn:hover { color: #fff; }

/* Estilo espec√≠fico para o Dossi√™ (Micas) */
.mica-folder {
    border: 1px solid #333;
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.02);
}

/* --- ESTILO DOS CARDS (FIEL √Ä FOTO 2) --- */
.detail-card {
    background: #1a1a1d; /* Cor de fundo id√™ntica √† imagem */
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-left: 4px solid #3498db; /* Barra azul na esquerda */
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* T√≠tulo em destaque (Bold) */
.card-note-title {
    color: #3498db; /* Azul igual ao "Teste2" da imagem */
    font-weight: bold;
    font-size: 1.05rem;
    cursor: pointer;
    text-decoration: none;
    display: block;
}

/* Texto de baixo (Snippet limpo) */
.card-snippet {
    color: #cecece; /* Cinza claro para o conte√∫do */
    font-size: 0.95rem;
    line-height: 1.5;
    white-space: pre-wrap; /* Mant√©m quebras de linha b√°sicas */
    word-break: break-word;
}

/* Bot√£o de Op√ß√µes (..) no canto superior direito */
.card-options-btn {
    position: absolute;
    top: 10px;
    right: 12px;
    color: #555;
    cursor: pointer;
    font-size: 18px;
}
.card-options-btn:hover { color: #fff; }

/* Ajuste das Micas para seguirem o mesmo padr√£o */
.mica-folder {
    border: 1px solid #333;
    border-radius: 6px;
    margin-bottom: 8px;
    background: #1a1a1d;
}


/* Contentor dos dois pontos */
.card-menu-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
}

.card-menu-btn {
    cursor: pointer;
    color: #666;
    font-size: 16px;
    padding: 2px 5px;
    transition: color 0.2s;
    user-select: none;
}
.card-menu-btn:hover { color: #fff; }

/* Menu Suspenso (Dropdown) */
.card-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 25px;
    background: #252528;
    border: 1px solid #444;
    border-radius: 6px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    min-width: 130px; /* Um pouco mais largo para caber o texto */
    flex-direction: column;
    overflow: hidden;
    z-index: 9999; /* GARANTE QUE APARE√áA POR CIMA */
}

.card-dropdown.visible { display: flex; }

.card-dropdown button {
    background: none;
    border: none;
    color: #ccc;
    padding: 10px 15px;
    text-align: left;
    cursor: pointer;
    font-size: 0.85rem;
    width: 100%;
    border-bottom: 1px solid #333;
}

.card-dropdown button:last-child { border-bottom: none; }
.card-dropdown button:hover { background: #333; color: white; }

/* Bot√£o Remover em destaque */
.btn-remove-card:hover { background: #c0392b !important; color: white !important; }

#edit-card-modal {
    display: none; /* Come√ßa escondido */
    position: fixed; /* Garante que fica fixo na tela */
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.85); /* Fundo escuro */
    z-index: 110000 !important; /* MAIOR que o shield (99999) */
    justify-content: center;
    align-items: center;
}

#edit-card-modal .modal-content {
    background: #1f1f22;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 550px;
    border: 1px solid #444;
}

/* Estilo para o destaque s√≥lido (Direct Highlight) */
.direct-highlight {
    background-color: var(--highlight-bg);
    border-bottom: 2px solid var(--highlight-color);
    padding-bottom: 1px;
    cursor: pointer;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
    /* ADICIONA ESTAS DUAS LINHAS: */
    user-select: text !important;
    -webkit-user-select: text !important;
}

/* Estilo para o destaque picotado (Nota Flash) */
.highlight-picotado {
    background-image: linear-gradient(to right, var(--accent-color) 50%, transparent 50%);
    background-position: bottom; 
    background-size: 6px 3px; 
    background-repeat: repeat-x;
    padding-bottom: 2px; 
    text-decoration: none !important;
    cursor: pointer; 
    position: relative; 
    z-index: 1;
    /* ADICIONA ESTAS DUAS LINHAS: */
    user-select: text !important;
    -webkit-user-select: text !important;
}


#custom-confirm-modal .modal-content {
    background: #1f1f22;
    border: 1px solid #444;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    transform: scale(0.9);
    transition: transform 0.2s ease;
}

#custom-confirm-modal.visible .modal-content {
    transform: scale(1);
}

#confirm-ok-btn:hover { background: #c0392b !important; }
#confirm-cancel-btn:hover { background: #444 !important; }

/* Estilos para os Chips (Piccards) de filtragem */
.lib-pub-chip {
    background: #252528;
    color: #ccc;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    white-space: nowrap;
    cursor: pointer;
    border: 1px solid #444;
    transition: 0.2s;
    flex-shrink: 0;
}
.lib-pub-chip.active {
    background: rgba(52, 152, 219, 0.2);
    border-color: var(--accent-color);
    color: white;
}

/* Itens de Resultado */
.lib-res-item {
    padding: 15px;
    border-bottom: 1px solid #222;
    cursor: pointer;
    transition: background 0.2s;
}
.lib-res-item:hover { background: #1a1a1a; }
.lib-res-pub { font-size: 0.7rem; color: var(--accent-color); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; }
.lib-res-title { font-size: 0.85rem; color: #888; font-weight: bold; margin-bottom: 5px; }
.lib-res-text { font-size: 0.95rem; color: #ddd; line-height: 1.5; }

/* Destaque das palavras */
.search-term-highlight {
    background-color: rgba(52, 152, 219, 0.25);
    border-bottom: 1px solid var(--accent-color);
    color: #fff;
    padding: 0 2px;
    border-radius: 2px;
}

/* Cabe√ßalho de Grupo (Modo P√°gina) */
.lib-search-group-header {
    background: #111;
    padding: 10px 15px;
    color: #555;
    font-weight: 800;
    font-size: 0.75rem;
    text-transform: uppercase;
    border-left: 4px solid #333;
    margin-top: 10px;
}

/* Toggle Switch (Igual ao da B√≠blia) */
.scope-group {
    display: flex;
    background: #111;
    padding: 2px;
    border-radius: 20px;
    border: 1px solid #333;
}
.scope-btn {
    background: none; border: none; color: #666; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.75rem; transition: 0.2s;
}
.scope-btn.active { background: var(--accent-color); color: white; }

.testament-btn {
    background: none; border: none; color: #888; cursor: pointer; padding: 4px 0; border-bottom: 2px solid transparent; font-weight: 500; font-size: 0.9rem;
}
.testament-btn.active { color: white; border-bottom-color: var(--accent-color); font-weight: bold; }

/* Chips/Piccards de Publica√ß√µes */
.lib-pub-chip {
    background: #252528;
    color: #ccc;
    padding: 6px 14px;
    border-radius: 15px;
    font-size: 0.75rem;
    white-space: nowrap;
    cursor: pointer;
    border: 1px solid #444;
    transition: 0.2s;
    flex-shrink: 0;
}
.lib-pub-chip.active {
    background: rgba(52, 152, 219, 0.2);
    border-color: var(--accent-color);
    color: white;
}

/* Item de Resultado na Lista */
.lib-res-item {
    padding: 15px;
    border-bottom: 1px solid #222;
    cursor: pointer;
    transition: background 0.2s;
}
.lib-res-item:hover { background: #1a1a1a; }
.lib-res-pub { font-size: 0.65rem; color: var(--accent-color); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
.lib-res-title { font-size: 0.8rem; color: #777; font-weight: bold; margin-bottom: 6px; }
.lib-res-text { font-size: 0.95rem; color: #ddd; line-height: 1.5; }

/* Destaque das palavras encontradas (Sublinhado Leve) */
.search-term-highlight {
    background-color: rgba(52, 152, 219, 0.2);
    border-bottom: 1px solid rgba(52, 152, 219, 0.5);
    color: #fff;
    padding: 0 1px;
}

/* Cabe√ßalho de Grupo no Modo P√°gina */
.lib-search-group-header {
    background: #1a1a1a;
    padding: 8px 15px;
    color: #555;
    font-weight: 800;
    font-size: 0.7rem;
    text-transform: uppercase;
    border-left: 4px solid var(--accent-color);
    margin: 15px 0 5px 0;
}


.nav-cap-btn:hover {
    background-color: #333;
    border-color: var(--accent-color);
    color: white;
}

.nav-cap-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
}


@keyframes slideDownFade {
    from { opacity: 0; transform: translate(-50%, -10px); }
    to { opacity: 1; transform: translate(-50%, 0); }
}

/* Quando esta classe for adicionada, ele aparece */
#chapter-nav-panel.show-now {
    display: grid !important; 
    gap: 10px;
}

/* Remova o !important desta classe se ela existir */
.hidden { display: none; }

/* Estilo para refer√™ncias b√≠blicas clic√°veis mas invis√≠veis no texto */
.bible-ref-ghost {
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: pointer;
    display: inline; /* Garante que se comporta como texto */
}

/* 2. Garante que os destaques (picotados ou s√≥lidos) permitem sele√ß√£o */
.highlight-picotado, .direct-highlight {
    user-select: text !important;
    -webkit-user-select: text !important;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
}
body {
    user-select: auto; 
}

/* Bloqueie a sele√ß√£o apenas na UI (Interface), n√£o no texto */
header, aside, .sidebar-tabs, button, .nav-arrow, .ref-num {
    user-select: none !important;
    -webkit-user-select: none !important;
}

.bible-ref-ghost:hover {
    background-color: rgba(52, 152, 219, 0.1);
    border-bottom-color: var(--accent-color);
}

/* Estilo para o conte√∫do da aba B√≠blia no painel lateral */
#ref-content-bibletext {
    padding: 15px;
    font-size: 1.1rem;
    line-height: 1.6;
    color: #eee;
}

#ref-content-bibletext h3 {
    color: var(--accent-color);
    border-bottom: 1px solid #333;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

/* Destaque para a aba de B√≠blia quando ativa */
.tab-btn[data-ref-tab="bibletext"].active {
    color: #2ecc71 !important; /* Verde b√≠blico */
    border-bottom-color: #2ecc71 !important;
}

/* Efeito Piscar para o Icon da Aba üìü */
@keyframes tab-blink {
    0%, 100% { opacity: 1; color: #e67e22; }
    50% { opacity: 0.3; color: #fff; }
}
.tab-blinking { animation: tab-blink 0.8s infinite; }

/* Radar/Dish Loader do X-Ray */
.loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; color: var(--accent-color); }
.scanner-ui { position: relative; width: 80px; height: 80px; margin-bottom: 15px; }
.dish {
    position: absolute; bottom: 20%; left: 50%; width: 50px; height: 25px;
    border: 3px solid var(--accent-color); border-radius: 50% 50% 0 0;
    transform: translateX(-50%) rotate(180deg); background: rgba(52, 152, 219, 0.1);
}
.dish::after { content: ''; position: absolute; top: -15px; left: 50%; width: 2px; height: 20px; background: var(--accent-color); transform: translateX(-50%); }
.wave { position: absolute; top: 15%; left: 50%; border: 2px solid var(--accent-color); border-radius: 50%; transform: translateX(-50%); opacity: 0; animation: wave-pulse 2s infinite; }
.wave-1 { width: 20px; height: 10px; animation-delay: 0s; }
.wave-2 { width: 40px; height: 20px; animation-delay: 0.5s; }
.wave-3 { width: 60px; height: 30px; animation-delay: 1s; }
@keyframes wave-pulse { 0% { transform: translateX(-50%) scale(0.5); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateX(-50%) scale(1.2); opacity: 0; } }



.xray-pane { display: none; padding: 10px; }
.xray-pane.active { display: block; }

.xray-empty-msg {
    padding: 30px 20px;
    text-align: center;
    color: #555;
    font-size: 0.8rem;
}

/* Barra de Chips de Vers√≠culos no X-Ray */
.xray-verse-bar {
    display: flex;
    gap: 8px;
    padding: 12px 15px;
    overflow-x: auto;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    scrollbar-width: none;
}
.xray-verse-bar::-webkit-scrollbar { display: none; }



.verse-chip.active {
    background: rgba(52, 152, 219, 0.2);
    border-color: var(--accent-color);
    color: white;
}

.xray-verse-bar {
    display: flex;
    gap: 8px;
    padding: 12px 5px;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none; /* Firefox */
}
.xray-verse-bar::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}

/* Estilo para quando o chip est√° selecionado */
.verse-chip.active {
    opacity: 1;
    background: rgba(52, 152, 219, 0.2);
    border-color: var(--accent-color);
    color: white;
}


.nav-arrow-xray {
    background: none;
    border: none;
    color: #444;
    font-size: 1rem; /* Seta menor */
    cursor: pointer;
    padding: 0 5px;
}

/* Container que une as abas */
.xray-sub-tabs {
    display: flex;
    justify-content: center;
    padding: 15px 20px 10px 20px;
    background: #000;
}


.verse-chip {
    border: 1px solid #3498db;
    background: transparent;
    color: white;
    padding: 1px 12px; /* Redu√ß√£o m√°xima de altura */
    border-radius: 15px;
    font-size: 0.75rem;
    white-space: nowrap;
    cursor: pointer;
}

.verse-chip.inactive {
    border-color: #333; /* Borda escura */
    color: #444;        /* Texto cinza escuro */
    background: transparent;
    opacity: 0.6;       /* Fica semi-transparente */
}

/* Remove o padding do topo do contentor quando o X-Ray est√° ativo */
#side-content.xray-active {
    padding-top: 0 !important;
}


/* Remove qualquer padding lateral do contentor pai no modo X-Ray */
#side-panel.open #side-content.xray-active {
    padding-left: 0 !important;
    padding-right: 0 !important;
    padding-top: 0 !important;
}

/* Contentor de Sub-Abas: Ocupa 100% */
.xray-sub-tabs-annex {
    width: 100%;
    background: #111;
    border-bottom: 1px solid #222;
}

/* Grupo de Sub-Abas: Flexbox sem restri√ß√£o de largura */
.xray-sub-group {
    display: flex;
    width: 100%;
    margin: 0;
    padding: 0;
}

/* Bot√µes: Cada um ocupa exatamente 50% */
.xray-sub-btn {
    flex: 1; 
    background: transparent;
    border: none;
    color: #555; /* Cor desativada */
    padding: 14px 0;
    font-size: 0.75rem;
    font-weight: 800;
    cursor: pointer;
    text-transform: uppercase;
    position: relative;
    transition: color 0.2s;
}

/* Sub-aba Ativa: Cor Azul e Linha Inferior Infinita */
.xray-sub-btn.active {
    color: #3498db;
    background: rgba(255, 255, 255, 0.02);
}

.xray-sub-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%; /* Linha vai de uma ponta √† outra do bot√£o */
    height: 2px;
    background: #3498db;
}

/* Ajuste do Piccard para manter o fundo preto s√≥lido logo abaixo */
.filter-nav-container {
    width: 100%;
    background: #000;
    padding: 12px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

/* Contentor que envolve as setas e a barra */
.filter-nav-container {
    display: flex;
    align-items: center;
    background: #000;
    padding: 5px 0;
}

/* Estilo das setas */
.nav-arrow-xray {
    background: none;
    border: none;
    color: #444; /* Cor discreta */
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 10px;
    transition: color 0.2s;
    user-select: none;
}

.nav-arrow-xray:hover {
    color: var(--accent-color);
}

/* Ajuste na barra para ocupar o espa√ßo central */
#xray-bar {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none; /* Esconde scrollbar no Firefox */
    scroll-behavior: smooth;
    flex: 1;
}

#xray-bar::-webkit-scrollbar {
    display: none; /* Esconde scrollbar no Chrome/Safari */
}

</style>


</head>
<body>


    <!-- ESCUDO DE CARREGAMENTO INICIAL -->
    <div id="global-auth-shield">
        <div class="global-spinner"></div>
    </div>

    <!-- CABE√áALHO -->
   <header>
    <button id="back-btn">‚¨Ö</button>
    <div id="page-title">Biblioteca</div>
    <button id="search-library-btn" style="background:none; border:none; font-size:1.3rem; cursor:pointer; color:white; margin-left: 10px;">üîç</button>
    <!-- Bot√£o de Defini√ß√µes -->
    <button id="settings-btn" style="background:none; border:none; font-size:1.3rem; cursor:pointer; color:white; margin-left: 10px;">‚öôÔ∏è</button>
</header>

<!-- MODAL DE DEFINI√á√ïES -->
<div id="settings-modal" class="modal-overlay" style="z-index: 19000;">
    <div class="modal-content" style="max-width: 400px; background: #1a1a1d;">
        <div class="side-header">
            <h3>Defini√ß√µes</h3>
            <button onclick="document.getElementById('settings-modal').style.display='none'" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">√ó</button>
        </div>
        <div style="padding: 20px;">
            <h4 style="color: var(--accent-color); font-size: 0.8rem; text-transform: uppercase; margin-bottom: 15px;">üìü X-Ray Scanner</h4>
            
            <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                <div>
                    <div style="color: white; font-size: 0.9rem; font-weight: bold;">Pesquisa Vers√≠culos Individualmente</div>
                    <div style="color: #666; font-size: 0.75rem; margin-top: 4px;">Ao encontrar "Rom 7:21-24", pesquisa tamb√©m cada vers√≠culo isolado.</div>
                </div>
                <label class="setting-switch">
                    <input type="checkbox" id="xray-deep-search" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>


    <div id="main-layout">
        <!-- √ÅREA PRINCIPAL (LEITURA) -->
        <div class="container" id="content-container">
            <!-- Vistas Din√¢micas (Grid Livros, Cap√≠tulos, Texto) -->
        </div>

        <!-- PAINEL LATERAL (NOTAS) -->
  <aside id="side-panel">
    <div class="side-header">
        <div id="side-title-container" style="display: flex; align-items: center; gap: 10px; flex-grow: 1;">
            <span id="side-title" style="color: var(--accent-color); font-weight: bold;">Notas</span>
            <!-- O bot√£o +üìù ser√° injetado aqui via JS -->
        </div>
        <button onclick="window.closeSidePanel()" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;line-height:1;">√ó</button>
    </div>

    <!-- ABAS SEMPRE VIS√çVEIS -->
<div class="sidebar-tabs" id="library-ref-tabs" style="display: none;">
    <button class="tab-btn active" data-ref-tab="puzzle" title="Quadro">üß©</button>
    <button class="tab-btn" data-ref-tab="links" title="Links">‚ö°</button>
    <button class="tab-btn" data-ref-tab="dossie" title="Micas">üìº</button>
    <!-- Aba de Segmentos (escondida por padr√£o) -->
    <button class="tab-btn" data-ref-tab="para-xray" title="X-Ray Par√°grafo" id="tab-xray-btn" style="display: none;">üìü</button>
        <button class="tab-btn" data-ref-tab="enxertos" id="tab-enxertos-btn" style="display:none;" title="Segmentos Selecionados">‚ùõ‚ùõ‚ùû</button>
    <button class="tab-btn" data-ref-tab="bibletext" title="B√≠blia" id="tab-bible-btn" style="display:none;">üìú</button> 
</div>

    <div class="side-content" id="side-content">
        <!-- Aqui aparece ou o formul√°rio de cria√ß√£o ou a lista de refer√™ncias -->
    </div>
</aside>
    </div>

    <!-- BARRA DE SELE√á√ÉO FLUTUANTE -->
   <div id="selection-toolbar">
    <button id="btn-copy" title="Copiar">üìë</button>
    <button id="btn-flash-note" title="Nota Flash">‚úç</button>
    
    <!-- Separador -->
    <div style="width: 1px; height: 20px; background: #444; margin: 0 5px;"></div>
    
    <!-- Cores de Destaque -->
    <div id="toolbar-colors" style="display: flex; gap: 8px; align-items: center; padding: 0 5px;">
        <div class="color-dot" data-color="#e74c3c" style="background:#e74c3c" title="Vermelho"></div>
        <div class="color-dot" data-color="#e67e22" style="background:#e67e22" title="Laranja"></div>
        <div class="color-dot" data-color="#f1c40f" style="background:#f1c40f" title="Amarelo"></div>
        <div class="color-dot" data-color="#2ecc71" style="background:#2ecc71" title="Verde"></div>
        <div class="color-dot" data-color="#3498db" style="background:#3498db" title="Azul"></div>
        <div class="color-dot" data-color="#9b59b6" style="background:#9b59b6" title="Roxo"></div>
        <div class="color-dot" data-color="#95a5a6" style="background:#95a5a6" title="Cinzento"></div>
        <div class="color-dot" data-color="#8d6e63" style="background:#8d6e63" title="Castanho"></div>
        <button id="btn-remove-highlight" title="Retirar Cor" style="background:none; border:1px solid #666; color:#888; width:22px; height:22px; border-radius:50%; padding:0; font-size:10px; display:flex; align-items:center; justify-content:center;">‚úï</button>
    </div>
</div>


    <!-- MODAL DE CRIA√á√ÉO DE NOTA -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <div style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <button onclick="window.closeFlashModal()" style="background:none; border:none; color:#888; font-size:18px; cursor:pointer; margin-right:10px;">‚¨Ö</button>
                <h3 style="color:#e67e22; margin:0;">Nova Nota</h3>
                <button onclick="window.closeFlashModal()" style="margin-left:auto; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota..." style="font-size:1.2em; margin-bottom:15px;">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')" title="Negrito"><b>B</b></button>
                <button onclick="document.execCommand('italic')" title="It√°lico"><i>I</i></button>
                <button onclick="document.execCommand('underline')" title="Sublinhado"><u>U</u></button>
                <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                <button id="btn-flash-topics" onclick="window.openTopicsModal()" title="T√≥picos">üìã</button>
                <button id="btn-flash-links" onclick="window.openFlashLinkManager()" title="Gest√£o de Links">‚ö°</button>
                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            <div class="color-picker-container" id="color-picker"></div>

            <div style="margin-top: 5px; font-size: 0.8rem; color: #888; display:flex; align-items:center; gap:5px;">
                <span style="font-size:1.2em;">üìö</span> Codex: 
                <span id="flash-codex-info" style="color: #3498db; font-weight:bold;"></span>
            </div>

            <button id="btn-save-flash" onclick="window.saveLibraryFlashNote()" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1rem;">
                GRAVAR NOTA
            </button>
        </div>
    </div>

    <!-- MODAL DE T√ìPICOS -->
    <div id="flash-topics-modal" class="modal-overlay" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
            <div class="side-header">
                <h3>T√≥picos do Bloco</h3>
                <button onclick="document.getElementById('flash-topics-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div style="display: flex; flex: 1; overflow: hidden;">
                <div style="flex: 1; border-right: 1px solid #333; padding: 10px; overflow-y: auto;">
                    <h4 style="color:#e67e22; font-size:0.8rem; margin-bottom:10px;">T√ìPICOS</h4>
                    <ul id="flash-topics-list" style="list-style:none;">Carregando...</ul>
                </div>
                <div style="flex: 1; padding: 10px; overflow-y: auto;">
                    <h4 style="color:#3498db; font-size:0.8rem; margin-bottom:10px;" id="flash-sub-title">SUBT√ìPICOS</h4>
                    <ul id="flash-subtopics-list" style="list-style:none;">
                        <li style="color:#888; font-style:italic;">Selecione um t√≥pico.</li>
                    </ul>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
                <button onclick="document.getElementById('flash-topics-modal').style.display='none'" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LINKS -->
    <div id="flash-links-modal" class="modal-overlay" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
            <div class="side-header">
                <h3>Gest√£o de Links</h3>
                <button onclick="document.getElementById('flash-links-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div style="padding: 15px 15px 0 15px;">
                <div id="flash-links-context"></div>
            </div>
            <div class="store-tabs-header" style="padding: 10px 15px; border-bottom: 1px solid #333; display: flex; gap: 10px;">
                <button class="store-tab-btn active" onclick="window.switchFlashLinkTab('refs')">Refer√™ncias</button>
                <button class="store-tab-btn" onclick="window.switchFlashLinkTab('codex')">Codex</button>
                <button class="store-tab-btn" onclick="window.switchFlashLinkTab('cats')">Categorias</button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 15px;">
                <div id="flash-tab-refs">
                    <input type="text" id="flash-link-title" class="flash-input-title" style="font-size:1rem;" placeholder="T√≠tulo do Grupo...">
                    <div id="flash-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <button onclick="window.addFlashUrlField()" style="margin-top:10px; padding:6px 12px; background:#333; border:1px solid #555; color:#ccc; cursor:pointer; border-radius:4px;">+ Adicionar URL</button>
                </div>
                <div id="flash-tab-codex" style="display:none;">
                    <div id="flash-codex-rows-container"></div>
                    <button onclick="window.createFlashCodexRow()" style="width:100%; margin-top:15px; padding:10px; background:rgba(230, 126, 34, 0.1); border:1px dashed #e67e22; color:#e67e22; cursor:pointer; border-radius:6px;">+ Nova Linha Codex</button>
                </div>
                <div id="flash-tab-cats" style="display:none;">
    
    <!-- Barra de Pesquisa -->
    <div style="margin-bottom: 15px;">
        <label class="codex-label">PESQUISAR T√ìPICO OU LIVRO</label>
        <input type="text" id="flash-cat-search" class="codex-input-modern" 
               placeholder="Ex: Amor, Daniel, Resgate..." 
               oninput="window.searchFlashCategories(this.value)">
    </div>

    <!-- Toggle Switch: Escolher entre T√≥picos ou B√≠blia -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px; padding:10px; background:rgba(255,255,255,0.03); border-radius:6px; border:1px solid #333;">
        <label class="setting-switch">
            <input type="checkbox" id="flash-bible-toggle">
            <span class="slider"></span>
        </label>
        <span style="font-size:0.85rem; color:#ccc; font-weight: 500;">Pesquisar na B√≠blia (Global)</span>
    </div>

    <!-- √Årea de Resultados da Pesquisa -->
    <div id="flash-cat-results" style="max-height:200px; overflow-y:auto; border:1px solid #333; border-radius:6px; background:#111; margin-bottom:20px;">
        <!-- Injetado via JS -->
    </div>

    <!-- √Årea de Itens Selecionados (Chips/P√≠lulas) -->
    <label class="codex-label">VINCULADOS A ESTA NOTA</label>
    <div id="flash-cat-selected" style="display:flex; flex-wrap:wrap; gap:8px; padding-top:5px;">
        <!-- Injetado via JS -->
    </div>
</div>
</div>

    <!-- MODAL DE VISUALIZA√á√ÉO DE FONTES -->
<div id="view-sources-modal" class="modal-overlay" style="z-index: 15000;">
    <div class="modal-content" style="max-width: 400px; max-height: 80vh;">
        <div class="side-header">
            <h3>üìé Fontes & Refer√™ncias</h3>
            <button onclick="document.getElementById('view-sources-modal').style.display='none'" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">√ó</button>
        </div>
        <div class="side-content" id="view-sources-content">
            <!-- Conte√∫do injetado via JS -->
        </div>
    </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE NOTA -->
<div id="edit-card-modal" class="modal-overlay" style="z-index: 12000;">
    <div class="modal-content" style="max-width: 550px;">
        <div style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <h3 style="color:var(--accent-color); margin:0;">Editar Nota</h3>
            <button onclick="document.getElementById('edit-card-modal').style.display='none'" style="margin-left:auto; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <input type="text" id="edit-card-title" class="flash-input-title" placeholder="T√≠tulo...">
        
        <div class="flash-toolbar">
            <button onclick="document.execCommand('bold')"><b>B</b></button>
            <button onclick="document.execCommand('italic')"><i>I</i></button>
            <button onclick="document.execCommand('underline')"><u>U</u></button>
            <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
            <button onclick="window.openTopicsModal()">üìã</button>
            <button onclick="window.openFlashLinkManager()">‚ö°</button>
        </div>

        <div id="edit-card-editor" class="flash-editor" contenteditable="true" style="min-height:200px;"></div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="document.getElementById('edit-card-modal').style.display='none'" style="flex:1; padding:12px; background:#333; color:white; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
            <button id="btn-confirm-edit" style="flex:2; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR ALTERA√á√ïES</button>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o Personalizado -->
<div id="custom-confirm-modal" class="modal-overlay" style="z-index: 20000; display: none; background: rgba(0,0,0,0.8); position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: #1f1f22; border: 1px solid #444; max-width: 350px; text-align: center; padding: 25px; border-radius: 8px;">
        <div style="font-size: 40px; margin-bottom: 15px;">‚ö†Ô∏è</div>
        <h3 style="color: #fff; margin-bottom: 10px;">Remover Destaques?</h3>
        <p style="color: #888; font-size: 0.9rem; margin-bottom: 25px;">Desejas remover todos os destaques de cor deste par√°grafo?</p>
        <div style="display: flex; gap: 10px;">
            <button id="confirm-cancel-btn" style="flex: 1; padding: 12px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">CANCELAR</button>
            <button id="confirm-ok-btn" style="flex: 1; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">REMOVER</button>
        </div>
    </div>
</div>

<!-- POPUP DE CONFIRMA√á√ÉO ULTRA-PRIORIT√ÅRIO -->
<div id="confirm-popup-final" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 1000000 !important; justify-content: center; align-items: center; font-family: sans-serif;">
    <div style="background: #1f1f22; border: 1px solid #444; width: 90%; max-width: 320px; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.7);">
        <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.2rem;">Remover Destaques?</h3>
        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 25px;">Isto ir√° apagar todas as cores de par√°grafo deste artigo. Notas Flash n√£o ser√£o apagadas.</p>
        <div style="display: flex; gap: 10px;">
            <button id="btn-popup-cancel" style="flex: 1; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">VOLTAR</button>
            <button id="btn-popup-confirm" style="flex: 1; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">APAGAR</button>
        </div>
    </div>
</div>


<!-- No HEADER, ao lado do t√≠tulo ou antes do bot√£o voltar (ajusta conforme preferires) -->
<button id="search-library-btn" style="background:none; border:none; font-size:1.2rem; cursor:pointer; margin-left:10px;">üîç</button>

<!-- MODAL DE PESQUISA AVAN√áADA DA BIBLIOTECA -->
<div id="search-library-modal" class="modal-overlay" style="z-index: 18000;">
    <div class="modal-content" style="max-width: 700px; height: 90vh; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
        <div class="side-header">
            <h3>Pesquisar na Biblioteca</h3>
            <button onclick="document.getElementById('search-library-modal').style.display='none'" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">√ó</button>
        </div>
        
        <!-- BARRA DE PESQUISA E FILTROS -->
        <div style="padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333;">
            <input type="text" id="lib-search-input" placeholder="Ex: Jesus Cristo ou &quot;Reino de Deus&quot;" 
                   style="width: 100%; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; border-bottom: 2px solid var(--accent-color);">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <div id="lib-filter-group" style="display: flex; gap: 15px;">
                    <button class="testament-btn active" onclick="window.setLibFilter('all', this)">Todos</button>
                    <button class="testament-btn" onclick="window.setLibFilter('books', this)">Livros</button>
                    <button class="testament-btn" onclick="window.setLibFilter('publicacoes', this)">Publica√ß√µes</button>
                </div>

                <!-- TOGGLE ESCOPO (Aparece via JS) -->
                <div id="lib-scope-container" class="scope-group" style="display: none;">
                    <button id="scope-para" class="scope-btn active" onclick="window.setLibScope('para')">Par√°grafo</button>
                    <button id="scope-page" class="scope-btn" onclick="window.setLibScope('page')">P√°gina</button>
                </div>
            </div>

            <!-- CHIPS DIN√ÇMICOS (Livros/Publica√ß√µes encontrados) -->
            <div id="lib-search-chips" style="display: flex; gap: 8px; overflow-x: auto; margin-top: 12px; padding-bottom: 5px; scrollbar-width: none;"></div>
        </div>

        <!-- LISTA DE RESULTADOS -->
        <div id="lib-search-results" style="flex: 1; overflow-y: auto; padding: 10px; background: #000;">
            <div id="lib-items-container"></div>
            <div id="lib-search-load-more" style="display: none; padding: 20px; text-align: center;">
                <button onclick="window.loadMoreLibResults()" style="background:none; border:1px solid var(--accent-color); color:var(--accent-color); padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:bold;">CARREGAR MAIS RESULTADOS</button>
            </div>
        </div>
    </div>
</div>

    <!-- PAINEL DE NAVEGA√á√ÉO R√ÅPIDA DE CAP√çTULOS (GRELHA) -->
    <div id="chapter-nav-panel" class="hidden"></div>
    <div id="view-sources-modal" class="modal-overlay">...</div>






<script type="module">
import { db, auth } from './js/firebase-config.js';
import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';

// --- ESTADO GLOBAL ---
let currentBookData = null;
let currentPubId = null;   
let currentChapter = null; 
let currentSectionId = null; 
let navStack = [];
let currentFlashTopics = {}; 
let currentFlashLinks = {};
let activeTopicIdForFlash = null;
let currentChapterHighlights = {};
let activeXrayVerseFilter = null;
let currentXrayData = [];

// Estado de Sele√ß√£o e Destaque
let currentSelectionText = "";
let currentSelectedParagraphs = []; 
let selectedColorHex = '#3498db';
let userCustomHighlights = {};
let activeXrayVerseFilters = new Set();
let currentXrayVersesList = [];
 let currentChapterIdx = null;
let cacheXrayHTML = null;   // Armazena o HTML da pesquisa X-Ray
let cacheSegmentoHTML = null; // Armazena o HTML do artigo aberto via X-Ray
let activeParaNum = null;   
let enxertoScrollPos = 0; // Nova vari√°vel para guardar o scroll
let libraryDataCache = {};
let globalEnxertoScroll = 0;


const container = document.getElementById('content-container');


const HIGHLIGHT_COLORS = [
    { name: 'Laranja', hex: '#e67e22' },
    { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' },
    { name: 'Verde', hex: '#2ecc71' },
    { name: 'Rosa', hex: '#ff7979' },
    { name: 'Roxo', hex: '#9b59b6' },
    { name: 'Vermelho', hex: '#e74c3c' },
    { name: 'Vinho', hex: '#822118' },
    { name: 'Castanho', hex: '#8d6e63' },
    { name: 'Cinzento', hex: '#95a5a6' }
];
const SIGLAS_REVISTAS = ['w', 'g', 'mwb', 'km', 'wp'];
const SIGLAS_MULTIMEDIA = ['jwbvod', 'mwbv', 'jwb'];
const MAGAZINE_FOLDERS = {
    'w': 'sentinelas',
    'g': 'despertai',
    'wp': 'sentinelas_publico' // Exemplo caso cries esta pasta
};
// --- CORES PADR√ÉO PARA O SELETOR ---
const DEFAULT_HIGHLIGHTS = [
    { code: "#B12823", name: "Vermelho Tijolo" },
    { code: "#AC4A0B", name: "Laranja Outono" },
    { code: "#D8B200", name: "Amarelo Dourado" },
    { code: "#436C21", name: "Verde Lima" },
    { code: "#006042", name: "Verde Esmeralda" },
    { code: "#1F7AC4", name: "Azul Oceano" },
    { code: "#B53E69", name: "Rosa Suave" },
    { code: "#8438D7", name: "Roxo Ametista" },
    { code: "#A08F8E", name: "Cinza Quente" }
];
const XRAY_LOADER_HTML = `
    <div class="loader-container">
        <div class="scanner-ui">
            <div class="wave wave-1"></div><div class="wave wave-2"></div><div class="wave wave-3"></div>
            <div class="dish"></div>
        </div>
        <div style="font-family:monospace; font-size:0.65rem; letter-spacing:2px;">PESQUISA PROFUNDA...</div>
    </div>
`;


// --- 1. INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
onAuthStateChanged(auth, async (user) => {
    const shield = document.getElementById('global-auth-shield');
    if (!user) { window.location.href = "404.html"; return; }

    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().aceite !== "on") { 
            window.location.href = "index.html"; 
            return; 
        }

        if (shield) shield.style.display = 'none';

        // --- L√ìGICA DE RESTAURO AUTOM√ÅTICO POR URL ---
        const params = new URLSearchParams(window.location.search);
        const sec = params.get('sec');   
        const pub = params.get('pub');   
        const year = params.get('year'); 
        const month = params.get('month'); 
        const cap = params.get('cap');   

        if (pub && cap) {
            const success = await loadPublication(sec, pub);
            if (success) {
                if (sec === 'publicacoes' && year && month) {
                     // Caso seja revista, reconstr√≥i o ambiente da revista
                     const sigla = pub.substring(0,1).toLowerCase();
                     await showArticles(sigla, year, month, "", true);
                }
                const idx = currentBookData.capitulos.findIndex(c => String(c.capitulo) === String(cap));
                renderReading(idx !== -1 ? idx : 0, sec, pub, true);
            }
        } else if (pub) {
            const success = await loadPublication(sec, pub);
            if (success) showChapters(sec, pub);
        } else if (sec) {
            showList(sec);
        } else {
            showRoot(); 
        }
    } catch (e) { console.error(e); }
});

// --- 2. CARREGAMENTO DE DADOS ---
async function loadPublication(sectionId, pubId) {
    container.innerHTML = '<div class="global-spinner" style="margin:50px auto;"></div>';
    try {
        currentPubId = pubId;
        const response = await fetch(`./js/${sectionId}/${pubId}.json`);
        if (!response.ok) throw new Error("Erro de rede");
        currentBookData = await response.json();
        return true;
    } catch (e) {
        container.innerHTML = `<p style="text-align:center;color:red;padding:20px;">Erro ao carregar publica√ß√£o.</p>`;
        return false;
    }
}

// --- 3. RENDERIZA√á√ÉO DA LEITURA ---
function renderReading(chapterIdx, sectionId, pubId) {
    hideSelectionToolbar();
    const navPanel = document.getElementById('chapter-nav-panel');
    if (navPanel) { 
        navPanel.style.display = 'none'; 
        navPanel.classList.add('hidden'); 
    }

    const cap = currentBookData.capitulos[chapterIdx];
    if (!cap) return;
    
    currentSectionId = sectionId;
    currentPubId = pubId; 
       currentChapterIdx = chapterIdx;
    currentChapter = cap.capitulo || (chapterIdx + 1);

    const isBook = (sectionId === 'books');
    const navLabel = isBook ? 'CAP√çTULO' : 'ARTIGO';

    const getNavHTML = () => `
        <button class="nav-arrow" onclick="window.changeChapter(-1)">‚ùÆ</button>
        <span onclick="window.toggleChapterNav(event)" style="cursor:pointer; border-bottom: 1px dotted #666; padding: 2px 5px;">
            ${navLabel} ${currentChapter}
        </span>
        <button class="nav-arrow" onclick="window.changeChapter(1)">‚ùØ</button>
    `;

    let html = `
        <div class="reader-content" id="reader-area">
            <div class="pub-body-title">${currentBookData.titulo}</div>
            <div class="reader-chapter-title">${cap.titulo}</div>
    `;

    cap.conteudo.forEach(block => {
        const pNum = block.numero_ref;
        const blockId = pNum ? `id="p-${pNum}"` : '';
        const dataAttr = pNum ? `data-pnum="${pNum}"` : '';
        
        // PROCESSAMENTO DE LINKS B√çBLICOS (Invis√≠veis)
        const textoFinal = window.linkifyBibleReferences(block.texto || "");

        const isCantico = block.texto && (block.texto.startsWith("C√ÇNTICO") || block.tipo === 'cantico');

        if (block.tipo === 'subtema') {
            html += `<div class="block-subtema">${textoFinal}</div>`;
        } 
        else if (block.tipo === 'pergunta') {
            const safeText = encodeURIComponent(block.texto);
            html += `
                <div class="block-pergunta" style="cursor:pointer;" 
                     onclick="window.openQuestionEditor('${pNum || ''}', decodeURIComponent('${safeText}'))">
                    ${textoFinal}
                </div>`;
        }
        else if (block.tipo === 'rodape' || isCantico) {
            const extraStyle = isCantico ? 'color:#e67e22; font-weight:bold; border:none; text-align:center;' : '';
            html += `<div class="block-rodape" style="${extraStyle}">${textoFinal}</div>`;
        }
        else {
            html += `
                <div ${blockId} ${dataAttr} class="block-paragrafo">
                    ${pNum ? `<span class="ref-num" onclick="window.openSidePanel('${pNum}')">${pNum}</span>` : ''}
                    ${textoFinal}
                </div>`;
        }
    });

    html += `</div>`;
    container.innerHTML = html;
    container.scrollTop = 0;
    
    if (document.getElementById('page-title')) {
        document.getElementById('page-title').innerHTML = getNavHTML();
    }
    
    setTimeout(() => {
        loadLibraryDataForChapter(pubId, currentChapter);
    }, 60);
}

// --- 4. NAVEGA√á√ÉO DE CAP√çTULOS ---

// Navega√ß√£o por setas (‚ùÆ e ‚ùØ)
window.changeChapter = (delta) => {
    if (!currentBookData) return;
    
    const currentIdx = currentBookData.capitulos.findIndex(c => 
        String(c.capitulo || (currentBookData.capitulos.indexOf(c) + 1)) === String(currentChapter)
    );

    const newIdx = currentIdx + delta;

    if (newIdx >= 0 && newIdx < currentBookData.capitulos.length) {
        renderReading(newIdx, currentSectionId, currentPubId);
    }
};

// Abrir/Fechar a Grelha de Cap√≠tulos
 window.toggleChapterNav = (event) => {
    // 1. Impedir que o evento suba para o window e feche o painel na hora
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    const panel = document.getElementById('chapter-nav-panel');
    if (!panel) return;

    // 2. Se o painel j√° est√° aberto, fecha-o e sai
    if (panel.classList.contains('active')) {
        panel.classList.remove('active');
        return;
    }

    // 3. Renderizar o conte√∫do da grelha
    if (!currentBookData || !currentBookData.capitulos) return;

    panel.innerHTML = ''; 
    const isMagazine = (currentSectionId === 'publicacoes');
    
    // Ajustar colunas se for revista
    panel.style.gridTemplateColumns = isMagazine 
        ? "repeat(auto-fill, minmax(120px, 1fr))" 
        : "repeat(auto-fill, minmax(55px, 1fr))";

    currentBookData.capitulos.forEach((cap, idx) => {
        const btn = document.createElement('div');
        btn.className = 'nav-cap-btn';
        const label = cap.capitulo || (idx + 1);
        btn.innerText = isMagazine ? `Artigo ${label}` : label;
        
        if (String(label) === String(currentChapter)) {
            btn.classList.add('active');
        }
        
        btn.onclick = (e) => {
            e.stopPropagation();
            panel.classList.remove('active');
            renderReading(idx, currentSectionId, currentPubId);
        };
        
        panel.appendChild(btn);
    });
    
    // 4. Mostrar o painel
    panel.classList.add('active');
    
    // Scroll para o cap√≠tulo atual
    setTimeout(() => {
        const active = panel.querySelector('.nav-cap-btn.active');
        if (active) active.scrollIntoView({ block: 'center' });
    }, 50);
};


// --- FECHAR O PAINEL AO CLICAR FORA ---
window.addEventListener('click', (e) => {
    const panel = document.getElementById('chapter-nav-panel');
    // Se o clique for fora do painel e o painel estiver aberto, fecha-o
    if (panel && panel.classList.contains('active') && !panel.contains(e.target)) {
        panel.classList.remove('active');
    }
});


// --- 5. SISTEMA DE SELE√á√ÉO E NOTAS FLASH ---

// Monitorizar sele√ß√£o de texto
document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const toolbar = document.getElementById('selection-toolbar');

    // Se a sele√ß√£o for limpa ou for apenas um clique (colapsada)
    if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.style.display = 'none';
        return;
    }

    const range = selection.getRangeAt(0);
    const text = selection.toString().trim();
    const reader = document.getElementById('reader-area');

    if (reader && reader.contains(range.commonAncestorContainer) && text.length > 5) { 
        currentSelectionText = text;
        
        // Descobrir quais par√°grafos est√£o na sele√ß√£o
        currentSelectedParagraphs = [];
        const paragraphs = document.querySelectorAll('.block-paragrafo');
        paragraphs.forEach(p => {
            const nodeRange = document.createRange();
            nodeRange.selectNode(p);
            const intersects = range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
                               range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
            if (intersects) {
                const pNum = p.getAttribute('data-pnum');
                if (pNum) currentSelectedParagraphs.push(pNum);
            }
        });

        // Posicionar barra flutuante
        const rect = range.getBoundingClientRect();
        if (window.innerWidth <= 768) {
            toolbar.style.position = 'fixed'; toolbar.style.bottom = '20px';
            toolbar.style.left = '50%'; toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.top = 'auto';
        } else {
            toolbar.style.position = 'absolute';
            toolbar.style.top = `${window.scrollY + rect.top - 50}px`;
            toolbar.style.left = `${window.scrollX + rect.left}px`;
            toolbar.style.transform = 'none';
        }
        toolbar.style.display = 'flex';
        } else {
        toolbar.style.display = 'none';
    }
});

// Bot√£o Copiar da barra
document.getElementById('btn-copy').onclick = () => {
    navigator.clipboard.writeText(currentSelectionText);
    document.getElementById('selection-toolbar').style.display = 'none';
};

// Bot√£o Nota Flash da barra
document.getElementById('btn-flash-note').onclick = () => {
    window.openFlashModal();
    document.getElementById('selection-toolbar').style.display = 'none';
};

// Abrir Modal de Nota
window.openFlashModal = () => {
    const modal = document.getElementById('flash-note-modal');
    modal.style.display = 'flex';
    document.getElementById('flash-title').value = '';
    document.getElementById('flash-editor').innerHTML = '';
    
    let codexStr = `${currentPubId} ${currentChapter}`;
    if (currentSelectedParagraphs.length > 0) codexStr += `:${currentSelectedParagraphs.join('-')}`;
    document.getElementById('flash-codex-info').textContent = codexStr;

    // DIFEREN√áA 2: Aqui as cores devem aparecer (para o picotado)
    const picker = document.getElementById('color-picker');
    if (picker) {
        picker.style.display = 'flex';
        renderColorPicker('color-picker'); 
    }
};

window.closeFlashModal = () => {
    document.getElementById('flash-note-modal').style.display = 'none';
};

window.renderColorPicker = (containerId) => {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    
    DEFAULT_HIGHLIGHTS.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.code;
        if (window.selectedColorHex === c.code) btn.classList.add('selected');
        btn.onclick = () => {
            container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            window.selectedColorHex = c.code;
        };
        container.appendChild(btn);
    });
};

// Grava√ß√£o da Nota na Biblioteca
window.saveQuestionAnswer = async (docId, encodedQText) => {
    const btn = document.getElementById('btn-save-question');
    const editor = document.getElementById('flash-editor');
    const qText = decodeURIComponent(encodedQText);
    
    if (btn.disabled) return;
    btn.disabled = true;

    try {
        const { collection, addDoc, doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        const qId = window.activeQuestionId;
        // LIMPEZA: Remove espa√ßos em branco no in√≠cio e fim do HTML
        const content = editor.innerHTML.trim(); 
        const color = window.selectedColorHex || '#2ecc71';
        
        // --- MONTAGEM DO HTML COM O ATRIBUTO DE DESTAQUE ---
        const boxHtml = `
            <div class="mini-note-wrapper question-mode" id="box_${Date.now()}" 
                 data-topics='{}' data-shared="false" data-box-links='{}' 
                 data-highlight="${color}" contenteditable="false">
                <textarea class="mini-note-title-input">${qText}</textarea>
                <div class="mini-note-toolbar" contenteditable="false">
                    <button>üîê</button><div class="toolbar-btn-group"><button>üî∫</button><button>üîª</button></div>
                    <button class="has-links">‚ö°</button><button>üß¨</button><button>üé®</button><button>üìã</button><button>üóëÔ∏è</button>
                </div>
                <div class="mini-note-content" contenteditable="true">${content}</div>
            </div><p><br></p>
        `;

        const noteData = {
            nome: qText,
            conteudo: boxHtml,
            tipo: 'nota',
            oque: 'back',
            qId: qId,
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ultimaedicao: serverTimestamp()
        };

        if (docId && docId !== "null" && docId !== "undefined") {
            await updateDoc(doc(db, 'pastas', docId), noteData);
        } else {
            noteData.createdAt = serverTimestamp();
            await addDoc(collection(db, 'pastas'), noteData);
        }

        btn.textContent = "‚úÖ GUARDADO";
        setTimeout(() => { btn.disabled = false; btn.textContent = "ATUALIZAR RESPOSTA"; }, 2000);
        
        loadLibraryDataForChapter(currentPubId, currentChapter);

    } catch (e) {
        console.error(e);
        btn.disabled = false;
    }
};

// --- 6. GEST√ÉO DE DADOS DO UTILIZADOR (HIGHLIGHTS) ---

async function loadLibraryDataForChapter(pubId, chapter) {
    const capituloId = `${pubId}_${chapter}`;
    const prefix = `${pubId} ${chapter}:`;
    
    // Reset local
    currentChapterHighlights = {}; 

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // 1. Buscar Destaques (Cores s√≥lidas) e Notas (Picotados) em paralelo para ser mais r√°pido
        const [snapCores, snapNotas] = await Promise.all([
            getDocs(query(collection(db, 'trechosbiblicos'), 
                where('userId', '==', auth.currentUser.uid),
                where('capituloId', '==', capituloId))),
            getDocs(query(collection(db, 'livros'), 
                where('userId', '==', auth.currentUser.uid),
                where('nome', '>=', prefix), where('nome', '<=', prefix + '\uf8ff')))
        ]);

        // Processar cores s√≥lidas
        snapCores.forEach(docSnap => {
            const data = docSnap.data();
            data.textosbiblicos.forEach(ref => {
                const pNum = ref.split(':').pop();
                const pId = `p-${pNum}`;
                if (!currentChapterHighlights[pId]) currentChapterHighlights[pId] = [];
                currentChapterHighlights[pId].push({
                    texto: data.nome,
                    cor: data.cor,
                    temNota: (data.noteIds && data.noteIds.length > 0)
                });
            });
        });

        // Processar Notas (Flash Notes)
        snapNotas.forEach(docSnap => {
            const data = docSnap.data();
            const pNum = data.paragrafo;
            const pId = `p-${pNum}`;
            
            if (!currentChapterHighlights[pId]) currentChapterHighlights[pId] = [];
            
            // Se tem puzzleBoard, este par√°grafo tem dados (N√∫mero fica Azul)
            if (data.puzzleBoard && data.puzzleBoard.length > 0) {
                // Marcamos que este par√°grafo espec√≠fico tem dados para o n√∫mero ficar azul
                currentChapterHighlights[pId].hasNoteData = true;

                data.puzzleBoard.forEach(item => {
                    if (item.highlightRef) {
                        currentChapterHighlights[pId].push({
                            texto: item.highlightRef,
                            cor: item.noteColor || '#3498db',
                            temNota: true
                        });
                    }
                });
            }
        });

        // CHAVE DO SUCESSO: Chama a pintura visual
        window.refreshVisualHighlights();

    } catch (e) { 
        console.error("Erro ao carregar dados:", e); 
    }
}

window.applyHighlightToUI = (text, color, refId) => {
    const reader = document.getElementById('reader-area');
    if (!reader) return;
    const paragraphs = reader.querySelectorAll('.block-paragrafo');
    paragraphs.forEach(p => {
        if (p.textContent.includes(text) && !p.innerHTML.includes('highlight-picotado')) {
            const safeText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeText})`, 'g');
            p.innerHTML = p.innerHTML.replace(regex, `<span class="highlight-picotado" style="background-image: linear-gradient(to right, ${color} 50%, transparent 50%);" onclick="window.openSidePanel('${refId}')">$1</span>`);
        }
    });
};

// --- 7. VISTAS DE NAVEGA√á√ÉO DA BIBLIOTECA ---

function showRoot() {
     hideSelectionToolbar();
    navStack = []; 
    container.innerHTML = `
        <h2 class="section-title">Cole√ß√µes</h2>
        <div class="grid">
            <div class="pub-card type-book" onclick="showList('books')">
                <span style="font-size:3em;">üìö</span>
                <span class="pub-title">Livros</span>
            </div>
            <div class="pub-card type-pub" onclick="showList('magazines')">
                <span style="font-size:3em;">üì∞</span>
                <span class="pub-title">Publica√ß√µes & Revistas</span>
            </div>
        </div>
    `;
    updateHeader("Biblioteca", () => window.location.href = "note.html");
}

// N√≠vel 2: Lista de Publica√ß√µes na Sec√ß√£o
function showList(category) {
    hideSelectionToolbar();
    
    // CORRE√á√ÉO: Verificar se category √© um objeto (erro comum)
    const catId = (typeof category === 'object') ? category.id : category;
    
    navStack.push(() => showRoot());
    const isBooks = catId === 'books';
    const title = isBooks ? 'Livros' : 'Publica√ß√µes';
    
    // Atualiza URL com a string correta
    updateLibraryURL({ sec: catId }); 
    container.innerHTML = `<h2 class="section-title">${title}</h2><div class="grid" id="dynamic-grid"></div>`;
    const grid = document.getElementById('dynamic-grid');
    Object.entries(SIGLAS_PUBLICACOES).forEach(([id, fullName]) => {
        const isMagazine = SIGLAS_REVISTAS.includes(id);
        if (isBooks && isMagazine) return;
        if (!isBooks && !isMagazine) return;
        const card = document.createElement('div');
        card.className = `pub-card ${isBooks ? 'type-book' : 'type-pub'}`;
        card.innerHTML = `<div style="font-size:0.7em; opacity:0.5; margin-bottom:5px;">${id.toUpperCase()}</div><span class="pub-title">${fullName}</span>`;
        card.onclick = () => {
            if (isMagazine) showYears(id, fullName);
            else { loadPublication('books', id).then(ok => { if(ok) showChapters('books', id); else { loadPublication('publicacoes', id).then(ok2 => { if(ok2) showChapters('publicacoes', id); }); } }); }
        };
        grid.appendChild(card);
    });
    updateHeader(title, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel 3 (Especial): Sele√ß√£o de Anos para Revistas
function showYears(sigla, fullName) {
    navStack.push(() => showList(sigla === 'w' ? {id:'publicacoes', name:'Publica√ß√µes', color:'type-pub', items:['w','g']} : {id:'publicacoes', name:'Publica√ß√µes'}));
    container.innerHTML = `<h2 class="section-title">${fullName} - Selecionar Ano</h2><div class="grid" id="year-grid"></div>`;
    const grid = document.getElementById('year-grid');

    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= 1950; i--) {
        const card = document.createElement('div');
        card.className = 'pub-card type-pub';
        card.style.aspectRatio = "1/1";
        card.innerHTML = `<span class="pub-title">${i}</span>`;
        card.onclick = () => showMonths(sigla, i);
        grid.appendChild(card);
    }
    updateHeader(fullName, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel 4 (Especial): Sele√ß√£o de Meses
function showMonths(sigla, year) {
    navStack.push(() => showYears(sigla, SIGLAS_PUBLICACOES[sigla]));
    const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    
    container.innerHTML = `<h2 class="section-title">Ano ${year}</h2><div class="grid" id="month-grid"></div>`;
    const grid = document.getElementById('month-grid');

    meses.forEach((mes, idx) => {
        const mesNum = (idx + 1).toString().padStart(2, '0');
        const card = document.createElement('div');
        card.className = 'pub-card type-pub';
        card.style.aspectRatio = "1/1";
        card.innerHTML = `<span class="pub-title">${mes}</span>`;
        card.onclick = () => showArticles(sigla, year, mesNum, mes);
        grid.appendChild(card);
    });
    updateHeader(`Ano ${year}`, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel 5 (Especial): Sele√ß√£o de Artigos (Fetch do JSON din√¢mico)
async function showArticles(sigla, year, mesNum, mesNome) {
    navStack.push(() => showMonths(sigla, year));
    container.innerHTML = '<div class="global-spinner" style="margin:50px auto;"></div>';

    try {
        // 1. Determina a pasta correta no servidor
        const subFolder = MAGAZINE_FOLDERS[sigla] || 'sentinelas';
        const path = `./js/publicacoes/${subFolder}/${year}/${mesNum}.json`;
        
        const response = await fetch(path);
        if (!response.ok) throw new Error("Ficheiro n√£o encontrado");
        const data = await response.json();
        
        const artigos = data.artigos;

        container.innerHTML = `<h2 class="section-title">Artigos de ${mesNome}</h2><div class="chapter-list"></div>`;
        const list = container.querySelector('.chapter-list');

        // 2. Prepara os dados globais da publica√ß√£o
        currentBookData = {
            titulo: `${SIGLAS_PUBLICACOES[sigla]} - ${mesNome}/${year}`,
            capitulos: artigos.map(a => ({
                capitulo: a.referencia.split(' ').pop(), // Ex: "pp. 2-7"
                titulo: a.titulo,
                conteudo: a.conteudo
            }))
        };

        // 3. Gera o ID Complexo para o Firestore (Ex: W24_05)
        const complexId = sigla.toUpperCase() + year.toString().slice(-2) + "_" + mesNum;

        artigos.forEach((art, idx) => {
            const item = document.createElement('div');
            item.className = 'chapter-item';
            item.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <small style="color:#888; font-weight:bold;">${art.referencia}</small>
                    <span style="text-align:left;">${art.titulo}</span>
                </div>
                <span>‚ûî</span>
            `;
            item.onclick = () => {
                // Atualizamos o ID global e abrimos o leitor
                currentPubId = complexId;
                renderReading(idx, 'publicacoes', complexId);
            };
            list.appendChild(item);
        });

    } catch (e) {
        console.error("Erro ao carregar JSON:", e);
        container.innerHTML = `<p style="text-align:center;color:#666;padding:20px;">Ficheiro n√£o encontrado em: <br><small>${year}/${mesNum}.json</small></p>`;
    }
    updateHeader(`${mesNome} ${year}`, () => { const last = navStack.pop(); if (last) last(); });
}

// N√≠vel Final: Lista de Cap√≠tulos para Livros Est√°ticos
function showChapters(sectionId, pubId) {
    navStack.push(() => showList(sectionId));
    updateLibraryURL({ sec: sectionId, pub: pubId }); // Atualiza URL
    container.innerHTML = `<h2 class="section-title">Sum√°rio</h2><div class="chapter-list"></div>`;
    const list = container.querySelector('.chapter-list');
    currentBookData.capitulos.forEach((cap, idx) => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.innerHTML = `<span><b>${cap.capitulo || idx+1}</b> ${cap.titulo}</span> <span>‚ûî</span>`;
        item.onclick = () => renderReading(idx, sectionId, pubId);
        list.appendChild(item);
    });
    updateHeader(currentBookData.titulo, () => { const last = navStack.pop(); if (last) last(); });
}

function updateHeader(title, backAction) {
    document.getElementById('page-title').innerHTML = title;
    document.getElementById('back-btn').onclick = backAction;
}



// --- 3. ATUALIZA√á√ÉO DA FUN√á√ÉO OPEN SIDE PANEL (COM FILTRO) ---
window.openSidePanel = async (pNum) => {
    const panel = document.getElementById('side-panel');
    const tabs = document.getElementById('library-ref-tabs');
    const titleContainer = document.getElementById('side-title-container');
    const content = document.getElementById('side-content');
    
    // 1. GEST√ÉO DE CACHE E ESTADO
    // Se o utilizador abrir um par√°grafo diferente do que estava aberto antes:
    if (activeParaNum !== pNum) {
        // Limpamos os caches das pesquisas e enxertos do par√°grafo anterior
        cacheXrayHTML = null;
        cacheSegmentoHTML = null;
          enxertoScrollPos = 0;
        activeParaNum = pNum;
        
        // Escondemos os bot√µes das abas din√¢micas (X-Ray e Segmentos)
        // Eles s√≥ reaparecer√£o se o utilizador disparar o Scanner ou abrir um resultado
        const xrayBtn = document.getElementById('tab-xray-btn');
        const enxertoBtn = document.getElementById('tab-enxertos-btn');
        const bibleBtn = document.getElementById('tab-bible-btn');
        
        if (xrayBtn) xrayBtn.style.display = 'none';
        if (enxertoBtn) enxertoBtn.style.display = 'none';
        if (bibleBtn) bibleBtn.style.display = 'none';

        // Garantir que o estilo de visualiza√ß√£o do X-Ray √© removido
        content.classList.remove('xray-active');
    }

    // 2. ABRIR O PAINEL E EXIBIR BARRA DE ABAS
    panel.classList.add('open');
    tabs.style.display = 'flex'; 

    // 3. DEFINIR CONTEXTO DE REFER√äNCIA
    // Guardamos o n√∫mero do par√°grafo e a refer√™ncia completa (ex: "w24 05:10") no pr√≥prio elemento
    panel.dataset.pNum = pNum;
    const fullRef = `${currentPubId} ${currentChapter}:${pNum}`;
    panel.dataset.currentRef = fullRef;

    // 4. ATUALIZAR CABE√áALHO DO PAINEL
    // Injetamos o t√≠tulo do par√°grafo e os bot√µes de a√ß√£o r√°pida
    titleContainer.innerHTML = `
        <div style="display:flex; flex-direction:column;">
            <span style="color: var(--accent-color); font-weight: bold;">Par√°grafo ${pNum}</span>
        </div>
        <div style="display:flex; gap:8px; margin-left:12px;">
            <!-- Bot√£o para Criar Nova Nota Flash -->
            <button class="btn-header-create" onclick="window.prepareNoteFromPanel('${pNum}')" title="Nova Nota">+ üìù</button>
            
            <!-- Bot√£o para Iniciar o Scanner X-Ray (Laranja) -->
            <button class="btn-header-create" style="background:#e67e22; animation: pulse-glow-orange 2s infinite;" 
                    onclick="window.runParaXRay('${pNum}')" title="X-Ray Scanner">+ üìü</button>
        </div>
    `;

    // 5. ATIVAR ABA PADR√ÉO (Puzzle/Quadro üß©)
    // Removemos a classe 'active' de todas as abas e pomos na primeira
    document.querySelectorAll('#library-ref-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    const puzzleTab = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTab) puzzleTab.classList.add('active');

    // Carregar o conte√∫do da aba Quadro
    window.renderLibraryRefTab('puzzle');
};



// Dentro de saveLibraryFlashNote, ap√≥s o sucesso da grava√ß√£o:
currentSelectedParagraphs.forEach(pNum => {
    const numEl = document.querySelector(`.block-paragrafo[data-pnum="${pNum}"] .ref-num`);
    if (numEl) {
        numEl.classList.add('has-data');
        numEl.onclick = () => window.openSidePanel(pNum);
    }
});


// --- NOVO: Fun√ß√£o para preparar a nota vinda do painel lateral ---
window.prepareNoteFromPanel = (pNum) => {
    const tabs = document.getElementById('library-ref-tabs');
    const content = document.getElementById('side-content');
    const titleContainer = document.getElementById('side-title-container');

    // 1. Esconde as abas (Quadro, Links, Micas)
    tabs.style.display = 'none';

    // 2. LIMPA O CONTAINER E DEIXA APENAS O T√çTULO 
    // (Isso faz o bot√£o +üìù desaparecer automaticamente)
    titleContainer.innerHTML = `
        <span id="side-title" style="color: var(--accent-color); font-weight: bold;">Nova Nota</span>
    `;

    currentSelectedParagraphs = [pNum];
    currentSelectionText = ""; 

    // 3. Injeta o formul√°rio
    content.innerHTML = window.getFlashNoteFormHTML(pNum);

    // 4. L√≥gica de cores (esconde se for apenas clique no n√∫mero)
    const picker = document.getElementById('inline-color-picker');
    if (picker) picker.style.display = 'none';
};



window.getFlashNoteFormHTML = (pNum) => {
    const codexStr = `${currentPubId} ${currentChapter}:${pNum}`;
    
    return `
        <div class="note-creation-form" style="padding: 5px;">
            <!-- T√≠tulo id√™ntico ao Bible.html -->
            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="document.execCommand('underline')"><u>U</u></button>
                <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                <button onclick="window.openTopicsModal()">üìã</button>
                <button onclick="window.openFlashLinkManager()">‚ö°</button>
                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            
            <!-- As cores aparecem aqui -->
            <div class="color-picker-container" id="inline-color-picker"></div>

            <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                üîó Anexado a: <span style="color: #3498db; font-weight:bold;">${codexStr}</span>
            </div>

            <button id="btn-save-flash" onclick="window.saveLibraryFlashNote(this)" 
                    style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                GRAVAR NOTA
            </button>
        </div>
    `;
};

// --- GEST√ÉO DE LINKS: DESIGN MAIS LIMPO ---
window.addFlashUrlField = (val = "") => {
    const div = document.createElement('div');
    div.className = 'flash-url-row';
    div.innerHTML = `
        <span style="opacity:0.5;">üîó</span>
        <input type="text" placeholder="https://..." value="${val}">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-urls-list').appendChild(div);
};

// Quando carregar as categorias selecionadas, use o novo design de Chip:
function renderFlashCategoryChip(cat) {
    const container = document.getElementById('flash-cat-selected');
    const chip = document.createElement('div');
    chip.className = 'flash-cat-chip';
    chip.innerHTML = `<span>#</span> ${cat.name} <span style="opacity:0.5; margin-left:5px;">&times;</span>`;
    chip.onclick = () => {
        chip.remove();
        // L√≥gica para remover do array global...
    };
    container.appendChild(chip);
}

// 1. Abrir o Gerenciador de Links com Design Bible
window.openFlashLinkManager = function() {
    const modal = document.getElementById('flash-links-modal');
    modal.style.display = 'flex';
    
    // Contexto visual (Anexado a...)
    const contextDiv = document.getElementById('flash-links-context');
    contextDiv.innerHTML = `<span style="opacity:0.5; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Contexto da Nota</span>
                            <strong style="color:#eee;">${currentPubId} ${currentChapter}:${currentSelectedParagraphs.join(',')}</strong>`;

    // Limpeza e Restaura√ß√£o de Dados
    document.getElementById('flash-urls-list').innerHTML = '';
    document.getElementById('flash-codex-rows-container').innerHTML = '';
    document.getElementById('flash-cat-selected').innerHTML = '';

    // Se houver links salvos, restaura (Exatamente como no Bible)
    if (currentFlashLinks.urls) {
        Object.values(currentFlashLinks.urls).forEach(url => window.addFlashUrlField(url));
    }
    
    if (currentFlashLinks.codex && currentFlashLinks.codex.length > 0) {
        currentFlashLinks.codex.forEach(row => window.createFlashCodexRow(row));
    } else {
        window.createFlashCodexRow(); // Adiciona uma vazia por padr√£o
    }

    window.switchFlashLinkTab('refs');
};

// 2. Criar Linha de Codex Complexa (Design Bible)
window.createFlashCodexRow = function(data = null) {
    const container = document.getElementById('flash-codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    row.innerHTML = `
        <button class="remove-codex-row" onclick="this.parentElement.remove()">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                <div class="manual-controls">
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Ano">A</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="M√™s">M</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Tempo">T</button>
                    <button class="btn-control-small" onclick="this.classList.toggle('active')" title="Cap√≠tulo">C</button>
                </div>
            </div>
        </div>
        <div class="codex-content-grid">
            <div>
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div>
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(row);

    // Preencher unidades se houver dados
    if (data) {
        const pCont = row.querySelector('.pages-container');
        const pgCont = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addFlashCodexUnit(pCont, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addFlashCodexUnit(pgCont, 'Par', p));
    }
};

// 3. Adicionar Unidade (P√≠lula de n√∫mero)
window.addFlashCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.insertBefore(unit, container.lastChild);
};

window.switchFlashLinkTab = (tab) => {
    // 1. Atualizar visual dos bot√µes (abas)
    document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
    
    // Procura o bot√£o que foi clicado ou corresponde √† aba e ativa-o
    const buttons = document.querySelectorAll('.store-tab-btn');
    if(tab === 'refs') buttons[0].classList.add('active');
    if(tab === 'codex') buttons[1].classList.add('active');
    if(tab === 'cats') buttons[2].classList.add('active');

    // 2. Alternar a visibilidade dos pain√©is
    const panels = ['refs', 'codex', 'cats'];
    panels.forEach(p => {
        const el = document.getElementById(`flash-tab-${p}`);
        if (el) el.style.display = 'none';
    });

    const targetPanel = document.getElementById(`flash-tab-${tab}`);
    if (targetPanel) targetPanel.style.display = 'block';
};

// Altera a cor da borda do editor conforme o tipo de nota selecionado
window.changeFlashBorder = (selectElement) => {
    // Procura o editor no documento (funciona tanto no Modal como no Painel Lateral)
    const editor = document.getElementById('flash-editor');
    if (!editor) return;

    const type = selectElement.value;

    if (type === 'question') {
        // Estilo para QUEST√ÉO (Verde)
        editor.style.borderLeft = '4px solid #2ecc71';
        editor.style.backgroundColor = 'rgba(46, 204, 113, 0.05)';
    } else {
        // Estilo para SUBNOTA / PADR√ÉO (Azul)
        editor.style.borderLeft = '4px solid #3498db';
        editor.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
    }
};

// --- SISTEMA DE PESQUISA DE CATEGORIAS (IGUAL AO BIBLE.HTML) ---

window.searchFlashCategories = async (text) => {
    if (text.length < 2) {
        document.getElementById('flash-cat-results').innerHTML = '';
        return;
    }
    
    const searchText = text.toLowerCase();
    const resDiv = document.getElementById('flash-cat-results');
    const isGlobalBible = document.getElementById('flash-bible-toggle').checked;
    
    resDiv.innerHTML = '<div style="padding:10px; color:#888; font-size:0.8rem;">A procurar...</div>';
    
    let resultsArray = [];
    let type = '';

    try {
        if (isGlobalBible) {
            // MODO B√çBLIA: Pesquisa na lista local de livros (BIBLE_DATA deve estar importado)
            type = 'bible_public';
            // BIBLE_DATA √© o array importado no topo do teu script
            const { BIBLE_DATA } = await import('./js/bible-data.js');
            const matches = BIBLE_DATA.filter(b => 
                b.nome.toLowerCase().includes(searchText)
            );
            resultsArray = matches.map(b => ({ id: b.nome, nome: b.nome }));
        } else {
            // MODO T√ìPICOS: Pesquisa no Firestore
            type = 'topic';
            const { collection, query, where, getDocs, limit, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Procura t√≥picos do utilizador atual
            const q = query(
                collection(db, "topicos"),
                where("userId", "==", auth.currentUser.uid),
                where("nome", ">=", text.charAt(0).toUpperCase() + text.slice(1)), // Primeira letra mai√∫scula
                limit(10)
            );
            
            const snap = await getDocs(q);
            snap.forEach(doc => {
                resultsArray.push({ id: doc.id, ...doc.data() });
            });
        }

        // Renderiza√ß√£o dos Resultados
        resDiv.innerHTML = '';
        if (resultsArray.length === 0) {
            resDiv.innerHTML = '<div style="padding:10px; color:#666; font-size:0.8rem;">Sem resultados.</div>';
            return;
        }

        resultsArray.forEach(d => {
            const div = document.createElement('div');
            div.style.cssText = "padding:10px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;";
            
            const icon = type === 'bible_public' ? 'üåç' : 'üè∑Ô∏è';
            div.innerHTML = `<span>${icon} ${d.nome}</span> <button style="background:var(--accent-color); border:none; color:white; border-radius:4px; padding:2px 8px; cursor:pointer;">+</button>`;
            
            div.onclick = () => {
                const catObj = { id: d.id, name: d.nome, type: type };
                window.addFlashCategoryChip(catObj);
                resDiv.innerHTML = '';
                document.getElementById('flash-cat-search').value = '';
            };
            resDiv.appendChild(div);
        });

    } catch(e) { 
        console.error("Erro na pesquisa:", e);
        resDiv.innerHTML = '<div style="padding:10px; color:red;">Erro ao pesquisar.</div>';
    }
};

// Adiciona a "p√≠lula" visual da categoria selecionada
window.addFlashCategoryChip = (cat) => {
    if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
    
    // Evita duplicados
    if (currentFlashLinks.categories.some(c => c.name === cat.name)) return;
    
    currentFlashLinks.categories.push(cat);
    window.renderFlashCategoryChips();
};

// Desenha todos os chips na √°rea de "Selecionados"
window.renderFlashCategoryChips = () => {
    const container = document.getElementById('flash-cat-selected');
    if (!container) return;
    
    container.innerHTML = '';
    const categories = currentFlashLinks.categories || [];
    
    categories.forEach(cat => {
        const chip = document.createElement('div');
        chip.className = 'flash-cat-chip'; // J√° tens o CSS para isto
        chip.innerHTML = `<span>#</span> ${cat.name} <span style="margin-left:8px; opacity:0.5; font-size:1.1rem;">&times;</span>`;
        
        chip.onclick = () => {
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => c.name !== cat.name);
            window.renderFlashCategoryChips();
        };
        
        container.appendChild(chip);
    });
};

function hideSelectionToolbar() {
    const toolbar = document.getElementById('selection-toolbar');
    if (toolbar) {
        toolbar.style.display = 'none';
    }
    // Opcional: Limpa a sele√ß√£o azul do navegador para evitar que a barra volte a aparecer
    // window.getSelection().removeAllRanges();
}

// --- L√ìGICA DE DESTAQUE DIRETO (CORES) ---

// 1. Delegar cliques nas cores da toolbar
document.getElementById('toolbar-colors').addEventListener('click', async (e) => {
    const dot = e.target.closest('.color-dot');
    const removeBtn = e.target.closest('#btn-remove-highlight');

    if (dot) {
        const color = dot.dataset.color;
        await applyDirectHighlight(color);
    } else if (removeBtn) {
        await removeDirectHighlight();
    }
    
    // Esconde a toolbar ap√≥s a a√ß√£o
    document.getElementById('selection-toolbar').style.display = 'none';
});

// Fun√ß√£o para aplicar e salvar o destaque
async function applyDirectHighlight(hexColor) {
    if (!currentSelectionText || currentSelectedParagraphs.length === 0) return;

    // --- 1. PINTURA INSTANT√ÇNEA (Para o utilizador ver logo) ---
    currentSelectedParagraphs.forEach(pNum => {
        const pId = `p-${pNum}`;
        
        // Inicializa o objeto de cache se n√£o existir
        if (!currentChapterHighlights[pId]) currentChapterHighlights[pId] = [];
        
        // Adiciona o novo destaque ao cache local
        currentChapterHighlights[pId].push({
            texto: currentSelectionText,
            cor: hexColor,
            temNota: false
        });
    });

    // Chama a fun√ß√£o de pintura imediatamente
    window.refreshVisualHighlights();

    // --- 2. GRAVA√á√ÉO NO FIREBASE (Em segundo plano) ---
    try {
        const { collection, addDoc, query, where, getDocs, updateDoc, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        const capituloId = `${currentPubId}_${currentChapter}`;

        // Verifica se este texto j√° foi destacado antes para este cap√≠tulo
        const q = query(collection(db, 'trechosbiblicos'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '==', currentSelectionText),
            where('capituloId', '==', capituloId)
        );
        const snap = await getDocs(q);

        if (!snap.empty) {
            await updateDoc(doc(db, 'trechosbiblicos', snap.docs[0].id), { 
                cor: hexColor,
                ultimaEdicao: serverTimestamp() 
            });
        } else {
            await addDoc(collection(db, 'trechosbiblicos'), {
                userId: auth.currentUser.uid,
                nome: currentSelectionText,
                cor: hexColor,
                capituloId: capituloId,
                textosbiblicos: currentSelectedParagraphs.map(p => `${currentPubId} ${currentChapter}:${p}`),
                createdAt: serverTimestamp()
            });
        }

        // Limpa a sele√ß√£o do navegador
        window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao gravar destaque:", e);
    }
}


// Fun√ß√£o para remover o destaque do Firebase
async function removeDirectHighlight() {
    if (!currentSelectionText) return;

    try {
        const { collection, query, where, getDocs, deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(collection(db, 'trechosbiblicos'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '==', currentSelectionText)
        );
        const snap = await getDocs(q);

        for (const d of snap.docs) {
            // S√≥ remove se n√£o tiver notas vinculadas (seguran√ßa)
            // Se quiser apagar sempre, retire a condi√ß√£o do if
            if (!d.data().noteIds || d.data().noteIds.length === 0) {
                await deleteDoc(doc(db, 'trechosbiblicos', d.id));
            }
        }

        loadLibraryDataForChapter(currentPubId, currentChapter);
        window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao remover destaque:", e);
    }
}

// --- ATUALIZA√á√ÉO DO MOTOR VISUAL ---
// Vamos modificar o refreshVisualHighlights para suportar este estilo s√≥lido
const originalRefresh = window.refreshVisualHighlights;
window.refreshVisualHighlights = () => {
    const reader = document.getElementById('reader-area');
    if (!reader) return;

    for (const [pId, highlights] of Object.entries(currentChapterHighlights)) {
        const paragraphEl = document.getElementById(pId);
        if (!paragraphEl) continue;

        const pNum = paragraphEl.getAttribute('data-pnum');
        
        // 1. Resetar o par√°grafo para texto limpo antes de pintar
        // Isso evita "ninhos" de spans uns dentro dos outros
        const refNumHTML = `<span class="ref-num" onclick="window.openSidePanel('${pNum}')">${pNum}</span>`;
        let pureText = paragraphEl.innerText.replace(pNum, '').trim();
        paragraphEl.innerHTML = `${refNumHTML} ${pureText}`;

        // 2. Pintar o n√∫mero de azul se tiver notas
        const numEl = paragraphEl.querySelector('.ref-num');
        if (highlights.hasNoteData && numEl) {
            numEl.classList.add('has-data');
        }

        // 3. Aplicar cada destaque
        highlights.forEach(h => {
            if (!h.texto) return;
            
            // Re-obtemos o HTML atualizado a cada volta do loop
            let currentHTML = paragraphEl.innerHTML;
            const escapedText = h.texto.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // Regex que ignora o que j√° est√° dentro de tags span
            const regex = new RegExp(`(${escapedText})(?![^<]*>|[^<>]*<\/span>)`, 'gi');

            if (regex.test(currentHTML)) {
                let className = h.temNota ? 'highlight-picotado' : 'direct-highlight';
                let style = h.temNota 
                    ? `background-image: linear-gradient(to right, ${h.cor} 50%, transparent 50%)`
                    : `background-color: ${h.cor}44; border-bottom: 2px solid ${h.cor};`;

                paragraphEl.innerHTML = currentHTML.replace(regex, 
                    `<span class="${className}" style="${style}" onclick="window.openSidePanel('${pNum}')">$1</span>`
                );
            }
        });
    }
};


window.removeDirectHighlight = async (specificText = null) => {
    const textToRemove = specificText || currentSelectionText;
    if (!textToRemove) return;

    try {
        const { collection, query, where, getDocs, deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const capituloId = `${currentPubId}_${currentChapter}`;
        const q = query(collection(db, 'trechosbiblicos'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '==', textToRemove),
            where('capituloId', '==', capituloId)
        );
        const snap = await getDocs(q);

        for (const d of snap.docs) {
            // Se tiver notas (picotado), n√£o removemos o registro, apenas a cor
            if (d.data().noteIds && d.data().noteIds.length > 0) {
                const { updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await updateDoc(doc(db, 'trechosbiblicos', d.id), { cor: null });
            } else {
                // Se for s√≥ uma cor simples, apaga o documento
                await deleteDoc(doc(db, 'trechosbiblicos', d.id));
            }
        }

        // Feedback visual e fechar pain√©is
        loadLibraryDataForChapter(currentPubId, currentChapter);
        document.getElementById('side-panel').classList.remove('open');
        window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao remover destaque:", e);
    }
};


// Gestor de Troca de Abas na Biblioteca
document.getElementById('library-ref-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    document.querySelectorAll('#library-ref-tabs .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window.renderLibraryRefTab(btn.dataset.refTab);
});

window.renderLibraryRefTab = async function(tab) {
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('side-content');
    
    // --- 1. SALVAR IMEDIATAMENTE ---
    if (content.dataset.currentTab === 'enxertos') {
        globalEnxertoScroll = content.scrollTop;
        console.log(`%c[MEM√ìRIA] Guardado: ${globalEnxertoScroll}px`, "color: #f1c40f; font-weight: bold;");
    }

    const previousTab = content.dataset.currentTab;
    content.dataset.currentTab = tab;

    // --- 2. GEST√ÉO DE ESTILOS ---
    if (tab === 'para-xray' || tab === 'enxertos' || tab === 'bibletext') {
        content.classList.add('xray-active');
    } else {
        content.classList.remove('xray-active');
    }

    // --- 3. ABA ENXERTOS / ARTIGO (‚ùõ‚ùõ‚ùû) ---
    if (tab === 'enxertos') {
        if (cacheSegmentoHTML) {
            content.innerHTML = cacheSegmentoHTML;
            
            // Usamos o valor da vari√°vel global
            const alvo = globalEnxertoScroll || 0;
            console.log(`%c[RESTAURO] Alvo: ${alvo}px`, "color: #2ecc71; font-weight: bold;");

            // Tentativa de restauro progressivo (mais robusto)
            setTimeout(() => { 
                content.scrollTop = alvo; 
                // Se o primeiro falhar (telem√≥veis lentos), tenta um segundo mais tarde
                setTimeout(() => { if(content.scrollTop < alvo - 5) content.scrollTop = alvo; }, 100);
                setTimeout(() => { if(content.scrollTop < alvo - 5) content.scrollTop = alvo; }, 300);
            }, 50);
            return;
        } else {
            content.innerHTML = '<div class="xray-empty-msg">Nenhum artigo aberto.</div>';
            return;
        }
    }

    // --- 4. ABA X-RAY (üìü) ---
    if (tab === 'para-xray') {
        content.innerHTML = cacheXrayHTML || '<div class="xray-empty-msg">Scanner vazio.</div>';
        return;
    }

    // --- 5. ABA B√çBLIA (üìú) ---
    if (tab === 'bibletext') {
        const ref = panel.dataset.currentRef;
        if (ref && ref !== "undefined") window.renderBibleTextInPanel(ref);
        else content.innerHTML = '<div class="xray-empty-msg">Selecione um vers√≠culo.</div>';
        return;
    }

    // --- 6. CARREGAMENTO FIREBASE (üß©, ‚ö°, üìº) ---
    const refName = panel.dataset.currentRef;
    if (!refName || refName === "undefined") {
        content.innerHTML = '<p style="text-align:center; padding:40px; opacity:0.5;">Selecione um par√°grafo.</p>';
        return;
    }

    content.innerHTML = '<div style="padding:50px; text-align:center;"><div class="global-spinner"></div></div>';

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(collection(db, 'livros'), where('nome', '==', refName), where('userId', '==', auth.currentUser.uid));
        const snap = await getDocs(q);

        if (snap.empty) {
            content.innerHTML = '<div class="xray-empty-msg">Sem notas.</div>';
            return;
        }

        const data = snap.docs[0].data();
        content.innerHTML = ''; 

        if (tab === 'puzzle') {
            const board = data.puzzleBoard || [];
            board.forEach((item, index) => {
                const color = item.noteColor || "#3498db";
                const card = document.createElement('div');
                card.className = 'detail-card';
                card.style.borderLeftColor = color;
                card.innerHTML = `
                    <div class="card-menu-container">
                        <div class="card-menu-btn" onclick="window.toggleCardMenu(event)">‚Ä¢‚Ä¢</div>
                        <div class="card-dropdown">
                            <button onclick="window.openEditCard('${panel.dataset.pNum}', ${index})">‚úèÔ∏è Editar</button>
                            <button class="btn-remove-card" onclick="window.deletePuzzleItem('${panel.dataset.pNum}', ${index})">üóëÔ∏è Remover</button>
                        </div>
                    </div>
                    <span class="card-note-title" onclick="window.openNoteFromBoard('${item.noteId}')" style="color:${color}">${item.noteName || 'Sem T√≠tulo'}</span>
                    <div class="card-snippet">${cleanMicaContent(item.snippet)}</div>
                `;
                content.appendChild(card);
            });
        }
        else if (tab === 'links') {
            (data.panelLinks || []).forEach(link => {
                content.innerHTML += `<div class="flash-url-row" style="margin: 10px 15px;"><span style="font-size:1.2rem;">üîó</span><a href="${link.url}" target="_blank" style="color:white; text-decoration:none;">${link.url}</a></div>`;
            });
        }
        else if (tab === 'dossie') {
            (data.dossie || []).forEach((mica) => {
                const micaColor = mica.color || '#e74c3c';
                const micaDiv = document.createElement('div');
                micaDiv.className = 'mica-folder';
                micaDiv.style.borderLeft = `4px solid ${micaColor}`;
                let itemsList = "";
                if(mica.items) {
                    mica.items.forEach(mi => {
                        itemsList += `<div style="padding:10px; border-bottom:1px solid #222;" onclick="window.openNoteFromBoard('${mi.noteId}')"><div style="color:#eee; font-weight:bold; font-size:0.85rem;">${mi.noteName}</div><div style="color:#666; font-size:0.75rem;">${cleanMicaContent(mi.snippet).substring(0,60)}...</div></div>`;
                    });
                }
                micaDiv.innerHTML = `<div class="mica-header" onclick="this.nextElementSibling.classList.toggle('hidden')"><span style="color:${micaColor}">üìÇ ${mica.name.toUpperCase()}</span><span>‚ñº</span></div><div class="mica-content hidden">${itemsList}</div>`;
                content.appendChild(micaDiv);
            });
        }
    } catch (e) {
        content.innerHTML = '<p style="color:red; text-align:center;">Erro de conex√£o.</p>';
    }
};

      


// Vigilante de Scroll: Atualiza a posi√ß√£o em tempo real
document.getElementById('side-content').addEventListener('scroll', (e) => {
    // S√≥ guardamos se a aba ativa for a de enxertos
    if (e.target.dataset.currentTab === 'enxertos') {
        window.enxertoScrollPos = e.target.scrollTop;
    }
}, { passive: true });


window.openQuestionEditor = async (qNum, qText) => {
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('side-content');
    const titleContainer = document.getElementById('side-title-container');

    // 1. Definir o ID √∫nico da pergunta
    const qId = `${currentPubId}_Q${qNum}`;
    window.activeQuestionId = qId; 
    
    panel.classList.add('open');
    document.getElementById('library-ref-tabs').style.display = 'none';
    
    // Mostrar um carregamento enquanto procura
    content.innerHTML = '<div style="padding:40px;text-align:center;"><div class="global-spinner"></div></div>';

    // 2. Procurar se j√° existe uma resposta no Firestore
    let existingDocId = "null";
    let existingContent = "";
    let savedColor = '#2ecc71'; // Cor padr√£o verde

    try {
        const { collection, query, where, getDocs, limit } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'pastas'), 
            where('userId', '==', auth.currentUser.uid),
            where('qId', '==', qId),
            where('estado', '==', 'ativa'),
            limit(1)
        );
        
        const snap = await getDocs(q);

        if (!snap.empty) {
            const docData = snap.docs[0].data();
            existingDocId = snap.docs[0].id;
            
            // Extrair o conte√∫do da nota (limpando o HTML do wrapper se necess√°rio)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = docData.conteudo;
            const contentDiv = tempDiv.querySelector('.mini-note-content');
            existingContent = contentDiv ? contentDiv.innerHTML : docData.conteudo;
            
            // Tentar recuperar a cor salva no atributo data-highlight ou no array de cores
            const wrapper = tempDiv.querySelector('.mini-note-wrapper');
            if (wrapper && wrapper.dataset.highlight) {
                savedColor = wrapper.dataset.highlight;
            } else if (docData.coresUsadas && docData.coresUsadas.length > 0) {
                savedColor = docData.coresUsadas[0];
            }
        }
    } catch (e) {
        console.error("Erro ao carregar resposta existente:", e);
    }

    window.selectedColorHex = savedColor;
    await loadUserColorNames();

    // 3. Renderizar o interface com os dados carregados
    titleContainer.innerHTML = `<span style="color:#2ecc71; font-weight:bold;">Pergunta ${qNum}</span>`;

    content.innerHTML = `
        <div class="note-creation-form" style="padding: 10px;">
            <h2 style="font-size:1.1em; color:white; margin-bottom:15px; line-height:1.4;">${qText}</h2>
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="window.toggleQuestionColorGrid()" title="Cores Destaque">üé®</button>
                <button onclick="window.openFlashLinkManager()" title="Links">‚ö°</button>
            </div>

            <div id="q-color-grid" style="display:none; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #252528; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444;">
                ${window.generateQuestionColorGridHTML()}
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" 
                 placeholder="Escreva a sua resposta aqui..."
                 style="border-left: 4px solid ${window.selectedColorHex}; min-height:250px; padding:15px; outline:none;">${existingContent}</div>

            <button id="btn-save-question" onclick="window.saveQuestionAnswer('${existingDocId}', '${encodeURIComponent(qText)}')" 
                    style="width:100%; margin-top:20px; padding:15px; background:#2ecc71; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                ${existingDocId !== "null" ? "ATUALIZAR RESPOSTA" : "GRAVAR RESPOSTA"}
            </button>
        </div>
    `;
};

// Gera o HTML do 3x3 com nomes sincronizados
window.generateQuestionColorGridHTML = () => {
    return DEFAULT_HIGHLIGHTS.map(c => {
        const displayName = userCustomHighlights[c.code] || c.name;
        return `
            <div onclick="window.selectQuestionColor('${c.code}')" style="display:flex; flex-direction:column; align-items:center; cursor:pointer; gap:5px;">
                <div style="width:30px; height:30px; border-radius:50%; background:${c.code}; border:2px solid ${window.selectedColorHex === c.code ? 'white' : 'transparent'}"></div>
                <span style="font-size:10px; text-align:center; color:#888;">${displayName}</span>
            </div>
        `;
    }).join('');
};

window.toggleQuestionColorGrid = () => {
    const grid = document.getElementById('q-color-grid');
    grid.style.display = grid.style.display === 'none' ? 'grid' : 'none';
};

window.selectQuestionColor = (hex) => {
    // Definimos qual √© a cor "b√°sica" para as perguntas
    const COR_BASICA = '#2ecc71'; 

    // Se a cor clicada j√° for a que est√° selecionada, voltamos ao b√°sico
    if (window.selectedColorHex === hex) {
        window.selectedColorHex = COR_BASICA;
    } else {
        // Caso contr√°rio, aplicamos a nova cor
        window.selectedColorHex = hex;
    }

    // Atualiza a borda do editor
    const editor = document.getElementById('flash-editor');
    if (editor) {
        editor.style.borderLeft = `4px solid ${window.selectedColorHex}`;
    }

    // Atualiza o HTML do grid para que a borda branca (indicador de sele√ß√£o) mude de s√≠tio
    const grid = document.getElementById('q-color-grid');
    if (grid) {
        grid.innerHTML = window.generateQuestionColorGridHTML();
    }

    // Fecha o grid ap√≥s a sele√ß√£o (opcional, se preferires que fique aberto retira a linha abaixo)
    window.toggleQuestionColorGrid(); 
};


window.openHighlightModal = () => {
    // Podes reaproveitar o modal de cores existente ou criar um popup simples
    // Para simplificar, vamos disparar o renderColorPicker e mostrar a div
    const picker = document.getElementById('color-picker');
    // Se quiseres que apare√ßa como um modal, usa:
    // document.getElementById('flash-note-modal').style.display = 'flex';
    // Mas o ideal aqui √© um prompt de cores ou abrir o modal de destaques se o tiveres.
    renderColorPicker(); 
    alert("Escolha a cor nas bolas que apareceram em baixo!"); 
    // Ou podes abrir um pequeno overlay s√≥ com as cores.
};


window.openListCategory = async (type, title, contextId = null) => {
    // 1. Monitoriza√ß√£o e Logs de Navega√ß√£o
    console.log(`%cüöÄ [Lists] Abrindo: ${type} | ${title}`, "background: #222; color: #bada55; padding: 2px 5px; font-weight: bold;");
    
    // 2. Gest√£o da Pilha de Navega√ß√£o (Stack) para o bot√£o Voltar
    const lastInStack = listsStack[listsStack.length - 1];
    if (!lastInStack || lastInStack.title !== title) {
        listsStack.push({ type, title, contextId });
    }
    
    if (typeof updateListsHeader === 'function') updateListsHeader();
    
    const ul = document.getElementById('lists-content');
    if (!ul) return;

    // Ativar Spinner de carregamento visual
    ul.innerHTML = `
        <div class="sidebar-loading">
            <div class="spinner"></div>
            <span>A organizar ${title}...</span>
        </div>`;

    const myUid = auth.currentUser.uid;
    const IDs_REVISTAS = ["w", "g", "wp", "km", "mwb"];

    try {
        const { collection, query, where, getDocs, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // ============================================================
        // CASO 1: CONTE√öDO DE ARTIGO (A SENTINELA OU LIVROS)
        // ============================================================
        if (type === 'sentinela-content' || type === 'book-chapter') {
            let artigo;
            let bookTitle = "";
            let mesNum = "";
            let bookId = "";

            if (type === 'sentinela-content') {
                const { ano, mesNum: m, artIdx } = contextId;
                const response = await fetch(`./js/publicacoes/sentinelas/${ano}/${m}.json`);
                const data = await response.json();
                const lista = data.artigos ? data.artigos : [data];
                artigo = lista[artIdx];
                bookTitle = artigo.titulo;
                mesNum = m;
                bookId = 'sentinela';
            } else {
                const { bookId: bId, capIdx } = contextId;
                const response = await fetch(`./js/books/${bId}.json`);
                const data = await response.json();
                artigo = data.capitulos[capIdx];
                bookTitle = data.titulo;
                bookId = bId;
            }

            ul.innerHTML = "";
            const hLi = document.createElement('li');
            hLi.className = 'list-group-header';
            hLi.textContent = bookTitle;
            ul.appendChild(hLi);
            
            let isInsideReview = false; // Deteta se entrou na sec√ß√£o "Como responderia?"

            artigo.conteudo.forEach((bloco) => {
                const li = document.createElement('li');
                let textoOriginal = bloco.texto;

                // A. Aplicar Links B√≠blicos Invis√≠veis (Ghost)
                let textoProcessado = typeof linkifyBibleReferences === 'function' 
                    ? linkifyBibleReferences(textoOriginal) 
                    : textoOriginal;

                // B. Aplicar Destaques (Highlights) vindos da Library
                if (window.currentArticleHighlights && window.currentArticleHighlights.length > 0) {
                    window.currentArticleHighlights.forEach(h => {
                        if (textoProcessado.includes(h.nome)) {
                            const escapedH = h.nome.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            // Regex para n√£o quebrar tags HTML j√° existentes
                            const regH = new RegExp(`(${escapedH})(?![^<]*>|[^<>]*<\/span>)`, 'gi');
                            const style = `background-color: ${h.cor}44; border-bottom: 2px solid ${h.cor};`;
                            textoProcessado = textoProcessado.replace(regH, `<span style="${style}">$1</span>`);
                        }
                    });
                }

                // C. L√≥gica de Renderiza√ß√£o por tipo de bloco
                if (bloco.tipo === 'subtema') {
                    if (textoOriginal.toUpperCase().includes("COMO RESPONDERIA")) isInsideReview = true;
                    li.style.cssText = `padding:20px 10px 5px 10px; font-weight:bold; color:var(--accent-color); font-size:1em; ${isInsideReview ? 'color:#9b59b6; border-bottom:1px solid #9b59b633;' : ''}`;
                    li.innerHTML = textoProcessado;
                    ul.appendChild(li);
                    return;
                }

                if (bloco.tipo === 'cantico') {
                    li.style.cssText = "padding:15px 10px; text-align:center; font-style:italic; color:#e67e22; border-bottom:1px solid #333; cursor:pointer;";
                    li.innerHTML = `üéµ ${textoProcessado}`;
                    li.onclick = () => window.openBookParagraphPanel(bookId, bookTitle, artigo.capitulo || mesNum, "cantico", textoOriginal, true, "üéµ");
                } 
               else if (bloco.tipo === 'pergunta') {
    const safeText = encodeURIComponent(bloco.texto);
    li.className = 'toc-item-row';
    li.style.cssText = "font-size:0.95em; line-height:1.5; padding:12px 10px; border-bottom:1px solid rgba(128,128,128,0.1); cursor:pointer; display:block;";
    li.innerHTML = `<span style="color:#d3869b; font-weight:bold;">${bloco.numero_ref}.</span> ${textoProcessado}`;
    
    // Agora chama o editor especializado
    li.onclick = () => window.openQuestionEditor(bloco.numero_ref, decodeURIComponent(safeText));
}
                else {
                    // --- MODO PAR√ÅGRAFO NORMAL ---
                    li.className = 'toc-item-row';
                    li.style.cssText = "font-size:0.95em; line-height:1.5; padding:12px 10px; border-bottom:1px solid rgba(128,128,128,0.1); cursor:pointer; display:block;";
                    
                    if (isInsideReview) {
                        li.innerHTML = `<span style="color:#9b59b6; font-weight:800; font-size:0.75em; display:block;">RECAPITULA√á√ÉO</span>${textoProcessado}`;
                    } else {
                        li.innerHTML = `<span class="paragraph-badge">pr ${bloco.numero_ref || '?'}</span>${textoProcessado}`;
                    }

                    li.onclick = () => {
                        const primaryRef = bloco.numero_ref ? bloco.numero_ref.split(',')[0].trim() : '0';
                        window.openBookParagraphPanel(bookId, bookTitle, artigo.capitulo || mesNum, primaryRef, textoOriginal, true, bloco.numero_ref);
                    };
                }
                ul.appendChild(li);
            });
            return;
        }

        // ============================================================
        // CASO 2: LISTA DE DESTAQUES (CORES)
        // ============================================================
        if (type === 'destaque') {
            ul.innerHTML = '<li class="list-group-header">Filtrar por Cor</li>';
            const colors = (globalHighlightsCache && Object.keys(globalHighlightsCache).length > 0) 
                ? Object.entries(globalHighlightsCache).map(([name, code]) => ({ name, code }))
                : DEFAULT_HIGHLIGHTS;
            
            colors.forEach(color => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="width:16px; height:16px; background:${color.code}; border-radius:50%; margin-right:12px; border:1px solid rgba(255,255,255,0.2);"></span> ${color.name}`;
                li.onclick = () => window.showHighlightRef(color.code, color.name);
                ul.appendChild(li);
            });
        }

        // ============================================================
        // CASO 3: T√ìPICOS E MARCADORES
        // ============================================================
        else if (type === 'topico' || type === 'marcadores') {
            const coll = type === 'topico' ? 'topicos' : 'marcadores';
            const q = query(collection(db, coll), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            ul.innerHTML = "";
            snap.forEach(docSnap => {
                const li = document.createElement('li');
                const icon = type === 'topico' ? 'üìë' : 'üîñ';
                li.innerHTML = `<span>${icon} ${docSnap.data().nome}</span>`;
                li.onclick = () => {
                    if (type === 'topico') window.showTopicRef(docSnap.id, docSnap.data().nome, 'topico');
                    else window.showMarkerReferencesPanel(docSnap.id, docSnap.data().nome);
                };
                ul.appendChild(li);
            });
        }

        // ============================================================
        // CASO 4: LIVROS (TOC PRINCIPAL)
        // ============================================================
        else if (type === 'livros') {
            ul.innerHTML = '';
            // Artigos da Sentinela
            const liW = document.createElement('li');
            liW.innerHTML = `<span class="list-icon">üìÖ</span> A Sentinela (Anos)`;
            liW.onclick = () => window.openListCategory('sentinela-years', 'Anos da Sentinela', 'w');
            ul.appendChild(liW);

            // Livros est√°ticos do cat√°logo
            Object.keys(SIGLAS_PUBLICACOES).forEach(id => {
                if (!IDs_REVISTAS.includes(id)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="list-icon">üìî</span> ${SIGLAS_PUBLICACOES[id]}`;
                    li.onclick = () => window.openListCategory('book-toc', SIGLAS_PUBLICACOES[id], id);
                    ul.appendChild(li);
                }
            });
        }

        // Fallback para tipos simples (Personagens, Locais, etc.)
        else {
            const coll = ENTITY_CONFIG[type]?.collection;
            if (coll) {
                const q = query(collection(db, coll), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                ul.innerHTML = "";
                snap.forEach(docSnap => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>üîπ ${docSnap.data().nome}</span>`;
                    li.onclick = () => window.showReferencesPanel(docSnap.id, docSnap.data().nome, type);
                    ul.appendChild(li);
                });
            }
        }

    } catch (error) {
        console.error("‚ùå Erro ao renderizar categoria:", error);
        ul.innerHTML = '<li style="color:red; padding:20px; text-align:center;">Erro ao carregar dados.</li>';
    }
};


// Fun√ß√£o para carregar os nomes das cores do Firestore
async function loadUserColorNames() {
    if (!auth.currentUser) return;
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            userCustomHighlights = docSnap.data().colors || {};
        }
    } catch (e) { console.error("Erro ao carregar nomes das cores:", e); }
}

// --- FUN√á√ÉO PARA GRAVAR NOTA VINDA DA BIBLIOTECA ---
window.saveLibraryFlashNote = async (clickedBtn) => {
    if (!clickedBtn || clickedBtn.disabled) return;

    clickedBtn.disabled = true;
    const originalText = clickedBtn.textContent;
    clickedBtn.textContent = "A gravar...";

    try {
        const { collection, addDoc, doc, updateDoc, arrayUnion, serverTimestamp, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        const titleInput = document.getElementById('flash-title');
        const editor = document.getElementById('flash-editor');
        const typeSelect = document.getElementById('flash-type-select');

        const title = titleInput.value.trim();
        const content = editor.innerHTML;
        const noteType = typeSelect ? typeSelect.value : 'default';
        const color = window.selectedColorHex || '#3498db';
        const boxUniqueId = "box_" + Date.now();

        if (!title) {
            alert("O t√≠tulo √© obrigat√≥rio!");
            clickedBtn.disabled = false;
            clickedBtn.textContent = originalText;
            return;
        }

        // ============================================================
        // üõ†Ô∏è L√ìGICA DE CODEX AUTOM√ÅTICO
        // ============================================================
        // 1. Garantir que a estrutura de links existe
        if (!currentFlashLinks) currentFlashLinks = {};
        if (!currentFlashLinks.codex) currentFlashLinks.codex = [];

        // 2. Criar a refer√™ncia autom√°tica do livro/cap√≠tulo/par√°grafo
        const autoCodex = {
            serie: currentPubId,
            capitulo: String(currentChapter),
            paragrafos: currentSelectedParagraphs.map(String),
            total: `${currentPubId.toUpperCase()} Cap. ${currentChapter}`,
            type: 'codex'
        };

        // 3. Evitar duplicados: se j√° existir uma entrada para este livro, atualiza-a
        const existingIdx = currentFlashLinks.codex.findIndex(c => c.serie === currentPubId);
        if (existingIdx > -1) {
            currentFlashLinks.codex[existingIdx] = autoCodex;
        } else {
            currentFlashLinks.codex.push(autoCodex);
        }
        // ============================================================

        const safeTopics = JSON.stringify(currentFlashTopics || {}).replace(/"/g, '&quot;');
        
        // Garantir que a refer√™ncia b√≠blica/livro tamb√©m est√° nas categorias para busca
        if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
        const refName = `${currentPubId} ${currentChapter}:${currentSelectedParagraphs[0]}`;
        if (!currentFlashLinks.categories.some(c => c.name === refName)) {
            currentFlashLinks.categories.push({ id: "temp", name: refName, type: "livro_ref" });
        }

        const safeBoxLinks = JSON.stringify(currentFlashLinks).replace(/"/g, '&quot;');

        const commonToolbarHTML = `
            <div class="mini-note-toolbar" contenteditable="false">
                <button type="button" data-action="sharing-settings">üîê</button>
                <div class="toolbar-btn-group">
                    <button type="button" data-action="move-up">üî∫</button>
                    <button type="button" data-action="move-down">üîª</button>
                </div>
                <button type="button" data-action="manage-box-links">‚ö°</button>
                <button type="button" data-action="append-mini-note">üß¨</button>
                <button type="button" data-action="highlight-color">üé®</button>
                <button type="button" data-action="manage-mini-note-topics">üìã</button>
                <button type="button" data-action="delete-mini-note">üóëÔ∏è</button>
            </div>`;

        let wrapperClass = "mini-note-wrapper";
        if (noteType === 'question') wrapperClass += " question-mode";

        const subNoteHtml = `
            <div class="${wrapperClass}" id="${boxUniqueId}" 
                 data-topics='${safeTopics}' data-shared="false" data-box-links='${safeBoxLinks}' 
                 contenteditable="false">
                <textarea class="mini-note-title-input" rows="1">${title}</textarea>
                ${commonToolbarHTML}
                <div class="mini-note-content" contenteditable="true">${content}</div>
            </div><p><br></p>
        `;

        // GRAVAR EM 'PASTAS'
        const noteRef = await addDoc(collection(db, 'pastas'), {
            nome: title,
            conteudo: subNoteHtml,
            tipo: 'nota',
            oque: 'back',
            userId: auth.currentUser.uid,
            estado: 'ativa',
            boxIds: [boxUniqueId],
            coresUsadas: [color.toUpperCase()],
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        });

        // VINCULAR AOS LIVROS (PuzzleBoard)
        const puzzleItem = {
            type: 'ref',
            noteId: noteRef.id,
            noteName: title,
            snippet: encodeURIComponent(subNoteHtml),
            noteColor: color,
            addedAt: Date.now()
        };

        for (const pNum of currentSelectedParagraphs) {
            const fullName = `${currentPubId} ${currentChapter}:${pNum}`;
            const q = query(collection(db, 'livros'), where('nome', '==', fullName), where('userId', '==', auth.currentUser.uid));
            const snap = await getDocs(q);

            if (!snap.empty) {
                await updateDoc(doc(db, 'livros', snap.docs[0].id), { puzzleBoard: arrayUnion(puzzleItem) });
            } else {
                await addDoc(collection(db, 'livros'), {
                    nome: fullName, userId: auth.currentUser.uid, puzzleBoard: [puzzleItem], 
                    dossie: [], panelLinks: [], createdAt: serverTimestamp()
                });
            }
        }

        clickedBtn.textContent = "‚úÖ GUARDADO";
        setTimeout(() => {
            window.closeSidePanel();
            loadLibraryDataForChapter(currentPubId, currentChapter);
        }, 1000);

    } catch (e) {
        console.error(e);
        alert("Erro ao gravar.");
        clickedBtn.disabled = false;
        clickedBtn.textContent = originalText;
    }
};

function buildVerseHTML(data, num) {
    const puzzleCount = data?.puzzleBoard?.length || 0;
    const dossieCount = data?.dossie?.length || 0;
    const linksCount  = data?.panelLinks?.length || 0;
    const totalCount = puzzleCount + dossieCount + linksCount;

    if (totalCount === 0) return '<div style="padding:40px; text-align:center; opacity:0.3;">Vazio.</div>';

    // 1. RENDERIZAR PUZZLE (üß©)
    let puzzleHtml = "";
    if (data?.puzzleBoard) {
       data.puzzleBoard.forEach((item, index) => {
    const cleanText = cleanMicaContent(item.snippet);
    const color = item.noteColor || "#3498db";
    const sources = window.extractSources(item.snippet); // Verifica fontes aqui

    // Monta o bot√£o de fontes apenas se houver dados
    const btnSources = sources ? 
        `<button onclick="window.viewSources('${encodeURIComponent(JSON.stringify(sources))}')">üìé Fontes</button>` : '';

    puzzleHtml += `
        <div class="detail-card" style="border-left-color: ${color};">
            
            <!-- Menu de 2 Pontos -->
            <div class="card-menu-container">
                <div class="card-menu-btn" onclick="window.toggleCardMenu(event)">‚Ä¢‚Ä¢</div>
                <div class="card-dropdown">
                    <button onclick="window.openEditCard('${num}', ${index})">‚úèÔ∏è Editar</button>
                    ${btnSources}
                    <button class="btn-remove-card" onclick="window.deletePuzzleItem('${num}', ${index})">üóëÔ∏è Remover</button>
                </div>
            </div>

            <span class="card-note-title" onclick="window.openNoteFromBoard('${item.noteId}')">
                ${item.noteName || 'Sem T√≠tulo'}
            </span>
            <div class="card-snippet">${cleanText}</div>
        </div>`;
});
    }

    // 2. RENDERIZAR DOSSI√â (üìº)
    let dossieHtml = "";
    if (dossieCount > 0) {
        data.dossie.forEach((mica) => {
            const micaColor = mica.color || '#e74c3c';
            let itemsList = "";
            
            if(mica.items && mica.items.length > 0) {
                mica.items.forEach(mi => {
                    itemsList += `
                        <div style="background:rgba(255,255,255,0.02); border-radius:4px; padding:10px; margin-bottom:8px; border-left: 2px solid #3498db;">
                            <span class="card-note-title" style="font-size:0.9rem;" onclick="window.openNoteFromBoard('${mi.noteId}')">${mi.noteName}</span>
                            <div style="font-size:0.85rem; color:#888;">${cleanMicaContent(mi.snippet)}</div>
                        </div>`;
                });
            }

            dossieHtml += `
                <div class="mica-folder" style="border-left: 4px solid ${micaColor};">
                    <div class="mica-header" style="padding:10px 15px; cursor:pointer; display:flex; justify-content:space-between;" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <strong style="color:${micaColor}; font-size:0.85rem;">üìÇ ${mica.name.toUpperCase()}</strong>
                        <span>‚ñº</span>
                    </div>
                    <div class="mica-content hidden" style="padding:10px; background:#111;">${itemsList}</div>
                </div>`;
        });
    }

    // Retorna a estrutura de abas igual ao NoteBook
    return `
        <div class="sidebar-tabs">
            <button class="tab-btn active" onclick="window.switchLibraryTab(this, 'all')">‚ôæÔ∏è</button>
            <button class="tab-btn" onclick="window.switchLibraryTab(this, 'puzzle')">üß©</button>
            <button class="tab-btn" onclick="window.switchLibraryTab(this, 'links')">‚ö°</button>
            <button class="tab-btn" onclick="window.switchLibraryTab(this, 'dossie')">üìº</button>
        </div>
        <div id="pane-all" class="tab-pane active">${puzzleHtml}${dossieHtml}</div>
        <div id="pane-puzzle" class="tab-pane">${puzzleHtml}</div>
        <div id="pane-dossie" class="tab-pane">${dossieHtml}</div>
    `;
}

function cleanMicaContent(snippet) {
    if (!snippet) return "";
    
    // 1. Descodifica o conte√∫do
    let decoded = "";
    try {
        decoded = decodeURIComponent(snippet);
    } catch (e) {
        decoded = snippet;
    }

    // 2. Cria um elemento tempor√°rio para manipular o HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = decoded;

    // 3. REMO√á√ÉO CR√çTICA: Remove a toolbar, bot√µes e campos de entrada de t√≠tulo
    // Estes s√£o os elementos que cont√™m os s√≠mbolos que voc√™ v√™ na imagem
    const elementsToRemove = [
        '.mini-note-toolbar', 
        'button', 
        '.mini-note-title-input', 
        'textarea',
        'script',
        'style'
    ];

    elementsToRemove.forEach(selector => {
        tempDiv.querySelectorAll(selector).forEach(el => el.remove());
    });

    // 4. EXTRA√á√ÉO DE TEXTO LIMPO
    // Tentamos pegar apenas o conte√∫do da div de texto, se n√£o houver, pegamos o texto geral
    const contentDiv = tempDiv.querySelector('.mini-note-content');
    let text = contentDiv ? contentDiv.innerText : tempDiv.innerText;

    // 5. LIMPEZA FINAL: Remove emojis de sistema remanescentes e espa√ßos extras
    const systemIconsRegex = /[üîêüî∫üîª‚ö°üß¨üé®üìãüóëÔ∏è]/gu;
    text = text.replace(systemIconsRegex, '');

    // Retorna apenas os primeiros 150 caracteres para o preview
    return text.trim();
}

window.switchLibraryTab = (btn, tabName) => {
    // 1. Bot√µes
    const parent = btn.parentElement;
    parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 2. Pain√©is
    const contentArea = parent.nextElementSibling.parentElement; // O side-content
    contentArea.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    
    const targetPane = document.getElementById(`pane-${tabName}`);
    if (targetPane) targetPane.classList.add('active');
};


// Fun√ß√£o para extrair dados de links do HTML da nota
window.extractSources = function(snippetHtml) {
    if (!snippetHtml) return null;
    try {
        const decoded = decodeURIComponent(snippetHtml);
        const parser = new DOMParser();
        const doc = parser.parseFromString(decoded, 'text/html');
        const wrapper = doc.querySelector('[data-box-links]');
        
        if (wrapper) {
            const data = JSON.parse(wrapper.getAttribute('data-box-links'));
            // Verifica se h√° URLs ou itens no Codex
            const hasUrls = data.urls && Object.keys(data.urls).length > 0;
            const hasCodex = data.codex && data.codex.length > 0;
            
            return (hasUrls || hasCodex) ? data : null;
        }
    } catch (e) { return null; }
    return null;
};

// Alternar visibilidade do menu
window.toggleCardMenu = (event) => {
    // 1. Impede que o clique "suba" para o document e feche o menu na hora
    event.stopPropagation();
    
    const btn = event.currentTarget;
    const dropdown = btn.nextElementSibling;
    const isVisible = dropdown.classList.contains('visible');
    
    // 2. Fecha todos os outros menus que possam estar abertos
    document.querySelectorAll('.card-dropdown').forEach(d => d.classList.remove('visible'));
    
    // 3. Abre o menu atual se ele n√£o estava vis√≠vel
    if (!isVisible) {
        dropdown.classList.add('visible');
    }
    
    // 4. Cria a fun√ß√£o para fechar ao clicar fora, apenas uma vez
    const closeMenu = () => {
        dropdown.classList.remove('visible');
        document.removeEventListener('click', closeMenu);
    };

    // Adiciona o listener para fechar quando clicar em qualquer outro lugar
    document.addEventListener('click', closeMenu);
};

window.viewSources = (encodedData) => {
    const data = JSON.parse(decodeURIComponent(encodedData));
    const modal = document.getElementById('view-sources-modal');
    const container = document.getElementById('view-sources-content');
    
    modal.style.display = 'flex';
    container.innerHTML = '';

    if (data.urls) {
        container.innerHTML += `<div style="font-size:0.7rem; color:#888; margin-bottom:10px; font-weight:bold; text-transform:uppercase;">üåê Links Web</div>`;
        Object.values(data.urls).forEach(url => {
            container.innerHTML += `
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px; margin-bottom:8px; border-left:3px solid #3498db;">
                    <a href="${url}" target="_blank" style="color:#fff; text-decoration:none; font-size:0.9rem; word-break:break-all;">üîó ${url}</a>
                </div>`;
        });
    }

    if (data.codex && data.codex.length > 0) {
        container.innerHTML += `<div style="font-size:0.7rem; color:#888; margin:15px 0 10px 0; font-weight:bold; text-transform:uppercase;">üìö Codex</div>`;
        data.codex.forEach(c => {
            container.innerHTML += `
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px; margin-bottom:8px; border-left:3px solid #e67e22;">
                    <strong style="color:#fff; display:block;">${c.serie.toUpperCase()}</strong>
                    <small style="color:#aaa;">${c.total}</small>
                </div>`;
        });
    }
};




// --- ABRIR MODAL DE EDI√á√ÉO ---
window.openEditCard = async (pNum, index) => {
    console.log("%c[1/6] Iniciando openEditCard", "color: orange; font-weight: bold;");
    
    const panel = document.getElementById('side-panel');
    const refName = panel.dataset.currentRef; 

    if (!refName) {
        alert("Erro: Refer√™ncia n√£o encontrada.");
        return;
    }

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(collection(db, 'livros'), where('nome', '==', refName), where('userId', '==', auth.currentUser.uid));
        const snap = await getDocs(q);

        if (snap.empty) return;

        const docSnapshot = snap.docs[0];
        const item = docSnapshot.data().puzzleBoard[index];

        const decoded = decodeURIComponent(item.snippet);
        const parser = new DOMParser();
        const docHTML = parser.parseFromString(decoded, 'text/html');
        
        const wrapper = docHTML.querySelector('.mini-note-wrapper');
        if (wrapper) {
            window.currentFlashTopics = JSON.parse(wrapper.getAttribute('data-topics') || '{}');
            window.currentFlashLinks = JSON.parse(wrapper.getAttribute('data-box-links') || '{}');
        }

        const titleInput = document.getElementById('edit-card-title');
        const editorDiv = document.getElementById('edit-card-editor');
        const modal = document.getElementById('edit-card-modal');

        // PREENCHIMENTO
        titleInput.value = item.noteName || "";
        const contentDiv = docHTML.querySelector('.mini-note-content');
        editorDiv.innerHTML = contentDiv ? contentDiv.innerHTML : docHTML.body.innerHTML;

        // FOR√áAR VISIBILIDADE (A corre√ß√£o est√° aqui)
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = '100000'; // Maior que o global-auth-shield (99999)
        
        // Esconder o loader por seguran√ßa se ele ainda estiver l√°
        const shield = document.getElementById('global-auth-shield');
        if (shield) shield.style.display = 'none';

        console.log("%cSUCESSO: Modal deve estar vis√≠vel agora.", "color: green; font-weight: bold;");

        document.getElementById('btn-confirm-edit').onclick = () => {
            window.saveEditLibraryNote(docSnapshot.id, index, item.noteId);
        };

    } catch (e) {
        console.error("Erro ao abrir modal:", e);
    }
};


// --- GRAVAR ALTERA√á√ïES ---
window.saveEditLibraryNote = async (docLibraryId, index, noteId) => {
    const btn = document.getElementById('btn-confirm-edit');
    if(btn.disabled) return;
    btn.disabled = true;

    try {
        const newTitle = document.getElementById('edit-card-title').value;
        const newContent = document.getElementById('edit-card-editor').innerHTML;
        
        const safeTopics = JSON.stringify(window.currentFlashTopics || {}).replace(/"/g, '&quot;');
        const safeLinks = JSON.stringify(window.currentFlashLinks || {}).replace(/"/g, '&quot;');
        
        const updatedHtml = `
            <div class="mini-note-wrapper" data-topics='${safeTopics}' data-box-links='${safeLinks}' contenteditable="false">
                <textarea class="mini-note-title-input">${newTitle}</textarea>
                <div class="mini-note-content" contenteditable="true">${newContent}</div>
            </div>`;

        // Atualiza nota principal
        await updateDoc(doc(db, 'pastas', noteId), {
            nome: newTitle,
            conteudo: updatedHtml,
            ultimaedicao: serverTimestamp()
        });

        // Atualiza a c√≥pia no par√°grafo
        const libRef = doc(db, 'livros', docLibraryId);
        const libSnap = await getDoc(libRef);
        const board = libSnap.data().puzzleBoard;
        board[index].noteName = newTitle;
        board[index].snippet = encodeURIComponent(updatedHtml);
        
        await updateDoc(libRef, { puzzleBoard: board });

        document.getElementById('edit-card-modal').style.display = 'none';
        window.renderLibraryRefTab('puzzle'); 
    } catch (e) {
        console.error(e);
        alert("Erro ao salvar.");
    } finally {
        btn.disabled = false;
    }
};



window.deletePuzzleItem = async (pNum, index) => {
    if (!confirm("Deseja remover esta nota deste par√°grafo?")) return;

    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const refName = `${currentPubId} ${currentChapter}:${pNum}`;
        const q = (await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js")).query(
            (await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js")).collection(db, 'livros'), 
            where('nome', '==', refName), 
            where('userId', '==', auth.currentUser.uid)
        );
        const snap = await (await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js")).getDocs(q);

        if (!snap.empty) {
            const libDoc = snap.docs[0];
            const board = libDoc.data().puzzleBoard;
            board.splice(index, 1); // Remove o item
            
            await updateDoc(doc(db, 'livros', libDoc.id), { puzzleBoard: board });
            window.renderLibraryRefTab('puzzle'); // Atualiza a lista
        }
    } catch (e) {
        console.error(e);
    }
};

// Fun√ß√£o para apagar todas as cores de um par√°grafo sem precisar selecionar o texto
window.clearAllHighlightsFromParagraph = function(pNum) {
    console.log("%c[DEBUG] Fun√ß√£o clearAllHighlights iniciada para pNum: " + pNum, "color: orange; font-weight: bold;");

    const modal = document.getElementById('custom-confirm-modal');
    const okBtn = document.getElementById('confirm-ok-btn');
    const cancelBtn = document.getElementById('confirm-cancel-btn');

    if (!modal) {
        console.error("%c[ERRO] O elemento 'custom-confirm-modal' N√ÉO EXISTE no HTML!", "background: red; color: white;");
        alert("Erro: Modal de confirma√ß√£o n√£o encontrado na p√°gina.");
        return;
    }

    console.log("[DEBUG] Modal encontrado. Exibindo...");
    modal.style.display = 'flex';

    cancelBtn.onclick = () => {
        console.log("[DEBUG] Utilizador clicou em Cancelar.");
        modal.style.display = 'none';
    };

    okBtn.onclick = async () => {
        console.log("%c[DEBUG] Utilizador confirmou a remo√ß√£o. Acedendo ao Firebase...", "color: yellow;");
        modal.style.display = 'none';
        
        try {
            const { collection, query, where, getDocs, deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const capituloId = `${currentPubId}_${currentChapter}`;
            const refFull = `${currentPubId} ${currentChapter}:${pNum}`;
            const pId = `p-${pNum}`;

            console.log("[DEBUG] Query: capituloId =", capituloId, " | refFull =", refFull);

            const q = query(collection(db, 'trechosbiblicos'), 
                where('userId', '==', auth.currentUser.uid),
                where('capituloId', '==', capituloId)
            );
            
            const snap = await getDocs(q);
            console.log("[DEBUG] Documentos encontrados na query: " + snap.size);

            let deletados = 0;
            for (const d of snap.docs) {
                const data = d.data();
                if (data.textosbiblicos && data.textosbiblicos.includes(refFull)) {
                    if (!data.noteIds || data.noteIds.length === 0) {
                        await deleteDoc(doc(db, 'trechosbiblicos', d.id));
                        deletados++;
                    } else {
                        console.log("[DEBUG] Documento " + d.id + " ignorado pois tem Nota Flash.");
                    }
                }
            }
            console.log("%c[SUCESSO] Firebase atualizado. Removidos: " + deletados, "color: green;");

            // LIMPEZA VISUAL
            console.log("[DEBUG] Iniciando limpeza visual do par√°grafo: " + pId);
            const paragraphEl = document.getElementById(pId);
            
            if (paragraphEl) {
                delete currentChapterHighlights[pId];
                
                let textContent = paragraphEl.innerText;
                // Removemos o n√∫mero do in√≠cio se ele estiver l√°
                if (textContent.startsWith(pNum)) {
                    textContent = textContent.replace(pNum, "").trim();
                }

                paragraphEl.innerHTML = `<span class="ref-num" onclick="window.openSidePanel('${pNum}')">${pNum}</span> ${textContent}`;
                
                if (window.refreshVisualHighlights) {
                    console.log("[DEBUG] Chamando refreshVisualHighlights para atualizar visual restante.");
                    window.refreshVisualHighlights();
                }
            } else {
                console.warn("[AVISO] Elemento do par√°grafo " + pId + " n√£o encontrado para limpeza visual.");
            }

            window.closeSidePanel();
            console.log("%c[FINALIZADO] Processo conclu√≠do.", "background: green; color: white;");

        } catch (e) {
            console.error("%c[ERRO CR√çTICO] Falha no processo de limpeza:", "background: red; color: white;", e);
        }
    };
};


// --- ESTADO DA PESQUISA DA BIBLIOTECA ---
let libSearchState = {
    query: "",
    filter: "all", 
    scope: "para", 
    selectedPub: null,
    allResults: [],
    pageSize: 300,
    displayedCount: 0
};

// 1. Abrir Modal
document.getElementById('search-library-btn').onclick = () => {
    document.getElementById('search-library-modal').style.display = 'flex';
    document.getElementById('lib-search-input').focus();
};

// 2. Filtros Globais
window.setLibFilter = (type, btn) => {
    libSearchState.filter = type;
    document.querySelectorAll('#lib-filter-group .testament-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    libSearchState.selectedPub = null;
    performLibSearch();
};

window.setLibScope = (scope) => {
    libSearchState.scope = scope;
    document.getElementById('scope-para').classList.toggle('active', scope === 'para');
    document.getElementById('scope-page').classList.toggle('active', scope === 'page');
    performLibSearch();
};

// 3. Debounce para Pesquisa suave
const libSearchDebounce = (func, wait) => {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
};

document.getElementById('lib-search-input').addEventListener('input', libSearchDebounce(performLibSearch, 600));


async function performLibSearch() {
    const input = document.getElementById('lib-search-input').value.trim();
    const itemsContainer = document.getElementById('lib-items-container');
    const chipsContainer = document.getElementById('lib-search-chips');
    const scopeContainer = document.getElementById('lib-scope-container');

    if (input.length < 2) {
        itemsContainer.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Introduza termos para pesquisar...</div>';
        chipsContainer.innerHTML = '';
        return;
    }

    const phrases = [];
    const phraseRegex = /"([^"]+)"/g;
    let match;
    while ((match = phraseRegex.exec(input)) !== null) { phrases.push(match[1].toLowerCase()); }
    const words = input.replace(phraseRegex, ' ').toLowerCase().split(/\s+/).filter(w => w.length > 1);
    const allTerms = phrases.concat(words);

    if (phrases.length >= 2) { scopeContainer.style.display = 'flex'; } 
    else { scopeContainer.style.display = 'none'; libSearchState.scope = 'para'; }

    itemsContainer.innerHTML = '<div style="text-align:center; padding:50px;"><div class="global-spinner" style="margin:0 auto;"></div><br><span style="color:#888;">A pesquisar em toda a biblioteca...</span></div>';

    libSearchState.allResults = [];
    
    // 1. DEFINIR O QUE PESQUISAR
    const pubsToSearch = Object.keys(SIGLAS_PUBLICACOES).map(id => {
        const isMag = SIGLAS_REVISTAS.includes(id);
        const type = isMag ? 'publicacoes' : 'books';
        return { id, type, isMag };
    }).filter(pub => {
        if (libSearchState.filter === 'books' && pub.isMag) return false;
        if (libSearchState.filter === 'publicacoes' && !pub.isMag) return false;
        return true;
    });

    for (const pub of pubsToSearch) {
        try {
            if (pub.isMag) {
                // PESQUISA EM REVISTAS (Estrutura: js/publicacoes/sentinelas/ANO/MES.json)
                // Para n√£o sobrecarregar o browser, vamos pesquisar anos recentes (ex: 2014-2024)
                // Nota: O ideal seria ter um ficheiro de √≠ndice, mas aqui vamos simular a busca nos ficheiros
                const subFolder = MAGAZINE_FOLDERS[pub.id] || 'sentinelas';
                const anosParaPesquisar = [2014, 2024]; // Podes ajustar o range ou anos espec√≠ficos

                for (let ano = anosParaPesquisar[0]; ano <= anosParaPesquisar[1]; ano++) {
                    for (let mes = 1; mes <= 12; mes++) {
                        const mesStr = mes.toString().padStart(2, '0');
                        const path = `./js/publicacoes/${subFolder}/${ano}/${mesStr}.json`;
                        
                        const response = await fetch(path);
                        if (!response.ok) continue;
                        const data = await response.json();
                        
                        // Processar artigos da revista encontrada
                        data.artigos.forEach((artigo, artIdx) => {
                            processarDadosParaBusca(artigo.conteudo, pub.id, data.titulo, artigo.titulo, artIdx, pub.type, ano, mesStr);
                        });
                    }
                }
            } else {
                // PESQUISA EM LIVROS (Estrutura simples: js/books/ID.json)
                const response = await fetch(`./js/${pub.type}/${pub.id}.json`);
                if (!response.ok) continue;
                const data = await response.json();

                data.capitulos.forEach((cap, capIdx) => {
                    processarDadosParaBusca(cap.conteudo, pub.id, data.titulo, cap.titulo, capIdx, pub.type);
                });
            }
        } catch (e) { console.warn("Erro ao ler ficheiro:", e); }
    }

    // Fun√ß√£o interna para validar termos e adicionar ao array global
    function processarDadosParaBusca(conteudo, pubId, pubTitle, capTitle, capIdx, sourceType, ano = null, mes = null) {
        conteudo.forEach(block => {
            if (!block.texto) return;
            const lowText = block.texto.toLowerCase();
            const hasPhrases = phrases.every(p => lowText.includes(p));
            const hasWords = words.every(w => lowText.includes(w));

            if (hasPhrases && hasWords) {
                libSearchState.allResults.push({
                    pubId, pubTitle, capTitle,
                    text: block.texto,
                    pNum: block.numero_ref,
                    capIdx: capIdx,
                    sourceType: sourceType,
                    ano: ano,
                    mes: mes
                });
            }
        });
    }

    renderLibResults(allTerms);
}

// O segredo est√° aqui: Guardamos o 'sourceType' em cada resultado
function addLibResult(pubId, pubTitle, capTitle, block, capIdx, sourceType) {
    libSearchState.allResults.push({
        pubId, pubTitle, capTitle,
        text: block.texto,
        pNum: block.numero_ref,
        capIdx: capIdx,
        sourceType: sourceType // 'books' ou 'publicacoes'
    });
}

// 4. Renderiza√ß√£o Final
function renderLibResults(highlightTerms) {
    const itemsContainer = document.getElementById('lib-items-container');
    const chipsContainer = document.getElementById('lib-search-chips');
    const loadMoreBtn = document.getElementById('lib-search-load-more');

    // Chips Din√¢micos
    const pubCounts = {};
    libSearchState.allResults.forEach(r => pubCounts[r.pubId] = (pubCounts[r.pubId] || 0) + 1);
    const uniquePubs = Object.keys(pubCounts);

    chipsContainer.innerHTML = '';
    // S√≥ mostra chips se houver mais de uma obra com resultados
    if (uniquePubs.length > 1) {
        uniquePubs.forEach(id => {
            const chip = document.createElement('div');
            chip.className = `lib-pub-chip ${libSearchState.selectedPub === id ? 'active' : ''}`;
            chip.innerText = SIGLAS_PUBLICACOES[id] || id.toUpperCase();
            chip.onclick = () => {
                libSearchState.selectedPub = (libSearchState.selectedPub === id) ? null : id;
                renderLibResults(highlightTerms);
            };
            chipsContainer.appendChild(chip);
        });
    }

    let filtered = libSearchState.allResults;
    if (libSearchState.selectedPub) filtered = filtered.filter(r => r.pubId === libSearchState.selectedPub);

    const toShow = filtered.slice(0, libSearchState.pageSize);
    itemsContainer.innerHTML = '';

    if (toShow.length === 0) {
        itemsContainer.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Nenhum resultado encontrado.</div>';
        loadMoreBtn.style.display = 'none';
        return;
    }

    let lastHeader = "";
    toShow.forEach(res => {
        if (libSearchState.scope === 'page') {
            const header = `${res.pubTitle} - ${res.capTitle}`;
            if (header !== lastHeader) {
                const hDiv = document.createElement('div');
                hDiv.className = 'lib-search-group-header';
                hDiv.innerText = header;
                itemsContainer.appendChild(hDiv);
                lastHeader = header;
            }
        }

        const div = document.createElement('div');
        div.className = 'lib-res-item';
        
        let highlighted = res.text;
        const sorted = [...highlightTerms].sort((a,b) => b.length - a.length);
        sorted.forEach(t => {
            const regex = new RegExp(`(${escapeRegExp(t)})`, 'gi');
            highlighted = highlighted.replace(regex, '<span class="search-term-highlight">$1</span>');
        });

        div.innerHTML = `
            <span class="lib-res-pub">${res.pubId}</span>
            <div class="lib-res-title">${res.capTitle} ${res.pNum ? '(par. '+res.pNum+')' : ''}</div>
            <div class="lib-res-text">${highlighted}</div>
        `;

    div.onclick = async () => {
    document.getElementById('search-library-modal').style.display = 'none';
    
    // USAMOS O TIPO GUARDADO NO RESULTADO
    const folder = res.sourceType; 
    
    const ok = await loadPublication(folder, res.pubId);
    if (ok) {
        // A fun√ß√£o renderReading agora recebe a pasta correta (folder)
        renderReading(res.capIdx, folder, res.pubId);
        
        setTimeout(() => {
            const target = document.getElementById(`p-${res.pNum}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
                setTimeout(() => target.style.backgroundColor = '', 2000);
            }
        }, 600);
    }
};
        itemsContainer.appendChild(div);
    });

    loadMoreBtn.style.display = filtered.length > toShow.length ? 'block' : 'none';
}

// --- IMPORTA√á√ïES ADICIONAIS ---
import { BIBLE_ABBREVIATIONS } from './js/bible-map.js'; 
import { BIBLE_DATA } from './js/bible-data.js';

// --- FUN√á√ÉO PARA TRANSFORMAR TEXTO EM LINKS CLIC√ÅVEIS ---
window.linkifyBibleReferences = function(text) {
    if (!text) return "";

    // 1. Lista de livros para detec√ß√£o
    const allBookPatterns = [...BIBLE_DATA.map(b => b.nome), ...Object.keys(BIBLE_ABBREVIATIONS)];
    const sortedPatterns = allBookPatterns.sort((a, b) => b.length - a.length);
    const patternString = sortedPatterns.map(p => p.replace(/\./g, '\\.')).join('|');

    /* 
       ESTA √â A REGEX "M√ÅGICA":
       - Procura o nome do livro
       - Procura Cap√≠tulo:Vers√≠culo
       - Continua a capturar enquanto encontrar espa√ßos, n√∫meros, v√≠rgulas, tra√ßos ou ponto e v√≠rgula
    */
    const groupRegex = new RegExp(`\\b(?:${patternString})\\.?\\s+\\d+[:.]\\d+(?:\\s*[\\-‚Äì,;]\\s*\\d*[:.]?\\d+)*`, 'gi');

    return text.replace(groupRegex, (match) => {
        // Limpeza b√°sica para evitar capturar pontua√ß√£o final do par√°grafo
        const cleanMatch = match.trim().replace(/[.,;]+$/, '');
        
        // Se houver ponto e v√≠rgula, vamos dividir e processar para garantir que o "ghost" saiba o contexto
        // mas para o utilizador, o link ser√° um bloco √∫nico e cont√≠nuo.
        return `<span class="bible-ref-ghost" data-entity-type="textobiblico" data-entity-name="${cleanMatch}">${match}</span>`;
    });
};

// --- FUN√á√ÉO PARA BUSCAR TEXTO DOS VERS√çCULOS ---
async function fetchPublicBibleText(verseName) {
    const match = verseName.match(/^(.+?)\s+(\d+):(\d+)$/);
    if (!match) return null;

    const bookName = match[1].trim();
    const chapter = match[2];
    const verse = match[3];
    
    // Normaliza√ß√£o do nome do ficheiro (ex: 1 Pedro -> 1_pedro)
    const filename = bookName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().replace(/\s+/g, "_");

    if (!window.localBibleCache) window.localBibleCache = {};

    try {
        if (!window.localBibleCache[filename]) {
            const response = await fetch(`./js/bible/${filename}.json`);
            if (!response.ok) return null;
            window.localBibleCache[filename] = await response.json();
        }
        const fileData = window.localBibleCache[filename];
        const bookData = fileData[bookName];
        return (bookData && bookData[chapter]) ? bookData[chapter][verse] : null;
    } catch (e) { return null; }
}

// --- FUN√á√ÉO PARA EXIBIR O TEXTO NO PAINEL ---
window.renderBibleTextInPanel = async function(fullReference) {
    const container = document.getElementById('side-content');
    container.innerHTML = '<div style="padding:40px;text-align:center;"><div class="global-spinner"></div></div>';

    const verseList = window.expandVerseReference(fullReference);
    
    try {
        const texts = await Promise.all(verseList.map(v => fetchPublicBibleText(v)));
        
        let finalHTML = "";
        let lastChapterContext = ""; 

        texts.forEach((text, index) => {
            if (text) {
                const currentRef = verseList[index]; 
                const match = currentRef.match(/^(.+?)\s+(\d+):(\d+)$/);
                const bookAndCap = match ? `${match[1]} ${match[2]}` : "";
                const verseNum = match ? match[3] : "";

                if (bookAndCap !== lastChapterContext) {
                    finalHTML += `
                        <div style="margin: 15px 0 8px 0; padding-bottom: 3px; border-bottom: 1px solid #333; color: var(--accent-color); font-weight: 700; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">
                            ${bookAndCap}
                        </div>`;
                    lastChapterContext = bookAndCap;
                }

                finalHTML += `
                    <div style="margin-bottom: 8px; line-height: 1.5; display: flex; align-items: flex-start;">
                        <span style="color: var(--accent-color); font-weight: bold; font-size: 0.75em; min-width: 25px; margin-right: 12px; text-align: right; margin-top: 2px; user-select: none; opacity: 0.8;">
                            ${verseNum}
                        </span>
                        <span style="color: #ccc; font-size: 0.9em; flex: 1; user-select: text;">${text}</span>
                    </div>`;
            }
        });

        if (finalHTML === "") {
            container.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.6; font-size:0.85em;">Texto n√£o encontrado.</div>`;
        } else {
            container.innerHTML = `<div id="ref-content-bibletext" style="padding: 0 5px;">${finalHTML}</div>`;
            container.scrollTop = 0;
        }

    } catch (e) {
        console.error("Erro ao carregar B√≠blia:", e);
        container.innerHTML = '<p style="padding:20px; color:red; font-size:0.8rem;">Erro de conex√£o.</p>';
    }
};

// Reutilize a fun√ß√£o de expans√£o de vers√≠culos do book.html
window.expandVerseReference = function(fullRef) {
    let cleanRef = fullRef.replace(/[()]/g, '').replace(/‚Äì/g, '-').trim();
    
    const allBooks = [...BIBLE_DATA.map(b => b.nome), ...Object.keys(BIBLE_ABBREVIATIONS)]
        .sort((a, b) => b.length - a.length);
    const bookPattern = allBooks.map(b => b.replace(/\./g, '\\.')).join('|');
    const bookRegex = new RegExp(`^(${bookPattern})\\.?\\s*`, 'i');

    const parts = cleanRef.split(';');
    let expandedList = [];
    let currentBook = "";
    let currentChapter = "";

    parts.forEach(part => {
        let p = part.trim();
        if (!p) return;

        const bookMatch = p.match(bookRegex);
        if (bookMatch) {
            let rawPrefix = bookMatch[1].trim();
            currentBook = BIBLE_ABBREVIATIONS[rawPrefix] || rawPrefix;
            p = p.replace(bookMatch[0], '').trim();
        }

        if (!currentBook) return;

        if (p.includes(':')) {
            const [cap, verses] = p.split(':');
            currentChapter = cap.trim();
            
            const verseChunks = verses.split(',');
            verseChunks.forEach(chunk => {
                const c = chunk.trim();
                if (c.includes('-')) {
                    const [start, end] = c.split('-').map(Number);
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let v = start; v <= end; v++) {
                            expandedList.push(`${currentBook} ${currentChapter}:${v}`);
                        }
                    }
                } else if (c) {
                    expandedList.push(`${currentBook} ${currentChapter}:${c}`);
                }
            });
        }
    });

    return expandedList;
};



// Capturar cliques em links b√≠blicos e abrir o painel
document.addEventListener('click', async (e) => {
    const bibleLink = e.target.closest('.bible-ref-ghost');
    if (bibleLink) {
        e.preventDefault();
        e.stopPropagation();

        const refName = bibleLink.dataset.entityName;
        const panel = document.getElementById('side-panel');
        const tabs = document.getElementById('library-ref-tabs');
        const bibleTabBtn = document.getElementById('tab-bible-btn');

        // Abrir painel
        panel.classList.add('open');
        tabs.style.display = 'flex';
        bibleTabBtn.style.display = 'inline-block';
        
        // Ativar aba da B√≠blia
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        bibleTabBtn.classList.add('active');

        // Carregar texto
        window.renderBibleTextInPanel(refName);
    }
});

// Detetar clique em refer√™ncias b√≠blicas dentro do texto
document.addEventListener('click', (e) => {
    const bibleLink = e.target.closest('.bible-ref-ghost');
    if (bibleLink) {
        e.preventDefault();
        e.stopPropagation();

        const content = document.getElementById('side-content');
        
        // Se estivermos a ler um artigo, tiramos a "foto" da posi√ß√£o AGORA
        if (content.dataset.currentTab === 'enxertos') {
            window.enxertoScrollPos = content.scrollTop;
            console.log(`%c[CLIQUE ‚ö°] Captura imediata no link: ${window.enxertoScrollPos}px`, "color: #3498db; font-weight:bold;");
        }

        const refName = bibleLink.dataset.entityName; 
        const panel = document.getElementById('side-panel');
        const bibleTabBtn = document.getElementById('tab-bible-btn');
        const tabs = document.getElementById('library-ref-tabs');

        panel.dataset.currentRef = refName;
        panel.classList.add('open');
        tabs.style.display = 'flex';
        bibleTabBtn.style.display = 'inline-block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        bibleTabBtn.classList.add('active');

        // Renderiza a B√≠blia chamando a fun√ß√£o principal
        window.renderLibraryRefTab('bibletext');
    }
});

function updateLibraryURL(params = {}) {
    const url = new URL(window.location);
    const keys = ['sec', 'pub', 'year', 'month', 'cap'];
    keys.forEach(k => url.searchParams.delete(k));
    Object.entries(params).forEach(([key, value]) => {
        if (value) url.searchParams.set(key, value);
    });
    window.history.pushState({}, '', url);
}

// Faz o bot√£o "Retroceder" do navegador funcionar
window.onpopstate = () => window.location.reload();

// Fun√ß√£o para disparar o X-Ray do par√°grafo
window.runParaXRay = async (pNum) => {
    const paragraphEl = document.getElementById(`p-${pNum}`);
    if (!paragraphEl) return;

    console.log(`%c[X-RAY SCANNER] üïµÔ∏è Analisando par√°grafo ${pNum}...`, "background: #222; color: #3498db; padding: 5px; font-weight: bold;");

    // 1. Setup UI
    const xrayTabBtn = document.getElementById('tab-xray-btn');
    xrayTabBtn.style.display = 'inline-block'; 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    xrayTabBtn.classList.add('active', 'tab-blinking');
    
    const content = document.getElementById('side-content');
    content.innerHTML = XRAY_LOADER_HTML;

    // 2. Extra√ß√£o
    const text = paragraphEl.innerText;
    // Regex para capturar refer√™ncias
    const bibleRegex = /\b((?:[123]\s)?[A-Z][a-z√ß√°√©√≠√≥√∫]+\.?\s+\d+[:.]\d+(?:\s*[-‚Äì,;]\s*\d+[:.-]?\d*)*)/g;
    const originalVerses = text.match(bibleRegex) || [];
    
    console.log(`%c[PASSO 1] Refer√™ncias encontradas no texto:`, "color: #888;", originalVerses);

    // 3. Expans√£o (Deep Search)
    let allSearchTerms = [];
    originalVerses.forEach(v => {
        // Remove par√™nteses e limpa a string
        const cleanV = v.replace(/[()]/g, '').trim();
        const expanded = expandBibleRange(cleanV);
        allSearchTerms = [...allSearchTerms, ...expanded];
    });

    // Remove duplicados
    currentXrayVersesList = Array.from(new Set(allSearchTerms));
    console.log(`%c[PASSO 3] Lista FINAL de termos para pesquisa:`, "color: #2ecc71; font-weight: bold;", currentXrayVersesList);
    
    activeXrayVerseFilters = new Set(currentXrayVersesList);

    // 4. Pesquisa Real
    const results = await deepSearchInLibrary(currentXrayVersesList, pNum);
    
    currentXrayData = results; 
    xrayTabBtn.classList.remove('tab-blinking');
    window.renderXrayResults(results, currentXrayVersesList);
};


async function deepSearchInLibrary(searchTerms, sourcePNum) {
    let matches = [];
    const startYear = 1950;
    const agora = new Date();
    const anoAtual = agora.getFullYear();
    const mesAtual = agora.getMonth() + 1;

    // Marcamos o tempo de in√≠cio para ver a performance
    const startTime = performance.now();
    const cacheInicial = Object.keys(libraryDataCache).length;

    console.log(`%c[X-RAY üìü] Pesquisa Iniciada para: ${searchTerms.join(", ")}`, "background: #222; color: #3498db; padding: 5px; border-radius: 4px;");

    // --- PARTE A: LIVROS ---
const livrosSiglas = Object.keys(SIGLAS_PUBLICACOES).filter(s => !['w', 'g', 'wp', 'km', 'mwb'].includes(s));
for (const sigla of livrosSiglas) {
    const data = await fetchWithCache(`./js/books/${sigla}.json`);
    if (data && data.capitulos) {
        // O √∫ltimo argumento define a pasta como 'books'
        scanContentXRay(data.capitulos, data.titulo, sigla, matches, searchTerms, sourcePNum, 'books');
    }
}

    // --- PARTE B: REVISTAS ---
    const revistas = [{ id: 'w', folder: 'sentinelas' }, { id: 'g', folder: 'despertai' }];
    for (let ano = startYear; ano <= anoAtual; ano++) {
        for (const rev of revistas) {
            const limiteMes = (ano === anoAtual) ? mesAtual : 12;
            const monthPromises = [];
            for (let mes = 1; mes <= limiteMes; mes++) {
                monthPromises.push(fetchWithCache(`./js/publicacoes/${rev.folder}/${ano}/${mes.toString().padStart(2, '0')}.json`));
            }
            const monthsData = await Promise.all(monthPromises);
            monthsData.forEach((data, idx) => {
                if (data && data.artigos) {
                    const siglaRes = `${rev.id.toUpperCase()}${ano.toString().slice(-2)}_${(idx+1).toString().padStart(2, '0')}`;
                    scanContentXRay(data.artigos, data.titulo, siglaRes, matches, searchTerms, sourcePNum, 'publicacoes', ano, (idx+1).toString().padStart(2, '0'));
                }
            });
        }
    }

    const endTime = performance.now();
    const cacheFinal = Object.keys(libraryDataCache).length;
    const novosFicheiros = cacheFinal - cacheInicial;
    
    return matches;
}



function scanContentXRay(secoes, pubTitle, sigla, matches, terms, sourcePNum, folder, ano, mes) {
    if (!secoes || !Array.isArray(secoes)) return;

    secoes.forEach((sec, sIdx) => {
        if (!sec) return;

        // 1. Impede que o X-Ray encontre o pr√≥prio cap√≠tulo/artigo de onde a pesquisa partiu
        if (sigla === currentPubId && sIdx === currentChapterIdx) return;

        // Captura metadados da sec√ß√£o
        const artRef = sec.referencia || (sec.capitulo ? `Cap. ${sec.capitulo}` : "");
        const artTitle = sec.titulo || "Sem T√≠tulo";

        if (sec.conteudo && Array.isArray(sec.conteudo)) {
            sec.conteudo.forEach(block => {
                if (!block || !block.texto) return;
                
                // 2. Pesquisa cada termo (vers√≠culo) dentro do texto do bloco
                terms.forEach(t => {
                    // --- CORRE√á√ÉO DE PRECIS√ÉO ---
                    // Escapamos o termo para evitar erros com caracteres especiais (ex: ".")
                    const escapedTerm = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    
                    // Criamos uma Regex com "Negative Lookahead" (?!\d)
                    // Isto garante que se pesquisarmos "Atos 8:1", ele N√ÉO valide "Atos 8:12"
                    // porque verifica que ap√≥s o "1" n√£o existe outro d√≠gito num√©rico.
                    const regex = new RegExp(escapedTerm + "(?!\\d)", "i");

                    if (regex.test(block.texto)) {
                        matches.push({
                            pubTitle: pubTitle, 
                            capTitle: artTitle, 
                            artRef: artRef,     
                            text: block.texto, 
                            sigla: sigla, 
                            capIdx: sIdx,
                            pNum: block.numero_ref,
                            folder: folder, 
                            refFound: t, // O vers√≠culo exato que gerou a correspond√™ncia
                            ano: ano, 
                            mes: mes
                        });
                    }
                });
            });
        }
    });
}

function scanContent(secoes, pubTitle, sigla, matches, verses, sourcePNum, folder, ano=null, mes=null) {
    secoes.forEach((sec, sIdx) => {
        const artRef = sec.referencia || ""; 
        sec.conteudo.forEach((block, bIdx) => {
            if (!block.texto) return;
            if (sigla === currentPubId && block.numero_ref === sourcePNum) return;

            verses.forEach(v => {
                if (block.texto.includes(v)) {
                    matches.push({
                        pubTitle: pubTitle,
                        capTitle: sec.titulo,
                        artRef: artRef,
                        text: block.texto,
                        sigla: sigla,
                        capIdx: sIdx,
                        pNum: block.numero_ref, // <--- ADICIONA ESTA LINHA AQUI
                        folder: folder,
                        refFound: v,
                        ano, mes
                    });
                }
            });
        });
    });
}

window.renderXrayResults = (results, verses) => {
    const content = document.getElementById('side-content');
    if (!content) return;

    content.classList.add('xray-active');

    const getFilteredContentHTML = (type) => {
        // Filtra os resultados pelo tipo (books ou publicacoes) e pelos vers√≠culos ativos
        let filtered = results.filter(r => 
            r.folder === type && 
            activeXrayVerseFilters.has(r.refFound)
        );

        // Ordena√ß√£o especial apenas para revistas (por data decrescente)
        if (type === 'publicacoes') {
            filtered.sort((a, b) => {
                if (parseInt(b.ano) !== parseInt(a.ano)) return parseInt(b.ano) - parseInt(a.ano);
                return parseInt(b.mes) - parseInt(a.mes);
            });
        }

        if (filtered.length === 0) {
            return `<div class="xray-empty-msg">Nenhum resultado em ${type === 'books' ? 'Livros' : 'Publica√ß√µes'}.</div>`;
        }

     return filtered.map(res => {
    const escapedTerm = res.refFound.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedTerm})(?!\\d)`, 'gi');
    const highlightedSnippet = (res.text || "").replace(regex, '<strong style="color:#fff; border-bottom:1px solid #3498db;">$1</strong>');

    // FORMATA√á√ÉO SOLICITADA: "Refer√™ncia ‚Äî T√≠tulo" em it√°lico
    const infoLinha = `${res.artRef} ‚Äî ${res.capTitle}`;

    return `
    <div class="xray-res-card" 
         style="margin: 12px 15px; background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; border-left:4px solid #3498db; cursor:pointer;"
         onclick='window.openSegmentoInSidebar(${JSON.stringify(res).replace(/'/g, "&apos;")})'>
        
        <div style="font-size:0.75rem; color:#3498db; font-weight:800; text-transform:uppercase; margin-bottom:2px;">
            ${res.refFound}
        </div>

        <!-- LINHA CORRIGIDA: It√°lico e sem undefined -->
        <div style="font-size:0.75rem; color:#888; margin-bottom:12px; font-style: italic; line-height:1.3;">
            ${infoLinha}
        </div>

        <div style="font-size:0.92rem; color:#cecece; line-height:1.6;">
            ${highlightedSnippet}
        </div>
    </div>`;
}).join('');
    };

    // Renderiza√ß√£o do HTML (Abas + Panes)
    content.innerHTML = `
      <div style="background:#000; position:sticky; top:0; z-index:100; border-bottom:1px solid #222;">
        <div class="xray-sub-tabs-annex">
            <div class="xray-sub-group">
                <button class="xray-sub-btn ${window.currentXrayTab !== 'publicacoes' ? 'active' : ''}" 
                        onclick="window.switchXraySubTab(this, 'xray-books')">Livros</button>
                <button class="xray-sub-btn ${window.currentXrayTab === 'publicacoes' ? 'active' : ''}" 
                        onclick="window.switchXraySubTab(this, 'xray-pubs')">Publica√ß√µes</button>
            </div>
        </div>
        
        <!-- BARRA COM SETAS -->
        <div class="filter-nav-container">
            <button class="nav-arrow-xray" onclick="window.scrollXrayBar(-1)">‚ùÆ</button>
            <div id="xray-bar">
                ${verses.map(v => `
                    <div class="verse-chip ${activeXrayVerseFilters.has(v) ? 'active' : 'inactive'}" 
                         onclick="window.toggleXrayVerse('${v}')">${v}</div>
                `).join('')}
            </div>
            <button class="nav-arrow-xray" onclick="window.scrollXrayBar(1)">‚ùØ</button>
        </div>
    </div>
    
    <div id="xray-books" class="xray-pane" style="display:${window.currentXrayTab !== 'publicacoes' ? 'block' : 'none'};">
        ${getFilteredContentHTML('books')}
    </div>
    <div id="xray-pubs" class="xray-pane" style="display:${window.currentXrayTab === 'publicacoes' ? 'block' : 'none'};">
        ${getFilteredContentHTML('publicacoes')}
    </div>
    `;
    cacheXrayHTML = content.innerHTML;
};

  

   
   
window.scrollXrayBar = (direction) => {
    const bar = document.getElementById('xray-bar');
    if (bar) {
        // Move 150px para a esquerda ou direita
        const scrollAmount = 150;
        bar.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
    }
};


window.filterXrayByVerse = (verse) => {
    activeXrayVerseFilter = verse;
    // Extrai os vers√≠culos √∫nicos dos dados atuais para reconstruir os chips
    const uniqueVerses = Array.from(new Set(currentXrayData.map(r => r.refFound)));
    window.renderXrayResults(currentXrayData, uniqueVerses);
};


// Garante que a fun√ß√£o √© global para ser chamada pelo onclick
window.currentXrayTab = 'books'; // Global no topo do script

window.switchXraySubTab = (btn, paneId) => {
    document.querySelectorAll('.xray-sub-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.xray-pane').forEach(p => p.style.display = 'none');
    document.getElementById(paneId).style.display = 'block';
    
    window.currentXrayTab = (paneId === 'xray-pubs') ? 'publicacoes' : 'books';
};

window.toggleXrayVerse = (verse) => {
    if (activeXrayVerseFilters.has(verse)) {
        activeXrayVerseFilters.delete(verse);
    } else {
        activeXrayVerseFilters.add(verse);
    }
    // Ao re-renderizar, a renderXrayResults vai atualizar o cacheXrayHTML automaticamente
    window.renderXrayResults(currentXrayData, currentXrayVersesList);
};

window.switchXraySubTab = (btn, paneId) => {
    // Atualiza a vari√°vel global de estado da sub-aba
    window.currentXrayTab = (paneId === 'xray-pubs') ? 'publicacoes' : 'books';
    // Re-renderiza para aplicar a mudan√ßa e salvar no cache
    window.renderXrayResults(currentXrayData, currentXrayVersesList);
};


// 1. Vari√°vel de estado para as defini√ß√µes
let userSettings = {
    xrayDeepSearch: true
};

// 2. Fun√ß√£o para abrir o modal
document.getElementById('settings-btn').onclick = () => {
    document.getElementById('settings-modal').style.display = 'flex';
};

// 3. Monitorizar a mudan√ßa no toggle
document.getElementById('xray-deep-search').onchange = (e) => {
    userSettings.xrayDeepSearch = e.target.checked;
};

// 4. FUN√á√ÉO M√ÅGICA: Expandir Refer√™ncias (Ex: Romanos 7:21-24 -> individual)
function expandBibleRange(ref) {
    // 1. Limpeza inicial (remove par√™nteses e pontua√ß√£o final)
    let cleanRef = ref.replace(/[()]/g, '').replace(/[.,;]+$/, '').trim();
    let finalTerms = [];

    // Se o Deep Search estiver desligado, devolve apenas a refer√™ncia original
    if (!userSettings.xrayDeepSearch) return [cleanRef];

    // 2. Dividir por Ponto e V√≠rgula para tratar grupos
    // Ex: "Atos 8:3; 26:9-11" -> ["Atos 8:3", "26:9-11"]
    const groups = cleanRef.split(';').map(g => g.trim());
    let lastBook = "";

    groups.forEach(group => {
        // Detectar o livro
        const bookMatch = group.match(/^((?:[123]\s)?[A-Z][a-z√ß√°√©√≠√≥√∫]+\.?)\s/i);
        let currentRef = group;

        if (bookMatch) {
            lastBook = bookMatch[1].trim();
        } else if (lastBook) {
            // Reconstr√≥i a refer√™ncia se faltar o livro (ex: "26:9-11" -> "Atos 26:9-11")
            currentRef = `${lastBook} ${group}`;
        }

        // --- ADI√á√ÉO CRUCIAL ---
        // Adicionamos sempre a refer√™ncia do grupo (seja ela simples ou um intervalo)
        // Ex: Adiciona "Atos 8:3" e tamb√©m adiciona "Atos 26:9-11"
        finalTerms.push(currentRef);

        // 3. Se for um intervalo, expandimos os vers√≠culos individuais
        const rangeMatch = currentRef.match(/^(.+?)\s+(\d+)[:.](\d+)[-‚Äì](\d+)$/);

        if (rangeMatch) {
            const [_, livro, cap, inicio, fim] = rangeMatch;
            const start = parseInt(inicio);
            const end = parseInt(fim);

            if (end > start && (end - start) < 50) {
                // Adiciona cada vers√≠culo do intervalo √† lista
                for (let i = start; i <= end; i++) {
                    finalTerms.push(`${livro} ${cap}:${i}`);
                }
            }
        }
    });

    // Remover duplicados (caso a expans√£o gere algo que j√° existia)
    return Array.from(new Set(finalTerms));
}


window.openSegmentoInSidebar = async (res) => {
    const content = document.getElementById('side-content');
    const enxertoBtn = document.getElementById('tab-enxertos-btn');
    
    // 1. GEST√ÉO DE UI E ESTADO
    // Resetamos a posi√ß√£o do scroll global pois estamos a carregar um NOVO documento
    window.enxertoScrollPos = 0;

    // Ativar a aba de Enxertos (‚ùõ‚ùõ‚ùû) no cabe√ßalho do painel
    if (enxertoBtn) {
        enxertoBtn.style.display = 'inline-block';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        enxertoBtn.classList.add('active');
    }
    
    // Configurar o container para modo X-Ray (fundo preto e tipografia)
    content.dataset.currentTab = 'enxertos';
    content.classList.add('xray-active');
    
    // Mostrar loading enquanto processa o JSON
    content.innerHTML = `<div style="padding:50px; text-align:center;"><div class="global-spinner"></div></div>`;

    try {
        // 2. DETERMINAR O CAMINHO DO FICHEIRO (Pasta 'books' ou 'publicacoes')
        let path = "";
        if (res.folder === 'publicacoes') {
            const sigla = res.sigla.substring(0, 1).toLowerCase(); 
            const subFolder = MAGAZINE_FOLDERS[sigla] || 'sentinelas';
            path = `./js/publicacoes/${subFolder}/${res.ano}/${res.mes}.json`;
        } else {
            path = `./js/books/${res.sigla}.json`;
        }

        // 3. CARREGAMENTO DOS DADOS
        const response = await fetch(path);
        if (!response.ok) throw new Error("Ficheiro n√£o encontrado.");
        const data = await response.json();
        
        // Suporte para ambas as estruturas: 'artigos' (revistas) ou 'capitulos' (livros)
        const lista = data.artigos || data.capitulos;
        const artigo = lista[res.capIdx];

        if (!artigo) throw new Error("Segmento inv√°lido.");

        // 4. CONSTRU√á√ÉO DO HTML DO ARTIGO
        let html = `
            <!-- Cabe√ßalho Fixo do Enxerto -->
            <div style="padding:15px; background:#1a1a1d; border-bottom:1px solid #333; position:sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:var(--accent-color); font-weight:bold; font-size:0.7rem; letter-spacing:1px;">ENXERTO SELECIONADO</span>
                <button onclick="window.loadPublication('${res.folder}', '${res.sigla}').then(() => window.renderReading(${res.capIdx}, '${res.folder}', '${res.sigla}'))" 
                        style="background:var(--accent-color); color:white; border:none; padding:6px 14px; border-radius:20px; font-size:0.7rem; cursor:pointer; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    ABRIR TELA CHEIA
                </button>
            </div>

            <div style="padding:20px; font-size:1rem; line-height:1.7; color:#ccc;">
                <h2 style="color:#eee; font-size:1.4rem; margin-bottom:25px; line-height:1.2;">${artigo.titulo}</h2>
        `;

        // Renderizar cada bloco de texto do artigo
        artigo.conteudo.forEach(block => {
            const pNum = block.numero_ref;
            const isTarget = String(pNum) === String(res.pNum);
            const blockId = pNum ? `id="enxerto-p-${pNum}"` : '';
            
            // Destaque visual apenas no par√°grafo que continha a refer√™ncia encontrada
            const highlightStyle = isTarget 
                ? 'background:rgba(52, 152, 219, 0.12); border-left:4px solid #3498db; padding:15px; border-radius:4px; margin-left:-15px; margin-right:-15px;' 
                : 'padding:12px 0;';

            // Linkar textos b√≠blicos automaticamente (Ghost links)
            const textoFinal = window.linkifyBibleReferences(block.texto || "");

            html += `
                <div ${blockId} class="enxerto-block" style="margin-bottom:10px; ${highlightStyle}">
                    ${pNum ? `<b style="color:#555; font-size:0.75rem; margin-right:12px; font-family:monospace;">${pNum}</b>` : ''}
                    ${textoFinal}
                </div>`;
        });

        // Adicionar espa√ßo no fim para permitir que o √∫ltimo par√°grafo suba no scroll
        html += `</div><div style="height:200px;"></div>`;
        
        // 5. INJETAR E SALVAR CACHE
        content.innerHTML = html;
        cacheSegmentoHTML = html; // Important√≠ssimo para a persist√™ncia entre abas

        // 6. SCROLL AUTOM√ÅTICO PARA O ALVO
       setTimeout(() => {
            const targetId = `enxerto-p-${res.pNum}`;
            const targetEl = document.getElementById(targetId);
            
            // S√ì faz o scroll autom√°tico se a posi√ß√£o guardada for 0 
            // (ou seja, se acab√°mos de abrir o artigo agora)
            if (targetEl && content && (!window.enxertoScrollPos || window.enxertoScrollPos === 0)) {
                const header = content.querySelector('div[style*="position:sticky"]');
                const headerHeight = header ? header.offsetHeight : 60;
                content.scrollTo({
                    top: targetEl.offsetTop - headerHeight - 10,
                    behavior: 'smooth'
                });
                // Atualiza a mem√≥ria ap√≥s o scroll autom√°tico
                setTimeout(() => { window.enxertoScrollPos = content.scrollTop; }, 600);
            }
        }, 500);

    } catch (e) {
        console.error("[X-RAY ERROR]", e);
        content.innerHTML = `<div style="padding:40px; text-align:center; color:#666;">Erro ao carregar segmento.<br><small>${e.message}</small></div>`;
    }
};


async function fetchWithCache(path) {
    // Se o ficheiro j√° est√° no objeto global libraryDataCache
    if (libraryDataCache[path]) {
        return libraryDataCache[path];
    }

    // Se n√£o est√°, vamos descarregar
    try {
        const response = await fetch(path);
        
        if (!response.ok) {
            // Se o arquivo n√£o existir (404), n√£o guardamos nada
            return null;
        }
        
        const data = await response.json();
        libraryDataCache[path] = data; // Guarda no Cache Global
        return data;
    } catch (e) {
        return null;
    }
}



function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }


// Adicione isto dentro do <script type="module">
window.openNoteFromBoard = (noteId) => {
    if (!noteId) return;
    // Redireciona para a p√°gina note.html com o ID da nota
    window.location.href = `note.html?id=${noteId}`;
};


// Fun√ß√µes de T√≥picos e Links (Simplificadas para o exemplo, mantendo as chamadas nos modais)
window.openTopicsModal = () => { document.getElementById('flash-topics-modal').style.display = 'flex'; };
window.openFlashLinkManager = () => { document.getElementById('flash-links-modal').style.display = 'flex'; };
window.closeSidePanel = () => { document.getElementById('side-panel').classList.remove('open'); };
window.showRoot = showRoot;
window.showList = showList;
window.showYears = showYears;
window.showMonths = showMonths;
window.showArticles = showArticles;
window.showChapters = showChapters;
window.loadPublication = loadPublication;
window.changeChapter = changeChapter;
window.toggleChapterNav = toggleChapterNav;
window.renderReading = renderReading;


</script>
</body>
</html>
