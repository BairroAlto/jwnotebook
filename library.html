<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca - NotaBook</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczPH9OhQSJZR7u-h_UGu-_iJzdj7gWv6TYb5aUWISpPJ9ytdkeqRo1cr-VwNnKLThljiM_iv3KlSU9qfj7icHOhGI8Ehaq6Z2VX9rJC8B1Xqmk7Lthcq8y8V9w37yZ7G-ayEhKUnO4aW4gSEk7Fv1HiQ=w582-h461-s-no-gm?authuser=4">

<style>
   :root {
        --bg-color: #000000;
        --tile-color: #252528;
        --text-color: #ffffff;
        --accent-color: #3498db;
        --border-color: #333;
        --text-size-pct: 100%; 
        --panel-color: #1f1f22;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        height: 45px;
        flex-shrink: 0;
        z-index: 100;
    }

    #back-btn { background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; margin-right: 15px; }
    #page-title { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; flex-grow: 1; text-align: center; }

    #main-layout { flex: 1; overflow: hidden; position: relative; display: flex; }
    
    /* Contentor de Leitura */
    .container { 
        flex: 1; 
        overflow-y: auto; 
        padding: 15px; 
        transition: width 0.3s ease;
    }
    
    .section-title { font-size: 0.75rem; font-weight: 800; color: #888; margin: 20px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; }

    /* --- GRELHA --- */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding-bottom: 40px; }
    
    .pub-card {
        background-color: var(--tile-color);
        border: 1px solid #333;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        aspect-ratio: 2/2.5;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; padding: 15px; border-top: 4px solid var(--accent-color);
    }
    .pub-card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
    .pub-card.type-pub { border-top-color: #9b59b6; }
    .pub-title { font-size: 0.9rem; font-weight: bold; color: #e0e0e0; line-height: 1.3; }

    /* --- CAP√çTULOS --- */
    .chapter-list { display: flex; flex-direction: column; gap: 8px; }
    .chapter-item {
        background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #333;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .chapter-item:hover { border-color: var(--accent-color); }
    .chapter-item b { color: var(--accent-color); margin-right: 10px; }

    /* --- LEITOR & TEXTO --- */
    .reader-content {
        max-width: 800px; margin: 0 auto; font-size: var(--text-size-pct); line-height: 1.7;
        /* Permitir sele√ß√£o */
        user-select: text !important; -webkit-user-select: text !important;
    }
    
    /* Blocos de texto */
    .block-paragrafo, .block-pergunta, .block-subtema, .block-rodape {
        position: relative;
        user-select: text !important; -webkit-user-select: text !important;
    }

    .block-subtema { color: var(--accent-color); font-size: 1.4em; font-weight: bold; margin: 30px 0 15px 0; }
    .block-pergunta { color: #e67e22; font-weight: bold; background: rgba(230, 126, 34, 0.05); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .block-paragrafo { margin-bottom: 15px; text-align: justify; color: #ccc; }
    .block-rodape { color: #888; font-size: 0.85em; opacity: 0.6; font-style: italic; margin-top: 10px; padding: 5px 10px; border-left: 1px solid #444; text-align: left; }

    /* N√∫mero do Par√°grafo */
    .ref-num {
        display: inline-block; color: #666; font-size: 0.75em; font-weight: 800;
        margin-right: 8px; border: 1px solid #333; padding: 0 4px; border-radius: 3px;
        cursor: default; user-select: none; /* N√£o seleciona o n√∫mero */
    }
    
    /* N√∫mero com dados associados */
    .ref-num.has-data {
        color: var(--accent-color); border-color: var(--accent-color);
        background: rgba(52, 152, 219, 0.1); cursor: pointer;
    }

    /* --- DESTAQUES (Picotado) --- */
    .highlight-picotado {
        background-image: linear-gradient(to right, var(--accent-color) 50%, transparent 50%);
        background-position: bottom; background-size: 6px 3px; background-repeat: repeat-x;
        padding-bottom: 2px; text-decoration: none !important;
        cursor: pointer; position: relative; z-index: 1;
    }
    
    /* --- BARRA FLUTUANTE DE SELE√á√ÉO --- */
    #selection-toolbar {
        position: absolute; z-index: 9999; background-color: #252528; border: 1px solid #444;
        border-radius: 8px; padding: 5px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        gap: 10px; align-items: center;
    }
    #selection-toolbar button {
        background: #333; border: none; color: #fff; padding: 6px 12px; border-radius: 4px;
        cursor: pointer; font-size: 0.9rem;
    }
    #selection-toolbar button:hover { background: var(--accent-color); }

    @media (max-width: 768px) {
        #selection-toolbar {
            position: fixed !important; top: auto !important; bottom: 20px !important;
            left: 50% !important; transform: translateX(-50%) !important; width: 90%; justify-content: center;
        }
    }

    /* --- PAINEL LATERAL (4¬™ COLUNA) --- */
    #side-panel {
        width: 0; background-color: #1f1f22; border-left: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        transition: width 0.3s ease; flex-shrink: 0; z-index: 1000;
        position: relative;
    }
    #side-panel.open { width: 400px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
    
    @media (max-width: 768px) {
        #side-panel {
            position: fixed; bottom: 0; left: 0; right: 0; top: auto;
            width: 100vw !important; height: 0; border-radius: 20px 20px 0 0;
            transition: height 0.3s ease;
        }
        #side-panel.open { height: 75vh; width: 100vw !important; }
    }

    .side-header {
        padding: 10px 15px; border-bottom: 1px solid #333; display: flex;
        justify-content: space-between; align-items: center; background: #252528;
    }
    .side-content { flex: 1; overflow-y: auto; padding: 15px; }

    /* Card no Painel */
    .detail-card {
        background: rgba(255,255,255,0.03); border: 1px solid #333;
        border-radius: 4px; padding: 12px; margin-bottom: 10px;
        font-size: 0.95rem; line-height: 1.5; color: #ddd;
    }

    /* --- MODAL NOTA FLASH --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 11000; display: none;
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 500px; border-radius: 8px;
        border: 1px solid #333; padding: 15px; display: flex; flex-direction: column;
    }
    .flash-editor {
        min-height: 100px; background: rgba(0,0,0,0.2); border: 1px solid #333;
        padding: 10px; color: #fff; margin-bottom: 10px; white-space: pre-wrap;
    }
    
    /* Seletor de Cores */
    .color-picker-container { display: flex; gap: 8px; margin-bottom: 15px; }
    .color-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-btn.selected { border-color: white; transform: scale(1.1); }

    /* Loader */
    #global-auth-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; justify-content: center; align-items: center; }
    .global-spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* --- ESTILOS DA TOOLBAR FLASH (Igual √† B√≠blia) --- */
.flash-toolbar {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
}

.flash-toolbar button {
    background: #333;
    border: 1px solid #444;
    color: #ccc;
    width: 32px;
    height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.flash-toolbar button:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Dropdown √† direita */
#flash-type-select {
    margin-left: auto; /* Empurra para a direita */
    background: #252528;
    color: #fff;
    border: 1px solid #444;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    outline: none;
    cursor: pointer;
}

/* Bolas de Cor */
.color-picker-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    padding: 5px;
    overflow-x: auto;
}

.color-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-btn:hover { transform: scale(1.1); }
.color-btn.selected { border-color: white; transform: scale(1.2); }

/* --- ESTILOS DO MODAL DE LINKS & CODEX --- */
.codex-row {
    background: #252528;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
    border-left: 3px solid var(--accent-color);
}

.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.serie-wrapper {
    flex: 1;
}

.codex-label {
    display: block;
    font-size: 0.7rem;
    font-weight: bold;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.codex-input-modern {
    width: 100%;
    background: #151515;
    border: 1px solid #444;
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    outline: none;
}
.codex-input-modern:focus { border-color: var(--accent-color); }

.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
}

.pages-container, .paragraphs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    min-height: 30px;
}

/* Chips (P√≠lulas) de n√∫meros */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: #333;
    border: 1px solid #555;
    border-radius: 15px;
    padding: 2px 8px;
    font-size: 0.85rem;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: white;
    width: 35px;
    text-align: center;
    outline: none;
    font-family: monospace;
}

.btn-unit-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-weight: bold;
    margin-left: 2px;
    padding: 0 4px;
}

/* Bot√£o Redondo (+) */
.btn-unit-add {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px dashed #666;
    color: #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-unit-add:hover {
    background: var(--accent-color);
    color: white;
    border-style: solid;
}

.remove-codex-row {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
}
.remove-codex-row:hover { opacity: 1; }

/* Contexto da Refer√™ncia */
#flash-links-context {
    background: rgba(52, 152, 219, 0.1);
    border-left: 4px solid #3498db;
    padding: 8px 12px;
    margin-bottom: 15px;
    color: #ddd;
    font-size: 0.9rem;
    border-radius: 0 4px 4px 0;
}

</style>


</head>
<body>

    <div id="global-auth-shield">
        <div class="global-spinner"></div>
    </div>

    <header>
        <button id="back-btn">‚¨Ö</button>
        <div id="page-title">Biblioteca</div>
        <div style="width: 30px;"></div>
    </header>

    <div id="main-layout">
        <!-- √ÅREA PRINCIPAL -->
        <div class="container" id="content-container">
            <!-- Vistas Din√¢micas (Grid Livros, Cap√≠tulos, Texto) -->
        </div>

        <!-- PAINEL LATERAL (NOTAS) -->
        <aside id="side-panel">
            <div class="side-header">
                <span id="side-title" style="color: var(--accent-color); font-weight: bold;">Notas</span>
                <button onclick="window.closeSidePanel()" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">√ó</button>
            </div>
            <div class="side-content" id="side-content">
                <!-- Notas injetadas aqui -->
            </div>
        </aside>
    </div>

    <!-- BARRA DE SELE√á√ÉO FLUTUANTE -->
    <div id="selection-toolbar">
        <button id="btn-copy">üìë Copiar</button>
        <button id="btn-flash-note">‚úç Nota Flash</button>
    </div>

    <!-- MODAL DE CRIA√á√ÉO DE NOTA -->
   <div id="flash-note-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 550px;">
        
        <!-- Cabe√ßalho com Bot√£o Voltar -->
        <div style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <button onclick="window.closeFlashModal()" style="background:none; border:none; color:#888; font-size:18px; cursor:pointer; margin-right:10px;">‚¨Ö</button>
            <h3 style="color:#e67e22; margin:0;">Nova Nota</h3>
            <button onclick="window.closeFlashModal()" style="margin-left:auto; background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <!-- T√≠tulo -->
        <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota..." style="font-size:1.2em; margin-bottom:15px;">
        
        <!-- BARRA DE FERRAMENTAS (B, I, U, T√≥picos, Links, Tipo) -->
        <div class="flash-toolbar">
            <button onclick="document.execCommand('bold')" title="Negrito"><b>B</b></button>
            <button onclick="document.execCommand('italic')" title="It√°lico"><i>I</i></button>
            <button onclick="document.execCommand('underline')" title="Sublinhado"><u>U</u></button>
            
            <!-- Separador -->
            <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>

            <button id="btn-flash-topics" onclick="window.openTopicsModal()" title="T√≥picos">üìã</button>
            <button id="btn-flash-links" onclick="window.openFlashLinkManager()" title="Gest√£o de Links">‚ö°</button>

            <!-- Dropdown Tipo -->
            <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                <option value="default">üìò Subnota</option>
                <option value="question">üìó Quest√£o</option>
            </select>
        </div>

        <!-- Editor -->
        <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
        
        <!-- Seletor de Cores -->
        <div class="color-picker-container" id="color-picker">
            <!-- As cores ser√£o geradas pelo JS -->
        </div>

        <!-- Informa√ß√£o de Anexo -->
        <div style="margin-top: 5px; font-size: 0.8rem; color: #888; display:flex; align-items:center; gap:5px;">
            <span style="font-size:1.2em;">üìö</span> Codex: 
            <span id="flash-codex-info" style="color: #3498db; font-weight:bold;"></span>
        </div>

        <!-- Bot√£o Gravar -->
        <button id="btn-save-flash" onclick="window.saveLibraryFlashNote()" 
                style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1rem; transition: background 0.2s;">
            GRAVAR NOTA
        </button>
    </div>
</div>

<!-- MODAL DE SELE√á√ÉO DE T√ìPICOS (BIBLE VERSION) -->
<div id="flash-topics-modal" class="modal-overlay" style="z-index: 12000;">
    <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3>T√≥picos do Bloco</h3>
            <button class="modal-close" onclick="document.getElementById('flash-topics-modal').style.display='none'">√ó</button>
        </div>
        <div style="display: flex; flex: 1; overflow: hidden;">
            <!-- Coluna Esquerda: T√≥picos -->
            <div style="flex: 1; border-right: 1px solid #333; padding: 10px; overflow-y: auto;">
                <h4 style="color:#e67e22; font-size:0.8rem; margin-bottom:10px;">T√ìPICOS</h4>
                <ul id="flash-topics-list" style="list-style:none;">Carregando...</ul>
            </div>
            <!-- Coluna Direita: Subt√≥picos -->
            <div style="flex: 1; padding: 10px; overflow-y: auto;">
                <h4 style="color:#3498db; font-size:0.8rem; margin-bottom:10px;" id="flash-sub-title">SUBT√ìPICOS</h4>
                <ul id="flash-subtopics-list" style="list-style:none;">
                    <li style="color:#888; font-style:italic;">Selecione um t√≥pico.</li>
                </ul>
            </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
            <button onclick="document.getElementById('flash-topics-modal').style.display='none'" 
                    style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Confirmar Sele√ß√£o
            </button>
        </div>
    </div>
</div>

<!-- MODAL GEST√ÉO DE LINKS (FLASH VERSION) -->
<div id="flash-links-modal" class="modal-overlay" style="z-index: 12000;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        
        <div class="modal-header">
            <h3>Gest√£o de Links</h3>
            <button class="modal-close" onclick="document.getElementById('flash-links-modal').style.display='none'">√ó</button>
        </div>

        <!-- NOVO: Contexto da Refer√™ncia (O que est√° selecionado) -->
        <div style="padding: 15px 15px 0 15px;">
            <div id="flash-links-context"></div>
        </div>

        <!-- ABAS -->
        <div class="store-tabs-header" style="padding: 10px 15px; border-bottom: 1px solid #333; display: flex; gap: 10px;">
            <button class="store-tab-btn active" onclick="window.switchFlashLinkTab('refs')">Refer√™ncias</button>
            <button class="store-tab-btn" onclick="window.switchFlashLinkTab('codex')">Codex</button>
            <button class="store-tab-btn" onclick="window.switchFlashLinkTab('cats')">Categorias</button>
        </div>

        <!-- CONTE√öDO DAS ABAS -->
        <div style="flex: 1; overflow-y: auto; padding: 15px;">
            
            <!-- ABA 1: REFER√äNCIAS (URLS) -->
            <div id="flash-tab-refs">
                <label style="color:#888; font-size:0.8rem;">T√≠tulo do Grupo de Links</label>
                <input type="text" id="flash-link-title" class="flash-input-title" style="font-size:1rem; margin-bottom:15px; border-bottom:1px solid #333;" placeholder="Ex: Artigos de apoio...">
                
                <div id="flash-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                
                <button onclick="window.addFlashUrlField()" style="margin-top:10px; padding:6px 12px; background:#333; border:1px solid #555; color:#ccc; cursor:pointer; border-radius:4px;">+ Adicionar URL</button>
            </div>

            <!-- ABA 2: CODEX -->
            <div id="flash-tab-codex" style="display:none;">
                <div id="flash-codex-rows-container"></div>
                <button onclick="window.createFlashCodexRow()" style="width:100%; margin-top:15px; padding:10px; background:rgba(230, 126, 34, 0.1); border:1px dashed #e67e22; color:#e67e22; cursor:pointer; border-radius:6px;">+ Nova Linha Codex</button>
            </div>

            <!-- ABA 3: CATEGORIAS -->
            <div id="flash-tab-cats" style="display:none;">
                <input type="text" id="flash-cat-search" class="flash-input-title" style="font-size:0.9rem;" placeholder="Pesquisar..." oninput="window.searchFlashCategories(this.value)">
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; padding:5px; background:rgba(255,255,255,0.05); border-radius:4px;">
                    <label class="setting-switch">
                        <input type="checkbox" id="flash-bible-toggle">
                        <span class="slider round"></span>
                    </label>
                    <span style="font-size:0.8rem; color:#ccc;">Procurar na B√≠blia (Global)</span>
                </div>

                <div id="flash-cat-results" style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #333; padding:5px;"></div>
                <label style="color:#888; font-size:0.8rem;">Selecionados:</label>
                <div id="flash-cat-selected" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>

        </div>

        <!-- RODAP√â -->
        <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
            <button id="btn-save-flash-links" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Confirmar e Anexar
            </button>
        </div>
    </div>
</div>


    <script type="module">
import { db, auth } from './js/firebase-config.js';
import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';

// --- ESTADO GLOBAL ---
let currentBookData = null;
let currentPubId = null;   // Ex: 'ip-1', 'w24'
let currentChapter = null; // N√∫mero do cap√≠tulo
let navStack = [];
let currentView = 'books';
let selectedBook = null;
let currentFlashTopics = {}; 
let currentFlashLinks = {};
let activeTopicIdForFlash = null;
const container = document.getElementById('content-container');

// Estado de Sele√ß√£o
let currentSelectionText = "";
let currentSelectedParagraphs = []; // Array de Strings ["5", "6"]
let activeHighlightContext = null;
let selectedColorHex = '#3498db';

// Cache de Notas (Para n√£o ler BD sempre)
let libraryUserData = {}; 

const HIGHLIGHT_COLORS = [
    { name: 'Azul', hex: '#3498db' },
    { name: 'Laranja', hex: '#e67e22' },
    { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Verde', hex: '#2ecc71' },
    { name: 'Roxo', hex: '#9b59b6' },
    { name: 'Rosa', hex: '#ff7979' }
];

// --- 1. AUTENTICA√á√ÉO ---
onAuthStateChanged(auth, async (user) => {
    const shield = document.getElementById('global-auth-shield');
    if (!user) { window.location.href = "404.html"; return; }

    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().aceite !== "on") { window.location.href = "index.html"; return; }

        if (shield) shield.style.display = 'none';

        const params = new URLSearchParams(window.location.search);
        if (params.has('book') && params.has('cap')) {
            checkUrlParams(); 
        } else {
            showRoot(); 
        }
    } catch (e) { console.error(e); }
});

// --- 2. CARREGAMENTO ---
async function loadPublication(sectionId, pubId) {
    container.innerHTML = '<div class="global-spinner" style="margin:50px auto;"></div>';
    try {
        currentPubId = pubId; // Guarda o ID atual
        const response = await fetch(`./js/${sectionId}/${pubId}.json`);
        if (!response.ok) throw new Error("Erro");
        currentBookData = await response.json();
        return true;
    } catch (e) {
        container.innerHTML = `<p style="text-align:center;color:red;padding:20px;">Erro ao carregar publica√ß√£o.</p>`;
        return false;
    }
}

// --- 3. RENDERIZA√á√ÉO ---
function renderReading(chapterIdx, sectionId, pubId) {
    const cap = currentBookData.capitulos[chapterIdx];
    if (!cap) return;
    
    currentChapter = cap.capitulo || (chapterIdx + 1);

    if (navStack.length === 0 || navStack[navStack.length-1].name !== "showChapters") {
        navStack.push(() => showChapters(sectionId, pubId));
    }
    
    let html = `<div class="reader-content" id="reader-area">
        <h1 style="font-size:1.1em; opacity:0.5; border:none; margin-bottom:0;">${currentBookData.titulo}</h1>
        <h1 style="color:var(--accent-color); margin-bottom:20px;">Cap. ${currentChapter}: ${cap.titulo}</h1>`;

    cap.conteudo.forEach(block => {
        // IDs para os par√°grafos (para o destaque funcionar)
        // Usamos o formato: p-{numero}
        const pNum = block.numero_ref ? String(block.numero_ref).split(',')[0].trim() : null;
        const blockId = pNum ? `id="p-${pNum}"` : '';
        const dataAttr = pNum ? `data-pnum="${pNum}"` : '';

        if (block.tipo === 'subtema') {
            html += `<div class="block-subtema">${block.texto}</div>`;
        } else if (block.tipo === 'pergunta') {
            html += `<div class="block-pergunta">${block.texto}</div>`;
        } else if (block.tipo === 'paragrafo') {
            html += `<div ${blockId} ${dataAttr} class="block-paragrafo"><span class="ref-num">${block.numero_ref || ''}</span>${block.texto}</div>`;
        } else if (block.tipo === 'rodape') {
            html += `<div class="block-rodape">${block.texto}</div>`;
        }
    });

    html += `</div>`;
    container.innerHTML = html;
    container.scrollTop = 0;
    
    updateHeader(`Cap√≠tulo ${currentChapter}`, () => {
        const last = navStack.pop();
        if (last) last();
    });

    // --- CARREGAR DESTAQUES E DADOS ---
    loadLibraryDataForChapter(currentPubId, currentChapter);
}

// --- 4. MOTOR DE SELE√á√ÉO E BARRA FLUTUANTE ---

// Detectar sele√ß√£o no PC e Mobile
document.addEventListener('selectionchange', handleSelection);
// document.addEventListener('touchend', handleSelection); // Selectionchange j√° cobre touchend em browsers modernos

function handleSelection() {
    const selection = window.getSelection();
    const toolbar = document.getElementById('selection-toolbar');

    // Se n√£o h√° sele√ß√£o, esconde barra
    if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.style.display = 'none';
        return;
    }

    const range = selection.getRangeAt(0);
    const text = selection.toString().trim();
    
    // Verifica se a sele√ß√£o est√° dentro do leitor
    const reader = document.getElementById('reader-area');
    if (!reader || !reader.contains(range.commonAncestorContainer)) {
        toolbar.style.display = 'none';
        return;
    }

    if (text.length > 0) {
        currentSelectionText = text;
        
        // Identificar Par√°grafos Selecionados
        identifyParagraphsInSelection(range);

        // Posicionar Barra
        const rect = range.getBoundingClientRect();
        
        // Ajuste para Mobile (Fundo) ou PC (Flutuante)
        if (window.innerWidth <= 768) {
            toolbar.style.position = 'fixed';
            toolbar.style.bottom = '20px';
            toolbar.style.left = '50%';
            toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.top = 'auto';
        } else {
            toolbar.style.position = 'absolute';
            toolbar.style.top = `${window.scrollY + rect.top - 50}px`;
            toolbar.style.left = `${window.scrollX + rect.left}px`;
            toolbar.style.transform = 'none';
        }
        
        toolbar.style.display = 'flex';
        toolbar.style.gap = '10px';
    }
}

function identifyParagraphsInSelection(range) {
    currentSelectedParagraphs = [];
    // Encontra todos os blocos de par√°grafo na √°rea de leitura
    const paragraphs = document.querySelectorAll('.block-paragrafo');
    
    paragraphs.forEach(p => {
        if (selectionIntersectsNode(range, p)) {
            const pNum = p.getAttribute('data-pnum');
            if (pNum) currentSelectedParagraphs.push(pNum);
        }
    });
}

function selectionIntersectsNode(range, node) {
    const nodeRange = document.createRange();
    nodeRange.selectNode(node);
    return range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
           range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
}

// Bot√µes da Barra Flutuante
document.getElementById('btn-copy').onclick = () => {
    navigator.clipboard.writeText(currentSelectionText);
    document.getElementById('selection-toolbar').style.display = 'none';
};

document.getElementById('btn-flash-note').onclick = () => {
    openFlashModal();
    document.getElementById('selection-toolbar').style.display = 'none';
};

// --- 5. L√ìGICA DE CRIA√á√ÉO E GRAVA√á√ÉO (CODEX) ---

window.openFlashModal = () => {
    const modal = document.getElementById('flash-note-modal');
    modal.style.display = 'flex';
    
    // Reset campos
    document.getElementById('flash-title').value = '';
    document.getElementById('flash-editor').innerHTML = '';
    
    // Preenche info do Codex
    let codexStr = `${currentPubId} ${currentChapter}`;
    if (currentSelectedParagraphs.length > 0) {
        codexStr += `:${currentSelectedParagraphs.join('-')}`;
    }
    document.getElementById('flash-codex-info').textContent = codexStr;

    // Renderiza Cores
    renderColorPicker();
};

window.closeFlashModal = () => {
    document.getElementById('flash-note-modal').style.display = 'none';
};

function renderColorPicker() {
    const container = document.getElementById('color-picker');
    container.innerHTML = '';
    
    HIGHLIGHT_COLORS.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.hex;
        if (selectedColorHex === c.hex) btn.classList.add('selected');
        
        btn.onclick = () => {
            selectedColorHex = c.hex;
            renderColorPicker();
        };
        container.appendChild(btn);
    });
}

// Fun√ß√£o para mudar a cor da borda visualmente quando troca o tipo
window.changeFlashBorder = (selectElement) => {
    const editor = document.getElementById('flash-editor');
    const val = selectElement.value;
    if (val === 'question') {
        editor.style.borderLeft = '4px solid #2ecc71'; // Verde
    } else {
        editor.style.borderLeft = '4px solid #3498db'; // Azul
    }
};

// ATUALIZA√á√ÉO DA GRAVA√á√ÉO
window.saveLibraryFlashNote = async (clickedBtn = null) => {
    const btn = clickedBtn || document.getElementById('btn-save-flash');
    
    // Captura valores
    const title = document.getElementById('flash-title').value.trim();
    const content = document.getElementById('flash-editor').innerHTML;
    
    // NOVO: Captura o tipo (Subnota ou Quest√£o)
    const typeSelect = document.getElementById('flash-type-select');
    const noteType = typeSelect ? typeSelect.value : 'default';

    if (!title) return alert("O t√≠tulo √© obrigat√≥rio!");

    if(btn) { 
        btn.textContent = "A gravar..."; 
        btn.disabled = true; 
    }

    try {
        const { collection, addDoc, doc, updateDoc, arrayUnion, serverTimestamp, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // --- PREPARA√á√ÉO DO HTML DA CAIXA (Com o estilo correto) ---
        
        // 1. Define a classe CSS baseada no tipo
        let wrapperClass = "mini-note-wrapper";
        if (noteType === 'question') wrapperClass += " question-mode";

        // 2. Prepara Metadados (T√≥picos e Links que pode ter adicionado nos bot√µes novos)
        const safeTopics = JSON.stringify(currentFlashTopics || {}).replace(/"/g, '&quot;');
        
        // Garante que o Codex atual est√° nos links
        if (!currentFlashLinks.codex) currentFlashLinks.codex = [];
        // (A l√≥gica de adicionar o codex atual mant√©m-se a mesma de antes)
        
        const safeBoxLinks = JSON.stringify(currentFlashLinks).replace(/"/g, '&quot;');

        // 3. Constr√≥i o HTML da caixa
        const subNoteHtml = `
            <div class="${wrapperClass}" id="box_${Date.now()}" 
                 data-topics='${safeTopics}' data-shared="false" data-box-links='${safeBoxLinks}' contenteditable="false">
                <textarea class="mini-note-title-input" rows="1">${title}</textarea>
                <div class="mini-note-toolbar" contenteditable="false">
                    <button>üîê</button><div class="toolbar-btn-group"><button>üî∫</button><button>üîª</button></div>
                    <button class="has-links">‚ö°</button><button>üß¨</button><button>üé®</button><button>üìã</button><button>üóëÔ∏è</button>
                </div>
                <div class="mini-note-content" contenteditable="true">${content}</div>
            </div><p><br></p>
        `;

        // --- GRAVA√á√ÉO (Mant√©m-se igual, mas agora envia o HTML formatado acima) ---
        
        // 1. Cria a nota na cole√ß√£o 'pastas'
        const noteRef = await addDoc(collection(db, 'pastas'), {
            nome: title,
            conteudo: subNoteHtml, // HTML com classe correta (verde/azul)
            tipo: 'nota',
            oque: 'flash',
            userId: auth.currentUser.uid,
            estado: 'ativa',
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        });

        // 2. Cria o item do Puzzle (Refer√™ncia)
        const puzzleItem = {
            type: 'ref',
            noteId: noteRef.id,
            noteName: title,
            snippet: encodeURIComponent(subNoteHtml),
            addedAt: Date.now(),
            noteColor: selectedColorHex // Usa a cor escolhida nas bolas
        };

    const promises = currentSelectedParagraphs.map(async (pNum) => {
            const docName = `${currentPubId} ${currentChapter}:${pNum}`;
            const q = query(collection(db, 'livros'), where('nome', '==', docName), where('userId', '==', auth.currentUser.uid));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                await addDoc(collection(db, 'livros'), {
                    nome: docName,
                    livro: currentBookData.titulo,
                    bookId: currentPubId,
                    capitulo: currentChapter,
                    paragrafo: pNum,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp(),
                    puzzleBoard: [puzzleItem],
                    dossie: [], panelLinks: []
                });
            } else {
                const docId = snap.docs[0].id;
                await updateDoc(doc(db, 'livros', docId), { puzzleBoard: arrayUnion(puzzleItem) });
            }
        });

        await Promise.all(promises);

        window.closeFlashModal();
        if(btn) { btn.textContent = "GRAVAR NOTA"; btn.disabled = false; }
        
        // Atualiza visualmente se houver sele√ß√£o de texto
        if(currentSelectionText) {
            window.applyHighlightToUI(currentSelectionText, selectedColorHex);
        }

    } catch (e) {
        console.error("Erro:", e);
        alert("Erro ao gravar.");
        if(btn) { btn.textContent = "GRAVAR NOTA"; btn.disabled = false; }
    }
};

     

// --- 6. SISTEMA DE DESTAQUES E PAINEL LATERAL ---

// Carregar destaques ao abrir cap√≠tulo
async function loadLibraryDataForChapter(pubId, chapter) {
    const prefix = `${pubId} ${chapter}:`;
    
    try {
        // Busca na cole√ß√£o LIVROS
        const q = query(collection(db, 'livros'), 
            where('userId', '==', auth.currentUser.uid),
            where('nome', '>=', prefix),
            where('nome', '<=', prefix + '\uf8ff')
        );
        
        const snapshot = await getDocs(q);
        
        snapshot.forEach(doc => {
            const data = doc.data();
            // Para cada item no puzzleBoard (notas), aplica o highlight
            if (data.puzzleBoard) {
                data.puzzleBoard.forEach(item => {
                    if (item.highlightRef && item.noteColor) {
                        window.applyHighlightToUI(item.highlightRef, item.noteColor, data.nome);
                    }
                });
            }
            
            // Marca o n√∫mero do par√°grafo
            const pNum = data.paragrafo;
            const numEl = document.querySelector(`.block-paragrafo[data-pnum="${pNum}"] .ref-num`);
            if (numEl) numEl.classList.add('has-data');
        });

    } catch (e) { console.error("Erro highlights:", e); }
}

window.applyHighlightToUI = (text, color, refId) => {
    // Procura no texto do leitor
    const reader = document.getElementById('reader-area');
    if (!reader) return;

    // Simplifica√ß√£o: Procura nos par√°grafos
    const paragraphs = reader.querySelectorAll('.block-paragrafo');
    
    paragraphs.forEach(p => {
        if (p.textContent.includes(text)) {
            // Evita duplicar se j√° estiver destacado
            if (p.innerHTML.includes(text) && !p.innerHTML.includes('highlight-picotado')) {
                 const safeText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape regex
                 const regex = new RegExp(`(${safeText})`, 'g');
                 
                 const replacement = `<span class="highlight-picotado" 
                    style="background-image: linear-gradient(to right, ${color} 50%, transparent 50%);"
                    onclick="window.openSidePanel('${refId}')">${text}</span>`;
                 
                 p.innerHTML = p.innerHTML.replace(regex, replacement);
            }
        }
    });
};

// --- 7. PAINEL LATERAL ---

window.openSidePanel = async (refName) => {
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('side-content');
    const title = document.getElementById('side-title');

    panel.classList.add('open');
    title.textContent = refName; // Ex: ip-1 5:12
    content.innerHTML = '<div style="padding:20px;text-align:center;">A carregar...</div>';

    try {
        const q = query(collection(db, 'livros'), where('nome', '==', refName), where('userId', '==', auth.currentUser.uid));
        const snap = await getDocs(q);

        if (snap.empty) {
            content.innerHTML = '<p>Sem notas.</p>';
            return;
        }

        const data = snap.docs[0].data();
        let html = '';

        if (data.puzzleBoard) {
            data.puzzleBoard.forEach(item => {
                let cleanSnippet = decodeURIComponent(item.snippet);
                // Remove HTML wrapper para mostrar texto limpo se poss√≠vel
                cleanSnippet = cleanSnippet.replace(/<[^>]*>/g, ' ').substring(0, 100) + '...';
                
                html += `
                <div class="detail-card" style="border-left: 3px solid ${item.noteColor}">
                    <strong>${item.noteName}</strong>
                    <div style="font-size:0.9em; color:#ccc;">${cleanSnippet}</div>
                </div>`;
            });
        }
        content.innerHTML = html || '<p>Sem notas.</p>';

    } catch (e) {
        content.innerHTML = '<p style="color:red">Erro ao carregar.</p>';
    }
};

window.closeSidePanel = () => {
    document.getElementById('side-panel').classList.remove('open');
};

// --- NAVEGA√á√ÉO B√ÅSICA (MANTIDA) ---
function showRoot() {
    navStack = [];
    container.innerHTML = '<h2 class="section-title">Cole√ß√µes</h2><div class="grid" id="root-grid"></div>';
    const grid = document.getElementById('root-grid');
    const SECTIONS = [
        { id: 'books', name: 'Livros', icon: 'üìö', color: 'type-book', items: ['cf', 'jy', 'ia', 'ip-1', 'ip-2', 're', 'dp', 'rr'] },
        { id: 'publicacoes', name: 'Publica√ß√µes', icon: 'üì∞', color: 'type-pub', items: ['lff', 'od', 'th', 'mwb'] }
    ];
    SECTIONS.forEach(sec => {
        const card = document.createElement('div');
        card.className = `pub-card ${sec.color}`;
        card.innerHTML = `<span style="font-size:3em;">${sec.icon}</span><span class="pub-title">${sec.name}</span>`;
        card.onclick = () => showList(sec);
        grid.appendChild(card);
    });
    updateHeader("Biblioteca", () => window.location.href = "note.html");
}

function showList(section) {
    navStack.push(() => showRoot());
    container.innerHTML = `<h2 class="section-title">${section.name}</h2><div class="grid" id="list-grid"></div>`;
    const grid = document.getElementById('list-grid');
    section.items.forEach(id => {
        const card = document.createElement('div');
        card.className = `pub-card ${section.color}`;
        const fullName = SIGLAS_PUBLICACOES[id] || id.toUpperCase();
        card.innerHTML = `<div style="font-size:0.7em; opacity:0.5; margin-bottom:5px;">${id.toUpperCase()}</div><span class="pub-title">${fullName}</span>`;
        card.onclick = () => loadPublication(section.id, id).then(ok => { if(ok) showChapters(section.id, id); });
        grid.appendChild(card);
    });
    updateHeader(section.name, () => { const last = navStack.pop(); if (last) last(); });
}

function showChapters(sectionId, pubId) {
    navStack.push(() => showList(sectionId === 'books' ? {id:'books', name:'Livros'} : {id:'publicacoes', name:'Publica√ß√µes'})); // Simplificado
    container.innerHTML = `<h2 class="section-title">Cap√≠tulos</h2><div class="chapter-list"></div>`;
    const list = container.querySelector('.chapter-list');
    currentBookData.capitulos.forEach((cap, idx) => {
        const item = document.createElement('div');
        item.className = 'chapter-item';
        item.innerHTML = `<span><b>${cap.capitulo || idx+1}</b> ${cap.titulo}</span> <span>‚ûî</span>`;
        item.onclick = () => renderReading(idx, sectionId, pubId);
        list.appendChild(item);
    });
    updateHeader(currentBookData.titulo, () => { showList(sectionId === 'books' ? {id:'books', name:'Livros', color:'type-book', items:[]} : {id:'publicacoes', name:'Publica√ß√µes', color:'type-pub', items:[]}); }); // Hack r√°pido para voltar
}

function updateHeader(title, backAction) {
    document.getElementById('page-title').textContent = title;
    const btn = document.getElementById('back-btn');
    if (backAction) btn.onclick = backAction;
}

// URL Params
async function checkUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get('book');
    const capNum = params.get('cap');
    if (bookId && capNum) {
        const success = await loadPublication('books', bookId); // Assume 'books' por defeito
        if (success) {
            const chapterIdx = currentBookData.capitulos.findIndex(c => String(c.capitulo) === String(capNum));
            if (chapterIdx !== -1) renderReading(chapterIdx, 'books', bookId);
        }
    }
}

// --- GEST√ÉO DE T√ìPICOS (üìã) ---

// 1. Abrir Modal
window.openTopicsModal = function() {
    const modal = document.getElementById('flash-topics-modal');
    if (!modal) return console.error("Modal de t√≥picos n√£o encontrado");
    
    modal.style.display = 'flex';
    
    // Carrega a lista de t√≥picos
    loadFlashTopicsList();
};

// 2. Carregar Lista de T√≥picos (Esquerda)
async function loadFlashTopicsList() {
    const list = document.getElementById('flash-topics-list');
    list.innerHTML = '<li style="padding:10px; color:#888;">A carregar...</li>';
    
    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('nome')
        );
        const snapshot = await getDocs(q);

        list.innerHTML = '';
        
        snapshot.forEach(doc => {
            const topic = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.style.cssText = "padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center;";
            
            // Verifica se este t√≥pico tem algo selecionado
            const isSelected = !!currentFlashTopics[topic.id];
            
            li.innerHTML = `
                <span style="margin-right: 10px;">${isSelected ? '‚úÖ' : '‚¨ú'}</span>
                <span>${topic.nome}</span>
            `;

            li.onclick = () => {
                // Remove destaque visual anterior
                Array.from(list.children).forEach(c => c.style.background = "");
                li.style.background = "rgba(255,255,255,0.1)";
                
                // Carrega subt√≥picos √† direita
                document.getElementById('flash-sub-title').textContent = `SUBT√ìPICOS: ${topic.nome}`;
                renderFlashSubtopics(topic.id);
            };

            list.appendChild(li);
        });
    } catch (e) {
        console.error(e);
        list.innerHTML = "Erro ao carregar.";
    }
}

// 3. Carregar Subt√≥picos (Direita)
async function renderFlashSubtopics(topicId) {
    const list = document.getElementById('flash-subtopics-list');
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    
    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(
            collection(db, 'subtopicos'), 
            where('topicId', '==', topicId),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        if(snapshot.empty) {
            list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
            return;
        }

        // Recupera o array de subt√≥picos j√° selecionados
        const selectedSubs = currentFlashTopics[topicId] || [];

        snapshot.forEach(doc => {
            const sub = { id: doc.id, ...doc.data() };
            const isChecked = selectedSubs.includes(sub.id);

            const li = document.createElement('li');
            li.style.cssText = "padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center;";
            
            li.innerHTML = `
                <input type="checkbox" ${isChecked ? 'checked' : ''} style="margin-right: 10px; cursor:pointer;">
                <span>${sub.nome}</span>
            `;
            
            // Clique na linha
            li.onclick = (e) => {
                const cb = li.querySelector('input');
                if(e.target !== cb) cb.checked = !cb.checked;
                
                // Atualiza Vari√°vel Global
                toggleFlashSubtopic(topicId, sub.id, cb.checked);
            };

            list.appendChild(li);
        });

    } catch (e) { console.error(e); }
}

// 4. L√≥gica de Toggle (Guardar na mem√≥ria)
function toggleFlashSubtopic(topicId, subId, isChecked) {
    if (!currentFlashTopics[topicId]) currentFlashTopics[topicId] = [];
    
    if (isChecked) {
        if (!currentFlashTopics[topicId].includes(subId)) {
            currentFlashTopics[topicId].push(subId);
        }
    } else {
        currentFlashTopics[topicId] = currentFlashTopics[topicId].filter(id => id !== subId);
        // Se ficar vazio, apaga a chave do t√≥pico
        if (currentFlashTopics[topicId].length === 0) {
            delete currentFlashTopics[topicId];
        }
    }
    // Atualiza visualmente o check do t√≥pico pai na esquerda
    loadFlashTopicsList(); 
}

// --- GEST√ÉO DE LINKS (‚ö°) ---

// 1. Abrir Modal
window.openFlashLinkManager = function() {
    const modal = document.getElementById('flash-links-modal');
    if(!modal) return;
    
    modal.style.display = 'flex';
    
    // --- ATUALIZA√á√ÉO: MOSTRAR O CONTEXTO ---
    const contextDiv = document.getElementById('flash-links-context');
    if (contextDiv) {
        // Usa o texto selecionado ou o vers√≠culo ativo
        let displayText = currentSelectionText 
            ? `Trecho: "${currentSelectionText.substring(0, 50)}..."` 
            : activeVerseFullName;

        // Se houver m√∫ltiplos vers√≠culos
        if (currentSelectionVerses && currentSelectionVerses.length > 1) {
            const first = currentSelectionVerses[0];
            const last = currentSelectionVerses[currentSelectionVerses.length - 1].split(':')[1];
            displayText = `${first}-${last}`;
        }
        
        contextDiv.innerHTML = `<strong>üîó A criar links para:</strong> ${displayText}`;
    }
    // ----------------------------------------
    
    // Limpeza visual
    document.getElementById('flash-urls-list').innerHTML = '';
    document.getElementById('flash-codex-rows-container').innerHTML = ''; 
    document.getElementById('flash-cat-selected').innerHTML = '';
    
    // RESTAURAR DADOS
    document.getElementById('flash-link-title').value = currentFlashLinks.title || "";
    
    if (currentFlashLinks.urls) {
        Object.values(currentFlashLinks.urls).forEach(url => window.addFlashUrlField(url));
    }
    
    if (currentFlashLinks.codex && Array.isArray(currentFlashLinks.codex)) {
        currentFlashLinks.codex.forEach(row => {
            window.createFlashCodexRow(row);
        });
    } else {
        window.createFlashCodexRow();
    }
    
    if (currentFlashLinks.categories) {
        currentFlashLinks.categories.forEach(c => renderFlashCategoryChip(c));
    }
    
    window.switchFlashLinkTab('refs');
};

// 2. Alternar Abas do Modal
window.switchFlashLinkTab = (tab) => {
    // UI dos Bot√µes
    document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
    // Encontra o bot√£o clicado (ou o que corresponde √† aba) e ativa
    const buttons = document.querySelectorAll('.store-tab-btn');
    if(tab === 'refs') buttons[0].classList.add('active');
    if(tab === 'codex') buttons[1].classList.add('active');
    if(tab === 'cats') buttons[2].classList.add('active');

    // UI dos Paineis
    document.getElementById('flash-tab-refs').style.display = 'none';
    document.getElementById('flash-tab-codex').style.display = 'none';
    document.getElementById('flash-tab-cats').style.display = 'none';

    document.getElementById(`flash-tab-${tab}`).style.display = 'block';
};

// 3. Adicionar Campo URL
window.addFlashUrlField = (val = "") => {
    const div = document.createElement('div');
    div.className = 'flash-url-row';
    div.innerHTML = `
        <input type="text" placeholder="https://..." value="${val}">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-urls-list').appendChild(div);
};

// 4. Gravar Dados do Modal para a Vari√°vel Global
const btnSaveLinks = document.getElementById('btn-save-flash-links');
if (btnSaveLinks) {
    btnSaveLinks.onclick = () => {
        const title = document.getElementById('flash-link-title').value;
        const isBibleActive = document.getElementById('flash-bible-toggle').checked;
        
        // 1. Recolher URLs
        const urlsObj = {};
        document.querySelectorAll('#flash-urls-list input').forEach((inp, i) => {
            if(inp.value.trim()) urlsObj[`url_${i}`] = inp.value.trim();
        });

        // 2. Recolher Codex (Complexo)
        const codexArr = [];
        document.querySelectorAll('#flash-codex-rows-container .codex-row').forEach(row => {
            const serie = row.querySelector('.serie-main')?.value.trim();
            if (serie) {
                const paginas = Array.from(row.querySelectorAll('.pages-container input')).map(i => i.value);
                const paragrafos = Array.from(row.querySelectorAll('.paragraphs-container input')).map(i => i.value);
                
                // Recolhe manuais
                const manA = row.querySelector('.manual-year')?.value;
                const manM = row.querySelector('.manual-month')?.value;
                const manC = row.querySelector('.manual-chapter')?.value;
                const manT = row.querySelector('.manual-time')?.value;

                let total = serie;
                if (manA) total += ` ${manA}`;
                if (manC) total += `, Cap ${manC}`;
                if (paginas.length) total += `, p√°g. ${paginas.join(',')}`;

                codexArr.push({
                    serie: serie, paginas: paginas, paragrafos: paragrafos,
                    manualYear: manA, manualMonth: manM, capitulo: manC, tempo: manT,
                    total: total, type: 'codex'
                });
            }
        });

        // 3. Atualiza Global
        currentFlashLinks.title = title;
        currentFlashLinks.urls = urlsObj;
        currentFlashLinks.codex = codexArr;
        currentFlashLinks.bibleMode = isBibleActive;

        document.getElementById('flash-links-modal').style.display = 'none';
        
        // Feedback visual no bot√£o ‚ö°
        const btn = document.getElementById('btn-flash-links');
        const hasData = Object.keys(urlsObj).length > 0 || codexArr.length > 0 || (currentFlashLinks.categories && currentFlashLinks.categories.length > 0);
        
        if (hasData && btn) {
            btn.style.color = "#f1c40f"; btn.style.borderColor = "#f1c40f";
        } else if (btn) {
            btn.style.color = ""; btn.style.borderColor = "";
        }
    };
}


// Cria uma linha do Codex no modal Flash
window.createFlashCodexRow = function(data = null) {
    const container = document.getElementById('flash-codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row'; // Usa o CSS existente
    
    row.innerHTML = `
        <button class="remove-codex-row" onclick="this.parentElement.remove()">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
            </div>
        </div>
        <div class="codex-content-grid">
            <div>
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container" style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div>
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container" style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(row);

    // Se tiver dados, preenche
    if (data) {
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addFlashCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addFlashCodexUnit(pgContainer, 'Par', p));
    }
};

window.addFlashCodexUnit = function(container, ph, val = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `<input type="text" placeholder="${ph}" value="${val}" style="width:30px;"><span onclick="this.parentElement.remove()" style="cursor:pointer;margin-left:5px;">√ó</span>`;
    container.insertBefore(unit, container.lastChild);
};



</script>
</body>
</html>
