<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator B√≠blico Completo (66 Livros)</title>
    <style>
        :root {
            --bg-color: #1a1a1d;
            --panel-color: #252528;
            --accent-color: #f39c12;
            --text-color: #f0f0f0;
            --border-color: #444;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        body {
            font-family: monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            min-width: 350px;
        }

        h1 { color: var(--accent-color); font-size: 1.1rem; margin: 0 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        .card {
            background: var(--panel-color);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        textarea, button {
            width: 100%;
            box-sizing: border-box;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        button {
            background: var(--accent-color);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border: none;
            margin-top: 10px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #555; }

        .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn-small { width: auto; padding: 5px 10px; font-size: 0.8rem; margin-top:0; flex: 1;}

        /* Grid de Sele√ß√£o de Livros */
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 2px;
            flex: 1;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 5px;
            background: #111;
            max-height: 400px; /* Limite de altura para scroll */
        }
        
        .book-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 2px;
        }
        .book-item:hover { background-color: #333; }
        .book-item input { margin: 0; width: auto; cursor: pointer; }
        .book-item label { cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .log-entry { margin-bottom: 2px; font-size: 0.75rem; border-bottom: 1px solid #333; padding: 2px 0;}
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-info { color: #3498db; }

        #progressBar {
            width: 100%; height: 6px; background: #333; margin-top: 10px; border-radius: 3px; overflow: hidden; display: none;
        }
        #progressFill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.2s; }
    </style>
    
    <!-- SDKs do Firebase (Vers√£o Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <!-- COLUNA 1: CONFIG E SELE√á√ÉO -->
    <div class="column">
        <div class="card">
            <h1>1. Configura√ß√£o Firebase</h1>
            <textarea id="firebaseConfig" rows="4" placeholder='const firebaseConfig = { apiKey: "...", ... };'></textarea>
        </div>

        <div class="card" style="flex:1;">
            <h1>2. Selecione os Livros</h1>
            <div class="btn-group">
                <button class="btn-small" onclick="toggleAll(true)">Marcar Todos</button>
                <button class="btn-small" onclick="toggleAll(false)" style="background:#555; color:white;">Desmarcar Todos</button>
                <button class="btn-small" onclick="toggleSection('AT')" style="background:#444;">Antigo Test.</button>
                <button class="btn-small" onclick="toggleSection('NT')" style="background:#444;">Novo Test.</button>
            </div>
            
            <div id="bookSelectionContainer" class="book-grid">
                <!-- Checkboxes gerados via JS -->
            </div>
            
            <div id="progressBar"><div id="progressFill"></div></div>
            <div id="statusText" style="text-align: center; margin-top: 5px; font-size: 0.8rem; color: #aaa;"></div>
            
            <button onclick="connectAndFetch()" id="btnFetch">üî• Extrair Selecionados</button>
        </div>
    </div>

    <!-- COLUNA 2: RELAT√ìRIO E RESULTADO -->
    <div class="column">
        <div class="card" style="height: 40%;">
            <h1>3. Relat√≥rio de Extra√ß√£o</h1>
            <div id="validationReport" style="height: 100%; overflow-y: auto; font-size: 0.8rem;">
                Aguardando in√≠cio...
            </div>
        </div>

        <div class="card" style="flex: 1;">
            <h1>4. JSON Final</h1>
            <textarea id="jsonOutput" style="flex: 1; resize: none;" readonly placeholder="O JSON gerado aparecer√° aqui..."></textarea>
            <button onclick="downloadJson()">üíæ Baixar JSON</button>
        </div>
    </div>

    <script>
        // ======================================================
        // DADOS COMPLETOS (66 LIVROS)
        // ======================================================
        const BIBLE_DATA = [
            { id: 1,  nome: "G√©nesis", caps: 50, abrev: "G√©n", versiculos: [31, 25, 24, 26, 32, 22, 24, 22, 29, 32, 32, 20, 18, 24, 21, 16, 27, 33, 38, 18, 34, 24, 20, 67, 34, 35, 46, 22, 35, 43, 55, 32, 20, 31, 29, 43, 36, 30, 23, 23, 57, 38, 34, 34, 28, 34, 31, 22, 33, 26] },
            { id: 2,  nome: "√äxodo", caps: 40, abrev: "√äx", versiculos: [22, 25, 22, 31, 23, 30, 25, 32, 35, 29, 10, 51, 22, 31, 27, 36, 16, 27, 25, 26, 36, 31, 33, 18, 40, 37, 21, 43, 46, 38, 18, 35, 23, 35, 35, 38, 29, 31, 43, 38] },
            { id: 3,  nome: "Lev√≠tico", caps: 27, abrev: "Lev", versiculos: [17, 16, 17, 35, 19, 30, 38, 36, 24, 20, 47, 8, 59, 57, 33, 34, 16, 30, 37, 27, 24, 33, 44, 23, 55, 46, 34] },
            { id: 4,  nome: "N√∫meros", caps: 36, abrev: "N√∫m", versiculos: [54, 34, 51, 49, 31, 27, 89, 26, 23, 36, 35, 16, 33, 45, 41, 50, 13, 32, 22, 29, 35, 41, 30, 25, 18, 65, 23, 31, 40, 16, 54, 42, 56, 29, 34, 13] },
            { id: 5,  nome: "Deuteron√≥mio", caps: 34, abrev: "Deut", versiculos: [46, 37, 29, 49, 33, 25, 26, 20, 29, 22, 32, 32, 18, 29, 23, 22, 20, 22, 21, 20, 23, 30, 25, 22, 19, 19, 26, 68, 29, 20, 30, 52, 29, 12] },
            { id: 6,  nome: "Josu√©", caps: 24, abrev: "Jos", versiculos: [18, 24, 17, 24, 15, 27, 26, 35, 27, 43, 23, 24, 33, 15, 63, 10, 18, 28, 51, 9, 45, 34, 16, 33] },
            { id: 7,  nome: "Ju√≠zes", caps: 21, abrev: "Ju√≠", versiculos: [36, 23, 31, 24, 31, 40, 25, 35, 57, 18, 40, 15, 25, 20, 20, 31, 13, 31, 30, 48, 25] },
            { id: 8,  nome: "Rute", caps: 4, abrev: "Rute", versiculos: [22, 23, 18, 22] },
            { id: 9,  nome: "1 Samuel", caps: 31, abrev: "1 Sam", versiculos: [28, 36, 21, 22, 12, 21, 17, 22, 27, 27, 15, 25, 23, 52, 35, 23, 58, 30, 24, 42, 15, 23, 29, 22, 44, 25, 12, 25, 11, 31, 13] },
            { id: 10, nome: "2 Samuel", caps: 24, abrev: "2 Sam", versiculos: [27, 32, 39, 12, 25, 23, 29, 18, 13, 19, 27, 31, 39, 33, 37, 23, 29, 33, 43, 26, 22, 51, 39, 25] },
            { id: 11, nome: "1 Reis", caps: 22, abrev: "1 Reis", versiculos: [53, 46, 28, 34, 18, 38, 51, 66, 28, 29, 43, 33, 34, 31, 34, 34, 24, 46, 21, 43, 29, 53] },
            { id: 12, nome: "2 Reis", caps: 25, abrev: "2 Reis", versiculos: [18, 25, 27, 44, 27, 33, 20, 29, 37, 36, 21, 21, 25, 29, 38, 20, 41, 37, 37, 21, 26, 20, 37, 20, 30] },
            { id: 13, nome: "1 Cr√≥nicas", caps: 29, abrev: "1 Cr√≥n", versiculos: [54, 55, 24, 43, 26, 81, 40, 40, 44, 14, 47, 40, 14, 17, 29, 43, 27, 17, 19, 8, 30, 19, 32, 31, 31, 32, 34, 21, 30] },
            { id: 14, nome: "2 Cr√≥nicas", caps: 36, abrev: "2 Cr√≥n", versiculos: [17, 18, 17, 22, 14, 42, 22, 18, 31, 19, 23, 16, 22, 15, 19, 14, 19, 34, 11, 37, 20, 12, 21, 27, 28, 23, 9, 27, 36, 27, 21, 33, 25, 33, 27, 23] },
            { id: 15, nome: "Esdras", caps: 10, abrev: "Esd", versiculos: [11, 70, 13, 24, 17, 22, 28, 36, 15, 44] },
            { id: 16, nome: "Neemias", caps: 13, abrev: "Nee", versiculos: [11, 20, 32, 23, 19, 19, 73, 18, 38, 39, 36, 47, 31] },
            { id: 17, nome: "Ester", caps: 10, abrev: "Est", versiculos: [22, 23, 15, 17, 14, 14, 10, 17, 32, 3] },
            { id: 18, nome: "J√≥", caps: 42, abrev: "J√≥", versiculos: [22, 13, 26, 21, 27, 30, 21, 22, 35, 22, 20, 25, 28, 22, 35, 22, 16, 21, 29, 29, 34, 30, 17, 25, 6, 14, 23, 28, 25, 31, 40, 22, 33, 37, 16, 33, 24, 41, 30, 24, 34, 17] },
            { id: 19, nome: "Salmos", caps: 150, abrev: "Sal", versiculos: [6, 12, 8, 8, 12, 10, 17, 9, 20, 18, 7, 8, 6, 7, 5, 11, 15, 50, 14, 9, 13, 31, 6, 10, 22, 12, 14, 9, 11, 12, 24, 11, 22, 22, 28, 12, 40, 22, 13, 17, 13, 11, 5, 26, 17, 11, 9, 14, 20, 23, 19, 9, 6, 7, 23, 13, 11, 11, 17, 12, 8, 12, 11, 10, 13, 20, 7, 35, 36, 5, 24, 20, 28, 23, 10, 12, 20, 72, 13, 19, 16, 8, 18, 12, 13, 17, 7, 18, 52, 17, 16, 15, 5, 23, 11, 13, 12, 9, 9, 5, 8, 28, 22, 35, 45, 48, 43, 13, 31, 7, 10, 10, 9, 8, 18, 19, 2, 29, 176, 7, 8, 9, 4, 8, 5, 6, 5, 6, 8, 8, 3, 18, 3, 3, 21, 26, 9, 8, 24, 13, 10, 7, 12, 15, 21, 10, 20, 14, 9, 6] },
            { id: 20, nome: "Prov√©rbios", caps: 31, abrev: "Prov", versiculos: [33, 22, 35, 27, 23, 35, 27, 36, 18, 32, 31, 28, 25, 35, 33, 33, 28, 24, 29, 30, 31, 29, 35, 34, 28, 28, 27, 28, 27, 33, 31] },
            { id: 21, nome: "Eclesiastes", caps: 12, abrev: "Ecl", versiculos: [18, 26, 22, 16, 20, 12, 29, 17, 18, 20, 10, 14] },
            { id: 22, nome: "C√¢ntico de Salom√£o", caps: 8, abrev: "C√¢n", versiculos: [17, 17, 11, 16, 16, 13, 13, 14] },
            { id: 23, nome: "Isa√≠as", caps: 66, abrev: "Isa", versiculos: [31, 22, 26, 6, 30, 13, 25, 22, 21, 34, 16, 6, 22, 32, 9, 14, 14, 7, 25, 6, 17, 25, 18, 23, 12, 21, 13, 29, 24, 33, 9, 20, 24, 17, 10, 22, 38, 22, 8, 31, 29, 25, 28, 28, 25, 13, 15, 22, 26, 11, 23, 15, 12, 17, 13, 12, 21, 14, 21, 22, 11, 12, 6, 12, 25, 24] },
            { id: 24, nome: "Jeremias", caps: 52, abrev: "Jer", versiculos: [19, 37, 25, 31, 31, 30, 34, 22, 26, 25, 23, 17, 27, 22, 21, 21, 27, 23, 15, 18, 14, 30, 40, 10, 38, 24, 22, 17, 32, 24, 40, 44, 26, 22, 19, 32, 21, 28, 18, 16, 18, 22, 13, 30, 5, 28, 7, 47, 39, 46, 64, 34] },
            { id: 25, nome: "Lamenta√ß√µes", caps: 5, abrev: "Lam", versiculos: [22, 22, 66, 22, 22] },
            { id: 26, nome: "Ezequiel", caps: 48, abrev: "Eze", versiculos: [28, 10, 27, 17, 17, 14, 27, 18, 11, 22, 25, 28, 23, 23, 8, 63, 24, 32, 14, 49, 32, 31, 49, 27, 17, 21, 36, 26, 21, 26, 18, 32, 33, 31, 15, 38, 28, 23, 29, 49, 26, 20, 27, 31, 25, 24, 23, 35] },
            { id: 27, nome: "Daniel", caps: 12, abrev: "Dan", versiculos: [21, 49, 30, 37, 31, 28, 28, 27, 27, 21, 45, 13] },
            { id: 28, nome: "Oseias", caps: 14, abrev: "Ose", versiculos: [11, 23, 5, 19, 15, 11, 16, 14, 17, 15, 12, 14, 16, 9] },
            { id: 29, nome: "Joel", caps: 3, abrev: "Joel", versiculos: [20, 32, 21] },
            { id: 30, nome: "Am√≥s", caps: 9, abrev: "Am√≥s", versiculos: [15, 16, 15, 13, 27, 14, 17, 14, 15] },
            { id: 31, nome: "Obadias", caps: 1, abrev: "Oba", versiculos: [21] },
            { id: 32, nome: "Jonas", caps: 4, abrev: "Jon", versiculos: [17, 10, 10, 11] },
            { id: 33, nome: "Miqueias", caps: 7, abrev: "Miq", versiculos: [16, 13, 12, 13, 15, 16, 20] },
            { id: 34, nome: "Naum", caps: 3, abrev: "Naum", versiculos: [15, 13, 19] },
            { id: 35, nome: "Habacuque", caps: 3, abrev: "Hab", versiculos: [17, 20, 19] },
            { id: 36, nome: "Sofonias", caps: 3, abrev: "Sof", versiculos: [18, 15, 20] },
            { id: 37, nome: "Ageu", caps: 2, abrev: "Ageu", versiculos: [15, 23] },
            { id: 38, nome: "Zacarias", caps: 14, abrev: "Zac", versiculos: [21, 13, 10, 14, 11, 15, 14, 23, 17, 12, 17, 14, 9, 21] },
            { id: 39, nome: "Malaquias", caps: 4, abrev: "Mal", versiculos: [14, 17, 18, 6] },
            { id: 40, nome: "Mateus", caps: 28, abrev: "Mat", versiculos: [25, 23, 17, 25, 48, 34, 29, 34, 38, 42, 30, 50, 58, 36, 39, 28, 27, 35, 30, 34, 46, 46, 39, 51, 46, 75, 66, 20] },
            { id: 41, nome: "Marcos", caps: 16, abrev: "Mar", versiculos: [45, 28, 35, 41, 43, 56, 37, 38, 50, 52, 33, 44, 37, 72, 47, 8] },
            { id: 42, nome: "Lucas", caps: 24, abrev: "Luc", versiculos: [80, 52, 38, 44, 39, 49, 50, 56, 62, 42, 54, 59, 35, 35, 32, 31, 37, 43, 48, 47, 38, 71, 56, 53] },
            { id: 43, nome: "Jo√£o", caps: 21, abrev: "Jo√£o", versiculos: [51, 25, 36, 54, 47, 71, 52, 48, 41, 42, 57, 50, 38, 31, 27, 33, 26, 40, 42, 31, 25] },
            { id: 44, nome: "Atos", caps: 28, abrev: "Atos", versiculos: [26, 47, 26, 37, 42, 15, 60, 40, 43, 48, 30, 25, 52, 28, 41, 40, 34, 28, 41, 38, 40, 30, 35, 27, 27, 32, 44, 31] },
            { id: 45, nome: "Romanos", caps: 16, abrev: "Rom", versiculos: [32, 29, 31, 25, 21, 23, 25, 39, 33, 21, 36, 21, 14, 23, 33, 27] },
            { id: 46, nome: "1 Cor√≠ntios", caps: 16, abrev: "1 Cor", versiculos: [31, 16, 23, 21, 13, 20, 40, 13, 27, 33, 34, 31, 13, 40, 58, 24] },
            { id: 47, nome: "2 Cor√≠ntios", caps: 13, abrev: "2 Cor", versiculos: [24, 17, 18, 18, 21, 18, 16, 24, 15, 18, 33, 21, 14] },
            { id: 48, nome: "G√°latas", caps: 6, abrev: "G√°l", versiculos: [24, 21, 29, 31, 26, 18] },
            { id: 49, nome: "Ef√©sios", caps: 6, abrev: "Ef√©", versiculos: [23, 22, 21, 32, 33, 24] },
            { id: 50, nome: "Filipenses", caps: 4, abrev: "Fil", versiculos: [30, 30, 21, 23] },
            { id: 51, nome: "Colossenses", caps: 4, abrev: "Col", versiculos: [29, 23, 25, 18] },
            { id: 52, nome: "1 Tessalonicenses", caps: 5, abrev: "1 Tes", versiculos: [10, 20, 13, 18, 28] },
            { id: 53, nome: "2 Tessalonicenses", caps: 3, abrev: "2 Tes", versiculos: [12, 17, 18] },
            { id: 54, nome: "1 Tim√≥teo", caps: 6, abrev: "1 Tim", versiculos: [20, 15, 16, 16, 25, 21] },
            { id: 55, nome: "2 Tim√≥teo", caps: 4, abrev: "2 Tim", versiculos: [18, 26, 17, 22] },
            { id: 56, nome: "Tito", caps: 3, abrev: "Tito", versiculos: [16, 15, 15] },
            { id: 57, nome: "Fil√©mon", caps: 1, abrev: "Flm", versiculos: [25] },
            { id: 58, nome: "Hebreus", caps: 13, abrev: "Heb", versiculos: [14, 18, 19, 16, 14, 20, 28, 13, 28, 39, 40, 29, 25] },
            { id: 59, nome: "Tiago", caps: 5, abrev: "Tia", versiculos: [27, 26, 18, 17, 20] },
            { id: 60, nome: "1 Pedro", caps: 5, abrev: "1 Ped", versiculos: [25, 25, 22, 19, 14] },
            { id: 61, nome: "2 Pedro", caps: 3, abrev: "2 Ped", versiculos: [21, 22, 18] },
            { id: 62, nome: "1 Jo√£o", caps: 5, abrev: "1 Jo√£o", versiculos: [10, 29, 24, 21, 21] },
            { id: 63, nome: "2 Jo√£o", caps: 1, abrev: "2 Jo√£o", versiculos: [13] },
            { id: 64, nome: "3 Jo√£o", caps: 1, abrev: "3 Jo√£o", versiculos: [14] },
            { id: 65, nome: "Judas", caps: 1, abrev: "Jud", versiculos: [25] },
            { id: 66, nome: "Apocalipse", caps: 22, abrev: "Apo", versiculos: [20, 29, 22, 11, 14, 17, 17, 13, 21, 11, 19, 17, 18, 20, 8, 21, 18, 24, 21, 15, 27, 21] }
        ];

        let extractedData = {};

        // 1. Inicializar a lista de checkboxes
        window.onload = function() {
            const container = document.getElementById('bookSelectionContainer');
            container.innerHTML = "";
            
            BIBLE_DATA.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = book.nome;
                checkbox.id = `chk_${book.id}`;
                checkbox.dataset.id = book.id; // Para filtrar AT/NT

                const label = document.createElement('label');
                label.htmlFor = `chk_${book.id}`;
                label.innerText = book.nome;
                label.title = book.nome; // Tooltip para nomes longos

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        };

        function toggleAll(state) {
            const checkboxes = document.querySelectorAll('#bookSelectionContainer input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = state);
        }

        function toggleSection(section) {
            const checkboxes = document.querySelectorAll('#bookSelectionContainer input[type="checkbox"]');
            checkboxes.forEach(cb => {
                const id = parseInt(cb.dataset.id);
                if (section === 'AT') {
                    if(id <= 39) cb.checked = true;
                    else cb.checked = false;
                } else if (section === 'NT') {
                    if(id >= 40) cb.checked = true;
                    else cb.checked = false;
                }
            });
        }

        // ======================================================
        // FUN√á√ÉO CR√çTICA: NORMALIZA√á√ÉO PARA BUSCA (Slug)
        // ======================================================
        // Transforma "1 Cr√≥nicas" em "1_cronicas" para bater com o ID do Firestore
        function slugify(text) {
            return text
                .toString()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // Remove acentos
                .replace(/\s+/g, "_");           // Espa√ßos viram underline
        }

        async function connectAndFetch() {
            const configStr = document.getElementById('firebaseConfig').value;
            const btn = document.getElementById('btnFetch');
            const status = document.getElementById('statusText');
            const reportDiv = document.getElementById('validationReport');
            
            // 1. Pegar livros selecionados
            const checkboxes = document.querySelectorAll('#bookSelectionContainer input[type="checkbox"]:checked');
            const selectedBookNames = Array.from(checkboxes).map(cb => cb.value);

            if (selectedBookNames.length === 0) {
                alert("Por favor, selecione pelo menos um livro.");
                return;
            }

            try {
                // 2. Conectar Firebase
                const cleanConfig = configStr.replace(/const firebaseConfig = /, '').replace(/;$/, '');
                const config = eval(`(${cleanConfig})`);
                
                if (!firebase.apps.length) firebase.initializeApp(config);
                const db = firebase.firestore();

                btn.disabled = true;
                document.getElementById('progressBar').style.display = 'block';
                status.innerText = "Iniciando extra√ß√£o...";
                reportDiv.innerHTML = "";
                extractedData = {}; // Reset

                let processedCount = 0;
                let totalVersesFound = 0;

                // 3. Loop pelos livros SELECIONADOS
                for (let i = 0; i < selectedBookNames.length; i++) {
                    const bookPrettyName = selectedBookNames[i];
                    
                    // Converte "1 Jo√£o" -> "1_joao"
                    const bookSlug = slugify(bookPrettyName);
                    
                    status.innerText = `Extraindo: ${bookPrettyName} (${i+1}/${selectedBookNames.length})...`;

                    // TRUQUE DO FIRESTORE:
                    // Buscar documentos onde o ID come√ßa com "1_joao_"
                    // Usamos FieldPath.documentId()
                    // startAt: '1_joao_' e endAt: '1_joao_\uf8ff'
                    const snapshot = await db.collection("bible_verses_public")
                        .where(firebase.firestore.FieldPath.documentId(), '>=', bookSlug + '_')
                        .where(firebase.firestore.FieldPath.documentId(), '<', bookSlug + '_\uf8ff')
                        .get();

                    if (snapshot.empty) {
                        reportDiv.innerHTML += `<div class='log-entry log-error'>‚ùå ${bookPrettyName}: 0 vers√≠culos (Slug testado: ${bookSlug}_)</div>`;
                    } else {
                        // Processar vers√≠culos deste livro
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            processDoc(data);
                            totalVersesFound++;
                        });
                        reportDiv.innerHTML += `<div class='log-entry log-info'>üì• ${bookPrettyName}: ${snapshot.size} vers√≠culos.</div>`;
                    }

                    // Atualiza barra
                    const pct = ((i + 1) / selectedBookNames.length) * 100;
                    document.getElementById('progressFill').style.width = pct + "%";
                }

                status.innerText = `Conclu√≠do! Total: ${totalVersesFound} vers√≠culos.`;
                btn.disabled = false;

                // 4. Mostrar e Validar
                document.getElementById('jsonOutput').value = JSON.stringify(extractedData, null, 2);
                validateData(selectedBookNames);

            } catch (e) {
                alert("Erro: " + e.message);
                console.error(e);
                btn.disabled = false;
            }
        }

        function processDoc(data) {
            const rawName = data.nome; // "1 Cor√≠ntios 10:1"
            const text = data.texto;

            // Regex para separar "Nome do Livro Capitulo:Versiculo"
            // Pega tudo at√© o ultimo espa√ßo como nome, depois numeros
            const match = rawName.match(/^(.*)\s+(\d+):(\d+)$/);

            if (match) {
                const bookName = match[1].trim(); 
                const chapter = parseInt(match[2]);
                const verse = parseInt(match[3]);

                if (!extractedData[bookName]) extractedData[bookName] = {};
                if (!extractedData[bookName][chapter]) extractedData[bookName][chapter] = {};
                
                extractedData[bookName][chapter][verse] = text;
            }
        }

        function validateData(selectedNames) {
            const reportDiv = document.getElementById('validationReport');
            reportDiv.innerHTML += "<br><strong>--- Valida√ß√£o Estrutural ---</strong>";
            let errors = 0;

            // Validar APENAS os livros que o usu√°rio pediu
            const booksToValidate = BIBLE_DATA.filter(b => selectedNames.includes(b.nome));

            booksToValidate.forEach(bookMeta => {
                const bookName = bookMeta.nome;
                
                // Encontrar no JSON extra√≠do (usando slug para garantir match)
                const extractedKeys = Object.keys(extractedData);
                const extractedBookKey = extractedKeys.find(k => slugify(k) === slugify(bookName));
                
                if (!extractedBookKey) {
                    return; // J√° reportado como erro no loop
                }

                const bookContent = extractedData[extractedBookKey];
                
                for (let c = 1; c <= bookMeta.caps; c++) {
                    const expectedVerses = bookMeta.versiculos[c-1];
                    
                    if (!bookContent[c]) {
                        reportDiv.innerHTML += `<div class='log-entry log-error'>‚ö†Ô∏è <strong>${bookName} Cap. ${c}</strong>: Cap√≠tulo em falta.</div>`;
                        errors++;
                        continue;
                    }

                    const foundVersesCount = Object.keys(bookContent[c]).length;
                    if (foundVersesCount !== expectedVerses) {
                        let missing = [];
                        for(let v=1; v<=expectedVerses; v++) if(!bookContent[c][v]) missing.push(v);
                        
                        // Resumir a lista de faltas se for muito grande
                        let missingStr = missing.join(', ');
                        if (missing.length > 10) missingStr = missing.slice(0, 10).join(', ') + "...";

                        reportDiv.innerHTML += `<div class='log-entry log-error'>‚ö†Ô∏è <strong>${bookName} ${c}</strong>: ${foundVersesCount}/${expectedVerses}. Faltam: ${missingStr}</div>`;
                        errors++;
                    }
                }
            });

            if (errors === 0) {
                reportDiv.innerHTML += `<div class='log-entry log-success' style='margin-top:10px;'>üéâ Valida√ß√£o perfeita! Nenhum vers√≠culo em falta nos livros baixados.</div>`;
            } else {
                reportDiv.innerHTML += `<div class='log-entry' style='margin-top:10px;'>Fim da valida√ß√£o. Total de erros: ${errors}</div>`;
            }
        }

        function downloadJson() {
            const text = document.getElementById("jsonOutput").value;
            if (!text) return;
            const blob = new Blob([text], {type: "application/json"});
            const anchor = document.createElement("a");
            anchor.download = "biblia_firebase_completa.json";
            anchor.href = window.URL.createObjectURL(blob);
            anchor.click();
        }
    </script>
</body>
</html>
