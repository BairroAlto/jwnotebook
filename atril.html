<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - Atril</title>
<style>
    :root {
        --bg-color: #1a1a1d;
        --panel-color: #252528;
        --accent-color: #4a90e2;
        --text-color: #f0f0f0;
        --text-muted: #888;
        --border-color: #333;
        --hover-color: #2c2c30;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    body { 
        background-color: var(--bg-color); 
        color: var(--text-color); 
        height: 100vh; 
        display: flex; 
        overflow: hidden; /* Impede scroll na p√°gina inteira */
    }

    /* --- LAYOUT PRINCIPAL (DIVIS√ÉO 60/40) --- */
    #atril-container { 
        display: flex; 
        width: 100%; 
        height: 100%; 
    }

    /* COLUNA DA ESQUERDA (60%) - PALCO */
    #stage-panel {
        flex: 6;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        background-color: var(--bg-color);
        padding: 0;
        overflow: hidden; /* O scroll √© interno na lista */
    }

    /* COLUNA DA DIREITA (40%) - PESQUISA */
    #search-panel {
        flex: 4;
        background-color: var(--panel-color);
        display: flex;
        flex-direction: column; /* Pilha vertical r√≠gida */
        border-left: 1px solid var(--border-color);
        box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        height: 100%;
        overflow: hidden;
    }

    /* --- CABE√áALHOS --- */
    .panel-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0; /* Nunca encolhe */
        background-color: var(--bg-color);
    }

    /* --- BARRA DE PESQUISA (FIXA NO TOPO) --- */
    .search-wrapper { 
        padding: 15px; 
        border-bottom: 1px solid var(--border-color); 
        flex-shrink: 0; /* Nunca encolhe */
        background-color: var(--panel-color);
    }
    
    #atril-search-input {
        width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color);
        border-radius: 6px; color: white; font-size: 16px; outline: none;
    }
    #atril-search-input:focus { border-color: var(--accent-color); }

    /* --- BARRA DE FILTROS (FIXA E COM SCROLL HORIZONTAL) --- */
   .filter-bar {
    display: flex; 
    gap: 4px; /* Espa√ßo reduzido entre √≠cones (era 8px) */
    padding: 10px 10px; 
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color); 
    background: rgba(0,0,0,0.2);
    
    /* Alinha √† esquerda e impede que se espalhem */
    justify-content: flex-start; 
    flex-shrink: 0 !important; 
    height: 60px;
    align-items: center;
    
    scrollbar-width: none;
}
    .filter-bar::-webkit-scrollbar { display: none; } /* Chrome */

    .filter-btn {
        background: none; 
        border: 1px solid transparent; 
        cursor: pointer; 
        font-size: 20px;
        padding: 5px; 
        border-radius: 5px; 
        transition: all 0.2s; 
        opacity: 0.6; 
        
        /* Garante tamanho do bot√£o */
        min-width: 40px;
        height: 40px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; /* CR√çTICO: Impede esmagamento */
    }
    
    .filter-btn:hover { opacity: 1; background: var(--hover-color); }
    .filter-btn.active { opacity: 1; background: rgba(74, 144, 226, 0.2); border-color: var(--accent-color); transform: scale(1.1); }

    /* --- √ÅREA DE RESULTADOS (COM SCROLL) --- */
    .results-list, .stage-list {
        list-style: none; 
        padding: 10px; 
        
        /* Ocupa o resto do espa√ßo e ativa scroll */
        flex-grow: 1; 
        overflow-y: auto; 
        height: 100%;
    }

    /* --- CART√ÉO DE ITEM --- */
    .atril-card {
        background: var(--bg-color); border: 1px solid var(--border-color);
        border-radius: 6px; padding: 12px; margin-bottom: 10px;
        cursor: grab; transition: all 0.2s; 
        position: relative; /* Necess√°rio para o bot√£o absoluto */
        display: flex; flex-direction: column; gap: 5px;
        
        /* Espa√ßo seguro para o bot√£o n√£o tapar texto */
        padding-right: 90px !important; 
        min-height: 85px;
    }
    .atril-card:hover { border-color: var(--accent-color); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px; }
    .card-type { font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
    .card-source { font-style: italic; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .card-content { font-size: 0.95em; line-height: 1.4; max-height: 100px; overflow: hidden; color: #ddd; position: relative; }
    .card-content::after {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 20px;
        background: linear-gradient(transparent, var(--bg-color));
    }

    /* Bot√£o para Mover (Direita -> Esquerda) */
    .btn-move-left {
        position: absolute; 
        
        /* Centrado verticalmente */
        top: 50%; 
        transform: translateY(-50%);
        right: 10px;
        
        background: var(--panel-color); 
        color: var(--accent-color);
        border: 1px solid var(--accent-color); 
        border-radius: 4px;
        cursor: pointer; padding: 4px 10px; 
        font-size: 12px; font-weight: bold;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        display: none;
    }
    .atril-card:hover .btn-move-left { display: block; }

    /* --- ESTILOS DO PALCO (ESQUERDA) --- */
    #stage-list { padding: 20px; }
    #stage-list .atril-card {
        background: var(--panel-color); cursor: default;
        padding-right: 12px !important; /* Remove espa√ßo extra no palco */
    }
    #stage-list .card-content { max-height: none; overflow: visible; }
    #stage-list .card-content::after { display: none; }
    #stage-list .btn-move-left { display: none !important; }

    .stage-controls {
        display: flex; justify-content: flex-end; gap: 5px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 5px;
    }
    .stage-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; padding: 2px 6px; border-radius: 3px; }
    .stage-btn:hover { background: var(--hover-color); color: white; }
    .btn-remove:hover { color: #e74c3c; border-color: #e74c3c; }

    /* Loader */
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 20px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Scrollbars Modernas */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* ============================================================
       CORRE√á√ÉO VISUAL DO CONTE√öDO (LIMPEZA DOS CART√ïES)
       ============================================================ */

    /* 1. ESCONDER TOOLBARS INTERNAS E BOT√ïES DE EDI√á√ÉO */
    /* Isto remove o lixo visual (lixo, paleta, cadeado) de dentro do preview */
    .atril-card .mini-note-toolbar,
    .atril-card .redator-top-tools,
    .atril-card .redator-dock,
    .atril-card .sign-toolbar,
    .atril-card .card-toolbar,
    .atril-card .cube-toolbar,
    .atril-card .toggle-delete-btn,
    .atril-card .ghost-actions,
    .atril-card .ghost-add-between-btn {
        display: none !important;
    }

    /* 2. TRANSFORMAR INPUTS/TEXTAREAS EM "TEXTO LIMPO" */
    /* Remove bordas e fundos dos t√≠tulos para parecerem texto normal */
    .atril-card .mini-note-title-input,
    .atril-card .redator-input,
    .atril-card .sign-title-input,
    .atril-card .card-title-input {
        border: none !important;
        background: transparent !important;
        resize: none !important;
        pointer-events: none !important; /* Impede clicar/editar */
        box-shadow: none !important;
        width: 100% !important;
        padding: 0 !important;
        color: var(--accent-color) !important; /* Destaca o t√≠tulo */
        font-weight: bold !important;
        min-height: auto !important;
        height: auto !important;
        overflow: hidden !important;
        white-space: pre-wrap !important;
        margin-bottom: 5px !important;
    }

    /* 3. AJUSTAR OS WRAPPERS (CAIXAS) */
    /* Garante que a caixa cabe bem e mant√©m a cor lateral */
    .atril-card .mini-note-wrapper,
    .atril-card .redator-wrapper,
    .atril-card .journal-sign-wrapper,
    .atril-card .ref-depot-wrapper {
        margin: 0 !important;
        width: 100% !important;
        box-shadow: none !important;
        min-height: auto !important;
        background: transparent !important; /* Remove fundo pesado */
        border: none !important;
        border-left-width: 3px !important; /* Mant√©m s√≥ a linha colorida √† esquerda */
        border-left-style: solid !important;
        padding: 0 0 0 10px !important; /* Espa√ßo entre linha e texto */
    }

    /* 4. AJUSTE DO TEXTO DO CORPO */
    .atril-card .mini-note-content,
    .atril-card .redator-content,
    .atril-card .sign-content {
        padding: 0 !important;
        min-height: auto !important;
        color: var(--text-muted) !important;
        pointer-events: none !important;
        font-size: 0.9em !important;
    }

    /* Corre√ß√£o espec√≠fica para a altura do cart√£o */
    .atril-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

/* ============================================================
       LIMPEZA TOTAL DO PALCO (COLUNA ESQUERDA - VISUALIZA√á√ÉO PURA)
       ============================================================ */

    /* 1. Esconder TODOS os bot√µes e √≠cones funcionais dentro do cart√£o */
    #stage-list .atril-card .redator-reopen-btn,       /* Bot√£o T */
    #stage-list .atril-card .redator-collapsed-menu-btn, /* Bot√£o Menu Flutuante */
    #stage-list .atril-card .redator-menu-trigger,       /* Bot√£o 3 pontos */
    #stage-list .atril-card .redator-dock,               /* Dock inferior */
    #stage-list .atril-card .ghost-actions,              /* Bot√µes do Aqu√°rio */
    #stage-list .atril-card button:not(.stage-btn) {     /* Qualquer outro bot√£o interno */
        display: none !important;
    }

    /* 2. Limpar T√≠tulos (Remover "T√≠tulo do Redator..." se estiver vazio) */
    #stage-list .atril-card input::placeholder,
    #stage-list .atril-card textarea::placeholder {
        color: transparent !important;
    }
    
    /* Remove intera√ß√£o dos inputs */
    #stage-list .atril-card input,
    #stage-list .atril-card textarea {
        pointer-events: none !important;
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin-bottom: 2px !important;
    }

    /* 3. Neutralizar Links no Texto */
    #stage-list .atril-card .card-content a,
    #stage-list .atril-card .entity-link {
        pointer-events: none !important;      /* N√£o clic√°vel */
        text-decoration: none !important;     /* Sem sublinhado */
        color: inherit !important;            /* Cor igual ao texto normal */
        cursor: default !important;
        background-color: transparent !important; /* Remove fundo de destaque */
        border-bottom: none !important;
    }

    /* 4. Ajuste Espec√≠fico para o Redator (Remover caixas e sombras) */
    #stage-list .atril-card .redator-wrapper {
        box-shadow: none !important;
        background: transparent !important;
        border: none !important;
        /* Mant√©m apenas uma linha fina discreta √† esquerda */
        border-left: 2px solid #444 !important; 
        padding: 0 0 0 10px !important;
        margin: 0 !important;
        min-height: auto !important;
    }

    #stage-list .atril-card .redator-header {
        padding: 0 !important;
        border: none !important;
        height: auto !important;
        opacity: 1 !important; /* Garante que o t√≠tulo se v√™ se existir */
    }

    #stage-list .atril-card .redator-content {
        padding: 0 !important;
        color: var(--text-muted) !important;
    }
    
    /* --- CORRE√á√ÉO: TEXTO BRANCO NO CONTE√öDO (PALCO) --- */
    #stage-list .card-content,
    #stage-list .atril-card .mini-note-content,
    #stage-list .atril-card .redator-content,
    #stage-list .atril-card .sign-content,
    #stage-list .atril-card .toggle-content,
    #stage-list .atril-card p,
    #stage-list .atril-card div {
        color: #ffffff !important; /* Branco Puro */
        opacity: 1 !important;     /* Remove transpar√™ncia */
        text-shadow: none !important;
    }

    /* ============================================================
       CORRE√á√ÉO FINAL: BLOQUEIO DE EDI√á√ÉO + ESTILO DA GRUA
       ============================================================ */

    /* --- 1. BLOQUEAR EDI√á√ÉO EM TUDO (GHOST, NOTAS, ETC) --- */
    #stage-list .atril-card [contenteditable],
    #stage-list .atril-card input,
    #stage-list .atril-card textarea {
        pointer-events: none !important;      /* Impede clicar para escrever */
        border: none !important;              /* Remove bordas de input */
        outline: none !important;             /* Remove contorno azul */
        background: transparent !important;   /* Remove fundo branco/preto */
        box-shadow: none !important;          /* Remove sombras */
        resize: none !important;              /* Remove canto de redimensionar */
        color: white !important;              /* For√ßa texto branco */
        min-height: auto !important;
        padding: 0 !important;
    }

    /* Remove especificamente a borda branca do Ghost que aparece na imagem */
    #stage-list .atril-card .ghost-block {
        border: none !important;
        padding: 0 !important;
    }

    /* --- 2. ESTILO VISUAL DA GRUA (DEP√ìSITO) --- */
    
    /* Contentor Principal da Grua no Palco */
    #stage-list .ref-depot-wrapper {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        box-shadow: none !important;
        margin: 0 !important;
    }

    /* T√≠tulo da Grua */
    #stage-list .depot-header {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 10px;
        padding-bottom: 5px;
    }
    
    #stage-list .depot-title {
        font-size: 1.1em !important;
        color: #f39c12 !important; /* Laranja */
        font-weight: bold !important;
    }

    /* Esconder bot√µes de controlo da Grua (Lixo, Adicionar, Setas) */
    #stage-list .depot-btn,
    #stage-list .depot-toggle-icon,
    #stage-list .depot-del-card,
    #stage-list .btn-add-link-bottom {
        display: none !important;
    }

    /* Estilo das Categorias (Pastas) */
    #stage-list .depot-category, 
    #stage-list .depot-subtitle {
        margin-left: 10px;
        padding: 5px 0;
        border-left: 2px solid rgba(255,255,255,0.1);
        padding-left: 10px;
    }

    /* T√≠tulos das Categorias */
    #stage-list .depot-input-title {
        font-weight: bold !important;
        color: #aaa !important;
        font-size: 0.9em !important;
        text-transform: uppercase;
    }

    /* --- CART√ïES DE LINK (O que estava desarrumado) --- */
    #stage-list .depot-link-card {
        background-color: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 4px;
        padding: 8px !important;
        margin-top: 5px;
        margin-bottom: 5px;
        display: flex;
        flex-direction: column;
    }

    /* Descri√ß√£o do Link */
    #stage-list .depot-desc {
        font-weight: bold !important;
        font-size: 0.95em !important;
        color: white !important;
        margin-bottom: 2px !important;
    }

    /* O URL em si (Corta se for comprido) */
    #stage-list .depot-url {
        font-family: monospace !important;
        font-size: 0.8em !important;
        color: var(--accent-color) !important;
        opacity: 0.8;
        
        /* Truncar texto longo (...) */
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        display: block !important;
        width: 100% !important;
    }

    /* Esconde a linha do input url e o bot√£o de visitar para ficar mais limpo */
    #stage-list .depot-url-row {
        display: block !important; /* Muda de flex para block para o ellipsis funcionar */
    }
    #stage-list .depot-visit-btn {
        display: none !important;
    }

/* Classes para indicar onde o item vai cair */
    .atril-card.drop-target-top {
        border-top: 4px solid var(--accent-color) !important;
        margin-top: 0 !important; /* Ajuste fino */
    }
    
    .atril-card.drop-target-bottom {
        border-bottom: 4px solid var(--accent-color) !important;
        margin-bottom: 0 !important; /* Ajuste fino */
    }

/* Refor√ßo visual para o primeiro item */
    #stage-list li:first-child.drop-target-top {
        margin-top: 10px !important; /* Cria espa√ßo f√≠sico para a barra azul */
        position: relative;
    }
    
    /* Garante que o painel tem espa√ßo no topo para arrastar */
    #stage-panel {
        padding-top: 10px !important; 
    }

</style>


</head>
<body>

<div id="atril-container">
    <!-- COLUNA ESQUERDA: PALCO (ORGANIZA√á√ÉO) -->
    <div id="stage-panel">
        <div class="panel-header">
            <span>üóÇÔ∏è Atril de Montagem</span>
            <button onclick="window.close()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Fechar ‚úñ</button>
        </div>
        <div id="stage-empty-msg" style="text-align:center; color: #555; margin-top: 50px;">
            <h3>O Atril est√° vazio</h3>
            <p>Use a pesquisa √† direita para encontrar blocos e mov√™-los para aqui.</p>
        </div>
        <ul id="stage-list" class="stage-list"></ul>
    </div>

    <!-- COLUNA DIREITA: PESQUISA (FONTE) -->
    <div id="search-panel">
        <div class="search-wrapper">
            <input type="text" id="atril-search-input" placeholder="üîç Pesquisar no conte√∫do...">
        </div>
        
        <div class="filter-bar" id="filter-bar">
            <button class="filter-btn" data-filter="text_body" title="Texto da Nota">üåç</button>
            <button class="filter-btn" data-filter="subnote" title="Subnotas">üìò</button>
            <button class="filter-btn" data-filter="question" title="Quest√µes">üìó</button>
            <button class="filter-btn" data-filter="container" title="Contentores">üìô</button>
            <button class="filter-btn" data-filter="redator" title="Redator">üìì</button>
            <button class="filter-btn" data-filter="postit" title="Post-its">üìí</button>
            <button class="filter-btn" data-filter="puzzle" title="Quadro 4¬™ Coluna">üìÑ</button>
            <button class="filter-btn" data-filter="idea" title="Ideias">üí°</button>
            <button class="filter-btn" data-filter="timeline" title="Timeline">üå≥</button>
            <button class="filter-btn" data-filter="depot" title="Grua">üèóÔ∏è</button>
            <button class="filter-btn" data-filter="sign" title="Racioc√≠nio">ü™ß</button>
            <button class="filter-btn" data-filter="card" title="Cart√£o">ü™™</button>
            <button class="filter-btn" data-filter="ghost" title="Aqu√°rio">ü™∏</button>
        </div>

        <ul id="search-results-list" class="results-list">
            <li style="text-align:center; color:#666; padding:20px;">Digite algo para pesquisar...</li>
        </ul>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
 
<script type="module">
    import { db, auth } from './js/firebase-config.js';
 import { collection, query, where, getDocs, orderBy, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    // ESTADO
    let currentFilter = 'all';
    let allFoundItems = [];
    let stageItems = [];
    let searchQuery = "";
    
    // PAGINA√á√ÉO
    let currentVisibleCount = 20; 
    const ITEMS_PER_LOAD = 20;

    // LOGIN
    onAuthStateChanged(auth, async (user) => {
        // 1. VERIFICA√á√ÉO: UTILIZADOR N√ÉO AUTENTICADO
        if (!user) {
            console.warn("‚õî Acesso n√£o autorizado. Redirecionando para 404...");
            window.location.href = "404.html";
            return;
        } 
        
        // 2. VERIFICA√á√ÉO: UTILIZADOR AUTENTICADO
        else {
            try {
                // Consulta o perfil na base de dados
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                // Se o documento n√£o existe ou 'aceite' n√£o √© 'on'
                if (!userDocSnap.exists() || userDocSnap.data().aceite !== "on") {
                    console.warn("‚è≥ Conta pendente. Redirecionando...");
                    window.location.href = "index.html"; // Volta para a tela de espera
                    return;
                }

                // --- SUCESSO: CONTA APROVADA ---
                console.log("üîê Acesso Confirmado. Atril pronto.");
                
                // Inicializa√ß√£o da Interface
                document.getElementById('search-results-list').innerHTML = 
                    '<li style="text-align:center; color:#666; padding:20px;">Escreva na caixa acima para come√ßar.</li>';

            } catch (error) {
                console.error("Erro de seguran√ßa:", error);
                window.location.href = "index.html";
            }
        }
    });

    // LISTENERS
    document.getElementById('atril-search-input').addEventListener('input', (e) => {
        searchQuery = e.target.value.trim();
        if (searchQuery.length === 0) {
            document.getElementById('search-results-list').innerHTML = '<li style="text-align:center; color:#666; padding:20px;">A aguardar pesquisa...</li>';
            allFoundItems = [];
            return;
        }
        debounceSearch(searchQuery);
    });

    document.getElementById('filter-bar').addEventListener('click', (e) => {
        const btn = e.target.closest('.filter-btn');
        if (!btn) return;

        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        currentFilter = btn.dataset.filter;
        currentVisibleCount = ITEMS_PER_LOAD; 
        renderRightColumn();
    });

    let debounceTimer;
    function debounceSearch(val) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => performSearch(val), 800);
    }

    // --- FUN√á√ïES AUXILIARES DE TEXTO ---
    function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function parseSearchQuery(query) {
        if (!query) return [];
        const terms = [];
        const regex = /"([^"]+)"|(\S+)/g;
        let match;
        while ((match = regex.exec(query)) !== null) {
            if (match[1]) terms.push({ text: match[1], exact: true }); // Com aspas = exato
            else if (match[2]) terms.push({ text: match[2], exact: false }); // Sem aspas = ignora acentos
        }
        return terms;
    }

    function checkMatch(text, terms) {
        if (!text) return false;
        if (terms.length === 0) return true;
        
        // Prepara textos para compara√ß√£o
        const rawText = text.toLowerCase();
        const normalizedText = removeAccents(rawText);

        return terms.every(term => {
            const termLower = term.text.toLowerCase();
            
            if (term.exact) {
                // Se tem aspas ("J√≥"), procura exato
                return rawText.includes(termLower);
            } else {
                // Se n√£o tem aspas (J√≥), normaliza ambos (Jo encontra J√≥)
                return normalizedText.includes(removeAccents(termLower));
            }
        });
    }

    // --- MOTOR DE PESQUISA ---
 async function performSearch(text) {
        if (!text) return;
        console.log(`üîé Pesquisando por: "${text}"`);

        const list = document.getElementById('search-results-list');
        list.innerHTML = '<div class="spinner"></div>';
        
        allFoundItems = [];
        currentVisibleCount = ITEMS_PER_LOAD;

        try {
            const uid = auth.currentUser.uid;
            
            // 1. QUERY NAS PASTAS
            const q = query(
                collection(db, 'pastas'),
                where('userId', '==', uid),
                where('estado', '==', 'ativa'),
                orderBy('ultimaedicao', 'desc'),
                limit(50) 
            );

            const snapshot = await getDocs(q);
            const parser = new DOMParser();
            const terms = parseSearchQuery(text);

            snapshot.forEach(doc => {
                const data = doc.data();
                const noteTitle = data.nome || "Sem T√≠tulo";

                // --- PREPARA√á√ÉO DAS FONTES DE HTML (CORRE√á√ÉO) ---
                let sourcesToScan = [];

                // A. Conte√∫do Principal (Notas, Aqu√°rios)
                if (data.conteudo) {
                    sourcesToScan.push({ html: data.conteudo, sourceLabel: noteTitle });
                }

                // B. Posts de Arquivo (Feed)
                if (data.posts && Array.isArray(data.posts)) {
                    data.posts.forEach(post => {
                        sourcesToScan.push({ 
                            html: post.content || "", 
                            sourceLabel: `${noteTitle} > ${post.title || "Post"}` 
                        });
                    });
                }

                // --- ITERAR SOBRE AS FONTES ---
                sourcesToScan.forEach(src => {
                    const docHTML = parser.parseFromString(src.html, 'text/html');

                    // =========================================================
                    // 1. PESQUISA NO TEXTO LIVRE (FILTRO MUNDO üåç)
                    // =========================================================
                    if (currentFilter === 'all' || currentFilter === 'text_body') {
                        // Clona para limpar
                        const cleanClone = docHTML.body.cloneNode(true);
                        
                        // Remove TODAS as caixas conhecidas
                        const widgetsToRemove = cleanClone.querySelectorAll(
                            '.mini-note-wrapper, .redator-wrapper, .post-it-note, ' + 
                            '.journal-sign-wrapper, .journal-id-card, .jwn-timeline-wrapper, ' + 
                            '.ref-depot-wrapper, .journal-cube-wrapper, .ghost-block, details.toggle-section'
                        );
                        widgetsToRemove.forEach(el => el.remove());

                        // Texto que sobra
                        const freeText = cleanClone.innerText.trim();
                        
                        if (freeText && checkMatch(freeText, terms)) {
                            // Criar snippet
                            const firstTerm = terms[0].text.toLowerCase();
                            const index = removeAccents(freeText.toLowerCase()).indexOf(removeAccents(firstTerm));
                            let snippet = freeText;
                            
                            if (index !== -1) {
                                const start = Math.max(0, index - 50);
                                const end = Math.min(freeText.length, index + 50);
                                snippet = "..." + freeText.substring(start, end) + "...";
                            } else {
                                snippet = freeText.substring(0, 100) + "...";
                            }

                            allFoundItems.push({
                                id: `free_${doc.id}_${Math.random().toString(36).substr(2,5)}`,
                                type: 'text_body',
                                icon: 'üåç',
                                title: "Texto da Nota",
                                content: snippet,
                                html: `<div class="card-content" style="white-space: pre-wrap;">${snippet}</div>`,
                                sourceName: src.sourceLabel,
                                timestamp: data.ultimaedicao?.toMillis() || 0
                            });
                        }
                    }

                    // =========================================================
                    // 2. PESQUISA DENTRO DAS CAIXAS (OUTROS FILTROS)
                    // =========================================================
                    const extractors = [
                        { selector: '.mini-note-wrapper:not(.question-mode):not(.free-mode)', type: 'subnote', icon: 'üìò' },
                        { selector: '.mini-note-wrapper.question-mode', type: 'question', icon: 'üìó' },
                        { selector: '.mini-note-wrapper.free-mode', type: 'container', icon: 'üìô' },
                        { selector: '.redator-wrapper', type: 'redator', icon: 'üìì' },
                        { selector: '.post-it-note', type: 'postit', icon: 'üìí' },
                        { selector: '.idea-span', type: 'idea', icon: 'üí°' },
                        { selector: '.jwn-timeline-wrapper', type: 'timeline', icon: 'üå≥' },
                        { selector: '.ref-depot-wrapper', type: 'depot', icon: 'üèóÔ∏è' },
                        { selector: '.journal-sign-wrapper', type: 'sign', icon: 'ü™ß' },
                        { selector: '.journal-id-card', type: 'card', icon: 'ü™™' },
                        { selector: '.ghost-block', type: 'ghost', icon: 'ü™∏' }
                    ];

                    extractors.forEach(ext => {
                        docHTML.querySelectorAll(ext.selector).forEach(el => {
                            let title = extractTitle(el, ext.type);
                            let body = extractBody(el, ext.type);
                            
                            if (checkMatch(title + " " + body, terms)) {
                                allFoundItems.push({
                                    id: `item_${doc.id}_${Math.random().toString(36).substr(2,9)}`,
                                    type: ext.type,
                                    icon: ext.icon,
                                    title: title,
                                    content: body,
                                    html: el.outerHTML,
                                    sourceName: src.sourceLabel,
                                    timestamp: data.ultimaedicao?.toMillis() || 0
                                });
                            }
                        });
                    });
                });
            });

            // 2. QUERY NA 4¬™ COLUNA (Puzzle/Textos)
            if (currentFilter === 'all' || currentFilter === 'puzzle') {
                const collections = ['textosbiblicos', 'topicos', 'personagens'];
                for (const col of collections) {
                    const qRef = query(collection(db, col), where('userId', '==', uid), limit(20));
                    const snapRef = await getDocs(qRef);
                    snapRef.forEach(doc => {
                        const data = doc.data();
                        if (data.puzzleBoard) {
                            data.puzzleBoard.forEach(card => {
                                if (card.type === 'text' && checkMatch(card.content, terms)) {
                                    allFoundItems.push({
                                        id: `pz_${doc.id}_${Math.random()}`,
                                        type: 'puzzle',
                                        icon: 'üìÑ',
                                        title: "Texto de Quadro",
                                        content: card.content,
                                        html: `<div class="board-card">${card.content}</div>`,
                                        sourceName: data.nome,
                                        timestamp: 0
                                    });
                                }
                            });
                        }
                    });
                }
            }

            console.log(`‚úÖ Encontrados ${allFoundItems.length} resultados.`);
            
            // Ordenar por data (mais recente primeiro)
            allFoundItems.sort((a, b) => b.timestamp - a.timestamp);
            renderRightColumn();

        } catch (e) {
            console.error("Erro na pesquisa:", e);
            list.innerHTML = `<li style="color:#e74c3c; padding:20px;">Erro: ${e.message}</li>`;
        }
    }

    // --- RENDERIZA√á√ÉO ---
    function renderRightColumn() {
        const list = document.getElementById('search-results-list');
        list.innerHTML = '';

        const filtered = currentFilter === 'all' 
            ? allFoundItems 
            : allFoundItems.filter(i => i.type === currentFilter);

        const available = filtered.filter(item => !stageItems.some(s => s.id === item.id));

        if (available.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#666; padding:20px;">Sem resultados.</li>';
            return;
        }

        const itemsToShow = available.slice(0, currentVisibleCount);

        itemsToShow.forEach(item => {
            const li = document.createElement('li');
            li.className = 'atril-card';
            li.draggable = true;
            
            li.innerHTML = `
                <div class="card-header">
                    <span class="card-type">${item.icon} ${item.type}</span>
                    <span class="card-source">üìÑ ${item.sourceName}</span>
                </div>
                <div class="card-content">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</div>
                <button class="btn-move-left" onclick="window.moveToStage('${item.id}')">‚¨Ö Mover</button>
            `;

            li.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.id);
                li.style.opacity = '0.5';
            });
            li.addEventListener('dragend', () => { li.style.opacity = '1'; });

            list.appendChild(li);
        });

        // Bot√£o Carregar Mais
        if (available.length > currentVisibleCount) {
            const remaining = available.length - currentVisibleCount;
            const btn = document.createElement('button');
            btn.className = "filter-btn";
            btn.style.cssText = "width:100%; margin-top:10px; border-radius:6px; font-size:14px; opacity:1; border:1px solid var(--accent-color); color:var(--accent-color); justify-content: center;";
            btn.textContent = `Carregar mais ${Math.min(remaining, ITEMS_PER_LOAD)}...`;
            
            btn.onclick = () => {
                currentVisibleCount += ITEMS_PER_LOAD;
                renderRightColumn();
            };
            
            list.appendChild(btn);
        }
    }

    // --- RENDERIZAR PALCO (ESQUERDA) ---
    function renderStage() {
        const list = document.getElementById('stage-list');
        const emptyMsg = document.getElementById('stage-empty-msg');
        list.innerHTML = '';
        if (stageItems.length === 0) { emptyMsg.style.display = 'block'; return; }
        emptyMsg.style.display = 'none';

        stageItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'atril-card';
            li.innerHTML = `
                <div class="card-header">
                    <span class="card-type">${item.icon} ${item.type}</span>
                    <span class="card-source">üìÑ ${item.sourceName}</span>
                </div>
                <div class="card-content">${item.html}</div>
                <div class="stage-controls">
                    <button class="stage-btn" onclick="window.reorderStage(${index}, -1)">‚ñ≤</button>
                    <button class="stage-btn" onclick="window.reorderStage(${index}, 1)">‚ñº</button>
                    <button class="stage-btn btn-remove" onclick="window.removeFromStage('${item.id}')">üóëÔ∏è Remover</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // FUN√á√ïES GLOBAIS
    window.moveToStage = (id) => {
        const item = allFoundItems.find(i => i.id === id);
        if (item) { stageItems.push(item); renderStage(); renderRightColumn(); }
    };
    window.removeFromStage = (id) => {
        stageItems = stageItems.filter(i => i.id !== id);
        renderStage(); renderRightColumn();
    };
    window.reorderStage = (index, dir) => {
        const newIndex = index + dir;
        if (newIndex >= 0 && newIndex < stageItems.length) {
            [stageItems[index], stageItems[newIndex]] = [stageItems[newIndex], stageItems[index]];
            renderStage();
        }
    };

    // EXTRA√á√ÉO DE DADOS
    function extractTitle(el, type) {
        if (type === 'redator' || type === 'card' || type === 'sign') {
            const input = el.querySelector('input');
            return input ? input.value : "Sem T√≠tulo";
        }
        if (type === 'subnote' || type === 'question') {
            const input = el.querySelector('.mini-note-title-input');
            return input ? (input.value || input.textContent) : "Sem T√≠tulo";
        }
        if (type === 'ghost') return "Bloco Aqu√°rio";
        return type.toUpperCase();
    }

    function extractBody(el, type) {
        const contentDiv = el.querySelector('.mini-note-content, .redator-content, .card-desc-content, .sign-content, .cube-content');
        if (contentDiv) return contentDiv.innerText.trim();
        if (type === 'ghost') return el.innerText.trim();
        if (type === 'postit') { const c = el.querySelector('.post-it-content'); return c ? c.innerText.trim() : ""; }
        if (type === 'idea') return el.textContent;
        return "Conte√∫do visual";
    }

    // Drag Drop Palco
 const stagePanel = document.getElementById('stage-panel');
    const stageList = document.getElementById('stage-list');
    
    let dropTargetIndex = null; // Guarda o √≠ndice onde vamos largar

    // 1. DRAG OVER (Calcular onde encaixar)
     stagePanel.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        
        const targetCard = e.target.closest('.atril-card');
        const listRect = stageList.getBoundingClientRect();

        // Limpa estilos antigos
        document.querySelectorAll('.drop-target-top, .drop-target-bottom').forEach(el => {
            el.classList.remove('drop-target-top', 'drop-target-bottom');
        });

        // CASO ESPECIAL: Rato acima do primeiro cart√£o (Topo Absoluto)
        if (e.clientY < listRect.top + 10 && stageList.children.length > 0) {
            stageList.firstElementChild.classList.add('drop-target-top');
            dropTargetIndex = 0;
            return; // Sai daqui, j√° decidimos
        }

        if (targetCard && stageList.contains(targetCard)) {
            const rect = targetCard.getBoundingClientRect();
            const midY = rect.top + (rect.height / 2);
            const cardIndex = Array.from(stageList.children).indexOf(targetCard);

            if (e.clientY < midY) {
                targetCard.classList.add('drop-target-top');
                dropTargetIndex = cardIndex;
            } else {
                targetCard.classList.add('drop-target-bottom');
                dropTargetIndex = cardIndex + 1;
            }
        } else {
            // Se estiver no vazio no fundo, insere no fim
            dropTargetIndex = stageItems.length;
            stagePanel.style.backgroundColor = "rgba(74, 144, 226, 0.05)";
        }
    });

    // 2. DRAG LEAVE (Limpeza Visual)
    stagePanel.addEventListener('dragleave', (e) => {
        // S√≥ limpa se sair mesmo do painel, n√£o quando entra num filho
        if (e.target === stagePanel) {
            stagePanel.style.backgroundColor = "var(--bg-color)";
            document.querySelectorAll('.drop-target-top, .drop-target-bottom').forEach(el => {
                el.classList.remove('drop-target-top', 'drop-target-bottom');
            });
            dropTargetIndex = null;
        }
    });

    // 3. DROP (Executar o Movimento)
    stagePanel.addEventListener('drop', (e) => {
        e.preventDefault();
        
        // Limpeza visual
        stagePanel.style.backgroundColor = "var(--bg-color)";
        document.querySelectorAll('.drop-target-top, .drop-target-bottom').forEach(el => {
            el.classList.remove('drop-target-top', 'drop-target-bottom');
        });

        const id = e.dataTransfer.getData('text/plain');
        if (!id) return;

        // A. Verificar se o item vem da Direita (Novo) ou da Esquerda (Reordena√ß√£o)
        const itemFromSearch = allFoundItems.find(i => i.id === id);
        const itemInStageIndex = stageItems.findIndex(i => i.id === id);

        // CASO 1: Reordenar dentro do Palco (Esquerda -> Esquerda)
        if (itemInStageIndex > -1) {
            const item = stageItems[itemInStageIndex];
            
            // Remove da posi√ß√£o antiga
            stageItems.splice(itemInStageIndex, 1);
            
            // Ajusta o √≠ndice de destino se necess√°rio
            // (se tir√°mos de cima, os √≠ndices de baixo mudam)
            if (dropTargetIndex > itemInStageIndex) {
                dropTargetIndex--;
            }
            
            // Seguran√ßa
            if (dropTargetIndex < 0) dropTargetIndex = 0;
            if (dropTargetIndex > stageItems.length) dropTargetIndex = stageItems.length;

            // Insere na nova posi√ß√£o
            stageItems.splice(dropTargetIndex, 0, item);
        }
        
        // CASO 2: Mover da Pesquisa (Direita -> Esquerda)
        else if (itemFromSearch) {
            // Se o dropTargetIndex for nulo (arrastou para o vazio), vai para o fim
            if (dropTargetIndex === null) dropTargetIndex = stageItems.length;
            
            // Insere na posi√ß√£o exata calculada
            stageItems.splice(dropTargetIndex, 0, itemFromSearch);
            
            // Atualiza a coluna da direita para remover o item de l√°
            renderRightColumn();
        }

        // Renderiza o resultado final
        renderStage();
        
        // Reset
        dropTargetIndex = null;
    });


    
</script>

</body>
</html>
