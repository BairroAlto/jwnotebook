
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - B√≠ble</title>
        <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczOY7rWSKCJmZbLGggGZ2vWDuDDrBhuLq0jaDOk7-F7QHtiqF5829JfGIU1UQ05rIoOYMT-Yqh_rJzqla7FeevnjwwjzclIJGJOc4jFc2Cb5K_xvEKr3508iNOFUql7oI0u5EpM-flcGFOgzVyhvc8H1=w1005-h873-s-no-gm?authuser=4">


<style>
   :root {
        /* Cores Base */
        --bg-color: #000000;
        --tile-color: #565060;
        --tile-hover: #6d6679;
        --text-color: #ffffff;
        --accent-color: #e67e22; 
        --highlight-bg: rgba(230, 126, 34, 0.15);
        --border-color: #333;
        --panel-color: #1f1f22;
        
        /* Cores Espec√≠ficas dos Modos */
        --question-color: #2ecc71; /* Verde */
        --question-bg: rgba(46, 204, 113, 0.15);

        /* Vari√°veis de Tamanho Din√¢mico */
        --verse-size-pct: 100%; 
        --card-size-pct: 100%;
        --tile-size-pct: 100; /* Novo: Valor num√©rico para c√°lculo de Zoom nos Bot√µes */
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 45px;
        flex-shrink: 0;
    }

    #back-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        min-width: 30px;
    }

    #page-title {
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
        flex-grow: 1;
        text-align: center;
    }

    #settings-btn {
        background: none; 
        border: none; 
        font-size: 1.2rem; 
        cursor: pointer;
        padding: 5px; 
        margin-left: 10px; 
        filter: grayscale(100%); 
        transition: 0.3s;
        min-width: 30px;
    }
    #settings-btn:hover { filter: none; transform: rotate(90deg); }

    /* √ÅREA PRINCIPAL */
    .container { flex: 1; overflow-y: auto; padding: 5px; }
    
    .section-title { 
        font-size: 0.7rem; font-weight: 800; color: #888; 
        margin: 10px 0 5px 0; padding-left: 2px; text-transform: uppercase; 
    }

    /* GRELHA (Livros e Cap√≠tulos) */
   .grid { 
        display: grid; 
        /* 
           AQUI EST√Å A MAGIA: 
           Dizemos ao browser: "Cria tantas colunas quantas couberem (auto-fill), 
           mas cada quadrado tem de ter NO M√çNIMO X largura (calculada pelo zoom)."
           Se n√£o couberem, ele joga para a linha de baixo automaticamente.
           
           Base PC: ~45px por quadrado a 100%
        */
        grid-template-columns: repeat(auto-fill, minmax(calc(45px * (var(--tile-size-pct) / 100)), 1fr)); 
        gap: 3px; 
        padding-bottom: 20px; 
    }
    
   .tile {
        background-color: var(--tile-color); 
        color: var(--text-color); 
        aspect-ratio: 1 / 1; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        
        /* --- CORRE√á√ÉO AQUI --- */
        white-space: nowrap;       /* Obriga o texto a ficar numa linha √∫nica */
        overflow: hidden;          /* Garante que n√£o sai para fora do quadrado */
        text-overflow: clip;       /* Corta suavemente se for demasiado grande */
        padding: 0 2px;            /* Pequena margem lateral de seguran√ßa */
        
        /* Ajustei ligeiramente de 0.8 para 0.75 para garantir que "2 Cr√≥n" cabe bem */
        font-size: calc(0.75rem * (var(--tile-size-pct) / 100));
        
        font-weight: 500; 
        cursor: pointer; 
        transition: background-color 0.2s;
        border-radius: 4px;
    }
    .tile:hover { background-color: var(--tile-hover); }

    @media (max-width: 480px) { 
        .grid { 
            /* Base Mobile mantida */
             grid-template-columns: repeat(auto-fill, minmax(calc(38px * (var(--tile-size-pct) / 100)), 1fr)); 

          padding-bottom: 80px !important;
        } 
        
        .tile { 
            /* Ajuste mobile para garantir que cabe */
            font-size: calc(0.65rem * (var(--tile-size-pct) / 100)); 
        } 
    }


    /* --- LISTA DE VERS√çCULOS --- */
   .verse-list { 
        display: flex; 
        flex-direction: column; 
        gap: 0; 
        padding-bottom: 50px;
        /* PERMITIR SELE√á√ÉO NO CONTENTOR PAI */
        user-select: text !important;
        -webkit-user-select: text !important;
    }
    
    .verse-item { 
        padding: 12px 10px; 
        border-bottom: none; 
        display: flex; 
        gap: 12px; 
        align-items: flex-start; 
        /* Cursor de texto para indicar que √© selecion√°vel, mesmo no vazio */
        cursor: text; 
        /* PERMITIR SELE√á√ÉO ENTRE VERS√çCULOS */
        user-select: text !important;
        -webkit-user-select: text !important;
    }
    
    .verse-number { 
        color: #666; font-weight: bold; font-size: 0.85rem; 
        min-width: 25px; text-align: right; margin-top: 2px; 
        cursor: pointer; padding: 2px 5px; border-radius: 4px; 
        transition: background-color 0.2s; 
    }
    .verse-number:hover { background-color: rgba(255,255,255,0.1); }
    
    .verse-number.has-data { 
        color: var(--accent-color); 
        text-shadow: 0 0 5px rgba(230, 126, 34, 0.4); 
    }
    
  .verse-text { 
        color: #ddd; 
        line-height: 1.6;
        font-size: var(--verse-size-pct);
        
        /* CORRE√á√ÉO CRUCIAL PARA SELE√á√ÉO DO "V√ÅCUO" */
        flex: 1; /* Ocupa todo o espa√ßo restante √† direita */
        display: block; /* Garante que o flex:1 funcione bem */
        
        user-select: text !important;
        -webkit-user-select: text !important;
    }

    /* Modo Sequ√™ncia */
    .verse-list.sequence-mode {
        display: block;
        padding: 15px;
        text-align: justify;
    }
    .verse-list.sequence-mode .verse-item { display: inline; padding: 0; margin: 0; }
    .verse-list.sequence-mode .verse-number {
        display: inline-block; min-width: auto; margin-left: 8px; margin-right: 2px;
        vertical-align: super; font-size: 0.7em; color: #888; padding: 0 2px;
    }
    .verse-list.sequence-mode .verse-item:first-child .verse-number { margin-left: 0; }
    .verse-list.sequence-mode .verse-number.has-data { color: var(--accent-color); font-weight: 900; }
    .verse-list.sequence-mode .verse-text { display: inline; }

    .loading-text { color: #444; font-style: italic; font-size: 0.9em; }
    .hidden { display: none !important; }

    /* --- MODAIS GERAIS --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 2000;
        display: none; justify-content: center; align-items: flex-start; padding-top: 50px;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 700px; max-height: 85vh;
        border-radius: 8px; border: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,1);
    }
    .modal-header {
        padding: 10px 15px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        background: #252528; position: relative;
    }
    .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
    .details-body { flex: 1; overflow-y: auto; padding: 15px; }

    /* --- CARD DE DETALHES (CORRIGIDO PARA N√ÉO FICAR GIGANTE) --- */
  .detail-card { 
        background: rgba(255,255,255,0.03); 
        border: 1px solid #333; 
        border-radius: 4px; 
        padding: 12px; 
        margin-bottom: 10px; 
        color: #e0e0e0; 
        
        white-space: normal;
        word-wrap: break-word;
        position: relative;
        
        font-size: var(--card-size-pct); 
        
        line-height: 1.6; 
    }

.detail-card div, 
    .detail-card p {
        margin-bottom: 4px; /* <--- MUDAN√áA: Reduzido de 10px para 4px */
        line-height: 1.4;   /* Altura da linha de texto um pouco mais compacta */
    }

    /* 2. Quebras de linha (Shift+Enter ou Colar) */
    .detail-card br {
        display: block;      
        content: "";         
        margin-top: 2px;     /* <--- MUDAN√áA: Reduzido de 5px para 2px */
        margin-bottom: 2px;  /* <--- MUDAN√áA: Reduzido de 5px para 2px */
        line-height: 8px;    /* Reduzido ligeiramente a altura f√≠sica da quebra */
    }

    /* Remove a margem do √∫ltimo elemento para n√£o ficar espa√ßo vazio no fundo */
    .detail-card *:last-child {
        margin-bottom: 0;
    }

    .detail-card strong { display: block; margin-bottom: 5px; color: #fff; font-size: 1.1em; }
    .detail-card a { color: #3498db; text-decoration: none; word-break: break-all; }
    
    .detail-section { margin-bottom: 25px; }
    .detail-title { 
        font-size: 0.8rem; text-transform: uppercase; color: #888; 
        font-weight: bold; border-bottom: 1px solid #333; 
        padding-bottom: 5px; margin-bottom: 10px; 
    }
    .empty-msg { color: #555; font-style: italic; font-size: 0.85rem; padding-left: 5px; }

    /* --- MENU DE 2 PONTOS NOS CARDS --- */
    .card-menu-container {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 10;
    }
    .card-menu-btn {
        cursor: pointer;
        color: #888;
        font-weight: bold;
        font-size: 14px;
        padding: 0 6px;
        letter-spacing: 1px;
        background: rgba(0,0,0,0.4);
        border-radius: 4px;
        transition: background 0.2s;
    }
    .card-menu-btn:hover { color: #fff; background: var(--accent-color); }

  .card-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 22px;
        background: #252528;
        border: 1px solid #555;
        border-radius: 4px;
        box-shadow: 0 4px 15px rgba(0,0,0,1); /* Sombra mais forte para destacar */
        min-width: 120px; /* Um pouco mais largo */
        flex-direction: column;
        z-index: 9999; /* <--- MUITO IMPORTANTE: N√∫mero alto */
    }
    .card-dropdown.visible { display: flex; }

    .card-dropdown button {
        background: none;
        border: none;
        color: #ccc;
        padding: 10px;
        text-align: left;
        cursor: pointer;
        font-size: 0.85rem;
        border-bottom: 1px solid #333;
        white-space: nowrap;
    }
    .card-dropdown button:last-child { border-bottom: none; }
    .card-dropdown button:hover { background: #333; color: white; }
    .btn-remove-card:hover { background: #c0392b !important; color: white; }

    /* --- CRIA√á√ÉO FLASH NOTE --- */
    #btn-add-flash-note {
         background: linear-gradient(135deg, #e67e22, #f39c12);
        border: none; color: white; padding: 6px 12px; border-radius: 20px;
        font-weight: bold; font-size: 0.85rem; cursor: pointer;
        box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        animation: pulse-glow 2s infinite;
        margin-left: 10px;
    }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
        50% { box-shadow: 0 0 15px rgba(230, 126, 34, 0.8); }
        100% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
    }

    #flash-note-modal { z-index: 3000; }
    .flash-toolbar {
        display: flex; align-items: center; gap: 5px; 
        padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 10px;
    }
    .flash-toolbar button {
        background: #333; border: 1px solid #444; color: #ccc; 
        width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    }
    #flash-type-select {
        margin-left: auto; background: #333; color: #fff;
        border: 1px solid #444; padding: 5px; border-radius: 4px; font-size: 0.8rem; outline: none;
    }
    .flash-input-title {
        width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; 
        color: #e67e22; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; outline: none;
    }
 .flash-editor {
        min-height: 150px; outline: none; line-height: 1.5; color: #ddd; 
        padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px;
        white-space: pre-wrap;
        
        /* --- NOVAS PROPRIEDADES --- */
        border: 1px solid #3498db; /* Azul claro por defeito (Subnota) */
        transition: border-color 0.3s ease; /* Efeito suave na troca */
    }

    /* --- CONFIGURA√á√ïES --- */
    .config-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 0; border-bottom: 1px solid #333;
    }
    .config-label { font-size: 0.9rem; color: #ccc; }
    .config-controls { 
        display: flex; align-items: center; gap: 10px; 
        background: #111; padding: 5px; border-radius: 20px; border: 1px solid #333; 
    }
    .btn-cfg {
        width: 30px; height: 30px; border-radius: 50%; border: none;
        background: #333; color: #fff; font-weight: bold; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
    .btn-cfg:hover { background: var(--accent-color); }
    .cfg-value { width: 50px; text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--accent-color); }
    
    .btn-cfg-toggle {
        width: auto; padding: 0 15px; border-radius: 20px; font-size: 0.85rem;
        background: #333; color: #fff; border: 1px solid #444; height: 30px; cursor: pointer;
    }
    .btn-cfg-toggle:hover { border-color: var(--accent-color); }

    /* Estilos herdados para renderiza√ß√£o de notas (Cores) */
    .mini-note-wrapper.question-mode { border-color: var(--question-color) !important; background-color: var(--question-bg) !important; }
    .mini-note-wrapper.question-mode .mini-note-title-input { color: var(--question-color) !important; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

    /* Estilos para as abas do Modal de Links */
.store-tab-btn {
    background: none; border: none; color: #888; 
    padding: 5px 10px; cursor: pointer; border-bottom: 2px solid transparent;
}
.store-tab-btn.active {
    color: var(--text-color); border-bottom-color: var(--accent-color); font-weight: bold;
}
.flash-url-row, .flash-codex-row {
    display: flex; gap: 5px;
}
.flash-url-row input, .flash-codex-row input {
    background: #111; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; flex: 1;
}
.btn-remove-row {
    background: #c0392b; color: white; border: none; width: 30px; cursor: pointer; border-radius: 4px;
}
.flash-cat-chip {
    background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; cursor: pointer;
}

/* --- ESTILOS AVAN√áADOS DO CODEX (Portados do note.html) --- */
.codex-row {
    background: #252528; border: 1px solid #333; border-radius: 8px;
    padding: 10px; margin-bottom: 10px; position: relative;
    border-left: 3px solid var(--accent-color);
}
.remove-codex-row {
    position: absolute; top: 5px; right: 5px; background: none; border: none;
    color: #e74c3c; cursor: pointer; font-weight: bold; font-size: 16px;
}
.codex-header-grid {
    display: flex; gap: 10px; align-items: center; margin-bottom: 10px;
}
.serie-wrapper { flex: 1; }
.codex-label {
    display: block; font-size: 0.65rem; color: #888; margin-bottom: 2px; text-transform: uppercase;
}
.codex-input-modern {
    width: 100%; background: #111; border: 1px solid #333; color: white;
    padding: 6px; border-radius: 4px; font-size: 0.9rem;
}
.manual-controls { display: flex; gap: 2px; }
.btn-control-small {
    background: #333; border: 1px solid #444; color: #ccc; width: 24px; height: 24px;
    border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold;
}
.btn-control-small.active {
    background: var(--accent-color); color: white; border-color: var(--accent-color);
}
.manual-inputs-area {
    display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;
}
.manual-field-group {
    display: flex; align-items: center; background: rgba(255,255,255,0.1);
    padding: 2px 6px; border-radius: 4px; gap: 5px; border: 1px solid #444;
}
.codex-input-manual {
    background: transparent; border: none; color: white; width: 40px; font-size: 0.8rem; outline: none;
}
.btn-close-manual {
    background: none; border: none; color: #e74c3c; cursor: pointer; font-weight: bold;
}
.codex-content-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #333; padding-top: 8px;
}
.codex-unit-chip {
    display: inline-flex; align-items: center; background: #333; border: 1px solid #444;
    border-radius: 12px; padding: 2px 6px; margin: 2px; font-size: 0.8rem;
}
.codex-unit-chip input {
    background: transparent; border: none; color: white; width: 30px; text-align: center; outline: none;
}
.btn-unit-del {
    background: none; border: none; color: #e74c3c; cursor: pointer; margin-left: 2px; font-weight: bold;
}
.btn-unit-add {
    background: rgba(255,255,255,0.1); border: 1px dashed #666; color: #ccc;
    width: 20px; height: 20px; border-radius: 50%; cursor: pointer; margin-left: 5px;
}

/* --- ESTILO DO TOGGLE (INTERRUPTOR) --- */
.setting-switch {
    position: relative; display: inline-block; width: 34px; height: 18px;
}
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #444; transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(16px); }

/* --- LAYOUT H√çBRIDO (SIDEBAR) --- */
    /* Wrapper para colocar a B√≠blia e a Sidebar lado a lado */
    #main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
        height: calc(100vh - 45px); /* Desconta o header */
    }

    /* A √°rea da B√≠blia ocupa o espa√ßo restante */
    .container {
        flex: 1;
        overflow-y: auto;
        padding: 5px;
        transition: flex 0.3s ease; /* Suavidade se encolher */
    }

    /* A Coluna Lateral (PC) */
    #side-panel {
        width: 0; /* Come√ßa fechada */
        background-color: #1f1f22;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Efeito suave */
        flex-shrink: 0; /* Impede que seja esmagada */
        z-index: 1000;
    }

    #side-panel.open {
        width: 40%; /* No PC ocupa 40% */
        box-shadow: -5px 0 15px rgba(0,0,0,0.5);
    }

    /* Esconde a Sidebar em ecr√£s pequenos e garante que o modal funciona */
    @media (max-width: 768px) {
        .verse-list {
            /* Aumenta o espa√ßo no fundo para 150px (cerca de 2 dedos de altura) */
            padding-bottom: 150px !important; 
        }
        
        /* Se estiver a usar o modo de texto corrido (Sequ√™ncia) */
        .verse-list.sequence-mode {
            padding-bottom: 150px !important;
        }
    }

      #btn-add-flash-note, .btn-create-note {
        background: linear-gradient(135deg, #e67e22, #f39c12);
        border: none; color: white; padding: 6px 12px; border-radius: 20px;
        font-weight: bold; font-size: 0.85rem; cursor: pointer;
        box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        animation: pulse-glow 2s infinite;
        margin-left: 10px;
        white-space: nowrap; /* Impede que o texto quebre */
    }

    /* --- BARRA FLUTUANTE DE SELE√á√ÉO --- */
 #selection-toolbar {
    position: absolute;
    z-index: 9999;
    background-color: #252528;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 5px;
    display: none; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    gap: 5px;
}
    #selection-toolbar::after {
        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
        border-width: 5px; border-style: solid; border-color: #252528 transparent transparent transparent;
    }
    .sel-btn {
        background: none; border: none; color: white; cursor: pointer;
        padding: 5px 10px; font-size: 0.9rem; border-radius: 4px;
        display: flex; align-items: center; gap: 5px;
    }
    .sel-btn:hover { background-color: rgba(255,255,255,0.1); }

    /* --- ESTILO DOS DESTAQUES (PICOTADO) --- */
    /* A classe base ser√° gerada via JS, mas a estrutura √© esta */
    .bible-highlight {
        border-bottom-width: 3px;
        border-bottom-style: dotted; /* O tal "picotado" */
        background-color: rgba(255,255,255,0.05); /* Ligeiro fundo para destacar */
    }

    /* --- DROPDOWN DE CORES --- */
    .color-select-wrapper {
        display: flex; align-items: center; gap: 5px; margin-top: 10px;
        padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;
    }
    #flash-color-select {
        background: #333; color: white; border: 1px solid #444;
        padding: 5px; border-radius: 4px; flex: 1;
    }
    /* Pequena bola de pr√©-visualiza√ß√£o da cor */
    #color-preview-dot {
        width: 20px; height: 20px; border-radius: 50%; background-color: transparent; border: 1px solid #555;
    }

#selection-toolbar {
    position: absolute;
    display: none; /* Escondido por defeito */
    background-color: #252528;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    z-index: 5000;
    gap: 5px;
    align-items: center;
}
#selection-toolbar button {
    background: #333;
    border: none;
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
}
#selection-toolbar button:hover { background: var(--accent-color); }

/* --- SELETOR DE CORES (NOVA NOTA) --- */
/* --- ATUALIZA√á√ÉO FINAL DO CSS DAS CORES --- */
.color-picker-container {
    display: flex;
    gap: 10px;
    padding: 10px 2px; /* Um pouco mais de altura para o zoom */
    overflow-x: auto;
    align-items: center;
    min-height: 50px;
}

.color-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0;
    border: 2px solid transparent; 
    opacity: 0.7;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    
    /* NOVO: Para centrar o "certo" */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Prepara para n√£o mostrar nada por defeito */
    font-size: 0; 
}

.color-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}

/* O ESTADO SELECIONADO */
.color-btn.selected {
    transform: scale(1.3);
    border: 2px solid #ffffff;
    opacity: 1;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    z-index: 10;
}

/* O √çCONE DE "CERTO" (‚úì) */
.color-btn.selected::after {
    content: '‚úì';
    font-size: 14px;
    color: white;
    font-weight: bold;
    /* Sombra no texto para se ver bem mesmo em cores claras (tipo amarelo) */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    
    /* Anima√ß√£ozinha de entrada */
    animation: popIn 0.3s ease forwards;
}

@keyframes popIn {
    0% { transform: scale(0); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* --- ESTILO DO SUBLINHADO (PICOTADO) --- */
.highlight-picotado {
    /* O gradiente pontilhado que j√° t√≠nhamos */
    background-image: linear-gradient(to right, var(--accent-color) 50%, transparent 50%); /* Cor ser√° injetada via JS */
    background-position: bottom;
    background-size: 6px 3px;
    background-repeat: repeat-x;
    padding-bottom: 2px;
    
    /* CORRE√á√ÉO PARA MOBILE E QUEBRA DE LINHAS */
    /* Isto garante que o picotado continua perfeito se o texto mudar de linha */
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
    
    text-decoration: none !important;
    display: inline;
    cursor: pointer;
    
    /* Garante que a sele√ß√£o nativa funciona por cima */
    position: relative;
    z-index: 1;
}

    /* Cor espec√≠fica para o Pentateuco (G√©nesis a Deuteron√≥mio) */
    .tile.tile-pentateuco {
        background-color: #3b3046; /* Roxo mais escuro e profundo */
        color: #e0d0f0; /* Texto ligeiramente lil√°s para contraste */
        border: 1px solid rgba(0,0,0,0.3); /* Ligeira borda para destacar */
    }
    
    /* Efeito hover espec√≠fico para estes bot√µes */
    .tile.tile-pentateuco:hover {
        background-color: #4f415c;
    }
    

    /* Cor espec√≠fica para Profetas Maiores (Isa√≠as a Daniel) */
    .tile.tile-profetas-maiores {
        background-color: #8c4b28; /* Laranja escuro / Terra cota */
        color: #ffecd9; /* Texto creme para bom contraste */
        border: 1px solid rgba(0,0,0,0.3);
    }

    /* Efeito hover */
    .tile.tile-profetas-maiores:hover {
        background-color: #a65d36; /* Um pouco mais claro ao passar o rato */
    }
    
/* Cor para Profetas Menores (Os√©ias a Malaquias) - Tom Bronze/Terra */
    .tile.tile-profetas-menores {
        background-color: #6e4c30; /* Um laranja muito escuro / bronze */
        color: #ffdab9; /* Texto p√™ssego claro para contrastar bem */
        border: 1px solid rgba(0,0,0,0.3);
    }

    /* Efeito hover */
    .tile.tile-profetas-menores:hover {
        background-color: #855e40;
    }

/* Roxo mais leve para Cartas Gerais (Tiago a Judas) */
    .tile.tile-cartas-gerais {
        background-color: #745c85; /* Um roxo m√©dio/lavanda, mais leve que o de G√©nesis */
        color: #f3e5f5; /* Texto lil√°s muito claro */
        border: 1px solid rgba(0,0,0,0.3);
    }

    /* Efeito hover */
    .tile.tile-cartas-gerais:hover {
        background-color: #8c739e;
    }
    
    /* --- ECR√É DE CARREGAMENTO DE CAP√çTULO --- */
    #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-color); /* Fundo preto para tapar tudo */
        z-index: 5000;
        display: none; /* Escondido por defeito */
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .spinner-main {
        width: 50px;
        height: 50px;
        border: 5px solid #333;
        border-top: 5px solid var(--accent-color); /* A cor laranja */
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Bot√£o de Marcadores no Header */
#bookmarks-btn {
    background: none; 
    border: none; 
    font-size: 1.2rem; 
    cursor: pointer;
    padding: 5px; 
    transition: 0.3s;
    min-width: 30px;
}
#bookmarks-btn:hover { transform: scale(1.1); }

/* Lista de Navega√ß√£o de Marcadores */
.bk-list-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    transition: background 0.2s;
}
.bk-list-item:hover { background-color: var(--hover-color); }

.bk-count {
    background: rgba(255,255,255,0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8em;
    color: #aaa;
}

/* Item de Vers√≠culo Espec√≠fico */
.bk-verse-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
}
.bk-verse-item:hover { background-color: rgba(46, 204, 113, 0.1); }

.bk-verse-ref { font-weight: bold; color: var(--accent-color); display: block; }
.bk-verse-desc { font-size: 0.85em; color: #888; margin-top: 2px; }

/* Efeito de Flash ao encontrar o vers√≠culo */
@keyframes verse-flash {
    0% { background-color: rgba(230, 126, 34, 0.6); }
    100% { background-color: transparent; }
}
.flash-target { animation: verse-flash 2s ease-out; }


/* Bot√£o de Marcador (+ üîñ) */
.btn-bookmark {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #aaa;
    color: #fff;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85rem;
    cursor: pointer;
    margin-left: 5px;
    transition: background 0.2s;
}

.btn-bookmark:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* √çcone de Marcador no T√≠tulo (Clic√°vel para remover) */
.bookmark-icon-title {
    cursor: pointer;
    margin-right: 5px;
    font-size: 1.2rem;
    transition: transform 0.2s;
    display: inline-block;
}
.bookmark-icon-title:hover {
    transform: scale(1.2);
    filter: drop-shadow(0 0 5px #e67e22);
}

/* Item da Lista no Modal */
.bk-select-item {
    padding: 10px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
}
.bk-select-item:hover { background-color: rgba(255,255,255,0.05); }
.bk-select-item.active { color: var(--accent-color); font-weight: bold; }

/* Cor espec√≠fica para Po√©ticos e Evangelhos (Azul Petr√≥leo) */
.tile.tile-poeticos {
    background-color: #2c3e50; /* Azul escuro/petr√≥leo */
    color: #a9cce3; /* Texto azul claro */
    border: 1px solid rgba(0,0,0,0.3);
}

.tile.tile-poeticos:hover {
    background-color: #34495e;
}

/* --- PALETA DE CORES CORRIGIDA (VIBRANTE) --- */

    /* 1. ROXO ESCURO (G√©nesis a Deuteron√≥mio + Atos) */
    .tile.tile-purple-dark {
        background-color: #3b2e44; 
        color: #e0d0f0;
        border: 1px solid #4a235a;
    }
    .tile.tile-purple-dark:hover { background-color: #4f3e5c; }

    /* 2. LIL√ÅS M√âDIO (Josu√© a Ester + Cartas NT) 
       Ajustado para #7e6b99 para ser bem vis√≠vel */
    .tile.tile-lilac-medium {
        background-color: #7e6b99; 
        color: #ffffff;
        border: 1px solid #9575cd;
    }
    .tile.tile-lilac-medium:hover { background-color: #9683b3; }

    /* 3. AZUL ARD√ìSIA (J√≥ a C√¢ntico de Salom√£o) 
       Novo grupo para igualar a imagem */
    .tile.tile-slate-blue {
        background-color: #4f5b66; 
        color: #dbe4eb;
        border: 1px solid #65737e;
    }
    .tile.tile-slate-blue:hover { background-color: #65737e; }

    /* 4. LARANJA FERRUGEM (Isa√≠as a Daniel + Evangelhos + Apocalipse) */
    .tile.tile-rust {
        background-color: #a3552d; 
        color: #fff0e0;
        border: 1px solid #d35400;
    }
    .tile.tile-rust:hover { background-color: #bf6336; }

    /* 5. CASTANHO (Os√©ias a Malaquias) */
    .tile.tile-brown {
        background-color: #6d4c33; 
        color: #ffe0cc;
        border: 1px solid #8d6e63;
    }
    .tile.tile-brown:hover { background-color: #855e40; }

/* --- ESTILO DAS ABAS (CORRIGIDO) --- */
.verse-tabs-nav {
    display: flex;
    /* Cor de fundo s√≥lida IGUAL √† do modal para tapar o texto que passa por tr√°s */
    background-color: #1f1f22; 
    border-bottom: 1px solid #333;
    
    /* Fixar no topo */
    position: sticky;
    top: 0;
    z-index: 1000; /* Garante que fica acima de tudo */
    
    /* Sombra para dar profundidade e separar do conte√∫do */
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

.verse-tab-btn {
    flex: 1;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #666; /* Cor inativa mais escura */
    padding: 12px 5px;
    cursor: pointer;
    font-size: 1.1rem; /* √çcones ligeiramente maiores */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.verse-tab-btn:hover {
    background-color: rgba(255, 255, 255, 0.05);
    color: #bbb;
}

.verse-tab-btn.active {
    color: #fff;
    border-bottom-color: var(--accent-color);
    /* Ligeiro brilho no fundo da aba ativa */
    background: linear-gradient(to top, rgba(230, 126, 34, 0.1), transparent);
}

/* Bolinha com o n√∫mero */
.tab-badge {
    background-color: #333;
    color: #ccc;
    font-size: 0.7rem;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}

.verse-tab-btn.active .tab-badge {
    background-color: var(--accent-color);
    color: #fff;
    box-shadow: 0 0 5px var(--accent-color);
}

/* √Årea de Conte√∫do */
.tab-pane {
    display: none;
    padding: 15px 5px; /* Espa√ßamento interno */
    padding-bottom: 50px; /* Espa√ßo extra no fundo para n√£o cortar o √∫ltimo card */
    animation: fadeInTab 0.3s ease;
}

.tab-pane.active {
    display: block;
}

@keyframes fadeInTab {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- CORRE√á√ÉO DE PADDING E LAYOUT --- */

/* 1. Remove o padding do contentor principal para a barra colar no topo */
.details-body { 
    flex: 1; 
    overflow-y: auto; 
    padding: 0; /* MUDAN√áA IMPORTANTE: Era 15px */
}

/* 2. Adiciona o padding de volta DENTRO das abas (para o texto n√£o colar √†s bordas) */
.tab-pane {
    display: none;
    padding: 15px; /* O padding vem para aqui */
    padding-bottom: 60px; /* Espa√ßo extra no fundo */
    animation: fadeInTab 0.3s ease;
}

/* 3. Estilo da Barra de Navega√ß√£o (Para colar perfeitamente) */
.verse-tabs-nav {
    display: flex;
    background-color: #1f1f22; /* Mesma cor do fundo do modal */
    border-bottom: 1px solid #333;
    position: sticky;
    top: 0;
    z-index: 1000;
    margin: 0; /* Garante que n√£o h√° margens */
    width: 100%; /* Ocupa a largura toda */
    box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* Sombra para tapar o texto */
}

/* --- REPOR PADDING NOS OUTROS MODAIS --- */
/* Como tir√°mos o padding global do .details-body, temos de o p√¥r de volta 
   nos modais que n√£o usam abas (Configura√ß√µes, Notas Flash, etc.) */

#flash-note-modal .details-body,
#settings-modal .details-body,
#edit-card-modal .details-body,
#bible-bookmark-modal .details-body,
#bookmarks-navigator-modal .details-body {
    padding: 15px !important;
}

/* Ajuste espec√≠fico para o painel lateral no PC */
#side-panel .details-body {
    padding: 0; /* Garante que no PC a barra tamb√©m cola */
}

/* For√ßa o primeiro elemento dentro do Dossi√© a encostar ao topo */
.dossie-content-wrapper > *:first-child {
    margin-top: 0 !important;
    padding-top: 0 !important;
}
.dossie-content-wrapper p, 
.dossie-content-wrapper h2, 
.dossie-content-wrapper h3 {
    margin-block-start: 0 !important; /* Remove margens autom√°ticas do browser */
}

/* Estilo das setas de navega√ß√£o no cabe√ßalho */
    .nav-arrow {
        background: none;
        border: none;
        color: #888; /* Cor discreta */
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 10px;
        transition: color 0.2s, transform 0.2s;
        vertical-align: middle;
    }
    .nav-arrow:hover {
        color: var(--accent-color); /* Laranja ao passar o rato */
        transform: scale(1.2);
    }
    /* Ajuste para o t√≠tulo ficar alinhado com as setas */
    #page-title {
        display: flex;
        justify-content: center;
        align-items: center;
    }

/* --- NAVEGADOR R√ÅPIDO DE CAP√çTULOS --- */
    #chapter-nav-panel {
        position: fixed;
        top: 50px; /* Logo abaixo do cabe√ßalho */
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 500px;
        background-color: #1f1f22;
        border: 1px solid #444;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.9);
        z-index: 2000;
        padding: 10px;
        
        /* Grelha de N√∫meros */
        display: none; /* Escondido por defeito (o JS controla o display flex/grid) */
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 5px;
        
        max-height: 60vh; /* Se forem muitos cap√≠tulos, faz scroll */
        overflow-y: auto;
    }

    /* Estilo do bot√£o de n√∫mero no painel */
    .nav-cap-btn {
        background-color: #333;
        color: #ccc;
        border: 1px solid #444;
        padding: 8px 0;
        text-align: center;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .nav-cap-btn:hover { background-color: #444; color: white; }
    
    /* Cap√≠tulo Atual destacado */
    .nav-cap-btn.active {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

/* Item da lista de √¢ncoras encontradas */
.bible-anchor-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}
.bible-anchor-item:hover { background-color: var(--hover-color); }

.bible-anchor-name { font-weight: bold; color: var(--text-color); }
.bible-anchor-type { 
    font-size: 0.75rem; 
    text-transform: uppercase; 
    background: rgba(255,255,255,0.1); 
    padding: 2px 6px; 
    border-radius: 4px; 
    color: #aaa; 
}

/* --- MODO LEITURA (READ-ONLY) NA SIDEBAR --- */
/* Quando a sidebar tem esta classe, esconde bot√µes de edi√ß√£o */
#side-panel.read-only-mode .btn-create-note,
#side-panel.read-only-mode .btn-bookmark,
#side-panel.read-only-mode .card-menu-container,
#side-panel.read-only-mode .card-menu-btn,
#side-panel.read-only-mode .add-codex-btn, /* Se houver bot√µes de adicionar */
#side-panel.read-only-mode button[onclick*="window.delete"],
#side-panel.read-only-mode button[onclick*="window.openEdit"] {
    display: none !important;
}

/* Ajuste do t√≠tulo no modo leitura */
#side-panel.read-only-mode #sidebar-verse-title {
    color: #2ecc71 !important; /* Verde para diferenciar */
}

/* Estilo do sublinhado da √Çncora */
.anchor-highlight {
    background-color: rgba(46, 204, 113, 0.25); /* Verde ligeiramente mais vis√≠vel */
    border-bottom: 2px solid #2ecc71;
    color: inherit;
    border-radius: 2px;
    
    /* CORRE√á√ÉO CR√çTICA: */
    pointer-events: auto;     /* Permite que o rato interaja (clicar/selecionar) */
    cursor: text;             /* Mostra o cursor de texto para indicar sele√ß√£o */
    
    /* Garante a sele√ß√£o */
    -webkit-user-select: text;
    user-select: text;
    
    /* Anima√ß√£o suave */
    animation: highlightPulse 2s infinite;
}

/* ============================================================
   CORRE√á√ÉO NUCLEAR: PAINEL BOTTOM-SHEET MOBILE
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar a visibilidade e posi√ß√£o */
    #side-panel, 
    #side-panel.open {
        display: flex !important;        /* Garante que n√£o est√° 'none' */
        flex-direction: column !important;
        
        position: fixed !important;      /* Cola ao ecr√£, ignora scroll */
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        top: auto !important;            /* Ignora topo */
        
        /* A CORRE√á√ÉO PRINCIPAL: */
        width: 100vw !important;         /* For√ßa largura total */
        min-width: 100vw !important;
        max-width: 100vw !important;
        
        z-index: 10000 !important;       /* Acima do modal de √¢ncoras (8000) */
        
        background-color: #1f1f22 !important; /* Cor de fundo s√≥lida */
        box-shadow: 0 -5px 50px rgba(0,0,0,0.8) !important;
        border-radius: 20px 20px 0 0 !important;
        border-top: 1px solid rgba(255,255,255,0.1) !important;
        
        /* Garante que a transi√ß√£o funciona */
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.2s ease !important;
    }

    /* 2. Estado Fechado (Escondido em baixo) */
    #side-panel:not(.open) {
        transform: translateY(100%) !important;
    }

    /* 3. Estado Aberto (Vis√≠vel) */
    #side-panel.open {
        transform: translateY(0) !important;
    }
    
    /* 4. Estado a Arrastar (Sem anima√ß√£o para seguir o dedo) */
    #side-panel.is-dragging {
        transition: none !important;
    }

    /* 5. Ajuste do conte√∫do interno para n√£o cortar */
    #side-panel .details-body {
        padding-bottom: 50px !important; /* Espa√ßo para n√£o cortar texto no fundo */
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
    }
}

/* ============================================================
   BARRA DE SELE√á√ÉO DE TEXTO (AJUSTE MOBILE)
   ============================================================ */

/* Estilo Base (PC - Flutuante) */
#selection-toolbar {
    position: absolute;
    z-index: 9999;
    background-color: #252528;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 5px;
    display: none; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    gap: 10px;
    align-items: center;
}

/* Estilo Mobile (Fixo no Fundo) */
@media (max-width: 768px) {
    #selection-toolbar {
        position: fixed !important; /* Cola ao ecr√£ */
        top: auto !important;       /* Ignora o c√°lculo de topo do JS */
        bottom: 20px !important;    /* Fica no fundo */
        left: 50% !important;       /* Centrado horizontalmente */
        transform: translateX(-50%) !important;
        
        width: 90%;                 /* Largura confort√°vel */
        max-width: 350px;
        justify-content: center;
        
        background-color: #1a1a1d !important;
        border: 1px solid var(--accent-color);
        box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        padding: 10px;
        
        /* Anima√ß√£o de entrada */
        animation: slideUp 0.3s ease-out;
    }
    
    /* Bot√µes maiores no telem√≥vel para facilitar o toque */
    #selection-toolbar button {
        padding: 10px 15px !important;
        font-size: 1rem !important;
    }
}

@keyframes slideUp {
    from { transform: translate(-50%, 100%); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}


/* --- ESCUDO GLOBAL DE AUTENTICA√á√ÉO E CARREGAMENTO --- */
    #global-auth-shield {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000000; /* Fundo preto s√≥lido */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 99999; /* Acima de absolutamente tudo */
        transition: opacity 0.6s ease-out, visibility 0.6s;
    }

    #global-auth-shield.fade-out {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
    }

    .global-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid var(--accent-color); /* Laranja */
        border-radius: 50%;
        animation: spin-global 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin-global { to { transform: rotate(360deg); } }

    .global-loading-text {
        color: #666;
        font-family: monospace;
        letter-spacing: 2px;
        font-size: 0.9rem;
        animation: pulse-text 1.5s infinite ease-in-out;
    }

    @keyframes pulse-text { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

/* --- HIERARQUIA DE POPUPS (Z-INDEX) --- */

/* N√≠vel 1: Painel Lateral (Gaveta) - J√° est√° definido como 10000 no mobile */

/* N√≠vel 2: Popup "+ Nota Flash" e "Editar Nota" (Fica √† frente da Gaveta) */
#flash-note-modal,
#edit-card-modal {
    z-index: 11000 !important;
}

/* N√≠vel 3: Ferramentas da Nota (Ficam √† frente da Nota) */
#flash-topics-modal,  /* üìã T√≥picos */
#flash-links-modal,   /* ‚ö° Links */
#bible-bookmark-modal /* üîñ Marcadores */ {
    z-index: 12000 !important;
}

/* N√≠vel 4: Alertas e Confirma√ß√µes (Ficam √† frente de TUDO) */
#confirm-modal,
#custom-alert-modal {
    z-index: 13000 !important;
}

/* ACELERAR ANIMA√á√ÉO DO PAINEL MOBILE */
    @media (max-width: 768px) {
        #side-panel {
            /* Mudei de 0.3s para 0.15s (Muito r√°pido) */
            transition: transform 0.15s ease-out, height 0.15s ease !important;
        }
    }

/* Estilos para o Modal de Fontes */
.source-section-header {
    font-size: 0.8rem;
    font-weight: bold;
    color: var(--accent-color);
    text-transform: uppercase;
    border-bottom: 1px solid #444;
    margin-bottom: 10px;
    padding-bottom: 5px;
    margin-top: 15px;
}
.source-section-header:first-child { margin-top: 0; }

.source-view-item {
    background: rgba(255,255,255,0.05);
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 0.9rem;
    border-left: 3px solid #666;
    
    /* Garante que o conte√∫do n√£o estica o cart√£o */
    max-width: 100%;
    box-sizing: border-box;
}

.source-view-item div, 
.source-view-item a {
    /* Esta √© a propriedade m√°gica para URLs: */
    word-break: break-all; 
    
    /* Alternativas para compatibilidade: */
    overflow-wrap: break-word;
    white-space: normal;
    
    /* Garante que a cor e o estilo se mant√™m */
    display: block; 
    line-height: 1.4;
}

/* Permitir sele√ß√£o de texto no modal de fontes */
#view-sources-content, 
.source-view-item,
.source-view-item a,
.source-view-item strong,
.source-view-item div {
    user-select: text !important;
    -webkit-user-select: text !important; /* Essencial para iPhone/iPad */
    cursor: text;
    pointer-events: auto;
}

/* ============================================================
   PERMITIR COPIAR TEXTO NOS CART√ïES (PC & MOBILE)
   ============================================================ */

/* 1. Define que o texto √© selecion√°vel nos contentores dos cart√µes */
.detail-card,                 /* Cart√£o Gen√©rico */
.dossie-content-wrapper,      /* Texto dentro das Micas */
.post-view-content,           /* Texto dos Posts/Notas */
.ref-card-content,            /* Texto do Puzzle/Refer√™ncias */
.bible-collapsible-content,   /* Texto B√≠blico expandido */
.detail-card div,             /* Divs internos */
.detail-card strong {         /* Negritos internos */
    
    /* Habilita sele√ß√£o para Webkit (Chrome/Safari/iOS) */
    -webkit-user-select: text !important;
    
    /* Habilita sele√ß√£o Padr√£o (Firefox/Edge/PC) */
    user-select: text !important;
    
    /* Muda o cursor para o "I" de texto no PC */
    cursor: text !important;
    
    /* Garante que os eventos de clique/toque chegam ao texto */
    pointer-events: auto !important;
}

/* 2. Opcional: Remove a cor de "toque" cinzenta no mobile ao selecionar */
.detail-card,
.dossie-content-wrapper {
    -webkit-tap-highlight-color: transparent;
}
/* Estilo para os itens dentro do popup de Foco */
.focus-mode-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 5px;
    background-color: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.focus-mode-item:hover {
    background-color: rgba(255, 255, 255, 0.08);
    transform: translateX(5px);
}

.focus-mode-item.active {
    background-color: rgba(74, 144, 226, 0.15);
    border-color: var(--accent-color);
}

/* A bolinha de cor ao lado do nome do foco */
.focus-preview-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin-right: 15px;
    flex-shrink: 0;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}

.focus-label {
    flex-grow: 1;
    font-size: 0.95rem;
    font-weight: 500;
    color: #eee;
}

/* S√≠mbolo de check para o item ativo */
.focus-check {
    color: var(--accent-color);
    font-weight: bold;
    font-size: 1.1rem;
}

/* Cabe√ßalho de Categoria nos Cards da 4¬™ Coluna */
.ref-card-category-label {
    font-size: 0.75em;
    font-weight: 800;
    text-transform: uppercase;
    margin-bottom: 4px;
    letter-spacing: 0.8px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.filter-chip {
    background: #333;
    border: 1px solid #444;
    color: #bbb;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    cursor: pointer;
    white-space: nowrap;
    transition: 0.2s;
}
.filter-chip.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}
.book-chip {
    background: rgba(255,255,255,0.05);
    border: 1px solid #333;
    color: #888;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.7rem;
    cursor: pointer;
}
.book-chip.active {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background: rgba(230, 126, 34, 0.1);
}

/* --- CSS PESQUISA E FILTROS --- */
#search-books-filter {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 5px;
    margin-top: 10px;
    
    /* Scrollbar fina para a lista de livros */
    scrollbar-width: thin; 
    scrollbar-color: #444 #1a1a1d;
}

#search-books-filter::-webkit-scrollbar {
    height: 4px;
}

.filter-chip {
    background: #333;
    border: 1px solid #444;
    color: #bbb;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.filter-chip:hover {
    background: #444;
    color: #fff;
}

.filter-chip.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
    box-shadow: 0 0 10px rgba(230, 126, 34, 0.4);
}

.book-chip {
    background: rgba(255,255,255,0.05);
    border: 1px solid #333;
    color: #888;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    white-space: nowrap; /* Impede que o nome do livro quebre */
    flex-shrink: 0;      /* Impede que o bot√£o seja esmagado */
}

.book-chip:hover {
    border-color: #666;
    color: #ccc;
}

.book-chip.active {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background: rgba(230, 126, 34, 0.1);
    font-weight: bold;
}

/* Remove o fundo verde ao passar o rato e coloca um cinza discreto */
.bk-verse-item:hover { 
    background-color: rgba(255, 255, 255, 0.05) !important; 
}

/* Estilo for√ßado para a palavra encontrada */
mark.search-highlight {
    background-color: #f1c40f !important; /* Amarelo Ouro */
    color: #000 !important;               /* Texto Preto para contraste */
    font-weight: bold !important;
    text-decoration: underline !important;
    padding: 0 2px !important;
    border-radius: 3px !important;
}

</style>

</head>
<body>

     <!-- ESCUDO DE CARREGAMENTO INICIAL -->
    <div id="global-auth-shield">
        <div class="global-spinner"></div>
        <div class="global-loading-text">A CARREGAR...</div>
    </div>

 <header>
    <button id="back-btn">‚¨Ö</button>
    <div id="page-title">B√≠blia</div>
    
    <!-- NOVO: Contentor de bot√µes da direita -->
    <div style="display:flex; align-items:center;">
        <button id="bookmarks-btn" title="Meus Marcadores" style="margin-right: 5px;">üîñ</button>
        <button id="settings-btn">‚öôÔ∏è</button>
    </div>
</header>

<!-- NOVO WRAPPER FLEX -->
    <div id="main-layout">
        
        <!-- √Årea Principal (B√≠blia) -->
        <div class="container">
            <div id="view-books"></div>
            <div id="view-chapters" class="hidden"><div class="grid" id="chapters-grid"></div></div>
            <div id="view-verses" class="hidden"><div class="verse-list" id="verses-list"></div></div>
        </div>

        <!-- Nova Coluna Lateral (Sidebar PC) -->
<aside id="side-panel">
        <div class="modal-header" style="position: relative; justify-content: space-between; height: 50px;">
            
            <!-- ESQUERDA: Contentor para T√≠tulo e Bot√£o Voltar -->
            <div style="display: flex; align-items: center; max-width: 30%; overflow: hidden;">
                <!-- Bot√£o Voltar (Escondido por defeito) -->
                <button id="sidebar-back-btn" onclick="window.returnToVerseDetails()" style="display: none; background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; margin-right: 10px;">‚¨Ö</button>
                
                <h3 id="sidebar-verse-title" style="color:var(--accent-color); font-size:1.1rem; white-space:nowrap; overflow: hidden; text-overflow: ellipsis;">
                    Vers√≠culo
                </h3>
            </div>
            
            <!-- CENTRO: Bot√£o Criar Nota -->
            <div id="sidebar-center-actions" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 10;">
                <button class="btn-create-note" onclick="window.handleCreateNoteClick()" style="margin: 0;">
                    + üìù
                </button>
            </div>

            <!-- DIREITA: Bot√£o Fechar -->
            <button class="modal-close" onclick="window.closeSidePanel()">√ó</button>
        </div>
        
        <div class="details-body" id="sidebar-content">
            <!-- Conte√∫do carregado via JS -->
        </div>
    </aside>



    </div>

    <!-- MODAL DE DETALHES -->
    <div id="verse-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display:flex; align-items:center;">
                    <h3 id="modal-verse-title" style="color:var(--accent-color); font-size:1.1rem; margin-right:15px;">Vers√≠culo</h3>
                    <button id="btn-add-flash-note">+ üìù</button>
                </div>
                <button class="modal-close" onclick="document.getElementById('verse-details-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body" id="details-content"></div>
        </div>
    </div>

    <!-- MODAL DE CRIA√á√ÉO FLASH (ATUALIZADO COM SELECT) -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color:#e67e22;">Nova Nota Flash</h3>
                <button class="modal-close" onclick="document.getElementById('flash-note-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
                
                <!-- Toolbar com Dropdown √† Direita -->
                <div class="flash-toolbar">
                    <button onclick="document.execCommand('bold')"><b>B</b></button>
                    <button onclick="document.execCommand('italic')"><i>I</i></button>
                    <button onclick="document.execCommand('underline')"><u>U</u></button>
                    <button id="btn-flash-topics" title="T√≥picos do Bloco" style="margin-left:5px;">üìã</button>
                    <button id="btn-flash-links" title="Gest√£o de Links" style="margin-left:2px;">‚ö°</button>
                    <button id="btn-flash-focus" title="Definir Foco" style="margin-left:2px;">üé®</button>

                    <!-- Novo Seletor de Tipo -->
                    <select id="flash-type-select">
                        <option value="default">üìò Subnota</option>
                        <option value="question">üìó Quest√£o</option>
                    </select>
                </div>

                <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                    üîó Anexado a: <span id="flash-attached-verse" style="color: #3498db;"></span>
                </div>

<button id="btn-save-flash" onclick="window.saveFlashNoteGlobal()" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR NOTA</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; height: auto; max-height: auto;">
            <div class="modal-header">
                <h3 style="color:#fff;">Configura√ß√µes</h3>
                <button class="modal-close" onclick="document.getElementById('settings-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                
                <!-- Modo de Leitura (Grelha/Sequ√™ncia) -->
                <div class="config-row">
                    <span class="config-label">Modo Visualiza√ß√£o</span>
                    <div class="config-controls" style="background:transparent; border:none;">
                        <button id="btn-toggle-view" class="btn-cfg-toggle" onclick="toggleViewMode()">
                            Lista (Grelha)
                        </button>
                    </div>
                </div>

                <!-- Tamanho Texto Vers√≠culos -->
                <div class="config-row">
                    <span class="config-label">Tamanho Vers√≠culos</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('verse', -10)">-</button>
                        <span id="disp-verse-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('verse', 10)">+</button>
                    </div>
                </div>

                <!-- Tamanho Bot√µes (Livros/Caps) -->
                <div class="config-row">
                    <span class="config-label">Zoom Bot√µes (Livros)</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('tile', -10)">-</button>
                        <span id="disp-tile-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('tile', 10)">+</button>
                    </div>
                </div>

                <!-- Tamanho Texto Cards -->
                <div class="config-row" style="border-bottom: none;">
                    <span class="config-label">Tamanho Cards (Popups)</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('card', -10)">-</button>
                        <span id="disp-card-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('card', 10)">+</button>
                    </div>
                </div>

                <button id="btn-save-cfg" style="width:100%; margin-top:20px; padding:12px; background:#333; color:white; border:1px solid #555; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR E FECHAR</button>

            </div>
        </div>
    </div>
    
   <!-- MODAL DE EDI√á√ÉO DE CARD -->
<div id="edit-card-modal" class="modal-overlay" style="z-index: 11000;">
    <div class="modal-content" style="max-width: 450px; height: auto;">
        <div class="modal-header">
            <h3 style="color: var(--accent-color);">‚úèÔ∏è Editar Nota</h3>
            <button class="modal-close" onclick="document.getElementById('edit-card-modal').style.display='none'">√ó</button>
        </div>
        
        <div class="details-body" style="padding: 15px;">
            <!-- Campo de T√≠tulo -->
            <label style="font-size:0.75rem; color:#888; text-transform: uppercase; font-weight: bold;">T√≠tulo da Nota</label>
            <input type="text" id="edit-card-title" class="flash-input-title" style="font-size:1.1rem; margin-bottom:15px; border-bottom: 1px solid #444;" placeholder="T√≠tulo...">
            
            <!-- Barra de Ferramentas (Toolbar) -->
            <div class="flash-toolbar" style="margin-bottom: 10px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;">
                <!-- Formata√ß√£o de Texto -->
                <button onclick="document.execCommand('bold')" title="Negrito"><b>B</b></button>
                <button onclick="document.execCommand('italic')" title="It√°lico"><i>I</i></button>
                <button onclick="document.execCommand('underline')" title="Sublinhado"><u>U</u></button>
                
                <div style="width: 1px; height: 20px; background: #444; margin: 0 5px;"></div>

                <!-- Bot√µes de Funcionalidade (Corrigidos com onclick) -->
                <button id="btn-edit-topics" onclick="window.openTopicsModal()" title="Editar T√≥picos">üìã</button>
                <button id="btn-edit-links" onclick="window.openFlashLinkManager()" title="Editar Links">‚ö°</button>
                <button id="btn-edit-focus" onclick="window.openFocusModal()" title="Definir Foco">üé®</button>
            </div>

            <!-- Editor de Conte√∫do -->
            <label style="font-size:0.75rem; color:#888; text-transform: uppercase; font-weight: bold;">Conte√∫do</label>
            <div id="edit-card-content" class="flash-editor" contenteditable="true" style="min-height:150px; margin-top: 5px; border: 1px solid #333;"></div>
            
            <!-- Inputs Escondidos para Controlo -->
            <input type="hidden" id="edit-card-index"> 
            <input type="hidden" id="edit-card-verse"> 

            <!-- Rodap√© com A√ß√µes -->
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="document.getElementById('edit-card-modal').style.display='none'" 
                        style="flex:1; padding:12px; background:#333; border:none; color:#ccc; border-radius:6px; cursor:pointer; font-weight: bold;">
                    CANCELAR
                </button>
                <button id="btn-confirm-edit-card" 
                        style="flex:1; padding:12px; background:var(--accent-color); border:none; color:white; border-radius:6px; font-weight:bold; cursor:pointer;">
                    GRAVAR ALTERA√á√ïES
                </button>
            </div>
        </div>
    </div>
</div>


<!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 300px; text-align: center; padding: 20px;">
            <h3 id="confirm-title" style="margin-bottom: 10px; color: #e74c3c;">Aten√ß√£o</h3>
            <p id="confirm-message" style="margin-bottom: 20px; color: #ccc;">Deseja continuar?</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btn-cancel-confirm" style="padding: 8px 15px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button id="btn-ok-confirm" style="padding: 8px 15px; background: #e74c3c; border: none; color: white; border-radius: 4px; font-weight: bold; cursor: pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SELE√á√ÉO DE T√ìPICOS (BIBLE VERSION) -->
<div id="flash-topics-modal" class="modal-overlay" style="z-index: 5000;">
    <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3>T√≥picos do Bloco</h3>
            <button class="modal-close" onclick="document.getElementById('flash-topics-modal').style.display='none'">√ó</button>
        </div>
        <div style="display: flex; flex: 1; overflow: hidden;">
            <!-- Coluna Esquerda: T√≥picos -->
            <div style="flex: 1; border-right: 1px solid #333; padding: 10px; overflow-y: auto;">
                <h4 style="color:#e67e22; font-size:0.8rem; margin-bottom:10px;">T√ìPICOS</h4>
                <ul id="flash-topics-list" style="list-style:none;">Carregando...</ul>
            </div>
            <!-- Coluna Direita: Subt√≥picos -->
            <div style="flex: 1; padding: 10px; overflow-y: auto;">
                <h4 style="color:#3498db; font-size:0.8rem; margin-bottom:10px;" id="flash-sub-title">SUBT√ìPICOS</h4>
                <ul id="flash-subtopics-list" style="list-style:none;">
                    <li style="color:#888; font-style:italic;">Selecione um t√≥pico.</li>
                </ul>
            </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
            <button onclick="document.getElementById('flash-topics-modal').style.display='none'" 
                    style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Confirmar Sele√ß√£o
            </button>
        </div>
    </div>
</div>

<!-- MODAL GEST√ÉO DE LINKS (FLASH VERSION) -->
<div id="flash-links-modal" class="modal-overlay" style="z-index: 5000;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        
        <div class="modal-header">
            <h3>Gest√£o de Links</h3>
            <button class="modal-close" onclick="document.getElementById('flash-links-modal').style.display='none'">√ó</button>
        </div>

        <!-- ABAS -->
        <div class="store-tabs-header" style="padding: 10px; border-bottom: 1px solid #333; display: flex; gap: 10px;">
            <button class="store-tab-btn active" onclick="window.switchFlashLinkTab('refs')">Refer√™ncias</button>
            <button class="store-tab-btn" onclick="window.switchFlashLinkTab('codex')">Codex</button>
            <button class="store-tab-btn" onclick="window.switchFlashLinkTab('cats')">Categorias</button>
        </div>

        <!-- CONTE√öDO DAS ABAS -->
        <div style="flex: 1; overflow-y: auto; padding: 15px;">
            
            <!-- ABA 1: REFER√äNCIAS (URLS) -->
            <div id="flash-tab-refs">
                <label style="color:#888; font-size:0.8rem;">T√≠tulo do Grupo de Links</label>
                <input type="text" id="flash-link-title" class="flash-input-title" style="font-size:1rem; margin-bottom:15px; border-bottom:1px solid #333;" placeholder="Ex: Artigos de apoio...">
                
                <div id="flash-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                
                <button onclick="window.addFlashUrlField()" style="margin-top:10px; padding:6px 12px; background:#333; border:1px solid #555; color:#ccc; cursor:pointer; border-radius:4px;">+ Adicionar URL</button>
            </div>

            <!-- ABA 2: CODEX (AGORA COMPLETO) -->
            <div id="flash-tab-codex" style="display:none;">
                <div id="flash-codex-rows-container">
                    <!-- As linhas complexas do Codex ser√£o injetadas aqui -->
                </div>
                <button onclick="window.createFlashCodexRow()" style="width:100%; margin-top:15px; padding:10px; background:rgba(230, 126, 34, 0.1); border:1px dashed #e67e22; color:#e67e22; cursor:pointer; border-radius:6px;">+ Nova Linha Codex</button>
            </div>

            <!-- ABA 3: CATEGORIAS (COM TOGGLE) -->
            <div id="flash-tab-cats" style="display:none;">
                
                <!-- Barra de Pesquisa + Toggle -->
                <input type="text" id="flash-cat-search" class="flash-input-title" style="font-size:0.9rem;" placeholder="Pesquisar..." oninput="window.searchFlashCategories(this.value)">
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; padding:5px; background:rgba(255,255,255,0.05); border-radius:4px;">
                    <label class="setting-switch">
                        <input type="checkbox" id="flash-bible-toggle">
                        <span class="slider round"></span>
                    </label>
                    <span style="font-size:0.8rem; color:#ccc;">Procurar na B√≠blia (Global)</span>
                </div>

                <div id="flash-cat-results" style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #333; padding:5px;"></div>

                <label style="color:#888; font-size:0.8rem;">Selecionados:</label>
                <div id="flash-cat-selected" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>

        </div>

        <!-- RODAP√â -->
        <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
            <button id="btn-save-flash-links" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Confirmar e Anexar
            </button>
        </div>
    </div>
</div>

<!-- BARRA FLUTUANTE DE SELE√á√ÉO -->
<div id="selection-toolbar">
    <button id="btn-copy-selection" title="Copiar">üìë</button>
    <button id="btn-note-selection" title="Criar Nota Flash">‚úç Nota Flash</button>
</div>

<!-- ECR√É DE CARREGAMENTO (OVERLAY) -->
<div id="loading-overlay">
    <div class="spinner-main"></div>
    <p style="margin-top: 15px; color: #888; font-size: 0.9rem; letter-spacing: 1px;">A CARREGAR TEXTO E NOTAS...</p>
</div>


<!-- MODAL DE MARCADORES (Painel de Navega√ß√£o) -->
<div id="bookmarks-navigator-modal" class="modal-overlay" style="z-index: 6000;">
    <div class="modal-content" style="height: 80vh; max-height: 600px; display:flex; flex-direction:column;">
        <div class="modal-header">
            <!-- Bot√£o Voltar (aparece s√≥ quando dentro de uma categoria) -->
            <button id="bk-nav-back" style="display:none; background:none; border:none; color:var(--accent-color); font-size:1.2rem; cursor:pointer; margin-right:10px;">‚¨Ö</button>
            <h3 id="bk-nav-title" style="color:var(--text-color); font-size:1.1rem;">Meus Marcadores</h3>
            <button class="modal-close" onclick="document.getElementById('bookmarks-navigator-modal').style.display='none'">√ó</button>
        </div>
        
        <div class="details-body" id="bk-nav-content" style="padding:0;">
            <!-- Lista ser√° injetada aqui -->
        </div>
    </div>
</div>

<!-- MODAL DE SELE√á√ÉO DE MARCADOR B√çBLICO -->
<div id="bible-bookmark-modal" class="modal-overlay" style="z-index: 7000;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Escolher Marcador</h3>
            <button class="modal-close" onclick="document.getElementById('bible-bookmark-modal').style.display='none'">√ó</button>
        </div>
        
        <div class="details-body">
            <p style="color:#888; font-size:0.9rem; margin-bottom:15px;">
                Associe <strong><span id="bk-verse-target"></span></strong> a uma categoria:
            </p>

            <!-- Lista de Marcadores -->
            <ul id="bible-bookmark-list" style="list-style:none; max-height:300px; overflow-y:auto; margin-bottom:15px;">
                <!-- Preenchido via JS -->
            </ul>

            <!-- Criar Novo -->
            <div style="border-top:1px solid #333; padding-top:10px; display:flex; gap:5px;">
                <input type="text" id="new-bookmark-input" placeholder="Novo g√©nero..." 
                       style="flex:1; background:#111; border:1px solid #333; color:white; padding:8px; border-radius:4px;">
                <button onclick="window.createNewBookmarkGenre()" 
                        style="background:var(--accent-color); color:white; border:none; padding:0 15px; border-radius:4px; cursor:pointer;">+</button>
            </div>
        </div>
    </div>
</div>

<!-- PAINEL DE NAVEGA√á√ÉO R√ÅPIDA DE CAP√çTULOS -->
<div id="chapter-nav-panel" class="hidden">
    <!-- Os n√∫meros dos cap√≠tulos ser√£o gerados aqui via JS -->
</div>

<!-- MODAL DE √ÇNCORAS DA B√çBLIA -->
<div id="bible-anchors-modal" class="modal-overlay" style="z-index: 8000;">
    <div class="modal-content" style="max-width: 450px; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3>√Çncoras neste Cap√≠tulo</h3>
            <button class="modal-close" onclick="document.getElementById('bible-anchors-modal').style.display='none'">√ó</button>
        </div>
        <div style="padding: 10px; background: #252528; border-bottom: 1px solid #333; font-size: 0.85rem; color: #aaa;">
            A mostrar itens com a √¢ncora <strong>"B√≠blia"</strong> encontrados no texto.
        </div>
        <ul id="bible-anchors-list" class="verse-list" style="flex: 1; overflow-y: auto; list-style: none; padding: 0;">
            <!-- Lista gerada via JS -->
        </ul>
    </div>
</div>

<!-- MODAL DE AVISO (SUBSTITUI O ALERT) -->
<div id="custom-alert-modal" class="modal-overlay" style="z-index: 99999;">
    <div class="modal-content" style="max-width: 300px; text-align: center; padding: 25px; height: auto; border: 1px solid #e74c3c;">
        <div style="font-size: 2rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h3 style="margin-bottom: 10px; color: #e74c3c; text-transform: uppercase;">Aten√ß√£o</h3>
        <p id="custom-alert-msg" style="margin-bottom: 25px; color: #fff; font-size: 1rem; line-height: 1.4;"></p>
        
        <button onclick="document.getElementById('custom-alert-modal').style.display='none'" 
                style="padding: 10px 0; background: #e74c3c; border: none; color: white; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; font-size: 0.9rem;">
            ENTENDIDO
        </button>
    </div>
</div>

<!-- MODAL DE VISUALIZA√á√ÉO DE FONTES (LINKS/CODEX) -->
<div id="view-sources-modal" class="modal-overlay" style="z-index: 15000;">
    <div class="modal-content" style="max-width: 400px; max-height: 80vh;">
        <div class="modal-header">
            <h3>üìé Fontes & Refer√™ncias</h3>
            <button class="modal-close" onclick="document.getElementById('view-sources-modal').style.display='none'">√ó</button>
        </div>
        <div class="details-body" id="view-sources-content" style="padding: 15px;">
            <!-- Conte√∫do injetado via JS -->
        </div>
    </div>
</div>

<!-- Modal de Foco -->
<div id="flash-focus-modal" class="modal-overlay" style="z-index: 13000;">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
            <h3>üé≠ Definir Foco</h3>
            <button class="modal-close" onclick="document.getElementById('flash-focus-modal').style.display='none'">√ó</button>
        </div>
        <div class="details-body" id="flash-focus-list">
            <!-- Gerado via JS -->
        </div>
    </div>
</div>

<!-- MODAL DE PESQUISA B√çBLICA -->
<div id="bible-search-modal" class="modal-overlay" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 500px; height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3 style="color:var(--accent-color);">üîç Pesquisar na B√≠blia</h3>
            <button class="modal-close" onclick="document.getElementById('bible-search-modal').style.display='none'">√ó</button>
        </div>
        
        <div style="padding: 15px; background: #252528; border-bottom: 1px solid #333;">
            <input type="text" id="bible-search-input" placeholder='Ex: "jesus" "pedra" ou "amor"' 
                   style="width: 100%; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; border-color: var(--accent-color);">
            
          <div id="scope-toggle-container" style="display: none; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #444;">
    <span style="font-size: 0.85rem; color: #aaa;">√Çmbito da pesquisa:</span>
    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="label-verse" style="font-size: 0.8rem; color: var(--accent-color); font-weight: bold;">VERS√çCULO</span>
        <label class="setting-switch">
            <input type="checkbox" id="search-scope-toggle">
            <span class="slider round"></span>
        </label>
        <span id="label-chapter" style="font-size: 0.8rem; color: #666;">CAP√çTULO</span>
    </div>
</div>
        </div>

        <div id="bible-search-results" style="flex: 1; overflow-y: auto; padding: 10px;">
            <div style="text-align: center; color: #555; margin-top: 50px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üìñ</div>
                <p>Digite termos entre aspas para filtros espec√≠ficos.<br>Ex: "f√©" "obras"</p>
            </div>
        </div>
        
        <div id="search-status-bar" style="padding: 8px 15px; background: #1a1a1d; border-top: 1px solid #333; font-size: 0.75rem; color: #888; display: flex; justify-content: space-between;">
            <span id="search-count">Aguardando...</span>
            <span id="search-progress"></span>
        </div>
    </div>
</div>

<div id="search-modal-container"></div>


  <script type="module">
        import { BIBLE_DATA } from './js/bible-data.js';
        import { db, auth } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { SIGLAS_PUBLICACOES } from './js/siglas-data.js'; 


        // --- ESTADO GLOBAL ---
        let currentView = 'books';
        let selectedBook = null;
        let selectedChapter = null;
        let currentUser = null;
        
        let existingUserData = {}; 
        let activeVerseFullName = ""; 
        let activeVerseDocId = ""; 

        // Configura√ß√µes do Utilizador
        let userConfig = {
            verseTextSize: 100,
            cardTextSize: 100,
              tileSize: 100,
            viewMode: 'list' // 'list' = Grelha (padr√£o), 'text' = Sequ√™ncia
        };
        let currentFlashTopics = {}; // Formato: { "topicID": ["subID1", "subID2"] }
let activeTopicIdForFlash = null;
let currentFlashLinks = {};
let currentSelectionRange = null;
let currentSelectedText = "";
let currentSelectedVerses = [];
let currentSelectionText = "";
let currentSelectionVerses = []; // Array de IDs: ["G√©nesis 1:1", "G√©nesis 1:2"]
let selectedColorHex = null; // Cor escolhida
let currentChapterHighlights = [];
let activeHighlightContext = null;
let startY = 0;
let startHeight = 0;
let isDragging = false;
let verseObserver = null;
let isFirstLoad = true;
let currentFlashFocus = null;
let allSearchResults = [];
let currentSearchPage = 0;
const resultsPerPage = 300;
let searchFilterTestament = 'all';
let searchSelectedBook = null;
let booksWithHits = new Set();
let bibleSearchTimeout = null;


        // --- REFER√äNCIAS DOM ---
        const viewBooks = document.getElementById('view-books');
        const viewChapters = document.getElementById('view-chapters');
        const viewVerses = document.getElementById('view-verses');
        const chaptersGrid = document.getElementById('chapters-grid');
        const versesList = document.getElementById('verses-list');
        const pageTitle = document.getElementById('page-title');
        const backBtn = document.getElementById('back-btn');
        
        // Modais
        const verseModal = document.getElementById('verse-details-modal');
        const flashModal = document.getElementById('flash-note-modal');
        const settingsModal = document.getElementById('settings-modal');
        
        // Bot√µes
        const btnAddFlash = document.getElementById('btn-add-flash-note');
        const btnSaveFlash = document.getElementById('btn-save-flash');
        if (document.getElementById('btn-save-flash')) {
    document.getElementById('btn-save-flash').onclick = window.saveFlashNoteGlobal;
}
        const settingsBtn = document.getElementById('settings-btn');
        const btnSaveCfg = document.getElementById('btn-save-cfg');
        const btnToggleView = document.getElementById('btn-toggle-view');
const panel = document.getElementById('side-panel');
const localBibleCache = {}; 


// Cores Dispon√≠veis
const HIGHLIGHT_COLORS = [
    { name: 'Laranja', hex: '#e67e22' },
    { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' },
    { name: 'Verde', hex: '#2ecc71' },
    { name: 'Lil√°s', hex: '#9b59b6' },
    { name: 'Rosa', hex: '#ff7979' },
    { name: 'Vermelho', hex: '#e74c3c' },
    { name: 'Castanho', hex: '#a0522d' },
    { name: 'Cinzento', hex: '#95a5a6' }
];
 const initialUrlSearch = window.location.search; 
const FLASH_FOCUS_OPTIONS = {
    default: [ 
        // Removido o "Original" daqui
        { id: "resumo", name: "Resumo", color: "#1a3a5f" },
        { id: "estudo_pessoal", name: "Estudo Pessoal", color: "#4169E1" },
         { id: "perola", name: "P√©rola", color: "#0032FD" },
        { id: "ponto_chave", name: "Ponto Chave", color: "#85C1E9" },
        { id: "palestra", name: "Palestra", color: "#5c6bc0" }
    ],
    question: [ 
        // Removido o "Original" daqui
        { id: "revisao", name: "Pergunta Revis√£o", color: "#2B6467" },
        { id: "dilema", name: "Dilema", color: "#052c1e" },
        { id: "hipotese", name: "Hip√≥tese", color: "#27ae60" },
        { id: "paradoxo", name: "Paradoxo", color: "#82e0aa" }
    ]
};
// --- DICION√ÅRIO DE R√ìTULOS DE FOCO ---
const FOCUS_LABELS = {
    // Subnotas
    resumo: "Resumo",
    estudo_pessoal: "Estudo Pessoal",
    perola: "P√©rola",
    ponto_chave: "Ponto Chave",
    palestra: "Palestra",
    // Quest√µes
    revisao: "Pergunta Revis√£o",
    dilema: "Dilema",
    hipotese: "Hip√≥tese",
    paradoxo: "Paradoxo",
    // Contentores
    reflexao: "Reflex√£o",
    desafio: "Desafio",
    exemplo: "Exemplo Pr√°tico",
    transcricao: "Transcri√ß√£o",
    rascunho: "Rascunho",
    camaleao: "Camale√£o",
    // Consultor
    revisao_lit: "Revis√£o Liter√°ria",
    bibliografia: "Bibliografia",
    discurso: "Discurso",
    rastreador: "Rastreador"
};

        // --- AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---
   const globalShield = document.getElementById('global-auth-shield');

onAuthStateChanged(auth, async (user) => {
    // 1. VERIFICA√á√ÉO: UTILIZADOR N√ÉO AUTENTICADO
    if (!user) {
        console.warn("‚õî Acesso n√£o autorizado. Redirecionando para 404...");
        window.location.href = "404.html";
        return;
    } 
    
    // 2. VERIFICA√á√ÉO: UTILIZADOR AUTENTICADO
    else {
        try {
            // Consulta o perfil do utilizador na base de dados
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            // Se o documento n√£o existe ou o campo 'aceite' n√£o √© 'on'
            if (!userDocSnap.exists() || userDocSnap.data().aceite !== "on") {
                console.warn("‚è≥ Conta pendente ou inv√°lida. Redirecionando para espera...");
                window.location.href = "index.html"; // Volta para a tela de "Pendente"
                return;
            }

            // --- SUCESSO: CONTA APROVADA (aceite = "on") ---
            currentUser = user; // Define a vari√°vel global essencial

            // A. Carrega configura√ß√µes do utilizador (Tamanhos, Cores, Modos)
            await loadUserConfig(); 
            
            // B. Inicializa o M√≥dulo de Pesquisa (Injeta HTML do Modal e Filtros)
            // Isto garante que a lupa e os filtros (AT/NT) funcionam imediatamente
            if (typeof window.initializeBibleSearch === 'function') {
                window.initializeBibleSearch();
            }

            // C. Recupera o estado do URL (Livro/Cap√≠tulo/Vers√≠culo)
            // Se o URL for "bible.html?b=G√©nesis&c=1", ele abre l√° direto
            await loadStateFromUrl(); 
            
            // D. Remove o escudo de carregamento (A Revela√ß√£o)
            setTimeout(() => {
                // Revela o corpo do site
                document.body.style.opacity = "1";
                
                // Desvanece o escudo preto
                if(globalShield) globalShield.classList.add('fade-out');
                
                // Marca que o carregamento inicial terminou
                isFirstLoad = false; 
                
                console.log("‚úÖ Aplica√ß√£o carregada. Utilizador:", currentUser.email);
            
            }, 500);

        } catch (error) { 
            console.error("Erro cr√≠tico no carregamento inicial:", error); 
            // Em caso de erro de rede ou permiss√µes, manda para o index por seguran√ßa
            window.location.href = "index.html";
        }
    }
});

        // --- L√ìGICA DE CONFIGURA√á√ïES ---
    async function loadUserConfig() {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'configuracoes', currentUser.uid);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.bibleVerseSize) userConfig.verseTextSize = data.bibleVerseSize;
                    if (data.bibleCardSize) userConfig.cardTextSize = data.bibleCardSize;
                    if (data.bibleViewMode) userConfig.viewMode = data.bibleViewMode;
                    
                    // >>> LINHA NOVA:
                    if (data.bibleTileSize) userConfig.tileSize = data.bibleTileSize;
                }
                applyConfigToUI();
            } catch (e) {
                console.error("Erro ao carregar configs:", e);
            }
        }

       function applyConfigToUI() {
            document.documentElement.style.setProperty('--verse-size-pct', `${userConfig.verseTextSize}%`);
            document.documentElement.style.setProperty('--card-size-pct', `${userConfig.cardTextSize}%`);
            
            // >>> LINHA NOVA: Aplica ao CSS (sem o s√≠mbolo % porque usamos calc)
            document.documentElement.style.setProperty('--tile-size-pct', userConfig.tileSize);
            
            const dispVerse = document.getElementById('disp-verse-size');
            const dispCard = document.getElementById('disp-card-size');
            
            // >>> LINHA NOVA: Atualiza mostrador do modal
            const dispTile = document.getElementById('disp-tile-size');

            if(dispVerse) dispVerse.innerText = `${userConfig.verseTextSize}%`;
            if(dispCard) dispCard.innerText = `${userConfig.cardTextSize}%`;
            
            // >>> LINHA NOVA:
            if(dispTile) dispTile.innerText = `${userConfig.tileSize}%`;

            if (userConfig.viewMode === 'text') {
                versesList.classList.add('sequence-mode');
                btnToggleView.innerText = "Texto (Sequ√™ncia)";
                btnToggleView.style.borderColor = "var(--accent-color)";
            } else {
                versesList.classList.remove('sequence-mode');
                btnToggleView.innerText = "Lista (Grelha)";
                btnToggleView.style.borderColor = "#444";
            }
        }

     window.changeConfig = (type, delta) => {
            if (type === 'verse') {
                let novo = userConfig.verseTextSize + delta;
                if (novo >= 80 && novo <= 300) userConfig.verseTextSize = novo;
            } else if (type === 'card') {
                let novo = userConfig.cardTextSize + delta;
                if (novo >= 80 && novo <= 300) userConfig.cardTextSize = novo;
            } 
            // >>> BLOCO NOVO:
            else if (type === 'tile') {
                let novo = userConfig.tileSize + delta;
                // Limites: M√≠nimo 50%, M√°ximo 200%
                if (novo >= 50 && novo <= 200) userConfig.tileSize = novo;
            }
            
            applyConfigToUI();
        };

        window.toggleViewMode = () => {
            userConfig.viewMode = userConfig.viewMode === 'list' ? 'text' : 'list';
            applyConfigToUI();
        };

        settingsBtn.onclick = () => {
            settingsModal.style.display = 'flex';
        };

      btnSaveCfg.onclick = async () => {
            btnSaveCfg.innerText = "A gravar...";
            try {
                await setDoc(doc(db, 'configuracoes', currentUser.uid), {
                    bibleVerseSize: userConfig.verseTextSize,
                    bibleCardSize: userConfig.cardTextSize,
                    bibleViewMode: userConfig.viewMode,
                    
                    // >>> LINHA NOVA: Grava na base de dados
                    bibleTileSize: userConfig.tileSize 
                    
                }, { merge: true });

                settingsModal.style.display = 'none';
            } catch (e) {
                console.error("Erro:", e);
                // Pode usar o seu novo alerta aqui ;)
                window.showCustomAlert("Erro ao gravar configura√ß√µes.");
            } finally {
                btnSaveCfg.innerText = "GRAVAR E FECHAR";
            }
        };


        // --- FUN√á√ïES DE UTILIDADE ---
        function generateDocId(bookName, chapter, verse) {
            const slug = bookName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ /g, "_");
            return `${slug}_${chapter}_${verse}`;
        }

        // --- RENDERIZA√á√ÉO DA B√çBLIA ---
function renderBooks() {
    viewBooks.innerHTML = '';
    const hebraico = BIBLE_DATA.filter(b => b.id <= 39);
    const grego = BIBLE_DATA.filter(b => b.id >= 40);

    const createSection = (title, books) => {
        const h2 = document.createElement('h2'); 
        h2.className = 'section-title'; 
        h2.innerText = title; 
        viewBooks.appendChild(h2);
        
        const grid = document.createElement('div'); 
        grid.className = 'grid';
        
        books.forEach(book => {
            const tile = document.createElement('div'); 
            tile.className = 'tile'; 
            
            // --- L√ìGICA DE CORES ATUALIZADA ---

         // 1. ROXO ESCURO: Pentateuco (1-5) e Atos (44)
            if ((book.id >= 1 && book.id <= 5) || book.id === 44) {
                tile.classList.add('tile-purple-dark');
            }
            
            // 2. LIL√ÅS M√âDIO: 
            // Hist√≥ricos (Josu√©-Ester: 6-17) e Cartas Paulinas + Hebreus (45-58)
            // ALTERA√á√ÉO: O limite superior mudou de 65 para 58 (Hebreus)
            else if ((book.id >= 6 && book.id <= 17) || (book.id >= 45 && book.id <= 58)) {
                tile.classList.add('tile-lilac-medium');
            }

            // 3. AZUL ARD√ìSIA (Cor de J√≥): 
            // Po√©ticos (J√≥-C√¢ntico: 18-22) + Cartas Gerais (Tiago-Judas: 59-65)
            // ALTERA√á√ÉO: Adicion√°mos o grupo 59-65 aqui
            else if ((book.id >= 18 && book.id <= 22) || (book.id >= 59 && book.id <= 65)) {
                tile.classList.add('tile-slate-blue');
            }

            // 4. LARANJA FERRUGEM: 
            // Profetas Maiores (Isa√≠as-Daniel: 23-27), Evangelhos (40-43) e Apocalipse (66)
            else if ((book.id >= 23 && book.id <= 27) || (book.id >= 40 && book.id <= 43) || book.id === 66) {
                tile.classList.add('tile-rust');
            }

            // 5. CASTANHO: Profetas Menores (28-39)
            else if (book.id >= 28 && book.id <= 39) {
                tile.classList.add('tile-brown');
            }
            
            // Fallback
            else {
                tile.classList.add('tile-lilac-medium');
            }

            tile.innerText = book.abrev;
            tile.onclick = () => openChapters(book); 
            grid.appendChild(tile);
        });
        viewBooks.appendChild(grid);
    };

    createSection('Escrituras Hebraico-Aramaicas', hebraico);
    createSection('Escrituras Gregas Crist√£s', grego);
    updateUI('books');
}

      function openChapters(book) {
    selectedBook = book; 
    chaptersGrid.innerHTML = '';
    
    for (let i = 1; i <= book.caps; i++) {
        const tile = document.createElement('div'); 
        tile.className = 'tile'; 
        tile.innerText = i;
        tile.onclick = () => openVerses(i); 
        chaptersGrid.appendChild(tile);
    }
    
    // Chama a UI atualizada
    updateUI('chapters');
}

async function openVerses(chapter) {
    // --- NOVO: For√ßar o scroll do contentor para o topo ---
    const container = document.querySelector('.container');
    if (container) container.scrollTop = 0;
    // -----------------------------------------------------
 window.closeSidePanel(); 

    // 1. ATIVAR O LOADING IMEDIATAMENTE
    const loader = document.getElementById('loading-overlay');
    if (loader) loader.style.display = 'flex';

    // Pequeno delay para garantir que o browser renderiza o loader antes de bloquear a thread
    await new Promise(r => setTimeout(r, 50));

    try {
        selectedChapter = chapter; 
        versesList.innerHTML = ''; 
        existingUserData = {}; 
        currentChapterHighlights = []; 
        
        applyConfigToUI();

        const totalVerses = selectedBook.versiculos[chapter - 1] || 50;
        
        // Array para guardar as promessas de carregamento do texto
        const textLoadPromises = [];

        // Constru√ß√£o do DOM (Placeholders)
        for (let i = 1; i <= totalVerses; i++) {
            const row = document.createElement('div'); 
            row.className = 'verse-item';
            
  row.setAttribute('data-vnum', i);

            const spanId = `vtext-${i}`; 
            const numId = `vnum-${i}`;
            
            row.innerHTML = `
                <span id="${numId}" class="verse-number" onclick="window.openModalForVerse(${i})">${i}</span>
                <span id="${spanId}" class="verse-text loading-text">...</span>
            `;
            versesList.appendChild(row);
            
            // Inicia o download do texto
            textLoadPromises.push(fetchVerseText(selectedBook.nome, chapter, i, spanId));
        }

        // Muda a vista para Vers√≠culos (o loader ainda est√° por cima a tapar tudo)
        updateUI('verses');

           setupScrollObserver(); 

        // 2. ESPERA QUE TODO O TEXTO B√çBLICO CHEGUE
        await Promise.all(textLoadPromises);

        // 3. CARREGA DADOS DO UTILIZADOR E DESENHA OS PICOTADOS
        if (currentUser) {
            // Esta fun√ß√£o j√° chama o window.refreshVisualHighlights() no final da execu√ß√£o
            await loadUserDataForChapter(selectedBook.nome, chapter);
        }

    } catch (error) {
        console.error("Erro cr√≠tico ao abrir cap√≠tulo:", error);
        alert("Ocorreu um erro ao carregar o cap√≠tulo.");
    } finally {
        // 4. S√ì AGORA ESCONDE O LOADER
        // Um pequeno delay extra (300ms) d√° uma sensa√ß√£o de suavidade e garante que o CSS dos picotados "assentou"
        if (loader) {
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300);
        }
    }
}

 async function loadUserDataForChapter(bookName, chapter) {
    const prefix = `${bookName} ${chapter}:`; // Ex: "G√©nesis 1:"
    
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Pesquisa por prefixo (apanha G√©nesis 1:1, 1:2, etc.)
        const q = query(
            collection(db, "textosbiblicos"), 
            where("userId", "==", currentUser.uid), 
            where("nome", ">=", prefix), 
            where("nome", "<=", prefix + "\uf8ff")
        );
        
        const snapshot = await getDocs(q);
        
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const parts = data.nome.split(':');
            
            if (parts.length > 1) {
                const verseNum = parts[1].trim(); // O n√∫mero "1" ou "1-2"
                
                // --- PROTE√á√ÉO CONTRA DUPLICADOS VAZIOS ---
                // Verifica se j√° carreg√°mos dados para este vers√≠culo antes
                if (existingUserData[verseNum]) {
                    const dadosAtuais = existingUserData[verseNum];
                    
                    // Se o que j√° temos tem notas, e o novo est√° vazio... IGNORA O NOVO!
                    if (dadosAtuais.puzzleBoard && dadosAtuais.puzzleBoard.length > 0) {
                        if (!data.puzzleBoard || data.puzzleBoard.length === 0) {
                            console.warn(`üõ°Ô∏è Ignorado documento duplicado vazio (${docSnap.id}) para V${verseNum}. Mantido o original (${dadosAtuais.docId}).`);
                            return; // Salta fora, n√£o substitui
                        }
                    }
                }
                // -----------------------------------------

                // Guarda os dados na cache
                existingUserData[verseNum] = { ...data, docId: docSnap.id };

                // Marca o n√∫mero do vers√≠culo a laranja se tiver dados
                const hasData = (data.puzzleBoard?.length > 0) || (data.dossie?.length > 0) || (data.panelLinks?.length > 0);
                if (hasData) {
                    const firstNum = parseInt(verseNum.split('-')[0]);
                    const numEl = document.getElementById(`vnum-${firstNum}`);
                    if (numEl) numEl.classList.add('has-data');
                }
            }
        });

        // Redesenha os picotados no final
        if (typeof window.refreshVisualHighlights === 'function') {
            window.refreshVisualHighlights();
        }

    } catch (e) { console.error("Erro a carregar dados user:", e); }
}

async function fetchVerseText(bookName, chapter, verse, elementId) {
    const span = document.getElementById(elementId);
    const filename = getBibleFilename(bookName); // ex: "exodo"

    try {
        if (!localBibleCache[filename]) {
            const response = await fetch(`./js/bible/${filename}.json`);
            if (!response.ok) throw new Error("Livro n√£o encontrado");
            localBibleCache[filename] = await response.json();
        }

        let textoBiblico = "";
        
        try {
            const capStr = chapter.toString();
            const verStr = verse.toString();
            
            // CORRE√á√ÉO AQUI: 
            // Acessamos localBibleCache[filename] (o arquivo)
            // Depois acessamos [bookName] (a chave "√äxodo" dentro do arquivo)
            // Depois o cap√≠tulo e o vers√≠culo
            if (localBibleCache[filename][bookName]) {
                textoBiblico = localBibleCache[filename][bookName][capStr][verStr];
            }
        } catch (err) {
            console.warn(`Vers√≠culo n√£o encontrado: ${bookName} ${chapter}:${verse}`);
        }

        if (textoBiblico) {
            span.innerText = textoBiblico.replace(/\s+/g, ' ').trim();
            span.classList.remove('loading-text');
        } else {
            span.innerText = "Texto indispon√≠vel.";
        }

    } catch (error) {
        console.error(`Erro ao carregar ${filename}:`, error);
        span.innerText = "Erro de carregamento.";
    }
}

function cleanMicaContent(snippet) {
    if (!snippet) return "";
    
    let decoded = "";
    try {
        // Tenta decodificar apenas se parecer estar codificado (cont√©m % ou similar)
        if (typeof snippet === 'string' && (snippet.includes('%') || snippet.includes('+'))) {
            decoded = decodeURIComponent(snippet);
        } else {
            decoded = snippet;
        }
    } catch (e) {
        console.warn("‚ö†Ô∏è Falha ao decodificar snippet, usando formato original:", e);
        decoded = snippet; // Se falhar (URI malformed), usa o original sem travar
    }

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = decoded;
    
    let title = "";
    const titleInput = tempDiv.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
    const h2 = tempDiv.querySelector('h2');
    
    if (titleInput) title = titleInput.value || titleInput.getAttribute('value') || "";
    else if (h2) title = h2.textContent;

    let content = "";
    const contentDiv = tempDiv.querySelector('.mini-note-content, .toggle-content, .redator-content, .sign-content, .card-desc-content, .cube-content');
    
    if (contentDiv) content = contentDiv.innerHTML; 
    else content = tempDiv.innerHTML;

    // Remove emojis de controlo
    content = content.replace(/üîê|üî∫|üîª|‚ö°|üß¨|üé®|üìã|üóëÔ∏è/g, '').trim();

    let finalHtml = "";
    if (title && title !== "Texto da Nota") {
        finalHtml += `<div style="font-weight:bold; color:white; margin-bottom:5px;">${title}</div>`;
    }
    
    finalHtml += `<div style="color:#ddd; font-size:0.9em;">${content}</div>`;

    return finalHtml || "Conte√∫do vazio.";
}

        // --- MODAL DE DETALHES ---
 // --- MODAL DE DETALHES ---
 // Fun√ß√£o para fechar a sidebar
     window.closeSidePanel = () => {
    const panel = document.getElementById('side-panel');
    
    // 1. Limpezas visuais
    panel.classList.remove('read-only-mode');
    if (typeof highlightAnchorInText === 'function') highlightAnchorInText(null);
    document.querySelectorAll('.verse-number.active-selection').forEach(el => el.classList.remove('active-selection'));

    // 2. L√≥gica de Fecho R√°pido
    if (window.innerWidth <= 768) {
        // Desliza para baixo
        panel.style.transform = "translateY(100%)";
        
        // Espera apenas 150ms (muito r√°pido) para limpar
        setTimeout(() => {
            panel.classList.remove('open');
            panel.style.height = "0"; 
            panel.style.transform = ""; 
        }, 150); // <--- Reduzido de 300 para 150
    } else {
        // No PC √© instant√¢neo (apenas remove a classe)
        panel.classList.remove('open');
    }

    // 3. Atualiza URL
    if (selectedBook && selectedChapter && typeof updateUrlParams === 'function') {
        updateUrlParams(selectedBook.nome, selectedChapter, null);
    }
};

window.openModalForVerse = async (num) => {
    // 1. Reset Global
    window.hideSelectionToolbar();
    activeHighlightContext = null; 
    currentSelectionText = ""; 
    selectedColorHex = null;

    // Atualiza URL
    if (typeof updateUrlParams === 'function') {
        updateUrlParams(selectedBook.nome, selectedChapter, num);
    }

    activeVerseFullName = `${selectedBook.nome} ${selectedChapter}:${num}`;
    
    // --- L√ìGICA UNIFICADA: USAR SEMPRE O SIDE PANEL ---
    const sidePanel = document.getElementById('side-panel');
    const titleEl = document.getElementById('sidebar-verse-title');
    const contentDiv = document.getElementById('sidebar-content');
    const centerActions = document.getElementById('sidebar-center-actions');
    const backBtn = document.getElementById('sidebar-back-btn');

    // 2. Verificar cache para Marcadores
    const cachedData = existingUserData[num];
    const hasBookmarks = cachedData && cachedData.marcadoresAssociados && Object.keys(cachedData.marcadoresAssociados).length > 0;

    // 3. Preparar T√≠tulo e Bot√µes
    let titleHTML = hasBookmarks 
        ? `<span class="bookmark-icon-title" onclick="window.manageBibleBookmark('${num}')" title="Gerir/Remover Marcadores">üîñ</span>${activeVerseFullName}`
        : activeVerseFullName;

    const bookmarkBtnHtml = !hasBookmarks 
        ? `<button class="btn-bookmark" onclick="window.openBibleBookmarkModal('${num}')">+ üîñ</button>` 
        : ``;

    const buttonsHtml = `
        <div style="display:flex; align-items:center;">
            <button class="btn-create-note" onclick="window.handleCreateNoteClick()" style="margin: 0;">
                + üìù
            </button>
            ${bookmarkBtnHtml}
        </div>
    `;

    // 4. Configurar UI do Painel
    titleEl.innerHTML = titleHTML;
    backBtn.style.display = 'none'; // N√£o h√° "voltar" na vista inicial do vers√≠culo
    
    if (centerActions) {
        centerActions.style.display = 'block'; 
        centerActions.innerHTML = buttonsHtml;
    }

    // 5. ABRIR O PAINEL (L√≥gica Mobile vs PC)
    sidePanel.classList.add('open'); // Ativa a classe CSS base

    if (window.innerWidth <= 768) {
        // --- MOBILE: Define a altura para 75% ---
        sidePanel.style.height = '75vh'; 
    } else {
        // --- PC: Limpa a altura (usa o CSS 100% height) ---
        sidePanel.style.height = ''; 
    }
    
    // 6. Carregar Conte√∫do (Spinner)
    contentDiv.innerHTML = `
        <div class="spinner-container" style="padding: 40px; text-align: center; color: #888;">
            <div class="spinner"></div><br>A carregar notas...
        </div>`;

    // 7. L√≥gica de Dados (Firebase/Cache) - Igual ao anterior
    let data = cachedData;
    if (!data) {
        try {
            const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(
                collection(db, 'textosbiblicos'), 
                where('nome', '==', activeVerseFullName),
                where('userId', '==', currentUser.uid)
            );
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                data = { ...snapshot.docs[0].data(), docId: snapshot.docs[0].id };
                existingUserData[num] = data;
            }
        } catch (e) { console.error(e); }
    }

    activeVerseDocId = data ? data.docId : null;
    const htmlContent = buildVerseHTML(data, num);
    contentDiv.innerHTML = htmlContent;
};


        // --- FUN√á√ÉO AUXILIAR DE RENDERIZA√á√ÉO (Para evitar c√≥digo duplicado) ---
function buildVerseHTML(data, num) {
    const puzzleCount = data?.puzzleBoard?.length || 0;
    const dossieCount = data?.dossie?.length || 0;
    const linksCount  = data?.panelLinks?.length || 0;
    const totalCount = puzzleCount + dossieCount + linksCount;

    if (totalCount === 0) {
        return '<p class="empty-msg" style="padding:20px; text-align:center;">Sem registos.</p>';
    }

    const parser = new DOMParser(); // Instanciado aqui para uso global na fun√ß√£o
    let puzzleHtml = "";
    let dossieHtml = "";
    let linksHtml  = "";

    // --- A. PUZZLE (CART√ïES DE NOTAS) ---
    if (puzzleCount > 0) {
        data.puzzleBoard.forEach((item, index) => {
            const displayHtml = cleanMicaContent(item.snippet || item.content);
            let raw = "";
            try {
                raw = (item.snippet && item.snippet.includes('%')) ? decodeURIComponent(item.snippet) : (item.snippet || "");
            } catch (e) { raw = item.snippet || ""; }

            const docHTML = parser.parseFromString(raw, 'text/html');
            const wrapper = docHTML.querySelector('.mini-note-wrapper, .redator-wrapper');

            let icon = "üìò"; 
            let label = "Subnota";
            let borderColor = item.noteColor || "#4a90e2";

            if (raw.includes("consultor-mode")) { icon = "üìï"; label = "Consultor"; borderColor = "#c0392b"; }
            else if (raw.includes("question-mode")) { icon = "üìó"; label = "Quest√£o"; borderColor = "#2ecc71"; }
            else if (raw.includes("free-mode")) { icon = "üìô"; label = "Contentor"; borderColor = "#e67e22"; }
            else if (raw.includes("redator-wrapper")) { icon = "üìì"; label = "Redator"; borderColor = "#555555"; }

            if (wrapper) {
                const focusId = wrapper.getAttribute('data-focus');
                if (focusId && FOCUS_LABELS[focusId]) {
                    label = FOCUS_LABELS[focusId];
                    if (focusId === 'perola') borderColor = "#0661e0";
                    else if (focusId === 'estudo_pessoal') borderColor = "#4169E1";
                }
            }

            const boxLinks = window.extractBoxLinksFromSnippet(item.snippet);
            let btnSources = "";
            if (boxLinks) {
                const safeJson = encodeURIComponent(JSON.stringify(boxLinks));
                btnSources = `<button onclick="window.viewCardSources('${safeJson}')" style="color:var(--accent-color); font-weight:bold;">üìé Fontes</button>`;
            }

            const menuHtml = `
                <div class="card-menu-container">
                    <div class="card-menu-btn" onclick="window.toggleCardMenu(this)">‚Ä¢‚Ä¢</div>
                    <div class="card-dropdown">
                        <button onclick="window.openEditCard('${num}', ${index})">‚úèÔ∏è Editar</button>
                        ${btnSources}
                        <button class="btn-remove-card" onclick="window.deletePuzzleItem('${num}', ${index})">üóëÔ∏è Remover</button>
                    </div>
                </div>`;

            puzzleHtml += `
                <div class="detail-card" style="border-left: 4px solid ${borderColor}; position: relative;">
                    ${menuHtml}
                    <div class="ref-card-category-label" style="color: ${borderColor};">
                        ${icon} ${label}
                    </div>
                    ${displayHtml}
                </div>`;
        });
    }

    // --- B. DOSSI√â (MICAS) ---
    if (dossieCount > 0) {
        data.dossie.forEach((mica) => {
            let itemsList = "";
            const micaColor = mica.cor || mica.color || mica.noteColor || '#e74c3c';

            if(mica.items && mica.items.length > 0) {
                mica.items.forEach((mi) => {
                    // Detec√ß√£o de Metadados para o Card dentro da Mica
                    let rawMica = "";
                    try {
                        rawMica = (mi.snippet && mi.snippet.includes('%')) ? decodeURIComponent(mi.snippet) : (mi.snippet || "");
                    } catch (e) { rawMica = mi.snippet || ""; }

                    const micaDoc = parser.parseFromString(rawMica, 'text/html');
                    const micaWrapper = micaDoc.querySelector('.mini-note-wrapper, .redator-wrapper');

                    let mIcon = "üìò"; let mLabel = "Subnota"; let mBorderColor = "#4a90e2";
                    let isBible = rawMica.includes('bible-card-mica') || mi.noteId === 'bible_internal';

                    if (isBible) {
                        mIcon = "üìñ"; mLabel = "B√≠blia"; mBorderColor = "#5d4037";
                    } else {
                        if (rawMica.includes("consultor-mode")) { mIcon = "üìï"; mLabel = "Consultor"; mBorderColor = "#c0392b"; }
                        else if (rawMica.includes("question-mode")) { mIcon = "üìó"; mLabel = "Quest√£o"; mBorderColor = "#2ecc71"; }
                        else if (rawMica.includes("free-mode")) { mIcon = "üìô"; mLabel = "Contentor"; mBorderColor = "#e67e22"; }
                        else if (rawMica.includes("redator-wrapper")) { mIcon = "üìì"; mLabel = "Redator"; mBorderColor = "#555555"; }

                        if (micaWrapper) {
                            const fId = micaWrapper.getAttribute('data-focus');
                            if (fId && FOCUS_LABELS[fId]) {
                                mLabel = FOCUS_LABELS[fId];
                                if (fId === 'perola') mBorderColor = "#0032FD";
                                else if (fId === 'estudo_pessoal') mBorderColor = "#4169E1";
                            }
                        }
                    }

                    const boxLinks = window.extractBoxLinksFromSnippet(mi.snippet);
                    let micaMenuHtml = "";
                    if (boxLinks) {
                        const safeJson = encodeURIComponent(JSON.stringify(boxLinks));
                        micaMenuHtml = `
                        <div class="card-menu-container" style="top:5px; right:5px;">
                            <div class="card-menu-btn" onclick="window.toggleCardMenu(this)" style="font-size:12px; padding:0 4px; background:rgba(0,0,0,0.6);">‚Ä¢‚Ä¢</div>
                            <div class="card-dropdown">
                                <button onclick="window.viewCardSources('${safeJson}')" style="color:var(--accent-color); font-weight:bold;">üìé Fontes</button>
                            </div>
                        </div>`;
                    }

                    itemsList += `
                    <div style="background-color: #2b2b2e; border: 1px solid #3d3d40; border-left: 4px solid ${mBorderColor}; border-radius: 6px; margin: 10px; padding: 12px; position: relative;">
                        ${micaMenuHtml}
                        <div class="ref-card-category-label" style="color: ${mBorderColor}; margin-bottom: 8px;">
                            ${mIcon} ${mLabel}
                        </div>
                        <div class="dossie-content-wrapper" style="color:#cecece; font-size:0.9em; line-height:1.5;">
                             ${cleanMicaContent(mi.snippet)}
                        </div>
                    </div>`;
                });
            } else {
                itemsList = '<div style="padding:15px; color:#666; font-style:italic; text-align:center;">Pasta vazia.</div>';
            }

            const safeName = mica.name ? mica.name.trim() : "Sem Nome";
            dossieHtml += `
                <div class="detail-card" style="border-left: 3px solid ${micaColor}; padding: 0; margin-bottom: 12px; border-radius: 4px; overflow: hidden; background: transparent;">
                    <div style="padding: 10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; background: #1e1e20; border-bottom: 1px solid #000;" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span style="font-weight:bold; font-size:0.9rem; color:#fff;">üìÇ ${safeName}</span>
                        <span style="font-size:0.8rem; color:#888;">‚ñº</span>
                    </div>
                    <div class="hidden" style="display:flex; flex-direction:column; background: #141416; padding-bottom: 5px;">
                        ${itemsList}
                    </div>
                </div>`;
        });
    }

    // --- C. LINKS ---
    if (linksCount > 0) {
        data.panelLinks.forEach(link => {
            if (link.type === 'codex') {
                linksHtml += `<div class="detail-card" style="border-left: 3px solid #3498db;"><strong>üìö ${link.serie}</strong><br>${link.codiceshow || ''}</div>`;
            } else {
                let urlsHtml = "";
                const urls = link.urls ? Object.values(link.urls) : [link.url];
                urls.forEach(u => urlsHtml += `<br><a href="${u}" target="_blank">üîó ${u}</a>`);
                linksHtml += `<div class="detail-card" style="border-left: 3px solid #3498db;"><strong>${link.title}</strong>${urlsHtml}</div>`;
            }
        });
    }

    const universalContent = 
        (puzzleHtml ? `<div class="section-label" style="color:#888; font-size:0.7rem; font-weight:bold; margin:15px 0 5px 2px;">PUZZLE</div>${puzzleHtml}` : '') +
        (dossieHtml ? `<div class="section-label" style="color:#888; font-size:0.7rem; font-weight:bold; margin:20px 0 5px 2px;">DOSSI√â</div>${dossieHtml}` : '') +
        (linksHtml  ? `<div class="section-label" style="color:#888; font-size:0.7rem; font-weight:bold; margin:20px 0 5px 2px;">LINKS</div>${linksHtml}` : '');

    let navHtml = '<div class="verse-tabs-nav">';
    navHtml += `<button id="btn-tab-all" class="verse-tab-btn active" onclick="window.switchDetailTab('all')"><span>‚ôæÔ∏è</span> <span class="tab-badge">${totalCount}</span></button>`;
    if (puzzleHtml) navHtml += `<button id="btn-tab-puzzle" class="verse-tab-btn" onclick="window.switchDetailTab('puzzle')"><span>üß©</span> <span class="tab-badge">${puzzleCount}</span></button>`;
    if (dossieHtml) navHtml += `<button id="btn-tab-dossie" class="verse-tab-btn" onclick="window.switchDetailTab('dossie')"><span>üìº</span> <span class="tab-badge">${dossieCount}</span></button>`;
    if (linksHtml) navHtml += `<button id="btn-tab-links" class="verse-tab-btn" onclick="window.switchDetailTab('links')"><span>‚ö°</span> <span class="tab-badge">${linksCount}</span></button>`;
    navHtml += '</div>';

    return navHtml + `
        <div id="pane-all" class="tab-pane active">${universalContent}</div>
        <div id="pane-puzzle" class="tab-pane">${puzzleHtml || '<p class="empty-msg">Vazio</p>'}</div>
        <div id="pane-dossie" class="tab-pane">${dossieHtml || '<p class="empty-msg">Vazio</p>'}</div>
        <div id="pane-links" class="tab-pane">${linksHtml || '<p class="empty-msg">Vazio</p>'}</div>
    `;
}

        // --- FLASH NOTE ---
        btnAddFlash.onclick = () => {
    // 1. Limpa os campos visuais
    document.getElementById('flash-title').value = "";
    document.getElementById('flash-editor').innerHTML = "";
    document.getElementById('flash-attached-verse').innerText = activeVerseFullName;
    
    // 2. Reset do dropdown para o padr√£o
    document.getElementById('flash-type-select').value = "default";
    
    // 3. RESET DAS VARI√ÅVEIS DE DADOS (CRUCIAL PARA OS NOVOS BOT√ïES)
    currentFlashTopics = {}; 
    currentFlashLinks = {}; // Reinicia os links
    activeTopicIdForFlash = null;

    // 4. RESET VISUAL DOS √çCONES DA TOOLBAR
    const btnLink = document.getElementById('btn-flash-links');
    if(btnLink) { 
        btnLink.style.color = ""; 
        btnLink.style.borderColor = ""; 
    }
    
    // 5. Mostra o modal e foca no t√≠tulo
    flashModal.style.display = 'flex';
    
    // Pequeno delay para garantir que o modal est√° vis√≠vel antes de focar
    setTimeout(() => {
        document.getElementById('flash-title').focus();
    }, 50);
};

 window.saveFlashNoteGlobal = async (clickedBtn = null) => {
    // 1. Gerir estado do bot√£o para evitar cliques duplos
    const btn = clickedBtn || document.getElementById('btn-submit-flash') || document.getElementById('btn-save-flash');
    if (btn && btn.disabled) return; 
    if (btn) { 
        btn.textContent = "A gravar..."; 
        btn.disabled = true; 
        btn.style.opacity = "0.7"; 
    }

    try {
        // 2. Identificar o contentor ativo (Sidebar no PC ou Modal no Mobile)
        let container;
        const sidePanel = document.getElementById('side-panel');
        if (sidePanel && sidePanel.classList.contains('open') && window.innerWidth >= 768) {
            container = document.getElementById('sidebar-content');
        } else {
            container = document.getElementById('flash-note-modal');
        }

        // 3. Recolher dados do formul√°rio
        const titleInput = container.querySelector('#flash-title');
        const editor = container.querySelector('#flash-editor');
        const typeSelect = container.querySelector('#flash-type-select');
        
        const title = titleInput.value.trim();
        const content = editor.innerHTML;
        const noteType = typeSelect ? typeSelect.value : 'default';

        if (!title) {
            if (btn) { btn.textContent = "GRAVAR NOTA"; btn.disabled = false; btn.style.opacity = "1"; }
            return window.showCustomAlert("O t√≠tulo √© obrigat√≥rio!"); 
        }

        // --- 4. L√ìGICA DE IDENTIFICA√á√ÉO DE VERS√çCULOS (MULTI-VERS√çCULO / CATEGORIAS) ---
        // Come√ßamos com os vers√≠culos selecionados ou o ativo
        let versesToAttach = (currentSelectionVerses && currentSelectionVerses.length > 0) 
            ? [...currentSelectionVerses] 
            : [activeVerseFullName];

        // Adicionar vers√≠culos que foram selecionados manualmente na aba Categorias
        if (currentFlashLinks && currentFlashLinks.categories) {
            currentFlashLinks.categories.forEach(cat => {
                if (cat.type === 'bible_public' || cat.type === 'textobiblico') {
                    if (!versesToAttach.includes(cat.name)) {
                        versesToAttach.push(cat.name);
                    }
                }
            });
        }
        versesToAttach = [...new Set(versesToAttach)].filter(v => v);

        // --- 5. L√ìGICA DE FOCO (CORES) ---
        const allFocusOptions = [...FLASH_FOCUS_OPTIONS.default, ...FLASH_FOCUS_OPTIONS.question];
        const selectedFocusObj = allFocusOptions.find(o => o.id === currentFlashFocus);
        
        // A cor da borda da nota ser√° a cor do Foco, ou a cor do picker, ou o padr√£o azul/verde
        const newColor = selectedFocusObj ? selectedFocusObj.color : (selectedColorHex || (noteType === 'question' ? '#2ecc71' : '#3498db'));

        // 6. Preparar Firebase e Metadados
        const { collection, addDoc, doc, updateDoc, arrayUnion, serverTimestamp, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        const fullHighlightText = currentSelectionText || (activeHighlightContext ? activeHighlightContext.text : null);
        const boxUniqueId = "box_" + Date.now();

        // Serializar metadados para o HTML
        const safeTopics = JSON.stringify(currentFlashTopics || {}).replace(/"/g, '&quot;');
        const safeBoxLinks = JSON.stringify(currentFlashLinks || {}).replace(/"/g, '&quot;');
        const focusAttr = currentFlashFocus ? `data-focus="${currentFlashFocus}"` : "";

        const commonToolbarHTML = `<div class="mini-note-toolbar" contenteditable="false"><button type="button" data-action="sharing-settings">üîê</button><div class="toolbar-btn-group"><button type="button" data-action="move-up">üî∫</button><button type="button" data-action="move-down">üîª</button></div><button type="button" data-action="manage-box-links">‚ö°</button><button type="button" data-action="append-mini-note">üß¨</button><button type="button" data-action="highlight-color">üé®</button><button type="button" data-action="manage-mini-note-topics">üìã</button><button type="button" data-action="delete-mini-note">üóëÔ∏è</button></div>`;

        let wrapperClass = (noteType === 'question') ? "mini-note-wrapper question-mode" : "mini-note-wrapper";

        // Montar HTML final (incluindo o data-focus e cor da borda via inline style se necess√°rio)
        const subNoteHtml = `<div class="${wrapperClass}" id="${boxUniqueId}" ${focusAttr} data-topics='${safeTopics}' data-box-links='${safeBoxLinks}' contenteditable="false" style="border-left-color: ${newColor}"><textarea class="mini-note-title-input" rows="1">${title}</textarea>${commonToolbarHTML}<div class="mini-note-content" contenteditable="true">${content}</div></div><p><br></p>`;

        // 7. EXECU√á√ÉO FIREBASE

        // A. Gravar nota principal na Mochila (pastas)
        const noteRef = await addDoc(collection(db, 'pastas'), {
            nome: title, 
            conteudo: subNoteHtml, 
            tipo: 'nota', 
            oque: 'back', 
            userId: currentUser.uid, 
            estado: 'ativa', 
            boxIds: [boxUniqueId],
            createdAt: serverTimestamp(), 
            ultimaedicao: serverTimestamp()
        });

        // B. Tratar Destaques (Picotados)
        if (fullHighlightText) {
            const qCheck = query(collection(db, 'trechosbiblicos'), where('userId', '==', currentUser.uid), where('nome', '==', fullHighlightText));
            const snapCheck = await getDocs(qCheck);
            if (!snapCheck.empty) {
                await updateDoc(doc(db, 'trechosbiblicos', snapCheck.docs[0].id), { noteIds: arrayUnion(noteRef.id), cor: newColor });
            } else {
                await addDoc(collection(db, 'trechosbiblicos'), {
                    userId: currentUser.uid, textosbiblicos: versesToAttach, nome: fullHighlightText, cor: newColor, noteIds: [noteRef.id], createdAt: serverTimestamp()
                });
            }
        }

        // C. VINCULAR A CADA VERS√çCULO (Loop em todos os anexados pelas Categorias)
    for (const verseName of versesToAttach) {
    const vNum = verseName.split(':')[1].trim().split('-')[0];

    const puzzleItem = { 
        noteId: noteRef.id, 
        noteName: title, 
        snippet: encodeURIComponent(subNoteHtml), 
        addedAt: Date.now(), 
        noteColor: newColor, 
        highlightRef: fullHighlightText || "Nota Geral" 
    };

    // 1. ATUALIZA CACHE LOCAL (Usando unshift para ir para o topo)
    if (!existingUserData[vNum]) {
        existingUserData[vNum] = { puzzleBoard: [], dossie: [], panelLinks: [] };
    }
    // Mudamos de .push() para .unshift()
    existingUserData[vNum].puzzleBoard.unshift(puzzleItem);

    // 2. GRAVA NA DB DO VERS√çCULO
    const qVerse = query(collection(db, 'textosbiblicos'), where('nome', '==', verseName), where('userId', '==', currentUser.uid));
    const snapshot = await getDocs(qVerse);
    
    if (!snapshot.empty) {
        const docSnap = snapshot.docs[0];
        const docRef = doc(db, 'textosbiblicos', docSnap.id);
        
        // Em vez de arrayUnion (que p√µe no fim), pegamos no array atual,
        // adicionamos ao in√≠cio e gravamos o array inteiro.
        let currentBoard = docSnap.data().puzzleBoard || [];
        currentBoard.unshift(puzzleItem); // Adiciona ao in√≠cio
        
        await updateDoc(docRef, { puzzleBoard: currentBoard });
    } else {
        // Se o documento √© novo, o primeiro item fica naturalmente no topo
        await addDoc(collection(db, 'textosbiblicos'), {
            nome: verseName, 
            userId: currentUser.uid, 
            createdAt: serverTimestamp(), 
            puzzleBoard: [puzzleItem], 
            dossie: [], 
            panelLinks: []
        });
    }

    // PINTAR O N√öMERO DE LARANJA NA UI
    const numEl = document.getElementById(`vnum-${vNum}`);
    if (numEl) numEl.classList.add('has-data');
}

        // 8. FINALIZA√á√ÉO
        document.getElementById('flash-note-modal').style.display = 'none';
        if (typeof window.refreshVisualHighlights === 'function') window.refreshVisualHighlights();
        
        window.returnToVerseDetails();

        // Limpeza de vari√°veis globais
        currentSelectionText = ""; 
        currentSelectionVerses = []; 
        selectedColorHex = null;
        currentFlashFocus = null;
        currentFlashLinks = {};
        currentFlashTopics = {};

        if (window.getSelection) window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro Cr√≠tico ao gravar Nota Flash:", e);
        window.showCustomAlert("Erro ao gravar. Verifique a sua liga√ß√£o.");
    } finally {
        if (btn) { 
            btn.textContent = "GRAVAR NOTA"; 
            btn.disabled = false; 
            btn.style.opacity = "1"; 
        }
    }
};

// --- FOR√áAR LIGA√á√ÉO DOS BOT√ïES (CORRE√á√ÉO DE ERROS DE LOAD) ---
// Adiciona isto para garantir que os bot√µes funcionam mesmo que o HTML falhe
setTimeout(() => {
    // 1. Bot√£o de Abrir
    const btnOpen = document.getElementById('btn-add-flash-note');
    if (btnOpen) {
        btnOpen.onclick = window.handleCreateNoteClick;
    }

    // 2. Bot√£o de Gravar
    const btnSave = document.getElementById('btn-save-flash');
    if (btnSave) {
        btnSave.onclick = window.saveFlashNoteGlobal;
    }
}, 1000);



        // --- NAVEGA√á√ÉO UI ---
function updateUI(view) {
     const container = document.querySelector('.container');
    if (container) {
        container.scrollTop = 0;
    }
    // Fecha pain√©is laterais ao mudar de vista
    window.closeSidePanel(); 
    document.getElementById('verse-details-modal').style.display = 'none';

    currentView = view;
    viewBooks.classList.add('hidden'); 
    viewChapters.classList.add('hidden'); 
    viewVerses.classList.add('hidden');
    
    const anchorBtn = document.getElementById('bible-anchors-btn');
    
  if (view === 'books') { 
        viewBooks.classList.remove('hidden'); 
        pageTitle.innerText = "B√çBLIA"; 
        backBtn.style.display = 'none'; 
        if(anchorBtn) anchorBtn.style.display = 'none';

        // CORRE√á√ÉO: S√ì LIMPA O URL SE N√ÉO FOR O CARREGAMENTO INICIAL
        // Isto impede que o ?b=G√©nesis seja apagado antes de ser lido
        if (!isFirstLoad && typeof updateUrlParams === 'function') {
            updateUrlParams(null, null, null);
        }

    } else if (view === 'chapters') {
        viewChapters.classList.remove('hidden'); 
        
        // PROTE√á√ÉO: S√≥ tenta ler o nome se o livro existir
        if (selectedBook) {
            pageTitle.innerText = selectedBook.nome;
            
            // ATUALIZA URL: Apenas Livro
            if (typeof updateUrlParams === 'function') {
                updateUrlParams(selectedBook.nome, null, null);
            }
        }
        
        backBtn.style.display = 'block'; 
        if(anchorBtn) anchorBtn.style.display = 'none';

    } else if (view === 'verses') { 
        viewVerses.classList.remove('hidden'); 
        
        if (selectedBook && selectedChapter) {
            // ATUALIZA URL: Livro e Cap√≠tulo (usa selectedChapter, n√£o 'chapter')
            if (typeof updateUrlParams === 'function') {
                updateUrlParams(selectedBook.nome, selectedChapter, null);
            }

            pageTitle.innerHTML = `
                <button class="nav-arrow" onclick="window.changeChapter(-1)">‚ùÆ</button>
                <span id="page-title-span" 
                      onclick="window.toggleChapterNav(event)" 
                      style="margin: 0 8px; cursor:pointer; border-bottom: 1px dotted #666; padding-bottom: 2px; user-select: none;"
                      title="Mudar Cap√≠tulo">
                    ${selectedBook.nome} ${selectedChapter}
                </span>
                <button class="nav-arrow" onclick="window.changeChapter(1)">‚ùØ</button>
            `;
        }
        
        backBtn.style.display = 'block'; 
        if(anchorBtn) anchorBtn.style.display = 'inline-block';
    }
    
    window.scrollTo(0, 0);
}

backBtn.addEventListener('click', () => {
    window.hideSelectionToolbar(); 
    
    if (currentView === 'verses') { 
        // CORRE√á√ÉO: Em vez de apenas mudar a vista (updateUI),
        // chamamos openChapters para garantir que a grelha √© desenhada.
        // Isto resolve o problema da tela branca ap√≥s refresh.
        if (selectedBook) {
            openChapters(selectedBook);
        } else {
            // Fallback de seguran√ßa
            updateUI('books');
        }
    } 
    else if (currentView === 'chapters') { 
        // Voltar para Home
        selectedBook = null; 
        selectedChapter = null;
        updateUI('books'); 
    }
});


        window.onclick = function(event) { 
            if (event.target === verseModal) verseModal.style.display = "none";
            if (event.target === flashModal) flashModal.style.display = "none"; 
            if (event.target === settingsModal) settingsModal.style.display = "none";
        }

        renderBooks();


        // 1. Alternar Menu (Abrir/Fechar)
 window.toggleCardMenu = (btn) => {
    const container = btn.parentElement; // O div .card-menu-container
    const dropdown = btn.nextElementSibling;

    // 1. Fechar todos os outros menus abertos E RESETAR o z-index deles
    document.querySelectorAll('.card-dropdown').forEach(d => {
        if (d !== dropdown) {
            d.classList.remove('visible');
            // Reseta o pai para o z-index baixo original
            d.parentElement.style.zIndex = "10"; 
        }
    });

    // 2. Verificar se vamos abrir ou fechar
    const isOpening = !dropdown.classList.contains('visible');

    if (isOpening) {
        dropdown.classList.add('visible');
        // TRUQUE: Eleva este contentor espec√≠fico acima de todos os outros cards
        container.style.zIndex = "10000"; 
    } else {
        dropdown.classList.remove('visible');
        container.style.zIndex = "10"; // Volta ao normal
    }
    
    // 3. Fechar ao clicar fora (com reset do z-index)
    if (isOpening) {
        const closeMenu = (e) => {
            if (!container.contains(e.target)) {
                dropdown.classList.remove('visible');
                container.style.zIndex = "10"; // MUITO IMPORTANTE: Resetar aqui tamb√©m
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 10);
    }
};

        // 2. Eliminar Item do Puzzle
window.deletePuzzleItem = async (vNum, index) => {
    // 1. Confirma√ß√£o
    const confirmed = await window.showConfirmation(
        "Remover Nota?", 
        "Esta nota ser√° apagada de TODOS os vers√≠culos ligados a este trecho."
    );
    if (!confirmed) return;

    // 2. Obter dados
    const data = existingUserData[vNum];
    if (!data || !data.puzzleBoard || !data.puzzleBoard[index]) return;

    const itemToDelete = data.puzzleBoard[index];
    const targetNoteId = itemToDelete.noteId;
    const highlightTextContext = itemToDelete.highlightRef; // Guardamos o texto do trecho para verificar depois

    // Feedback visual
    const btn = document.querySelector('.btn-remove-card');
    if(btn) btn.innerText = "‚è≥";

    try {
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const updatePromises = [];

        // --- L√ìGICA DE APAGAR (GLOBAL OU LOCAL) ---
        if (targetNoteId) {
            for (const [verseKey, verseData] of Object.entries(existingUserData)) {
                if (!verseData || !Array.isArray(verseData.puzzleBoard)) continue;

                const originalLength = verseData.puzzleBoard.length;
                const newBoard = verseData.puzzleBoard.filter(item => item.noteId !== targetNoteId);

                if (newBoard.length < originalLength) {
                    existingUserData[verseKey].puzzleBoard = newBoard;
                    
                    // Limpa badge se ficar vazio
                    if (newBoard.length === 0 && (!verseData.dossie?.length) && (!verseData.panelLinks?.length)) {
                        const numBadge = document.getElementById(`vnum-${verseKey}`);
                        if(numBadge) numBadge.classList.remove('has-data');
                    }

                    if (verseData.docId) {
                        const docRef = doc(db, 'textosbiblicos', verseData.docId);
                        updatePromises.push(updateDoc(docRef, { puzzleBoard: newBoard }));
                    }
                }
            }
        } else {
            // Apagar Local Simples
            const newBoard = [...data.puzzleBoard];
            newBoard.splice(index, 1);
            existingUserData[vNum].puzzleBoard = newBoard;
            if (data.docId) {
                const docRef = doc(db, 'textosbiblicos', data.docId);
                updatePromises.push(updateDoc(docRef, { puzzleBoard: newBoard }));
            }
        }

        await Promise.all(updatePromises);

        // 3. ATUALIZAR UI (AQUI EST√Å A NOVIDADE)
        
        // A. Redesenha a B√≠blia (remove o picotado se n√£o houver mais notas)
 if (typeof window.refreshVisualHighlights === 'function') {
    window.refreshVisualHighlights();
}

if (activeHighlightContext) {
    // Verifica o que sobrou para este trecho espec√≠fico
    const currentData = existingUserData[vNum];
    const notesRemaining = currentData.puzzleBoard.filter(item => 
        item.highlightRef === activeHighlightContext.text
    );

    if (notesRemaining.length === 0) {
        // Se n√£o restam notas, volta √† vista geral sem anima√ß√µes bruscas
        window.returnToVerseDetails();
    } else {
        // EM VEZ DE REABRIR (openHighlightDetails), apenas re-renderizamos o conte√∫do
        // Isso evita que o painel mobile "salte" ou mude de altura
        const contentDiv = document.getElementById(window.innerWidth >= 768 ? 'sidebar-content' : 'details-content');
        if (contentDiv) {
            // Criamos uma lista de notas com os √≠ndices ATUALIZADOS para o novo array
            const updatedNotesForDisplay = [];
            currentData.puzzleBoard.forEach((item, idx) => {
                if (item.highlightRef === activeHighlightContext.text) {
                    updatedNotesForDisplay.push({ ...item, originalIndex: idx, sourceVerse: vNum });
                }
            });
            renderHighlightContentConsolidated(contentDiv, updatedNotesForDisplay, activeHighlightContext.color);
        }
    }
} else {
    // Vista geral do vers√≠culo
    window.openModalForVerse(vNum);
}

    } catch (e) {
        console.error("Erro ao apagar:", e);
        alert("Erro ao apagar nota: " + e.message);
    }
};

        // 3. Abrir Modal de Edi√ß√£o
 window.openEditCard = (vNum, index) => {
    console.group(`üîç [EDI√á√ÉO] A abrir cart√£o (Verso: ${vNum}, Index: ${index})`);

    // 1. Localizar os dados no cache local
    const data = existingUserData[vNum];
    if (!data || !data.puzzleBoard || !data.puzzleBoard[index]) {
        console.error("‚ùå Erro: Dados n√£o encontrados na mem√≥ria local.");
        console.groupEnd();
        return;
    }

    const item = data.puzzleBoard[index];

    // 2. Descodificar o Snippet HTML da nota
    let rawSnippet = "";
    try {
        const snippetToDecode = item.snippet || "";
        rawSnippet = snippetToDecode.includes('%') ? decodeURIComponent(snippetToDecode) : snippetToDecode;
    } catch(e) {
        console.warn("‚ö†Ô∏è Falha ao descodificar snippet.");
        rawSnippet = item.snippet || "";
    }

    const parser = new DOMParser();
    const docHTML = parser.parseFromString(rawSnippet, 'text/html');
    
    // 3. Recuperar T√≠tulos e Conte√∫do
    let title = "";
    const titleInput = docHTML.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
    const h2 = docHTML.querySelector('h2');
    
    if (titleInput) title = titleInput.value || titleInput.getAttribute('value') || "";
    else if (h2) title = h2.textContent;

    let content = "";
    const contentDiv = docHTML.querySelector('.mini-note-content, .redator-content, .sign-content, .card-desc-content, .cube-content');
    if (contentDiv) content = contentDiv.innerHTML;

    // 4. RECUPERAR METADADOS (Vital para manter T√≥picos, Links e FOCO)
    const wrapper = docHTML.querySelector('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
    
    if (wrapper) {
        // T√≥picos üìã
        try { 
            currentFlashTopics = JSON.parse(wrapper.getAttribute('data-topics') || '{}'); 
        } catch(e) { currentFlashTopics = {}; }

        // Links ‚ö°
        try { 
            const rawLinks = wrapper.getAttribute('data-box-links');
            currentFlashLinks = (rawLinks && rawLinks !== "null") ? JSON.parse(rawLinks) : {};
        } catch(e) { currentFlashLinks = {}; }

        // Foco üé®
        const focusInAttr = wrapper.getAttribute('data-focus');
        currentFlashFocus = focusInAttr || null;
    } else {
        currentFlashTopics = {};
        currentFlashLinks = {};
        currentFlashFocus = null;
    }

    // 5. Preencher os campos do Modal de Edi√ß√£o
    document.getElementById('edit-card-title').value = title;
    document.getElementById('edit-card-content').innerHTML = content;
    document.getElementById('edit-card-index').value = index;
    document.getElementById('edit-card-verse').value = vNum;

    // A cor base para o picotado
    selectedColorHex = item.noteColor || item.cor || '#3498db'; 

    // 6. Mostrar o Modal
    document.getElementById('edit-card-modal').style.display = 'flex';

    // 7. Feedback Visual na Toolbar (‚ö° e üìã)
    const btnLinks = document.getElementById('btn-edit-links');
    const btnTopics = document.getElementById('btn-edit-topics');
    const btnFocus = document.getElementById('btn-edit-focus');

    const hasLinks = (currentFlashLinks.urls && Object.keys(currentFlashLinks.urls).length > 0) || 
                     (currentFlashLinks.codex && currentFlashLinks.codex.length > 0) || 
                     (currentFlashLinks.categories && currentFlashLinks.categories.length > 0);

    if (btnLinks) {
        btnLinks.style.color = hasLinks ? "#f1c40f" : ""; 
        btnLinks.style.borderColor = hasLinks ? "#f1c40f" : "";
    }
    if (btnTopics) {
        const hasTopics = Object.keys(currentFlashTopics).length > 0;
        btnTopics.style.color = hasTopics ? "#f1c40f" : "";
    }

    // 8. Aplicar a Cor do Foco no Editor (Incluindo P√©rola)
    setTimeout(() => {
        if (typeof window.injectColorPickerIntoEditModal === 'function') {
            window.injectColorPickerIntoEditModal();
        }
        
        const editEditor = document.getElementById('edit-card-content');
        if (editEditor) {
            if (currentFlashFocus) {
                // Procura a cor nas tabelas de foco (default ou question)
                const allFocusOptions = [...FLASH_FOCUS_OPTIONS.default, ...FLASH_FOCUS_OPTIONS.question];
                const focusObj = allFocusOptions.find(o => o.id === currentFlashFocus);
                
                if (focusObj) {
                    editEditor.style.borderColor = focusObj.color;
                    editEditor.style.borderWidth = "2px";
                    if (btnFocus) btnFocus.style.color = focusObj.color;
                }
            } else {
                // Se n√£o tiver foco, usa a cor base do tipo de nota
                const isQuestion = rawSnippet.includes('question-mode');
                editEditor.style.borderColor = isQuestion ? '#2ecc71' : '#3498db';
                editEditor.style.borderWidth = "1px";
                if (btnFocus) btnFocus.style.color = "";
            }
        }
    }, 50);

    console.log("‚úÖ Edi√ß√£o aberta. Foco atual:", currentFlashFocus || "Padr√£o");
    console.groupEnd();
};


        // 4. Gravar Edi√ß√£o
 document.getElementById('btn-confirm-edit-card').onclick = async () => {
    const btn = document.getElementById('btn-confirm-edit-card');
    const vNumOriginal = document.getElementById('edit-card-verse').value;
    const indexOriginal = parseInt(document.getElementById('edit-card-index').value);
    const newTitle = document.getElementById('edit-card-title').value;
    const newContent = document.getElementById('edit-card-content').innerHTML;

    if (!newTitle) return window.showCustomAlert("O t√≠tulo √© obrigat√≥rio!");

    btn.textContent = "A gravar...";
    btn.disabled = true;

    try {
        const { doc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp, arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // 1. Identificar a Nota e Metadados
        const itemOriginal = existingUserData[vNumOriginal].puzzleBoard[indexOriginal];
        const targetNoteId = itemOriginal.noteId;

        // 2. Determinar TODOS os vers√≠culos a serem atualizados
        let allTargetVerses = [activeVerseFullName]; 
        
        if (currentFlashLinks && currentFlashLinks.categories) {
            currentFlashLinks.categories.forEach(cat => {
                if ((cat.type === 'bible_public' || cat.type === 'textobiblico') && !allTargetVerses.includes(cat.name)) {
                    allTargetVerses.push(cat.name);
                }
            });
        }
        allTargetVerses = [...new Set(allTargetVerses)].filter(v => v);

        // 3. Preparar o novo Snippet HTML
        const safeTopics = JSON.stringify(currentFlashTopics || {}).replace(/"/g, '&quot;');
        const safeBoxLinks = JSON.stringify(currentFlashLinks || {}).replace(/"/g, '&quot;');
        const focusAttr = currentFlashFocus ? `data-focus="${currentFlashFocus}"` : "";
        const boxUniqueId = targetNoteId ? `box_${targetNoteId}` : `box_${Date.now()}`;
        
        const isQuestion = newContent.includes('question-mode') || (document.getElementById('edit-card-content').style.borderColor === 'rgb(46, 204, 113)');
        let wrapperClass = isQuestion ? "mini-note-wrapper question-mode" : "mini-note-wrapper";
        
        const commonToolbarHTML = `<div class="mini-note-toolbar" contenteditable="false"><button type="button" data-action="sharing-settings">üîê</button><div class="toolbar-btn-group"><button type="button" data-action="move-up">üî∫</button><button type="button" data-action="move-down">üîª</button></div><button type="button" data-action="manage-box-links">‚ö°</button><button type="button" data-action="append-mini-note">üß¨</button><button type="button" data-action="highlight-color">üé®</button><button type="button" data-action="manage-mini-note-topics">üìã</button><button type="button" data-action="delete-mini-note">üóëÔ∏è</button></div>`;

        const newSnippetRaw = `<div class="${wrapperClass}" id="${boxUniqueId}" ${focusAttr} data-topics='${safeTopics}' data-box-links='${safeBoxLinks}' contenteditable="false"><textarea class="mini-note-title-input" rows="1">${newTitle}</textarea>${commonToolbarHTML}<div class="mini-note-content" contenteditable="true">${newContent}</div></div><p><br></p>`;
        const newSnippetEncoded = encodeURIComponent(newSnippetRaw);
        const newColor = selectedColorHex || itemOriginal.noteColor || '#3498db';

        // 4. ATUALIZAR EM TODOS OS VERS√çCULOS ENVOLVIDOS
        const updatePromises = [];
        for (const verseName of allTargetVerses) {
            const vNum = verseName.split(':')[1].trim().split('-')[0];
            
            const qVerse = query(collection(db, 'textosbiblicos'), where('nome', '==', verseName), where('userId', '==', currentUser.uid));
            const snap = await getDocs(qVerse);

            const newItem = {
                noteId: targetNoteId,
                noteName: newTitle,
                snippet: newSnippetEncoded,
                noteColor: newColor,
                highlightRef: itemOriginal.highlightRef || "Nota Geral",
                addedAt: itemOriginal.addedAt || Date.now()
            };

            if (!snap.empty) {
                const vDoc = snap.docs[0];
                let board = vDoc.data().puzzleBoard || [];
                const idx = board.findIndex(b => b.noteId === targetNoteId);
                if (idx !== -1) board[idx] = newItem; else board.push(newItem);
                updatePromises.push(updateDoc(doc(db, 'textosbiblicos', vDoc.id), { puzzleBoard: board }));
            } else {
                updatePromises.push(addDoc(collection(db, 'textosbiblicos'), {
                    nome: verseName, userId: currentUser.uid, puzzleBoard: [newItem], dossie: [], panelLinks: [], createdAt: serverTimestamp()
                }));
            }

            if (!existingUserData[vNum]) existingUserData[vNum] = { puzzleBoard: [] };
            const localIdx = existingUserData[vNum].puzzleBoard.findIndex(b => b.noteId === targetNoteId);
            if (localIdx !== -1) existingUserData[vNum].puzzleBoard[localIdx] = newItem; else existingUserData[vNum].puzzleBoard.push(newItem);
        }

        // Executa atualiza√ß√µes dos vers√≠culos
        await Promise.all(updatePromises);

        // 5. ATUALIZAR A NOTA MESTRE (Com tratamento de erro se n√£o existir)
        if (targetNoteId) {
            try {
                await updateDoc(doc(db, 'pastas', targetNoteId), {
                    nome: newTitle, conteudo: newSnippetRaw, ultimaedicao: serverTimestamp()
                });
            } catch (err) {
                if (err.code === 'not-found') {
                    console.warn("‚ö†Ô∏è A nota original n√£o existe mais na cole√ß√£o 'pastas'. O v√≠nculo no vers√≠culo foi atualizado localmente.");
                } else {
                    throw err;
                }
            }
        }

        // 6. Fechar e Limpar
        document.getElementById('edit-card-modal').style.display = 'none';
        if (typeof window.refreshVisualHighlights === 'function') window.refreshVisualHighlights();
        window.openModalForVerse(vNumOriginal);

    } catch (e) {
        console.error("Erro ao gravar edi√ß√£o:", e);
        window.showCustomAlert("Erro ao atualizar nota.");
    } finally {
        btn.textContent = "GRAVAR ALTERA√á√ïES";
        btn.disabled = false;
    }
};

// Fun√ß√£o Global de Confirma√ß√£o
        window.showConfirmation = (title, message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const msgEl = document.getElementById('confirm-message');
                const btnOk = document.getElementById('btn-ok-confirm');
                const btnCancel = document.getElementById('btn-cancel-confirm');

                titleEl.textContent = title;
                msgEl.textContent = message;
                modal.style.display = 'flex';

                // Limpar listeners antigos (Clonagem simples)
                const newOk = btnOk.cloneNode(true);
                const newCancel = btnCancel.cloneNode(true);
                btnOk.parentNode.replaceChild(newOk, btnOk);
                btnCancel.parentNode.replaceChild(newCancel, btnCancel);

                newOk.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };

                newCancel.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        };

        // 1. LISTENER DO BOT√ÉO üìã
document.getElementById('btn-flash-topics').addEventListener('click', () => {
    const modal = document.getElementById('flash-topics-modal');
    modal.style.display = 'flex';
    loadFlashTopicsList();
});

// 2. CARREGAR T√ìPICOS (Firebase)
async function loadFlashTopicsList() {
    const list = document.getElementById('flash-topics-list');
    list.innerHTML = '';
    
    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', currentUser.uid), 
            orderBy('nome')
        );
        const snapshot = await getDocs(q);

        snapshot.forEach(doc => {
            const topic = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.style.cssText = "padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center;";
            
            // Checkbox visual (se tem subt√≥picos selecionados ou o pr√≥prio t√≥pico)
            const isSelected = !!currentFlashTopics[topic.id];
            
            li.innerHTML = `
                <span style="margin-right: 10px;">${isSelected ? '‚úÖ' : '‚¨ú'}</span>
                <span>${topic.nome}</span>
            `;

            li.onclick = () => {
                activeTopicIdForFlash = topic.id;
                document.getElementById('flash-sub-title').textContent = `SUBT√ìPICOS: ${topic.nome}`;
                // Atualiza visual da sele√ß√£o na lista da esquerda
                renderFlashSubtopics(topic.id);
                loadFlashTopicsList(); // Recarrega para atualizar os vistos
            };

            // Se for o ativo, destaca
            if (activeTopicIdForFlash === topic.id) {
                li.style.backgroundColor = "rgba(255,255,255,0.1)";
            }

            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erro topics:", e);
        list.innerHTML = "Erro ao carregar.";
    }
}

// 3. CARREGAR SUBT√ìPICOS
async function renderFlashSubtopics(topicId) {
    const list = document.getElementById('flash-subtopics-list');
    list.innerHTML = '<div class="spinner"></div>';
    
    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(
            collection(db, 'subtopicos'), 
            where('topicId', '==', topicId),
            where('userId', '==', currentUser.uid),
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        if(snapshot.empty) {
            list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
            return;
        }

        // Recupera o array de subt√≥picos selecionados para este t√≥pico
        const selectedSubs = currentFlashTopics[topicId] || [];

        snapshot.forEach(doc => {
            const sub = { id: doc.id, ...doc.data() };
            const isChecked = selectedSubs.includes(sub.id);

            const li = document.createElement('li');
            li.style.cssText = "padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center;";
            
            li.innerHTML = `
                <input type="checkbox" ${isChecked ? 'checked' : ''} style="margin-right: 10px; cursor:pointer;">
                <span>${sub.nome}</span>
            `;
            
            // Clique na linha
            li.onclick = (e) => {
                if(e.target.tagName !== 'INPUT') {
                    const cb = li.querySelector('input');
                    cb.checked = !cb.checked;
                }
                const cb = li.querySelector('input');
                toggleFlashSubtopic(topicId, sub.id, cb.checked);
            };

            list.appendChild(li);
        });

    } catch (e) { console.error(e); }
}

// 4. L√ìGICA DE SELE√á√ÉO
function toggleFlashSubtopic(topicId, subId, isChecked) {
    if (!currentFlashTopics[topicId]) currentFlashTopics[topicId] = [];
    
    if (isChecked) {
        if (!currentFlashTopics[topicId].includes(subId)) {
            currentFlashTopics[topicId].push(subId);
        }
    } else {
        currentFlashTopics[topicId] = currentFlashTopics[topicId].filter(id => id !== subId);
        // Se ficar vazio, remove a chave do t√≥pico tamb√©m
        if (currentFlashTopics[topicId].length === 0) {
            delete currentFlashTopics[topicId];
        }
    }
}



// 2. FUN√á√ÉO DE ABERTURA
window.openFlashLinkManager = function() {
    const modal = document.getElementById('flash-links-modal');
    if (modal) {
        // Mostrar o modal
        modal.style.display = 'flex';
        
        // Limpeza visual profunda para evitar duplica√ß√£o ao reabrir
        document.getElementById('flash-urls-list').innerHTML = '';
        document.getElementById('flash-codex-rows-container').innerHTML = ''; 
        document.getElementById('flash-cat-selected').innerHTML = '';
        document.getElementById('flash-cat-results').innerHTML = '';
        
        // Restaurar T√≠tulo e estado do Toggle da B√≠blia
        document.getElementById('flash-link-title').value = currentFlashLinks.title || "";
        const bibleToggle = document.getElementById('flash-bible-toggle');
        if (bibleToggle) {
            bibleToggle.checked = currentFlashLinks.bibleMode === true;
        }

        // Popular URLs (Links Web)
        if (currentFlashLinks.urls && Object.keys(currentFlashLinks.urls).length > 0) {
            Object.values(currentFlashLinks.urls).forEach(url => window.addFlashUrlField(url));
        } else {
            window.addFlashUrlField(); // Campo vazio inicial
        }

        // Popular Codex (Refer√™ncias de Publica√ß√µes)
        if (currentFlashLinks.codex && Array.isArray(currentFlashLinks.codex) && currentFlashLinks.codex.length > 0) {
            currentFlashLinks.codex.forEach(row => window.createFlashCodexRow(row));
        } else {
            window.createFlashCodexRow(); // Linha vazia inicial
        }

        // ============================================================
        // V√çNCULO AUTOM√ÅTICO DO VERS√çCULO ATUAL (AUTO-SELE√á√ÉO)
        // ============================================================
        if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
        
        const currentVerseName = activeVerseFullName; // Ex: "G√©nesis 1:1"
        
        // Verifica se o vers√≠culo onde estamos j√° est√° na lista de Categorias
        const isAlreadySelected = currentFlashLinks.categories.some(c => c.name === currentVerseName);

        if (!isAlreadySelected && currentVerseName) {
            // Adiciona automaticamente o vers√≠culo pai como categoria selecionada
            currentFlashLinks.categories.unshift({ 
                id: activeVerseDocId || "temp_id", 
                name: currentVerseName, 
                type: "textobiblico" 
            });
            console.log("üñáÔ∏è V√≠nculo autom√°tico com: " + currentVerseName);
        }

        // Desenhar os "Chips" (p√≠lulas) na aba Categorias
        window.renderFlashCategoryChips();

        // Define a aba de Refer√™ncias como inicial ao abrir
        window.switchFlashLinkTab('refs');
        
    } else {
        console.error("‚ùå Erro: Modal 'flash-links-modal' n√£o encontrado.");
    }
};

// --- 2. RENDERIZAR AS P√çLULAS (CHIPS) DE SELECIONADOS ---
window.renderFlashCategoryChips = function() {
    const container = document.getElementById('flash-cat-selected');
    if (!container) return;

    container.innerHTML = '';
    const cats = currentFlashLinks.categories || [];

    if (cats.length === 0) {
        container.innerHTML = '<span style="color:#555; font-size:0.8rem; font-style:italic;">Nenhuma selecionada.</span>';
        return;
    }

    cats.forEach(cat => {
        const chip = document.createElement('div');
        
        // Estilo visual diferenciado (Verde para B√≠blia, Laranja para T√≥picos)
        let color = (cat.type === 'bible_public' || cat.type === 'textobiblico') 
            ? "rgba(46, 204, 113, 0.15)" 
            : "rgba(230, 126, 34, 0.15)";
        let border = (cat.type === 'bible_public' || cat.type === 'textobiblico') 
            ? "#2ecc71" 
            : "#e67e22";

        chip.style.cssText = `
            background: ${color}; color: white; padding: 4px 12px; border-radius: 20px;
            font-size: 0.8rem; display: flex; align-items: center; gap: 8px;
            border: 1px solid ${border}; white-space: nowrap; cursor: pointer;
            transition: background 0.2s;
        `;
        
        chip.innerHTML = `<span>${cat.name}</span> <span style="font-weight:bold; opacity:0.6;">√ó</span>`;
        
        // Fun√ß√£o para remover a categoria ao clicar no chip
        chip.onclick = () => {
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => c.name !== cat.name);
            window.renderFlashCategoryChips(); // Redesenha a lista de chips
            
            // Se houver uma pesquisa ativa, atualiza os bot√µes "+" em baixo
            const searchVal = document.getElementById('flash-cat-search').value;
            if (searchVal) window.searchFlashCategories(searchVal);
        };
        
        container.appendChild(chip);
    });
};

window.renderFlashCategoryChips();


// 3. FUN√á√ïES DE UI (ABAS E CAMPOS)
window.switchFlashLinkTab = (tab) => {
    // Atualiza visual dos bot√µes
    document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
    if (event && event.target) event.target.classList.add('active');

    // Esconde todos os conte√∫dos
    document.getElementById('flash-tab-refs').style.display = 'none';
    document.getElementById('flash-tab-codex').style.display = 'none';
    document.getElementById('flash-tab-cats').style.display = 'none';

    // Mostra o selecionado
    const target = document.getElementById(`flash-tab-${tab}`);
    if (target) target.style.display = 'block';
};

window.addFlashUrlField = (val = "") => {
    const div = document.createElement('div');
    div.className = 'flash-url-row';
    div.innerHTML = `
        <input type="text" placeholder="https://..." value="${val}">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-urls-list').appendChild(div);
};

window.addFlashCodexField = (data = null) => {
    const div = document.createElement('div');
    div.className = 'flash-codex-row';
    // Simplificado para o modo flash (apenas S√©rie e P√°ginas)
    div.innerHTML = `
        <input type="text" class="serie" placeholder="Pub (ex: w24 05)" value="${data ? data.serie : ''}">
        <input type="text" class="pages" placeholder="P√°g/Par" value="${data ? data.total.split(', p√°g. ')[1] || '' : ''}" style="max-width:80px;">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-codex-list').appendChild(div);
};

// 4. PESQUISA DE CATEGORIAS (B√çBLIA)
window.searchFlashCategories = async (text) => {
    if (text.length < 2) return;
    
    // Normaliza texto
    const searchText = text.toLowerCase();
    
    const resDiv = document.getElementById('flash-cat-results');
    const isGlobal = document.getElementById('flash-bible-toggle').checked;
    
    resDiv.innerHTML = '<div style="padding:10px; color:#888;">A procurar...</div>';
    
    let resultsArray = [];
    let type = '';

    try {
        if (isGlobal) {
            // --- MODO B√çBLIA (LOCAL) ---
            type = 'bible_public';
            // Filtra na lista est√°tica importada de bible-data.js
            const matches = BIBLE_DATA.filter(b => 
                b.nome.toLowerCase().includes(searchText)
            );
            resultsArray = matches.map(b => ({ id: b.nome, nome: b.nome }));
        } else {
            // --- MODO T√ìPICOS (FIREBASE) ---
            type = 'topic';
            // Usa os imports j√° existentes no topo do script
            const { collection, query, where, getDocs, limit, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Primeira letra mai√∫scula para compatibilidade com a BD antiga se necess√°rio
            const searchCap = text.charAt(0).toUpperCase() + text.slice(1);
            
            const q = query(
                collection(db, "topicos"),
                where("userId", "==", currentUser.uid),
                where("nome", ">=", searchCap), 
                where("nome", "<=", searchCap + '\uf8ff'),
                orderBy("nome"),
                limit(20)
            );
            
            const snap = await getDocs(q);
            snap.forEach(doc => {
                resultsArray.push({ id: doc.id, ...doc.data() });
            });
        }

        // --- RENDERIZA√á√ÉO ---
        resDiv.innerHTML = '';
        
        if (resultsArray.length === 0) {
            resDiv.innerHTML = '<div style="padding:10px; color:#888;">Sem resultados.</div>';
            return;
        }

        resultsArray.slice(0, 20).forEach(d => {
            const div = document.createElement('div');
            div.style.cssText = "padding:8px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center;";
            
            const icon = type === 'bible_public' ? 'üåç' : 'üè∑Ô∏è';
            
            // Destaque visual simples
            // Regex case-insensitive para destacar o termo
            const nomeHtml = d.nome.replace(new RegExp(`(${text})`, 'gi'), '<span style="color:#e67e22; font-weight:bold;">$1</span>');

            div.innerHTML = `
                <span style="font-size:0.9rem;">${icon} ${nomeHtml}</span> 
                <button style="background:none; border:1px solid #2ecc71; color:#2ecc71; border-radius:50%; width:24px; height:24px; cursor:pointer; display:flex; align-items:center; justify-content:center;">+</button>
            `;
            
            div.onclick = () => {
                const catObj = { id: d.id, name: d.nome, type: type };
                renderFlashCategoryChip(catObj);
                
                if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
                
                if (!currentFlashLinks.categories.some(c => c.name === d.nome)) {
                    currentFlashLinks.categories.push(catObj);
                }
                
                resDiv.innerHTML = '';
                document.getElementById('flash-cat-search').value = '';
                document.getElementById('flash-cat-search').focus();
            };
            resDiv.appendChild(div);
        });

    } catch(e) { 
        console.error(e); 
        resDiv.innerHTML = '<div style="padding:10px; color:#e74c3c;">Erro na pesquisa.</div>';
    }
};

function renderFlashCategoryChip(cat) {
    const container = document.getElementById('flash-cat-selected');
    const chip = document.createElement('div');
    chip.className = 'flash-cat-chip';
    chip.innerHTML = `${cat.name} √ó`;
    chip.onclick = () => {
        chip.remove();
        if(currentFlashLinks.categories) {
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => c.name !== cat.name);
        }
    };
    container.appendChild(chip);
}

// 5. GRAVAR DADOS DO MODAL NA VARI√ÅVEL GLOBAL
document.getElementById('btn-save-flash-links').onclick = () => {
    const titleInput = document.getElementById('flash-link-title');
    const bibleToggle = document.getElementById('flash-bible-toggle');
    
    // Coletar URLs
    const urlsObj = {};
    document.querySelectorAll('#flash-urls-list input').forEach((inp, i) => {
        if(inp.value.trim()) urlsObj[`url_${i}`] = inp.value.trim();
    });

    // Coletar Codex (usa a fun√ß√£o getCodexDataFromRow se existir ou similar)
    const codexArr = [];
    document.querySelectorAll('#flash-codex-rows-container .codex-row').forEach(row => {
        const data = window.getFlashCodexData(row);
        if (data && data.serie) codexArr.push(data);
    });

    // Atualiza o objeto global de mem√≥ria
    currentFlashLinks.title = titleInput.value.trim();
    currentFlashLinks.urls = urlsObj;
    currentFlashLinks.codex = codexArr;
    currentFlashLinks.bibleMode = bibleToggle.checked;
    // (As categorias j√° s√£o atualizadas nos clicks dos chips/resultados)

    // Feedback Visual no bot√£o da toolbar principal
    const mainBtn = document.getElementById('btn-flash-links');
    const hasData = Object.keys(urlsObj).length > 0 || codexArr.length > 0 || (currentFlashLinks.categories?.length > 0);
    
    if (hasData) {
        mainBtn.style.color = "#f1c40f"; 
        mainBtn.style.borderColor = "#f1c40f";
    } else {
        mainBtn.style.color = ""; 
        mainBtn.style.borderColor = "";
    }

    document.getElementById('flash-links-modal').style.display = 'none';
};

    

// Cria uma linha completa do Codex (igual ao note.html)
window.createFlashCodexRow = function(data = null) {
    const container = document.getElementById('flash-codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    // --- ALTERA√á√ÉO AQUI: Mud√°mos o onclick para chamar a fun√ß√£o de remo√ß√£o segura ---
    row.innerHTML = `
        <button class="remove-codex-row" onclick="window.removeCodexRow(this)">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                
                <!-- AQUI APARECE O NOME -->
                <div class="serie-fullname" style="font-size: 11px; color: var(--accent-color); margin-top: 4px; height: 14px; font-weight: 500; font-style: italic;"></div>
            </div>
            
            <div class="manual-controls">
                <label class="codex-label">OP√á√ïES</label>
                <div style="display:flex; gap:2px;">
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'A')" title="Ano">A</button>
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'M')" title="M√™s">M</button>
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'T')" title="Tempo">T</button>
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'C')" title="Cap√≠tulo">C</button>
                </div>
            </div>
        </div>
        <div class="manual-inputs-area"></div> 
        <div class="codex-content-grid">
            <div>
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container" style="display:flex; flex-wrap:wrap; align-items:center;">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div>
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container" style="display:flex; flex-wrap:wrap; align-items:center;">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;

    // --- L√ìGICA DE DETE√á√ÉO USANDO O TEU FICHEIRO ---
    const inputSerie = row.querySelector('.serie-main');
    const displayFullName = row.querySelector('.serie-fullname');

    const updateFullName = (val) => {
        if (!val) {
            displayFullName.textContent = "";
            return;
        }

        const valorBaixo = val.toLowerCase().trim();
        
        // Regex para capturar 'w', 'it-1', 'lff', etc., ignorando o resto
        const match = valorBaixo.match(/^[a-z]+(?:-[0-9])?/);
        
        if (match) {
            const sigla = match[0];
            const nomeCompleto = (typeof SIGLAS_PUBLICACOES !== 'undefined') ? SIGLAS_PUBLICACOES[sigla] : null;

            if (nomeCompleto) {
                displayFullName.textContent = `üìö ${nomeCompleto}`;
            } else {
                displayFullName.textContent = "";
            }
        } else {
            displayFullName.textContent = "";
        }
    };

    // Ativa o ouvinte
    inputSerie.addEventListener('input', (e) => updateFullName(e.target.value));

    container.appendChild(row);

    // Se estiver a carregar dados existentes, preenche logo o nome
    if (data) {
        updateFullName(data.serie);
        
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        
        if (data.paginas) data.paginas.forEach(p => window.addFlashCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addFlashCodexUnit(pgContainer, 'Par', p));
        
        setTimeout(() => {
            if (data.manualYear) window.toggleFlashManual(row.querySelector("button[onclick*='A']"), 'A', data.manualYear);
            if (data.manualMonth) window.toggleFlashManual(row.querySelector("button[onclick*='M']"), 'M', data.manualMonth);
            if (data.capitulo) window.toggleFlashManual(row.querySelector("button[onclick*='C']"), 'C', data.capitulo);
            if (data.tempo) window.toggleFlashManual(row.querySelector("button[onclick*='T']"), 'T', data.tempo);
        }, 10);
    } else {
        window.addFlashCodexUnit(row.querySelector('.pages-container'), 'P√°g');
    }
};


// Adiciona uma "P√≠lula" (Pagina ou Par√°grafo)
window.addFlashCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    // Insere antes do bot√£o "+"
    container.insertBefore(unit, container.lastChild);
};

// Gere os bot√µes de toggle (A, M, T, C)
window.toggleFlashManual = function(btn, type, val = '') {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    
    // Se j√° tiver a classe active, estamos a remover (exceto se for load inicial com valor)
    if (btn.classList.contains('active') && !val) {
        const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));
        const el = area.querySelector(selector)?.closest('.manual-field-group');
        if (el) el.remove();
        btn.classList.remove('active');
        return;
    }

    btn.classList.add('active');
    
    // Evita duplicados no load
    const existingClass = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));
    if (area.querySelector(existingClass)) return;

    const group = document.createElement('div');
    group.className = 'manual-field-group';

    if (type === 'A') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-year" placeholder="Ano" value="${val}" style="width:40px;">`;
    } else if (type === 'M') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-month" placeholder="M√™s" value="${val}" style="width:40px;">`;
    } else if (type === 'C') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-chapter" placeholder="Cap." value="${val}" style="width:40px;">`;
    } else if (type === 'T') {
        // Simplificado para texto livre no tempo
        group.classList.add('manual-time-group');
        group.innerHTML = `<input type="text" class="codex-input-manual manual-time" placeholder="00:00" value="${val}" style="width:50px;">`;
    }

    group.innerHTML += `<button class="btn-close-manual" onclick="window.closeFlashManual(this, '${type}')">√ó</button>`;
    area.appendChild(group);
};

window.closeFlashManual = function(closeBtn, type) {
    const row = closeBtn.closest('.codex-row');
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if(toggleBtn) toggleBtn.classList.remove('active');
    closeBtn.parentElement.remove();
};

// --- 1. FUN√á√ÉO QUE GERA O FORMUL√ÅRIO (HTML STRING) ---
// Isto permite usar o mesmo formul√°rio no Modal e na Sidebar
// Mapa de Cores para Destaque (Trechos)
const highlightColors = {
    'none':   { label: 'Sem Cor', hex: 'transparent' },
    'orange': { label: 'Laranja', hex: '#e67e22' },
    'yellow': { label: 'Amarelo', hex: '#f1c40f' },
    'blue':   { label: 'Azul',    hex: '#3498db' },
    'green':  { label: 'Verde',   hex: '#2ecc71' },
    'lilac':  { label: 'Lil√°s',   hex: '#9b59b6' },
    'pink':   { label: 'Rosa',    hex: '#ff7979' },
    'salmon': { label: 'Vermelho', hex: '#e74c3c' },
    'brown':  { label: 'Castanho',hex: '#8d6e63' },
    'grey':   { label: 'Cinzento',hex: '#95a5a6' }
};

// Fun√ß√£o auxiliar para atualizar a bolinha de cor (pr√©-visualiza√ß√£o)
window.updateColorPreview = (select) => {
    const colorKey = select.value;
    const dot = document.getElementById('color-preview-dot');
    if(dot && highlightColors[colorKey]) {
        dot.style.backgroundColor = highlightColors[colorKey].hex;
        // Se for "Sem Cor", pomos uma borda para se ver, sen√£o tira-se a borda
        dot.style.border = colorKey === 'none' ? '1px solid #555' : 'none';
    }
};

window.getFlashFormHTML = (customLabel = null) => {
    // Se passarmos um r√≥tulo personalizado (intervalo), usa esse.
    // Sen√£o, usa o nome do vers√≠culo ativo padr√£o.
    const displayLabel = customLabel || activeVerseFullName;

    return `
        <div style="padding: 10px;">
            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="document.execCommand('underline')"><u>U</u></button>
                
                <button id="btn-flash-topics" onclick="window.openTopicsModal()" title="T√≥picos">üìã</button>
                <button id="btn-flash-links" onclick="window.openFlashLinkManager()" title="Links">‚ö°</button>
                <button id="btn-flash-focus" title="Definir Foco" style="margin-left:2px;">üé®</button>

                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            
            <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                üîó Anexado a: <span id="flash-attached-verse" style="color: #3498db;">${displayLabel}</span>
            </div>

            <!-- ALTERA√á√ÉO AQUI: ID ADICIONADO E 'THIS' PASSADO NO ONCLICK -->
            <button id="btn-submit-flash" onclick="window.saveFlashNoteGlobal(this)" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR NOTA</button>
        </div>
    `;
};

// --- 2. GEST√ÉO DE CLIQUES E NAVEGA√á√ÉO ---

// Quando clica em "+ Adicionar Nota"
window.handleCreateNoteClick = () => {
    // 1. Esconde a barra flutuante de sele√ß√£o (se estiver aberta)
    const toolbar = document.getElementById('selection-toolbar');
    if (toolbar) toolbar.style.display = 'none';

    // 2. RESET TOTAL DOS DADOS (Evita carregar dados da nota anterior)
    currentFlashTopics = {};      // Limpa T√≥picos üìã
    currentFlashLinks = {};       // Limpa Links e Categorias ‚ö°
    currentFlashFocus = null;     // Limpa o Foco üé®
    activeTopicIdForFlash = null; // Reset de navega√ß√£o interna de t√≥picos
    selectedColorHex = null;      // Limpa cor de destaque (picotado)

    // 3. RESET VISUAL DOS BOT√ïES (Remove a cor amarela/ativa dos √≠cones)
    const resetIcon = (id) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.style.color = ""; 
            btn.style.borderColor = "";
        }
    };
    resetIcon('btn-flash-links');
    resetIcon('btn-flash-topics');
    resetIcon('btn-flash-focus');

    // 4. Limpeza dos campos de texto
    const titleInput = document.getElementById('flash-title');
    const editor = document.getElementById('flash-editor');
    if (titleInput) titleInput.value = "";
    if (editor) {
        editor.innerHTML = "";
        editor.style.borderColor = "#3498db"; // Cor padr√£o (Subnota)
    }

    // 5. Configurar o r√≥tulo "Anexado a"
    let labelParaMostrar = activeVerseFullName; 
    if (activeHighlightContext && activeHighlightContext.text) {
        labelParaMostrar = `Trecho: "${activeHighlightContext.text.substring(0, 25)}..."`;
    } else if (currentSelectionVerses && currentSelectionVerses.length > 1) {
        const primeiro = currentSelectionVerses[0];
        const ultimo = currentSelectionVerses[currentSelectionVerses.length - 1];
        let numFinal = ultimo.split(':').pop();
        labelParaMostrar = `${primeiro} ‚ûù ${numFinal}`;
    }

    // 6. Abrir o contentor correto (Sidebar no PC / Modal no Mobile)
    const isDesktop = window.innerWidth >= 768;
    if (isDesktop) {
        const sidePanel = document.getElementById('side-panel');
        const contentDiv = document.getElementById('sidebar-content');
        const titleEl = document.getElementById('sidebar-verse-title');
        
        sidePanel.classList.add('open');
        titleEl.innerText = "Nova Nota";
        contentDiv.innerHTML = window.getFlashFormHTML(labelParaMostrar);
    } else {
        const modal = document.getElementById('flash-note-modal');
        modal.querySelector('.details-body').innerHTML = window.getFlashFormHTML(labelParaMostrar);
        modal.style.display = 'flex';
    }

    // 7. Auto-foco e prepara√ß√µes finais
    setTimeout(() => {
        const input = document.getElementById('flash-title');
        if (input) input.focus();
        
        // Se houver texto selecionado, injeta o seletor de cores para o picotado
        const shouldShowColors = (activeHighlightContext !== null) || (currentSelectionText && currentSelectionText.trim() !== "");
        if (shouldShowColors && typeof window.injectColorPickerIntoForm === 'function') {
            window.injectColorPickerIntoForm();
        }
    }, 100);
};

// Quando clica na Seta "Voltar" (PC)
window.returnToVerseDetails = () => {
    const vNum = activeVerseFullName.split(':')[1].trim().split('-')[0];
    const data = existingUserData[vNum];

    // 1. Identificar o Modo (PC ou Mobile)
    const isDesktop = window.innerWidth >= 768;
    const sidePanel = document.getElementById('side-panel');
    const contentDiv = document.getElementById('sidebar-content');
    const titleEl = document.getElementById('sidebar-verse-title');
    const centerActions = document.getElementById('sidebar-center-actions');
    const backBtn = document.getElementById('sidebar-back-btn');

    // 2. No Mobile, garantimos que o outro modal (antigo) est√° fechado para evitar duplicados
    if (!isDesktop) {
        document.getElementById('verse-details-modal').style.display = 'none';
    }

    // 3. Abrir SEMPRE o Side Panel (Unificado)
    sidePanel.classList.add('open');
    if (!isDesktop) {
        sidePanel.style.height = '75vh'; // Mant√©m como Bottom Sheet no Mobile
    }

    // 4. Reset da UI do Header do Painel
    if (backBtn) backBtn.style.display = 'none';
    if (titleEl) titleEl.innerText = activeVerseFullName;

    // 5. Mostrar bot√µes de a√ß√£o (Criar Nota)
    if (centerActions) {
        centerActions.style.display = 'block';
        centerActions.innerHTML = `<button class="btn-create-note" onclick="window.handleCreateNoteClick()">+ üìù</button>`;
    }

    // 6. Limpa contexto de destaque (voltamos √† vista geral)
    activeHighlightContext = null; 

    // 7. Renderiza o conte√∫do (Dossi√©, Puzzle, etc)
    contentDiv.innerHTML = buildVerseHTML(data, vNum);
};

// Fun√ß√µes wrapper para os bot√µes da toolbar (para funcionarem no innerHTML)
window.openTopicsModal = () => {
    document.getElementById('flash-topics-modal').style.display = 'flex';
    loadFlashTopicsList();
};

// Fun√ß√£o visual para mudar a cor da borda
window.changeFlashBorder = (selectElement) => {
    const editor = document.getElementById('flash-editor');
    const val = selectElement.value;

    if (val === 'question') {
        editor.style.borderColor = '#2ecc71'; // Verde (Quest√£o)
    } else {
        editor.style.borderColor = '#3498db'; // Azul Claro (Subnota)
    }
};


// --- 1. DETECTAR SELE√á√ÉO DE TEXTO ---
document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const toolbar = document.getElementById('selection-toolbar');
    
    if (!toolbar) return;

    // Se n√£o houver sele√ß√£o ou estiver vazia, esconde
    if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.style.display = 'none';
        return;
    }

    // Filtro de √°reas proibidas (modais, inputs, etc)
    const node = selection.anchorNode;
    const element = node.nodeType === 3 ? node.parentElement : node;

    if (element.closest('.modal-content') ||    
        element.closest('#side-panel') ||       
        element.closest('.flash-editor') ||     
        element.closest('input') ||             
        element.closest('textarea') ||          
        element.isContentEditable) {            
        
        toolbar.style.display = 'none';
        return; 
    }

    const text = selection.toString().trim();
    if (text.length > 0) {
        currentSelectionText = text;

        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        // 1. Preparar a barra para c√°lculo (renderizar mas invis√≠vel)
        toolbar.style.opacity = '0';
        toolbar.style.display = 'flex';

        // 2. Obter dimens√µes reais
        const toolbarWidth = toolbar.offsetWidth;
        const toolbarHeight = toolbar.offsetHeight;
        const screenWidth = window.innerWidth;
        const margin = 10; // Margem de seguran√ßa das bordas (10px)

        // 3. Calcular Esquerda (Tentativa de centrar)
        // Posi√ß√£o Esquerda do Texto + Metade da Largura do Texto - Metade da Barra
        let leftPos = rect.left + (rect.width / 2) - (toolbarWidth / 2);

        // 4. Bloqueio Lado Esquerdo
        if (leftPos < margin) {
            leftPos = margin;
        }

        // 5. Bloqueio Lado Direito
        // Se a posi√ß√£o + largura da barra passar a largura do ecr√£
        if (leftPos + toolbarWidth > screenWidth - margin) {
            leftPos = screenWidth - toolbarWidth - margin;
        }

        // 6. Aplicar Posi√ß√£o Horizontal
        toolbar.style.left = `${leftPos}px`;
        
        // 7. Aplicar Posi√ß√£o Vertical (Acima do texto)
        // Usa window.scrollY para compensar o scroll da p√°gina
        let topPos = window.scrollY + rect.top - toolbarHeight - 10;
        // Se ficar muito perto do topo e sair do ecr√£ para cima, mete por baixo do texto
        if (rect.top - toolbarHeight - 10 < 0) {
            topPos = window.scrollY + rect.bottom + 10;
        }
        toolbar.style.top = `${topPos}px`;

        // Mostrar finalmente
        toolbar.style.opacity = '1';

        identifyVersesInSelection(range);
    }
});

// Fun√ß√£o para descobrir quais vers√≠culos foram tocados pela sele√ß√£o
function identifyVersesInSelection(range) {
    currentSelectionVerses = [];
    
    // Procura todos os elementos de vers√≠culo (.verse-item)
    const allVerses = document.querySelectorAll('.verse-item');
    
    allVerses.forEach(div => {
        // Verifica se a sele√ß√£o intersecta com este vers√≠culo
        if (selectionIntersectsNode(range, div)) {
            const numSpan = div.querySelector('.verse-number');
            if (numSpan) {
                const vNum = numSpan.innerText;
                const verseFullName = `${selectedBook.nome} ${selectedChapter}:${vNum}`;
                currentSelectionVerses.push(verseFullName);
            }
        }
    });
}

// Auxiliar: Verifica interse√ß√£o
function selectionIntersectsNode(range, node) {
    const nodeRange = document.createRange();
    nodeRange.selectNode(node);
    return range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
           range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
}

// --- 2. BOT√ïES DA BARRA FLUTUANTE ---

// Bot√£o Copiar
document.getElementById('btn-copy-selection').addEventListener('click', () => {
    navigator.clipboard.writeText(currentSelectionText).then(() => {
        const btn = document.getElementById('btn-copy-selection');
        const original = btn.innerText;
        btn.innerText = "‚úÖ";
        setTimeout(() => { 
            btn.innerText = original; 
            document.getElementById('selection-toolbar').style.display = 'none';
            window.getSelection().removeAllRanges();
        }, 1000);
    });
});

// Bot√£o Criar Nota Flash (Modificado)
// --- DIAGN√ìSTICO: Bot√£o Criar Nota Flash ---
const btnFlashSelection = document.getElementById('btn-note-selection');
if (btnFlashSelection) {
    btnFlashSelection.addEventListener('click', () => {
        // Define o contexto necess√°rio
        if (currentSelectionVerses && currentSelectionVerses.length > 0) {
            activeVerseFullName = currentSelectionVerses[0];
        }
        
        // Abre a janela (a fun√ß√£o handleCreateNoteClick vai detetar que currentSelectionText existe e injetar√° as cores)
        window.handleCreateNoteClick();
        
        // Esconde a barra
        const toolbar = document.getElementById('selection-toolbar');
        if (toolbar) toolbar.style.display = 'none';
    });
}

window.injectColorPickerIntoForm = () => {
    const editor = document.getElementById('flash-editor');
    if (!editor) return;

    // Evita duplicar se j√° existir
    if (document.querySelector('.color-picker-container')) return;

    const colors = [
        { name: 'Laranja', hex: '#e67e22' },
        { name: 'Amarelo', hex: '#f1c40f' },
        { name: 'Azul', hex: '#3498db' },
        { name: 'Verde', hex: '#2ecc71' },
        { name: 'Lil√°s', hex: '#9b59b6' },
        { name: 'Rosa', hex: '#ff7979' },
        { name: 'Vermelho', hex: '#e74c3c' },
        { name: 'Castanho', hex: '#a0522d' },
        { name: 'Cinzento', hex: '#95a5a6' }
    ];

    const container = document.createElement('div');
    container.className = 'color-picker-container';
    
    // Estilos ajustados para a posi√ß√£o inferior
    container.style.marginTop = "15px";     // Espa√ßo entre o editor e as cores
    container.style.marginBottom = "10px";  // Espa√ßo entre as cores e o "Anexado a"
    container.style.display = "flex";
    container.style.gap = "8px";
    container.style.overflowX = "auto";
    container.style.padding = "5px 2px";
    
    // Cria os bot√µes de cor
    colors.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.hex;
        btn.title = c.name;
        
        // Marca a cor selecionada (se houver)
        if (selectedColorHex && selectedColorHex.toLowerCase() === c.hex.toLowerCase()) {
            btn.classList.add('selected');
        }

        btn.onclick = () => {
            container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedColorHex = c.hex;
        };
        container.appendChild(btn);
    });

    // --- ALTERA√á√ÉO DA POSI√á√ÉO ---
    // Insere DEPOIS do editor (inserindo antes do elemento seguinte ao editor)
    if (editor.nextElementSibling) {
        editor.parentElement.insertBefore(container, editor.nextElementSibling);
    } else {
        editor.parentElement.appendChild(container);
    }
};


async function loadHighlightsForChapter(bookName, chapter) {
    const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    try {
        const q = query(
            collection(db, "trechosbiblicos"),
            where("userId", "==", currentUser.uid)
        );

        const snapshot = await getDocs(q);
        
        // Mapa tempor√°rio para agrupar cores por texto
        // Chave: "Texto do Trecho", Valor: Set de Cores (para evitar repetidas)
        const tempMap = {};
        
        const prefixoCapitulo = `${bookName} ${chapter}:`;

        snapshot.forEach(doc => {
            const data = doc.data();
            // Verifica se pertence a este cap√≠tulo
            if (data.textosbiblicos && data.textosbiblicos.some(v => v.startsWith(prefixoCapitulo))) {
                const texto = data.nome;
                const cor = data.cor;

                if (!tempMap[texto]) {
                    tempMap[texto] = new Set();
                }
                tempMap[texto].add(cor);
            }
        });

        // Converte o Mapa para o formato final Array
        currentChapterHighlights = Object.keys(tempMap).map(texto => ({
            texto: texto,
            colors: Array.from(tempMap[texto]) // Ex: ['#e67e22', '#3498db']
        }));

        // Aplica as altera√ß√µes
        applyCachedHighlightsGlobally();

    } catch (e) {
        console.error("Erro highlights:", e);
    }
}


// Fun√ß√£o que aplica o CSS no texto HTML
function applyCachedHighlightsToElement(spanElement) {
    if (!spanElement || currentChapterHighlights.length === 0) return;

    let htmlContent = spanElement.innerHTML;
    let hasChanges = false;

    currentChapterHighlights.forEach(highlight => {
        // Verifica se o texto existe e evita duplicados de processamento
        // (S√≥ aplica se ainda n√£o tiver a classe highlight-picotado)
        if (htmlContent.includes(highlight.texto) && !htmlContent.includes(`data-highlight-ref="${highlight.texto}"`)) {
            
            const safeText = encodeURIComponent(highlight.texto);
            // Cor principal para passar ao modal (a √∫ltima cor adicionada ou a primeira)
            const mainColor = highlight.colors[highlight.colors.length - 1]; 
            const safeColor = encodeURIComponent(mainColor);

            let styleString = "";

            if (highlight.colors.length === 1) {
                // --- 1 COR: Picotado Simples ---
                // background-image √© mais fi√°vel para controlar o tamanho dos pontos do que border-dotted
                styleString = `
                    background-image: linear-gradient(to right, ${mainColor} 50%, transparent 50%);
                    background-position: bottom;
                    background-size: 6px 3px; /* 3px tra√ßo, 3px espa√ßo */
                    background-repeat: repeat-x;
                    padding-bottom: 3px;
                    text-decoration: none;
                `;
            } else {
                // --- M√öLTIPLAS CORES (PONTO 3) ---
                // Desenha 2 tra√ßos de cada cor sequencialmente
                
                let gradientParts = [];
                let currentPos = 0;
                
                const dotWidth = 5;   // Largura do tra√ßo (px)
                const gapWidth = 3;   // Largura do espa√ßo (px)
                
                highlight.colors.forEach(color => {
                    // 2 tra√ßos desta cor
                    for (let i = 0; i < 2; i++) {
                        // Tra√ßo
                        gradientParts.push(`${color} ${currentPos}px ${currentPos + dotWidth}px`);
                        currentPos += dotWidth;
                        // Espa√ßo Transparente
                        gradientParts.push(`transparent ${currentPos}px ${currentPos + gapWidth}px`);
                        currentPos += gapWidth;
                    }
                });

                // O gradiente repete-se para cobrir todo o texto
                const gradString = gradientParts.join(', ');
                
                styleString = `
                    background-image: repeating-linear-gradient(to right, ${gradString});
                    background-position: bottom;
                    background-size: ${currentPos}px 3px; /* A largura total do padr√£o */
                    background-repeat: repeat-x;
                    padding-bottom: 3px;
                    text-decoration: none;
                `;
            }

            // Remove sublinhados nativos se existirem
            const highlightedHTML = `<span class="highlight-picotado" 
                data-highlight-ref="${highlight.texto}"
                onclick="window.openHighlightDetails(event, '${safeText}', '${safeColor}')"
                style="${styleString} cursor: pointer; display: inline; border-bottom: none;">${highlight.texto}</span>`;
            
            // Substitui√ß√£o global segura
            htmlContent = htmlContent.split(highlight.texto).join(highlightedHTML);
            hasChanges = true;
        }
    });

    if (hasChanges) {
        spanElement.innerHTML = htmlContent;
    }
}

// Aplica a tudo (usado quando os destaques carregam DEPOIS do texto)
function applyCachedHighlightsGlobally() {
    const allSpans = document.querySelectorAll('.verse-text');
    allSpans.forEach(span => applyCachedHighlightsToElement(span));
}

// Mantemos esta para compatibilidade com o saveFlashNoteGlobal (para feedback instant√¢neo)
window.applyHighlightToUI = (text, color) => {
    // Adiciona ao cache local para persistir se navegarmos
    currentChapterHighlights.push({ texto: text, cor: color });
    applyCachedHighlightsGlobally();
};


window.applyHighlightToUI = (textToHighlight, colorHex) => {
    if (!textToHighlight) return;

    // Codifica os textos para n√£o quebrar o HTML do onclick
    const safeText = encodeURIComponent(textToHighlight);
    const safeColor = encodeURIComponent(colorHex);

    // Seleciona todos os contentores de texto de vers√≠culos
    const verseElements = document.querySelectorAll('.verse-text');
    
    verseElements.forEach(span => {
        const originalHTML = span.innerHTML;
        const originalText = span.innerText;

        // Verifica se o texto do vers√≠culo cont√©m o trecho selecionado
        if (originalText.includes(textToHighlight)) {
            
            // Verifica se j√° n√£o est√° destacado para evitar duplicados
            // (Verifica se j√° existe a classe E o texto espec√≠fico)
            if (originalHTML.includes('highlight-picotado') && originalHTML.includes(`>${textToHighlight}<`)) {
                return; 
            }

            // CRIA O HTML DO DESTAQUE COM O ONCLICK (CORRE√á√ÉO AQUI)
            const highlightedHTML = `<span class="highlight-picotado" 
                onclick="window.openHighlightDetails(event, '${safeText}', '${safeColor}')"
                style="border-bottom: 3px dotted ${colorHex}; padding-bottom: 1px;">${textToHighlight}</span>`;
            
            // Substitui o texto pelo HTML destacado
            span.innerHTML = originalHTML.split(textToHighlight).join(highlightedHTML);
        }
    });
};

window.openHighlightDetails = async (event, encodedText, encodedColor) => {
    // 1. Prote√ß√£o
    const selection = window.getSelection();
    if (selection && selection.toString().length > 0 && !selection.isCollapsed) return;
    window.hideSelectionToolbar();
    if(event && event.stopPropagation) event.stopPropagation(); 

    const rawPartialText = decodeURIComponent(encodedText);
    let fullText = rawPartialText.trim();
    let displayColor = decodeURIComponent(encodedColor); 

    // 2. Identificar Vers√≠culo
    let vNum;
    let verseRow = event && event.target ? event.target.closest('.verse-item') : null;
    if (verseRow) {
        vNum = verseRow.querySelector('.verse-number').innerText.trim();
    } else {
        vNum = activeVerseFullName.split(':')[1].trim().split('-')[0];
    }
    const fullVerseName = `${selectedBook.nome} ${selectedChapter}:${vNum}`;
    activeVerseFullName = fullVerseName; 

    // UI
    const sidePanel = document.getElementById('side-panel');
    const contentDiv = document.getElementById('sidebar-content');
    const titleEl = document.getElementById('sidebar-verse-title');
    const centerActions = document.getElementById('sidebar-center-actions');
    const backBtn = document.getElementById('sidebar-back-btn');

    sidePanel.classList.add('open');
    if (window.innerWidth <= 768) sidePanel.style.height = '75vh'; else sidePanel.style.height = ''; 
    backBtn.style.display = 'none';

    titleEl.innerHTML = `<span style="color: ${displayColor}; font-weight: bold;">${fullText.substring(0, 20)}...</span>`;
    contentDiv.innerHTML = '<div class="spinner-container" style="padding:40px; text-align:center;"><div class="spinner"></div></div>';

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let masterNoteIds = [];
        let masterDoc = null;

        const qMaster = query(
            collection(db, 'trechosbiblicos'), 
            where('userId', '==', currentUser.uid), 
            where('textosbiblicos', 'array-contains', fullVerseName)
        );
        const snapMaster = await getDocs(qMaster);

        snapMaster.forEach(doc => {
            const data = doc.data();
            if (data.nome && (data.nome.includes(rawPartialText) || rawPartialText.includes(data.nome))) {
                masterDoc = { ...data, id: doc.id };
                if (data.noteIds) masterNoteIds = [...masterNoteIds, ...data.noteIds];
            }
        });

        // Configura t√≠tulo e cor
        if (masterDoc) {
            fullText = masterDoc.nome; 
            displayColor = masterDoc.cor || displayColor;
            activeHighlightContext = { text: fullText, color: displayColor };
        } else {
             activeHighlightContext = { text: fullText, color: displayColor };
        }
        
        titleEl.innerHTML = `<span style="color: ${displayColor}; font-weight: bold;">${fullText}</span>`;

        // --- AQUI EST√Å A CORRE√á√ÉO CR√çTICA DO BOT√ÉO ---
        // Se temos um masterDoc, sabemos exatamente quais s√£o os vers√≠culos envolvidos (ex: 9 e 10)
        let versesListSafe = 'null';
        if (masterDoc && masterDoc.textosbiblicos) {
            versesListSafe = encodeURIComponent(JSON.stringify(masterDoc.textosbiblicos));
        } else {
            // Se for novo, usa o atual
            versesListSafe = encodeURIComponent(JSON.stringify([activeVerseFullName]));
        }

        const btnHtml = `
            <button id="btn-custom-highlight" 
                    onclick="window.openFlashForHighlight('${encodeURIComponent(fullText)}', '${encodeURIComponent(displayColor)}', '${versesListSafe}')" 
                    style="background: var(--accent-color); color: #fff; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.2); white-space: nowrap; font-size: 0.85rem;">
                + Nota no Trecho
            </button>
        `;
        // ---------------------------------------------

        if (centerActions) {
            centerActions.innerHTML = btnHtml;
            centerActions.style.display = 'block';
        }

        // Filtragem e Renderiza√ß√£o
        let finalNotes = [];
        let seenNoteIds = new Set(); 
        const vData = existingUserData[vNum];

        if (vData && vData.puzzleBoard) {
            vData.puzzleBoard.forEach((item, idx) => {
                let shouldInclude = false;
                if (item.noteId && masterNoteIds.includes(item.noteId)) shouldInclude = true;
                if (item.highlightRef === rawPartialText) shouldInclude = true;
                if (item.highlightRef === fullText) shouldInclude = true;
                if (item.highlightRef && (rawPartialText.includes(item.highlightRef) || item.highlightRef.includes(rawPartialText))) shouldInclude = true;

                if (shouldInclude) {
                    if (!seenNoteIds.has(item.noteId || idx)) {
                        seenNoteIds.add(item.noteId || idx);
                        finalNotes.push({ ...item, originalIndex: idx, sourceVerse: vNum });
                    }
                }
            });
        }

        renderHighlightContentConsolidated(contentDiv, finalNotes, displayColor);

    } catch (e) {
        console.error("Erro detalhado:", e);
        contentDiv.innerHTML = `<div style="color:red; padding:20px;">Erro: ${e.message}</div>`;
    }
};

// Nova Fun√ß√£o de Renderiza√ß√£o Consolidada (necess√°ria para lidar com o sourceVerse)
function renderHighlightContentConsolidated(container, notes, contextColor) {
    let html = "";
    if (notes.length === 0) {
        html += `<div style="color:#888; font-style:italic; text-align:center; padding: 40px 20px;">
                    Nenhuma nota encontrada.<br><small>(Crie uma clicando no bot√£o acima)</small>
                 </div>`;
    } else {
        notes.forEach((item) => {
            const displayHtml = cleanMicaContent(item.snippet || item.content);
            const borderColor = item.noteColor || contextColor || '#3498db';
            
            // Usamos o sourceVerse para saber onde editar
            const vToEdit = item.sourceVerse || activeVerseFullName.split(':')[1].trim().split('-')[0];

            // --- CORRE√á√ÉO: VERIFICAR SE EXISTEM FONTES ---
            const boxLinks = window.extractBoxLinksFromSnippet(item.snippet);
            let btnSources = "";
            
            if (boxLinks) {
                const safeJson = encodeURIComponent(JSON.stringify(boxLinks));
                btnSources = `<button onclick="window.viewCardSources('${safeJson}')" style="color:var(--accent-color); font-weight:bold;">üìé Fontes</button>`;
            }
            // ----------------------------------------------

            const menuHtml = `
                <div class="card-menu-container">
                    <div class="card-menu-btn" onclick="window.toggleCardMenu(this)">‚Ä¢‚Ä¢</div>
                    <div class="card-dropdown">
                        <button onclick="window.openEditCard('${vToEdit}', ${item.originalIndex})">‚úèÔ∏è Editar</button>
                        ${btnSources} <!-- INSERIR O BOT√ÉO AQUI -->
                        <button class="btn-remove-card" onclick="window.deletePuzzleItem('${vToEdit}', ${item.originalIndex})">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `;
            html += `
                <div class="detail-card" style="border-left: 4px solid ${borderColor}; margin-bottom: 15px; position: relative;">
                    ${menuHtml} ${displayHtml}
                </div>`;
        });
    }
    container.innerHTML = html;
}


// Fun√ß√£o auxiliar para desenhar o conte√∫do do destaque
function renderHighlightContent(container, notes, contextColor, vNum) {
    let html = "";

    if (notes.length === 0) {
        html += `<div style="color:#888; font-style:italic; text-align:center; padding: 40px 20px;">
                    Nenhuma nota encontrada para este trecho exato.<br>
                    <small>(Crie uma clicando no bot√£o acima)</small>
                 </div>`;
    } else {
        notes.forEach((item) => {
            const displayHtml = cleanMicaContent(item.snippet || item.content);
            
            // --- L√ìGICA DA COR DA BORDA ---
            // 1. Tenta usar a cor espec√≠fica da nota (se foi gravada com uma)
            // 2. Se n√£o tiver, usa a cor do contexto (do trecho picotado)
            // 3. Se tudo falhar, usa azul padr√£o
            const borderColor = item.noteColor || contextColor || '#3498db';

            const menuHtml = `
                <div class="card-menu-container">
                    <div class="card-menu-btn" onclick="window.toggleCardMenu(this)">‚Ä¢‚Ä¢</div>
                    <div class="card-dropdown">
                        <button onclick="window.openEditCard('${vNum}', ${item.originalIndex})">‚úèÔ∏è Editar</button>
                        <button class="btn-remove-card" onclick="window.deletePuzzleItem('${vNum}', ${item.originalIndex})">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `;

            html += `
                <div class="detail-card" style="border-left: 4px solid ${borderColor}; margin-bottom: 15px; position: relative;">
                    ${menuHtml}
                    ${displayHtml}
                </div>`;
        });
    }

    container.innerHTML = html;
}

// Fun√ß√£o chamada pelo bot√£o "Criar Nota neste Trecho"
window.openFlashForHighlight = (encodedText, encodedColor, encodedVerses = null) => {
    const text = decodeURIComponent(encodedText);
    const color = decodeURIComponent(encodedColor);

    // --- GUARDAR ESTADO ---
    activeHighlightContext = { text: text, color: color };
    // ----------------------

    currentSelectionText = text;
    
    // IMPORTANTE: Definimos a cor atual como a cor selecionada.
    selectedColorHex = color; 
    
    // --- CORRE√á√ÉO MULTI-VERS√çCULO ---
    if (encodedVerses && encodedVerses !== 'null') {
        try {
            // Se o bot√£o nos mandou a lista completa de vers√≠culos (9 e 10), usamos essa!
            currentSelectionVerses = JSON.parse(decodeURIComponent(encodedVerses));
        } catch (e) {
            console.error("Erro ao ler vers√≠culos do trecho:", e);
            currentSelectionVerses = [activeVerseFullName];
        }
    } else {
        // Fallback: assume apenas o atual
        currentSelectionVerses = [activeVerseFullName]; 
    }

    // Chama a fun√ß√£o que desenha o form
    window.handleCreateNoteClick();
};

window.injectColorPickerIntoEditModal = () => {
    const editor = document.getElementById('edit-card-content');
    if (!editor) return;

    // Remove picker antigo se existir (para n√£o duplicar ao reabrir)
    const existing = document.getElementById('edit-color-picker');
    if (existing) existing.remove();

    const colors = [
        { name: 'Laranja', hex: '#e67e22' },
        { name: 'Amarelo', hex: '#f1c40f' },
        { name: 'Azul', hex: '#3498db' },
        { name: 'Verde', hex: '#2ecc71' },
        { name: 'Lil√°s', hex: '#9b59b6' },
        { name: 'Rosa', hex: '#ff7979' },
        { name: 'Vermelho', hex: '#e74c3c' },
        { name: 'Castanho', hex: '#a0522d' },
        { name: 'Cinzento', hex: '#95a5a6' }
    ];

    const container = document.createElement('div');
    container.id = 'edit-color-picker'; // ID espec√≠fico para facilitar remo√ß√£o
    container.className = 'color-picker-container';
    container.style.marginTop = "0px";
    container.style.marginBottom = "10px";
    
    colors.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.hex;
        btn.title = c.name;
        
        // Verifica a vari√°vel global selectedColorHex (que definimos ao abrir o modal)
        if (selectedColorHex && selectedColorHex.toLowerCase() === c.hex.toLowerCase()) {
            btn.classList.add('selected');
        }

        btn.onclick = () => {
            container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedColorHex = c.hex; // Atualiza a escolha
        };
        container.appendChild(btn);
    });

    // Insere ANTES da caixa de conte√∫do
    editor.parentElement.insertBefore(container, editor);
};

window.refreshVisualHighlights = () => {
    // 1. Limpeza Inicial
    const allPicotados = document.querySelectorAll('.highlight-picotado');
    allPicotados.forEach(span => {
        const parent = span.parentNode;
        while (span.firstChild) parent.insertBefore(span.firstChild, span);
        parent.removeChild(span);
    });
    document.querySelectorAll('.verse-text').forEach(el => el.normalize());

    // 2. Iterar sobre os destaques no cache
    for (const [vKey, data] of Object.entries(existingUserData)) {
        const verseSpan = document.getElementById(`vtext-${vKey}`);
        if (!verseSpan) continue;

        // Agrupar cores por texto de destaque neste vers√≠culo
        const tempMap = {};
        data.puzzleBoard.forEach(item => {
            if (item.highlightRef && item.highlightRef.trim() !== "") {
                const text = item.highlightRef.trim();
                const color = item.noteColor || item.cor || '#3498db';
                if (!tempMap[text]) tempMap[text] = new Set();
                tempMap[text].add(color);
            }
        });

        // Ordenar por tamanho do texto (maior para o menor) para evitar conflitos de spans
        const sortedTexts = Object.keys(tempMap).sort((a, b) => b.length - a.length);

        sortedTexts.forEach(textToHighlight => {
            const colors = Array.from(tempMap[textToHighlight]);
            let styleString = "";
            const dashWidth = 6; 
            const gapWidth = 3;

            if (colors.length === 1) {
                // Uma cor: Gradiente simples
                styleString = `background-image: linear-gradient(to right, ${colors[0]} 50%, transparent 50%); background-position: bottom; background-size: ${dashWidth + gapWidth}px 3px; background-repeat: repeat-x;`;
            } else {
                // M√∫ltiplas cores: Gradiente repetido alternado
                let gradientParts = [];
                let currentPos = 0;
                colors.forEach(color => {
                    gradientParts.push(`${color} ${currentPos}px ${currentPos + dashWidth}px`);
                    currentPos += dashWidth;
                    gradientParts.push(`transparent ${currentPos}px ${currentPos + gapWidth}px`);
                    currentPos += gapWidth;
                });
                styleString = `background-image: repeating-linear-gradient(to right, ${gradientParts.join(', ')}); background-position: bottom; background-size: ${currentPos}px 3px; background-repeat: repeat-x;`;
            }

            const safeText = encodeURIComponent(textToHighlight);
            const mainColor = encodeURIComponent(colors[colors.length - 1]);

            // Aplicar no DOM usando TreeWalker para seguran√ßa
            const walker = document.createTreeWalker(verseSpan, NodeFilter.SHOW_TEXT, null, false);
            const escapedTerm = textToHighlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escapedTerm, 'i');

            while (walker.nextNode()) {
                const node = walker.currentNode;
                if (node.parentNode.classList.contains('highlight-picotado')) continue;

                if (node.nodeValue && regex.test(node.nodeValue)) {
                    const match = regex.exec(node.nodeValue);
                    const matchIndex = match.index;
                    const matchLength = match[0].length;

                    const after = node.splitText(matchIndex + matchLength);
                    const middle = node.splitText(matchIndex);

                    const span = document.createElement('span');
                    span.className = 'highlight-picotado';
                    span.textContent = middle.nodeValue;
                    span.style.cssText = styleString + " cursor: pointer; padding-bottom: 3px; text-decoration: none; border-bottom: none;";
                    span.onclick = (e) => window.openHighlightDetails(e, safeText, mainColor);

                    middle.parentNode.replaceChild(span, middle);
                    break; 
                }
            }
        });
    }
};



// --- FUN√á√ÉO AUXILIAR PARA CORRIGIR SELE√á√ïES MULTI-VERS√çCULO ---
function calculateVerseIntersection(verseText, fullSelection) {
    if (!verseText || !fullSelection) return null;
    const vNormal = verseText.replace(/\s+/g, ' ').trim();
    const sNormal = fullSelection.replace(/\s+/g, ' ').trim();
    if (vNormal.includes(sNormal)) return sNormal;
    if (sNormal.includes(vNormal)) return vNormal;
    for (let i = sNormal.length; i > 5; i--) {
        const chunkEnd = sNormal.substring(sNormal.length - i);
        if (vNormal.startsWith(chunkEnd)) return chunkEnd;
        const chunkStart = sNormal.substring(0, i);
        if (vNormal.endsWith(chunkStart)) return chunkStart;
    }
    return null;
}


window.hideSelectionToolbar = () => {
    const toolbar = document.getElementById('selection-toolbar');
    if (toolbar) {
        toolbar.style.display = 'none';
    }
    // Remove a sele√ß√£o azul do texto para ficar limpo
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    }
    // Limpa a vari√°vel global de texto selecionado
    currentSelectionText = "";
    currentSelectionVerses = [];
};


// Abrir Navegador de Marcadores
document.getElementById('bookmarks-btn').addEventListener('click', () => {
    // Se for PC, podemos usar o SidePanel (opcional), mas o modal funciona bem em ambos.
    // Para cumprir o requisito "Painel (PC) / Popup (Mobile)", vamos usar o modal
    // mas estiliz√°-lo como painel lateral se for PC.
    
    const modal = document.getElementById('bookmarks-navigator-modal');
    modal.style.display = 'flex';
    
    // Carrega a lista inicial (Categorias)
    loadBookmarkCategories();
});

// Bot√£o Voltar dentro do Modal
document.getElementById('bk-nav-back').addEventListener('click', () => {
    loadBookmarkCategories();
});


// Carregar Categorias (G√©neros)
async function loadBookmarkCategories() {
    const listDiv = document.getElementById('bk-nav-content');
    const titleEl = document.getElementById('bk-nav-title');
    const backBtn = document.getElementById('bk-nav-back');
    
    listDiv.innerHTML = '<div class="spinner-container" style="padding:20px; text-align:center;"><div class="spinner"></div></div>';
    titleEl.textContent = "Meus Marcadores";
    backBtn.style.display = 'none';

    try {
        const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'marcadores'), 
            where('userId', '==', currentUser.uid),
            orderBy('nome')
        );
        
        const snap = await getDocs(q);
        listDiv.innerHTML = '';
        
        if (snap.empty) {
            listDiv.innerHTML = '<p style="padding:20px; text-align:center; color:#888;">Sem marcadores criados.</p>';
            return;
        }

        snap.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'bk-list-item';
            div.innerHTML = `
                <span>üîñ ${data.nome}</span>
                <span class="bk-count">‚ûî</span>
            `;
            div.onclick = () => loadVersesInBookmark(doc.id, data.nome);
            listDiv.appendChild(div);
        });

    } catch (e) {
        console.error(e);
        listDiv.innerHTML = '<p style="color:red; padding:10px;">Erro ao carregar.</p>';
    }
}

// Carregar Vers√≠culos dentro de uma Categoria
async function loadVersesInBookmark(markerId, markerName) {
    const listDiv = document.getElementById('bk-nav-content');
    const titleEl = document.getElementById('bk-nav-title');
    const backBtn = document.getElementById('bk-nav-back');

    listDiv.innerHTML = '<div class="spinner-container" style="padding:20px; text-align:center;"><div class="spinner"></div></div>';
    titleEl.textContent = markerName;
    backBtn.style.display = 'block';

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Procura textos que tenham este marcador
        const q = query(
            collection(db, 'textosbiblicos'),
            where(`marcadoresAssociados.${markerId}`, '==', true),
            where('userId', '==', currentUser.uid)
        );

        const snap = await getDocs(q);
        listDiv.innerHTML = '';

        if (snap.empty) {
            listDiv.innerHTML = '<p style="padding:20px; text-align:center; color:#888;">Nenhum vers√≠culo nesta categoria.</p>';
            return;
        }

        // Ordenar alfabeticamente (opcional)
        const verses = [];
        snap.forEach(doc => verses.push({id: doc.id, ...doc.data()}));
        verses.sort((a,b) => a.nome.localeCompare(b.nome, undefined, {numeric: true}));

        verses.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bk-verse-item';
            div.innerHTML = `
                <div class="bk-verse-ref">üìú ${item.nome}</div>
                ${item.descricao ? `<div class="bk-verse-desc">${item.descricao.substring(0, 50)}...</div>` : ''}
            `;
            
            // AQUI EST√Å A MAGIA DO SCROLL
            div.onclick = () => {
                document.getElementById('bookmarks-navigator-modal').style.display = 'none';
                navigateToBibleVerse(item.nome);
            };
            
            listDiv.appendChild(div);
        });

    } catch (e) {
        console.error(e);
        listDiv.innerHTML = '<p style="color:red; padding:10px;">Erro ao carregar vers√≠culos.</p>';
    }
}

async function navigateToBibleVerse(verseRef) {

    // 1. Parse da string (Ex: "1 Cor√≠ntios 13:4")
    // Regex captura: (Nome do Livro) (Cap√≠tulo):(Vers√≠culo)
    // Suporta nomes com n√∫meros e espa√ßos (ex: 1 Reis, Atos)
    const match = verseRef.match(/(.+)\s+(\d+):(\d+)/);
    
    if (!match) {
        alert("Formato de refer√™ncia inv√°lido.");
        return;
    }

    const bookName = match[1].trim();
    const chapter = parseInt(match[2]);
    const verse = parseInt(match[3]);

    // 2. Encontrar o Livro na Base de Dados Local (BIBLE_DATA)
    const bookData = BIBLE_DATA.find(b => b.nome.toLowerCase() === bookName.toLowerCase());
    
    if (!bookData) {
        alert(`Livro "${bookName}" n√£o encontrado.`);
        return;
    }

    // 3. Abrir o Cap√≠tulo
    // Isto define o selectedBook globalmente e prepara a vista
    selectedBook = bookData;
    
    // Chama a fun√ß√£o existente que carrega o cap√≠tulo e o texto
    // Importante: openVerses tem de ser async para esperarmos o texto carregar
    await openVerses(chapter);

    // 4. Scroll e Destaque
    // Espera um pouco para o DOM renderizar
    setTimeout(() => {
        // Tenta encontrar pelo n√∫mero ou pelo texto
        const verseElement = document.getElementById(`vnum-${verse}`) || document.getElementById(`vtext-${verse}`);
        
        if (verseElement) {
            // Scroll suave para o centro
            verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Efeito visual (Flash)
            const parentRow = verseElement.closest('.verse-item');
            if (parentRow) {
                parentRow.classList.add('flash-target');
                setTimeout(() => parentRow.classList.remove('flash-target'), 2000);
            }
        } else {
            console.warn("Vers√≠culo n√£o encontrado no DOM:", verse);
        }
    }, 300); // 300ms delay para garantir que o HTML foi injetado
}

// 1. Abrir Modal de Sele√ß√£o
window.openBibleBookmarkModal = async (vNum) => {
    const modal = document.getElementById('bible-bookmark-modal');
    const list = document.getElementById('bible-bookmark-list');
    const targetSpan = document.getElementById('bk-verse-target');
    
    // Guarda o n√∫mero do vers√≠culo atual para usar depois
    modal.dataset.vNum = vNum;
    targetSpan.textContent = activeVerseFullName;
    
    modal.style.display = 'flex';
    list.innerHTML = '<li>A carregar marcadores...</li>';

    try {
        const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Busca marcadores do utilizador
        const q = query(collection(db, 'marcadores'), where('userId', '==', currentUser.uid), orderBy('nome'));
        const snap = await getDocs(q);
        
        list.innerHTML = '';
        
        if (snap.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Sem marcadores criados. Crie um abaixo.</li>';
        }

        snap.forEach(doc => {
            const m = doc.data();
            const li = document.createElement('li');
            li.className = 'bk-select-item';
            li.innerHTML = `<span>üîñ ${m.nome}</span>`;
            
            li.onclick = () => window.saveBibleBookmark(doc.id);
            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar lista.</li>';
    }
};

// 2. Criar Novo G√©nero de Marcador (Bot√£o +)
window.createNewBookmarkGenre = async () => {
    const input = document.getElementById('new-bookmark-input');
    const name = input.value.trim();
    if (!name) return alert("Escreva um nome.");
    
    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const ref = await addDoc(collection(db, 'marcadores'), {
            nome: name,
            userId: currentUser.uid,
            createdAt: serverTimestamp()
        });
        
        input.value = "";
        // Usa o novo ID para aplicar logo
        window.saveBibleBookmark(ref.id);
        
    } catch (e) {
        console.error(e);
        alert("Erro ao criar marcador.");
    }
};

// 3. Gravar Marcador no Vers√≠culo
window.saveBibleBookmark = async (markerId) => {
    const modal = document.getElementById('bible-bookmark-modal');
    const vNum = modal.dataset.vNum; // Recupera o n√∫mero do vers√≠culo
    const verseName = activeVerseFullName;

    // Fechar modal visualmente logo
    modal.style.display = 'none';

    try {
        const { collection, query, where, getDocs, addDoc, updateDoc, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // Verifica se o documento do vers√≠culo j√° existe
        let docId = activeVerseDocId;
        
        if (!docId) {
            // Se n√£o existe, cria
            const newDoc = await addDoc(collection(db, 'textosbiblicos'), {
                nome: verseName,
                userId: currentUser.uid,
                createdAt: serverTimestamp(),
                marcadoresAssociados: { [markerId]: true }, // Adiciona o marcador
                puzzleBoard: [],
                dossie: [],
                panelLinks: []
            });
            docId = newDoc.id;
        } else {
            // Se existe, atualiza
            const verseRef = doc(db, 'textosbiblicos', docId);
            await updateDoc(verseRef, {
                [`marcadoresAssociados.${markerId}`]: true
            });
        }

        // --- ATUALIZA√á√ÉO VISUAL IMEDIATA ---
        // Atualiza a cache local
        if (!existingUserData[vNum]) existingUserData[vNum] = {};
        existingUserData[vNum].docId = docId;
        if (!existingUserData[vNum].marcadoresAssociados) existingUserData[vNum].marcadoresAssociados = {};
        existingUserData[vNum].marcadoresAssociados[markerId] = true;

        // Recarrega o painel lateral para mostrar o √≠cone üîñ e esconder o bot√£o +
        window.openModalForVerse(vNum);

    } catch (e) {
        console.error("Erro ao gravar marcador:", e);
        alert("Erro ao guardar marcador.");
    }
};

// 4. Gerir/Remover (Ao clicar no t√≠tulo "üîñ J√≥ 1:1")
window.manageBibleBookmark = async (vNum) => {
    // Reutiliza o modal, mas mostra quais est√£o ativos para remover
    const modal = document.getElementById('bible-bookmark-modal');
    const list = document.getElementById('bible-bookmark-list');
    const targetSpan = document.getElementById('bk-verse-target');

    modal.dataset.vNum = vNum;
    targetSpan.textContent = activeVerseFullName;
    modal.style.display = 'flex';
    list.innerHTML = '<li>A carregar...</li>';

    // Obt√©m dados da cache
    const currentData = existingUserData[vNum];
    const activeMarkers = currentData && currentData.marcadoresAssociados ? currentData.marcadoresAssociados : {};

    try {
        const { collection, query, where, getDocs, orderBy, updateDoc, doc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(collection(db, 'marcadores'), where('userId', '==', currentUser.uid), orderBy('nome'));
        const snap = await getDocs(q);
        
        list.innerHTML = '';
        
        snap.forEach(docSnap => {
            const m = docSnap.data();
            const isActive = !!activeMarkers[docSnap.id];
            
            const li = document.createElement('li');
            li.className = 'bk-select-item';
            
            // Se ativo, mostra Check verde
            li.innerHTML = `
                <span style="${isActive ? 'color:var(--accent-color); font-weight:bold;' : ''}">
                    ${isActive ? '‚úì ' : ''} ${m.nome}
                </span>
            `;
            
            li.onclick = async () => {
                // TOGGLE L√ìGICA
                const verseRef = doc(db, 'textosbiblicos', currentData.docId);
                
                if (isActive) {
                    // REMOVER
                    await updateDoc(verseRef, { [`marcadoresAssociados.${docSnap.id}`]: deleteField() });
                    delete existingUserData[vNum].marcadoresAssociados[docSnap.id];
                } else {
                    // ADICIONAR
                    await updateDoc(verseRef, { [`marcadoresAssociados.${docSnap.id}`]: true });
                    existingUserData[vNum].marcadoresAssociados[docSnap.id] = true;
                }
                
                // Fecha e recarrega UI
                modal.style.display = 'none';
                window.openModalForVerse(vNum);
            };

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
    }
};

window.switchDetailTab = (tabName) => {
    // 1. Remove classe 'active' de todos os bot√µes e pain√©is
    document.querySelectorAll('.verse-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

    // 2. Adiciona classe 'active' ao bot√£o clicado e ao painel correspondente
    const btn = document.getElementById(`btn-tab-${tabName}`);
    const pane = document.getElementById(`pane-${tabName}`);

    if (btn) btn.classList.add('active');
    if (pane) pane.classList.add('active');
};

// --- FUN√á√ÉO PARA TROCAR CAP√çTULOS ---
window.changeChapter = (delta) => {
    if (!selectedBook || !selectedChapter) return;

    let newCap = selectedChapter + delta;

    // 1. Navega√ß√£o simples dentro do mesmo livro
    if (newCap >= 1 && newCap <= selectedBook.caps) {
        openVerses(newCap);
    } 
    // 2. Mudar de Livro (Ir para o Pr√≥ximo)
    else if (newCap > selectedBook.caps) {
        // Encontra o √≠ndice do livro atual
        const currentIdx = BIBLE_DATA.findIndex(b => b.id === selectedBook.id);
        
        // Se houver pr√≥ximo livro
        if (currentIdx < BIBLE_DATA.length - 1) {
            selectedBook = BIBLE_DATA[currentIdx + 1]; // Muda o livro global
            openVerses(1); // Abre o cap 1 do novo livro
        }
    }
    // 3. Mudar de Livro (Ir para o Anterior)
    else if (newCap < 1) {
        const currentIdx = BIBLE_DATA.findIndex(b => b.id === selectedBook.id);
        
        // Se houver livro anterior
        if (currentIdx > 0) {
            selectedBook = BIBLE_DATA[currentIdx - 1]; // Muda o livro global
            openVerses(selectedBook.caps); // Abre o √öLTIMO cap do livro anterior
        }
    }
};

// --- NAVEGADOR R√ÅPIDO DE CAP√çTULOS ---

// 1. Abrir/Fechar o Painel
window.toggleChapterNav = (event) => {
    // 1. IMPEDE QUE O CLIQUE FECHE O PAINEL IMEDIATAMENTE
    if (event) event.stopPropagation();

    const panel = document.getElementById('chapter-nav-panel');
    
    // Verifica se est√° vis√≠vel (se N√ÉO tem a classe hidden ou se o display √© grid)
    const isVisible = panel.style.display === 'grid' && !panel.classList.contains('hidden');
    
    // Toggle (Abrir/Fechar)
    if (isVisible) {
        panel.style.display = 'none';
        panel.classList.add('hidden'); // IMPORTANTE: Repor a classe hidden
        return;
    }

    // Gerar e Mostrar
    if (selectedBook) {
        panel.innerHTML = ''; 
        
        for (let i = 1; i <= selectedBook.caps; i++) {
            const btn = document.createElement('div');
            btn.className = 'nav-cap-btn';
            btn.innerText = i;
            
            if (i === selectedChapter) btn.classList.add('active');

            btn.onclick = () => {
                panel.style.display = 'none';
                panel.classList.add('hidden'); // Esconder ao clicar num cap√≠tulo
                openVerses(i);
            };
            
            panel.appendChild(btn);
        }
        
        // CORRE√á√ÉO AQUI:
        panel.classList.remove('hidden'); // Remove a classe que tem !important
        panel.style.display = 'grid';     // Aplica o grid
    }
};

// 2. Fechar o painel se clicar fora dele
window.addEventListener('click', (e) => {
    const panel = document.getElementById('chapter-nav-panel');
    
    // S√≥ fecha se o painel existir, estiver vis√≠vel E o clique N√ÉO for dentro do painel
    if (panel && !panel.classList.contains('hidden') && !panel.contains(e.target)) {
        panel.style.display = 'none';
        panel.classList.add('hidden'); // Garante que volta a ficar hidden
    }
});

// 1. INJETAR O BOT√ÉO NA HEADER (Ao lado esquerdo do Bookmark)
function injectAnchorButton() {
    const bookmarkBtn = document.getElementById('bookmarks-btn');
    
    // Verifica se o bot√£o j√° existe para n√£o duplicar
    if (bookmarkBtn && !document.getElementById('bible-anchors-btn')) {
        const btn = document.createElement('button');
        btn.id = 'bible-anchors-btn';
        btn.innerHTML = '‚öì';
        btn.title = '√Çncoras neste Cap√≠tulo';
        
        // CORRE√á√ÉO AQUI:
        // Verifica se j√° estamos na vista de vers√≠culos. 
        // Se sim, nasce vis√≠vel. Se n√£o, nasce oculto.
        const initialDisplay = (currentView === 'verses') ? 'inline-block' : 'none';

        btn.style.cssText = `background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; margin-right: 5px; min-width: 30px; display: ${initialDisplay};`;
        
        bookmarkBtn.parentNode.insertBefore(btn, bookmarkBtn);
        
        btn.onclick = openBibleAnchorsModal;
    }
}
// Reduzir o tempo para garantir que aparece mais r√°pido, mas mantendo o check dentro da fun√ß√£o
setTimeout(injectAnchorButton, 500);


// 2. ABRIR O POPUP E PROCESSAR DADOS
window.openBibleAnchorsModal = async () => {
    const modal = document.getElementById('bible-anchors-modal');
    const list = document.getElementById('bible-anchors-list');
    
    modal.style.display = 'flex';
    list.innerHTML = '<div class="spinner-container" style="padding:20px; text-align:center;"><div class="spinner"></div>A analisar texto...</div>';

    try {
        const myUid = auth.currentUser.uid;
        
        // A. Obter texto do cap√≠tulo atual
        const chapterElement = document.getElementById('verses-list');
        if (!chapterElement) return;
        const chapterText = chapterElement.innerText.toLowerCase(); // Texto completo para pesquisa

        // B. Encontrar o ID da √Çncora "B√≠blia"
        const qAnchor = query(collection(db, 'ancoras'), where('userId', '==', myUid), where('nome', '==', 'B√≠blia'));
        const anchorSnap = await getDocs(qAnchor);
        
        if (anchorSnap.empty) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:#e74c3c;">√Çncora "B√≠blia" n√£o encontrada.<br><small>Crie uma √¢ncora chamada "B√≠blia" no NotaBook.</small></li>';
            return;
        }
        
        const bibleAnchorId = anchorSnap.docs[0].id;

        // C. Pesquisar Entidades com essa √Çncora
        // Vamos procurar nas principais cole√ß√µes: personagens, locais, cosmos, subcosmos, topicos
        const collectionsToCheck = [
            { name: 'personagens', type: 'Personagem' },
            { name: 'locais', type: 'Local' },
            { name: 'cosmos', type: 'Tema' },
            { name: 'subcosmos', type: 'Subtema' },
            { name: 'topicos', type: 'T√≥pico' }
        ];

        let foundItems = [];

        // Executa queries em paralelo
        const promises = collectionsToCheck.map(async (col) => {
            // Procura onde a chave da √¢ncora existe e √© true
            const qEnt = query(
                collection(db, col.name), 
                where('userId', '==', myUid),
                where(`ancorasAssociadas.${bibleAnchorId}`, '==', true)
            );
            
            const snap = await getDocs(qEnt);
            
            snap.forEach(doc => {
                const data = doc.data();
                // FILTRO FINAL: O nome est√° no texto do cap√≠tulo?
                if (chapterText.includes(data.nome.toLowerCase())) {
                    foundItems.push({
                        id: doc.id,
                        name: data.nome,
                        type: col.type, // Nome bonito para exibir
                        collection: col.name, // Nome t√©cnico para buscar dados
                        data: data // Guardamos os dados para n√£o ter de buscar outra vez
                    });
                }
            });
        });

        await Promise.all(promises);

        // D. Renderizar Lista
        list.innerHTML = '';
        
        if (foundItems.length === 0) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">Nenhuma entidade com a √¢ncora "B√≠blia" encontrada neste cap√≠tulo.</li>';
            return;
        }

        // Ordenar alfabeticamente
        foundItems.sort((a, b) => a.name.localeCompare(b.name));

    foundItems.forEach(item => {
            const li = document.createElement('li');
            li.className = 'bible-anchor-item';
            li.innerHTML = `
                <span class="bible-anchor-name">${item.name}</span>
                <span class="bible-anchor-type">${item.type}</span>
            `;
            
            li.onclick = () => {
                modal.style.display = 'none';
                
                // 1. APLICAR SUBLINHADO VISUAL NO TEXTO
                highlightAnchorInText(item.name);
                
                // 2. ABRIR PAINEL LATERAL
                openEntityInSidePanel(item);
            };
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error("Erro ao carregar √¢ncoras:", e);
        list.innerHTML = '<li style="padding:20px; color:red;">Erro ao processar dados.</li>';
    }
};


// 3. ABRIR PAINEL LATERAL EM MODO LEITURA (Para Entidades)
window.openEntityInSidePanel = async (item) => {
    const sidePanel = document.getElementById('side-panel');
    const contentDiv = document.getElementById('sidebar-content');
    const titleEl = document.getElementById('sidebar-verse-title');
    const backBtn = document.getElementById('sidebar-back-btn');
    const centerActions = document.getElementById('sidebar-center-actions');

    // 1. Configurar Visual (Modo Leitura)
    sidePanel.classList.add('open');
    sidePanel.classList.add('read-only-mode'); // <--- CSS esconde bot√µes de edi√ß√£o
    
    // Esconde bot√µes de a√ß√£o do header (criados para vers√≠culos)
    if (centerActions) centerActions.style.display = 'none';
    if (backBtn) backBtn.style.display = 'none';

    titleEl.innerHTML = `‚öì ${item.name}`;
    contentDiv.innerHTML = '<div class="spinner-container" style="padding:40px; text-align:center;"><div class="spinner"></div></div>';

    // 2. Buscar Dados Completos (Se n√£o vierem completos do passo anterior)
    // Nota: Como j√° temos 'item.data' do passo anterior, podemos usar direto, 
    // mas por seguran√ßa vamos buscar fresco caso precise de campos extra.
    
    // Adaptamos os dados para o formato que o buildVerseHTML espera
    // O 'buildVerseHTML' espera: { puzzleBoard: [], dossie: [], panelLinks: [] }
    const formattedData = {
        puzzleBoard: item.data.puzzleBoard || [],
        dossie: item.data.dossie || [],
        panelLinks: item.data.panelLinks || []
    };

    // 3. Renderizar usando a fun√ß√£o existente
    // Passamos 'null' como n√∫mero de vers√≠culo porque n√£o √© um vers√≠culo
    const htmlContent = buildVerseHTML(formattedData, null);
    contentDiv.innerHTML = htmlContent;
    
    // 4. Corre√ß√£o: Remover bot√µes de edi√ß√£o que o HTML gerou
    // (O CSS .read-only-mode j√° deve tratar disto, mas por seguran√ßa...)
    const removeButtons = contentDiv.querySelectorAll('.card-menu-container, .btn-remove-row, .btn-unit-add, .btn-unit-del');
    removeButtons.forEach(btn => btn.remove());
};

// 4. LISTENER PARA LIMPAR MODO LEITURA AO FECHAR
// Adicione isto para garantir que quando voltar a abrir um vers√≠culo normal, o painel volta ao normal
const closePanelBtn = document.querySelector('#side-panel .modal-close');
if (closePanelBtn) {
    const oldOnClick = closePanelBtn.onclick;
    closePanelBtn.onclick = (e) => {
        document.getElementById('side-panel').classList.remove('read-only-mode');
        if (oldOnClick) oldOnClick(e);
    };
}
// Tamb√©m no window.closeSidePanel
const originalCloseSide = window.closeSidePanel;
window.closeSidePanel = () => {
    document.getElementById('side-panel').classList.remove('read-only-mode');
    
    // LINHA NOVA: Limpa os sublinhados verdes das √¢ncoras
    highlightAnchorInText(null); 
    
    if (originalCloseSide) originalCloseSide();
};

// Fun√ß√£o auxiliar para escapar caracteres especiais na Regex
function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Fun√ß√£o para destacar a palavra da √¢ncora no texto b√≠blico
function highlightAnchorInText(term) {
    const root = document.getElementById('verses-list');
    if (!root) return;

    // 1. LIMPEZA: Remove destaques anteriores (desembrulha o texto)
    const oldHighlights = root.querySelectorAll('.anchor-highlight');
    oldHighlights.forEach(span => {
        const parent = span.parentNode;
        while (span.firstChild) {
            parent.insertBefore(span.firstChild, span);
        }
        parent.removeChild(span);
    });

    // Normaliza o DOM ap√≥s remover os spans para juntar os n√≥s de texto partidos
    root.normalize();

    // Se n√£o houver termo novo (apenas limpeza), sai
    if (!term) return;

    // 2. APLICA√á√ÉO: Usa TreeWalker
    const walker = document.createTreeWalker(
        root, 
        NodeFilter.SHOW_TEXT, 
        null, 
        false
    );

    // --- A MAGIA DA CORRE√á√ÉO ---
    // Em vez de \b, usamos Lookbehind (?<!) e Lookahead (?!).
    // Dizemos: "Encontra a palavra, DESDE QUE o que est√° atr√°s n√£o seja uma letra
    // e o que est√° √† frente tamb√©m n√£o seja uma letra (incluindo acentos)".
    
    // Intervalo de letras: \w (letras normais) + \u00C0-\u00FF (Acentos Latim-1: √°, √©, √≠, √≥, √∫, √ß, √£, etc.)
    const letterPattern = '[\\w\\u00C0-\\u00FF]';
    
    const regex = new RegExp(`(?<!${letterPattern})(${escapeRegExp(term)})(?!${letterPattern})`, 'gi');
    
    const nodesToProcess = [];

    // Primeiro recolhemos todos os n√≥s (para n√£o baralhar o walker enquanto editamos)
    while (walker.nextNode()) {
        const node = walker.currentNode;
        // Ignora scripts e estilos
        if (node.parentNode.tagName === 'SCRIPT' || node.parentNode.tagName === 'STYLE') continue;
        // Ignora se j√° estiver dentro de um highlight (seguran√ßa)
        if (node.parentNode.classList.contains('anchor-highlight')) continue;

        if (node.nodeValue && regex.test(node.nodeValue)) {
            nodesToProcess.push(node);
        }
    }

    // Processa os n√≥s encontrados
    nodesToProcess.forEach(textNode => {
        const text = textNode.nodeValue;
        let match;
        
        // Reset do √≠ndice da regex
        regex.lastIndex = 0;
        
        // Executa a regex. Nota: processamos apenas a primeira ocorr√™ncia por n√≥ de texto 
        // para manter a estabilidade do DOM. Se a palavra aparecer 2x no mesmo vers√≠culo,
        // pode ser necess√°rio recarregar a fun√ß√£o ou fazer um loop while complexo.
        // Para leitura b√≠blica, este m√©todo √© geralmente suficiente e muito r√°pido.
        
        if ((match = regex.exec(text)) !== null) {
            const matchIndex = match.index;
            const matchLength = match[0].length;

            // 1. Corta o texto depois da palavra
            const afterTextNode = textNode.splitText(matchIndex + matchLength);
            
            // 2. Corta o texto antes da palavra (o n√≥ original fica com o in√≠cio)
            const middleTextNode = textNode.splitText(matchIndex);
            
            // 3. Cria o SPAN e envolve o meio
            const span = document.createElement('span');
            span.className = 'anchor-highlight';
            span.textContent = middleTextNode.nodeValue;
            
            middleTextNode.parentNode.replaceChild(span, middleTextNode);
        }
    });
}

// ============================================================
// L√ìGICA DE ARRASTO DO PAINEL (MOBILE BOTTOM SHEET)
// ============================================================
// 1. IN√çCIO DO TOQUE (No cabe√ßalho ou no topo do painel)
panel.addEventListener('touchstart', (e) => {
    // S√≥ permite arrastar se tocar no topo (header)
    // Se tocar no conte√∫do (texto), deve permitir scroll normal, n√£o arrasto do painel
    if (e.target.closest('.modal-header') || e.target === panel) {
        isDragging = true;
        startY = e.touches[0].clientY;
        startHeight = panel.offsetHeight; // Altura atual em pixels
        
        panel.classList.add('is-dragging'); // Desliga anima√ß√µes CSS
    }
}, { passive: false });

// 2. MOVIMENTO (Arrastar)
window.addEventListener('touchmove', (e) => {
    if (!isDragging) return;

    // Impede o scroll da p√°gina por tr√°s
    if (e.cancelable) e.preventDefault();

    const currentY = e.touches[0].clientY;
    const deltaY = startY - currentY; // Se for positivo, estamos a puxar para cima
    
    let newHeight = startHeight + deltaY;
    const screenHeight = window.innerHeight;

    // Converter para percentagem (vh) para facilitar limites
    const newHeightVh = (newHeight / screenHeight) * 100;

    // APLICA√á√ÉO DOS LIMITES (10% a 90%)
    if (newHeightVh < 10) newHeight = screenHeight * 0.10; // M√≠nimo 10%
    if (newHeightVh > 90) newHeight = screenHeight * 0.90; // M√°ximo 90%

    panel.style.height = `${newHeight}px`;
}, { passive: false });

// 3. FIM DO TOQUE
window.addEventListener('touchend', () => {
    if (!isDragging) return;
    isDragging = false;
    panel.classList.remove('is-dragging'); // Reativa anima√ß√µes CSS
});

// ============================================================
// ATUALIZA√á√ÉO DA FUN√á√ÉO DE ABERTURA (COM LOGS)
// ============================================================

// Guardamos a refer√™ncia da fun√ß√£o original (a que carrega o HTML/conte√∫do)
// para n√£o ter de repetir a l√≥gica de base de dados aqui.
if (typeof window.originalOpenEntity === 'undefined') {
    // S√≥ guarda se ainda n√£o tiver guardado, para evitar loops
    window.originalOpenEntity = window.openEntityInSidePanel; 
}

window.openEntityInSidePanel = async (item) => {
    console.group(`üöÄ [DEBUG] A√ß√£o de Clique: ${item.name}`);

    // Chama a l√≥gica original (que carrega o texto, limpa bot√µes, etc.)
    if (window.originalOpenEntity) {
        await window.originalOpenEntity(item);
    } else {
        console.warn("‚ö†Ô∏è Fun√ß√£o originalOpenEntity n√£o encontrada (pode ser a primeira execu√ß√£o).");
    }

    // --- L√ìGICA EXTRA PARA MOBILE ---
    const screenWidth = window.innerWidth;

    if (screenWidth <= 768) {
        
        const panel = document.getElementById('side-panel');
        
        if (panel) {
            // Log do estado antes
            
            // Define a altura inicial como 45% da tela
            panel.style.height = "45vh";

            
            // Garante que a transi√ß√£o ocorre visualmente
            requestAnimationFrame(() => {
                panel.classList.add('open');
                
                // Log de confirma√ß√£o visual
                setTimeout(() => {
                    const computed = window.getComputedStyle(panel);
                    console.groupEnd();
                }, 100);
            });
        } else {
            console.error("‚ùå ERRO CR√çTICO: Elemento #side-panel n√£o encontrado no HTML!");
            console.groupEnd();
        }
    } else {
        console.groupEnd();
    }
};

// ============================================================
// ATUALIZA√á√ÉO DA FUN√á√ÉO DE FECHO (Bot√£o X)
// ============================================================

// O bot√£o X fecha TOTALMENTE o painel
// (J√° existe um onclick no seu HTML chamando closeSidePanel, vamos refor√ß√°-lo)
const originalClose = window.closeSidePanel;

window.closeSidePanel = () => {
    const panel = document.getElementById('side-panel');
    
    // --- 1. A√á√ÉO VISUAL IMEDIATA (Prioridade M√°xima) ---
    if (window.innerWidth <= 768) {
        // Dispara a anima√ß√£o de descida no instante do clique
        panel.style.transform = "translateY(100%)";
    } else {
        panel.classList.remove('open');
    }

    // --- 2. ATUALIZA√á√ÉO DE URL (N√£o bloqueia, fazemos j√°) ---
    // Usamos replace=true para ser mais r√°pido e n√£o criar hist√≥rico
    if (selectedBook && selectedChapter && typeof updateUrlParams === 'function') {
        updateUrlParams(selectedBook.nome, selectedChapter, null, true);
    }

    // --- 3. LIMPEZAS DE BASTIDORES (Durante/Ap√≥s a anima√ß√£o) ---
    // Colocamos as tarefas "pesadas" dentro do timeout para n√£o travar a anima√ß√£o visual inicial
    setTimeout(() => {
        // Reset das propriedades do painel
        if (window.innerWidth <= 768) {
            panel.classList.remove('open');
            panel.style.height = "0"; 
            panel.style.transform = ""; 
        }

        // Limpezas de DOM (que podem causar pequenos 'solu√ßos')
        panel.classList.remove('read-only-mode');
        if (typeof highlightAnchorInText === 'function') highlightAnchorInText(null);
        document.querySelectorAll('.verse-number.active-selection').forEach(el => el.classList.remove('active-selection'));
        
    }, 150); // 150ms = Tempo exato da transi√ß√£o CSS que definimos antes
};


// REFOR√áO PARA MOBILE: Dete√ß√£o de fim de sele√ß√£o t√°til
document.addEventListener('touchend', () => {
    // Pequeno delay para o sistema processar a sele√ß√£o nativa
    setTimeout(() => {
        const selection = window.getSelection();
        
        // 1. Verifica se h√° sele√ß√£o v√°lida
        if (selection && !selection.isCollapsed) {
            const rawText = selection.toString();
            
            if (rawText.trim().length > 0) {
                // A. Normaliza o texto (remove quebras de linha estranhas)
                currentSelectionText = rawText.replace(/[\n\r]+/g, ' ').replace(/\s+/g, ' ').trim();
                
                // B. Identifica os vers√≠culos
                const range = selection.getRangeAt(0);
                identifyVersesInSelection(range);

                // C. Configura a Barra Flutuante
                const toolbar = document.getElementById('selection-toolbar');
                const btnNote = document.getElementById('btn-note-selection');

                if (toolbar) {
                    if (currentSelectionVerses.length > 1 && btnNote) {
                        btnNote.innerHTML = `‚úç Nota (${currentSelectionVerses.length} vs)`;
                    } else if (btnNote) {
                        btnNote.innerHTML = `‚úç Nota Flash`;
                    }
                    
                    // Mostra a barra
                    toolbar.style.display = 'flex';
                    
                    // Em mobile, garante que fica no fundo (CSS j√° trata disto, mas refor√ßamos)
                    if (window.innerWidth <= 768) {
                        toolbar.style.opacity = '1';
                    }
                }
            }
        }
    }, 100);
});


// Adicione esta fun√ß√£o auxiliar
function normalizeSelectionText(text) {
    if (!text) return "";
    // Substitui quebras de linha e m√∫ltiplos espa√ßos por um espa√ßo simples
    return text.replace(/[\n\r]+/g, ' ').replace(/\s+/g, ' ').trim();
}

// ATUALIZE o listener 'touchend' que cri√°mos anteriormente:
document.addEventListener('touchend', () => {
    setTimeout(() => {
        const selection = window.getSelection();
        
        if (selection && !selection.isCollapsed) {
            const rawText = selection.toString();
            
            // 1. NORMALIZA√á√ÉO CR√çTICA PARA MULTI-VERS√çCULOS
            // Isto une "Verso 4" + "Verso 5" num √∫nico fio de texto limpo
            currentSelectionText = normalizeSelectionText(rawText);
            
            const range = selection.getRangeAt(0);
            identifyVersesInSelection(range);

            const toolbar = document.getElementById('selection-toolbar');
            const btnNote = document.getElementById('btn-note-selection');

            if (toolbar) {
                if (currentSelectionVerses.length > 1 && btnNote) {
                    // Feedback visual: Mostra que apanhou v√°rios
                    btnNote.innerHTML = `‚úç Nota (${currentSelectionVerses.length} vs)`;
                } else if (btnNote) {
                    btnNote.innerHTML = `‚úç Nota Flash`;
                }
                
                // Posi√ß√£o para mobile (Fundo do ecr√£)
                if (window.innerWidth <= 768) {
                     toolbar.style.display = 'flex'; // Flex para alinhar bot√µes
                }
            }
        }
    }, 100);
});

// --- GEST√ÉO DE URL (DEEP LINKING) ---

// Atualizar o URL
function updateUrlParams(bookName, chapter, verse, replace = false) {
    const url = new URL(window.location);
    
    // Limpar par√¢metros antigos
    url.searchParams.delete('b');
    url.searchParams.delete('c');
    url.searchParams.delete('v');

    if (bookName) url.searchParams.set('b', bookName);
    if (chapter) url.searchParams.set('c', chapter);
    if (verse) url.searchParams.set('v', verse);

    const state = { book: bookName, chapter: chapter, verse: verse };

    // SE for scroll (replace=true), substitui o URL atual (n√£o cria hist√≥rico)
    // SE for navega√ß√£o (replace=false), cria novo hist√≥rico
    if (replace) {
        window.history.replaceState(state, '', url);
    } else {
        window.history.pushState(state, '', url);
    }
}

// 2. Ler o URL e abrir o local correto (Chamado ao iniciar)
async function loadStateFromUrl() {

    const params = new URLSearchParams(window.location.search);
    
    // 1. Ler par√¢metros do URL
    let bParam = params.get('b'); // Livro
    const cParam = params.get('c'); // Cap√≠tulo
    const vParam = params.get('v'); // Vers√≠culo

    // Se n√£o houver livro no URL, n√£o faz nada (fica na Home)
    if (!bParam) return;

    // 2. Decodificar o nome (transforma "1%20Reis" em "1 Reis")
    bParam = decodeURIComponent(bParam);

    // 3. Normalizar para comparar (remove acentos e p√µe min√∫sculas)
    // Ex: "G√©nesis" vira "genesis" para comparar com a base de dados
    const searchName = normalizeStr(bParam);

    // 4. Encontrar o Livro na Base de Dados (BIBLE_DATA)
    const foundBook = BIBLE_DATA.find(b => 
        normalizeStr(b.nome) === searchName || 
        normalizeStr(b.abrev) === searchName
    );

    if (foundBook) {
        selectedBook = foundBook;
        
        if (cParam) {
            const chapter = parseInt(cParam);
            
            // A. Abre o Cap√≠tulo e ESPERA (await) que o texto e as notas carreguem
            await openVerses(chapter);
            
            // B. Se houver vers√≠culo no URL, faz o scroll para ele
            if (vParam) {
                const verse = parseInt(vParam);
                // Usa a nova fun√ß√£o de scroll seguro
                scrollToVerse(verse);
            }
        } else {
            // Se o URL s√≥ tiver o livro (?b=G√©nesis), abre a lista de cap√≠tulos
            openChapters(foundBook);
        }
    } else {
        console.warn("‚õî Livro do URL n√£o encontrado:", bParam);
if (typeof updateUrlParams === 'function') {
            updateUrlParams(null, null, null);
        }
    }
}

// 3. Lidar com o bot√£o "Voltar" do navegador
window.onpopstate = function(event) {
    // Quando o utilizador clica na seta de voltar do browser, recarregamos o estado
    if (event.state) {
        // Se houver estado, tentamos restaurar (simplificado: recarrega a vista URL)
        loadStateFromUrl();
    } else {
        // Se voltou ao in√≠cio
        selectedBook = null;
        updateUI('books');
    }
};

function setupScrollObserver() {
    // Se j√° existir um observador, desliga-o para n√£o duplicar
    if (verseObserver) verseObserver.disconnect();

    // Configura√ß√µes: O 'rootMargin' define uma linha imagin√°ria a 30% do topo do ecr√£
    // Quando um vers√≠culo cruza essa linha, o URL atualiza.
    const options = {
        root: document.querySelector('.container'), // O elemento que faz scroll
        rootMargin: '-30% 0px -70% 0px', 
        threshold: 0
    };

    verseObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // O vers√≠culo entrou na "zona de leitura"
                const verseNum = entry.target.getAttribute('data-vnum');
                
                if (selectedBook && selectedChapter && verseNum) {
                    // Atualiza o URL silenciosamente (replace = true)
                    updateUrlParams(selectedBook.nome, selectedChapter, verseNum, true);
                }
            }
        });
    }, options);

    // Manda o observador vigiar todos os vers√≠culos
    document.querySelectorAll('.verse-item').forEach(item => {
        verseObserver.observe(item);
    });
}

// Fun√ß√£o para abrir o alerta personalizado
window.showCustomAlert = (msg) => {
    document.getElementById('custom-alert-msg').innerText = msg;
    document.getElementById('custom-alert-modal').style.display = 'flex';
};

// Remove acentos e p√µe tudo em min√∫sculas para comparar (Ex: "G√©nesis" vira "genesis")
function normalizeStr(str) {
    if (!str) return "";
    return str.toLowerCase()
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .trim();
}

// Fun√ß√£o auxiliar para fazer scroll suave e destacar o vers√≠culo
function scrollToVerse(verseNum) {
    // Tenta encontrar o elemento (d√° algumas tentativas caso o DOM esteja lento)
    let attempts = 0;
    
    const tryScroll = setInterval(() => {
        attempts++;
        
        // Procura pelo n√∫mero ou pelo texto do vers√≠culo
        const targetEl = document.getElementById(`vnum-${verseNum}`) || document.getElementById(`vtext-${verseNum}`);
        
        if (targetEl) {
            clearInterval(tryScroll); // Parar de procurar
            
            
            // 1. Scroll suave para o centro do ecr√£
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 2. Efeito visual de destaque (Flash Laranja)
            const row = targetEl.closest('.verse-item');
            if (row) {
                row.style.transition = "background-color 0.5s ease";
                row.style.backgroundColor = "rgba(230, 126, 34, 0.4)"; // Laranja transparente
                
                // Remove o destaque ap√≥s 1.5 segundos
                setTimeout(() => {
                    row.style.backgroundColor = "transparent";
                }, 1500);
            }
        } else if (attempts > 20) {
            // Se tentar 20 vezes (aprox 2 segundos) e n√£o achar, desiste
            clearInterval(tryScroll);
        }
    }, 100); // Tenta a cada 100ms
}

window.removeCodexRow = async function(btn) {
    const row = btn.closest('.codex-row');
    // Verifica se tem ID do Firestore (caso seja uma linha j√° salva num documento)
    const firestoreId = row.getAttribute('data-firestore-id');
    const confirmModal = document.getElementById('confirm-modal');

    // --- CORRE√á√ÉO DE SOBREPOSI√á√ÉO (Z-INDEX) ---
    if (confirmModal) {
        // Move o modal para o final do body para garantir que ganha a guerra de Z-Index
        document.body.appendChild(confirmModal);
        // Define o valor m√°ximo permitido pelos navegadores (Max 32-bit Integer)
        confirmModal.style.setProperty('z-index', '2147483647', 'important');
    }

    const confirmed = await showConfirmation(
        "Eliminar Refer√™ncia?", 
        "Deseja remover esta linha do Codex? Esta a√ß√£o √© permanente."
    );

    // Se o modal existir, limpamos o z-index manual para n√£o afetar outros usos
    if (confirmModal) {
        // Ocultar via style.display √© feito dentro do showConfirmation, 
        // mas aqui resetamos a prioridade
        confirmModal.style.zIndex = "";
    }

    if (confirmed) {
        // 1. ELIMINA√á√ÉO NO FIREBASE (Se tiver ID associado)
        if (firestoreId) {
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await deleteDoc(doc(db, 'codex', firestoreId));
            } catch (e) {
                console.error("‚ùå Erro ao apagar no Firebase:", e);
                alert("Erro ao apagar no servidor.");
                return; 
            }
        }

        // 2. ELIMINA√á√ÉO NO ECR√É (Anima√ß√£o de sa√≠da)
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(30px)';
        
        setTimeout(() => {
            row.remove();
            // Se estiver numa nota normal, tenta gravar o estado
            if (typeof saveNote === 'function') saveNote(true); 
        }, 300);
    }
};

// 1. Fun√ß√£o Auxiliar para extrair dados JSON do HTML da nota (Snippet)
window.extractBoxLinksFromSnippet = function(snippetHtml) {
    if (!snippetHtml) return null;
    
    let content = snippetHtml;
    try {
        // Verifica se √© uma string codificada antes de tentar
        if (typeof snippetHtml === 'string' && snippetHtml.includes('%')) {
            content = decodeURIComponent(snippetHtml);
        }
    } catch (e) { 
        console.warn("‚ö†Ô∏è extractBoxLinks: Erro de decodifica√ß√£o, tentando processar original.");
        content = snippetHtml; 
    }
    try {
        if (content.includes('%3C') || content.includes('%7B')) {
            content = decodeURIComponent(content);
        }
    } catch (e) { }

    // --- MUDAN√áA: USAR DOMPARSER EM VEZ DE REGEX ---
    // A Regex falha quando o JSON tem objetos aninhados (como o Codex que tem {})
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(content, 'text/html');
        
        // Procura o elemento wrapper que guarda os dados
        const wrapper = doc.querySelector('[data-box-links]');
        
        if (wrapper) {
            const rawLinks = wrapper.getAttribute('data-box-links');
            if (rawLinks && rawLinks !== "null" && rawLinks !== "{}") {
                const data = JSON.parse(rawLinks);
                
                // Verifica se tem conte√∫do real
                const hasUrls = data.urls && Object.keys(data.urls).length > 0;
                const hasCodex = data.codex && Array.isArray(data.codex) && data.codex.length > 0;

                if (hasUrls || hasCodex) {
                    return data; 
                }
            }
        }
    } catch (e) {
        console.warn("Erro ao extrair links:", e);
    }
    return null;
};

// 2. Fun√ß√£o para Abrir o Modal de Visualiza√ß√£o
window.viewCardSources = function(encodedJson) {
    const data = JSON.parse(decodeURIComponent(encodedJson));
    const modal = document.getElementById('view-sources-modal');
    const content = document.getElementById('view-sources-content');
    
    document.body.appendChild(modal); // Garante z-index correto
    modal.style.display = 'flex';
    content.innerHTML = '';

    let hasContent = false;

    // --- SEC√á√ÉO LINKS (URLs) ---
    if (data.urls && Object.keys(data.urls).length > 0) {
        hasContent = true;
        content.innerHTML += `<div class="source-section-header">üåê Links Web</div>`;
        
        Object.values(data.urls).forEach(url => {
            let domain = url;
            try { domain = new URL(url).hostname.replace('www.',''); } catch(e){}
            
            content.innerHTML += `
                <div class="source-view-item" style="border-left-color: #3498db;">
                    <a href="${url}" target="_blank">üîó ${domain}</a>
                    <div style="font-size:0.8em; color:#888; margin-top:2px;">${url}</div>
                </div>`;
        });
    }

    // --- SEC√á√ÉO CODEX ---
    if (data.codex && data.codex.length > 0) {
        hasContent = true;
        content.innerHTML += `<div class="source-section-header">üìö Codex</div>`;
        
        data.codex.forEach(c => {
            const displayTitle = c.codiceshow || `${c.serie} ${c.capitulo ? 'cap.'+c.capitulo : ''}`;
            content.innerHTML += `
                <div class="source-view-item" style="border-left-color: #e67e22;">
                    <strong>${displayTitle}</strong>
                    ${c.paginas && c.paginas.length ? `<div style="font-size:0.8em; color:#ccc;">P√°g: ${c.paginas.join(', ')}</div>` : ''}
                    ${c.paragrafos && c.paragrafos.length ? `<div style="font-size:0.8em; color:#ccc;">Par: ${c.paragrafos.join(', ')}</div>` : ''}
                </div>`;
        });
    }

    if (!hasContent) {
        content.innerHTML = '<p style="text-align:center; color:#888;">Erro: Dados vazios.</p>';
    }
};

// 2. Fun√ß√£o para Abrir o Modal de Visualiza√ß√£o
window.viewCardSources = function(encodedJson) {
    const data = JSON.parse(decodeURIComponent(encodedJson));
    const modal = document.getElementById('view-sources-modal');
    const content = document.getElementById('view-sources-content');
    
    // For√ßa hierarquia visual
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    content.innerHTML = '';

    let hasContent = false;

    // --- SEC√á√ÉO LINKS (URLs) ---
    if (data.urls && Object.keys(data.urls).length > 0) {
        hasContent = true;
        content.innerHTML += `<div class="source-section-header">üåê Links Web</div>`;
        
        Object.values(data.urls).forEach(url => {
            let domain = url;
            try { domain = new URL(url).hostname.replace('www.',''); } catch(e){}
            
            content.innerHTML += `
                <div class="source-view-item" style="border-left-color: #3498db;">
                    <a href="${url}" target="_blank">üîó ${domain}</a>
                    <div style="font-size:0.8em; color:#888; margin-top:2px;">${url}</div>
                </div>`;
        });
    }

    // --- SEC√á√ÉO CODEX (Bibliogafia) ---
    if (data.codex && data.codex.length > 0) {
        hasContent = true;
        content.innerHTML += `<div class="source-section-header">üìö Codex (Publica√ß√µes)</div>`;
        
        data.codex.forEach(c => {
            // Usa o campo formatado 'codiceshow' ou constr√≥i um fallback
            const displayTitle = c.codiceshow || `${c.serie} ${c.capitulo ? 'cap.'+c.capitulo : ''}`;
            
            content.innerHTML += `
                <div class="source-view-item" style="border-left-color: #e67e22;">
                    <strong>${displayTitle}</strong>
                    ${c.paginas && c.paginas.length ? `<div style="font-size:0.8em; color:#ccc;">P√°g: ${c.paginas.join(', ')}</div>` : ''}
                    ${c.paragrafos && c.paragrafos.length ? `<div style="font-size:0.8em; color:#ccc;">Par: ${c.paragrafos.join(', ')}</div>` : ''}
                </div>`;
        });
    }

    // [REMOVIDO] O bloco que mostrava "Categorias Vinculadas" foi apagado aqui.

    if (!hasContent) {
        content.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Nenhuma fonte encontrada (apenas Categorias ocultas).</p>';
    }
};

  // Converte "1 Jo√£o" para "1_joao"
function getBibleFilename(bookName) {
    return bookName.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos
        .trim()
        .replace(/\s+/g, "_"); // Substitui espa√ßos por _
}

// --- GEST√ÉO DE CATEGORIAS (SISTEMA IGUAL AO NOTE.HTML) ---

window.searchFlashCategories = async function(queryText) {
    const resultsContainer = document.getElementById('flash-cat-results');
    const isBibleSearch = document.getElementById('flash-bible-toggle')?.checked;
    
    if (!resultsContainer) return;

    const term = queryText.trim().toLowerCase();
    
    // Limpa se o texto for curto
    if (term.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }

    resultsContainer.innerHTML = '<div style="padding:10px; color:#888; font-size:0.8rem;">A pesquisar...</div>';
    
    let resultsArray = [];

    if (isBibleSearch) {
        // --- MODO B√çBLIA (Biblioteca Global usando BIBLE_DATA) ---
        const termParts = term.split(' ');
        const matchedBooks = BIBLE_DATA.filter(book => 
            normalizeStr(book.nome).includes(normalizeStr(termParts[0]))
        );

        matchedBooks.forEach(book => {
            for (let c = 1; c <= book.caps; c++) {
                const totalVerses = book.versiculos[c - 1];
                for (let v = 1; v <= totalVerses; v++) {
                    const fullRef = `${book.nome} ${c}:${v}`;
                    const normRef = normalizeStr(fullRef);
                    
                    if (normRef.includes(term)) {
                        // Verifica se j√° foi adicionado para evitar duplicados na lista
                        const isAdded = currentFlashLinks.categories?.some(cat => cat.name === fullRef);
                        if (!isAdded) {
                            resultsArray.push({ 
                                id: fullRef.replace(/ /g, '_').replace(/:/g, '_'), 
                                name: fullRef, 
                                type: 'bible_public' 
                            });
                        }
                    }
                }
            }
        });
        // Ordena√ß√£o Natural (Ex: 1:2 antes de 1:10)
        resultsArray.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
        
    } else {
        // --- MODO T√ìPICOS PESSOAIS (Firebase) ---
        try {
            const { collection, query, where, getDocs, limit, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Primeira letra Mai√∫scula (padr√£o NotaBook)
            const searchCap = queryText.charAt(0).toUpperCase() + queryText.slice(1);
            
            const q = query(
                collection(db, "topicos"),
                where("userId", "==", currentUser.uid),
                where("nome", ">=", searchCap),
                where("nome", "<=", searchCap + '\uf8ff'),
                limit(15)
            );
            
            const snap = await getDocs(q);
            snap.forEach(doc => {
                const isAdded = currentFlashLinks.categories?.some(cat => cat.id === doc.id);
                if (!isAdded) {
                    resultsArray.push({ id: doc.id, name: doc.data().nome, type: 'topic' });
                }
            });
        } catch(e) { console.error("Erro busca categorias:", e); }
    }

    // RENDERIZA√á√ÉO DOS RESULTADOS
    resultsContainer.innerHTML = '';
    
    if (resultsArray.length === 0) {
        resultsContainer.innerHTML = '<div style="padding:15px; color:#666; font-style:italic;">Sem resultados.</div>';
        return;
    }

    resultsArray.slice(0, 40).forEach(res => {
        const div = document.createElement('div');
        div.style.cssText = `
            padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03);
            display: flex; align-items: center; justify-content: space-between; transition: 0.2s;
        `;

        let icon = res.type === 'bible_public' ? "üåç" : "üè∑Ô∏è";
        let typeLabel = res.type === 'bible_public' ? "B√çBLIA" : "T√ìPICO";
        let color = res.type === 'bible_public' ? "#2ecc71" : "#e67e22";

        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:1.2em;">${icon}</span>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:0.6rem; color:${color}; font-weight:bold; letter-spacing:1px;">${typeLabel}</span>
                    <span style="color:white; font-size:0.9rem;">${res.name}</span>
                </div>
            </div>
            <span style="font-weight:bold; color:#555; font-size:1.2rem;">+</span>
        `;

        div.onclick = () => {
            if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
            currentFlashLinks.categories.push(res);
            
            window.renderFlashCategoryChips(); // Atualiza p√≠lulas no topo
            window.searchFlashCategories(queryText); // Refresh lista
        };

        resultsContainer.appendChild(div);
    });
};

window.renderFlashCategoryChips = function() {
    const container = document.getElementById('flash-cat-selected');
    if (!container) return;

    container.innerHTML = '';
    const cats = currentFlashLinks.categories || [];

    if (cats.length === 0) {
        container.innerHTML = '<span style="color:#555; font-size:0.8rem; font-style:italic;">Nenhuma selecionada.</span>';
        return;
    }

    cats.forEach(cat => {
        const chip = document.createElement('div');
        
        // Cores baseadas no tipo
        let color = cat.type === 'bible_public' ? "rgba(46, 204, 113, 0.15)" : "rgba(230, 126, 34, 0.15)";
        let border = cat.type === 'bible_public' ? "#2ecc71" : "#e67e22";

        chip.style.cssText = `
            background: ${color}; color: white; padding: 4px 12px; border-radius: 20px;
            font-size: 0.8rem; display: flex; align-items: center; gap: 8px;
            border: 1px solid ${border}; white-space: nowrap; cursor: pointer;
            transition: 0.2s;
        `;
        
        chip.innerHTML = `<span>${cat.name}</span> <span style="font-weight:bold; opacity:0.6;">√ó</span>`;
        
        chip.onclick = () => {
            // Filtra o array removendo o item (pelo ID se for t√≥pico, pelo Nome se for B√≠blia)
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => 
                (cat.type === 'topic') ? c.id !== cat.id : c.name !== cat.name
            );
            window.renderFlashCategoryChips();
            
            // Opcional: Atualiza a lista de pesquisa se o user estiver a pesquisar
            const searchVal = document.getElementById('flash-cat-search').value;
            if (searchVal) window.searchFlashCategories(searchVal);
        };
        
        container.appendChild(chip);
    });
};

window.getFlashCodexData = (row) => {
    const serie = row.querySelector('.serie-main').value.trim();
    if (!serie) return null;

    return {
        serie: serie,
        paginas: Array.from(row.querySelectorAll('.pages-container input')).map(i => i.value.trim()).filter(v => v),
        paragrafos: Array.from(row.querySelectorAll('.paragraphs-container input')).map(i => i.value.trim()).filter(v => v),
        manualYear: row.querySelector('.manual-year')?.value || null,
        manualMonth: row.querySelector('.manual-month')?.value || null,
        capitulo: row.querySelector('.manual-chapter')?.value || null,
        tempo: row.querySelector('.manual-time')?.value || null,
        type: 'codex'
    };
};

// Abrir Modal de Foco
window.openFocusModal = () => {
    const typeSelect = document.getElementById('flash-type-select');
    const editModal = document.getElementById('edit-card-modal');
    
    let currentType = 'default';

    // Se estiver no modal de edi√ß√£o, o tipo √© fixo (baseado na classe ou borda)
    if (editModal && editModal.style.display === 'flex') {
        const editEditor = document.getElementById('edit-card-content');
        if (editEditor.style.borderColor === 'rgb(46, 204, 113)' || editEditor.style.borderColor === '#2ecc71') {
            currentType = 'question';
        }
    } else {
        // No modo cria√ß√£o, l√™ SEMPRE o valor atual do dropdown
        currentType = typeSelect.value;
    }

    const list = document.getElementById('flash-focus-list');
    const options = FLASH_FOCUS_OPTIONS[currentType] || [];
    
    list.innerHTML = '';
    
    // Renderizar op√ß√£o "Padr√£o"
    const noneDiv = document.createElement('div');
    noneDiv.className = `focus-mode-item ${!currentFlashFocus ? 'active' : ''}`;
    noneDiv.innerHTML = `
        <div class="focus-preview-dot" style="border:1px dashed #666; background:none;"></div>
        <span class="focus-label">Padr√£o</span>
        ${!currentFlashFocus ? '<span class="focus-check">‚úì</span>' : ''}
    `;
    noneDiv.onclick = () => window.applyFlashFocus(null);
    list.appendChild(noneDiv);

    // Renderizar op√ß√µes din√¢micas conforme o tipo selecionado no dropdown
    options.forEach(opt => {
        const div = document.createElement('div');
        const isSelected = currentFlashFocus === opt.id;
        div.className = `focus-mode-item ${isSelected ? 'active' : ''}`;
        
        div.innerHTML = `
            <div class="focus-preview-dot" style="background-color: ${opt.color}"></div>
            <span class="focus-label">${opt.name}</span>
            ${isSelected ? '<span class="focus-check">‚úì</span>' : ''}
        `;
        div.onclick = () => window.applyFlashFocus(opt);
        list.appendChild(div);
    });

    document.getElementById('flash-focus-modal').style.display = 'flex';
};

// Aplicar Foco Selecionado
window.applyFlashFocus = (opt) => {
    const modal = document.getElementById('flash-focus-modal');
    const flashModal = document.getElementById('flash-note-modal');
    const editModal = document.getElementById('edit-card-modal');
    
    // Identificar qual editor deve receber a cor
    let editorParaPintar = null;

    // Se o modal de EDI√á√ÉO estiver vis√≠vel, ele tem prioridade absoluta
    if (editModal && editModal.style.display !== 'none') {
        editorParaPintar = document.getElementById('edit-card-content');
    } 
    // Caso contr√°rio, se for o de cria√ß√£o
    else if (flashModal && flashModal.style.display !== 'none') {
        editorParaPintar = document.getElementById('flash-editor');
    }

    if (editorParaPintar) {
        if (!opt) {
            // Se escolher "Padr√£o" (sem foco)
            currentFlashFocus = null;
            // Verifica se √© modo quest√£o (verde) ou subnota (azul) para repor a cor base
            const isQuestion = editorParaPintar.classList.contains('question-mode') || 
                               (document.getElementById('flash-type-select')?.value === 'question');
            
            editorParaPintar.style.borderColor = isQuestion ? '#2ecc71' : '#3498db';
        } else {
            // APLICAR A COR DO FOCO SELECIONADO
            currentFlashFocus = opt.id;
            editorParaPintar.style.borderColor = opt.color;
            // For√ßar a espessura da borda para garantir que se v√™
            editorParaPintar.style.borderWidth = "2px";
            editorParaPintar.style.borderStyle = "solid";
        }
    }

    // Atualizar o √≠cone do bot√£o üé® no modal que estiver ativo
    const btn = (editModal && editModal.style.display !== 'none') 
                ? document.getElementById('btn-edit-focus') 
                : document.getElementById('btn-flash-focus');
                
    if (btn) btn.style.color = opt ? opt.color : "";

    // Fechar o popup de focos
    modal.style.display = 'none';
};

// Ouvinte global corrigido para os bot√µes de Foco
document.addEventListener('click', (e) => {
    const btn = e.target.closest('#btn-flash-focus, #btn-edit-focus');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        window.openFocusModal();
    }
});

// Monitorar mudan√ßa no dropdown de tipo (Quest√£o / Subnota)
const typeSelect = document.getElementById('flash-type-select');
if (typeSelect) {
    typeSelect.addEventListener('change', () => {
        const newType = typeSelect.value; // 'default' ou 'question'
        const editor = document.getElementById('flash-editor');
        const focusBtn = document.getElementById('btn-flash-focus');

        // 1. O PONTO CHAVE: Resetar obrigatoriamente para "Padr√£o"
        currentFlashFocus = null; 

        // 2. Reset visual do bot√£o üé® (volta √† cor neutra/padr√£o)
        if (focusBtn) {
            focusBtn.style.color = ""; 
            focusBtn.style.borderColor = "";
        }

        // 3. Reset da cor da borda do editor para a cor base do novo tipo
        if (editor) {
            // Se mudou para Quest√£o -> Verde. Se mudou para Subnota -> Azul.
            editor.style.borderColor = (newType === 'question') ? '#2ecc71' : '#3498db';
            editor.style.boxShadow = ""; // Remove brilhos de focos anteriores
        }

        // 4. Se o popup de Foco estiver aberto, ele atualiza a lista na hora
        // Agora o item "Padr√£o" aparecer√° com o check ‚úì
        const focusModal = document.getElementById('flash-focus-modal');
        if (focusModal && focusModal.style.display === 'flex') {
            window.openFocusModal();
        }
    });
}


// --- L√ìGICA DO MOTOR DE BUSCA ---
const searchInput = document.getElementById('bible-search-input');
const scopeToggle = document.getElementById('search-scope-toggle');
const scopeContainer = document.getElementById('scope-toggle-container');
const resultsDiv = document.getElementById('bible-search-results');
const countSpan = document.getElementById('search-count');

let searchTimeout;
searchInput.oninput = () => {
    const query = searchInput.value.trim();
    
    // 1. Detetar termos entre aspas: "termo1" "termo2"
    // Esta regex captura apenas o que est√° dentro das aspas
    const matches = query.match(/"([^"]+)"/g);
    
    // 2. S√≥ mostra a barra de √¢mbito se houver 2 ou mais termos entre aspas
    if (matches && matches.length >= 2) {
        scopeContainer.style.display = 'flex';
    } else {
        scopeContainer.style.display = 'none';
        scopeToggle.checked = false; // Reset para Vers√≠culo se a barra sumir
        updateScopeLabels(); 
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(executeBibleSearch, 500);
};

// Fun√ß√£o auxiliar para atualizar as cores das labels (Vers√≠culo/Cap√≠tulo)
function updateScopeLabels() {
    const isChapter = scopeToggle.checked;
    document.getElementById('label-verse').style.color = isChapter ? "#666" : "var(--accent-color)";
    document.getElementById('label-chapter').style.color = isChapter ? "var(--accent-color)" : "#666";
}

scopeToggle.onchange = () => {
    updateScopeLabels();
    if (searchInput.value.length > 2) executeBibleSearch();
};


function renderSearchResult(book, cap, verse, text, highlights = [], isChapterSummary = false) {
    const ref = verse ? `${book} ${cap}:${verse}` : `${book} ${cap}`;
    let displayContent = text;

    // Se n√£o for resumo de cap√≠tulo, aplicamos o destaque visual (mark) no texto do vers√≠culo
    if (!isChapterSummary) {
        highlights.forEach(term => {
            const regex = new RegExp(`(${term})`, "gi");
            displayContent = displayContent.replace(regex, '<mark style="background:rgba(230,126,34,0.4); color:white; border-radius:2px; padding:0 2px;">$1</mark>');
        });
    }

    return `
        <div class="bk-verse-item" onclick="goToSearchRef('${book}', ${cap}, ${verse || 1})" 
             style="border-bottom: 1px solid #333; padding: 12px; cursor: pointer; transition: background 0.2s;">
            <div style="color: var(--accent-color); font-weight: bold; font-size: 0.9rem; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">${isChapterSummary ? 'üìñ' : 'üìú'}</span> ${ref}
            </div>
            <div style="color: #bbb; font-size: 0.85rem; line-height: 1.5; padding-left: 25px;">
                ${isChapterSummary ? `<div style="color: #888; margin-bottom: 4px; font-style: italic;">Termos encontrados:</div>${displayContent}` : displayContent}
            </div>
        </div>
    `;
}

window.goToSearchRef = async (bookName, chapter, verse) => {
    document.getElementById('bible-search-modal').style.display = 'none';
    const fullRef = `${bookName} ${chapter}:${verse}`;
    // Reutiliza a sua fun√ß√£o de navega√ß√£o existente
    if (typeof navigateToBibleVerse === 'function') {
        navigateToBibleVerse(fullRef);
    }
};

function setupSearchListeners() {
    const openBtn = document.getElementById('open-search-btn');
    if (openBtn) {
        openBtn.onclick = () => {
            const modal = document.getElementById('bible-search-modal');
            if (modal) {
                modal.style.display = 'flex';
                renderSearchBookFilters(); 
                const input = document.getElementById('bible-search-input');
                if (input) input.focus();
            }
        };
    }
}

// Chame a fun√ß√£o de injetar e depois a de configurar
function injectSearchButton() {
    const anchorBtn = document.getElementById('bible-anchors-btn');
    if (anchorBtn && !document.getElementById('open-search-btn')) {
        const btn = document.createElement('button');
        btn.id = 'open-search-btn';
        btn.innerHTML = 'üîç';
        btn.title = 'Pesquisar na B√≠blia';
        btn.style.cssText = `background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; margin-right: 5px;`;
        anchorBtn.parentNode.insertBefore(btn, anchorBtn);
        
        // Configura o clique imediatamente ap√≥s injetar
        setupSearchListeners();
    }
}
setTimeout(injectSearchButton, 800);


// 3. Fun√ß√£o de Pesquisa (COM PROTE√á√ÉO CONTRA NULL)
async function executeBibleSearch(shouldUpdateBookChips = true) {
    const input = document.getElementById('bible-search-input');
    const resultsDiv = document.getElementById('bible-search-results');
    const countSpan = document.getElementById('search-count');

    if (!input || !resultsDiv) return;

    const rawQuery = input.value.trim().toLowerCase();
    if (rawQuery.length < 3) return;

    console.log("üîç Pesquisando por:", rawQuery);
    console.log("üìÇ Filtro atual:", searchFilterTestament);

    allSearchResults = [];
    if (shouldUpdateBookChips) booksWithHits.clear();
    
    resultsDiv.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div><p>A procurar...</p></div>';

    try {
        for (const book of BIBLE_DATA) {
            // Valida√ß√£o de Testamento
            if (searchFilterTestament === 'at' && book.id >= 40) continue;
            if (searchFilterTestament === 'nt' && book.id <= 39) continue;
            
            // Filtro de Livro selecionado
            if (searchSelectedBook && book.nome !== searchSelectedBook) continue;

            const filename = getBibleFilename(book.nome);
            
            // Tentar carregar o ficheiro
            if (!localBibleCache[filename]) {
                const response = await fetch(`./js/bible/${filename}.json`);
                if (!response.ok) {
                    console.error(`‚ùå N√£o foi poss√≠vel carregar: ${filename}.json`);
                    continue;
                }
                localBibleCache[filename] = await response.json();
            }

            const bookContent = localBibleCache[filename][book.nome];
            let bookHasMatch = false;

            for (const capNum in bookContent) {
                const chapter = bookContent[capNum];
                for (const vNum in chapter) {
                    const verseText = chapter[vNum].toLowerCase();
                    
                    if (verseText.includes(rawQuery)) {
                        bookHasMatch = true;
                        allSearchResults.push({
                            book: book.nome,
                            cap: capNum,
                            verse: vNum,
                            text: chapter[vNum],
                            isChapter: false
                        });
                    }
                }
            }

            if (bookHasMatch && shouldUpdateBookChips) {
                booksWithHits.add(book.nome);
            }
        }

        console.log(`‚úÖ Pesquisa terminada. Encontrados: ${allSearchResults.length} resultados.`);
        
        // Renderizar
        renderNextSearchPage(true); 
        if (shouldUpdateBookChips) renderSearchBookFilters();

    } catch (e) {
        console.error("‚ùå Erro fatal na pesquisa:", e);
        resultsDiv.innerHTML = '<p style="color:red; text-align:center;">Erro ao processar pesquisa.</p>';
    }
}

// Inicia o processo
setTimeout(initializeBibleSearch, 1000);

function renderSearchBookFilters() {
    // 1. Localizar o contentor onde os livros ser√£o desenhados
    const container = document.getElementById('search-books-filter');
    if (!container) return; // Se o modal n√£o estiver aberto, sai para evitar erros

    // 2. Obter o texto atual da pesquisa
    const searchInput = document.getElementById('bible-search-input');
    const query = searchInput ? searchInput.value.trim() : "";
    
    // Limpar o conte√∫do anterior
    container.innerHTML = '';

    // 3. FILTRO 1: Por Testamento (Baseado na vari√°vel global 'searchFilterTestament')
    let booksToShow = BIBLE_DATA.filter(book => {
        if (searchFilterTestament === 'at') return book.id <= 39; // Antigo Testamento (G√©nesis a Malaquias)
        if (searchFilterTestament === 'nt') return book.id >= 40; // Novo Testamento (Mateus a Apocalipse)
        return true; // Todos
    });

    // 4. FILTRO 2: Por Resultados da Pesquisa
    // Se o utilizador j√° pesquisou algo (> 2 letras) e temos resultados ('booksWithHits'),
    // mostramos APENAS os livros que cont√™m a palavra pesquisada.
    if (query.length >= 3 && booksWithHits.size > 0) {
        booksToShow = booksToShow.filter(book => booksWithHits.has(book.nome));
    }

    // 5. Verificar se sobraram livros para mostrar
    if (booksToShow.length === 0) {
        // Se estiver vazio (ex: pesquisou "xpto" e n√£o existe), mostra aviso
        if (query.length >= 3) {
            container.innerHTML = '<span style="color:#555; font-size:0.75rem; padding:5px;">Nenhum livro com resultados.</span>';
        } else {
            // Se for apenas filtro de Testamento vazio (raro)
            container.innerHTML = '<span style="color:#555; font-size:0.75rem; padding:5px;">Nenhum livro dispon√≠vel.</span>';
        }
        return;
    }

    // 6. DESENHAR OS BOT√ïES (CHIPS)
    booksToShow.forEach(book => {
        const chip = document.createElement('div');
        
        // Define as classes CSS:
        // 'book-chip': Estilo base
        // 'active': Se este livro for o selecionado (searchSelectedBook), fica Laranja
        chip.className = `book-chip ${searchSelectedBook === book.nome ? 'active' : ''}`;
        
        // Texto do bot√£o (Abreviatura, ex: "G√©n")
        chip.innerText = book.abrev;
        // Tooltip (Nome completo ao passar o rato)
        chip.title = book.nome;

        // 7. EVENTO DE CLIQUE
        chip.onclick = () => {
            // L√≥gica de Toggle (Ligar/Desligar)
            if (searchSelectedBook === book.nome) {
                // Se clicou no livro que j√° estava ativo, desmarca-o
                searchSelectedBook = null;
            } else {
                // Sen√£o, marca este livro como ativo
                searchSelectedBook = book.nome;
            }
            
            // A. Redesenha os filtros para atualizar a cor (Laranja/Cinza)
            renderSearchBookFilters();
            
            // B. Executa a pesquisa novamente para filtrar a lista de vers√≠culos em baixo
            // Passamos 'false' para dizer √† fun√ß√£o de pesquisa: 
            // "N√£o apagues a lista de livros encontrados (booksWithHits), apenas filtra o que mostras."
            if (typeof executeBibleSearch === 'function') {
                executeBibleSearch(false);
            }
        };

        container.appendChild(chip);
    });
}

// 2. Fun√ß√£o para os bot√µes de Testamento (Todos | AT | NT)
window.setSearchTestament = (type, btnElement) => {
    searchFilterTestament = type;
    searchSelectedBook = null; // Reseta livro selecionado ao mudar testamento

    // Atualiza visual dos bot√µes de filtro principais
    document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
    if (btnElement) btnElement.classList.add('active');

    // Atualiza a lista de livros e refaz a pesquisa
    renderSearchBookFilters();
    
    const input = document.getElementById('bible-search-input');
    if (input && input.value.length >= 3) {
        executeBibleSearch(false);
    }
};

// 2. Fun√ß√£o para os bot√µes de Testamento (Todos | AT | NT)
window.setSearchTestament = (type, btnElement) => {
    searchFilterTestament = type;
    searchSelectedBook = null; // Reseta livro selecionado ao mudar testamento

    // Atualiza visual dos bot√µes de filtro principais
    document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
    if (btnElement) btnElement.classList.add('active');

    // Atualiza a lista de livros e refaz a pesquisa
    renderSearchBookFilters();
    
    const input = document.getElementById('bible-search-input');
    if (input && input.value.length >= 3) {
        executeBibleSearch(false);
    }
};

// 3. Inicializa√ß√£o (Injeta HTML e configura eventos)
function initializeBibleSearch() {
    const container = document.getElementById('search-modal-container');
    if (!container) return;

    // INJE√á√ÉO DO HTML
    container.innerHTML = `
        <div id="bible-search-modal" class="modal-overlay" style="display:none; z-index:10000;">
            <div class="modal-content" style="max-width: 550px; height: 90vh; display: flex; flex-direction: column;">
                
                <div class="modal-header">
                    <h3 style="color:var(--accent-color);">üîç Pesquisar na B√≠blia</h3>
                    <button class="modal-close" id="close-search-modal">√ó</button>
                </div>
                
                <div style="padding: 15px; background: #252528; border-bottom: 1px solid #333;">
                    <!-- Campo de Texto -->
                    <input type="text" id="bible-search-input" placeholder='Ex: "jesus" "pedra"' 
                           style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; border-radius:6px;">
                    
                    <!-- Filtros de Testamento -->
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="filter-chip active" id="filter-btn-all">Todos</button>
                        <button class="filter-chip" id="filter-btn-at">AT</button>
                        <button class="filter-chip" id="filter-btn-nt">NT</button>
                    </div>

                    <!-- Carrossel de Livros (Injetado via JS) -->
                    <div id="search-books-filter"></div>

                    <!-- Toggle de √Çmbito -->
                    <div id="scope-toggle-container" style="display: none; align-items: center; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444;">
                        <span style="font-size: 0.85rem; color: #aaa;">Modo:</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="label-verse" style="font-size: 0.8rem; color: var(--accent-color); font-weight: bold;">VERS√çCULO</span>
                            <label class="setting-switch">
                                <input type="checkbox" id="search-scope-toggle">
                                <span class="slider round"></span>
                            </label>
                            <span id="label-chapter" style="font-size: 0.8rem; color: #666;">CAP√çTULO</span>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div id="bible-search-results" style="flex: 1; overflow-y: auto; padding: 10px; background: #1a1a1d;">
                    <div style="text-align:center; padding:40px; color:#666;">
                        <div style="font-size:2rem;">üìñ</div>
                        Digite para pesquisar...
                    </div>
                </div>

                <!-- Bot√£o Carregar Mais -->
                <div id="search-load-more-container" style="display: none; padding: 15px; text-align: center; background: #111;">
                    <button id="btn-search-load-more" style="background: #333; color: var(--accent-color); border: 1px solid var(--accent-color); padding: 8px 25px; border-radius: 20px; cursor: pointer;">Carregar Mais...</button>
                </div>
                
                <!-- Rodap√© -->
                <div id="search-status-bar" style="padding: 10px; background: #111; border-top: 1px solid #333; font-size: 0.75rem; color: #888;">
                    <span id="search-count">Pronto.</span>
                </div>
            </div>
        </div>`;

    // CONFIGURA√á√ÉO DOS EVENTOS
    
    // 1. Bot√£o Fechar
    document.getElementById('close-search-modal').onclick = () => {
        document.getElementById('bible-search-modal').style.display = 'none';
    };

    // 2. Filtros de Testamento
    document.getElementById('filter-btn-all').onclick = (e) => setSearchTestament('all', e.target);
    document.getElementById('filter-btn-at').onclick = (e) => setSearchTestament('at', e.target);
    document.getElementById('filter-btn-nt').onclick = (e) => setSearchTestament('nt', e.target);

    // 3. Input de Pesquisa
    const input = document.getElementById('bible-search-input');
    input.oninput = () => {
        // Mostra toggle se houver aspas
        const matches = input.value.match(/"([^"]+)"/g);
        const scopeCont = document.getElementById('scope-toggle-container');
        if(scopeCont) scopeCont.style.display = (matches && matches.length >= 2) ? 'flex' : 'none';

        clearTimeout(bibleSearchTimeout);
        bibleSearchTimeout = setTimeout(() => executeBibleSearch(true), 500);
    };

    // 4. Carregar Mais
    document.getElementById('btn-search-load-more').onclick = () => renderNextSearchPage();

    // 5. Toggle de √Çmbito
    const scopeTog = document.getElementById('search-scope-toggle');
    if (scopeTog) {
        scopeTog.onchange = () => {
            const isCap = scopeTog.checked;
            document.getElementById('label-verse').style.color = isCap ? "#666" : "var(--accent-color)";
            document.getElementById('label-chapter').style.color = isCap ? "var(--accent-color)" : "#666";
            if (input.value.length >= 3) executeBibleSearch(true);
        };
    }

    // INJETA O √çCONE DE LUPA NO CABE√áALHO (Se ainda n√£o existir)
    const anchorBtn = document.getElementById('bible-anchors-btn');
    if (anchorBtn && !document.getElementById('open-search-btn')) {
        const btn = document.createElement('button');
        btn.id = 'open-search-btn';
        btn.innerHTML = 'üîç';
        btn.style.cssText = `background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; margin-right: 5px;`;
        anchorBtn.parentNode.insertBefore(btn, anchorBtn);

        btn.onclick = () => {
            const modal = document.getElementById('bible-search-modal');
            modal.style.display = 'flex';
            
            // IMPORTANTE: Renderiza os livros assim que abre!
            renderSearchBookFilters(); 
            
            setTimeout(() => document.getElementById('bible-search-input').focus(), 100);
        };
    }
}

// Inicia ap√≥s 1 segundo
setTimeout(initializeBibleSearch, 1000);

window.setSearchTestament = (type, btnElement) => {
    // Atualiza a vari√°vel global
    searchFilterTestament = type;
    
    // Ao mudar o testamento, limpamos qualquer livro espec√≠fico que estivesse selecionado
    searchSelectedBook = null; 

    // Atualiza visualmente os bot√µes (quem fica laranja)
    const allFilterBtns = document.querySelectorAll('.filter-chip');
    allFilterBtns.forEach(btn => btn.classList.remove('active'));
    btnElement.classList.add('active');

    // Atualiza os Picards (chips dos livros) e a pesquisa
    renderSearchBookFilters();
    if (typeof executeBibleSearch === 'function') {
        executeBibleSearch(true); // 'true' para recalcular os hits de livros
    }
};

// Fun√ß√£o para escapar caracteres especiais em Regex (evita erros se escreveres par√™nteses, etc)
function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// 1. FUN√á√ÉO DE RENDERIZA√á√ÉO (O "Desenhador")
function renderNextSearchPage(isFirstPage = false) {
    const resultsDiv = document.getElementById('bible-search-results');
    const loadMoreContainer = document.getElementById('search-load-more-container');
    const countSpan = document.getElementById('search-count');
    if (!resultsDiv) return;

    if (isFirstPage) {
        resultsDiv.innerHTML = '';
        currentSearchPage = 0;
    }

    const start = currentSearchPage * resultsPerPage;
    const end = start + resultsPerPage;
    const pageItems = allSearchResults.slice(start, end);

    // Estilo for√ßado para o destaque (Amarelo com texto preto)
    const highlightStyle = "background:#f1c40f !important; color:#000 !important; font-weight:bold; border-radius:3px; padding:0 3px; text-decoration:underline;";

    let html = pageItems.map(item => {
        const ref = `${item.book} ${item.cap}:${item.verse}`;
        let text = item.text;

        if (item.termsToHighlight) {
            item.termsToHighlight.forEach(t => {
                const regex = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi");
                text = text.replace(regex, `<mark style="${highlightStyle}">$1</mark>`);
            });
        }

        return `
            <div class="bk-verse-item" onclick="window.goToSearchRef('${item.book}', ${item.cap}, ${item.verse})" 
                 style="border-bottom: 1px solid #333; padding: 15px; cursor: pointer;">
                <div style="color: var(--accent-color); font-weight: bold; font-size: 0.95rem; margin-bottom: 5px;">üìú ${ref}</div>
                <div style="color: #bbb; font-size: 0.9rem; line-height: 1.5; pointer-events: none;">${text}</div>
            </div>`;
    }).join('');

    if (isFirstPage) resultsDiv.innerHTML = html;
    else if (loadMoreContainer) {
        const temp = document.createElement('div'); temp.innerHTML = html;
        while(temp.firstChild) resultsDiv.insertBefore(temp.firstChild, loadMoreContainer);
    }

    currentSearchPage++;
    if (loadMoreContainer) loadMoreContainer.style.display = (allSearchResults.length > (currentSearchPage * resultsPerPage)) ? 'block' : 'none';
    if (countSpan) countSpan.innerText = `${allSearchResults.length} resultados encontrados.`;
}

// 2. FUN√á√ÉO DE PESQUISA (O "Motor")
window.executeBibleSearch = async function(shouldUpdateBookChips = true) {
    const input = document.getElementById('bible-search-input');
    const resultsDiv = document.getElementById('bible-search-results');
    if (!input || !resultsDiv) return;

    const rawQuery = input.value.trim().toLowerCase();
    if (rawQuery.length < 3) return;

    // Reinicia dados
    allSearchResults = [];
    currentSearchPage = 0; 
    if (shouldUpdateBookChips) booksWithHits.clear();
    
    resultsDiv.innerHTML = '<div style="text-align:center; padding:40px;"><p style="color:#888;">A pesquisar...</p></div>';

    // Captura os termos para o destaque (suporta palavras separadas)
    const searchTerms = rawQuery.split(/\s+/).filter(t => t.length >= 2);

    try {
        for (const book of BIBLE_DATA) {
            if (searchFilterTestament === 'at' && book.id >= 40) continue;
            if (searchFilterTestament === 'nt' && book.id <= 39) continue;
            if (searchSelectedBook && book.nome !== searchSelectedBook) continue;

            const filename = getBibleFilename(book.nome);
            if (!localBibleCache[filename]) {
                const resp = await fetch(`./js/bible/${filename}.json`);
                if (resp.ok) localBibleCache[filename] = await resp.json();
                else continue;
            }

            const bookContent = localBibleCache[filename][book.nome];
            let bookHasMatch = false;

            for (const capNum in bookContent) {
                for (const vNum in bookContent[capNum]) {
                    const verseText = bookContent[capNum][vNum].toLowerCase();
                    
                    // Verifica se o vers√≠culo cont√©m todas as palavras
                    const match = searchTerms.every(term => verseText.includes(term));
                    
                    if (match) {
                        bookHasMatch = true;
                        allSearchResults.push({
                            book: book.nome,
                            cap: capNum,
                            verse: vNum,
                            text: bookContent[capNum][vNum],
                            termsToHighlight: searchTerms // <--- CRUCIAL
                        });
                    }
                }
            }
            if (bookHasMatch && shouldUpdateBookChips) booksWithHits.add(book.nome);
        }
        renderNextSearchPage(true); 
        if (shouldUpdateBookChips) renderSearchBookFilters();
    } catch (e) { console.error("Erro:", e); }
};


function resetSearchUI() {
    allSearchResults = [];
    currentSearchPage = 0;
    booksWithHits.clear();
    const resultsDiv = document.getElementById('bible-search-results');
    const countSpan = document.getElementById('search-count');
    const loadMoreContainer = document.getElementById('search-load-more-container');

    if (resultsDiv) {
        resultsDiv.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;"><div style="font-size:2.5rem;">üìñ</div><p>Digite para pesquisar...</p></div>';
    }
    if (countSpan) countSpan.innerText = "Aguardando pesquisa...";
    if (loadMoreContainer) loadMoreContainer.style.display = 'none';
    
    renderSearchBookFilters();
}

// ============================================================
// M√ìDULO DE PESQUISA B√çBLICA (CORRIGIDO)
// ============================================================

// 1. INJE√á√ÉO DE CSS FOR√áADA (Para garantir que os bot√µes s√£o vis√≠veis)
const searchStyle = document.createElement('style');
searchStyle.innerHTML = `
    /* Contentor dos Livros (Scroll Horizontal) */
    #search-books-filter {
        display: flex;
        gap: 6px;
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 2px;
        margin-top: 5px;
        margin-bottom: 5px;
        -webkit-overflow-scrolling: touch;
        border-bottom: 1px solid #333;
    }
    
    /* Bot√µes de Filtro (AT/NT/Todos) */
    .filter-chip {
        background: #252528;
        border: 1px solid #444;
        color: #888;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: bold;
    }
    .filter-chip.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    /* P√≠lulas dos Livros */
    .book-chip {
        background: rgba(255,255,255,0.08);
        border: 1px solid #444;
        color: #ccc;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        flex-shrink: 0; /* Impede que encolham */
    }
    .book-chip:hover { background: #444; }
    .book-chip.active {
        background: rgba(230, 126, 34, 0.2);
        border-color: var(--accent-color);
        color: var(--accent-color);
        font-weight: bold;
    }
`;
document.head.appendChild(searchStyle);


// 2. FUN√á√ÉO DE RENDERIZA√á√ÉO DOS LIVROS
window.renderSearchBookFilters = function() {
    console.log("üîÑ A renderizar filtros de livros...");
    
    const container = document.getElementById('search-books-filter');
    if (!container) {
        console.error("‚ùå Contentor 'search-books-filter' n√£o encontrado no HTML!");
        return;
    }

    // Limpa conte√∫do anterior
    container.innerHTML = '';

    // Filtra lista de livros (BIBLE_DATA deve estar dispon√≠vel globalmente ou importado)
    let booksToShow = BIBLE_DATA.filter(book => {
        if (searchFilterTestament === 'at') return book.id <= 39;
        if (searchFilterTestament === 'nt') return book.id >= 40;
        return true;
    });

    // Se houver pesquisa ativa e resultados, filtra mais
    if (booksWithHits.size > 0) {
         booksToShow = booksToShow.filter(book => booksWithHits.has(book.nome));
    }

    if (booksToShow.length === 0) {
        container.innerHTML = '<span style="color:#666; font-size:0.8rem; padding:5px;">Nenhum livro dispon√≠vel.</span>';
        return;
    }

    // Cria os bot√µes
    booksToShow.forEach(book => {
        const chip = document.createElement('div');
        chip.className = `book-chip ${searchSelectedBook === book.nome ? 'active' : ''}`;
        chip.innerText = book.abrev;
        
        chip.onclick = (e) => {
            e.stopPropagation(); // Evita fechar coisas indesejadas
            searchSelectedBook = (searchSelectedBook === book.nome) ? null : book.nome;
            
            window.renderSearchBookFilters(); // Atualiza cores
            
            if (typeof executeBibleSearch === 'function') {
                executeBibleSearch(false); // Atualiza resultados
            }
        };
        container.appendChild(chip);
    });
    
    console.log(`‚úÖ ${booksToShow.length} livros renderizados.`);
};


// 3. FUN√á√ÉO DE ALTERNAR TESTAMENTO
window.setSearchTestament = function(type, btnElement) {
    searchFilterTestament = type;
    searchSelectedBook = null;

    // Atualiza bot√µes AT/NT
    document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
    if (btnElement) btnElement.classList.add('active');

    // Redesenha os livros
    window.renderSearchBookFilters();
    
    // Se houver texto, refaz a pesquisa
    const input = document.getElementById('bible-search-input');
    if (input && input.value.length >= 3 && typeof executeBibleSearch === 'function') {
        executeBibleSearch(true);
    }
};


// 4. INICIALIZA√á√ÉO E INJE√á√ÉO DO HTML
window.initializeBibleSearch = function() {
    // 1. Evita duplicar o modal se ele j√° existir
    if (document.getElementById('bible-search-modal')) return;

    // 2. Injeta o HTML do Modal de Pesquisa no final do body
    const modalHTML = `
    <div id="bible-search-modal" class="modal-overlay" style="display:none; z-index:10000; align-items: flex-start; padding-top: 50px;">
        <div class="modal-content" style="max-width: 600px; height: 85vh; display: flex; flex-direction: column; background:#1f1f22; border: 1px solid #444;">
            
            <div class="modal-header">
                <h3 style="color:var(--accent-color);">üîç Pesquisar na B√≠blia</h3>
                <button class="modal-close" onclick="window.closeBibleSearch()">√ó</button>
            </div>
            
            <div style="padding: 15px; background: #252528; border-bottom: 1px solid #333; flex-shrink: 0;">
                <!-- Campo de Entrada -->
                <input type="text" id="bible-search-input" placeholder='Pesquisar (ex: "Jesus Cristo" ou "F√©")' 
                       style="width:100%; padding:12px; background:#111; border:1px solid #444; color:white; border-radius:8px; font-size:1rem; outline:none; border-color: var(--accent-color);">
                
                <!-- Filtros de Testamento -->
                <div style="display: flex; gap: 8px; margin-top: 15px; align-items:center;">
                    <span style="font-size:0.75rem; color:#888; text-transform:uppercase; font-weight:bold;">Filtros:</span>
                    <button class="filter-chip active" id="btn-search-all" onclick="window.setSearchTestament('all', this)">Todos</button>
                    <button class="filter-chip" onclick="window.setSearchTestament('at', this)">AT</button>
                    <button class="filter-chip" onclick="window.setSearchTestament('nt', this)">NT</button>
                </div>

                <!-- Contentor de Livros (P√≠lulas) -->
                <div id="search-books-filter" style="display: flex; gap: 6px; overflow-x: auto; padding: 10px 0; margin-top: 5px; scrollbar-width: none;"></div>
            </div>

            <!-- √Årea de Resultados -->
            <div id="bible-search-results" style="flex: 1; overflow-y: auto; padding: 10px; background: #1a1a1d;">
                <div style="text-align:center; padding:50px; color:#555;">
                    <div style="font-size:3rem; opacity:0.3;">üìñ</div>
                    <p>Digite para come√ßar a pesquisar...</p>
                </div>
            </div>

            <!-- Rodap√© e Carregar Mais -->
            <div id="search-load-more-container" style="display: none; padding: 10px; text-align: center; background: #252528;">
                <button onclick="window.renderNextSearchPage()" style="width:100%; padding:10px; background:#333; color:#fff; border:1px solid #444; border-radius:4px; cursor:pointer;">Carregar Mais Resultados</button>
            </div>
            <div id="search-status-bar" style="padding: 8px 15px; background: #111; color: #888; font-size: 0.75rem; border-top: 1px solid #333;">
                <span id="search-count">Pronto.</span>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // 3. L√≥gica do Campo de Pesquisa (Digita√ß√£o Din√¢mica)
    const input = document.getElementById('bible-search-input');
    input.oninput = function(e) {
        const val = e.target.value.trim();

        // Se apagar tudo, limpa os resultados imediatamente
        if (val === "") {
            clearTimeout(window.bibleSearchTimeout);
            window.resetSearchUI();
            return;
        }

        // Se tiver menos de 3 letras, avisa o utilizador
        if (val.length < 3) {
            document.getElementById('bible-search-results').innerHTML = '<div style="text-align:center; padding:30px; color:#666;">Digite pelo menos 3 letras...</div>';
            return;
        }

        // Debounce: Aguarda o utilizador parar de digitar para pesquisar
        clearTimeout(window.bibleSearchTimeout);
        window.bibleSearchTimeout = setTimeout(() => {
            if (typeof window.executeBibleSearch === 'function') {
                window.executeBibleSearch(true);
            }
        }, 600);
    };

    // 4. Fun√ß√£o para Fechar Pesquisa
    window.closeBibleSearch = function() {
        document.getElementById('bible-search-modal').style.display = 'none';
        window.resetSearchUI();
        document.getElementById('bible-search-input').value = '';
    };

    // 5. Fun√ß√£o para Resetar Interface
    window.resetSearchUI = function() {
        allSearchResults = [];
        currentSearchPage = 0;
        if (typeof booksWithHits !== 'undefined') booksWithHits.clear();
        searchSelectedBook = null;

        document.getElementById('bible-search-results').innerHTML = `
            <div style="text-align:center; padding:50px; color:#555;">
                <div style="font-size:3rem; opacity:0.3;">üìñ</div>
                <p>Digite para come√ßar a pesquisar...</p>
            </div>`;
        document.getElementById('search-count').innerText = "Pronto.";
        document.getElementById('search-load-more-container').style.display = 'none';
        
        if (typeof window.renderSearchBookFilters === 'function') {
            window.renderSearchBookFilters();
        }
    };

    // 6. Configura o bot√£o de abertura no Header
    const openBtn = document.getElementById('open-search-btn');
    if (openBtn) {
        openBtn.onclick = () => {
            document.getElementById('bible-search-modal').style.display = 'flex';
            window.renderSearchBookFilters();
            setTimeout(() => input.focus(), 100);
        };
    }
};

// --- FUN√á√ÉO DE EXIBI√á√ÉO CORRIGIDA (Destaque Amarelo/Preto) ---
window.renderNextSearchPage = function(isFirstPage = false) {
    const resultsDiv = document.getElementById('bible-search-results');
    const loadMoreContainer = document.getElementById('search-load-more-container');
    const countSpan = document.getElementById('search-count');

    if (isFirstPage) {
        resultsDiv.innerHTML = '';
        currentSearchPage = 0;
    }

    const start = currentSearchPage * resultsPerPage;
    const end = start + resultsPerPage;
    const pageItems = allSearchResults.slice(start, end);

    // Estilo de Destaque Vibrante
    const hStyle = "background:#f1c40f !important; color:#000 !important; font-weight:bold; border-radius:3px; padding:0 3px; text-decoration:underline;";

    let html = pageItems.map(item => {
        const ref = `${item.book} ${item.cap}:${item.verse}`;
        let text = item.text;

        if (item.termsToHighlight) {
            item.termsToHighlight.forEach(t => {
                const regex = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi");
                text = text.replace(regex, `<mark style="${hStyle}">$1</mark>`);
            });
        }

        return `
            <div class="bk-verse-item" onclick="window.goToSearchRef('${item.book}', ${item.cap}, ${item.verse})" 
                 style="border-bottom: 1px solid #333; padding: 15px; cursor: pointer; background: transparent;">
                <div style="color: var(--accent-color); font-weight: bold; font-size: 0.95rem; margin-bottom: 5px;">üìú ${ref}</div>
                <div style="color: #bbb; font-size: 0.9rem; line-height: 1.5; pointer-events: none;">${text}</div>
            </div>`;
    }).join('');

    if (isFirstPage) {
        resultsDiv.innerHTML = html;
        resultsDiv.scrollTop = 0;
    } else {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        while(temp.firstChild) resultsDiv.insertBefore(temp.firstChild, loadMoreContainer);
    }

    currentSearchPage++;
    loadMoreContainer.style.display = (allSearchResults.length > (currentSearchPage * resultsPerPage)) ? 'block' : 'none';
    countSpan.innerText = `${allSearchResults.length} resultados encontrados.`;
};

// 5. BOT√ÉO PARA ABRIR O MODAL (Inje√ß√£o Segura)
setTimeout(() => {
    // Cria o HTML do modal se n√£o existir
    window.initializeBibleSearch();

    // Injeta bot√£o na Header
    const anchorBtn = document.getElementById('bible-anchors-btn');
    if (anchorBtn && !document.getElementById('open-search-btn')) {
        const btn = document.createElement('button');
        btn.id = 'open-search-btn';
        btn.innerHTML = 'üîç';
        btn.style.cssText = `background:none; border:none; font-size:1.2rem; cursor:pointer; padding:5px; margin-right:5px;`;
        
        btn.onclick = () => {
            const modal = document.getElementById('bible-search-modal');
            modal.style.display = 'flex';
            
            // --- AQUI EST√Å A CORRE√á√ÉO PRINCIPAL ---
            // For√ßamos a renderiza√ß√£o dos livros no momento exato em que abre
            setTimeout(() => {
                window.renderSearchBookFilters();
                document.getElementById('bible-search-input').focus();
            }, 50);
        };
        
        anchorBtn.parentNode.insertBefore(btn, anchorBtn);
    }
}, 1500);

// ============================================================
// CORRE√á√ÉO DOS FILTROS DE PESQUISA (FOR√áAR VISUALIZA√á√ÉO)
// ============================================================

// 1. INJETAR CSS NECESS√ÅRIO
const styleFix = document.createElement('style');
styleFix.innerHTML = `
    /* Contentor dos Livros */
    #search-books-filter {
        display: flex; 
        gap: 6px; 
        overflow-x: auto; 
        white-space: nowrap; 
        padding: 8px 2px;
        margin-top: 8px;
        border-bottom: 1px solid #333;
        margin-bottom: 5px;
        
        /* Scroll suave */
        -webkit-overflow-scrolling: touch; 
        
        /* --- ALTERA√á√ÉO: ESCONDER SCROLLBAR (Firefox e IE) --- */
        scrollbar-width: none; 
        -ms-overflow-style: none; 
    }
    
    /* --- ALTERA√á√ÉO: ESCONDER SCROLLBAR (Chrome, Safari, Android, iOS) --- */
    #search-books-filter::-webkit-scrollbar {
        display: none;
        width: 0 !important;
        height: 0 !important;
        background: transparent; /* Opcional: garante que √© invis√≠vel */
    }
    
    /* Bot√µes de Filtro (AT/NT) */
    .filter-chip {
        background: #252528; border: 1px solid #444; color: #888;
        padding: 4px 12px; border-radius: 15px; font-size: 0.75rem;
        cursor: pointer; transition: 0.2s; font-weight: bold;
    }
    .filter-chip.active {
        background: var(--accent-color); color: white; border-color: var(--accent-color);
    }

    /* P√≠lulas dos Livros */
    .book-chip {
        background: rgba(255,255,255,0.08); border: 1px solid #444; color: #ccc;
        padding: 4px 10px; border-radius: 6px; font-size: 0.75rem;
        cursor: pointer; flex-shrink: 0;
    }
    .book-chip.active {
        background: rgba(230, 126, 34, 0.2); border-color: var(--accent-color);
        color: var(--accent-color); font-weight: bold;
    }
`;
document.head.appendChild(styleFix);


// 2. FUN√á√ÉO QUE CONSTR√ìI A ESTRUTURA (CHAMAR NO IN√çCIO)
window.fixSearchModalStructure = function() {
    const input = document.getElementById('bible-search-input');
    
    // Se n√£o encontrar o input ou se os filtros j√° existirem, n√£o faz nada
    if (!input || document.getElementById('search-filters-container')) return;

    // Criar o contentor dos filtros
    const filtersDiv = document.createElement('div');
    filtersDiv.id = 'search-filters-container';
    filtersDiv.style.marginTop = "10px";

    filtersDiv.innerHTML = `
        <!-- Bot√µes AT / NT -->
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 5px;">
            <span style="font-size:0.75rem; color:#666; text-transform:uppercase; font-weight:bold;">Filtros:</span>
            <button class="filter-chip active" onclick="window.setSearchTestament('all', this)">Todos</button>
            <button class="filter-chip" onclick="window.setSearchTestament('at', this)">AT</button>
            <button class="filter-chip" onclick="window.setSearchTestament('nt', this)">NT</button>
        </div>

        <!-- Carrossel de Livros -->
        <div id="search-books-filter"></div>
    `;

    // INSERIR LOGO AP√ìS O INPUT
    input.parentNode.insertBefore(filtersDiv, input.nextSibling);
    
    console.log("‚úÖ Estrutura de filtros injetada com sucesso!");
};


// 3. FUN√á√ÉO QUE DESENHA OS LIVROS (L√ìGICA)
window.renderSearchBookFilters = function() {
    // Garante que a estrutura existe antes de tentar desenhar
    window.fixSearchModalStructure();

    const container = document.getElementById('search-books-filter');
    if (!container) return;

    container.innerHTML = '';

    // Filtragem dos livros
    let booksToShow = BIBLE_DATA.filter(book => {
        if (searchFilterTestament === 'at') return book.id <= 39;
        if (searchFilterTestament === 'nt') return book.id >= 40;
        return true;
    });

    if (booksWithHits && booksWithHits.size > 0) {
        booksToShow = booksToShow.filter(book => booksWithHits.has(book.nome));
    }

    if (booksToShow.length === 0) {
        container.innerHTML = '<span style="color:#555; font-size:0.75rem;">Nenhum livro dispon√≠vel.</span>';
        return;
    }

    // Criar bot√µes
    booksToShow.forEach(book => {
        const chip = document.createElement('div');
        chip.className = `book-chip ${searchSelectedBook === book.nome ? 'active' : ''}`;
        chip.innerText = book.abrev;
        
        chip.onclick = (e) => {
            e.stopPropagation(); // N√£o fechar nada
            searchSelectedBook = (searchSelectedBook === book.nome) ? null : book.nome;
            window.renderSearchBookFilters(); // Atualizar cor
            if(typeof executeBibleSearch === 'function') executeBibleSearch(false); // Filtrar resultados
        };
        container.appendChild(chip);
    });
};


// 4. FUN√á√ÉO DE ALTERNAR TESTAMENTO
window.setSearchTestament = function(type, btnElement) {
    searchFilterTestament = type;
    searchSelectedBook = null;

    // Atualiza visual dos bot√µes
    const parent = btnElement.parentNode;
    parent.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');

    // Redesenha livros e pesquisa
    window.renderSearchBookFilters();
    
    const input = document.getElementById('bible-search-input');
    if (input && input.value.length >= 3) {
        if(typeof executeBibleSearch === 'function') executeBibleSearch(true);
    }
};


// 5. ATIVAR TUDO (USAR ISTO NO BOT√ÉO DA LUPA)
setTimeout(() => {
    // 1. Garante que a estrutura base dos filtros est√° criada
    if (typeof window.fixSearchModalStructure === 'function') {
        window.fixSearchModalStructure();
    }

    // 2. Tenta encontrar o bot√£o da lupa, ou cria-o se n√£o existir
    const anchorBtn = document.getElementById('bible-anchors-btn');
    let searchBtn = document.getElementById('open-search-btn');

    if (anchorBtn && !searchBtn) {
        searchBtn = document.createElement('button');
        searchBtn.id = 'open-search-btn';
        searchBtn.innerHTML = 'üîç';
        searchBtn.title = 'Pesquisar na B√≠blia';
        searchBtn.style.cssText = `
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            cursor: pointer; 
            padding: 5px; 
            margin-right: 5px;
            min-width: 30px;
        `;
        // Insere a lupa antes do bot√£o de √¢ncoras
        anchorBtn.parentNode.insertBefore(searchBtn, anchorBtn);
    }

    // 3. CONFIGURA O CLIQUE (AQUI EST√Å A CORRE√á√ÉO DOS FILTROS)
    if (searchBtn) {
        searchBtn.onclick = () => {
            const modal = document.getElementById('bible-search-modal');
            
            if (modal) {
                // A. Mostra o modal
                modal.style.display = 'flex';
                
                // B. FOR√áA A RENDERIZA√á√ÉO DOS FILTROS NESTE MOMENTO
                // Isto garante que os bot√µes (AT/NT) e os livros aparecem logo!
                if (typeof window.renderSearchBookFilters === 'function') {
                    window.renderSearchBookFilters();
                }

                // C. Foca no campo de texto (pequeno delay para o modal abrir totalmente)
                setTimeout(() => {
                    const input = document.getElementById('bible-search-input');
                    if (input) input.focus();
                }, 50);
            }
        };
    }
}, 2000); // Espera 2 segundos para garantir que o resto da p√°gina carregou

// Para garantir que corre ao carregar a p√°gina (seguran√ßa):
setTimeout(() => {
    window.fixSearchModalStructure();
}, 2000);



// ============================================================
// MODO DE DIAGN√ìSTICO (LOGS)
// Cole isto no final para ver as a√ß√µes na Consola (F12)
// ============================================================

console.clear();
console.log("üöÄ MODO DE DIAGN√ìSTICO ATIVO: Abra a consola para ver os cliques.");

// 1. MONITORIZAR A BARRA DE PESQUISA
const debugInput = document.getElementById('bible-search-input');
if (debugInput) {
    debugInput.addEventListener('input', (e) => {
        console.log(`‚å®Ô∏è A escrever: "${e.target.value}"`);
    });
} else {
    console.error("‚ùå ERRO: Input de pesquisa n√£o encontrado!");
}

// 2. LOGS NOS BOT√ïES DE TESTAMENTO (AT / NT / TODOS)
// Substitu√≠mos a fun√ß√£o para adicionar o log antes da a√ß√£o
window.setSearchTestament = function(type, btnElement) {
    console.log(`üóÇÔ∏è CLIQUE NO FILTRO: Mudar para "${type.toUpperCase()}"`);

    searchFilterTestament = type;
    searchSelectedBook = null;

    // Atualiza visual
    const parent = btnElement.parentNode;
    parent.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');

    // Redesenha
    window.renderSearchBookFilters();
    
    // Pesquisa
    const input = document.getElementById('bible-search-input');
    if (input && input.value.length >= 3) {
        console.log("   ‚Ü≥ üîé A refazer pesquisa com novo filtro...");
        if(typeof executeBibleSearch === 'function') executeBibleSearch(true);
    }
};

// 3. LOGS NOS BOT√ïES DOS LIVROS (MAT, MAR, ETC)
// Substitu√≠mos a fun√ß√£o de renderiza√ß√£o para injetar o log no clique do livro
window.renderSearchBookFilters = function() {
    // Garante estrutura
    if(typeof window.fixSearchModalStructure === 'function') window.fixSearchModalStructure();

    const container = document.getElementById('search-books-filter');
    if (!container) return;

    container.innerHTML = '';

    // Filtra
    let booksToShow = BIBLE_DATA.filter(book => {
        if (searchFilterTestament === 'at') return book.id <= 39;
        if (searchFilterTestament === 'nt') return book.id >= 40;
        return true;
    });

    if (booksWithHits && booksWithHits.size > 0) {
        booksToShow = booksToShow.filter(book => booksWithHits.has(book.nome));
    }

    if (booksToShow.length === 0) {
        container.innerHTML = '<span style="color:#555; font-size:0.75rem;">Nenhum livro dispon√≠vel.</span>';
        return;
    }

    // Cria bot√µes com LOG
    booksToShow.forEach(book => {
        const chip = document.createElement('div');
        chip.className = `book-chip ${searchSelectedBook === book.nome ? 'active' : ''}`;
        chip.innerText = book.abrev;
        
        chip.onclick = (e) => {
            e.stopPropagation();
            
            // --- LOG DO CLIQUE NO LIVRO ---
            console.log(`üìö LIVRO SELECIONADO: ${book.nome}`);
            // ------------------------------

            searchSelectedBook = (searchSelectedBook === book.nome) ? null : book.nome;
            
            if (searchSelectedBook) {
                console.log(`   ‚Ü≥ Filtro ativo: Apenas resultados em ${book.nome}`);
            } else {
                console.log(`   ‚Ü≥ Filtro removido: A mostrar todos os livros do ${searchFilterTestament.toUpperCase()}`);
            }

            window.renderSearchBookFilters(); // Atualiza cor
            if(typeof executeBibleSearch === 'function') executeBibleSearch(false);
        };
        container.appendChild(chip);
    });
};

// 4. LOG NA EXECU√á√ÉO DA PESQUISA
const originalExecute = window.executeBibleSearch;
window.executeBibleSearch = async (shouldUpdateBookChips = true) => {
    const input = document.getElementById('bible-search-input');
    const resultsDiv = document.getElementById('bible-search-results');
    const countSpan = document.getElementById('search-count');

    if (!input || !resultsDiv) return;

    const rawQuery = input.value.trim().toLowerCase();
    if (rawQuery.length < 3) return;

    console.log(`üîé Iniciando busca por: "${rawQuery}" | Filtro: ${searchFilterTestament}`);

    allSearchResults = [];
    if (shouldUpdateBookChips) booksWithHits.clear();
    
    resultsDiv.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div><p>Pesquisando...</p></div>';

    try {
        for (const book of BIBLE_DATA) {
            // VERIFICA√á√ÉO DE TESTAMENTO
            if (searchFilterTestament === 'at' && book.id >= 40) continue;
            if (searchFilterTestament === 'nt' && book.id <= 39) continue;
            if (searchSelectedBook && book.nome !== searchSelectedBook) continue;

            const filename = getBibleFilename(book.nome);
            
            // Tenta carregar o ficheiro JSON
            if (!localBibleCache[filename]) {
                try {
                    const response = await fetch(`./js/bible/${filename}.json`);
                    if (!response.ok) {
                        console.error(`‚ùå Erro 404: Ficheiro n√£o encontrado: ./js/bible/${filename}.json`);
                        continue;
                    }
                    localBibleCache[filename] = await response.json();
                } catch (fetchErr) {
                    console.error(`‚ùå Erro ao carregar ${filename}:`, fetchErr);
                    continue;
                }
            }

            const bookContent = localBibleCache[filename][book.nome];
            if (!bookContent) {
                console.warn(`‚ö†Ô∏è O livro "${book.nome}" n√£o foi encontrado dentro do ficheiro ${filename}.json`);
                continue;
            }

            let bookHasMatch = false;
            for (const capNum in bookContent) {
                const chapter = bookContent[capNum];
                for (const vNum in chapter) {
                    const verseText = chapter[vNum].toLowerCase();
                    if (verseText.includes(rawQuery)) {
                        bookHasMatch = true;
                        allSearchResults.push({
                            book: book.nome,
                            cap: capNum,
                            verse: vNum,
                            text: chapter[vNum],
                            isChapter: false
                        });
                    }
                }
            }

            if (bookHasMatch && shouldUpdateBookChips) {
                booksWithHits.add(book.nome);
            }
        }

        console.log(`‚úÖ Busca conclu√≠da. Resultados: ${allSearchResults.length}`);
        renderNextSearchPage(true); 
        if (shouldUpdateBookChips) renderSearchBookFilters();

    } catch (e) {
        console.error("‚ùå Erro cr√≠tico na pesquisa:", e);
        resultsDiv.innerHTML = '<p style="color:red; text-align:center;">Erro ao realizar pesquisa.</p>';
    }
};

// ============================================================
// üöë REPARA√á√ÉO DE EMERG√äNCIA: LIGAR O MOTOR DE BUSCA
// Cole isto no final do script para for√ßar a pesquisa a funcionar
// ============================================================

setTimeout(() => {
    console.log("üîß A reparar liga√ß√£o da pesquisa...");
    const input = document.getElementById('bible-search-input');
    
    if (input) {
        input.oninput = function(e) {
            const val = e.target.value.trim();
            
            // --- CORRE√á√ÉO AQUI: SE ESTIVER VAZIO, LIMPA TUDO NA HORA ---
            if (val === "") {
                clearTimeout(window.searchTimer);
                console.log("üßπ Caixa vazia: A limpar resultados...");
                if (typeof window.resetSearchUI === 'function') {
                    window.resetSearchUI();
                }
                return; // Para aqui e n√£o executa a pesquisa
            }

            // Se tiver menos de 3 letras, apenas avisa (opcional)
            if (val.length < 3) {
                const results = document.getElementById('bible-search-results');
                if(results) results.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Digite pelo menos 3 letras...</div>';
                return;
            }

            // Debounce da pesquisa
            if (window.searchTimer) clearTimeout(window.searchTimer);
            
            window.searchTimer = setTimeout(() => {
                console.log("üöÄ TEMPO ESGOTADO: A EXECUTAR PESQUISA AGORA!");
                if (typeof window.executeBibleSearch === 'function') {
                    window.executeBibleSearch(true);
                }
            }, 600);
        };
        console.log("‚úÖ Pesquisa reconectada com sucesso.");
    }
}, 3000);

window.resetSearchUI = function() {
    allSearchResults = [];
    currentSearchPage = 0;
    if (typeof booksWithHits !== 'undefined') booksWithHits.clear();

    const resultsDiv = document.getElementById('bible-search-results');
    const countSpan = document.getElementById('search-count');
    const loadMoreBtn = document.getElementById('search-load-more-container');

    if (resultsDiv) {
        // Volta ao estado inicial (√≠cone de livro e mensagem)
        resultsDiv.innerHTML = `
            <div style="text-align:center; padding:50px; color:#555;">
                <div style="font-size:3rem; opacity:0.3;">üìñ</div>
                <p>Digite para come√ßar a pesquisar...</p>
            </div>`;
    }
    if (countSpan) countSpan.innerText = "Pronto.";
    if (loadMoreBtn) loadMoreBtn.style.display = 'none';
    
    // Atualiza os filtros de livros para voltarem ao normal (sem destaques)
    if (typeof renderSearchBookFilters === 'function') renderSearchBookFilters();
};




    </script>
</body>
</html>
