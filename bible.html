<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√≠blia - Leitura</title>
<style>
    :root {
        /* Cores Base */
        --bg-color: #000000;
        --tile-color: #565060;
        --tile-hover: #6d6679;
        --text-color: #ffffff;
        --accent-color: #e67e22; 
        --highlight-bg: rgba(230, 126, 34, 0.15);
        --border-color: #333;
        --panel-color: #1f1f22;

        /* Vari√°veis de Tamanho Din√¢mico (Configur√°veis) */
        --verse-size-pct: 100%; 
        --card-size-pct: 100%;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between; /* Espa√ßa os elementos */
        height: 45px;
        flex-shrink: 0;
    }

    #back-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        min-width: 30px;
    }

    #page-title {
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
        flex-grow: 1; /* Ocupa o espa√ßo central */
        text-align: center;
    }

    #settings-btn {
        background: none; 
        border: none; 
        font-size: 1.2rem; 
        cursor: pointer;
        padding: 5px; 
        margin-left: 10px; 
        filter: grayscale(100%); 
        transition: 0.3s;
        min-width: 30px;
    }
    #settings-btn:hover { filter: none; transform: rotate(90deg); }

    /* √ÅREA PRINCIPAL */
    .container { flex: 1; overflow-y: auto; padding: 5px; }
    
    .section-title { 
        font-size: 0.7rem; font-weight: 800; color: #888; 
        margin: 10px 0 5px 0; padding-left: 2px; text-transform: uppercase; 
    }

    /* GRELHA (Livros e Cap√≠tulos) */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; padding-bottom: 20px; }
    
    .tile {
        background-color: var(--tile-color); color: var(--text-color); aspect-ratio: 1 / 1;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
    }
    .tile:hover { background-color: var(--tile-hover); }

    @media (max-width: 480px) { 
        .grid { grid-template-columns: repeat(8, 1fr); } 
        .tile { font-size: 0.65rem; } 
    }

    /* --- LISTA DE VERS√çCULOS (MODO PADR√ÉO - LISTA/GRELHA) --- */
    .verse-list { 
        display: flex; 
        flex-direction: column; 
        gap: 0; 
        padding-bottom: 50px; 
    }
    
    .verse-item { 
        padding: 12px 10px; 
        border-bottom: none; 
        display: flex; 
        gap: 12px; 
        align-items: flex-start; 
        cursor: default; 
    }
    
    .verse-number { 
        color: #666; font-weight: bold; font-size: 0.85rem; 
        min-width: 25px; text-align: right; margin-top: 2px; 
        cursor: pointer; padding: 2px 5px; border-radius: 4px; 
        transition: background-color 0.2s; 
    }
    .verse-number:hover { background-color: rgba(255,255,255,0.1); }
    
    /* Ilumina√ß√£o do Vers√≠culo (Laranja Brilhante) */
    .verse-number.has-data { 
        color: var(--accent-color); 
        text-shadow: 0 0 5px rgba(230, 126, 34, 0.4); 
    }
    
    .verse-text { 
        color: #ddd; 
        user-select: text; 
        line-height: 1.6;
        font-size: var(--verse-size-pct); 
    }

    /* --- MODO SEQU√äNCIA (TEXTO CORRIDO) --- */
    .verse-list.sequence-mode {
        display: block; /* Permite fluxo de texto */
        padding: 15px;
        text-align: justify;
    }

    .verse-list.sequence-mode .verse-item {
        display: inline; /* Transforma o bloco em linha */
        padding: 0;
        margin: 0;
    }

    .verse-list.sequence-mode .verse-number {
        display: inline-block;
        min-width: auto;
        margin-left: 8px;
        margin-right: 2px;
        vertical-align: super; /* N√∫mero elevado tipo nota de rodap√© */
        font-size: 0.7em;
        color: #888;
        padding: 0 2px;
    }
    
    /* Ajuste para o primeiro vers√≠culo n√£o ter margem esquerda */
    .verse-list.sequence-mode .verse-item:first-child .verse-number { margin-left: 0; }

    .verse-list.sequence-mode .verse-number.has-data {
        color: var(--accent-color);
        font-weight: 900;
    }

    .verse-list.sequence-mode .verse-text {
        display: inline;
    }


    /* --- ESTILOS GERAIS --- */
    .loading-text { color: #444; font-style: italic; font-size: 0.9em; }
    .hidden { display: none !important; }

    /* --- MODAIS (Geral) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 2000;
        display: none; justify-content: center; align-items: flex-start; padding-top: 50px;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 700px; max-height: 85vh;
        border-radius: 8px; border: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,1);
    }
    .modal-header {
        padding: 10px 15px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        background: #252528; position: relative;
    }
    .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
    .details-body { flex: 1; overflow-y: auto; padding: 15px; }

    /* --- MODAL DE DETALHES (Cards) --- */
    #btn-add-flash-note {
        background: linear-gradient(135deg, #e67e22, #f39c12);
        border: none; color: white; padding: 6px 12px; border-radius: 20px;
        font-weight: bold; font-size: 0.85rem; cursor: pointer;
        box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        animation: pulse-glow 2s infinite;
        margin-left: 10px;
    }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
        50% { box-shadow: 0 0 15px rgba(230, 126, 34, 0.8); }
        100% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
    }

    .detail-section { margin-bottom: 25px; }
    .detail-title { 
        font-size: 0.8rem; text-transform: uppercase; color: #888; 
        font-weight: bold; border-bottom: 1px solid #333; 
        padding-bottom: 5px; margin-bottom: 10px; 
    }
    
    .detail-card { 
        background: rgba(255,255,255,0.03); 
        border: 1px solid #333; 
        border-radius: 4px; 
        padding: 12px; 
        margin-bottom: 10px; 
        color: #e0e0e0; 
        white-space: pre-wrap; 
        word-wrap: break-word;
        font-size: var(--card-size-pct); 
        line-height: 1.5;
    }
    .detail-card strong { display: block; margin-bottom: 5px; color: #fff; font-size: 1.1em; }
    .detail-card a { color: #3498db; text-decoration: none; word-break: break-all; }
    
    .detail-card.puzzle { border-left: 3px solid #2ecc71; }
    .detail-card.dossie { border-left: 3px solid #e74c3c; }
    .detail-card.link { border-left: 3px solid #3498db; }
    .empty-msg { color: #555; font-style: italic; font-size: 0.85rem; padding-left: 5px; }

    /* --- MODAL DE CONFIGURA√á√ïES --- */
    .config-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 0; border-bottom: 1px solid #333;
    }
    .config-label { font-size: 0.9rem; color: #ccc; }
    .config-controls { 
        display: flex; align-items: center; gap: 10px; 
        background: #111; padding: 5px; border-radius: 20px; border: 1px solid #333; 
    }
    .btn-cfg {
        width: 30px; height: 30px; border-radius: 50%; border: none;
        background: #333; color: #fff; font-weight: bold; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
    .btn-cfg:hover { background: var(--accent-color); }
    .cfg-value { width: 50px; text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--accent-color); }
    
    /* Bot√£o Toggle Modo Texto */
    .btn-cfg-toggle {
        width: auto; padding: 0 15px; border-radius: 20px; font-size: 0.85rem;
        background: #333; color: #fff; border: 1px solid #444; height: 30px; cursor: pointer;
    }
    .btn-cfg-toggle:hover { border-color: var(--accent-color); }


    /* --- MODAL DE CRIA√á√ÉO FLASH (SubNota) --- */
    #flash-note-modal { z-index: 3000; } 
    
    .flash-toolbar {
        display: flex; gap: 5px; padding: 8px; background: rgba(0,0,0,0.2); 
        border-radius: 4px; margin-bottom: 10px;
    }
    .flash-toolbar button {
        background: #333; border: 1px solid #444; color: #ccc; 
        width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    }
    
    .flash-input-title {
        width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; 
        color: #e67e22; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; outline: none;
    }
    
    .flash-editor {
        min-height: 150px; outline: none; line-height: 1.5; color: #ddd; 
        padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px;
    }

    /* SCROLLBAR PERSONALIZADO */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
</style>

</head>
<body>

    <header>
        <button id="back-btn">‚¨Ö</button>
        <div id="page-title">B√≠blia</div>
         <button id="settings-btn">‚öôÔ∏è</button>
    </header>

    <div class="container">
        <div id="view-books"></div>
        <div id="view-chapters" class="hidden"><div class="grid" id="chapters-grid"></div></div>
        <div id="view-verses" class="hidden"><div class="verse-list" id="verses-list"></div></div>
    </div>

    <!-- MODAL DE DETALHES -->
    <div id="verse-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display:flex; align-items:center;">
                    <h3 id="modal-verse-title" style="color:var(--accent-color); font-size:1.1rem; margin-right:15px;">Vers√≠culo</h3>
                    <button id="btn-add-flash-note">+ Adicionar Nota</button>
                </div>
                <button class="modal-close" onclick="document.getElementById('verse-details-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body" id="details-content"></div>
        </div>
    </div>

    <!-- MODAL DE CRIA√á√ÉO FLASH -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color:#e67e22;">Nova Nota Flash</h3>
                <button class="modal-close" onclick="document.getElementById('flash-note-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
                
                <div class="flash-toolbar">
                    <button onclick="document.execCommand('bold')"><b>B</b></button>
                    <button onclick="document.execCommand('italic')"><i>I</i></button>
                    <button onclick="document.execCommand('underline')"><u>U</u></button>
                </div>

                <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                    üîó Anexado a: <span id="flash-attached-verse" style="color: #3498db;"></span>
                </div>

                <button id="btn-save-flash" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR NOTA</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; height: auto; max-height: auto;">
            <div class="modal-header">
                <h3 style="color:#fff;">Configura√ß√µes</h3>
                <button class="modal-close" onclick="document.getElementById('settings-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                
                <!-- Modo de Leitura (Grelha/Sequ√™ncia) -->
                <div class="config-row">
                    <span class="config-label">Modo Visualiza√ß√£o</span>
                    <div class="config-controls" style="background:transparent; border:none;">
                        <button id="btn-toggle-view" class="btn-cfg-toggle" onclick="toggleViewMode()">
                            Lista (Grelha)
                        </button>
                    </div>
                </div>

                <!-- Tamanho Texto Vers√≠culos -->
                <div class="config-row">
                    <span class="config-label">Tamanho Vers√≠culos</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('verse', -10)">-</button>
                        <span id="disp-verse-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('verse', 10)">+</button>
                    </div>
                </div>

                <!-- Tamanho Texto Cards -->
                <div class="config-row" style="border-bottom: none;">
                    <span class="config-label">Tamanho Cards (Popups)</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('card', -10)">-</button>
                        <span id="disp-card-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('card', 10)">+</button>
                    </div>
                </div>

                <button id="btn-save-cfg" style="width:100%; margin-top:20px; padding:12px; background:#333; color:white; border:1px solid #555; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR E FECHAR</button>

            </div>
        </div>
    </div>
    

  <script type="module">
        import { BIBLE_DATA } from './js/bible-data.js';
        import { db, auth } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- ESTADO GLOBAL ---
        let currentView = 'books';
        let selectedBook = null;
        let selectedChapter = null;
        let currentUser = null;
        
        let existingUserData = {}; 
        let activeVerseFullName = ""; 
        let activeVerseDocId = ""; 

        // Configura√ß√µes do Utilizador
        let userConfig = {
            verseTextSize: 100,
            cardTextSize: 100,
            viewMode: 'list' // 'list' = Grelha (padr√£o), 'text' = Sequ√™ncia
        };

        // --- REFER√äNCIAS DOM ---
        const viewBooks = document.getElementById('view-books');
        const viewChapters = document.getElementById('view-chapters');
        const viewVerses = document.getElementById('view-verses');
        const chaptersGrid = document.getElementById('chapters-grid');
        const versesList = document.getElementById('verses-list');
        const pageTitle = document.getElementById('page-title');
        const backBtn = document.getElementById('back-btn');
        
        // Modais
        const verseModal = document.getElementById('verse-details-modal');
        const flashModal = document.getElementById('flash-note-modal');
        const settingsModal = document.getElementById('settings-modal');
        
        // Bot√µes
        const btnAddFlash = document.getElementById('btn-add-flash-note');
        const btnSaveFlash = document.getElementById('btn-save-flash');
        const settingsBtn = document.getElementById('settings-btn');
        const btnSaveCfg = document.getElementById('btn-save-cfg');
        const btnToggleView = document.getElementById('btn-toggle-view');

        // --- AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserConfig(); 
            } else {
                window.location.href = "index.html";
            }
        });

        // --- L√ìGICA DE CONFIGURA√á√ïES ---
        
        async function loadUserConfig() {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'configuracoes', currentUser.uid);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.bibleVerseSize) userConfig.verseTextSize = data.bibleVerseSize;
                    if (data.bibleCardSize) userConfig.cardTextSize = data.bibleCardSize;
                    if (data.bibleViewMode) userConfig.viewMode = data.bibleViewMode;
                }
                applyConfigToUI();
            } catch (e) {
                console.error("Erro ao carregar configs:", e);
            }
        }

        function applyConfigToUI() {
            // 1. Vari√°veis CSS (Tamanhos)
            document.documentElement.style.setProperty('--verse-size-pct', `${userConfig.verseTextSize}%`);
            document.documentElement.style.setProperty('--card-size-pct', `${userConfig.cardTextSize}%`);
            
            const dispVerse = document.getElementById('disp-verse-size');
            const dispCard = document.getElementById('disp-card-size');
            if(dispVerse) dispVerse.innerText = `${userConfig.verseTextSize}%`;
            if(dispCard) dispCard.innerText = `${userConfig.cardTextSize}%`;

            // 2. Modo de Visualiza√ß√£o (Grelha/Sequ√™ncia)
            if (userConfig.viewMode === 'text') {
                versesList.classList.add('sequence-mode');
                btnToggleView.innerText = "Texto (Sequ√™ncia)";
                btnToggleView.style.borderColor = "var(--accent-color)";
            } else {
                versesList.classList.remove('sequence-mode');
                btnToggleView.innerText = "Lista (Grelha)";
                btnToggleView.style.borderColor = "#444";
            }
        }

        window.changeConfig = (type, delta) => {
            if (type === 'verse') {
                let novo = userConfig.verseTextSize + delta;
                if (novo >= 80 && novo <= 300) userConfig.verseTextSize = novo;
            } else if (type === 'card') {
                let novo = userConfig.cardTextSize + delta;
                if (novo >= 80 && novo <= 300) userConfig.cardTextSize = novo;
            }
            applyConfigToUI();
        };

        window.toggleViewMode = () => {
            userConfig.viewMode = userConfig.viewMode === 'list' ? 'text' : 'list';
            applyConfigToUI();
        };

        settingsBtn.onclick = () => {
            settingsModal.style.display = 'flex';
        };

        btnSaveCfg.onclick = async () => {
            btnSaveCfg.innerText = "A gravar...";
            try {
                await setDoc(doc(db, 'configuracoes', currentUser.uid), {
                    bibleVerseSize: userConfig.verseTextSize,
                    bibleCardSize: userConfig.cardTextSize,
                    bibleViewMode: userConfig.viewMode
                }, { merge: true });

                settingsModal.style.display = 'none';
            } catch (e) {
                console.error("Erro ao gravar config:", e);
                alert("Erro ao gravar configura√ß√µes.");
            } finally {
                btnSaveCfg.innerText = "GRAVAR E FECHAR";
            }
        };


        // --- FUN√á√ïES DE UTILIDADE ---
        function generateDocId(bookName, chapter, verse) {
            const slug = bookName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ /g, "_");
            return `${slug}_${chapter}_${verse}`;
        }

        // --- RENDERIZA√á√ÉO DA B√çBLIA ---
        function renderBooks() {
            viewBooks.innerHTML = '';
            const hebraico = BIBLE_DATA.filter(b => b.id <= 39);
            const grego = BIBLE_DATA.filter(b => b.id >= 40);

            const createSection = (title, books) => {
                const h2 = document.createElement('h2'); 
                h2.className = 'section-title'; 
                h2.innerText = title; 
                viewBooks.appendChild(h2);
                
                const grid = document.createElement('div'); 
                grid.className = 'grid';
                
                books.forEach(book => {
                    const tile = document.createElement('div'); 
                    tile.className = 'tile'; 
                    tile.innerText = book.abrev;
                    tile.onclick = () => openChapters(book); 
                    grid.appendChild(tile);
                });
                viewBooks.appendChild(grid);
            };
            createSection('Escrituras Hebraico-Aramaicas', hebraico);
            createSection('Escrituras Gregas Crist√£s', grego);
            updateUI('books');
        }

        function openChapters(book) {
            selectedBook = book; 
            chaptersGrid.innerHTML = '';
            for (let i = 1; i <= book.caps; i++) {
                const tile = document.createElement('div'); 
                tile.className = 'tile'; 
                tile.innerText = i;
                tile.onclick = () => openVerses(i); 
                chaptersGrid.appendChild(tile);
            }
            updateUI('chapters');
        }

        async function openVerses(chapter) {
            selectedChapter = chapter; 
            versesList.innerHTML = ''; 
            existingUserData = {}; // Reset cache local
            
            // Garante que o modo de visualiza√ß√£o est√° correto antes de renderizar
            applyConfigToUI();

            if (currentUser) loadUserDataForChapter(selectedBook.nome, chapter);
            
            const totalVerses = selectedBook.versiculos[chapter - 1] || 50;
            for (let i = 1; i <= totalVerses; i++) {
                const row = document.createElement('div'); 
                row.className = 'verse-item';
                const spanId = `vtext-${i}`; 
                const numId = `vnum-${i}`;
                
                row.innerHTML = `<span id="${numId}" class="verse-number" onclick="openModalForVerse(${i})">${i}</span><span id="${spanId}" class="verse-text loading-text">...</span>`;
                versesList.appendChild(row);
                
                fetchVerseText(selectedBook.nome, chapter, i, spanId);
            }
            updateUI('verses');
        }

        async function loadUserDataForChapter(bookName, chapter) {
            const prefix = `${bookName} ${chapter}:`;
            try {
                const q = query(
                    collection(db, "textosbiblicos"), 
                    where("userId", "==", currentUser.uid), 
                    where("nome", ">=", prefix), 
                    where("nome", "<=", prefix + "\uf8ff")
                );
                
                const snapshot = await getDocs(q);
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const parts = data.nome.split(':');
                    
                    if (parts.length > 1) {
                        const verseNum = parts[1].trim();
                        existingUserData[verseNum] = { ...data, docId: docSnap.id };

                        const hasPuzzle = data.puzzleBoard && Array.isArray(data.puzzleBoard) && data.puzzleBoard.length > 0;
                        const hasDossie = data.dossie && Array.isArray(data.dossie) && data.dossie.length > 0;
                        const hasLinks = data.panelLinks && Array.isArray(data.panelLinks) && data.panelLinks.length > 0;

                        if (hasPuzzle || hasDossie || hasLinks) {
                            const firstNum = parseInt(verseNum.split('-')[0]);
                            const numEl = document.getElementById(`vnum-${firstNum}`);
                            if (numEl) numEl.classList.add('has-data');
                        }
                    }
                });
            } catch (e) { console.error("Erro a carregar dados user:", e); }
        }

        async function fetchVerseText(bookName, chapter, verse, elementId) {
            const docId = generateDocId(bookName, chapter, verse);
            const span = document.getElementById(elementId);
            try {
                const docSnap = await getDoc(doc(db, "bible_verses_public", docId));
                if (docSnap.exists()) { 
                    span.innerText = docSnap.data().texto; 
                    span.classList.remove('loading-text'); 
                } else { 
                    span.innerText = "Texto indispon√≠vel."; 
                }
            } catch (error) { 
                span.innerText = "Erro."; 
            }
        }

        function cleanMicaContent(snippet) {
            if (!snippet) return "";
            
            let decoded = decodeURIComponent(snippet);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = decoded;
            
            let title = "";
            const titleInput = tempDiv.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
            const h2 = tempDiv.querySelector('h2');
            
            if (titleInput) title = titleInput.value || titleInput.getAttribute('value') || "";
            else if (h2) title = h2.textContent;

            let content = "";
            const contentDiv = tempDiv.querySelector('.mini-note-content, .toggle-content, .redator-content, .sign-content, .card-desc-content, .cube-content');
            
            if (contentDiv) content = contentDiv.innerText; 
            else content = tempDiv.innerText;

            content = content.replace(/üîê|üî∫|üîª|‚ö°|üß¨|üé®|üìã|üóëÔ∏è/g, '').trim();

            let finalHtml = "";
            if (title && title !== "Texto da Nota") {
                finalHtml += `<div style="font-weight:bold; color:white; margin-bottom:5px;">${title}</div>`;
            }
            finalHtml += `<div style="color:#ddd; font-size:0.9em; white-space: pre-wrap;">${content}</div>`;

            return finalHtml || "Conte√∫do vazio.";
        }

        // --- MODAL DE DETALHES ---
        window.openModalForVerse = async (num) => {
            activeVerseFullName = `${selectedBook.nome} ${selectedChapter}:${num}`;
            const modalTitle = document.getElementById('modal-verse-title');
            const contentDiv = document.getElementById('details-content');
            
            modalTitle.innerText = activeVerseFullName;
            contentDiv.innerHTML = '';
            verseModal.style.display = 'flex';

            const data = existingUserData[num];
            activeVerseDocId = data ? data.docId : null;

            const hasData = data && (
                (data.puzzleBoard && data.puzzleBoard.length > 0) ||
                (data.dossie && data.dossie.length > 0) ||
                (data.panelLinks && data.panelLinks.length > 0)
            );

            if (!hasData) {
                contentDiv.innerHTML = '<p class="empty-msg">Sem registos (Puzzle, Dossi√©, Links).</p>';
                return;
            }

            // A. PUZZLE
            if (data.puzzleBoard && data.puzzleBoard.length > 0) {
                let puzzleHtml = "";
                data.puzzleBoard.forEach(item => {
                    const displayHtml = cleanMicaContent(item.snippet || item.content);
                    puzzleHtml += `<div class="detail-card puzzle">${displayHtml}</div>`;
                });
                contentDiv.innerHTML += `<div class="detail-section"><div class="detail-title">üß© Puzzle</div>${puzzleHtml}</div>`;
            }

            // B. DOSSI√â
            if (data.dossie && data.dossie.length > 0) {
                let dossieHtml = "";
                data.dossie.forEach(mica => {
                    let itemsList = "";
                    if(mica.items && mica.items.length > 0) {
                        mica.items.forEach(mi => {
                            itemsList += `<div style="margin-top:8px; padding:8px; background:rgba(0,0,0,0.3); border-left:2px solid #666; border-radius:4px;">${cleanMicaContent(mi.snippet)}</div>`;
                        });
                    }
                    dossieHtml += `<div class="detail-card dossie"><strong>üóÇÔ∏è ${mica.name}</strong>${itemsList}</div>`;
                });
                contentDiv.innerHTML += `<div class="detail-section"><div class="detail-title">üìº Dossi√©</div>${dossieHtml}</div>`;
            }

            // C. LINKS
            if (data.panelLinks && data.panelLinks.length > 0) {
                let linksHtml = "";
                data.panelLinks.forEach(link => {
                    if (link.type === 'codex') {
                        linksHtml += `<div class="detail-card link"><strong>üìö ${link.serie}</strong><br>${link.codiceshow || ''}</div>`;
                    } else {
                        let urlsHtml = "";
                        if (link.urls) Object.values(link.urls).forEach(u => urlsHtml += `<br><a href="${u}" target="_blank">üîó ${u}</a>`);
                        else if (link.url) urlsHtml += `<br><a href="${link.url}" target="_blank">üîó ${link.url}</a>`;
                        linksHtml += `<div class="detail-card link"><strong>${link.title}</strong>${urlsHtml}</div>`;
                    }
                });
                contentDiv.innerHTML += `<div class="detail-section"><div class="detail-title">‚ö° Doc / Links</div>${linksHtml}</div>`;
            }
        };

        // --- FLASH NOTE ---
        btnAddFlash.onclick = () => {
            document.getElementById('flash-title').value = "";
            document.getElementById('flash-editor').innerHTML = "";
            document.getElementById('flash-attached-verse').innerText = activeVerseFullName;
            flashModal.style.display = 'flex';
            document.getElementById('flash-title').focus();
        };

        btnSaveFlash.onclick = async () => {
            const title = document.getElementById('flash-title').value.trim();
            const content = document.getElementById('flash-editor').innerHTML;
            
            if (!title) return alert("Escreva um t√≠tulo para a nota.");

            btnSaveFlash.textContent = "A gravar...";
            btnSaveFlash.disabled = true;

            try {
                let docRef;
                if (!activeVerseDocId) {
                    const newDoc = await addDoc(collection(db, 'textosbiblicos'), {
                        nome: activeVerseFullName,
                        userId: currentUser.uid,
                        createdAt: serverTimestamp(),
                        referencias: {},
                        puzzleBoard: [],
                        dossie: [],
                        panelLinks: []
                    });
                    activeVerseDocId = newDoc.id;
                }
                
                docRef = doc(db, 'textosbiblicos', activeVerseDocId);

                const boxLinksData = JSON.stringify({
                    categories: [{
                        id: activeVerseDocId,
                        name: activeVerseFullName,
                        type: "textobiblico"
                    }]
                });
                const safeBoxLinks = boxLinksData.replace(/"/g, '&quot;');

                const subNoteHtml = `
                    <div class="mini-note-wrapper" id="box_${Date.now()}" data-topics="{}" data-shared="false" data-box-links='${safeBoxLinks}'>
                        <textarea class="mini-note-title-input" rows="1">${title}</textarea>
                        <div class="mini-note-toolbar" contenteditable="false">
                            <button>üîê</button><button>‚ö°</button><button>üóëÔ∏è</button>
                        </div>
                        <div class="mini-note-content">${content}</div>
                    </div><p><br></p>
                `;

                const noteRef = await addDoc(collection(db, 'pastas'), {
                    nome: title,
                    conteudo: subNoteHtml,
                    tipo: 'nota',
                    oque: 'flash',
                    userId: currentUser.uid,
                    estado: 'ativa',
                    ordem: 0,
                    createdAt: serverTimestamp(),
                    ultimaedicao: serverTimestamp()
                });

                const puzzleItem = {
                    type: 'ref',
                    noteId: noteRef.id,
                    noteName: title,
                    snippet: encodeURIComponent(subNoteHtml),
                    addedAt: Date.now()
                };

                await updateDoc(docRef, {
                    puzzleBoard: arrayUnion(puzzleItem)
                });

                const vNum = activeVerseFullName.split(':')[1].trim();
                const firstNum = parseInt(vNum.split('-')[0]);
                const numBadge = document.getElementById(`vnum-${firstNum}`);
                if(numBadge) numBadge.classList.add('has-data');

                const snap = await getDoc(docRef);
                existingUserData[vNum] = { ...snap.data(), docId: activeVerseDocId };

                alert("Nota criada e afixada no Quadro do vers√≠culo!");
                flashModal.style.display = 'none';
                
                window.openModalForVerse(vNum);

            } catch (e) {
                console.error("Erro ao gravar Flash Note:", e);
                alert("Ocorreu um erro ao gravar.");
            } finally {
                btnSaveFlash.textContent = "GRAVAR NOTA";
                btnSaveFlash.disabled = false;
            }
        };

        // --- NAVEGA√á√ÉO UI ---
        function updateUI(view) {
            currentView = view;
            viewBooks.classList.add('hidden'); 
            viewChapters.classList.add('hidden'); 
            viewVerses.classList.add('hidden');
            
            if (view === 'books') { 
                viewBooks.classList.remove('hidden'); 
                pageTitle.innerText = "B√çBLIA"; 
                backBtn.style.display = 'none'; 
            } else if (view === 'chapters') { 
                viewChapters.classList.remove('hidden'); 
                pageTitle.innerText = selectedBook.nome; 
                backBtn.style.display = 'block'; 
            } else if (view === 'verses') { 
                viewVerses.classList.remove('hidden'); 
                pageTitle.innerText = `${selectedBook.nome} ${selectedChapter}`; 
                backBtn.style.display = 'block'; 
            }
            window.scrollTo(0, 0);
        }

        backBtn.addEventListener('click', () => {
            if (currentView === 'verses') updateUI('chapters'); 
            else if (currentView === 'chapters') { 
                selectedBook = null; 
                updateUI('books'); 
            }
        });

        window.onclick = function(event) { 
            if (event.target === verseModal) verseModal.style.display = "none";
            if (event.target === flashModal) flashModal.style.display = "none"; 
            if (event.target === settingsModal) settingsModal.style.display = "none";
        }

        renderBooks();
    </script>
</body>
</html>
