<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√≠blia - Leitura</title>
<style>
    :root {
        /* Cores Base */
        --bg-color: #000000;
        --tile-color: #565060;
        --tile-hover: #6d6679;
        --text-color: #ffffff;
        --accent-color: #e67e22; 
        --highlight-bg: rgba(230, 126, 34, 0.15);
        --border-color: #333;
        --panel-color: #1f1f22;
        
        /* Cores Espec√≠ficas dos Modos */
        --question-color: #2ecc71; /* Verde */
        --question-bg: rgba(46, 204, 113, 0.15);

        /* Vari√°veis de Tamanho Din√¢mico */
        --verse-size-pct: 100%; 
        --card-size-pct: 100%;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* --- CABE√áALHO --- */
    header {
        padding: 0 15px;
        background-color: #1a1a1a;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 45px;
        flex-shrink: 0;
    }

    #back-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        min-width: 30px;
    }

    #page-title {
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
        flex-grow: 1;
        text-align: center;
    }

    #settings-btn {
        background: none; 
        border: none; 
        font-size: 1.2rem; 
        cursor: pointer;
        padding: 5px; 
        margin-left: 10px; 
        filter: grayscale(100%); 
        transition: 0.3s;
        min-width: 30px;
    }
    #settings-btn:hover { filter: none; transform: rotate(90deg); }

    /* √ÅREA PRINCIPAL */
    .container { flex: 1; overflow-y: auto; padding: 5px; }
    
    .section-title { 
        font-size: 0.7rem; font-weight: 800; color: #888; 
        margin: 10px 0 5px 0; padding-left: 2px; text-transform: uppercase; 
    }

    /* GRELHA (Livros e Cap√≠tulos) */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; padding-bottom: 20px; }
    
    .tile {
        background-color: var(--tile-color); color: var(--text-color); aspect-ratio: 1 / 1;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
    }
    .tile:hover { background-color: var(--tile-hover); }

    @media (max-width: 480px) { 
        .grid { grid-template-columns: repeat(8, 1fr); } 
        .tile { font-size: 0.65rem; } 
    }

    /* --- LISTA DE VERS√çCULOS --- */
    .verse-list { 
        display: flex; 
        flex-direction: column; 
        gap: 0; 
        padding-bottom: 50px; 
    }
    
    .verse-item { 
        padding: 12px 10px; 
        border-bottom: none; 
        display: flex; 
        gap: 12px; 
        align-items: flex-start; 
        cursor: default; 
    }
    
    .verse-number { 
        color: #666; font-weight: bold; font-size: 0.85rem; 
        min-width: 25px; text-align: right; margin-top: 2px; 
        cursor: pointer; padding: 2px 5px; border-radius: 4px; 
        transition: background-color 0.2s; 
    }
    .verse-number:hover { background-color: rgba(255,255,255,0.1); }
    
    .verse-number.has-data { 
        color: var(--accent-color); 
        text-shadow: 0 0 5px rgba(230, 126, 34, 0.4); 
    }
    
    .verse-text { 
        color: #ddd; 
        user-select: text; 
        line-height: 1.6;
        font-size: var(--verse-size-pct); 
    }

    /* Modo Sequ√™ncia */
    .verse-list.sequence-mode {
        display: block;
        padding: 15px;
        text-align: justify;
    }
    .verse-list.sequence-mode .verse-item { display: inline; padding: 0; margin: 0; }
    .verse-list.sequence-mode .verse-number {
        display: inline-block; min-width: auto; margin-left: 8px; margin-right: 2px;
        vertical-align: super; font-size: 0.7em; color: #888; padding: 0 2px;
    }
    .verse-list.sequence-mode .verse-item:first-child .verse-number { margin-left: 0; }
    .verse-list.sequence-mode .verse-number.has-data { color: var(--accent-color); font-weight: 900; }
    .verse-list.sequence-mode .verse-text { display: inline; }

    .loading-text { color: #444; font-style: italic; font-size: 0.9em; }
    .hidden { display: none !important; }

    /* --- MODAIS GERAIS --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 2000;
        display: none; justify-content: center; align-items: flex-start; padding-top: 50px;
    }
    .modal-content {
        background: #1f1f22; width: 95%; max-width: 700px; max-height: 85vh;
        border-radius: 8px; border: 1px solid var(--border-color);
        display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,1);
    }
    .modal-header {
        padding: 10px 15px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        background: #252528; position: relative;
    }
    .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
    .details-body { flex: 1; overflow-y: auto; padding: 15px; }

    /* --- CARD DE DETALHES (CORRIGIDO PARA N√ÉO FICAR GIGANTE) --- */
    .detail-card { 
        background: rgba(255,255,255,0.03); 
        border: 1px solid #333; 
        border-radius: 4px; 
        padding: 12px; 
        margin-bottom: 10px; 
        color: #e0e0e0; 
        
        /* CORRE√á√ÉO DO TAMANHO GIGANTE AQUI */
        white-space: normal; /* Era pre-wrap */
        word-wrap: break-word;
        position: relative; /* Necess√°rio para o menu de pontinhos */
        
        font-size: var(--card-size-pct); 
        line-height: 1.5;
    }

    .detail-card strong { display: block; margin-bottom: 5px; color: #fff; font-size: 1.1em; }
    .detail-card a { color: #3498db; text-decoration: none; word-break: break-all; }
    
    .detail-section { margin-bottom: 25px; }
    .detail-title { 
        font-size: 0.8rem; text-transform: uppercase; color: #888; 
        font-weight: bold; border-bottom: 1px solid #333; 
        padding-bottom: 5px; margin-bottom: 10px; 
    }
    .empty-msg { color: #555; font-style: italic; font-size: 0.85rem; padding-left: 5px; }

    /* --- MENU DE 2 PONTOS NOS CARDS --- */
    .card-menu-container {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 10;
    }
    .card-menu-btn {
        cursor: pointer;
        color: #888;
        font-weight: bold;
        font-size: 14px;
        padding: 0 6px;
        letter-spacing: 1px;
        background: rgba(0,0,0,0.4);
        border-radius: 4px;
        transition: background 0.2s;
    }
    .card-menu-btn:hover { color: #fff; background: var(--accent-color); }

  .card-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 22px;
        background: #252528;
        border: 1px solid #555;
        border-radius: 4px;
        box-shadow: 0 4px 15px rgba(0,0,0,1); /* Sombra mais forte para destacar */
        min-width: 120px; /* Um pouco mais largo */
        flex-direction: column;
        z-index: 9999; /* <--- MUITO IMPORTANTE: N√∫mero alto */
    }
    .card-dropdown.visible { display: flex; }

    .card-dropdown button {
        background: none;
        border: none;
        color: #ccc;
        padding: 10px;
        text-align: left;
        cursor: pointer;
        font-size: 0.85rem;
        border-bottom: 1px solid #333;
        white-space: nowrap;
    }
    .card-dropdown button:last-child { border-bottom: none; }
    .card-dropdown button:hover { background: #333; color: white; }
    .btn-remove-card:hover { background: #c0392b !important; color: white; }

    /* --- CRIA√á√ÉO FLASH NOTE --- */
    #btn-add-flash-note {
         background: linear-gradient(135deg, #e67e22, #f39c12);
        border: none; color: white; padding: 6px 12px; border-radius: 20px;
        font-weight: bold; font-size: 0.85rem; cursor: pointer;
        box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        animation: pulse-glow 2s infinite;
        margin-left: 10px;
    }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
        50% { box-shadow: 0 0 15px rgba(230, 126, 34, 0.8); }
        100% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
    }

    #flash-note-modal { z-index: 3000; }
    .flash-toolbar {
        display: flex; align-items: center; gap: 5px; 
        padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 10px;
    }
    .flash-toolbar button {
        background: #333; border: 1px solid #444; color: #ccc; 
        width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    }
    #flash-type-select {
        margin-left: auto; background: #333; color: #fff;
        border: 1px solid #444; padding: 5px; border-radius: 4px; font-size: 0.8rem; outline: none;
    }
    .flash-input-title {
        width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; 
        color: #e67e22; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; outline: none;
    }
 .flash-editor {
        min-height: 150px; outline: none; line-height: 1.5; color: #ddd; 
        padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px;
        white-space: pre-wrap;
        
        /* --- NOVAS PROPRIEDADES --- */
        border: 1px solid #3498db; /* Azul claro por defeito (Subnota) */
        transition: border-color 0.3s ease; /* Efeito suave na troca */
    }

    /* --- CONFIGURA√á√ïES --- */
    .config-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 0; border-bottom: 1px solid #333;
    }
    .config-label { font-size: 0.9rem; color: #ccc; }
    .config-controls { 
        display: flex; align-items: center; gap: 10px; 
        background: #111; padding: 5px; border-radius: 20px; border: 1px solid #333; 
    }
    .btn-cfg {
        width: 30px; height: 30px; border-radius: 50%; border: none;
        background: #333; color: #fff; font-weight: bold; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
    .btn-cfg:hover { background: var(--accent-color); }
    .cfg-value { width: 50px; text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--accent-color); }
    
    .btn-cfg-toggle {
        width: auto; padding: 0 15px; border-radius: 20px; font-size: 0.85rem;
        background: #333; color: #fff; border: 1px solid #444; height: 30px; cursor: pointer;
    }
    .btn-cfg-toggle:hover { border-color: var(--accent-color); }

    /* Estilos herdados para renderiza√ß√£o de notas (Cores) */
    .mini-note-wrapper.question-mode { border-color: var(--question-color) !important; background-color: var(--question-bg) !important; }
    .mini-note-wrapper.question-mode .mini-note-title-input { color: var(--question-color) !important; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

    /* Estilos para as abas do Modal de Links */
.store-tab-btn {
    background: none; border: none; color: #888; 
    padding: 5px 10px; cursor: pointer; border-bottom: 2px solid transparent;
}
.store-tab-btn.active {
    color: var(--text-color); border-bottom-color: var(--accent-color); font-weight: bold;
}
.flash-url-row, .flash-codex-row {
    display: flex; gap: 5px;
}
.flash-url-row input, .flash-codex-row input {
    background: #111; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; flex: 1;
}
.btn-remove-row {
    background: #c0392b; color: white; border: none; width: 30px; cursor: pointer; border-radius: 4px;
}
.flash-cat-chip {
    background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; cursor: pointer;
}

/* --- ESTILOS AVAN√áADOS DO CODEX (Portados do note.html) --- */
.codex-row {
    background: #252528; border: 1px solid #333; border-radius: 8px;
    padding: 10px; margin-bottom: 10px; position: relative;
    border-left: 3px solid var(--accent-color);
}
.remove-codex-row {
    position: absolute; top: 5px; right: 5px; background: none; border: none;
    color: #e74c3c; cursor: pointer; font-weight: bold; font-size: 16px;
}
.codex-header-grid {
    display: flex; gap: 10px; align-items: center; margin-bottom: 10px;
}
.serie-wrapper { flex: 1; }
.codex-label {
    display: block; font-size: 0.65rem; color: #888; margin-bottom: 2px; text-transform: uppercase;
}
.codex-input-modern {
    width: 100%; background: #111; border: 1px solid #333; color: white;
    padding: 6px; border-radius: 4px; font-size: 0.9rem;
}
.manual-controls { display: flex; gap: 2px; }
.btn-control-small {
    background: #333; border: 1px solid #444; color: #ccc; width: 24px; height: 24px;
    border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold;
}
.btn-control-small.active {
    background: var(--accent-color); color: white; border-color: var(--accent-color);
}
.manual-inputs-area {
    display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;
}
.manual-field-group {
    display: flex; align-items: center; background: rgba(255,255,255,0.1);
    padding: 2px 6px; border-radius: 4px; gap: 5px; border: 1px solid #444;
}
.codex-input-manual {
    background: transparent; border: none; color: white; width: 40px; font-size: 0.8rem; outline: none;
}
.btn-close-manual {
    background: none; border: none; color: #e74c3c; cursor: pointer; font-weight: bold;
}
.codex-content-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid #333; padding-top: 8px;
}
.codex-unit-chip {
    display: inline-flex; align-items: center; background: #333; border: 1px solid #444;
    border-radius: 12px; padding: 2px 6px; margin: 2px; font-size: 0.8rem;
}
.codex-unit-chip input {
    background: transparent; border: none; color: white; width: 30px; text-align: center; outline: none;
}
.btn-unit-del {
    background: none; border: none; color: #e74c3c; cursor: pointer; margin-left: 2px; font-weight: bold;
}
.btn-unit-add {
    background: rgba(255,255,255,0.1); border: 1px dashed #666; color: #ccc;
    width: 20px; height: 20px; border-radius: 50%; cursor: pointer; margin-left: 5px;
}

/* --- ESTILO DO TOGGLE (INTERRUPTOR) --- */
.setting-switch {
    position: relative; display: inline-block; width: 34px; height: 18px;
}
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #444; transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(16px); }

/* --- LAYOUT H√çBRIDO (SIDEBAR) --- */
    /* Wrapper para colocar a B√≠blia e a Sidebar lado a lado */
    #main-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
        height: calc(100vh - 45px); /* Desconta o header */
    }

    /* A √°rea da B√≠blia ocupa o espa√ßo restante */
    .container {
        flex: 1;
        overflow-y: auto;
        padding: 5px;
        transition: flex 0.3s ease; /* Suavidade se encolher */
    }

    /* A Coluna Lateral (PC) */
    #side-panel {
        width: 0; /* Come√ßa fechada */
        background-color: #1f1f22;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Efeito suave */
        flex-shrink: 0; /* Impede que seja esmagada */
        z-index: 1000;
    }

    #side-panel.open {
        width: 40%; /* No PC ocupa 40% */
        box-shadow: -5px 0 15px rgba(0,0,0,0.5);
    }

    /* Esconde a Sidebar em ecr√£s pequenos e garante que o modal funciona */
    @media (max-width: 768px) {
        #side-panel { display: none !important; }
        #side-panel.open { width: 0 !important; }
    }

      #btn-add-flash-note, .btn-create-note {
        background: linear-gradient(135deg, #e67e22, #f39c12);
        border: none; color: white; padding: 6px 12px; border-radius: 20px;
        font-weight: bold; font-size: 0.85rem; cursor: pointer;
        box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
        animation: pulse-glow 2s infinite;
        margin-left: 10px;
        white-space: nowrap; /* Impede que o texto quebre */
    }

    /* --- BARRA FLUTUANTE DE SELE√á√ÉO --- */
    #selection-toolbar {
        position: absolute;
        z-index: 9999;
        background-color: #252528;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 5px;
        display: none; /* Escondido por defeito */
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        gap: 5px;
        transform: translateX(-50%); /* Para centrar na sele√ß√£o */
    }
    #selection-toolbar::after {
        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
        border-width: 5px; border-style: solid; border-color: #252528 transparent transparent transparent;
    }
    .sel-btn {
        background: none; border: none; color: white; cursor: pointer;
        padding: 5px 10px; font-size: 0.9rem; border-radius: 4px;
        display: flex; align-items: center; gap: 5px;
    }
    .sel-btn:hover { background-color: rgba(255,255,255,0.1); }

    /* --- ESTILO DOS DESTAQUES (PICOTADO) --- */
    /* A classe base ser√° gerada via JS, mas a estrutura √© esta */
    .bible-highlight {
        border-bottom-width: 3px;
        border-bottom-style: dotted; /* O tal "picotado" */
        background-color: rgba(255,255,255,0.05); /* Ligeiro fundo para destacar */
    }

    /* --- DROPDOWN DE CORES --- */
    .color-select-wrapper {
        display: flex; align-items: center; gap: 5px; margin-top: 10px;
        padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;
    }
    #flash-color-select {
        background: #333; color: white; border: 1px solid #444;
        padding: 5px; border-radius: 4px; flex: 1;
    }
    /* Pequena bola de pr√©-visualiza√ß√£o da cor */
    #color-preview-dot {
        width: 20px; height: 20px; border-radius: 50%; background-color: transparent; border: 1px solid #555;
    }

#selection-toolbar {
    position: absolute;
    display: none; /* Escondido por defeito */
    background-color: #252528;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    z-index: 5000;
    gap: 5px;
    align-items: center;
}
#selection-toolbar button {
    background: #333;
    border: none;
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
}
#selection-toolbar button:hover { background: var(--accent-color); }

/* --- SELETOR DE CORES (NOVA NOTA) --- */
/* --- ATUALIZA√á√ÉO FINAL DO CSS DAS CORES --- */
.color-picker-container {
    display: flex;
    gap: 10px;
    padding: 10px 2px; /* Um pouco mais de altura para o zoom */
    overflow-x: auto;
    align-items: center;
    min-height: 50px;
}

.color-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0;
    border: 2px solid transparent; 
    opacity: 0.7;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    
    /* NOVO: Para centrar o "certo" */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Prepara para n√£o mostrar nada por defeito */
    font-size: 0; 
}

.color-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}

/* O ESTADO SELECIONADO */
.color-btn.selected {
    transform: scale(1.3);
    border: 2px solid #ffffff;
    opacity: 1;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    z-index: 10;
}

/* O √çCONE DE "CERTO" (‚úì) */
.color-btn.selected::after {
    content: '‚úì';
    font-size: 14px;
    color: white;
    font-weight: bold;
    /* Sombra no texto para se ver bem mesmo em cores claras (tipo amarelo) */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    
    /* Anima√ß√£ozinha de entrada */
    animation: popIn 0.3s ease forwards;
}

@keyframes popIn {
    0% { transform: scale(0); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* --- ESTILO DO SUBLINHADO (PICOTADO) --- */
.highlight-picotado {
    border-bottom-width: 3px;
    border-bottom-style: dotted; /* Picotado */
    padding-bottom: 1px;
      display: inline;
    cursor: pointer;
}

</style>

</head>
<body>

    <header>
        <button id="back-btn">‚¨Ö</button>
        <div id="page-title">B√≠blia</div>
         <button id="settings-btn">‚öôÔ∏è</button>
    </header>

<!-- NOVO WRAPPER FLEX -->
    <div id="main-layout">
        
        <!-- √Årea Principal (B√≠blia) -->
        <div class="container">
            <div id="view-books"></div>
            <div id="view-chapters" class="hidden"><div class="grid" id="chapters-grid"></div></div>
            <div id="view-verses" class="hidden"><div class="verse-list" id="verses-list"></div></div>
        </div>

        <!-- Nova Coluna Lateral (Sidebar PC) -->
<aside id="side-panel">
        <div class="modal-header" style="position: relative; justify-content: space-between; height: 50px;">
            
            <!-- ESQUERDA: Contentor para T√≠tulo e Bot√£o Voltar -->
            <div style="display: flex; align-items: center; max-width: 30%; overflow: hidden;">
                <!-- Bot√£o Voltar (Escondido por defeito) -->
                <button id="sidebar-back-btn" onclick="window.returnToVerseDetails()" style="display: none; background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; margin-right: 10px;">‚¨Ö</button>
                
                <h3 id="sidebar-verse-title" style="color:var(--accent-color); font-size:1.1rem; white-space:nowrap; overflow: hidden; text-overflow: ellipsis;">
                    Vers√≠culo
                </h3>
            </div>
            
            <!-- CENTRO: Bot√£o Criar Nota -->
            <div id="sidebar-center-actions" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 10;">
                <button class="btn-create-note" onclick="window.handleCreateNoteClick()" style="margin: 0;">
                    + Adicionar Nota
                </button>
            </div>

            <!-- DIREITA: Bot√£o Fechar -->
            <button class="modal-close" onclick="window.closeSidePanel()">√ó</button>
        </div>
        
        <div class="details-body" id="sidebar-content">
            <!-- Conte√∫do carregado via JS -->
        </div>
    </aside>



    </div>

    <!-- MODAL DE DETALHES -->
    <div id="verse-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display:flex; align-items:center;">
                    <h3 id="modal-verse-title" style="color:var(--accent-color); font-size:1.1rem; margin-right:15px;">Vers√≠culo</h3>
                    <button id="btn-add-flash-note">+ Adicionar Nota</button>
                </div>
                <button class="modal-close" onclick="document.getElementById('verse-details-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body" id="details-content"></div>
        </div>
    </div>

    <!-- MODAL DE CRIA√á√ÉO FLASH (ATUALIZADO COM SELECT) -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color:#e67e22;">Nova Nota Flash</h3>
                <button class="modal-close" onclick="document.getElementById('flash-note-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
                
                <!-- Toolbar com Dropdown √† Direita -->
                <div class="flash-toolbar">
                    <button onclick="document.execCommand('bold')"><b>B</b></button>
                    <button onclick="document.execCommand('italic')"><i>I</i></button>
                    <button onclick="document.execCommand('underline')"><u>U</u></button>
                    <button id="btn-flash-topics" title="T√≥picos do Bloco" style="margin-left:5px;">üìã</button>
                    <button id="btn-flash-links" title="Gest√£o de Links" style="margin-left:2px;">‚ö°</button>

                    <!-- Novo Seletor de Tipo -->
                    <select id="flash-type-select">
                        <option value="default">üìò Subnota</option>
                        <option value="question">üìó Quest√£o</option>
                    </select>
                </div>

                <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                    üîó Anexado a: <span id="flash-attached-verse" style="color: #3498db;"></span>
                </div>

                <button id="btn-save-flash" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR NOTA</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; height: auto; max-height: auto;">
            <div class="modal-header">
                <h3 style="color:#fff;">Configura√ß√µes</h3>
                <button class="modal-close" onclick="document.getElementById('settings-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                
                <!-- Modo de Leitura (Grelha/Sequ√™ncia) -->
                <div class="config-row">
                    <span class="config-label">Modo Visualiza√ß√£o</span>
                    <div class="config-controls" style="background:transparent; border:none;">
                        <button id="btn-toggle-view" class="btn-cfg-toggle" onclick="toggleViewMode()">
                            Lista (Grelha)
                        </button>
                    </div>
                </div>

                <!-- Tamanho Texto Vers√≠culos -->
                <div class="config-row">
                    <span class="config-label">Tamanho Vers√≠culos</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('verse', -10)">-</button>
                        <span id="disp-verse-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('verse', 10)">+</button>
                    </div>
                </div>

                <!-- Tamanho Texto Cards -->
                <div class="config-row" style="border-bottom: none;">
                    <span class="config-label">Tamanho Cards (Popups)</span>
                    <div class="config-controls">
                        <button class="btn-cfg" onclick="changeConfig('card', -10)">-</button>
                        <span id="disp-card-size" class="cfg-value">100%</span>
                        <button class="btn-cfg" onclick="changeConfig('card', 10)">+</button>
                    </div>
                </div>

                <button id="btn-save-cfg" style="width:100%; margin-top:20px; padding:12px; background:#333; color:white; border:1px solid #555; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR E FECHAR</button>

            </div>
        </div>
    </div>
    
    <!-- MODAL DE EDI√á√ÉO DE CARD -->
    <div id="edit-card-modal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-content" style="max-width: 400px; height: auto;">
            <div class="modal-header">
                <h3>Editar Nota</h3>
                <button class="modal-close" onclick="document.getElementById('edit-card-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                <label style="font-size:0.8rem; color:#888;">T√≠tulo</label>
                <input type="text" id="edit-card-title" class="flash-input-title" style="font-size:1rem; margin-bottom:10px;">
                
                <label style="font-size:0.8rem; color:#888;">Conte√∫do</label>
                <div id="edit-card-content" class="flash-editor" contenteditable="true" style="min-height:100px;"></div>
                
                <input type="hidden" id="edit-card-index"> <!-- Guarda qual item estamos a editar -->
                <input type="hidden" id="edit-card-verse"> <!-- Guarda o n√∫mero do vers√≠culo -->

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="document.getElementById('edit-card-modal').style.display='none'" style="flex:1; padding:10px; background:#333; border:none; color:#ccc; border-radius:4px; cursor:pointer;">Cancelar</button>
                    <button id="btn-confirm-edit-card" style="flex:1; padding:10px; background:var(--accent-color); border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">Gravar</button>
                </div>
            </div>
        </div>
    </div>

<!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 300px; text-align: center; padding: 20px;">
            <h3 id="confirm-title" style="margin-bottom: 10px; color: #e74c3c;">Aten√ß√£o</h3>
            <p id="confirm-message" style="margin-bottom: 20px; color: #ccc;">Deseja continuar?</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btn-cancel-confirm" style="padding: 8px 15px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button id="btn-ok-confirm" style="padding: 8px 15px; background: #e74c3c; border: none; color: white; border-radius: 4px; font-weight: bold; cursor: pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SELE√á√ÉO DE T√ìPICOS (BIBLE VERSION) -->
<div id="flash-topics-modal" class="modal-overlay" style="z-index: 5000;">
    <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3>T√≥picos do Bloco</h3>
            <button class="modal-close" onclick="document.getElementById('flash-topics-modal').style.display='none'">√ó</button>
        </div>
        <div style="display: flex; flex: 1; overflow: hidden;">
            <!-- Coluna Esquerda: T√≥picos -->
            <div style="flex: 1; border-right: 1px solid #333; padding: 10px; overflow-y: auto;">
                <h4 style="color:#e67e22; font-size:0.8rem; margin-bottom:10px;">T√ìPICOS</h4>
                <ul id="flash-topics-list" style="list-style:none;">Carregando...</ul>
            </div>
            <!-- Coluna Direita: Subt√≥picos -->
            <div style="flex: 1; padding: 10px; overflow-y: auto;">
                <h4 style="color:#3498db; font-size:0.8rem; margin-bottom:10px;" id="flash-sub-title">SUBT√ìPICOS</h4>
                <ul id="flash-subtopics-list" style="list-style:none;">
                    <li style="color:#888; font-style:italic;">Selecione um t√≥pico.</li>
                </ul>
            </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
            <button onclick="document.getElementById('flash-topics-modal').style.display='none'" 
                    style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Confirmar Sele√ß√£o
            </button>
        </div>
    </div>
</div>

<!-- MODAL GEST√ÉO DE LINKS (FLASH VERSION) -->
<div id="flash-links-modal" class="modal-overlay" style="z-index: 5000;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        
        <div class="modal-header">
            <h3>Gest√£o de Links</h3>
            <button class="modal-close" onclick="document.getElementById('flash-links-modal').style.display='none'">√ó</button>
        </div>

        <!-- ABAS -->
        <div class="store-tabs-header" style="padding: 10px; border-bottom: 1px solid #333; display: flex; gap: 10px;">
            <button class="store-tab-btn active" onclick="window.switchFlashLinkTab('refs')">Refer√™ncias</button>
            <button class="store-tab-btn" onclick="window.switchFlashLinkTab('codex')">Codex</button>
            <button class="store-tab-btn" onclick="window.switchFlashLinkTab('cats')">Categorias</button>
        </div>

        <!-- CONTE√öDO DAS ABAS -->
        <div style="flex: 1; overflow-y: auto; padding: 15px;">
            
            <!-- ABA 1: REFER√äNCIAS (URLS) -->
            <div id="flash-tab-refs">
                <label style="color:#888; font-size:0.8rem;">T√≠tulo do Grupo de Links</label>
                <input type="text" id="flash-link-title" class="flash-input-title" style="font-size:1rem; margin-bottom:15px; border-bottom:1px solid #333;" placeholder="Ex: Artigos de apoio...">
                
                <div id="flash-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                
                <button onclick="window.addFlashUrlField()" style="margin-top:10px; padding:6px 12px; background:#333; border:1px solid #555; color:#ccc; cursor:pointer; border-radius:4px;">+ Adicionar URL</button>
            </div>

            <!-- ABA 2: CODEX (AGORA COMPLETO) -->
            <div id="flash-tab-codex" style="display:none;">
                <div id="flash-codex-rows-container">
                    <!-- As linhas complexas do Codex ser√£o injetadas aqui -->
                </div>
                <button onclick="window.createFlashCodexRow()" style="width:100%; margin-top:15px; padding:10px; background:rgba(230, 126, 34, 0.1); border:1px dashed #e67e22; color:#e67e22; cursor:pointer; border-radius:6px;">+ Nova Linha Codex</button>
            </div>

            <!-- ABA 3: CATEGORIAS (COM TOGGLE) -->
            <div id="flash-tab-cats" style="display:none;">
                
                <!-- Barra de Pesquisa + Toggle -->
                <input type="text" id="flash-cat-search" class="flash-input-title" style="font-size:0.9rem;" placeholder="Pesquisar..." oninput="window.searchFlashCategories(this.value)">
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; padding:5px; background:rgba(255,255,255,0.05); border-radius:4px;">
                    <label class="setting-switch">
                        <input type="checkbox" id="flash-bible-toggle">
                        <span class="slider round"></span>
                    </label>
                    <span style="font-size:0.8rem; color:#ccc;">Procurar na B√≠blia (Global)</span>
                </div>

                <div id="flash-cat-results" style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #333; padding:5px;"></div>

                <label style="color:#888; font-size:0.8rem;">Selecionados:</label>
                <div id="flash-cat-selected" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>

        </div>

        <!-- RODAP√â -->
        <div style="padding: 15px; border-top: 1px solid #333; text-align: right;">
            <button id="btn-save-flash-links" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                Confirmar e Anexar
            </button>
        </div>
    </div>
</div>

<!-- BARRA FLUTUANTE DE SELE√á√ÉO -->
<div id="selection-toolbar">
    <button id="btn-copy-selection" title="Copiar">üìÑ</button>
    <button id="btn-note-selection" title="Criar Nota Flash">üñçÔ∏è Nota Flash</button>
</div>


  <script type="module">
        import { BIBLE_DATA } from './js/bible-data.js';
        import { db, auth } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // --- ESTADO GLOBAL ---
        let currentView = 'books';
        let selectedBook = null;
        let selectedChapter = null;
        let currentUser = null;
        
        let existingUserData = {}; 
        let activeVerseFullName = ""; 
        let activeVerseDocId = ""; 

        // Configura√ß√µes do Utilizador
        let userConfig = {
            verseTextSize: 100,
            cardTextSize: 100,
            viewMode: 'list' // 'list' = Grelha (padr√£o), 'text' = Sequ√™ncia
        };
        let currentFlashTopics = {}; // Formato: { "topicID": ["subID1", "subID2"] }
let activeTopicIdForFlash = null;
let currentFlashLinks = {};
let currentSelectionRange = null;
let currentSelectedText = "";
let currentSelectedVerses = [];
let currentSelectionText = "";
let currentSelectionVerses = []; // Array de IDs: ["G√©nesis 1:1", "G√©nesis 1:2"]
let selectedColorHex = null; // Cor escolhida
let currentChapterHighlights = [];
let activeHighlightContext = null;

        // --- REFER√äNCIAS DOM ---
        const viewBooks = document.getElementById('view-books');
        const viewChapters = document.getElementById('view-chapters');
        const viewVerses = document.getElementById('view-verses');
        const chaptersGrid = document.getElementById('chapters-grid');
        const versesList = document.getElementById('verses-list');
        const pageTitle = document.getElementById('page-title');
        const backBtn = document.getElementById('back-btn');
        
        // Modais
        const verseModal = document.getElementById('verse-details-modal');
        const flashModal = document.getElementById('flash-note-modal');
        const settingsModal = document.getElementById('settings-modal');
        
        // Bot√µes
        const btnAddFlash = document.getElementById('btn-add-flash-note');
        const btnSaveFlash = document.getElementById('btn-save-flash');
        const settingsBtn = document.getElementById('settings-btn');
        const btnSaveCfg = document.getElementById('btn-save-cfg');
        const btnToggleView = document.getElementById('btn-toggle-view');


// Cores Dispon√≠veis
const HIGHLIGHT_COLORS = [
    { name: 'Laranja', hex: '#e67e22' },
    { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' },
    { name: 'Verde', hex: '#2ecc71' },
    { name: 'Lil√°s', hex: '#9b59b6' },
    { name: 'Rosa', hex: '#ff7979' },
    { name: 'Salm√£o', hex: '#ffb8b8' },
    { name: 'Castanho', hex: '#a0522d' },
    { name: 'Cinzento', hex: '#95a5a6' }
];



        // --- AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserConfig(); 
            } else {
                window.location.href = "index.html";
            }
        });

        // --- L√ìGICA DE CONFIGURA√á√ïES ---
        async function loadUserConfig() {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'configuracoes', currentUser.uid);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.bibleVerseSize) userConfig.verseTextSize = data.bibleVerseSize;
                    if (data.bibleCardSize) userConfig.cardTextSize = data.bibleCardSize;
                    if (data.bibleViewMode) userConfig.viewMode = data.bibleViewMode;
                }
                applyConfigToUI();
            } catch (e) {
                console.error("Erro ao carregar configs:", e);
            }
        }

        function applyConfigToUI() {
            document.documentElement.style.setProperty('--verse-size-pct', `${userConfig.verseTextSize}%`);
            document.documentElement.style.setProperty('--card-size-pct', `${userConfig.cardTextSize}%`);
            
            const dispVerse = document.getElementById('disp-verse-size');
            const dispCard = document.getElementById('disp-card-size');
            if(dispVerse) dispVerse.innerText = `${userConfig.verseTextSize}%`;
            if(dispCard) dispCard.innerText = `${userConfig.cardTextSize}%`;

            if (userConfig.viewMode === 'text') {
                versesList.classList.add('sequence-mode');
                btnToggleView.innerText = "Texto (Sequ√™ncia)";
                btnToggleView.style.borderColor = "var(--accent-color)";
            } else {
                versesList.classList.remove('sequence-mode');
                btnToggleView.innerText = "Lista (Grelha)";
                btnToggleView.style.borderColor = "#444";
            }
        }

        window.changeConfig = (type, delta) => {
            if (type === 'verse') {
                let novo = userConfig.verseTextSize + delta;
                if (novo >= 80 && novo <= 300) userConfig.verseTextSize = novo;
            } else if (type === 'card') {
                let novo = userConfig.cardTextSize + delta;
                if (novo >= 80 && novo <= 300) userConfig.cardTextSize = novo;
            }
            applyConfigToUI();
        };

        window.toggleViewMode = () => {
            userConfig.viewMode = userConfig.viewMode === 'list' ? 'text' : 'list';
            applyConfigToUI();
        };

        settingsBtn.onclick = () => {
            settingsModal.style.display = 'flex';
        };

        btnSaveCfg.onclick = async () => {
            btnSaveCfg.innerText = "A gravar...";
            try {
                await setDoc(doc(db, 'configuracoes', currentUser.uid), {
                    bibleVerseSize: userConfig.verseTextSize,
                    bibleCardSize: userConfig.cardTextSize,
                    bibleViewMode: userConfig.viewMode
                }, { merge: true });

                settingsModal.style.display = 'none';
            } catch (e) {
                console.error("Erro ao gravar config:", e);
                alert("Erro ao gravar configura√ß√µes.");
            } finally {
                btnSaveCfg.innerText = "GRAVAR E FECHAR";
            }
        };


        // --- FUN√á√ïES DE UTILIDADE ---
        function generateDocId(bookName, chapter, verse) {
            const slug = bookName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ /g, "_");
            return `${slug}_${chapter}_${verse}`;
        }

        // --- RENDERIZA√á√ÉO DA B√çBLIA ---
        function renderBooks() {
            viewBooks.innerHTML = '';
            const hebraico = BIBLE_DATA.filter(b => b.id <= 39);
            const grego = BIBLE_DATA.filter(b => b.id >= 40);

            const createSection = (title, books) => {
                const h2 = document.createElement('h2'); 
                h2.className = 'section-title'; 
                h2.innerText = title; 
                viewBooks.appendChild(h2);
                
                const grid = document.createElement('div'); 
                grid.className = 'grid';
                
                books.forEach(book => {
                    const tile = document.createElement('div'); 
                    tile.className = 'tile'; 
                    tile.innerText = book.abrev;
                    tile.onclick = () => openChapters(book); 
                    grid.appendChild(tile);
                });
                viewBooks.appendChild(grid);
            };
            createSection('Escrituras Hebraico-Aramaicas', hebraico);
            createSection('Escrituras Gregas Crist√£s', grego);
            updateUI('books');
        }

        function openChapters(book) {
            selectedBook = book; 
            chaptersGrid.innerHTML = '';
            for (let i = 1; i <= book.caps; i++) {
                const tile = document.createElement('div'); 
                tile.className = 'tile'; 
                tile.innerText = i;
                tile.onclick = () => openVerses(i); 
                chaptersGrid.appendChild(tile);
            }
            updateUI('chapters');
        }

async function openVerses(chapter) {
    selectedChapter = chapter; 
    versesList.innerHTML = ''; 
    existingUserData = {}; 
    currentChapterHighlights = []; 
    
    applyConfigToUI();

    const totalVerses = selectedBook.versiculos[chapter - 1] || 50;
    
    // Array para guardar as promessas de carregamento do texto
    const textLoadPromises = [];

    for (let i = 1; i <= totalVerses; i++) {
        const row = document.createElement('div'); 
        row.className = 'verse-item';
        
        const spanId = `vtext-${i}`; 
        const numId = `vnum-${i}`;
        
        row.innerHTML = `
            <span id="${numId}" class="verse-number" onclick="window.openModalForVerse(${i})">${i}</span>
            <span id="${spanId}" class="verse-text loading-text">...</span>
        `;
        versesList.appendChild(row);
        
        // Adiciona o carregamento deste vers√≠culo √† lista de espera
        textLoadPromises.push(fetchVerseText(selectedBook.nome, chapter, i, spanId));
    }

    updateUI('verses');

    // --- CORRE√á√ÉO DE SINCRONIA ---
    // 1. Espera que TODOS os textos da B√≠blia apare√ßam
    await Promise.all(textLoadPromises);

    // 2. S√≥ agora carrega os dados do utilizador e desenha as cores
    if (currentUser) {
        // N√ÉO chamamos mais o loadHighlightsForChapter aqui para evitar conflitos visuais
        // Chamamos apenas o loadUserData, que vai chamar o refreshVisualHighlights no fim
        await loadUserDataForChapter(selectedBook.nome, chapter);
    }
}

   async function loadUserDataForChapter(bookName, chapter) {
    const prefix = `${bookName} ${chapter}:`;
    console.log("üì• A carregar notas do utilizador...");
    
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, "textosbiblicos"), 
            where("userId", "==", currentUser.uid), 
            where("nome", ">=", prefix), 
            where("nome", "<=", prefix + "\uf8ff")
        );
        
        const snapshot = await getDocs(q);
        
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const parts = data.nome.split(':');
            
            if (parts.length > 1) {
                const verseNum = parts[1].trim();
                // Guarda os dados na cache
                existingUserData[verseNum] = { ...data, docId: docSnap.id };

                // Marca o n√∫mero do vers√≠culo a laranja se tiver dados
                const hasData = (data.puzzleBoard?.length > 0) || (data.dossie?.length > 0) || (data.panelLinks?.length > 0);
                if (hasData) {
                    const firstNum = parseInt(verseNum.split('-')[0]);
                    const numEl = document.getElementById(`vnum-${firstNum}`);
                    if (numEl) numEl.classList.add('has-data');
                }
            }
        });

        // --- CORRE√á√ÉO FUNDAMENTAL ---
        // Assim que acabamos de carregar as notas, redesenhamos os picotados!
        // Isto garante que ao entrar na p√°gina, as cores v√™m das notas e n√£o do hist√≥rico antigo.
        if (typeof window.refreshVisualHighlights === 'function') {
            window.refreshVisualHighlights();
        }

    } catch (e) { console.error("Erro a carregar dados user:", e); }
}

async function fetchVerseText(bookName, chapter, verse, elementId) {
    const docId = generateDocId(bookName, chapter, verse);
    const span = document.getElementById(elementId);
    try {
        const docSnap = await getDoc(doc(db, "bible_verses_public", docId));
        if (docSnap.exists()) { 
            const textoBiblico = docSnap.data().texto;
            span.innerText = textoBiblico; 
            span.classList.remove('loading-text'); 
            
            // REMOVEMOS a chamada antiga applyCachedHighlightsToElement(span) aqui
            // Agora deixamos o refreshVisualHighlights tratar de tudo no fim
        } else { 
            span.innerText = "Texto indispon√≠vel."; 
        }
    } catch (error) { 
        span.innerText = "Erro."; 
    }
}

        function cleanMicaContent(snippet) {
            if (!snippet) return "";
            
            let decoded = decodeURIComponent(snippet);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = decoded;
            
            let title = "";
            const titleInput = tempDiv.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
            const h2 = tempDiv.querySelector('h2');
            
            if (titleInput) title = titleInput.value || titleInput.getAttribute('value') || "";
            else if (h2) title = h2.textContent;

            let content = "";
            const contentDiv = tempDiv.querySelector('.mini-note-content, .toggle-content, .redator-content, .sign-content, .card-desc-content, .cube-content');
            
            if (contentDiv) content = contentDiv.innerText; 
            else content = tempDiv.innerText;

            content = content.replace(/üîê|üî∫|üîª|‚ö°|üß¨|üé®|üìã|üóëÔ∏è/g, '').trim();

            let finalHtml = "";
            if (title && title !== "Texto da Nota") {
                finalHtml += `<div style="font-weight:bold; color:white; margin-bottom:5px;">${title}</div>`;
            }
            finalHtml += `<div style="color:#ddd; font-size:0.9em; white-space: pre-wrap;">${content}</div>`;

            return finalHtml || "Conte√∫do vazio.";
        }

        // --- MODAL DE DETALHES ---
 // --- MODAL DE DETALHES ---
 // Fun√ß√£o para fechar a sidebar
        window.closeSidePanel = () => {
            const sidePanel = document.getElementById('side-panel');
            sidePanel.classList.remove('open');
            // Remove o destaque do vers√≠culo ativo (opcional)
            document.querySelectorAll('.verse-number.active-selection').forEach(el => el.classList.remove('active-selection'));
        };

window.openModalForVerse = async (num) => {
    // --- RESET DO CONTEXTO (IMPORTANTE) ---
    activeHighlightContext = null; 
    currentSelectionText = ""; // Garante que n√£o h√° texto selecionado
    selectedColorHex = null;   // Garante que n√£o h√° cor pr√©-selecionada
    // -----------------------------------

    activeVerseFullName = `${selectedBook.nome} ${selectedChapter}:${num}`;
    const isDesktop = window.innerWidth >= 768;
    
    let titleEl, contentDiv, container;

    // --- HTML DO BOT√ÉO PADR√ÉO ---
    const defaultBtnHtml = `
        <button class="btn-create-note" onclick="window.handleCreateNoteClick()" style="margin: 0;">
            + Adicionar Nota
        </button>
    `;

    if (isDesktop) {
        container = document.getElementById('side-panel');
        titleEl = document.getElementById('sidebar-verse-title');
        contentDiv = document.getElementById('sidebar-content');
        container.classList.add('open');

        const centerActions = document.getElementById('sidebar-center-actions');
        const backBtn = document.getElementById('sidebar-back-btn');

        if (centerActions) {
            // FOR√áA O DISPLAY BLOCK (caso estivesse none)
            centerActions.style.display = 'block'; 
            centerActions.innerHTML = defaultBtnHtml;
        }
        if(backBtn) backBtn.style.display = 'none';

    } else {
        // MOBILE
        container = document.getElementById('verse-details-modal');
        titleEl = document.getElementById('modal-verse-title');
        contentDiv = document.getElementById('details-content');
        container.style.display = 'flex';

        // 1. Mostrar bot√£o padr√£o
        const defaultBtn = document.getElementById('btn-add-flash-note');
        if (defaultBtn) {
            defaultBtn.style.display = 'inline-block';
            defaultBtn.innerText = "+ Adicionar Nota"; // Garante o texto original
        }
        
        // 2. Remover bot√£o personalizado se existir
        const customBtn = document.getElementById('btn-custom-highlight');
        if (customBtn) customBtn.remove();
    }

    titleEl.innerText = activeVerseFullName;
    
    contentDiv.innerHTML = `
        <div class="spinner-container" style="padding: 40px; text-align: center; color: #888;">
            <div class="spinner"></div><br>A carregar notas...
        </div>`;

    let data = null;
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(
            collection(db, 'textosbiblicos'), 
            where('nome', '==', activeVerseFullName),
            where('userId', '==', currentUser.uid)
        );
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
            data = { ...snapshot.docs[0].data(), docId: snapshot.docs[0].id };
            existingUserData[num] = data;
        }
    } catch (e) {
        contentDiv.innerHTML = `<p style="color:#e74c3c; text-align:center;">Erro: ${e.message}</p>`;
        return;
    }

    activeVerseDocId = data ? data.docId : null;
    const htmlContent = buildVerseHTML(data, num);
    contentDiv.innerHTML = htmlContent;
};


        // --- FUN√á√ÉO AUXILIAR DE RENDERIZA√á√ÉO (Para evitar c√≥digo duplicado) ---
        function buildVerseHTML(data, num) {
            const hasData = data && (
                (data.puzzleBoard && data.puzzleBoard.length > 0) ||
                (data.dossie && data.dossie.length > 0) ||
                (data.panelLinks && data.panelLinks.length > 0)
            );

            if (!hasData) {
                return '<p class="empty-msg">Sem registos (Puzzle, Dossi√©, Links).</p>';
            }

            let finalHtml = "";

            // A. PUZZLE
            if (data.puzzleBoard && data.puzzleBoard.length > 0) {
                let puzzleHtml = "";
                data.puzzleBoard.forEach((item, index) => {
                    const displayHtml = cleanMicaContent(item.snippet || item.content);
                    let borderColor = "#3498db"; 
                    let raw = decodeURIComponent(item.snippet || "");
                    
                    if (raw.includes("question-mode")) borderColor = "#2ecc71";
                    else if (raw.includes("free-mode")) borderColor = "#e67e22";

                    const menuHtml = `
                        <div class="card-menu-container">
                            <div class="card-menu-btn" onclick="window.toggleCardMenu(this)">‚Ä¢‚Ä¢</div>
                            <div class="card-dropdown">
                                <button onclick="window.openEditCard('${num}', ${index})">‚úèÔ∏è Editar</button>
                                <button class="btn-remove-card" onclick="window.deletePuzzleItem('${num}', ${index})">üóëÔ∏è Remover</button>
                            </div>
                        </div>
                    `;

                    puzzleHtml += `
                        <div class="detail-card" style="border-left: 4px solid ${borderColor}; position: relative;">
                            ${menuHtml}
                            ${displayHtml}
                        </div>`;
                });
                finalHtml += `<div class="detail-section"><div class="detail-title">üß© Puzzle</div>${puzzleHtml}</div>`;
            }

            // B. DOSSI√â
            if (data.dossie && data.dossie.length > 0) {
                let dossieHtml = "";
                data.dossie.forEach(mica => {
                    let itemsList = "";
                    if(mica.items && mica.items.length > 0) {
                        mica.items.forEach(mi => {
                            itemsList += `<div style="margin-bottom:12px; padding:8px; background:rgba(0,0,0,0.3); border-left:2px solid #666; border-radius:4px; font-size:0.9em;">${cleanMicaContent(mi.snippet)}</div>`;
                        });
                    }
                    const safeName = mica.name ? mica.name.trim() : "Sem Nome";
                    dossieHtml += `
                        <div class="detail-card" style="border-left: 3px solid #e74c3c; padding: 6px 8px; margin-bottom: 4px; min-height: 0; height: auto; white-space: normal;">
                            <div style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; line-height: 1.2;" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                <span style="font-weight:bold; font-size:0.85rem; overflow:hidden; text-overflow:ellipsis;">üìÇ ${safeName}</span>
                                <span style="font-size:0.7rem; color:#666; padding-left:5px;">‚ñº</span>
                            </div>
                            <div class="hidden" style="margin-top:8px; padding-top:5px; border-top:1px solid rgba(255,255,255,0.1); white-space: pre-wrap;">
                                ${itemsList}
                            </div>
                        </div>`;
                });
                finalHtml += `<div class="detail-section"><div class="detail-title">üìº Dossi√©</div>${dossieHtml}</div>`;
            }

            // C. LINKS
            if (data.panelLinks && data.panelLinks.length > 0) {
                let linksHtml = "";
                data.panelLinks.forEach(link => {
                    if (link.type === 'codex') {
                        linksHtml += `<div class="detail-card" style="border-left: 3px solid #3498db;"><strong>üìö ${link.serie}</strong><br>${link.codiceshow || ''}</div>`;
                    } else {
                        let urlsHtml = "";
                        if (link.urls) Object.values(link.urls).forEach(u => urlsHtml += `<br><a href="${u}" target="_blank">üîó ${u}</a>`);
                        else if (link.url) urlsHtml += `<br><a href="${link.url}" target="_blank">üîó ${link.url}</a>`;
                        linksHtml += `<div class="detail-card" style="border-left: 3px solid #3498db;"><strong>${link.title}</strong>${urlsHtml}</div>`;
                    }
                });
                finalHtml += `<div class="detail-section"><div class="detail-title">‚ö° Doc / Links</div>${linksHtml}</div>`;
            }

            return finalHtml;
        }

        // --- FLASH NOTE ---
        btnAddFlash.onclick = () => {
    // 1. Limpa os campos visuais
    document.getElementById('flash-title').value = "";
    document.getElementById('flash-editor').innerHTML = "";
    document.getElementById('flash-attached-verse').innerText = activeVerseFullName;
    
    // 2. Reset do dropdown para o padr√£o
    document.getElementById('flash-type-select').value = "default";
    
    // 3. RESET DAS VARI√ÅVEIS DE DADOS (CRUCIAL PARA OS NOVOS BOT√ïES)
    currentFlashTopics = {}; 
    currentFlashLinks = {}; // Reinicia os links
    activeTopicIdForFlash = null;

    // 4. RESET VISUAL DOS √çCONES DA TOOLBAR
    const btnLink = document.getElementById('btn-flash-links');
    if(btnLink) { 
        btnLink.style.color = ""; 
        btnLink.style.borderColor = ""; 
    }
    
    // 5. Mostra o modal e foca no t√≠tulo
    flashModal.style.display = 'flex';
    
    // Pequeno delay para garantir que o modal est√° vis√≠vel antes de focar
    setTimeout(() => {
        document.getElementById('flash-title').focus();
    }, 50);
};

 window.saveFlashNoteGlobal = async () => {
    const titleInput = document.getElementById('flash-title');
    const editor = document.getElementById('flash-editor');
    const typeSelect = document.getElementById('flash-type-select');
    const saveBtn = editor.parentElement.querySelector('button:last-of-type') || document.getElementById('btn-save-flash');

    const title = titleInput.value.trim();
    const content = editor.innerHTML;
    const noteType = typeSelect ? typeSelect.value : 'default';
    
    if (!title) return alert("Escreva um t√≠tulo para a nota.");

    saveBtn.textContent = "A gravar...";
    saveBtn.disabled = true;

    try {
        const { collection, addDoc, doc, updateDoc, arrayUnion, serverTimestamp, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // 1. DADOS DE CONTEXTO
        let highlightRefTexto = currentSelectionText; 
        if (!highlightRefTexto && activeHighlightContext) highlightRefTexto = activeHighlightContext.text;

        let colorToSave = selectedColorHex;
        if (!colorToSave && activeHighlightContext) colorToSave = activeHighlightContext.color;
        if (!colorToSave && highlightRefTexto) colorToSave = '#3498db'; 

        const versesToAttach = (currentSelectionVerses && currentSelectionVerses.length > 0) 
                       ? currentSelectionVerses 
                       : [activeVerseFullName];

        // 2. CRIAR A NOTA (DOC) PRIMEIRO para obter o ID
        const safeTopics = JSON.stringify(currentFlashTopics || {}).replace(/"/g, '&quot;');
        if (!currentFlashLinks || (!currentFlashLinks.categories && !currentFlashLinks.urls && !currentFlashLinks.codex)) {
             currentFlashLinks = { categories: [{ id: "temp", name: versesToAttach[0], type: "textobiblico" }] };
        }
        const safeBoxLinks = JSON.stringify(currentFlashLinks).replace(/"/g, '&quot;');

        let wrapperClass = "mini-note-wrapper";
        if (noteType === 'question') wrapperClass += " question-mode";

        const subNoteHtml = `
            <div class="${wrapperClass}" id="box_${Date.now()}" 
                 data-topics='${safeTopics}' 
                 data-shared="false" 
                 data-box-links='${safeBoxLinks}' 
                 contenteditable="false">
                <textarea class="mini-note-title-input" rows="1">${title}</textarea>
                <div class="mini-note-toolbar" contenteditable="false">
                    <button>üîê</button>
                    <div class="toolbar-btn-group"><button>üî∫</button><button>üîª</button></div>
                    <button class="has-links">‚ö°</button><button>üß¨</button><button>üé®</button><button>üìã</button><button>üóëÔ∏è</button>
                </div>
                <div class="mini-note-content" contenteditable="true">${content}</div>
            </div><p><br></p>
        `;

        const noteRef = await addDoc(collection(db, 'pastas'), {
            nome: title,
            conteudo: subNoteHtml,
            tipo: 'nota',
            oque: 'flash',
            userId: currentUser.uid,
            estado: 'ativa',
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        });

        // 3. AGORA GRAVAMOS O TRECHO GLOBAL (COM O NOTE ID)
        // Verificamos se j√° existe este trecho exato para n√£o duplicar, ou criamos novo
        if (currentSelectionText && colorToSave) {
            // Pequena query para ver se este trecho j√° existe
            const qCheck = query(
                collection(db, 'trechosbiblicos'), 
                where('userId', '==', currentUser.uid),
                where('nome', '==', currentSelectionText),
                where('textosbiblicos', 'array-contains', versesToAttach[0]) // Simplifica√ß√£o
            );
            const snapCheck = await getDocs(qCheck);
            
            if (!snapCheck.empty) {
                // Se j√° existe, adicionamos o ID desta nova nota ao array de noteIds
                const docId = snapCheck.docs[0].id;
                await updateDoc(doc(db, 'trechosbiblicos', docId), {
                    noteIds: arrayUnion(noteRef.id),
                    cor: colorToSave // Atualiza a cor se mudou
                });
            } else {
                // Se √© novo, cria
                await addDoc(collection(db, 'trechosbiblicos'), {
                    userId: currentUser.uid,
                    textosbiblicos: versesToAttach,
                    nome: currentSelectionText, // O TEXTO COMPLETO (ex: "Hoje... calor")
                    cor: colorToSave,
                    noteIds: [noteRef.id], // <--- O ELO DE LIGA√á√ÉO
                    createdAt: serverTimestamp()
                });
            }
        }

        // 4. ATUALIZAR VERS√çCULOS INDIVIDUAIS
        const puzzleItemBase = {
            type: 'ref',
            noteId: noteRef.id,
            noteName: title,
            snippet: encodeURIComponent(subNoteHtml),
            addedAt: Date.now(),
            noteColor: colorToSave || null 
        };

        for (const verseName of versesToAttach) {
            let targetRef, targetId;
            const qVerse = query(collection(db, 'textosbiblicos'), where('nome', '==', verseName), where('userId', '==', currentUser.uid));
            const snapshot = await getDocs(qVerse);

            // Calcular Interse√ß√£o
            let specificHighlightRef = highlightRefTexto; 
            try {
                const vNum = verseName.split(':')[1].trim().split('-')[0];
                const verseSpan = document.getElementById(`vtext-${vNum}`);
                if (verseSpan && highlightRefTexto) {
                    const overlap = calculateVerseIntersection(verseSpan.innerText, highlightRefTexto);
                    if (overlap) specificHighlightRef = overlap;
                }
            } catch(err) { console.log(err); }

            const specificPuzzleItem = { 
                ...puzzleItemBase, 
                highlightRef: specificHighlightRef || null 
            };

            if (!snapshot.empty) {
                targetId = snapshot.docs[0].id;
                targetRef = doc(db, 'textosbiblicos', targetId);
                await updateDoc(targetRef, { puzzleBoard: arrayUnion(specificPuzzleItem) });
            } else {
                const newVerseDoc = await addDoc(collection(db, 'textosbiblicos'), {
                    nome: verseName, userId: currentUser.uid, createdAt: serverTimestamp(), referencias: {},
                    puzzleBoard: [specificPuzzleItem], dossie: [], panelLinks: []
                });
                targetId = newVerseDoc.id;
                targetRef = newVerseDoc;
            }

            // Cache Local
            const vNum = verseName.split(':')[1].trim().split('-')[0];
            const numBadge = document.getElementById(`vnum-${vNum}`);
            if(numBadge) numBadge.classList.add('has-data');
            const currentData = existingUserData[vNum] || {};
            existingUserData[vNum] = { ...currentData, docId: targetId, puzzleBoard: [...(currentData.puzzleBoard || []), specificPuzzleItem], nome: verseName };
        }

        // 5. FINALIZA√á√ÉO
        if (typeof window.refreshVisualHighlights === 'function') window.refreshVisualHighlights();
        document.getElementById('flash-note-modal').style.display = 'none';

        // Redireciona para o painel consolidado
        if (highlightRefTexto) {
            activeHighlightContext = { text: highlightRefTexto, color: colorToSave };
            // Usa o primeiro vers√≠culo como "√¢ncora" para o evento
            const vNum = versesToAttach[0].split(':')[1].trim().split('-')[0];
            const verseEl = document.getElementById(`vnum-${vNum}`).closest('.verse-item');
            
            // Importante: Passamos o texto completo aqui
            window.openHighlightDetails({stopPropagation:()=>{}, target: verseEl}, encodeURIComponent(highlightRefTexto), encodeURIComponent(colorToSave));
        } else {
             if (window.innerWidth >= 768) window.returnToVerseDetails();
             else window.openModalForVerse(versesToAttach[0].split(':')[1].trim().split('-')[0]);
        }

        // Limpeza
        currentSelectionText = "";
        currentSelectionVerses = [];
        selectedColorHex = null;
        if (window.getSelection) window.getSelection().removeAllRanges();

    } catch (e) {
        console.error("Erro ao gravar:", e);
        alert("Erro: " + e.message);
        saveBtn.disabled = false;
    }
};



        // --- NAVEGA√á√ÉO UI ---
        function updateUI(view) {
            currentView = view;
            viewBooks.classList.add('hidden'); 
            viewChapters.classList.add('hidden'); 
            viewVerses.classList.add('hidden');
            
            if (view === 'books') { 
                viewBooks.classList.remove('hidden'); 
                pageTitle.innerText = "B√çBLIA"; 
                backBtn.style.display = 'none'; 
            } else if (view === 'chapters') { 
                viewChapters.classList.remove('hidden'); 
                pageTitle.innerText = selectedBook.nome; 
                backBtn.style.display = 'block'; 
            } else if (view === 'verses') { 
                viewVerses.classList.remove('hidden'); 
                pageTitle.innerText = `${selectedBook.nome} ${selectedChapter}`; 
                backBtn.style.display = 'block'; 
            }
            window.scrollTo(0, 0);
        }

        backBtn.addEventListener('click', () => {
            if (currentView === 'verses') updateUI('chapters'); 
            else if (currentView === 'chapters') { 
                selectedBook = null; 
                updateUI('books'); 
            }
        });

        window.onclick = function(event) { 
            if (event.target === verseModal) verseModal.style.display = "none";
            if (event.target === flashModal) flashModal.style.display = "none"; 
            if (event.target === settingsModal) settingsModal.style.display = "none";
        }

        renderBooks();


        // 1. Alternar Menu (Abrir/Fechar)
 window.toggleCardMenu = (btn) => {
    const container = btn.parentElement; // O div .card-menu-container
    const dropdown = btn.nextElementSibling;

    // 1. Fechar todos os outros menus abertos E RESETAR o z-index deles
    document.querySelectorAll('.card-dropdown').forEach(d => {
        if (d !== dropdown) {
            d.classList.remove('visible');
            // Reseta o pai para o z-index baixo original
            d.parentElement.style.zIndex = "10"; 
        }
    });

    // 2. Verificar se vamos abrir ou fechar
    const isOpening = !dropdown.classList.contains('visible');

    if (isOpening) {
        dropdown.classList.add('visible');
        // TRUQUE: Eleva este contentor espec√≠fico acima de todos os outros cards
        container.style.zIndex = "10000"; 
    } else {
        dropdown.classList.remove('visible');
        container.style.zIndex = "10"; // Volta ao normal
    }
    
    // 3. Fechar ao clicar fora (com reset do z-index)
    if (isOpening) {
        const closeMenu = (e) => {
            if (!container.contains(e.target)) {
                dropdown.classList.remove('visible');
                container.style.zIndex = "10"; // MUITO IMPORTANTE: Resetar aqui tamb√©m
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 10);
    }
};

        // 2. Eliminar Item do Puzzle
window.deletePuzzleItem = async (vNum, index) => {
    // 1. Confirma√ß√£o
    const confirmed = await window.showConfirmation(
        "Remover Nota?", 
        "Esta nota ser√° apagada de TODOS os vers√≠culos ligados a este trecho."
    );
    if (!confirmed) return;

    // 2. Obter dados da nota alvo (do vers√≠culo onde clic√°mos)
    const data = existingUserData[vNum];
    if (!data || !data.puzzleBoard || !data.puzzleBoard[index]) return;

    const itemToDelete = data.puzzleBoard[index];
    const targetNoteId = itemToDelete.noteId; // O ID de liga√ß√£o global

    // Feedback visual imediato (muda o √≠cone para um rel√≥gio)
    const btn = document.querySelector('.btn-remove-card');
    if(btn) btn.innerText = "‚è≥";

    try {
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const updatePromises = [];

        // --- CEN√ÅRIO A: Nota Global (com NoteID) ---
        if (targetNoteId) {
            console.log(`üóëÔ∏è A apagar nota global: ${targetNoteId}`);

            // Percorre TODOS os vers√≠culos carregados na mem√≥ria
            for (const [verseKey, verseData] of Object.entries(existingUserData)) {
                
                // --- CORRE√á√ÉO DO ERRO AQUI ---
                // Verifica√ß√£o de seguran√ßa: Se o vers√≠culo n√£o tiver dados ou n√£o tiver puzzleBoard, salta fora.
                if (!verseData || !Array.isArray(verseData.puzzleBoard)) {
                    continue;
                }
                // -----------------------------

                // Filtra o array para remover a nota com este ID
                const originalLength = verseData.puzzleBoard.length;
                const newBoard = verseData.puzzleBoard.filter(item => item.noteId !== targetNoteId);

                // Se houve altera√ß√£o (o tamanho diminuiu), significa que a nota existia aqui
                if (newBoard.length < originalLength) {
                    
                    // 1. Atualiza Cache Local
                    existingUserData[verseKey].puzzleBoard = newBoard;
                    
                    // Se ficou vazio e n√£o tem mais nada, remove o destaque visual do n√∫mero
                    if (newBoard.length === 0 && (!verseData.dossie?.length) && (!verseData.panelLinks?.length)) {
                        const numBadge = document.getElementById(`vnum-${verseKey}`);
                        if(numBadge) numBadge.classList.remove('has-data');
                    }

                    // 2. Prepara Atualiza√ß√£o Firebase para este vers√≠culo espec√≠fico
                    if (verseData.docId) {
                        const docRef = doc(db, 'textosbiblicos', verseData.docId);
                        updatePromises.push(updateDoc(docRef, { puzzleBoard: newBoard }));
                    }
                }
            }
        } 
        // --- CEN√ÅRIO B: Nota Local Antiga (sem NoteID) ---
        else {
            console.log("üóëÔ∏è A apagar nota local simples.");
            const newBoard = [...data.puzzleBoard];
            newBoard.splice(index, 1);
            
            existingUserData[vNum].puzzleBoard = newBoard;
            
            if (data.docId) {
                const docRef = doc(db, 'textosbiblicos', data.docId);
                updatePromises.push(updateDoc(docRef, { puzzleBoard: newBoard }));
            }
        }

        // Executa todas as atualiza√ß√µes na base de dados
        await Promise.all(updatePromises);

        // 3. Atualizar UI
        // Recalcula os picotados visuais na B√≠blia
        if (typeof window.refreshVisualHighlights === 'function') {
            window.refreshVisualHighlights();
        }

        // Se estivermos dentro do painel do trecho, recarregamos o contexto
        if (activeHighlightContext) {
            const safeText = encodeURIComponent(activeHighlightContext.text);
            const safeColor = encodeURIComponent(activeHighlightContext.color);
            // Simula o alvo para o evento
            const verseEl = document.getElementById(`vnum-${vNum}`)?.closest('.verse-item');
            
            setTimeout(() => {
                window.openHighlightDetails({stopPropagation:()=>{}, target: verseEl}, safeText, safeColor);
            }, 50);
        } else {
            // Modo vers√≠culo normal
            window.openModalForVerse(vNum);
        }

    } catch (e) {
        console.error("Erro ao apagar globalmente:", e);
        alert("Erro ao apagar nota: " + e.message);
    }
};

        // 3. Abrir Modal de Edi√ß√£o
window.openEditCard = (vNum, index) => {
    const data = existingUserData[vNum];
    if (!data || !data.puzzleBoard[index]) return;

    const item = data.puzzleBoard[index];
    const rawSnippet = decodeURIComponent(item.snippet || "");
    const parser = new DOMParser();
    const docHTML = parser.parseFromString(rawSnippet, 'text/html');
    
    // T√≠tulo
    let title = "";
    const titleInput = docHTML.querySelector('.mini-note-title-input');
    const h2 = docHTML.querySelector('h2');
    if (titleInput) title = titleInput.value || titleInput.getAttribute('value') || "";
    else if (h2) title = h2.textContent;

    // Conte√∫do
    let content = "";
    const contentDiv = docHTML.querySelector('.mini-note-content');
    if (contentDiv) content = contentDiv.innerHTML;

    // Dados Extra
    const wrapper = docHTML.querySelector('.mini-note-wrapper');
    if (wrapper) {
        try { currentFlashTopics = JSON.parse(wrapper.getAttribute('data-topics') || '{}'); } catch(e) {}
        try { currentFlashLinks = JSON.parse(wrapper.getAttribute('data-box-links') || '{}'); } catch(e) {}
    }

    // --- CRUCIAL: CARREGAR A COR ATUAL ---
    // Se isto falhar, ao gravar a cor torna-se null e desaparece do picotado
    selectedColorHex = item.noteColor || item.cor || '#3498db'; 

    // Preenche UI
    document.getElementById('edit-card-title').value = title;
    document.getElementById('edit-card-content').innerHTML = content;
    document.getElementById('edit-card-index').value = index;
    document.getElementById('edit-card-verse').value = vNum;

    document.getElementById('edit-card-modal').style.display = 'flex';

    // Injeta seletor de cores
    setTimeout(() => {
        if (typeof window.injectColorPickerIntoEditModal === 'function') {
            window.injectColorPickerIntoEditModal();
        }
    }, 50);
};

        // 4. Gravar Edi√ß√£o
document.getElementById('btn-confirm-edit-card').onclick = async () => {
    const btn = document.getElementById('btn-confirm-edit-card');
    
    // Dados do formul√°rio
    const vNumOriginal = document.getElementById('edit-card-verse').value;
    const indexOriginal = parseInt(document.getElementById('edit-card-index').value);
    const newTitle = document.getElementById('edit-card-title').value;
    const newContent = document.getElementById('edit-card-content').innerHTML;

    // Acede aos dados do vers√≠culo onde clic√°mos
    const dataOriginal = existingUserData[vNumOriginal];
    if (!dataOriginal) return;

    btn.textContent = "A gravar em todos...";
    btn.disabled = true;

    try {
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // 1. Identificar a Nota Original
        const itemOriginal = dataOriginal.puzzleBoard[indexOriginal];
        
        // O "Elo de Liga√ß√£o" entre os vers√≠culos √© o noteId.
        // Se for uma nota antiga sem noteId, usamos o snippet como fallback (menos seguro, mas funcional)
        const targetNoteId = itemOriginal.noteId; 

        // 2. Preparar o Novo Snippet (HTML)
        // Precisamos reconstruir o HTML uma vez para aplicar em todas as inst√¢ncias
        let rawSnippet = decodeURIComponent(itemOriginal.snippet || "");
        const parser = new DOMParser();
        const docHTML = parser.parseFromString(rawSnippet, 'text/html');
        
        // Atualiza T√≠tulo e Conte√∫do no HTML
        const titleInput = docHTML.querySelector('.mini-note-title-input');
        if (titleInput) {
            titleInput.setAttribute('value', newTitle);
            titleInput.textContent = newTitle;
        }
        const contentDiv = docHTML.querySelector('.mini-note-content');
        if (contentDiv) {
            contentDiv.innerHTML = newContent;
        }
        // Atualiza atributos ocultos (T√≥picos/Links)
        const wrapper = docHTML.querySelector('.mini-note-wrapper');
        if (wrapper) {
            wrapper.setAttribute('data-topics', JSON.stringify(currentFlashTopics));
            wrapper.setAttribute('data-box-links', JSON.stringify(currentFlashLinks));
            
            // Atualiza a borda se mudou o tipo (Quest√£o/Subnota)
            if (currentFlashTopics && Object.keys(currentFlashTopics).length > 0) { 
                // L√≥gica opcional se quiser mudar cor baseada em t√≥picos, 
                // mas aqui mantemos o user selection:
            }
        }
        const newSnippet = encodeURIComponent(docHTML.body.innerHTML);


        // 3. CICLO DE ATUALIZA√á√ÉO GLOBAL (O Segredo)
        // Vamos percorrer TODOS os vers√≠culos carregados na mem√≥ria (existingUserData)
        // Se encontrarmos esta nota noutro vers√≠culo, atualizamos tamb√©m!
        
        const updatePromises = [];

        for (const [vKey, vData] of Object.entries(existingUserData)) {
            let hasChanges = false;
            
            // Percorre o puzzleBoard deste vers√≠culo
            const newBoard = vData.puzzleBoard.map(item => {
                // Verifica se √© a "mesma" nota (pelo ID ou, em √∫ltimo caso, comparando o snippet antigo)
                const isMatch = targetNoteId 
                    ? (item.noteId === targetNoteId) 
                    : (item.snippet === itemOriginal.snippet);

                if (isMatch) {
                    hasChanges = true;
                    return {
                        ...item,
                        noteName: newTitle,
                        snippet: newSnippet,
                        noteColor: selectedColorHex, // <--- APLICA A NOVA COR AQUI
                        // IMPORTANTE: Mantemos o 'highlightRef' original de cada item!
                        // O vers√≠culo 1 mant√©m o texto "A", o vers√≠culo 2 mant√©m o texto "B".
                        highlightRef: item.highlightRef 
                    };
                }
                return item;
            });

            if (hasChanges) {
                // Atualiza Cache Local
                existingUserData[vKey].puzzleBoard = newBoard;

                // Prepara Atualiza√ß√£o Firebase
                const docRef = doc(db, 'textosbiblicos', vData.docId);
                updatePromises.push(updateDoc(docRef, { puzzleBoard: newBoard }));
            }
        }

        // Executa todas as grava√ß√µes na base de dados em paralelo
        await Promise.all(updatePromises);

        
        // 4. FINALIZA√á√ÉO
        document.getElementById('edit-card-modal').style.display = 'none';

        // Atualiza visualmente TODOS os picotados na p√°gina
        if (typeof window.refreshVisualHighlights === 'function') {
            window.refreshVisualHighlights();
        }

        // Redirecionamento Inteligente
        if (activeHighlightContext) {
            // Atualiza o contexto com a nova cor para o cabe√ßalho ficar certo
            if (selectedColorHex) activeHighlightContext.color = selectedColorHex;
            
            const safeText = encodeURIComponent(activeHighlightContext.text);
            const safeColor = encodeURIComponent(activeHighlightContext.color);
            
            // Simula o evento para reabrir o painel
            // (Nota: Usamos vNumOriginal para localizar o elemento no DOM)
            const verseElement = document.getElementById(`vnum-${vNumOriginal}`)?.closest('.verse-item');
            const mockEvent = { stopPropagation: () => {}, target: verseElement };

            await window.openHighlightDetails(mockEvent, safeText, safeColor);

        } else {
            // Modo Geral
            window.openModalForVerse(vNumOriginal);
        }

    } catch (e) {
        console.error("Erro ao editar globalmente:", e);
        alert("Erro ao gravar altera√ß√µes em m√∫ltiplos vers√≠culos.");
    } finally {
        btn.textContent = "Gravar";
        btn.disabled = false;
        selectedColorHex = null; 
    }
};

// Fun√ß√£o Global de Confirma√ß√£o
        window.showConfirmation = (title, message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const msgEl = document.getElementById('confirm-message');
                const btnOk = document.getElementById('btn-ok-confirm');
                const btnCancel = document.getElementById('btn-cancel-confirm');

                titleEl.textContent = title;
                msgEl.textContent = message;
                modal.style.display = 'flex';

                // Limpar listeners antigos (Clonagem simples)
                const newOk = btnOk.cloneNode(true);
                const newCancel = btnCancel.cloneNode(true);
                btnOk.parentNode.replaceChild(newOk, btnOk);
                btnCancel.parentNode.replaceChild(newCancel, btnCancel);

                newOk.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };

                newCancel.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        };

        // 1. LISTENER DO BOT√ÉO üìã
document.getElementById('btn-flash-topics').addEventListener('click', () => {
    const modal = document.getElementById('flash-topics-modal');
    modal.style.display = 'flex';
    loadFlashTopicsList();
});

// 2. CARREGAR T√ìPICOS (Firebase)
async function loadFlashTopicsList() {
    const list = document.getElementById('flash-topics-list');
    list.innerHTML = '';
    
    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', currentUser.uid), 
            orderBy('nome')
        );
        const snapshot = await getDocs(q);

        snapshot.forEach(doc => {
            const topic = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.style.cssText = "padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center;";
            
            // Checkbox visual (se tem subt√≥picos selecionados ou o pr√≥prio t√≥pico)
            const isSelected = !!currentFlashTopics[topic.id];
            
            li.innerHTML = `
                <span style="margin-right: 10px;">${isSelected ? '‚úÖ' : '‚¨ú'}</span>
                <span>${topic.nome}</span>
            `;

            li.onclick = () => {
                activeTopicIdForFlash = topic.id;
                document.getElementById('flash-sub-title').textContent = `SUBT√ìPICOS: ${topic.nome}`;
                // Atualiza visual da sele√ß√£o na lista da esquerda
                renderFlashSubtopics(topic.id);
                loadFlashTopicsList(); // Recarrega para atualizar os vistos
            };

            // Se for o ativo, destaca
            if (activeTopicIdForFlash === topic.id) {
                li.style.backgroundColor = "rgba(255,255,255,0.1)";
            }

            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erro topics:", e);
        list.innerHTML = "Erro ao carregar.";
    }
}

// 3. CARREGAR SUBT√ìPICOS
async function renderFlashSubtopics(topicId) {
    const list = document.getElementById('flash-subtopics-list');
    list.innerHTML = '<div class="spinner"></div>';
    
    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const q = query(
            collection(db, 'subtopicos'), 
            where('topicId', '==', topicId),
            where('userId', '==', currentUser.uid),
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        if(snapshot.empty) {
            list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
            return;
        }

        // Recupera o array de subt√≥picos selecionados para este t√≥pico
        const selectedSubs = currentFlashTopics[topicId] || [];

        snapshot.forEach(doc => {
            const sub = { id: doc.id, ...doc.data() };
            const isChecked = selectedSubs.includes(sub.id);

            const li = document.createElement('li');
            li.style.cssText = "padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center;";
            
            li.innerHTML = `
                <input type="checkbox" ${isChecked ? 'checked' : ''} style="margin-right: 10px; cursor:pointer;">
                <span>${sub.nome}</span>
            `;
            
            // Clique na linha
            li.onclick = (e) => {
                if(e.target.tagName !== 'INPUT') {
                    const cb = li.querySelector('input');
                    cb.checked = !cb.checked;
                }
                const cb = li.querySelector('input');
                toggleFlashSubtopic(topicId, sub.id, cb.checked);
            };

            list.appendChild(li);
        });

    } catch (e) { console.error(e); }
}

// 4. L√ìGICA DE SELE√á√ÉO
function toggleFlashSubtopic(topicId, subId, isChecked) {
    if (!currentFlashTopics[topicId]) currentFlashTopics[topicId] = [];
    
    if (isChecked) {
        if (!currentFlashTopics[topicId].includes(subId)) {
            currentFlashTopics[topicId].push(subId);
        }
    } else {
        currentFlashTopics[topicId] = currentFlashTopics[topicId].filter(id => id !== subId);
        // Se ficar vazio, remove a chave do t√≥pico tamb√©m
        if (currentFlashTopics[topicId].length === 0) {
            delete currentFlashTopics[topicId];
        }
    }
}



// 2. FUN√á√ÉO DE ABERTURA
window.openFlashLinkManager = function() {
    const modal = document.getElementById('flash-links-modal');
    modal.style.display = 'flex';
    
    // 1. Limpeza visual
    document.getElementById('flash-urls-list').innerHTML = '';
    document.getElementById('flash-codex-rows-container').innerHTML = ''; 
    document.getElementById('flash-cat-selected').innerHTML = '';
    document.getElementById('flash-cat-results').innerHTML = '';
    
    // 2. Carrega T√≠tulo
    document.getElementById('flash-link-title').value = currentFlashLinks.title || "";

    // 3. Carrega Toggle B√≠blia
    const bibleToggle = document.getElementById('flash-bible-toggle');
    if (bibleToggle) {
        bibleToggle.checked = currentFlashLinks.bibleMode === true;
    }

    // 4. Carrega URLs
    if (currentFlashLinks.urls) {
        Object.values(currentFlashLinks.urls).forEach(url => window.addFlashUrlField(url));
    } else {
        window.addFlashUrlField(); 
    }

    // 5. Carrega Codex
    if (currentFlashLinks.codex && currentFlashLinks.codex.length > 0) {
        currentFlashLinks.codex.forEach(c => window.createFlashCodexRow(c));
    } else {
        window.createFlashCodexRow(); 
    }

    // --- NOVA L√ìGICA INTELIGENTE AQUI ---
    
    // Se a lista de categorias ainda n√£o existir, inicializa-a como array
    if (!currentFlashLinks.categories) currentFlashLinks.categories = [];

    // Verifica se o Vers√≠culo Atual j√° est√° na lista. Se n√£o estiver, ADICIONA-O.
    // Isto garante que ao abrir o gestor, v√™s logo o vers√≠culo de origem selecionado.
    const currentVerseName = activeVerseFullName; // Ex: "G√©nesis 1:1"
    const alreadyHasCurrent = currentFlashLinks.categories.some(c => c.name === currentVerseName);

    if (!alreadyHasCurrent) {
        // Nota: O ID aqui √© provis√≥rio se a nota for nova, mas o nome √© o que importa para a pesquisa
        currentFlashLinks.categories.unshift({ 
            id: activeVerseDocId || "new_temp_id", 
            name: currentVerseName, 
            type: "textobiblico" 
        });
    }

    // 6. Renderiza todas as Categorias (incluindo a que acab√°mos de adicionar)
    currentFlashLinks.categories.forEach(c => renderFlashCategoryChip(c));

    // Abre na primeira aba
    window.switchFlashLinkTab('refs');
};

// 3. FUN√á√ïES DE UI (ABAS E CAMPOS)
window.switchFlashLinkTab = (tab) => {
    document.querySelectorAll('.store-tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active'); // O bot√£o clicado fica ativo

    document.getElementById('flash-tab-refs').style.display = 'none';
    document.getElementById('flash-tab-codex').style.display = 'none';
    document.getElementById('flash-tab-cats').style.display = 'none';

    document.getElementById(`flash-tab-${tab}`).style.display = 'block';
};

window.addFlashUrlField = (val = "") => {
    const div = document.createElement('div');
    div.className = 'flash-url-row';
    div.innerHTML = `
        <input type="text" placeholder="https://..." value="${val}">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-urls-list').appendChild(div);
};

window.addFlashCodexField = (data = null) => {
    const div = document.createElement('div');
    div.className = 'flash-codex-row';
    // Simplificado para o modo flash (apenas S√©rie e P√°ginas)
    div.innerHTML = `
        <input type="text" class="serie" placeholder="Pub (ex: w24 05)" value="${data ? data.serie : ''}">
        <input type="text" class="pages" placeholder="P√°g/Par" value="${data ? data.total.split(', p√°g. ')[1] || '' : ''}" style="max-width:80px;">
        <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.getElementById('flash-codex-list').appendChild(div);
};

// 4. PESQUISA DE CATEGORIAS (B√çBLIA)
window.searchFlashCategories = async (text) => {
    if (text.length < 2) return;
    
    // Normaliza texto (Primeira letra mai√∫scula)
    const searchText = text.charAt(0).toUpperCase() + text.slice(1);
    
    const resDiv = document.getElementById('flash-cat-results');
    const isGlobal = document.getElementById('flash-bible-toggle').checked;
    
    resDiv.innerHTML = '<div style="padding:10px; color:#888;">A procurar...</div>';
    
    try {
        const { collection, query, where, getDocs, limit, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let q;
        let type = '';

        if (isGlobal) {
            // --- MODO LIGADO: PESQUISA VERS√çCULOS NA B√çBLIA ---
            // AUMENTAMOS O LIMIT PARA 300
            // Isto √© necess√°rio porque "G√©nesis 10" vem antes de "G√©nesis 1:" na base de dados.
            // Precisamos sacar muitos vers√≠culos para garantir que o Cap√≠tulo 1 vem no pacote.
            q = query(
                collection(db, "bible_verses_public"), 
                where("nome", ">=", searchText), 
                where("nome", "<=", searchText + '\uf8ff'),
                orderBy("nome"),
                limit(300) 
            );
            type = 'bible_public';
        } else {
            // --- MODO DESLIGADO: PESQUISA NOS T√ìPICOS ---
            q = query(
                collection(db, "topicos"),
                where("userId", "==", currentUser.uid),
                where("nome", ">=", searchText), 
                where("nome", "<=", searchText + '\uf8ff'),
                orderBy("nome"),
                limit(20)
            );
            type = 'topic';
        }

        const snap = await getDocs(q);
        resDiv.innerHTML = '';
        
        if (snap.empty) {
            resDiv.innerHTML = '<div style="padding:10px; color:#888;">Sem resultados.</div>';
            return;
        }

        // Converter para Array
        let resultsArray = [];
        snap.forEach(doc => {
            resultsArray.push({ id: doc.id, ...doc.data() });
        });

        // ORDENA√á√ÉO NATURAL (Corrige a ordem visualmente)
        // Agora que temos 300 resultados, o Cap√≠tulo 1 deve estar no meio deles.
        // Esta fun√ß√£o coloca o 1:1 antes do 10:1.
        resultsArray.sort((a, b) => {
            return a.nome.localeCompare(b.nome, undefined, { numeric: true, sensitivity: 'base' });
        });

        // Cortar para mostrar apenas os primeiros 15 (para a lista n√£o ficar gigante)
        const displayResults = resultsArray.slice(0, 15);

        // Renderizar
        displayResults.forEach(d => {
            const div = document.createElement('div');
            div.style.cssText = "padding:8px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center;";
            
            const icon = type === 'bible_public' ? 'üåç' : 'üè∑Ô∏è';
            
            // Destaque visual
            const nomeHtml = d.nome.replace(new RegExp(`(${text})`, 'gi'), '<span style="color:#e67e22; font-weight:bold;">$1</span>');

            div.innerHTML = `
                <span style="font-size:0.9rem;">${icon} ${nomeHtml}</span> 
                <button style="background:none; border:1px solid #2ecc71; color:#2ecc71; border-radius:50%; width:24px; height:24px; cursor:pointer; display:flex; align-items:center; justify-content:center;">+</button>
            `;
            
            div.onclick = () => {
                const catObj = { id: d.id, name: d.nome, type: type };
                renderFlashCategoryChip(catObj);
                
                if (!currentFlashLinks.categories) currentFlashLinks.categories = [];
                
                if (!currentFlashLinks.categories.some(c => c.name === d.nome)) {
                    currentFlashLinks.categories.push(catObj);
                }
                
                resDiv.innerHTML = '';
                document.getElementById('flash-cat-search').value = '';
                document.getElementById('flash-cat-search').focus();
            };
            resDiv.appendChild(div);
        });

    } catch(e) { 
        console.error(e); 
        resDiv.innerHTML = '<div style="padding:10px; color:#e74c3c;">Erro na pesquisa.</div>';
    }
};

function renderFlashCategoryChip(cat) {
    const container = document.getElementById('flash-cat-selected');
    const chip = document.createElement('div');
    chip.className = 'flash-cat-chip';
    chip.innerHTML = `${cat.name} √ó`;
    chip.onclick = () => {
        chip.remove();
        if(currentFlashLinks.categories) {
            currentFlashLinks.categories = currentFlashLinks.categories.filter(c => c.name !== cat.name);
        }
    };
    container.appendChild(chip);
}

// 5. GRAVAR DADOS DO MODAL NA VARI√ÅVEL GLOBAL
document.getElementById('btn-save-flash-links').onclick = () => {
    const title = document.getElementById('flash-link-title').value;
    const isBibleActive = document.getElementById('flash-bible-toggle').checked;
    
    // 1. Recolher URLs
    const urlsObj = {};
    document.querySelectorAll('#flash-urls-list input').forEach((inp, i) => {
        if(inp.value.trim()) urlsObj[`url_${i}`] = inp.value.trim();
    });

    // 2. Recolher Codex Complexo
    const codexArr = [];
    document.querySelectorAll('.codex-row').forEach(row => {
        const serie = row.querySelector('.serie-main').value.trim();
        if (serie) {
            // Coleta p√≠lulas de p√°ginas e par√°grafos
            const paginas = Array.from(row.querySelectorAll('.pages-container input')).map(i => i.value.trim()).filter(v => v);
            const paragrafos = Array.from(row.querySelectorAll('.paragraphs-container input')).map(i => i.value.trim()).filter(v => v);
            
            // Coleta manuais
            const manA = row.querySelector('.manual-year')?.value;
            const manM = row.querySelector('.manual-month')?.value;
            const manC = row.querySelector('.manual-chapter')?.value;
            const manT = row.querySelector('.manual-time')?.value;

            // Constroi string de exibi√ß√£o (Total)
            let total = serie;
            if (manA) total += ` ${manA}`;
            if (manC) total += `, Cap ${manC}`;
            if (paginas.length) total += `, p√°g. ${paginas.join(',')}`;

            codexArr.push({
                serie: serie,
                paginas: paginas,
                paragrafos: paragrafos,
                manualYear: manA,
                manualMonth: manM,
                capitulo: manC,
                tempo: manT,
                total: total,
                type: 'codex'
            });
        }
    });

    // 3. Atualiza Global
    currentFlashLinks.title = title;
    currentFlashLinks.urls = urlsObj;
    currentFlashLinks.codex = codexArr;
    currentFlashLinks.bibleMode = isBibleActive; // Salva o estado do bot√£o
    // (Categorias j√° est√£o salvas no array)

    document.getElementById('flash-links-modal').style.display = 'none';
    
    // Feedback visual
    const btn = document.getElementById('btn-flash-links');
    const hasData = Object.keys(urlsObj).length > 0 || codexArr.length > 0 || (currentFlashLinks.categories && currentFlashLinks.categories.length > 0);
    
    if (hasData) {
        btn.style.color = "#f1c40f"; btn.style.borderColor = "#f1c40f";
    } else {
        btn.style.color = ""; btn.style.borderColor = "";
    }
};

// Cria uma linha completa do Codex (igual ao note.html)
window.createFlashCodexRow = function(data = null) {
    const container = document.getElementById('flash-codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    // HTML Complexo da Linha
    row.innerHTML = `
        <button class="remove-codex-row" onclick="this.parentElement.remove()">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
            </div>
            <div class="manual-controls">
                <label class="codex-label">OP√á√ïES</label>
                <div style="display:flex; gap:2px;">
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'A')" title="Ano">A</button>
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'M')" title="M√™s">M</button>
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'T')" title="Tempo">T</button>
                    <button class="btn-control-small" onclick="window.toggleFlashManual(this, 'C')" title="Cap√≠tulo">C</button>
                </div>
            </div>
        </div>
        <div class="manual-inputs-area"></div> 
        <div class="codex-content-grid">
            <div>
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container" style="display:flex; flex-wrap:wrap; align-items:center;">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div>
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container" style="display:flex; flex-wrap:wrap; align-items:center;">
                    <button class="btn-unit-add" onclick="window.addFlashCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;

    container.appendChild(row);

    // Se estivermos a editar (carregar dados existentes)
    if (data) {
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        
        if (data.paginas) data.paginas.forEach(p => window.addFlashCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addFlashCodexUnit(pgContainer, 'Par', p));
        
        // Ativar bot√µes manuais se existirem dados
        if (data.manualYear) window.toggleFlashManual(row.querySelector("button[onclick*='A']"), 'A', data.manualYear);
        if (data.manualMonth) window.toggleFlashManual(row.querySelector("button[onclick*='M']"), 'M', data.manualMonth);
        if (data.capitulo) window.toggleFlashManual(row.querySelector("button[onclick*='C']"), 'C', data.capitulo);
        if (data.tempo) window.toggleFlashManual(row.querySelector("button[onclick*='T']"), 'T', data.tempo);
    } else {
        // Se for novo, adiciona uma p√≠lula vazia para facilitar
        window.addFlashCodexUnit(row.querySelector('.pages-container'), 'P√°g');
    }
};

// Adiciona uma "P√≠lula" (Pagina ou Par√°grafo)
window.addFlashCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    // Insere antes do bot√£o "+"
    container.insertBefore(unit, container.lastChild);
};

// Gere os bot√µes de toggle (A, M, T, C)
window.toggleFlashManual = function(btn, type, val = '') {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    
    // Se j√° tiver a classe active, estamos a remover (exceto se for load inicial com valor)
    if (btn.classList.contains('active') && !val) {
        const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));
        const el = area.querySelector(selector)?.closest('.manual-field-group');
        if (el) el.remove();
        btn.classList.remove('active');
        return;
    }

    btn.classList.add('active');
    
    // Evita duplicados no load
    const existingClass = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));
    if (area.querySelector(existingClass)) return;

    const group = document.createElement('div');
    group.className = 'manual-field-group';

    if (type === 'A') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-year" placeholder="Ano" value="${val}" style="width:40px;">`;
    } else if (type === 'M') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-month" placeholder="M√™s" value="${val}" style="width:40px;">`;
    } else if (type === 'C') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-chapter" placeholder="Cap." value="${val}" style="width:40px;">`;
    } else if (type === 'T') {
        // Simplificado para texto livre no tempo
        group.classList.add('manual-time-group');
        group.innerHTML = `<input type="text" class="codex-input-manual manual-time" placeholder="00:00" value="${val}" style="width:50px;">`;
    }

    group.innerHTML += `<button class="btn-close-manual" onclick="window.closeFlashManual(this, '${type}')">√ó</button>`;
    area.appendChild(group);
};

window.closeFlashManual = function(closeBtn, type) {
    const row = closeBtn.closest('.codex-row');
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if(toggleBtn) toggleBtn.classList.remove('active');
    closeBtn.parentElement.remove();
};

// --- 1. FUN√á√ÉO QUE GERA O FORMUL√ÅRIO (HTML STRING) ---
// Isto permite usar o mesmo formul√°rio no Modal e na Sidebar
// Mapa de Cores para Destaque (Trechos)
const highlightColors = {
    'none':   { label: 'Sem Cor', hex: 'transparent' },
    'orange': { label: 'Laranja', hex: '#e67e22' },
    'yellow': { label: 'Amarelo', hex: '#f1c40f' },
    'blue':   { label: 'Azul',    hex: '#3498db' },
    'green':  { label: 'Verde',   hex: '#2ecc71' },
    'lilac':  { label: 'Lil√°s',   hex: '#9b59b6' },
    'pink':   { label: 'Rosa',    hex: '#ff7979' },
    'salmon': { label: 'Salm√£o',  hex: '#ffbe76' },
    'brown':  { label: 'Castanho',hex: '#8d6e63' },
    'grey':   { label: 'Cinzento',hex: '#95a5a6' }
};

// Fun√ß√£o auxiliar para atualizar a bolinha de cor (pr√©-visualiza√ß√£o)
window.updateColorPreview = (select) => {
    const colorKey = select.value;
    const dot = document.getElementById('color-preview-dot');
    if(dot && highlightColors[colorKey]) {
        dot.style.backgroundColor = highlightColors[colorKey].hex;
        // Se for "Sem Cor", pomos uma borda para se ver, sen√£o tira-se a borda
        dot.style.border = colorKey === 'none' ? '1px solid #555' : 'none';
    }
};

window.getFlashFormHTML = (customLabel = null) => {
    // Se passarmos um r√≥tulo personalizado (intervalo), usa esse.
    // Sen√£o, usa o nome do vers√≠culo ativo padr√£o.
    const displayLabel = customLabel || activeVerseFullName;

    return `
        <div style="padding: 10px;">
            <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
            
            <div class="flash-toolbar">
                <button onclick="document.execCommand('bold')"><b>B</b></button>
                <button onclick="document.execCommand('italic')"><i>I</i></button>
                <button onclick="document.execCommand('underline')"><u>U</u></button>
                
                <button id="btn-flash-topics" onclick="window.openTopicsModal()" title="T√≥picos">üìã</button>
                <button id="btn-flash-links" onclick="window.openFlashLinkManager()" title="Links">‚ö°</button>

                <select id="flash-type-select" onchange="window.changeFlashBorder(this)">
                    <option value="default">üìò Subnota</option>
                    <option value="question">üìó Quest√£o</option>
                </select>
            </div>

            <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
            
            <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                üîó Anexado a: <span id="flash-attached-verse" style="color: #3498db;">${displayLabel}</span>
            </div>

            <button onclick="window.saveFlashNoteGlobal()" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR NOTA</button>
        </div>
    `;
};

// --- 2. GEST√ÉO DE CLIQUES E NAVEGA√á√ÉO ---

// Quando clica em "+ Adicionar Nota"
window.handleCreateNoteClick = () => {
    // 1. Defini√ß√£o do Modo (Com ou Sem Cor)
    // S√≥ mostramos cores se houver um contexto de trecho ativo OU se houver texto selecionado (barra flutuante)
    const shouldShowColors = (activeHighlightContext !== null) || (currentSelectionText && currentSelectionText.trim() !== "");

    // 2. Limpa os campos visuais
    document.getElementById('flash-title').value = "";
    document.getElementById('flash-editor').innerHTML = "";
    
    // 3. Reset das vari√°veis de dados
    currentFlashTopics = {}; 
    currentFlashLinks = {};
    activeTopicIdForFlash = null;
    
    // Reset do dropdown para o padr√£o
    const typeSelect = document.getElementById('flash-type-select');
    if(typeSelect) typeSelect.value = "default";

    // Reset visual da toolbar
    const btnLink = document.getElementById('btn-flash-links');
    if(btnLink) { 
        btnLink.style.color = ""; 
        btnLink.style.borderColor = ""; 
    }

    // 4. L√≥gica do R√≥tulo "Anexado a"
    let labelParaMostrar = activeVerseFullName; // Padr√£o

    if (activeHighlightContext && activeHighlightContext.text) {
        labelParaMostrar = `Trecho: "${activeHighlightContext.text.substring(0, 25)}..."`;
    } 
    else if (currentSelectionVerses && currentSelectionVerses.length > 1) {
        const primeiro = currentSelectionVerses[0];
        const ultimo = currentSelectionVerses[currentSelectionVerses.length - 1];
        let numFinal = ultimo.includes(':') ? ultimo.split(':')[1] : ultimo.split(' ').pop();
        labelParaMostrar = `${primeiro} ‚ûù ${numFinal}`;
    }

    // 5. Renderiza√ß√£o (PC vs Mobile)
    if (window.innerWidth >= 768) {
        const sidePanel = document.getElementById('side-panel');
        const contentDiv = document.getElementById('sidebar-content');
        const backBtn = document.getElementById('sidebar-back-btn');
        const centerBtn = document.getElementById('sidebar-center-actions');
        const titleEl = document.getElementById('sidebar-verse-title');

        if (sidePanel) sidePanel.classList.add('open'); 
        if(backBtn) backBtn.style.display = 'block';     
        if(centerBtn) centerBtn.style.display = 'none';  
        if(titleEl) titleEl.innerText = "Nova Nota";     
        
        contentDiv.innerHTML = window.getFlashFormHTML(labelParaMostrar);
    } else {
        const modal = document.getElementById('flash-note-modal');
        const modalBody = modal.querySelector('.details-body');
        modalBody.innerHTML = window.getFlashFormHTML(labelParaMostrar);
        modal.style.display = 'flex';
    }

    // 6. INJE√á√ÉO CONDICIONAL DE CORES E FOCO
    setTimeout(() => {
        // --- AQUI EST√Å A MUDAN√áA: S√≥ injeta se for um Trecho ---
        if (shouldShowColors && typeof window.injectColorPickerIntoForm === 'function') {
            window.injectColorPickerIntoForm();
        }
        // -------------------------------------------------------

        const input = document.getElementById('flash-title');
        if(input) input.focus();
    }, 100);
};

// Quando clica na Seta "Voltar" (PC)
window.returnToVerseDetails = () => {
    // Extrai o n√∫mero do vers√≠culo da string global (ex: "G√©nesis 1:1" -> "1")
    const vNum = activeVerseFullName.split(':')[1].trim().split('-')[0];

    // Refer√™ncias aos elementos da Sidebar (PC)
    const contentDiv = document.getElementById('sidebar-content');
    const titleEl = document.getElementById('sidebar-verse-title');
    const centerActions = document.getElementById('sidebar-center-actions');
    const backBtn = document.getElementById('sidebar-back-btn');

    // Esconde o bot√£o de voltar, pois cheg√°mos √† vista principal (seja do Trecho ou do Vers√≠culo)
    if (backBtn) backBtn.style.display = 'none';

    // --- L√ìGICA DE DECIS√ÉO: TRECHO OU VERS√çCULO GERAL? ---
    if (activeHighlightContext) {
        // === CASO A: VOLTAR PARA O PAINEL DO TRECHO (HIGHLIGHT) ===
        
        const { text, color } = activeHighlightContext;
        const encodedText = encodeURIComponent(text);
        const encodedColor = encodeURIComponent(color);

        // 1. Define o T√≠tulo com o sublinhado colorido
        if (titleEl) titleEl.innerHTML = `<span style="border-bottom: 3px dotted ${color}">${text}</span>`;

        // 2. Restaura o Bot√£o Personalizado (Colorido) no Topo
        if (centerActions) {
            centerActions.style.display = 'block';
            centerActions.innerHTML = `
                <button id="btn-custom-highlight" 
                        onclick="window.openFlashForHighlight('${encodedText}', '${encodedColor}')" 
                        style="background: ${color}; color: #fff; font-weight: bold; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; box-shadow: 0 0 10px ${color}66; white-space: nowrap; font-size: 0.85rem;">
                    + Nota no Trecho
                </button>
            `;
        }

        // 3. Renderiza apenas as notas deste trecho espec√≠fico
        if (contentDiv) {
            contentDiv.innerHTML = '<div class="spinner"></div>';
            
            const data = existingUserData[vNum];
            // Filtra notas que pertencem a este trecho
            const relatedNotes = (data && data.puzzleBoard) 
                ? data.puzzleBoard.filter(item => item.highlightRef === text) 
                : [];
            
            // Usa a fun√ß√£o auxiliar para desenhar os cards
            renderHighlightContent(contentDiv, relatedNotes, color);
        }

    } else {
        // === CASO B: VOLTAR PARA O PAINEL GERAL DO VERS√çCULO ===
        
        // 1. Define o T√≠tulo Padr√£o (Nome do Vers√≠culo)
        if (titleEl) titleEl.innerText = activeVerseFullName;

        // 2. Restaura o Bot√£o Padr√£o (Laranja) no Topo
        if (centerActions) {
            centerActions.style.display = 'block';
            centerActions.innerHTML = `
                <button class="btn-create-note" onclick="window.handleCreateNoteClick()" style="margin: 0;">
                    + Adicionar Nota
                </button>
            `;
        }

        // 3. Renderiza todas as notas do vers√≠culo (Puzzle, Dossier, Links)
        if (contentDiv) {
            const data = existingUserData[vNum];
            // Usa a fun√ß√£o padr√£o que constr√≥i todo o conte√∫do do vers√≠culo
            contentDiv.innerHTML = buildVerseHTML(data, vNum);
        }
    }
};

// Fun√ß√µes wrapper para os bot√µes da toolbar (para funcionarem no innerHTML)
window.openTopicsModal = () => {
    document.getElementById('flash-topics-modal').style.display = 'flex';
    loadFlashTopicsList();
};

// Fun√ß√£o visual para mudar a cor da borda
window.changeFlashBorder = (selectElement) => {
    const editor = document.getElementById('flash-editor');
    const val = selectElement.value;

    if (val === 'question') {
        editor.style.borderColor = '#2ecc71'; // Verde (Quest√£o)
    } else {
        editor.style.borderColor = '#3498db'; // Azul Claro (Subnota)
    }
};


// --- 1. DETECTAR SELE√á√ÉO DE TEXTO ---
document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const toolbar = document.getElementById('selection-toolbar');

    // Se n√£o houver texto ou a sele√ß√£o estiver vazia
    if (!selection.rangeCount || selection.isCollapsed) {
        toolbar.style.display = 'none';
        return;
    }

    const text = selection.toString().trim();
    if (text.length > 0) {
        // Guarda o texto
        currentSelectionText = text;

        // Calcula posi√ß√£o da barra flutuante
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        // Posiciona a barra logo acima da sele√ß√£o
        toolbar.style.top = `${window.scrollY + rect.top - 50}px`;
        // Centraliza horizontalmente (com limites de ecr√£)
        let leftPos = rect.left + (rect.width / 2) - 60; 
        if (leftPos < 10) leftPos = 10;
        toolbar.style.left = `${leftPos}px`;
        toolbar.style.display = 'flex';

        // Identifica os vers√≠culos envolvidos
        identifyVersesInSelection(range);
    }
});

// Fun√ß√£o para descobrir quais vers√≠culos foram tocados pela sele√ß√£o
function identifyVersesInSelection(range) {
    currentSelectionVerses = [];
    
    // Procura todos os elementos de vers√≠culo (.verse-item)
    const allVerses = document.querySelectorAll('.verse-item');
    
    allVerses.forEach(div => {
        // Verifica se a sele√ß√£o intersecta com este vers√≠culo
        if (selectionIntersectsNode(range, div)) {
            const numSpan = div.querySelector('.verse-number');
            if (numSpan) {
                const vNum = numSpan.innerText;
                const verseFullName = `${selectedBook.nome} ${selectedChapter}:${vNum}`;
                currentSelectionVerses.push(verseFullName);
            }
        }
    });
}

// Auxiliar: Verifica interse√ß√£o
function selectionIntersectsNode(range, node) {
    const nodeRange = document.createRange();
    nodeRange.selectNode(node);
    return range.compareBoundaryPoints(Range.END_TO_START, nodeRange) < 0 &&
           range.compareBoundaryPoints(Range.START_TO_END, nodeRange) > 0;
}

// --- 2. BOT√ïES DA BARRA FLUTUANTE ---

// Bot√£o Copiar
document.getElementById('btn-copy-selection').addEventListener('click', () => {
    navigator.clipboard.writeText(currentSelectionText).then(() => {
        const btn = document.getElementById('btn-copy-selection');
        const original = btn.innerText;
        btn.innerText = "‚úÖ";
        setTimeout(() => { 
            btn.innerText = original; 
            document.getElementById('selection-toolbar').style.display = 'none';
            window.getSelection().removeAllRanges();
        }, 1000);
    });
});

// Bot√£o Criar Nota Flash (Modificado)
// --- DIAGN√ìSTICO: Bot√£o Criar Nota Flash ---
const btnFlashSelection = document.getElementById('btn-note-selection');
if (btnFlashSelection) {
    btnFlashSelection.addEventListener('click', () => {
        // Define o contexto necess√°rio
        if (currentSelectionVerses && currentSelectionVerses.length > 0) {
            activeVerseFullName = currentSelectionVerses[0];
        }
        
        // Abre a janela (a fun√ß√£o handleCreateNoteClick vai detetar que currentSelectionText existe e injetar√° as cores)
        window.handleCreateNoteClick();
        
        // Esconde a barra
        const toolbar = document.getElementById('selection-toolbar');
        if (toolbar) toolbar.style.display = 'none';
    });
}

window.injectColorPickerIntoForm = () => {
    const editor = document.getElementById('flash-editor');
    if (!editor) return;

    // Evita duplicar se j√° existir
    if (document.querySelector('.color-picker-container')) return;

    const colors = [
        { name: 'Laranja', hex: '#e67e22' },
        { name: 'Amarelo', hex: '#f1c40f' },
        { name: 'Azul', hex: '#3498db' },
        { name: 'Verde', hex: '#2ecc71' },
        { name: 'Lil√°s', hex: '#9b59b6' },
        { name: 'Rosa', hex: '#ff7979' },
        { name: 'Salm√£o', hex: '#ffb8b8' },
        { name: 'Castanho', hex: '#a0522d' },
        { name: 'Cinzento', hex: '#95a5a6' }
    ];

    const container = document.createElement('div');
    container.className = 'color-picker-container';
    
    // Estilos ajustados para a posi√ß√£o inferior
    container.style.marginTop = "15px";     // Espa√ßo entre o editor e as cores
    container.style.marginBottom = "10px";  // Espa√ßo entre as cores e o "Anexado a"
    container.style.display = "flex";
    container.style.gap = "8px";
    container.style.overflowX = "auto";
    container.style.padding = "5px 2px";
    
    // Cria os bot√µes de cor
    colors.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.hex;
        btn.title = c.name;
        
        // Marca a cor selecionada (se houver)
        if (selectedColorHex && selectedColorHex.toLowerCase() === c.hex.toLowerCase()) {
            btn.classList.add('selected');
        }

        btn.onclick = () => {
            container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedColorHex = c.hex;
        };
        container.appendChild(btn);
    });

    // --- ALTERA√á√ÉO DA POSI√á√ÉO ---
    // Insere DEPOIS do editor (inserindo antes do elemento seguinte ao editor)
    if (editor.nextElementSibling) {
        editor.parentElement.insertBefore(container, editor.nextElementSibling);
    } else {
        editor.parentElement.appendChild(container);
    }
};


async function loadHighlightsForChapter(bookName, chapter) {
    const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    try {
        const q = query(
            collection(db, "trechosbiblicos"),
            where("userId", "==", currentUser.uid)
        );

        const snapshot = await getDocs(q);
        
        // Mapa tempor√°rio para agrupar cores por texto
        // Chave: "Texto do Trecho", Valor: Set de Cores (para evitar repetidas)
        const tempMap = {};
        
        const prefixoCapitulo = `${bookName} ${chapter}:`;

        snapshot.forEach(doc => {
            const data = doc.data();
            // Verifica se pertence a este cap√≠tulo
            if (data.textosbiblicos && data.textosbiblicos.some(v => v.startsWith(prefixoCapitulo))) {
                const texto = data.nome;
                const cor = data.cor;

                if (!tempMap[texto]) {
                    tempMap[texto] = new Set();
                }
                tempMap[texto].add(cor);
            }
        });

        // Converte o Mapa para o formato final Array
        currentChapterHighlights = Object.keys(tempMap).map(texto => ({
            texto: texto,
            colors: Array.from(tempMap[texto]) // Ex: ['#e67e22', '#3498db']
        }));

        // Aplica as altera√ß√µes
        applyCachedHighlightsGlobally();

    } catch (e) {
        console.error("Erro highlights:", e);
    }
}


// Fun√ß√£o que aplica o CSS no texto HTML
function applyCachedHighlightsToElement(spanElement) {
    if (!spanElement || currentChapterHighlights.length === 0) return;

    let htmlContent = spanElement.innerHTML;
    let hasChanges = false;

    currentChapterHighlights.forEach(highlight => {
        // Verifica se o texto existe e evita duplicados de processamento
        // (S√≥ aplica se ainda n√£o tiver a classe highlight-picotado)
        if (htmlContent.includes(highlight.texto) && !htmlContent.includes(`data-highlight-ref="${highlight.texto}"`)) {
            
            const safeText = encodeURIComponent(highlight.texto);
            // Cor principal para passar ao modal (a √∫ltima cor adicionada ou a primeira)
            const mainColor = highlight.colors[highlight.colors.length - 1]; 
            const safeColor = encodeURIComponent(mainColor);

            let styleString = "";

            if (highlight.colors.length === 1) {
                // --- 1 COR: Picotado Simples ---
                // background-image √© mais fi√°vel para controlar o tamanho dos pontos do que border-dotted
                styleString = `
                    background-image: linear-gradient(to right, ${mainColor} 50%, transparent 50%);
                    background-position: bottom;
                    background-size: 6px 3px; /* 3px tra√ßo, 3px espa√ßo */
                    background-repeat: repeat-x;
                    padding-bottom: 3px;
                    text-decoration: none;
                `;
            } else {
                // --- M√öLTIPLAS CORES (PONTO 3) ---
                // Desenha 2 tra√ßos de cada cor sequencialmente
                
                let gradientParts = [];
                let currentPos = 0;
                
                const dotWidth = 5;   // Largura do tra√ßo (px)
                const gapWidth = 3;   // Largura do espa√ßo (px)
                
                highlight.colors.forEach(color => {
                    // 2 tra√ßos desta cor
                    for (let i = 0; i < 2; i++) {
                        // Tra√ßo
                        gradientParts.push(`${color} ${currentPos}px ${currentPos + dotWidth}px`);
                        currentPos += dotWidth;
                        // Espa√ßo Transparente
                        gradientParts.push(`transparent ${currentPos}px ${currentPos + gapWidth}px`);
                        currentPos += gapWidth;
                    }
                });

                // O gradiente repete-se para cobrir todo o texto
                const gradString = gradientParts.join(', ');
                
                styleString = `
                    background-image: repeating-linear-gradient(to right, ${gradString});
                    background-position: bottom;
                    background-size: ${currentPos}px 3px; /* A largura total do padr√£o */
                    background-repeat: repeat-x;
                    padding-bottom: 3px;
                    text-decoration: none;
                `;
            }

            // Remove sublinhados nativos se existirem
            const highlightedHTML = `<span class="highlight-picotado" 
                data-highlight-ref="${highlight.texto}"
                onclick="window.openHighlightDetails(event, '${safeText}', '${safeColor}')"
                style="${styleString} cursor: pointer; display: inline; border-bottom: none;">${highlight.texto}</span>`;
            
            // Substitui√ß√£o global segura
            htmlContent = htmlContent.split(highlight.texto).join(highlightedHTML);
            hasChanges = true;
        }
    });

    if (hasChanges) {
        spanElement.innerHTML = htmlContent;
    }
}

// Aplica a tudo (usado quando os destaques carregam DEPOIS do texto)
function applyCachedHighlightsGlobally() {
    const allSpans = document.querySelectorAll('.verse-text');
    allSpans.forEach(span => applyCachedHighlightsToElement(span));
}

// Mantemos esta para compatibilidade com o saveFlashNoteGlobal (para feedback instant√¢neo)
window.applyHighlightToUI = (text, color) => {
    // Adiciona ao cache local para persistir se navegarmos
    currentChapterHighlights.push({ texto: text, cor: color });
    applyCachedHighlightsGlobally();
};


window.applyHighlightToUI = (textToHighlight, colorHex) => {
    if (!textToHighlight) return;

    // Codifica os textos para n√£o quebrar o HTML do onclick
    const safeText = encodeURIComponent(textToHighlight);
    const safeColor = encodeURIComponent(colorHex);

    // Seleciona todos os contentores de texto de vers√≠culos
    const verseElements = document.querySelectorAll('.verse-text');
    
    verseElements.forEach(span => {
        const originalHTML = span.innerHTML;
        const originalText = span.innerText;

        // Verifica se o texto do vers√≠culo cont√©m o trecho selecionado
        if (originalText.includes(textToHighlight)) {
            
            // Verifica se j√° n√£o est√° destacado para evitar duplicados
            // (Verifica se j√° existe a classe E o texto espec√≠fico)
            if (originalHTML.includes('highlight-picotado') && originalHTML.includes(`>${textToHighlight}<`)) {
                return; 
            }

            // CRIA O HTML DO DESTAQUE COM O ONCLICK (CORRE√á√ÉO AQUI)
            const highlightedHTML = `<span class="highlight-picotado" 
                onclick="window.openHighlightDetails(event, '${safeText}', '${safeColor}')"
                style="border-bottom: 3px dotted ${colorHex}; padding-bottom: 1px;">${textToHighlight}</span>`;
            
            // Substitui o texto pelo HTML destacado
            span.innerHTML = originalHTML.split(textToHighlight).join(highlightedHTML);
        }
    });
};

 window.openHighlightDetails = async (event, encodedText, encodedColor) => {
    if(event && event.stopPropagation) event.stopPropagation(); 

    const rawPartialText = decodeURIComponent(encodedText);
    let fullText = rawPartialText.trim();
    let displayColor = decodeURIComponent(encodedColor); 

    // Identificar vers√≠culo (igual ao anterior)
    let verseRow = event.target ? event.target.closest('.verse-item') : null;
    if (!verseRow) {
        const vNum = activeVerseFullName.split(':')[1].trim().split('-')[0];
        const el = document.getElementById(`vnum-${vNum}`);
        if(el) verseRow = el.closest('.verse-item');
    }
    if(!verseRow) return;

    const currentVerseNum = verseRow.querySelector('.verse-number').innerText.trim();
    const fullVerseName = `${selectedBook.nome} ${selectedChapter}:${currentVerseNum}`;

    let contentDiv, titleEl, centerActions;

    // --- HTML DO BOT√ÉO COLORIDO (Placeholder de Loading) ---
    // Nota: Usamos display:inline-block e white-space:nowrap para n√£o quebrar
    const loadingBtnHtml = `
        <button id="btn-custom-highlight" style="background: ${displayColor}; opacity: 0.7; color: #fff; border: none; padding: 6px 12px; border-radius: 20px; font-weight: bold; white-space: nowrap;">
            Carregando...
        </button>`;

    if (window.innerWidth >= 768) {
        // DESKTOP
        document.getElementById('side-panel').classList.add('open');
        contentDiv = document.getElementById('sidebar-content');
        titleEl = document.getElementById('sidebar-verse-title');
        centerActions = document.getElementById('sidebar-center-actions');
        document.getElementById('sidebar-back-btn').style.display = 'none';
        
        if (centerActions) { 
            centerActions.style.display = 'block'; // IMPORTANTE
            centerActions.innerHTML = loadingBtnHtml; 
        }
    } else {
        // MOBILE
        const modal = document.getElementById('verse-details-modal');
        modal.style.display = 'flex';
        contentDiv = document.getElementById('details-content');
        titleEl = document.getElementById('modal-verse-title');
        
        // 1. Esconde bot√£o padr√£o
        const defBtn = document.getElementById('btn-add-flash-note');
        if(defBtn) defBtn.style.display = 'none';

        // 2. Remove bot√£o custom antigo e insere o novo loading
        let existingBtn = document.getElementById('btn-custom-highlight');
        if(existingBtn) existingBtn.remove();
        
        // Inserir ao lado do t√≠tulo ou onde estava o bot√£o padr√£o
        if(defBtn) {
            defBtn.insertAdjacentHTML('afterend', loadingBtnHtml);
        }
    }

    titleEl.innerHTML = "A pesquisar...";
    contentDiv.innerHTML = '<div class="spinner-container" style="padding:40px; text-align:center;"><div class="spinner"></div></div>';

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // --- L√≥gica de Unifica√ß√£o (Igual √† anterior) ---
        const qMaster = query(
            collection(db, 'trechosbiblicos'),
            where('userId', '==', currentUser.uid),
            where('textosbiblicos', 'array-contains', fullVerseName)
        );
        
        const snapMaster = await getDocs(qMaster);
        let masterDoc = null;
        snapMaster.forEach(doc => {
            const data = doc.data();
            if (data.nome && data.nome.includes(rawPartialText)) {
                masterDoc = { ...data, id: doc.id };
            }
        });

        if (masterDoc) {
            fullText = masterDoc.nome;
            displayColor = masterDoc.cor || displayColor;
        }

        activeHighlightContext = { text: fullText, color: displayColor };

        // --- ATUALIZAR UI FINAL ---
        
        titleEl.innerHTML = `<span style="border-bottom: 3px dotted ${displayColor}; line-height:1.4;">${fullText}</span>`;
        
        const finalBtnHtml = `
            <button id="btn-custom-highlight" 
                    onclick="window.openFlashForHighlight('${encodeURIComponent(fullText)}', '${encodeURIComponent(displayColor)}')" 
                    style="background: ${displayColor}; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.2); white-space: nowrap; font-size: 0.85rem;">
                + Nota no Trecho
            </button>
        `;

        if (window.innerWidth >= 768 && centerActions) {
            centerActions.innerHTML = finalBtnHtml;
        } 
        else if (window.innerWidth < 768) {
             const loader = document.getElementById('btn-custom-highlight');
             if(loader) loader.outerHTML = finalBtnHtml;
        }

        // --- Renderiza√ß√£o das Notas (L√≥gica Unificada) ---
        let finalNotes = [];
        let seenNoteIds = new Set(); 

        if (masterDoc && masterDoc.noteIds && masterDoc.noteIds.length > 0) {
            const vData = existingUserData[currentVerseNum];
            if (vData && vData.puzzleBoard) {
                vData.puzzleBoard.forEach((item, idx) => {
                    if (masterDoc.noteIds.includes(item.noteId)) {
                        if (!seenNoteIds.has(item.noteId)) {
                            seenNoteIds.add(item.noteId);
                            finalNotes.push({ ...item, originalIndex: idx, sourceVerse: currentVerseNum });
                        }
                    }
                });
            }
        }

        renderHighlightContentConsolidated(contentDiv, finalNotes, displayColor);

    } catch (e) {
        console.error(e);
        contentDiv.innerHTML = `<div style="color:red; padding:20px;">Erro: ${e.message}</div>`;
    }
};

// Nova Fun√ß√£o de Renderiza√ß√£o Consolidada (necess√°ria para lidar com o sourceVerse)
function renderHighlightContentConsolidated(container, notes, contextColor) {
    let html = "";
    if (notes.length === 0) {
        html += `<div style="color:#888; font-style:italic; text-align:center; padding: 40px 20px;">
                    Nenhuma nota encontrada.<br><small>(Crie uma clicando no bot√£o acima)</small>
                 </div>`;
    } else {
        notes.forEach((item) => {
            const displayHtml = cleanMicaContent(item.snippet || item.content);
            const borderColor = item.noteColor || contextColor || '#3498db';
            
            // Usamos o sourceVerse para saber onde editar
            const vToEdit = item.sourceVerse || activeVerseFullName.split(':')[1].trim().split('-')[0];

            const menuHtml = `
                <div class="card-menu-container">
                    <div class="card-menu-btn" onclick="window.toggleCardMenu(this)">‚Ä¢‚Ä¢</div>
                    <div class="card-dropdown">
                        <button onclick="window.openEditCard('${vToEdit}', ${item.originalIndex})">‚úèÔ∏è Editar</button>
                        <button class="btn-remove-card" onclick="window.deletePuzzleItem('${vToEdit}', ${item.originalIndex})">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `;
            html += `
                <div class="detail-card" style="border-left: 4px solid ${borderColor}; margin-bottom: 15px; position: relative;">
                    ${menuHtml} ${displayHtml}
                </div>`;
        });
    }
    container.innerHTML = html;
}


// Fun√ß√£o auxiliar para desenhar o conte√∫do do destaque
function renderHighlightContent(container, notes, contextColor, vNum) {
    let html = "";

    if (notes.length === 0) {
        html += `<div style="color:#888; font-style:italic; text-align:center; padding: 40px 20px;">
                    Nenhuma nota encontrada para este trecho exato.<br>
                    <small>(Crie uma clicando no bot√£o acima)</small>
                 </div>`;
    } else {
        notes.forEach((item) => {
            const displayHtml = cleanMicaContent(item.snippet || item.content);
            
            // --- L√ìGICA DA COR DA BORDA ---
            // 1. Tenta usar a cor espec√≠fica da nota (se foi gravada com uma)
            // 2. Se n√£o tiver, usa a cor do contexto (do trecho picotado)
            // 3. Se tudo falhar, usa azul padr√£o
            const borderColor = item.noteColor || contextColor || '#3498db';

            const menuHtml = `
                <div class="card-menu-container">
                    <div class="card-menu-btn" onclick="window.toggleCardMenu(this)">‚Ä¢‚Ä¢</div>
                    <div class="card-dropdown">
                        <button onclick="window.openEditCard('${vNum}', ${item.originalIndex})">‚úèÔ∏è Editar</button>
                        <button class="btn-remove-card" onclick="window.deletePuzzleItem('${vNum}', ${item.originalIndex})">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `;

            html += `
                <div class="detail-card" style="border-left: 4px solid ${borderColor}; margin-bottom: 15px; position: relative;">
                    ${menuHtml}
                    ${displayHtml}
                </div>`;
        });
    }

    container.innerHTML = html;
}

// Fun√ß√£o chamada pelo bot√£o "Criar Nota neste Trecho"
window.openFlashForHighlight = (encodedText, encodedColor) => {
    const text = decodeURIComponent(encodedText);
    const color = decodeURIComponent(encodedColor);

    // --- GUARDAR ESTADO ---
    activeHighlightContext = { text: text, color: color };
    // ----------------------

    currentSelectionText = text;
    
    // IMPORTANTE: Definimos a cor atual como a cor selecionada.
    // Assim, quando o injectColorPickerIntoForm correr, ele vai marcar a bolinha dessa cor como "ativa".
    selectedColorHex = color; 
    
    currentSelectionVerses = [activeVerseFullName]; 

    // Chama a fun√ß√£o acima que desenha o form e injeta o picker
    window.handleCreateNoteClick();
};

window.injectColorPickerIntoEditModal = () => {
    const editor = document.getElementById('edit-card-content');
    if (!editor) return;

    // Remove picker antigo se existir (para n√£o duplicar ao reabrir)
    const existing = document.getElementById('edit-color-picker');
    if (existing) existing.remove();

    const colors = [
        { name: 'Laranja', hex: '#e67e22' },
        { name: 'Amarelo', hex: '#f1c40f' },
        { name: 'Azul', hex: '#3498db' },
        { name: 'Verde', hex: '#2ecc71' },
        { name: 'Lil√°s', hex: '#9b59b6' },
        { name: 'Rosa', hex: '#ff7979' },
        { name: 'Salm√£o', hex: '#ffb8b8' },
        { name: 'Castanho', hex: '#a0522d' },
        { name: 'Cinzento', hex: '#95a5a6' }
    ];

    const container = document.createElement('div');
    container.id = 'edit-color-picker'; // ID espec√≠fico para facilitar remo√ß√£o
    container.className = 'color-picker-container';
    container.style.marginTop = "0px";
    container.style.marginBottom = "10px";
    
    colors.forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = c.hex;
        btn.title = c.name;
        
        // Verifica a vari√°vel global selectedColorHex (que definimos ao abrir o modal)
        if (selectedColorHex && selectedColorHex.toLowerCase() === c.hex.toLowerCase()) {
            btn.classList.add('selected');
        }

        btn.onclick = () => {
            container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedColorHex = c.hex; // Atualiza a escolha
        };
        container.appendChild(btn);
    });

    // Insere ANTES da caixa de conte√∫do
    editor.parentElement.insertBefore(container, editor);
};

 window.refreshVisualHighlights = () => {
    console.log("üé® A desenhar cores das notas...");

    const tempMap = {};
    let count = 0;

    // 1. Percorre TODAS as notas carregadas
    Object.values(existingUserData).forEach(data => {
        if (data && data.puzzleBoard && Array.isArray(data.puzzleBoard)) {
            data.puzzleBoard.forEach(item => {
                if (item.highlightRef) {
                    const text = item.highlightRef.trim(); // Remove espa√ßos extra
                    
                    // Prioridade TOTAL √† cor da nota (noteColor)
                    // Se n√£o tiver noteColor, usa item.cor. Se n√£o, azul.
                    const color = item.noteColor || item.cor || '#3498db';

                    if (!tempMap[text]) {
                        tempMap[text] = new Set();
                    }
                    tempMap[text].add(color);
                    count++;
                }
            });
        }
    });

    console.log(`üìä Notas processadas para destaque: ${count}`);

    // 2. Atualiza lista global
    currentChapterHighlights = Object.keys(tempMap).map(text => ({
        texto: text,
        colors: Array.from(tempMap[text])
    }));

    // 3. LIMPEZA E REDESENHO NO DOM
    const allSpans = document.querySelectorAll('.verse-text');
    
    if (allSpans.length === 0) {
        console.warn("‚ö†Ô∏è ALERTA: Texto da B√≠blia ainda n√£o existe no DOM.");
        return;
    }

    allSpans.forEach(span => {
        // Limpa picotados antigos
        if (span.querySelector('.highlight-picotado')) {
            span.innerHTML = span.innerText; 
        }
    });

    // Aplica os novos
    applyCachedHighlightsGlobally();
    
    console.log(`‚úÖ Visual atualizado com ${currentChapterHighlights.length} trechos coloridos.`);
};

// --- FUN√á√ÉO AUXILIAR PARA CORRIGIR SELE√á√ïES MULTI-VERS√çCULO ---
function calculateVerseIntersection(verseText, fullSelection) {
    if (!verseText || !fullSelection) return null;
    
    // Limpeza b√°sica para maximizar compatibilidade
    const vText = verseText.trim();
    const sText = fullSelection.trim();

    // 1. Caso Perfeito: A sele√ß√£o cabe toda neste vers√≠culo
    if (vText.includes(sText)) return sText;

    // 2. O vers√≠culo est√° todo dentro da sele√ß√£o (selecionou tudo e mais um pouco)
    if (sText.includes(vText)) return vText;

    // 3. A sele√ß√£o come√ßa neste vers√≠culo e continua no pr√≥ximo
    // Procuramos o maior peda√ßo do IN√çCIO da sele√ß√£o que exista neste vers√≠culo
    // (Otimizado para textos b√≠blicos curtos)
    for (let i = sText.length; i > 5; i--) { // >5 para evitar coincidir palavras min√∫sculas como "e"
        const chunk = sText.substring(0, i);
        if (vText.includes(chunk)) return chunk;
    }

    // 4. A sele√ß√£o veio do anterior e termina neste vers√≠culo
    // Procuramos o maior peda√ßo do FIM da sele√ß√£o que exista neste vers√≠culo
    for (let i = 0; i < sText.length - 5; i++) {
        const chunk = sText.substring(i);
        if (vText.includes(chunk)) return chunk;
    }

    return null; // N√£o encontrou interse√ß√£o v√°lida
}

    </script>
</body>
</html>
