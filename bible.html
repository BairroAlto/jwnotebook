<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√≠blia - Leitura</title>
    <style>
        :root {
            --bg-color: #000000;
            --tile-color: #565060;
            --tile-hover: #6d6679;
            --text-color: #ffffff;
            --accent-color: #e67e22; 
            --highlight-bg: rgba(230, 126, 34, 0.15);
            --border-color: #333;
            --panel-color: #1f1f22;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- CABE√áALHO --- */
        header {
            padding: 0 15px;
            background-color: #1a1a1a;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            height: 45px;
            flex-shrink: 0;
        }

        #back-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            margin-right: 15px;
            display: none;
            padding: 5px;
        }

        #page-title {
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .container { flex: 1; overflow-y: auto; padding: 5px; }
        .section-title { font-size: 0.7rem; font-weight: 800; color: #888; margin: 10px 0 5px 0; padding-left: 2px; text-transform: uppercase; }

        /* GRELHA (12 Colunas) */
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; padding-bottom: 20px; }
        .tile {
            background-color: var(--tile-color); color: var(--text-color); aspect-ratio: 1 / 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
        }
        .tile:hover { background-color: var(--tile-hover); }

        @media (max-width: 480px) { .grid { grid-template-columns: repeat(8, 1fr); } .tile { font-size: 0.65rem; } }

        /* VERS√çCULOS */
        .verse-list { display: flex; flex-direction: column; gap: 0; padding-bottom: 50px; }
        .verse-item { font-size: 1.05rem; padding: 12px 10px; border-bottom: 1px solid #222; display: flex; gap: 12px; line-height: 1.5; align-items: flex-start; cursor: default; }
        .verse-number { color: #666; font-weight: bold; font-size: 0.85em; min-width: 25px; text-align: right; margin-top: 2px; cursor: pointer; padding: 2px 5px; border-radius: 4px; transition: background-color 0.2s; }
        .verse-number:hover { background-color: rgba(255,255,255,0.1); }
        .verse-number.has-data { color: var(--accent-color); text-shadow: 0 0 5px rgba(230, 126, 34, 0.4); }
        .verse-text { color: #ddd; user-select: text; }
        .loading-text { color: #444; font-style: italic; font-size: 0.9em; }
        .hidden { display: none !important; }

        /* --- MODAL DE DETALHES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; justify-content: center; align-items: flex-start; padding-top: 50px;
        }
        .modal-content {
            background: #1f1f22; width: 95%; max-width: 700px; max-height: 85vh;
            border-radius: 8px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,1);
        }
        .modal-header {
            padding: 10px 15px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: #252528; position: relative;
        }
        
        /* Bot√£o Brilhante + Nota */
        #btn-add-flash-note {
            background: linear-gradient(135deg, #e67e22, #f39c12);
            border: none; color: white; padding: 6px 12px; border-radius: 20px;
            font-weight: bold; font-size: 0.85rem; cursor: pointer;
            box-shadow: 0 0 10px rgba(230, 126, 34, 0.5);
            animation: pulse-glow 2s infinite;
            margin-left: 10px;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
            50% { box-shadow: 0 0 15px rgba(230, 126, 34, 0.8); }
            100% { box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
        }

        .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .details-body { flex: 1; overflow-y: auto; padding: 15px; }

        .detail-section { margin-bottom: 25px; }
        .detail-title { font-size: 0.8rem; text-transform: uppercase; color: #888; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
        
        .detail-card { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 4px; padding: 12px; margin-bottom: 10px; font-size: 0.95rem; color: #e0e0e0; white-space: pre-wrap; word-wrap: break-word; }
        .detail-card strong { display: block; margin-bottom: 5px; color: #fff; font-size: 1rem; }
        .detail-card a { color: #3498db; text-decoration: none; word-break: break-all; }
        
        .detail-card.puzzle { border-left: 3px solid #2ecc71; }
        .detail-card.dossie { border-left: 3px solid #e74c3c; }
        .detail-card.link { border-left: 3px solid #3498db; }
        .empty-msg { color: #555; font-style: italic; font-size: 0.85rem; padding-left: 5px; }

        /* --- MODAL DE CRIA√á√ÉO FLASH (SubNota) --- */
        #flash-note-modal { z-index: 3000; } /* Acima do modal de detalhes */
        .flash-toolbar {
            display: flex; gap: 5px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 10px;
        }
        .flash-toolbar button {
            background: #333; border: 1px solid #444; color: #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
        }
        .flash-input-title {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; 
            color: #e67e22; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; outline: none;
        }
        .flash-editor {
            min-height: 150px; outline: none; line-height: 1.5; color: #ddd; 
            padding: 10px; background: rgba(0,0,0,0.1); border-radius: 4px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <button id="back-btn">‚¨Ö</button>
        <div id="page-title">B√≠blia</div>
    </header>

    <div class="container">
        <div id="view-books"></div>
        <div id="view-chapters" class="hidden"><div class="grid" id="chapters-grid"></div></div>
        <div id="view-verses" class="hidden"><div class="verse-list" id="verses-list"></div></div>
    </div>

    <!-- MODAL DE DETALHES -->
    <div id="verse-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display:flex; align-items:center;">
                    <h3 id="modal-verse-title" style="color:var(--accent-color); font-size:1.1rem; margin-right:15px;">Vers√≠culo</h3>
                    <button id="btn-add-flash-note">+ Adicionar Nota</button>
                </div>
                <button class="modal-close" onclick="document.getElementById('verse-details-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body" id="details-content"></div>
        </div>
    </div>

    <!-- MODAL DE CRIA√á√ÉO FLASH -->
    <div id="flash-note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color:#e67e22;">Nova Nota Flash</h3>
                <button class="modal-close" onclick="document.getElementById('flash-note-modal').style.display='none'">√ó</button>
            </div>
            <div class="details-body">
                <input type="text" id="flash-title" class="flash-input-title" placeholder="T√≠tulo da Nota...">
                
                <div class="flash-toolbar">
                    <button onclick="document.execCommand('bold')"><b>B</b></button>
                    <button onclick="document.execCommand('italic')"><i>I</i></button>
                    <button onclick="document.execCommand('underline')"><u>U</u></button>
                </div>

                <div id="flash-editor" class="flash-editor" contenteditable="true" placeholder="Escreva aqui..."></div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                    üîó Anexado a: <span id="flash-attached-verse" style="color: #3498db;"></span>
                </div>

                <button id="btn-save-flash" style="width:100%; margin-top:20px; padding:12px; background:var(--accent-color); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GRAVAR NOTA</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { BIBLE_DATA } from './js/bible-data.js';
        import { db, auth } from './js/firebase-config.js';
        import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, arrayUnion, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // ESTADO
        let currentView = 'books';
        let selectedBook = null;
        let selectedChapter = null;
        let currentUser = null;
        let existingUserData = {}; 
        let activeVerseFullName = ""; 
        let activeVerseDocId = ""; 

        // DOM
        const viewBooks = document.getElementById('view-books');
        const viewChapters = document.getElementById('view-chapters');
        const viewVerses = document.getElementById('view-verses');
        const chaptersGrid = document.getElementById('chapters-grid');
        const versesList = document.getElementById('verses-list');
        const pageTitle = document.getElementById('page-title');
        const backBtn = document.getElementById('back-btn');
        const modal = document.getElementById('verse-details-modal');
        const flashModal = document.getElementById('flash-note-modal');
        const btnAddFlash = document.getElementById('btn-add-flash-note');
        const btnSaveFlash = document.getElementById('btn-save-flash');

        onAuthStateChanged(auth, (user) => {
            if (user) currentUser = user;
            else window.location.href = "index.html";
        });

        function generateDocId(bookName, chapter, verse) {
            const slug = bookName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ /g, "_");
            return `${slug}_${chapter}_${verse}`;
        }

        // --- RENDERIZA√á√ÉO ---
        function renderBooks() {
            viewBooks.innerHTML = '';
            const hebraico = BIBLE_DATA.filter(b => b.id <= 39);
            const grego = BIBLE_DATA.filter(b => b.id >= 40);

            const createSection = (title, books) => {
                const h2 = document.createElement('h2'); h2.className = 'section-title'; h2.innerText = title; viewBooks.appendChild(h2);
                const grid = document.createElement('div'); grid.className = 'grid';
                books.forEach(book => {
                    const tile = document.createElement('div'); tile.className = 'tile'; tile.innerText = book.abrev;
                    tile.onclick = () => openChapters(book); grid.appendChild(tile);
                });
                viewBooks.appendChild(grid);
            };
            createSection('Escrituras Hebraico-Aramaicas', hebraico);
            createSection('Escrituras Gregas Crist√£s', grego);
            updateUI('books');
        }

        function openChapters(book) {
            selectedBook = book; chaptersGrid.innerHTML = '';
            for (let i = 1; i <= book.caps; i++) {
                const tile = document.createElement('div'); tile.className = 'tile'; tile.innerText = i;
                tile.onclick = () => openVerses(i); chaptersGrid.appendChild(tile);
            }
            updateUI('chapters');
        }

        async function openVerses(chapter) {
            selectedChapter = chapter; versesList.innerHTML = ''; existingUserData = {};
            if (currentUser) loadUserDataForChapter(selectedBook.nome, chapter);
            const totalVerses = selectedBook.versiculos[chapter - 1] || 50;
            for (let i = 1; i <= totalVerses; i++) {
                const row = document.createElement('div'); row.className = 'verse-item';
                const spanId = `vtext-${i}`; const numId = `vnum-${i}`;
                row.innerHTML = `<span id="${numId}" class="verse-number" onclick="openModalForVerse(${i})">${i}</span><span id="${spanId}" class="verse-text loading-text">...</span>`;
                versesList.appendChild(row);
                fetchVerseText(selectedBook.nome, chapter, i, spanId);
            }
            updateUI('verses');
        }

        async function loadUserDataForChapter(bookName, chapter) {
            const prefix = `${bookName} ${chapter}:`;
            try {
                const q = query(collection(db, "textosbiblicos"), where("userId", "==", currentUser.uid), where("nome", ">=", prefix), where("nome", "<=", prefix + "\uf8ff"));
                const snapshot = await getDocs(q);
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const parts = data.nome.split(':');
                    if (parts.length > 1) {
                        const verseNum = parts[1].trim();
                        existingUserData[verseNum] = { ...data, docId: docSnap.id };
                        const firstNum = parseInt(verseNum.split('-')[0]);
                        const numEl = document.getElementById(`vnum-${firstNum}`);
                        if (numEl) numEl.classList.add('has-data');
                    }
                });
            } catch (e) { console.error(e); }
        }

        // --- LIMPEZA DE HTML PARA EXIBI√á√ÉO ---
        function cleanMicaContent(snippet) {
            if (!snippet) return "";
            
            // 1. DESCODIFICA√á√ÉO CRUCIAL
            let decoded = decodeURIComponent(snippet);
            
            // Cria um DOM tempor√°rio
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = decoded;
            
            // Procura o t√≠tulo
            let title = "";
            const titleInput = tempDiv.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
            const h2 = tempDiv.querySelector('h2');
            
            if (titleInput) title = titleInput.value || titleInput.getAttribute('value') || "";
            else if (h2) title = h2.textContent;

            // Procura o conte√∫do
            let content = "";
            const contentDiv = tempDiv.querySelector('.mini-note-content, .toggle-content, .redator-content, .sign-content, .card-desc-content, .cube-content');
            
            if (contentDiv) {
                // Remove tags HTML, mant√©m quebras de linha e texto limpo
                content = contentDiv.innerText; 
            } else {
                content = tempDiv.innerText;
            }

            // Remove bot√µes de lixo visual
            content = content.replace(/üîê|üî∫|üîª|‚ö°|üß¨|üé®|üìã|üóëÔ∏è/g, '').trim();

            // Monta o visual final
            let finalHtml = "";
            if (title && title !== "Texto da Nota") {
                finalHtml += `<div style="font-weight:bold; color:white; margin-bottom:5px;">${title}</div>`;
            }
            finalHtml += `<div style="color:#ddd; font-size:0.9em; white-space: pre-wrap;">${content}</div>`;

            return finalHtml || "Conte√∫do vazio.";
        }

        // --- ABRIR MODAL PRINCIPAL ---
        window.openModalForVerse = async (num) => {
            activeVerseFullName = `${selectedBook.nome} ${selectedChapter}:${num}`;
            const modalTitle = document.getElementById('modal-verse-title');
            const contentDiv = document.getElementById('details-content');
            
            modalTitle.innerText = activeVerseFullName;
            contentDiv.innerHTML = '';
            modal.style.display = 'flex';

            const data = existingUserData[num];
            activeVerseDocId = data ? data.docId : null;

            if (!data) {
                contentDiv.innerHTML = '<p class="empty-msg">Sem registos (Puzzle, Dossi√©, Links).</p>';
                return;
            }

            // A. PUZZLE (Quadro)
            const puzzleItems = data.puzzleBoard || [];
            if (puzzleItems.length > 0) {
                let puzzleHtml = "";
                puzzleItems.forEach(item => {
                    // Aplica a limpeza aqui tamb√©m para garantir visualiza√ß√£o correta
                    const displayHtml = cleanMicaContent(item.snippet || item.content);
                    puzzleHtml += `<div class="detail-card puzzle">${displayHtml}</div>`;
                });
                contentDiv.innerHTML += `<div class="detail-section"><div class="detail-title">üß© Puzzle</div>${puzzleHtml}</div>`;
            }

            // B. DOSSI√â (Micas)
            const dossieItems = data.dossie || [];
            if (dossieItems.length > 0) {
                let dossieHtml = "";
                dossieItems.forEach(mica => {
                    let itemsList = "";
                    if(mica.items && mica.items.length > 0) {
                        mica.items.forEach(mi => {
                            itemsList += `<div style="margin-top:8px; padding:8px; background:rgba(0,0,0,0.3); border-left:2px solid #666; border-radius:4px;">${cleanMicaContent(mi.snippet)}</div>`;
                        });
                    }
                    dossieHtml += `<div class="detail-card dossie"><strong>üóÇÔ∏è ${mica.name}</strong>${itemsList}</div>`;
                });
                contentDiv.innerHTML += `<div class="detail-section"><div class="detail-title">üìº Dossi√©</div>${dossieHtml}</div>`;
            }

            // C. LINKS
            const linksItems = data.panelLinks || [];
            if (linksItems.length > 0) {
                let linksHtml = "";
                linksItems.forEach(link => {
                    if (link.type === 'codex') {
                        linksHtml += `<div class="detail-card link"><strong>üìö ${link.serie}</strong><br>${link.codiceshow || ''}</div>`;
                    } else {
                        let urlsHtml = "";
                        if (link.urls) Object.values(link.urls).forEach(u => urlsHtml += `<br><a href="${u}" target="_blank">üîó ${u}</a>`);
                        else if (link.url) urlsHtml += `<br><a href="${link.url}" target="_blank">üîó ${link.url}</a>`;
                        linksHtml += `<div class="detail-card link"><strong>${link.title}</strong>${urlsHtml}</div>`;
                    }
                });
                contentDiv.innerHTML += `<div class="detail-section"><div class="detail-title">‚ö° Doc / Links</div>${linksHtml}</div>`;
            }
        };

        // --- ABRIR MODAL FLASH ---
        btnAddFlash.onclick = () => {
            document.getElementById('flash-title').value = "";
            document.getElementById('flash-editor').innerHTML = "";
            document.getElementById('flash-attached-verse').innerText = activeVerseFullName;
            flashModal.style.display = 'flex';
            document.getElementById('flash-title').focus();
        };

        // --- GRAVAR FLASH (Corre√ß√£o Final) ---
     btnSaveFlash.onclick = async () => {
    const title = document.getElementById('flash-title').value.trim();
    const content = document.getElementById('flash-editor').innerHTML;
    
    if (!title) return alert("Escreva um t√≠tulo para a nota.");

    // Feedback visual
    btnSaveFlash.textContent = "A gravar e a anexar ao Puzzle...";
    btnSaveFlash.disabled = true;

    try {
        // 1. GARANTIR QUE O VERS√çCULO EXISTE NA BD
        // Se ainda n√£o tivermos o ID do doc (porque √© a primeira vez que abrimos este vers√≠culo), criamos agora.
        let docRef;
        if (!activeVerseDocId) {
            const newDoc = await addDoc(collection(db, 'textosbiblicos'), {
                nome: activeVerseFullName,
                userId: currentUser.uid,
                createdAt: serverTimestamp(),
                referencias: {},
                puzzleBoard: [], // Inicializa o quadro vazio
                dossie: []
            });
            activeVerseDocId = newDoc.id;
            
            // Atualiza cache local para n√£o criar duplicados nesta sess√£o
            const vNum = activeVerseFullName.split(':')[1].trim();
            existingUserData[vNum] = { docId: activeVerseDocId, puzzleBoard: [] };
            
            // Marca visualmente o n√∫mero do vers√≠culo
            const firstNum = parseInt(vNum.split('-')[0]);
            const numBadge = document.getElementById(`vnum-${firstNum}`);
            if(numBadge) numBadge.classList.add('has-data');
        }
        
        docRef = doc(db, 'textosbiblicos', activeVerseDocId);

        // 2. PREPARAR O HTML DA SUBNOTA (O "Snippet")
        // Criamos isto exatamente como se fosse uma caixa dentro do note.html
        // Inclu√≠mos a liga√ß√£o inversa (data-box-links) para a nota saber que pertence a este vers√≠culo
        const boxLinksData = JSON.stringify({
            categories: [{
                id: activeVerseDocId,
                name: activeVerseFullName,
                type: "textobiblico"
            }]
        });

        // Usamos encodeURIComponent para o JSON para evitar quebra de aspas no HTML
        const safeBoxLinks = boxLinksData.replace(/"/g, '&quot;');

        const subNoteHtml = `
            <div class="mini-note-wrapper" id="box_${Date.now()}" data-topics="{}" data-shared="false" data-box-links='${safeBoxLinks}'>
                <textarea class="mini-note-title-input" rows="1">${title}</textarea>
                <div class="mini-note-toolbar" contenteditable="false">
                    <button>üîê</button><button>‚ö°</button><button>üóëÔ∏è</button>
                </div>
                <div class="mini-note-content">${content}</div>
            </div><p><br></p>
        `;

        // 3. CRIAR A NOTA F√çSICA (Cole√ß√£o 'pastas')
        const noteRef = await addDoc(collection(db, 'pastas'), {
            nome: title,
            conteudo: subNoteHtml, // A nota cont√©m a caixa
            tipo: 'nota',
            oque: 'flash', // Marca como nota r√°pida
            userId: currentUser.uid,
            estado: 'ativa',
            ordem: 0, // Aparece no topo
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        });

        // 4. ANEXAR AO PUZZLE DO VERS√çCULO (A "Magia")
        // Isto simula o "Editar > +Ref" da 4¬™ coluna
        const puzzleItem = {
            type: 'ref', // Tipo refer√™ncia (cart√£o verde/azul)
            noteId: noteRef.id,
            noteName: title,
            snippet: encodeURIComponent(subNoteHtml), // Codifica o HTML para guardar no JSON
            addedAt: Date.now()
        };

        await updateDoc(docRef, {
            puzzleBoard: arrayUnion(puzzleItem)
        });

        // 5. SUCESSO E FECHO
        alert("Nota criada e afixada no Quadro do vers√≠culo!");
        flashModal.style.display = 'none';
        
        // Recarrega o modal de detalhes para ver o novo cart√£o no Puzzle imediatamente
        const vNum = activeVerseFullName.split(':')[1].trim();
        
        // Pequeno truque para atualizar os dados locais antes de reabrir
        const snap = await getDoc(docRef);
        existingUserData[vNum] = { ...snap.data(), docId: activeVerseDocId };
        
        window.openModalForVerse(vNum);

    } catch (e) {
        console.error("Erro ao gravar Flash Note:", e);
        alert("Ocorreu um erro ao gravar. Verifique a consola.");
    } finally {
        btnSaveFlash.textContent = "GRAVAR NOTA";
        btnSaveFlash.disabled = false;
    }
};

        async function fetchVerseText(bookName, chapter, verse, elementId) {
            const docId = generateDocId(bookName, chapter, verse);
            const span = document.getElementById(elementId);
            try {
                const docSnap = await getDoc(doc(db, "bible_verses_public", docId));
                if (docSnap.exists()) { span.innerText = docSnap.data().texto; span.classList.remove('loading-text'); }
                else { span.innerText = "Texto indispon√≠vel."; }
            } catch (error) { span.innerText = "Erro."; }
        }

        function updateUI(view) {
            currentView = view;
            viewBooks.classList.add('hidden'); viewChapters.classList.add('hidden'); viewVerses.classList.add('hidden');
            if (view === 'books') { viewBooks.classList.remove('hidden'); pageTitle.innerText = "B√çBLIA"; backBtn.style.display = 'none'; }
            else if (view === 'chapters') { viewChapters.classList.remove('hidden'); pageTitle.innerText = selectedBook.nome; backBtn.style.display = 'block'; }
            else if (view === 'verses') { viewVerses.classList.remove('hidden'); pageTitle.innerText = `${selectedBook.nome} ${selectedChapter}`; backBtn.style.display = 'block'; }
            window.scrollTo(0, 0);
        }

        backBtn.addEventListener('click', () => {
            if (currentView === 'verses') updateUI('chapters'); else if (currentView === 'chapters') { selectedBook = null; updateUI('books'); }
        });

        window.onclick = function(event) { if (event.target === modal) modal.style.display = "none"; }
        renderBooks();
    </script>
</body>
</html>
