<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - X-Ray Scanner</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczN1hC3tbRhJ2qvfKk01zUIKkZHcjPl33YJ65mV7-JuDkW6D6Lm04n7OrI2KVzu-dxiQY2qKx4Y79g1BJ-nldW_mE0oCeu7rO1IckhzedMYk6STLY78vteeFIZzHmvc5Q8O_S-q50V3jhjajiDa3fRqS=w1009-h873-s-no-gm?authuser=4">

    <style>
        :root {
            --bg-color: #0f0f12;
            --sidebar-color: #1a1a1d;
            --accent-color: #3498db;
            --text-color: #f0f0f0;
            --border-color: #333;
            --panel-bg: #141417;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: 50px;
            background: var(--sidebar-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
        }
        .logo { font-weight: bold; color: var(--accent-color); letter-spacing: 2px; }

        #main-layout { display: flex; flex: 1; overflow: hidden; }

        /* LADO ESQUERDO (EDITOR) */
        #input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            gap: 15px;
        }
        #xray-editor {
            flex: 1;
            background: #16161a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: #ccc;
            padding: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* LADO DIREITO (PAINEL) */
        #xray-panel {
            width: 480px;
            background: var(--sidebar-color);
            display: flex;
            flex-direction: column;
        }

        .tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            flex: 1; padding: 15px 0; background: none; border: none;
            color: #666; cursor: pointer; font-size: 1.2rem;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--accent-color); border-bottom-color: var(--accent-color);
            background: rgba(52, 152, 219, 0.05);
        }

.tab-content { 
    flex: 1; 
    overflow-y: auto; 
    padding: 0; /* Estava 15px, mudamos para 0 */
    display: none; 
    position: relative;
}
        .tab-content.active { display: block; }

        /* PICCARDS (FILTROS) */
.tab-filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 15px; /* Espa√ßamento interno da barra */
    background: var(--sidebar-color); /* Garante que √© opaca */
    border-bottom: 1px solid rgba(255,255,255,0.1); /* Linha subtil de separa√ß√£o */
    position: sticky;
    top: 0;
    z-index: 100; /* Garante que fica acima do texto ao fazer scroll */
    width: 100%;
}
        .piccard {
            background: rgba(255,255,255,0.03);
            border: 1px solid #444;
            color: #777;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.72rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .piccard.active {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .piccard.active::after { content: '‚úì'; font-size: 0.6rem; }

        /* RESULTADOS */
.res-card {
    background: var(--panel-bg); 
    border: 1px solid var(--border-color);
    border-radius: 8px; 
    padding: 15px; 
    margin: 12px 15px; /* Adicion√°mos 15px de margem lateral */
    cursor: pointer; 
    transition: 0.2s;
}

.tab-content > p {
    padding: 20px;
    text-align: center;
}
        .res-card:hover { border-color: var(--accent-color); transform: translateY(-1px); }
        .res-ref { color: var(--accent-color); font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block; }
        .res-text { font-size: 0.95rem; color: #bbb; line-height: 1.5; text-align: justify; }

        /* --- ANIMA√á√ÉO DA PARAB√ìLICA (LOADER) --- */
        .loader-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; color: var(--accent-color);
        }
        .scanner-ui { position: relative; width: 150px; height: 150px; margin-bottom: 20px; }
        .dish {
            position: absolute; bottom: 20%; left: 50%; width: 80px; height: 40px;
            border: 3px solid var(--accent-color); border-radius: 50% 50% 0 0;
            transform: translateX(-50%) rotate(180deg); background: rgba(52, 152, 219, 0.1);
        }
        .dish::after {
            content: ''; position: absolute; top: -20px; left: 50%;
            width: 3px; height: 25px; background: var(--accent-color); transform: translateX(-50%);
        }
        .wave {
            position: absolute; top: 15%; left: 50%; border: 2px solid var(--accent-color);
            border-radius: 50%; transform: translateX(-50%); opacity: 0; animation: wave-pulse 2s infinite;
        }
        .wave-1 { width: 40px; height: 20px; animation-delay: 0s; }
        .wave-2 { width: 70px; height: 35px; animation-delay: 0.5s; }
        .wave-3 { width: 100px; height: 50px; animation-delay: 1s; }

        @keyframes wave-pulse {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateX(-50%) scale(1.2); opacity: 0; }
        }

        .falling-icon { position: absolute; font-size: 1.2rem; opacity: 0; animation: capture-icon 1.5s infinite linear; }
        .icon-1 { left: 15%; animation-delay: 0.2s; }
        .icon-2 { left: 45%; animation-delay: 0.9s; }
        .icon-3 { left: 75%; animation-delay: 0.5s; }

        @keyframes capture-icon {
            0% { transform: translateY(-60px) scale(0.5); opacity: 0; }
            30% { opacity: 1; }
            80% { transform: translateY(20px) scale(0.8); opacity: 0.5; }
            100% { transform: translateY(40px) scale(0); opacity: 0; }
        }

        .loader-text { font-family: monospace; font-size: 0.75rem; letter-spacing: 3px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* VIEWER */
        .viewer-block { margin-bottom: 15px; padding: 10px; border-radius: 6px; color: #bbb; }
        .viewer-block.highlight-target { background: rgba(52, 152, 219, 0.15); border-left: 4px solid var(--accent-color); color: #fff; }
        .para-badge { background: #333; color: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; }

        [contenteditable]:empty:before { content: attr(placeholder); color: #555; }
        /* --- ESTILOS DO ESCUDO DE SEGURAN√áA (IGUAL √Ä LIBRARY) --- */
#global-auth-shield { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: #000; 
    z-index: 999999; /* Valor alt√≠ssimo para cobrir tudo */
    display: flex; 
    justify-content: center; 
    align-items: center; 
}

.global-spinner { 
    width: 40px; 
    height: 40px; 
    border: 4px solid #333; 
    border-top: 4px solid var(--accent-color); 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Bot√µes do Header */
.header-actions { display: flex; gap: 10px; align-items: center; }
.btn-xray {
    background: #252528; border: 1px solid #444; color: #ccc;
    padding: 6px 12px; border-radius: 6px; cursor: pointer;
    font-size: 0.85rem; transition: 0.2s; display: flex; align-items: center; gap: 6px;
}
.btn-xray:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.btn-xray.save-btn { background: rgba(46, 204, 113, 0.1); border-color: #2ecc71; color: #2ecc71; }
.btn-xray.save-btn:hover { background: #2ecc71; color: white; }

/* Modal de Ficheiros */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 200000; display: none;
    justify-content: center; align-items: center;
}
.modal-content {
    background: #1a1a1d; border: 1px solid #333; width: 90%; max-width: 500px;
    border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.xray-file-item {
    padding: 12px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s;
    display: flex; justify-content: space-between; align-items: center;
}
.xray-file-item:hover { background: rgba(52, 152, 219, 0.1); }
.file-date { font-size: 0.75rem; color: #666; }

/* Bot√µes de A√ß√£o no Header */
.header-actions { display: flex; gap: 10px; align-items: center; }
.action-btn {
    background: #252528;
    border: 1px solid #444;
    color: #ccc;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: 0.2s;
}
.action-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.action-btn.save-btn { border-color: #2ecc71; color: #2ecc71; }
.action-btn.save-btn:hover { background: #2ecc71; color: white; }

/* Modal de Carregamento */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000; display: none;
    justify-content: center; align-items: center;
}
.modal-content {
    background: #1a1a1d; width: 90%; max-width: 500px; border-radius: 12px;
    border: 1px solid #333; padding: 20px; display: flex; flex-direction: column;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.load-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.load-item {
    background: #252528; padding: 15px; border-radius: 8px; border: 1px solid #333;
    cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
}
.load-item:hover { border-color: var(--accent-color); background: #2a2a2e; }

#save-xray-title-input:focus {
    border-color: #2ecc71;
    background: #000;
}

.filter-pane {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}
.filter-item {
    background: #252528; border: 1px solid #333; padding: 8px;
    border-radius: 6px; font-size: 0.75rem; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
}
.filter-item.active { border-color: var(--accent-color); color: white; background: rgba(52, 152, 219, 0.1); }
.filter-item span.check { color: var(--accent-color); font-weight: bold; opacity: 0; }
.filter-item.active span.check { opacity: 1; }


    </style>
</head>
<body>

    <!-- ESCUDO DE CARREGAMENTO E SEGURAN√áA -->
    <div id="global-auth-shield">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div class="global-spinner"></div>
            <div id="global-progress-text" style="color: #666; font-family: monospace; font-size: 0.8rem; margin-top: 15px; letter-spacing: 1px;">SINCRONIZAR: 0%</div>
        </div>
    </div>

    <header>
        <div class="logo">NOTA<span>BOOK</span> / X-RAY</div>
        <div id="status-info" style="font-size: 0.8rem; color: #666; flex: 1; margin-left: 20px;">Pronto para analisar...</div>
        
        <div class="header-actions">
            <button class="action-btn save-btn" onclick="window.saveXrayDoc()">
                <span>üíæ</span> Gravar
            </button>
            <button class="action-btn" onclick="window.openLoadXrayModal()">
                <span>üìÇ</span> Abrir
            </button>
        </div>
    </header>

    <!-- MODAL PARA CARREGAR FICHEIROS X-RAY -->
    <div id="load-xray-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: var(--accent-color);">Documentos Gravados</h3>
                <button onclick="document.getElementById('load-xray-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="load-list-container" class="load-list">
                <!-- Itens injetados via JS -->
            </div>
        </div>
    </div>

    <!-- MODAL PARA GRAVAR (NOMEAR DOCUMENTO) -->
    <div id="save-xray-modal" class="modal-overlay" style="z-index: 2001;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="color: #2ecc71;">Gravar Documento</h3>
                <button onclick="document.getElementById('save-xray-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="padding: 10px 0;">
                <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 8px;">NOME DO DOCUMENTO</label>
                <input type="text" id="save-xray-title-input" 
                       style="width: 100%; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; border-bottom: 2px solid #2ecc71;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="document.getElementById('save-xray-modal').style.display='none'" 
                        style="flex: 1; padding: 10px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>
                <button onclick="window.confirmSaveXray()" 
                        style="flex: 1; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">GRAVAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DEFINI√á√ïES DE FILTRO -->
    <div id="xray-filter-modal" class="modal-overlay" style="z-index: 210000;">
        <div class="modal-content" style="max-width: 600px; height: 85vh;">
            <div class="modal-header">
                <h3 style="color: var(--accent-color);">‚öôÔ∏è Defini√ß√µes de Filtro</h3>
                <button onclick="document.getElementById('xray-filter-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <!-- Abas Internas do Modal de Filtros -->
            <div class="tabs" style="background: #1a1a1d; margin-top: -20px;">
                <button class="tab-btn active" onclick="switchFilterTab('f-books', this)" style="font-size: 0.8rem;">Livros</button>
                <button class="tab-btn" onclick="switchFilterTab('f-pubs', this)" style="font-size: 0.8rem;">Pubs</button>
                <button class="tab-btn" onclick="switchFilterTab('f-w', this)" style="font-size: 0.8rem;">Sentinela</button>
                <button class="tab-btn" onclick="switchFilterTab('f-g', this)" style="font-size: 0.8rem;">Despertai</button>
                <button class="tab-btn" onclick="switchFilterTab('f-themes', this)" style="font-size: 0.8rem; color: #ffcc00;">üçú Misturar</button>
            </div>

            <div style="padding: 10px; background: #111; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-xray" onclick="toggleAllInActiveTab(true)" style="font-size: 0.7rem;">Marcar Tudo</button>
                <button class="btn-xray" onclick="toggleAllInActiveTab(false)" style="font-size: 0.7rem;">Desmarcar Tudo</button>
            </div>

            <div id="filter-scroll-area" style="flex: 1; overflow-y: auto; padding: 15px;">
                <div id="f-books" class="filter-pane active" style="display: grid;"></div>
                <div id="f-pubs" class="filter-pane" style="display: none;"></div>
                <div id="f-w" class="filter-pane" style="display: none;"></div>
                <div id="f-g" class="filter-pane" style="display: none;"></div>
                <div id="f-themes" class="filter-pane" style="display: none;"></div>
            </div>

            <div style="padding: 15px; border-top: 1px solid #333;">
                <button class="action-btn save-btn" style="width: 100%; justify-content: center;" onclick="applyFiltersAndRescan()">
                    APLICAR E REESCANEAR
                </button>
            </div>
        </div>
    </div>

    <div id="main-layout">
        <section id="input-section">
            <div id="xray-editor" contenteditable="true" placeholder="Escreva ou cole o seu texto aqui..."></div>
        </section>

        <aside id="xray-panel">
            <div class="tabs">
                <button class="tab-btn active" data-tab="bible">üìñ</button>
                <button class="tab-btn" data-tab="books">üìî</button>
                <button class="tab-btn" data-tab="pubs">üìö</button>
                <button id="tab-btn-mix" class="tab-btn" data-tab="mix" style="display:none;">üçú</button>
                <button class="tab-btn" data-tab="viewer">ü™∂</button>
            </div>

            <div id="tab-bible" class="tab-content active"></div>
            <div id="tab-books" class="tab-content"></div>
            <div id="tab-pubs" class="tab-content"></div>
            <div id="tab-mix" class="tab-content"></div>
            <div id="tab-viewer" class="tab-content"><div id="viewer-container"></div></div>
        </aside>
    </div>

    <script type="module">
  // --- 1. IMPORTA√á√ïES DE SEGURAN√áA E FIREBASE ---
import { db, auth } from './js/firebase-config.js';
import { 
    doc, getDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

// --- 2. IMPORTA√á√ïES DE DADOS LOCAIS ---
import { BIBLE_DATA } from './js/bible-data.js';
import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';
import { BIBLE_ABBREVIATIONS } from './js/bible-map.js';

// --- 3. CONFIGURA√á√ïES E ESTADO GLOBAL ---
let currentUser = null;
let localLibraryCache = {}; 
let localBibleCache = {};
let detectedCoords = []; 
let rawResultsCache = { books: [], pubs: [], mix: [] }; 
let scanTimeout;
let needsBooksRefresh = true;
let needsPubsRefresh = true;
let lastDetectedCoordsStr = ""; // Para saber se o texto mudou

const editor = document.getElementById('xray-editor');
const statusInfo = document.getElementById('status-info');

const CONFIG_SCAN = {
    anoInicio: 1950,
    anoFim: 2026,
    meses: ["12", "11", "10", "09", "08", "07", "06", "05", "04", "03", "02", "01"]
};

// Defini√ß√£o dos Temas para a aba "Misturar"
const THEMES_CONFIG = {
    "Decis√µes": {
        core: ["decis√µes", "decis√£o"],
        coreTarget: 8,
        attached: [
            ["mente", "pensar"], ["pensamentos"], ["decidir"], ["espiritualidade", "espiritual"]
        ],
        attachedTarget: 7
    },
    "Prega√ß√£o": {
        core: ["prega√ß√£o", "minist√©rio"],
        coreTarget: 9,
        attached: [
            ["fazer disc√≠pulos"], ["estudo", "estudante", "estudantes"]
        ],
        attachedTarget: 9
    },
    "Melhorar Personalidade": {
        core: ["personalidade"],
        coreTarget: 7,
        attached: [
            ["mente"], ["pensar"]
        ],
        attachedTarget: 7
    },
    "Consolo": {
        core: ["consolo", "consolar"],
        coreTarget: 10,
        attached: [
            ["ajuda", "ajudar"], ["confiar", "confian√ßa"]
        ],
        attachedTarget: 10
    },
    "Pais": {
        core: ["pais", "pai", "m√£e"],
        coreTarget: 10,
        attached: [
            ["filhos", "filho", "crian√ßas"]
        ],
        attachedTarget: 10
    },
    "Batismo": {
        core: ["batismo", "batizar"],
        coreTarget: 11,
        attached: [
            ["dedica√ß√£o"]
        ],
        attachedTarget: 10
    },
    "Casal": {
        core: ["casamento"],
        coreTarget: 10,
        attached: [
            ["marido", "esposa"]
        ],
        attachedTarget: 11
    },
    "Jovens": {
        core: ["jovens", "jovem"],
        coreTarget: 9,
        attached: [
            ["alvo", "alvos"]
        ],
        attachedTarget: 9
    },
    "Memorial": {
        core: ["resgate"],
        coreTarget: 10,
        attached: [
            ["celebra√ß√£o", "comemora√ß√£o"]
        ],
        attachedTarget: 10
    }
};

let xrayFilters = {
    books: {}, 
    pubs: {},  
    watchtower: {}, 
    awake: {},
    themes: {} 
};

const XRAY_LOADER_HTML = `
    <div class="loader-container">
        <div class="scanner-ui">
            <div class="falling-icon icon-1">üìî</div>
            <div class="falling-icon icon-2">üìÑ</div>
            <div class="falling-icon icon-3">üìö</div>
            <div class="wave wave-1"></div><div class="wave wave-2"></div><div class="wave wave-3"></div>
            <div class="dish"></div>
        </div>
        <div class="loader-text">ESCANEAR FREQU√äNCIAS...</div>
    </div>
`;

// --- 4. INICIALIZA√á√ÉO ---

function initFilters() {
    const exclusoesPeriodicos = ["w", "g", "wp", "km", "mwb", "jwbvod", "jwb", "mwbv"];
    Object.keys(SIGLAS_PUBLICACOES).forEach(s => {
        if (!exclusoesPeriodicos.includes(s)) xrayFilters.books[s] = true;
    });
    ["mwb", "km"].forEach(s => { xrayFilters.pubs[s] = true; });
    for (let ano = CONFIG_SCAN.anoInicio; ano <= CONFIG_SCAN.anoFim; ano++) {
        xrayFilters.watchtower[ano.toString()] = true;
        xrayFilters.awake[ano.toString()] = true;
    }
    // Inicializar temas como inativos
    Object.keys(THEMES_CONFIG).forEach(t => xrayFilters.themes[t] = false);
}

async function preloadXrayCore() {
    const progressText = document.getElementById('global-progress-text');
    const booksToLoad = Object.keys(xrayFilters.books);
    const bibleToLoad = BIBLE_DATA;
    let loaded = 0;
    const total = booksToLoad.length + bibleToLoad.length;

    const updateProgress = () => {
        loaded++;
        if (progressText) {
            const percent = Math.round((loaded / total) * 100);
            progressText.innerText = `SINCRONIZAR: ${percent}%`;
        }
    };

    const biblePromises = bibleToLoad.map(async (book) => {
        const filename = book.nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_");
        try {
            const resp = await fetch(`./js/bible/${filename}.json`);
            if (resp.ok) localBibleCache[filename] = await resp.json();
        } catch (e) {}
        updateProgress();
    });

    const bookPromises = booksToLoad.map(async (id) => {
        try {
            const resp = await fetch(`./js/books/${id}.json`);
            if (resp.ok) localLibraryCache[id] = await resp.json();
        } catch (e) {}
        updateProgress();
    });

    await Promise.all([...biblePromises, ...bookPromises]);
}

onAuthStateChanged(auth, async (user) => {
    const shield = document.getElementById('global-auth-shield');
    if (!user) { window.location.href = "404.html"; return; }
    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().aceite !== "on") { window.location.href = "index.html"; return; }
        currentUser = user;
        initFilters();
        await preloadXrayCore();
        if (shield) {
            shield.style.transition = "opacity 0.5s ease";
            shield.style.opacity = "0";
            setTimeout(() => shield.style.display = 'none', 500);
        }
    } catch (e) { console.error(e); }
});

// --- 5. L√ìGICA SEM√ÇNTICA (REGRAS DO MISTURAR) ---

function checkThemeMatch(paragraphText, articleData, themeKey) {
    const theme = THEMES_CONFIG[themeKey];
    if (!theme) return false;

    const normalize = (str) => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
    
    const pText = normalize(paragraphText);
    const fullArticleText = normalize(articleData.conteudo.map(c => c.texto).join(" "));

    // Helper para contar ocorr√™ncias de um grupo de palavras (ex: "mente" OU "pensar")
    const countGroup = (text, group) => {
        let total = 0;
        group.forEach(word => {
            const regex = new RegExp(`\\b${normalize(word)}\\b`, 'g');
            total += (text.match(regex) || []).length;
        });
        return total;
    };

    // --- C√ÅLCULOS PR√âVIOS ---
    const coreCountP = countGroup(pText, theme.core); // Core no par√°grafo
    const coreCountArt = countGroup(fullArticleText, theme.core); // Core no artigo
    
    // Contagem de cada grupo anexo no par√°grafo e no artigo
    const attachedStats = theme.attached.map(group => ({
        inP: countGroup(pText, group),
        inArt: countGroup(fullArticleText, group)
    }));

    // --- REGRA 1: Core aparece 3x ou mais no par√°grafo ---
    if (coreCountP >= 3) return true;

    // --- REGRA 2: Algum anexo aparece 2x ou mais no par√°grafo ---
    if (attachedStats.some(stat => stat.inP >= 2)) return true;

    // --- REGRA 3: Core >= coreTarget E TODOS os anexos >= attachedTarget no artigo ---
    const allAttachedMet = attachedStats.every(stat => stat.inArt >= theme.attachedTarget);
    if (coreCountArt >= theme.coreTarget && allAttachedMet) return true;

    // --- REGRA 5: 80% dos grupos anexos aparecem > 2 vezes cada no artigo ---
    const groupsAboveTwo = attachedStats.filter(stat => stat.inArt > 2).length;
    const percentageAboveTwo = (groupsAboveTwo / theme.attached.length);
    if (percentageAboveTwo >= 0.8) return true;

    return false;
}

// --- 6. MOTOR DO SCANNER ---

async function performXRay() {
    const text = editor.innerText;
    const bibleRegex = createBibleRegex();
    const matches = [...new Set(text.match(bibleRegex) || [])];

    // 1. Se n√£o houver refer√™ncias, limpa e para
    if (matches.length === 0) {
        statusInfo.textContent = "Pronto.";
        detectedCoords = [];
        lastDetectedCoordsStr = "";
        document.getElementById('tab-bible').innerHTML = '<p style="padding:20px; color:#666; text-align:center;">Nenhuma refer√™ncia detetada.</p>';
        return; 
    }

    // 2. Criar o objeto de coordenadas completo (sem placeholders!)
    const currentCoords = matches.map(m => {
        const info = parseReference(m);
        if (!info) return null;
        
        // Mapear variantes (ex: Gen, Gn, G√™nesis) para o Regex de busca interna
        const variants = Object.keys(BIBLE_ABBREVIATIONS).filter(s => BIBLE_ABBREVIATIONS[s] === info.book);
        variants.push(info.book);
        const escaped = [...new Set(variants)].map(v => v.replace(/\./g, '\\.')).join('|');
        
        // Criar padr√µes de busca para cada vers√≠culo individual
        const searchPatterns = info.verses.map(ver => new RegExp(`(?:^|\\s|‚Äî|\\()(${escaped})\\.?\\s*${info.cap}[:.]${ver}\\b`, 'i'));
        
        return { ...info, isActive: true, searchPatterns };
    }).filter(v => v !== null);

    // 3. Verificar se o texto mudou (se mudou, temos de re-escanear tudo)
    const currentCoordsStr = JSON.stringify(currentCoords.map(c => c.book + c.cap + c.originalVerses));
    
    if (currentCoordsStr !== lastDetectedCoordsStr) {
        needsBooksRefresh = true;
        needsPubsRefresh = true;
        lastDetectedCoordsStr = currentCoordsStr;
    }
    
    // Atualiza a vari√°vel global usada pela renderiza√ß√£o da B√≠blia
    detectedCoords = currentCoords;

    // 4. ATUALIZAR A B√çBLIA IMEDIATAMENTE (√© local, n√£o precisa de loader)
    renderBibleTranscription();

    statusInfo.textContent = "Scanner em curso...";

    // 5. PROCESSAMENTO DOS LIVROS (S√≥ se necess√°rio)
    if (needsBooksRefresh) {
        rawResultsCache.books = [];
        // Limpa resultados de livros da aba Mix
        rawResultsCache.mix = rawResultsCache.mix.filter(m => m.folder !== 'books');
        
        document.getElementById('tab-books').innerHTML = XRAY_LOADER_HTML;
        if(document.getElementById('tab-mix')) document.getElementById('tab-mix').innerHTML = XRAY_LOADER_HTML;
        
        await scanExternalData('books');
        applyFilters('books');
        needsBooksRefresh = false; // Reset da flag
    }

    // 6. PROCESSAMENTO DAS PUBLICA√á√ïES (S√≥ se necess√°rio)
    if (needsPubsRefresh) {
        rawResultsCache.pubs = [];
        // Limpa resultados de revistas da aba Mix
        rawResultsCache.mix = rawResultsCache.mix.filter(m => m.folder !== 'publicacoes');
        
        document.getElementById('tab-pubs').innerHTML = XRAY_LOADER_HTML;
        
        await scanExternalData('publicacoes');
        applyFilters('publicacoes');
        needsPubsRefresh = false; // Reset da flag
    }

    // Atualiza a aba Mix no final se houver temas ativos
    applyFilters('mix');
    
    statusInfo.textContent = "X-Ray Conclu√≠do.";
}

async function scanExternalData(folder) {
    const activeThemes = Object.keys(xrayFilters.themes).filter(t => xrayFilters.themes[t]);
    
    if (folder === 'publicacoes') {
        // Revistas
        for (let ano = CONFIG_SCAN.anoFim; ano >= CONFIG_SCAN.anoInicio; ano--) {
            if (!xrayFilters.watchtower[ano] && !xrayFilters.awake[ano]) continue;
            for (const mes of CONFIG_SCAN.meses) {
                if (xrayFilters.watchtower[ano]) {
                    await fetchAndProcess(`./js/publicacoes/sentinelas/${ano}/${mes}.json`, `sentinelas/${ano}/${mes}`, 'publicacoes', rawResultsCache.pubs, `${mes}/${ano}`, activeThemes);
                }
                if (xrayFilters.awake[ano]) {
                    await fetchAndProcess(`./js/publicacoes/despertai/${ano}/${mes}.json`, `despertai/${ano}/${mes}`, 'publicacoes', rawResultsCache.pubs, `${mes}/${ano}`, activeThemes);
                }
            }
        }
        // Outras Pubs (mwb, km)
        for (const sigla of Object.keys(xrayFilters.pubs).filter(s => xrayFilters.pubs[s])) {
            await fetchAndProcess(`./js/publicacoes/${sigla}.json`, sigla, 'publicacoes', rawResultsCache.pubs, "", activeThemes);
        }
    } else {
        // Livros
        for (const sigla of Object.keys(xrayFilters.books).filter(s => xrayFilters.books[s])) {
            await fetchAndProcess(`./js/books/${sigla}.json`, sigla, 'books', rawResultsCache.books, "", activeThemes);
        }
    }
}

async function fetchAndProcess(url, sigla, folder, targetArray, dateLabel, activeThemes) {
    try {
        let data = localLibraryCache[sigla];
        if (!data) {
            const resp = await fetch(url);
            if (!resp.ok) return;
            data = await resp.json();
            localLibraryCache[sigla] = data;
        }

        const secoes = data.artigos || data.capitulos || [];
        secoes.forEach((secao, sIdx) => {
            secao.conteudo.forEach((block, bIdx) => {
                if (!block.texto) return;
                detectedCoords.forEach(v => {
                    if (v.searchPatterns.some(p => p.test(block.texto))) {
                        const resObj = {
                            sigla, folder, matchKey: `${v.book} ${v.cap}:${v.originalVerses}`,
                            pubTitle: dateLabel ? `${data.titulo || "Revista"} (${dateLabel})` : (data.titulo || sigla),
                            capTitle: secao.titulo, capIdx: sIdx, blockIdx: bIdx, pNum: block.numero_ref,
                            text: block.texto, matchRef: `${v.book} ${v.cap}:${v.originalVerses}`
                        };
                        targetArray.push(resObj);

                        // Verifica√ß√£o Sem√¢ntica para Aba Mix üçú
                        activeThemes.forEach(themeKey => {
                            if (checkThemeMatch(block.texto, secao, themeKey)) {
                                rawResultsCache.mix.push({ ...resObj, themeTag: themeKey });
                            }
                        });
                    }
                });
            });
        });
    } catch (e) {}
}

// --- 7. RENDERIZA√á√ÉO E FILTROS ---

function applyFilters(target = 'all') {
    const activeKeys = detectedCoords.filter(c => c.isActive).map(c => `${c.book} ${c.cap}:${c.originalVerses}`);
    const hasActiveThemes = Object.values(xrayFilters.themes).some(v => v === true);
    
    // Controlar visibilidade da aba Mix
    const mixTabBtn = document.getElementById('tab-btn-mix');
    if (mixTabBtn) mixTabBtn.style.display = hasActiveThemes ? 'block' : 'none';

    if (target === 'all' || target === 'books') {
        const f = rawResultsCache.books.filter(r => activeKeys.includes(r.matchKey));
        renderResults(f, document.getElementById('tab-books'), 'books');
    }
    if (target === 'all' || target === 'publicacoes') {
        const f = rawResultsCache.pubs.filter(r => activeKeys.includes(r.matchKey));
        renderResults(f, document.getElementById('tab-pubs'), 'publicacoes');
    }
    if (target === 'all' || target === 'mix') {
        const f = rawResultsCache.mix.filter(r => activeKeys.includes(r.matchKey));
        renderResults(f, document.getElementById('tab-mix'), 'mix');
    }
}

function renderResults(data, container, folderType) {
    if (!container) return;
    const picHTML = getPiccardsHTML();
    if (data.length === 0) {
        container.innerHTML = picHTML + '<p style="padding:20px; color:#666; text-align:center;">Nenhum resultado encontrado.</p>';
        return;
    }
    // Remover duplicados (mesmo par√°grafo na mesma publica√ß√£o)
    const unique = data.filter((v, i, a) => a.findIndex(t => t.sigla === v.sigla && t.blockIdx === v.blockIdx) === i);
    
    const cards = unique.map(res => `
        <div class="res-card" onclick="window.openInViewer('${res.sigla}', ${res.capIdx}, ${res.blockIdx}, '${res.folder === 'publicacoes' ? 'publicacoes' : 'books'}')">
            <span class="res-ref">${res.pubTitle} ${res.themeTag ? `| üçú ${res.themeTag}` : ''}</span>
            <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">${res.capTitle}</div>
            <div class="res-text"><b>${res.matchRef}</b> ‚Äî ${res.text}</div>
        </div>
    `).join('');
    container.innerHTML = picHTML + cards;
}

// --- 8. UI HELPERS (MODALS, TABS) ---

window.switchFilterTab = (paneId, btn) => {
    const modal = document.getElementById('xray-filter-modal');
    modal.querySelectorAll('.filter-pane').forEach(p => p.style.display = 'none');
    document.getElementById(paneId).style.display = 'grid';
    modal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};

window.openFilterModal = () => {
    renderFilterGrid('f-books', xrayFilters.books, SIGLAS_PUBLICACOES);
    renderFilterGrid('f-pubs', xrayFilters.pubs, SIGLAS_PUBLICACOES);
    renderFilterGrid('f-w', xrayFilters.watchtower, null, "Ano ");
    renderFilterGrid('f-g', xrayFilters.awake, null, "Ano ");
    renderFilterGrid('f-themes', xrayFilters.themes, null, "Tema: ");
    
    document.getElementById('xray-filter-modal').style.display = 'flex';
};

function renderFilterGrid(containerId, filterObj, labelsObj, prefix = "") {
    const container = document.getElementById(containerId);
    if(!container) return;
    container.innerHTML = '';
    const keys = Object.keys(filterObj).sort((a, b) => isNaN(a) ? a.localeCompare(b) : b - a);
    
    keys.forEach(key => {
        const div = document.createElement('div');
        div.className = `filter-item ${filterObj[key] ? 'active' : ''}`;
        const label = labelsObj ? (labelsObj[key] || key.toUpperCase()) : prefix + key;
        div.innerHTML = `<span>${label}</span> <span class="check">‚úì</span>`;
        
        div.onclick = () => {
            filterObj[key] = !filterObj[key];
            div.classList.toggle('active');

            // --- L√ìGICA DE DETE√á√ÉO DE MUDAN√áA ---
            if (containerId === 'f-books') {
                needsBooksRefresh = true;
            } else if (['f-pubs', 'f-w', 'f-g'].includes(containerId)) {
                needsPubsRefresh = true;
            } else if (containerId === 'f-themes') {
                // Se mudar o tema, geralmente precisamos re-escanear tudo para a aba Mix
                needsBooksRefresh = true;
                needsPubsRefresh = true;
            }
        };
        container.appendChild(div);
    });
}

function getPiccardsHTML() {
    let html = `<div class="tab-filter-container">
        <div class="piccard" onclick="window.openFilterModal()" style="background:#252528; border-color:#444;">‚öôÔ∏è Filtros</div>`;
    html += detectedCoords.map((c, i) => `
        <div class="piccard ${c.isActive ? 'active' : ''}" onclick="window.togglePiccard(${i})">
            ${c.book} ${c.cap}:${c.originalVerses}
        </div>`).join('');
    return html + `</div>`;
}

window.togglePiccard = (idx) => {
    detectedCoords[idx].isActive = !detectedCoords[idx].isActive;
    renderBibleTranscription();
    applyFilters('all');
};

window.openInViewer = async (sigla, capIdx, targetIdx, folder) => {
    // Mudar para aba Viewer
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === 'viewer'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-viewer'));
    
    const container = document.getElementById('viewer-container');
    container.innerHTML = XRAY_LOADER_HTML;

    try {
        let data = localLibraryCache[sigla];
        if (!data) {
            const resp = await fetch(`./js/${folder}/${sigla}.json`);
            data = await resp.json();
        }
        const cap = (data.artigos || data.capitulos)[capIdx];
        let html = `<div style="color:var(--accent-color); font-size:1.2rem; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">${cap.titulo}</div>`;
        cap.conteudo.forEach((b, i) => {
            html += `<div class="viewer-block ${i === targetIdx ? 'highlight-target' : ''}" id="v-block-${i}">
                ${b.numero_ref ? `<span class="para-badge">${b.numero_ref}</span>` : ''} ${b.texto}
            </div>`;
        });
        container.innerHTML = html;
        setTimeout(() => document.getElementById(`v-block-${targetIdx}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
    } catch (e) { container.innerHTML = "Erro ao carregar no visualizador."; }
};

// --- 9. BIBLIA E UTILS ---

async function renderBibleTranscription() {
    const container = document.getElementById('tab-bible');
    const active = detectedCoords.filter(c => c.isActive);
    const picHTML = getPiccardsHTML();
    if (active.length === 0) { container.innerHTML = picHTML + '<p style="padding:20px; color:#666; text-align:center;">Sem vers√≠culos ativos.</p>'; return; }

    let html = '';
    for (const c of active) {
        const file = c.book.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_");
        const bookName = c.book === "Revela√ß√£o" ? "Apocalipse" : c.book;
        try {
            if (!localBibleCache[file]) {
                const r = await fetch(`./js/bible/${file}.json`);
                localBibleCache[file] = await r.json();
            }
            const data = localBibleCache[file][bookName];
            let txt = '';
            c.verses.forEach(v => { if(data[c.cap][v]) txt += `<span style="color:var(--accent-color); font-size:0.7rem; vertical-align:super; margin-right:4px;">${v}</span>${data[c.cap][v]} `; });
            html += `<div class="res-card"><span class="res-ref">üìñ ${c.book} ${c.cap}:${c.originalVerses}</span><div class="res-text">${txt}</div></div>`;
        } catch (e) { html += `<div class="res-card">Erro ao carregar ${c.book}</div>`; }
    }
    container.innerHTML = picHTML + html;
}

function createBibleRegex() {
    const books = BIBLE_DATA.map(b => b.nome);
    const siglas = Object.keys(BIBLE_ABBREVIATIONS);
    const all = [...books, ...siglas].sort((a,b) => b.length - a.length);
    return new RegExp(`\\b((?:${all.map(p => p.replace(/\./g, '\\.')).join('|')})\\.?\\s+\\d+[:.]\\d+(?:\\s*[-‚Äì,;]\\s*\\d+[:.-]?\\d*)*)`, 'gi');
}

function parseReference(ref) {
    const match = ref.match(/^(.+?)\.?\s+(\d+.*)$/);
    if (!match) return null;
    const bookName = BIBLE_ABBREVIATIONS[match[1].trim()] || match[1].trim();
    const parts = match[2].split(/[:.]/);
    if (parts.length < 2) return null;
    const vRaw = parts[1].trim();
    let verses = [];
    if (vRaw.includes('-')) {
        const r = vRaw.split('-');
        for (let i = parseInt(r[0]); i <= parseInt(r[1]); i++) verses.push(i.toString());
    } else { verses = vRaw.split(/[,;]/).map(v => v.trim().split(' ')[0]); }
    return { book: bookName, cap: parts[0].trim(), verses, originalVerses: vRaw };
}

// --- 10. SAVE / LOAD E EVENTOS ---

window.saveXrayDoc = () => {
    document.getElementById('save-xray-title-input').value = "";
    document.getElementById('save-xray-modal').style.display = 'flex';
};

window.confirmSaveXray = async () => {
    const title = document.getElementById('save-xray-title-input').value || "Sem T√≠tulo";
    try {
        await addDoc(collection(db, "xray_docs"), {
            userId: currentUser.uid,
            title: title,
            content: editor.innerHTML,
            timestamp: serverTimestamp()
        });
        document.getElementById('save-xray-modal').style.display = 'none';
        alert("Documento gravado!");
    } catch (e) { alert("Erro ao gravar."); }
};

window.openLoadXrayModal = async () => {
    const list = document.getElementById('load-list-container');
    list.innerHTML = "<p>A carregar...</p>";
    document.getElementById('load-xray-modal').style.display = 'flex';
    try {
        const q = query(collection(db, "xray_docs"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        list.innerHTML = "";
        snap.forEach(docSnap => {
            const data = docSnap.data();
            const div = document.createElement('div');
            div.className = "load-item";
            div.innerHTML = `<span>${data.title}</span><small>${data.timestamp?.toDate().toLocaleDateString()}</small>`;
            div.onclick = () => {
                editor.innerHTML = data.content;
                document.getElementById('load-xray-modal').style.display = 'none';
                performXRay();
            };
            list.appendChild(div);
        });
    } catch (e) { list.innerHTML = "Erro ao carregar lista."; }
};

// Eventos de Editor
editor.addEventListener('input', () => {
    clearTimeout(scanTimeout);
    scanTimeout = setTimeout(performXRay, 1200);
});

editor.addEventListener('paste', (e) => {
    e.preventDefault();
    const text = (e.originalEvent || e).clipboardData.getData('text/plain');
    document.execCommand("insertText", false, text);
});

// Aba Click Handler
document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
    };
});

// --- FUN√á√ïES DE INTERFACE PARA O MODAL (EXPORTADAS PARA O WINDOW) ---

window.applyFiltersAndRescan = () => {
    // Fecha o modal
    document.getElementById('xray-filter-modal').style.display = 'none';
    
    // Limpa os resultados atuais para for√ßar novo scan com os novos filtros
    rawResultsCache = { books: [], pubs: [], mix: [] };
    
    // Executa o scanner novamente
    performXRay();
};

window.toggleAllInActiveTab = (state) => {
    // Descobre qual √© o painel de filtros que est√° vis√≠vel no momento
    const activePane = Array.from(document.querySelectorAll('.filter-pane')).find(p => p.style.display === 'grid');
    if (!activePane) return;

    const items = activePane.querySelectorAll('.filter-item');
    let filterTarget;

    // Mapeia o ID do painel para o objeto de filtros correto
    if (activePane.id === 'f-books') filterTarget = xrayFilters.books;
    else if (activePane.id === 'f-pubs') filterTarget = xrayFilters.pubs;
    else if (activePane.id === 'f-w') filterTarget = xrayFilters.watchtower;
    else if (activePane.id === 'f-g') filterTarget = xrayFilters.awake;
    else if (activePane.id === 'f-themes') filterTarget = xrayFilters.themes;

    if (filterTarget) {
        Object.keys(filterTarget).forEach(k => filterTarget[k] = state);
        items.forEach(item => {
            if (state) item.classList.add('active');
            else item.classList.remove('active');
        });
    }
};

</script>
</body>
</html> 
