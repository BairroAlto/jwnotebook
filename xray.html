<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - X-Ray Scanner</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczO__qtgAbiMjh7jLHkq16igyxnU-GZ9_YDxeCVFW_YfGphIsST9KpuTCLyCsDbreAf_H5p9H7OynO0fFj5j0wGNL6o_P2qookQXQH-xE_XULJte89NA6FIcNA3GmMKugIGsrJJWAlN-XH5JaUGoXzYT=w1024-h869-s-no-gm?authuser=4">

    <style>
        :root {
            --bg-color: #0f0f12;
            --sidebar-color: #1a1a1d;
            --accent-color: #3498db;
            --text-color: #f0f0f0;
            --border-color: #333;
            --panel-bg: #141417;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: 50px;
            background: var(--sidebar-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
        }
        .logo { font-weight: bold; color: var(--accent-color); letter-spacing: 2px; }

        #main-layout { display: flex; flex: 1; overflow: hidden; }

        /* LADO ESQUERDO */
        #input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            gap: 15px;
        }
        #xray-title {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border-color);
            color: var(--accent-color);
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px 0;
            outline: none;
        }
        #xray-editor {
            flex: 1;
            background: #16161a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: #ccc;
            padding: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* LADO DIREITO */
        #xray-panel {
            width: 480px;
            background: var(--sidebar-color);
            display: flex;
            flex-direction: column;
        }

        .tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            flex: 1; padding: 15px 0; background: none; border: none;
            color: #666; cursor: pointer; font-size: 1.2rem;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--accent-color); border-bottom-color: var(--accent-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.active { display: block; }

        /* CARDS */
        .res-card {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; margin-bottom: 12px;
            cursor: pointer; transition: 0.2s;
        }
        .res-card:hover { border-color: var(--accent-color); }
        .res-ref { color: var(--accent-color); font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block; }
        .res-text { font-size: 0.95rem; color: #bbb; line-height: 1.5; text-align: justify; }
        .v-num { color: var(--accent-color); font-weight: bold; font-size: 0.7em; vertical-align: super; margin-right: 4px; }

        /* VIEWER */
        #viewer-container { line-height: 1.7; font-size: 1rem; padding-bottom: 100px; }
        .viewer-title { color: var(--accent-color); font-size: 1.4rem; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .viewer-block { margin-bottom: 15px; padding: 10px; border-radius: 6px; }
        .viewer-block.highlight-target { background: rgba(52, 152, 219, 0.15); border-left: 4px solid var(--accent-color); }
        .para-badge { background: #333; color: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; font-family: monospace; }

        .spinner { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        [contenteditable]:empty:before { content: attr(placeholder); color: #555; }
    </style>
</head>
<body>

    <header>
        <div class="logo">NOTA<span>BOOK</span> / X-RAY</div>
        <div id="status-info" style="font-size: 0.8rem; color: #666;">Aguardando texto...</div>
    </header>

    <div id="main-layout">
        <section id="input-section">
            <input type="text" id="xray-title" placeholder="T√≠tulo da An√°lise...">
            <div id="xray-editor" contenteditable="true" placeholder="Cole ou escreva o seu texto aqui..."></div>
        </section>

        <aside id="xray-panel">
            <div class="tabs">
                <button class="tab-btn active" data-tab="bible">üìñ</button>
                <button class="tab-btn" data-tab="books">üìî</button>
                <button class="tab-btn" data-tab="pubs">üìö</button>
                <button class="tab-btn" data-tab="viewer">ü™∂</button>
            </div>

            <div id="tab-bible" class="tab-content active"></div>
            <div id="tab-books" class="tab-content"></div>
            <div id="tab-pubs" class="tab-content"></div>
            <div id="tab-viewer" class="tab-content"><div id="viewer-container"></div></div>
        </aside>
    </div>

    <script type="module">
        import { BIBLE_DATA } from './js/bible-data.js';
        import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';
        import { BIBLE_ABBREVIATIONS } from './js/bible-map.js';

        let detectedCoords = []; // Coordenadas normalizadas { book, cap, verses: [] }
        let scanTimeout;
        const bibleCache = {}; // Cache para ficheiros da b√≠blia JSON

        const editor = document.getElementById('xray-editor');
        const statusInfo = document.getElementById('status-info');

        editor.addEventListener('input', () => {
            statusInfo.textContent = "Digitando...";
            clearTimeout(scanTimeout);
            scanTimeout = setTimeout(performXRay, 1000);
        });

        async function performXRay() {
            const text = editor.innerText;
            if (text.length < 5) return;

            const bibleRegex = createBibleRegex();
            const matches = text.match(bibleRegex) || [];
            
            statusInfo.textContent = `Encontradas ${matches.length} refer√™ncias. Escaneando...`;

            detectedCoords = [];
            [...new Set(matches)].forEach(m => {
                const info = parseReference(m);
                if (info) detectedCoords.push(info);
            });

            await renderBibleTranscription();
            await scanExternalData('books', document.getElementById('tab-books'));
            await scanExternalData('publicacoes', document.getElementById('tab-pubs'));
            
            statusInfo.textContent = "X-Ray Conclu√≠do.";
        }

        // --- 1. TRANSCREVER B√çBLIA (üìñ) ---
        async function renderBibleTranscription() {
            const container = document.getElementById('tab-bible');
            container.innerHTML = '<div class="spinner"></div>';

            if (detectedCoords.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">Nenhuma refer√™ncia b√≠blica.</p>';
                return;
            }

            let html = '';

            for (const coord of detectedCoords) {
                const bookFile = getBibleFilename(coord.book);
                
                try {
                    if (!bibleCache[bookFile]) {
                        const resp = await fetch(`./js/bible/${bookFile}.json`);
                        bibleCache[bookFile] = await resp.json();
                    }

                    const bookData = bibleCache[bookFile][coord.book];
                    let transcription = '';

                    coord.verses.forEach(vNum => {
                        const vText = bookData[coord.cap][vNum];
                        if (vText) {
                            transcription += `<span class="v-num">${vNum}</span>${vText} `;
                        }
                    });

                    html += `
                        <div class="res-card">
                            <span class="res-ref">üìñ ${coord.book} ${coord.cap}:${coord.originalVerses}</span>
                            <div class="res-text">${transcription}</div>
                        </div>
                    `;
                } catch (e) {
                    console.error("Erro ao transcrever:", coord.book);
                }
            }

            container.innerHTML = html;
        }

        // --- 2. VARRER LIVROS E PUBLICA√á√ïES (üìî/üìö) ---
        async function scanExternalData(folder, container) {
            container.innerHTML = '<div class="spinner"></div>';
            const results = [];
            const siglaKeys = Object.keys(SIGLAS_PUBLICACOES);
            const isMag = (sigla) => ["w", "g", "wp", "km", "mwb"].includes(sigla);
            const targets = siglaKeys.filter(k => folder === 'books' ? !isMag(k) : isMag(k));

            for (const sigla of targets) {
                try {
                    const resp = await fetch(`./js/${folder}/${sigla}.json`);
                    if (!resp.ok) continue;
                    const data = await resp.json();

                    data.capitulos.forEach((cap, cIdx) => {
                        cap.conteudo.forEach((block) => {
                            if (!block.texto) return;
                            const blockText = block.texto.toLowerCase();

                            detectedCoords.forEach(v => {
                                // Procura no par√°grafo se existe men√ß√£o ao Livro + Cap:Ver
                                const hasBook = blockText.includes(v.book.toLowerCase());
                                const hasCoord = v.verses.some(ver => blockText.includes(`${v.cap}:${ver}`));

                                if (hasBook && hasCoord) {
                                    results.push({
                                        sigla, folder,
                                        pubTitle: data.titulo,
                                        capTitle: cap.titulo,
                                        capIdx: cIdx,
                                        pNum: block.numero_ref,
                                        text: block.texto,
                                        match: `${v.book} ${v.cap}:${v.originalVerses}`
                                    });
                                }
                            });
                        });
                    });
                } catch (e) {}
            }
            renderResults(results, container);
        }

        // --- VIEWER (ü™∂) ---
        window.openInViewer = async (sigla, capIdx, pNum, folder) => {
            switchTab('viewer');
            const container = document.getElementById('viewer-container');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const resp = await fetch(`./js/${folder}/${sigla}.json`);
                const data = await resp.json();
                const cap = data.capitulos[capIdx];

                let html = `<div class="viewer-title">${cap.titulo}</div>`;
                cap.conteudo.forEach(block => {
                    let isTarget = false;
                    if (block.numero_ref) {
                        const refs = block.numero_ref.toString().split(/[-‚Äì,]/);
                        isTarget = refs.includes(pNum.toString()) || block.numero_ref == pNum;
                    }
                    html += `<div class="viewer-block ${isTarget ? 'highlight-target' : ''}" id="p-${block.numero_ref}">
                        ${block.numero_ref ? `<span class="para-badge">${block.numero_ref}</span>` : ''}
                        ${block.texto}
                    </div>`;
                });
                container.innerHTML = html;
                setTimeout(() => {
                    const el = document.getElementById(`p-${pNum}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            } catch (e) { container.innerHTML = 'Erro ao carregar.'; }
        };

        // --- AUXILIARES ---
        function createBibleRegex() {
            const books = BIBLE_DATA.map(b => b.nome);
            const siglas = Object.keys(BIBLE_ABBREVIATIONS);
            const all = [...books, ...siglas].sort((a,b) => b.length - a.length);
            const pattern = all.map(p => p.replace(/\./g, '\\.')).join('|');
            return new RegExp(`\\b((?:${pattern})\\.?\\s+\\d+[:.]\\d+(?:\\s*[-‚Äì,;]\\s*\\d+[:.-]?\\d*)*)`, 'gi');
        }

        function parseReference(ref) {
            const match = ref.match(/^(.+?)\.?\s+(\d+.*)$/);
            if (!match) return null;
            
            const rawPrefix = match[1].trim();
            const bookName = BIBLE_ABBREVIATIONS[rawPrefix] || rawPrefix;
            const parts = match[2].split(/[:.]/);
            const cap = parts[0].trim();
            const versesRaw = parts[1].trim();

            // L√≥gica para expandir vers√≠culos (ex: 1-3 vira [1, 2, 3])
            let verses = [];
            if (versesRaw.includes('-') || versesRaw.includes('‚Äì')) {
                const range = versesRaw.split(/[-‚Äì]/);
                const start = parseInt(range[0]);
                const end = parseInt(range[1]);
                for (let i = start; i <= end; i++) verses.push(i.toString());
            } else {
                verses = versesRaw.split(/[,;]/).map(v => v.trim());
            }

            return { book: bookName, cap, verses, originalVerses: versesRaw };
        }

        function getBibleFilename(book) {
            return book.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_");
        }

        function renderResults(results, container) {
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">Sem correspond√™ncias.</p>';
                return;
            }
            const unique = results.filter((v, i, a) => a.findIndex(t => t.sigla === v.sigla && t.pNum === v.pNum) === i);
            container.innerHTML = unique.map(res => `
                <div class="res-card" onclick="window.openInViewer('${res.sigla}', ${res.capIdx}, '${res.pNum}', '${res.folder}')">
                    <span class="res-ref">${res.pubTitle}</span>
                    <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">${res.capTitle} | Par. ${res.pNum}</div>
                    <div class="res-text">Cita: <b>${res.match}</b> - ${res.text}</div>
                </div>
            `).join('');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tabId}`));
        }

        document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => switchTab(btn.dataset.tab));
    </script>
</body>
</html>
