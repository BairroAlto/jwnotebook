<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - X-Ray Scanner</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczO__qtgAbiMjh7jLHkq16igyxnU-GZ9_YDxeCVFW_YfGphIsST9KpuTCLyCsDbreAf_H5p9H7OynO0fFj5j0wGNL6o_P2qookQXQH-xE_XULJte89NA6FIcNA3GmMKugIGsrJJWAlN-XH5JaUGoXzYT=w1024-h869-s-no-gm?authuser=4">

    <style>
        :root {
            --bg-color: #0f0f12;
            --sidebar-color: #1a1a1d;
            --accent-color: #3498db;
            --text-color: #f0f0f0;
            --border-color: #333;
            --panel-bg: #141417;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: 50px;
            background: var(--sidebar-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
        }
        .logo { font-weight: bold; color: var(--accent-color); letter-spacing: 2px; }

        #main-layout { display: flex; flex: 1; overflow: hidden; }

        /* LADO ESQUERDO (EDITOR) */
        #input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            gap: 15px;
        }
        #xray-editor {
            flex: 1;
            background: #16161a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: #ccc;
            padding: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* LADO DIREITO (PAINEL) */
        #xray-panel {
            width: 480px;
            background: var(--sidebar-color);
            display: flex;
            flex-direction: column;
        }

        .tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            flex: 1; padding: 15px 0; background: none; border: none;
            color: #666; cursor: pointer; font-size: 1.2rem;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--accent-color); border-bottom-color: var(--accent-color);
            background: rgba(52, 152, 219, 0.05);
        }

.tab-content { 
    flex: 1; 
    overflow-y: auto; 
    padding: 0; /* Estava 15px, mudamos para 0 */
    display: none; 
    position: relative;
}
        .tab-content.active { display: block; }

        /* PICCARDS (FILTROS) */
.tab-filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 15px; /* Espa√ßamento interno da barra */
    background: var(--sidebar-color); /* Garante que √© opaca */
    border-bottom: 1px solid rgba(255,255,255,0.1); /* Linha subtil de separa√ß√£o */
    position: sticky;
    top: 0;
    z-index: 100; /* Garante que fica acima do texto ao fazer scroll */
    width: 100%;
}
        .piccard {
            background: rgba(255,255,255,0.03);
            border: 1px solid #444;
            color: #777;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.72rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .piccard.active {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .piccard.active::after { content: '‚úì'; font-size: 0.6rem; }

        /* RESULTADOS */
.res-card {
    background: var(--panel-bg); 
    border: 1px solid var(--border-color);
    border-radius: 8px; 
    padding: 15px; 
    margin: 12px 15px; /* Adicion√°mos 15px de margem lateral */
    cursor: pointer; 
    transition: 0.2s;
}

.tab-content > p {
    padding: 20px;
    text-align: center;
}
        .res-card:hover { border-color: var(--accent-color); transform: translateY(-1px); }
        .res-ref { color: var(--accent-color); font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block; }
        .res-text { font-size: 0.95rem; color: #bbb; line-height: 1.5; text-align: justify; }

        /* --- ANIMA√á√ÉO DA PARAB√ìLICA (LOADER) --- */
        .loader-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; color: var(--accent-color);
        }
        .scanner-ui { position: relative; width: 150px; height: 150px; margin-bottom: 20px; }
        .dish {
            position: absolute; bottom: 20%; left: 50%; width: 80px; height: 40px;
            border: 3px solid var(--accent-color); border-radius: 50% 50% 0 0;
            transform: translateX(-50%) rotate(180deg); background: rgba(52, 152, 219, 0.1);
        }
        .dish::after {
            content: ''; position: absolute; top: -20px; left: 50%;
            width: 3px; height: 25px; background: var(--accent-color); transform: translateX(-50%);
        }
        .wave {
            position: absolute; top: 15%; left: 50%; border: 2px solid var(--accent-color);
            border-radius: 50%; transform: translateX(-50%); opacity: 0; animation: wave-pulse 2s infinite;
        }
        .wave-1 { width: 40px; height: 20px; animation-delay: 0s; }
        .wave-2 { width: 70px; height: 35px; animation-delay: 0.5s; }
        .wave-3 { width: 100px; height: 50px; animation-delay: 1s; }

        @keyframes wave-pulse {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateX(-50%) scale(1.2); opacity: 0; }
        }

        .falling-icon { position: absolute; font-size: 1.2rem; opacity: 0; animation: capture-icon 1.5s infinite linear; }
        .icon-1 { left: 15%; animation-delay: 0.2s; }
        .icon-2 { left: 45%; animation-delay: 0.9s; }
        .icon-3 { left: 75%; animation-delay: 0.5s; }

        @keyframes capture-icon {
            0% { transform: translateY(-60px) scale(0.5); opacity: 0; }
            30% { opacity: 1; }
            80% { transform: translateY(20px) scale(0.8); opacity: 0.5; }
            100% { transform: translateY(40px) scale(0); opacity: 0; }
        }

        .loader-text { font-family: monospace; font-size: 0.75rem; letter-spacing: 3px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* VIEWER */
        .viewer-block { margin-bottom: 15px; padding: 10px; border-radius: 6px; color: #bbb; }
        .viewer-block.highlight-target { background: rgba(52, 152, 219, 0.15); border-left: 4px solid var(--accent-color); color: #fff; }
        .para-badge { background: #333; color: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; }

        [contenteditable]:empty:before { content: attr(placeholder); color: #555; }
        /* --- ESTILOS DO ESCUDO DE SEGURAN√áA (IGUAL √Ä LIBRARY) --- */
#global-auth-shield { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: #000; 
    z-index: 999999; /* Valor alt√≠ssimo para cobrir tudo */
    display: flex; 
    justify-content: center; 
    align-items: center; 
}

.global-spinner { 
    width: 40px; 
    height: 40px; 
    border: 4px solid #333; 
    border-top: 4px solid var(--accent-color); 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Bot√µes do Header */
.header-actions { display: flex; gap: 10px; align-items: center; }
.btn-xray {
    background: #252528; border: 1px solid #444; color: #ccc;
    padding: 6px 12px; border-radius: 6px; cursor: pointer;
    font-size: 0.85rem; transition: 0.2s; display: flex; align-items: center; gap: 6px;
}
.btn-xray:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.btn-xray.save-btn { background: rgba(46, 204, 113, 0.1); border-color: #2ecc71; color: #2ecc71; }
.btn-xray.save-btn:hover { background: #2ecc71; color: white; }

/* Modal de Ficheiros */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 200000; display: none;
    justify-content: center; align-items: center;
}
.modal-content {
    background: #1a1a1d; border: 1px solid #333; width: 90%; max-width: 500px;
    border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.xray-file-item {
    padding: 12px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s;
    display: flex; justify-content: space-between; align-items: center;
}
.xray-file-item:hover { background: rgba(52, 152, 219, 0.1); }
.file-date { font-size: 0.75rem; color: #666; }

/* Bot√µes de A√ß√£o no Header */
.header-actions { display: flex; gap: 10px; align-items: center; }
.action-btn {
    background: #252528;
    border: 1px solid #444;
    color: #ccc;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: 0.2s;
}
.action-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.action-btn.save-btn { border-color: #2ecc71; color: #2ecc71; }
.action-btn.save-btn:hover { background: #2ecc71; color: white; }

/* Modal de Carregamento */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000; display: none;
    justify-content: center; align-items: center;
}
.modal-content {
    background: #1a1a1d; width: 90%; max-width: 500px; border-radius: 12px;
    border: 1px solid #333; padding: 20px; display: flex; flex-direction: column;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.load-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.load-item {
    background: #252528; padding: 15px; border-radius: 8px; border: 1px solid #333;
    cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
}
.load-item:hover { border-color: var(--accent-color); background: #2a2a2e; }

#save-xray-title-input:focus {
    border-color: #2ecc71;
    background: #000;
}

.filter-pane {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}
.filter-item {
    background: #252528; border: 1px solid #333; padding: 8px;
    border-radius: 6px; font-size: 0.75rem; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
}
.filter-item.active { border-color: var(--accent-color); color: white; background: rgba(52, 152, 219, 0.1); }
.filter-item span.check { color: var(--accent-color); font-weight: bold; opacity: 0; }
.filter-item.active span.check { opacity: 1; }


    </style>
</head>
<body>

    <!-- ESCUDO DE CARREGAMENTO E SEGURAN√áA -->
<div id="global-auth-shield">
    <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="global-spinner"></div>
        <div id="global-progress-text" style="color: #666; font-family: monospace; font-size: 0.8rem; margin-top: 15px; letter-spacing: 1px;">SINCRONIZAR: 0%</div>
    </div>
</div>

<header>
    <div class="logo">NOTA<span>BOOK</span> / X-RAY</div>
    <div id="status-info" style="font-size: 0.8rem; color: #666; flex: 1; margin-left: 20px;">Pronto para analisar...</div>
    
    <div class="header-actions">
        <button class="action-btn save-btn" onclick="window.saveXrayDoc()">
            <span>üíæ</span> Gravar
        </button>
        <button class="action-btn" onclick="window.openLoadXrayModal()">
            <span>üìÇ</span> Abrir
        </button>
    </div>
</header>

<!-- MODAL PARA CARREGAR FICHEIROS X-RAY -->
<div id="load-xray-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--accent-color);">Documentos Gravados</h3>
            <button onclick="document.getElementById('load-xray-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="load-list-container" class="load-list">
            <!-- Itens injetados via JS -->
        </div>
    </div>
</div>

    <div id="main-layout">
        <section id="input-section">
            <div id="xray-editor" contenteditable="true" placeholder="Escreva ou cole o seu texto aqui..."></div>
        </section>

        <aside id="xray-panel">
            <div class="tabs">
                <button class="tab-btn active" data-tab="bible">üìñ</button>
                <button class="tab-btn" data-tab="books">üìî</button>
                <button class="tab-btn" data-tab="pubs">üìö</button>
                <button class="tab-btn" data-tab="viewer">ü™∂</button>
            </div>

            <div id="tab-bible" class="tab-content active"></div>
            <div id="tab-books" class="tab-content"></div>
            <div id="tab-pubs" class="tab-content"></div>
            <div id="tab-viewer" class="tab-content"><div id="viewer-container"></div></div>
        </aside>
    </div>


    <!-- MODAL PARA DAR NOME AO DOCUMENTO (SAVE) -->
<div id="save-xray-modal" class="modal-overlay" style="z-index: 2001;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 style="color: #2ecc71;">Gravar Documento</h3>
            <button onclick="document.getElementById('save-xray-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="padding: 10px 0;">
            <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 8px;">NOME DO DOCUMENTO</label>
            <input type="text" id="save-xray-title-input" 
                   style="width: 100%; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; border-bottom: 2px solid #2ecc71;">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="document.getElementById('save-xray-modal').style.display='none'" 
                    style="flex: 1; padding: 10px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>
            <button onclick="window.confirmSaveXray()" 
                    style="flex: 1; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">GRAVAR</button>
        </div>
    </div>
</div>


<!-- MODAL DE DEFINI√á√ïES DE FILTROS -->
<div id="xray-filter-modal" class="modal-overlay" style="z-index: 210000;">
    <div class="modal-content" style="max-width: 600px; height: 85vh;">
        <div class="modal-header">
            <h3 style="color: var(--accent-color);">‚öôÔ∏è Defini√ß√µes de Filtro</h3>
            <button onclick="document.getElementById('xray-filter-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- Abas Internas do Modal -->
        <div class="tabs" style="background: #1a1a1d; margin-top: -20px;">
            <button class="tab-btn active" onclick="switchFilterTab('f-books', this)" style="font-size: 0.9rem;">Livros</button>
            <button class="tab-btn" onclick="switchFilterTab('f-pubs', this)" style="font-size: 0.9rem;">Pubs</button>
            <button class="tab-btn" onclick="switchFilterTab('f-w', this)" style="font-size: 0.9rem;">Sentinela</button>
            <button class="tab-btn" onclick="switchFilterTab('f-g', this)" style="font-size: 0.9rem;">Despertai</button>
        </div>

        <div style="padding: 10px; background: #111; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn-xray" onclick="toggleAllInActiveTab(true)" style="font-size: 0.7rem;">Marcar Tudo</button>
            <button class="btn-xray" onclick="toggleAllInActiveTab(false)" style="font-size: 0.7rem;">Desmarcar Tudo</button>
        </div>

<div id="filter-scroll-area" style="flex: 1; overflow-y: auto; padding: 15px;">
    <div id="f-books" class="filter-pane active" style="display: grid;"></div>
    <div id="f-pubs" class="filter-pane" style="display: none;"></div>
    <div id="f-w" class="filter-pane" style="display: none;"></div>
    <div id="f-g" class="filter-pane" style="display: none;"></div>
</div>

        <div style="padding: 15px; border-top: 1px solid #333;">
            <button class="action-btn save-btn" style="width: 100%; justify-content: center;" onclick="applyFiltersAndRescan()">
                APLICAR E REESCANEAR
            </button>
        </div>
    </div>
</div>


    <script type="module">
   // --- 1. IMPORTA√á√ïES DE SEGURAN√áA E FIREBASE ---
// --- 1. IMPORTA√á√ïES DE SEGURAN√áA E FIREBASE ---
import { db, auth } from './js/firebase-config.js';
import { 
    doc, getDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

// --- 2. IMPORTA√á√ïES DE DADOS LOCAIS ---
import { BIBLE_DATA } from './js/bible-data.js';
import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';
import { BIBLE_ABBREVIATIONS } from './js/bible-map.js';

// --- 3. VARI√ÅVEIS DE ESTADO GLOBAL E CACHE ---
let currentUser = null;
let localLibraryCache = {}; 
let localBibleCache = {};
let detectedCoords = []; 
let rawResultsCache = { books: [], pubs: [] }; 
let scanTimeout;

const editor = document.getElementById('xray-editor');
const statusInfo = document.getElementById('status-info');

// Configura√ß√£o do Scanner
const CONFIG_SCAN = {
    anoInicio: 1950,
    anoFim: 2026,
    meses: ["12", "11", "10", "09", "08", "07", "06", "05", "04", "03", "02", "01"]
};

// Estado dos Filtros
let xrayFilters = {
    books: {}, 
    pubs: {},  
    watchtower: {}, 
    awake: {}       
};

const XRAY_LOADER_HTML = `
    <div class="loader-container">
        <div class="scanner-ui">
            <div class="falling-icon icon-1">üìî</div>
            <div class="falling-icon icon-2">üìÑ</div>
            <div class="falling-icon icon-3">üìö</div>
            <div class="wave wave-1"></div><div class="wave wave-2"></div><div class="wave wave-3"></div>
            <div class="dish"></div>
        </div>
        <div class="loader-text">ESCANEAR FREQU√äNCIAS...</div>
    </div>
`;

// --- 4. INICIALIZA√á√ÉO DE FILTROS E PRE-DOWNLOAD ---

function initFilters() {
    const exclusoesPeriodicos = ["w", "g", "wp", "km", "mwb", "jwbvod", "jwb", "mwbv"];
    // Livros
    Object.keys(SIGLAS_PUBLICACOES).forEach(s => {
        if (!exclusoesPeriodicos.includes(s)) xrayFilters.books[s] = true;
    });
    // Publica√ß√µes secund√°rias (MWB, KM)
    ["mwb", "km"].forEach(s => { xrayFilters.pubs[s] = true; });
    // Anos
    for (let ano = CONFIG_SCAN.anoInicio; ano <= CONFIG_SCAN.anoFim; ano++) {
        xrayFilters.watchtower[ano.toString()] = true;
        xrayFilters.awake[ano.toString()] = true;
    }
}

async function preloadXrayCore() {
    const progressText = document.getElementById('global-progress-text');
    const booksToLoad = Object.keys(xrayFilters.books);
    const bibleToLoad = BIBLE_DATA;

    let loaded = 0;
    const total = booksToLoad.length + bibleToLoad.length;

    const updateProgress = () => {
        loaded++;
        if (progressText) {
            const percent = Math.round((loaded / total) * 100);
            progressText.innerText = `SINCRONIZAR: ${percent}%`;
        }
    };

    const biblePromises = bibleToLoad.map(async (book) => {
        const filename = book.nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_");
        try {
            const resp = await fetch(`./js/bible/${filename}.json`);
            if (resp.ok) localBibleCache[filename] = await resp.json();
        } catch (e) {}
        updateProgress();
    });

    const bookPromises = booksToLoad.map(async (id) => {
        try {
            const resp = await fetch(`./js/books/${id}.json`);
            if (resp.ok) localLibraryCache[id] = await resp.json();
        } catch (e) {}
        updateProgress();
    });

    await Promise.all([...biblePromises, ...bookPromises]);
}

// --- 5. BLOCO DE SEGURAN√áA E AUTH ---

onAuthStateChanged(auth, async (user) => {
    const shield = document.getElementById('global-auth-shield');
    if (!user) { window.location.href = "404.html"; return; }

    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().aceite !== "on") { 
            window.location.href = "index.html"; 
            return; 
        }

        currentUser = user;
        initFilters();
        await preloadXrayCore();

        if (shield) {
            shield.style.transition = "opacity 0.5s ease";
            shield.style.opacity = "0";
            setTimeout(() => shield.style.display = 'none', 500);
        }
    } catch (e) { console.error(e); }
});

// --- 6. FUN√á√ïES DO MODAL DE FILTROS ---

window.openFilterModal = () => {
    renderFilterGrid('f-books', xrayFilters.books, SIGLAS_PUBLICACOES);
    renderFilterGrid('f-pubs', xrayFilters.pubs, SIGLAS_PUBLICACOES);
    renderFilterGrid('f-w', xrayFilters.watchtower, null, "Ano ");
    renderFilterGrid('f-g', xrayFilters.awake, null, "Ano ");
    
    document.getElementById('xray-filter-modal').style.display = 'flex';
    const firstTabBtn = document.querySelector('#xray-filter-modal .tab-btn');
    window.switchFilterTab('f-books', firstTabBtn);
};

window.switchFilterTab = (paneId, btn) => {
    const modal = document.getElementById('xray-filter-modal');
    modal.querySelectorAll('.filter-pane').forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
    });
    const target = document.getElementById(paneId);
    if (target) {
        target.style.display = 'grid';
        target.classList.add('active');
    }
    modal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
};

function renderFilterGrid(containerId, filterObj, labelsObj, prefix = "") {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const keys = Object.keys(filterObj).sort((a, b) => isNaN(a) ? a.localeCompare(b) : b - a);

    keys.forEach(key => {
        const div = document.createElement('div');
        div.className = `filter-item ${filterObj[key] ? 'active' : ''}`;
        const label = labelsObj ? (labelsObj[key] || key.toUpperCase()) : prefix + key;
        div.innerHTML = `<span>${label}</span> <span class="check">‚úì</span>`;
        div.onclick = () => {
            filterObj[key] = !filterObj[key];
            div.classList.toggle('active');
        };
        container.appendChild(div);
    });
}

window.toggleAllInActiveTab = (state) => {
    const activePane = document.querySelector('.filter-pane.active');
    if (!activePane) return;
    const items = activePane.querySelectorAll('.filter-item');
    let filterTarget;
    if (activePane.id === 'f-books') filterTarget = xrayFilters.books;
    else if (activePane.id === 'f-pubs') filterTarget = xrayFilters.pubs;
    else if (activePane.id === 'f-w') filterTarget = xrayFilters.watchtower;
    else if (activePane.id === 'f-g') filterTarget = xrayFilters.awake;

    if (filterTarget) {
        Object.keys(filterTarget).forEach(k => filterTarget[k] = state);
        items.forEach(item => {
            if (state) item.classList.add('active');
            else item.classList.remove('active');
        });
    }
};

window.applyFiltersAndRescan = () => {
    document.getElementById('xray-filter-modal').style.display = 'none';
    performXRay(); 
};

// --- 7. MOTOR DO SCANNER (CORRIGIDO PARA PUBLICAC√ñESS) ---

async function performXRay() {
    const text = editor.innerText;
    if (text.length < 3) return;

    const bibleRegex = createBibleRegex();
    const matches = [...new Set(text.match(bibleRegex) || [])];
    
    detectedCoords = matches.map(m => {
        const info = parseReference(m);
        if (!info) return null;
        const existing = detectedCoords.find(c => c.book === info.book && c.originalVerses === info.originalVerses);
        
        const variants = Object.keys(BIBLE_ABBREVIATIONS).filter(s => BIBLE_ABBREVIATIONS[s] === info.book);
        variants.push(info.book);
        const escaped = [...new Set(variants)].map(v => v.replace(/\./g, '\\.')).join('|');
        const searchPatterns = info.verses.map(ver => new RegExp(`(?:^|\\s|‚Äî|\\()(${escaped})\\.?\\s*${info.cap}[:.]${ver}\\b`, 'i'));

        return { ...info, isActive: existing ? existing.isActive : true, searchPatterns };
    }).filter(v => v !== null);

    rawResultsCache = { books: [], pubs: [] };
    document.getElementById('tab-bible').innerHTML = XRAY_LOADER_HTML;
    document.getElementById('tab-books').innerHTML = XRAY_LOADER_HTML;
    document.getElementById('tab-pubs').innerHTML = XRAY_LOADER_HTML;

    statusInfo.textContent = "Scanner em curso...";

    renderBibleTranscription(); 

    // Busca nos Livros (RAM)
    scanExternalData('books').then(() => {
        applyFilters('books'); 
    });

    // Busca nas Revistas e Pubs (Rede)
    scanExternalData('publicacoes').then(() => {
        applyFilters('publicacoes'); 
        statusInfo.textContent = "X-Ray Conclu√≠do.";
    });
}

async function scanExternalData(folder) {
    if (folder === 'publicacoes') {
        // 1. Pesquisa Revistas nos Anos Ativos
        for (let ano = CONFIG_SCAN.anoFim; ano >= CONFIG_SCAN.anoInicio; ano--) {
            const wActive = xrayFilters.watchtower[ano.toString()];
            const gActive = xrayFilters.awake[ano.toString()];
            if (!wActive && !gActive) continue;

            for (const mes of CONFIG_SCAN.meses) {
                if (wActive) {
                    const siglaW = `sentinelas/${ano}/${mes}`;
                    // AJUSTE PARA O CAMINHO DA IMAGEM: publicacoess
                    await fetchAndProcess(`./js/publicacoes/${siglaW}.json`, siglaW, 'publicacoes', rawResultsCache.pubs, `${mes}/${ano}`);
                }
                if (gActive) {
                    const siglaG = `despertai/${ano}/${mes}`;
                    await fetchAndProcess(`./js/publicacoes/${siglaG}.json`, siglaG, 'publicacoes', rawResultsCache.pubs, `${mes}/${ano}`);
                }
            }
        }
        // 2. Pesquisa Outras Publica√ß√µes (MWB, KM)
        const siglasPubs = Object.keys(xrayFilters.pubs).filter(s => xrayFilters.pubs[s]);
        for (const sigla of siglasPubs) {
            await fetchAndProcess(`./js/publicacoes/${sigla}.json`, sigla, 'publicacoes', rawResultsCache.pubs);
        }

    } else {
        // Busca Livros em js/books/
        const siglasLivros = Object.keys(xrayFilters.books).filter(s => xrayFilters.books[s]);
        for (const sigla of siglasLivros) {
            await fetchAndProcess(`./js/books/${sigla}.json`, sigla, 'books', rawResultsCache.books);
        }
    }
}

async function fetchAndProcess(url, sigla, folder, targetArray, dateLabel = "") {
    try {
        let data;
        if (localLibraryCache[sigla]) {
            data = localLibraryCache[sigla];
        } else {
            const resp = await fetch(url);
            if (!resp.ok) return;
            data = await resp.json();
            localLibraryCache[sigla] = data; 
        }

        const secoes = data.artigos || data.capitulos || [];
        secoes.forEach((secao, sIdx) => {
            secao.conteudo.forEach((block, bIdx) => {
                if (!block.texto) return;
                detectedCoords.forEach(v => {
                    if (v.searchPatterns.some(p => p.test(block.texto))) {
                        targetArray.push({
                            sigla, folder, matchKey: `${v.book} ${v.cap}:${v.originalVerses}`,
                            pubTitle: dateLabel ? `${data.titulo || "Revista"} (${dateLabel})` : (data.titulo || sigla),
                            capTitle: secao.titulo, capIdx: sIdx, blockIdx: bIdx, pNum: block.numero_ref,
                            text: block.texto, matchRef: `${v.book} ${v.cap}:${v.originalVerses}`
                        });
                    }
                });
            });
        });
    } catch (e) {}
}

// --- 8. RENDERIZA√á√ÉO DA UI ---

function getPiccardsHTML() {
    let html = `<div class="tab-filter-container">
        <div class="piccard" onclick="window.openFilterModal()" style="background: #252528; color: #aaa; border-color: #444;">
            ‚öôÔ∏è Filtros
        </div>`;
    
    if (detectedCoords.length > 0) {
        html += detectedCoords.map((coord, idx) => `
            <div class="piccard ${coord.isActive ? 'active' : ''}" onclick="window.togglePiccard(${idx})">
                ${coord.book} ${coord.cap}:${coord.originalVerses}
            </div>`).join('');
    }
    return html + `</div>`;
}

window.togglePiccard = (index) => {
    detectedCoords[index].isActive = !detectedCoords[index].isActive;
    refreshAllTabs();
};

function refreshAllTabs() {
    renderBibleTranscription();
    applyFilters('all');
}

function applyFilters(target = 'all') {
    const activeKeys = detectedCoords.filter(c => c.isActive).map(c => `${c.book} ${c.cap}:${c.originalVerses}`);
    
    if (target === 'all' || target === 'books') {
        const fBooks = rawResultsCache.books.filter(res => activeKeys.includes(res.matchKey));
        renderResults(fBooks, document.getElementById('tab-books'), 'books');
    }
    
    if (target === 'all' || target === 'publicacoes') {
        const fPubs = rawResultsCache.pubs.filter(res => activeKeys.includes(res.matchKey));
        renderResults(fPubs, document.getElementById('tab-pubs'), 'publicacoess');
    }
}

function renderResults(data, container, folder) {
    const picHTML = getPiccardsHTML();
    if (data.length === 0) { 
        container.innerHTML = picHTML + '<p style="text-align:center; padding:20px; color:#666;">Nenhum resultado.</p>'; 
        return; 
    }
    const unique = data.filter((v, i, a) => a.findIndex(t => t.sigla === v.sigla && t.blockIdx === v.blockIdx) === i);
    const cards = unique.map(res => `
        <div class="res-card" onclick="window.openInViewer('${res.sigla}', ${res.capIdx}, ${res.blockIdx}, '${res.folder === 'publicacoes' ? 'publicacoess' : 'books'}')">
            <span class="res-ref">${res.pubTitle}</span>
            <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">${res.capTitle}</div>
            <div class="res-text">Refer√™ncia: <b>${res.matchRef}</b><br>${res.text}</div>
        </div>
    `).join('');
    container.innerHTML = picHTML + cards;
}

async function renderBibleTranscription() {
    const container = document.getElementById('tab-bible');
    const activeCoords = detectedCoords.filter(c => c.isActive);
    const picHTML = getPiccardsHTML();
    
    if (activeCoords.length === 0) { 
        container.innerHTML = picHTML + '<p style="text-align:center; padding:20px; color:#666;">Aguardando dete√ß√£o...</p>'; 
        return; 
    }

    let html = '';
    for (const coord of activeCoords) {
        let nomeNoFicheiro = coord.book === "Revela√ß√£o" ? "Apocalipse" : coord.book;
        const bookFile = getBibleFilename(nomeNoFicheiro);
        try {
            if (!localBibleCache[bookFile]) {
                const resp = await fetch(`./js/bible/${bookFile}.json`);
                localBibleCache[bookFile] = await resp.json();
            }
            const bookData = localBibleCache[bookFile][nomeNoFicheiro];
            let trans = '';
            coord.verses.forEach(vNum => { 
                if (bookData[coord.cap] && bookData[coord.cap][vNum]) {
                    trans += `<span style="color:var(--accent-color); font-weight:bold; font-size:0.75em; vertical-align:super; margin-right:4px;">${vNum}</span>${bookData[coord.cap][vNum]} `; 
                }
            });
            html += `<div class="res-card"><span class="res-ref">üìñ ${coord.book} ${coord.cap}:${coord.originalVerses}</span><div class="res-text">${trans}</div></div>`;
        } catch (e) { html += `<div class="res-card"><div class="res-text">Erro ao carregar ${coord.book}.</div></div>`; }
    }
    container.innerHTML = picHTML + html;
}

// --- 9. UTILIT√ÅRIOS E EVENTOS ---

function createBibleRegex() {
    const books = BIBLE_DATA.map(b => b.nome);
    const siglas = Object.keys(BIBLE_ABBREVIATIONS);
    const all = [...books, ...siglas].sort((a,b) => b.length - a.length);
    return new RegExp(`\\b((?:${all.map(p => p.replace(/\./g, '\\.')).join('|')})\\.?\\s+\\d+[:.]\\d+(?:\\s*[-‚Äì,;]\\s*\\d+[:.-]?\\d*)*)`, 'gi');
}

function parseReference(ref) {
    const match = ref.match(/^(.+?)\.?\s+(\d+.*)$/);
    if (!match) return null;
    const bookName = BIBLE_ABBREVIATIONS[match[1].trim()] || match[1].trim();
    const parts = match[2].split(/[:.]/);
    if (parts.length < 2) return null;
    const versesRaw = parts[1].trim();
    let verses = [];
    if (versesRaw.includes('-')) {
        const r = versesRaw.split('-');
        for (let i = parseInt(r[0]); i <= parseInt(r[1]); i++) verses.push(i.toString());
    } else { verses = versesRaw.split(/[,;]/).map(v => v.trim().split(' ')[0]); }
    return { book: bookName, cap: parts[0].trim(), verses, originalVerses: versesRaw };
}

function getBibleFilename(book) { 
    return book.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_"); 
}

window.openInViewer = async (sigla, capIdx, targetBlockIdx, folder) => {
    document.querySelectorAll('#xray-panel > .tabs > .tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === 'viewer'));
    document.querySelectorAll('#xray-panel .tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-viewer'));
    
    const container = document.getElementById('viewer-container');
    container.innerHTML = XRAY_LOADER_HTML;

    try {
        let data;
        if (localLibraryCache[sigla]) data = localLibraryCache[sigla];
        else {
            const resp = await fetch(`./js/${folder}/${sigla}.json`);
            data = await resp.json();
        }
        const secoes = data.artigos || data.capitulos || [];
        const cap = secoes[capIdx];
        let html = `<div class="viewer-title" style="color:var(--accent-color); font-size:1.4rem; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">${cap.titulo}</div>`;
        
        cap.conteudo.forEach((block, idx) => {
            const isTarget = (idx === targetBlockIdx);
            html += `<div class="viewer-block ${isTarget ? 'highlight-target' : ''}" id="block-${idx}">
                ${block.numero_ref ? `<span class="para-badge">${block.numero_ref}</span>` : ''} ${block.texto}
            </div>`;
        });
        container.innerHTML = html;
        setTimeout(() => { document.getElementById(`block-${targetBlockIdx}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300);
    } catch (e) { container.innerHTML = 'Erro ao carregar no Viewer.'; }
};

document.querySelectorAll('#xray-panel > .tabs > .tab-btn').forEach(btn => {
    btn.onclick = () => {
        const targetTabId = `tab-${btn.dataset.tab}`;
        const targetContent = document.getElementById(targetTabId);
        if (targetContent) {
            document.querySelectorAll('#xray-panel > .tabs > .tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#xray-panel .tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            targetContent.classList.add('active');
        }
    };
});

editor.addEventListener('paste', (e) => {
    e.preventDefault();
    const text = (e.originalEvent || e).clipboardData.getData('text/plain');
    document.execCommand("insertText", false, text);
});

editor.addEventListener('input', () => {
    statusInfo.textContent = "Digitando...";
    clearTimeout(scanTimeout);
    scanTimeout = setTimeout(performXRay, 1200);
});

</script>
</body>
</html> 
