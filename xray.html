<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - X-Ray Scanner</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczO__qtgAbiMjh7jLHkq16igyxnU-GZ9_YDxeCVFW_YfGphIsST9KpuTCLyCsDbreAf_H5p9H7OynO0fFj5j0wGNL6o_P2qookQXQH-xE_XULJte89NA6FIcNA3GmMKugIGsrJJWAlN-XH5JaUGoXzYT=w1024-h869-s-no-gm?authuser=4">

    <style>
        :root {
            --bg-color: #0f0f12;
            --sidebar-color: #1a1a1d;
            --accent-color: #3498db;
            --text-color: #f0f0f0;
            --border-color: #333;
            --panel-bg: #141417;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: 50px;
            background: var(--sidebar-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
        }
        .logo { font-weight: bold; color: var(--accent-color); letter-spacing: 2px; }

        #main-layout { display: flex; flex: 1; overflow: hidden; }

        /* LADO ESQUERDO (EDITOR) */
        #input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            gap: 15px;
        }
        #xray-editor {
            flex: 1;
            background: #16161a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: #ccc;
            padding: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* LADO DIREITO (PAINEL) */
        #xray-panel {
            width: 480px;
            background: var(--sidebar-color);
            display: flex;
            flex-direction: column;
        }

        .tabs { display: flex; background: #111; border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            flex: 1; padding: 15px 0; background: none; border: none;
            color: #666; cursor: pointer; font-size: 1.2rem;
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--accent-color); border-bottom-color: var(--accent-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.active { display: block; }

        /* PICCARDS (FILTROS) */
        .tab-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 5px 0 15px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
            background: var(--sidebar-color);
            z-index: 10;
        }
        .piccard {
            background: rgba(255,255,255,0.03);
            border: 1px solid #444;
            color: #777;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.72rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .piccard.active {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .piccard.active::after { content: 'âœ“'; font-size: 0.6rem; }

        /* RESULTADOS */
        .res-card {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; margin-bottom: 12px;
            cursor: pointer; transition: 0.2s;
        }
        .res-card:hover { border-color: var(--accent-color); transform: translateY(-1px); }
        .res-ref { color: var(--accent-color); font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; display: block; }
        .res-text { font-size: 0.95rem; color: #bbb; line-height: 1.5; text-align: justify; }

        /* --- ANIMAÃ‡ÃƒO DA PARABÃ“LICA (LOADER) --- */
        .loader-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; color: var(--accent-color);
        }
        .scanner-ui { position: relative; width: 150px; height: 150px; margin-bottom: 20px; }
        .dish {
            position: absolute; bottom: 20%; left: 50%; width: 80px; height: 40px;
            border: 3px solid var(--accent-color); border-radius: 50% 50% 0 0;
            transform: translateX(-50%) rotate(180deg); background: rgba(52, 152, 219, 0.1);
        }
        .dish::after {
            content: ''; position: absolute; top: -20px; left: 50%;
            width: 3px; height: 25px; background: var(--accent-color); transform: translateX(-50%);
        }
        .wave {
            position: absolute; top: 15%; left: 50%; border: 2px solid var(--accent-color);
            border-radius: 50%; transform: translateX(-50%); opacity: 0; animation: wave-pulse 2s infinite;
        }
        .wave-1 { width: 40px; height: 20px; animation-delay: 0s; }
        .wave-2 { width: 70px; height: 35px; animation-delay: 0.5s; }
        .wave-3 { width: 100px; height: 50px; animation-delay: 1s; }

        @keyframes wave-pulse {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateX(-50%) scale(1.2); opacity: 0; }
        }

        .falling-icon { position: absolute; font-size: 1.2rem; opacity: 0; animation: capture-icon 1.5s infinite linear; }
        .icon-1 { left: 15%; animation-delay: 0.2s; }
        .icon-2 { left: 45%; animation-delay: 0.9s; }
        .icon-3 { left: 75%; animation-delay: 0.5s; }

        @keyframes capture-icon {
            0% { transform: translateY(-60px) scale(0.5); opacity: 0; }
            30% { opacity: 1; }
            80% { transform: translateY(20px) scale(0.8); opacity: 0.5; }
            100% { transform: translateY(40px) scale(0); opacity: 0; }
        }

        .loader-text { font-family: monospace; font-size: 0.75rem; letter-spacing: 3px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* VIEWER */
        .viewer-block { margin-bottom: 15px; padding: 10px; border-radius: 6px; color: #bbb; }
        .viewer-block.highlight-target { background: rgba(52, 152, 219, 0.15); border-left: 4px solid var(--accent-color); color: #fff; }
        .para-badge { background: #333; color: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; }

        [contenteditable]:empty:before { content: attr(placeholder); color: #555; }
        /* --- ESTILOS DO ESCUDO DE SEGURANÃ‡A (IGUAL Ã€ LIBRARY) --- */
#global-auth-shield { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: #000; 
    z-index: 999999; /* Valor altÃ­ssimo para cobrir tudo */
    display: flex; 
    justify-content: center; 
    align-items: center; 
}

.global-spinner { 
    width: 40px; 
    height: 40px; 
    border: 4px solid #333; 
    border-top: 4px solid var(--accent-color); 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
}

@keyframes spin { to { transform: rotate(360deg); } }

/* BotÃµes do Header */
.header-actions { display: flex; gap: 10px; align-items: center; }
.btn-xray {
    background: #252528; border: 1px solid #444; color: #ccc;
    padding: 6px 12px; border-radius: 6px; cursor: pointer;
    font-size: 0.85rem; transition: 0.2s; display: flex; align-items: center; gap: 6px;
}
.btn-xray:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.btn-xray.save-btn { background: rgba(46, 204, 113, 0.1); border-color: #2ecc71; color: #2ecc71; }
.btn-xray.save-btn:hover { background: #2ecc71; color: white; }

/* Modal de Ficheiros */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 200000; display: none;
    justify-content: center; align-items: center;
}
.modal-content {
    background: #1a1a1d; border: 1px solid #333; width: 90%; max-width: 500px;
    border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.xray-file-item {
    padding: 12px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s;
    display: flex; justify-content: space-between; align-items: center;
}
.xray-file-item:hover { background: rgba(52, 152, 219, 0.1); }
.file-date { font-size: 0.75rem; color: #666; }

/* BotÃµes de AÃ§Ã£o no Header */
.header-actions { display: flex; gap: 10px; align-items: center; }
.action-btn {
    background: #252528;
    border: 1px solid #444;
    color: #ccc;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: 0.2s;
}
.action-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.action-btn.save-btn { border-color: #2ecc71; color: #2ecc71; }
.action-btn.save-btn:hover { background: #2ecc71; color: white; }

/* Modal de Carregamento */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000; display: none;
    justify-content: center; align-items: center;
}
.modal-content {
    background: #1a1a1d; width: 90%; max-width: 500px; border-radius: 12px;
    border: 1px solid #333; padding: 20px; display: flex; flex-direction: column;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.load-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.load-item {
    background: #252528; padding: 15px; border-radius: 8px; border: 1px solid #333;
    cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between;
}
.load-item:hover { border-color: var(--accent-color); background: #2a2a2e; }

#save-xray-title-input:focus {
    border-color: #2ecc71;
    background: #000;
}

    </style>
</head>
<body>

    <!-- ESCUDO DE CARREGAMENTO E SEGURANÃ‡A -->
<div id="global-auth-shield">
    <div class="global-spinner"></div>
</div>

<header>
    <div class="logo">NOTA<span>BOOK</span> / X-RAY</div>
    <div id="status-info" style="font-size: 0.8rem; color: #666; flex: 1; margin-left: 20px;">Pronto para analisar...</div>
    
    <div class="header-actions">
        <button class="action-btn save-btn" onclick="window.saveXrayDoc()">
            <span>ðŸ’¾</span> Gravar
        </button>
        <button class="action-btn" onclick="window.openLoadXrayModal()">
            <span>ðŸ“‚</span> Abrir
        </button>
    </div>
</header>

<!-- MODAL PARA CARREGAR FICHEIROS X-RAY -->
<div id="load-xray-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--accent-color);">Documentos Gravados</h3>
            <button onclick="document.getElementById('load-xray-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="load-list-container" class="load-list">
            <!-- Itens injetados via JS -->
        </div>
    </div>
</div>

    <div id="main-layout">
        <section id="input-section">
            <div id="xray-editor" contenteditable="true" placeholder="Escreva ou cole o seu texto aqui..."></div>
        </section>

        <aside id="xray-panel">
            <div class="tabs">
                <button class="tab-btn active" data-tab="bible">ðŸ“–</button>
                <button class="tab-btn" data-tab="books">ðŸ“”</button>
                <button class="tab-btn" data-tab="pubs">ðŸ“š</button>
                <button class="tab-btn" data-tab="viewer">ðŸª¶</button>
            </div>

            <div id="tab-bible" class="tab-content active"></div>
            <div id="tab-books" class="tab-content"></div>
            <div id="tab-pubs" class="tab-content"></div>
            <div id="tab-viewer" class="tab-content"><div id="viewer-container"></div></div>
        </aside>
    </div>


    <!-- MODAL PARA DAR NOME AO DOCUMENTO (SAVE) -->
<div id="save-xray-modal" class="modal-overlay" style="z-index: 2001;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 style="color: #2ecc71;">Gravar Documento</h3>
            <button onclick="document.getElementById('save-xray-modal').style.display='none'" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="padding: 10px 0;">
            <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 8px;">NOME DO DOCUMENTO</label>
            <input type="text" id="save-xray-title-input" 
                   style="width: 100%; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; border-bottom: 2px solid #2ecc71;">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="document.getElementById('save-xray-modal').style.display='none'" 
                    style="flex: 1; padding: 10px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>
            <button onclick="window.confirmSaveXray()" 
                    style="flex: 1; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">GRAVAR</button>
        </div>
    </div>
</div>


    <script type="module">
    // --- 1. IMPORTAÃ‡Ã•ES DE SEGURANÃ‡A E FIREBASE ---
    import { db, auth } from './js/firebase-config.js';
    import { 
        doc, getDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    // --- 2. IMPORTAÃ‡Ã•ES DE DADOS LOCAIS ---
    import { BIBLE_DATA } from './js/bible-data.js';
    import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';
    import { BIBLE_ABBREVIATIONS } from './js/bible-map.js';

    // --- 3. CONFIGURAÃ‡Ã•ES E ESTADO GLOBAL ---
    const XRAY_LOADER_HTML = `
        <div class="loader-container">
            <div class="scanner-ui">
                <div class="falling-icon icon-1">ðŸ“”</div>
                <div class="falling-icon icon-2">ðŸ“„</div>
                <div class="falling-icon icon-3">ðŸ“š</div>
                <div class="wave wave-1"></div><div class="wave wave-2"></div><div class="wave wave-3"></div>
                <div class="dish"></div>
            </div>
            <div class="loader-text">ESCANEAR FREQUÃŠNCIAS...</div>
        </div>
    `;

    const CONFIG_SCAN = {
        anoInicio: 1950,
        anoFim: 2026,
        meses: ["12", "11", "10", "09", "08", "07", "06", "05", "04", "03", "02", "01"]
    };

    let detectedCoords = []; 
    let rawResultsCache = { books: [], pubs: [] }; 
    let scanTimeout;
    const bibleCache = {}; 

    const editor = document.getElementById('xray-editor');
    const statusInfo = document.getElementById('status-info');

    // --- 4. BLOCO DE SEGURANÃ‡A (AUTENTICAÃ‡ÃƒO) ---
    onAuthStateChanged(auth, async (user) => {
        const shield = document.getElementById('global-auth-shield');
        if (!user) { 
            window.location.href = "404.html"; 
            return; 
        }

        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().aceite !== "on") { 
                window.location.href = "index.html"; 
                return; 
            }
            if (shield) shield.style.display = 'none';
        } catch (e) { 
            console.error("Erro na verificaÃ§Ã£o de acesso:", e); 
        }
    });

    // --- 5. SISTEMA DE GRAVAÃ‡ÃƒO (SAVE) ---

    window.saveXrayDoc = () => {
        const text = editor.innerText.trim();
        if (!text) return alert("O editor estÃ¡ vazio!");
        
        const modal = document.getElementById('save-xray-modal');
        const input = document.getElementById('save-xray-title-input');
        
        // Sugere um nome com base na data
        input.value = "Analise_" + new Date().toLocaleDateString().replace(/\//g, '-');
        modal.style.display = 'flex';
        input.focus();
    };

    window.confirmSaveXray = async () => {
        const titleInput = document.getElementById('save-xray-title-input');
        const title = titleInput.value.trim();
        const text = editor.innerText.trim();
        
        if (!title) return alert("Por favor, dÃª um nome ao documento.");

        try {
            statusInfo.textContent = "A gravar no Firestore...";
            document.getElementById('save-xray-modal').style.display = 'none';

            await addDoc(collection(db, "xray"), {
                userId: auth.currentUser.uid,
                titulo: title,
                conteudo: text,
                timestamp: serverTimestamp()
            });

            statusInfo.textContent = "Documento guardado: " + title;
            alert("Documento gravado com sucesso!");
        } catch (e) {
            console.error(e);
            alert("Erro ao gravar documento.");
            statusInfo.textContent = "Erro ao gravar.";
        }
    };

    // --- 6. SISTEMA DE CARREGAMENTO (LOAD) ---

    window.openLoadXrayModal = async () => {
        const modal = document.getElementById('load-xray-modal');
        const container = document.getElementById('load-list-container');
        modal.style.display = 'flex';
        container.innerHTML = '<div style="color:#666; text-align:center; padding: 20px;">A procurar documentos...</div>';

        try {
            const q = query(
                collection(db, "xray"), 
                where("userId", "==", auth.currentUser.uid),
                orderBy("timestamp", "desc")
            );
            const snap = await getDocs(q);
            container.innerHTML = "";

            if (snap.empty) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding: 20px;">Nenhum documento encontrado no seu arquivo.</div>';
                return;
            }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const date = data.timestamp?.toDate().toLocaleDateString() || "---";
                const item = document.createElement('div');
                item.className = 'load-item';
                item.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <strong style="color:#eee;">${data.titulo}</strong>
                        <small style="color:#666;">${date}</small>
                    </div>
                    <span style="color:var(--accent-color);">Abrir âž”</span>
                `;
                item.onclick = () => {
                    editor.innerText = data.conteudo;
                    modal.style.display = 'none';
                    performXRay(); // Inicia o scanner automaticamente apÃ³s carregar
                };
                container.appendChild(item);
            });
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div style="color:red; text-align:center; padding: 20px;">Erro ao carregar lista de documentos.</div>';
        }
    };

    // --- 7. MOTOR DO SCANNER (PERFORMXRAY) ---

    async function performXRay() {
        const text = editor.innerText;
        if (text.length < 3) return;

        const bibleRegex = createBibleRegex();
        const matches = [...new Set(text.match(bibleRegex) || [])];
        
        detectedCoords = matches.map(m => {
            const info = parseReference(m);
            if (!info) return null;
            const existing = detectedCoords.find(c => c.book === info.book && c.originalVerses === info.originalVerses);
            
            const variants = Object.keys(BIBLE_ABBREVIATIONS).filter(s => BIBLE_ABBREVIATIONS[s] === info.book);
            variants.push(info.book);

            if (info.book === "Apocalipse" || info.book === "RevelaÃ§Ã£o") {
                variants.push("Apocalipse", "RevelaÃ§Ã£o", "Revelacao", "Apo", "Re", "Rev");
            }

            const escaped = [...new Set(variants)].map(v => v.replace(/\./g, '\\.')).join('|');
            const searchPatterns = info.verses.map(ver => new RegExp(`(?:^|\\s|â€”|\\()(${escaped})\\.?\\s*${info.cap}[:.]${ver}\\b`, 'i'));

            return { ...info, isActive: existing ? existing.isActive : true, searchPatterns };
        }).filter(v => v !== null);

        // Reset visual e mostrar loaders
        document.getElementById('tab-bible').innerHTML = XRAY_LOADER_HTML;
        document.getElementById('tab-books').innerHTML = XRAY_LOADER_HTML;
        document.getElementById('tab-pubs').innerHTML = XRAY_LOADER_HTML;

        rawResultsCache = { books: [], pubs: [] };
        statusInfo.textContent = "Scanner em curso...";

        await Promise.all([
            renderBibleTranscription(),
            scanExternalData('books'),
            scanExternalData('publicacoes')
        ]);

        refreshAllTabs();
        statusInfo.textContent = "X-Ray ConcluÃ­do.";
    }

    // --- 8. VARREDURA DE DADOS EXTERNOS (JSON) ---

    async function scanExternalData(folder) {
        if (folder === 'publicacoes') {
            for (let ano = CONFIG_SCAN.anoFim; ano >= CONFIG_SCAN.anoInicio; ano--) {
                for (const mes of CONFIG_SCAN.meses) {
                    const sigla = `sentinelas/${ano}/${mes}`;
                    await fetchAndProcess(`./js/publicacoes/${sigla}.json`, sigla, 'publicacoes', rawResultsCache.pubs, `${mes}/${ano}`);
                }
            }
        } else {
            const exclusoes = ["w", "g", "wp", "km", "mwb", "jwbvod", "jwb", "mwbv"];
            const siglasLivros = Object.keys(SIGLAS_PUBLICACOES).filter(s => !exclusoes.includes(s));

            for (const sigla of siglasLivros) {
                await fetchAndProcess(`./js/books/${sigla}.json`, sigla, 'books', rawResultsCache.books);
            }
        }
    }

    async function fetchAndProcess(url, sigla, folder, targetArray, dateLabel = "") {
        try {
            const resp = await fetch(url);
            if (!resp.ok) return;
            const data = await resp.json();
            const secoes = data.artigos || data.capitulos || [];
            secoes.forEach((secao, sIdx) => {
                secao.conteudo.forEach((block, bIdx) => {
                    if (!block.texto) return;
                    detectedCoords.forEach(v => {
                        if (v.searchPatterns.some(p => p.test(block.texto))) {
                            targetArray.push({
                                sigla, folder, matchKey: `${v.book} ${v.cap}:${v.originalVerses}`,
                                pubTitle: dateLabel ? `${data.titulo || "Revista"} (${dateLabel})` : (data.titulo || sigla),
                                capTitle: secao.titulo, capIdx: sIdx, blockIdx: bIdx, pNum: block.numero_ref,
                                text: block.texto, matchRef: `${v.book} ${v.cap}:${v.originalVerses}`
                            });
                        }
                    });
                });
            });
        } catch (e) {}
    }

    // --- 9. RENDERIZAÃ‡ÃƒO DA INTERFACE ---

    function getPiccardsHTML() {
        if (detectedCoords.length === 0) return '';
        return `<div class="tab-filter-container">${detectedCoords.map((coord, idx) => `
            <div class="piccard ${coord.isActive ? 'active' : ''}" onclick="window.togglePiccard(${idx})">
                ${coord.book} ${coord.cap}:${coord.originalVerses}
            </div>`).join('')}</div>`;
    }

    window.togglePiccard = (index) => {
        detectedCoords[index].isActive = !detectedCoords[index].isActive;
        refreshAllTabs();
    };

    function refreshAllTabs() {
        renderBibleTranscription();
        applyFilters();
    }

    function applyFilters() {
        const activeKeys = detectedCoords.filter(c => c.isActive).map(c => `${c.book} ${c.cap}:${c.originalVerses}`);
        const fBooks = rawResultsCache.books.filter(res => activeKeys.includes(res.matchKey));
        const fPubs = rawResultsCache.pubs.filter(res => activeKeys.includes(res.matchKey));
        renderResults(fBooks, document.getElementById('tab-books'), 'books');
        renderResults(fPubs, document.getElementById('tab-pubs'), 'publicacoes');
    }

    function renderResults(data, container, folder) {
        const picHTML = getPiccardsHTML();
        if (data.length === 0) { 
            container.innerHTML = picHTML + '<p style="text-align:center; padding:20px; color:#666;">Nenhum resultado nos livros/revistas.</p>'; 
            return; 
        }
        const unique = data.filter((v, i, a) => a.findIndex(t => t.sigla === v.sigla && t.blockIdx === v.blockIdx) === i);
        const cards = unique.map(res => `
            <div class="res-card" onclick="window.openInViewer('${res.sigla}', ${res.capIdx}, ${res.blockIdx}, '${res.folder}')">
                <span class="res-ref">${res.pubTitle}</span>
                <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">${res.capTitle}</div>
                <div class="res-text">ReferÃªncia: <b>${res.matchRef}</b><br>${res.text}</div>
            </div>
        `).join('');
        container.innerHTML = picHTML + cards;
    }

    async function renderBibleTranscription() {
        const container = document.getElementById('tab-bible');
        const activeCoords = detectedCoords.filter(c => c.isActive);
        const picHTML = getPiccardsHTML();
        
        if (activeCoords.length === 0) { 
            container.innerHTML = picHTML + '<p style="text-align:center; padding:20px; color:#666;">Aguardando deteÃ§Ã£o de referÃªncias...</p>'; 
            return; 
        }

        let html = '';
        for (const coord of activeCoords) {
            let nomeNoFicheiro = coord.book === "RevelaÃ§Ã£o" ? "Apocalipse" : coord.book;
            const bookFile = getBibleFilename(nomeNoFicheiro);
            try {
                if (!bibleCache[bookFile]) {
                    const resp = await fetch(`./js/bible/${bookFile}.json`);
                    bibleCache[bookFile] = await resp.json();
                }
                const bookData = bibleCache[bookFile][nomeNoFicheiro];
                let trans = '';
                coord.verses.forEach(vNum => { 
                    if (bookData[coord.cap] && bookData[coord.cap][vNum]) {
                        trans += `<span style="color:var(--accent-color); font-weight:bold; font-size:0.75em; vertical-align:super; margin-right:4px;">${vNum}</span>${bookData[coord.cap][vNum]} `; 
                    }
                });
                html += `<div class="res-card"><span class="res-ref">ðŸ“– ${coord.book} ${coord.cap}:${coord.originalVerses}</span><div class="res-text">${trans}</div></div>`;
            } catch (e) { html += `<div class="res-card"><div class="res-text">Livro ${coord.book} indisponÃ­vel.</div></div>`; }
        }
        container.innerHTML = picHTML + html;
    }

    // --- 10. UTILITÃRIOS E EVENTOS DE INTERFACE ---

    editor.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.originalEvent || e).clipboardData.getData('text/plain');
        document.execCommand("insertText", false, text);
    });

    editor.addEventListener('input', () => {
        statusInfo.textContent = "Digitando...";
        clearTimeout(scanTimeout);
        scanTimeout = setTimeout(performXRay, 1000);
    });

    function createBibleRegex() {
        const books = BIBLE_DATA.map(b => b.nome);
        const siglas = Object.keys(BIBLE_ABBREVIATIONS);
        const all = [...books, ...siglas].sort((a,b) => b.length - a.length);
        return new RegExp(`\\b((?:${all.map(p => p.replace(/\./g, '\\.')).join('|')})\\.?\\s+\\d+[:.]\\d+(?:\\s*[-â€“,;]\\s*\\d+[:.-]?\\d*)*)`, 'gi');
    }

    function parseReference(ref) {
        const match = ref.match(/^(.+?)\.?\s+(\d+.*)$/);
        if (!match) return null;
        const bookName = BIBLE_ABBREVIATIONS[match[1].trim()] || match[1].trim();
        const parts = match[2].split(/[:.]/);
        if (parts.length < 2) return null;
        const versesRaw = parts[1].trim();
        let verses = [];
        if (versesRaw.includes('-')) {
            const r = versesRaw.split('-');
            for (let i = parseInt(r[0]); i <= parseInt(r[1]); i++) verses.push(i.toString());
        } else { verses = versesRaw.split(/[,;]/).map(v => v.trim().split(' ')[0]); }
        return { book: bookName, cap: parts[0].trim(), verses, originalVerses: versesRaw };
    }

    function getBibleFilename(book) { 
        return book.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_"); 
    }

    window.openInViewer = async (sigla, capIdx, targetBlockIdx, folder) => {
        // Ativa a aba Viewer visualmente
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === 'viewer'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-viewer'));
        
        const container = document.getElementById('viewer-container');
        container.innerHTML = XRAY_LOADER_HTML;

        try {
            const resp = await fetch(`./js/${folder}/${sigla}.json`);
            const data = await resp.json();
            const secoes = data.artigos || data.capitulos || [];
            const cap = secoes[capIdx];
            let html = `<div class="viewer-title" style="color:var(--accent-color); font-size:1.4rem; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">${cap.titulo}</div>`;
            
            cap.conteudo.forEach((block, idx) => {
                const isTarget = (idx === targetBlockIdx);
                html += `<div class="viewer-block ${isTarget ? 'highlight-target' : ''}" id="block-${idx}">
                    ${block.numero_ref ? `<span class="para-badge">${block.numero_ref}</span>` : ''} ${block.texto}
                </div>`;
            });
            container.innerHTML = html;
            setTimeout(() => { document.getElementById(`block-${targetBlockIdx}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300);
        } catch (e) { container.innerHTML = 'Erro ao carregar documento no Viewer.'; }
    };

    // Tabs logic
    document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
    });

</script>
</body>
</html>
