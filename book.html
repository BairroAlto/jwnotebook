<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modo Leitura - JW Notebook</title>
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
     
        /* ========================================= */
        /* 1. VARI√ÅVEIS E RESET GERAL                */
        /* ========================================= */
        :root {
            --bg-color: #1a1a1d;
            --sidebar-color: #252528;
            --panel-color: #1f1f22;
            --text-color: #f0f0f0;
            --text-muted: #888;
            --accent-color: #4a90e2;
            --border-color: #333;
            --hover-color: #2c2c30;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            height: 100vh; 
            overflow: hidden;
        }
        
        /* ========================================= */
        /* 2. LAYOUT PRINCIPAL (DESKTOP)             */
        /* ========================================= */
        .book-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        /* --- COLUNA 1: BARRA LATERAL (ESQUERDA) --- */
        #book-sidebar {
            flex: 0 0 300px;
            background-color: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { font-size: 1.2em; font-weight: 500; color: var(--accent-color); }
        
        #user-info {
            font-size: 0.9em; color: var(--text-muted); margin-top: 5px; font-weight: bold; display: block; text-transform: capitalize;
        }
        
        /* ABAS */
        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border-color); background-color: var(--panel-color); }
        .tab-btn { flex: 1; background: none; border: none; padding: 12px; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; font-weight: 500; }
        .tab-btn:hover { background-color: var(--hover-color); color: var(--text-color); }
        .tab-btn.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); background-color: var(--sidebar-color); }
        
        /* CONTE√öDO DA SIDEBAR */
        #book-toc { flex-grow: 1; overflow-y: auto; padding: 10px; list-style: none; display: block; }
        #book-lists { flex-grow: 1; overflow-y: auto; padding: 0; display: none; flex-direction: column; }
        
        /* ESTILOS DE LISTA */
        .toc-item { margin-bottom: 2px; }
        .toc-header { display: flex; align-items: center; padding: 8px 10px; cursor: pointer; border-radius: 4px; color: var(--text-muted); transition: all 0.2s; font-size: 0.95em; }
        .toc-header:hover { background-color: var(--hover-color); color: var(--text-color); }
        .toc-header.active-note { background-color: rgba(74, 144, 226, 0.2); color: var(--accent-color); font-weight: bold; }
        .toc-icon { margin-right: 8px; }
        .toc-arrow { margin-right: 5px; width: 15px; text-align: center; transition: transform 0.2s; display: inline-block; }
        .toc-arrow.rotated { transform: rotate(90deg); }
        .toc-children { margin-left: 20px; border-left: 1px solid var(--border-color); display: none; }
        
        #lists-content { list-style: none; padding: 10px; }
        #lists-content li { padding: 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; margin-bottom: 2px; color: var(--text-muted); transition: background 0.2s; }
        #lists-content li:hover { background-color: var(--hover-color); color: var(--text-color); }
        .list-icon { margin-right: 10px; font-size: 1.2em; }
        .protected-icon { margin-left: auto; font-size: 0.9em; }
        
        /* FOOTER */
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); text-align: center; background-color: var(--sidebar-color); }
        #global-search-btn { background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 10px; transition: background 0.2s; }
        #global-search-btn:hover { background-color: var(--hover-color); }
        
        
        /* --- COLUNA 2: √ÅREA DE LEITURA (CENTRO) --- */
        #book-main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            min-width: 0;
            position: relative;
        }
        
        /* Bot√£o Flutuante Mobile (Oculto em Desktop) */
        #mobile-menu-float-btn { display: none; }
        
        #book-content-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 40px 60px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            line-height: 1.8;
        }
        
        #read-title { font-size: 2.5em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--accent-color); }
        
        /* TOOLBAR */
        #note-toolbar { display: flex; gap: 10px; margin-bottom: 30px; padding: 10px; background-color: var(--panel-color); border-radius: 6px; align-items: center; flex-wrap: wrap; }
        .toolbar-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .toolbar-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--accent-color); }
        
        /* DROPDOWN ZOOM */
        #reader-zoom { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 5px 10px; height: 32px; cursor: pointer; outline: none; font-size: 0.9em; margin-right: 5px; }
        #reader-zoom:hover { border-color: var(--accent-color); background-color: var(--hover-color); }
        #reader-zoom option { background-color: var(--sidebar-color); color: var(--text-color); }
        
        #read-body { font-size: 1.1em; transition: font-size 0.2s; }
        
        /* TAGS E LINKS */
        .tag { background-color: #3a5370; color: #4a90e2; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; margin-right: 5px; cursor: pointer; }
        .entity-link { color: var(--accent-color); border-bottom: 1px dashed var(--accent-color); cursor: pointer; background-color: rgba(74, 144, 226, 0.1); }
        .entity-link:hover { background-color: rgba(74, 144, 226, 0.3); }
        .entity-link[data-entity-type="personagem"] { color: #e67e22; border-color: #e67e22; background-color: rgba(230, 126, 34, 0.1); }
        .entity-link[data-entity-type="local"] { color: #2ecc71; border-color: #2ecc71; background-color: rgba(46, 204, 113, 0.1); }
        .entity-link[data-entity-type="data"] { color: #9b59b2; border-color: #9b59b2; background-color: rgba(155, 89, 182, 0.1); }
        
        
        /* --- COLUNA 3: REFER√äNCIAS (DIREITA NO PC) --- */
        #references-panel {
            flex: 0 0 0; /* Come√ßa fechado (largura 0) */
            width: 0; 
            background-color: var(--sidebar-color);
            
            /* Posi√ß√£o normal no Flexbox (√† direita do main-panel) */
            border-left: 1px solid var(--border-color); 
            border-right: none;
            
            display: flex; 
            flex-direction: column;
            transition: all 0.3s ease-in-out; 
            overflow: hidden; 
            opacity: 0;
        }
        
        /* Quando ativo no Desktop */
        .book-container.references-visible #references-panel { 
            flex: 0 0 350px; /* Largura fixa */
            padding: 20px; 
            opacity: 1; 
        }
        
        /* Pega de arrasto (Oculta no Desktop) */
        #panel-drag-handle { display: none; }
        
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-header h2 { font-size: 18px; font-weight: 500; color: var(--text-color); }
        #close-ref-btn { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        
        #ref-description { font-size: 0.9em; color: var(--text-muted); margin-bottom: 20px; padding-left: 10px; border-left: 3px solid var(--accent-color); line-height: 1.5; }
        #ref-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        
        .reference-item { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-color); }
        .reference-item summary { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .reference-context { padding: 10px; border-top: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-muted); line-height: 1.5; }
        .go-to-btn { background: none; border: 1px solid var(--text-muted); color: var(--text-muted); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.8em; }
        .go-to-btn:hover { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }
        
        /* --- ESTILOS PARA MINI-NOTAS NO MODO LEITURA --- */
.processed-mini-note {
    margin: 30px 0;
    display: block;
}

.processed-mini-note h2 {
    font-size: 1.5em;
    color: var(--accent-color);
    margin-bottom: 15px;
    margin-top: 25px;
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--border-color);
}

.processed-mini-note .mini-note-body {
    font-size: 1em;
    line-height: 1.8;
}

/* Ocultar elementos de edi√ß√£o caso passem pelo filtro */
.mini-note-toolbar, 
.mini-note-title-input {
    display: none !important;
}
        
.processed-mini-note {
    margin: 30px 0;
    display: block;
}
.processed-mini-note h2 {
    font-size: 1.5em;
    color: var(--accent-color);
    margin-bottom: 15px;
    margin-top: 25px;
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--border-color);
    line-height: 1.3;
}
.processed-mini-note .mini-note-body {
    font-size: 1em;
    line-height: inherit; /* Importante para o Zoom funcionar bem */
}
/* Esconde elementos de edi√ß√£o que possam sobrar */
.mini-note-toolbar, .mini-note-title-input {
    display: none !important;
}

        /* ========================================= */
        /* 3. ESTILOS MOBILE (At√© 768px)             */
        /* ========================================= */
        @media (max-width: 768px) {
            
            /* --- NAVEGA√á√ÉO: Alterna entre Lista e Leitura --- */
            #book-sidebar { display: flex; width: 100%; flex: 1; }
            #book-main-panel { display: none; }
        
            /* Estado "A Ler": Esconde a Lista, V√™ o Leitor */
            body.mobile-reading-active #book-sidebar { display: none; }
            body.mobile-reading-active #book-main-panel { display: flex; width: 100%; position: relative; }
        
            /* --- BOT√ÉO FLUTUANTE (‚ò∞) --- */
            #mobile-menu-float-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 15px;
                left: 15px;
                width: 40px;
                height: 40px;
                background-color: var(--panel-color);
                border: 1px solid var(--border-color);
                color: var(--text-color);
                border-radius: 50%;
                font-size: 20px;
                z-index: 100;
                cursor: pointer;
                box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            }
            
            #book-content-scroll { padding: 60px 20px 20px 20px; }
            body.mobile-reading-active #global-search-btn { display: none; }
        
            /* --- PAINEL DE REFER√äNCIAS (BOTTOM SHEET) --- */
            /* Quando o painel N√ÉO est√° vis√≠vel */
            #references-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: auto; 
                
                /* Remove l√≥gica Flexbox do Desktop */
                flex: unset; 
                border-left: none; 
                
                background-color: var(--sidebar-color);
                border-top: 1px solid var(--border-color);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                box-shadow: 0 -5px 30px rgba(0,0,0,0.6);
                z-index: 2000;
                opacity: 1; /* Opacidade sempre 1, controlamos a posi√ß√£o */
                
                /* Esconde para baixo */
                transform: translateY(100%); 
                transition: transform 0.3s ease-in-out;
                
                display: flex;
                flex-direction: column;
            }
        
            /* Quando o painel EST√Å vis√≠vel */
            .book-container.references-visible #references-panel {
                /* Sobe para a vista */
                transform: translateY(0);
                
                /* Altura inicial (ajustada dinamicamente via JS no arrasto) */
                height: 50vh; 
                
                /* Reset de propriedades desktop que possam conflituar */
                width: 100%;
                padding: 0; /* Padding tratado internamente */
            }
        
            /* PEGA DE ARRASTO (DRAG HANDLE) */
            #panel-drag-handle {
                display: flex;
                width: 100%;
                height: 30px;
                align-items: center;
                justify-content: center;
                cursor: grab;
                touch-action: none;
                flex-shrink: 0;
            }
        
            .drag-indicator {
                width: 50px; height: 5px; background-color: var(--border-color); border-radius: 10px;
            }
            
            #references-panel .panel-header { padding: 0 20px 10px 20px; margin-bottom: 10px; }
            #ref-list { padding: 0 20px 20px 20px; }
        }
        
        /* ========================================= */
        /* 4. MODAIS E UTILIT√ÅRIOS                   */
        /* ========================================= */
        .search-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay); display: none; justify-content: center; align-items: start; z-index: 3000; padding-top: 100px; }
        .search-modal-content { background-color: var(--sidebar-color); width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 70vh; }
        .search-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; }
        #global-search-input { flex-grow: 1; padding: 12px; font-size: 1.1em; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; }
        #search-results-list { list-style: none; overflow-y: auto; padding: 10px; }
        .search-result-item { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .search-result-item:hover { background-color: var(--hover-color); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }
        .empty-state span { font-size: 3em; margin-bottom: 20px; }
        
        .pdf-force-light-mode { color: #000000 !important; background-color: #ffffff !important; }
        .pdf-force-light-mode * { color: #000000 !important; background-color: transparent !important; }
        
        </style>

</head>
<body>

<div class="book-container" id="main-container">
    
    <!-- 1. Barra Lateral -->
    <aside id="book-sidebar">
        <!-- Cabe√ßalho -->
        <div class="sidebar-header">
            <h2>As Minhas Notas</h2>
            <p id="user-info">A carregar...</p>
        </div>

        <!-- ABAS DE NAVEGA√á√ÉO -->
        <div class="sidebar-tabs">
            <button class="tab-btn active" data-tab="notes">Notas</button>
            <button class="tab-btn" data-tab="lists">Listas</button>
        </div>

        <!-- Conte√∫do 1: √çndice de Notas (TOC) -->
        <div id="book-toc"></div>
        
        <!-- Conte√∫do 2: Listas (Categorias) -->
        <div id="book-lists">
            <div id="lists-header" style="display:none; padding: 10px; border-bottom: 1px solid var(--border-color); align-items: center;">
                <button id="lists-back-btn" style="background:none; border:none; color:var(--accent-color); font-size:1.2em; cursor:pointer; margin-right:10px;">‚Üê</button>
                <span id="lists-title" style="font-weight:bold; color: var(--text-color);">Categorias</span>
            </div>
            <ul id="lists-content"></ul>
        </div>
        
        <!-- Rodap√© -->
        <div class="sidebar-footer">
            <button id="global-search-btn">üîç Pesquisar Tudo</button>
        </div>
    </aside>

    <!-- 2. √Årea de Leitura -->
    <main id="book-main-panel">
        <!-- NOVO: Bot√£o de Menu Flutuante (Canto Superior Esquerdo) -->
        <button id="mobile-menu-float-btn" title="Voltar √† Lista">‚ò∞</button>

        
        <div id="book-content-scroll">
            <div id="empty-placeholder" class="empty-state">
                <span>üìñ</span>
                <h2>Selecione uma nota para ler</h2>
            </div>
            
            <article id="reader-area" style="display: none;">
                <h1 id="read-title"></h1>
                
                <!-- BARRA DE FERRAMENTAS (Sem o bot√£o Voltar antigo) -->
                <div id="note-toolbar">
                    <select id="reader-zoom" title="Zoom da Leitura" class="toolbar-select">
                        <option value="12px">50%</option>
                        <option value="14px">75%</option>
                        <option value="100%" selected>100%</option>
                        <option value="18px">110%</option>
                        <option value="20px">125%</option>
                        <option value="24px">150%</option>
                        <option value="28px">180%</option>
                        <option value="32px">200%</option>
                    </select>
                    <button class="toolbar-btn" id="btn-copy" title="Copiar Texto">üìã Copiar</button>
                    <button class="toolbar-btn" id="btn-pdf" title="Descarregar PDF">üì• PDF</button>
                </div>

                <div id="read-body"></div>
            </article>
        </div>
    </main>

    <!-- 3. Painel de Refer√™ncias -->
    <aside id="references-panel">
        <!-- NOVO: √Årea de "Pega" para arrastar -->
        <div id="panel-drag-handle">
            <div class="drag-indicator"></div>
        </div>

        <div class="panel-header">
            <h2 id="ref-title">Refer√™ncias</h2>
            <button id="close-ref-btn" title="Fechar">√ó</button>
        </div>
        
        <p id="ref-description"></p>
        <ul id="ref-list"></ul>
    </aside>

</div>

<!-- MODAL DE PESQUISA GLOBAL -->
<div id="search-modal" class="search-modal-overlay">
    <div class="search-modal-content">
        <div class="search-header">
            <input type="text" id="global-search-input" placeholder="Pesquisar notas, tags, personagens...">
            <button id="close-search-modal" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">√ó</button>
        </div>
        <ul id="search-results-list">
            <li style="padding: 20px; text-align: center; color: #888;">Digite para pesquisar...</li>
        </ul>
    </div>
</div>

<!-- MODAL DE PALAVRA-PASSE -->
<div id="password-modal" class="search-modal-overlay" style="z-index: 3000;">
    <div class="search-modal-content" style="max-width: 350px;">
        <div style="padding: 20px;">
            <h3 style="margin-bottom: 15px;">Item Protegido üîí</h3>
            <p style="margin-bottom: 15px; color: #888;">Insira a palavra-passe para aceder.</p>
            <input type="password" id="password-input" style="width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
            <p id="password-error" style="color: #e74c3c; display: none; margin-bottom: 10px;">Palavra-passe incorreta.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancel-password-btn" style="padding: 8px 15px; background: transparent; border: 1px solid var(--border-color); color: #fff; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button id="confirm-password-btn" style="padding: 8px 15px; background: var(--accent-color); border: none; color: white; border-radius: 4px; cursor: pointer;">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
   
   import { db, auth } from './js/firebase-config.js';
    import { collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    // ============================================================
    // 1. VARI√ÅVEIS DE ESTADO E CONFIGURA√á√ÉO
    // ============================================================
    let appSettings = {
        searchTagsInProtected: false,
        searchTopicsInProtected: false,
        searchAnchorsInProtected: false
    };
    let sessionUnlockedFolders = new Set();
    let listsNavigationStack = [];

    const ENTITY_CONFIG = {
        personagem: { collection: 'personagens' },
        local: { collection: 'locais' },
        data: { collection: 'datas' },
        textobiblico: { collection: 'textosbiblicos' }
    };

    const BIBLICAL_BOOKS = [
        'G√©nesis', '√äxodo', 'Lev√≠tico', 'N√∫meros', 'Deuteron√≥mio', 'Josu√©', 'Ju√≠zes', 'Rute', 
        '1 Samuel', '2 Samuel', '1 Reis', '2 Reis', '1 Cr√≥nicas', '2 Cr√≥nicas', 'Esdras', 'Neemias', 'Ester', 
        'J√≥', 'Salmos', 'Prov√©rbios', 'Eclesiastes', 'C√¢ntico de Salom√£o', 'Isa√≠as', 'Jeremias', 'Lamenta√ß√µes', 
        'Ezequiel', 'Daniel', 'Oseias', 'Joel', 'Am√≥s', 'Obadias', 'Jonas', 'Miqueias', 'Naum', 'Habacuque', 
        'Sofonias', 'Ageu', 'Zacarias', 'Malaquias', 'Mateus', 'Marcos', 'Lucas', 'Jo√£o', 'Atos', 'Romanos', 
        '1 Cor√≠ntios', '2 Cor√≠ntios', 'G√°latas', 'Ef√©sios', 'Filipenses', 'Colossenses', 
        '1 Tessalonicenses', '2 Tessalonicenses', '1 Tim√≥teo', '2 Tim√≥teo', 'Tito', 'Fil√©mom', 'Hebreus', 
        'Tiago', '1 Pedro', '2 Pedro', '1 Jo√£o', '2 Jo√£o', '3 Jo√£o', 'Judas', 'Apocalipse'
    ];

    // --- ELEMENTOS DOM ---
    const tocContainer = document.getElementById('book-toc');
    const listsContainer = document.getElementById('book-lists');
    const listsContent = document.getElementById('lists-content');
    const listsHeader = document.getElementById('lists-header');
    const listsTitle = document.getElementById('lists-title');
    const listsBackBtn = document.getElementById('lists-back-btn');

    const readArea = document.getElementById('reader-area');
    const emptyState = document.getElementById('empty-placeholder');
    const readTitle = document.getElementById('read-title');
    const readBody = document.getElementById('read-body');
    const userInfo = document.getElementById('user-info');
    
    // Refer√™ncias (Painel)
    const refTitle = document.getElementById('ref-title');
    const refDesc = document.getElementById('ref-description');
    const refList = document.getElementById('ref-list');
    const mainContainer = document.getElementById('main-container');
    const refPanel = document.getElementById('references-panel');

    // Senha
    const passwordModal = document.getElementById('password-modal');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    const confirmPasswordBtn = document.getElementById('confirm-password-btn');
    const cancelPasswordBtn = document.getElementById('cancel-password-btn');

    // ============================================================
    // 2. AUTENTICA√á√ÉO E INICIALIZA√á√ÉO
    // ============================================================
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'index.html';
        } else {
            // Carregar Perfil Simples
            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where("email", "==", user.email.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    userInfo.textContent = querySnapshot.docs[0].data().nome || user.email;
                } else {
                    userInfo.textContent = user.email.split('@')[0];
                }
            } catch (e) { console.error(e); }

            // Carregar Configura√ß√µes e Dados
            await loadSettings(user.uid);
            await loadBookStructure(user.uid);
            renderListsRoot(); 
        }
    });

    async function loadSettings(userId) {
        try {
            const configRef = doc(db, "configuracoes", userId);
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) {
                appSettings = { ...appSettings, ...configSnap.data() };
            }
        } catch (e) {
            console.error("Erro configura√ß√µes:", e);
        }
    }

    // ============================================================
    // 3. L√ìGICA DE SIDEBAR (Abas e √çndice)
    // ============================================================
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (btn.dataset.tab === 'notes') {
                tocContainer.style.display = 'block';
                listsContainer.style.display = 'none';
            } else {
                tocContainer.style.display = 'none';
                listsContainer.style.display = 'flex';
            }
        });
    });

    async function loadBookStructure(userId) {
        tocContainer.innerHTML = '<p style="padding:10px; color:#888;">A carregar √≠ndice...</p>';
        try {
            const q = query(collection(db, 'pastas'), where('userId', '==', userId), where('estado', '==', 'ativa'), orderBy('ordem'));
            const snapshot = await getDocs(q);
            const items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
            const rootItems = items.filter(i => !i.parentId);
            
            tocContainer.innerHTML = '';
            if (rootItems.length === 0) { tocContainer.innerHTML = '<p style="padding:10px;">Vazio.</p>'; return; }

            const buildTree = (parentItems, container) => {
                parentItems.forEach(item => {
                    const children = items.filter(i => i.parentId === item.id);
                    const li = document.createElement('div'); li.className = 'toc-item';
                    const header = document.createElement('div'); header.className = 'toc-header';
                    const arrow = item.tipo === 'pasta' ? `<span class="toc-arrow ${children.length>0?'':'hidden'}">‚ñ∂</span>` : '<span class="toc-arrow"></span>';
                    header.innerHTML = `${arrow} <span class="toc-icon">${item.tipo==='pasta'?'üìÅ':'üìÑ'}</span> ${item.nome}`;
                    
                    const childrenContainer = document.createElement('div'); childrenContainer.className = 'toc-children';
                    header.onclick = async () => {
                        if (item.tipo === 'pasta') {
                            if (children.length > 0) {
                                const isHidden = childrenContainer.style.display === 'none' || childrenContainer.style.display === '';
                                childrenContainer.style.display = isHidden ? 'block' : 'none';
                                header.querySelector('.toc-arrow').textContent = isHidden ? '‚ñº' : '‚ñ∂';
                            }
                        } else {
                            // Verifica senha ao clicar no TOC
                            if (item.passe && item.passe.trim() !== "") {
                                if (!sessionUnlockedFolders.has(item.id)) {
                                    const authorized = await requestPassword(item.id, item.parentId);
                                    if(!authorized) return;
                                }
                            } else if (item.parentId) {
                                // Verifica heran√ßa de senha do pai
                                const parent = items.find(i => i.id === item.parentId);
                                if (parent && parent.passe && parent.passe.trim() !== "") {
                                    if (!sessionUnlockedFolders.has(parent.id)) {
                                        const authorized = await requestPassword(item.id, parent.id);
                                        if(!authorized) return;
                                    }
                                }
                            }
                            displayNote(item);
                            document.querySelectorAll('.toc-header').forEach(el => el.classList.remove('active-note'));
                            header.classList.add('active-note');
                        }
                    };
                    li.appendChild(header);
                    if (children.length > 0) { buildTree(children, childrenContainer); li.appendChild(childrenContainer); }
                    container.appendChild(li);
                });
            };
            buildTree(rootItems, tocContainer);
        } catch (e) { console.error(e); }
    }

    // ============================================================
    // 4. EXIBI√á√ÉO DA NOTA E NAVEGA√á√ÉO MOBILE
    // ============================================================
    function displayNote(noteData) {
    document.body.classList.add('mobile-reading-active');
    emptyState.style.display = 'none';
    readArea.style.display = 'block';
    readTitle.textContent = noteData.nome;
    
    // --- APLICA A TRANSFORMA√á√ÉO AQUI ---
    const rawContent = noteData.conteudo || '<p><em>Nota vazia.</em></p>';
    const processedContent = transformMiniNotesToText(rawContent);
    
    readBody.innerHTML = processedContent;
    // ------------------------------------

    document.getElementById('book-content-scroll').scrollTop = 0;

    // (O resto da l√≥gica de links mant√©m-se igual...)
    const entities = readBody.querySelectorAll('.entity-link, .tag');
    if (entities.length > 0) {
        entities.forEach(el => {
            el.style.cursor = "pointer"; 
            el.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                let type = el.dataset.entityType;
                let name = el.dataset.entityName;
                if (!type && el.classList.contains('tag')) {
                    type = 'tag';
                    name = el.textContent.replace('#', '').trim();
                }
                if (name && type) findAndShowEntity(name, type);
            }
        });
    }
}

    // Bot√£o Flutuante (‚ò∞) - Canto Superior Esquerdo (Mobile)
    const btnMobileMenu = document.getElementById('mobile-menu-float-btn');
    if (btnMobileMenu) {
        btnMobileMenu.onclick = () => {
            document.body.classList.remove('mobile-reading-active');
        };
    }

    // ============================================================
    // 5. PAINEL DE REFER√äNCIAS (L√ìGICA DE DADOS E ARRASTO)
    // ============================================================
    
    async function findAndShowEntity(name, type) {
        // 1. Abrir Painel
        mainContainer.classList.add('references-visible');
        
        // [MOBILE] Define altura inicial para 50% ao abrir
        if (window.innerWidth <= 768) {
            refPanel.style.height = '50vh';
        }

        // 2. Estado de Carregamento
        const iconMap = { 'personagem': 'üë§', 'local': 'üìç', 'data': 'üìÖ', 'textobiblico': 'üìñ', 'tag': 'üè∑Ô∏è' };
        const icon = iconMap[type] || 'üîó';
        
        refTitle.textContent = `${icon} ${name}`;
        refDesc.innerHTML = '<em>A carregar dados...</em>';
        refList.innerHTML = '<div style="padding:20px; text-align:center;"><div class="spinner"></div></div>';

        const userId = auth.currentUser.uid;

        try {
            let foundNotes = [];
            let description = "";

            // --- CASO A: √â UMA TAG (#) ---
            if (type === 'tag') {
                refDesc.textContent = `Notas com a tag #${name}`;
                const q = query(
                    collection(db, 'pastas'), 
                    where('tags', 'array-contains', name), 
                    where('userId', '==', userId),
                    where('estado', '==', 'ativa')
                );
                const snap = await getDocs(q);
                foundNotes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } 
            
            // --- CASO B: √â UMA ENTIDADE ---
            else {
                const config = ENTITY_CONFIG[type];
                if (!config) { throw new Error("Tipo desconhecido"); }

                const qEntity = query(
                    collection(db, config.collection),
                    where('nome', '==', name),
                    where('userId', '==', userId)
                );
                const snapEntity = await getDocs(qEntity);

                if (!snapEntity.empty) {
                    const entityData = snapEntity.docs[0].data();
                    description = entityData.descricao || "Sem descri√ß√£o.";
                    
                    // Buscar notas referenciadas
                    if (entityData.referencias) {
                        const noteIds = Object.keys(entityData.referencias);
                        // Loop para buscar IDs individuais (Firestore limitation bypass)
                        for (const noteId of noteIds) {
                            const docRef = doc(db, 'pastas', noteId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists() && docSnap.data().estado === 'ativa') {
                                foundNotes.push({ id: docSnap.id, ...docSnap.data() });
                            }
                        }
                    }
                } else {
                    description = "Entidade n√£o encontrada na base de dados.";
                }
                refDesc.textContent = description;
            }

            // --- FILTRAGEM DE SEGURAN√áA (Senhas & Configura√ß√µes) ---
            const safeNotes = [];
            for (const note of foundNotes) {
                let isProtected = (note.passe && note.passe.trim() !== "");
                
                if (!isProtected && note.parentId) {
                    const parentSnap = await getDoc(doc(db, 'pastas', note.parentId));
                    if (parentSnap.exists() && parentSnap.data().passe) {
                        isProtected = true;
                    }
                }

                let show = true;
                if (isProtected) {
                    if (type === 'tag' && !appSettings.searchTagsInProtected) show = false;
                    else if (type !== 'tag' && !appSettings.searchAnchorsInProtected) show = false;
                }

                if (show) {
                    safeNotes.push({ ...note, isProtected });
                }
            }

            // --- RENDERIZAR ---
            refList.innerHTML = '';
            if (safeNotes.length === 0) {
                refList.innerHTML = '<li style="padding:15px; color:#888; text-align:center;">Nenhuma refer√™ncia encontrada.</li>';
            } else {
                safeNotes.sort((a, b) => a.nome.localeCompare(b.nome));
                safeNotes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'reference-item';
                    li.style.listStyle = 'none';
                    
                    const noteIcon = note.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';
                    const lock = note.isProtected ? 'üîí ' : '';
                    
                    li.innerHTML = `
                        <div style="padding:10px; cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                            <span>${noteIcon} ${lock}<strong>${note.nome}</strong></span>
                            <button class="go-to-btn">Ver ‚ûî</button>
                        </div>
                    `;
                    li.onclick = () => handleReferenceClick(note);
                    refList.appendChild(li);
                });
            }

        } catch (error) {
            console.error("Erro ao carregar refer√™ncias:", error);
            refList.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar dados.</li>';
        }
    }

    // Fechar Painel
    document.getElementById('close-ref-btn').onclick = () => {
        mainContainer.classList.remove('references-visible');
        if (window.innerWidth <= 768) {
            setTimeout(() => { refPanel.style.height = '50vh'; }, 300);
        }
    };

    // --- L√ìGICA DE ARRASTO (TOUCH EVENTS - MOBILE) ---
    const dragHandle = document.getElementById('panel-drag-handle');
    let startY = 0;
    let startHeight = 0;
    let isDragging = false;

    if (dragHandle) {
        // In√≠cio do toque
        dragHandle.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            startHeight = refPanel.getBoundingClientRect().height;
            refPanel.style.transition = 'none'; // Remove anima√ß√£o para movimento fluido
        }, { passive: false });

        // Movimento
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault(); // Impede scroll da p√°gina

            const currentY = e.touches[0].clientY;
            const deltaY = startY - currentY; // >0 sobe, <0 desce
            const newHeight = startHeight + deltaY;

            // Limites de seguran√ßa
            if (newHeight > 100 && newHeight <= window.innerHeight) {
                refPanel.style.height = `${newHeight}px`;
            }
        }, { passive: false });

        // Fim (Snap)
        document.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            refPanel.style.transition = 'height 0.3s ease-out'; // Restaura anima√ß√£o

            const finalHeight = refPanel.getBoundingClientRect().height;
            const windowHeight = window.innerHeight;

            // DEFINI√á√ÉO DE ZONAS
            const CLOSE_THRESHOLD = 60; // S√≥ fecha se tiver menos de 60px de altura
            const MINIMIZED_HEIGHT = 80; // Altura da barra minimizada

            if (finalHeight > windowHeight * 0.75) {
                // 1. Puxou muito para cima -> Ecr√£ Cheio
                refPanel.style.height = '100vh';
            } 
            else if (finalHeight > windowHeight * 0.40) {
                // 2. Est√° mais ou menos a meio -> 50% do ecr√£
                refPanel.style.height = '50vh';
            } 
            else if (finalHeight > CLOSE_THRESHOLD) {
                // 3. Puxou para baixo, mas N√ÉO at√© ao fim -> MINIMIZA (80px)
                refPanel.style.height = `${MINIMIZED_HEIGHT}px`;
            } 
            else {
                // 4. Puxou at√© ao fundo mesmo (altura < 60px) -> FECHA
                mainContainer.classList.remove('references-visible');
                setTimeout(() => { refPanel.style.height = '50vh'; }, 300);
            }
        });
    } // <--- ESTA CHAVETA ESTAVA EM FALTA

    // ============================================================
    // 6. BARRA DE FERRAMENTAS (Zoom, Copiar, PDF)
    // ============================================================
    const zoomSelect = document.getElementById('reader-zoom');

    if (zoomSelect) {
        zoomSelect.addEventListener('change', () => {
            const selectedValue = zoomSelect.value;
            
            // 1. Tamanho
            readBody.style.fontSize = selectedValue;
            
            // 2. Limpeza Profunda
            const elementsWithFixedSize = readBody.querySelectorAll('*');
            elementsWithFixedSize.forEach(el => {
                if (el.style.fontSize) el.style.fontSize = ''; 
                if (el.tagName === 'FONT') el.removeAttribute('size');
            });

            // 3. Entrelinhamento
            if (selectedValue.includes('%')) {
                 readBody.style.lineHeight = '1.8'; 
            } else {
                 const sizeNum = parseInt(selectedValue);
                 readBody.style.lineHeight = (sizeNum * 1.6) + 'px';
            }
        });
    }

    const btnCopy = document.getElementById('btn-copy');
    if (btnCopy) {
        btnCopy.onclick = async () => { 
            await navigator.clipboard.writeText(readTitle.textContent + '\n\n' + readBody.innerText); 
            alert('Copiado!'); 
        };
    }
    
    const btnPdf = document.getElementById('btn-pdf');
    if (btnPdf) {
        btnPdf.onclick = () => {
            const element = document.getElementById('reader-area');
            const toolbar = document.getElementById('note-toolbar');
            toolbar.style.display = 'none';
            element.classList.add('pdf-force-light-mode');
            
            html2pdf().set({ 
                margin: 10, filename: 'nota.pdf', image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            }).from(element).save().then(() => {
                element.classList.remove('pdf-force-light-mode');
                toolbar.style.display = 'flex';
            });
        };
    }

    // ============================================================
    // 7. LISTAS (Categorias)
    // ============================================================
    function renderListsRoot() {
        listsNavigationStack = [];
        listsHeader.style.display = 'none';
        listsContent.innerHTML = `
            <li onclick="window.openListCategory('topico')"><span class="list-icon">üìë</span> T√≥picos</li>
            <li onclick="window.openListCategory('personagem')"><span class="list-icon">üë§</span> Personagens</li>
            <li onclick="window.openListCategory('local')"><span class="list-icon">üìç</span> Locais</li>
            <li onclick="window.openListCategory('data')"><span class="list-icon">üìÖ</span> Datas</li>
            <li onclick="window.openListCategory('biblia_root')"><span class="list-icon">üìñ</span> B√≠blia</li>
            <li onclick="window.openListCategory('tags')"><span class="list-icon">üè∑Ô∏è</span> Tags</li>
        `;
    }

    window.openListCategory = async (type) => {
        listsNavigationStack.push({ type: 'root' });
        updateListHeader(type);
        listsContent.innerHTML = '<li style="cursor:default; color:#888;">A carregar...</li>';

        const userId = auth.currentUser.uid;
        let items = [];

        try {
            if (type === 'biblia_root') {
                items = BIBLICAL_BOOKS.map(book => ({ id: book, nome: book, type: 'bible_book' }));
            } 
            else if (type === 'topico') {
                const q = query(collection(db, 'topicos'), where('userId', '==', userId), orderBy('nome'));
                const snap = await getDocs(q);
                items = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'topico_item' }));
            }
            else if (type === 'tags') {
                const q = query(collection(db, 'tags'), where('userId', '==', userId), orderBy('nome'));
                const snap = await getDocs(q);
                items = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'tag_item' }));
            }
            else {
                const config = ENTITY_CONFIG[type];
                const q = query(collection(db, config.collection), where('userId', '==', userId), orderBy('nome'));
                const snap = await getDocs(q);
                items = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'entity_item', entityType: type }));
            }
            renderListItems(items, type);
        } catch (error) {
            console.error("Erro lista:", error);
            listsContent.innerHTML = '<li>Erro ao carregar dados.</li>';
        }
    };

    // --- FUN√á√ÉO DE TRANSFORMA√á√ÉO DE MINI-NOTAS ---
function transformMiniNotesToText(htmlContent) {
    if (!htmlContent) return '';
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;

    const wrappers = tempDiv.querySelectorAll('.mini-note-wrapper');
    wrappers.forEach(wrapper => {
        // Recuperar T√≠tulo
        const titleInput = wrapper.querySelector('.mini-note-title-input');
        let titleText = '';
        if (titleInput) {
            titleText = titleInput.getAttribute('value') || titleInput.value || '';
        }

        // Recuperar Conte√∫do
        const contentDiv = wrapper.querySelector('.mini-note-content');
        const innerContent = contentDiv ? contentDiv.innerHTML : '';

        // Criar Nova Estrutura
        const newContainer = document.createElement('div');
        newContainer.className = 'processed-mini-note';

        if (titleText.trim()) {
            const h2 = document.createElement('h2');
            h2.textContent = titleText;
            newContainer.appendChild(h2);
        }

        const bodyDiv = document.createElement('div');
        bodyDiv.className = 'mini-note-body';
        bodyDiv.innerHTML = innerContent;
        newContainer.appendChild(bodyDiv);

        wrapper.parentNode.replaceChild(newContainer, wrapper);
    });

    return tempDiv.innerHTML;
}

// --- FUN√á√ïES EM FALTA PARA AS LISTAS ---

function updateListHeader(title) {
    if (listsNavigationStack.length > 0) {
        listsHeader.style.display = 'flex';
        listsTitle.textContent = title;
    } else {
        listsHeader.style.display = 'none';
    }
}

// L√≥gica do bot√£o Voltar nas Listas
listsBackBtn.onclick = () => {
    listsNavigationStack.pop(); // Remove o atual
    if (listsNavigationStack.length === 0) {
        renderListsRoot();
    } else {
        const previous = listsNavigationStack[listsNavigationStack.length - 1];
        // L√≥gica simples para voltar (neste caso simplificado, voltamos √† raiz se n√£o for complexo)
        // Se precisar de navega√ß√£o multin√≠vel complexa, seria necess√°rio mais l√≥gica aqui.
        // Para j√°, assumimos que volta √† raiz ou categoria anterior:
        if (previous.type === 'bible_book') {
            // Re-renderizar livro b√≠blico √© complexo sem passar argumentos, 
            // simplificamos voltando √† raiz para evitar erros:
            renderListsRoot(); 
        } else {
            renderListsRoot();
        }
    }
};

async function loadAndFilterReferences(item) {
    // Carregar entidade
    let description = "Sem descri√ß√£o.";
    let foundNotes = [];
    const userId = auth.currentUser.uid;
    const type = item.entityType; // personagem, local, etc.

    // 1. Obter detalhes da entidade
    // (Nota: voc√™ j√° tem a l√≥gica disto no findAndShowEntity, 
    // mas aqui √© para listar notas na sidebar esquerda)
    
    // Simplifica√ß√£o: vamos reusar a l√≥gica de pesquisa de notas
    const config = ENTITY_CONFIG[type];
    if (config) {
        const q = query(collection(db, config.collection), where('userId', '==', userId), where('nome', '==', item.nome));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const data = snap.docs[0].data();
            if(data.referencias) {
                const noteIds = Object.keys(data.referencias);
                for(const nid of noteIds) {
                    const ndoc = await getDoc(doc(db, 'pastas', nid));
                    if(ndoc.exists() && ndoc.data().estado === 'ativa') {
                        foundNotes.push({ id: ndoc.id, ...ndoc.data() });
                    }
                }
            }
        }
    }

    // 2. Filtrar por Prote√ß√£o (Seguran√ßa)
    const safeNotes = [];
    for (const note of foundNotes) {
        let isProtected = (note.passe && note.passe.trim() !== "");
        if (!isProtected && note.parentId) {
            const parentSnap = await getDoc(doc(db, 'pastas', note.parentId));
            if (parentSnap.exists() && parentSnap.data().passe) isProtected = true;
        }

        // Se protegido e configura√ß√µes n√£o permitem ver, salta
        let show = true;
        if (isProtected && !appSettings.searchAnchorsInProtected) show = false;
        
        if (show) safeNotes.push(note);
    }

    // 3. Renderizar na Sidebar
    listsContent.innerHTML = '';
    if (safeNotes.length === 0) {
        listsContent.innerHTML = '<li style="cursor:default;">Nenhuma nota encontrada.</li>';
    } else {
        safeNotes.sort((a,b) => a.nome.localeCompare(b.nome));
        safeNotes.forEach(note => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="list-icon">üìÑ</span> ${note.nome}`;
            li.onclick = async () => {
                 // Verifica√ß√£o de senha antes de abrir
                 if (note.passe || note.isProtected) { // Simplificado
                     if (!sessionUnlockedFolders.has(note.id)) {
                         const ok = await requestPassword(note.id, note.parentId);
                         if(!ok) return;
                     }
                 }
                 displayNote(note);
            };
            listsContent.appendChild(li);
        });
    }
}

    function renderListItems(items, currentType) {
        listsContent.innerHTML = '';
        if (items.length === 0) {
            listsContent.innerHTML = '<li style="cursor:default;">Nenhum item.</li>';
            return;
        }
        items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item.nome;
            li.onclick = () => handleListItemClick(item, currentType);
            listsContent.appendChild(li);
        });
    }

    async function handleListItemClick(item, parentType) {
        if (item.type === 'bible_book') {
            updateListHeader(item.nome);
            listsContent.innerHTML = '<li>A carregar textos...</li>';
            const q = query(collection(db, 'textosbiblicos'), where('userId', '==', auth.currentUser.uid));
            const snap = await getDocs(q);
            const texts = snap.docs
                .map(d => ({ id: d.id, ...d.data(), type: 'entity_item', entityType: 'textobiblico' }))
                .filter(t => t.nome.startsWith(item.nome))
                .sort((a, b) => a.nome.localeCompare(b.nome, undefined, { numeric: true, sensitivity: 'base' }));
            
            listsNavigationStack.push({ type: 'bible_book', name: item.nome });
            renderListItems(texts, 'textobiblico');
            return;
        }

        listsNavigationStack.push({ type: 'item_detail', name: item.nome });
        updateListHeader(item.nome);
        listsContent.innerHTML = '<li>A verificar permiss√µes...</li>';
        await loadAndFilterReferences(item);
    }

    // ============================================================
    // 8. UTILIT√ÅRIOS (Pesquisa e Senha)
    // ============================================================
    function requestPassword(itemId, parentId) {
        return new Promise((resolve) => {
            passwordModal.style.display = 'flex';
            passwordInput.value = '';
            passwordError.style.display = 'none';
            passwordInput.focus();

            const cleanup = () => { passwordModal.style.display = 'none'; };
            const newConfirm = confirmPasswordBtn.cloneNode(true);
            const newCancel = cancelPasswordBtn.cloneNode(true);
            confirmPasswordBtn.parentNode.replaceChild(newConfirm, confirmPasswordBtn);
            cancelPasswordBtn.parentNode.replaceChild(newCancel, cancelPasswordBtn);

            newConfirm.onclick = async () => {
                const inputPass = passwordInput.value;
                let isValid = false, idUnlocked = null;
                try {
                    const itemSnap = await getDoc(doc(db, 'pastas', itemId));
                    if (itemSnap.exists() && itemSnap.data().passe === inputPass) { isValid = true; idUnlocked = itemId; }
                    else if (parentId) {
                        const parentSnap = await getDoc(doc(db, 'pastas', parentId));
                        if (parentSnap.exists() && parentSnap.data().passe === inputPass) { isValid = true; idUnlocked = parentId; }
                    }
                    if (isValid) { sessionUnlockedFolders.add(idUnlocked); cleanup(); resolve(true); } 
                    else { passwordError.style.display = 'block'; }
                } catch (e) { console.error(e); resolve(false); }
            };
            newCancel.onclick = () => { cleanup(); resolve(false); };
            passwordInput.onkeydown = (e) => { if(e.key === 'Enter') newConfirm.click(); if(e.key === 'Escape') newCancel.click(); }
        });
    }

    document.getElementById('global-search-btn').onclick = () => document.getElementById('search-modal').style.display = 'flex';
    document.getElementById('close-search-modal').onclick = () => document.getElementById('search-modal').style.display = 'none';   
    </script>
</body>
</html>
