<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modo Leitura - JW Notebook</title>
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1d;
            --sidebar-color: #252528;
            --panel-color: #1f1f22;
            --text-color: #f0f0f0;
            --text-muted: #888;
            --accent-color: #4a90e2;
            --border-color: #333;
            --hover-color: #2c2c30;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            height: 100vh; 
            overflow: hidden;
        }

        #user-info {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-top: 5px;
            font-weight: bold;
            display: block;
            text-transform: capitalize; /* Coloca a primeira letra do nome em mai√∫scula */
        }

        /* Classe especial para for√ßar cor preta no PDF */
        .pdf-force-light-mode {
            color: #000000 !important;
            background-color: #ffffff !important;
        }
        .pdf-force-light-mode * {
            color: #000000 !important;
            background-color: transparent !important; /* Para n√£o tapar texto */
        }

        /* Layout Principal Flexbox */
        .book-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* --- COLUNA 1: BARRA LATERAL (√çndice) --- */
        #book-sidebar {
            flex: 0 0 300px;
            background-color: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { font-size: 1.2em; font-weight: 500; color: var(--accent-color); }
        .sidebar-header p { font-size: 0.9em; color: var(--text-muted); margin-top: 5px; font-weight: bold; }

        #book-toc { flex-grow: 1; overflow-y: auto; padding: 10px; list-style: none; }
        
        /* Footer da Sidebar */
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        #global-search-btn {
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.2s;
        }
        #global-search-btn:hover { background-color: var(--hover-color); }

        /* Estilos do TOC (√çndice) */
        .toc-item { margin-bottom: 2px; }
        .toc-header { display: flex; align-items: center; padding: 8px 10px; cursor: pointer; border-radius: 4px; color: var(--text-muted); transition: all 0.2s; font-size: 0.95em; }
        .toc-header:hover { background-color: var(--hover-color); color: var(--text-color); }
        .toc-header.active-note { background-color: rgba(74, 144, 226, 0.2); color: var(--accent-color); font-weight: bold; }
        .toc-icon { margin-right: 8px; }
        .toc-arrow { margin-right: 5px; width: 15px; text-align: center; transition: transform 0.2s; display: inline-block; }
        .toc-arrow.rotated { transform: rotate(90deg); }
        .toc-children { margin-left: 20px; border-left: 1px solid var(--border-color); display: none; }

        /* --- COLUNA 2: √ÅREA DE LEITURA --- */
        #book-main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            min-width: 0;
        }

        #book-content-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 40px 60px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            line-height: 1.8;
        }

        #read-title { font-size: 2.5em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--accent-color); }
        
        /* --- BARRA DE FERRAMENTAS DA NOTA --- */
        #note-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding: 10px;
            background-color: var(--panel-color);
            border-radius: 6px;
            align-items: center;
        }
        .toolbar-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .toolbar-btn:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
            border-color: var(--accent-color);
        }

        #read-body { font-size: 1.1em; transition: font-size 0.2s; }
        
        /* Estilos de Entidades e Tags */
        .tag { background-color: #3a5370; color: #4a90e2; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; margin-right: 5px; cursor: pointer; }
        .tag:hover { background-color: var(--accent-color); color: white; }
        
        .entity-link { 
            color: var(--accent-color); 
            border-bottom: 1px dashed var(--accent-color); 
            cursor: pointer; 
            background-color: rgba(74, 144, 226, 0.1);
        }
        .entity-link:hover { background-color: rgba(74, 144, 226, 0.3); }

        .entity-link[data-entity-type="personagem"] { color: #e67e22; border-color: #e67e22; background-color: rgba(230, 126, 34, 0.1); }
        .entity-link[data-entity-type="local"] { color: #2ecc71; border-color: #2ecc71; background-color: rgba(46, 204, 113, 0.1); }
        .entity-link[data-entity-type="data"] { color: #9b59b2; border-color: #9b59b2; background-color: rgba(155, 89, 182, 0.1); }

        /* --- COLUNA 3 (Refer√™ncias) --- */
        #references-panel {
            flex: 0 0 0;
            width: 0;
            background-color: var(--sidebar-color);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            opacity: 0;
        }

        .book-container.references-visible #references-panel {
            flex: 0 0 400px;
            padding: 20px;
            opacity: 1;
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-header h2 { font-size: 18px; font-weight: 500; color: var(--text-color); }
        #close-ref-btn { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        
        #ref-description { font-size: 0.9em; color: var(--text-muted); margin-bottom: 20px; padding-left: 10px; border-left: 3px solid var(--accent-color); line-height: 1.5; }

        #references-toolbar {
            display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
        }
        #references-toolbar button {
            background: none; border: 1px solid transparent; color: var(--text-muted); font-size: 1.4em; cursor: pointer; padding: 5px; border-radius: 5px; transition: all 0.2s;
        }
        #references-toolbar button:hover { color: var(--text-color); background-color: var(--hover-color); }

        #ref-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        
        .reference-item { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-color); }
        .reference-item summary { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .reference-item summary:hover { color: var(--accent-color); }
        .reference-context { padding: 10px; border-top: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-muted); line-height: 1.5; }
        .reference-context mark { background-color: rgba(74, 144, 226, 0.4); color: white; padding: 0 2px; border-radius: 2px; }

        .go-to-btn { background: none; border: 1px solid var(--text-muted); color: var(--text-muted); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.8em; }
        .go-to-btn:hover { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }

        /* --- MODAL DE PESQUISA GLOBAL --- */
        .search-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay);
            display: none; justify-content: center; align-items: start;
            z-index: 2000; padding-top: 100px;
        }
        .search-modal-content {
            background-color: var(--sidebar-color);
            width: 90%; max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            max-height: 70vh;
        }
        .search-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; }
        #global-search-input {
            flex-grow: 1; padding: 12px; font-size: 1.1em;
            background-color: var(--bg-color); border: 1px solid var(--border-color);
            color: var(--text-color); border-radius: 5px;
        }
        #close-search-modal { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        
        #search-results-list {
            list-style: none; overflow-y: auto; padding: 10px;
        }
        .search-result-item {
            padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .search-result-item:hover { background-color: var(--hover-color); }
        .result-category {
            font-size: 0.75em; text-transform: uppercase; font-weight: bold;
            padding: 2px 6px; border-radius: 4px; margin-left: 10px;
            background-color: var(--panel-color); color: var(--text-muted);
        }
        .cat-nota { color: #f0f0f0; border: 1px solid var(--text-muted); }
        .cat-personagem { color: #e67e22; border: 1px solid #e67e22; }
        .cat-local { color: #2ecc71; border: 1px solid #2ecc71; }
        .cat-data { color: #9b59b2; border: 1px solid #9b59b2; }
        .cat-tag { color: #3498db; border: 1px solid #3498db; }
        .cat-biblia { color: #f1c40f; border: 1px solid #f1c40f; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }
        .empty-state span { font-size: 3em; margin-bottom: 20px; }

    </style>
</head>
<body>

<div class="book-container" id="main-container">
    
    <!-- 1. Barra Lateral -->
    <aside id="book-sidebar">
        <div>
            <div class="sidebar-header">
                <h2>As Minhas Notas</h2>
                <p id="user-info">A carregar...</p>
            </div>
            <div id="book-toc"></div>
        </div>
        
        <!-- Rodap√© com Bot√£o de Pesquisa -->
        <div class="sidebar-footer">
            <button id="global-search-btn">üîç Pesquisar Tudo</button>
        </div>
    </aside>

    <!-- 2. √Årea de Leitura -->
    <main id="book-main-panel">
        <div id="book-content-scroll">
            <div id="empty-placeholder" class="empty-state">
                <span>üìñ</span>
                <h2>Selecione uma nota para ler</h2>
            </div>
            
            <article id="reader-area" style="display: none;">
                <h1 id="read-title"></h1>
                
                <!-- BARRA DE FERRAMENTAS -->
                <div id="note-toolbar">
                    <button class="toolbar-btn" id="btn-zoom-out" title="Diminuir Texto">A-</button>
                    <button class="toolbar-btn" id="btn-zoom-in" title="Aumentar Texto">A+</button>
                    <button class="toolbar-btn" id="btn-copy" title="Copiar Texto">üìã Copiar</button>
                    <button class="toolbar-btn" id="btn-pdf" title="Descarregar PDF">üì• PDF</button>
                </div>

                <div id="read-body"></div>
            </article>
        </div>
    </main>

    <!-- 3. Painel de Refer√™ncias -->
    <aside id="references-panel">
        <div class="panel-header">
            <h2 id="ref-title">Refer√™ncias</h2>
            <button id="close-ref-btn" title="Fechar">√ó</button>
        </div>
        
        <div id="references-toolbar">
            <button id="ref-refresh-btn" title="Atualizar Refer√™ncias">üîÑ</button>
            <button id="ref-wol-btn" title="Ler na WOL" style="display: none;">üìñ</button>
            <button id="ref-search-btn" title="Pesquisar">üîç</button>
            <button id="ref-toggle-btn" title="Expandir/Recolher Tudo">‚ÜïÔ∏è</button>
        </div>

        <p id="ref-description"></p>
        <ul id="ref-list"></ul>
    </aside>

</div>

<!-- MODAL DE PESQUISA GLOBAL -->
<div id="search-modal" class="search-modal-overlay">
    <div class="search-modal-content">
        <div class="search-header">
            <input type="text" id="global-search-input" placeholder="Pesquisar notas, tags, personagens...">
            <button id="close-search-modal">√ó</button>
        </div>
        <ul id="search-results-list">
            <li style="padding: 20px; text-align: center; color: #888;">Digite para pesquisar...</li>
        </ul>
    </div>
</div>

<script type="module">
    import { db, auth } from './js/firebase-config.js';
    import { collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    // --- ELEMENTOS DOM ---
    const mainContainer = document.getElementById('main-container');
    const tocContainer = document.getElementById('book-toc');
    const readArea = document.getElementById('reader-area');
    const emptyState = document.getElementById('empty-placeholder');
    const readTitle = document.getElementById('read-title');
    const readBody = document.getElementById('read-body');
    const userInfo = document.getElementById('user-info');
    
    // Ferramentas da Nota
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnCopy = document.getElementById('btn-copy');
    const btnPdf = document.getElementById('btn-pdf');
    let currentFontSize = 1.1; 

    // Refer√™ncias
    const refTitle = document.getElementById('ref-title');
    const refDesc = document.getElementById('ref-description');
    const refList = document.getElementById('ref-list');
    const closeRefBtn = document.getElementById('close-ref-btn');
    const refRefreshBtn = document.getElementById('ref-refresh-btn');
    const refWolBtn = document.getElementById('ref-wol-btn');
    const refSearchBtn = document.getElementById('ref-search-btn');
    const refToggleBtn = document.getElementById('ref-toggle-btn');

    // Pesquisa Global
    const globalSearchBtn = document.getElementById('global-search-btn');
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('global-search-input');
    const searchResultsList = document.getElementById('search-results-list');
    const closeSearchModalBtn = document.getElementById('close-search-modal');

    let activeReferenceState = null;

    const ENTITY_CONFIG = {
        personagem: { collection: 'personagens' },
        local: { collection: 'locais' },
        data: { collection: 'datas' },
        textobiblico: { collection: 'textosbiblicos' }
    };

    // --- L√ìGICA DA BARRA DE FERRAMENTAS ---
    
    // Zoom
    btnZoomIn.addEventListener('click', () => {
        if (currentFontSize < 3.0) {
            currentFontSize += 0.1;
            readBody.style.fontSize = `${currentFontSize.toFixed(1)}em`;
        }
    });

    btnZoomOut.addEventListener('click', () => {
        if (currentFontSize > 0.8) {
            currentFontSize -= 0.1;
            readBody.style.fontSize = `${currentFontSize.toFixed(1)}em`;
        }
    });

    // Copiar Texto
    btnCopy.addEventListener('click', async () => {
        try {
            const textToCopy = readTitle.textContent + '\n\n' + readBody.innerText;
            await navigator.clipboard.writeText(textToCopy);
            
            const originalText = btnCopy.textContent;
            btnCopy.textContent = "‚úÖ Copiado!";
            setTimeout(() => { btnCopy.textContent = originalText; }, 2000);
        } catch (err) {
            console.error('Falha ao copiar:', err);
            alert('Erro ao copiar texto.');
        }
    });

    // Descarregar PDF (COM CORRE√á√ÉO DE COR)
    btnPdf.addEventListener('click', () => {
        const element = document.getElementById('reader-area');
        
        // Ocultar a barra de ferramentas para n√£o sair no PDF
        const toolbar = document.getElementById('note-toolbar');
        toolbar.style.display = 'none';

        // *** IMPORTANTE: Adicionar classe para for√ßar PRETO no PDF ***
        element.classList.add('pdf-force-light-mode');

        const opt = {
            margin:       [15, 15, 15, 15],
            filename:     `${readTitle.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            // Restaura o estado original (Modo Escuro e Toolbar)
            element.classList.remove('pdf-force-light-mode');
            toolbar.style.display = 'flex';
        }).catch(err => {
            console.error("Erro PDF:", err);
            element.classList.remove('pdf-force-light-mode');
            toolbar.style.display = 'flex';
        });
    });

    // --- AUTENTICA√á√ÉO & CARREGAMENTO DE USER ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            alert("Sess√£o inv√°lida.");
            window.location.href = 'index.html';
        } else {
            // 1. Texto tempor√°rio enquanto carrega
            userInfo.textContent = "A carregar...";

            try {
                // For√ßa o email para min√∫sculas para garantir que encontra no banco de dados
                const emailSearch = user.email.toLowerCase();
                console.log("A procurar utilizador com email:", emailSearch);

                const usersRef = collection(db, 'users');
                const q = query(usersRef, where("email", "==", emailSearch));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Encontrou!
                    const userData = querySnapshot.docs[0].data();
                    console.log("Dados encontrados:", userData);
                    
                    if (userData.nome) {
                        userInfo.textContent = userData.nome; 
                    } else {
                        userInfo.textContent = "Nome n√£o definido"; 
                    }
                } else {
                    // N√£o encontrou
                    console.warn("Nenhum documento encontrado na cole√ß√£o 'users' para este email.");
                    // Fallback: Mostra a primeira parte do email se n√£o encontrar o nome
                    const nameFromEmail = user.email.split('@')[0];
                    userInfo.textContent = nameFromEmail; 
                }
            } catch (e) {
                console.error("Erro ao buscar nome (Verifique as Regras do Firestore):", e);
                userInfo.textContent = "Utilizador (Erro)";
            }
            
            await loadBookStructure(user.uid);
        }
    });

    // --- L√ìGICA DE PESQUISA GLOBAL ---

    globalSearchBtn.addEventListener('click', () => {
        searchModal.style.display = 'flex';
        searchInput.value = '';
        searchResultsList.innerHTML = '<li style="padding: 20px; text-align: center; color: #888;">Digite para pesquisar em todo o caderno...</li>';
        searchInput.focus();
    });

    closeSearchModalBtn.addEventListener('click', () => {
        searchModal.style.display = 'none';
    });

    searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) searchModal.style.display = 'none';
    });

    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const term = e.target.value.trim();
        if (term.length < 2) return;
        
        searchTimeout = setTimeout(() => {
            performGlobalSearch(term);
        }, 600);
    });

    async function performGlobalSearch(term) {
        if (!auth.currentUser) return;
        const userId = auth.currentUser.uid;
        const lowerTerm = term.toLowerCase();
        
        searchResultsList.innerHTML = '<li style="padding: 20px; text-align: center;">A pesquisar...</li>';

        try {
            const promises = [];

            // 1. Pesquisar em Pastas (Notas Ativas)
            const notesQuery = query(collection(db, 'pastas'), where('userId', '==', userId), where('estado', '==', 'ativa'));
            promises.push(getDocs(notesQuery).then(snap => 
                snap.docs.map(d => ({ type: 'nota', id: d.id, ...d.data() }))
            ));

            // 2. Pesquisar em Entidades
            for (const key in ENTITY_CONFIG) {
                const q = query(collection(db, ENTITY_CONFIG[key].collection), where('userId', '==', userId));
                promises.push(getDocs(q).then(snap => 
                    snap.docs.map(d => ({ type: key, id: d.id, ...d.data() }))
                ));
            }

            // 3. Pesquisar T√≥picos e Subt√≥picos
            promises.push(getDocs(query(collection(db, 'topicos'), where('userId', '==', userId))).then(snap => 
                snap.docs.map(d => ({ type: 'topico', id: d.id, ...d.data() }))
            ));
            promises.push(getDocs(query(collection(db, 'subtopicos'), where('userId', '==', userId))).then(snap => 
                snap.docs.map(d => ({ type: 'subtopico', id: d.id, ...d.data() }))
            ));

            // Executar tudo
            const resultsArrays = await Promise.all(promises);
            const flatResults = resultsArrays.flat();

            // Filtragem no Cliente
            const filteredResults = flatResults.filter(item => {
                if (item.nome && item.nome.toLowerCase().includes(lowerTerm)) return true;
                if (item.type === 'nota' && item.conteudo && item.conteudo.toLowerCase().includes(lowerTerm)) return true;
                if (item.type === 'nota' && item.tags && Array.isArray(item.tags)) {
                    return item.tags.some(tag => tag.toLowerCase().includes(lowerTerm));
                }
                return false;
            });

            renderSearchResults(filteredResults, lowerTerm);

        } catch (error) {
            console.error("Erro na pesquisa:", error);
            searchResultsList.innerHTML = '<li style="padding: 10px; color: red;">Erro ao pesquisar.</li>';
        }
    }

    function renderSearchResults(results, term) {
        searchResultsList.innerHTML = '';
        
        if (results.length === 0) {
            searchResultsList.innerHTML = '<li style="padding: 20px; text-align: center;">Nenhum resultado encontrado.</li>';
            return;
        }

        const processedResults = [];
        
        results.forEach(item => {
            if ((item.nome && item.nome.toLowerCase().includes(term)) || (item.conteudo && item.conteudo.toLowerCase().includes(term))) {
                processedResults.push(item);
            }
            if (item.type === 'nota' && item.tags) {
                item.tags.forEach(tag => {
                    if (tag.toLowerCase().includes(term)) {
                        if (!processedResults.some(r => r.type === 'tag' && r.nome === tag)) {
                            processedResults.push({ type: 'tag', nome: tag, id: 'tag_'+tag });
                        }
                    }
                });
            }
        });

        processedResults.forEach(item => {
            const li = document.createElement('li');
            li.className = 'search-result-item';
            
            let displayType = item.type;
            let categoryClass = `cat-${item.type}`;
            
            if (item.type === 'textobiblico') { displayType = 'B√≠blia'; categoryClass = 'cat-biblia'; }
            
            li.innerHTML = `
                <span>${item.nome}</span>
                <span class="result-category ${categoryClass}">${displayType}</span>
            `;

            li.onclick = () => {
                searchModal.style.display = 'none';
                handleSearchResultClick(item);
            };

            searchResultsList.appendChild(li);
        });
    }

    function handleSearchResultClick(item) {
        if (item.type === 'nota') {
            displayNote(item);
            document.querySelectorAll('.toc-header').forEach(el => {
                el.classList.remove('active-note');
                if(el.dataset.id === item.id) el.classList.add('active-note');
            });
        } 
        else if (item.type === 'tag') {
            showTagReferences(item.nome);
        }
        else if (item.type === 'topico' || item.type === 'subtopico') {
            showTopicReferencesPanel(item.id, item.nome, item.descricao || '', item.type);
        }
        else {
            findAndShowEntity(item.nome, item.type);
        }
    }

    // ============================================================
    // C√ìDIGO ORIGINAL (CARREGAMENTO E NAVEGA√á√ÉO)
    // ============================================================

    async function loadBookStructure(userId) {
        tocContainer.innerHTML = '<p style="padding:10px; color:#888;">A carregar √≠ndice...</p>';
        try {
            const q = query(collection(db, 'pastas'), where('userId', '==', userId), where('estado', '==', 'ativa'), orderBy('ordem'));
            const snapshot = await getDocs(q);
            const items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));

            const rootItems = items.filter(i => !i.parentId);
            tocContainer.innerHTML = '';

            if (rootItems.length === 0) {
                tocContainer.innerHTML = '<p style="padding:10px;">Nenhum item encontrado.</p>';
                return;
            }

            const buildTree = (parentItems, container) => {
                parentItems.forEach(item => {
                    const children = items.filter(i => i.parentId === item.id);
                    const hasChildren = children.length > 0;
                    
                    const li = document.createElement('div');
                    li.className = 'toc-item';

                    const header = document.createElement('div');
                    header.className = 'toc-header';
                    
                    let icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';
                    let arrowHTML = (item.tipo === 'pasta') 
                        ? `<span class="toc-arrow ${hasChildren ? '' : 'hidden'}" style="${hasChildren ? '' : 'opacity:0'}">‚ñ∂</span>` 
                        : `<span class="toc-arrow"></span>`;
                    
                    header.innerHTML = `${arrowHTML} <span class="toc-icon">${icon}</span> ${item.nome}`;
                    header.dataset.id = item.id; 

                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'toc-children';

                    header.onclick = () => {
                        if (item.tipo === 'pasta') {
                            if (!hasChildren) return;
                            const arrow = header.querySelector('.toc-arrow');
                            if (childrenContainer.style.display === 'block') {
                                childrenContainer.style.display = 'none';
                                if(arrow) { arrow.textContent = '‚ñ∂'; arrow.classList.remove('rotated'); }
                            } else {
                                childrenContainer.style.display = 'block';
                                if(arrow) { arrow.textContent = '‚ñº'; arrow.classList.add('rotated'); }
                            }
                        } else {
                            displayNote(item);
                            document.querySelectorAll('.toc-header').forEach(el => el.classList.remove('active-note'));
                            header.classList.add('active-note');
                        }
                    };

                    li.appendChild(header);
                    if (hasChildren) {
                        buildTree(children, childrenContainer);
                        li.appendChild(childrenContainer);
                    }
                    container.appendChild(li);
                });
            };
            buildTree(rootItems, tocContainer);
        } catch (error) {
            console.error("Erro ao carregar livros:", error);
            tocContainer.innerHTML = '<p style="color:red; padding:10px;">Erro ao carregar dados.</p>';
        }
    }

    function displayNote(noteData) {
        emptyState.style.display = 'none';
        readArea.style.display = 'block';
        
        currentFontSize = 1.1;
        readBody.style.fontSize = '1.1em';

        readTitle.textContent = noteData.nome;
        readBody.innerHTML = noteData.conteudo || '<p><em>Nota vazia.</em></p>';

        const links = readBody.querySelectorAll('a:not([data-anexo-id])');
        links.forEach(a => { a.target = '_blank'; a.style.cursor = 'pointer'; });

        document.getElementById('book-content-scroll').scrollTop = 0;
    }

    readBody.addEventListener('click', (e) => {
        const entityLink = e.target.closest('.entity-link');
        const tagLink = e.target.closest('.tag');

        if (entityLink) {
            e.preventDefault();
            const name = entityLink.dataset.entityName;
            const type = entityLink.dataset.entityType;
            findAndShowEntity(name, type);
        } 
        else if (tagLink) {
            e.preventDefault();
            const tagName = tagLink.textContent.replace('#', '').trim();
            showTagReferences(tagName);
        }
    });

    // --- BARRA LATERAL DE REFER√äNCIAS ---

    closeRefBtn.addEventListener('click', hideReferencesPanel);

    function hideReferencesPanel() {
        mainContainer.classList.remove('references-visible');
    }

    refRefreshBtn.onclick = () => {
        if (!activeReferenceState) return;
        if (activeReferenceState.mode === 'entity') {
            findAndShowEntity(activeReferenceState.name, activeReferenceState.type);
        } else if (activeReferenceState.mode === 'tag') {
            showTagReferences(activeReferenceState.name);
        } else if (activeReferenceState.mode === 'topic') {
            showTopicReferencesPanel(activeReferenceState.id, activeReferenceState.name, activeReferenceState.desc, activeReferenceState.type);
        }
    };

    refToggleBtn.onclick = () => {
        const allDetails = refList.querySelectorAll('details');
        if (allDetails.length === 0) return;
        const openCount = refList.querySelectorAll('details[open]').length;
        const shouldOpen = openCount <= allDetails.length / 2;
        allDetails.forEach(d => d.open = shouldOpen);
    };

    async function findAndShowEntity(name, type) {
        activeReferenceState = { mode: 'entity', name: name, type: type };
        mainContainer.classList.add('references-visible');
        refTitle.textContent = `Ref: "${name}"`;
        refDesc.textContent = 'A procurar detalhes...';
        refList.innerHTML = '<li>A carregar...</li>';

        if (type === 'textobiblico') {
            refWolBtn.style.display = 'block';
            refWolBtn.onclick = () => {
                const encodedQuery = encodeURIComponent(name).replace(/%20/g, '+');
                window.open(`https://wol.jw.org/pt-PT/wol/l/r296/lp-tpo?q=${encodedQuery}`, '_blank');
            };
        } else {
            refWolBtn.style.display = 'none';
        }

        refSearchBtn.onclick = () => {
            const encodedQuery = encodeURIComponent(name);
            window.open(`https://wol.jw.org/pt/wol/s/r5/lp-t?q=${encodedQuery}`, '_blank');
        };

        const config = ENTITY_CONFIG[type];
        if (!config) return;
        if (!auth.currentUser) { refList.innerHTML = '<li>Sess√£o inv√°lida.</li>'; return; }

        try {
            const qEntity = query(collection(db, config.collection), where('nome', '==', name), where('userId', '==', auth.currentUser.uid));
            const snapEntity = await getDocs(qEntity);

            if (snapEntity.empty) {
                refDesc.textContent = 'Entidade n√£o encontrada no √≠ndice.';
                refList.innerHTML = '';
                return;
            }

            const entityData = snapEntity.docs[0].data();
            refDesc.textContent = entityData.descricao || 'Sem descri√ß√£o dispon√≠vel.';
            refList.innerHTML = '';

            if (entityData.referencias) {
                const noteIds = Object.keys(entityData.referencias);
                await loadLinkedNotes(noteIds, name);
            } else {
                refList.innerHTML = '<li style="padding:10px; color:#888;">Nenhuma refer√™ncia encontrada.</li>';
            }
        } catch (error) {
            console.error("Erro na entidade:", error);
            refList.innerHTML = '<li>Erro de permiss√£o ou dados.</li>';
        }
    }

    async function showTagReferences(tagName) {
        activeReferenceState = { mode: 'tag', name: tagName };
        mainContainer.classList.add('references-visible');
        refTitle.textContent = `Tag: #${tagName}`;
        refDesc.textContent = '';
        refList.innerHTML = '<li>A pesquisar notas...</li>';
        
        refWolBtn.style.display = 'none';
        refSearchBtn.onclick = () => {
             const encodedQuery = encodeURIComponent(tagName);
             window.open(`https://wol.jw.org/pt/wol/s/r5/lp-t?q=${encodedQuery}`, '_blank');
        };

        if (!auth.currentUser) return;

        try {
            const q = query(collection(db, 'pastas'), where('tags', 'array-contains', tagName), where('estado', '==', 'ativa'), where('userId', '==', auth.currentUser.uid));
            const snapshot = await getDocs(q);
            refList.innerHTML = '';

            if (snapshot.empty) {
                refList.innerHTML = '<li style="padding:10px;">Nenhuma nota com esta tag.</li>';
                return;
            }
            snapshot.forEach(doc => { createReferenceItem(doc.id, doc.data(), tagName, true); });
        } catch (error) {
            console.error("Erro na tag:", error);
            refList.innerHTML = '<li>Erro ao buscar tags.</li>';
        }
    }

    async function showTopicReferencesPanel(id, name, description, type) {
        activeReferenceState = { mode: 'topic', id, name, desc: description, type };
        mainContainer.classList.add('references-visible');
        refTitle.textContent = `${type === 'topico' ? 'T√≥pico' : 'Subt√≥pico'}: ${name}`;
        refDesc.textContent = description || 'Sem descri√ß√£o.';
        refList.innerHTML = '<li>A pesquisar refer√™ncias...</li>';
        
        refWolBtn.style.display = 'none';
        refSearchBtn.onclick = () => { window.open(`https://wol.jw.org/pt/wol/s/r5/lp-t?q=${encodeURIComponent(name)}`, '_blank'); };

        try {
            const collectionRef = collection(db, 'pastas');
            const q = query(collectionRef, where('estado', '==', 'ativa'), where('userId', '==', auth.currentUser.uid));
            const snapshot = await getDocs(q);
            const results = [];

            snapshot.forEach(docSnapshot => {
                const data = docSnapshot.data();
                if (data.topicosSelecionados) {
                    if (type === 'topico') {
                        if (data.topicosSelecionados.hasOwnProperty(id)) results.push({ id: docSnapshot.id, ...data });
                    } else {
                        const hasSub = Object.values(data.topicosSelecionados).some(subArray => Array.isArray(subArray) && subArray.includes(id));
                        if (hasSub) results.push({ id: docSnapshot.id, ...data });
                    }
                }
            });

            refList.innerHTML = '';
            if (results.length === 0) { refList.innerHTML = '<li>Nenhuma refer√™ncia.</li>'; return; }
            results.sort((a, b) => a.nome.localeCompare(b.nome));
            
            results.forEach(data => {
                const details = document.createElement('details');
                details.className = 'reference-item';
                const summary = document.createElement('summary');
                
                const titleSpan = document.createElement('span');
                titleSpan.textContent = data.nome;
                const btn = document.createElement('button');
                btn.className = 'go-to-btn';
                btn.textContent = 'Ler';
                btn.onclick = (e) => { e.preventDefault(); displayNote(data); };

                summary.appendChild(titleSpan);
                summary.appendChild(btn);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'reference-context';
                contentDiv.innerHTML = '<p>Vinculado manualmente.</p>';

                details.appendChild(summary);
                details.appendChild(contentDiv);
                refList.appendChild(details);
            });

        } catch (error) {
            console.error("Erro t√≥pico:", error);
            refList.innerHTML = '<li>Erro ao carregar.</li>';
        }
    }

    async function loadLinkedNotes(noteIds, highlightTerm) {
        const promises = noteIds.map(id => getDoc(doc(db, 'pastas', id)));
        const docs = await Promise.all(promises);
        let found = false;
        docs.forEach(d => {
            if (d.exists() && d.data().estado === 'ativa') {
                createReferenceItem(d.id, d.data(), highlightTerm);
                found = true;
            }
        });
        if (!found) { refList.innerHTML = '<li style="padding:10px; color:#888;">Nenhuma nota ativa encontrada.</li>'; }
    }

    function createReferenceItem(id, data, term, isTag = false) {
        const details = document.createElement('details');
        details.className = 'reference-item';
        const summary = document.createElement('summary');
        const titleSpan = document.createElement('span');
        titleSpan.textContent = data.nome;
        const btn = document.createElement('button');
        btn.className = 'go-to-btn';
        btn.textContent = 'Ler';
        btn.onclick = (e) => {
            e.preventDefault(); 
            const noteObj = { id: id, ...data };
            displayNote(noteObj);
            document.querySelectorAll('.toc-header').forEach(el => {
                el.classList.remove('active-note');
                if(el.dataset.id === id) el.classList.add('active-note');
            });
        };
        summary.appendChild(titleSpan);
        summary.appendChild(btn);
        const contentDiv = document.createElement('div');
        contentDiv.className = 'reference-context';
        if (isTag) { contentDiv.innerHTML = `<p>Nota marcada com #${term}</p>`; }
        else { contentDiv.innerHTML = generateContext(data.conteudo, term); }
        details.appendChild(summary);
        details.appendChild(contentDiv);
        refList.appendChild(details);
    }

    function generateContext(htmlContent, term) {
        const temp = document.createElement('div');
        temp.innerHTML = htmlContent;
        const text = temp.textContent || temp.innerText || "";
        const index = text.toLowerCase().indexOf(term.toLowerCase());
        if (index === -1) return "Contexto n√£o encontrado.";
        const start = Math.max(0, index - 40);
        const end = Math.min(text.length, index + term.length + 40);
        let snippet = text.substring(start, end);
        const regex = new RegExp(`(${term})`, 'gi');
        snippet = snippet.replace(regex, "<mark>$1</mark>");
        return `...${snippet}...`;
    }

</script>
</body>
</html>
