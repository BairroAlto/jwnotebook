<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Notebook Moderno</title>
   
  
  <style>
    /* --- Reset B√°sico e Estilo Geral --- */
    :root {
        --bg-color: #1a1a1d;
        --sidebar-color: #252528;
        --panel-color: #1f1f22;
        --accent-color: #4a90e2;
        --text-color: #f0f0f0;
        --text-muted-color: #888;
        --border-color: #333;
        --hover-color: #2c2c30;
        --selected-color: #3a5370;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; height: 100vh; }

    /* --- Estrutura Principal --- */
    .notebook-container { display: flex; height: 100vh; }
    #left-panel, #middle-panel, #right-panel { height: 100%; display: flex; flex-direction: column; }
    
    #left-panel { flex: 0 0 240px; background-color: var(--sidebar-color); border-right: 1px solid var(--border-color); padding: 15px; justify-content: space-between; }
    #middle-panel { flex: 0 0 300px; background-color: var(--panel-color); border-right: 1px solid var(--border-color); padding: 20px; }
    #right-panel { flex: 1 1 auto; background-color: var(--bg-color); padding: 20px; }
    
    .panel-content { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
    #left-panel-list, #file-list { list-style-type: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }

    /* --- Pain√©is --- */
    .tabs-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
    .tabs-container button { background: none; border: none; color: var(--text-muted-color); padding: 10px; flex-grow: 1; text-align: center; font-size: 15px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .tabs-container button:hover { background-color: var(--hover-color); color: var(--text-color); }
    .tabs-container button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
    #left-panel hr { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0 15px 0; }
    
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .panel-header h2 { font-size: 18px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
    #back-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; margin-right: 10px; }
    #back-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

    .list-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s ease; display: flex; align-items: center; user-select: none; position: relative; }
    .list-item:before { font-size: 18px; margin-right: 10px; }
    .list-item[data-type="pasta"]:before { content: 'üìÅ'; }
    .list-item[data-type="nota"]:before { content: 'üìÑ'; }
    .list-item:hover { background-color: var(--hover-color); }
    .list-item.selected { background-color: var(--selected-color); }

    #add-item-btn { background: none; border: 2px solid var(--accent-color); color: var(--accent-color); width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    #add-item-btn:hover { background-color: var(--accent-color); color: white; }

    /* --- Painel Direito (Editor) --- */
    #editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted-color); text-align: center; height: 100%;}
    #editor-placeholder .placeholder-icon { font-size: 60px; margin-bottom: 20px; }
    #note-title-input { background: none; border: none; color: var(--text-color); font-size: 2.5em; font-weight: bold; padding: 10px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); outline: none; width: 100%; }
    
    /* --- Modais --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--sidebar-color); padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h3 { margin-bottom: 20px; font-size: 22px; }
    .modal-content p { margin-bottom: 20px; color: var(--text-muted-color); }
    .modal-content input[type="text"] { width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
    .modal-btn:hover { opacity: 0.9; }
    .modal-btn.primary { background-color: var(--accent-color); color: white; }
    .modal-btn.secondary { background-color: var(--hover-color); color: var(--text-color); }
    #add-item-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    #add-item-options button { background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 15px; text-align: left; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
    #add-item-options button:hover { background-color: var(--hover-color); }

    /* --- Componentes Adicionais (Menu de Contexto, Configura√ß√µes, etc.) --- */
    .panel-footer { padding-top: 10px; border-top: 1px solid var(--border-color); }
    #settings-btn { background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; width: 100%; text-align: left; padding: 5px 10px; border-radius: 5px; }
    #settings-btn:hover { background-color: var(--hover-color); }

    .item-menu-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 20px; padding: 0 8px; border-radius: 5px; cursor: pointer; display: none; }
    .list-item:hover .item-menu-btn { display: block; }
    .item-menu-btn:hover { background-color: var(--bg-color); color: var(--text-color); }

    .context-menu { position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; display: flex; flex-direction: column; padding: 5px; width: 160px;}
    .context-menu button { background: none; border: none; color: var(--text-color); padding: 8px 15px; text-align: left; cursor: pointer; border-radius: 4px; width: 100%;  white-space: nowrap; }
    .context-menu button:hover { background-color: var(--accent-color); color: white; }

    .move-list { list-style: none; max-height: 40vh; overflow-y: auto; }
    .move-list li { background-color: var(--bg-color); padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .move-list .order-controls button { background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 28px; height: 28px; cursor: pointer; border-radius: 5px; margin-left: 5px; }
    .move-list .order-controls button:hover { background-color: var(--hover-color); }
    .move-list .order-controls button:disabled { opacity: 0.3; cursor: not-allowed; }
    #hidden-items-list .item-name { opacity: 0.7; flex-grow: 1; }
    #hidden-items-list button { background-color: var(--accent-color); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    
    /* --- Estilos para o Editor Rico --- */
    #editor-toolbar {
        display: flex;
        align-items: center;
        background-color: var(--panel-color);
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    #editor-toolbar button {
        background: var(--hover-color);
        border: none;
        color: var(--text-color);
        min-width: 32px;
        height: 32px;
        padding: 0 8px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
    }
    #editor-toolbar button:hover {
        background-color: var(--accent-color);
    }
    #editor-toolbar input[type="color"] {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        cursor: pointer;
        padding: 2px;
    }
    .toolbar-separator {
        width: 1px;
        height: 25px;
        background-color: var(--border-color);
        margin: 0 10px;
    }
    .toolbar-history {
        margin-left: auto; /* Empurra para a direita */
    }

    #note-content-editor {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.1em;
        line-height: 1.6;
        outline: none;
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        padding: 5px;
    }

    /* Painel flutuante de sele√ß√£o */
    #selection-popup {
        background-color: var(--sidebar-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 5px;
        display: flex;
        gap: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #selection-popup button {
        background: none;
        border: none;
        color: var(--text-color);
        padding: 5px 8px;
        cursor: pointer;
        border-radius: 4px;
    }
    #selection-popup button:hover {
        background-color: var(--accent-color);
    }

    /* Estilos para conte√∫do especial no editor */
    .tag {
        background-color: var(--selected-color);
        color: var(--accent-color);
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
    }
    .entity-link {
        background-color: rgba(74, 144, 226, 0.2);
        border-bottom: 1px dashed var(--accent-color);
        cursor: pointer;
    }
    /* Cor para Personagens (um amarelo/dourado suave) */
    .entity-link[data-entity-type="personagem"] {
        background-color: rgba(230, 126, 34, 0.2); /* Fundo alaranjado transparente */
        border-bottom: 1px dashed #e67e22;          /* Borda alaranjada */
    } 

    /* Cor para Locais (um verde suave) */
    .entity-link[data-entity-type="local"] {
        background-color: rgba(46, 204, 113, 0.2); /* Fundo verde transparente */
        border-bottom: 1px dashed #2ecc71;          /* Borda verde */
    }

    /* Cor para Datas (um roxo suave) */
    .entity-link[data-entity-type="data"] {
        background-color: rgba(155, 89, 182, 0.2); /* Fundo roxo transparente */
        border-bottom: 1px dashed #9b59b2;          /* Borda roxa */
    }

    /* Cores para Etiquetas no Popup de Sugest√£o (@) */
    #entity-suggestion-popup .suggestion-list li[data-entity-type="personagem"] span {
        color: #e67e22; font-weight: 500;
    }
    #entity-suggestion-popup .suggestion-list li[data-entity-type="local"] span {
        color: #2ecc71; font-weight: 500;
    }
    #entity-suggestion-popup .suggestion-list li[data-entity-type="data"] span {
        color: #9b59b2; font-weight: 500;
    }

    /* --- Estilos Espec√≠ficos para o Modal de Links --- */
    #link-modal .url-field-wrapper {
        display: flex;
        gap: 8px;
    }
    #link-modal .remove-url-btn {
        background-color: #c0392b; color: white; padding: 0; width: 38px; height: 38px;
        min-width: unset; flex-shrink: 0; font-size: 24px; display: flex;
        align-items: center; justify-content: center;
    }
    #add-url-btn {
        color: var(--text-color); font-weight: 500;
    }
    #link-modal .modal-actions .modal-btn {
        padding: 8px 16px; font-size: 14px;
    }
    #confirm-modal { z-index: 1010; }

    /* --- Estilos para o Popup de Sugest√£o de Tags/Entidades --- */
    .suggestion-popup {
        background-color: var(--sidebar-color); border: 1px solid var(--border-color);
        border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-height: 250px; overflow-y: auto; width: 350px;
    }
    .suggestion-list { list-style: none; padding: 5px; }
    .suggestion-list li {
        padding: 8px 12px; border-radius: 4px; cursor: pointer;
        color: var(--text-color); display: flex; align-items: center;
    }
    .suggestion-list li:hover, .suggestion-list li.selected {
        background-color: var(--accent-color); color: white;
    }
    #entity-suggestion-popup .suggestion-list li span {
        margin-left: auto; padding-left: 1em;
    }
    #entity-suggestion-popup .suggestion-list li:hover span,
    #entity-suggestion-popup .suggestion-list li.selected span {
        color: white !important;
    }

    /* --- ESTILOS PARA O PAINEL COLAPSADO --- */
    #left-panel-toggle-btn {
        display: none; background: none; border: 1px solid var(--border-color); color: var(--text-color);
        width: 32px; height: 32px; border-radius: 5px; font-size: 20px; cursor: pointer; margin: 15px auto;
    }
    #left-panel-toggle-btn:hover { background-color: var(--accent-color); }
    #left-panel { transition: flex 0.3s ease-in-out; }
    .notebook-container.left-panel-collapsed #left-panel { flex: 0 0 60px; padding: 0; }
    .notebook-container.left-panel-collapsed #left-panel .panel-content,
    .notebook-container.left-panel-collapsed #left-panel .panel-footer { display: none; }
    .notebook-container.left-panel-collapsed #left-panel #left-panel-toggle-btn { display: block; }
    
    /* --- ESTILOS PARA O PAINEL DE REFER√äNCIAS (QUARTA COLUNA) --- */
    #references-panel {
        flex: 0 0 0px; background-color: var(--sidebar-color); border-left: 1px solid var(--border-color);
        padding: 20px; height: 100%; display: flex; flex-direction: column;
        transition: flex 0.3s ease-in-out; overflow: hidden;
    }
    #references-panel-close-btn {
        background: none; border: none; color: var(--text-muted-color); font-size: 24px; cursor: pointer;
    }
    #references-list { list-style-type: none; overflow-y: auto; flex-grow: 1; }
    #references-list li {
        padding: 12px; border-radius: 5px; cursor: pointer; margin-bottom: 5px;
        border-bottom: 1px solid var(--border-color);
    }
    #references-list li:hover { background-color: var(--hover-color); }
    .notebook-container.references-panel-visible #references-panel { flex: 0 0 400px; }

    /* --- ESTILOS PARA O MODAL DE √ÇNCORAS --- */
    #anchors-content-container .tab-content { display: none; max-height: 50vh; overflow-y: auto; }
    #anchors-content-container .tab-content.active { display: block; }
    #anchors-content-container ul { list-style-type: none; }
    #anchors-content-container li { padding: 10px; border-radius: 5px; cursor: pointer; position: relative; }
    #anchors-content-container li:hover { background-color: var(--hover-color); }
    #anchors-content-container li.is-on-page { background-color: #27ae60; color: white; }
    #anchors-content-container li.is-on-page:hover { background-color: #2ecc71; }
    .entity-edit-btn {
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none;
        border: none; color: var(--text-muted-color); font-size: 22px; line-height: 1;
        padding: 5px; border-radius: 5px; cursor: pointer; display: none;
    }
    #anchors-content-container li:hover .entity-edit-btn { display: block; }
    .entity-edit-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

    /* --- ESTILOS PAINEL DE REFER√äNCIAS --- */
    #references-panel-description {
        font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 20px;
        padding: 0 5px; line-height: 1.5; font-style: italic;
        border-left: 3px solid var(--accent-color); padding-left: 10px;
    }
    #references-list details.reference-item {
        padding: 12px; border-radius: 5px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color);
    }
    #references-list details.reference-item[open] { background-color: var(--hover-color); }
    #references-list summary { cursor: pointer; font-weight: 500; list-style: none; }
    #references-list summary::-webkit-details-marker { display: none; }
    #references-list summary:hover { color: var(--accent-color); }
    .reference-context {
        margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--accent-color);
        color: var(--text-muted-color); font-size: 0.9em; line-height: 1.5;
    }
    .reference-context mark {
        background-color: rgba(74, 144, 226, 0.4); color: var(--text-color);
        border-radius: 3px; padding: 1px 3px;
    }
    .toolbar-history { display: flex; align-items: center; }
    .save-status {
        font-size: 0.8em; color: var(--text-muted-color); margin-right: 15px;
        transition: all 0.3s ease; font-style: italic; font-weight: 500;
    }
    .save-status.status-saved { color: #27ae60; }
    .save-status.status-error { color: #c0392b; }
    #connectivity-status {
        display: none; color: #e74c3c; font-weight: bold; margin-right: 15px;
        font-size: 0.8em; animation: blink 1.5s linear infinite;
    }
    #connectivity-status.visible { display: inline; }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* --- Estilos Modernos para a Barra de Scroll --- */
    * { scrollbar-width: thin; scrollbar-color: var(--text-muted-color) var(--panel-color); }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--panel-color); border-radius: 10px; }
    ::-webkit-scrollbar-thumb {
        background-color: var(--text-muted-color); border-radius: 10px;
        border: 2px solid var(--panel-color);
    }
    ::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

    /* ==================================================================== */
    /* C√ìDIGO ATUALIZADO - ESTILOS PARA √ÇNCORAS COM LINKS                   */
    /* ==================================================================== */
    a[data-anexo-id] {
        color: inherit;
        text-decoration: none;
        border-bottom: 1px dotted var(--accent-color);
        cursor: pointer;
    }
    .reference-item.link-info summary {
        color: var(--accent-color);
        font-weight: bold;
    }

    /* --- ESTILOS PARA O MODAL DE VISUALIZA√á√ÉO DE LINK --- */
#view-link-urls-list li {
    padding: 12px;
    background-color: var(--bg-color);
}
#view-link-urls-list li a {
    color: var(--accent-color);
    text-decoration: none;
    display: block;
    word-break: break-all; /* Para URLs longas n√£o quebrarem o layout */
    font-weight: 500;
}
#view-link-urls-list li a:hover {
    text-decoration: underline;
}

/* --- ESTILO PARA ALARGAR OS POPUPS DE LISTAS E VISUALIZA√á√ÉO --- */
#generic-list-modal-content,
#view-link-modal .modal-content {
    max-width: 700px; /* Aumente ou diminua este valor conforme desejado */
}

/* --- ESTILOS PARA A BARRA DE FERRAMENTAS DO PAINEL DE REFER√äNCIAS --- */
.references-separator {
    border: none;
    height: 1px;
    background-color: var(--border-color);
    margin: 15px 0;
}

#references-toolbar {
    display: flex;
    justify-content: space-around; /* ou 'flex-start' com 'gap' */
    align-items: center;
    padding: 0 10px;
}

#references-toolbar button {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 5px;
    transition: all 0.2s ease;
    line-height: 1;
}

#references-toolbar button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
    border-color: var(--border-color);
}

/* --- ESTILO PARA O BOT√ÉO DE NAVEGA√á√ÉO NAS REFER√äNCIAS --- */
.reference-item summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.go-to-note-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 5px;
    margin-left: 10px;
    line-height: 1;
    transition: all 0.2s ease;
    display: none; /* Escondido por padr√£o */
}

.reference-item:hover .go-to-note-btn {
    display: block; /* Vis√≠vel ao passar o rato por cima */
}

.go-to-note-btn:hover {
    background-color: var(--hover-color);
    color: var(--accent-color);
}

</style>



</head>
<body>

    <div class="notebook-container">
        <!-- PAINEL DA ESQUERDA -->
        <aside id="left-panel">
            <button id="left-panel-toggle-btn" title="Mostrar Painel">‚ò∞</button>
            <div class="panel-content">
                <div class="tabs-container">
                    <button class="active" data-tab="note">Note</button>
                    <button data-tab="lists">Lists</button>
                    <button data-tab="book">Book</button>
                </div>
                <hr>
                <div class="panel-header">
                    <h2 id="left-panel-title">Pastas</h2>
                </div>
                <ul id="left-panel-list">
                    <!-- Itens da coluna esquerda -->
                </ul>
            </div>
            <div class="panel-footer">
                <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
            </div>
        </aside>

        <!-- PAINEL DO MEIO -->
        <main id="middle-panel">
            <div class="panel-header">
                <button id="back-btn" title="Voltar">‚Üê</button>
                <h2 id="middle-panel-title">Selecione uma pasta</h2>
                <button id="add-item-btn" title="Adicionar item">+</button>
            </div>
            <ul id="file-list">
                 <!-- Itens da coluna do meio -->
            </ul>
        </main>

        <!-- PAINEL DA DIREITA - EDITOR -->
        <section id="right-panel">
            <div id="editor-placeholder">
                <div class="placeholder-icon">üìñ</div>
                <h2>Selecione uma nota para come√ßar</h2>
                <p>Ou crie uma nova pasta e uma nota.</p>
            </div>
            <div id="editor-area" style="display: none; flex-direction: column; height: 100%;">
                <input type="text" id="note-title-input" placeholder="T√≠tulo da nota...">
                
                <div id="editor-toolbar">
                    <div class="toolbar-group">
                        <button data-command="increaseFontSize" title="Aumentar Zoom">A+</button>
                        <button data-command="decreaseFontSize" title="Diminuir Zoom">A-</button>
                        <button data-command="bold" title="Negrito"><b>B</b></button>
                        <button data-command="italic" title="It√°lico"><i>I</i></button>
                        <button data-command="underline" title="Sublinhado"><u>U</u></button>
                        <input type="color" data-command="foreColor" title="Cor do Texto">
                    </div>
                    <div class="toolbar-separator"></div>
                    <div class="toolbar-group">
                        <button data-action="show-tags" title="Tags"># Tags</button>
                        <button data-action="show-attachments" title="Anexos">üìé Anexos</button>
                        <button data-action="show-anchors" title="√Çncoras">‚öì √Çncoras</button>
                    </div>
                    <div class="toolbar-history">
                        <span id="save-status-indicator" class="save-status"></span>
                        <button data-action="show-history" title="Hist√≥rico de Vers√µes">üïí</button>
                    </div>
                </div>

                <div id="note-content-editor" contenteditable="true" spellcheck="true"></div>
            </div>
        </section>

        <!-- PAINEL DA DIREITA (QUARTA COLUNA) PARA REFER√äNCIAS -->
     <aside id="references-panel">
        <div class="panel-header">
            <h2 id="references-panel-title">Refer√™ncias</h2>
            <button id="references-panel-close-btn" title="Fechar">√ó</button>
        </div>
        
        <!-- Descri√ß√£o continua aqui -->
        <p id="references-panel-description"></p>
        
        <!-- NOVO: Barra de Ferramentas e Separador -->
        <hr class="references-separator">
        <div id="references-toolbar">
            <button id="references-refresh-btn" title="Atualizar Refer√™ncias">üîÑ</button>
            <button id="references-search-btn" title="Pesquisar na JW Library">üîç</button>
            <button id="references-edit-btn" title="Editar Entidade">‚úèÔ∏è</button>
            <button id="references-toggle-btn" title="Expandir/Recolher Tudo">‚ÜïÔ∏è</button>
        </div>
        <hr class="references-separator">
        
        <!-- Lista de refer√™ncias continua aqui -->
        <ul id="references-list">
            <!-- A lista de refer√™ncias ser√° preenchida via JS -->
        </ul>
      </aside>
    </div>

    <!-- PAINEL FLUTUANTE DE SELE√á√ÉO DE TEXTO (escondido) -->
    <div id="selection-popup" style="display: none; position: absolute; z-index: 1010;">
        <button data-action="create-link">üîó Link</button>
        <button data-action="break-link">üíî Quebrar Link</button>
        <button data-action="create-entity" data-type="local">üìç Local</button>
        <button data-action="create-entity" data-type="personagem">üë§ Personagem</button>
        <button data-action="create-entity" data-type="data">üìÖ Data</button>
        <button data-action="create-entity" data-type="textobiblico">üìñ Texto B√≠blico</button>
    </div>

    <!-- MODAL PARA ADICIONAR ITENS -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Adicionar Item</h3>
            <div id="add-item-options">
                 <button data-type="pasta">üìÅ Criar Pasta</button>
                 <button data-type="nota">üìÑ Criar Nota</button>
            </div>
            <input type="text" id="new-item-name" placeholder="Nome do item" style="display: none;">
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-item-addition" style="display: none;">Criar</button>
            </div>
        </div>
    </div>

    <!-- MENU DE CONTEXTO (3 PONTOS) - Fica escondido -->
  <div id="context-menu" class="context-menu" style="display: none;">
    <button data-action="rename">Mudar Nome</button>
    <button data-action="move-position">Mover Posi√ß√£o</button>
    <button data-action="move-folder">Mover de Pasta</button> 
    <button data-action="hide">Ocultar</button>
</div>

<!-- NOVO MODAL PARA MOVER ITEM ENTRE PASTAS -->
<div id="move-to-folder-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Mover para a Pasta</h3>
        <p>Selecione a pasta de destino para "<span id="item-to-move-name"></span>".</p>
        <ul id="folder-selection-list" class="move-list" style="max-height: 50vh;">
            <!-- A lista de pastas ser√° preenchida via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="confirm-folder-move">Mover</button>
        </div>
    </div>
</div>

    <!-- MODAL PARA MOVER ITENS -->
    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover Item</h3>
            <ul id="move-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="save-order">Salvar Ordem</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO GEN√âRICO -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title">Voc√™ tem certeza?</h3>
            <p id="confirm-message">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="confirm">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Configura√ß√µes</h3>
            <button class="modal-btn primary" data-action="show-hidden-items" style="width: 100%;">Ver Pastas Ocultas</button>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE ITENS OCULTOS -->
    <div id="hidden-items-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Itens Ocultos</h3>
            <ul id="hidden-items-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR/EDITAR LINK (ANEXO) -->
   <div id="link-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="link-modal-title">Criar Anexo</h3>
            <input type="text" id="link-title-input" placeholder="T√≠tulo do anexo">
            <div id="link-urls-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; margin-top: 15px;">
                <!-- Campos de URL ser√£o adicionados aqui dinamicamente via JS -->
            </div>
            <button id="add-url-btn" class="modal-btn" style="width: 100%; margin-bottom: 20px; background-color: var(--hover-color); text-align: center;">
                + Adicionar URL
            </button>
            <div class="modal-actions">
                <button class="modal-btn" id="link-remove-btn" style="background-color: #c0392b; color: white; display: none; margin-right: auto;">Remover Anexo</button>
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="link-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR ENTIDADE (Local, Personagem, Data) -->
    <div id="entity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="entity-modal-title">Criar Entidade</h3>
            <input type="text" id="entity-name-input" placeholder="Nome">
            <textarea id="entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 80px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
            <p id="entity-error-message" style="color: #e74c3c; display: none;">J√° existe uma entidade com este nome.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="entity-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA LISTAS (Tags, Anexos, etc.) -->
    <div id="generic-list-modal" class="modal-overlay">
    <div id="generic-list-modal-content" class="modal-content">
        <h3 id="generic-list-title">Lista</h3>
        <ul id="generic-list-content" class="move-list" style="max-height: 60vh;">
            <!-- O conte√∫do ser√° preenchido via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>
    <!-- MODAL DE √ÇNCORAS COM ABAS -->
    <div id="anchors-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Explorador de Entidades</h3>
            <div id="anchors-tabs-container" class="tabs-container" style="margin-bottom: 20px;">
                <!-- As abas ser√£o geradas via JS -->
            </div>
            <div id="anchors-content-container">
                <!-- O conte√∫do das abas ser√° gerado via JS -->
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA EDITAR ENTIDADE -->
<div id="edit-entity-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="edit-entity-title">Editar Entidade</h3>
        <input type="text" id="edit-entity-name-input" placeholder="Nome da entidade">
        <textarea id="edit-entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 120px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="edit-entity-save-btn">Gravar Altera√ß√µes</button>
        </div>
    </div>
</div>


    <!-- POPUP DE SUGEST√ÉO DE TAGS (escondido por padr√£o) -->
<div id="tag-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="tag-suggestion-list" class="suggestion-list"></ul>
</div>

<!-- POPUP DE SUGEST√ÉO DE ENTIDADES (escondido por padr√£o) -->
<div id="entity-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="entity-suggestion-list" class="suggestion-list"></ul>
</div>


<!-- MODAL DE HIST√ìRICO E BACKUP (NOVO) -->
<div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="history-modal-title">Hist√≥rico da Nota</h3>
        <p>Crie um ponto de restauro ou restaure uma vers√£o anterior. A restaura√ß√£o cria uma <strong>nova nota</strong> com o conte√∫do do backup.</p>
        
        <button id="backup-now-btn" class="modal-btn primary" style="width: 100%; margin: 20px 0;">
            Fazer backup do estado atual
        </button>

        <h4>Backups existentes:</h4>
        <ul id="history-list-content" class="move-list" style="max-height: 40vh; margin-top: 10px;">
            <!-- A lista de backups ser√° preenchida via JS -->
            <li>Nenhum backup encontrado.</li>
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER O CONTE√öDO DO BACKUP (NOVO) -->
<div id="view-backup-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 80vw; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="view-backup-title">Visualizando Backup</h3>
        <div id="view-backup-content" style="background-color: var(--bg-color); padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            <!-- Conte√∫do do backup aqui -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VISUALIZAR LINK (NOVO) -->
<div id="view-link-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="view-link-title">Visualizar Anexo</h3>
        <ul id="view-link-urls-list" class="move-list" style="margin-top: 20px; margin-bottom: 20px; max-height: 40vh;">
            <!-- URLs ser√£o preenchidas via JS -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn primary" id="view-link-edit-btn">Editar</button>
        </div>
    </div>
</div>


</body>


   <script type="module">
    
   import { db } from './js/firebase-config.js';
import { 
    collection, query, where, addDoc, serverTimestamp, onSnapshot, 
    doc, getDoc, updateDoc, orderBy, getDocs, writeBatch, deleteField, deleteDoc // <-- ADD THIS
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

document.addEventListener('DOMContentLoaded', () => {
    updateNavigationView();
    fetchAllEntities();
    fetchAllTags();
    checkInitialConnection(); // Verifica a conex√£o ao carregar
});

// --- REFER√äNCIAS AO DOM ---
const notebookContainer = document.querySelector('.notebook-container');
const leftPanelToggleBtn = document.getElementById('left-panel-toggle-btn');
const referencesPanel = document.getElementById('references-panel');
const referencesPanelTitle = document.getElementById('references-panel-title');
const referencesList = document.getElementById('references-list');
const referencesPanelCloseBtn = document.getElementById('references-panel-close-btn');
const leftPanelList = document.getElementById('left-panel-list');
const leftPanelTitle = document.getElementById('left-panel-title');
const middlePanelList = document.getElementById('file-list');
const middlePanelTitle = document.getElementById('middle-panel-title');
const backBtn = document.getElementById('back-btn');
const addItemBtn = document.getElementById('add-item-btn');
const editorPlaceholder = document.getElementById('editor-placeholder');
const editorArea = document.getElementById('editor-area');
const noteTitleInput = document.getElementById('note-title-input');
const newItemNameInput = document.getElementById('new-item-name');
const editorToolbar = document.getElementById('editor-toolbar');
const noteContentEditor = document.getElementById('note-content-editor');
const selectionPopup = document.getElementById('selection-popup');
const tagSuggestionPopup = document.getElementById('tag-suggestion-popup');
const tagSuggestionList = document.getElementById('tag-suggestion-list');
const saveStatusIndicator = document.getElementById('save-status-indicator');
const connectivityStatus = document.getElementById('connectivity-status');
const entitySuggestionPopup = document.getElementById('entity-suggestion-popup');
const entitySuggestionList = document.getElementById('entity-suggestion-list');
const debouncedScanAndLink = debounce(scanAndLinkEntities, 2000);
const ENTITY_CONFIG = {
    personagem: {
        collection: 'personagens',
        displayName: 'Personagens'
    },
    local: {
        collection: 'locais',
        displayName: 'Locais'
    },
    data: {
        collection: 'datas',
        displayName: 'Datas'
    },
    textobiblico: {
        collection: 'textosbiblicos',
        displayName: 'Textos B√≠blicos'
    }
};
const BIBLICAL_BOOKS = [
    'G√©nesis', '√äxodo', 'Lev√≠tico', 'N√∫meros', 'Deuteron√≥mio', 'Josu√©', 'Ju√≠zes', 'Rute', 
    '1 Samuel', '2 Samuel', '1 Reis', '2 Reis', '1 Cr√≥nicas', '2 Cr√≥nicas', 'Esdras', 'Neemias', 'Ester', 
    'J√≥', 'Salmos', 'Prov√©rbios', 'Eclesiastes', 'C√¢ntico de Salom√£o', 'Isa√≠as', 'Jeremias', 'Lamenta√ß√µes', 
    'Ezequiel', 'Daniel', 'Oseias', 'Joel', 'Am√≥s', 'Obadias', 'Jonas', 'Miqueias', 'Naum', 'Habacuque', 
    'Sofonias', 'Ageu', 'Zacarias', 'Malaquias', 'Mateus', 'Marcos', 'Lucas', 'Jo√£o', 'Atos', 'Romanos', 
    '1 Cor√≠ntios', '2 Cor√≠ntios', 'G√°latas', 'Ef√©sios', 'Filipenses', 'Colossenses', 
    '1 Tessalonicenses', '2 Tessalonicenses', '1 Tim√≥teo', '2 Tim√≥teo', 'Tito', 'Fil√©mom', 'Hebreus', 
    'Tiago', '1 Pedro', '2 Pedro', '1 Jo√£o', '2 Jo√£o', '3 Jo√£o', 'Judas', 'Apocalipse'
];

// --- ESTADO DA APLICA√á√ÉO ---
let allEntities = {};
let navigationStack = [];
let selectedNoteId = null;
let unsubscribeLeftPanel = null;
let unsubscribeMiddlePanel = null;
let saveTimeout = null;
let activeItemContext = null;
let currentSelectionRange = null;
let allTags = [];
let isTagPopupOpen = false;
let currentTagQueryRange = null;
let currentSaveStatus = 'hidden';
let isEntityPopupOpen = false;
let currentEntityQueryRange = null;
let activeReferenceEntity = { id: null, type: null, name: null };

// --- GEST√ÉO DE ESTADO E CONECTIVIDADE ---

/**
 * Atualiza o indicador visual de estado de grava√ß√£o.
 * @param {'unsaved' | 'saving' | 'saved' | 'error' | 'hidden'} status O estado a ser exibido.
 */
function updateSaveStatus(status) {
    currentSaveStatus = status;
    if (!saveStatusIndicator) return;

    saveStatusIndicator.classList.remove('status-saved', 'status-error');
    switch (status) {
        case 'unsaved':
            saveStatusIndicator.textContent = 'Altera√ß√µes por guardar...';
            break;
        case 'saving':
            saveStatusIndicator.textContent = 'A guardar...';
            break;
        case 'saved':
            saveStatusIndicator.textContent = 'Guardado';
            saveStatusIndicator.classList.add('status-saved');
            break;
        case 'error':
            saveStatusIndicator.textContent = 'Erro ao guardar';
            saveStatusIndicator.classList.add('status-error');
            break;
        case 'hidden':
        default:
            saveStatusIndicator.textContent = '';
            break;
    }
}

function handleOffline() {
    connectivityStatus.textContent = 'Sem liga√ß√£o';
    connectivityStatus.classList.add('visible');
    updateSaveStatus('error'); 
    saveStatusIndicator.textContent = 'Offline - Altera√ß√µes n√£o guardadas';
}

function handleOnline() {
    connectivityStatus.classList.remove('visible');
    updateSaveStatus('saving');
    clearTimeout(saveTimeout);
    saveNote();
}

function checkInitialConnection() {
    if (!navigator.onLine) {
        handleOffline();
    }
}

/**
 * Verifica se existem altera√ß√µes n√£o guardadas antes de executar uma a√ß√£o de navega√ß√£o.
 * @param {function} navigationAction A fun√ß√£o a ser executada se a navega√ß√£o for confirmada.
 */
async function navigateWithUnsavedCheck(navigationAction) {
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        const confirmed = await showConfirmation(
            'Altera√ß√µes n√£o guardadas',
            'Voc√™ tem altera√ß√µes que ainda n√£o foram guardadas. Tem a certeza que quer sair?'
        );

        if (confirmed) {
            navigationAction();
        }
    } else {
        navigationAction();
    }
}

// --- L√ìGICA PRINCIPAL DA APLICA√á√ÉO ---

  async function validateAndCleanupBiblicalLinks() {
    console.log('%cFASE 0: Iniciando limpeza de links b√≠blicos...', 'color: #e67e22; font-weight: bold;');
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    // ESTA √â A REGEX DE VALIDA√á√ÉO ESTRITA: s√≥ aceita "Livro C:V" e extens√µes v√°lidas (,-;)
    const validPattern = new RegExp(`^(${biblicalBooksPattern})\\s+\\d+:\\d+[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    let domChanged = false;

    for (const link of links) {
        const currentText = link.textContent.trim();
        
        // Se o texto dentro do link J√Å N√ÉO √â V√ÅLIDO...
        if (!validPattern.test(currentText)) {
            console.log(`%cLink inv√°lido encontrado: "${currentText}". Revertendo para texto.`, 'color: #c0392b;');
            
            // Preserva a posi√ß√£o do cursor se ele estiver dentro do link a ser removido
            const selection = window.getSelection();
            let markerNode = null; 
            if (selection && selection.rangeCount > 0 && link.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0).cloneRange();
                markerNode = document.createElement('span');
                markerNode.id = 'cursor-marker';
                range.insertNode(markerNode);
            }

            const textNode = document.createTextNode(link.textContent);
            link.parentNode.replaceChild(textNode, link);
            domChanged = true;

            // Restaura o cursor na posi√ß√£o correta
            if (markerNode && document.body.contains(markerNode)) {
                const newRange = document.createRange();
                newRange.setStartBefore(markerNode);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                markerNode.parentNode.removeChild(markerNode);
            }
        }
    }

    if (domChanged) {
        console.log('FASE 0: DOM alterado durante a limpeza.');
    }
    
    return domChanged;
}

/**
 * Remove a refer√™ncia de uma nota a uma entidade de texto b√≠blico.
 * Se for a √∫ltima refer√™ncia, apaga a pr√≥pria entidade.
 * @param {string} entityName O nome da entidade de texto b√≠blico (ex: "Daniel 4:3")
 */
async function cleanupBiblicalEntityReference(entityName) {
    if (!selectedNoteId || !entityName) return;

    const collectionRef = collection(db, 'textosbiblicos');
    const q = query(collectionRef, where("nome", "==", entityName));
    
    try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            console.log(`Nenhuma entidade encontrada para "${entityName}". Nenhuma a√ß√£o necess√°ria.`);
            return;
        }

        const entityDoc = snapshot.docs[0];
        const entityRef = entityDoc.ref;
        const entityData = entityDoc.data();
        const references = entityData.referencias || {};
        
        // Verifica se a nota atual est√° nas refer√™ncias
        if (references[selectedNoteId]) {
            const numReferences = Object.keys(references).length;

            if (numReferences === 1) {
                // √â a √∫ltima refer√™ncia, apagar o documento inteiro
                console.log(`√öltima refer√™ncia para "${entityName}". A apagar o documento...`);
                await deleteDoc(entityRef);
            } else {
                // Existem outras refer√™ncias, remover apenas a atual
                console.log(`A remover refer√™ncia da nota atual para "${entityName}"...`);
                await updateDoc(entityRef, {
                    [`referencias.${selectedNoteId}`]: deleteField()
                });
            }
            
            // Atualiza o cache de entidades local
            await fetchAllEntities();
        }

    } catch (error) {
        console.error(`Erro ao limpar a refer√™ncia para "${entityName}":`, error);
    }
}

async function fetchAllEntities() {
    allEntities = {}; 
    for (const type in ENTITY_CONFIG) {
        const config = ENTITY_CONFIG[type];
        const collectionName = config.collection;
        try {
            const q = query(collection(db, collectionName));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                allEntities[type] = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    nome: doc.data().nome,
                    tipo: type 
                }));
            }
        } catch (error) {
            console.error(`Erro ao carregar a cole√ß√£o ${collectionName}:`, error);
        }
    }
}

function resetEditor() {
    selectedNoteId = null;
    editorArea.style.display = 'none';
    editorPlaceholder.style.display = 'flex';
    document.querySelectorAll('#middle-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    updateSaveStatus('hidden');
}

function fetchAndDisplayItems(parentId, listElement, selectedId = null) {
    const itemsRef = collection(db, 'pastas');
    const q = query(itemsRef, where('parentId', '==', parentId), where('estado', '==', 'ativa'), orderBy('ordem'));

    return onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            li.dataset.id = item.id;
            li.dataset.type = item.tipo;
            li.dataset.name = item.nome;
            li.dataset.parentid = item.parentId || 'null';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = item.nome;
            const menuBtn = document.createElement('button');
            menuBtn.className = 'item-menu-btn';
            menuBtn.innerHTML = '‚Ä¶';
            
            li.appendChild(nameSpan);
            li.appendChild(menuBtn);

            if (item.id === selectedId) li.classList.add('selected');
            listElement.appendChild(li);
        });
    });
}

function updateNavigationView() {
    notebookContainer.classList.remove('left-panel-collapsed');

    if (unsubscribeLeftPanel) unsubscribeLeftPanel();
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();
    resetEditor();

    const depth = navigationStack.length;
    let leftPanelParentId = null, middlePanelParentId = null, leftPanelSelectedId = null;

    if (depth === 0) {
        leftPanelTitle.textContent = 'Pastas';
        middlePanelTitle.textContent = 'Selecione uma pasta';
        backBtn.style.display = 'none';
        leftPanelParentId = null;
        middlePanelList.innerHTML = '';
    } else {
        const currentFolder = navigationStack[depth - 1];
        middlePanelParentId = currentFolder.id;
        middlePanelTitle.textContent = currentFolder.name;
        backBtn.style.display = 'flex';
        if (depth > 1) {
            const parentFolder = navigationStack[depth - 2];
            leftPanelParentId = parentFolder.id;
            leftPanelTitle.textContent = parentFolder.name;
            leftPanelSelectedId = currentFolder.id;
        } else {
            leftPanelParentId = null;
            leftPanelTitle.textContent = 'Pastas';
            leftPanelSelectedId = currentFolder.id;
        }
    }
    
    unsubscribeLeftPanel = fetchAndDisplayItems(leftPanelParentId, leftPanelList, leftPanelSelectedId);
    if (middlePanelParentId) {
        unsubscribeMiddlePanel = fetchAndDisplayItems(middlePanelParentId, middlePanelList, null);
    }
}

function updateMiddlePanelForFolderSelection(folderId, folderName, selectedElement) {
    // 1. Atualiza o estado da sele√ß√£o visual no painel esquerdo
    document.querySelectorAll('#left-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    selectedElement.classList.add('selected');

    // 2. Atualiza o stack de navega√ß√£o para refletir a nova pasta
    if (navigationStack.length > 0) {
        // Se j√° est√°vamos numa pasta, substitu√≠mos o √∫ltimo item
        navigationStack[navigationStack.length - 1] = { id: folderId, name: folderName };
    } else {
        // Se est√°vamos na raiz, adicionamos a pasta ao stack
        navigationStack.push({ id: folderId, name: folderName });
    }
    
    // 3. Atualiza o t√≠tulo do painel do meio e o bot√£o "Voltar"
    middlePanelTitle.textContent = folderName;
    backBtn.style.display = 'flex';

    // 4. Limpa o listener antigo do painel do meio para evitar fugas de mem√≥ria
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();

    // 5. Busca e exibe os novos itens no painel do meio, sem tocar no editor
    unsubscribeMiddlePanel = fetchAndDisplayItems(folderId, middlePanelList, null);
}


async function displayNote(noteId, noteElement) {
    document.querySelectorAll('#middle-panel .list-item.selected').forEach(el => el.classList.remove('selected'));
    if (noteElement) noteElement.classList.add('selected');
    selectedNoteId = noteId;
    editorPlaceholder.style.display = 'none';
    editorArea.style.display = 'flex';
    
    const noteSnap = await getDoc(doc(db, 'pastas', noteId));
    if (noteSnap.exists()) {
        const { nome, conteudo } = noteSnap.data();
        noteTitleInput.value = nome || '';
        noteContentEditor.innerHTML = conteudo || '';

        setTimeout(() => {
            scanAndLinkEntities();
        }, 0);
    }
    
    notebookContainer.classList.add('left-panel-collapsed');
    updateSaveStatus('saved');
}

function saveNote() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        if (!selectedNoteId) return;

        updateSaveStatus('saving');

        try {
            const noteRef = doc(db, 'pastas', selectedNoteId);
            const noteSnap = await getDoc(noteRef);
            if (noteSnap.exists()) {
                const noteData = noteSnap.data();
                if (noteData.anexos) {
                    const anexosNoDb = noteData.anexos;
                    const idsNoDb = Object.keys(anexosNoDb);
                    const linksNoEditor = noteContentEditor.querySelectorAll('a[data-anexo-id]');
                    const idsNoEditor = new Set();
                    linksNoEditor.forEach(link => idsNoEditor.add(link.dataset.anexoId));
                    const idsParaRemover = idsNoDb.filter(id => !idsNoEditor.has(id));
                    if (idsParaRemover.length > 0) {
                        const updates = {};
                        idsParaRemover.forEach(id => {
                            updates[`anexosocultos.${id}`] = anexosNoDb[id];
                            updates[`anexos.${id}`] = deleteField();
                        });
                        await updateDoc(noteRef, updates);
                    }
                }
                const previousTagNames = new Set(noteData.tags || []);
                const tagSpansInEditor = noteContentEditor.querySelectorAll('span.tag');
                const currentTagNames = new Set();
                tagSpansInEditor.forEach(span => {
                    currentTagNames.add(span.textContent.substring(1));
                });
                const tagsToAdd = [...currentTagNames].filter(name => !previousTagNames.has(name));
                const tagsToRemove = [...previousTagNames].filter(name => !currentTagNames.has(name));
                for (const tagName of tagsToAdd) {
                    await updateTagLink(tagName, selectedNoteId, true);
                }
                for (const tagName of tagsToRemove) {
                    await updateTagLink(tagName, selectedNoteId, false);
                }
            }
            
            const finalTagNames = Array.from(noteContentEditor.querySelectorAll('span.tag')).map(span => span.textContent.substring(1));
            await updateDoc(doc(db, 'pastas', selectedNoteId), { 
                nome: noteTitleInput.value, 
                conteudo: noteContentEditor.innerHTML,
                tags: finalTagNames,
                ultimaedicao: serverTimestamp()
            });

            const listItem = document.querySelector(`.list-item[data-id="${selectedNoteId}"] span`);
            if (listItem) listItem.textContent = noteTitleInput.value;
            
            updateSaveStatus('saved');

        } catch (error) {
            console.error("Erro ao guardar a nota:", error);
            updateSaveStatus('error');
        }
    }, 2000);
}













function revertPrematureLinks(selection) {
    let domChanged = false;
    const potentialLinks = noteContentEditor.querySelectorAll('.entity-link');

    for (const span of potentialLinks) {
        const entityName = span.dataset.entityName;
        const isPotentialBook = BIBLICAL_BOOKS.some(b => entityName.toLowerCase().startsWith(b.toLowerCase()));
        
        if (!isPotentialBook) continue;

        let nextSignificantNode = null;
        let nodesToMerge = []; 
        let currentNode = span.nextSibling;

        while (currentNode) {
            if (currentNode.nodeType === Node.TEXT_NODE && currentNode.textContent.trim() === '') {
                nodesToMerge.push(currentNode);
                currentNode = currentNode.nextSibling;
            } else {
                nextSignificantNode = currentNode;
                break;
            }
        }

        if (nextSignificantNode && nextSignificantNode.nodeType === Node.TEXT_NODE) {
            const nextText = nextSignificantNode.textContent;
            const biblicalPatternRegex = /^\s*\u200B?:?\s*[,;]?\s*\d/;

            if (biblicalPatternRegex.test(nextText)) {
                let combinedText = span.textContent;
                nodesToMerge.forEach(node => combinedText += node.textContent);
                combinedText += nextSignificantNode.textContent;
                
                const newTextNode = document.createTextNode(combinedText);
                const parent = span.parentNode;
                
                parent.replaceChild(newTextNode, span);
                nodesToMerge.forEach(node => parent.removeChild(node));
                parent.removeChild(nextSignificantNode);
                
                const newRange = document.createRange();
                newRange.setStart(newTextNode, newTextNode.textContent.length);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                
                domChanged = true;
                break; 
            }
        }
    }
    return domChanged;
}

function logCursorState(label) {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) {
        return;
    }
    const range = selection.getRangeAt(0);
}


function validateAndCleanBiblicalLinks() {
    console.log('%cFASE 0: Iniciando limpeza de links b√≠blicos...', 'color: #e67e22; font-weight: bold;');
    
    const biblicalBooksPattern = `${BIBLICAL_BOOKS.join('|')}`;

    // =======================================================
    // AQUI ESTAVA O ERRO PERSISTENTE - ESTA √â A REGEX CORRETA E RIGOROSA
    // =======================================================
    const validPattern = new RegExp(`^${biblicalBooksPattern}\\s+\\d+:\\d[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    
    console.log(`FASE 0: Encontrados ${links.length} links b√≠blicos para validar.`);

    let domChanged = false;

    links.forEach((link, index) => {
        const originalText = link.textContent;
        const trimmedText = originalText.trim();
        
        console.log(`FASE 0: Verificando Link #${index + 1}: "${originalText}" (limpo: "${trimmedText}")`);

        if (!validPattern.test(trimmedText)) {
            console.log(`%cFASE 0: INV√ÅLIDO! O texto "${trimmedText}" n√£o corresponde ao padr√£o. Revertendo para texto simples.`, 'color: #c0392b; font-weight: bold;');
            
            const textNode = document.createTextNode(originalText);
            link.parentNode.replaceChild(textNode, link);

            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(textNode, textNode.length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            domChanged = true;
        } else {
            console.log(`%cFASE 0: V√ÅLIDO. O link "${trimmedText}" ser√° mantido.`, 'color: #27ae60;');
        }
    });

    if (domChanged) {
        console.log('FASE 0: A limpeza alterou o DOM.');
    } else {
        console.log('FASE 0: Nenhum link inv√°lido encontrado. Nenhuma altera√ß√£o feita.');
    }
    
    return domChanged;
}



/**
 * Percorre o editor para remover caracteres invis√≠veis (como o Zero-Width Space)
 * que podem ter sido deixados por outras opera√ß√µes, garantindo que a l√≥gica de 
 * reconhecimento de entidades funcione em texto limpo.
 * A posi√ß√£o do cursor √© cuidadosamente preservada.
 */
function cleanupInvisibleCharacters() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) return;

    // Salva a posi√ß√£o original do cursor
    const originalRange = selection.getRangeAt(0);
    let originalContainer = originalRange.startContainer;
    let originalOffset = originalRange.startOffset;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        nodesToProcess.push(node);
    }
    
    const ZWSP = /\u200B/g; // Regex para o caractere invis√≠vel (Zero-Width Space)

    for (const textNode of nodesToProcess) {
        if (ZWSP.test(textNode.textContent)) {
            // Se o cursor estiver neste n√≥, ajustamos a sua posi√ß√£o futura
            if (textNode === originalContainer) {
                // Conta quantos caracteres invis√≠veis existem ANTES da posi√ß√£o do cursor
                const charsToRemoveBeforeCursor = (textNode.textContent.substring(0, originalOffset).match(ZWSP) || []).length;
                originalOffset -= charsToRemoveBeforeCursor;
            }
            // Remove todos os caracteres invis√≠veis do n√≥ de texto
            textNode.textContent = textNode.textContent.replace(ZWSP, '');
        }
    }

    // Normaliza o editor para juntar n√≥s de texto que possam ter sido separados
    noteContentEditor.normalize();

    // Restaura a posi√ß√£o do cursor, garantindo que o n√≥ ainda existe
    try {
        const newRange = document.createRange();
        // Verifica se o container original ainda faz parte do documento
        if (document.body.contains(originalContainer)) {
             // Garante que a posi√ß√£o n√£o exceda o novo comprimento do texto
            const newOffset = Math.min(originalOffset, originalContainer.textContent.length);
            newRange.setStart(originalContainer, newOffset);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
        }
    } catch (e) {
        console.error("Erro ao restaurar a posi√ß√£o do cursor ap√≥s a limpeza:", e);
    }
}




 // ===================================================================
// FUN√á√ÉO SCANANDLINKENTITIES - VERS√ÉO COM REGEX CORRIGIDA
// ===================================================================
  async function scanAndLinkEntities() {
    const logStyles = {
        header: 'color: white; background-color: #1abc9c; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;',
        automation: 'color: white; background-color: #8e44ad; font-weight: bold; padding: 2px 5px; border-radius: 3px;'
    };

    console.groupCollapsed('%c[Verifica√ß√£o] Iniciando verifica√ß√£o de entidades...', logStyles.header);

    noteContentEditor.normalize();
    const hasCleanedLinks = await validateAndCleanupBiblicalLinks();
    if (hasCleanedLinks) {
        console.log('%c  - Links inv√°lidos foram removidos. A acionar grava√ß√£o e a terminar verifica√ß√£o.', logStyles.info);
        updateSaveStatus('unsaved');
        saveNote(); 
        console.groupEnd();
        return; 
    } else {
        console.log('%c  - Nenhum link b√≠blico inv√°lido para limpar.', logStyles.info);
    }

    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
        console.log('%c  - Verifica√ß√£o ignorada (texto selecionado ou nenhum cursor).', logStyles.info);
        console.groupEnd();
        return;
    }
    const originalRange = selection.getRangeAt(0).cloneRange();

    console.group('%cFASE 1: Liga√ß√£o de Formato Padr√£o (Livro C:V)', logStyles.phase);
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const standardBiblicalRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'giu');
    
    console.log('%c  - Regex utilizada:', logStyles.info, standardBiblicalRegex);

    let domModified = false;
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) {
            nodesToProcess.push(node);
        }
    }

    for (const textNode of nodesToProcess) {
        standardBiblicalRegex.lastIndex = 0;
        let match;
        if ((match = standardBiblicalRegex.exec(textNode.textContent)) !== null) {
            domModified = true;
            
            const matchedName = match[1].trim(); 
            const cleanedName = matchedName.replace(/[.,;]+$/, '');
            console.log(`%c  - Texto identificado: "${matchedName}". Texto a gravar: "${cleanedName}"`, logStyles.action);

            const matchStartIndex = match.index;
            
            textNode.splitText(matchStartIndex + matchedName.length);
            let matchNode = textNode.splitText(matchStartIndex);
            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = 'textobiblico';
            span.dataset.entityName = cleanedName;
            span.textContent = cleanedName;
            matchNode.parentNode.replaceChild(span, matchNode);
            
            const allExistingEntities = Object.values(allEntities).flat();
            let entity = allExistingEntities.find(e => e.tipo === 'textobiblico' && e.nome.toLowerCase() === cleanedName.toLowerCase());
            
            if (!entity) {
                // ===================================================================
                // --- IN√çCIO DA NOVA L√ìGICA DE AUTOMA√á√ÉO ---
                // ===================================================================
                console.group('%c[Automa√ß√£o] Nova Entidade B√≠blica Detetada', logStyles.automation);
                
                const collectionName = ENTITY_CONFIG['textobiblico'].collection;

                try {
                    // Passo 1: Adiciona o documento INICIALMENTE com a descri√ß√£o vazia.
                    console.log(`%c  - Passo 1: A criar ficha para "${cleanedName}" no Firebase com descri√ß√£o vazia.`, logStyles.info);
                    const newEntityDocRef = await addDoc(collection(db, collectionName), { 
                        nome: cleanedName, 
                        descricao: "", // Come√ßa vazio para ser preenchido depois
                        createdAt: serverTimestamp(), 
                        referencias: { [selectedNoteId]: true } 
                    });

                    // Passo 2: Chamar o nosso novo servidor Python (O Pesquisador Especialista)
                    console.log('%c  - Passo 2: A pedir ao Pesquisador Especialista para encontrar o texto...', logStyles.action);
                    const response = await fetch(`https://jwnotebook.onrender.com/get-verse?ref=${encodeURIComponent(cleanedName)}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const verseText = data.text;
                        
                        // Passo 3: Atualiza o documento que acab√°mos de criar com a descri√ß√£o.
                        console.log(`%c  - Passo 3: Pesquisador respondeu com sucesso! A atualizar a ficha no Firebase.`, logStyles.success);
                        await updateDoc(newEntityDocRef, {
                            descricao: verseText
                        });

                    } else {
                        const errorData = await response.json();
                        console.warn(`%c  - AVISO: O Pesquisador n√£o encontrou o texto. A descri√ß√£o ficar√° vazia. (Erro: ${errorData.error})`, logStyles.phase);
                    }
                } catch (error) {
                    console.error(`%c  - ERRO: Falha na comunica√ß√£o com o Pesquisador Especialista. Verifique se o servidor Python (pesquisador_api.py) est√° a correr.`, 'color: red; font-weight: bold;', error);
                } finally {
                    await fetchAllEntities(); // Atualiza sempre o cache local, mesmo se a pesquisa falhar
                    console.groupEnd(); // Fecha o grupo de logs da automa√ß√£o
                }
                // ===================================================================
                // --- FIM DA NOVA L√ìGICA DE AUTOMA√á√ÉO ---
                // ===================================================================
            }
            break; 
        }
    }
    console.groupEnd(); // Fecha o grupo de logs da verifica√ß√£o
    
    if (domModified) {
        selection.removeAllRanges();
        selection.addRange(originalRange);
        updateSaveStatus('unsaved');
        saveNote();
    }
}





function maintainEntityProtection() {
    const entityLinks = noteContentEditor.querySelectorAll('.entity-link');
    let domModified = false;

    entityLinks.forEach(link => {
        const parent = link.parentNode;
        let needsProtectionBefore = true;
        let needsProtectionAfter = true;

        // Verifica o que existe ANTES do link
        if (link.previousSibling && link.previousSibling.nodeType === Node.TEXT_NODE && link.previousSibling.textContent.endsWith('\u200B')) {
            needsProtectionBefore = false;
        }

        // Verifica o que existe DEPOIS do link
        if (link.nextSibling && link.nextSibling.nodeType === Node.TEXT_NODE && link.nextSibling.textContent.startsWith('\u200B')) {
            needsProtectionAfter = false;
        }

        // Se faltar prote√ß√£o antes, adiciona-a
        if (needsProtectionBefore) {
            console.log(`%cMANUTEN√á√ÉO: A proteger a entidade "${link.textContent}" (antes).`, 'color: #f39c12;');
            const zeroWidthSpace = document.createTextNode('\u200B');
            parent.insertBefore(zeroWidthSpace, link);
            domModified = true;
        }

        // Se faltar prote√ß√£o depois, adiciona-a
        if (needsProtectionAfter) {
            console.log(`%cMANUTEN√á√ÉO: A proteger a entidade "${link.textContent}" (depois).`, 'color: #f39c12;');
            const zeroWidthSpace = document.createTextNode('\u200B');
            // insertBefore √© usado para inserir depois, passando o "irm√£o" seguinte como refer√™ncia
            parent.insertBefore(zeroWidthSpace, link.nextSibling);
            domModified = true;
        }
    });

    if (domModified) {
        // A normaliza√ß√£o junta n√≥s de texto adjacentes, limpando o c√≥digo
        noteContentEditor.normalize();
    }
}


function escapeRegExp(string) {
  // $& significa a string inteira que foi encontrada
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
}

    async function validateAndReconcileAllEntities() {
    // Estilos para os logs na consola
    const logStyles = {
        header: 'color: white; background-color: #00a8ff; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;'
    };

    console.groupCollapsed('%c[Reconcilia√ß√£o] Iniciando verifica√ß√£o completa de entidades...', logStyles.header);

    // ETAPA 1: Preservar a posi√ß√£o do cursor
    console.log('%cFASE 1: Preservando a posi√ß√£o do cursor', logStyles.phase);
    const selection = window.getSelection();
    let cursorMarker = null;
    let originalRange = null;
    if (selection && selection.rangeCount > 0) {
        originalRange = selection.getRangeAt(0).cloneRange();
        if (selection.isCollapsed) {
            cursorMarker = document.createElement('span');
            cursorMarker.id = 'cursor-marker'; // A nossa "bandeira"
            try {
                originalRange.insertNode(cursorMarker);
                console.log('%c  - Inserido marcador de cursor no DOM.', logStyles.success);
            } catch (e) {
                console.warn('  - N√£o foi poss√≠vel inserir o marcador de cursor. A sele√ß√£o pode estar num local inv√°lido.', e);
                cursorMarker = null; // Garante que n√£o tentaremos encontr√°-lo mais tarde
            }
        } else {
            console.log('%c  - O utilizador tem texto selecionado. O range original ser√° restaurado.', logStyles.info);
        }
    } else {
        console.log('%c  - Nenhuma sele√ß√£o encontrada. Imposs√≠vel preservar o cursor.', logStyles.info);
    }
    
    // ETAPA 2: Varrer e corrigir
    console.log('%cFASE 2: Procurando por entidades n√£o formatadas', logStyles.phase);
    const allKnownEntities = Object.values(allEntities).flat();
    if (!allKnownEntities || allKnownEntities.length === 0) {
        console.log('%c  - Nenhuma entidade conhecida na base de dados. A abortar reconcilia√ß√£o.', logStyles.info);
        // Ainda assim, remove o marcador se ele foi inserido
        if (cursorMarker) cursorMarker.parentNode.removeChild(cursorMarker);
        console.groupEnd();
        return;
    }
    console.log(`%c  - A comparar o texto com ${allKnownEntities.length} entidades conhecidas.`, logStyles.info);


    let keepLooping = true;
    let pass = 0;
    while (keepLooping) {
        pass++;
        console.log(`%c  - INICIANDO PASSAGEM DE VERIFICA√á√ÉO N¬∫ ${pass}`, logStyles.action);
        keepLooping = false; // Assume que esta ser√° a √∫ltima passagem, a menos que uma altera√ß√£o seja feita
        
        const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
        const nodesToProcess = [];
        let n;
        while (n = walker.nextNode()) {
            nodesToProcess.push(n);
        }
        console.log(`%c    - Encontrados ${nodesToProcess.length} n√≥s de texto para analisar.`, logStyles.info);


        for (const node of nodesToProcess) {
            // Ignora n√≥s que j√° est√£o dentro de elementos especiais para evitar trabalho desnecess√°rio
            if (!node.parentElement || node.parentElement.closest('.entity-link, .tag, a, #cursor-marker')) {
                continue;
            }

            for (const entity of allKnownEntities) {
                // A l√≥gica de textos b√≠blicos √© tratada noutra fun√ß√£o, por isso ignoramo-la aqui.
                if (entity.tipo === 'textobiblico') continue;
                
                const entityName = entity.nome;
                // Usa uma RegEx com `\b` (word boundary) para encontrar a palavra exata
                const regex = new RegExp(`\\b(${escapeRegExp(entityName)})\\b`);
                
                if (regex.test(node.textContent)) {
                    console.log(`%c    - SUCESSO! Encontrado texto simples "${entityName}" no n√≥: "${node.textContent}"`, logStyles.success);
                    console.log('%c    - A recriar o link...', logStyles.action);

                    // Divide o n√≥ de texto em tr√™s partes: antes, durante e depois da correspond√™ncia
                    const matchIndex = node.textContent.search(regex);
                    node.splitText(matchIndex + entityName.length); // Divide depois
                    const matchNode = node.splitText(matchIndex); // Divide antes
                    
                    // Cria o novo elemento <span> para a entidade
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = entity.tipo;
                    span.dataset.entityName = entity.nome;
                    span.textContent = entity.nome;
                    
                    // Substitui o n√≥ de texto (que agora cont√©m apenas o nome da entidade) pelo <span> formatado
                    matchNode.parentNode.replaceChild(span, matchNode);
                    
                    console.log('%c    - Link recriado. A reiniciar a passagem de verifica√ß√£o para garantir consist√™ncia.', logStyles.info);
                    keepLooping = true; // For√ßa uma nova passagem porque o DOM foi alterado
                    break; // Sai do loop de entidades
                }
            }
            if (keepLooping) break; // Sai do loop de n√≥s para reiniciar a passagem
        }
        if (!keepLooping) {
             console.log(`%c  - FIM DA PASSAGEM N¬∫ ${pass}. Nenhuma altera√ß√£o foi feita.`, logStyles.info);
        }
    }
    
    // ETAPA 3: Restaurar a posi√ß√£o do cursor
    console.log('%cFASE 3: Restaurando a posi√ß√£o do cursor', logStyles.phase);
    const markerInDom = document.getElementById('cursor-marker');
    if (markerInDom) {
        const newRange = document.createRange();
        // Colocamos o cursor ANTES da √¢ncora para que ele fique na posi√ß√£o correta
        newRange.setStartBefore(markerInDom);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);
        // Removemos a √¢ncora depois de a usarmos
        markerInDom.parentNode.removeChild(markerInDom);
        console.log('%c  - Marcador encontrado. Posi√ß√£o do cursor restaurada.', logStyles.success);
    } else if (originalRange) {
        // Fallback: se n√£o t√≠nhamos uma √¢ncora (ex: sele√ß√£o de texto), restauramos o range original
        selection.removeAllRanges();
        selection.addRange(originalRange);
        console.log('%c  - Marcador n√£o encontrado, mas range original foi restaurado.', logStyles.info);
    } else {
        console.log('%c  - N√£o foi poss√≠vel restaurar o cursor.', logStyles.info);
    }
    
    console.groupEnd();
}



// --- FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS ---

function showContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    const menu = document.getElementById('context-menu');
    menu.style.display = 'block';
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
    const item = e.target.closest('.list-item');
    activeItemContext = {
        id: item.dataset.id,
        name: item.dataset.name,
        type: item.dataset.type,
        parentId: item.dataset.parentid === 'null' ? null : item.dataset.parentid
    };
}

function hideContextMenu() {
    document.getElementById('context-menu').style.display = 'none';
    activeItemContext = null;
}

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

function showConfirmation(title, message) {
    const modal = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    modal.style.display = 'flex';
    return new Promise(resolve => {
        const confirmBtn = modal.querySelector('[data-action="confirm"]');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');
        const onConfirm = () => { modal.style.display = 'none'; resolve(true); cleanup(); };
        const onCancel = () => { modal.style.display = 'none'; resolve(false); cleanup(); };
        const cleanup = () => {
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
        };
        confirmBtn.addEventListener('click', onConfirm, { once: true });
        cancelBtn.addEventListener('click', onCancel, { once: true });
    });
}

async function updateTagLink(tagName, noteId, shouldExist) {
    const tag = allTags.find(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tag) {
        console.error(`Tag "${tagName}" n√£o encontrada no cache para atualiza√ß√£o.`);
        return;
    }
    const tagRef = doc(db, 'tags', tag.id);
    const updateData = {};
    if (shouldExist) {
        updateData[`notas.${noteId}`] = true;
    } else {
        updateData[`notas.${noteId}`] = deleteField();
    }
    try {
        await updateDoc(tagRef, updateData);
    } catch (error) {
        console.error(`Erro ao atualizar v√≠nculo da tag "${tagName}":`, error);
    }
}

// --- L√ìGICA DE MODAIS E PAIN√âIS ADICIONAIS ---

async function openMoveModal() {
    const modal = document.getElementById('move-item-modal');
    const list = document.getElementById('move-list');
    list.innerHTML = 'Carregando...';
    modal.style.display = 'flex';
    const q = query(collection(db, 'pastas'), where('parentId', '==', activeItemContext.parentId), where('estado', '==', 'ativa'), orderBy('ordem'));
    const snapshot = await getDocs(q);
    let items = [];
    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
    renderMoveList(items);
}

// --- NOVA FUN√á√ÉO PARA GERIR O MODAL "MOVER DE PASTA" ---
async function openMoveToFolderModal(itemContext) { // ALTERA√á√ÉO: Recebe o item como argumento
    if (!itemContext) return;

    const modal = document.getElementById('move-to-folder-modal');
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const itemNameSpan = document.getElementById('item-to-move-name');

    itemNameSpan.textContent = itemContext.name;
    list.innerHTML = '<li>A carregar pastas...</li>';
    modal.style.display = 'flex';

    const q = query(collection(db, 'pastas'), where('tipo', '==', 'pasta'), where('estado', '==', 'ativa'));
    const snapshot = await getDocs(q);

    list.innerHTML = '';

    const rootLi = document.createElement('li');
    rootLi.className = 'list-item'; // CORRE√á√ÉO: Adicionada a classe para o estilo de sele√ß√£o
    rootLi.textContent = 'üìÅ (Pasta Principal)';
    rootLi.dataset.folderId = 'null';
    if (itemContext.parentId !== null) {
        list.appendChild(rootLi);
    }
    
    snapshot.forEach(doc => {
        if (doc.id !== itemContext.id && doc.id !== itemContext.parentId) {
            const li = document.createElement('li');
            li.className = 'list-item'; // CORRE√á√ÉO: Adicionada a classe para o estilo de sele√ß√£o
            li.textContent = `üìÅ ${doc.data().nome}`;
            li.dataset.folderId = doc.id;
            list.appendChild(li);
        }
    });

    let selectedFolderId = null;
    const handleSelection = (e) => {
        const li = e.target.closest('li');
        if (!li) return;
        
        list.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
        li.classList.add('selected');
        selectedFolderId = li.dataset.folderId;
    };
    // Usamos .onclick para substituir listeners antigos facilmente
    list.onclick = handleSelection;

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        if (selectedFolderId === null) { // Verifica se √© null, n√£o !selectedFolderId, pois 'null' como string √© "truthy"
            alert('Por favor, selecione uma pasta de destino.');
            return;
        }

        const newParentId = selectedFolderId === 'null' ? null : selectedFolderId;
        
        try {
            // CORRE√á√ÉO: Usamos o itemContext.id que foi passado para a fun√ß√£o
            const itemRef = doc(db, 'pastas', itemContext.id);
            await updateDoc(itemRef, {
                parentId: newParentId,
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            updateNavigationView();
        } catch (error) {
            console.error("Erro ao mover o item:", error);
            alert("Ocorreu um erro ao mover o item.");
        }
    };
}

function renderMoveList(items) {
    const list = document.getElementById('move-list');
    list.innerHTML = '';
    items.forEach((item, index) => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.innerHTML = `
            <span>${item.nome}</span>
            <div class="order-controls">
                <button data-action="up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button data-action="down" ${index === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
            </div>
        `;
        list.appendChild(li);
    });
    list.onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const currentLi = btn.closest('li');
        const currentIndex = Array.from(list.children).indexOf(currentLi);
        const action = btn.dataset.action;
        if (action === 'up' && currentIndex > 0) {
            [items[currentIndex], items[currentIndex - 1]] = [items[currentIndex - 1], items[currentIndex]];
        } else if (action === 'down' && currentIndex < items.length - 1) {
            [items[currentIndex], items[currentIndex + 1]] = [items[currentIndex + 1], items[currentIndex]];
        }
        renderMoveList(items);
    };
    document.querySelector('#move-item-modal [data-action="save-order"]').onclick = async () => {
        const batch = writeBatch(db);
        items.forEach((item, index) => {
            const docRef = doc(db, 'pastas', item.id);
            batch.update(docRef, { 
                ordem: index,
                ultimaedicao: serverTimestamp()
            });
        });
        await batch.commit();
        document.getElementById('move-item-modal').style.display = 'none';
    };
}

async function showHiddenItemsModal() {
    const modal = document.getElementById('hidden-items-modal');
    const list = document.getElementById('hidden-items-list');
    list.innerHTML = 'Carregando...';
    modal.style.display = 'flex';
    const q = query(collection(db, 'pastas'), where('estado', '==', 'desativa'));
    const snapshot = await getDocs(q);
    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li>Nenhum item oculto.</li>';
        return;
    }
    snapshot.forEach(doc => {
        const item = { id: doc.id, ...doc.data() };
        const li = document.createElement('li');
        li.innerHTML = `<span class="item-name">${item.nome}</span> <button data-id="${item.id}">Restaurar</button>`;
        list.appendChild(li);
    });
}

function addUrlField(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'url-field-wrapper';
    const urlInput = document.createElement('input');
    urlInput.type = 'text';
    urlInput.placeholder = 'URL da hiperliga√ß√£o';
    urlInput.value = urlValue;
    urlInput.style.flexGrow = '1';
    urlInput.style.padding = '12px';
    urlInput.style.backgroundColor = 'var(--bg-color)';
    urlInput.style.border = '1px solid var(--border-color)';
    urlInput.style.borderRadius = '5px';
    urlInput.style.color = 'var(--text-color)';
    urlInput.style.fontSize = '16px';
    const removeUrlBtn = document.createElement('button');
    removeUrlBtn.textContent = '‚Äì';
    removeUrlBtn.className = 'modal-btn remove-url-btn'; 
    removeUrlBtn.onclick = () => {
        if (container.childElementCount > 1) {
            fieldWrapper.remove();
        } else {
            alert('√â necess√°rio pelo menos um campo de URL.');
        }
    };
    fieldWrapper.appendChild(urlInput);
    fieldWrapper.appendChild(removeUrlBtn);
    container.appendChild(fieldWrapper);
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
  function openLinkModal(isEditing, data) {
        const modal = document.getElementById('link-modal');
        const titleInput = document.getElementById('link-title-input');
        const urlsContainer = document.getElementById('link-urls-container');
        const addUrlBtn = document.getElementById('add-url-btn');
        const removeBtn = document.getElementById('link-remove-btn');
        const saveBtn = document.getElementById('link-save-btn');
        const modalTitle = document.getElementById('link-modal-title');
        urlsContainer.innerHTML = '';

        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        const newRemoveBtn = removeBtn.cloneNode(true);
        removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);
        const newAddUrlBtn = addUrlBtn.cloneNode(true);
        addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
        newAddUrlBtn.onclick = () => addUrlField();

        if (isEditing) {
            console.log('[openLinkModal] Abrindo em modo de EDI√á√ÉO para o anexo ID:', data.id);
            modalTitle.textContent = "Editar/Remover Anexo";
            newRemoveBtn.style.display = 'block';
            (async () => {
                const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
                if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                    const anexoFromDb = noteSnap.data().anexos[data.id];
                    titleInput.value = anexoFromDb.titulo;
                    if (anexoFromDb.urls && Object.keys(anexoFromDb.urls).length > 0) {
                        Object.values(anexoFromDb.urls).forEach(url => addUrlField(url));
                    } else { addUrlField(); }
                }
            })();
        
        newSaveBtn.onclick = async () => {
            const newTitle = titleInput.value.trim();
            if (!newTitle) return;
            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;
            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });
            if (Object.keys(urlsToSave).length === 0) { alert('Por favor, preencha pelo menos uma URL.'); return; }
            const noteRef = doc(db, 'pastas', selectedNoteId);
            await updateDoc(noteRef, {
                [`anexos.${data.id}.titulo`]: newTitle,
                [`anexos.${data.id}.urls`]: urlsToSave,
                [`anexos.${data.id}.hiperligacao`]: deleteField(),
                [`anexos.${data.id}.timestamp`]: serverTimestamp()
            });
            const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
            if (linkInEditor) linkInEditor.href = firstUrl;
            modal.style.display = 'none';
            saveNote();
        };

        newRemoveBtn.onclick = async () => {
            const confirmed = await showConfirmation('Remover Anexo?', `Tem certeza que deseja remover o anexo "${titleInput.value}"?`);
            if (!confirmed) return;
            const noteRef = doc(db, 'pastas', selectedNoteId);
            const noteSnap = await getDoc(noteRef);
            if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                const anexoToMove = noteSnap.data().anexos[data.id];
                await updateDoc(noteRef, {
                    [`anexos.${data.id}`]: deleteField(),
                    [`anexosocultos.${data.id}`]: anexoToMove
                });
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) {
                    const textNode = document.createTextNode(linkInEditor.textContent);
                    linkInEditor.parentNode.replaceChild(textNode, linkInEditor);
                }
                modal.style.display = 'none';
                saveNote();
            } else { alert("Erro: Anexo n√£o encontrado no banco de dados."); }
        };

    } else {
        modalTitle.textContent = "Criar Anexo";
        titleInput.value = data;
        newRemoveBtn.style.display = 'none';
        addUrlField();

        newSaveBtn.onclick = async () => {
            console.groupCollapsed('%c[Link Creation] Bot√£o "Gravar" clicado', 'color: white; background-color: #3498db; padding: 2px 5px; border-radius: 3px;');
            
            const titleForDb = titleInput.value.trim();
            if (!titleForDb) { console.log('  - ERRO: T√≠tulo vazio. A abortar.'); console.groupEnd(); return; }
            
            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;
            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });
            if (Object.keys(urlsToSave).length === 0) { alert('Por favor, preencha pelo menos uma URL.'); console.groupEnd(); return; }
            console.log('  - Dados a gravar na DB:', { titleForDb, urlsToSave, firstUrl });

            const anexoId = `anexo_${Date.now()}`;
            const noteRef = doc(db, 'pastas', selectedNoteId);
            await updateDoc(noteRef, { [`anexos.${anexoId}`]: { titulo: titleForDb, urls: urlsToSave, timestamp: serverTimestamp() } }, { merge: true });
            console.log(`  - Anexo ID "${anexoId}" gravado na DB.`);

            console.log('%cFASE 1: Preservar √Çncoras Existentes', 'font-weight: bold; color: #f39c12;');
            const tempDiv = document.createElement('div');
            tempDiv.appendChild(currentSelectionRange.cloneContents());
            console.log('  - Conte√∫do HTML da sele√ß√£o:', tempDiv.innerHTML);

            const anchorsInSelection = Array.from(tempDiv.querySelectorAll('.entity-link'));
            const preservedAnchors = anchorsInSelection.map(span => ({
                name: span.dataset.entityName,
                type: span.dataset.entityType
            }));
            console.log('  - √Çncoras preservadas:', preservedAnchors);

            console.log('%cFASE 2: Aplicar o Link (execCommand)', 'font-weight: bold; color: #e74c3c;');
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(currentSelectionRange);
            document.execCommand('createLink', false, firstUrl || '#');
            const createdLink = selection.anchorNode.parentElement.closest('a');
            console.log('  - Link criado pelo browser:', createdLink ? createdLink.outerHTML : 'ERRO: Link n√£o encontrado');

            console.log('%cFASE 3: Re-hidratar √Çncoras (M√âTODO CORRIGIDO)', 'font-weight: bold; color: #9b59b2;');
            if (createdLink) {
                createdLink.dataset.anexoId = anexoId;
                
                if (preservedAnchors.length > 0) {
                    // Pegamos o texto SIMPLES que o browser colocou dentro do link.
                    let reconstructedHTML = createdLink.textContent;
                    console.log('  - Texto dentro do link (p√≥s-execCommand):', reconstructedHTML);

                    // Para cada √¢ncora que guard√°mos, encontramos o seu nome no texto simples e voltamos a envolv√™-lo no span.
                    preservedAnchors.forEach(anchor => {
                        const anchorHTML = `<span class="entity-link" data-entity-type="${anchor.type}" data-entity-name="${anchor.name}">${anchor.name}</span>`;
                        // Usamos uma RegEx para garantir que substitu√≠mos a palavra exata.
                        const replaceRegex = new RegExp(escapeRegExp(anchor.name), 'g');
                        reconstructedHTML = reconstructedHTML.replace(replaceRegex, anchorHTML);
                    });

                    console.log('  - HTML Reconstru√≠do:', reconstructedHTML);
                    createdLink.innerHTML = reconstructedHTML;
                } else {
                    console.log('  - Nenhuma √¢ncora para re-hidratar.');
                }
                console.log('  - Link final no DOM:', createdLink.outerHTML);
            }
            
            modal.style.display = 'none';
            saveNote();
            console.groupEnd();
        };
    }
    
    modal.style.display = 'flex';
}
// ====================================================================


 function openEntityModal(type, name) {
    const modal = document.getElementById('entity-modal');
    const title = document.getElementById('entity-modal-title');
    const nameInput = document.getElementById('entity-name-input');
    const descriptionInput = document.getElementById('entity-description-input');
    const errorMsg = document.getElementById('entity-error-message');
    const singularDisplayName = ENTITY_CONFIG[type]?.displayName.slice(0, -1) || (type.charAt(0).toUpperCase() + type.slice(1));
    title.textContent = `Criar ou Vincular ${singularDisplayName}`;
    nameInput.value = name;
    descriptionInput.value = '';
    errorMsg.style.display = 'none';
    modal.style.display = 'flex';

    document.getElementById('entity-save-btn').onclick = async () => {
        const entityName = nameInput.value.trim();
        const entityDescription = descriptionInput.value.trim();
        if (!entityName) return;

        const collectionName = ENTITY_CONFIG[type]?.collection;
        if (!collectionName) {
            console.error("Tipo de entidade desconhecido:", type);
            return;
        }

        const collectionRef = collection(db, collectionName);
        const q = query(collectionRef, where("nome", "==", entityName));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            // Entidade n√£o existe, cria uma nova com a refer√™ncia da nota atual
            await addDoc(collectionRef, {
                nome: entityName,
                descricao: entityDescription,
                createdAt: serverTimestamp(),
                referencias: { [selectedNoteId]: true }
            });
        } else {
            // AQUI EST√Å A CORRE√á√ÉO: Entidade j√° existe, ent√£o ATUALIZAMOS as suas refer√™ncias
            const existingDoc = querySnapshot.docs[0];
            const entityRef = doc(db, collectionName, existingDoc.id);
            await updateDoc(entityRef, {
                [`referencias.${selectedNoteId}`]: true // Adiciona a refer√™ncia da nota atual
            });
        }

        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(currentSelectionRange);
        const span = document.createElement('span');
        span.className = 'entity-link';
        span.dataset.entityType = type;
        span.dataset.entityName = entityName;
        span.textContent = entityName;
        currentSelectionRange.surroundContents(span);
        
        modal.style.display = 'none';
        saveNote();
        fetchAllEntities(); // Atualiza o cache local
    };
}

  async function openGenericListModal(title, dataPromise) {
    const modal = document.getElementById('generic-list-modal');
    const titleEl = document.getElementById('generic-list-title');
    const contentEl = document.getElementById('generic-list-content');
    
    titleEl.textContent = title;
    contentEl.innerHTML = '<li>Carregando...</li>';
    modal.style.display = 'flex';

    try {
        const items = await dataPromise;
        contentEl.innerHTML = ''; 
        if (!items || items.length === 0) {
            contentEl.innerHTML = '<li>Nenhum item encontrado.</li>';
            return;
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.style.alignItems = 'flex-start';
            
            // <<<<<<< ALTERA√á√ÉO IMPORTANTE >>>>>>>>>
            // Adiciona um data-attribute se o t√≠tulo for uma tag
            if (item.title.startsWith('#')) {
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = item.title.replace('#', '');
                li.style.cursor = 'pointer'; // Muda o cursor para indicar que √© clic√°vel
            }
            
            let contentHTML = '';

            if (Array.isArray(item.content) && item.content.length > 0) {
                const linksHTML = item.content.map((url, index) => {
                    if (!url) return '';
                    return `<div style="display: flex; align-items: baseline; margin-top: 5px; gap: 8px;"><span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span><a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; word-break: break-all;">${url}</a></div>`;
                }).join('');
                contentHTML = `<div style="margin-top: 4px;">${linksHTML}</div>`;
            } 
            else if (typeof item.content === 'string' && item.content) {
                contentHTML = `<small style="color: var(--text-muted-color); margin-top: 4px;">${item.content}</small>`;
            }

            let editButtonHTML = '';
            if (item.type === 'anexo' && item.id) {
                editButtonHTML = `<button data-action="edit-anexo" data-id="${item.id}" title="Editar Anexo" style="background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; margin-left: auto; padding: 5px;">‚úèÔ∏è</button>`;
            }

            li.innerHTML = `<div style="display: flex; flex-direction: column; flex-grow: 1;"><strong style="font-size: 1.1em;">${item.title}</strong>${contentHTML}</div>${editButtonHTML}`;
            contentEl.appendChild(li);
        });

    } catch (error) {
        console.error("Erro ao carregar dados para o modal:", error);
        contentEl.innerHTML = '<li>Ocorreu um erro ao carregar os itens.</li>';
    }
}

 function openAttachmentsModal() {
    if (!selectedNoteId) return;
    
    const fetchData = async () => {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (noteSnap.exists() && noteSnap.data().anexos) {
            const anexosMap = noteSnap.data().anexos;
            // A MUDAN√áA PRINCIPAL: Agora usamos Object.entries para ter acesso √† CHAVE (ID do anexo)
            return Object.entries(anexosMap).map(([anexoId, anexoData]) => {
                const urlsArray = anexoData.urls ? Object.values(anexoData.urls) : (anexoData.hiperligacao ? [anexoData.hiperligacao] : []);
                return { 
                    id: anexoId, // <<<<<<< IMPORTANTE: Passamos o ID do anexo
                    title: anexoData.titulo, 
                    content: urlsArray,
                    type: 'anexo' // <<<<<<< Adicionamos um tipo para identifica√ß√£o
                };
            });
        }
        return [];
    };

    openGenericListModal("Anexos na Nota", fetchData());
}

function openTagsModal() {
    const fetchData = async () => {
        // Usa a cache de tags que j√° temos, ordenadas alfabeticamente
        if (allTags && allTags.length > 0) {
            return [...allTags]
                .sort((a, b) => a.nome.localeCompare(b.nome))
                .map(tag => ({
                    title: `#${tag.nome}`,
                    // Deixamos o content vazio, pois a a√ß√£o ser√° no clique
                    content: '' 
                }));
        }
        
        // Fallback para ir √† base de dados se a cache estiver vazia
        const tagsCollection = collection(db, 'tags');
        const tagsSnapshot = await getDocs(tagsCollection);
        if (!tagsSnapshot.empty) {
            const tags = tagsSnapshot.docs.map(doc => ({
                title: `#${doc.data().nome}`,
                content: ''
            }));
            return tags.sort((a, b) => a.title.localeCompare(b.title));
        }
        
        return [];
    };

    openGenericListModal("Todas as Tags", fetchData());
}

async function openAnchorsModal() {
    await fetchAllEntities();
    const modal = document.getElementById('anchors-modal');
    const tabsContainer = document.getElementById('anchors-tabs-container');
    const contentContainer = document.getElementById('anchors-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';
    const onPageEntityNames = new Set(Array.from(noteContentEditor.querySelectorAll('.entity-link')).map(link => link.dataset.entityName));

    let isFirstTab = true;
    for (const type in ENTITY_CONFIG) {
        if (allEntities[type] && allEntities[type].length > 0) {
            const config = ENTITY_CONFIG[type];
            const tabButton = document.createElement('button');
            tabButton.dataset.tab = type;
            tabButton.textContent = config.displayName;
            if (isFirstTab) tabButton.classList.add('active');
            tabsContainer.appendChild(tabButton);

            const tabContent = document.createElement('div');
            tabContent.id = `tab-${type}`;
            tabContent.className = 'tab-content';
            if (isFirstTab) tabContent.classList.add('active');
            
            const ul = document.createElement('ul');
            const sortedEntities = [...allEntities[type]].sort((a, b) => a.nome.localeCompare(b.nome));

            sortedEntities.forEach(entity => {
                const li = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = entity.nome;
                li.appendChild(nameSpan);
                li.dataset.entityId = entity.id;
                li.dataset.entityName = entity.nome;
                li.dataset.entityType = entity.tipo;
                if (onPageEntityNames.has(entity.nome)) li.classList.add('is-on-page');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'entity-edit-btn';
                editBtn.innerHTML = '‚Ä¶';
                editBtn.title = 'Editar entidade';
                editBtn.onclick = (event) => {
                    event.stopPropagation();
                    openEditEntityModal(entity.id, entity.tipo);
                };

                li.appendChild(editBtn);
                ul.appendChild(li);
            });
            tabContent.appendChild(ul);
            contentContainer.appendChild(tabContent);
            isFirstTab = false;
        }
    }
    modal.style.display = 'flex';
}

async function openEditEntityModal(entityId, entityType) {
    const modal = document.getElementById('edit-entity-modal');
    const title = document.getElementById('edit-entity-title');
    const nameInput = document.getElementById('edit-entity-name-input');
    const descriptionInput = document.getElementById('edit-entity-description-input');
    const saveBtn = document.getElementById('edit-entity-save-btn');

    modal.style.display = 'flex';
    nameInput.value = 'A carregar...';
    descriptionInput.value = 'A carregar...';
    
    const collectionName = ENTITY_CONFIG[entityType]?.collection;
    if (!collectionName) {
        alert('Erro: Tipo de entidade desconhecido.');
        return;
    }

    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (!entitySnap.exists()) {
            alert('Erro: Entidade n√£o encontrada na base de dados.');
            modal.style.display = 'none';
            return;
        }

        const entityData = entitySnap.data();
        title.textContent = `Editar "${entityData.nome}"`;
        nameInput.value = entityData.nome;
        descriptionInput.value = entityData.descricao || '';

        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDescription = descriptionInput.value.trim();

            if (!newName) {
                alert('O nome n√£o pode estar vazio.');
                return;
            }

            await updateDoc(entityRef, {
                nome: newName,
                descricao: newDescription
            });

            modal.style.display = 'none';
            await fetchAllEntities();
            
            const liToUpdate = document.querySelector(`#anchors-content-container li[data-entity-id="${entityId}"] span`);
            if (liToUpdate) {
                liToUpdate.textContent = newName;
            }
        };

    } catch (error) {
        console.error("Erro ao abrir o modal de edi√ß√£o:", error);
        alert('Ocorreu um erro ao carregar os dados da entidade.');
        modal.style.display = 'none';
    }
}


// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function appendLinkInfoToPanel(anexoId) {
    console.groupCollapsed('%c[Painel de Refer√™ncias]', 'color: white; background-color: #8e44ad; padding: 2px 5px; border-radius: 3px;');
    console.log(`A procurar informa√ß√£o para o anexo com ID: ${anexoId}`);

    if (!selectedNoteId) {
        console.error('ID da nota n√£o encontrado. A abortar.');
        console.groupEnd();
        return;
    }

    const noteRef = doc(db, 'pastas', selectedNoteId);
    const noteSnap = await getDoc(noteRef);
    
    if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[anexoId]) {
        const anexo = noteSnap.data().anexos[anexoId];
        console.log('Anexo encontrado na base de dados:', anexo);
        const list = document.getElementById('references-list');

        const details = document.createElement('details');
        details.className = 'reference-item link-info';
        details.open = true;

        const summary = document.createElement('summary');
        summary.innerHTML = `üîó Anexo: ${anexo.titulo}`;
        
        const contextDiv = document.createElement('div');
        contextDiv.className = 'reference-context';
        
        const urls = anexo.urls ? Object.values(anexo.urls) : [anexo.hiperligacao];
        urls.forEach(url => {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.textContent = url;
                link.target = '_blank';
                link.style.display = 'block';
                link.style.marginBottom = '5px';
                contextDiv.appendChild(link);
            }
        });

        details.appendChild(summary);
        details.appendChild(contextDiv);
        
        const separator = document.createElement('hr');
        separator.style.borderColor = 'var(--border-color)';
        separator.style.margin = '15px 0';
        
        list.appendChild(separator);
        list.appendChild(details);
        console.log('%cSUCESSO: Informa√ß√£o do anexo adicionada ao painel.', 'color: #2ecc71;');
    } else {
        console.error(`Anexo com ID "${anexoId}" n√£o foi encontrado nos dados da nota.`);
    }
    console.groupEnd();
}
// ====================================================================

// ====================================================================
// ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT JAVASCRIPT
// ====================================================================
async function showTagReferencesPanel(tagName) {
    // Esconde elementos espec√≠ficos de entidades (descri√ß√£o, toolbar)
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'none';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'none');
    
    // Configura e mostra o painel
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Refer√™ncias para a Tag "#${tagName}"`;
    referencesList.innerHTML = '<li>A carregar refer√™ncias...</li>';

    try {
        // Procura por todas as notas que cont√™m a tag no seu array 'tags'
        const q = query(collection(db, 'pastas'), where('tags', 'array-contains', tagName));
        const querySnapshot = await getDocs(q);

        referencesList.innerHTML = ''; // Limpa o "a carregar"

        if (querySnapshot.empty) {
            referencesList.innerHTML = '<li>Nenhuma refer√™ncia encontrada para esta tag.</li>';
            return;
        }

        const resultsPromises = querySnapshot.docs.map(async (noteDoc) => {
            if (!noteDoc.exists()) return null;
            const parentId = noteDoc.data().parentId;
            if (!parentId) return { noteSnap: noteDoc, parentSnap: null };
            const parentDoc = await getDoc(doc(db, 'pastas', parentId));
            return { noteSnap: noteDoc, parentSnap: parentDoc.exists() ? parentDoc : null };
        });

        const results = await Promise.all(resultsPromises);

        results.forEach(result => {
            if (!result) return;
            const { noteSnap, parentSnap } = result;
            const noteData = noteSnap.data();
            
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            const summary = document.createElement('summary');
            const noteTitleSpan = document.createElement('span');
            noteTitleSpan.textContent = noteData.nome;
            
            const goToNoteBtn = document.createElement('button');
            goToNoteBtn.className = 'go-to-note-btn';
            goToNoteBtn.title = 'Ir para esta nota';
            goToNoteBtn.innerHTML = '‚ûî';
            goToNoteBtn.dataset.noteId = noteSnap.id;
            if (parentSnap) {
                goToNoteBtn.dataset.parentId = parentSnap.id;
                goToNoteBtn.dataset.parentName = parentSnap.data().nome;
            }
            
            summary.appendChild(noteTitleSpan);
            summary.appendChild(goToNoteBtn);

            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Para tags, um contexto simples pode ser suficiente
            contextDiv.innerHTML = `<p style="font-style: italic;">Esta nota cont√©m a tag #${tagName}.</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            referencesList.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias da tag:", error);
        referencesList.innerHTML = '<li>Ocorreu um erro ao buscar as refer√™ncias.</li>';
    }
}


  async function showReferencesPanel(entityId, entityName, entityType, anexoId = null) {
    // RESTAURA A VISIBILIDADE dos elementos de entidade
    document.getElementById('references-panel-description').style.display = 'block';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');

    // O resto da fun√ß√£o continua exatamente igual...
    activeReferenceEntity = { id: entityId, type: entityType, name: entityName };
    const descriptionElement = document.getElementById('references-panel-description');
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Refer√™ncias para "${entityName}"`;
    referencesList.innerHTML = '<li>A carregar refer√™ncias...</li>';
    descriptionElement.textContent = ''; 

    const collectionName = ENTITY_CONFIG[entityType]?.collection;
    if (!collectionName) {
        referencesList.innerHTML = '<li>Erro: Tipo de entidade inv√°lido.</li>';
        return;
    }

    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (entitySnap.exists()) {
            const entityData = entitySnap.data();
            descriptionElement.textContent = entityData.descricao?.trim() || 'Nenhuma descri√ß√£o dispon√≠vel.';
            
            referencesList.innerHTML = ''; 
            
            if (entityData.referencias && Object.keys(entityData.referencias).length > 0) {
                const noteIds = Object.keys(entityData.referencias);
                // Usamos Promise.all com um map para obter os dados da nota E da sua pasta pai
                const promises = noteIds.map(async (id) => {
                    const noteDoc = await getDoc(doc(db, 'pastas', id));
                    if (!noteDoc.exists()) return null;
                    const parentId = noteDoc.data().parentId;
                    if (!parentId) return { noteSnap: noteDoc, parentSnap: null }; // Nota na raiz
                    const parentDoc = await getDoc(doc(db, 'pastas', parentId));
                    return { noteSnap: noteDoc, parentSnap: parentDoc.exists() ? parentDoc : null };
                });

                const results = await Promise.all(promises);

                results.forEach(result => {
                    if (!result) return;
                    const { noteSnap, parentSnap } = result;
                    const noteData = noteSnap.data();
                    
                    const details = document.createElement('details');
                    details.className = 'reference-item';
                    
                    const summary = document.createElement('summary');
                    const noteTitleSpan = document.createElement('span');
                    noteTitleSpan.textContent = noteData.nome;
                    
                    // AQUI CRIAMOS O BOT√ÉO DE NAVEGA√á√ÉO
                    const goToNoteBtn = document.createElement('button');
                    goToNoteBtn.className = 'go-to-note-btn';
                    goToNoteBtn.title = 'Ir para esta nota';
                    goToNoteBtn.innerHTML = '‚ûî';
                    // Guardamos os dados necess√°rios para a navega√ß√£o no bot√£o
                    goToNoteBtn.dataset.noteId = noteSnap.id;
                    if (parentSnap) {
                        goToNoteBtn.dataset.parentId = parentSnap.id;
                        goToNoteBtn.dataset.parentName = parentSnap.data().nome;
                    }
                    
                    summary.appendChild(noteTitleSpan);
                    summary.appendChild(goToNoteBtn);

                    const contextDiv = document.createElement('div');
                    contextDiv.className = 'reference-context';
                    contextDiv.innerHTML = generateReferenceContext(noteData.conteudo, entityName);
                    
                    details.appendChild(summary);
                    details.appendChild(contextDiv);
                    referencesList.appendChild(details);
                });
            } else {
                 referencesList.innerHTML = '<li>Nenhuma refer√™ncia de nota encontrada.</li>';
            }
        } else {
            referencesList.innerHTML = '<li>Erro: Entidade n√£o encontrada.</li>';
        }

        // A l√≥gica do anexo permanece igual
        if (anexoId) {
            // ... (c√≥digo do anexo que j√° existe, n√£o precisa de ser alterado)
            const noteRef = doc(db, 'pastas', selectedNoteId);
            const noteSnap = await getDoc(noteRef);
            if (noteSnap.exists() && noteSnap.data().anexos?.[anexoId]) {
                const anexo = noteSnap.data().anexos[anexoId];
                const separator = document.createElement('hr');
                separator.style.borderColor = 'var(--border-color)';
                separator.style.margin = '15px 0';
                const details = document.createElement('details');
                details.className = 'reference-item link-info';
                details.open = true;
                const summary = document.createElement('summary');
                summary.innerHTML = `üîó Anexo: ${anexo.titulo}`;
                const contextDiv = document.createElement('div');
                contextDiv.className = 'reference-context';
                const urls = anexo.urls ? Object.values(anexo.urls) : [anexo.hiperligacao];
                urls.forEach(url => {
                    if (url) {
                        const link = document.createElement('a');
                        link.href = url;
                        link.textContent = url;
                        link.target = '_blank';
                        link.style.display = 'block';
                        link.style.marginBottom = '5px';
                        contextDiv.appendChild(link);
                    }
                });
                details.appendChild(summary);
                details.appendChild(contextDiv);
                referencesList.appendChild(separator);
                referencesList.appendChild(details);
            }
        }
    } catch (error) {
        console.error("Erro ao buscar refer√™ncias:", error);
        referencesList.innerHTML = '<li>Ocorreu um erro ao buscar as refer√™ncias.</li>';
    }
}

function hideReferencesPanel() {
    notebookContainer.classList.remove('references-panel-visible');
    const descriptionElement = document.getElementById('references-panel-description');
    if (descriptionElement) {
        descriptionElement.textContent = '';
    }
}

function generateReferenceContext(noteContent, entityName) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = noteContent;
    const plainText = tempDiv.innerText;
    const position = plainText.toLowerCase().indexOf(entityName.toLowerCase());

    if (position === -1) {
        return '<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>';
    }

    const CONTEXT_LENGTH = 70;
    const start = Math.max(0, position - CONTEXT_LENGTH);
    const end = Math.min(plainText.length, position + entityName.length + CONTEXT_LENGTH);
    let prefix = start > 0 ? '... ' : '';
    let suffix = end < plainText.length ? ' ...' : '';
    let contextText = plainText.substring(start, end);
    const highlightedText = contextText.replace(
        new RegExp(entityName, 'i'),
        `<mark>${entityName}</mark>`
    );
    return `<p>${prefix}${highlightedText}${suffix}</p>`;
}

// --- L√ìGICA DO EDITOR RICO E TAGS ---

function showTagPopup(query) {
    const filteredTags = allTags.filter(tag => tag.nome.toLowerCase().includes(query.toLowerCase()));
    tagSuggestionList.innerHTML = '';
    if (filteredTags.length > 0) {
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag.nome;
            li.dataset.tagNome = tag.nome;
            tagSuggestionList.appendChild(li);
        });
    } else if (query) {
        const li = document.createElement('li');
        li.innerHTML = `Criar nova tag: "<strong>${query}</strong>"`;
        li.dataset.tagNome = query;
        tagSuggestionList.appendChild(li);
    } else {
         hideTagPopup(); return;
    }
    const rect = currentTagQueryRange.getBoundingClientRect();
    tagSuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
    tagSuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
    tagSuggestionPopup.style.display = 'block';
    isTagPopupOpen = true;
    tagSuggestionList.firstChild.classList.add('selected');
}

function hideTagPopup() {
    tagSuggestionPopup.style.display = 'none';
    isTagPopupOpen = false;
    currentTagQueryRange = null;
}

function navigateTagSuggestions(key) {
    const items = Array.from(tagSuggestionList.children);
    if(items.length === 0) return;
    const selected = tagSuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

async function commitTagSelection() {
    const selectedLi = tagSuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    const tagName = selectedLi.dataset.tagNome.trim();
    if (!tagName) { hideTagPopup(); return; }
    let tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tagExists) await createNewTag(tagName);
    insertTagIntoEditor(tagName);
    hideTagPopup();
}

async function createNewTag(tagName) {
    try {
        const tagsCollection = collection(db, 'tags');
        const newTagRef = await addDoc(tagsCollection, { nome: tagName, createdAt: serverTimestamp() });
        allTags.push({ id: newTagRef.id, nome: tagName });
    } catch (error) { console.error("Erro ao criar nova tag:", error); }
}


async function fetchAllTags() {
    try {
        const tagsCollection = collection(db, 'tags');
        const tagsSnapshot = await getDocs(tagsCollection);
        
        const loadedTags = tagsSnapshot.docs.map(doc => ({
            id: doc.id,
            nome: doc.data().nome || doc.data().name 
        }));

        allTags = loadedTags.filter(tag => {
            if (tag.nome && typeof tag.nome === 'string') {
                return true; 
            } else {
                console.warn('Tag descartada por falta do campo "nome":', doc.id);
                return false; 
            }
        });
        
    } catch (error) {
        console.error("Erro ao carregar as tags existentes:", error);
    }
}


function insertTagIntoEditor(tagName) {
    if (!currentTagQueryRange) return;
    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = `#${tagName}`;
    tagSpan.setAttribute('contenteditable', 'false');
    const spaceNode = document.createTextNode('\u00A0');
    currentTagQueryRange.deleteContents();
    currentTagQueryRange.insertNode(spaceNode);
    currentTagQueryRange.insertNode(tagSpan);
    const selection = window.getSelection();
    const newRange = document.createRange();
    const newOffset = Math.min(originalOffset, textNode.textContent.length); 
    newRange.setStart(textNode, newOffset);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}


// --- NOVAS FUN√á√ïES PARA SUGEST√ÉO DE ENTIDADES ---

function showEntityPopup(query) {
    // Junta todas as entidades de todos os tipos num √∫nico array
    const flatEntities = Object.values(allEntities).flat();
    const filteredEntities = flatEntities.filter(entity => 
        entity.nome.toLowerCase().includes(query.toLowerCase())
    );

    entitySuggestionList.innerHTML = '';
    if (filteredEntities.length > 0) {
        filteredEntities.forEach(entity => {
            const li = document.createElement('li');
            // Guardamos os dados da entidade no elemento li
            li.dataset.entityName = entity.nome;
            li.dataset.entityType = entity.tipo;
            
            // Mostra o nome e o tipo para ser mais f√°cil de identificar
            li.innerHTML = `${entity.nome} <span style="font-size: 0.8em;">[${entity.tipo}]</span>`;
            
            entitySuggestionList.appendChild(li);
        });
        
        const rect = currentEntityQueryRange.getBoundingClientRect();
        entitySuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
        entitySuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
        entitySuggestionPopup.style.display = 'block';
        isEntityPopupOpen = true;
        entitySuggestionList.firstChild.classList.add('selected');
    } else {
        hideEntityPopup();
    }
}

function hideEntityPopup() {
    entitySuggestionPopup.style.display = 'none';
    isEntityPopupOpen = false;
    currentEntityQueryRange = null;
}

function navigateEntitySuggestions(key) {
    const items = Array.from(entitySuggestionList.children);
    if(items.length === 0) return;
    const selected = entitySuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

function insertEntityIntoEditor(entityName, entityType) {
    if (!currentEntityQueryRange) return;

    const entitySpan = document.createElement('span');
    entitySpan.className = 'entity-link';
    entitySpan.dataset.entityType = entityType;
    entitySpan.dataset.entityName = entityName;
    entitySpan.textContent = entityName;
    
    const spaceNode = document.createTextNode('\u00A0');

    // Substitui o texto que o utilizador digitou (ex: @Jeremias)
    currentEntityQueryRange.deleteContents();
    currentEntityQueryRange.insertNode(spaceNode);
    currentEntityQueryRange.insertNode(entitySpan);
    
    // P√µe o cursor a seguir ao espa√ßo, pronto para continuar a escrever
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}

async function commitEntitySelection() {
    const selectedLi = entitySuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    
    const entityName = selectedLi.dataset.entityName;
    const entityType = selectedLi.dataset.entityType;
    
    if (entityName && entityType) {
        // A L√ìGICA DE ATUALIZA√á√ÉO FOI ADICIONADA AQUI
        const collectionName = ENTITY_CONFIG[entityType]?.collection;
        if (collectionName) {
            const allKnownEntities = Object.values(allEntities).flat();
            const entity = allKnownEntities.find(e => e.tipo === entityType && e.nome === entityName);

            if (entity) {
                // Se a entidade foi encontrada no cache, atualiza as suas refer√™ncias no Firestore
                const entityRef = doc(db, collectionName, entity.id);
                try {
                    await updateDoc(entityRef, {
                        [`referencias.${selectedNoteId}`]: true
                    });
                    console.log(`Refer√™ncia para a nota ${selectedNoteId} adicionada √† entidade "${entityName}".`);
                } catch (error) {
                    console.error("Erro ao atualizar refer√™ncia da entidade:", error);
                }
            }
        }

        // Insere o <span> no editor (comportamento visual)
        insertEntityIntoEditor(entityName, entityType);
    }
    
    hideEntityPopup();
}



   function escapeStyledElements(event) {
    const selection = window.getSelection();
    if (!selection.isCollapsed || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    const parentElement = currentNode.nodeType === Node.TEXT_NODE ? currentNode.parentElement : currentNode;
    const styledContainer = parentElement.closest('.entity-link, .tag');

    if (styledContainer) {
        const isAtTheStart = range.startOffset === 0;
        const isAtTheEnd = range.startOffset === currentNode.textContent.length;
        const isPrintableChar = (event.key.length === 1 || event.key === 'Enter') && !event.ctrlKey && !event.metaKey && !event.altKey;

        // =========================================================================
        // IN√çCIO DO NOVO C√ìDIGO - Prote√ß√£o para escrever ANTES do link
        // =========================================================================
        if (isAtTheStart && isPrintableChar && event.key !== 'Backspace') {
            console.groupCollapsed('%c[Prote√ß√£o de √Çncora] A√ß√£o detetada!', 'color: white; background-color: #e67e22; padding: 2px 5px; border-radius: 3px;');
            console.log(`Evento: Tecla "${event.key}" premida.`);
            console.log(`Posi√ß√£o: In√≠cio da √¢ncora "${styledContainer.textContent}".`);
            
            // 1. Impedimos a a√ß√£o padr√£o do navegador para assumir o controlo.
            event.preventDefault();
            console.log('%cA√á√ÉO: Comportamento padr√£o do navegador cancelado.', 'color: #c0392b;');

            // 2. Criamos o texto que o utilizador digitou e uma "barreira" invis√≠vel.
            const typedTextNode = document.createTextNode(event.key);
            const zeroWidthSpace = document.createTextNode('\u200B');
            const parent = styledContainer.parentNode;

            // 3. Inserimos o texto e a barreira ANTES da √¢ncora.
            parent.insertBefore(typedTextNode, styledContainer);
            parent.insertBefore(zeroWidthSpace, styledContainer);
            console.log('%cA√á√ÉO: Texto e barreira invis√≠vel inseridos ANTES da √¢ncora.', 'color: #3498db;');

            // 4. Movemos o cursor para o local correto (depois do texto, antes da barreira).
            const newRange = document.createRange();
            newRange.setStart(zeroWidthSpace, 0);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            console.log('%cSUCESSO: A fronteira da √¢ncora foi protegida. O novo texto ficou fora dela.', 'color: #2ecc71; font-weight: bold;');
            console.groupEnd();
            return; // A√ß√£o conclu√≠da.
        }
    

        // =========================================================================
        // IN√çCIO DA L√ìGICA COM LOGS - Prote√ß√£o para n√£o escrever no final do link
        // =========================================================================
        if (isAtTheEnd && (event.key.length === 1 || event.key === 'Enter') && !event.ctrlKey && !event.metaKey && !event.altKey) {
            
            // --- LOGS ADICIONADOS ---
            console.groupCollapsed('%c[Prote√ß√£o de √Çncora] A√ß√£o detetada!', 'color: white; background-color: #9b59b2; padding: 2px 5px; border-radius: 3px;');
            console.log(`Evento: Tecla "${event.key}" premida.`);
            console.log(`Posi√ß√£o: Fim da √¢ncora "${styledContainer.textContent}".`);
            console.log('%cA√á√ÉO: A inserir caractere invis√≠vel (Zero-Width Space) para criar uma barreira.', 'color: #3498db;');
            // --- FIM DOS LOGS ---

            const zeroWidthSpace = document.createTextNode('\u200B');
            const parent = styledContainer.parentNode;
            parent.insertBefore(zeroWidthSpace, styledContainer.nextSibling);
            
            const newRange = document.createRange();
            newRange.setStart(zeroWidthSpace, 1);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);

            // --- LOGS ADICIONADOS ---
            console.log('%cAC√ÉO: Cursor movido para fora da √¢ncora, para depois da barreira.', 'color: #f1c40f;');
            console.log('%cSUCESSO: A fronteira da √¢ncora foi protegida. O novo texto ser√° escrito fora dela.', 'color: #2ecc71; font-weight: bold;');
            console.groupEnd();
            // --- FIM DOS LOGS ---
        }
    }
    
    // =========================================================================
    // CEN√ÅRIO 2: Prote√ß√£o contra a tecla DELETE no final de um texto
    // =========================================================================
    else if (event.key === 'Delete' && range.startOffset === currentNode.textContent.length) {
        const elementAfter = parentElement.nextElementSibling;
        if (elementAfter && (elementAfter.matches('.entity-link') || elementAfter.matches('.tag'))) {
            event.preventDefault();
            const newRange = document.createRange();
            const textNodeInsideEntity = elementAfter.firstChild;
            if (textNodeInsideEntity) {
                newRange.setStart(textNodeInsideEntity, 0);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }
    }
}


// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
function handleTextSelection() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) {
        selectionPopup.style.display = 'none';
        return;
    }
    const selectionText = selection.toString().trim();
    const isInEditor = noteContentEditor.contains(selection.anchorNode);

    if (!selection.isCollapsed && selectionText.length > 0 && isInEditor) {
        console.log(`%c[Sele√ß√£o de Texto] Texto selecionado: "${selectionText}"`, 'color: #3498db;');
        currentSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = currentSelectionRange.getBoundingClientRect();
        selectionPopup.style.display = 'flex';
        selectionPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        selectionPopup.style.left = `${rect.left + (rect.width / 2) - (selectionPopup.offsetWidth / 2) + window.scrollX}px`;
    } else {
        if (!selectionPopup.matches(':hover')) {
            selectionPopup.style.display = 'none';
        }
    }
}
// ====================================================================



function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.seconds) {
            return 'Data inv√°lida';
        }
        const date = new Date(timestamp.seconds * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    /**
     * Carrega e exibe a lista de backups para a nota atual.
     */
    async function loadBackupsForNote() {
        if (!selectedNoteId) return;

        const listEl = document.getElementById('history-list-content');
        listEl.innerHTML = '<li>A carregar backups...</li>';

        const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
        const q = query(backupsRef, orderBy('timestamp', 'desc'));

        try {
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                listEl.innerHTML = '<li>Nenhum backup encontrado.</li>';
                return;
            }

            listEl.innerHTML = '';
            snapshot.forEach(doc => {
                const backup = { id: doc.id, ...doc.data() };
                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                
                const backupDate = formatTimestamp(backup.timestamp);
                
                li.innerHTML = `
                    <span>Backup de ${backupDate}</span>
                    <div>
                        <button class="modal-btn secondary" data-action="view" data-backup-id="${backup.id}" style="padding: 5px 10px;">Ver</button>
                        <button class="modal-btn primary" data-action="restore" data-backup-id="${backup.id}" style="padding: 5px 10px;">Restaurar</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        } catch (error) {
            console.error("Erro ao carregar backups:", error);
            listEl.innerHTML = '<li>Ocorreu um erro ao carregar os backups.</li>';
        }
    }
    
    /**
     * Abre o modal de hist√≥rico e configura os seus eventos.
     */
    async function openHistoryModal() {
        if (!selectedNoteId) {
            alert("Por favor, selecione uma nota primeiro.");
            return;
        }

        const modal = document.getElementById('history-modal');
        const titleEl = document.getElementById('history-modal-title');
        const backupBtn = document.getElementById('backup-now-btn');
        
        titleEl.textContent = `Hist√≥rico de "${noteTitleInput.value}"`;
        
        // Remove listener antigo para evitar duplicados e adiciona um novo
        const newBackupBtn = backupBtn.cloneNode(true);
        backupBtn.parentNode.replaceChild(newBackupBtn, backupBtn);
        newBackupBtn.onclick = async () => {
            newBackupBtn.disabled = true;
            newBackupBtn.textContent = 'A criar backup...';
            try {
                const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
                await addDoc(backupsRef, {
                    titulo: noteTitleInput.value,
                    conteudo: noteContentEditor.innerHTML,
                    timestamp: serverTimestamp()
                });
                await loadBackupsForNote(); // Atualiza a lista
            } catch (error) {
                console.error("Erro ao criar backup:", error);
                alert("Ocorreu um erro ao criar o backup.");
            } finally {
                newBackupBtn.disabled = false;
                newBackupBtn.textContent = 'Fazer backup do estado atual';
            }
        };

        modal.style.display = 'flex';
        await loadBackupsForNote();
    }

    /**
     * Restaura um backup criando uma nova nota.
     * @param {string} backupId O ID do documento de backup.
     */
    async function restoreBackup(backupId) {
        if (!selectedNoteId) return;
        
        try {
            // 1. Obter os dados do backup
            const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
            const backupSnap = await getDoc(backupRef);
            if (!backupSnap.exists()) {
                throw new Error("Backup n√£o encontrado.");
            }
            const backupData = backupSnap.data();

            // 2. Obter o parentId da nota original
            const originalNoteRef = doc(db, 'pastas', selectedNoteId);
            const originalNoteSnap = await getDoc(originalNoteRef);
            if (!originalNoteSnap.exists()) {
                throw new Error("Nota original n√£o encontrada.");
            }
            const parentId = originalNoteSnap.data().parentId;
            
            // 3. Formatar o novo t√≠tulo
            const backupDate = formatTimestamp(backupData.timestamp);
            const newTitle = `${backupData.titulo} (Restaurado de ${backupDate})`;

            // 4. Determinar a ordem da nova nota
            const q = query(collection(db, 'pastas'), where('parentId', '==', parentId), where('estado', '==', 'ativa'));
            const siblingsSnap = await getDocs(q);
            const newOrder = siblingsSnap.size;

            // 5. Criar a nova nota
            await addDoc(collection(db, 'pastas'), {
                nome: newTitle,
                conteudo: backupData.conteudo,
                parentId: parentId,
                tipo: 'nota',
                estado: 'ativa',
                ordem: newOrder,
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            alert(`Nota restaurada com sucesso como "${newTitle}".\nA lista de notas ser√° atualizada.`);
            document.getElementById('history-modal').style.display = 'none';

        } catch (error) {
            console.error("Erro ao restaurar backup:", error);
            alert("Ocorreu um erro ao restaurar o backup.");
        }
    }

    /**
     * Exibe o conte√∫do de um backup num modal de visualiza√ß√£o.
     * @param {string} backupId O ID do documento de backup.
     */
    async function viewBackup(backupId) {
        if (!selectedNoteId) return;

        try {
            const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
            const backupSnap = await getDoc(backupRef);
            if (!backupSnap.exists()) {
                throw new Error("Backup n√£o encontrado.");
            }
            const backupData = backupSnap.data();
            
            const modal = document.getElementById('view-backup-modal');
            const titleEl = document.getElementById('view-backup-title');
            const contentEl = document.getElementById('view-backup-content');

            const backupDate = formatTimestamp(backupData.timestamp);
            titleEl.textContent = `Visualizando Backup de ${backupDate}`;
            // Usar textContent para evitar renderiza√ß√£o de HTML malicioso
            contentEl.textContent = backupData.conteudo.replace(/<[^>]*>/g, ''); // Remove tags HTML para visualiza√ß√£o simples
            
            modal.style.display = 'flex';

        } catch (error) {
            console.error("Erro ao visualizar backup:", error);
            alert("Ocorreu um erro ao carregar o conte√∫do do backup.");
        }
    }
    
    // --- EVENT LISTENER MODIFICADO ---

    editorToolbar.addEventListener('click', async (e) => {
        const target = e.target.closest('button, input');
        if (!target) return;
        const command = target.dataset.command;
        if (command) {
            // ... (c√≥digo existente para formata√ß√£o de texto)
        }
        const action = target.dataset.action;
        if (action) {
            switch (action) {
                case 'show-tags': openTagsModal(); break;
                case 'show-attachments': openAttachmentsModal(); break;
                case 'show-anchors': openAnchorsModal(); break;
                // --- Linha modificada ---
                case 'show-history': openHistoryModal(); break; 
            }
        }
    });

    // --- NOVO EVENT LISTENER PARA O MODAL DE HIST√ìRICO ---
    
    document.getElementById('history-list-content').addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        
        const action = button.dataset.action;
        const backupId = button.dataset.backupId;

        if (action === 'restore') {
            restoreBackup(backupId);
        } else if (action === 'view') {
            viewBackup(backupId);
        }
    });


// --- EVENT LISTENERS ---

// Listeners de Conectividade e Sa√≠da
window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);
window.addEventListener('beforeunload', (event) => {
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        event.preventDefault();
        event.returnValue = '';
        return '';
    }
});

// Listeners de Navega√ß√£o (Protegidos pelo Gatekeeper)
backBtn.addEventListener('click', () => {
    const action = () => {
        if (navigationStack.length > 0) {
            navigationStack.pop();
            updateNavigationView();
        }
    };
    navigateWithUnsavedCheck(action);
});

leftPanelList.addEventListener('click', (e) => {
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) { showContextMenu(e); return; }
    
    const listItem = e.target.closest('.list-item');
    // Ignora cliques que n√£o s√£o em pastas ou se a pasta j√° est√° selecionada
    if (!listItem || listItem.dataset.type !== 'pasta' || listItem.classList.contains('selected')) {
        return;
    }

    // --- A NOVA L√ìGICA EST√Å AQUI ---
    // SE UMA NOTA ESTIVER ABERTA, usamos a nova fun√ß√£o "suave" que n√£o fecha o editor.
    if (selectedNoteId) {
        updateMiddlePanelForFolderSelection(listItem.dataset.id, listItem.dataset.name, listItem);
    } 
    // SE NENHUMA NOTA ESTIVER ABERTA, usamos a navega√ß√£o padr√£o com reset total.
    else {
        const action = () => {
            if (navigationStack.length > 0) navigationStack.pop();
            navigationStack.push({ id: listItem.dataset.id, name: listItem.dataset.name });
            updateNavigationView();
        };
        // O gatekeeper n√£o √© estritamente necess√°rio aqui, mas √© uma boa pr√°tica
        navigateWithUnsavedCheck(action);
    }
});

middlePanelList.addEventListener('click', (e) => {
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) { showContextMenu(e); return; }

    const listItem = e.target.closest('.list-item');
    if (!listItem) return;

    const { id, type, name } = listItem.dataset;
    if (type === 'nota' && id === selectedNoteId) return;

    const action = () => {
        if (type === 'pasta') {
            navigationStack.push({ id, name });
            updateNavigationView();
        } else if (type === 'nota') {
            displayNote(id, listItem);
        }
    };
    navigateWithUnsavedCheck(action);
});

document.querySelector('.tabs-container').addEventListener('click', (e) => {
    const clickedTab = e.target.closest('button');
    if (!clickedTab) return;

    const action = () => {
        document.querySelectorAll('.tabs-container button').forEach(btn => btn.classList.remove('active'));
        clickedTab.classList.add('active');
        navigationStack = [];
        updateNavigationView();
    };
    navigateWithUnsavedCheck(action);
});

// Listeners do Editor
noteTitleInput.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
noteContentEditor.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
document.addEventListener('selectionchange', handleTextSelection);

  noteContentEditor.addEventListener('keydown', (event) => {
    escapeStyledElements(event); // Mant√©m a fun√ß√£o original

    if (isTagPopupOpen) {
        if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
            event.preventDefault();
            navigateTagSuggestions(event.key);
        } else if (['Enter', 'Tab'].includes(event.key)) { // Removi o ' ' e ','
            event.preventDefault();
            commitTagSelection();
        }
    } else if (isEntityPopupOpen) {
        if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
            event.preventDefault();
            navigateEntitySuggestions(event.key);
        } else if (['Enter', 'Tab'].includes(event.key)) {
            event.preventDefault();
            commitEntitySelection();
        }
    }
});

// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
document.getElementById('generic-list-modal').addEventListener('click', (e) => {
    // Procura por um bot√£o de edi√ß√£o de anexo
    const editButton = e.target.closest('button[data-action="edit-anexo"]');
    if (editButton) {
        const anexoId = editButton.dataset.id;
        if (anexoId) {
            document.getElementById('generic-list-modal').style.display = 'none';
            openLinkModal(true, { id: anexoId });
        }
        return; // Termina a execu√ß√£o aqui
    }

    // <<<<<<< NOVO: Procura por um item de lista de tag clic√°vel >>>>>>>>>
    const tagListItem = e.target.closest('li[data-action="show-tag-references"]');
    if (tagListItem) {
        const tagName = tagListItem.dataset.tagName;
        if (tagName) {
            // 1. Fecha o modal de tags
            document.getElementById('generic-list-modal').style.display = 'none';
            // 2. Abre o painel de refer√™ncias para essa tag
            showTagReferencesPanel(tagName);
        }
    }
});

 noteContentEditor.addEventListener('keyup', (event) => {
    // Ignora teclas que n√£o alteram o conte√∫do para evitar execu√ß√µes desnecess√°rias
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(event.key)) {
        return;
    }
    
    // Se um dos popups de sugest√£o estiver aberto, n√£o faz mais nada
    if (isTagPopupOpen || isEntityPopupOpen) {
        if (['Enter', ' '].includes(event.key)) return;
    }

    if (event.key === 'Escape') { 
        hideTagPopup();
        hideEntityPopup();
        return; 
    }

    // --- L√ìGICA DE SUGEST√ïES (permanece igual) ---
    const selection = window.getSelection();
    if (!selection.rangeCount > 0) return;
    const range = selection.getRangeAt(0);
    const textBeforeCursor = range.startContainer.textContent.substring(0, range.startOffset);

    const tagMatch = textBeforeCursor.match(/#(\w*)$/);
    const entityMatch = textBeforeCursor.match(/@([\w\s]*)$/);

    if (tagMatch) {
        hideEntityPopup();
        currentTagQueryRange = document.createRange();
        currentTagQueryRange.setStart(range.startContainer, tagMatch.index);
        currentTagQueryRange.setEnd(range.startContainer, range.startOffset);
        showTagPopup(tagMatch[1]);
    } else if (entityMatch) {
        hideTagPopup();
        currentEntityQueryRange = document.createRange();
        currentEntityQueryRange.setStart(range.startContainer, entityMatch.index);
        currentEntityQueryRange.setEnd(range.startContainer, range.startOffset);
        showEntityPopup(entityMatch[1]);
    } else {
        hideTagPopup();
        hideEntityPopup();
    }
    
    // --- CHAMADA UNIFICADA E SEGURA ---
    // Apenas a nossa fun√ß√£o debounced ser√° respons√°vel por analisar e criar links.
    // Isto elimina o conflito e a instabilidade.
    debouncedScanAndLink();
});


// Outros Listeners
document.addEventListener('click', (e) => {
    if (!e.target.closest('.context-menu')) hideContextMenu();
    if (!noteContentEditor.contains(e.target) && !tagSuggestionPopup.contains(e.target)) hideTagPopup();
});

leftPanelToggleBtn.addEventListener('click', () => {
    notebookContainer.classList.toggle('left-panel-collapsed');
});

addItemBtn.addEventListener('click', () => {
    const addFolderBtn = document.querySelector('#add-item-options button[data-type="pasta"]');
    const addNoteBtn = document.querySelector('#add-item-options button[data-type="nota"]');
    newItemNameInput.value = '';
    newItemNameInput.style.display = 'none';
    document.getElementById('confirm-item-addition').style.display = 'none';
    document.getElementById('add-item-options').style.display = 'flex';
    if (navigationStack.length === 0) {
        addFolderBtn.style.display = 'block';
        addNoteBtn.style.display = 'none';
    } else {
        addFolderBtn.style.display = 'block';
        addNoteBtn.style.display = 'block';
    }
    document.getElementById('add-item-modal').style.display = 'flex';
});

let itemTypeToAdd = '';
document.getElementById('add-item-options').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    itemTypeToAdd = btn.dataset.type;
    document.getElementById('add-item-options').style.display = 'none';
    newItemNameInput.style.display = 'block';
    newItemNameInput.placeholder = `Nome d${itemTypeToAdd === 'pasta' ? 'a' : 'a'} ${itemTypeToAdd}...`;
    newItemNameInput.focus();
    document.getElementById('confirm-item-addition').style.display = 'block';
});

document.getElementById('confirm-item-addition').addEventListener('click', async () => {
    const itemName = newItemNameInput.value.trim();
    if (!itemName || !itemTypeToAdd) return;
    const parentId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
    try {
        const q = query(collection(db, 'pastas'), where('parentId', '==', parentId), where('estado', '==', 'ativa'));
        const siblingsSnap = await getDocs(q);
        const newOrder = siblingsSnap.size;
        await addDoc(collection(db, 'pastas'), {
            nome: itemName, parentId: parentId, tipo: itemTypeToAdd, estado: 'ativa',
            ordem: newOrder, createdAt: serverTimestamp(), ultimaedicao: serverTimestamp(),
            ...(itemTypeToAdd === 'nota' && { conteudo: '' })
        });
        document.getElementById('add-item-modal').style.display = 'none';
    } catch (error) { console.error("Erro ao criar item:", error); }
});

document.getElementById('context-menu').addEventListener('click', async (e) => {
    const action = e.target.dataset.action;
    if (!action || !activeItemContext) return;

    // Guardamos o contexto numa vari√°vel local antes que seja limpo
    const itemContext = { ...activeItemContext };

    if (action === 'hide') {
        const confirmed = await showConfirmation('Ocultar Item?', `Tem certeza que deseja ocultar "${itemContext.name}"?`);
        if (confirmed) {
            await updateDoc(doc(db, 'pastas', itemContext.id), { 
                estado: 'desativa',
                ultimaedicao: serverTimestamp()
            });
        }
    } else if (action === 'move-position') {
        await openMoveModal(); 
    } else if (action === 'move-folder') { 
        // ALTERA√á√ÉO: Passamos o itemContext como argumento
        await openMoveToFolderModal(itemContext); 
    } else if (action === 'rename') {
        const currentName = itemContext.name;
        const newName = prompt("Mudar nome para:", currentName);
        if (newName && newName.trim() !== "" && newName !== currentName) {
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                nome: newName.trim(),
                ultimaedicao: serverTimestamp()
            });
        }
    }
    hideContextMenu(); // Agora √© seguro chamar isto, pois j√° pass√°mos a informa√ß√£o
});

document.querySelectorAll('.modal-overlay [data-action="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal-overlay').style.display = 'none';
    });
});

document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-modal').style.display = 'flex';
});

document.getElementById('settings-modal').addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    if (action === 'show-hidden-items') {
        document.getElementById('settings-modal').style.display = 'none';
        showHiddenItemsModal();
    }
});

document.getElementById('hidden-items-list').addEventListener('click', async (e) => {
    if (e.target.tagName === 'BUTTON') {
        const id = e.target.dataset.id;
        await updateDoc(doc(db, 'pastas', id), { 
            estado: 'ativa',
            ultimaedicao: serverTimestamp()
        });
        e.target.closest('li').remove();
    }
});

editorToolbar.addEventListener('click', async (e) => {
    const target = e.target.closest('button, input');
    if (!target) return;
    const command = target.dataset.command;
    if (command) {
        if (command.includes('FontSize')) {
            const currentSize = window.getComputedStyle(noteContentEditor, null).getPropertyValue('font-size');
            let newSize = parseFloat(currentSize) + (command === 'increaseFontSize' ? 1 : -1);
            document.execCommand("fontSize", false, "7");
            let fontElements = window.getSelection().anchorNode.parentNode;
            fontElements.style.fontSize = newSize + "px";
        } else if (command === 'foreColor') {
            target.oninput = () => document.execCommand(command, false, target.value);
        } else {
            document.execCommand(command, false, null);
        }
        noteContentEditor.focus();
        saveNote();
    }
    const action = target.dataset.action;
    if (action) {
        switch (action) {
            case 'show-tags': openTagsModal(); break;
            case 'show-attachments': openAttachmentsModal(); break;
            case 'show-anchors': openAnchorsModal(); break;
            case 'show-history': openHistoryModal(); break;
        }
    }
});

// ====================================================================
// NOVA FUN√á√ÉO PARA O POPUP DE VISUALIZA√á√ÉO
// ====================================================================
 async function openViewLinkModal(anexoId) {
    const modal = document.getElementById('view-link-modal');
    const titleEl = document.getElementById('view-link-title');
    const listEl = document.getElementById('view-link-urls-list');
    const editBtn = document.getElementById('view-link-edit-btn');

    titleEl.textContent = 'A carregar...';
    listEl.innerHTML = '';
    modal.style.display = 'flex';

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists() || !noteSnap.data().anexos?.[anexoId]) {
            throw new Error('Anexo n√£o encontrado na base de dados.');
        }

        const anexo = noteSnap.data().anexos[anexoId];
        titleEl.textContent = anexo.titulo;
        const urls = anexo.urls ? Object.values(anexo.urls) : [];

        if (urls.length > 0) {
            // A L√ìGICA DE RENDERIZA√á√ÉO √â AGORA ID√äNTICA √Ä DO OUTRO MODAL
            urls.forEach((url, index) => {
                const li = document.createElement('li');
                
                // Criamos a estrutura com n√∫mero (branco) e link (azul)
                const linkHTML = `
                    <div style="display: flex; align-items: baseline; gap: 8px;">
                        <span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" 
                           style="color: var(--accent-color); text-decoration: none; word-break: break-all;">
                            ${url}
                        </a>
                    </div>
                `;
                li.innerHTML = linkHTML;
                listEl.appendChild(li);
            });
        } else {
            listEl.innerHTML = '<li>Nenhuma URL associada a este anexo.</li>';
        }
        
        const newEditBtn = editBtn.cloneNode(true);
        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
        newEditBtn.onclick = () => {
            modal.style.display = 'none'; 
            openLinkModal(true, { id: anexoId });
        };

    } catch (error) {
        console.error("Erro ao abrir o modal de visualiza√ß√£o:", error);
        alert(error.message);
        modal.style.display = 'none';
    }
}



// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 noteContentEditor.addEventListener('click', (event) => {
    console.groupCollapsed('%c[Gestor de Cliques]', 'color: white; background-color: #c0392b; padding: 2px 5px; border-radius: 3px;');
    
    const target = event.target;
    const anchorElement = target.closest('.entity-link');
    const linkElement = target.closest('a[data-anexo-id]');
    const tagElement = target.closest('.tag'); // <<<<<<< NOVO: Detetar clique na tag

    console.log('Elemento de √¢ncora (.entity-link) detetado:', anchorElement);
    console.log('Elemento de link (a[data-anexo-id]) detetado:', linkElement);
    console.log('Elemento de tag (.tag) detetado:', tagElement); // <<<<<<< NOVO: Log para a tag

    // PRIORIDADE 1: O utilizador clicou numa √¢ncora de entidade.
    if (anchorElement) {
        // ... (c√≥digo existente, n√£o precisa de ser alterado)
        console.log('%cDECIS√ÉO: Prioridade 1 - Clique em √Çncora. A mostrar refer√™ncias.', 'font-weight: bold; color: #e67e22;');
        event.preventDefault();
        const entityName = anchorElement.dataset.entityName;
        const entityType = anchorElement.dataset.entityType;
        const entity = allEntities[entityType]?.find(e => e.nome === entityName);
        if (!entity) {
            console.error(`Entidade "${entityName}" n√£o encontrada no cache.`);
            console.groupEnd();
            return;
        }
        const anexoId = linkElement ? linkElement.dataset.anexoId : null;
        if (anexoId) {
            console.log('  - B√≥nus: A √¢ncora est√° dentro de um link. A passar o anexoId para o painel unificado.');
        }
        showReferencesPanel(entity.id, entityName, entityType, anexoId);
        console.groupEnd();
        return; 
    }

    // PRIORIDADE 2: Se n√£o foi numa √¢ncora, verificamos se foi num link.
    if (linkElement) {
        // ... (c√≥digo existente, n√£o precisa de ser alterado)
        console.log('%cDECIS√ÉO: Prioridade 2 - Clique em Link (sem √¢ncora). A abrir popup de visualiza√ß√£o.', 'font-weight: bold; color: #3498db;');
        event.preventDefault();
        const anexoId = linkElement.dataset.anexoId;
        openViewLinkModal(anexoId);
        console.groupEnd();
        return;
    }

    // <<<<<<< NOVO BLOCO DE C√ìDIGO PARA AS TAGS >>>>>>>>>
    // PRIORIDADE 3: Se n√£o foi √¢ncora nem link, verificamos se foi uma tag.
    if (tagElement) {
        console.log('%cDECIS√ÉO: Prioridade 3 - Clique em Tag. A pesquisar na WOL.', 'font-weight: bold; color: #2ecc71;');
        event.preventDefault(); // Prevenir qualquer outro comportamento
        
        // Extrai o nome da tag, removendo o '#' inicial
        const tagName = tagElement.textContent.replace('#', '').trim();
        
        if (tagName) {
              showTagReferencesPanel(tagName);
        }
        
        console.groupEnd();
        return;
    }

    console.log('%cDECIS√ÉO: Clique irrelevante. A ignorar.', 'color: #95a5a6;');
    console.groupEnd();
});

// ====================================================================


// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
selectionPopup.addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    const type = e.target.dataset.type;
    if (!action || !currentSelectionRange) return;

    const selection = window.getSelection();
    if (action === 'create-link') {
        console.groupCollapsed('%c[Popup de Sele√ß√£o] "Criar Link" clicado', 'color: white; background-color: #2980b9; padding: 2px 5px; border-radius: 3px;');
        const linkElement = selection.anchorNode.parentElement.closest('a[data-anexo-id]');
        console.log('  - A verificar se j√° existe um link na sele√ß√£o...', linkElement ? `Sim, ID: ${linkElement.dataset.anexoId}` : 'N√£o');
        
        if (linkElement) {
            console.log('  - A√ß√£o: Abrir modal em modo de EDI√á√ÉO.');
            openLinkModal(true, { id: linkElement.dataset.anexoId, title: linkElement.textContent, url: linkElement.href });
        } else {
            const selectedText = currentSelectionRange.toString().trim();
            console.log(`  - Texto selecionado: "${selectedText}"`);
            console.log('  - A√ß√£o: Abrir modal em modo de CRIA√á√ÉO.');
            if (!selectedText) { alert("Por favor, selecione um texto para criar um anexo."); selectionPopup.style.display = 'none'; console.groupEnd(); return; }
            openLinkModal(false, selectedText);
        }
        console.groupEnd();

    } else if (action === 'break-link') {
        const linkElement = selection.anchorNode.parentElement.closest('a[data-anexo-id]');
        if (linkElement) {
            openLinkModal(true, { id: linkElement.dataset.anexoId, title: linkElement.textContent, url: linkElement.href });
        } else {
            alert("Por favor, certifique-se de que seu cursor est√° dentro de um anexo existente.");
        }
    } else if (action === 'create-entity') {
        const selectedText = currentSelectionRange.toString().trim();
        if (!selectedText) { alert("Por favor, selecione um texto para criar uma entidade."); selectionPopup.style.display = 'none'; return; }
        openEntityModal(type, selectedText);
    }
    selectionPopup.style.display = 'none';
});
// ====================================================================

tagSuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const li = e.target.closest('li');
    if (li) {
        const selected = tagSuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitTagSelection();
    }
});

entitySuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Impede que o editor perca o foco
    const li = e.target.closest('li');
    if (li) {
        const selected = entitySuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitEntitySelection();
    }
});

// ====================================================================
// ADICIONE ESTE BLOCO DE EVENT LISTENERS NO FINAL DO SCRIPT
// ====================================================================
document.getElementById('references-toolbar').addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;

    const { id, type, name } = activeReferenceEntity;
    if (!id || !type || !name) {
        console.error("Nenhuma entidade de refer√™ncia ativa.");
        return;
    }

    switch (button.id) {
        case 'references-refresh-btn':
            // Simplesmente chama a fun√ß√£o de novo com os dados guardados
            console.log("A atualizar refer√™ncias...");
            showReferencesPanel(id, name, type);
            break;

        case 'references-search-btn':
            // Constr√≥i a URL de pesquisa e abre-a numa nova aba
            const query = encodeURIComponent(name);
            const searchUrl = `https://wol.jw.org/pt/wol/s/r5/lp-t?q=${query}`;
            window.open(searchUrl, '_blank');
            break;

        case 'references-edit-btn':
            // Abre o modal de edi√ß√£o de entidade que j√° existe
            openEditEntityModal(id, type);
            break;

        case 'references-toggle-btn':
            // Verifica se a maioria dos 'details' est√° aberta ou fechada
            const allDetails = document.querySelectorAll('#references-list details');
            if (allDetails.length === 0) return;
            
            // Conta quantos est√£o abertos
            const openCount = document.querySelectorAll('#references-list details[open]').length;
            // Se mais de metade estiver aberta, fecha todos. Sen√£o, abre todos.
            const shouldOpen = openCount <= allDetails.length / 2;
            
            allDetails.forEach(detail => {
                detail.open = shouldOpen;
            });
            break;
    }
});

// ====================================================================
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// ====================================================================
 document.getElementById('references-list').addEventListener('click', (e) => {
    const goToButton = e.target.closest('.go-to-note-btn');
    if (!goToButton) return;

    e.preventDefault(); 
    e.stopPropagation();

    const { noteId, parentId, parentName } = goToButton.dataset;
    if (!noteId) return;

    const navigateAndOpenNote = () => {
        // <<<<<<< ALTERA√á√ÉO PRINCIPAL: N√ÉO ESCONDEMOS MAIS O PAINEL >>>>>>>>>
        // hideReferencesPanel(); // Esta linha foi removida/comentada.

        // 1. Determina a pasta atual
        const currentFolderId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;

        // 2. Verifica se precisamos de mudar de pasta
        // O `parentId` do bot√£o pode ser 'undefined' se a nota estiver na raiz.
        const targetParentId = parentId || null;

        if (currentFolderId !== targetParentId) {
            // Se a nota est√° numa pasta diferente, reconstru√≠mos a navega√ß√£o
            console.log("A navegar para uma pasta diferente...");
            navigationStack = [];
            if (targetParentId && parentName) {
                navigationStack.push({ id: targetParentId, name: parentName });
            }
            updateNavigationView();
        }

        // 3. Aguarda um instante para o DOM atualizar e depois abre a nota
        setTimeout(() => {
            const noteElement = document.querySelector(`#middle-panel .list-item[data-id="${noteId}"]`);
            if (noteElement) {
                // Se a nota atual tiver altera√ß√µes, o displayNote ser√° bloqueado pelo
                // navigateWithUnsavedCheck. Precisamos de o chamar de forma diferente.
                // Como o check j√° foi feito, podemos chamar diretamente.
                displayNote(noteId, noteElement);
            } else {
                console.error("N√£o foi poss√≠vel encontrar o elemento da nota para a selecionar.");
            }
        }, 150); // Aumentei um pouco o delay para garantir a renderiza√ß√£o
    };
    
    // 4. Verifica se h√° altera√ß√µes por guardar ANTES de fazer qualquer coisa
    navigateWithUnsavedCheck(navigateAndOpenNote);
});

document.getElementById('anchors-modal').addEventListener('click', (e) => {
    const tabButton = e.target.closest('button[data-tab]');
    if (tabButton) {
        document.querySelectorAll('#anchors-tabs-container button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#anchors-content-container .tab-content').forEach(content => content.classList.remove('active'));
        tabButton.classList.add('active');
        document.getElementById(`tab-${tabButton.dataset.tab}`).classList.add('active');
        return;
    }
    const listItem = e.target.closest('li[data-entity-id]');
    if(listItem) {
        const { entityId, entityName, entityType } = listItem.dataset;
        showReferencesPanel(entityId, entityName, entityType);
        document.getElementById('anchors-modal').style.display = 'none';
    }
});

referencesPanelCloseBtn.addEventListener('click', hideReferencesPanel);


    </script>
</body>
</html>
