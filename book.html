<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Notebook Moderno</title>
   
<style>
    /* --- Reset B√°sico e Estilo Geral --- */
    :root {
        --bg-color: #1a1a1d;
        --sidebar-color: #252528;
        --panel-color: #1f1f22;
        --accent-color: #4a90e2;
        --text-color: #f0f0f0;
        --text-muted-color: #888;
        --border-color: #333;
        --hover-color: #2c2c30;
        --selected-color: #3a5370;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; height: 100vh; }

    /* --- Estrutura Principal --- */
    .notebook-container { display: flex; height: 100vh; }
    #left-panel, #middle-panel, #right-panel { height: 100%; display: flex; flex-direction: column; }
    
    #left-panel { flex: 0 0 240px; background-color: var(--sidebar-color); border-right: 1px solid var(--border-color); padding: 15px; justify-content: space-between; }
    #middle-panel { flex: 0 0 300px; background-color: var(--panel-color); border-right: 1px solid var(--border-color); padding: 20px; }
    #right-panel { flex: 1 1 auto; background-color: var(--bg-color); padding: 20px; }
    
    .panel-content { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
    #left-panel-list, #file-list { list-style-type: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }

    /* --- Pain√©is --- */
    .tabs-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
    .tabs-container button { background: none; border: none; color: var(--text-muted-color); padding: 10px; flex-grow: 1; text-align: center; font-size: 15px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .tabs-container button:hover { background-color: var(--hover-color); color: var(--text-color); }
    .tabs-container button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
    #left-panel hr { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0 15px 0; }
    
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .panel-header h2 { font-size: 18px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
    #back-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; margin-right: 10px; }
    #back-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

    .list-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s ease; display: flex; align-items: center; user-select: none; position: relative; }
    .list-item:before { font-size: 18px; margin-right: 10px; }
    .list-item[data-type="pasta"]:before { content: 'üìÅ'; }
    .list-item[data-type="nota"]:before { content: 'üìÑ'; }
    .list-item:hover { background-color: var(--hover-color); }
    .list-item.selected { background-color: var(--selected-color); }

    #add-item-btn { background: none; border: 2px solid var(--accent-color); color: var(--accent-color); width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    #add-item-btn:hover { background-color: var(--accent-color); color: white; }

    /* --- Painel Direito (Editor) --- */
    #editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted-color); text-align: center; height: 100%;}
    #editor-placeholder .placeholder-icon { font-size: 60px; margin-bottom: 20px; }
    #note-title-input { background: none; border: none; color: var(--text-color); font-size: 2.5em; font-weight: bold; padding: 10px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); outline: none; width: 100%; }
    
    /* --- Modais --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--sidebar-color); padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h3 { margin-bottom: 20px; font-size: 22px; }
    .modal-content p { margin-bottom: 20px; color: var(--text-muted-color); }
    .modal-content input[type="text"] { width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
    .modal-btn:hover { opacity: 0.9; }
    .modal-btn.primary { background-color: var(--accent-color); color: white; }
    .modal-btn.secondary { background-color: var(--hover-color); color: var(--text-color); }
    #add-item-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    #add-item-options button { background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 15px; text-align: left; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
    #add-item-options button:hover { background-color: var(--hover-color); }

    /* --- Componentes Adicionais (Menu de Contexto, Configura√ß√µes, etc.) --- */
    .panel-footer { padding-top: 10px; border-top: 1px solid var(--border-color); }
    #settings-btn { background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; width: 100%; text-align: left; padding: 5px 10px; border-radius: 5px; }
    #settings-btn:hover { background-color: var(--hover-color); }

    .item-menu-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 20px; padding: 0 8px; border-radius: 5px; cursor: pointer; display: none; }
    .list-item:hover .item-menu-btn { display: block; }
    .item-menu-btn:hover { background-color: var(--bg-color); color: var(--text-color); }

    .context-menu { position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; display: flex; flex-direction: column; padding: 5px; }
    .context-menu button { background: none; border: none; color: var(--text-color); padding: 8px 15px; text-align: left; cursor: pointer; border-radius: 4px; width: 100%; }
    .context-menu button:hover { background-color: var(--accent-color); color: white; }

    .move-list { list-style: none; max-height: 40vh; overflow-y: auto; }
    .move-list li { background-color: var(--bg-color); padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .move-list .order-controls button { background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 28px; height: 28px; cursor: pointer; border-radius: 5px; margin-left: 5px; }
    .move-list .order-controls button:hover { background-color: var(--hover-color); }
    .move-list .order-controls button:disabled { opacity: 0.3; cursor: not-allowed; }
    #hidden-items-list .item-name { opacity: 0.7; flex-grow: 1; }
    #hidden-items-list button { background-color: var(--accent-color); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    
    /* --- Estilos para o Editor Rico --- */
    #editor-toolbar {
        display: flex;
        align-items: center;
        background-color: var(--panel-color);
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    #editor-toolbar button {
        background: var(--hover-color);
        border: none;
        color: var(--text-color);
        min-width: 32px;
        height: 32px;
        padding: 0 8px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
    }
    #editor-toolbar button:hover {
        background-color: var(--accent-color);
    }
    #editor-toolbar input[type="color"] {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        cursor: pointer;
        padding: 2px;
    }
    .toolbar-separator {
        width: 1px;
        height: 25px;
        background-color: var(--border-color);
        margin: 0 10px;
    }
    .toolbar-history {
        margin-left: auto; /* Empurra para a direita */
    }

    #note-content-editor {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.1em;
        line-height: 1.6;
        outline: none;
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        padding: 5px;
    }

    /* Painel flutuante de sele√ß√£o */
    #selection-popup {
        background-color: var(--sidebar-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 5px;
        display: flex;
        gap: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #selection-popup button {
        background: none;
        border: none;
        color: var(--text-color);
        padding: 5px 8px;
        cursor: pointer;
        border-radius: 4px;
    }
    #selection-popup button:hover {
        background-color: var(--accent-color);
    }

    /* Estilos para conte√∫do especial no editor */
    .tag {
        background-color: var(--selected-color);
        color: var(--accent-color);
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
    }
    .entity-link {
        background-color: rgba(74, 144, 226, 0.2);
        border-bottom: 1px dashed var(--accent-color);
        cursor: pointer;
    }
    /* --- Estilos Espec√≠ficos para o Modal de Links --- */
    #link-modal .url-field-wrapper {
        display: flex;
        gap: 8px;
    }

    #link-modal .remove-url-btn {
        background-color: #c0392b;
        color: white;
        padding: 0;
        width: 38px;
        height: 38px;
        min-width: unset;
        flex-shrink: 0;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #add-url-btn {
        color: var(--text-color); 
        font-weight: 500;
    }

    #link-modal .modal-actions .modal-btn {
        padding: 8px 16px;
        font-size: 14px;
    }

    #confirm-modal {
        z-index: 1010; 
    }

    /* --- Estilos para o Popup de Sugest√£o de Tags/Entidades --- */
    .suggestion-popup {
        background-color: var(--sidebar-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-height: 250px;
        overflow-y: auto;
        width: 350px;
    }

    .suggestion-list {
        list-style: none;
        padding: 5px;
    }

    .suggestion-list li {
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-color);
        display: flex;
        align-items: center;
    }

    .suggestion-list li:hover, .suggestion-list li.selected {
        background-color: var(--accent-color);
        color: white;
    }

    #entity-suggestion-popup .suggestion-list li span {
        margin-left: auto;
        padding-left: 1em;
    }

    #entity-suggestion-popup .suggestion-list li:hover span,
    #entity-suggestion-popup .suggestion-list li.selected span {
        color: white !important;
    }

    /* --- ESTILOS PARA O PAINEL COLAPSADO --- */
    #left-panel-toggle-btn {
        display: none;
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        width: 32px;
        height: 32px;
        border-radius: 5px;
        font-size: 20px;
        cursor: pointer;
        margin: 15px auto;
    }
    #left-panel-toggle-btn:hover {
        background-color: var(--accent-color);
    }

    #left-panel {
        transition: flex 0.3s ease-in-out;
    }

    .notebook-container.left-panel-collapsed #left-panel {
        flex: 0 0 60px;
        padding: 0;
    }
    .notebook-container.left-panel-collapsed #left-panel .panel-content,
    .notebook-container.left-panel-collapsed #left-panel .panel-footer {
        display: none;
    }
    .notebook-container.left-panel-collapsed #left-panel #left-panel-toggle-btn {
        display: block;
    }
    
    /* --- ESTILOS PARA O PAINEL DE REFER√äNCIAS (QUARTA COLUNA) --- */
    #references-panel {
        flex: 0 0 0px;
        background-color: var(--sidebar-color);
        border-left: 1px solid var(--border-color);
        padding: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: flex 0.3s ease-in-out;
        overflow: hidden;
    }

    #references-panel-close-btn {
        background: none;
        border: none;
        color: var(--text-muted-color);
        font-size: 24px;
        cursor: pointer;
    }
    #references-list {
        list-style-type: none;
        overflow-y: auto;
        flex-grow: 1;
    }
    #references-list li {
        padding: 12px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 5px;
        border-bottom: 1px solid var(--border-color);
    }
    #references-list li:hover {
        background-color: var(--hover-color);
    }

    .notebook-container.references-panel-visible #references-panel {
        flex: 0 0 300px;
    }

    /* --- ESTILOS PARA O MODAL DE √ÇNCORAS --- */
    #anchors-content-container .tab-content {
        display: none;
        max-height: 50vh;
        overflow-y: auto;
    }
    #anchors-content-container .tab-content.active {
        display: block;
    }
    #anchors-content-container ul {
        list-style-type: none;
    }
    #anchors-content-container li {
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
    }
    #anchors-content-container li:hover {
        background-color: var(--hover-color);
    }

    #anchors-content-container li.is-on-page {
        background-color: #27ae60;
        color: white;
    }
    #anchors-content-container li.is-on-page:hover {
        background-color: #2ecc71;
    }

    .entity-edit-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted-color);
        font-size: 22px;
        line-height: 1;
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
        display: none;
    }

    #anchors-content-container li:hover .entity-edit-btn {
        display: block;
    }

    .entity-edit-btn:hover {
        background-color: var(--hover-color);
        color: var(--text-color);
    }

    #references-panel-description {
        font-size: 0.9em;
        color: var(--text-muted-color);
        margin-bottom: 20px;
        padding: 0 5px;
        line-height: 1.5;
        font-style: italic;
        border-left: 3px solid var(--accent-color);
        padding-left: 10px;
    }

    #references-list details.reference-item {
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 5px;
        border-bottom: 1px solid var(--border-color);
    }

    #references-list details.reference-item[open] {
        background-color: var(--hover-color);
    }

    #references-list summary {
        cursor: pointer;
        font-weight: 500;
        list-style: none;
    }
    #references-list summary::-webkit-details-marker {
        display: none;
    }

    #references-list summary:hover {
        color: var(--accent-color);
    }

    .reference-context {
        margin-top: 10px;
        padding-left: 15px;
        border-left: 2px solid var(--accent-color);
        color: var(--text-muted-color);
        font-size: 0.9em;
        line-height: 1.5;
    }

    .reference-context mark {
        background-color: rgba(74, 144, 226, 0.4);
        color: var(--text-color);
        border-radius: 3px;
        padding: 1px 3px;
    }

    .toolbar-history {
        display: flex;
        align-items: center;
    }

    .save-status {
        font-size: 0.8em;
        color: var(--text-muted-color);
        margin-right: 15px;
        transition: all 0.3s ease;
        font-style: italic;
        font-weight: 500;
    }

    .save-status.status-saved {
        color: #27ae60;
    }

    .save-status.status-error {
        color: #c0392b;
    }

    #connectivity-status {
        display: none;
        color: #e74c3c;
        font-weight: bold;
        margin-right: 15px;
        font-size: 0.8em;
        animation: blink 1.5s linear infinite;
    }

    #connectivity-status.visible {
        display: inline;
    }

    @keyframes blink {
        50% { opacity: 0.5; }
    }

    /* --- Estilos Modernos para a Barra de Scroll --- */
    * {
        scrollbar-width: thin;
        scrollbar-color: var(--text-muted-color) var(--panel-color);
    }

    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    ::-webkit-scrollbar-track {
        background: var(--panel-color);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background-color: var(--text-muted-color);
        border-radius: 10px;
        border: 2px solid var(--panel-color);
    }

    ::-webkit-scrollbar-thumb:hover {
        background-color: #a0a0a0;
    }
</style>

</head>
<body>

    <div class="notebook-container">
        <!-- PAINEL DA ESQUERDA -->
        <aside id="left-panel">
            <button id="left-panel-toggle-btn" title="Mostrar Painel">‚ò∞</button>
            <div class="panel-content">
                <div class="tabs-container">
                    <button class="active" data-tab="note">Note</button>
                    <button data-tab="lists">Lists</button>
                    <button data-tab="book">Book</button>
                </div>
                <hr>
                <div class="panel-header">
                    <h2 id="left-panel-title">Pastas</h2>
                </div>
                <ul id="left-panel-list">
                    <!-- Itens da coluna esquerda -->
                </ul>
            </div>
            <div class="panel-footer">
                <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
            </div>
        </aside>

        <!-- PAINEL DO MEIO -->
        <main id="middle-panel">
            <div class="panel-header">
                <button id="back-btn" title="Voltar">‚Üê</button>
                <h2 id="middle-panel-title">Selecione uma pasta</h2>
                <button id="add-item-btn" title="Adicionar item">+</button>
            </div>
            <ul id="file-list">
                 <!-- Itens da coluna do meio -->
            </ul>
        </main>

        <!-- PAINEL DA DIREITA - EDITOR -->
        <section id="right-panel">
            <div id="editor-placeholder">
                <div class="placeholder-icon">üìñ</div>
                <h2>Selecione uma nota para come√ßar</h2>
                <p>Ou crie uma nova pasta e uma nota.</p>
            </div>
            <div id="editor-area" style="display: none; flex-direction: column; height: 100%;">
                <input type="text" id="note-title-input" placeholder="T√≠tulo da nota...">
                
                <div id="editor-toolbar">
                    <div class="toolbar-group">
                        <button data-command="increaseFontSize" title="Aumentar Zoom">A+</button>
                        <button data-command="decreaseFontSize" title="Diminuir Zoom">A-</button>
                        <button data-command="bold" title="Negrito"><b>B</b></button>
                        <button data-command="italic" title="It√°lico"><i>I</i></button>
                        <button data-command="underline" title="Sublinhado"><u>U</u></button>
                        <input type="color" data-command="foreColor" title="Cor do Texto">
                    </div>
                    <div class="toolbar-separator"></div>
                    <div class="toolbar-group">
                        <button data-action="show-tags" title="Tags"># Tags</button>
                        <button data-action="show-attachments" title="Anexos">üìé Anexos</button>
                        <button data-action="show-anchors" title="√Çncoras">‚öì √Çncoras</button>
                    </div>
                    <div class="toolbar-history">
                        <span id="save-status-indicator" class="save-status"></span>
                        <button data-action="show-history" title="Hist√≥rico de Vers√µes">üïí</button>
                    </div>
                </div>

                <div id="note-content-editor" contenteditable="true" spellcheck="false"></div>
            </div>
        </section>

        <!-- PAINEL DA DIREITA (QUARTA COLUNA) PARA REFER√äNCIAS -->
      <aside id="references-panel">
    <div class="panel-header">
        <h2 id="references-panel-title">Refer√™ncias</h2>
        <button id="references-panel-close-btn" title="Fechar">√ó</button>
    </div>
    
    <!-- NOVO ELEMENTO PARA A DESCRI√á√ÉO -->
    <p id="references-panel-description"></p>
    
    <ul id="references-list">
        <!-- A lista de refer√™ncias ser√° preenchida via JS -->
    </ul>
</aside>
    </div>

    <!-- PAINEL FLUTUANTE DE SELE√á√ÉO DE TEXTO (escondido) -->
    <div id="selection-popup" style="display: none; position: absolute; z-index: 1010;">
        <button data-action="create-link">üîó Link</button>
        <button data-action="break-link">üíî Quebrar Link</button>
        <button data-action="create-entity" data-type="local">üìç Local</button>
        <button data-action="create-entity" data-type="personagem">üë§ Personagem</button>
        <button data-action="create-entity" data-type="data">üìÖ Data</button>
        <button data-action="create-entity" data-type="textobiblico">üìñ Texto B√≠blico</button>
    </div>

    <!-- MODAL PARA ADICIONAR ITENS -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Adicionar Item</h3>
            <div id="add-item-options">
                 <button data-type="pasta">üìÅ Criar Pasta</button>
                 <button data-type="nota">üìÑ Criar Nota</button>
            </div>
            <input type="text" id="new-item-name" placeholder="Nome do item" style="display: none;">
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-item-addition" style="display: none;">Criar</button>
            </div>
        </div>
    </div>

    <!-- MENU DE CONTEXTO (3 PONTOS) - Fica escondido -->
    <div id="context-menu" class="context-menu" style="display: none;">
        <button data-action="rename">Mudar Nome</button>
        <button data-action="move">Mover</button>
        <button data-action="hide">Ocultar</button>
    </div>

    <!-- MODAL PARA MOVER ITENS -->
    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover Item</h3>
            <ul id="move-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="save-order">Salvar Ordem</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO GEN√âRICO -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title">Voc√™ tem certeza?</h3>
            <p id="confirm-message">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="confirm">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIGURA√á√ïES -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Configura√ß√µes</h3>
            <button class="modal-btn primary" data-action="show-hidden-items" style="width: 100%;">Ver Pastas Ocultas</button>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE ITENS OCULTOS -->
    <div id="hidden-items-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Itens Ocultos</h3>
            <ul id="hidden-items-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR/EDITAR LINK (ANEXO) -->
   <div id="link-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="link-modal-title">Criar Anexo</h3>
            <input type="text" id="link-title-input" placeholder="T√≠tulo do anexo">
            <div id="link-urls-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; margin-top: 15px;">
                <!-- Campos de URL ser√£o adicionados aqui dinamicamente via JS -->
            </div>
            <button id="add-url-btn" class="modal-btn" style="width: 100%; margin-bottom: 20px; background-color: var(--hover-color); text-align: center;">
                + Adicionar URL
            </button>
            <div class="modal-actions">
                <button class="modal-btn" id="link-remove-btn" style="background-color: #c0392b; color: white; display: none; margin-right: auto;">Remover Anexo</button>
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="link-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR ENTIDADE (Local, Personagem, Data) -->
    <div id="entity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="entity-modal-title">Criar Entidade</h3>
            <input type="text" id="entity-name-input" placeholder="Nome">
            <textarea id="entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 80px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
            <p id="entity-error-message" style="color: #e74c3c; display: none;">J√° existe uma entidade com este nome.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="entity-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA LISTAS (Tags, Anexos, etc.) -->
    <div id="generic-list-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="generic-list-title">Lista</h3>
            <ul id="generic-list-content" class="move-list" style="max-height: 60vh;">
                <!-- O conte√∫do ser√° preenchido via JavaScript -->
            </ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE √ÇNCORAS COM ABAS -->
    <div id="anchors-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Explorador de Entidades</h3>
            <div id="anchors-tabs-container" class="tabs-container" style="margin-bottom: 20px;">
                <!-- As abas ser√£o geradas via JS -->
            </div>
            <div id="anchors-content-container">
                <!-- O conte√∫do das abas ser√° gerado via JS -->
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA EDITAR ENTIDADE -->
<div id="edit-entity-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="edit-entity-title">Editar Entidade</h3>
        <input type="text" id="edit-entity-name-input" placeholder="Nome da entidade">
        <textarea id="edit-entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 120px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="edit-entity-save-btn">Gravar Altera√ß√µes</button>
        </div>
    </div>
</div>


    <!-- POPUP DE SUGEST√ÉO DE TAGS (escondido por padr√£o) -->
<div id="tag-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="tag-suggestion-list" class="suggestion-list"></ul>
</div>

<!-- POPUP DE SUGEST√ÉO DE ENTIDADES (escondido por padr√£o) -->
<div id="entity-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="entity-suggestion-list" class="suggestion-list"></ul>
</div>


<!-- MODAL DE HIST√ìRICO E BACKUP (NOVO) -->
<div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="history-modal-title">Hist√≥rico da Nota</h3>
        <p>Crie um ponto de restauro ou restaure uma vers√£o anterior. A restaura√ß√£o cria uma <strong>nova nota</strong> com o conte√∫do do backup.</p>
        
        <button id="backup-now-btn" class="modal-btn primary" style="width: 100%; margin: 20px 0;">
            Fazer backup do estado atual
        </button>

        <h4>Backups existentes:</h4>
        <ul id="history-list-content" class="move-list" style="max-height: 40vh; margin-top: 10px;">
            <!-- A lista de backups ser√° preenchida via JS -->
            <li>Nenhum backup encontrado.</li>
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER O CONTE√öDO DO BACKUP (NOVO) -->
<div id="view-backup-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 80vw; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="view-backup-title">Visualizando Backup</h3>
        <div id="view-backup-content" style="background-color: var(--bg-color); padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            <!-- Conte√∫do do backup aqui -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>



</body>


    <script type="module">
    
   import { db } from './js/firebase-config.js';
import { 
    collection, query, where, addDoc, serverTimestamp, onSnapshot, 
    doc, getDoc, updateDoc, orderBy, getDocs, writeBatch, deleteField, deleteDoc // <-- ADD THIS
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

document.addEventListener('DOMContentLoaded', () => {
    updateNavigationView();
    fetchAllEntities();
    fetchAllTags();
    checkInitialConnection(); // Verifica a conex√£o ao carregar
});

// --- REFER√äNCIAS AO DOM ---
const notebookContainer = document.querySelector('.notebook-container');
const leftPanelToggleBtn = document.getElementById('left-panel-toggle-btn');
const referencesPanel = document.getElementById('references-panel');
const referencesPanelTitle = document.getElementById('references-panel-title');
const referencesList = document.getElementById('references-list');
const referencesPanelCloseBtn = document.getElementById('references-panel-close-btn');
const leftPanelList = document.getElementById('left-panel-list');
const leftPanelTitle = document.getElementById('left-panel-title');
const middlePanelList = document.getElementById('file-list');
const middlePanelTitle = document.getElementById('middle-panel-title');
const backBtn = document.getElementById('back-btn');
const addItemBtn = document.getElementById('add-item-btn');
const editorPlaceholder = document.getElementById('editor-placeholder');
const editorArea = document.getElementById('editor-area');
const noteTitleInput = document.getElementById('note-title-input');
const newItemNameInput = document.getElementById('new-item-name');
const editorToolbar = document.getElementById('editor-toolbar');
const noteContentEditor = document.getElementById('note-content-editor');
const selectionPopup = document.getElementById('selection-popup');
const tagSuggestionPopup = document.getElementById('tag-suggestion-popup');
const tagSuggestionList = document.getElementById('tag-suggestion-list');
const saveStatusIndicator = document.getElementById('save-status-indicator');
const connectivityStatus = document.getElementById('connectivity-status');
const entitySuggestionPopup = document.getElementById('entity-suggestion-popup');
const entitySuggestionList = document.getElementById('entity-suggestion-list');
const debouncedScanAndLink = debounce(scanAndLinkEntities, 2000);
const ENTITY_CONFIG = {
    personagem: {
        collection: 'personagens',
        displayName: 'Personagens'
    },
    local: {
        collection: 'locais',
        displayName: 'Locais'
    },
    data: {
        collection: 'datas',
        displayName: 'Datas'
    },
    textobiblico: {
        collection: 'textosbiblicos',
        displayName: 'Textos B√≠blicos'
    }
};
const BIBLICAL_BOOKS = [
    'G√©nesis', '√äxodo', 'Lev√≠tico', 'N√∫meros', 'Deuteron√≥mio', 'Josu√©', 'Ju√≠zes', 'Rute', 
    '1 Samuel', '2 Samuel', '1 Reis', '2 Reis', '1 Cr√≥nicas', '2 Cr√≥nicas', 'Esdras', 'Neemias', 'Ester', 
    'J√≥', 'Salmos', 'Prov√©rbios', 'Eclesiastes', 'C√¢ntico de Salom√£o', 'Isa√≠as', 'Jeremias', 'Lamenta√ß√µes', 
    'Ezequiel', 'Daniel', 'Oseias', 'Joel', 'Am√≥s', 'Obadias', 'Jonas', 'Miqueias', 'Naum', 'Habacuque', 
    'Sofonias', 'Ageu', 'Zacarias', 'Malaquias', 'Mateus', 'Marcos', 'Lucas', 'Jo√£o', 'Atos', 'Romanos', 
    '1 Cor√≠ntios', '2 Cor√≠ntios', 'G√°latas', 'Ef√©sios', 'Filipenses', 'Colossenses', 
    '1 Tessalonicenses', '2 Tessalonicenses', '1 Tim√≥teo', '2 Tim√≥teo', 'Tito', 'Fil√©mom', 'Hebreus', 
    'Tiago', '1 Pedro', '2 Pedro', '1 Jo√£o', '2 Jo√£o', '3 Jo√£o', 'Judas', 'Apocalipse'
];

// --- ESTADO DA APLICA√á√ÉO ---
let allEntities = {};
let navigationStack = [];
let selectedNoteId = null;
let unsubscribeLeftPanel = null;
let unsubscribeMiddlePanel = null;
let saveTimeout = null;
let activeItemContext = null;
let currentSelectionRange = null;
let allTags = [];
let isTagPopupOpen = false;
let currentTagQueryRange = null;
let currentSaveStatus = 'hidden';
let isEntityPopupOpen = false;
let currentEntityQueryRange = null;


// --- GEST√ÉO DE ESTADO E CONECTIVIDADE ---

/**
 * Atualiza o indicador visual de estado de grava√ß√£o.
 * @param {'unsaved' | 'saving' | 'saved' | 'error' | 'hidden'} status O estado a ser exibido.
 */
function updateSaveStatus(status) {
    currentSaveStatus = status;
    if (!saveStatusIndicator) return;

    saveStatusIndicator.classList.remove('status-saved', 'status-error');
    switch (status) {
        case 'unsaved':
            saveStatusIndicator.textContent = 'Altera√ß√µes por guardar...';
            break;
        case 'saving':
            saveStatusIndicator.textContent = 'A guardar...';
            break;
        case 'saved':
            saveStatusIndicator.textContent = 'Guardado';
            saveStatusIndicator.classList.add('status-saved');
            break;
        case 'error':
            saveStatusIndicator.textContent = 'Erro ao guardar';
            saveStatusIndicator.classList.add('status-error');
            break;
        case 'hidden':
        default:
            saveStatusIndicator.textContent = '';
            break;
    }
}

function handleOffline() {
    connectivityStatus.textContent = 'Sem liga√ß√£o';
    connectivityStatus.classList.add('visible');
    updateSaveStatus('error'); 
    saveStatusIndicator.textContent = 'Offline - Altera√ß√µes n√£o guardadas';
}

function handleOnline() {
    connectivityStatus.classList.remove('visible');
    updateSaveStatus('saving');
    clearTimeout(saveTimeout);
    saveNote();
}

function checkInitialConnection() {
    if (!navigator.onLine) {
        handleOffline();
    }
}

/**
 * Verifica se existem altera√ß√µes n√£o guardadas antes de executar uma a√ß√£o de navega√ß√£o.
 * @param {function} navigationAction A fun√ß√£o a ser executada se a navega√ß√£o for confirmada.
 */
async function navigateWithUnsavedCheck(navigationAction) {
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        const confirmed = await showConfirmation(
            'Altera√ß√µes n√£o guardadas',
            'Voc√™ tem altera√ß√µes que ainda n√£o foram guardadas. Tem a certeza que quer sair?'
        );

        if (confirmed) {
            navigationAction();
        }
    } else {
        navigationAction();
    }
}

// --- L√ìGICA PRINCIPAL DA APLICA√á√ÉO ---

async function validateAndCleanupBiblicalLinks() {
    console.log('%cFASE 0: Iniciando limpeza de links b√≠blicos...', 'color: #e67e22; font-weight: bold;');
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    // ALTERADO: Regex de valida√ß√£o agora √© muito mais estrita.
    // Exige o formato "Livro C:V" e nada mais.
    const validPattern = new RegExp(`^(${biblicalBooksPattern})\\s+\\d+:\\d+$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    let domChanged = false;

    for (const link of links) {
        const currentText = link.textContent.trim();
        const originalName = link.dataset.entityName;

       if (!validPattern.test(currentText)) {
            console.log(`%cLink inv√°lido encontrado: "${currentText}". Revertendo para texto.`, 'color: #c0392b;');
            
            // ==========================================================
            // PARTE 1: COLOCAR O MARCADOR ANTES DE DESTRUIR O LINK
            // ==========================================================
            const selection = window.getSelection();
            let markerNode = null; // Usaremos isto para encontrar o marcador depois

            // S√≥ colocamos o marcador se o cursor estiver dentro do link que vamos remover
            if (selection && selection.rangeCount > 0 && link.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0).cloneRange();
                markerNode = document.createElement('span');
                markerNode.id = 'cursor-marker'; // A nossa "bandeira"
                range.insertNode(markerNode);
            }
            // ==========================================================

            const textNode = document.createTextNode(link.textContent);
            link.parentNode.replaceChild(textNode, link);
            domChanged = true;

            // Aciona a limpeza da refer√™ncia na base de dados
            await cleanupBiblicalEntityReference(originalName);

            // =========================================================================
            // PARTE 2: RESTAURAR O CURSOR USANDO O MARCADOR E DEPOIS REMOV√ä-LO
            // =========================================================================
            if (markerNode && document.body.contains(markerNode)) {
                const newRange = document.createRange();
                newRange.setStartBefore(markerNode); // P√µe o cursor antes da "bandeira"
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                markerNode.parentNode.removeChild(markerNode); // Remove a "bandeira"
            }
            // N√£o precisamos de um "else" aqui, porque se o cursor n√£o estava no link,
            // n√£o queremos mov√™-lo de todo.
            // =========================================================================
        }
    }

    if (domChanged) {
        console.log('FASE 0: DOM alterado durante a limpeza.');
    }
    
    return domChanged;
}

/**
 * Remove a refer√™ncia de uma nota a uma entidade de texto b√≠blico.
 * Se for a √∫ltima refer√™ncia, apaga a pr√≥pria entidade.
 * @param {string} entityName O nome da entidade de texto b√≠blico (ex: "Daniel 4:3")
 */
async function cleanupBiblicalEntityReference(entityName) {
    if (!selectedNoteId || !entityName) return;

    const collectionRef = collection(db, 'textosbiblicos');
    const q = query(collectionRef, where("nome", "==", entityName));
    
    try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            console.log(`Nenhuma entidade encontrada para "${entityName}". Nenhuma a√ß√£o necess√°ria.`);
            return;
        }

        const entityDoc = snapshot.docs[0];
        const entityRef = entityDoc.ref;
        const entityData = entityDoc.data();
        const references = entityData.referencias || {};
        
        // Verifica se a nota atual est√° nas refer√™ncias
        if (references[selectedNoteId]) {
            const numReferences = Object.keys(references).length;

            if (numReferences === 1) {
                // √â a √∫ltima refer√™ncia, apagar o documento inteiro
                console.log(`√öltima refer√™ncia para "${entityName}". A apagar o documento...`);
                await deleteDoc(entityRef);
            } else {
                // Existem outras refer√™ncias, remover apenas a atual
                console.log(`A remover refer√™ncia da nota atual para "${entityName}"...`);
                await updateDoc(entityRef, {
                    [`referencias.${selectedNoteId}`]: deleteField()
                });
            }
            
            // Atualiza o cache de entidades local
            await fetchAllEntities();
        }

    } catch (error) {
        console.error(`Erro ao limpar a refer√™ncia para "${entityName}":`, error);
    }
}

async function fetchAllEntities() {
    allEntities = {}; 
    for (const type in ENTITY_CONFIG) {
        const config = ENTITY_CONFIG[type];
        const collectionName = config.collection;
        try {
            const q = query(collection(db, collectionName));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                allEntities[type] = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    nome: doc.data().nome,
                    tipo: type 
                }));
            }
        } catch (error) {
            console.error(`Erro ao carregar a cole√ß√£o ${collectionName}:`, error);
        }
    }
}

function resetEditor() {
    selectedNoteId = null;
    editorArea.style.display = 'none';
    editorPlaceholder.style.display = 'flex';
    document.querySelectorAll('#middle-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    updateSaveStatus('hidden');
}

function fetchAndDisplayItems(parentId, listElement, selectedId = null) {
    const itemsRef = collection(db, 'pastas');
    const q = query(itemsRef, where('parentId', '==', parentId), where('estado', '==', 'ativa'), orderBy('ordem'));

    return onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            li.dataset.id = item.id;
            li.dataset.type = item.tipo;
            li.dataset.name = item.nome;
            li.dataset.parentid = item.parentId || 'null';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = item.nome;
            const menuBtn = document.createElement('button');
            menuBtn.className = 'item-menu-btn';
            menuBtn.innerHTML = '‚Ä¶';
            
            li.appendChild(nameSpan);
            li.appendChild(menuBtn);

            if (item.id === selectedId) li.classList.add('selected');
            listElement.appendChild(li);
        });
    });
}

function updateNavigationView() {
    notebookContainer.classList.remove('left-panel-collapsed');

    if (unsubscribeLeftPanel) unsubscribeLeftPanel();
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();
    resetEditor();

    const depth = navigationStack.length;
    let leftPanelParentId = null, middlePanelParentId = null, leftPanelSelectedId = null;

    if (depth === 0) {
        leftPanelTitle.textContent = 'Pastas';
        middlePanelTitle.textContent = 'Selecione uma pasta';
        backBtn.style.display = 'none';
        leftPanelParentId = null;
        middlePanelList.innerHTML = '';
    } else {
        const currentFolder = navigationStack[depth - 1];
        middlePanelParentId = currentFolder.id;
        middlePanelTitle.textContent = currentFolder.name;
        backBtn.style.display = 'flex';
        if (depth > 1) {
            const parentFolder = navigationStack[depth - 2];
            leftPanelParentId = parentFolder.id;
            leftPanelTitle.textContent = parentFolder.name;
            leftPanelSelectedId = currentFolder.id;
        } else {
            leftPanelParentId = null;
            leftPanelTitle.textContent = 'Pastas';
            leftPanelSelectedId = currentFolder.id;
        }
    }
    
    unsubscribeLeftPanel = fetchAndDisplayItems(leftPanelParentId, leftPanelList, leftPanelSelectedId);
    if (middlePanelParentId) {
        unsubscribeMiddlePanel = fetchAndDisplayItems(middlePanelParentId, middlePanelList, null);
    }
}

async function displayNote(noteId, noteElement) {
    document.querySelectorAll('#middle-panel .list-item.selected').forEach(el => el.classList.remove('selected'));
    if (noteElement) noteElement.classList.add('selected');
    selectedNoteId = noteId;
    editorPlaceholder.style.display = 'none';
    editorArea.style.display = 'flex';
    
    const noteSnap = await getDoc(doc(db, 'pastas', noteId));
    if (noteSnap.exists()) {
        const { nome, conteudo } = noteSnap.data();
        noteTitleInput.value = nome || '';
        noteContentEditor.innerHTML = conteudo || '';

        setTimeout(() => {
            scanAndLinkEntities();
        }, 0);
    }
    
    notebookContainer.classList.add('left-panel-collapsed');
    updateSaveStatus('saved');
}

function saveNote() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        if (!selectedNoteId) return;

        updateSaveStatus('saving');

        try {
            const noteRef = doc(db, 'pastas', selectedNoteId);
            const noteSnap = await getDoc(noteRef);
            if (noteSnap.exists()) {
                const noteData = noteSnap.data();
                if (noteData.anexos) {
                    const anexosNoDb = noteData.anexos;
                    const idsNoDb = Object.keys(anexosNoDb);
                    const linksNoEditor = noteContentEditor.querySelectorAll('a[data-anexo-id]');
                    const idsNoEditor = new Set();
                    linksNoEditor.forEach(link => idsNoEditor.add(link.dataset.anexoId));
                    const idsParaRemover = idsNoDb.filter(id => !idsNoEditor.has(id));
                    if (idsParaRemover.length > 0) {
                        const updates = {};
                        idsParaRemover.forEach(id => {
                            updates[`anexosocultos.${id}`] = anexosNoDb[id];
                            updates[`anexos.${id}`] = deleteField();
                        });
                        await updateDoc(noteRef, updates);
                    }
                }
                const previousTagNames = new Set(noteData.tags || []);
                const tagSpansInEditor = noteContentEditor.querySelectorAll('span.tag');
                const currentTagNames = new Set();
                tagSpansInEditor.forEach(span => {
                    currentTagNames.add(span.textContent.substring(1));
                });
                const tagsToAdd = [...currentTagNames].filter(name => !previousTagNames.has(name));
                const tagsToRemove = [...previousTagNames].filter(name => !currentTagNames.has(name));
                for (const tagName of tagsToAdd) {
                    await updateTagLink(tagName, selectedNoteId, true);
                }
                for (const tagName of tagsToRemove) {
                    await updateTagLink(tagName, selectedNoteId, false);
                }
            }
            
            const finalTagNames = Array.from(noteContentEditor.querySelectorAll('span.tag')).map(span => span.textContent.substring(1));
            await updateDoc(doc(db, 'pastas', selectedNoteId), { 
                nome: noteTitleInput.value, 
                conteudo: noteContentEditor.innerHTML,
                tags: finalTagNames,
                ultimaedicao: serverTimestamp()
            });

            const listItem = document.querySelector(`.list-item[data-id="${selectedNoteId}"] span`);
            if (listItem) listItem.textContent = noteTitleInput.value;
            
            updateSaveStatus('saved');

        } catch (error) {
            console.error("Erro ao guardar a nota:", error);
            updateSaveStatus('error');
        }
    }, 2000);
}













function revertPrematureLinks(selection) {
    let domChanged = false;
    const potentialLinks = noteContentEditor.querySelectorAll('.entity-link');

    for (const span of potentialLinks) {
        const entityName = span.dataset.entityName;
        const isPotentialBook = BIBLICAL_BOOKS.some(b => entityName.toLowerCase().startsWith(b.toLowerCase()));
        
        if (!isPotentialBook) continue;

        let nextSignificantNode = null;
        let nodesToMerge = []; 
        let currentNode = span.nextSibling;

        while (currentNode) {
            if (currentNode.nodeType === Node.TEXT_NODE && currentNode.textContent.trim() === '') {
                nodesToMerge.push(currentNode);
                currentNode = currentNode.nextSibling;
            } else {
                nextSignificantNode = currentNode;
                break;
            }
        }

        if (nextSignificantNode && nextSignificantNode.nodeType === Node.TEXT_NODE) {
            const nextText = nextSignificantNode.textContent;
            const biblicalPatternRegex = /^\s*\u200B?:?\s*[,;]?\s*\d/;

            if (biblicalPatternRegex.test(nextText)) {
                let combinedText = span.textContent;
                nodesToMerge.forEach(node => combinedText += node.textContent);
                combinedText += nextSignificantNode.textContent;
                
                const newTextNode = document.createTextNode(combinedText);
                const parent = span.parentNode;
                
                parent.replaceChild(newTextNode, span);
                nodesToMerge.forEach(node => parent.removeChild(node));
                parent.removeChild(nextSignificantNode);
                
                const newRange = document.createRange();
                newRange.setStart(newTextNode, newTextNode.textContent.length);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                
                domChanged = true;
                break; 
            }
        }
    }
    return domChanged;
}

function logCursorState(label) {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) {
        return;
    }
    const range = selection.getRangeAt(0);
}


function validateAndCleanBiblicalLinks() {
    console.log('%cFASE 0: Iniciando limpeza de links b√≠blicos...', 'color: #e67e22; font-weight: bold;');
    
    const biblicalBooksPattern = `${BIBLICAL_BOOKS.join('|')}`;

    // =======================================================
    // AQUI ESTAVA O ERRO PERSISTENTE - ESTA √â A REGEX CORRETA E RIGOROSA
    // =======================================================
    const validPattern = new RegExp(`^${biblicalBooksPattern}\\s+\\d+:\\d[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    
    console.log(`FASE 0: Encontrados ${links.length} links b√≠blicos para validar.`);

    let domChanged = false;

    links.forEach((link, index) => {
        const originalText = link.textContent;
        const trimmedText = originalText.trim();
        
        console.log(`FASE 0: Verificando Link #${index + 1}: "${originalText}" (limpo: "${trimmedText}")`);

        if (!validPattern.test(trimmedText)) {
            console.log(`%cFASE 0: INV√ÅLIDO! O texto "${trimmedText}" n√£o corresponde ao padr√£o. Revertendo para texto simples.`, 'color: #c0392b; font-weight: bold;');
            
            const textNode = document.createTextNode(originalText);
            link.parentNode.replaceChild(textNode, link);

            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(textNode, textNode.length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            domChanged = true;
        } else {
            console.log(`%cFASE 0: V√ÅLIDO. O link "${trimmedText}" ser√° mantido.`, 'color: #27ae60;');
        }
    });

    if (domChanged) {
        console.log('FASE 0: A limpeza alterou o DOM.');
    } else {
        console.log('FASE 0: Nenhum link inv√°lido encontrado. Nenhuma altera√ß√£o feita.');
    }
    
    return domChanged;
}



/**
 * Percorre o editor para remover caracteres invis√≠veis (como o Zero-Width Space)
 * que podem ter sido deixados por outras opera√ß√µes, garantindo que a l√≥gica de 
 * reconhecimento de entidades funcione em texto limpo.
 * A posi√ß√£o do cursor √© cuidadosamente preservada.
 */
function cleanupInvisibleCharacters() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) return;

    // Salva a posi√ß√£o original do cursor
    const originalRange = selection.getRangeAt(0);
    let originalContainer = originalRange.startContainer;
    let originalOffset = originalRange.startOffset;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        nodesToProcess.push(node);
    }
    
    const ZWSP = /\u200B/g; // Regex para o caractere invis√≠vel (Zero-Width Space)

    for (const textNode of nodesToProcess) {
        if (ZWSP.test(textNode.textContent)) {
            // Se o cursor estiver neste n√≥, ajustamos a sua posi√ß√£o futura
            if (textNode === originalContainer) {
                // Conta quantos caracteres invis√≠veis existem ANTES da posi√ß√£o do cursor
                const charsToRemoveBeforeCursor = (textNode.textContent.substring(0, originalOffset).match(ZWSP) || []).length;
                originalOffset -= charsToRemoveBeforeCursor;
            }
            // Remove todos os caracteres invis√≠veis do n√≥ de texto
            textNode.textContent = textNode.textContent.replace(ZWSP, '');
        }
    }

    // Normaliza o editor para juntar n√≥s de texto que possam ter sido separados
    noteContentEditor.normalize();

    // Restaura a posi√ß√£o do cursor, garantindo que o n√≥ ainda existe
    try {
        const newRange = document.createRange();
        // Verifica se o container original ainda faz parte do documento
        if (document.body.contains(originalContainer)) {
             // Garante que a posi√ß√£o n√£o exceda o novo comprimento do texto
            const newOffset = Math.min(originalOffset, originalContainer.textContent.length);
            newRange.setStart(originalContainer, newOffset);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
        }
    } catch (e) {
        console.error("Erro ao restaurar a posi√ß√£o do cursor ap√≥s a limpeza:", e);
    }
}




 // ===================================================================
// FUN√á√ÉO SCANANDLINKENTITIES - VERS√ÉO COM REGEX CORRIGIDA
// ===================================================================
  async function scanAndLinkEntities() {
    console.log('%c--- Iniciando verifica√ß√£o com L√ìGICA ROBUSTA ---', 'color: #1abc9c; font-weight: bold;');

    cleanupInvisibleCharacters();
    noteContentEditor.normalize(); 
    
     const hasCleanedLinks = await validateAndCleanupBiblicalLinks();
    if (hasCleanedLinks) {
        updateSaveStatus('unsaved');
        saveNote(); 
        return; 
    }

    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
        return;
    }

    const originalRange = selection.getRangeAt(0).cloneRange();
    console.log('%cLOG CURSOR (Antes da verifica√ß√£o):', 'color: #f39c12; font-weight: bold;');
    try {
        console.log(`  -> N√≥ de Texto: "${originalRange.startContainer.textContent}" | Posi√ß√£o: ${originalRange.startOffset}`);
    } catch (e) {
        console.log('  -> (Cursor n√£o est√° num n√≥ de texto)');
    }

    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    let domModified = false;
    const newBiblicalEntitiesToCreate = new Map();
    const allExistingEntities = Object.values(allEntities).flat();

    // --- FASE 1: Converter Linguagem Natural ---
    const naturalLanguageRegex = new RegExp(`\\b(${biblicalBooksPattern})\\s+cap√≠tulo\\s+(\\d+)\\s+(e|,)\\s+vers√≠culo\\s+(\\d+)\\b`, 'gi');
    let walkerPass1 = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT, null, false);
    let nodesToProcess1 = [];
    let node; 
    while (node = walkerPass1.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) nodesToProcess1.push(node);
    }
    for (const textNode of nodesToProcess1) {
        if (naturalLanguageRegex.test(textNode.textContent)) {
            domModified = true;
            let lastIndex = 0;
            const fragment = document.createDocumentFragment();
            naturalLanguageRegex.lastIndex = 0;
            let match; // <-- CORRE√á√ÉO: Vari√°vel declarada no escopo correto
            while ((match = naturalLanguageRegex.exec(textNode.textContent)) !== null) {
                const standardFormat = `${match[1]} ${match[2]}:${match[4]}`;
                fragment.appendChild(document.createTextNode(textNode.textContent.slice(lastIndex, match.index)));
                const newTextNode = document.createTextNode(standardFormat);
                fragment.appendChild(newTextNode);
                lastIndex = match.index + match[0].length;
            }
            fragment.appendChild(document.createTextNode(textNode.textContent.slice(lastIndex)));
            textNode.parentNode.replaceChild(fragment, textNode);
            console.log("LOG: Fase 1 converteu texto. A parar para re-analisar.");
            break; // <-- MUDAN√áA: Processa apenas uma convers√£o de cada vez para estabilidade
        }
    }
    if (domModified) { // Se a Fase 1 fez algo, paramos aqui para a pr√≥xima execu√ß√£o.
        console.log('%c--- Verifica√ß√£o terminada ap√≥s modifica√ß√£o na Fase 1 ---', 'color: #1abc9c; font-weight: bold;');
        return;
    }

    // --- FASE 2: Ligar Formato Padr√£o ---
    const standardBiblicalRegex = new RegExp(`(^|\\s)((?:${biblicalBooksPattern})\\s+\\d+:\\d+)(?=$|\\s|\\p{P})`, 'giu');
    let walkerPass2 = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT, null, false);
    let nodesToProcess2 = [];
    while (node = walkerPass2.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) nodesToProcess2.push(node);
    }

    for (let i = 0; i < nodesToProcess2.length; i++) {
        let textNode = nodesToProcess2[i];
        standardBiblicalRegex.lastIndex = 0;
        
        let match; // <-- CORRE√á√ÉO: Vari√°vel declarada no escopo correto
        if ((match = standardBiblicalRegex.exec(textNode.textContent)) !== null) {
            domModified = true;
            
            const prefix = match[1];
            const matchedName = match[2].trim();
            const matchStartIndex = match.index + prefix.length;

            console.log(`%c     SUCESSO! A criar link para: "${matchedName}"`, 'color: #27ae60;');
            
            let afterNode = textNode.splitText(matchStartIndex + matchedName.length);
            let matchNode = textNode.splitText(matchStartIndex);
            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = 'textobiblico';
            span.dataset.entityName = matchedName;
            span.textContent = matchedName;
            matchNode.parentNode.replaceChild(span, matchNode);
            
            let entity = allExistingEntities.find(e => e.tipo === 'textobiblico' && e.nome.toLowerCase() === matchedName.toLowerCase());
            if (!entity) {
                const tempId = `new_${Date.now()}`;
                if (!newBiblicalEntitiesToCreate.has(tempId)) {
                    newBiblicalEntitiesToCreate.set(tempId, { id: tempId, nome: matchedName, tipo: 'textobiblico' });
                }
            }
            
            console.log("LOG: Fase 2 criou um link. A parar para re-analisar.");
            break; // <-- MUDAN√áA: Processa apenas um link de cada vez para estabilidade
        }
    }
    
    // --- FASE 3: Cursor e Base de Dados ---
    console.log('%cLOG CURSOR (Ap√≥s verifica√ß√£o):', 'color: #f39c12; font-weight: bold;');
    if (domModified) {
        console.log('  -> DOM foi modificado. A restaurar posi√ß√£o do cursor.');
        // Restaurar o cursor √© importante quando o DOM muda
        selection.removeAllRanges();
        selection.addRange(originalRange);
        
        // Se alguma modifica√ß√£o foi feita, sa√≠mos para deixar a pr√≥xima chamada da fun√ß√£o
        // lidar com um estado limpo.
        console.log('%c--- Verifica√ß√£o terminada ap√≥s modifica√ß√£o na Fase 2 ---', 'color: #1abc9c; font-weight: bold;');
        return;
    } else {
        console.log('  -> Nenhuma modifica√ß√£o no DOM. O cursor permanece intacto.');
    }
    
    if (newBiblicalEntitiesToCreate.size > 0) {
        try {
            const batch = writeBatch(db);
            for (const entity of newBiblicalEntitiesToCreate.values()) {
                const collectionName = ENTITY_CONFIG[entity.tipo]?.collection;
                if (collectionName) {
                    const newDocRef = doc(collection(db, collectionName));
                    batch.set(newDocRef, { nome: entity.nome, descricao: "", createdAt: serverTimestamp(), referencias: { [selectedNoteId]: true } });
                }
            }
            await batch.commit();
            await fetchAllEntities();
        } catch (error) { console.error("Erro ao criar novas entidades de texto b√≠blico:", error); }
    }

    console.log('%c--- Verifica√ß√£o terminada (sem modifica√ß√µes) ---', 'color: #1abc9c; font-weight: bold;');
}




// --- FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS ---

function showContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    const menu = document.getElementById('context-menu');
    menu.style.display = 'block';
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
    const item = e.target.closest('.list-item');
    activeItemContext = {
        id: item.dataset.id,
        name: item.dataset.name,
        type: item.dataset.type,
        parentId: item.dataset.parentid === 'null' ? null : item.dataset.parentid
    };
}

function hideContextMenu() {
    document.getElementById('context-menu').style.display = 'none';
    activeItemContext = null;
}

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

function showConfirmation(title, message) {
    const modal = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    modal.style.display = 'flex';
    return new Promise(resolve => {
        const confirmBtn = modal.querySelector('[data-action="confirm"]');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');
        const onConfirm = () => { modal.style.display = 'none'; resolve(true); cleanup(); };
        const onCancel = () => { modal.style.display = 'none'; resolve(false); cleanup(); };
        const cleanup = () => {
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
        };
        confirmBtn.addEventListener('click', onConfirm, { once: true });
        cancelBtn.addEventListener('click', onCancel, { once: true });
    });
}

async function updateTagLink(tagName, noteId, shouldExist) {
    const tag = allTags.find(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tag) {
        console.error(`Tag "${tagName}" n√£o encontrada no cache para atualiza√ß√£o.`);
        return;
    }
    const tagRef = doc(db, 'tags', tag.id);
    const updateData = {};
    if (shouldExist) {
        updateData[`notas.${noteId}`] = true;
    } else {
        updateData[`notas.${noteId}`] = deleteField();
    }
    try {
        await updateDoc(tagRef, updateData);
    } catch (error) {
        console.error(`Erro ao atualizar v√≠nculo da tag "${tagName}":`, error);
    }
}

// --- L√ìGICA DE MODAIS E PAIN√âIS ADICIONAIS ---

async function openMoveModal() {
    const modal = document.getElementById('move-item-modal');
    const list = document.getElementById('move-list');
    list.innerHTML = 'Carregando...';
    modal.style.display = 'flex';
    const q = query(collection(db, 'pastas'), where('parentId', '==', activeItemContext.parentId), where('estado', '==', 'ativa'), orderBy('ordem'));
    const snapshot = await getDocs(q);
    let items = [];
    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
    renderMoveList(items);
}

function renderMoveList(items) {
    const list = document.getElementById('move-list');
    list.innerHTML = '';
    items.forEach((item, index) => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.innerHTML = `
            <span>${item.nome}</span>
            <div class="order-controls">
                <button data-action="up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button data-action="down" ${index === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
            </div>
        `;
        list.appendChild(li);
    });
    list.onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const currentLi = btn.closest('li');
        const currentIndex = Array.from(list.children).indexOf(currentLi);
        const action = btn.dataset.action;
        if (action === 'up' && currentIndex > 0) {
            [items[currentIndex], items[currentIndex - 1]] = [items[currentIndex - 1], items[currentIndex]];
        } else if (action === 'down' && currentIndex < items.length - 1) {
            [items[currentIndex], items[currentIndex + 1]] = [items[currentIndex + 1], items[currentIndex]];
        }
        renderMoveList(items);
    };
    document.querySelector('#move-item-modal [data-action="save-order"]').onclick = async () => {
        const batch = writeBatch(db);
        items.forEach((item, index) => {
            const docRef = doc(db, 'pastas', item.id);
            batch.update(docRef, { 
                ordem: index,
                ultimaedicao: serverTimestamp()
            });
        });
        await batch.commit();
        document.getElementById('move-item-modal').style.display = 'none';
    };
}

async function showHiddenItemsModal() {
    const modal = document.getElementById('hidden-items-modal');
    const list = document.getElementById('hidden-items-list');
    list.innerHTML = 'Carregando...';
    modal.style.display = 'flex';
    const q = query(collection(db, 'pastas'), where('estado', '==', 'desativa'));
    const snapshot = await getDocs(q);
    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li>Nenhum item oculto.</li>';
        return;
    }
    snapshot.forEach(doc => {
        const item = { id: doc.id, ...doc.data() };
        const li = document.createElement('li');
        li.innerHTML = `<span class="item-name">${item.nome}</span> <button data-id="${item.id}">Restaurar</button>`;
        list.appendChild(li);
    });
}

function addUrlField(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'url-field-wrapper';
    const urlInput = document.createElement('input');
    urlInput.type = 'text';
    urlInput.placeholder = 'URL da hiperliga√ß√£o';
    urlInput.value = urlValue;
    urlInput.style.flexGrow = '1';
    urlInput.style.padding = '12px';
    urlInput.style.backgroundColor = 'var(--bg-color)';
    urlInput.style.border = '1px solid var(--border-color)';
    urlInput.style.borderRadius = '5px';
    urlInput.style.color = 'var(--text-color)';
    urlInput.style.fontSize = '16px';
    const removeUrlBtn = document.createElement('button');
    removeUrlBtn.textContent = '‚Äì';
    removeUrlBtn.className = 'modal-btn remove-url-btn'; 
    removeUrlBtn.onclick = () => {
        if (container.childElementCount > 1) {
            fieldWrapper.remove();
        } else {
            alert('√â necess√°rio pelo menos um campo de URL.');
        }
    };
    fieldWrapper.appendChild(urlInput);
    fieldWrapper.appendChild(removeUrlBtn);
    container.appendChild(fieldWrapper);
}

function openLinkModal(isEditing, data) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const addUrlBtn = document.getElementById('add-url-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');
    urlsContainer.innerHTML = '';
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = () => addUrlField();
    if (isEditing) {
        modalTitle.textContent = "Editar/Remover Anexo";
        newRemoveBtn.style.display = 'block';
        (async () => {
            const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
            if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                const anexoFromDb = noteSnap.data().anexos[data.id];
                titleInput.value = anexoFromDb.titulo;
                if (anexoFromDb.urls && Object.keys(anexoFromDb.urls).length > 0) {
                    Object.values(anexoFromDb.urls).forEach(url => addUrlField(url));
                } else if (anexoFromDb.hiperligacao) {
                    addUrlField(anexoFromDb.hiperligacao);
                } else {
                    addUrlField();
                }
            }
        })();
        newSaveBtn.onclick = async () => {
            const newTitle = titleInput.value.trim();
            if (!newTitle) return;
            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;
            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });
            if (Object.keys(urlsToSave).length === 0) { alert('Por favor, preencha pelo menos uma URL.'); return; }
            const noteRef = doc(db, 'pastas', selectedNoteId);
            await updateDoc(noteRef, {
                [`anexos.${data.id}.titulo`]: newTitle,
                [`anexos.${data.id}.urls`]: urlsToSave,
                [`anexos.${data.id}.hiperligacao`]: deleteField(),
                [`anexos.${data.id}.timestamp`]: serverTimestamp()
            });
            const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
            if (linkInEditor) linkInEditor.href = firstUrl;
            modal.style.display = 'none';
            saveNote();
        };
        newRemoveBtn.onclick = async () => {
            const confirmed = await showConfirmation('Remover Anexo?', `Tem certeza que deseja remover o anexo "${titleInput.value}"?`);
            if (!confirmed) return;
            const noteRef = doc(db, 'pastas', selectedNoteId);
            const noteSnap = await getDoc(noteRef);
            if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                const anexoToMove = noteSnap.data().anexos[data.id];
                await updateDoc(noteRef, {
                    [`anexos.${data.id}`]: deleteField(),
                    [`anexosocultos.${data.id}`]: anexoToMove
                });
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) {
                    const textNode = document.createTextNode(linkInEditor.textContent);
                    linkInEditor.parentNode.replaceChild(textNode, linkInEditor);
                }
                modal.style.display = 'none';
                saveNote();
            } else { alert("Erro: Anexo n√£o encontrado no banco de dados."); }
        };
    } else {
        modalTitle.textContent = "Criar Anexo";
        titleInput.value = data;
        newRemoveBtn.style.display = 'none';
        addUrlField();
        newSaveBtn.onclick = async () => {
            const titleForDb = titleInput.value.trim();
            if (!titleForDb) return;
            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;
            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });
            if (Object.keys(urlsToSave).length === 0) { alert('Por favor, preencha pelo menos uma URL.'); return; }
            const anexoId = `anexo_${Date.now()}`;
            const noteRef = doc(db, 'pastas', selectedNoteId);
            await updateDoc(noteRef, {
                [`anexos.${anexoId}`]: { titulo: titleForDb, urls: urlsToSave, timestamp: serverTimestamp() }
            }, { merge: true });
            const selection = window.getSelection();
            const originalOffset = selection.getRangeAt(0).startOffset;
            selection.removeAllRanges();
            selection.addRange(currentSelectionRange);
            document.execCommand('createLink', false, firstUrl);
            const createdLink = selection.anchorNode.parentElement.closest('a');
            if (createdLink) {
                createdLink.textContent = data;
                createdLink.dataset.anexoId = anexoId;
            }
            modal.style.display = 'none';
            saveNote();
        };
    }
    modal.style.display = 'flex';
}

function openEntityModal(type, name) {
    const modal = document.getElementById('entity-modal');
    const title = document.getElementById('entity-modal-title');
    const nameInput = document.getElementById('entity-name-input');
    const descriptionInput = document.getElementById('entity-description-input');
    const errorMsg = document.getElementById('entity-error-message');
    const singularDisplayName = ENTITY_CONFIG[type]?.displayName.slice(0, -1) || (type.charAt(0).toUpperCase() + type.slice(1));
    title.textContent = `Criar ou Vincular ${singularDisplayName}`;
    nameInput.value = name;
    descriptionInput.value = '';
    errorMsg.style.display = 'none';
    modal.style.display = 'flex';
    document.getElementById('entity-save-btn').onclick = async () => {
        const entityName = nameInput.value.trim();
        const entityDescription = descriptionInput.value.trim();
        if (!entityName) return;
        const collectionName = ENTITY_CONFIG[type]?.collection;
        if (!collectionName) {
            console.error("Tipo de entidade desconhecido:", type);
            return;
        }
        const collectionRef = collection(db, collectionName);
        const q = query(collectionRef, where("nome", "==", entityName));
        const querySnapshot = await getDocs(q);
        let entityId;
        if (querySnapshot.empty) {
            const newEntityRef = await addDoc(collectionRef, {
                nome: entityName,
                descricao: entityDescription,
                createdAt: serverTimestamp(),
                referencias: { [selectedNoteId]: true }
            });
            entityId = newEntityRef.id;
        } else {
            const existingDoc = querySnapshot.docs[0];
            entityId = existingDoc.id;
            const entityRef = doc(db, collectionName, entityId);
            await updateDoc(entityRef, {
                [`referencias.${selectedNoteId}`]: true
            });
        }
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(currentSelectionRange);
        const span = document.createElement('span');
        span.className = 'entity-link';
        span.dataset.entityType = type;
        span.dataset.entityName = entityName;
        span.textContent = entityName;
        currentSelectionRange.surroundContents(span);
        modal.style.display = 'none';
        saveNote();
        fetchAllEntities();
    };
}

async function openGenericListModal(title, dataPromise) {
    const modal = document.getElementById('generic-list-modal');
    const titleEl = document.getElementById('generic-list-title');
    const contentEl = document.getElementById('generic-list-content');
    titleEl.textContent = title;
    contentEl.innerHTML = '<li>Carregando...</li>';
    modal.style.display = 'flex';
    try {
        const items = await dataPromise;
        contentEl.innerHTML = ''; 
        if (!items || items.length === 0) {
            contentEl.innerHTML = '<li>Nenhum item encontrado.</li>';
            return;
        }
        items.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div style="display: flex; flex-direction: column;">
                    <strong style="font-size: 1.1em;">${item.title}</strong>
                    <small style="color: var(--text-muted-color); margin-top: 4px;">${item.content}</small>
                </div>
            `;
            contentEl.appendChild(li);
        });
    } catch (error) {
        console.error("Erro ao carregar dados para o modal:", error);
        contentEl.innerHTML = '<li>Ocorreu um erro ao carregar os itens.</li>';
    }
}

function openAttachmentsModal() {
    if (!selectedNoteId) return;
    const fetchData = async () => {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        if (noteSnap.exists() && noteSnap.data().anexos) {
            const anexosMap = noteSnap.data().anexos;
            return Object.values(anexosMap).map(anexo => {
                const urls = anexo.urls ? Object.values(anexo.urls).join(', ') : anexo.hiperligacao;
                return { title: anexo.titulo, content: urls };
            });
        }
        return [];
    };
    openGenericListModal("Anexos na Nota", fetchData());
}

function openTagsModal() {
    const fetchData = async () => {
        const tagsCollection = collection(db, 'tags');
        const tagsSnapshot = await getDocs(tagsCollection);
        if (!tagsSnapshot.empty) {
            return tagsSnapshot.docs.map(doc => ({
                title: doc.data().nome,
                content: `ID: ${doc.id}`
            }));
        }
        return [];
    };
    openGenericListModal("Todas as Tags", fetchData());
}

async function openAnchorsModal() {
    await fetchAllEntities();
    const modal = document.getElementById('anchors-modal');
    const tabsContainer = document.getElementById('anchors-tabs-container');
    const contentContainer = document.getElementById('anchors-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';
    const onPageEntityNames = new Set(Array.from(noteContentEditor.querySelectorAll('.entity-link')).map(link => link.dataset.entityName));

    let isFirstTab = true;
    for (const type in ENTITY_CONFIG) {
        if (allEntities[type] && allEntities[type].length > 0) {
            const config = ENTITY_CONFIG[type];
            const tabButton = document.createElement('button');
            tabButton.dataset.tab = type;
            tabButton.textContent = config.displayName;
            if (isFirstTab) tabButton.classList.add('active');
            tabsContainer.appendChild(tabButton);

            const tabContent = document.createElement('div');
            tabContent.id = `tab-${type}`;
            tabContent.className = 'tab-content';
            if (isFirstTab) tabContent.classList.add('active');
            
            const ul = document.createElement('ul');
            const sortedEntities = [...allEntities[type]].sort((a, b) => a.nome.localeCompare(b.nome));

            sortedEntities.forEach(entity => {
                const li = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = entity.nome;
                li.appendChild(nameSpan);
                li.dataset.entityId = entity.id;
                li.dataset.entityName = entity.nome;
                li.dataset.entityType = entity.tipo;
                if (onPageEntityNames.has(entity.nome)) li.classList.add('is-on-page');
                
                const editBtn = document.createElement('button');
                editBtn.className = 'entity-edit-btn';
                editBtn.innerHTML = '‚Ä¶';
                editBtn.title = 'Editar entidade';
                editBtn.onclick = (event) => {
                    event.stopPropagation();
                    openEditEntityModal(entity.id, entity.tipo);
                };

                li.appendChild(editBtn);
                ul.appendChild(li);
            });
            tabContent.appendChild(ul);
            contentContainer.appendChild(tabContent);
            isFirstTab = false;
        }
    }
    modal.style.display = 'flex';
}

async function openEditEntityModal(entityId, entityType) {
    const modal = document.getElementById('edit-entity-modal');
    const title = document.getElementById('edit-entity-title');
    const nameInput = document.getElementById('edit-entity-name-input');
    const descriptionInput = document.getElementById('edit-entity-description-input');
    const saveBtn = document.getElementById('edit-entity-save-btn');

    modal.style.display = 'flex';
    nameInput.value = 'A carregar...';
    descriptionInput.value = 'A carregar...';
    
    const collectionName = ENTITY_CONFIG[entityType]?.collection;
    if (!collectionName) {
        alert('Erro: Tipo de entidade desconhecido.');
        return;
    }

    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (!entitySnap.exists()) {
            alert('Erro: Entidade n√£o encontrada na base de dados.');
            modal.style.display = 'none';
            return;
        }

        const entityData = entitySnap.data();
        title.textContent = `Editar "${entityData.nome}"`;
        nameInput.value = entityData.nome;
        descriptionInput.value = entityData.descricao || '';

        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDescription = descriptionInput.value.trim();

            if (!newName) {
                alert('O nome n√£o pode estar vazio.');
                return;
            }

            await updateDoc(entityRef, {
                nome: newName,
                descricao: newDescription
            });

            modal.style.display = 'none';
            await fetchAllEntities();
            
            const liToUpdate = document.querySelector(`#anchors-content-container li[data-entity-id="${entityId}"] span`);
            if (liToUpdate) {
                liToUpdate.textContent = newName;
            }
        };

    } catch (error) {
        console.error("Erro ao abrir o modal de edi√ß√£o:", error);
        alert('Ocorreu um erro ao carregar os dados da entidade.');
        modal.style.display = 'none';
    }
}

async function showReferencesPanel(entityId, entityName, entityType) {
    const descriptionElement = document.getElementById('references-panel-description');
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Refer√™ncias para "${entityName}"`;
    referencesList.innerHTML = '<li>A carregar refer√™ncias...</li>';
    descriptionElement.textContent = ''; 

    const collectionName = ENTITY_CONFIG[entityType]?.collection;
    if (!collectionName) {
        referencesList.innerHTML = '<li>Erro: Tipo de entidade inv√°lido.</li>';
        return;
    }

    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (entitySnap.exists()) {
            const entityData = entitySnap.data();
            if (entityData.descricao && entityData.descricao.trim() !== '') {
                descriptionElement.textContent = entityData.descricao;
            } else {
                descriptionElement.textContent = 'Nenhuma descri√ß√£o dispon√≠vel.';
            }
            
            if (entityData.referencias && Object.keys(entityData.referencias).length > 0) {
                const noteIds = Object.keys(entityData.referencias);
                const promises = noteIds.map(id => getDoc(doc(db, 'pastas', id)));
                const noteSnaps = await Promise.all(promises);
                
                referencesList.innerHTML = ''; 

                noteSnaps.forEach(noteSnap => {
                    if (noteSnap.exists()) {
                        const noteData = noteSnap.data();
                        const details = document.createElement('details');
                        details.className = 'reference-item';
                        const summary = document.createElement('summary');
                        summary.textContent = noteData.nome;
                        const contextDiv = document.createElement('div');
                        contextDiv.className = 'reference-context';
                        contextDiv.innerHTML = generateReferenceContext(noteData.conteudo, entityName);
                        details.appendChild(summary);
                        details.appendChild(contextDiv);
                        referencesList.appendChild(details);
                    }
                });
            } else {
                referencesList.innerHTML = '<li>Nenhuma refer√™ncia encontrada.</li>';
            }

        } else {
            referencesList.innerHTML = '<li>Erro: Entidade n√£o encontrada.</li>';
        }
    } catch (error) {
        console.error("Erro ao buscar refer√™ncias:", error);
        referencesList.innerHTML = '<li>Ocorreu um erro ao buscar as refer√™ncias.</li>';
    }
}

function hideReferencesPanel() {
    notebookContainer.classList.remove('references-panel-visible');
    const descriptionElement = document.getElementById('references-panel-description');
    if (descriptionElement) {
        descriptionElement.textContent = '';
    }
}

function generateReferenceContext(noteContent, entityName) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = noteContent;
    const plainText = tempDiv.innerText;
    const position = plainText.toLowerCase().indexOf(entityName.toLowerCase());

    if (position === -1) {
        return '<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>';
    }

    const CONTEXT_LENGTH = 70;
    const start = Math.max(0, position - CONTEXT_LENGTH);
    const end = Math.min(plainText.length, position + entityName.length + CONTEXT_LENGTH);
    let prefix = start > 0 ? '... ' : '';
    let suffix = end < plainText.length ? ' ...' : '';
    let contextText = plainText.substring(start, end);
    const highlightedText = contextText.replace(
        new RegExp(entityName, 'i'),
        `<mark>${entityName}</mark>`
    );
    return `<p>${prefix}${highlightedText}${suffix}</p>`;
}

// --- L√ìGICA DO EDITOR RICO E TAGS ---

function showTagPopup(query) {
    const filteredTags = allTags.filter(tag => tag.nome.toLowerCase().includes(query.toLowerCase()));
    tagSuggestionList.innerHTML = '';
    if (filteredTags.length > 0) {
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag.nome;
            li.dataset.tagNome = tag.nome;
            tagSuggestionList.appendChild(li);
        });
    } else if (query) {
        const li = document.createElement('li');
        li.innerHTML = `Criar nova tag: "<strong>${query}</strong>"`;
        li.dataset.tagNome = query;
        tagSuggestionList.appendChild(li);
    } else {
         hideTagPopup(); return;
    }
    const rect = currentTagQueryRange.getBoundingClientRect();
    tagSuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
    tagSuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
    tagSuggestionPopup.style.display = 'block';
    isTagPopupOpen = true;
    tagSuggestionList.firstChild.classList.add('selected');
}

function hideTagPopup() {
    tagSuggestionPopup.style.display = 'none';
    isTagPopupOpen = false;
    currentTagQueryRange = null;
}

function navigateTagSuggestions(key) {
    const items = Array.from(tagSuggestionList.children);
    if(items.length === 0) return;
    const selected = tagSuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

async function commitTagSelection() {
    const selectedLi = tagSuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    const tagName = selectedLi.dataset.tagNome.trim();
    if (!tagName) { hideTagPopup(); return; }
    let tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tagExists) await createNewTag(tagName);
    insertTagIntoEditor(tagName);
    hideTagPopup();
}

async function createNewTag(tagName) {
    try {
        const tagsCollection = collection(db, 'tags');
        const newTagRef = await addDoc(tagsCollection, { nome: tagName, createdAt: serverTimestamp() });
        allTags.push({ id: newTagRef.id, nome: tagName });
    } catch (error) { console.error("Erro ao criar nova tag:", error); }
}


async function fetchAllTags() {
    try {
        const tagsCollection = collection(db, 'tags');
        const tagsSnapshot = await getDocs(tagsCollection);
        
        const loadedTags = tagsSnapshot.docs.map(doc => ({
            id: doc.id,
            nome: doc.data().nome || doc.data().name 
        }));

        allTags = loadedTags.filter(tag => {
            if (tag.nome && typeof tag.nome === 'string') {
                return true; 
            } else {
                console.warn('Tag descartada por falta do campo "nome":', doc.id);
                return false; 
            }
        });
        
    } catch (error) {
        console.error("Erro ao carregar as tags existentes:", error);
    }
}


function insertTagIntoEditor(tagName) {
    if (!currentTagQueryRange) return;
    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = `#${tagName}`;
    tagSpan.setAttribute('contenteditable', 'false');
    const spaceNode = document.createTextNode('\u00A0');
    currentTagQueryRange.deleteContents();
    currentTagQueryRange.insertNode(spaceNode);
    currentTagQueryRange.insertNode(tagSpan);
    const selection = window.getSelection();
    const newRange = document.createRange();
    const newOffset = Math.min(originalOffset, textNode.textContent.length); 
    newRange.setStart(textNode, newOffset);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}


// --- NOVAS FUN√á√ïES PARA SUGEST√ÉO DE ENTIDADES ---

function showEntityPopup(query) {
    // Junta todas as entidades de todos os tipos num √∫nico array
    const flatEntities = Object.values(allEntities).flat();
    const filteredEntities = flatEntities.filter(entity => 
        entity.nome.toLowerCase().includes(query.toLowerCase())
    );

    entitySuggestionList.innerHTML = '';
    if (filteredEntities.length > 0) {
        filteredEntities.forEach(entity => {
            const li = document.createElement('li');
            // Guardamos os dados da entidade no elemento li
            li.dataset.entityName = entity.nome;
            li.dataset.entityType = entity.tipo;
            
            // Mostra o nome e o tipo para ser mais f√°cil de identificar
            li.innerHTML = `${entity.nome} <span style="font-size: 0.8em; color: var(--text-muted-color);">[${entity.tipo}]</span>`;
            
            entitySuggestionList.appendChild(li);
        });
        
        const rect = currentEntityQueryRange.getBoundingClientRect();
        entitySuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
        entitySuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
        entitySuggestionPopup.style.display = 'block';
        isEntityPopupOpen = true;
        entitySuggestionList.firstChild.classList.add('selected');
    } else {
        hideEntityPopup();
    }
}

function hideEntityPopup() {
    entitySuggestionPopup.style.display = 'none';
    isEntityPopupOpen = false;
    currentEntityQueryRange = null;
}

function navigateEntitySuggestions(key) {
    const items = Array.from(entitySuggestionList.children);
    if(items.length === 0) return;
    const selected = entitySuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

function insertEntityIntoEditor(entityName, entityType) {
    if (!currentEntityQueryRange) return;

    // Cria o <span> para a entidade, que √© o nosso link especial
    const entitySpan = document.createElement('span');
    entitySpan.className = 'entity-link';
    entitySpan.dataset.entityType = entityType;
    entitySpan.dataset.entityName = entityName;
    entitySpan.textContent = entityName;
    
    // Adiciona um espa√ßo depois para o cursor n√£o ficar "preso"
    const spaceNode = document.createTextNode('\u00A0'); 

    // Substitui o texto digitado (ex: "@Ped") pelo link da entidade
    currentEntityQueryRange.deleteContents();
    currentEntityQueryRange.insertNode(spaceNode);
    currentEntityQueryRange.insertNode(entitySpan);

    // Posiciona o cursor depois do link e do espa√ßo
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote(); // Guarda a altera√ß√£o
}

async function commitEntitySelection() {
    const selectedLi = entitySuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    
    const entityName = selectedLi.dataset.entityName;
    const entityType = selectedLi.dataset.entityType;
    
    if (entityName && entityType) {
        insertEntityIntoEditor(entityName, entityType);
    }
    
    hideEntityPopup();
}



 function escapeStyledElements(event) {
    const selection = window.getSelection();
    if (!selection.isCollapsed || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    const parentElement = currentNode.nodeType === Node.TEXT_NODE ? currentNode.parentElement : currentNode;
    const styledContainer = parentElement.closest('.entity-link, .tag');

    if (styledContainer) {
        const isAtTheStart = range.startOffset === 0;
        if (event.key === 'Backspace' && isAtTheStart) {
            event.preventDefault();
            const textContent = styledContainer.textContent;
            const textNode = document.createTextNode(textContent);
            styledContainer.parentNode.replaceChild(textNode, styledContainer);
            const newRange = document.createRange();
            newRange.setStart(textNode, textNode.length);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            updateSaveStatus('unsaved');
            saveNote();
            return;
        }

        const isAtTheEnd = range.startOffset === currentNode.textContent.length;
        if (isAtTheEnd && (event.key.length === 1 || event.key === 'Enter') && !event.ctrlKey && !event.metaKey && !event.altKey) {
            const zeroWidthSpace = document.createTextNode('\u200B');
            if (styledContainer.nextSibling) {
                styledContainer.parentNode.insertBefore(zeroWidthSpace, styledContainer.nextSibling);
            } else {
                styledContainer.parentNode.appendChild(zeroWidthSpace);
            }
            const newRange = document.createRange();
            newRange.setStart(zeroWidthSpace, 1);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
        }
    }

}

function handleTextSelection() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) {
        selectionPopup.style.display = 'none';
        return;
    }
    const selectionText = selection.toString().trim();
    const isInEditor = noteContentEditor.contains(selection.anchorNode);
    if (!selection.isCollapsed && selectionText.length > 0 && isInEditor) {
        currentSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = currentSelectionRange.getBoundingClientRect();
        selectionPopup.style.display = 'flex';
        selectionPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        selectionPopup.style.left = `${rect.left + (rect.width / 2) - (selectionPopup.offsetWidth / 2) + window.scrollX}px`;
    } else {
        if (!selectionPopup.matches(':hover')) {
            selectionPopup.style.display = 'none';
        }
    }
}




function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.seconds) {
            return 'Data inv√°lida';
        }
        const date = new Date(timestamp.seconds * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    /**
     * Carrega e exibe a lista de backups para a nota atual.
     */
    async function loadBackupsForNote() {
        if (!selectedNoteId) return;

        const listEl = document.getElementById('history-list-content');
        listEl.innerHTML = '<li>A carregar backups...</li>';

        const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
        const q = query(backupsRef, orderBy('timestamp', 'desc'));

        try {
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                listEl.innerHTML = '<li>Nenhum backup encontrado.</li>';
                return;
            }

            listEl.innerHTML = '';
            snapshot.forEach(doc => {
                const backup = { id: doc.id, ...doc.data() };
                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                
                const backupDate = formatTimestamp(backup.timestamp);
                
                li.innerHTML = `
                    <span>Backup de ${backupDate}</span>
                    <div>
                        <button class="modal-btn secondary" data-action="view" data-backup-id="${backup.id}" style="padding: 5px 10px;">Ver</button>
                        <button class="modal-btn primary" data-action="restore" data-backup-id="${backup.id}" style="padding: 5px 10px;">Restaurar</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        } catch (error) {
            console.error("Erro ao carregar backups:", error);
            listEl.innerHTML = '<li>Ocorreu um erro ao carregar os backups.</li>';
        }
    }
    
    /**
     * Abre o modal de hist√≥rico e configura os seus eventos.
     */
    async function openHistoryModal() {
        if (!selectedNoteId) {
            alert("Por favor, selecione uma nota primeiro.");
            return;
        }

        const modal = document.getElementById('history-modal');
        const titleEl = document.getElementById('history-modal-title');
        const backupBtn = document.getElementById('backup-now-btn');
        
        titleEl.textContent = `Hist√≥rico de "${noteTitleInput.value}"`;
        
        // Remove listener antigo para evitar duplicados e adiciona um novo
        const newBackupBtn = backupBtn.cloneNode(true);
        backupBtn.parentNode.replaceChild(newBackupBtn, backupBtn);
        newBackupBtn.onclick = async () => {
            newBackupBtn.disabled = true;
            newBackupBtn.textContent = 'A criar backup...';
            try {
                const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
                await addDoc(backupsRef, {
                    titulo: noteTitleInput.value,
                    conteudo: noteContentEditor.innerHTML,
                    timestamp: serverTimestamp()
                });
                await loadBackupsForNote(); // Atualiza a lista
            } catch (error) {
                console.error("Erro ao criar backup:", error);
                alert("Ocorreu um erro ao criar o backup.");
            } finally {
                newBackupBtn.disabled = false;
                newBackupBtn.textContent = 'Fazer backup do estado atual';
            }
        };

        modal.style.display = 'flex';
        await loadBackupsForNote();
    }

    /**
     * Restaura um backup criando uma nova nota.
     * @param {string} backupId O ID do documento de backup.
     */
    async function restoreBackup(backupId) {
        if (!selectedNoteId) return;
        
        try {
            // 1. Obter os dados do backup
            const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
            const backupSnap = await getDoc(backupRef);
            if (!backupSnap.exists()) {
                throw new Error("Backup n√£o encontrado.");
            }
            const backupData = backupSnap.data();

            // 2. Obter o parentId da nota original
            const originalNoteRef = doc(db, 'pastas', selectedNoteId);
            const originalNoteSnap = await getDoc(originalNoteRef);
            if (!originalNoteSnap.exists()) {
                throw new Error("Nota original n√£o encontrada.");
            }
            const parentId = originalNoteSnap.data().parentId;
            
            // 3. Formatar o novo t√≠tulo
            const backupDate = formatTimestamp(backupData.timestamp);
            const newTitle = `${backupData.titulo} (Restaurado de ${backupDate})`;

            // 4. Determinar a ordem da nova nota
            const q = query(collection(db, 'pastas'), where('parentId', '==', parentId), where('estado', '==', 'ativa'));
            const siblingsSnap = await getDocs(q);
            const newOrder = siblingsSnap.size;

            // 5. Criar a nova nota
            await addDoc(collection(db, 'pastas'), {
                nome: newTitle,
                conteudo: backupData.conteudo,
                parentId: parentId,
                tipo: 'nota',
                estado: 'ativa',
                ordem: newOrder,
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            alert(`Nota restaurada com sucesso como "${newTitle}".\nA lista de notas ser√° atualizada.`);
            document.getElementById('history-modal').style.display = 'none';

        } catch (error) {
            console.error("Erro ao restaurar backup:", error);
            alert("Ocorreu um erro ao restaurar o backup.");
        }
    }

    /**
     * Exibe o conte√∫do de um backup num modal de visualiza√ß√£o.
     * @param {string} backupId O ID do documento de backup.
     */
    async function viewBackup(backupId) {
        if (!selectedNoteId) return;

        try {
            const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
            const backupSnap = await getDoc(backupRef);
            if (!backupSnap.exists()) {
                throw new Error("Backup n√£o encontrado.");
            }
            const backupData = backupSnap.data();
            
            const modal = document.getElementById('view-backup-modal');
            const titleEl = document.getElementById('view-backup-title');
            const contentEl = document.getElementById('view-backup-content');

            const backupDate = formatTimestamp(backupData.timestamp);
            titleEl.textContent = `Visualizando Backup de ${backupDate}`;
            // Usar textContent para evitar renderiza√ß√£o de HTML malicioso
            contentEl.textContent = backupData.conteudo.replace(/<[^>]*>/g, ''); // Remove tags HTML para visualiza√ß√£o simples
            
            modal.style.display = 'flex';

        } catch (error) {
            console.error("Erro ao visualizar backup:", error);
            alert("Ocorreu um erro ao carregar o conte√∫do do backup.");
        }
    }
    
    // --- EVENT LISTENER MODIFICADO ---

    editorToolbar.addEventListener('click', async (e) => {
        const target = e.target.closest('button, input');
        if (!target) return;
        const command = target.dataset.command;
        if (command) {
            // ... (c√≥digo existente para formata√ß√£o de texto)
        }
        const action = target.dataset.action;
        if (action) {
            switch (action) {
                case 'show-tags': openTagsModal(); break;
                case 'show-attachments': openAttachmentsModal(); break;
                case 'show-anchors': openAnchorsModal(); break;
                // --- Linha modificada ---
                case 'show-history': openHistoryModal(); break; 
            }
        }
    });

    // --- NOVO EVENT LISTENER PARA O MODAL DE HIST√ìRICO ---
    
    document.getElementById('history-list-content').addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        
        const action = button.dataset.action;
        const backupId = button.dataset.backupId;

        if (action === 'restore') {
            restoreBackup(backupId);
        } else if (action === 'view') {
            viewBackup(backupId);
        }
    });


// --- EVENT LISTENERS ---

// Listeners de Conectividade e Sa√≠da
window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);
window.addEventListener('beforeunload', (event) => {
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        event.preventDefault();
        event.returnValue = '';
        return '';
    }
});

// Listeners de Navega√ß√£o (Protegidos pelo Gatekeeper)
backBtn.addEventListener('click', () => {
    const action = () => {
        if (navigationStack.length > 0) {
            navigationStack.pop();
            updateNavigationView();
        }
    };
    navigateWithUnsavedCheck(action);
});

leftPanelList.addEventListener('click', (e) => {
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) { showContextMenu(e); return; }
    
    const listItem = e.target.closest('.list-item');
    if (!listItem || listItem.dataset.type !== 'pasta') return;

    const action = () => {
        if (navigationStack.length > 0) navigationStack.pop();
        navigationStack.push({ id: listItem.dataset.id, name: listItem.dataset.name });
        updateNavigationView();
    };
    navigateWithUnsavedCheck(action);
});

middlePanelList.addEventListener('click', (e) => {
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) { showContextMenu(e); return; }

    const listItem = e.target.closest('.list-item');
    if (!listItem) return;

    const { id, type, name } = listItem.dataset;
    if (type === 'nota' && id === selectedNoteId) return;

    const action = () => {
        if (type === 'pasta') {
            navigationStack.push({ id, name });
            updateNavigationView();
        } else if (type === 'nota') {
            displayNote(id, listItem);
        }
    };
    navigateWithUnsavedCheck(action);
});

document.querySelector('.tabs-container').addEventListener('click', (e) => {
    const clickedTab = e.target.closest('button');
    if (!clickedTab) return;

    const action = () => {
        document.querySelectorAll('.tabs-container button').forEach(btn => btn.classList.remove('active'));
        clickedTab.classList.add('active');
        navigationStack = [];
        updateNavigationView();
    };
    navigateWithUnsavedCheck(action);
});

// Listeners do Editor
noteTitleInput.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
noteContentEditor.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
document.addEventListener('selectionchange', handleTextSelection);

noteContentEditor.addEventListener('keydown', (event) => {
    escapeStyledElements(event); // Mant√©m a fun√ß√£o original

    if (isTagPopupOpen) {
        if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
            event.preventDefault();
            navigateTagSuggestions(event.key);
        } else if (['Enter', 'Tab'].includes(event.key)) { // Removi o ' ' e ','
            event.preventDefault();
            commitTagSelection();
        }
    } else if (isEntityPopupOpen) {
        if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
            event.preventDefault();
            navigateEntitySuggestions(event.key);
        } else if (['Enter', 'Tab'].includes(event.key)) {
            event.preventDefault();
            commitEntitySelection();
        }
    }
});

 noteContentEditor.addEventListener('keyup', (event) => {
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(event.key)) return;
    if (isTagPopupOpen && ['Enter', ' '].includes(event.key)) return;
    if (isEntityPopupOpen && ['Enter'].includes(event.key)) return;

    if (event.key === 'Escape') { 
        hideTagPopup();
        hideEntityPopup();
        return; 
    }

    const selection = window.getSelection();
    if (!selection.rangeCount > 0) return;
    const range = selection.getRangeAt(0);
    const textBeforeCursor = range.startContainer.textContent.substring(0, range.startOffset);

    const tagMatch = textBeforeCursor.match(/#(\w*)$/);
    const entityMatch = textBeforeCursor.match(/@([\w\s]*)$/);

    if (tagMatch) {
        hideEntityPopup();
        currentTagQueryRange = document.createRange();
        currentTagQueryRange.setStart(range.startContainer, tagMatch.index);
        currentTagQueryRange.setEnd(range.startContainer, range.startOffset);
        showTagPopup(tagMatch[1]);
    } else if (entityMatch) {
        hideTagPopup();
        currentEntityQueryRange = document.createRange();
        currentEntityQueryRange.setStart(range.startContainer, entityMatch.index);
        currentEntityQueryRange.setEnd(range.startContainer, range.startOffset);
        showEntityPopup(entityMatch[1]);
    } else {
        hideTagPopup();
        hideEntityPopup();
    }
    
     debouncedScanAndLink();
});

// Outros Listeners
document.addEventListener('click', (e) => {
    if (!e.target.closest('.context-menu')) hideContextMenu();
    if (!noteContentEditor.contains(e.target) && !tagSuggestionPopup.contains(e.target)) hideTagPopup();
});

leftPanelToggleBtn.addEventListener('click', () => {
    notebookContainer.classList.toggle('left-panel-collapsed');
});

addItemBtn.addEventListener('click', () => {
    const addFolderBtn = document.querySelector('#add-item-options button[data-type="pasta"]');
    const addNoteBtn = document.querySelector('#add-item-options button[data-type="nota"]');
    newItemNameInput.value = '';
    newItemNameInput.style.display = 'none';
    document.getElementById('confirm-item-addition').style.display = 'none';
    document.getElementById('add-item-options').style.display = 'flex';
    if (navigationStack.length === 0) {
        addFolderBtn.style.display = 'block';
        addNoteBtn.style.display = 'none';
    } else {
        addFolderBtn.style.display = 'block';
        addNoteBtn.style.display = 'block';
    }
    document.getElementById('add-item-modal').style.display = 'flex';
});

let itemTypeToAdd = '';
document.getElementById('add-item-options').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    itemTypeToAdd = btn.dataset.type;
    document.getElementById('add-item-options').style.display = 'none';
    newItemNameInput.style.display = 'block';
    newItemNameInput.placeholder = `Nome d${itemTypeToAdd === 'pasta' ? 'a' : 'a'} ${itemTypeToAdd}...`;
    newItemNameInput.focus();
    document.getElementById('confirm-item-addition').style.display = 'block';
});

document.getElementById('confirm-item-addition').addEventListener('click', async () => {
    const itemName = newItemNameInput.value.trim();
    if (!itemName || !itemTypeToAdd) return;
    const parentId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
    try {
        const q = query(collection(db, 'pastas'), where('parentId', '==', parentId), where('estado', '==', 'ativa'));
        const siblingsSnap = await getDocs(q);
        const newOrder = siblingsSnap.size;
        await addDoc(collection(db, 'pastas'), {
            nome: itemName, parentId: parentId, tipo: itemTypeToAdd, estado: 'ativa',
            ordem: newOrder, createdAt: serverTimestamp(), ultimaedicao: serverTimestamp(),
            ...(itemTypeToAdd === 'nota' && { conteudo: '' })
        });
        document.getElementById('add-item-modal').style.display = 'none';
    } catch (error) { console.error("Erro ao criar item:", error); }
});

document.getElementById('context-menu').addEventListener('click', async (e) => {
    const action = e.target.dataset.action;
    if (!action || !activeItemContext) return;
    if (action === 'hide') {
        const confirmed = await showConfirmation('Ocultar Item?', `Tem certeza que deseja ocultar "${activeItemContext.name}"?`);
        if (confirmed) {
            await updateDoc(doc(db, 'pastas', activeItemContext.id), { 
                estado: 'desativa',
                ultimaedicao: serverTimestamp()
            });
        }
    } else if (action === 'move') {
        await openMoveModal();
    } else if (action === 'rename') {
        const currentName = activeItemContext.name;
        const newName = prompt("Mudar nome para:", currentName);
        if (newName && newName.trim() !== "" && newName !== currentName) {
            await updateDoc(doc(db, 'pastas', activeItemContext.id), {
                nome: newName.trim(),
                ultimaedicao: serverTimestamp()
            });
        }
    }
    hideContextMenu();
});

document.querySelectorAll('.modal-overlay [data-action="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal-overlay').style.display = 'none';
    });
});

document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-modal').style.display = 'flex';
});

document.getElementById('settings-modal').addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    if (action === 'show-hidden-items') {
        document.getElementById('settings-modal').style.display = 'none';
        showHiddenItemsModal();
    }
});

document.getElementById('hidden-items-list').addEventListener('click', async (e) => {
    if (e.target.tagName === 'BUTTON') {
        const id = e.target.dataset.id;
        await updateDoc(doc(db, 'pastas', id), { 
            estado: 'ativa',
            ultimaedicao: serverTimestamp()
        });
        e.target.closest('li').remove();
    }
});

editorToolbar.addEventListener('click', async (e) => {
    const target = e.target.closest('button, input');
    if (!target) return;
    const command = target.dataset.command;
    if (command) {
        if (command.includes('FontSize')) {
            const currentSize = window.getComputedStyle(noteContentEditor, null).getPropertyValue('font-size');
            let newSize = parseFloat(currentSize) + (command === 'increaseFontSize' ? 1 : -1);
            document.execCommand("fontSize", false, "7");
            let fontElements = window.getSelection().anchorNode.parentNode;
            fontElements.style.fontSize = newSize + "px";
        } else if (command === 'foreColor') {
            target.oninput = () => document.execCommand(command, false, target.value);
        } else {
            document.execCommand(command, false, null);
        }
        noteContentEditor.focus();
        saveNote();
    }
    const action = target.dataset.action;
    if (action) {
        switch (action) {
            case 'show-tags': openTagsModal(); break;
            case 'show-attachments': openAttachmentsModal(); break;
            case 'show-anchors': openAnchorsModal(); break;
            case 'show-history': openHistoryModal(); break;
        }
    }
});

noteContentEditor.addEventListener('click', (event) => {
    const linkElement = event.target.closest('.entity-link');
    if (!linkElement || !linkElement.dataset.entityName || !linkElement.dataset.entityType) return;
    event.preventDefault();
    const entityName = linkElement.dataset.entityName;
    const entityType = linkElement.dataset.entityType;
    if (!allEntities[entityType]) return;
    const entity = allEntities[entityType].find(e => e.nome === entityName);
    if (!entity) return;
    const entityId = entity.id;
    showReferencesPanel(entityId, entityName, entityType);
});

selectionPopup.addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    const type = e.target.dataset.type;
    if (!action || !currentSelectionRange) return;
    const selection = window.getSelection();
    if (action === 'create-link') {
        const linkElement = selection.anchorNode.parentElement.closest('a[data-anexo-id]');
        if (linkElement) {
            openLinkModal(true, { id: linkElement.dataset.anexoId, title: linkElement.textContent, url: linkElement.href });
        } else {
            const selectedText = currentSelectionRange.toString().trim();
            if (!selectedText) { alert("Por favor, selecione um texto para criar um anexo."); selectionPopup.style.display = 'none'; return; }
            openLinkModal(false, selectedText);
        }
    } else if (action === 'break-link') {
        const linkElement = selection.anchorNode.parentElement.closest('a[data-anexo-id]');
        if (linkElement) {
            openLinkModal(true, { id: linkElement.dataset.anexoId, title: linkElement.textContent, url: linkElement.href });
        } else {
            alert("Por favor, certifique-se de que seu cursor est√° dentro de um anexo existente.");
        }
    } else if (action === 'create-entity') {
        const selectedText = currentSelectionRange.toString().trim();
        if (!selectedText) { alert("Por favor, selecione um texto para criar uma entidade."); selectionPopup.style.display = 'none'; return; }
        openEntityModal(type, selectedText);
    }
    selectionPopup.style.display = 'none';
});

tagSuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const li = e.target.closest('li');
    if (li) {
        const selected = tagSuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitTagSelection();
    }
});

entitySuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Impede que o editor perca o foco
    const li = e.target.closest('li');
    if (li) {
        const selected = entitySuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitEntitySelection();
    }
});

document.getElementById('anchors-modal').addEventListener('click', (e) => {
    const tabButton = e.target.closest('button[data-tab]');
    if (tabButton) {
        document.querySelectorAll('#anchors-tabs-container button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#anchors-content-container .tab-content').forEach(content => content.classList.remove('active'));
        tabButton.classList.add('active');
        document.getElementById(`tab-${tabButton.dataset.tab}`).classList.add('active');
        return;
    }
    const listItem = e.target.closest('li[data-entity-id]');
    if(listItem) {
        const { entityId, entityName, entityType } = listItem.dataset;
        showReferencesPanel(entityId, entityName, entityType);
        document.getElementById('anchors-modal').style.display = 'none';
    }
});

referencesPanelCloseBtn.addEventListener('click', hideReferencesPanel);


    </script>
</body>
</html>
