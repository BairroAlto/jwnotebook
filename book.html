<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modo Leitura - JW Notebook</title>
    <style>
        :root {
            --bg-color: #1a1a1d;
            --sidebar-color: #252528;
            --panel-color: #1f1f22;
            --text-color: #f0f0f0;
            --text-muted: #888;
            --accent-color: #4a90e2;
            --border-color: #333;
            --hover-color: #2c2c30;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            height: 100vh; 
            overflow: hidden;
        }

        /* Layout Principal Flexbox */
        .book-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* --- COLUNA 1: BARRA LATERAL (√çndice) --- */
        #book-sidebar {
            flex: 0 0 300px;
            background-color: var(--sidebar-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { font-size: 1.2em; font-weight: 500; color: var(--accent-color); }
        .sidebar-header p { font-size: 0.8em; color: var(--text-muted); margin-top: 5px; }

        #book-toc { flex-grow: 1; overflow-y: auto; padding: 10px; list-style: none; }
        .toc-item { margin-bottom: 2px; }
        .toc-header { display: flex; align-items: center; padding: 8px 10px; cursor: pointer; border-radius: 4px; color: var(--text-muted); transition: all 0.2s; font-size: 0.95em; }
        .toc-header:hover { background-color: var(--hover-color); color: var(--text-color); }
        .toc-header.active-note { background-color: rgba(74, 144, 226, 0.2); color: var(--accent-color); font-weight: bold; }
        .toc-icon { margin-right: 8px; }
        .toc-arrow { margin-right: 5px; width: 15px; text-align: center; transition: transform 0.2s; display: inline-block; }
        .toc-arrow.rotated { transform: rotate(90deg); }
        .toc-children { margin-left: 20px; border-left: 1px solid var(--border-color); display: none; }

        /* --- COLUNA 2: √ÅREA DE LEITURA --- */
        #book-main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            min-width: 0; /* Importante para flexbox */
        }

        #book-content-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 40px 60px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            line-height: 1.8;
        }

        #read-title { font-size: 2.5em; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); color: var(--accent-color); }
        #read-body { font-size: 1.1em; }
        
        /* Estilos de Entidades e Tags */
        .tag { background-color: #3a5370; color: #4a90e2; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; margin-right: 5px; cursor: pointer; }
        .tag:hover { background-color: var(--accent-color); color: white; }
        
        .entity-link { 
            color: var(--accent-color); 
            border-bottom: 1px dashed var(--accent-color); 
            cursor: pointer; 
            background-color: rgba(74, 144, 226, 0.1);
        }
        .entity-link:hover { background-color: rgba(74, 144, 226, 0.3); }

        /* Cores espec√≠ficas por tipo (iguais ao note.html) */
        .entity-link[data-entity-type="personagem"] { color: #e67e22; border-color: #e67e22; background-color: rgba(230, 126, 34, 0.1); }
        .entity-link[data-entity-type="local"] { color: #2ecc71; border-color: #2ecc71; background-color: rgba(46, 204, 113, 0.1); }
        .entity-link[data-entity-type="data"] { color: #9b59b2; border-color: #9b59b2; background-color: rgba(155, 89, 182, 0.1); }

        /* --- COLUNA 3 (Refer√™ncias) --- */
        #references-panel {
            flex: 0 0 0; /* Largura inicial 0 */
            width: 0;
            background-color: var(--sidebar-color);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            opacity: 0;
        }

        /* Classe ativada via JS para mostrar o painel */
        .book-container.references-visible #references-panel {
            flex: 0 0 400px; /* Largura expandida */
            padding: 20px;
            opacity: 1;
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-header h2 { font-size: 18px; font-weight: 500; color: var(--text-color); }
        #close-ref-btn { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
        
        #ref-description { 
            font-size: 0.9em; color: var(--text-muted); margin-bottom: 20px; 
            padding-left: 10px; border-left: 3px solid var(--accent-color); line-height: 1.5; 
        }

        #ref-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        
        .reference-item { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-color); }
        .reference-item summary { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .reference-item summary:hover { color: var(--accent-color); }
        .reference-context { padding: 10px; border-top: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-muted); line-height: 1.5; }
        .reference-context mark { background-color: rgba(74, 144, 226, 0.4); color: white; padding: 0 2px; border-radius: 2px; }

        .go-to-btn { background: none; border: 1px solid var(--text-muted); color: var(--text-muted); border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.8em; }
        .go-to-btn:hover { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }
        .empty-state span { font-size: 3em; margin-bottom: 20px; }

    </style>
</head>
<body>

<div class="book-container" id="main-container">
    
    <!-- 1. Barra Lateral -->
    <aside id="book-sidebar">
        <div class="sidebar-header">
            <h2>Os Meus Livros</h2>
            <p id="user-info">A carregar...</p>
        </div>
        <div id="book-toc"></div>
    </aside>

    <!-- 2. √Årea de Leitura -->
    <main id="book-main-panel">
        <div id="book-content-scroll">
            <div id="empty-placeholder" class="empty-state">
                <span>üìñ</span>
                <h2>Selecione uma nota para ler</h2>
            </div>
            
            <article id="reader-area" style="display: none;">
                <h1 id="read-title"></h1>
                <div id="read-body"></div>
            </article>
        </div>
    </main>

    <!-- 3. Painel de Refer√™ncias (Quarta Coluna) -->
    <aside id="references-panel">
        <div class="panel-header">
            <h2 id="ref-title">Refer√™ncias</h2>
            <button id="close-ref-btn" title="Fechar">√ó</button>
        </div>
        <p id="ref-description"></p>
        <ul id="ref-list"></ul>
    </aside>

</div>

<script type="module">
    import { db, auth } from './js/firebase-config.js';
    import { collection, query, where, getDocs, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    // --- ELEMENTOS DOM ---
    const mainContainer = document.getElementById('main-container');
    const tocContainer = document.getElementById('book-toc');
    const readArea = document.getElementById('reader-area');
    const emptyState = document.getElementById('empty-placeholder');
    const readTitle = document.getElementById('read-title');
    const readBody = document.getElementById('read-body');
    const userInfo = document.getElementById('user-info');
    
    // Refer√™ncias
    const refTitle = document.getElementById('ref-title');
    const refDesc = document.getElementById('ref-description');
    const refList = document.getElementById('ref-list');
    const closeRefBtn = document.getElementById('close-ref-btn');

    // --- CONFIGURA√á√ÉO DE ENTIDADES ---
    const ENTITY_CONFIG = {
        personagem: { collection: 'personagens' },
        local: { collection: 'locais' },
        data: { collection: 'datas' },
        textobiblico: { collection: 'textosbiblicos' }
    };

    // --- AUTENTICA√á√ÉO ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            alert("Sess√£o inv√°lida.");
            window.location.href = 'index.html';
        } else {
            userInfo.textContent = user.email;
            await loadBookStructure(user.uid);
        }
    });

    // --- 1. CARREGAR ESTRUTURA (LIVRO) ---
    async function loadBookStructure(userId) {
        tocContainer.innerHTML = '<p style="padding:10px; color:#888;">A carregar √≠ndice...</p>';
        try {
            const q = query(collection(db, 'pastas'), where('userId', '==', userId), where('estado', '==', 'ativa'), orderBy('ordem'));
            const snapshot = await getDocs(q);
            const items = [];
            snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));

            const rootItems = items.filter(i => !i.parentId);
            tocContainer.innerHTML = '';

            if (rootItems.length === 0) {
                tocContainer.innerHTML = '<p style="padding:10px;">Nenhum item encontrado.</p>';
                return;
            }

            const buildTree = (parentItems, container) => {
                parentItems.forEach(item => {
                    const children = items.filter(i => i.parentId === item.id);
                    const hasChildren = children.length > 0;
                    
                    const li = document.createElement('div');
                    li.className = 'toc-item';

                    const header = document.createElement('div');
                    header.className = 'toc-header';
                    
                    let icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';
                    let arrowHTML = (item.tipo === 'pasta') 
                        ? `<span class="toc-arrow ${hasChildren ? '' : 'hidden'}" style="${hasChildren ? '' : 'opacity:0'}">‚ñ∂</span>` 
                        : `<span class="toc-arrow"></span>`;
                    
                    header.innerHTML = `${arrowHTML} <span class="toc-icon">${icon}</span> ${item.nome}`;
                    header.dataset.id = item.id; // Guardar ID para refer√™ncia

                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'toc-children';

                    header.onclick = () => {
                        if (item.tipo === 'pasta') {
                            if (!hasChildren) return;
                            const arrow = header.querySelector('.toc-arrow');
                            if (childrenContainer.style.display === 'block') {
                                childrenContainer.style.display = 'none';
                                if(arrow) { arrow.textContent = '‚ñ∂'; arrow.classList.remove('rotated'); }
                            } else {
                                childrenContainer.style.display = 'block';
                                if(arrow) { arrow.textContent = '‚ñº'; arrow.classList.add('rotated'); }
                            }
                        } else {
                            displayNote(item);
                            document.querySelectorAll('.toc-header').forEach(el => el.classList.remove('active-note'));
                            header.classList.add('active-note');
                        }
                    };

                    li.appendChild(header);
                    if (hasChildren) {
                        buildTree(children, childrenContainer);
                        li.appendChild(childrenContainer);
                    }
                    container.appendChild(li);
                });
            };
            buildTree(rootItems, tocContainer);
        } catch (error) {
            console.error("Erro ao carregar livros:", error);
            tocContainer.innerHTML = '<p style="color:red; padding:10px;">Erro ao carregar dados.</p>';
        }
    }

    // --- 2. EXIBIR NOTA (CENTRO) ---
    function displayNote(noteData) {
        emptyState.style.display = 'none';
        readArea.style.display = 'block';
        readTitle.textContent = noteData.nome;
        readBody.innerHTML = noteData.conteudo || '<p><em>Nota vazia.</em></p>';

        // Reset links externos
        const links = readBody.querySelectorAll('a:not([data-anexo-id])');
        links.forEach(a => { a.target = '_blank'; a.style.cursor = 'pointer'; });

        document.getElementById('book-content-scroll').scrollTop = 0;

        // Se abriu uma nova nota, talvez queira fechar o painel lateral para focar na leitura?
        // hideReferencesPanel(); // Opcional: descomente se preferir fechar ao mudar de nota
    }

    // --- 3. INTERA√á√ÉO E REFER√äNCIAS ---

    // Detetar cliques no corpo do texto
    readBody.addEventListener('click', (e) => {
        const entityLink = e.target.closest('.entity-link');
        const tagLink = e.target.closest('.tag');

        if (entityLink) {
            e.preventDefault();
            const name = entityLink.dataset.entityName;
            const type = entityLink.dataset.entityType;
            
            // Precisamos encontrar o ID da entidade pelo nome.
            // Como n√£o temos o ID no dataset do HTML (apenas nome e tipo),
            // vamos buscar ao Firebase.
            findAndShowEntity(name, type);
        } 
        else if (tagLink) {
            e.preventDefault();
            const tagName = tagLink.textContent.replace('#', '').trim();
            showTagReferences(tagName);
        }
    });

    closeRefBtn.addEventListener('click', hideReferencesPanel);

    function hideReferencesPanel() {
        mainContainer.classList.remove('references-visible');
    }

   async function findAndShowEntity(name, type) {
        mainContainer.classList.add('references-visible');
        refTitle.textContent = `Refer√™ncias: "${name}"`;
        refDesc.textContent = 'A procurar detalhes...';
        refList.innerHTML = '<li>A carregar...</li>';

        const config = ENTITY_CONFIG[type];
        if (!config) return;

        // Verifica√ß√£o de seguran√ßa
        if (!auth.currentUser) {
             refList.innerHTML = '<li>Sess√£o inv√°lida.</li>';
             return;
        }

        try {
            // 1. Encontrar a entidade pelo nome E pelo userId
            const qEntity = query(
                collection(db, config.collection), 
                where('nome', '==', name),
                where('userId', '==', auth.currentUser.uid) // <--- CORRE√á√ÉO AQUI
            );
            
            const snapEntity = await getDocs(qEntity);

            if (snapEntity.empty) {
                refDesc.textContent = 'Entidade n√£o encontrada no √≠ndice.';
                refList.innerHTML = '';
                return;
            }

            const entityData = snapEntity.docs[0].data();
            refDesc.textContent = entityData.descricao || 'Sem descri√ß√£o dispon√≠vel.';
            refList.innerHTML = '';

            // 2. Carregar notas referenciadas
            if (entityData.referencias) {
                const noteIds = Object.keys(entityData.referencias);
                await loadLinkedNotes(noteIds, name);
            } else {
                refList.innerHTML = '<li style="padding:10px; color:#888;">Nenhuma refer√™ncia encontrada.</li>';
            }

        } catch (error) {
            console.error("Erro na entidade:", error); // Log √∫til para debug
            refList.innerHTML = '<li>Erro de permiss√£o ou dados.</li>';
        }
    }

   async function showTagReferences(tagName) {
        mainContainer.classList.add('references-visible');
        refTitle.textContent = `Tag: #${tagName}`;
        refDesc.textContent = '';
        refList.innerHTML = '<li>A pesquisar notas...</li>';

        // Verifica√ß√£o de seguran√ßa
        if (!auth.currentUser) return;

        try {
            const q = query(
                collection(db, 'pastas'), 
                where('tags', 'array-contains', tagName),
                where('estado', '==', 'ativa'),
                where('userId', '==', auth.currentUser.uid) // <--- CORRE√á√ÉO AQUI
            );
            
            const snapshot = await getDocs(q);
            refList.innerHTML = '';

            if (snapshot.empty) {
                refList.innerHTML = '<li style="padding:10px;">Nenhuma nota com esta tag.</li>';
                return;
            }

            snapshot.forEach(doc => {
                createReferenceItem(doc.id, doc.data(), tagName, true); 
            });

        } catch (error) {
            console.error("Erro na tag:", error);
            refList.innerHTML = '<li>Erro ao buscar tags.</li>';
        }
    }

    async function loadLinkedNotes(noteIds, highlightTerm) {
        // Carrega as notas em paralelo
        const promises = noteIds.map(id => getDoc(doc(db, 'pastas', id)));
        const docs = await Promise.all(promises);

        let found = false;
        docs.forEach(d => {
            if (d.exists() && d.data().estado === 'ativa') {
                createReferenceItem(d.id, d.data(), highlightTerm);
                found = true;
            }
        });

        if (!found) {
            refList.innerHTML = '<li style="padding:10px; color:#888;">Nenhuma nota ativa encontrada.</li>';
        }
    }

    function createReferenceItem(id, data, term, isTag = false) {
        const details = document.createElement('details');
        details.className = 'reference-item';
        
        const summary = document.createElement('summary');
        
        const titleSpan = document.createElement('span');
        titleSpan.textContent = data.nome;

        // Bot√£o "Ir" (Neste modo livro, carrega a nota no painel central)
        const btn = document.createElement('button');
        btn.className = 'go-to-btn';
        btn.textContent = 'Ler';
        btn.onclick = (e) => {
            e.preventDefault(); // Impede o toggle do details
            // Simula um objeto de nota para usar na fun√ß√£o displayNote
            const noteObj = { id: id, ...data };
            displayNote(noteObj);
            
            // Atualiza a √°rvore (Tree View) para mostrar qual est√° ativa
            document.querySelectorAll('.toc-header').forEach(el => {
                el.classList.remove('active-note');
                if(el.dataset.id === id) el.classList.add('active-note');
            });
        };

        summary.appendChild(titleSpan);
        summary.appendChild(btn);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'reference-context';
        
        if (isTag) {
            contentDiv.innerHTML = `<p>Nota marcada com #${term}</p>`;
        } else {
            contentDiv.innerHTML = generateContext(data.conteudo, term);
        }

        details.appendChild(summary);
        details.appendChild(contentDiv);
        refList.appendChild(details);
    }

    function generateContext(htmlContent, term) {
        const temp = document.createElement('div');
        temp.innerHTML = htmlContent;
        const text = temp.textContent || temp.innerText || "";
        
        const index = text.toLowerCase().indexOf(term.toLowerCase());
        if (index === -1) return "Contexto n√£o encontrado.";

        const start = Math.max(0, index - 40);
        const end = Math.min(text.length, index + term.length + 40);
        
        let snippet = text.substring(start, end);
        // Highlight simples
        const regex = new RegExp(`(${term})`, 'gi');
        snippet = snippet.replace(regex, "<mark>$1</mark>");

        return `...${snippet}...`;
    }

</script>
</body>
</html>
