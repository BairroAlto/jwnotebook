<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - Notes</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczNbOBxcAwWmdQfM23rP7EAZINaQRQFX53uMo14hPhWvC3lsPy1inv3b42P5T2iFJ8Ot-bsLFUcOb0G4tVevedv1jtFxTlzGHyc00ddx94QViaji6vp0KuRcw1eC_WbddVVCPidHPoCJLZuwNdbr02ZC=w192-h192-s-no-gm?authuser=4">

   
  
<style>
/* ============================================================
   VARI√ÅVEIS E RESET
   ============================================================ */
:root {
    --bg-color: #1a1a1d;
    --sidebar-color: #252528;
    --panel-color: #1f1f22;
    --accent-color: #4a90e2;
    --text-color: #f0f0f0;
    --text-muted-color: #888;
    --border-color: #333;
    --hover-color: #2c2c30;
    --selected-color: #3a5370;
    
    /* Cores Espec√≠ficas para Modos */
    --question-color: #1e8449;
    --question-bg: rgba(20, 90, 50, 0.08);
    --container-color: #e67e22; /* Laranja */
    --container-bg: rgba(230, 126, 34, 0.08);
    
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-color); 
    overflow: hidden; 
    height: 100vh; 
}

/* Scrollbars Modernas */
* { scrollbar-width: thin; scrollbar-color: var(--text-muted-color) var(--panel-color); }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--panel-color); border-radius: 10px; }
::-webkit-scrollbar-thumb {
    background-color: var(--text-muted-color); border-radius: 10px;
    border: 2px solid var(--panel-color);
}
::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

/* ============================================================
   ESTRUTURA PRINCIPAL (LAYOUT)
   ============================================================ */
.notebook-container { display: flex; height: 100vh; width: 100vw; }
#left-panel, #middle-panel, #right-panel { height: 100%; display: flex; flex-direction: column; }

/* 1. PAINEL ESQUERDO (PASTAS) */
#left-panel { 
    flex: 0 0 240px; 
    background-color: var(--sidebar-color); 
    border-right: 1px solid var(--border-color); 
    padding: 15px; 
    justify-content: space-between; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden;
}

/* 2. PAINEL DO MEIO (LISTA DE NOTAS) */
#middle-panel { 
    /* IGUAL √Ä PRIMEIRA COLUNA (240px) */
    flex: 0 0 240px; 
    
    background-color: var(--panel-color); 
    border-right: 1px solid var(--border-color); 
    padding: 20px; 
    transition: all 0.3s ease; 
    overflow: hidden;
}

/* 3. PAINEL DIREITO (EDITOR - A NOTA) */
#right-panel { 
    flex: 1; /* Ocupa o espa√ßo que sobrar */
    min-width: 0; /* CR√çTICO: Permite que o editor encolha quando a 4¬™ coluna abre */
    background-color: var(--bg-color); 
    padding: 20px; 
    position: relative; 
    transition: all 0.3s ease;
}

/* ESTILOS DO SELETOR LOCAL | PARTILHA */
.folder-mode-container {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 18px;
    font-weight: 500;
    color: var(--text-muted-color);
}

.folder-mode-item {
    cursor: pointer;
    transition: color 0.2s, text-shadow 0.2s;
    user-select: none;
    position: relative;
}

.folder-mode-item:hover {
    color: var(--text-color);
}

.folder-mode-item.active {
    color: var(--text-color);
    font-weight: bold;
}

/* Pequeno ponto azul por baixo do ativo */
.folder-mode-item.active::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--accent-color);
    border-radius: 2px;
}

.folder-mode-separator {
    color: var(--border-color);
    font-weight: normal;
    font-size: 0.9em;
}

/* ============================================================
   4. PAINEL DE REFER√äNCIAS (4¬™ COLUNA) - AJUSTE DE TAMANHO
   ============================================================ */
#references-panel {
    flex: 0 0 0; 
    width: 0; 
    background-color: var(--sidebar-color); 
    padding: 0; 
    height: 100%;
    display: flex; 
    flex-direction: column; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden; 
    opacity: 0;
    border-left: 1px solid var(--border-color);
}

/* QUANDO ABERTO: FOR√áA 50% DA LARGURA DO ECR√É */
.notebook-container.references-panel-visible #references-panel {
    display: flex !important; /* Garante que n√£o est√° como none */
    flex: 0 0 400px !important; 
    width: 400px !important;
    min-width: 400px !important;
    opacity: 1 !important;
    visibility: visible !important;
    padding: 20px !important;
    border-left: 1px solid var(--border-color) !important;
}

/* No PC, o painel direito deve encolher para dar lugar √† 4¬™ coluna */
.notebook-container.references-panel-visible #right-panel {
    flex: 1 !important;
    min-width: 0 !important;
}


/* ============================================================
   CORRE√á√ÉO DO BOT√ÉO TOGGLE ‚Üñ (COLLAPSE DA ESQUERDA)
   ============================================================ */

/* 1. Quando ativo, ESCONDE o painel esquerdo (Pastas) */
.notebook-container.middle-panel-collapsed #left-panel {
    display: none !important;
    width: 0 !important;
    flex: 0 0 0 !important;
    padding: 0 !important;
    border: none !important;
}

/* 2. O painel do Meio (Lista) mant√©m o tamanho normal */
.notebook-container.middle-panel-collapsed #middle-panel {
    width: 240px !important; 
    flex: 0 0 240px !important;
}

/* 3. O painel da Direita (Editor) ocupa todo o espa√ßo restante */
.notebook-container.middle-panel-collapsed #right-panel {
    display: flex !important;
    flex: 1 !important;
    opacity: 1 !important;
}

/* 4. Ajustes do Cabe√ßalho para manter tudo bonito */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header {
    display: flex !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
}

/* Garante que os bot√µes do cabe√ßalho continuam vis√≠veis */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header > * {
    display: flex !important;
}

/* --- ESTILO VERMELHO PARA O BOT√ÉO ADICIONAR (MODO PARTILHA) --- */
#add-item-btn.shared-mode {
    border-color: #e74c3c !important;
    color: #e74c3c !important;
}

#add-item-btn.shared-mode:hover {
    background-color: #e74c3c !important;
    color: white !important;
}

/* ============================================================
   ELEMENTOS INTERNOS (Listas, Bot√µes, etc)
   ============================================================ */
.panel-content { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
#left-panel-list, #file-list { list-style-type: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }

/* Cabe√ßalhos e Rodap√©s de Painel */
.panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.panel-header h2 { font-size: 18px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
.panel-footer { padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }

/* Bot√µes de Controlo de Painel */
#left-panel-toggle-btn { display: none; background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 32px; height: 32px; border-radius: 5px; font-size: 20px; cursor: pointer; margin: 15px auto; }
#left-panel-toggle-btn:hover { background-color: var(--accent-color); }

#middle-panel-toggle-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; line-height: 1; margin-right: 10px; }
#middle-panel-toggle-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

#back-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; margin-right: 10px; }
#back-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

/* Tabs */
.tabs-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
.tabs-container button { background: none; border: none; color: var(--text-muted-color); padding: 10px; flex-grow: 1; text-align: center; font-size: 15px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
.tabs-container button:hover { background-color: var(--hover-color); color: var(--text-color); }
.tabs-container button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
#left-panel hr { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0 15px 0; }

/* Listas (Esquerda e Meio) */
.list-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s ease; display: flex; align-items: center; user-select: none; position: relative; }
.list-item:before { font-size: 18px; margin-right: 10px; }
.list-item[data-type="pasta"]:before { content: 'üìÅ'; }
.list-item[data-type="nota"]:before { content: 'üìÑ'; }
.list-item[data-type="agregacao"]:before { content: 'üß¨'; } 
.list-item[data-type="arquivo"]:before { content: 'üóÑÔ∏è'; }
.list-item[data-type="partilhado"]:before { content: 'üóÑÔ∏è'; }
.list-item:hover { background-color: var(--hover-color); }
.list-item.selected { background-color: var(--selected-color); }

/* Menu de 3 pontos no item */
.item-menu-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 20px; padding: 0 8px; border-radius: 5px; cursor: pointer; display: none; }
.list-item:hover .item-menu-btn { display: block; }
.item-menu-btn:hover { background-color: var(--bg-color); color: var(--text-color); }

/* Bot√µes de A√ß√£o Rodap√©/Topo */
#add-item-btn { background: none; border: 2px solid var(--accent-color); color: var(--accent-color); width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
#add-item-btn:hover { background-color: var(--accent-color); color: white; }
#settings-btn, #account-btn, #global-search-btn { background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; flex-grow: 1; /* Isto faz com que dividam o espa√ßo igualmente */ text-align: center; padding: 5px; border-radius: 5px; }
#settings-btn:hover, #account-btn:hover, #global-search-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* ============================================================
   CORRE√á√ÉO DE TEXTO LONGO NAS LISTAS (QUEBRA DE LINHA)
   ============================================================ */

/* 1. Garante que a lista nunca tem scroll horizontal */
#left-panel-list, #file-list {
    overflow-x: hidden !important;
}

/* 2. Ajuste no contentor do item para permitir altura vari√°vel */
.list-item {
    height: auto !important; /* Permite crescer em altura */
    min-height: 44px; /* Altura m√≠nima para ser clic√°vel */
    align-items: center !important; /* Mant√©m √≠cone centrado verticalmente */
}

/* 3. A regra principal: For√ßa o texto (span) a quebrar linha */
.list-item span {
    white-space: normal !important;   /* Permite quebra de linha */
    word-break: break-word !important; /* Quebra palavras muito longas */
    overflow-wrap: break-word !important; /* Standard moderno */
    line-height: 1.4 !important;      /* Espa√ßamento para leitura f√°cil */
    flex: 1;                          /* Ocupa o espa√ßo dispon√≠vel */
    padding-right: 5px;               /* Espa√ßo para n√£o colar √† direita */
}

/* ============================================================
   PAINEL DIREITO: EDITOR
   ============================================================ */
#editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted-color); text-align: center; height: 100%;}
#editor-placeholder .placeholder-icon { font-size: 60px; margin-bottom: 20px; }
#note-title-input { background: none; border: none; color: var(--text-color); font-size: 2.5em; font-weight: bold; padding: 10px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); outline: none; width: 100%; }

/* Barra de Ferramentas Principal */
#editor-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 6px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
}
.toolbar-group { display: flex; align-items: center; gap: 5px; }
#editor-toolbar button, #secondary-toolbar button {
    background: var(--hover-color); border: none; color: var(--text-color); min-width: 32px; height: 32px;
    padding: 0 8px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#editor-toolbar button:hover, #secondary-toolbar button:hover { background-color: var(--accent-color); }
#editor-toolbar input[type="color"], #secondary-toolbar input[type="color"] {
    width: 32px; height: 32px; border: none; background: none; cursor: pointer; padding: 2px;
}
.toolbar-separator { width: 1px; height: 25px; background-color: var(--border-color); margin: 0 10px; }
.toolbar-history { margin-left: auto; display: flex; align-items: center; }

/* Barra de Ferramentas Secund√°ria */
#secondary-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 0 0 6px 6px; margin-top: -10px; margin-bottom: 15px; flex-wrap: wrap;
    gap: 10px; border-top: 1px solid var(--border-color); animation: slideDown 0.2s ease-out;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
#toggle-more-tools-btn.active { background-color: var(--selected-color); transform: rotate(180deg); }

/* Zoom Select */
#editor-zoom {
    background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color);
    border-radius: 5px; padding: 0 5px; height: 32px; cursor: pointer; outline: none; font-size: 14px; margin-right: 5px;
}
#editor-zoom:hover { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
#editor-zoom option { background-color: var(--sidebar-color); color: var(--text-color); }

/* Conte√∫do Edit√°vel */
#note-content-editor {
    position: relative; 
    background: none; 
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; 
    padding: 5px;
    
    /* --- CORRE√á√ÉO PARA MOBILE --- */
    -webkit-overflow-scrolling: touch; /* Ativa o scroll suave (in√©rcia) no iPhone/Android */
    overscroll-behavior-y: contain;    /* Impede que o scroll "puxe" a p√°gina toda */
    touch-action: pan-y;               /* Melhora a dete√ß√£o do dedo para scroll vertical */
     overflow-wrap: break-word; 
    word-wrap: break-word;
    word-break: break-word;
}

/* Adicione isto em qualquer lugar no seu CSS principal */
#note-content-editor {
    position: relative; 
    background: none; 
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    
    /* --- CORRE√á√ÉO DE SCROLL --- */
    flex: 1;                 /* Ocupa todo o espa√ßo restante */
    overflow-y: auto;        /* Ativa o scroll vertical AQUI */
    overflow-x: hidden; 
    min-height: 0;           /* Refor√ßo para o Firefox/Safari mobile */
    padding: 5px 5px 50px 5px; /* Padding extra no fundo para o teclado n√£o tapar texto */
    
    /* --- MOTOR DE TOQUE NATIVO --- */
    -webkit-overflow-scrolling: touch; 
    touch-action: pan-y;
}

#note-content-editor h1 { font-size: 2em; font-weight: bold; border-bottom: 1px solid var(--border-color); color: var(--accent-color); margin: 0.6em 0; }
#note-content-editor h2 { font-size: 1.5em; font-weight: bold; color: var(--text-color); margin: 0.5em 0; }
#note-content-editor h3 { font-size: 1.17em; font-weight: bold; color: var(--text-muted-color); margin-bottom: 0.5em; }
#note-content-editor h4 { font-size: 1em; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5em; }
#note-content-editor p { margin: 0.5em 0; }

/* For√ßa consist√™ncia de tamanho dentro do editor */
#note-content-editor p, 
#note-content-editor div, 
#note-content-editor li, 
#note-content-editor span {
    font-size: inherit; /* Herda o tamanho do pai (o editor) */
    line-height: inherit;
}

/* Tags e Entidades no Texto */
.tag { background-color: var(--selected-color); color: var(--accent-color); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
.entity-link { background-color: rgba(74, 144, 226, 0.2); border-bottom: 1px dashed var(--accent-color); cursor: pointer; }
.entity-link[data-entity-type="personagem"] { background-color: rgba(230, 126, 34, 0.2); border-bottom-color: #e67e22; }
.entity-link[data-entity-type="local"] { background-color: rgba(46, 204, 113, 0.2); border-bottom-color: #2ecc71; }
.entity-link[data-entity-type="data"] { background-color: rgba(155, 89, 182, 0.2); border-bottom-color: #9b59b2; }
a[data-anexo-id] { color: inherit; text-decoration: none; border-bottom: 1px dotted var(--accent-color); cursor: pointer; }
.idea-span { text-decoration: underline; text-decoration-color: #e74c3c; text-decoration-thickness: 3px; cursor: pointer; background-color: rgba(231, 76, 60, 0.1); }
.idea-span:hover { background-color: rgba(231, 76, 60, 0.2); }

/* ============================================================
   POST-IT FLUTUANTE (Amarelo, Arrast√°vel)
   ============================================================ */
.post-it-note {
    position: absolute; display: flex; flex-direction: column;
    background-color: #fff9c4; border: 1px solid #f1c40f;
    resize: both; overflow: hidden; min-width: 150px; min-height: 80px;
    box-shadow: 4px 4px 10px rgba(0,0,0,0.2); z-index: 20;
}
.post-it-note::-webkit-resizer { background-color: #f1c40f; }
.post-it-note.active-note { border-color: #f39c12; z-index: 50; }

.post-it-drag-handle {
    position: absolute; top: 0; right: 0; width: 25px; height: 25px;
    background-color: #f1c40f; color: #333; cursor: grab; z-index: 10;
    display: flex; align-items: center; justify-content: center;
    border-bottom-left-radius: 4px; user-select: none;
}
.post-it-drag-handle:active { cursor: grabbing; background-color: #d4ac0d; }
.post-it-drag-handle:hover { background-color: #d4ac0d; }

.post-it-cut-btn {
    position: absolute; top: 0; left: 0; width: 25px; height: 25px;
    background-color: transparent; cursor: pointer; z-index: 100;
    display: none; align-items: center; justify-content: center;
    font-size: 16px; user-select: none; border-bottom-right-radius: 4px;
}
.post-it-note.active-note .post-it-cut-btn { display: flex; }
.post-it-cut-btn:hover { background-color: rgba(0,0,0,0.1); }

.post-it-content {
    background-color: transparent; color: #333; padding: 10px;
    height: 100%; width: 100%; outline: none; overflow-y: auto; cursor: text; user-select: text;
}

/* ============================================================
   MINI-NOTAS & QUEST√ïES (Embutidas no texto)
   ============================================================ */
/* Estilo Base (SubNota Padr√£o) */
.mini-note-wrapper {
    display: block; position: relative; margin: 30px -25px; width: auto;
    background-color: rgba(255, 255, 255, 0.03);
    border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
    padding: 20px 25px; box-sizing: border-box;
}
.mini-note-wrapper::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
    background: var(--accent-color); opacity: 0.8;
}

/* Modo Quest√£o (Verde) */
.mini-note-wrapper.question-mode {
    background-color: var(--question-bg);
    border-color: var(--question-color);
}
.mini-note-wrapper.question-mode::before { background: var(--question-color); }

/* Componentes Internos */
.mini-note-title-input {
    display: block;
    width: 100%;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid var(--border-color) !important;
    color: var(--accent-color) !important;
    
    /* FOR√áA A FONTE ORIGINAL DO TEU SITE */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 1.4em !important;
    font-weight: bold !important;
    
    padding: 0 !important;
    margin: 0 0 15px 0 !important;
    outline: none !important;
    resize: none !important;
    
    /* REMOVE BARRA DE SCROLL E SETA */
    overflow: hidden !important; 
    line-height: 1.2 !important;
}

/* QUANDO A OP√á√ÉO EST√Å DESLIGADA (Imita o input antigo) */
.mini-note-title-input:not(.wrap-enabled) {
    white-space: nowrap !important; /* Impede quebra de linha */
    height: 1.5em !important;       /* Altura exata de uma linha */
}

/* QUANDO A OP√á√ÉO EST√Å LIGADA */
.mini-note-title-input.wrap-enabled {
    white-space: pre-wrap !important; /* Permite quebra de linha */
    height: auto;
}

/* Garante que se for Quest√£o, mant√©m o Verde */
.mini-note-wrapper.question-mode .mini-note-title-input {
    color: var(--question-color) !important;
}

/* Quando a configura√ß√£o estiver ativa, o campo expande */
.mini-note-title-input.wrap-enabled {
    word-break: break-word;
}

.mini-note-wrapper.question-mode .mini-note-title-input { color: var(--question-color); }

.mini-note-content {
    outline: none; min-height: 60px; font-size: 1em; line-height: 1.6; color: var(--text-color); padding: 5px;
}

.mini-note-toolbar {
    display: flex; justify-content: flex-end; background: transparent;
    padding: 0; margin-bottom: 5px; border: none; height: 30px;
    font-size: 0 !important;
}
.mini-note-toolbar button[data-action="delete-mini-note"] {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); color: #e74c3c; border-color: #e74c3c;
}
.mini-note-wrapper.question-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(30, 132, 73, 0.15); color: var(--question-color); border-color: var(--question-color);
}
/* Esconde bot√µes desnecess√°rios dentro da mini-nota */
.mini-note-toolbar button:not([data-action="sharing-settings"]):not([data-action="delete-mini-note"]):not([data-action="manage-mini-note-topics"]):not([data-action="highlight-color"]):not([data-action="append-mini-note"]):not([data-action="move-up"]):not([data-action="move-down"]):not([data-action="manage-box-links"]),
.mini-note-toolbar input[type="color"],
.mini-note-toolbar .toolbar-separator { 
    display: none !important; 
}

/* Atualiza√ß√£o na sec√ß√£o .mini-note-toolbar */
.mini-note-toolbar button {
    background: none; 
    border: 1px solid var(--border-color); 
    color: var(--text-muted-color);
    width: 30px; 
    height: 30px; 
    border-radius: 4px; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s;
    margin-left: 5px; /* Espa√ßo entre bot√µes */
    font-size: 14px !important;
}

/* Hover espec√≠fico para o bot√£o de T√≥picos */
.mini-note-toolbar button[data-action="manage-mini-note-topics"]:hover {
    background-color: rgba(74, 144, 226, 0.1); 
    color: var(--accent-color); 
    border-color: var(--accent-color);
}

/* Mant√©m o hover vermelho para o lixo */
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); 
    color: #e74c3c; 
    border-color: #e74c3c;
}

/* Modo Contentor Livre (Laranja) */
.mini-note-wrapper.free-mode {
    background-color: var(--container-bg);
    border-color: var(--container-color);
}
.mini-note-wrapper.free-mode::before { 
    background: var(--container-color); 
}

/* Ajuste da Toolbar no modo livre (j√° que n√£o tem t√≠tulo, garantimos que fica no topo) */
.mini-note-wrapper.free-mode .mini-note-toolbar {
    margin-bottom: 0;
    padding-bottom: 5px;
}

/* Hover dos bot√µes no modo laranja */
.mini-note-wrapper.free-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(230, 126, 34, 0.15); 
    color: var(--container-color); 
    border-color: var(--container-color);
}

/* ============================================================
   POPUPS E MODAIS
   ============================================================ */
/* Popups Flutuantes (Sele√ß√£o e Inser√ß√£o) */
#selection-popup, #insertion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 30px; padding: 5px 10px; display: flex; gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4); align-items: center; z-index: 1010;
}
#selection-popup button, #insertion-popup button {
    background: none; border: none; color: var(--text-color); padding: 6px;
    cursor: pointer; border-radius: 50%; font-size: 18px; line-height: 1;
    transition: transform 0.2s, background-color 0.2s; width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
}
#selection-popup button:hover, #insertion-popup button:hover {
    background-color: var(--hover-color); transform: scale(1.15);
}


.popup-separator { width: 1px; height: 20px; background-color: var(--text-muted-color); opacity: 0.4; margin: 0 4px; }

/* Popup de Sugest√£o (Tags/Entidades) */
.suggestion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-height: 250px; overflow-y: auto; width: 350px;
}
.suggestion-list { list-style: none; padding: 5px; }
.suggestion-list li {
    padding: 8px 12px; border-radius: 4px; cursor: pointer; color: var(--text-color);
    display: flex; align-items: center;
}
.suggestion-list li:hover, .suggestion-list li.selected { background-color: var(--accent-color); color: white; }
#entity-suggestion-popup .suggestion-list li span { margin-left: auto; padding-left: 1em; }
#entity-suggestion-popup .suggestion-list li:hover span, #entity-suggestion-popup .suggestion-list li.selected span { color: white !important; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="personagem"] span { color: #e67e22; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="local"] span { color: #2ecc71; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="data"] span { color: #9b59b2; font-weight: 500; }

/* Menu de Contexto (3 Pontos) */
.context-menu {
    position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001;
    display: flex; flex-direction: column; padding: 5px; width: 160px;
}
.context-menu button {
    background: none; border: none; color: var(--text-color); padding: 8px 15px;
    text-align: left; cursor: pointer; border-radius: 4px; width: 100%; white-space: nowrap;
}
.context-menu button:hover { background-color: var(--accent-color); color: white; }

/* Modais (Sobreposi√ß√£o) */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center;
    align-items: center; z-index: 1000;
}
.modal-content {
    background-color: var(--sidebar-color); padding: 30px; border-radius: 8px;
    width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-content h3 { margin-bottom: 20px; font-size: 22px; }
.modal-content p { margin-bottom: 20px; color: var(--text-muted-color); }
.modal-content input[type="text"], .modal-content input[type="password"], .modal-content textarea {
    width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color);
    border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;
}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
.modal-btn:hover { opacity: 0.9; }
.modal-btn.primary { background-color: var(--accent-color); color: white; }
.modal-btn.secondary { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos Espec√≠ficos de Modais */
#add-item-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
#add-item-options button {
    background-color: var(--panel-color); border: 1px solid var(--border-color);
    color: var(--text-color); padding: 15px; text-align: left; border-radius: 5px;
    cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#add-item-options button:hover { background-color: var(--hover-color); }

.move-list { list-style: none; max-height: 40vh; overflow-y: auto; }
.move-list li {
    background-color: var(--bg-color); padding: 10px; border-radius: 5px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
}
.move-list .order-controls button {
    background: none; border: 1px solid var(--border-color); color: var(--text-color);
    width: 28px; height: 28px; cursor: pointer; border-radius: 5px; margin-left: 5px;
}
.move-list .order-controls button:hover { background-color: var(--hover-color); }
.move-list .order-controls button:disabled { opacity: 0.3; cursor: not-allowed; }

#link-modal .url-field-wrapper { display: flex; gap: 8px; }
#link-modal .remove-url-btn {
    background-color: #c0392b; color: white; padding: 0; width: 38px; height: 38px;
    min-width: unset; flex-shrink: 0; font-size: 24px; display: flex;
    align-items: center; justify-content: center;
}
#generic-list-modal-content, #view-link-modal .modal-content { max-width: 700px; }
#view-link-urls-list li { padding: 12px; background-color: var(--bg-color); }
#view-link-urls-list li a {
    color: var(--accent-color); text-decoration: none; display: block;
    word-break: break-all; font-weight: 500;
}
#view-link-urls-list li a:hover { text-decoration: underline; }

/* ============================================================
   PAINEL DE REFER√äNCIAS (4¬™ COLUNA)
   ============================================================ */
#references-panel {
    flex: 0 0 0; width: 0; background-color: var(--sidebar-color); padding: 0; height: 100%;
    display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; opacity: 0;
    border-left: 1px solid var(--border-color);
}

#references-panel-close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 24px; cursor: pointer; }
#references-panel-description {
    font-size: 0.85em;
    color: var(--text-muted-color);
    margin-bottom: 8px; /* Reduzido de 20px para 8px */
    padding: 0 5px;
    line-height: 1.5;
    font-style: italic;
    border-left: 3px solid var(--accent-color);
    padding-left: 10px;
}
.references-separator { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0; /* Reduzido de 15px para 5px */ }
#references-toolbar { display: flex; justify-content: space-around; align-items: center; padding: 0 10px; }
#references-toolbar button {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 20px;
    cursor: pointer; padding: 8px; border-radius: 5px; transition: all 0.2s ease; line-height: 1;
}
#references-toolbar button:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--border-color); }

#references-list { list-style-type: none; overflow-y: auto; flex-grow: 1; }
#references-list li {
    padding: 12px; border-radius: 5px; cursor: pointer; margin-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
}
#references-list li:hover { background-color: var(--hover-color); }
#references-list details.reference-item {
    padding: 12px; border-radius: 5px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color);
}
#references-list details.reference-item[open] { background-color: var(--hover-color); }
#references-list summary { cursor: pointer; font-weight: 500; list-style: none; display: flex; justify-content: space-between; align-items: center; }
#references-list summary::-webkit-details-marker { display: none; }
#references-list summary:hover { color: var(--accent-color); }
.reference-item.link-info summary { color: var(--accent-color); font-weight: bold; }
.reference-context {
    margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--accent-color);
    color: var(--text-muted-color); font-size: 0.9em; line-height: 1.5;
}
.reference-context mark { background-color: rgba(74, 144, 226, 0.4); color: var(--text-color); border-radius: 3px; padding: 1px 3px; }

/* Bot√£o "Ir para" nas refer√™ncias */
.go-to-note-btn {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 18px;
    cursor: pointer; padding: 4px 8px; border-radius: 5px; margin-left: 10px; line-height: 1;
    transition: all 0.2s ease; display: none;
}
.reference-item:hover .go-to-note-btn { display: block; }
.go-to-note-btn:hover { background-color: var(--hover-color); color: var(--accent-color); }

/* ============================================================
   OUTROS PAINEIS E UTILIT√ÅRIOS
   ============================================================ */
/* Modal de T√≥picos */
.topics-layout { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
.topics-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background-color: var(--bg-color);
    padding: 10px;
    min-height: 0; /* IMPORTANTE: permite que o conte√∫do interno encolha e ative o scroll */
}


.topics-list li {
    padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;
    display: flex; align-items: center; transition: background 0.2s;
}
.topics-list {
    list-style: none;
    overflow-y: auto;   /* Ativa o scroll vertical */
    flex-grow: 1;       /* Faz a lista ocupar o espa√ßo todo da coluna */
    max-height: 100%;   /* Garante que n√£o ultrapassa o limite do pai */
    padding-right: 5px; /* Espa√ßo para a barra de scroll n√£o tapar o texto */
}

/* Mantenha o que j√° tem abaixo */
.topics-list li {
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background 0.2s;
}
.topics-list li:hover { background-color: var(--hover-color); }
.topics-list li.active-topic { background-color: rgba(74, 144, 226, 0.2); border-left: 3px solid var(--accent-color); }
.topic-checkbox { margin-right: 10px; width: 16px; height: 16px; cursor: pointer; }
.create-btn { width: 100%; padding: 8px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
.topic-search-input { width: 100%; padding: 8px; margin-bottom: 10px; background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; }

/* Filtro e Pesquisa */
.filter-bar { display: flex; justify-content: flex-end; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); position: relative; }
.filter-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
.filter-btn:hover, .filter-btn.active { background-color: var(--hover-color); color: var(--text-color); border-color: var(--accent-color); }
.filter-popup { position: absolute; top: 35px; right: 0; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; width: 150px; display: none; flex-direction: column; }
.filter-popup button { background: none; border: none; color: var(--text-color); padding: 10px; text-align: left; cursor: pointer; font-size: 0.9em; }
.filter-popup button:hover { background-color: var(--hover-color); }
.filter-popup button.selected { color: var(--accent-color); font-weight: bold; }
.group-header { background-color: var(--hover-color); color: var(--accent-color); padding: 8px 10px; font-weight: bold; font-size: 0.85em; border-radius: 4px; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
.list-search-container { padding-bottom: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); cursor: default; }
.list-search-input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; outline: none; transition: border-color 0.2s; }
.list-search-input:focus { border-color: var(--accent-color); }

/* Configura√ß√µes (Switches) */
.setting-toggle-container { display: flex; align-items: center; margin-bottom: 15px; }
.setting-label { margin-left: 12px; font-size: 0.95em; color: var(--text-color); }
.setting-switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 20px; }
.slider.round:before { border-radius: 50%; }

/* Perfil */
.profile-info { text-align: center; margin-bottom: 20px; }
.profile-avatar { font-size: 50px; margin-bottom: 10px; display: block; }
.profile-name { font-size: 1.2em; font-weight: bold; color: var(--text-color); display: block; margin-bottom: 5px; }
.profile-email { color: var(--text-muted-color); font-size: 0.9em; }

/* Status de Grava√ß√£o */
.save-status { 
    font-size: 0.8em; 
    color: var(--text-muted-color); 
    margin-right: 15px; 
    transition: all 0.3s ease; 
    font-style: italic; 
    font-weight: 500;
    cursor: pointer;
}

.save-status:hover {
    text-decoration: underline;
    color: var(--accent-color);
}

.save-status.status-saved { color: #27ae60; cursor: default; }
.save-status.status-error { color: #c0392b; cursor: pointer; }
#connectivity-status { display: none; color: #e74c3c; font-weight: bold; margin-right: 15px; font-size: 0.8em; animation: blink 1.5s linear infinite; }
#connectivity-status.visible { display: inline; }
@keyframes blink { 50% { opacity: 0.5; } }

/* Spinner */
.spinner-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 0; color: var(--text-muted-color); font-size: 0.9em; font-style: italic; }
.spinner { width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1); border-left-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Marcadores (Bookmarks) */
.bookmark-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
.bookmark-item:hover { background-color: var(--hover-color); }
.bookmark-info { display: flex; flex-direction: column; }
.bookmark-title { font-weight: 500; color: var(--text-color); }
.bookmark-desc { font-size: 0.8em; color: var(--text-muted-color); }
.bookmark-check { width: 20px; height: 20px; border: 2px solid var(--text-muted-color); border-radius: 4px; margin-left: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.bookmark-item.active .bookmark-check { background-color: var(--accent-color); border-color: var(--accent-color); }
.bookmark-item.active .bookmark-check::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

/* √Çncoras e Tabs */
#anchors-content-container .tab-content { display: none; max-height: 50vh; overflow-y: auto; }
#anchors-content-container .tab-content.active { display: block; }
#anchors-content-container li { padding: 10px; border-radius: 5px; cursor: pointer; position: relative; }
#anchors-content-container li:hover { background-color: var(--hover-color); }
#anchors-content-container li.is-on-page { background-color: #27ae60; color: white; }
.entity-edit-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 22px; line-height: 1; padding: 5px; border-radius: 5px; cursor: pointer; display: none; }
#anchors-content-container li:hover .entity-edit-btn { display: block; }
.entity-edit-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos para a Aba de Pesquisa Global */
.search-container { padding: 10px; }
.global-search-input {
    width: 100%; padding: 12px; font-size: 16px;
    background-color: var(--bg-color); border: 2px solid var(--border-color);
    border-radius: 8px; color: var(--text-color); outline: none;
    transition: border-color 0.3s; margin-bottom: 20px;
}
.global-search-input:focus { border-color: var(--accent-color); }

.search-results-group { margin-bottom: 20px; }
.search-results-header {
    font-size: 0.9em; text-transform: uppercase; color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color); margin-bottom: 10px; padding-bottom: 5px;
}
.search-result-item {
    background-color: rgba(255, 255, 255, 0.03); border-radius: 6px;
    padding: 12px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
    border-left: 3px solid transparent;
}
.search-result-item:hover { background-color: var(--hover-color); border-left-color: var(--accent-color); }
.search-result-title { font-weight: bold; color: var(--accent-color); display: block; margin-bottom: 4px; }
.search-result-path { font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 6px; display: block; }
.search-match-context {
    font-size: 0.9em; color: var(--text-color); line-height: 1.5;
    background-color: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;
    font-family: monospace;
}
.search-match-context mark { background-color: rgba(241, 196, 15, 0.4); color: white; border-radius: 2px; padding: 0 2px; }
.search-badge {
    font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 8px;
    text-transform: uppercase; font-weight: bold;
}
.badge-pasta { background-color: rgba(52, 152, 219, 0.2); color: #3498db; }
.badge-nota { background-color: rgba(46, 204, 113, 0.2); color: #2ecc71; }
.badge-postit { background-color: rgba(241, 196, 15, 0.2); color: #f1c40f; }
.badge-question { background-color: rgba(39, 174, 96, 0.2); color: #27ae60; }

@keyframes flash-highlight {
    0% { background-color: rgba(241, 196, 15, 0.8); }
    100% { background-color: transparent; }
}

.temporary-highlight {
    animation: flash-highlight 2s ease-out;
}

/* --- ESTILOS DO MODAL DE DESTAQUES (NOVO) --- */
/* 1. Contentor do Modal */
/* 1. Contentor do Modal */
#highlight-modal .modal-content {
    max-width: 500px !important; 
    width: 95%;
    padding: 20px;
}

/* 2. Grelha das Op√ß√µes */
#highlight-options-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 colunas no PC */
    gap: 12px;
    max-height: 65vh; 
    overflow-y: auto;
    overflow-x: hidden;
    margin-top: 15px;
    padding: 5px;
}

/* 3. Item Individual (O Quadrado) */
#highlight-options-container .highlight-option-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 15px 5px 10px 5px; /* Espa√ßo no topo para o l√°pis n√£o bater */
    border-radius: 8px;
    cursor: pointer;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s;
    height: 100px; 
    position: relative; /* CR√çTICO: Base para o l√°pis no canto */
    text-align: center;
    box-sizing: border-box;
}

/* 4. A BOLA DA COR */
#highlight-options-container .color-preview-box {
    width: 28px !important;
    height: 28px !important;
    border-radius: 50%;
    margin-bottom: 8px;
    flex-shrink: 0;
    display: block !important;
    border: 1px solid rgba(255,255,255,0.2);
}

/* 5. O BOT√ÉO DO L√ÅPIS (REPOSICIONADO NO CANTO) */
#highlight-options-container .highlight-options-btn {
    position: absolute !important; /* Retira do fluxo vertical */
    top: 5px !important;           /* Cola no topo */
    right: 5px !important;         /* Cola na direita */
    width: 22px !important;        /* Tamanho pequeno */
    height: 22px !important;
    font-size: 12px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 0 !important;
    margin: 0 !important;
    opacity: 0.6;
    transition: opacity 0.2s, background 0.2s;
}

#highlight-options-container .highlight-options-btn:hover {
    opacity: 1;
    background: var(--accent-color) !important;
    color: white;
}

/* 6. Ajuste do Nome/Label */
#highlight-options-container .highlight-name-label {
    font-size: 11px;
    font-weight: 500;
    line-height: 1.2;
    color: var(--text-color);
    width: 90%;
    overflow: hidden;
}

/* 7. Media Query para Mobile (At√© 480px) */
@media (max-width: 480px) {
    #highlight-options-container {
        grid-template-columns: repeat(2, 1fr); /* 2 colunas no Mobile */
        gap: 10px;
    }
    #highlight-options-container .highlight-option-row {
        height: 110px;
    }
    #highlight-options-container .highlight-name-label {
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
}

/* 8. Bot√£o Remover Destaque */
#highlight-options-container .remove-highlight-row {
    grid-column: 1 / -1;
    flex-direction: row;
    height: 48px;
    gap: 10px;
    border: 1px dashed #e74c3c;
    color: #e74c3c;
    font-weight: bold;
}

/* 8. Estilo do Selecionado */
.highlight-option-row.selected-color-row {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,0.3);
}

.highlight-option-row.selected-color-row .highlight-options-btn {
    color: white !important;
    opacity: 1;
}

/* Check no canto */
.highlight-option-row.selected-color-row::after {
    content: '‚úì';
    position: absolute;
    top: 2px;
    left: 6px;
    font-weight: bold;
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ============================================================
   ESTILOS DE TABELA E MENU FLUTUANTE
   ============================================================ */
/* Estilo da Tabela no Editor */
.jwn-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 0.95em;
}
.jwn-table th, .jwn-table td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    min-width: 50px;
    position: relative;
}
.jwn-table th {
    background-color: var(--sidebar-color);
    font-weight: bold;
    text-align: left;
    color: var(--accent-color);
}
/* Efeito hover para saber onde estamos */
.jwn-table td:hover, .jwn-table th:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* Menu de Ferramentas de Tabela */
#table-tools-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2000;
    padding: 5px;
    gap: 5px;
    flex-wrap: wrap;
    max-width: 220px;
}
#table-tools-popup button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 14px;
    flex-grow: 1;
}
#table-tools-popup button:hover {
    background-color: var(--accent-color);
    color: white;
}
#table-tools-popup .sep {
    width: 100%;
    height: 1px;
    background: var(--border-color);
    margin: 3px 0;
}

/* Wrapper para posicionar o bot√£o relativo √† tabela */
.jwn-table-wrapper {
    position: relative;
    margin-top: 25px; /* Espa√ßo para o bot√£o */
    margin-bottom: 15px;
}

/* Bot√£o de Ferramentas da Tabela */
.table-settings-btn {
    position: absolute;
    top: -28px;
    right: 0;
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    border-radius: 4px 4px 0 0;
    padding: 2px 8px;
    font-size: 14px;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 5px;
}
.table-settings-btn:hover, .table-settings-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* ============================================================
   WIDGET DE CALEND√ÅRIO
   ============================================================ */
.jwn-calendar-widget {
    border: 1px solid var(--border-color);
    background-color: var(--sidebar-color);
    border-radius: 8px;
    padding: 10px;
    margin: 15px 0;
    width: 100%;
    max-width: 350px; /* Tamanho compacto */
    user-select: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Cabe√ßalho: M√™s + Bot√µes */
.cal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    color: var(--accent-color);
    font-weight: bold;
}
.cal-btn {
    background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text-muted-color); padding: 4px 8px; border-radius: 4px;
}
.cal-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Menu de Defini√ß√µes (Semana/M√™s/Ano) */
.cal-settings-menu {
    display: none;
    flex-direction: column; /* Organiza bot√µes verticalmente */
    gap: 8px;
    margin-bottom: 10px;
    background: var(--panel-color); /* Fundo um pouco mais claro que a base */
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
/* Bot√£o Eliminar Agenda */
.cal-delete-btn {
    width: 100%;
    background-color: rgba(231, 76, 60, 0.1); /* Fundo vermelho muito subtil */
    border: 1px solid #c0392b; /* Borda vermelha escura */
    color: #e74c3c; /* Texto vermelho vivo */
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}/* Efeito Hover (Ao passar o rato) */
.cal-delete-btn:hover {
    background-color: #c0392b; /* Fica vermelho s√≥lido */
    color: white; /* Texto passa a branco */
    border-color: #c0392b;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.cal-settings-menu.visible { display: flex; }
.cal-view-btn {
    font-size: 0.8em; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; background: var(--panel-color); color: var(--text-color);
}
.cal-view-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }

/* Grelha de Dias */
.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
}
.cal-day-header {
    font-size: 0.75em; color: var(--text-muted-color); padding-bottom: 5px;
}
.cal-day {
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    position: relative;
    border: 1px solid transparent;
}
.cal-day:hover { background-color: var(--hover-color); border-color: var(--border-color); }
.cal-day.empty { background: transparent; cursor: default; }
.cal-day.today { border: 1px solid var(--accent-color); font-weight: bold; color: var(--accent-color); }
.cal-day.has-task::after {
    content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
    width: 4px; height: 4px; background-color: #e74c3c; border-radius: 50%;
}

/* Estilos para o Seletor de Agrega√ß√£o */
.agreg-item {
    display: flex; 
    align-items: center; 
    padding: 10px; 
    border-bottom: 1px solid var(--border-color); 
    cursor: pointer;
}
.agreg-item:hover { background-color: var(--hover-color); }

/* Tipos de Item */
.agreg-type-folder { font-weight: bold; color: var(--text-color); }
.agreg-type-note { color: var(--text-muted-color); }

/* Caixas de Conte√∫do (Miniaturas) */
.agreg-box-item {
    background-color: rgba(255,255,255,0.03);
    margin: 5px 0;
    border-left: 4px solid transparent;
    padding: 10px;
    border-radius: 4px;
    display: flex;
    gap: 10px;
}
.agreg-box-item.selected {
    background-color: rgba(74, 144, 226, 0.15);
    border: 1px solid var(--accent-color);
}

/* Cores das Bordas das Caixas */
.agreg-box-question { border-left-color: #2ecc71; } /* Verde */
.agreg-box-subnote { border-left-color: #3498db; }  /* Azul */
.agreg-box-free { border-left-color: #e67e22; }     /* Laranja */

/* --- NOVO: POPUP DE DEFINI√á√ïES DE PARTILHA --- */
#share-settings-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2200;
    padding: 15px;
    width: 220px;
    flex-direction: column;
    gap: 10px;
}

#share-settings-popup h4 {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    text-transform: uppercase;
    color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
}

.share-toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95em;
    color: var(--text-color);
}

/* Estado visual do bot√£o na toolbar quando partilhado */
button.sharing-active {
    color: #2ecc71 !important; /* Verde */
    border-color: #2ecc71 !important;
    background-color: rgba(46, 204, 113, 0.1) !important;
}

/* ============================================================
   ESTILO T√çTULO TOGGLE (EXPANS√çVEL)
   ============================================================ */
details.toggle-section {
    margin: 15px 0;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.02);
    display: block; 
    height: auto; /* Garante que a altura √© autom√°tica */
}

details.toggle-section summary {
    padding: 10px;
    cursor: pointer;
    list-style: none !important;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
    user-select: none;
}

/* Remove a seta padr√£o no Chrome/Safari */
details.toggle-section summary::-webkit-details-marker {
   display: none !important;
}

details.toggle-section summary:hover {
    background-color: var(--hover-color);
}

details.toggle-section summary::marker {
    display: none !important; /* Refor√ßo para navegadores modernos */
}

/* A nossa seta personalizada */
details.toggle-section summary::before {
    content: '‚òÇ';
    display: inline-block;
    width: 20px;
    font-size: 12px;
    color: var(--text-muted-color);
    transition: transform 0.2s ease;
    margin-right: 8px;
}

/* Quando aberto, roda a seta */
details.toggle-section[open] summary::before {
    transform: rotate(90deg);
}

/* O T√≠tulo H2 l√° dentro */
details.toggle-section summary h2 {
    margin: 0;
    display: inline;
    border: none;
    font-size: 1.5em; /* Tamanho A2 */
    font-weight: bold;
    color: var(--text-color); /* Herda cor ou usa padr√£o */
}

/* O conte√∫do oculto */
details.toggle-section .toggle-content {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: rgba(0, 0, 0, 0.1);
    
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* Usa normal em vez de pre-wrap para evitar conflito com <br> */
    display: block;
    height: auto !important; /* For√ßa altura autom√°tica */
}

/* Bot√£o de eliminar dentro do Toggle */
.toggle-delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-delete-btn:hover {
    opacity: 1;
    background-color: rgba(192, 57, 43, 0.1); /* Fundo vermelho suave */
}

/* Garante que o T√≠tulo ocupa o espa√ßo todo para empurrar o lixo para a direita */
details.toggle-section summary h2 {
    flex-grow: 1;
}

/* Bot√£o do Pincel (igual ao do lixo, mas margem ajustada) */
.toggle-color-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-color-btn:hover {
    opacity: 1;
    background-color: rgba(255, 255, 255, 0.1);
}

/* Estilo das bolas de cor no popup */
.color-choice {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}
.color-choice:hover {
    transform: scale(1.15);
    border-color: var(--text-color);
}

/* Bot√µes de Mover dentro do Toggle */
.toggle-move-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px; /* Um pouco menor que o t√≠tulo */
    margin-left: 5px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-move-btn:hover {
    opacity: 1;
    background-color: var(--hover-color);
}


/* Corre√ß√£o de tamanho de texto dentro dos Toggles */
details.toggle-section .toggle-content, 
details.toggle-section .toggle-content p, 
details.toggle-section .toggle-content div {
    font-size: 1em !important; /* 1em significa "igual ao tamanho atual" */
    line-height: inherit !important;
}

/* ============================================================
   ESTILO DO AGRUPADOR DE SETAS (NOVO)
   ============================================================ */
.toolbar-btn-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color); /* A borda do ret√¢ngulo */
    border-radius: 4px;
    margin-left: 5px;
    height: 30px;
    overflow: hidden; /* Garante cantos arredondados */
    background-color: transparent;
}

/* Removemos o estilo padr√£o dos bot√µes APENAS quando est√£o dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button {
    border: none !important;       /* Sem borda individual */
    border-radius: 0 !important;   /* Sem cantos redondos individuais */
    margin-left: 0 !important;     /* Sem espa√ßo entre eles */
    width: 28px !important;        /* Largura fixa */
    height: 100% !important;
}

/* Adiciona a linha separadora no meio */
.mini-note-toolbar .toolbar-btn-group button:first-child {
    border-right: none !important; /* <--- MUDAR AQUI PARA "none" */
}

/* Efeito Hover dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button:hover {
    background-color: var(--hover-color);
}
/* ============================================================
   WIDGET DE LINHA CRONOL√ìGICA (TIMELINE)
   ============================================================ */
.jwn-timeline-wrapper {
    position: relative;
    padding: 20px 10px;
    margin: 15px 0;
    background-color: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* A Linha Vertical */
.timeline-track {
    position: absolute;
    left: 30px; /* Posi√ß√£o da linha */
    top: 20px;
    bottom: 50px; /* Espa√ßo para o bot√£o adicionar */
    width: 2px;
    background-color: var(--accent-color);
    opacity: 0.5;
}

/* O item individual */
.timeline-entry {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-left: 45px; /* Espa√ßo para a bolinha e linha */
}

/* A bolinha (marcador) */
.t-marker {
    position: absolute;
    left: 24px; /* Centrado na linha (30px - metade da bola) */
    top: 5px;
    width: 14px;
    height: 14px;
    background-color: var(--bg-color);
    border: 2px solid var(--accent-color);
    border-radius: 50%;
    z-index: 2;
    transition: background-color 0.2s;
}

.timeline-entry:hover .t-marker {
    background-color: var(--accent-color);
}

/* Campos de Texto */
.t-date {
    font-weight: bold;
    color: var(--accent-color);
    min-width: 80px;
    margin-right: 10px;
    font-size: 0.9em;
    border-bottom: 1px dashed transparent;
}

.t-text {
    flex-grow: 1;
    color: var(--text-color);
    line-height: 1.4;
}

.t-date:focus, .t-text:focus {
    outline: none;
    border-bottom-color: var(--accent-color);
}

/* Bot√µes de A√ß√£o */
.t-btn-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0;
    margin-left: 10px;
    transition: opacity 0.2s;
}

.timeline-entry:hover .t-btn-del {
    opacity: 1;
}

.t-btn-add {
    display: block;
    margin-left: 23px; /* Alinhado com a linha */
    background: none;
    border: 1px dashed var(--text-muted-color);
    color: var(--text-muted-color);
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    margin-top: 10px;
    transition: all 0.2s;
}

.t-btn-add:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

   /* --- ESTILOS DO SCANNER UNIVERSAL --- */
/* Estilo para os itens do scanner b√≠blico */
.bible-scan-item {
    display: flex;
    align-items: center;
    padding: 8px;
    background-color: var(--bg-color);
    border-radius: 4px;
    margin-bottom: 5px;
    cursor: pointer;
}
.bible-scan-item:hover {
    background-color: var(--hover-color);
}
.bible-scan-item input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.bible-scan-item label {
    flex-grow: 1;
    cursor: pointer;
    font-weight: 500;
}
.bible-scan-existing-item {
    padding: 8px;
    color: #2ecc71; /* Verde */
    font-weight: 500;
    display: flex;
    align-items: center;
}
.bible-scan-existing-item::before {
    content: '‚úì';
    margin-right: 10px;
    font-weight: bold;
}
/* Abas */
.scan-tabs {
    display: flex;
    gap: 10px;
}
.scan-tab-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: var(--text-muted-color);
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: all 0.2s;
}
.scan-tab-btn:hover {
    color: var(--text-color);
    background-color: var(--hover-color);
    border-radius: 4px 4px 0 0;
}
.scan-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

/* Itens da Lista */
.scan-item-row {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-color);
    margin-bottom: 5px;
    border-radius: 4px;
}
.scan-item-row:hover {
    background-color: var(--hover-color);
}
.scan-checkbox {
    width: 18px; height: 18px; margin-right: 10px; cursor: pointer;
}
.scan-info {
    flex-grow: 1; display: flex; flex-direction: column;
}
.scan-name {
    font-weight: bold; color: var(--text-color);
}
.scan-location {
    font-size: 0.8em; color: var(--text-muted-color);
}
.scan-preview-btn {
    background: none; border: 1px solid var(--border-color);
    color: var(--text-muted-color); border-radius: 50%;
    width: 30px; height: 30px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    margin-left: 10px; transition: all 0.2s;
}
.scan-preview-btn:hover {
    background-color: var(--accent-color); color: white; border-color: var(--accent-color);
}

/* Sec√ß√µes (Novos vs Existentes) */
.scan-section-title {
    font-size: 0.85em; text-transform: uppercase; 
    color: var(--text-muted-color); margin: 15px 0 10px 0;
    font-weight: bold; border-bottom: 1px solid var(--border-color);
}

/* Popup de Preview Flutuante */
#scan-preview-popup {
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80%; max-width: 350px;
    background-color: var(--panel-color);
    border: 1px solid var(--accent-color);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    border-radius: 8px;
    z-index: 10;
    overflow: hidden;
}
.preview-header {
    background-color: var(--sidebar-color);
    padding: 8px 12px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border-color);
}
.preview-header button {
    background: none; border: none; color: var(--text-color); font-size: 18px; cursor: pointer;
}
#scan-preview-content {
    padding: 15px;
    font-size: 0.9em;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
}
#scan-preview-content mark {
    background-color: rgba(241, 196, 15, 0.4);
    color: white; padding: 2px 4px; border-radius: 4px;
}

/* --- CSS PARA O BOT√ÉO "VOLTAR √Ä NOTA" --- */


/* Garante que o Painel do Meio ocupa 100% da tela no Mobile */
@media (max-width: 768px) {
    #middle-panel {
        width: 100% !important;
        right: 0 !important;
        max-width: none !important;
    }
}

/* --- ESTILOS DO PAINEL DE REFER√äNCIAS (ABAS E PUZZLE) --- */

/* Caixas de M√≥dulo de Texto (Puzzle) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: transform 0.2s;
}

.puzzle-module-card textarea {
    width: 100%;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    border-radius: 4px;
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
}

.puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
}

.puzzle-controls button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.puzzle-controls button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.puzzle-controls button.delete:hover {
    background-color: rgba(192, 57, 43, 0.2);
    color: #e74c3c;
    border-color: #e74c3c;
}

/* Item da Lista de Refer√™ncias Escolhidas */
#puzzle-chosen-list li {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background-color: rgba(255, 255, 255, 0.03);
    border-left: 3px solid var(--accent-color);
}

.chosen-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 0.9em;
}

.chosen-ref-snippet {
    font-size: 0.85em;
    color: var(--text-muted-color);
    font-style: italic;
    margin-top: 3px;
    padding: 5px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}

/* Bot√£o adicionar ao puzzle (na aba Refer√™ncias) */
.add-to-puzzle-btn {
    background-color: var(--hover-color);
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 14px;
    cursor: pointer;
    margin-right: 5px;
}
.add-to-puzzle-btn:hover {
    background-color: var(--accent-color);
    color: white;
}

/* --- ESTILOS DO PUZZLE (MODO LEITURA VS EDI√á√ÉO) --- */

/* Estilo do Card (Contentor) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: all 0.2s;
}

/* O Textarea por padr√£o (MODO LEITURA - "Bonito") */
.puzzle-module-card textarea {
    width: 100%;
    /* Remove as bordas e fundo para parecer texto limpo */
    background: transparent; 
    border: none; 
    color: var(--text-color);
    padding: 5px;
    resize: none; /* Impede redimensionar */
    min-height: auto;
    font-family: inherit;
    font-size: 0.95em;
    line-height: 1.5;
    outline: none;
    overflow: hidden; /* Esconde scrollbar */
}

/* Os bot√µes de controlo por padr√£o (ESCONDIDOS) */
.puzzle-module-card .puzzle-controls {
    display: none; 
}

/* --- CLASSE ATIVADORA: .edit-mode-active --- */
/* Quando o contentor pai tem esta classe, mudamos o visual */

/* 1. Mostra o bot√£o "+ Criar" */
#ref-content-puzzle.edit-mode-active #add-puzzle-module-btn {
    display: block !important;
}

/* 2. Muda o Textarea para parecer um campo de input */
#ref-content-puzzle.edit-mode-active .puzzle-module-card textarea {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    resize: vertical; /* Permite redimensionar */
    min-height: 60px;
}

/* 3. Mostra os bot√µes de controlo (Setas e Lixo) */
#ref-content-puzzle.edit-mode-active .puzzle-module-card .puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-top: 5px;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}


/* Bot√µes do Quadro */
.puzzle-edit-toggle {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    border-radius: 4px; padding: 4px 10px; cursor: pointer; transition: all 0.2s;
}
.puzzle-action-btn {
    border: none; color: white; border-radius: 4px; padding: 4px 10px; 
    cursor: pointer; font-weight: bold; font-size: 0.85em;
}
.btn-blue { background-color: #3498db; }
.btn-blue:hover { background-color: #2980b9; }
.btn-green { background-color: #2ecc71; }
.btn-green:hover { background-color: #27ae60; }

/* Estilo do Cart√£o no Quadro (Gen√©rico) */
.board-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Tipo TEXTO */
.board-card.type-text textarea {
    width: 100%; background: transparent; border: none; color: var(--text-color);
    resize: none; font-family: inherit; line-height: 1.5; outline: none;
}
/* No modo edi√ß√£o, o textarea parece um input */
.edit-mode-active .board-card.type-text textarea {
    background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; resize: vertical;
}

/* Tipo REFER√äNCIA */
.board-card.type-ref {
    border-left: 3px solid #2ecc71; /* Borda verde para identificar */
}
.ref-card-content {
    font-size: 0.9em; color: var(--text-color);
}
.ref-card-title {
    font-weight: bold; color: var(--accent-color); display: flex; align-items: center; gap: 5px;
}
.ref-card-snippet {
    background-color: transparent; /* Remove fundo amarelo se houver */
    padding: 5px 0; 
    margin: 5px 0; 
    color: var(--text-muted-color); 
    font-size: 0.9em; 
    line-height: 1.5;
    /* Adiciona a barra lateral de cita√ß√£o para ficar igual */
    border-left: 2px solid var(--accent-color);
    padding-left: 10px;
}

/* Garante que o <mark> dentro do snippet tem a cor correta */
.ref-card-snippet mark {
    background-color: rgba(74, 144, 226, 0.4); /* Azul suave */
    color: var(--text-color); 
    border-radius: 3px; 
    padding: 1px 3px;
}

/* Controlos (Lixo, Setas) */
.card-controls {
    display: none; /* Escondido por padr√£o */
    margin-top: 5px; 
    border-top: 1px solid var(--border-color); 
    padding-top: 5px; 
    justify-content: flex-end; 
    gap: 5px;
}
.edit-mode-active .card-controls { display: flex; } /* Mostra ao editar */

/* A MAGIA: S√≥ mostra quando o painel tem esta classe */
#ref-content-puzzle.edit-mode-active .card-controls {
    display: flex !important;
}

.card-controls button {
    background: none; border: 1px solid var(--border-color); cursor: pointer; padding: 2px 6px; border-radius: 4px;
}
.card-controls button:hover { background-color: var(--hover-color); }

/* Estilo Base (Modo Visualiza√ß√£o - Limpo) */
.board-text-content {
    width: 100%;
    min-height: 40px;
    outline: none;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-color);
    
    /* O SEGREDO: Bordas e fundo transparentes por defeito */
    border: 1px solid transparent; 
    background-color: transparent;
    padding: 2px 5px; /* Padding pequeno para leitura */
    transition: all 0.2s ease;
}

/* Estilo Modo Edi√ß√£o (Quando o pai tem a classe activa) */
.edit-mode-active .board-text-content {
    border: 1px solid var(--border-color);
    background-color: var(--bg-color); /* Fundo da caixa de input */
    border-radius: 4px;
    padding: 8px; /* Mais espa√ßo para escrever */
    cursor: text;
}

/* Efeito Hover opcional no modo edi√ß√£o para saber que pode clicar */
.edit-mode-active .board-text-content:hover {
    border-color: var(--accent-color);
}

/* ============================================================
   ESTILO PERSONALIZADO PARA LINKS DO QUADRO
   ============================================================ */
a.board-link {
    /* 1. Mant√©m a cor do texto original (branco/cinza) */
    color: inherit !important; 
    
    /* 2. Remove o sublinhado padr√£o */
    text-decoration: none !important; 
    
    /* 3. Cria a linha picotada azul por baixo */
    border-bottom: 1px dotted #4a90e2 !important; 
    
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Efeito ao passar o rato (Opcional: torna a linha s√≥lida) */
a.board-link:hover {
    border-bottom-style: solid !important;
    background-color: rgba(74, 144, 226, 0.1); /* Fundo azul muito suave */
}

/* --- ESTILO PARA O ITEM DO POPUP DE REFER√äNCIA --- */
.puzzle-ref-item {
    display: flex !important;        /* For√ßa layout flex√≠vel */
    flex-direction: column !important; /* Organiza em colunas (Cima/Baixo) */
    align-items: flex-start !important;
    justify-content: center !important;
    width: 100%;
    padding: 12px 15px !important;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    box-sizing: border-box; /* Garante que padding n√£o aumenta largura */
    overflow: hidden;       /* Impede barras de scroll */
}

.puzzle-ref-item:hover {
    background-color: var(--hover-color);
}

/* Linha de Cima (Tipo + Nome da Nota) */
.puzzle-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 6px;
}

/* O Tipo (Ex: Quest√£o) */
.puzzle-ref-type {
    font-weight: bold;
    color: var(--text-color);
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0; /* Impede de encolher */
}

/* O Nome da Nota (Direita) */
.puzzle-ref-note {
    font-size: 0.8em;
    color: var(--text-muted-color);
    text-align: right;
    
    /* Truncar texto longo com ... */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%; /* Ocupa no m√°ximo 60% da linha */
}

/* O Texto de Contexto (Baixo) */
.puzzle-ref-snippet {
    font-size: 0.9em;
    color: var(--text-muted-color);
    width: 100%;
    line-height: 1.4;
    
    /* Truncar texto longo com ... */
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================================
   WIDGET CARD DE LINK (üé¥)
   ============================================================ */
  .url-card-widget {
    /* MUDAN√áA 1: inline-flex permite que fiquem lado a lado */
    display: inline-flex; 
    flex-direction: column;
    width: 240px;             
    height: 180px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin: 5px; 
    vertical-align: top; /* Alinha pelo topo quando h√° texto ao lado */
    position: relative;
    background-color: var(--panel-color);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    user-select: none;
    text-decoration: none;
    cursor: grab; /* M√£ozinha para indicar que pode arrastar */
}

.url-card-widget:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border-color: var(--accent-color);
}

/* Estado enquanto est√° a ser arrastado (Fica transparente) */
.url-card-widget.sortable-dragging {
    opacity: 0.4;
    border: 2px dashed var(--accent-color);
}

/* Indicadores de onde vai cair (Esquerda ou Direita) */
.url-card-widget.drop-target-left {
    border-left: 4px solid var(--accent-color) !important;
    transform: none !important;
}

.url-card-widget.drop-target-right {
    border-right: 4px solid var(--accent-color) !important;
    transform: none !important;
}

/* √Årea da Imagem */
.url-card-image {
    width: 100%;
    height: 100px;
    background-color: #2c2c30;
    background-size: cover;
    background-position: center;
    position: relative;
}

/* T√≠tulo e Dom√≠nio */
.url-card-info {
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex-grow: 1;
}

.url-card-title {
    font-weight: bold;
    font-size: 0.9em;
    color: var(--text-color);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* M√°ximo 2 linhas */
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 5px;
}

.url-card-domain {
    font-size: 0.75em;
    color: var(--text-muted-color);
    text-transform: uppercase;
    font-weight: 600;
}

/* Bot√£o de Fechar (X) - S√≥ aparece no hover */
.url-card-close {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 50%;
    display: none; /* Escondido por defeito */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    transition: background 0.2s;
}

.url-card-close:hover {
    background-color: #e74c3c; /* Vermelho ao passar o rato */
}

.url-card-widget:hover .url-card-close {
    display: flex; /* Mostra ao passar o rato no card */
}

/* Loading State */
.url-card-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 0.8em;
    color: var(--text-muted-color);
    font-style: italic;
}

/* Estilo para a nova Dropdown de Formata√ß√£o */
#editor-format {
    background-color: var(--hover-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    padding: 0 5px;
    height: 32px;
    cursor: pointer;
    outline: none;
    font-size: 14px;
    margin-right: 5px;
   width: 105px; /* Largura suficiente para o texto */
}

#editor-format:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

#editor-format option {
    background-color: var(--sidebar-color);
    color: var(--text-color);
}

/* Grelha de Vers√≠culos B√≠blicos */
.bible-verses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 8px;
    padding: 10px 0;
}

.verse-btn {
    aspect-ratio: 1; /* Quadrado */
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    background-color: var(--panel-color);
    color: var(--text-muted-color);
    transition: all 0.2s;
}

.verse-btn:hover {
    border-color: var(--accent-color);
    color: var(--text-color);
}

/* Vers√≠culo que j√° existe (Verde) */
.verse-btn.exists {
    background-color: rgba(46, 204, 113, 0.15);
    border-color: #2ecc71;
    color: #2ecc71;
    font-weight: bold;
}

.verse-btn.exists:hover {
    background-color: #2ecc71;
    color: white;
}

/* --- √çCONE DE SUPERPASTA (üóÉÔ∏è) --- */

/* Substitui o √≠cone padr√£o (üìÅ) pelo arquivo (üóÉÔ∏è) quando √© superpasta */
.list-item[data-superpasta="true"]::before {
    content: 'üóÉÔ∏è' !important; 
    font-size: 20px; /* Um pouco maior para destacar */
}

/* (Opcional) Mant√©m o estilo dourado que cri√°mos antes para o texto */
.list-item[data-superpasta="true"] {
    border-left: 3px solid #f1c40f !important;
}

/* Estilo dos bot√µes de Emoji */
.emoji-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    font-size: 24px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}
.emoji-btn:hover {
    background-color: var(--hover-color);
    transform: scale(1.1);
}

/* L√ìGICA M√ÅGICA PARA MOSTRAR O √çCONE PERSONALIZADO NA LISTA */
/* Se o item tiver a vari√°vel --custom-icon definida, usa isso em vez do padr√£o */
.list-item[style*="--custom-icon"]::before {
    content: var(--custom-icon) !important;
    font-size: 20px;
}

#context-menu {
    position: fixed; /* IMPORTANTE: Fixed em vez de Absolute */
    z-index: 99999 !important; /* Garante que fica por cima de tudo */
    background-color: var(--sidebar-color); 
    border: 1px solid var(--border-color);
    border-radius: 6px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    display: none; 
    flex-direction: column; 
    padding: 5px; 
    width: 160px;
}

/* ============================================================
   LINHAS ARRAST√ÅVEIS (·Øì)
   ============================================================ */
.draggable-line {
    display: flex;
    align-items: baseline; /* Alinha o texto pela base da letra, n√£o pelo topo da caixa */
    margin: 2px 0;         /* Margem m√≠nima para n√£o criar buracos */
    padding: 2px 0;        /* Padding reduzido */
    width: 100%;           /* Garante que ocupa a largura toda */
    box-sizing: border-box;
}

.draggable-line:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* O √çcone/Puxador */
.drag-handle-icon {
    cursor: grab;
    margin-right: 8px;
    font-weight: normal; /* Remove negrito excessivo */
    color: var(--accent-color);
    user-select: none; 
    font-size: 1.1em;    /* Tamanho ajustado ao texto */
    line-height: 1.4;    /* Igual ao texto normal */
    flex-shrink: 0; 
    transform: translateY(2px); /* Pequeno ajuste fino vertical */
}

/* O Conte√∫do do Texto */
.drag-content-area {
    flex: 1;
    outline: none;
    min-width: 0; 
    line-height: 1.4; /* For√ßa a mesma altura de linha do editor */
    white-space: pre-wrap; /* Mant√©m quebras de linha se existirem */
}

/* Garante que os par√°grafos vizinhos n√£o empurram */
.toggle-content p, 
.mini-note-content p {
    margin: 4px 0 !important;
    line-height: 1.4 !important;
}




/* ============================================================
   ESTILOS H√çBRIDOS DE TOOLBAR (DESKTOP vs MOBILE)
   ============================================================ */

/* --- PADR√ÉO (DESKTOP) --- */
/* Faz com que os grupos novos (toolbar-nav-section, etc) sejam ignorados pelo layout flex pai */
.toolbar-nav-section, 
.toolbar-tools-section {
    display: contents; 
}

/* Oculta separadores exclusivos de mobile */
.mobile-only-sep {
    display: none;
}

/* --- VERS√ÉO MOBILE (LAYOUT DUAS LINHAS NO TOPO) --- */
@media (max-width: 768px) {

    /* 1. Mudar a ordem geral do Editor */
    #editor-area {
        display: flex;
        flex-direction: column;
    }

    /* 2. Mover a Toolbar para o TOPO (Acima do T√≠tulo) */
    #editor-toolbar {
        order: -1; /* Coloca antes do input de t√≠tulo */
        display: flex;
        flex-direction: column; /* Organiza as duas barras verticalmente */
        padding: 0;
        background-color: var(--panel-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
        width: 100%;
    }

    /* 3. DESATIVA O 'display: contents' para assumir controlo no Mobile */
    .toolbar-nav-section, 
    .toolbar-tools-section {
        display: flex; 
    }


    /* ==================================================
       LINHA 1: FERRAMENTAS (Scroll Horizontal)
       ================================================== */
    .toolbar-tools-section {
        order: 1; /* Primeira Linha */
        width: 100%;
        overflow-x: auto; /* Permite scroll lateral */
        white-space: nowrap;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        align-items: center;
        
        /* Esconde barra de scroll feia */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .toolbar-tools-section::-webkit-scrollbar { 
        display: none; 
    }

    /* For√ßa a Barra Secund√°ria a aparecer e integrar-se na linha */
    #secondary-toolbar {
        display: flex !important; /* For√ßa visibilidade */
        position: static !important; /* Remove posicionamento absoluto se houver */
        background: none !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
        animation: none !important;
        flex-shrink: 0; /* Impede que encolha */
    }

    /* Ajustes nos bot√µes para mobile */
    #editor-toolbar button, 
    #secondary-toolbar button,
    #editor-toolbar select,
    #secondary-toolbar select,
    #editor-toolbar input[type="color"] {
        flex-shrink: 0; /* Garante que n√£o ficam esmagados */
        height: 34px; /* Altura de toque amig√°vel */
        min-width: 34px;
        margin: 0 1px;
    }

    /* Esconder a seta de "Mais Ferramentas" no mobile (j√° est√° tudo vis√≠vel) */
    #toggle-more-tools-btn {
        display: none !important;
    }

    /* Mostra separador extra */
    .mobile-only-sep {
        display: block;
        width: 1px;
        height: 20px;
        background-color: var(--border-color);
        margin: 0 8px;
        flex-shrink: 0;
    }

    /* ==================================================
       LINHA 2: NAVEGA√á√ÉO E STATUS (Fundo)
       ================================================== */
    .toolbar-nav-section {
        order: 2; /* Segunda Linha */
        width: 100%;
        padding: 5px 10px;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(0,0,0,0.1); /* Ligeiramente mais escuro */
        height: 40px;
    }

    /* Bot√£o Back */
    #mobile-back-btn {
        display: flex !important;
        background: none;
        border: none;
        color: var(--accent-color);
        font-size: 1.2em;
        padding: 5px;
        margin: 0 !important;
    }

    /* Status de Grava√ß√£o */
    .save-status {
        font-size: 0.75em;
        margin: 0;
        text-align: center;
        flex-grow: 1; /* Ocupa o centro */
    }

    /* Grupo da Direita (Share, History) */
    .toolbar-history {
        margin: 0 !important;
        gap: 8px;
    }

    .desktop-spacer {
        display: none;
    }
    
    /* Remover margem do input de t√≠tulo para colar √† barra */
    #note-title-input {
        margin-top: 5px;
    }
}

/* ============================================================
   CORRE√á√ÉO DE PISCAR NO MOBILE (FOR√áA BRUTA)
   ============================================================ */
@media (max-width: 768px) {

    /* 1. Garante que o Painel do Meio ocupa sempre o ecr√£ todo quando ativo */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        width: 100% !important;
        height: 100% !important;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 60;
    }

    /* 2. O MAIS IMPORTANTE: For√ßa o Cabe√ßalho a existir */
    /* Isto impede que regras de desktop escondam o header */
    #middle-panel .panel-header {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        height: auto !important;
        min-height: 50px; /* Garante altura m√≠nima */
        width: 100% !important;
        flex-shrink: 0 !important; /* Impede de encolher a zero */
    }

    /* 3. Garante que o conte√∫do do header (t√≠tulo e bot√µes) est√° vis√≠vel */
    #middle-panel .panel-header > * {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* 4. Corrige o bot√£o de voltar no header da lista */
    #middle-panel .panel-header #back-btn {
        display: flex !important; /* Garante que √© flex para centrar a seta */
    }
}



/* ============================================================
   RESPONSIVIDADE MOBILE (SISTEMA DE PILHA)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Reset do Contentor Principal */
    .notebook-container {
        display: block !important;
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* 2. Configura√ß√£o Base dos 3 Pain√©is (Ecr√£ Cheio) */
    #left-panel, #middle-panel, #right-panel {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        flex: none !important;
        z-index: 10;
        border: none !important;
        border-radius: 0 !important;
        /* Reset de estilos desktop que causam cortes */
        margin: 0 !important;
        max-width: none !important;
        min-width: 0 !important;
    }

    /* --- L√ìGICA DE VISIBILIDADE (Quem est√° no topo?) --- */

    /* ESTADO 1: Painel Esquerdo (Pastas + Abas) */
    body:not(.mobile-view-middle):not(.mobile-view-editor) #left-panel {
        display: flex !important;
        z-index: 50; /* No topo */
        background-color: var(--sidebar-color);
    }
    body:not(.mobile-view-middle):not(.mobile-view-editor) #middle-panel,
    body:not(.mobile-view-middle):not(.mobile-view-editor) #right-panel {
        display: none !important;
    }

    /* ESTADO 2: Painel do Meio (Lista de Notas) */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        flex-direction: column !important;
        z-index: 60; /* Acima da esquerda */
        background-color: var(--panel-color);
        padding: 15px !important; /* Espa√ßo para n√£o cortar o topo */
    }
    body.mobile-view-middle #left-panel {
        display: none !important; 
    }
    body.mobile-view-middle #right-panel {
        display: none !important;
    }

    /* ESTADO 3: Editor (Nota Aberta) */
    body.mobile-view-editor #right-panel {
        display: flex !important;
        z-index: 70; /* Acima de tudo */
        background-color: var(--bg-color);
    }
    body.mobile-view-editor #left-panel, 
    body.mobile-view-editor #middle-panel {
        display: none !important;
    }

    /* --- CORRE√á√ïES ESPEC√çFICAS --- */

    /* 1. For√ßar as ABAS (Note/Lists/Book) a aparecerem bem */
    #left-panel .panel-content {
        padding-top: 10px;
    }
    .tabs-container {
        display: flex !important;
        margin-bottom: 15px !important;
        flex-shrink: 0; /* Impede que encolham */
    }
    
    /* 2. Corrigir o Cabe√ßalho da Coluna 2 (Para n√£o cortar) */
    #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        height: auto !important;
        min-height: 50px;
        margin-bottom: 20px;
        width: 100%;
        flex-shrink: 0;
    }
    
    /* For√ßar a visibilidade dos elementos internos do header */
    #middle-panel .panel-header h2,
    #middle-panel .panel-header #back-btn,
    #middle-panel .panel-header #add-item-btn {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* 3. Bot√£o de Voltar no Editor (Topo) */
    #mobile-back-btn {
        display: flex !important;
        align-items: center;
        padding: 5px 12px;
        background: var(--panel-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-right: 10px;
    }

    /* 4. Esconder bot√µes desktop in√∫teis */
    #middle-panel-toggle-btn,
    #left-panel-toggle-btn {
        display: none !important;
    }
}
/* ==========================================================
       CORRE√á√ÉO IPHONE 13 E BOT√ïES SUMIDOS
       ========================================================== */

    /* 1. Ajuste do Painel para respeitar o "Notch" (C√¢mara) do iPhone */
    #middle-panel,
    .notebook-container.middle-panel-collapsed #middle-panel {
        /* Adiciona espa√ßo no topo seguro para o iPhone */
        padding-top: calc(15px + env(safe-area-inset-top)) !important;
    }

    /* 2. For√ßa o cabe√ßalho a ser vis√≠vel e Horizontal */
    #middle-panel .panel-header,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important; /* Linha horizontal */
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        min-height: 50px !important;
        margin-bottom: 20px !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* 3. O MAIS IMPORTANTE: For√ßa os bot√µes e t√≠tulo a aparecerem! 
       (Anula a regra que os escondia no modo colapsado) */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header > *,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #back-btn,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #add-item-btn {
        display: flex !important; /* Traz de volta os elementos! */
        visibility: visible !important;
        opacity: 1 !important;
        height: 32px !important;
        align-items: center;
    }

    /* Ajuste fino para o T√≠tulo (H2) ser bloco e n√£o flex */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2 {
        display: block !important;
        text-align: center;
        flex-grow: 1;
    }

/* ============================================================
   CORRE√á√ÉO H√çBRIDA TOOLBAR (PC Fiel + Mobile 2 Linhas)
   ============================================================ */

/* --- PADR√ÉO (PC) - Mant√©m o visual original --- */
#editor-toolbar {
    display: flex;
    flex-wrap: wrap; /* Permite que a barra secund√°ria quebre linha se necess√°rio */
    align-items: center;
    position: relative;
}

.tools-wrapper {
    display: contents; /* No PC, ignora este wrapper e mostra os bot√µes diretamente */
}

/* Oculta separadores exclusivos de mobile */
.toolbar-separator.mobile-only { display: none; }

/* Barra Secund√°ria no PC (Comportamento de Dropdown) */
/* Quando vis√≠vel via JS, ela aparece como flex */
#secondary-toolbar {
    width: 100%; /* For√ßa nova linha no PC */
    flex-basis: 100%;
    order: 10; /* Garante que fica abaixo de tudo */
    padding-top: 10px;
    margin-top: 5px;
    border-top: 1px solid var(--border-color);
    /* Mant√©m o display: none inline do HTML at√© o JS ativar */
}

/* --- VERS√ÉO MOBILE (LAYOUT FOR√áADO) --- */
@media (max-width: 768px) {

    /* 1. Mover Toolbar para cima do T√≠tulo */
    #editor-area {
        display: flex;
        flex-direction: column;
    }
    #toolbar-container {
        order: -1; /* Sobe para o topo */
        width: 100%;
        background-color: var(--panel-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
    }

    #editor-toolbar {
        flex-direction: column; /* Organiza em 2 linhas verticais */
        padding: 0;
        gap: 0;
    }

    /* 2. LINHA 1: Ferramentas (Scroll Horizontal) */
    .tools-wrapper {
        display: flex !important; /* Ativa o wrapper */
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        align-items: center;
        scrollbar-width: none; /* Esconde scrollbar Firefox */
    }
    .tools-wrapper::-webkit-scrollbar { display: none; } /* Esconde scrollbar Chrome */

    /* For√ßa a barra secund√°ria a aparecer e integrar-se na linha */
    #secondary-toolbar {
        display: contents !important; /* O SEGREDO: Faz os bot√µes filhos subirem para a linha principal */
    }

    /* Ajustes dos bot√µes no scroll */
    .tools-wrapper button, 
    .tools-wrapper select, 
    .tools-wrapper input {
        flex-shrink: 0;
        margin: 0 2px;
        height: 36px;
    }

    /* Esconde elementos in√∫teis no mobile */
    #toggle-more-tools-btn { display: none !important; }
    .toolbar-separator.desktop-only { display: none; }
    .toolbar-separator.mobile-only { 
        display: block; width: 1px; height: 24px; background: var(--border-color); margin: 0 8px; flex-shrink: 0; 
    }

    /* 3. LINHA 2: Navega√ß√£o e Status (Fixo em baixo) */
    .toolbar-history {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 10px;
        background-color: rgba(0,0,0,0.1);
        height: 44px;
        margin: 0 !important;
    }

    /* Bot√£o Voltar (Aparece na esquerda da linha 2) */
    #mobile-back-btn {
        display: flex !important;
        background: none;
        border: none;
        font-size: 20px;
        margin-right: auto; /* Empurra o resto para a direita */
    }

    /* Status no meio */
    .save-status {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8em;
        white-space: nowrap;
    }
}

/* ============================================================
   ORDEM DA BARRA DE FERRAMENTAS (PC vs MOBILE)
   ============================================================ */

/* --- PADR√ÉO (PC): Barra ABAIXO do t√≠tulo --- */
#editor-area {
    display: flex;
    flex-direction: column;
}

/* O input do t√≠tulo fica em 1¬∫ lugar (order: 0 √© o padr√£o) */
#note-title-input {
    order: 0;
    margin-bottom: 20px; /* Espa√ßo entre t√≠tulo e barra */
}

/* A barra de ferramentas fica em 2¬∫ lugar */
#toolbar-container {
    order: 1;
    margin-bottom: 10px; /* Espa√ßo entre barra e editor */
}

/* O editor fica em 3¬∫ lugar */
#note-content-editor {
    order: 2;
}


/* --- VERS√ÉO MOBILE: Barra ACIMA do t√≠tulo --- */
@media (max-width: 768px) {
    
    /* Inverte a ordem visualmente */
    
    /* A barra sobe para o topo (order negativo) */
    #toolbar-container {
        order: -1; 
        margin-bottom: 10px;
        position: sticky; /* Opcional: Mant√©m a barra vis√≠vel no topo ao fazer scroll */
        top: 0;
        z-index: 100;
    }

    /* O t√≠tulo desce para depois da barra */
    #note-title-input {
        order: 0;
        margin-top: 5px;
        margin-bottom: 15px;
    }

    /* O editor mant√©m-se no fim */
    #note-content-editor {
        order: 1;
    }
}

/* ============================================================
   TOOLBAR PERSONALIZADA (PC vs MOBILE)
   ============================================================ */

/* --- CONFIGURA√á√ÉO PC (LAYOUT ORIGINAL) --- */
#editor-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    background-color: var(--panel-color);
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 15px;
    gap: 5px;
}

/* O "Truque": No PC, esta div √© invis√≠vel estruturalmente */
.tools-scroll-container {
    display: contents; 
}

/* Grupo da Direita (Status + √çcones) */
.toolbar-history-group {
    display: flex;
    align-items: center;
    margin-left: auto; /* Empurra para a direita no PC */
    gap: 15px;
}

/* Separadores Verticais */
.toolbar-separator {
    width: 1px;
    height: 24px;
    background-color: var(--border-color);
    margin: 0 5px;
    display: block; /* Vis√≠veis no PC */
}
.toolbar-separator.mobile-only { display: none; } /* Esconde extras no PC */

/* Barra Secund√°ria (PC) - Quebra para nova linha */
#secondary-toolbar {
    width: 100%;
    flex-basis: 100%;
    border-top: 1px solid var(--border-color);
    padding-top: 10px;
    margin-top: 5px;
    display: none; /* Controlado pelo JS */
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

/* Bot√£o Toggle (Seta) Ativo */
#toggle-more-tools-btn.active {
    background-color: var(--selected-color) !important;
}

/* ESTILO ESPEC√çFICO PARA O MODO PARTILHA (VERMELHO) */
.folder-mode-item.active.mode-shared {
    color: #e74c3c; /* Texto vermelho */
}

.folder-mode-item.active.mode-shared::after {
    background-color: #e74c3c !important; /* Linha vermelha for√ßada */
    height: 3px; /* Um pouco mais grossa para destaque */
}


/* --- ESTILOS DO ARQUIVO (FEED) --- */
.archive-post {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    position: relative;
    transition: box-shadow 0.2s;
}

.archive-post:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Modo Edi√ß√£o do Post */
.post-edit-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    animation: fadeIn 0.3s;
}

.post-title-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 4px;
}

.post-editor-content {
    min-height: 100px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 4px;
    outline: none;
    color: var(--text-color);
}

/* Toolbar Espec√≠fica do Post */
.post-toolbar {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    background: rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 4px;
}

.post-toolbar button {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 3px;
}
.post-toolbar button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Modo Visualiza√ß√£o do Post */
.post-view-container {
    display: flex;
    flex-direction: column;
}

.post-view-title {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 10px;
}

.post-view-content {
    line-height: 1.5;
    color: var(--text-color);
}

.post-edit-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.8em;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.archive-post:hover .post-edit-btn {
    opacity: 1;
}

.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    font-size: 0.75em;
    color: var(--text-muted-color);
    display: flex;
    justify-content: space-between;
}

/* ============================================================
   VISIBILIDADE DA TOOLBAR DAS ENTIDADES (ARQUIVO)
   ============================================================ */

/* 1. MODO VISUALIZA√á√ÉO: ESCONDER A BARRA */
/* Esconde a barra laranja/azul/verde com os √≠cones */
.post-view-content .mini-note-toolbar {
    display: none !important;
}

/* Esconde tamb√©m os bot√µes espec√≠ficos dos T√≠tulos Toggle (caso use) */
.post-view-content .toggle-color-btn,
.post-view-content .toggle-delete-btn,
.post-view-content .toggle-move-btn {
    display: none !important;
}

/* 2. MODO EDI√á√ÉO: GARANTIR VISIBILIDADE */
/* Quando clica em "Editar", a classe muda para .post-editor-content e a barra reaparece */
.post-editor-content .mini-note-toolbar {
    display: flex !important;
}

/* ============================================================
   CORRE√á√ÉO DE LAYOUT: ENTIDADES DENTRO DE POSTS
   ============================================================ */

/* 1. Remove margens negativas que causam transbordo */
/* O estilo original tem 'margin: 30px -25px', o que empurra para fora */
.post-editor-content .mini-note-wrapper,
.post-view-content .mini-note-wrapper {
    margin: 10px 0 !important; /* Margem vertical pequena, zero lateral */
    width: 100% !important;    /* For√ßa a caber no pai */
    box-sizing: border-box;    /* Garante que padding n√£o aumenta largura */
}

/* 2. Ajuste para Toggles (T√≠tulos Expans√≠veis) */
.post-editor-content details.toggle-section,
.post-view-content details.toggle-section {
    margin: 10px 0 !important;
    width: 100% !important;
}

/* 3. Ajuste fino do conte√∫do do post para evitar scroll horizontal desnecess√°rio */
.post-editor-content,
.post-view-content {
    overflow-x: hidden; /* Corta o que sobrar */
    width: 100%;        /* Garante largura total */
    word-wrap: break-word; /* Quebra palavras longas */
}

/* ============================================================
   PROTE√á√ÉO DA TOOLBAR INTERNA (ARQUIVO)
   ============================================================ */
.post-editor-content .mini-note-toolbar {
    user-select: none;          /* Impede selecionar os bot√µes com o rato */
    -webkit-user-select: none;  /* Safari/Chrome */
    -moz-user-select: none;     /* Firefox */
    cursor: default;
}

/* Garante que a barra √© considerada um bloco s√≥lido n√£o edit√°vel */
.post-editor-content .mini-note-toolbar[contenteditable="false"] {
    outline: none !important;
    border: none !important;
}

/* Garante espa√ßo para os bot√µes √† direita */
.post-view-title {
    padding-right: 120px; /* Espa√ßo para 3 bot√µes */
}

/* --- SELE√á√ÉO VERMELHA (MODO PARTILHA) --- */
.list-item.selected-red {
    background-color: rgba(231, 76, 60, 0.25) !important; /* Fundo vermelho suave */
    border-left: 4px solid #e74c3c !important; /* Borda vermelha forte */
    color: white !important;
}

/* Garante que o texto fica leg√≠vel */
.list-item.selected-red span {
    font-weight: bold;
}


/* --- BARRA DE COLABORA√á√ÉO --- */
#collab-bar {
    display: none; /* S√≥ aparece se houver colaboradores */
    align-items: center;
    padding: 0 20px;
    margin-bottom: 10px;
    gap: 5px;
}

.user-presence-bubble {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--accent-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    border: 2px solid var(--sidebar-color);
    cursor: default;
    position: relative;
    transition: transform 0.2s;
}

.user-presence-bubble:hover {
    transform: translateY(-2px);
    z-index: 10;
}

/* Tooltip do nome */
.user-presence-bubble::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.user-presence-bubble:hover::after { opacity: 1; }

/* --- POST BLOQUEADO (EDITADO POR OUTRO) --- */
.archive-post.is-locked {
    opacity: 0.7;
    border: 1px dashed #e74c3c !important;
    background: repeating-linear-gradient(
        45deg,
        rgba(231, 76, 60, 0.05),
        rgba(231, 76, 60, 0.05) 10px,
        rgba(231, 76, 60, 0.1) 10px,
        rgba(231, 76, 60, 0.1) 20px
    );
    pointer-events: none; /* Bloqueia cliques */
    position: relative;
}

.locked-badge {
    position: absolute;
    top: -10px;
    right: 10px;
    background-color: #e74c3c;
    color: white;
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
    z-index: 20;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 5px;
}

.list-item.selected, .list-item.selected-red {
    transition: background-color 0.1s ease-in-out, border-left 0.1s ease-in-out;
}


.archive-tab-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 10px 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 15px;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.archive-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.archive-tab-btn:hover {
    color: var(--text-color);
}
.drawer-toggle {
    margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px;
    background: rgba(255,255,255,0.02);
}
.drawer-toggle summary {
    padding: 15px; cursor: pointer; font-weight: bold; color: var(--accent-color);
    list-style: none; display: flex; justify-content: space-between;
}
.drawer-toggle[open] { border-color: var(--accent-color); }


.mini-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}
.mini-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}
/* Estilo para que o cabe√ßalho n√£o abra o toggle ao clicar nos bot√µes */
.drawer-controls {
    pointer-events: auto;
}


/* Estilo do bot√£o Criar Post ao lado das abas */
.archive-inline-create-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 14px; /* Tamanho igual √†s abas */
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 5px; /* Alinhamento visual com a borda de baixo */
    transition: opacity 0.2s;
    white-space: nowrap;
}

.archive-inline-create-btn:hover {
    opacity: 0.8;
}

/* Ajuste na div pai para o bot√£o n√£o esticar */
.archive-tabs {
    display: flex;
    align-items: center;
}

/* Efeito Hover no Popup de Formata√ß√£o Extra */
#formatting-popup button {
    background: rgba(255,255,255,0.05);
    border: 1px solid #444;
    border-radius: 4px;
    padding: 6px 0;
    cursor: pointer;
    transition: all 0.2s ease;
}

#formatting-popup button:hover {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important; /* O texto fica branco para contrastar com o fundo azul */
}

/* Estado ativo do bot√£o de mais formata√ß√µes */
#more-formatting-btn.active {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
}

/* --- AJUSTE DE BOT√ïES DE A√á√ÉO DOS POSTS --- */

/* 1. Contentor dos bot√µes no modo edi√ß√£o */
.post-edit-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    padding-top: 12px;
    margin-top: 10px;
}

.post-edit-actions .modal-btn {
    padding: 6px 12px !important;
    font-size: 13px !important;
    height: 32px !important;
    flex: 1 1 auto;
    min-width: fit-content;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}

/* --- L√ìGICA MOBILE (AT√â 480PX) --- */
@media (max-width: 480px) {
    .post-edit-actions {
        justify-content: center;
    }
    
    .post-edit-actions .modal-btn {
        font-size: 12px !important;
        padding: 6px 8px !important;
        flex: 1 1 45%; /* Garante 2 bot√µes por linha */
    }

    /* REORDENA√á√ÉO DOS BOT√ïES NO MOBILE */
    /* Ordem original no HTML: 1. Gavet√£o, 2. Eliminar, 3. Cancelar, 4. Salvar */
    
    .post-edit-actions .modal-btn:nth-child(1) { order: 1; } /* Gavet√£o continua em 1¬∫ */
    .post-edit-actions .modal-btn:nth-child(4) { order: 2; } /* SALVAR sobe para 2¬∫ (lugar do eliminar) */
    .post-edit-actions .modal-btn:nth-child(3) { order: 3; } /* Cancelar continua em 3¬∫ */
    .post-edit-actions .modal-btn:nth-child(2) { order: 4; } /* ELIMINAR desce para 4¬∫ (lugar do salvar) */
}


/* --- CONFIGURA√á√ÉO MOBILE (LAYOUT 2 LINHAS NO TOPO) --- */
@media (max-width: 768px) {

    /* 1. Mover Toolbar para cima do T√≠tulo */
    #editor-area { display: flex; flex-direction: column; }
    #toolbar-container {
        order: -1; 
        position: sticky; top: 0; z-index: 100;
        background-color: var(--panel-color);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    #note-title-input { order: 0; margin-top: 10px; }
    #note-content-editor { order: 1; }

    /* 2. Layout da Barra Principal */
    #editor-toolbar {
        flex-direction: column; /* Pilha vertical */
        padding: 0;
        gap: 0;
        border-radius: 0;
        margin-bottom: 0;
    }

    /* LINHA 1: Ferramentas com Scroll */
    .tools-scroll-container {
        display: flex; /* Ativa o flex para scroll */
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 5px;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        /* Esconde scrollbars */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .tools-scroll-container::-webkit-scrollbar { display: none; }

    /* For√ßa a barra secund√°ria a aparecer e integrar-se na linha 1 */
    #secondary-toolbar {
        display: contents !important; /* Faz os bot√µes subirem para a linha principal */
    }

    /* Separadores no Mobile */
    .toolbar-separator { margin: 0 8px; flex-shrink: 0; height: 20px; }
    .toolbar-separator.mobile-only { display: block; }

    /* Esconde a seta de toggle no mobile (tudo vis√≠vel) */
    #toggle-more-tools-btn { display: none !important; }

    /* Ajuste de bot√µes para toque */
    #editor-toolbar button, #editor-toolbar select, #editor-toolbar input {
        flex-shrink: 0; height: 34px; margin: 0 1px;
    }

    /* LINHA 2: Navega√ß√£o e Hist√≥rico (Barra Inferior) */
    .toolbar-history-group {
        width: 100%;
        height: 45px;
        background-color: rgba(0,0,0,0.2);
        justify-content: space-between; /* Espalha: Back - Status - √çcones */
        padding: 0 10px;
        margin: 0;
    }

    /* Bot√£o Back vis√≠vel */
    #mobile-back-btn {
        display: flex !important;
        background: none; border: none; font-size: 22px; color: var(--accent-color);
        padding: 0; margin: 0;
    }

    /* Ajuste do Status */
    .save-status {
        position: absolute; left: 50%; transform: translateX(-50%);
        font-size: 0.75em; opacity: 0.8;
    }
}

/* ============================================================
   NOVA REGRA: BOT√ïES FLUTUANTES (MOBILE FAB)
   ============================================================ */
#mobile-fab-container {
    display: none; /* Escondido por padr√£o em Desktop */
}

@media (max-width: 768px) {
    /* Esconde o rodap√© original do painel esquerdo */
    #left-panel .panel-footer {
        display: none !important;
    }

    /* O contentor s√≥ aparece se o body tiver a classe 'show-fab' */
       #mobile-fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none; /* Escondido por padr√£o */
        flex-direction: column;
        gap: 12px;
        z-index: 900;
        align-items: center;
    }

    body.show-fab #mobile-fab-container {
        display: flex !important; /* Mostra apenas quando a classe existir */
    }

    /* Prote√ß√£o extra: se mudar de ecr√£, os bot√µes morrem sempre */
    body.mobile-view-middle #mobile-fab-container,
    body.mobile-view-editor #mobile-fab-container {
        display: none !important;
    }

    /* Estilo das Bolinhas */
    .fab-btn {
        width: 48px; height: 48px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        background-color: var(--panel-color);
        color: var(--text-color);
        font-size: 20px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        cursor: pointer;
    }

    #mobile-fab-add {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        font-size: 28px;
        width: 56px; height: 56px;
    }
}

/* ============================================================
   MODO "APP NATIVA" (SEM SALTOS DE TELA) - MOBILE
   ============================================================ */
@media (max-width: 768px) {

    /* 1. TRAVAR A P√ÅGINA INTEIRA (O Segredo) */
    /* Isto impede que o site "fuja" quando faz scroll agressivo ou abre o teclado */
    html, body {
        height: 100% !important;
        width: 100% !important;
        overflow: hidden !important;
        position: fixed !important; 
    }

    /* 2. Painel da Direita (Contentor Fixo) */
    #right-panel {
        position: fixed !important;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw !important;
        height: 100% !important;
        display: none !important; /* Escondido por padr√£o */
        flex-direction: column !important;
        z-index: 70;
        background-color: var(--bg-color);
    }
  /* Quando a nota est√° aberta, mostramos o painel */
    body.mobile-view-editor #right-panel {
        display: flex !important;
    }

    /* 3. √Årea do Editor (O Motor de Scroll) */
    /* √â AQUI e S√ì AQUI que o scroll acontece */
    #editor-area {
        display: none;
        flex-direction: column;
        width: 100% !important;
        height: 100% !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
    }

    /* 4. Barra de Ferramentas (STICKY) */
    /* Sticky dentro de um contentor fixo √© muito mais est√°vel que Fixed */
    #toolbar-container {
        position: -webkit-sticky !important; /* Safari */
        position: sticky !important;         /* Android/Modern */
        top: 0 !important;                   /* Cola no teto do #editor-area */
        z-index: 9999 !important;            /* Acima de tudo */
        
        width: 100% !important;
        background-color: var(--panel-color) !important;
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        
        /* Truques para evitar piscar */
        transform: translateZ(0);
        margin: 0 !important;
    }

    /* 5. Ajuste do T√≠tulo */
    /* Como usamos Sticky, a barra ocupa espa√ßo f√≠sico. N√£o precisamos de margem gigante */
    #note-title-input {
        display: block !important;
        margin-top: 20px !important; 
        margin-left: 15px !important;
        width: calc(100% - 30px) !important;
        position: relative;
        z-index: 1;
    }

    /* 6. Conte√∫do da Nota (Padding Gigante para o Teclado) */
    #note-content-editor {
        display: block !important;
        overflow: visible !important; /* O scroll √© gerido pelo pai (#editor-area) */
        height: auto !important;
        
        /* Espa√ßo enorme no fundo para conseguir fazer scroll 
           e ver o texto mesmo com o teclado aberto */
        padding: 10px 15px 400px 15px !important; 
    }
}

@media (max-width: 768px) {
    /* 1. Mostra a barra de voltar apenas no mobile */
    #archive-mobile-nav {
        display: flex !important;
    }

    /* 2. Remove o espa√ßo excessivo acima do t√≠tulo */
    #archive-area > div[style*="padding: 20px"] {
        padding-top: 10px !important;
    }

    /* 3. For√ßa o conte√∫do a colar ao topo (elimina o buraco negro) */
    #right-panel, #archive-area {
        justify-content: flex-start !important;
    }
}

/* ============================================================
   CORRE√á√ÉO FINAL DE ESPA√áAMENTO NO TOPO (MOBILE)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßa o painel da direita a alinhar tudo ao TOPO */
    #right-panel {
        display: block !important; /* Remove o Flexbox que centra as coisas */
        padding-top: 0 !important;
        justify-content: flex-start !important;
    }

    /* 2. Garante que o Arquivo ocupa a altura toda e cola ao topo */
    #archive-area {
        display: none;
        flex-direction: column !important;
        height: 100vh !important;
        justify-content: flex-start !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* 3. Se tiver a barra de navega√ß√£o que cri√°mos antes, garante que ela n√£o tem margem */
    #archive-mobile-nav {
        flex-shrink: 0; /* Impede que encolha */
        margin-top: 0 !important;
    }
    
    /* 4. Remove padding extra do t√≠tulo do arquivo */
    #archive-area > div:nth-child(2) { /* Seleciona a div do input de t√≠tulo */
        padding-top: 10px !important;
    }
}

/* ============================================================
   CORRE√á√ÉO FINAL DE ALINHAMENTO VERTICAL (MOBILE)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar o contentor principal a alinhar ao TOPO */
    #right-panel {
        display: block !important;       /* Desliga o Flexbox centrado */
        padding-top: 0 !important;       /* Remove padding do topo */
        justify-content: flex-start !important; /* Se ficar flex, cola ao topo */
        overflow-y: auto !important;     /* Permite scroll se necess√°rio */
    }

    /* 2. Garantir que o Arquivo ocupa o espa√ßo e n√£o tem margens estranhas */
    #archive-area {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;         /* Altura autom√°tica para n√£o esticar */
        min-height: 100vh !important;    /* M√≠nimo ecra todo */
        justify-content: flex-start !important; /* Cola conte√∫dos ao topo */
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* 3. Se tiver a barra de navega√ß√£o "Voltar", cola-a ao teto */
    #archive-mobile-nav {
        margin-top: 0 !important;
        flex-shrink: 0;
    }
}

/* ============================================================
   CORRE√á√ÉO DO √çCONE SOBREPOSTO (LIVRO)
   ============================================================ */
@media (max-width: 768px) {
    /* Quando o modo de edi√ß√£o/arquivo est√° ativo,
       DESTR√ìI o placeholder (livro) completamente */
    body.mobile-view-editor #editor-placeholder {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
    }
}

/* Contentor da linha da refer√™ncia */
.reference-item {
    border-bottom: 1px solid var(--border-color);
    padding: 5px 0;
    transition: background 0.2s;
}

.reference-item summary {
    list-style: none;
    padding: 8px 10px;
    cursor: pointer;
}

/* Esconde a seta padr√£o do summary */
.reference-item summary::-webkit-details-marker { display: none; }

/* Alinhamento da linha: [+] [T√≠tulo] [Seta] */
.ref-item-header {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.ref-item-title {
    flex-grow: 1;
    font-size: 0.95em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-color);
}

/* O bot√£o "+" mais discreto */
.add-to-puzzle-btn {
    background: var(--hover-color);
    border: 1px solid var(--border-color);
    color: var(--accent-color);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    flex-shrink: 0;
    transition: all 0.2s;
}

.add-to-puzzle-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* O "Contexto" (Snippets) agora sem caixas azuis, apenas texto discreto */
.reference-context {
    padding: 0 10px 10px 44px; /* Alinhado com o texto acima */
    font-size: 0.85em;
    color: var(--text-muted-color);
    line-height: 1.4;
}

/* Remove qualquer background azul ou borda que tenhas nos snippets anteriores */
.reference-context p, .reference-context mark {
    background: transparent;
    border: none;
}

.reference-context mark {
    color: var(--accent-color);
    font-weight: bold;
    text-decoration: underline;
}

/* ============================================================
   PAINEL DE REFER√äNCIAS MOBILE (CORRE√á√ÉO DE HIERARQUIA)
   ============================================================ */
@media (max-width: 768px) {
    /* 1. O PAINEL FICA NUM N√çVEL ALTO */
    #references-panel, 
    .notebook-container.references-panel-visible #references-panel {
        display: flex !important;
        position: fixed !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        min-width: 100vw !important;
        max-width: 100vw !important;
        flex: none !important; 
        height: 60vh; 
        
        /* Valor alto, mas menor que o dos modais */
        z-index: 10000 !important; 
        
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        border-top: 1px solid var(--border-color) !important;
        border-radius: 15px 15px 0 0 !important;
        max-height: calc(100dvh - env(safe-area-inset-top, 20px)) !important;
        background-color: var(--sidebar-color) !important;
        box-shadow: 0 -10px 50px rgba(0,0,0,0.9) !important;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s ease !important;
        transform: translateY(100%) !important; 
        visibility: visible !important;
        touch-action: none; 
    }

    /* 2. OS MODAIS (EDICAO, CONFIGS, ETC) FICAM NO TOPO ABSOLUTO */
    .modal-overlay {
        z-index: 20000 !important; /* Dobro do valor do painel */
    }

    /* ESTADO ATIVO DO PAINEL */
    .notebook-container.references-panel-visible #references-panel {
        transform: translateY(0) !important;
    }

    #references-panel.is-dragging {
        transition: none !important;
    }

    /* AJUSTES DE CONTE√öDO */
    #references-panel .panel-content,
    #ref-content-puzzle,
    #ref-content-references {
        padding: 0 15px 30px 15px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        overflow-y: auto !important;
        touch-action: pan-y; 
    }

    #references-panel .panel-header {
        padding: 25px 20px 10px 20px !important;
        cursor: grab;
        touch-action: none;
    }

    #references-panel::before {
        content: '';
        width: 60px;
        height: 6px;
        background: var(--border-color);
        border-radius: 10px;
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
    }

    /* IMPEDE QUE A NOTA AO FUNDO SE MOVA ENQUANTO O PAINEL EST√Å ABERTO */
    body.mobile-view-editor.references-panel-visible {
        overflow: hidden !important;
    }
}

/* Outros ajustes Mobile */
@media (max-width: 768px) {
    .entity-link, .tag, a[data-anexo-id] { position: relative; display: inline-block; padding: 4px 0; touch-action: manipulation; }
    #note-content-editor, .post-editor-content { -webkit-tap-highlight-color: transparent; }
}

#settings-modal .modal-content.settings-expanded { max-width: 550px; width: 94%; max-height: 85vh; display: flex; flex-direction: column; padding: 20px; }
.modal-scroll-area { overflow-y: auto; flex: 1; padding-right: 10px; margin-bottom: 10px; }
#settings-modal [data-action="cancel"]:hover { color: var(--accent-color) !important; }

@media (max-width: 768px) {
    #references-panel-title { font-size: 1.1em; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
}

/* ============================================================
   DESIGN MODERNO DA GRELHA B√çBLICA
   ============================================================ */
.bible-grid {
    display: grid;
    /* FR divide o espa√ßo dispon√≠vel em partes iguais. 4 colunas = 25% cada. */
    grid-template-columns: repeat(4, 1fr); 
    gap: 8px; /* Espa√ßo fixo entre bot√µes */
    padding: 10px;
    width: 100%;
    box-sizing: border-box; /* Garante que o padding n√£o aumenta a largura */
}

.bible-grid-btn {
    /* Mant√©m o bot√£o quadrado independentemente da largura */
    aspect-ratio: 1 / 1; 
    display: flex;
    align-items: center;
    justify-content: center;
    
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    
    color: var(--text-color);
    /* Fonte ajustada para bot√µes de ~50px */
    font-size: 1.1rem; 
    font-weight: 700;
    
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Estilo de SELE√á√ÉO (Hover / Rato por cima) */
.bible-grid-btn:hover {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important;
    transform: translateY(-2px); /* Salta para cima */
    box-shadow: 0 4px 8px rgba(74, 144, 226, 0.4);
    z-index: 2;
}

/* Feedback ao carregar (Telem√≥vel) */
.bible-grid-btn:active {
    transform: scale(0.9);
}

/* Estilo para Vers√≠culo que J√Å EXISTE (VERDE) */
.bible-grid-btn.exists {
    background-color: rgba(46, 204, 113, 0.1);
    border: 1px solid #2ecc71;
    color: #2ecc71;
}

.bible-grid-btn.exists:hover {
    background-color: #2ecc71 !important;
    color: white !important;
}

/* Ajuste de scrollbar para a lista do meio n√£o bater nos bot√µes */
#file-list {
    padding-right: 5px;
    overflow-x: hidden;
}

/* Estilo Amarelo para o bot√£o Adicionar em Listas */
#add-item-btn.yellow-mode {
    border-color: #f1c40f !important;
    color: #f1c40f !important;
}

#add-item-btn.yellow-mode:hover {
    background-color: #f1c40f !important;
    color: white !important;
}

/* Estilos para o Layout do Codex */
.codex-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: flex-end;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid var(--accent-color);
    position: relative;
}

.codex-field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.codex-field-group label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-muted-color);
}

.codex-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 13px;
}

.multi-input-container {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-add-small {
    background: var(--hover-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.btn-toggle-codex {
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}

.btn-toggle-codex.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.remove-codex-row {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e74c3c;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    border: none;
}


.codex-row {
    background: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: border-color 0.2s;
}

.codex-row:hover {
    border-color: var(--accent-color);
}

/* Header da Linha (Serie + A/M + Lixo) */
.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.serie-wrapper { flex: 1; position: relative; }

.codex-label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted-color);
    margin-bottom: 6px;
    letter-spacing: 0.5px;
}

/* Inputs elegantes */
.codex-input-modern {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    outline: none;
    transition: all 0.2s;
}

.codex-input-modern:focus {
    border-color: var(--accent-color);
    background: var(--sidebar-color);
}

/* Bot√µes A e M */
.btn-control-small {
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    width: 34px;
    height: 34px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-control-small.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Bot√£o Lixo */
.btn-delete-row {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
    transition: color 0.2s;
}
.btn-delete-row:hover { color: #e74c3c; }

/* Grid de Baixo (P√°ginas e Par√°grafos) */
.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

/* Estilo das Unidades (Chips/P√≠lulas) */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-right: 6px;
    margin-bottom: 6px;
    overflow: hidden;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: var(--text-color);
    width: 40px;
    padding: 6px 4px 6px 8px;
    font-size: 13px;
    outline: none;
    text-align: center;
}

.btn-unit-del {
    background: rgba(231, 76, 60, 0.1);
    border: none;
    color: #e74c3c;
    padding: 0 8px;
    cursor: pointer;
    height: 28px;
    font-size: 12px;
}
.btn-unit-del:hover { background: #e74c3c; color: white; }

/* Bot√£o Adicionar Unidade (+) */
.btn-unit-add {
    background: var(--bg-color);
    border: 1px dashed var(--border-color);
    color: var(--accent-color);
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.btn-unit-add:hover { background: var(--accent-color); color: white; border-style: solid; }

.manual-inputs-area { display: flex; flex-wrap: wrap; /* Permite quebrar linha se n√£o houver espa√ßo */ gap: 8px; margin-bottom: 10px; margin-top: 10px; }

.manual-field-group {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid var(--border-color);
    padding: 5px 10px;
    border-radius: 6px;
    gap: 5px;
}

/* Inputs dentro das p√≠lulas manuais */
.codex-input-manual {
    background: transparent !important;
    border: none !important;
    color: var(--text-color) !important;
    font-size: 13px;
    padding: 0 !important;
    outline: none;
}

.btn-close-manual {
    background: none !important;
    border: none !important;
    color: #e74c3c !important;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    margin-left: 5px;
    display: flex;
    align-items: center;
}

.btn-close-manual:hover {
    color: #ff4d4d !important;
}

/* Garante que o modal de confirma√ß√£o fique sempre no topo absoluto */
#confirm-modal {
    z-index: 5000 !important;
}

/* O Link Modal (Gest√£o) fica numa camada alta */
#link-modal {
    z-index: 2000 !important;
}

/* O Confirm Modal (Eliminar) fica na camada m√°xima */
#confirm-modal {
    z-index: 9999 !important;
}

/* Garante que o fundo escuro do confirm tamb√©m fique √† frente */
#confirm-modal.modal-overlay {
    z-index: 30000 !important;
}

/* Garante que o conte√∫do do modal tamb√©m acompanhe a camada */
#confirm-modal .modal-content {
    z-index: 30001 !important;
}

/* Estilo espec√≠fico para as abas da 4¬™ Coluna */
#ref-tabs {
    border-bottom: 1px solid var(--border-color);
    gap: 15px;
    justify-content: flex-start;
    padding-left: 10px;
}

#ref-tabs button {
    background: none !important; /* Remove o fundo azul antigo */
    border-radius: 0;
    position: relative;
    padding: 10px 5px;
    flex-grow: 0; /* N√£o estica os bot√µes */
    color: var(--text-muted-color);
}

#ref-tabs button.active {
    color: var(--text-color) !important;
}

/* A linha azul ACIMA ou ABAIXO (como pediu 'acima', vou colocar no topo) */
#ref-tabs button.active::after {
    content: '';
    position: absolute;
    top: 0; /* Coloca a linha no topo do bot√£o */
    left: 0;
    width: 100%;
    height: 3px;
    background-color: var(--accent-color);
    border-radius: 0 0 2px 2px;
}

/* Cores para os bot√µes de a√ß√£o do painel lateral */
.btn-brown { background-color: #795548 !important; }
.btn-brown:hover { background-color: #5d4037 !important; }

.btn-orange-dark { background-color: #d35400 !important; }
.btn-orange-dark:hover { background-color: #a04000 !important; }

/* Classe base para garantir que o tamanho e fonte s√£o iguais aos do Puzzle */
.panel-action-btn-styled {
    border: none;
    color: white;
    border-radius: 4px;
    padding: 0 12px;
    height: 30px;
    cursor: pointer;
    font-weight: bold;
    font-size: 13px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

/* Estilo para o vers√≠culo que est√° aberto na 4¬™ coluna */
.bible-grid-btn.active-verse {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: white !important;
    transform: scale(1.1);
    z-index: 5;
    box-shadow: 0 0 12px rgba(74, 144, 226, 0.5);
}

/* Estilo dos Cards das Micas */
.mica-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    position: relative;
    transition: transform 0.2s;
    cursor: pointer;
}

.mica-card:hover { border-color: var(--accent-color); }

.mica-card.active-view {
    cursor: default;
    border-color: var(--accent-color);
    background-color: rgba(255,255,255,0.02);
}

/* Popup de Cores das Micas */
#mica-color-popup {
    display: none;
    position: fixed; /* Mudado de absolute para fixed para ignorar scroll do pai */
    z-index: 30000 !important; /* Muito acima dos 10000 da 4¬™ coluna */
    background: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    padding: 12px;
    border-radius: 12px;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    /* Garante que n√£o saia da tela no mobile */
    max-width: 160px;
}

.mica-color-dot {
    width: 35px; /* Ligeiramente maior para facilitar o toque */
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid rgba(255,255,255,0.1);
    transition: transform 0.1s;
}

.mica-color-dot:active {
    transform: scale(0.9);
}

/* Estilo Unificado para os bot√µes Editar das abas da 4¬™ Coluna */
.ref-panel-edit-btn {
    background: none !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-muted-color) !important;
    border-radius: 4px;
    padding: 4px 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
    height: 28px; /* Altura fixa para alinhar com o t√≠tulo */
    display: flex;
    align-items: center;
    justify-content: center;
}

.ref-panel-edit-btn:hover {
    background-color: var(--hover-color) !important;
    color: var(--text-color) !important;
}

/* Design azul quando est√° em modo "Salvar" */
.ref-panel-edit-btn.is-active {
    color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1) !important;
}

/* Classe unificada para os bot√µes Editar da 4¬™ coluna */
.btn-editar-custom {
    background: none !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-muted-color) !important;
    border-radius: 4px !important;
    padding: 4px 10px !important;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
}

.btn-editar-custom:hover {
    background-color: var(--hover-color) !important;
    color: var(--text-color) !important;
}

/* Estado quando est√° em modo "Salvar" (Azul) */
.btn-editar-custom.is-active {
    color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1) !important;
}




/* Estado visual do card sendo arrastado */
.board-card.dragging-mica {
    opacity: 0.4;
    border: 1px dashed var(--accent-color);
}

/* Estilo para o conte√∫do oculto da B√≠blia no Dossi√© */
.bible-collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.2s, margin-top 0.3s;
    opacity: 0;
    font-size: 0.92em;
    color: var(--text-color);
    padding-left: 8px;
    line-height: 1.5;
    font-style: italic;
    opacity: 0.9;
}

/* Quando o card est√° expandido */
.board-card.bible-open .bible-collapsible-content {
    max-height: 1000px; /* Valor alto para permitir qualquer tamanho de texto */
    opacity: 1;
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding-top: 10px;
}

/* Cursor e Seta no T√≠tulo da B√≠blia */
.bible-clickable-area {
    cursor: pointer;
}

.bible-clickable-area .ref-title-text::after {
    content: ' ‚ñæ';
    font-size: 0.8em;
    opacity: 0.5;
    display: inline-block;
    transition: transform 0.3s;
}

.board-card.bible-open .ref-title-text::after {
    transform: rotate(180deg);
}

/* Bot√µes de navega√ß√£o subir/descer no Dossi√© */
.mica-nav-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 4px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mica-nav-btn:hover {
    background-color: var(--hover-color);
    color: var(--accent-color);
    border-color: var(--border-color);
}

/* Garante que o texto dos cards seja selecion√°vel para c√≥pia */
.board-card.type-ref {
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: default !important;
}

/* Ajuste na √°rea clic√°vel da b√≠blia para n√£o interferir na sele√ß√£o */
.bible-clickable-area {
    user-select: text;
}

.mica-card {
    transition: transform 0.1s, background-color 0.2s;
    /* Impede que o texto seja selecionado enquanto tentas clicar r√°pido */
    user-select: none; 
}

.mica-card:active {
    transform: scale(0.98); /* Efeito de "apertar" o bot√£o ao clicar */
    background-color: var(--hover-color);
}

.bible-card-mica {
    border-left: 4px solid #5d4037 !important; /* Castanho em vez de Roxo */
    padding-left: 10px;
}

/* Estilo para o Modo Pins (Rosa) */
.folder-mode-item.active.mode-pins {
    color: #ff69b4 !important; /* Hot Pink */
}

.folder-mode-item.active.mode-pins::after {
    background-color: #ff69b4 !important;
    height: 3px;
}

/* √çcone de Pin na lista */
.list-item[data-pinned="true"]::after {
    content: 'üìå';
    font-size: 14px;            /* Tamanho do pin */
    position: absolute;
    left: 18px;                 /* Ajusta horizontalmente sobre o √≠cone */
    top: 8px;                   /* Ajusta verticalmente (sobe um pouco) */
    z-index: 10;                /* Garante que fica por cima do √≠cone */
    pointer-events: none;       /* O clique passa atrav√©s do pin para a pasta */
    
    /* Efeito de sombra para o pin destacar-se do √≠cone amarelo */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.6); 
    
    /* Leve inclina√ß√£o para parecer espetado na pasta */
    transform: rotate(-10deg); 
}

/* Garante que o √≠cone original n√£o seja empurrado */
.list-item {
    position: relative; 
}

/* Linha divis√≥ria dentro do menu de contexto */
.menu-sep {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 4px 5px;
    opacity: 0.4;
}

/* Ajuste da Grelha de Emojis do Cosmos */
#cosmos-emoji-grid {
    display: grid;
    /* auto-fill: preenche o espa√ßo dispon√≠vel / minmax: tamanho m√≠nimo de 45px por bot√£o */
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
    gap: 10px;
    width: 100%;
    max-width: 100%; /* Impede que a grelha saia para fora */
    box-sizing: border-box;
    margin-bottom: 20px;
    padding: 5px;
}

/* Ajuste dos bot√µes de Emoji */
.emoji-btn {
    aspect-ratio: 1 / 1; /* Mant√©m o bot√£o sempre quadrado */
    width: 100%;       /* Ocupa a largura da coluna da grelha */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    padding: 0;
}

/* Feedback visual de selecionado */
.emoji-btn.selected {
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1);
    box-shadow: 0 0 5px var(--accent-color);
}

/* No mobile, o modal em si deve ter um limite de largura */
@media (max-width: 480px) {
    #cosmos-modal .modal-content {
        width: 90%;
        max-width: 320px;
        padding: 20px;
    }
    
    .emoji-btn {
        font-size: 18px; /* Reduz ligeiramente o emoji no telem√≥vel */
    }
}


/* Toggle de Escopo de Pesquisa */
#search-scope-container {
    display: none; /* Escondido por padr√£o, aparece via JS */
    align-items: center;
    gap: 8px;
    background: var(--panel-color);
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    margin-right: 10px;
}

.scope-label {
    font-size: 11px;
    font-weight: bold;
    color: var(--text-muted-color);
    text-transform: uppercase;
}

.scope-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
}

.scope-switch input { opacity: 0; width: 0; height: 0; }

.scope-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--sidebar-color);
    transition: .4s;
    border-radius: 20px;
    border: 1px solid var(--border-color);
}

.scope-slider:before {
    position: absolute;
    content: "";
    height: 12px; width: 12px;
    left: 2px; bottom: 2px;
    background-color: var(--text-muted-color);
    transition: .4s;
    border-radius: 50%;
}

input:checked + .scope-slider { background-color: var(--accent-color); }
input:checked + .scope-slider:before { transform: translateX(16px); background-color: white; }

/* Bot√£o de Escopo de Pesquisa (Quadrado como o Filtros) */
#search-scope-btn {
    display: none; /* Escondido por padr√£o */
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    margin-left: 10px; /* Espa√ßo √† direita do Filtros */
    white-space: nowrap;
    align-items: center;
    gap: 8px;
}

#search-scope-btn:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Estado Ativo (Na P√°gina) */
#search-scope-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}


/* Bot√£o X no canto superior direito */
.corner-close-btn {
    position: absolute;
    top: 5px;
    right: 8px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-muted-color);
    opacity: 0.5;
    transition: opacity 0.2s, color 0.2s;
    background: none;
    border: none;
    padding: 2px;
    z-index: 5;
}
.corner-close-btn:hover {
    opacity: 1;
    color: #e74c3c;
}

/* Estilo da Gaveta (Pasta) dentro do Gavet√£o */
.gaveta-folder {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px 15px;
    margin: 5px 0 5px 20px; /* Recuo para parecer interno */
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
}
.gaveta-folder:hover {
    background-color: var(--hover-color);
}

.gaveta-title-area {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-color);
    font-weight: 500;
}

/* Header da Gaveta Aberta */
.opened-gaveta-header {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: var(--panel-color);
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid var(--accent-color);
}


/* Garante que o fundo do modal seja vis√≠vel e cubra tudo */
#create-gaveta-modal.modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.85) !important; /* Fundo escuro */
    display: none; /* Controlado pelo JS */
    align-items: center !important;
    justify-content: center !important;
    z-index: 9999999 !important;
}

/* Garante que a caixa branca/escura apare√ßa no meio */
#create-gaveta-modal .modal-content {
    background-color: var(--sidebar-color) !important;
    border: 1px solid var(--accent-color) !important;
    padding: 30px !important;
    border-radius: 12px !important;
    width: 90% !important;
    max-width: 400px !important;
    box-shadow: 0 10px 50px rgba(0,0,0,1) !important;
    color: white !important;
}

#drawer-selection-modal.modal-overlay {
    z-index: 30000 !important;
}

/* Quando o post est√° em modo lista (t√≠tulos apenas) */
.archive-post {
    transition: all 0.2s ease;
}

.archive-post:hover {
    background-color: var(--hover-color);
}

/* Cabe√ßalho do Gavet√£o no Modal */
.modal-gavetao-header {
    background-color: rgba(74, 144, 226, 0.1);
    color: var(--accent-color);
    padding: 8px 12px;
    border-radius: 6px 6px 0 0;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 15px;
    border-left: 4px solid var(--accent-color);
}

/* Container que agrupa as gavetas de um gavet√£o */
.modal-gavetas-group {
    background-color: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 6px 6px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Ajuste do item da gaveta para parecer interno */
.list-item.gaveta-interna {
    margin: 0 !important;
    padding: 10px 15px !important;
    background-color: var(--panel-color);
    border: 1px solid transparent;
}

.list-item.gaveta-interna:hover {
    border-color: var(--accent-color);
}

/* Esconder o bot√£o em ecr√£s pequenos (Mobile) */
@media (max-width: 768px) {
    .pc-only { display: none !important; }
}

/* Regras para o Modo Criativo Ativo */
.notebook-container.creative-mode-active #left-panel,
.notebook-container.creative-mode-active #middle-panel {
    display: none !important;
}

/* Estilo para o bot√£o ü™Å quando est√° ativo no menu */
button[data-action="creative-mode"].active {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important;
}

.archive-separator {
    background-color: rgba(46, 204, 113, 0.05); /* Fundo verde muito subtil */
    border: 1px dashed #2ecc71;
    border-left: 5px solid #2ecc71; /* Barra lateral s√≥lida verde */
    border-radius: 8px;
    padding: 10px 15px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 50px;
    position: relative;
}

.separator-title {
    font-weight: bold;
    color: #27ae60; /* Verde escuro para leitura */
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Cor vermelha para o toggle de colabora√ß√£o quando ativo */
#collab-share-toggle:checked + .slider {
    background-color: #e74c3c !important;
}

/* Opcional: Efeito visual para a bolinha branca quando est√° em modo vermelho */
#collab-share-toggle:checked + .slider:before {
    box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}

/* ============================================================
   ESTILO DO ESCUDO DE CARREGAMENTO (APP LOADER)
   ============================================================ */
#app-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: #1a1a1d; /* Mesma cor do seu --bg-color */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999999; /* Fica por cima de absolutamente tudo */
    transition: opacity 0.5s ease, visibility 0.5s;
}

.loader-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.loader-circle {
    width: 60px;
    height: 60px;
    border: 3px solid rgba(74, 144, 226, 0.1);
    border-top: 3px solid #4a90e2; /* Cor --accent-color */
    border-radius: 50%;
    animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

.loader-logo {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    font-size: 32px;
}

.logo-text {
    font-size: 24px;
    font-weight: bold;
    color: #f0f0f0;
    letter-spacing: 1px;
}

.loader-status {
    color: #888;
    font-size: 0.9em;
    font-style: italic;
    animation: pulse 1.5s infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Classe para esconder com suavidade */
#app-loader.fade-out {
    opacity: 0;
    visibility: hidden;
}


.notebook-container { 
    display: none !important; /* Adiciona isto: O site nasce escondido */
    height: 100vh; 
    width: 100vw; 
}

/* Garante que o Loader est√° sempre por cima e vis√≠vel no in√≠cio */
#app-loader {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: #1a1a1d;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999999;
}

</style>




</head>
<body>

    <div class="notebook-container">
        <!-- PAINEL DA ESQUERDA -->
    <aside id="left-panel">
    <button id="left-panel-toggle-btn" title="Mostrar Painel">‚ò∞</button>
    
    <!-- WRAPPER DE CONTE√öDO (Mant√©m tudo alinhado no topo) -->
    <div class="panel-content">
        
        <!-- 1. Tabs (Note, Lists, Book) -->
        <div class="tabs-container">
            <button class="active" data-tab="note">Note</button>
            <button data-tab="lists">Lists</button>
            <button data-tab="book">Book</button>
        </div>
        
        <hr>
        
        <!-- 2. O Cabe√ßalho com o Seletor (TEM DE ESTAR ANTES DA LISTA) -->
        <div class="panel-header">
            <div id="left-panel-title" class="folder-mode-container">
                <!-- O JavaScript vai preencher isto, mas deixamos o padr√£o aqui -->
                <span class="folder-mode-item active" onclick="window.switchFolderView('local')">Local</span>
                <span class="folder-mode-separator">|</span>
                <span class="folder-mode-item" onclick="window.switchFolderView('shared')">Partilha</span>
                <span class="folder-mode-separator">|</span>
    <span class="folder-mode-item" onclick="window.switchFolderView('pins')">Pins</span>
            </div>
        </div>
        
        <!-- 3. A Lista de Pastas (Ocupa o espa√ßo restante) -->
        <ul id="left-panel-list">
            <!-- Itens da coluna esquerda gerados via JS -->
        </ul>
    </div>

    <!-- 4. Rodap√© (Fixo em baixo) -->
    <div class="panel-footer">
        <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
        <button id="global-search-btn" title="Pesquisa Global">üîé</button>
        <button id="account-btn" title="Minha Conta">üë§</button>
    </div>
</aside>

      <!-- PAINEL DO MEIO -->
        <main id="middle-panel">
            <div class="panel-header">
                <button id="back-btn" title="Voltar">‚Üê</button>
            
                <button id="middle-panel-toggle-btn" title="Expandir/Recolher" style="margin-right: 10px;">‚Üñ</button>
                
                <h2 id="middle-panel-title">Selecione</h2>
                <button id="add-item-btn" title="Adicionar item">+</button>
            </div>
            <ul id="file-list">
                 <!-- Itens da coluna do meio -->
            </ul>
        </main>

   <!-- PAINEL DA DIREITA - EDITOR -->
        <section id="right-panel">
  
            <div id="editor-placeholder">
                <div class="placeholder-icon">üìñ</div>
                <h2>Selecione uma nota para come√ßar</h2>
                <p>Ou crie uma nova pasta e uma nota.</p>
            </div>
            
           <!-- √ÅREA DO EDITOR -->
            <div id="editor-area" style="display: none; flex-direction: column; height: 100%;">
                
                <!-- √ÅREA DE FERRAMENTAS -->
                <div id="toolbar-container">
                    <div id="editor-toolbar">
                        
                        <!-- √ÅREA DE SCROLL (NO MOBILE) / CONTE√öDO NORMAL (NO PC) -->
                        <div class="tools-scroll-container">
                            
                            <!-- GRUPO 1: Formata√ß√£o -->
                            <div class="toolbar-group">
                                <button data-command="bold" title="Negrito"><b>B</b></button>
                                <button data-command="boldBlue" title="Negrito Azul" style="color: #4a90e2; font-weight: bold;">B</button>
                                <button data-command="italic" title="It√°lico"><i>I</i></button>
                                <button data-command="underline" title="Sublinhado"><u>U</u></button>
                                <button id="toggle-more-tools-btn" title="Mais Ferramentas" style="font-size: 12px; background-color: rgba(255,255,255,0.1);">‚ñº</button>
                            </div>
                            
                            <div class="toolbar-separator"></div>
                            
                            <!-- GRUPO 2: A√ß√µes -->
                            <div class="toolbar-group">
                                <button data-action="show-explorer" title="Explorador">üîç</button>
                                <button data-action="show-attachments" title="Anexos">üìé</button>
                                <button data-command="undo" title="Retroceder">‚Ü©Ô∏è</button>
                                <button data-command="redo" title="Refazer">‚Ü™Ô∏è</button>
                            </div>

                            <div class="toolbar-separator mobile-only"></div>

                            <!-- BARRA SECUND√ÅRIA (Linha 2 no PC / Continua√ß√£o no Mobile) -->
                            <div id="secondary-toolbar" style="display: none;">
                                
                                <!-- Grupo 3: Estilo e Cor -->
                                <div class="toolbar-group">
                                    <select id="editor-zoom" title="Zoom">
                                        <option value="12px">50%</option>
                                        <option value="100%" selected>100%</option>
                                        <option value="18px">110%</option>
                                        <option value="24px">150%</option>
                                    </select>
                                    <select id="editor-format" title="Estilo" style="width: 90px;">
                                        <option value="P" selected>¬∂ Normal</option>
                                        <option value="H1">A1 T√≠tulo</option>
                                        <option value="H2">A2 T√≠tulo</option>
                                        <option value="H3">A3 T√≠tulo</option>
                                    </select>
                                    <input type="color" data-command="foreColor" title="Cor" style="margin: 0 5px;">
                                    <button data-action="insert-toggle-h2" title="Toggle">‚òÇ</button>
                                    <button data-action="make-draggable" title="Arrastar">·Øì</button>
                                </div>
                                
                                <div class="toolbar-separator"></div>

                                <!-- Grupo 4: Widgets -->
                                <div class="toolbar-group">
                                    <button data-action="insert-checkbox" title="Check">‚òëÔ∏è</button>
                                    <button data-cmd-sec="insertHorizontalRule" title="Linha">‚Äï</button>
                                </div>

                                <div class="toolbar-separator"></div>

                                <!-- Grupo 4b: Widgets Complexos -->
                                <div class="toolbar-group">
                                    <button data-action="insert-table" title="Tabela">üßÆ</button>
                                    <button data-action="insert-date" title="Data">üìÖ</button>
                                    <button data-action="insert-timeline" title="Timeline">üå≥</button>
                                </div>

                                <div class="toolbar-separator"></div>

                                <!-- Grupo 5: Avan√ßado -->
                                <div class="toolbar-group">
                                    <button data-action="bible-scan" title="Scanner">üé∞</button>
<button id="more-formatting-btn" data-action="more-formatting" title="Mais Formata√ß√µes" style="font-weight: bold; font-size: 18px;">‚ãÆ</button>
                                </div>
                            </div>
                        </div>

                        <!-- GRUPO DE NAVEGA√á√ÉO E HIST√ìRICO -->
                        <div class="toolbar-history-group">
                            <button id="mobile-back-btn" title="Voltar" style="display: none;">‚¨Ö</button>
                            <span id="save-status-indicator" class="save-status"></span>
                            <div style="display: flex; gap: 5px;">
                                <button data-action="note-sharing-settings" title="Partilha">üîê</button> 
                                <button data-action="show-topics" title="T√≥picos">üìë</button> 
                                <button data-action="show-history" title="Hist√≥rico">üïí</button>
                            </div>
                        </div>
                    </div>
                </div>

                <input type="text" id="note-title-input" placeholder="T√≠tulo da nota...">
                <div id="note-content-editor" contenteditable="true" spellcheck="true"></div>
            </div>

            <!-- √ÅREA DE ARQUIVO (FEED) -->
            <div id="archive-area" style="display: none; flex-direction: column; height: 100%; position: relative;">
                <div id="archive-mobile-nav" style="display: none; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--panel-color);">
                    <button id="archive-back-btn" style="background: none; border: none; font-size: 22px; color: var(--accent-color); cursor: pointer; padding: 0;">‚¨Ö</button>
                    <span style="margin-left: 15px; font-weight: bold; color: var(--text-color);">Arquivo</span>
                </div>

                <div id="collab-bar" style="display:none; align-items: center; padding: 10px 20px; gap: 10px; background: rgba(74, 144, 226, 0.05); border-bottom: 1px solid var(--border-color);">
                    <span style="font-size: 0.7em; color: var(--text-muted-color); text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">Online agora:</span>
                    <div id="active-users-list" style="display: flex; gap: 5px;"></div>
                </div>

                <div style="padding: 20px 20px 10px 20px;">
                    <input type="text" id="archive-title-input" placeholder="T√≠tulo do Arquivo..." 
                           style="width: 100%; background: none; border: none; border-bottom: 1px solid var(--border-color); color: var(--text-color); font-size: 2.5em; font-weight: bold; outline: none; padding-bottom: 5px;">
                </div>

                <div id="archive-toolbar" style="padding: 10px 20px; display: flex; align-items: center; justify-content: flex-end; margin-bottom: 5px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="archive-save-status" class="save-status" style="margin: 0; font-size: 0.8em; font-style: italic;">Guardado</span>
                        <div style="display: flex; gap: 10px;">
                            <button data-action="archive-share" title="Partilha" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted-color);">üîì</button>
                            <button data-action="archive-topics" title="T√≥picos" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted-color);">üìë</button>
                            <button data-action="archive-history" title="Hist√≥rico/Reciclagem" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted-color);">üïí</button>
                        </div>
                    </div>
                </div>

                <div class="archive-tabs" style="padding: 0 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border-color);">
                    <button class="archive-tab-btn active" data-archive-tab="prateleira">Prateleira</button>
                    <button class="archive-tab-btn" data-archive-tab="gavet√µes">Gavet√£o</button>
                    <button id="create-post-btn" class="archive-inline-create-btn">+ Post</button>
                    <button id="create-drawer-trigger-btn" class="archive-inline-create-btn" style="display: none;">+ Gavet√£o</button>
<button id="create-separator-btn" class="archive-inline-create-btn" style="display: none; background-color: #2ecc71;">+ Separador</button>
                </div>

                <div id="archive-feed" style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; display: flex; flex-direction: column; gap: 20px;">
                    <!-- Posts inseridos aqui -->
                </div>
            </div>
        </section> <!-- FECHO DO PAINEL DIREITO (EDITOR) -->

        <!-- PAINEL DA DIREITA (QUARTA COLUNA) PARA REFER√äNCIAS -->
        <aside id="references-panel">
            <div class="panel-header">
                <h2 id="references-panel-title">Refer√™ncias</h2>
                <button id="references-panel-close-btn" title="Fechar">√ó</button>
            </div>
            
            <p id="references-panel-description"></p>
            
            <hr class="references-separator">
            <div id="references-toolbar">
                <button id="references-refresh-btn" title="Atualizar">üîÑ</button>
                <button id="references-wol-btn" title="Ler na WOL" style="display: none;">üìñ</button>
                <button id="references-search-btn" title="Pesquisar na JW">üîç</button>
                <button id="references-edit-btn" title="Editar">‚úèÔ∏è</button>
                <button id="references-bookmark-btn" title="Marcadores" style="display: none;">üîñ</button> 
                <button id="references-toggle-btn" title="Expandir/Recolher">‚ÜïÔ∏è</button>
            </div>
            <hr class="references-separator">

       <div class="tabs-container" id="ref-tabs">
                <button class="active" data-ref-tab="puzzle">üß© Puzzle</button>
                <button data-ref-tab="links">‚ö° Links</button>
                <button data-ref-tab="dossie">üìº Dossi√©</button>
                <button data-ref-tab="references">‚ùù Cita</button>
            </div>

            <!-- ABA 1: PUZZLE (QUADRO) -->
            <div id="ref-content-puzzle" class="ref-tab-content active" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 0 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Quadro</h3>
                    <div id="puzzle-header-actions" style="display:flex; gap: 5px; align-items: center;">
                        <div id="puzzle-add-buttons" style="display:none; gap:5px;">
                            <button id="teleport-puzzle-btn" title="Converter em Nota" style="background-color: #8e44ad; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">üì°</button>    
                            <button id="add-text-btn" title="Adicionar Texto" style="background-color: #3498db; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; display: flex; align-items: center;">+ Txt</button>
                            <button id="add-ref-btn" title="Adicionar Refer√™ncia Existente" style="background-color: #2ecc71; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; display: flex; align-items: center;">+ Ref</button>
                        </div>
                        <button id="toggle-puzzle-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>

                <div id="puzzle-board-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;">
                    <p id="puzzle-empty-msg" style="font-style:italic; color:var(--text-muted-color); font-size:0.9em; text-align:center;">
                        O quadro est√° vazio. Clique em "Editar" para adicionar notas ou refer√™ncias.
                    </p>
                </div>
            </div>

            <!-- ABA 2: DOSSI√â (MICAS) -->
            <div id="ref-content-dossie" class="ref-tab-content" style="display: none; flex-direction: column; padding: 0 10px; flex-grow: 1; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 id="dossie-view-title" style="color:var(--text-color); margin:0; font-size: 1.1em;">Micas</h3>
                    <div style="display:flex; gap: 5px; align-items: center;">
                        <button id="mica-back-btn" class="panel-action-btn-styled" style="display:none; background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color); height:30px;">Back</button>
                       <button id="mica-add-bible-btn" class="panel-action-btn-styled" style="display:none; background-color: #5d4037; color: white; height:30px;">+B√≠blia</button>
                        <button id="mica-add-content-btn" class="panel-action-btn-styled btn-green" style="display:none; height:30px;">+ Add</button>
                        <div id="dossie-edit-actions" style="display:none;">
                            <button id="add-mica-btn" class="panel-action-btn-styled btn-orange-dark" style="height:30px;">+ Micas</button>
                        </div>
                        <button id="toggle-dossie-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>
                <div id="dossie-list-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;"></div>
            </div>

            <!-- ABA 3: CITA (REFER√äNCIAS) -->
            <div id="ref-content-references" class="ref-tab-content" style="flex-grow: 1; overflow-y: auto; display: none;">
                <ul id="references-list"></ul>
            </div>

            <!-- ABA 4: LINKS (DOC.) -->
            <div id="ref-content-links" class="ref-tab-content" style="display: none; flex-direction: column; padding: 0 10px; flex-grow: 1; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Doc.</h3>
                    <div style="display:flex; gap: 5px; align-items: center;">
                        <div id="links-edit-actions" style="display:none; gap:5px;">
                            <button onclick="window.openPanelLinkCreator('link')" class="panel-action-btn-styled btn-brown">+ Link</button>
                            <button onclick="window.openPanelLinkCreator('codex')" class="panel-action-btn-styled btn-orange-dark">+ Codex</button>
                        </div>
                        <button id="toggle-links-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>
                <div id="panel-links-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </aside>

    </div> 

    <!-- MODAIS E POPUPS GLOBAIS -->
    <div id="post-type-popup" class="modal-overlay" style="z-index: 2100;">
        <div class="modal-content" style="max-width: 300px; text-align: center;">
            <h3>Novo Post</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <button class="modal-btn" id="gen-text-btn" style="padding: 15px; text-align: left;">üìù Gerar Texto</button>
                <button class="modal-btn" id="gen-entity-btn" style="padding: 15px; text-align: left;">üõ∏ Gerar Entidade</button>
            </div>
            <button class="modal-btn secondary" onclick="document.getElementById('post-type-popup').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="entity-type-popup" class="modal-overlay" style="z-index: 2200;">
        <div class="modal-content" style="max-width: 300px;">
            <h3>Escolher Entidade</h3>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                <button class="modal-btn" onclick="createArchiveEntity('subnota')">üìò Subnota</button>
                <button class="modal-btn" onclick="createArchiveEntity('question')">üìó Quest√£o</button>
                <button class="modal-btn" onclick="createArchiveEntity('free')">üìô Contentor</button>
                <button class="modal-btn" onclick="createArchiveEntity('toggle')">‚òÇ T√≠tulo Toggle</button>
                <button class="modal-btn" onclick="createArchiveEntity('idea')">üí° Ideia</button>
            </div>
            <button class="modal-btn secondary" onclick="document.getElementById('entity-type-popup').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="puzzle-ref-selection-modal" class="modal-overlay" style="z-index: 2300;">
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3>Escolher Refer√™ncia</h3>
            <p style="font-size:0.9em; color:var(--text-muted-color); margin-bottom:10px;">Selecione uma ocorr√™ncia para adicionar ao Quadro:</p>
            <ul id="puzzle-ref-selection-list" class="move-list" style="flex-grow: 1; overflow-y: auto;"></ul>
            <div class="modal-actions" style="margin-top: 15px;">
                <button class="modal-btn secondary" onclick="document.getElementById('puzzle-ref-selection-modal').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="selection-popup" style="display: none; position: absolute; z-index: 1010;">
        <button data-action="create-link" title="Criar Link / Anexo">üîó</button>
        <button data-action="break-link" title="Remover Link">‚õìÔ∏è‚Äçüí•</button> 
        <button data-action="create-entity" data-type="local" title="Local">üìç</button>
        <button data-action="create-entity" data-type="personagem" title="Personagem">üë§</button>
        <button data-action="create-entity" data-type="data" title="Data">üìÖ</button>
        <button data-action="create-entity" data-type="textobiblico" title="Texto B√≠blico">üìñ</button>
        <div class="popup-separator"></div>
        <button data-action="highlight" title="Criar Post-it">üìí</button>
        <button data-action="create-idea" title="Converter em Ideia">üí°</button>
        <button data-action="create-url-card" title="Criar Cart√£o Web">üé¥</button>
    </div>

    <div id="insertion-popup" style="display: none; position: absolute; z-index: 1010;">
        <button data-action="quick-mini-note" title="Inserir Mini-Nota">üìò</button>
        <button data-action="insert-question" title="Inserir Quest√£o">üìó</button>
        <button data-action="insert-free-container" title="Inserir Contentor Livre">üìô</button>
        <div class="popup-separator"></div>
        <button data-action="quick-placeholder" title="Inserir Post-it">üìí</button>
    </div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Adicionar Item</h3>
            <div id="add-item-options">
                 <button data-type="pasta">üìÅ Criar Pasta</button>
                 <button data-type="nota">üìÑ Criar Nota</button>
                 <button data-type="agregacao">üß¨ Criar Agrega√ß√£o</button>
                 <button data-type="arquivo">üóÑÔ∏è Adicionar Arquivo</button>
            </div>
            <input type="text" id="new-item-name" placeholder="Nome do item" style="display: none;">
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-item-addition" style="display: none;">Criar</button>
            </div>
        </div>
    </div>

  <div id="context-menu" class="context-menu" style="display: none;">
    <!-- GRUPO 1: Identidade e Seguran√ßa -->
    <button data-action="rename">Mudar Nome</button>
    <button data-action="toggle-pin">Adicionar Pin</button>
    <button data-action="protect">Proteger</button>
    <button data-action="unprotect" style="display:none;">Tirar Prote√ß√£o</button>
    <hr class="menu-sep">
    <!-- GRUPO 2: Organiza√ß√£o -->
    <button data-action="move-position">Mover Posi√ß√£o</button>
    <button data-action="move-folder">Mover de Pasta</button>
    <hr class="menu-sep">
    <!-- GRUPO 3: Atribui√ß√µes e Tipo -->
    <button data-action="manage-topics">Anexar T√≥pico</button>
    <!-- Este bot√£o s√≥ aparece em Superpastas -->
    <button data-action="change-icon" style="display: none;">Mudar Icon</button>
    <!-- Este muda texto entre Tornar Superpasta / Tornar Pasta -->
    <button data-action="toggle-superfolder">Tornar Superpasta</button>
    <hr class="menu-sep">
    <!-- GRUPO 4: Elimina√ß√£o -->
    <button data-action="hide">Ocultar</button>
</div>

    <div id="move-to-folder-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover para a Pasta</h3>
            <p>Selecione a pasta de destino para "<span id="item-to-move-name"></span>".</p>
            <div id="move-modal-current-path"></div>
            <ul id="folder-selection-list" class="move-list" style="max-height: 50vh;"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-folder-move">Mover</button>
            </div>
        </div>
    </div>

    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover Item</h3>
            <ul id="move-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="save-order">Salvar Ordem</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title">Voc√™ tem certeza?</h3>
            <p id="confirm-message">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="confirm">Confirmar</button>
            </div>
        </div>
    </div>




    <!-- MODAL DE CONFIGURA√á√ïES -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal-content settings-expanded">
        <!-- Cabe√ßalho com T√≠tulo e Bot√£o X -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
            <h3 style="margin: 0;">Configura√ß√µes</h3>
            <button data-action="cancel" style="background: none; border: none; color: var(--text-muted-color); font-size: 28px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- √Årea de Conte√∫do com Scroll -->
        <div class="modal-scroll-area">
            <button class="modal-btn primary" data-action="show-hidden-items" style="width: 100%; margin-bottom: 20px;">
                Ver Pastas Ocultas
            </button>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
            
            <h4 style="margin-bottom: 10px; color: var(--accent-color);">Privacidade & Pesquisa</h4>
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
                Defina se os itens protegidos com palavra-passe devem aparecer no Painel de Refer√™ncias.
            </p>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-tags">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>Tags</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-topics">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>T√≥picos</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-anchors">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>√Çncoras</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-global-search-superfolder">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>Globalmente</strong> dentro de Superpastas</span>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: var(--accent-color);">T√≠tulos Entidades</h4>
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
                Permite que os t√≠tulos de Quest√µes e Subnotas ocupem v√°rias linhas se o texto for grande.
            </p>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-full-titles">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Mostrar T√≠tulo Completo de Entidade</span>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel" style="width: 100%;">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL MINHA CONTA -->
<div id="account-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Minha Conta</h3>
        
        <div class="profile-info">
            <span class="profile-avatar">üë§</span>
            <span id="profile-name-display" class="profile-name">Carregando...</span>
            <span id="profile-email-display" class="profile-email">...</span>
        </div>

        <button class="modal-btn secondary" id="logout-btn" style="width: 100%; background-color: #c0392b; color: white;">
            Sair da Conta (Logout)
        </button>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

    <!-- MODAL DE ITENS OCULTOS -->
    <div id="hidden-items-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Itens Ocultos</h3>
            <ul id="hidden-items-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR/EDITAR LINK (ANEXO) -->
<div id="link-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 650px; width: 95%;">
        <h3 id="link-modal-title">Gest√£o</h3>
        
        <!-- ABAS -->
        <div class="tabs-container" id="box-link-tabs" style="margin-top: 15px;">
            <button class="active" data-box-tab="refs">Refer√™ncias da Caixa</button>
            <button data-box-tab="codex">Codex</button>
        </div>

        <!-- CONTE√öDO ABA REFER√äNCIAS (O QUE J√Å TINHA) -->
        <div id="box-content-refs" class="box-tab-content">
            <div style="margin-top: 15px;">
                <label style="font-size: 0.85em; color: var(--text-muted-color);">T√≠tulo do Grupo</label>
                <input type="text" id="link-title-input" placeholder="T√≠tulo do anexo">
                
                <div id="link-urls-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; margin-top: 10px;">
                </div>
                <button id="add-url-btn" class="modal-btn" style="width: 100%; background-color: var(--hover-color); text-align: center;">
                    + Adicionar URL
                </button>
            </div>
        </div>

        <!-- CONTE√öDO ABA CODEX -->
        <div id="box-content-codex" class="box-tab-content" style="display: none; margin-top: 15px;">
            <div id="codex-rows-container" style="display: flex; flex-direction: column; gap: 15px; max-height: 40vh; overflow-y: auto; padding-right: 5px;">
                <!-- As linhas do Codex ser√£o geradas aqui -->
            </div>
            <button id="add-codex-row-btn" class="modal-btn" style="width: 100%; margin-top: 10px; border: 1px dashed var(--accent-color); color: var(--accent-color);">
                + Adicionar Nova Linha Codex
            </button>
        </div>

        <div class="modal-actions">
    <button class="modal-btn" id="link-remove-btn" style="background-color: #c0392b; color: white; display: none;">Limpar Tudo</button>
    <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
    <button class="modal-btn primary" id="link-save-btn">Gravar</button>
</div>
    </div>
</div>

    <!-- MODAL PARA CRIAR ENTIDADE (Local, Personagem, Data) -->
    <div id="entity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="entity-modal-title">Criar Entidade</h3>
            <input type="text" id="entity-name-input" placeholder="Nome">
            <textarea id="entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 80px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
            <p id="entity-error-message" style="color: #e74c3c; display: none;">J√° existe uma entidade com este nome.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="entity-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA LISTAS (Tags, Anexos, etc.) -->
    <div id="generic-list-modal" class="modal-overlay">
    <div id="generic-list-modal-content" class="modal-content">
        <h3 id="generic-list-title">Lista</h3>
        <ul id="generic-list-content" class="move-list" style="max-height: 60vh;">
            <!-- O conte√∫do ser√° preenchido via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>
    <!-- MODAL DE √ÇNCORAS COM ABAS -->
   <div id="anchors-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; display: flex; flex-direction: column; max-height: 85vh;">
        <h3 id="explorer-title">Pesquisa Global</h3>
        
        <div id="anchors-content-container" style="flex-grow: 1; overflow-y: auto; margin-top: 15px;">
            <!-- Onde a pesquisa ou os filtros aparecer√£o -->
        </div>

  <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; align-items: center; justify-content: flex-end;">
    
    <!-- Bot√£o Filtros -->
    <button id="toggle-search-filters-btn" class="modal-btn secondary">‚öôÔ∏è Filtros</button>
    <!-- Bot√£o Escopo (Aparece via JS) -->
    <button id="search-scope-btn" title="Alternar escopo de pesquisa">
        <span>No Par√°grafo</span>
    </button>
    <div style="flex-grow: 1;"></div> <!-- Empurra o bot√£o Fechar para a direita -->
    <button class="modal-btn secondary" data-action="cancel">Fechar</button>
</div>



    <!-- MODAL PARA EDITAR ENTIDADE -->
<div id="edit-entity-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="edit-entity-title">Editar Entidade</h3>
        <input type="text" id="edit-entity-name-input" placeholder="Nome da entidade">
        
        <!-- NOVO: Sec√ß√£o de Emoji exclusiva para Subtemas -->
        <div id="edit-emoji-container" style="display: none; margin-bottom: 20px;">
    <label style="display:block; margin-bottom:10px; font-size: 0.85em; color: var(--text-muted-color);">Mudar Emoji:</label>
    <input type="text" id="edit-emoji-input" maxlength="5" 
           style="width: 70px; height: 70px; text-align: center; font-size: 35px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; color: white; outline: none; transition: border-color 0.2s;"
           onfocus="this.style.borderColor='var(--accent-color)'" 
           onblur="this.style.borderColor='var(--border-color)'">
</div>

        <textarea id="edit-entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 120px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="edit-entity-save-btn">Gravar Altera√ß√µes</button>
        </div>
    </div>
</div>


    <!-- POPUP DE SUGEST√ÉO DE TAGS (escondido por padr√£o) -->
<div id="tag-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="tag-suggestion-list" class="suggestion-list"></ul>
</div>

<!-- POPUP DE SUGEST√ÉO DE ENTIDADES (escondido por padr√£o) -->
<div id="entity-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="entity-suggestion-list" class="suggestion-list"></ul>
</div>


<!-- MODAL DE HIST√ìRICO E BACKUP -->
<div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="history-modal-title">Hist√≥rico da Nota</h3>
        <p>Crie um ponto de restauro ou restaure uma vers√£o anterior. A restaura√ß√£o cria uma <strong>nova nota</strong> com o conte√∫do do backup.</p>
        
        <button id="backup-now-btn" class="modal-btn primary" style="width: 100%; margin: 20px 0;">
            Fazer backup do estado atual
        </button>

        <h4>Backups existentes:</h4>
        <ul id="history-list-content" class="move-list" style="max-height: 40vh; margin-top: 10px;">
            <li>Nenhum backup encontrado.</li>
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER O CONTE√öDO DO BACKUP -->
<div id="view-backup-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 80vw; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="view-backup-title">Visualizando Backup</h3>
        <div id="view-backup-content" style="background-color: var(--bg-color); padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            <!-- Conte√∫do do backup aqui -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VISUALIZAR LINK -->
<div id="view-link-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="view-link-title">Visualizar Anexo</h3>
        <ul id="view-link-urls-list" class="move-list" style="margin-top: 20px; margin-bottom: 20px; max-height: 40vh;">
            <!-- URLs ser√£o preenchidas via JS -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn primary" id="view-link-edit-btn">Editar</button>
        </div>
    </div>
</div>

<!-- MODAL PRINCIPAL: SELE√á√ÉO DE T√ìPICOS -->
<div id="topics-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>T√≥picos da Nota</h3>
            <button id="manage-topics-btn" title="Criar/Gerir T√≥picos" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer;">+</button>
        </div>
        
        <div class="topics-layout">
            <!-- Coluna da Esquerda: Lista de T√≥picos -->
            <div class="topics-column">
                <h4>T√≥picos</h4>
                <ul id="topics-list-select" class="topics-list"></ul>
            </div>
            <!-- Coluna da Direita: Lista de Subt√≥picos -->
            <div class="topics-column">
                <h4 id="subtopics-title-select">Subt√≥picos</h4>
                <ul id="subtopics-list-select" class="topics-list">
                    <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="save-topics-btn">Gravar T√≥picos</button>
        </div>
    </div>
</div>

<!-- MODAL SECUND√ÅRIO: CRIA√á√ÉO DE T√ìPICOS (GEST√ÉO) -->
<div id="manage-topics-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
        <div style="margin-bottom: 15px;">
            <h3>Criar T√≥picos e Subt√≥picos</h3>
            <p style="font-size: 0.9em; color: var(--text-muted-color);">Adicione novos itens √† base de dados global.</p>
        </div>

        <div class="topics-layout">
            <!-- Coluna da Esquerda: Gerir T√≥picos -->
            <div class="topics-column">
                <button id="create-new-topic-btn" class="create-btn">+ Criar Novo T√≥pico</button>
                <input type="text" id="search-topic-input" placeholder="Filtrar t√≥picos..." class="topic-search-input">
                <ul id="topics-list-manage" class="topics-list"></ul>
            </div>
            <!-- Coluna da Direita: Gerir Subt√≥picos -->
            <div class="topics-column">
                <button id="create-new-subtopic-btn" class="create-btn" style="display: none;">+ Criar Novo Subt√≥pico</button>
                <ul id="subtopics-list-manage" class="topics-list">
                    <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico para adicionar subt√≥picos.</li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" id="close-manage-topics-btn">Voltar</button>
        </div>
    </div>
</div>

<!-- MODAL DE INPUT DUPLO (Nome + Descri√ß√£o) -->
<div id="custom-input-modal" class="modal-overlay" style="z-index: 1200;">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="custom-input-title">Novo Item</h3>
        
        <!-- Campo Nome -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Nome</label>
        <input type="text" id="custom-input-name" placeholder="Escreva o nome aqui..." 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <!-- Campo Descri√ß√£o (Novo) -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Descri√ß√£o <small>(Opcional)</small></label>
        <textarea id="custom-input-desc" placeholder="Detalhes adicionais..." 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none; font-family: inherit;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="custom-input-cancel">Cancelar</button>
            <button class="modal-btn primary" id="custom-input-confirm">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE PALAVRA-PASSE -->
<div id="password-modal" class="modal-overlay" style="z-index: 2000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3 id="password-modal-title">Proteger Item</h3>
        <p id="password-modal-desc" style="margin-bottom: 15px; font-size: 0.9em;">Defina uma palavra-passe.</p>
        
       <input type="password" id="password-input" placeholder="Palavra-passe" 
       autocomplete="new-password"
       style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <p id="password-error" style="color: #e74c3c; font-size: 0.9em; display: none; margin-bottom: 10px;">Palavra-passe incorreta.</p>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="password-confirm-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE GEST√ÉO DE MARCADORES (Lista) -->
<div id="bookmarks-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Marcadores</h3>
            <!-- Bot√£o '+' no canto superior direito -->
            <button id="open-create-bookmark-btn" title="Novo Marcador" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Selecione os marcadores para associar a este texto b√≠blico.
        </p>

        <ul id="bookmarks-list" class="move-list" style="max-height: 50vh;">
            <!-- A lista ser√° preenchida via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL DE CRIA√á√ÉO DE NOVO MARCADOR (Sub-popup) -->
<div id="create-bookmark-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Novo G√©nero de Marcador</h3>
        
        <input type="text" id="new-bookmark-title" placeholder="T√≠tulo (ex: Profecias)" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="new-bookmark-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-create-bookmark">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-bookmark">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE BLOQUEIO DE GRAVA√á√ÉO -->
<div id="forcing-save-modal" class="modal-overlay" style="z-index: 9999; background-color: rgba(0,0,0,0.85);">
    <div class="modal-content" style="text-align: center; max-width: 300px; border: 1px solid var(--accent-color);">
        <div class="spinner" style="margin: 0 auto 15px auto; border-left-color: var(--accent-color);"></div>
        <h3 style="margin-bottom: 10px; color: white;">A Guardar...</h3>
        <p style="color: var(--text-muted-color); font-size: 0.9em;">Por favor, aguarde enquanto as suas altera√ß√µes s√£o enviadas.</p>
    </div>
</div>

<!-- POPUP DE ESCOLHA DE TAMANHO DO POST-IT -->
<div id="postit-size-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020; flex-direction: column; width: 180px; padding: 5px;">
    <button data-size="small" style="text-align:left; width:100%; border-radius:4px; padding:8px;">‚ñ´Ô∏è Pequeno</button>
    <button data-size="medium" style="text-align:left; width:100%; border-radius:4px; padding:8px;">‚óªÔ∏è M√©dio</button>
    <button data-size="large" style="text-align:left; width:100%; border-radius:4px; padding:8px;">‚¨ú Grande</button>
</div>

<!-- POPUP DE A√á√ïES DA IDEIA (‚úÇÔ∏è üß≤) -->
<div id="idea-actions-popup" style="display: none; position: absolute; background: var(--sidebar-color); border: 1px solid var(--border-color); padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; gap: 5px;">
    <button data-action="remove-idea" title="Remover Ideia" style="background:none; border:none; cursor:pointer; font-size:18px;">‚úÇÔ∏è</button>
    <button data-action="append-idea" title="Adicionar a outra nota" style="background:none; border:none; cursor:pointer; font-size:18px;">üß≤</button>
</div>

<!-- MODAL DE SELE√á√ÉO DE NOTA (Para transferir a ideia) -->
<div id="select-note-modal" class="modal-overlay" style="z-index: 2100;">
    <div class="modal-content">
        <h3>Adicionar Ideia a...</h3>
        <p style="font-size:0.9em; color:#888;">Selecione uma nota nesta pasta:</p>
        <ul id="select-note-list" class="move-list" style="max-height: 50vh;"></ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- NOVO MODAL DE DESTAQUES (POPUP CENTRAL) -->
<div id="highlight-modal" class="modal-overlay" style="z-index: 2200;">
    <div class="modal-content" style="max-width: 500px;">
        <h3>Escolher o Marcador</h3>
        <div id="highlight-options-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <!-- As cores ser√£o geradas aqui via JS -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- MENU FLUTUANTE PARA TABELAS -->
<div id="table-tools-popup">
    <div style="font-size:0.8em; color:#888; width:100%; text-align:center; padding-bottom:4px;">Tabela</div>
    <button data-action="add-row-above" title="Linha Acima">‚¨ÜÔ∏è Linha</button>
    <button data-action="add-row-below" title="Linha Abaixo">‚¨áÔ∏è Linha</button>
    <button data-action="add-col-left" title="Coluna Esquerda">‚¨ÖÔ∏è Coluna</button>
    <button data-action="add-col-right" title="Coluna Direita">‚û°Ô∏è Coluna</button>
    <div class="sep"></div>
    <button data-action="del-row" title="Apagar Linha" style="color:#e74c3c;">‚ùå Linha</button>
    <button data-action="del-col" title="Apagar Coluna" style="color:#e74c3c;">‚ùå Coluna</button>
    <button data-action="del-table" title="Apagar Tabela Inteira" style="width:100%; border-color:#e74c3c; color:#e74c3c; margin-top:3px;">üóëÔ∏è Apagar Tabela</button>
</div>


<!-- MODAL DE TAREFA DE CALEND√ÅRIO -->
<div id="calendar-task-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Agenda: <span id="cal-selected-date-display"></span></h3>
        <input type="hidden" id="cal-selected-date-iso"> <!-- Guarda YYYY-MM-DD -->
        
        <textarea id="cal-task-desc" placeholder="Descreva a tarefa ou evento..." 
                  style="width: 100%; height: 100px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); margin-bottom: 15px; resize: none;"></textarea>
        
        <!-- Lista de tarefas existentes neste dia -->
        <div id="cal-existing-tasks" style="margin-bottom: 15px; max-height: 100px; overflow-y: auto;"></div>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="cal-save-task-btn">Gravar Tarefa</button>
        </div>
    </div>
</div>

<!-- MODAL DE AGREGA√á√ÉO (SELETOR DE CONTE√öDO) -->
<div id="aggregation-modal" class="modal-overlay" style="z-index: 1500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        <h3>Criar Agrega√ß√£o: <span id="aggregation-new-name" style="color: var(--accent-color);"></span></h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue pelas pastas e notas. Selecione as caixas que deseja copiar para esta nova nota.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs e Bot√£o Voltar) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="agreg-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="agreg-current-path" style="font-weight: bold; color: var(--text-color);">Pasta Raiz</span>
        </div>

        <!-- Lista de Conte√∫do (Pastas, Notas ou Caixas) -->
        <ul id="aggregation-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px;">
            <!-- Preenchido via JS -->
        </ul>

        <!-- Rodap√© com Contador e Bot√£o Criar -->
        <div class="modal-actions" style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px; align-items: center;">
            <span id="agreg-count" style="margin-right: auto; font-weight: bold; color: var(--accent-color);">0 itens selecionados</span>
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="agreg-finish-btn">Criar Agrega√ß√£o</button>
        </div>
    </div>
</div>

<!-- MODAL DE CLONAR PARA NOTA (DESTINO) -->
<div id="append-to-note-modal" class="modal-overlay" style="z-index: 1600;">
    <div class="modal-content" style="max-width: 500px; height: 70vh; display: flex; flex-direction: column;">
        <h3>Enviar para...</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue e selecione a <strong>Nota</strong> onde deseja colar este conte√∫do.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="append-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="append-current-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        </div>

        <!-- Lista de Pastas e Notas -->
        <ul id="append-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px; overflow-y: auto;">
            <!-- Preenchido via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- POPUP DE DEFINI√á√ïES DE PARTILHA DA CAIXA -->
<div id="share-settings-popup">
    <h4>Seguran√ßa da Caixa</h4>
    <div class="share-toggle-row">
        <span>Permitir Partilha</span>
        <label class="setting-switch">
            <input type="checkbox" id="mini-note-share-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    <p style="font-size: 0.75em; color: var(--text-muted-color); margin-top: 10px; line-height: 1.3;">
        Se desativado, o conte√∫do n√£o aparecer√° em links p√∫blicos, mesmo que tenham sido gerados anteriormente.
    </p>
</div>

<!-- POPUP DE PARTILHA (AGORA √â UM MODAL CENTRAL) -->
<div id="note-share-popup" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 400px;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;">Partilha</h3>
            <button onclick="document.getElementById('note-share-popup').style.display='none'" style="background:none; border:none; color:var(--text-muted-color); font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <!-- 1. LINK DE LEITURA (Padr√£o) -->
        <div class="share-toggle-row" style="background-color: var(--bg-color); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <span style="font-weight:bold; color: var(--text-color); display:block;">Link de Leitura</span>
                <small style="color:var(--text-muted-color); font-size:0.75em;">P√∫blico (Apenas Ver)</small>
            </div>
            <label class="setting-switch">
                <input type="checkbox" id="note-share-toggle">
                <span class="slider round"></span>
            </label>
        </div>

        <div id="note-share-link-container" style="display: none; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid var(--accent-color);">
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="note-share-url" readonly 
                       style="flex-grow: 1; height: 36px; padding: 0 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); outline: none; font-size: 0.85em;">
                <button onclick="copyLink('note-share-url')" style="height: 36px; padding: 0 15px; background: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; cursor: pointer; font-size: 0.85em;">Copiar</button>
            </div>
        </div>

        <!-- 2. LINK DE COLABORA√á√ÉO (Apenas Arquivos Partilhados) -->
        <div id="archive-collab-section" style="display: none;">
            <div class="share-toggle-row" style="background-color: rgba(231, 76, 60, 0.1); padding: 12px; border-radius: 8px; border: 1px solid #c0392b; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <span style="font-weight:bold; color: #e74c3c; display:block;">Link de Colabora√ß√£o</span>
                    <small style="color:var(--text-muted-color); font-size:0.75em;">Permite Criar/Editar Posts</small>
                </div>
                <label class="setting-switch">
                    <input type="checkbox" id="collab-share-toggle">
                    <span class="slider round" style="background-color: #ccc;"></span>
                </label>
            </div>

            <div id="collab-share-link-container" style="display: none; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid #e74c3c;">
                <p style="font-size:0.8em; color:#e74c3c; margin-bottom:5px;">‚ö†Ô∏è Quem tiver este link poder√° editar o seu Arquivo.</p>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="collab-share-url" readonly 
                           style="flex-grow: 1; height: 36px; padding: 0 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); outline: none; font-size: 0.85em;">
                    <button onclick="copyLink('collab-share-url')" style="height: 36px; padding: 0 15px; background: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; cursor: pointer; font-size: 0.85em;">Copiar</button>
                </div>
            </div>
        </div>

    </div>
</div>




<!-- POPUP DE CORES DO TOGGLE -->
<div id="toggle-color-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 2500; width: 160px; padding: 10px;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        <!-- As cores ser√£o geradas aqui ou fixas -->
        <button class="color-choice" style="background-color: #ffcdd2;" data-color="#ffcdd2" title="Rosa Suave"></button>
        <button class="color-choice" style="background-color: #ffe0b2;" data-color="#ffe0b2" title="Laranja P√™ssego"></button>
        <button class="color-choice" style="background-color: #fff9c4;" data-color="#fff9c4" title="Amarelo Creme"></button>
        <button class="color-choice" style="background-color: #c8e6c9;" data-color="#c8e6c9" title="Verde Menta"></button>
        <button class="color-choice" style="background-color: #b3e5fc;" data-color="#b3e5fc" title="Azul C√©u"></button>
        <button class="color-choice" style="background-color: #e1bee7;" data-color="#e1bee7" title="Lil√°s"></button>
    </div>
    <div style="margin-top: 8px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 5px;">
        <button class="color-choice-reset" style="background: none; border: none; font-size: 0.8em; color: var(--text-muted-color); cursor: pointer;">Sem Cor</button>
    </div>
</div>

<!-- MODAL DE SCANNER UNIVERSAL (üé∞) -->
<div id="universal-scan-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column; padding: 0;">
        
        <!-- Cabe√ßalho com Abas -->
        <div class="scan-header" style="padding: 15px 15px 0 15px; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 15px;">Detetor de Entidades</h3>
            <div class="scan-tabs">
                <button class="scan-tab-btn active" data-target="textobiblico">üìñ B√≠blia</button>
                <button class="scan-tab-btn" data-target="personagem">üë§ Personagens</button>
                <button class="scan-tab-btn" data-target="local">üìç Locais</button>
                <button class="scan-tab-btn" data-target="data">üìÖ Datas</button>
            </div>
        </div>

        <!-- Corpo das Listas -->
        <div class="scan-body" style="flex-grow: 1; overflow-y: auto; padding: 15px; position: relative;">
            
            <!-- Contentor para as listas (Preenchido via JS) -->
            <div id="scan-lists-container">
                <!-- As listas <ul> ser√£o geradas aqui dinamicamente -->
            </div>

            <!-- POPUP DE PREVIEW (CONTEXTO) -->
            <div id="scan-preview-popup" style="display: none;">
                <div class="preview-header">
                    <strong>Contexto</strong>
                    <button onclick="document.getElementById('scan-preview-popup').style.display='none'">√ó</button>
                </div>
                <div id="scan-preview-content"></div>
            </div>

        </div>

        <!-- Rodap√© -->
        <div class="modal-actions" style="padding: 15px; border-top: 1px solid var(--border-color);">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn secondary" id="scan-toggle-all-btn" style="margin-right: auto;">Selecionar Todos</button>
            <button class="modal-btn primary" id="confirm-scan-btn">Converter Selecionados</button>
        </div>
    </div>
</div>

<!-- Modal de Escolha de √çcone -->
<div id="icon-picker-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>Escolher √çcone</h3>
        <p style="color: var(--text-muted-color); margin-bottom: 15px;">Personalize a sua Superpasta.</p>
        
        <!-- Grelha de Emojis -->
        <div id="emoji-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
            <!-- Padr√£o -->
            <button class="emoji-btn" data-icon="üóÉÔ∏è" style="grid-column: span 4; background: var(--panel-color); border: 1px solid var(--accent-color);">üóÉÔ∏è Padr√£o</button>
            
            <!-- Paisagens -->
            <button class="emoji-btn" data-icon="üèûÔ∏è">üèûÔ∏è</button>
            <button class="emoji-btn" data-icon="üåÖ">üåÖ</button>
            <button class="emoji-btn" data-icon="üåÑ">üåÑ</button>
            <button class="emoji-btn" data-icon="üèúÔ∏è">üèúÔ∏è</button>
            
            <!-- Cidades -->
            <button class="emoji-btn" data-icon="üèôÔ∏è">üèôÔ∏è</button>
            <button class="emoji-btn" data-icon="üåá">üåá</button>
            <button class="emoji-btn" data-icon="üåÜ">üåÜ</button>
            <button class="emoji-btn" data-icon="üåÉ">üåÉ</button>
            
            <!-- Noite/C√©u -->
            <button class="emoji-btn" data-icon="üéë">üéë</button>
            <button class="emoji-btn" data-icon="üåå">üåå</button>
            <button class="emoji-btn" data-icon="üå†">üå†</button>
            <button class="emoji-btn" data-icon="üåâ">üåâ</button>
            
            <!-- Fogos/Estrada -->
            <button class="emoji-btn" data-icon="üéÜ">üéÜ</button>
            <button class="emoji-btn" data-icon="üéá">üéá</button>
            <button class="emoji-btn" data-icon="üõ£Ô∏è">üõ£Ô∏è</button>
            <button class="emoji-btn" data-icon="üõ§Ô∏è">üõ§Ô∏è</button>
        </div>

        <button class="modal-btn secondary" onclick="document.getElementById('icon-picker-modal').style.display='none'" style="width: 100%;">Cancelar</button>
    </div>
</div>

<!-- 2. Modal: Selecionar Gavet√£o (Adicione no final do body) -->
<div id="drawer-selection-modal" class="modal-overlay" style="z-index: 2300;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3>Gavet√£o</h3>
            <button id="open-create-drawer-btn" style="background:var(--accent-color); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer;">+</button>
        </div>
        <ul id="drawer-list-select" class="move-list" style="max-height: 300px; overflow-y: auto;">
            <!-- Gavet√µes aqui -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('drawer-selection-modal').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<!-- 3. Modal: Criar Gavet√£o (CORRIGIDO) -->
<div id="create-drawer-modal" class="modal-overlay" style="z-index: 99999;">
    <div class="modal-content" style="max-width: 350px;">
        <form onsubmit="return false;" autocomplete="off">
            <h3>Criar Gavet√£o</h3>
            
            <input type="text" id="new-drawer-name" placeholder="Nome do gavet√£o" autocomplete="off" 
                   style="width: 100%; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white;">
            
            <textarea id="new-drawer-desc" placeholder="Descri√ß√£o (opcional)" 
                      style="width:100%; height:80px; margin-top:10px; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; resize: none;"></textarea>
            
            <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="modal-btn secondary" onclick="document.getElementById('create-drawer-modal').style.display='none'">Voltar</button>
                <button type="button" class="modal-btn primary" id="confirm-create-drawer">Criar</button>
            </div>
        </form>
    </div>
</div>


<!-- POPUP DE FORMATA√á√ÉO COLORIDA (PC) -->
<div id="formatting-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 3000; width: 250px; padding: 10px; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5);">
    
    <!-- LINHA 1: NEGRITO -->
    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;">
        <button onclick="applyColorStyle('bold', '#ffff00')" style="color: #ffff00; font-weight: bold;">B</button>
        <button onclick="applyColorStyle('bold', '#ff4d4d')" style="color: #ff4d4d; font-weight: bold;">B</button>
        <button onclick="applyColorStyle('bold', '#ffa500')" style="color: #ffa500; font-weight: bold;">B</button>
        <button onclick="applyColorStyle('bold', '#4dff4d')" style="color: #4dff4d; font-weight: bold;">B</button>
        <button onclick="applyColorStyle('bold', '#b366ff')" style="color: #b366ff; font-weight: bold;">B</button>
        <button onclick="applyColorStyle('bold', '#ffffff')" style="color: #ffffff; font-weight: bold;">B</button>
    </div>

    <!-- LINHA SEPARADORA -->
    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;">

    <!-- LINHA 2: IT√ÅLICO -->
    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;">
        <button onclick="applyColorStyle('italic', '#ffff00')" style="color: #ffff00; font-style: italic;">I</button>
        <button onclick="applyColorStyle('italic', '#ff4d4d')" style="color: #ff4d4d; font-style: italic;">I</button>
        <button onclick="applyColorStyle('italic', '#ffa500')" style="color: #ffa500; font-style: italic;">I</button>
        <button onclick="applyColorStyle('italic', '#4dff4d')" style="color: #4dff4d; font-style: italic;">I</button>
        <button onclick="applyColorStyle('italic', '#4da6ff')" style="color: #4da6ff; font-style: italic;">I</button>
      <button onclick="applyColorStyle('italic', '#ffffff')" style="color: #ffffff; font-style: italic;">I</button>
    </div>

<hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;">

<!-- LINHA 3: FERRAMENTAS LADO A LADO -->
<div style="display: flex; gap: 10px; justify-content: center; align-items: center; padding-bottom: 5px;">
    <button data-action="open-robot" 
            style="width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" 
            title="Exportar Sentinela">ü§ñ</button>
            
    <button data-action="open-margin-editor" 
            style="width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" 
            title="Editor de Margem">üî¨</button>

    <button data-action="creative-mode" 
            class="pc-only"
            style="width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" 
            title="Modo Criativo (Tela Inteira)">ü™Å</button>
</div>


<!-- MODAL DO ROB√î (CAIXA DE TEXTO) -->
<div id="robot-modal" class="modal-overlay" style="z-index: 3100;">
    <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">ü§ñ Exportar Sentinela</h3>
        
        <!-- √Årea de Colagem -->
        <div id="robot-input-container">
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 8px;">Cole aqui o texto do artigo (JW.ORG):</p>
            <textarea id="robot-input-text" placeholder="Cole o conte√∫do aqui..." 
                      style="width: 100%; height: 150px; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 10px; resize: none; outline: none;"></textarea>
            <button class="modal-btn primary" id="robot-generate-btn" style="width: 100%; margin-bottom: 15px;">Gerar Perguntas</button>
        </div>

        <!-- √Årea de Pr√©-visualiza√ß√£o (Escondida inicialmente) -->
        <div id="robot-preview-container" style="display: none; flex-grow: 1; overflow-y: auto; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <h4 id="preview-count" style="color: var(--accent-color); margin-bottom: 10px;">Encontradas 0 perguntas:</h4>
            <ul id="preview-list" style="list-style: none; padding: 0; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <!-- Lista gerada aqui -->
            </ul>
        </div>
        
        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" onclick="document.getElementById('robot-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="robot-insert-btn" style="display: none;">Inserir na Nota</button>
        </div>
    </div>
</div>

<!-- MODAL PARA RENOMEAR DESTAQUE -->
<div id="rename-highlight-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3>Renomear Marcador</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">Defina um nome personalizado para esta cor:</p>
        
        <input type="text" id="new-highlight-name-input" placeholder="Ex: Importante, Revisar..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-rename-highlight-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-rename-highlight-btn">Gravar</button>
        </div>
    </div>
</div>


<!-- MODAL CRIAR/EDITAR COSMOS -->
<div id="cosmos-modal" class="modal-overlay" style="z-index: 2600;">
    <div class="modal-content" style="max-width: 400px;">
        <h3 id="cosmos-modal-title">Novo Tema/Conceito</h3>
        
        <input type="text" id="cosmos-name-input" placeholder="Nome do Tema" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="cosmos-desc-input" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 15px; resize: none;"></textarea>
        
        <label style="display:block; margin-bottom:10px; font-size: 0.85em; color: var(--text-muted-color);">Escolher Emoji:</label>
        <div id="cosmos-emoji-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
            <button class="emoji-btn" data-emoji="ü¶ñ">ü¶ñ</button>
            <button class="emoji-btn" data-emoji="üå∫">üå∫</button>
            <button class="emoji-btn" data-emoji="üå±">üå±</button>
            <button class="emoji-btn" data-emoji="üß™">üß™</button>
            <button class="emoji-btn" data-emoji="üìú">üìú</button>
            <button class="emoji-btn" data-emoji="üèõÔ∏è">üèõÔ∏è</button>
            <button class="emoji-btn" data-emoji="üìê">üìê</button>
            <button class="emoji-btn" data-emoji="‚òÑÔ∏è">‚òÑÔ∏è</button>
            <button class="emoji-btn" data-emoji="‚öîÔ∏è">‚öîÔ∏è</button>
            <button class="emoji-btn" id="custom-emoji-btn" style="background: var(--panel-color); border: 1px dashed var(--accent-color);">+</button>
        </div>

        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('cosmos-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="save-cosmos-btn">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA EMOJI PERSONALIZADO -->
<div id="custom-emoji-modal" class="modal-overlay" style="z-index: 9000000;">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>Editar Tema</h3>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">Ajuste o nome e o √≠cone do tema:</p>
        
        <!-- Campo Nome -->
        <input type="text" id="custom-theme-name-input" placeholder="Nome do Tema" 
               style="width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: white; margin-bottom: 15px; outline: none;">

        <!-- Campo Emoji -->
        <label style="display:block; margin-bottom:8px; font-size: 0.75em; text-transform: uppercase; color: var(--text-muted-color);">Emoji / √çcone:</label>
        <input type="text" id="custom-emoji-input" maxlength="5" placeholder="üòä"
               style="width: 80px; height: 80px; text-align: center; font-size: 40px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; color: white; margin: 0 auto 20px auto; outline: none; display: block;">
        
        <div class="modal-actions" style="justify-content: center; gap: 10px;">
            <button class="modal-btn secondary" onclick="document.getElementById('custom-emoji-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-custom-emoji-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE SELE√á√ÉO B√çBLICA PARA MICA -->
<div id="mica-bible-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 450px;">
        <h3>Adicionar Texto B√≠blico</h3>
        
        <label class="codex-label">T√≠tulo do Card (Opcional)</label>
        <input type="text" id="bible-card-title" placeholder="Ex: Base para a esperan√ßa" class="codex-input-modern" style="margin-bottom: 15px;">

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div>
                <label class="codex-label">Livro</label>
                <select id="bible-book-select" class="codex-input-modern"></select>
            </div>
            <div>
                <label class="codex-label">Cap√≠tulo</label>
                <select id="bible-chapter-select" class="codex-input-modern"></select>
            </div>
        </div>

        <label class="codex-label">Vers√≠culos</label>
        <div id="verse-inputs-container" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
            <!-- Linhas de vers√≠culos entrar√£o aqui -->
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="add-single-verse-btn" class="modal-btn" style="flex: 1; background: var(--panel-color); border: 1px solid var(--border-color);">+ Vers√≠culo</button>
            <button id="add-range-verse-btn" class="modal-btn" style="flex: 1; background: var(--panel-color); border: 1px solid var(--border-color);">- Intervalo</button>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('mica-bible-modal').style.display='none'">Cancelar</button>
            <button id="confirm-mica-bible-save" class="modal-btn primary">Adicionar √† Mica</button>
        </div>
    </div>
</div>

<!-- Popup de Cores das Micas -->
<div id="mica-color-popup" style="display: none;"></div>

<!-- MODAL PARA RENOMEAR ITENS -->
<div id="rename-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3>Mudar Nome</h3>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 10px;">Insira o novo nome para o item:</p>
        <input type="text" id="rename-input" placeholder="Novo nome..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-rename-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-rename-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- Modal: Criar Gaveta (Interna) -->
<div id="create-gaveta-modal" class="modal-overlay" style="z-index: 9999999 !important;">
    <div class="modal-content" style="max-width: 350px; background-color: var(--sidebar-color); border: 1px solid var(--accent-color);">
        <h3>Nova Gaveta</h3>
        <p style="font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 10px;">Crie uma pasta dentro deste gavet√£o.</p>
        
        <input type="text" id="new-gaveta-name" placeholder="Nome da gaveta" 
               style="width: 100%; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white;">
        
        <textarea id="new-gaveta-desc" placeholder="Descri√ß√£o (opcional)" 
                  style="width:100%; height:80px; margin-top:10px; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; resize: none;"></textarea>
        
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('create-gaveta-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-gaveta">Criar</button>
        </div>
    </div>
</div>

<!-- ESCUDO DE CARREGAMENTO INICIAL -->
<div id="app-loader">
    <div class="loader-content">
        <div class="loader-circle"></div>
        <div class="loader-logo">
            <span class="logo-icon">üìñ</span>
            <span class="logo-text">NotaBook</span>
        </div>
        <p class="loader-status">A preparar o seu espa√ßo...</p>
    </div>
</div>

<div id="app-loader">
    <div style="text-align:center;">
        <div class="spinner" style="width:50px; height:50px; border-width:4px; margin: 0 auto 20px auto;"></div>
        <h2 style="color:white; font-family:sans-serif;">NotaBook</h2>
        <p style="color:#888; font-style:italic;">A validar acesso...</p>
    </div>
</div>


</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
   <script type="module">
    
  // 1. Importa√ß√µes de Configura√ß√£o
    import { db, auth } from './js/firebase-config.js';
    import { BIBLE_DATA, BIBLICAL_BOOKS } from './js/bible-data.js';
    import { sanitizeHTML, debounce, removeAccents, escapeRegExp } from './js/utils.js';
    import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';



    // 2. Importa√ß√µes do Firestore
    import { 
    collection, query, where, addDoc, serverTimestamp, onSnapshot, 
    doc, getDoc, updateDoc, orderBy, getDocs, writeBatch, deleteField, deleteDoc,
    setDoc, limit, startAfter, runTransaction 
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // 3. Importa√ß√µes de Autentica√ß√£o
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";



document.addEventListener('DOMContentLoaded', () => {
    checkInitialConnection(); // Verifica a conex√£o ao carregar

    // 1. Gravar ao mudar de aba ou minimizar (Muito fi√°vel em telem√≥veis e PC)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        if (activeEditingPostId) {
            console.log("üì± [MOBILE EXIT] App escondida. Gravando e libertando post para outros.");
            
            // Capturamos o ID e limpamos a vari√°vel imediatamente para evitar duplicados
            const tempId = activeEditingPostId;
            activeEditingPostId = null;
            window.activeEditingPostId = null;

            // Executa a grava√ß√£o e o desbloqueio
            window.saveArchivePost(tempId);
        }
    }
});

// 2. Gravar ao perder o foco da janela (ex: clicar noutra janela do Windows)
window.addEventListener('blur', () => {
    if (currentSaveStatus === 'unsaved') {
        executeSave();
    }
});

    const modalObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const target = mutation.target;
                
                // Se o modal passou de 'none' para 'flex' (ou seja, abriu)
                if (target.style.display !== 'none' && target.style.display !== '') {
                    
                    // 1. Fecha a Barra de Ferramentas de Sele√ß√£o
                    if (selectionPopup) selectionPopup.style.display = 'none';

                     if (document.getElementById('insertion-popup')) document.getElementById('insertion-popup').style.display = 'none';

                    // 2. (Opcional) Fecha tamb√©m popups de sugest√£o (@ e #) se estiverem abertos
                    if (tagSuggestionPopup) tagSuggestionPopup.style.display = 'none';
                    if (entitySuggestionPopup) entitySuggestionPopup.style.display = 'none';
                    if (isTagPopupOpen) isTagPopupOpen = false;
                    if (isEntityPopupOpen) isEntityPopupOpen = false;
                }
            }
        });
    });

    // Ativa o observador em todos os elementos com a classe .modal-overlay
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modalObserver.observe(modal, { 
            attributes: true, 
            attributeFilter: ['style'] // S√≥ vigia altera√ß√µes no estilo (display block/none)
        });
    });
});

// --- REFER√äNCIAS AO DOM ---
const notebookContainer = document.querySelector('.notebook-container');
const leftPanelToggleBtn = document.getElementById('left-panel-toggle-btn');
const referencesPanel = document.getElementById('references-panel');
const referencesPanelTitle = document.getElementById('references-panel-title');
const referencesList = document.getElementById('references-list');
const referencesPanelCloseBtn = document.getElementById('references-panel-close-btn');
const leftPanelList = document.getElementById('left-panel-list');
const leftPanelTitle = document.getElementById('left-panel-title');
const middlePanelList = document.getElementById('file-list');
const middlePanelTitle = document.getElementById('middle-panel-title');
const backBtn = document.getElementById('back-btn');
const addItemBtn = document.getElementById('add-item-btn');
const editorPlaceholder = document.getElementById('editor-placeholder');
const editorArea = document.getElementById('editor-area');
const noteTitleInput = document.getElementById('note-title-input');
const newItemNameInput = document.getElementById('new-item-name');
const editorToolbar = document.getElementById('editor-toolbar');
const noteContentEditor = document.getElementById('note-content-editor');
const selectionPopup = document.getElementById('selection-popup');
const tagSuggestionPopup = document.getElementById('tag-suggestion-popup');
const tagSuggestionList = document.getElementById('tag-suggestion-list');
const saveStatusIndicator = document.getElementById('save-status-indicator');
const connectivityStatus = document.getElementById('connectivity-status');
const entitySuggestionPopup = document.getElementById('entity-suggestion-popup');
const entitySuggestionList = document.getElementById('entity-suggestion-list');
const noteSharePopup = document.getElementById('note-share-popup');
const noteShareToggle = document.getElementById('note-share-toggle');
const noteShareLinkContainer = document.getElementById('note-share-link-container');
const noteShareUrlInput = document.getElementById('note-share-url');
const copyNoteLinkBtn = document.getElementById('copy-note-link-btn');
const mobileBackBtn = document.getElementById('mobile-back-btn');
const debouncedScanAndLink = debounce(scanAndLinkEntities, 2000);
const MESES_LISTA = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
const ENTITY_CONFIG = {
    personagem: { collection: 'personagens', displayName: 'Personagens' },
    local: { collection: 'locais', displayName: 'Locais' },
    data: { collection: 'datas', displayName: 'Datas' },
    textobiblico: { collection: 'textosbiblicos', displayName: 'Textos B√≠blicos' },
    marcadores: { collection: 'marcadores', displayName: 'Marcadores' },
    cosmos: { collection: 'cosmos', displayName: 'Cosmos' },
    subcosmos: { collection: 'subcosmos', displayName: 'Sub-Cosmos' }
};

// 10 Cores diferentes das padr√£o (Azul/Verde/Laranja)
const DEFAULT_HIGHLIGHTS = [
    { code: "#8B0037", name: "Vermelho Coral" },    // Vermelho avermelhado
    { code: "#A05930", name: "Laranja Sol" },       // Laranja bem distinto
    { code: "#BAA81B", name: "Amarelo Intenso" },   // Amarelo "Post-it" forte
    { code: "#415329", name: "Verde Lima" },        // Verde amarelado
    { code: "#007B69", name: "Verde Esmeralda" },   // Verde menta forte
    { code: "#006967", name: "Turquesa" },          // Ciano vibrante
    { code: "#221B6C", name: "Roxo Lavanda" },      // Roxo el√©trico claro
    { code: "#7C1851", name: "Rosa Choque" },       // Rosa forte
    { code: "#4C5B67", name: "Cinza Met√°lico" }     // Neutro
];
const EXPLORER_RESULTS_PER_PAGE = 15;
const MICA_COLORS = [
    { name: 'Laranja', hex: '#e67e22' }, { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' }, { name: 'Verde', hex: '#2ecc71' },
    { name: 'Roxo', hex: '#9b59b6' }, { name: 'Rosa', hex: '#e91e63' },
    { name: 'Vermelho', hex: '#e74c3c' }, { name: 'Castanho', hex: '#795548' },
    { name: 'Cinza', hex: '#95a5a6' }
];
const CITATIONS_PER_PAGE = 10; // Limite por p√°gina
const DEFAULT_FILTERS = {
    all: false,
    notes: true,
    superfolders: false,
    archives: false,
    subnote: true,
    question: true,
    free: true,
    postit: true,
    topics: false,
    subtopics: false,
    highlights: false,
    bookmarks: false,
    personagem: false,
    local: false,
    data: false,
    cosmos: false,
    subcosmos: false,
    tags: false,
    fourthColumn: false
};



// --- ESTADO DA APLICA√á√ÉO ---
  let currentUserData = null;
let allEntities = {};
let sessionUnlockedFolders = new Set(); 
let navigationStack = [];
let selectedNoteId = null;
let unsubscribeLeftPanel = null;
let unsubscribeMiddlePanel = null;
let saveTimeout = null;
let activeItemContext = null;
let currentSelectionRange = null;
let allTags = [];
let isTagPopupOpen = false;
let currentTagQueryRange = null;
let currentSaveStatus = 'hidden';
let isEntityPopupOpen = false;
let currentEntityQueryRange = null;
let activeReferenceEntity = { id: null, type: null, name: null };
let currentTab = 'note';
let SUPERFOLDER_ID = null;
let currentSuperfolderParentId = null;
let currentSuperfolderParentName = "Raiz Global";
let currentNoteTopics = {}; // Estado local dos t√≥picos da nota: { topicId: [subId1, subId2] }
let activeTopicIdForSelection = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Sele√ß√£o)
let activeTopicIdForManagement = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Gest√£o)
let currentViewMode = 'local'; // 'local' ou 'shared'
let systemSharedFolderId = null; // Vai guardar o ID da pasta "Partilhadas"
let isClosingNote = false;
let currentShortcutId = null;
let topicTargetId = null; 
let currentSuperfolderName = "";
let appSettings = {
    searchTagsInProtected: false,
    searchTopicsInProtected: false,
    searchAnchorsInProtected: false,
    searchGlobalInSuperfolder: false,
    showFullTitles: false // Nova defini√ß√£o
};
let currentBookmarkSort = 'texto'; // Op√ß√µes: 'texto', 'categoria', 'descricao'
let savedRange = null;
let activeMiniNoteElement = null;
let activeWrapperForColor = null; // Qual caixa estamos a editar
let userCustomHighlights = {}; // Cache dos nomes personalizados
let aggregationStack = []; // Para navegar nas pastas dentro do modal
let aggregationSelectedItems = []; // Guarda o HTML das caixas selecionadas
let aggregationTargetName = ""; // Nome da nova nota a criar
let aggregationParentId = null; // Onde a nova nota ser√° criada
let htmlToAppend = ""; // Guarda o conte√∫do da caixa que vamos copiar
let appendStack = [];  // Hist√≥rico de navega√ß√£o do modal
let currentNoteShareData = null;
let moveStack = []; // Hist√≥rico de navega√ß√£o (como no Append/Aggregation)
let itemToMoveRef = null; // Guarda o objeto do item que estamos a mover
let selectedDestFolderId = null; // Guarda o ID da pasta destino selecionada
let globalExplorerResults = []; // Guarda todos os resultados (Pastas + Notas)
let lastContentEditTime = 0;
let currentExplorerPage = 0;
let moveFolderLastDoc = null;
let currentArchiveId = null;
let currentArchiveData = null;
let activeEditingPostId = null; // ID do post que est√° aberto para edi√ß√£o
let archiveAutoSaveTimer = null;
let collabUnsubscribe = null; // Para parar de ouvir quando sair
let presenceInterval = null;  // Para o "heartbeat"
let currentLocks = {};        // Cache local dos bloqueios
let unsubscribeShared1 = null;
let unsubscribeShared2 = null;
let currentArchiveTab = 'prateleira';
let postToAssignDrawer = null; // Guarda o ID do post que vai para o gavet√£o
let colorHexBeingRenamed = null;
let isPanelEditMode = false;
let allFoundReferenceBoxes = [];
let currentReferencePageIndex = 0;
let noteStackMemory = [];
let listsStackMemory = [];
let currentlyOpenVerseName = null;
let isDossieEditMode = false;
let activeMicaId = null; 
let allCitationsResults = []; // Guarda todos os resultados encontrados
let currentCitationsPageIndex = 0; // Controla a p√°gina atual
let col1SelectedId = null;
let selectedCosmosEmoji = "üíº"; // Antes era ü™ê
let tempEditEmoji = "üíº";
let currentDossieVersion = 0;
let globalSearchScope = 'paragraph'; 
let activeGavetaId = null; // Controla se estamos visualizando uma gaveta espec√≠fica
let activeGavetaData = null;


// Fun√ß√£o: Grava√ß√£o Silenciosa (Mant√©m o editor aberto)
// Usada pelo temporizador de 3 minutos e pelo clique no status
async function saveCurrentPostInBackground() {
    if (!activeEditingPostId) return;

    const postDiv = document.getElementById(`post-${activeEditingPostId}`);
    if (!postDiv) return;

    const statusEl = document.getElementById('archive-save-status');
    statusEl.textContent = "A guardar auto...";

    // 1. Capturar Dados do DOM
    const titleInput = postDiv.querySelector('.post-title-input');
    const contentEditor = postDiv.querySelector('.post-editor-content');

    if (titleInput && contentEditor) {
        const postIndex = currentArchiveData.posts.findIndex(p => p.id === activeEditingPostId);
        if (postIndex > -1) {
            
            // L√≥gica de T√≠tulo (Igual ao Save normal)
            let finalTitle = titleInput.value.trim();
            if (!finalTitle) finalTitle = "Sem T√≠tulo";

            // Sincroniza HTML interno (Entidades)
            const internalInput = contentEditor.querySelector('.mini-note-title-input');
            if (internalInput) internalInput.setAttribute('value', finalTitle);
            
            const internalH2 = contentEditor.querySelector('summary h2');
            if (internalH2) internalH2.textContent = finalTitle;

            // Atualiza Mem√≥ria
            currentArchiveData.posts[postIndex].title = finalTitle;
            currentArchiveData.posts[postIndex].content = contentEditor.innerHTML;
            currentArchiveData.posts[postIndex].updatedAt = Date.now();
        }
    }

    // 2. Gravar na BD (Sem fechar o editor)
    await saveFullArchive();
    
    // Reset do Status Visual
    statusEl.textContent = "Guardado";
    setTimeout(() => {
        if(statusEl.textContent === "Guardado") statusEl.textContent = "Guardado";
    }, 2000);
}



// Carrega do localStorage ou usa o padr√£o
window.searchFilters = JSON.parse(localStorage.getItem('jwn_search_filters')) || DEFAULT_FILTERS;

window.updateSearchFilter = function(property, value) {
    window.searchFilters[property] = value;
    
    // Se desativar qualquer um, o "Todos" deixa de estar ativo
    if (!value) {
        window.searchFilters.all = false;
        const allCb = document.getElementById('f-all');
        if (allCb) allCb.checked = false;
    }
    
    // Grava no navegador para n√£o perder ao fechar
    localStorage.setItem('jwn_search_filters', JSON.stringify(window.searchFilters));
};

window.toggleAllFilters = function(checked) {
    window.searchFilters.all = checked;
    Object.keys(window.searchFilters).forEach(key => {
        window.searchFilters[key] = checked;
        const el = document.getElementById(`f-${key}`);
        if (el) el.checked = checked;
    });
    localStorage.setItem('jwn_search_filters', JSON.stringify(window.searchFilters));
};


// --- NOVA FUN√á√ÉO: Reconstruir caminho para uma Pasta ---
async function reconstructFolderNavigation(targetFolderId, targetNoteId = null) {
    let currentId = targetFolderId;
    const path = [];
    let safety = 0;

    // Sobe na √°rvore geneal√≥gica at√© encontrar a raiz
    while (currentId && safety < 20) {
        const docSnap = await getDoc(doc(db, 'pastas', currentId));
        
        if (!docSnap.exists()) break;
        
        const data = docSnap.data();
        
        // Adiciona ao IN√çCIO do array
        path.unshift({ id: docSnap.id, name: data.nome });
        
        currentId = data.parentId; 
        safety++;
    }

    // Define o hist√≥rico de navega√ß√£o
    navigationStack = path;
    
    // AQUI EST√Å A CORRE√á√ÉO:
    // Passamos o targetNoteId (o ID da nota nova) para a fun√ß√£o que desenha a lista.
    // Assim a lista j√° nasce com a nota pintada de azul.
    updateNavigationView(false, targetNoteId);
}

// --- PROTE√á√ÉO DE ROTA E CARREGAMENTO DE USU√ÅRIO ---
 onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('app-loader');
    const container = document.querySelector('.notebook-container');

    if (!user) {
        // üõ°Ô∏è SEGURO: Se n√£o h√° login, salta para fora. 
        // Como o container est√° com "display: none", o interior nunca √© visto.
        window.location.href = "index.html";
        return; 
    } else {
        console.log("üîê Login confirmado. A preparar dados...");

        // --- TODA A TUA L√ìGICA DE CARREGAMENTO (Par√¢metros, Perfil, Pastas) ---
        const params = new URLSearchParams(window.location.search);
        const urlRootId = params.get('rootId');
        const openFolderId = params.get('openFolder'); 
        const targetNoteId = params.get('noteId');
        const redirectSearch = params.get('search');
        const viewParam = params.get('view');
        const openArchiveId = params.get('openArchive'); 
        const modeParam = params.get('mode');           

        SUPERFOLDER_ID = urlRootId || null; 
        if (viewParam === 'shared' || modeParam === 'collab') currentViewMode = 'shared';

        try {
            // Carregar Perfil e Configura√ß√µes
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) currentUserData = userDoc.data();
            
            const configRef = doc(db, "configuracoes", user.uid);
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) appSettings = { ...appSettings, ...configSnap.data() };

            // Inicializar a navega√ß√£o (Pastas/Arquivos)
            if (openFolderId) {
                await reconstructFolderNavigation(openFolderId, targetNoteId);
            } else if (SUPERFOLDER_ID) {
                const rootSnap = await getDoc(doc(db, 'pastas', SUPERFOLDER_ID));
                if (rootSnap.exists()) {
                    currentSuperfolderName = rootSnap.data().nome;
                    updateNavigationView(false, targetNoteId);
                }
            } else {
                updateNavigationView(false, targetNoteId); 
            }

            if (targetNoteId) displayNote(targetNoteId, null, redirectSearch);
            if (openArchiveId) {
                const arcSnap = await getDoc(doc(db, 'pastas', openArchiveId));
                if (arcSnap.exists()) displayArchive(openArchiveId, arcSnap.data());
            }

            // Iniciar caches de fundo
            fetchAllEntities();
            fetchAllTags();
            loadUserHighlights();

        } catch (e) { console.error(e); }

        // ============================================================
        // üöÄ O MOMENTO DA REVELA√á√ÉO (S√≥ ap√≥s os dados estarem prontos)
        // ============================================================
        
        // 1. Esperamos um pequeno f√¥lego para o navegador processar o HTML das listas
        setTimeout(() => {
            if (container) {
                // Remove o "display: none" e mostra a interface
                container.style.setProperty('display', 'flex', 'important');
            }
            
            if (loader) {
                // Efeito suave de sa√≠da do loader
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.remove();
                }, 500);
            }
        }, 800); // 800ms √© o tempo perfeito para evitar qualquer "pulo" visual
    }
});


// --- FUN√á√ÉO PARA SALVAR CONFIGURA√á√ïES ---
async function saveUserSettings() {
    if (!auth.currentUser) return;
    
    // 1. Atualiza a vari√°vel global de imediato
    appSettings.showFullTitles = document.getElementById('setting-full-titles').checked;
    appSettings.searchTagsInProtected = document.getElementById('setting-search-tags').checked;
    appSettings.searchTopicsInProtected = document.getElementById('setting-search-topics').checked;
    appSettings.searchAnchorsInProtected = document.getElementById('setting-search-anchors').checked;

    // 2. Tenta aplicar o efeito agora (se houver nota aberta)
    applyTitleWrappingEffect();

    // 3. Salva no Firebase para persist√™ncia
    try {
        const configRef = doc(db, 'configuracoes', auth.currentUser.uid);
        await setDoc(configRef, appSettings, { merge: true });
    } catch (e) {
        console.error("Erro ao salvar:", e);
    }
}

// Adicione os listeners aos checkboxes
document.getElementById('setting-search-tags').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-topics').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-anchors').addEventListener('change', saveUserSettings);
document.getElementById('setting-full-titles').addEventListener('change', saveUserSettings);

const globalSearchToggle = document.getElementById('setting-global-search-superfolder');
if (globalSearchToggle) {
    globalSearchToggle.addEventListener('change', saveUserSettings);
}



// --- GEST√ÉO DE ESTADO E CONECTIVIDADE ---

function updateSaveStatus(status) {
    currentSaveStatus = status;
    if (!saveStatusIndicator) return;

    saveStatusIndicator.classList.remove('status-saved', 'status-error');
    switch (status) {
        case 'unsaved':
            saveStatusIndicator.textContent = 'por guardar...';
            break;
        case 'saving':
            saveStatusIndicator.textContent = 'A guardar...';
            break;
        case 'saved':
            saveStatusIndicator.textContent = 'Guardado';
            saveStatusIndicator.classList.add('status-saved');
            break;
        case 'error':
            saveStatusIndicator.textContent = 'Erro ao guardar';
            saveStatusIndicator.classList.add('status-error');
            break;
        case 'hidden':
        default:
            saveStatusIndicator.textContent = '';
            break;
    }
}

function handleOffline() {
    connectivityStatus.textContent = 'Sem liga√ß√£o';
    connectivityStatus.classList.add('visible');
    updateSaveStatus('error'); 
    saveStatusIndicator.textContent = 'Offline - Altera√ß√µes n√£o guardadas';
}

function handleOnline() {
    connectivityStatus.classList.remove('visible');
    updateSaveStatus('saving');
    clearTimeout(saveTimeout);
    saveNote();
}

function checkInitialConnection() {
    if (!navigator.onLine) {
        handleOffline();
         leaveArchivePresence();
    }
}

/**
 * Verifica se existem altera√ß√µes n√£o guardadas antes de executar uma a√ß√£o de navega√ß√£o.
 * @param {function} navigationAction A fun√ß√£o a ser executada se a navega√ß√£o for confirmada.
 */
async function navigateWithUnsavedCheck(navigationAction) {
    // Verifica se h√° algo por guardar
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        const savingModal = document.getElementById('forcing-save-modal');
        
        if (savingModal) {
            console.log("‚è≥ Mostrando painel de grava√ß√£o for√ßada...");
            // MOVE PARA O TOPO E FOR√áA VISIBILIDADE
            document.body.appendChild(savingModal);
            savingModal.style.setProperty('display', 'flex', 'important');
            savingModal.style.zIndex = "9999999"; // O n√≠vel mais alto
            savingModal.style.opacity = "1";
            savingModal.style.visibility = "visible";
        }

        try {
            // Executa a grava√ß√£o e ESPERA (await) que o Firebase confirme
            await saveNote(true); 

            // Esconde o painel ap√≥s o sucesso
            if (savingModal) savingModal.style.display = 'none';
            
            // Segue com a navega√ß√£o que o utilizador queria fazer
            navigationAction();

        } catch (error) {
            console.error("‚ùå Erro na grava√ß√£o for√ßada:", error);
            if (savingModal) savingModal.style.display = 'none';
            alert("N√£o foi poss√≠vel guardar as altera√ß√µes. Verifique a sua liga√ß√£o.");
        }
    } else {
        // Se j√° estava tudo guardado, apenas navega
        navigationAction();
    }
}

// --- 1. FUN√á√ïES DE ABERTURA E RENDERIZA√á√ÉO (MODAL SELE√á√ÉO) ---

async function openTopicsModal(targetId, type) {
    if (!targetId) return alert("Erro: Nenhum item selecionado.");

    console.log(`üöÄ Abrindo t√≥picos para ${type}: ${targetId}`);
    
    // 1. CONFIGURA√á√ÉO DE ESTADO
    topicTargetId = targetId; // ID da Nota Principal
    activeMiniNoteElement = null; // Garante que N√ÉO estamos em modo "caixa"

    const modal = document.getElementById('topics-modal');
    if (!modal) return console.error("Modal #topics-modal n√£o encontrado!");

    // 2. MOVE PARA O BODY E DEFINE Z-INDEX ALTO
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000"; // No mesmo n√≠vel do Hist√≥rico
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 3. ATUALIZA T√çTULO DO MODAL
    const modalTitle = modal.querySelector('h3');
    if (modalTitle) {
        const typeName = type === 'pasta' ? 'Pasta' : 'Nota';
        modalTitle.textContent = `T√≥picos da ${typeName}`;
    }

    // 4. CARREGAR DADOS ATUAIS DA NOTA
    try {
        const docSnap = await getDoc(doc(db, 'pastas', targetId));
        if (docSnap.exists()) {
            currentNoteTopics = docSnap.data().topicosSelecionados || {}; 
        } else {
            currentNoteTopics = {};
        }

        // Reset visual e carregamento da lista
        activeTopicIdForSelection = null;
        document.getElementById('subtopics-list-select').innerHTML = 
            '<li style="color: #888; font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>';
        
        await renderTopicsSelectionList();

    } catch (e) {
        console.error("Erro ao carregar t√≥picos da nota:", e);
    }
}

async function renderTopicsSelectionList() {
    const list = document.getElementById('topics-list-select');
    if (!list) return;

    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    try {
        console.log("üì° [FIREBASE] Buscando t√≥picos...");
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        if (snapshot.empty) {
            console.log("‚ÑπÔ∏è [FIREBASE] Nenhum t√≥pico encontrado.");
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum t√≥pico criado.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            const topic = { id: docSnap.id, ...docSnap.data() };
            const li = document.createElement('li');
            
            // Verifica se este t√≥pico (ou subt√≥picos dele) j√° est√£o no data-topics da caixa
            const isSelected = !!currentNoteTopics[topic.id];
            
            li.innerHTML = `
                <input type="checkbox" class="topic-checkbox" ${isSelected ? 'checked' : ''}>
                <span>${topic.nome}</span>
            `;

            li.onclick = () => {
                activeTopicIdForSelection = topic.id;
                document.querySelectorAll('#topics-list-select li').forEach(el => el.classList.remove('active-topic'));
                li.classList.add('active-topic');
                renderSubtopicsSelectionList(topic.id, topic.nome);
            };

            const cb = li.querySelector('.topic-checkbox');
            cb.onclick = (e) => {
                e.stopPropagation();
                toggleTopicSelection(topic.id, cb.checked);
            };

            list.appendChild(li);
        });
        console.log("üé® [UI] Lista de t√≥picos renderizada.");

    } catch (error) {
        console.error("‚ùå [ERRO] Falha ao renderizar lista de t√≥picos:", error);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar.</li>';
    }
}

async function renderSubtopicsSelectionList(topicId, topicName) {
    const list = document.getElementById('subtopics-list-select');
    const title = document.getElementById('subtopics-title-select');
    
    title.textContent = `Subt√≥picos de "${topicName}"`;
    list.innerHTML = '<li>A carregar...</li>';

    const q = query( collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome') );
    const snapshot = await getDocs(q);

    list.innerHTML = '';

    if (snapshot.empty) {
        list.innerHTML = '<li style="font-style:italic; color: #888;">Nenhum subt√≥pico dispon√≠vel.</li>';
        return;
    }

    // Obt√©m os subt√≥picos j√° selecionados para este t√≥pico espec√≠fico
    const selectedSubtopics = currentNoteTopics[topicId] || [];

    snapshot.forEach(doc => {
        const sub = { id: doc.id, ...doc.data() };
        const isSelected = selectedSubtopics.includes(sub.id);

        const li = document.createElement('li');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'topic-checkbox';
        checkbox.checked = isSelected;
        
        checkbox.onclick = (e) => {
            e.stopPropagation();
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };
        
        // Clicar na linha tamb√©m seleciona
        li.onclick = () => {
            checkbox.checked = !checkbox.checked;
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };

        const span = document.createElement('span');
        span.textContent = sub.nome;

        li.appendChild(checkbox);
        li.appendChild(span);
        list.appendChild(li);
    });
}

// --- 2. L√ìGICA DE SELE√á√ÉO (ESTADO LOCAL) ---

function toggleTopicSelection(topicId, isChecked) {
    if (isChecked) {
        // Se n√£o existia, cria entrada (array vazio de subt√≥picos)
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
        }
    } else {
        // Se desmarcar o t√≥pico, removemos tudo (incluindo subt√≥picos)
        delete currentNoteTopics[topicId];
        // Se este era o t√≥pico ativo na direita, atualiza a UI da direita
        if (activeTopicIdForSelection === topicId) {
             const subInputs = document.querySelectorAll('#subtopics-list-select input');
             subInputs.forEach(input => input.checked = false);
        }
    }
}

function toggleSubtopicSelection(topicId, subtopicId, isChecked) {
    // Se selecionar um subt√≥pico, garantimos que o pai est√° selecionado
    if (isChecked) {
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
            // Atualiza visualmente o checkbox do pai na esquerda
            renderTopicsSelectionList(); // Re-renderiza para atualizar o check
        }
        if (!currentNoteTopics[topicId].includes(subtopicId)) {
            currentNoteTopics[topicId].push(subtopicId);
        }
    } else {
        // Remove o subt√≥pico do array
        if (currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = currentNoteTopics[topicId].filter(id => id !== subtopicId);
        }
    }
}

// 1. EVENTO MOUSEDOWN: Formata√ß√£o (Negrito, It√°lico, Tamanho, Cor Azul)
editorToolbar.addEventListener('mousedown', (e) => {
    const target = e.target.closest('button');
    
    // Se n√£o for bot√£o ou for o input de cor, ignoramos aqui (deixa o navegador tratar)
    if (!target || target.tagName === 'INPUT') return;

    // Se o bot√£o tiver um comando de formata√ß√£o (data-command)
    if (target.dataset.command) {
        // A. IMPORTANTE: Previne que o bot√£o roube o foco do editor
        e.preventDefault();

        const command = target.dataset.command;

        // B. Executa o comando
        if (command.includes('FontSize')) {
            // L√≥gica de Tamanho de Fonte
            const currentSize = window.getComputedStyle(noteContentEditor, null).getPropertyValue('font-size');
            let newSize = parseFloat(currentSize) + (command === 'increaseFontSize' ? 1 : -1);
            
            // Truque para mudar tamanho
            document.execCommand("fontSize", false, "7");
            const selection = window.getSelection();
            if (selection.anchorNode && selection.anchorNode.parentNode) {
                let fontElement = selection.anchorNode.parentNode;
                // Sobe at√© encontrar o elemento font, se necess√°rio
                if (fontElement.nodeType === 3) fontElement = fontElement.parentNode;
                
                if (fontElement.tagName === 'FONT') {
                    fontElement.removeAttribute('size');
                    fontElement.style.fontSize = newSize + "px";
                }
            }
        } 
        else if (command === 'boldBlue') {
            document.execCommand('bold', false, null);
            document.execCommand('foreColor', false, '#4a90e2');
        } 
        else {
            // Comandos Normais (Bold, Italic, Underline)
            document.execCommand(command, false, null);
        }

        // C. Gravar altera√ß√µes
        saveNote();
    }
});

// 2. EVENTO INPUT: Apenas para o Seletor de Cores (Color Picker)
editorToolbar.addEventListener('input', (e) => {
    const target = e.target;
    // Se for o input de cor
    if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
        // Tenta restaurar a sele√ß√£o se existir
        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);
        }
        document.execCommand('foreColor', false, target.value);
        saveNote(); 
    }
});



// ------------------------------------------------------------------
// L√ìGICA DE MARCADORES (BOOKMARKS)
// ------------------------------------------------------------------

// 1. Abrir o Modal Principal de Marcadores
async function openBookmarksModal() {
    console.log("üöÄ [IN√çCIO] openBookmarksModal acionado.");
    
    const modal = document.getElementById('bookmarks-modal');
    const list = document.getElementById('bookmarks-list');
    
    if (!modal || !list) {
        console.error("‚ùå [ERRO] Elementos do modal n√£o encontrados no DOM.");
        return;
    }

    // 1. FOR√áAR EXIBI√á√ÉO IMEDIATA (Para sabermos que o JS chegou aqui)
    document.body.appendChild(modal); // Move para a raiz para evitar ser tapado
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
    modal.style.opacity = "1";
    modal.style.visibility = "visible";

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar marcadores...</span></div>';

    if (!activeReferenceEntity || activeReferenceEntity.type !== 'textobiblico') {
        console.warn("‚ö†Ô∏è Entidade ativa n√£o √© texto b√≠blico ou est√° vazia.", activeReferenceEntity);
        list.innerHTML = '<li style="padding:20px; color:orange;">Selecione um vers√≠culo b√≠blico primeiro.</li>';
        return;
    }

    try {
        const nameToFind = activeReferenceEntity.name;
        const myUid = auth.currentUser.uid;
        console.log("üì° [FIREBASE] Iniciando busca para:", nameToFind, "UID:", myUid);

        // A. Buscar se o texto j√° existe no DB do usu√°rio
        const qTexto = query(
            collection(db, 'textosbiblicos'), 
            where('nome', '==', nameToFind),
            where('userId', '==', myUid)
        );
        
        const textoSnap = await getDocs(qTexto);
        let marcadoresAssociados = {};
        
        if (!textoSnap.empty) {
            console.log("‚úÖ Texto b√≠blico encontrado no DB.");
            const data = textoSnap.docs[0].data();
            marcadoresAssociados = data.marcadoresAssociados || {};
            activeReferenceEntity.id = textoSnap.docs[0].id;
        } else {
            console.log("‚ÑπÔ∏è Texto b√≠blico novo (ainda n√£o est√° no DB).");
        }

        // B. Buscar lista global de Marcadores do usu√°rio
        console.log("üì° [FIREBASE] Buscando lista de g√™neros de marcadores...");
        const qMarcadores = query(
            collection(db, 'marcadores'), 
            where('userId', '==', myUid), 
            orderBy('nome')
        );
        
        const marcadoresSnap = await getDocs(qMarcadores);
        console.log("üìä Total de marcadores encontrados:", marcadoresSnap.size);

        list.innerHTML = '';

        if (marcadoresSnap.empty) {
            list.innerHTML = `
                <li style="padding: 20px; text-align: center; color: #888;">
                    Nenhum marcador criado.<br>
                    <button class="modal-btn primary" style="margin-top:10px;" onclick="document.getElementById('open-create-bookmark-btn').click()">+ Criar Novo Marcador</button>
                </li>`;
            return;
        }

        marcadoresSnap.forEach(docSnap => {
            const marcador = { id: docSnap.id, ...docSnap.data() };
            const isChecked = !!marcadoresAssociados[marcador.id]; 

            const li = document.createElement('li');
            li.className = `bookmark-item ${isChecked ? 'active' : ''}`;
            li.innerHTML = `
                <div class="bookmark-info">
                    <span class="bookmark-title">${marcador.nome}</span>
                    <span class="bookmark-desc">${marcador.descricao || ''}</span>
                </div>
                <div class="bookmark-check"></div>
            `;

            li.onclick = () => toggleBookmark(marcador.id, !li.classList.contains('active'), li);
            list.appendChild(li);
        });

    } catch (error) {
        console.error("‚ùå [ERRO CR√çTICO] Falha no openBookmarksModal:", error);
        list.innerHTML = `<li style="color:red; padding:20px;">
            <strong>Erro ao carregar:</strong><br>
            ${error.message}<br><br>
            <small>Verifique se os √≠ndices do Firestore foram criados.</small>
        </li>`;
    }
}

async function toggleBookmark(marcadorId, shouldAdd, liElement) {
    if (!activeReferenceEntity.id) return;

    const textoRef = doc(db, 'textosbiblicos', activeReferenceEntity.id);

    if (shouldAdd) liElement.classList.add('active');
    else liElement.classList.remove('active');

    liElement.onclick = () => toggleBookmark(marcadorId, !shouldAdd, liElement);

    // Atualizar T√≠tulo em Tempo Real
    const activeCount = document.querySelectorAll('#bookmarks-list .bookmark-item.active').length;
    const titleElement = document.getElementById('references-panel-title');
    const entityName = activeReferenceEntity.name;

    if (activeCount > 0) {
        titleElement.textContent = `Refer√™ncias para üîñ"${entityName}"`;
    } else {
        titleElement.textContent = `Refer√™ncias para "${entityName}"`;
    }

    try {
        if (shouldAdd) {
            await updateDoc(textoRef, { [`marcadoresAssociados.${marcadorId}`]: true });
        } else {
            await updateDoc(textoRef, { [`marcadoresAssociados.${marcadorId}`]: deleteField() });
        }
    } catch (error) {
        console.error("Erro ao atualizar marcador:", error);
        alert("Erro ao guardar. A reverter...");
        if (shouldAdd) liElement.classList.remove('active');
        else liElement.classList.add('active');
    }
}

// --- FUN√á√ÉO UTILIT√ÅRIA PARA O PROMPT PERSONALIZADO ---
function showCustomInput(title, namePlaceholder = "") {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-input-modal');
        const titleEl = document.getElementById('custom-input-title');
        const nameInput = document.getElementById('custom-input-name');
        const descInput = document.getElementById('custom-input-desc');
        const confirmBtn = document.getElementById('custom-input-confirm');
        const cancelBtn = document.getElementById('custom-input-cancel');

        if (!modal) return console.error("Modal custom-input-modal n√£o encontrado!");

        // 1. MOVE PARA O TOPO ABSOLUTO
      document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "9000000";

        // 2. CONFIGURA INTERFACE
        titleEl.textContent = title;
        nameInput.value = '';
        nameInput.placeholder = namePlaceholder;
        descInput.value = '';
        
        setTimeout(() => nameInput.focus(), 100);

        const cleanup = () => {
            modal.style.display = 'none';
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
        };

        confirmBtn.onclick = () => {
            const nameVal = nameInput.value.trim();
            const descVal = descInput.value.trim();
            if (!nameVal) return alert("O nome √© obrigat√≥rio.");
            cleanup();
            resolve({ name: nameVal, description: descVal }); 
        };

        cancelBtn.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
}



// ============================================================
// L√ìGICA DO MODAL DE GEST√ÉO (CRIAR T√ìPICOS)
// ============================================================

// A. LISTENER DE CLIQUE NO BOT√ÉO üìã
noteContentEditor.addEventListener('click', (e) => {
    console.log("üñ±Ô∏è Clique detetado no editor. Alvo:", e.target);

    const topicBtn = e.target.closest('button[data-action="manage-mini-note-topics"]');
    
    if (topicBtn) {
        console.log("‚úÖ Bot√£o üìã identificado com sucesso!");
        e.preventDefault(); 
        e.stopPropagation();
        
        const wrapper = topicBtn.closest('.mini-note-wrapper');
        if (wrapper) {
            console.log("üì¶ Pai .mini-note-wrapper encontrado (ID:", wrapper.id, ")");
            openTopicsModalForMiniNote(wrapper);
        } else {
            console.error("‚ùå ERRO: Clique no bot√£o üìã mas n√£o encontrei o pai .mini-note-wrapper.");
        }
    } else {
        console.log("‚ÑπÔ∏è Clique n√£o foi no bot√£o de t√≥picos.");
    }
});

// OUVINTE PARA O FEED DO ARQUIVO (Caso use t√≥picos l√° tamb√©m)
const archiveFeedEl = document.getElementById('archive-feed');
if (archiveFeedEl) {
    archiveFeedEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="manage-mini-note-topics"]');
        if (btn) {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openTopicsModalForMiniNote(wrapper);
        }
    });
}

// B. FUN√á√ÉO PARA ABRIR O MODAL (Modo SubNota)
async function openTopicsModalForMiniNote(wrapperElement) {
    console.log("üöÄ [DEBUG] Iniciando abertura de t√≥picos para caixa...");

    if (!wrapperElement) {
        console.error("‚ùå [ERRO] wrapperElement nulo.");
        return;
    }

    // 1. Configura√ß√£o de Estado
    activeMiniNoteElement = wrapperElement; 
    topicTargetId = null; 

    // 2. Leitura dos Dados
    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    console.log("üìä [DEBUG] Dados lidos:", topicsString);

    try {
        currentNoteTopics = JSON.parse(topicsString);
    } catch (e) {
        console.warn("‚ö†Ô∏è [AVISO] JSON de t√≥picos inv√°lido, resetando.");
        currentNoteTopics = {};
    }

    // 3. CAPTURA E MOVIMENTA√á√ÉO DO MODAL (Corre√ß√£o de Visibilidade)
    const modal = document.getElementById('topics-modal');
    if (!modal) {
        console.error("‚ùå [ERRO] Modal #topics-modal n√£o encontrado no HTML!");
        return;
    }

    // Move o modal para a raiz do body para garantir que nenhum 'overflow:hidden' o tape
    document.body.appendChild(modal);

    // 4. Configura√ß√£o Visual
    const modalTitle = modal.querySelector('h3');
    if (modalTitle) {
        const isQuestion = wrapperElement.classList.contains('question-mode');
        modalTitle.textContent = isQuestion ? "T√≥picos da Quest√£o" : "T√≥picos da SubNota";
    }

    // Reset de busca e sele√ß√£o anterior
    activeTopicIdForSelection = null;
    const subList = document.getElementById('subtopics-list-select');
    if(subList) subList.innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico √† esquerda.</li>';

    // 5. FOR√áAR EXIBI√á√ÉO
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "999999"; // Valor extremo para ficar √† frente de tudo
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    console.log("‚ú® [DEBUG] Modal disparado com sucesso!");

    // 6. Carregar a Lista
    await renderTopicsSelectionList();
    console.log("‚úÖ [DEBUG] renderTopicsSelectionList finalizado.");
}

// --- FUN√á√ÉO UNIFICADA E √öNICA PARA O BOT√ÉO GRAVAR T√ìPICOS ---
document.getElementById('save-topics-btn').onclick = async () => {
    const btn = document.getElementById('save-topics-btn');
    
    // 1. Bloqueia o bot√£o para evitar cliques duplos
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "A gravar...";

    try {
        // CEN√ÅRIO A: Gravando t√≥picos de uma CAIXA INDIVIDUAL (Quest√£o, Subnota, etc.)
        if (activeMiniNoteElement) {
            console.log("üíæ Gravando t√≥picos na Caixa:", activeMiniNoteElement.id);
            
            // Converte a sele√ß√£o do modal para texto JSON e guarda no atributo da caixa
            const jsonTopics = JSON.stringify(currentNoteTopics);
            activeMiniNoteElement.setAttribute('data-topics', jsonTopics);
            
            // Atualiza a cor azul do √≠cone üìã na caixa
            if (typeof updateMiniNoteButtonState === 'function') {
                updateMiniNoteButtonState(activeMiniNoteElement);
            }

            // Fecha o modal e limpa a refer√™ncia
            document.getElementById('topics-modal').style.display = 'none';
            activeMiniNoteElement = null; 
            
            // Grava a nota principal para persistir as mudan√ßas no Firebase
            await saveNote(true); 
        } 
        // CEN√ÅRIO B: Gravando t√≥picos da NOTA ou PASTA principal
        else if (topicTargetId) {
            console.log("üíæ Gravando t√≥picos na Nota/Pasta:", topicTargetId);
            const itemRef = doc(db, 'pastas', topicTargetId);
            
            await updateDoc(itemRef, {
                topicosSelecionados: currentNoteTopics,
                ultimaedicao: serverTimestamp()
            });

            document.getElementById('topics-modal').style.display = 'none';
            
            // Se for a nota que temos aberta agora, mostra o "Guardado" no topo
            if (topicTargetId === selectedNoteId) updateSaveStatus('saved');
        }
    } catch (error) {
        console.error("‚ùå Erro cr√≠tico ao gravar t√≥picos:", error);
        alert("Erro ao gravar. Verifique a sua liga√ß√£o √† internet.");
    } finally {
        // Restaura o bot√£o
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

document.getElementById('manage-topics-btn').addEventListener('click', () => {
    activeTopicIdForManagement = null;
    document.getElementById('manage-topics-modal').style.display = 'flex';
    renderManageTopicsList();
    document.getElementById('create-new-subtopic-btn').style.display = 'none';
    document.getElementById('subtopics-list-manage').innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico.</li>';
});

document.getElementById('close-manage-topics-btn').addEventListener('click', () => {
    document.getElementById('manage-topics-modal').style.display = 'none';
    // Recarrega a lista de sele√ß√£o principal para mostrar os novos itens
    renderTopicsSelectionList(); 
});

// --- Renderiza√ß√£o Gest√£o ---

async function renderManageTopicsList(filterText = '') {
    const list = document.getElementById('topics-list-manage');
    if (!list) return;

    list.innerHTML = '<li>Carregando...</li>';

    try {
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        snapshot.forEach(docSnap => {
            const topic = { id: docSnap.id, ...docSnap.data() };
            if (filterText && !topic.nome.toLowerCase().includes(filterText.toLowerCase())) return;

            const li = document.createElement('li');
            li.textContent = topic.nome;
            if (topic.id === activeTopicIdForManagement) li.classList.add('active-topic');
            
            li.onclick = () => {
                document.querySelectorAll('#topics-list-manage li').forEach(el => el.classList.remove('active-topic'));
                li.classList.add('active-topic');
                activeTopicIdForManagement = topic.id;
                
                const createSubBtn = document.getElementById('create-new-subtopic-btn');
                if (createSubBtn) {
                    createSubBtn.style.display = 'block';
                    createSubBtn.textContent = `+ Subt√≥pico em "${topic.nome}"`;
                }
                
                renderManageSubtopicsList(topic.id);
            };
            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erro ao carregar gest√£o de t√≥picos:", e);
    }
}

async function renderManageSubtopicsList(topicId) {
    const list = document.getElementById('subtopics-list-manage');
    list.innerHTML = '<li>Carregando...</li>';

    const q = query(collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome'));
    const snapshot = await getDocs(q);

    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
        return;
    }

    snapshot.forEach(doc => {
        const sub = doc.data();
        const li = document.createElement('li');
        li.textContent = sub.nome;
        li.style.cursor = 'default'; // Apenas visualiza√ß√£o na gest√£o
        list.appendChild(li);
    });
}

// --- Pesquisa ---
document.getElementById('search-topic-input').addEventListener('input', (e) => {
    renderManageTopicsList(e.target.value);
});

// --- Cria√ß√£o de Novos Itens ---

document.getElementById('create-new-topic-btn').addEventListener('click', async () => {
    const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina...");
    
    // Verifica se result existe e se tem nome (descri√ß√£o √© opcional)
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'topicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageTopicsList(document.getElementById('search-topic-input').value);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar t√≥pico."); 
        }
    }
});


 document.getElementById('create-new-subtopic-btn').addEventListener('click', async () => {
    if (!activeTopicIdForManagement) return;
    
    const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo...");
    
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'subtopicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                topicId: activeTopicIdForManagement,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageSubtopicsList(activeTopicIdForManagement);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar subt√≥pico."); 
        }
    }
});

// --- LIGAR O BOT√ÉO DA BARRA DE FERRAMENTAS ---


// 2. EVENTO INPUT: Exclusivo para o Seletor de Cores
// O seletor de cores precisa do evento 'input' para funcionar em tempo real
editorToolbar.addEventListener('input', (e) => {
    const target = e.target;
    // Verifica se √© o input de cor da barra
    if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
        document.execCommand('foreColor', false, target.value);
        saveNote(); 
    }
});




/**
 * Remove a refer√™ncia de uma nota a uma entidade de texto b√≠blico.
 * Se for a √∫ltima refer√™ncia, apaga a pr√≥pria entidade.
 * @param {string} entityName O nome da entidade de texto b√≠blico (ex: "Daniel 4:3")
 */
async function cleanupBiblicalEntityReference(entityName) {
    if (!selectedNoteId || !entityName) return;

    const collectionRef = collection(db, 'textosbiblicos');
    const q = query(collectionRef, where("nome", "==", entityName));
    
    try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            return;
        }

        const entityDoc = snapshot.docs[0];
        const entityRef = entityDoc.ref;
        const entityData = entityDoc.data();
        const references = entityData.referencias || {};
        
        // Verifica se a nota atual est√° nas refer√™ncias
        if (references[selectedNoteId]) {
            const numReferences = Object.keys(references).length;

            if (numReferences === 1) {
                // √â a √∫ltima refer√™ncia, apagar o documento inteiro
                await deleteDoc(entityRef);
            } else {
                // Existem outras refer√™ncias, remover apenas a atual

                await updateDoc(entityRef, {
                    [`referencias.${selectedNoteId}`]: deleteField()
                });
            }
            
            // Atualiza o cache de entidades local
            await fetchAllEntities();
        }

    } catch (error) {
        console.error(`Erro ao limpar a refer√™ncia para "${entityName}":`, error);
    }
}

async function fetchAllEntities() {
    if (!auth.currentUser) return;
    allEntities = {}; 
    for (const type in ENTITY_CONFIG) {
        const config = ENTITY_CONFIG[type];
        const collectionName = config.collection;
        try {
            // FILTRO OBRIGAT√ìRIO
            const q = query(
                collection(db, collectionName), 
                where('userId', '==', auth.currentUser.uid)
            );
            
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                allEntities[type] = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    nome: doc.data().nome,
                    tipo: type,
                    descricao: doc.data().descricao // Importante carregar a descri√ß√£o para uso posterior
                }));
            }
        } catch (error) {
            console.error(`Erro ao carregar a cole√ß√£o ${collectionName}:`, error);
        }
    }
}

function resetEditor() {
     leaveArchivePresence(); 
    selectedNoteId = null;
    currentArchiveId = null; // Limpa ID do arquivo
    activeEditingPostId = null; // Limpa edi√ß√£o ativa

     if (document.getElementById('insertion-popup')) document.getElementById('insertion-popup').style.display = 'none';

    editorArea.style.display = 'none';
    document.getElementById('archive-area').style.display = 'none';
    editorPlaceholder.style.display = 'flex';

    // 1. Esconde TODAS as √°reas de conte√∫do
    editorArea.style.display = 'none'; // Editor de Nota
    document.getElementById('archive-area').style.display = 'none'; // Editor de Arquivo

    // 2. Mostra o Placeholder (O √≠cone do livro)
    editorPlaceholder.style.display = 'flex';

    // 3. Limpa sele√ß√£o visual da lista
    document.querySelectorAll('#middle-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('#file-list .list-item.selected').forEach(el => el.classList.remove('selected', 'selected-red'));
    
    updateSaveStatus('hidden');
}

function fetchAndDisplayItems(parentId, listElement, selectedId = null) {
    if (!auth.currentUser) return;

    // Define que tipos de ficheiro mostrar dependendo do modo
    let allowedTypes = currentViewMode === 'local' 
        ? ['pasta', 'nota', 'agregacao', 'arquivo'] 
        : ['pasta', 'nota', 'agregacao', 'arquivo', 'partilhado'];

    const itemsRef = collection(db, 'pastas');
    const q = query(
        itemsRef, 
        where('parentId', '==', parentId), 
        where('estado', '==', 'ativa'), 
        where('userId', '==', auth.currentUser.uid), 
        where('tipo', 'in', allowedTypes), 
        orderBy('ordem')
    );

    return onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        
        // Identifica se estamos a renderizar a Coluna 1 ou a Coluna 2
        const isColumn1 = (listElement.id === 'left-panel-list');

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Atributos base
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo);
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-userid', item.userId);
            li.setAttribute('data-parent-id', item.parentId || "null");
            li.setAttribute('data-protected', (item.passe && item.passe.trim() !== "") ? "true" : "false");
            
            // Atributo de PIN (Novo)
            li.setAttribute('data-pinned', item.isPinned ? "true" : "false");
            
            // Atributos de Superpasta e √çcones personalizados
            li.setAttribute('data-superpasta', item.superpasta || "false");
            if (item.customIcon) {
                li.style.setProperty('--custom-icon', `"${item.customIcon}"`);
            }

            // √çcone de cadeado se tiver senha
            let lockIcon = (item.passe && item.passe.trim() !== "") ? "üîí " : "";
            
            li.innerHTML = `<span>${lockIcon}${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            // ============================================================
            // L√ìGICA DE SELE√á√ÉO VISUAL
            // ============================================================
            let active = false;

            if (isColumn1) {
                // COLUNA 1: Ativa se foi o √∫ltimo clicado ou faz parte do caminho
                if (item.id === col1SelectedId) {
                    active = true;
                } else if (navigationStack.some(nav => nav.id === item.id)) {
                    active = true;
                }
            } else {
                // COLUNA 2: Ativa apenas se for a nota aberta no momento
                if (selectedNoteId && item.id === selectedNoteId) {
                    active = true;
                }
            }

            if (active) {
                if (isColumn1) {
                    li.classList.add('selected'); // Coluna 1 √© sempre azul
                } else {
                    // Coluna 2 segue o tema (Vermelho para Partilha, Azul para Local)
                    const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                    li.classList.add(selectionClass);
                }
            }

            listElement.appendChild(li);
        });
    });
}


async function updateNavigationView(keepEditorOpen = false, targetSelectId = null) {
    // 1. PRIMEIRA COISA: Atualizar a visibilidade dos bot√µes flutuantes
    updateMobileFABVisibility();

    // 2. Remove qualquer estado colapsado ao navegar
    notebookContainer.classList.remove('left-panel-collapsed');

    // 1. Limpeza de Ouvintes (Listeners) ativos para evitar fugas de mem√≥ria
    if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    // 2. Reset do Editor se n√£o for solicitado manter aberto
    if (!keepEditorOpen) {
        resetEditor();
    }

    const depth = navigationStack.length;
    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // ============================================================
    // CASO A: ABA DE LISTAS (T√≥picos, B√≠blia, Personagens, etc)
    // ============================================================
    if (currentTab === 'lists') {
        const activeCategory = navigationStack.length > 0 ? navigationStack[0].id : null;

        // Gerar categorias dinamicamente
        const categories = [
            { id: 'topico', icon: 'üìë', name: 'T√≥picos' },
            { id: 'destaque', icon: 'üé®', name: 'Destaques' },
            { separator: true },
            { id: 'biblia-root', icon: 'üìñ', name: 'B√≠blia' },
            { id: 'textobiblico', icon: 'üìú', name: 'Textos B√≠blicos' },
            { id: 'marcadores', icon: 'üîñ', name: 'Marcadores' },
            { separator: true },
            { id: 'personagem', icon: 'üë§', name: 'Personagens' },
            { id: 'local', icon: 'üìç', name: 'Locais' },
            { id: 'data', icon: 'üìÖ', name: 'Datas' },
            { id: 'cosmos', icon: 'ü™ê', name: 'Cosmos' },
            { id: 'tag', icon: 'üè∑Ô∏è', name: 'Tags' }
        ];

        let categoriesHTML = '';
        categories.forEach(cat => {
            if (cat.separator) {
                categoriesHTML += `<hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 5px; opacity: 0.3;">`;
            } else {
                const isSelected = activeCategory === cat.id ? 'selected' : '';
                categoriesHTML += `<li class="list-item ${isSelected}" data-type="list-category" data-id="${cat.id}">${cat.icon} ${cat.name}</li>`;
            }
        });

        leftPanelList.innerHTML = categoriesHTML;

        if (depth === 0) {
            addItemBtn.style.display = 'none';
            setLeftPanelTitle('Categorias'); 
            middlePanelTitle.textContent = 'Selecione uma categoria';
            middlePanelList.innerHTML = '';
            backBtn.style.display = 'none';
        } else {
            const currentContext = navigationStack[depth - 1];
            setLeftPanelTitle('Categorias', true); 
            middlePanelTitle.textContent = currentContext.name;
            backBtn.style.display = 'flex';
            
            const rootCategoryId = navigationStack[0].id;
            const validYellowCategories = ['topico', 'personagem', 'local', 'data', 'marcadores', 'cosmos']; 
            updateAddButtonState(validYellowCategories.includes(rootCategoryId), true);
            renderListCategoryItems(currentContext.id);
        }
        return; 
    }

    // ============================================================
    // CASO B: MODO PINS (NOVO)
    // ============================================================
    if (currentViewMode === 'pins' && currentTab === 'note') {
        addItemBtn.style.display = 'none'; 
        backBtn.style.display = 'none';
        setLeftPanelTitle('Pins'); 
        
        // FOR√áA O CARREGAMENTO DA COLUNA 1 SEMPRE QUE ENTRA/VOLTA
        loadPinsView(); 
        
        return; 
    }

    // ============================================================
    // CASO C: MODO NOTE (LOCAL OU PARTILHA)
    // ============================================================
    addItemBtn.style.display = 'flex';
    addItemBtn.classList.remove('yellow-mode');

    // 1. Definir T√≠tulo da Esquerda (Coluna 1)
    if (depth === 0) {
        setLeftPanelTitle(currentViewMode === 'local' ? 'Pastas' : 'Partilha'); 
    } else {
        const parentFolder = (depth > 1) ? navigationStack[depth - 2] : null;
        const parentName = parentFolder ? parentFolder.name : (currentViewMode === 'shared' ? 'Partilhadas' : 'Pastas');
        setLeftPanelTitle(parentName, true);
    }

    let leftPanelParentId = null;
    let middlePanelParentId = null;

    // 2. Definir o que mostrar em cada coluna baseando-se na profundidade
    if (depth === 0) {
        // RAIZ
        if (currentViewMode === 'shared') {
            leftPanelParentId = "EMPTY_SIDEBAR_FOR_SHARED"; // A coluna 1 fica limpa para focar na lista
        } else {
            leftPanelParentId = isSuperContext ? SUPERFOLDER_ID : null;
        }
        middlePanelTitle.textContent = 'Selecione';
        middlePanelList.innerHTML = '';
        backBtn.style.display = 'none';
        
        if (currentViewMode === 'shared') loadSharedFilesRoot();
    } else {
        // DENTRO DE PASTAS
        const currentFolder = navigationStack[depth - 1];
        middlePanelParentId = currentFolder.id;
        middlePanelTitle.textContent = currentFolder.name;
        backBtn.style.display = 'flex';
        
        if (depth === 1) {
            leftPanelParentId = (currentViewMode === 'local') ? (isSuperContext ? SUPERFOLDER_ID : null) : "EMPTY_SIDEBAR_FOR_SHARED";
        } else {
            leftPanelParentId = navigationStack[depth - 2].id;
        }
    }
    
    // 3. Disparar a renderiza√ß√£o das listas via onSnapshot
    unsubscribeLeftPanel = fetchAndDisplayItems(leftPanelParentId, leftPanelList, null);
    if (middlePanelParentId) {
        unsubscribeMiddlePanel = fetchAndDisplayItems(middlePanelParentId, middlePanelList, targetSelectId);
    }
    updateMobileFABVisibility();
}



// 2. Cria Regex que entende acentos (ex: "joao" vira regex para encontrar "jo√£o", "Jo√£o", "J√íAO")
function getAccentInsensitiveRegex(term, isExact = false) {
    const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    let regexStr = escaped
        .replace(/a/gi, '[a√†√°√¢√£√§√•]')
        .replace(/e/gi, '[e√®√©√™√´]')
        .replace(/i/gi, '[i√¨√≠√Æ√Ø]')
        .replace(/o/gi, '[o√≤√≥√¥√µ√∂]')
        .replace(/u/gi, '[u√π√∫√ª√º]')
        .replace(/c/gi, '[c√ß]');
        
    // AQUI: Envolvemos o padr√£o em par√™nteses (Capturing Group) para o $1 funcionar
    return isExact ? new RegExp(`(\\b${regexStr}\\b)`, 'gi') : new RegExp(`(${regexStr})`, 'gi');
}



// --- L√ìGICA DA BARRA SECUND√ÅRIA ---

setTimeout(() => {
    const toggleMoreBtn = document.getElementById('toggle-more-tools-btn');
    const secondaryToolbar = document.getElementById('secondary-toolbar');
    const safeNoteEditor = document.getElementById('note-content-editor'); 

    // 1. Abrir/Fechar Painel Secund√°rio
    if (toggleMoreBtn && secondaryToolbar) {
        toggleMoreBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            const isHidden = secondaryToolbar.style.display === 'none';
            
            if (isHidden) {
                secondaryToolbar.style.display = 'flex';
                toggleMoreBtn.classList.add('active');
                toggleMoreBtn.textContent = '‚ñ≤';
            } else {
                secondaryToolbar.style.display = 'none';
                toggleMoreBtn.classList.remove('active');
                toggleMoreBtn.textContent = '‚ñº';
            }
        });
    }

// 2. Funcionalidade dos Bot√µes da Barra Secund√°ria
    if (secondaryToolbar) {
        secondaryToolbar.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            e.preventDefault(); // Impede perda de foco

            // A. T√≠tulos e Texto Normal (A1, A2, P)
            if (btn.dataset.cmdSec === 'formatBlock') {
                const value = btn.dataset.val;
                
                // 1. Aplica o formato de bloco (H1, H2...)
                document.execCommand('formatBlock', false, value);

                // 2. LIMPEZA PROFUNDA
                const selection = window.getSelection();
                if (selection.anchorNode && safeNoteEditor) {
                    let block = selection.anchorNode;
                    if (block.nodeType === 3) block = block.parentNode; 
                    
                    while(block && block.id !== 'note-content-editor' && block.tagName !== value) {
                        block = block.parentNode;
                    }

                    if (block && block.tagName === value) {
                        block.removeAttribute('style'); 
                        const dirtyChildren = block.querySelectorAll('span, font, b, i, u');
                        dirtyChildren.forEach(child => {
                             child.style.fontSize = '';
                             child.style.fontWeight = '';
                             if (child.tagName === 'FONT') {
                                 child.removeAttribute('size');
                                 child.removeAttribute('face');
                             }
                        });
                    }
                }
                
                safeNoteEditor.focus(); 
                saveNote();
            }

            // B. Outros Comandos (Linha Horizontal)
            else if (btn.dataset.cmdSec) {
                const command = btn.dataset.cmdSec;
                document.execCommand(command, false, null);
                safeNoteEditor.focus();
                saveNote();
            }

            // C. Inserir Checkbox
            else if (btn.dataset.action === 'insert-checkbox') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.marginRight = '8px';
                checkbox.style.cursor = 'pointer';
                const space = document.createTextNode('\u00A0'); 

                insertNodeAtCursor(checkbox);
                insertNodeAtCursor(space);
                saveNote();
            }

            // D. Inserir Tabela (üßÆ) - NOVO
        else if (btn.dataset.action === 'insert-table') {
                const tableHTML = `
                    <div class="jwn-table-wrapper">
                        <button class="table-settings-btn" contenteditable="false">üõ†Ô∏è Op√ß√µes</button>
                        <table class="jwn-table">
                            <thead>
                                <tr>
                                    <th>T√≠tulo 1</th>
                                    <th>T√≠tulo 2</th>
                                    <th>T√≠tulo 3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td><br></td><td><br></td><td><br></td></tr>
                                <tr><td><br></td><td><br></td><td><br></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p><br></p>`;
                
                document.execCommand('insertHTML', false, tableHTML);
                saveNote();
            }

            // F. Inserir Linha Cronol√≥gica (NOVO)
else if (btn.dataset.action === 'insert-timeline') {
    const timelineId = `tl_${Date.now()}`;
    
    const timelineHTML = `
        <div class="jwn-timeline-wrapper" contenteditable="false" id="${timelineId}">
            <div class="timeline-track"></div>
            
            <div class="timeline-container">
                <!-- Ponto 1 -->
                <div class="timeline-entry">
                    <div class="t-marker"></div>
                    <div class="t-date" contenteditable="true">Data 1</div>
                    <div class="t-text" contenteditable="true">Descri√ß√£o do evento...</div>
                    <button class="t-btn-del" title="Remover Ponto">√ó</button>
                </div>
                <!-- Ponto 2 -->
                <div class="timeline-entry">
                    <div class="t-marker"></div>
                    <div class="t-date" contenteditable="true">Data 2</div>
                    <div class="t-text" contenteditable="true">Descri√ß√£o do evento...</div>
                    <button class="t-btn-del" title="Remover Ponto">√ó</button>
                </div>
            </div>

            <button class="t-btn-add" title="Adicionar Novo Ponto">‚ûï Adicionar Ponto</button>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, timelineHTML);
    saveNote();
}

   // G. TORNAR TEXTO MOV√çVEL (·Øì) - C√ìDIGO CORRIGIDO E INTEGRADO
       else if (btn.dataset.action === 'make-draggable') {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const anchorNode = selection.anchorNode;
            const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

            // 1. REVERTER: Se j√° estiver dentro de uma linha mov√≠vel
            const existingLine = element.closest('.draggable-line');
            if (existingLine) {
                const contentDiv = existingLine.querySelector('.drag-content-area');
                const content = contentDiv ? contentDiv.innerHTML : existingLine.textContent.replace('·Øì', '');
                
                const p = document.createElement('p');
                p.innerHTML = content || "<br>";
                
                existingLine.replaceWith(p);
                
                // Focar no p revertido
                p.focus();
                
                saveNote();
                return;
            }

            // 2. CRIAR: Preparar o conte√∫do
            let contentHTML = "";
            let blockToRemove = null;

            if (!selection.isCollapsed) {
                const fragment = range.cloneContents();
                const div = document.createElement('div');
                div.appendChild(fragment);
                contentHTML = div.innerHTML;
            } else {
                const block = element.closest('p, div, h1, h2, h3, li');
                if (block && !block.id.includes('note-content-editor') && !block.classList.contains('mini-note-wrapper')) {
                    contentHTML = block.innerHTML;
                    blockToRemove = block;
                } else {
                    contentHTML = "Texto mov√≠vel";
                }
            }

            // 3. LIMPEZA DE SEGURAN√áA
            const cleaner = document.createElement('div');
            cleaner.innerHTML = contentHTML;
            cleaner.querySelectorAll('.drag-handle-icon').forEach(i => i.remove());
            cleaner.querySelectorAll('.draggable-line').forEach(line => {
                const inner = line.querySelector('.drag-content-area');
                line.outerHTML = inner ? inner.innerHTML : line.textContent;
            });
            contentHTML = cleaner.innerHTML;

            // 4. APLICA√á√ÉO
            const uniqueId = `drag_${Date.now()}`;
            const draggableHTML = `
                <div class="draggable-line" draggable="true" id="${uniqueId}">
                    <span class="drag-handle-icon" contenteditable="false">·Øì</span>
                    <div class="drag-content-area" contenteditable="true">${contentHTML}</div>
                </div>`;

            if (blockToRemove) {
                blockToRemove.outerHTML = draggableHTML;
            } else {
                document.execCommand('insertHTML', false, draggableHTML);
            }

            // --- CORRE√á√ÉO DE CURSOR AQUI ---
            // Espera o HTML renderizar, encontra o novo elemento e move o cursor para o fim
            setTimeout(() => {
                const newLine = document.getElementById(uniqueId);
                if (newLine) {
                    const contentArea = newLine.querySelector('.drag-content-area');
                    if (contentArea) {
                        contentArea.focus(); // Foca na caixa de texto

                        // Cria um novo range
                        const newRange = document.createRange();
                        
                        // Seleciona todo o conte√∫do da caixa
                        newRange.selectNodeContents(contentArea);
                        
                        // COLAPSA PARA O FIM (true = in√≠cio, false = fim)
                        newRange.collapse(false); 
                        
                        // Aplica a sele√ß√£o
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(newRange);
                    }
                }
            }, 10); // Pequeno delay de 10ms √© suficiente

            saveNote();
        }

  


if (btn.dataset.action === 'insert-toggle-h2') {
    const selection = window.getSelection();

    // =================================================================
    // 1. VERIFICA√á√ÉO DE ANINHAMENTO (IMPEDIR TOGGLE DENTRO DE TOGGLE)
    // =================================================================
    if (selection.rangeCount > 0) {
        const node = selection.anchorNode;
        // Garante que temos o elemento HTML
        const element = node.nodeType === 3 ? node.parentElement : node;
        
        // Verifica se o cursor j√° est√° dentro de um <details>
        if (element.closest('details.toggle-section')) {
            alert("N√£o √© permitido criar um Toggle dentro de outro.");
            return; // Cancela a a√ß√£o imediatamente
        }
    }
    // =================================================================

    let text = selection.toString();
    
    if (!text.trim()) {
        text = "T√≠tulo Expans√≠vel";
    }

    const uniqueId = 'toggle_' + Date.now();

 const toggleHTML = `
        <details class="toggle-section" open id="${uniqueId}">
            <summary>
                <h2>${text}</h2>
                
                <!-- NOVOS BOT√ïES DE MOVIMENTO -->
                <button class="toggle-move-btn" data-action="move-up" contenteditable="false" title="Mover para Cima">üî∫</button>
                <button class="toggle-move-btn" data-action="move-down" contenteditable="false" title="Mover para Baixo">üîª</button>
                
                <!-- BOT√ïES ANTIGOS -->
                <button class="toggle-color-btn" contenteditable="false" title="Mudar Cor">üñåÔ∏è</button>
                <button class="toggle-delete-btn" contenteditable="false" title="Ocultar Sec√ß√£o">üóëÔ∏è</button>
            </summary>
            <div class="toggle-content">
                <p><br></p>
            </div>
        </details>
        <p><br></p>`;

    document.execCommand('insertHTML', false, toggleHTML);
    saveNote();
}

           // E. Inserir Calend√°rio (üìÖ) - ATUALIZADO
     else if (btn.dataset.action === 'insert-date') {
    const calId = `cal_${Date.now()}`;
    const today = new Date();
    
    const widgetHTML = `
        <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
            <div class="cal-header">
                <button class="cal-btn cal-prev">‚óÄ</button>
                <span class="cal-title">Carregando...</span>
                <div style="display:flex; gap:5px;">
                    <button class="cal-btn cal-next">‚ñ∂</button>
                    <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                </div>
            </div>
            
            <!-- Menu de Defini√ß√µes -->
            <div class="cal-settings-menu">
                <!-- Bot√µes de Vista -->
                <div style="display:flex; gap:5px; justify-content:center; width:100%;">
                    <button class="cal-view-btn" data-view="week" style="flex:1;">Semana</button>
                    <button class="cal-view-btn active" data-view="month" style="flex:1;">M√™s</button>
                    <button class="cal-view-btn" data-view="year" style="flex:1;">Ano</button>
                </div>
                
                <!-- Separador -->
                <hr style="border:0; border-top:1px solid var(--border-color); opacity: 0.5;">
                
                <!-- Bot√£o Eliminar com classe CSS -->
                <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
            </div>
            
            <div class="cal-grid">
                <!-- Dias ser√£o gerados via JS -->
            </div>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, widgetHTML);
    
    setTimeout(() => renderCalendarUI(document.getElementById(calId)), 50);
    saveNote();
}
        });

        // 3. Listener para Cor (Separado, mant√©m-se igual)
        secondaryToolbar.addEventListener('input', (e) => {
            const target = e.target;
            if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
                document.execCommand('foreColor', false, target.value);
                saveNote(); 
            }
        });
    }
}, 500);

// Fun√ß√£o Auxiliar (Mant√©m-se a mesma, mas garante que est√° presente)
function insertNodeAtCursor(node) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node);
        range.setEndAfter(node);
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante)
// ====================================================================

// --- NOVO C√ìDIGO PARA A DROPDOWN DE FORMATOS ---
    const formatSelect = document.getElementById('editor-format');
    if (formatSelect) {
        formatSelect.addEventListener('change', () => {
            const value = formatSelect.value; // Pega H1, H2, P, etc.
            
            // 1. Aplica o formato
            document.execCommand('formatBlock', false, value);

            // 2. LIMPEZA PROFUNDA (Mesma l√≥gica que tinhas nos bot√µes)
            const selection = window.getSelection();
            if (selection.anchorNode && safeNoteEditor) {
                let block = selection.anchorNode;
                if (block.nodeType === 3) block = block.parentNode; 
                
                // Sobe at√© encontrar o bloco alterado
                while(block && block.id !== 'note-content-editor' && block.tagName !== value) {
                    block = block.parentNode;
                }

                if (block && block.tagName === value) {
                    block.removeAttribute('style'); 
                    const dirtyChildren = block.querySelectorAll('span, font, b, i, u');
                    dirtyChildren.forEach(child => {
                            child.style.fontSize = '';
                            child.style.fontWeight = '';
                            if (child.tagName === 'FONT') {
                                child.removeAttribute('size');
                                child.removeAttribute('face');
                            }
                    });
                }
            }
            
            // 3. Foca de volta no editor e grava
            safeNoteEditor.focus();
            saveNote();
            
            // Opcional: Voltar visualmente para "Normal" para a pr√≥xima a√ß√£o
            // formatSelect.value = "P"; 
        });
    }

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante Controlado)
// ====================================================================
let activeTableCell = null; // Memoriza a √∫ltima c√©lula clicada/focada
let activeTableWrapper = null; // Memoriza qual a tabela ativa
const tablePopup = document.getElementById('table-tools-popup');

// 1. Detetar cliques (Memorizar C√©lula OU Abrir Menu)
noteContentEditor.addEventListener('click', (e) => {
    
    // CASO A: Clicou numa c√©lula (Apenas memorizamos, N√ÉO abrimos menu)
    const cell = e.target.closest('td, th');
    if (cell) {
        activeTableCell = cell; // Guardamos a refer√™ncia para saber onde inserir linhas
        activeTableWrapper = cell.closest('.jwn-table-wrapper');
        
        // Se o menu estiver aberto noutra tabela, fecha-o
        if (tablePopup.style.display === 'flex' && !activeTableWrapper.contains(e.target)) {
            tablePopup.style.display = 'none';
        }
        return;
    }

    // CASO B: Clicou no bot√£o de Ferramentas (üõ†Ô∏è)
    const settingsBtn = e.target.closest('.table-settings-btn');
    if (settingsBtn) {
        // Encontra a tabela associada a este bot√£o
        activeTableWrapper = settingsBtn.closest('.jwn-table-wrapper');
        const table = activeTableWrapper.querySelector('table');
        
        // Se n√£o tivermos clicado numa c√©lula recentemente, assumimos a primeira c√©lula da tabela
        if (!activeTableCell || !table.contains(activeTableCell)) {
            activeTableCell = table.querySelector('td, th');
        }

        // Toggle do Menu
        if (tablePopup.style.display === 'flex') {
            tablePopup.style.display = 'none';
            settingsBtn.classList.remove('active');
        } else {
            // Posicionar Menu
            const rect = settingsBtn.getBoundingClientRect();
            tablePopup.style.display = 'flex';
            tablePopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            // Alinha √† direita do bot√£o
            tablePopup.style.left = `${(rect.right + window.scrollX) - tablePopup.offsetWidth}px`;
            
            settingsBtn.classList.add('active');
        }
        return;
    }

    // CASO C: Clicou fora (Fechar Menu)
    if (tablePopup.style.display === 'flex' && !tablePopup.contains(e.target)) {
        tablePopup.style.display = 'none';
        // Remove estado ativo de todos os bot√µes
        document.querySelectorAll('.table-settings-btn').forEach(b => b.classList.remove('active'));
    }
});

// 2. A√ß√µes dos bot√µes do menu (Adicionar/Remover)
if (tablePopup) {
    tablePopup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeTableCell) return;
        
        e.preventDefault(); e.stopPropagation();

        const action = btn.dataset.action;
        const cell = activeTableCell;
        const row = cell.parentElement;
        const table = row.closest('table');
        
        const rowIndex = row.rowIndex;
        const colIndex = cell.cellIndex;
        const currentCols = row.cells.length;
        const currentRows = table.rows.length;

        // --- ADICIONAR ---
        if (action === 'add-row-above' || action === 'add-row-below') {
            if (currentRows >= 50) return alert("Limite de linhas atingido.");
            const newRow = table.insertRow(action === 'add-row-above' ? rowIndex : rowIndex + 1);
            for (let i = 0; i < currentCols; i++) {
                newRow.insertCell(i).innerHTML = '<br>';
            }
        }
        else if (action === 'add-col-left' || action === 'add-col-right') {
            if (currentCols >= 15) return alert("Limite de colunas atingido.");
            for (let i = 0; i < table.rows.length; i++) {
                const tr = table.rows[i];
                const isHeadRow = tr.parentNode.tagName === 'THEAD';
                const refIndex = action === 'add-col-left' ? colIndex : colIndex + 1;
                const newCell = tr.insertCell(refIndex);
                if (isHeadRow) newCell.outerHTML = '<th>T√≠tulo</th>';
                else newCell.innerHTML = '<br>';
            }
        }

        // --- APAGAR ---
        else if (action === 'del-row') {
            table.deleteRow(rowIndex);
            if (table.rows.length === 0) activeTableWrapper.remove();
        }
        else if (action === 'del-col') {
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].deleteCell(colIndex);
            }
            if (table.rows[0] && table.rows[0].cells.length === 0) activeTableWrapper.remove();
        }
        else if (action === 'del-table') {
            if (confirm("Apagar toda a tabela?")) {
                activeTableWrapper.remove();
            }
        }

        saveNote();
        // N√£o fechamos o menu automaticamente para permitir m√∫ltiplas a√ß√µes r√°pidas
        // Se quiser fechar, descomente a linha abaixo:
        // tablePopup.style.display = 'none'; 
    });
}

// --- FUN√á√ÉO AUXILIAR: ATUALIZAR VISUAL DO BOT√ÉO DE T√ìPICOS ---
function updateMiniNoteButtonState(wrapperElement) {
    if (!wrapperElement) return;

    const btn = wrapperElement.querySelector('button[data-action="manage-mini-note-topics"]');
    if (!btn) return;

    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    let hasTopics = false;

    try {
        const topics = JSON.parse(topicsString);
        // Verifica se h√° chaves no objeto (t√≥picos selecionados)
        hasTopics = Object.keys(topics).length > 0;
    } catch (e) {
        hasTopics = false;
    }

    if (hasTopics) {
        // --- ESTILO DESTACADO (COM T√ìPICOS) ---
        btn.style.backgroundColor = "rgba(74, 144, 226, 0.3)"; // Fundo azulado semi-transparente
        btn.style.color = "var(--accent-color)";               // √çcone azul forte
        btn.style.borderColor = "var(--accent-color)";         // Borda azul forte
        btn.title = "Gerir T√≥picos (Ativos)";
    } else {
        // --- ESTILO PADR√ÉO (SEM T√ìPICOS) ---
        btn.style.backgroundColor = "";
        btn.style.color = "";
        btn.style.borderColor = "";
        btn.title = "Gerir T√≥picos";
    }
}

// --- FUN√á√ÉO PARA CORRIGIR SUBNOTAS ANTIGAS ---
function fixLegacyMiniNotes() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    // 1. LIMPEZA DE SEGURAN√áA (Remove elementos √≥rf√£os de vers√µes antigas)
    const ghostArrows = editor.querySelectorAll('.title-expand-arrow');
    ghostArrows.forEach(arrow => arrow.remove());

    const wrappers = editor.querySelectorAll('.mini-note-wrapper');
    
    wrappers.forEach(wrapper => {
        // 2. GARANTIA DE ATRIBUTOS ESSENCIAIS (Inicia se n√£o existirem)
        if (!wrapper.hasAttribute('data-topics')) wrapper.setAttribute('data-topics', '{}');
        if (!wrapper.hasAttribute('data-shared')) wrapper.setAttribute('data-shared', 'false');
        if (!wrapper.hasAttribute('data-box-links')) wrapper.setAttribute('data-box-links', '{}');

        // 3. RECONSTRU√á√ÉO DA TOOLBAR
        let toolbar = wrapper.querySelector('.mini-note-toolbar');
        if (!toolbar) {
            toolbar = document.createElement('div');
            toolbar.className = 'mini-note-toolbar';
            toolbar.setAttribute('contenteditable', 'false');
            // Insere a toolbar antes do conte√∫do da nota
            const content = wrapper.querySelector('.mini-note-content');
            wrapper.insertBefore(toolbar, content);
        }

        // Garante que o grupo de setas (Mover) existe
        let arrowGroup = toolbar.querySelector('.toolbar-btn-group');
        if (!arrowGroup) {
            arrowGroup = document.createElement('div');
            arrowGroup.className = 'toolbar-btn-group';
            toolbar.appendChild(arrowGroup);
        }

        // Configura√ß√£o de todos os bot√µes necess√°rios
        const buttonsConfig = [
            { action: 'sharing-settings', icon: 'üîê', title: 'Partilha', parent: toolbar },
            { action: 'move-up', icon: 'üî∫', title: 'Subir', parent: arrowGroup },
            { action: 'move-down', icon: 'üîª', title: 'Descer', parent: arrowGroup },
            { action: 'manage-box-links', icon: '‚ö°', title: 'Links/Codex', parent: toolbar },
            { action: 'append-mini-note', icon: 'üß¨', title: 'Clonar para Nota', parent: toolbar },
            { action: 'highlight-color', icon: 'üé®', title: 'Destacar Cor', parent: toolbar },
            { action: 'manage-mini-note-topics', icon: 'üìã', title: 'Gerir T√≥picos', parent: toolbar },
            { action: 'delete-mini-note', icon: 'üóëÔ∏è', title: 'Apagar', parent: toolbar }
        ];

        buttonsConfig.forEach(cfg => {
            let btn = toolbar.querySelector(`button[data-action="${cfg.action}"]`);
            if (!btn) {
                btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.action = cfg.action;
                btn.textContent = cfg.icon;
                btn.title = cfg.title;
                cfg.parent.appendChild(btn);
            }
        });

        // 4. CONVERS√ÉO DE T√çTULOS (Input -> Textarea para m√∫ltiplas linhas)
        let titleArea = wrapper.querySelector('.mini-note-title-input');
        if (titleArea && titleArea.tagName === 'INPUT') {
            const textarea = document.createElement('textarea');
            textarea.className = titleArea.className;
            textarea.value = titleArea.getAttribute('value') || titleArea.value || "";
            textarea.placeholder = titleArea.placeholder;
            textarea.setAttribute('spellcheck', 'false');
            titleArea.parentNode.replaceChild(textarea, titleArea);
            titleArea = textarea;
        }

        // Aplica o comportamento de quebra de linha se a configura√ß√£o global estiver ativa
        if (titleArea && typeof appSettings !== 'undefined' && appSettings.showFullTitles) {
            titleArea.classList.add('wrap-enabled');
            // Ajusta a altura inicial baseado no conte√∫do
            setTimeout(() => {
                titleArea.style.height = 'auto';
                titleArea.style.height = titleArea.scrollHeight + 'px';
            }, 0);
        }

        // 5. GARANTIA DE EDI√á√ÉO
        toolbar.setAttribute('contenteditable', 'false');
        const contentDiv = wrapper.querySelector('.mini-note-content');
        if (contentDiv) contentDiv.setAttribute('contenteditable', 'true');

        // 6. ATUALIZA√á√ÉO VISUAL (Cores dos bot√µes baseadas nos dados)
        if (typeof updateMiniNoteButtonState === 'function') updateMiniNoteButtonState(wrapper); 
        if (typeof updateHighlightButtonState === 'function') updateHighlightButtonState(wrapper); 
        if (typeof updateSharingButtonState === 'function') updateSharingButtonState(wrapper); 
        if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(wrapper);
    });
}





// 1. Carregar Destaques Personalizados do Firebase
async function loadUserHighlights() {
    if (!auth.currentUser) return;
    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            userCustomHighlights = docSnap.data().colors || {};
        }
    } catch (e) {
        console.error("Erro ao carregar destaques:", e);
    }
}

// 2. Abrir Popup de Cores
 function renderHighlightList() {
    const container = document.getElementById('highlight-options-container');
    container.innerHTML = '';

    // 1. Descobrir qual a cor ativa na caixa atual
    // Convertemos para min√∫sculas para garantir que a compara√ß√£o funciona
    const activeColor = activeWrapperForColor && activeWrapperForColor.dataset.highlight 
                      ? activeWrapperForColor.dataset.highlight.toLowerCase() 
                      : null;

    // Op√ß√£o de Remover
    const removeRow = document.createElement('div');
    removeRow.className = 'highlight-option-row remove-highlight-row';
    removeRow.innerHTML = '<span>üö´ Remover Destaque</span>';
    removeRow.onclick = () => applyHighlight(null);
    container.appendChild(removeRow);

    // Lista de Cores
    DEFAULT_HIGHLIGHTS.forEach(colorObj => {
        const hex = colorObj.code;
        const displayName = userCustomHighlights[hex] || colorObj.name;

        const row = document.createElement('div');
        row.className = 'highlight-option-row';

        // --- CORRE√á√ÉO AQUI: Comparar ambos em min√∫sculas ---
        if (hex.toLowerCase() === activeColor) {
            row.classList.add('selected-color-row');
        }
        // ---------------------------------------------------

        // Bola de Cor
        const colorBox = document.createElement('div');
        colorBox.className = 'color-preview-box';
        colorBox.style.backgroundColor = hex;

        // Nome
        const nameLabel = document.createElement('span');
        nameLabel.className = 'highlight-name-label';
        nameLabel.textContent = displayName;

        // L√°pis
        const editBtn = document.createElement('button');
        editBtn.className = 'highlight-options-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.title = "Mudar Nome";
        editBtn.onclick = (e) => {
            e.stopPropagation(); 
            renameHighlight(hex, displayName);
        };

        row.onclick = () => applyHighlight(hex);

        row.appendChild(colorBox);
        row.appendChild(nameLabel);
        row.appendChild(editBtn);
        container.appendChild(row);
    });
}

// 2. Abrir Modal de Cores (Agora muito mais simples)
async function openHighlightPopup(wrapper) {
    console.log("üöÄ Abrindo seletor de cores...");
    activeWrapperForColor = wrapper; 

    const modal = document.getElementById('highlight-modal');
    if (!modal) return console.error("Modal #highlight-modal n√£o encontrado!");

    // 1. MOVE PARA O BODY (Top Level)
    document.body.appendChild(modal);

    // 2. FOR√áA VISIBILIDADE E CAMADA
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "3000000"; // N√≠vel muito alto
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 3. CARREGA DADOS
    await loadUserHighlights();
    renderHighlightList(); 
}

// 3. Renomear Destaque
async function renameHighlight(hexCode, currentName) {
    const modal = document.getElementById('rename-highlight-modal');
    if (!modal) return;

    // Move para o body e define Z-index supremo
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "4000000"; // Acima do seletor de cores

    const input = document.getElementById('new-highlight-name-input');
    colorHexBeingRenamed = hexCode;
    input.value = currentName;
    
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);

    // L√≥gica dos bot√µes Cancelar/Gravar (mant√©m a tua original, apenas garante o fecho)
    document.getElementById('confirm-rename-highlight-btn').onclick = async () => {
        const newName = input.value.trim();
        if (newName) {
            userCustomHighlights[hexCode] = newName;
            await syncColorsToFirebase();
            renderHighlightList();
        }
        modal.style.display = 'none';
    };

    document.getElementById('cancel-rename-highlight-btn').onclick = () => {
        modal.style.display = 'none';
    };
}

function updateSharingButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="sharing-settings"]');
    if (!btn) return;

    const isShared = wrapper.getAttribute('data-shared') === 'true';

    if (isShared) {
        btn.textContent = 'üîì'; // Cadeado aberto
        btn.classList.add('sharing-active');
        btn.title = "Partilha Permitida (P√∫blico)";
    } else {
        btn.textContent = 'üîê'; // Cadeado fechado
        btn.classList.remove('sharing-active');
        btn.title = "Partilha Bloqueada (Privado)";
    }
}

// Atualiza o √≠cone na toolbar principal
function updateNoteSharingButtonUI(isShared) {
    const btn = document.querySelector('button[data-action="note-sharing-settings"]');
    if (!btn) return;

    if (isShared) {
        // ESTADO P√öBLICO
        btn.textContent = 'üîì'; // Cadeado Aberto
        btn.style.color = '#2ecc71'; // Verde
        btn.title = "Nota P√∫blica (Clique para gerir)";
    } else {
        // ESTADO PRIVADO
        btn.textContent = 'üîê'; // Cadeado Fechado
        btn.style.color = ''; // Cor padr√£o do tema
        btn.title = "Nota Privada (Clique para partilhar)";
    }
}

// Fun√ß√£o Central: Grava as cores e o UserID no Firebase
// (Cria se n√£o existir, Atualiza se j√° existir)
async function syncColorsToFirebase() {
    if (!auth.currentUser) return;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // Prepara os dados
        const dataToSave = {
            userId: auth.currentUser.uid, // Garante que o ID do user est√° gravado
            colors: userCustomHighlights    // Grava o mapa de cores (Hex -> Nome)
        };

        // O { merge: true } √© a chave aqui:
        // - Se o doc n√£o existir: CRIA com estes dados.
        // - Se o doc existir: ATUALIZA/JUNTA estes dados.
        await setDoc(docRef, dataToSave, { merge: true });
        

    } catch (e) {
        console.error("Erro ao sincronizar cores:", e);
    }
}

// 4. Aplicar Destaque √† Caixa
async function applyHighlight(colorCode) {
    if (!activeWrapperForColor) return;

    if (colorCode) {
        activeWrapperForColor.dataset.highlight = colorCode;
    } else {
        activeWrapperForColor.removeAttribute('data-highlight');
    }

    updateHighlightButtonState(activeWrapperForColor);
    
    // FECHA O MODAL
    document.getElementById('highlight-modal').style.display = 'none';
    
    activeWrapperForColor = null;
    saveNote(true); // Grava a nota imediatamente
}


// Fun√ß√£o Auxiliar: Garante que a cor existe na cole√ß√£o 'destaques'
async function ensureColorExistsInFirebase(hexCode, defaultName) {
    // Se j√° temos esta cor carregada localmente, n√£o precisamos de ir √† BD
    if (userCustomHighlights[hexCode]) return;

    const nameToSave = defaultName;
    
    // Atualiza cache local
    userCustomHighlights[hexCode] = nameToSave;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // --- ALTERA√á√ÉO AQUI ---
        // Adicionamos userId: auth.currentUser.uid ao objeto
        await setDoc(docRef, {
            userId: auth.currentUser.uid, // <--- CAMPO NOVO
            colors: {
                [hexCode]: nameToSave
            }
        }, { merge: true });
        
    } catch (e) {
        console.error("Erro ao registar cor:", e);
    }
}

// Listener para o bot√£o üé®
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="highlight-color"]');
    if (btn) {
        e.preventDefault(); 
        e.stopPropagation();
        
     const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
if (!wrapper) return;
        
        // Simplesmente abre o popup, sem c√°lculos de posi√ß√£o nem toggle complexo
        openHighlightPopup(wrapper);
        return;
    }
});

// Fechar popup ao clicar fora
document.addEventListener('click', (e) => {
    const modal = document.getElementById('highlight-modal');
    const renameModal = document.getElementById('rename-highlight-modal');
    
    if (!modal) return; 

    // Verifica se o clique foi dentro do modal de renomear ou se o modal de renomear est√° aberto
    const isRenameModalOpen = renameModal && renameModal.style.display === 'flex';
    const clickedInsideRename = renameModal && renameModal.contains(e.target);

    if (modal.style.display === 'flex' && 
        !modal.contains(e.target) && 
        !e.target.closest('button[data-action="highlight-color"]') &&
        !isRenameModalOpen && !clickedInsideRename) { // <--- S√≥ fecha se N√ÉO for intera√ß√£o com o rename
        
        modal.style.display = 'none';
        activeWrapperForColor = null;
    }
});

// 5. Atualizar Estado Visual do Bot√£o (Ao carregar a nota)
 function updateHighlightButtonState(wrapper) {
    const color = wrapper.dataset.highlight;
    const btn = wrapper.querySelector('button[data-action="highlight-color"]');
    const contentDiv = wrapper.querySelector('.mini-note-content');

    if (!btn) return;

    if (color) {
        // --- ESTILO ATIVO (PREENCHIDO) ---
        // Fundo ligeiramente claro para destacar que est√° ativo
        btn.style.backgroundColor = "rgba(255, 255, 255, 0.15)"; 
        // Borda com a cor do destaque escolhido
        btn.style.borderColor = color; 
        // √çcone com a cor do destaque escolhido
        btn.style.color = color; 
        
        btn.classList.add('has-color');
        
        // Garante que a caixa de texto tem a cor correta
        if (contentDiv) {
            contentDiv.style.backgroundColor = color;
            contentDiv.style.color = "#222222"; // Texto escuro para contraste
        }
    } else {
        // --- ESTILO INATIVO (RESET) ---
        btn.style.backgroundColor = "";
        btn.style.borderColor = "";
        btn.style.color = "";
        btn.classList.remove('has-color');
        
        if (contentDiv) {
            contentDiv.style.backgroundColor = ""; // Remove fundo
            contentDiv.style.color = ""; // Volta √† cor do tema
        }
    }
}


function updateMiddlePanelForFolderSelection(folderId, folderName, selectedElement) {
    // 1. Atualiza o estado da sele√ß√£o visual no painel esquerdo
    document.querySelectorAll('#left-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    selectedElement.classList.add('selected');

    // 2. Atualiza o stack de navega√ß√£o para refletir a nova pasta
    if (navigationStack.length > 0) {
        // Se j√° est√°vamos numa pasta, substitu√≠mos o √∫ltimo item
        navigationStack[navigationStack.length - 1] = { id: folderId, name: folderName };
    } else {
        // Se est√°vamos na raiz, adicionamos a pasta ao stack
        navigationStack.push({ id: folderId, name: folderName });
    }
    
    // 3. Atualiza o t√≠tulo do painel do meio e o bot√£o "Voltar"
    middlePanelTitle.textContent = folderName;
    backBtn.style.display = 'flex';

    // 4. Limpa o listener antigo do painel do meio para evitar fugas de mem√≥ria
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();

    // 5. Busca e exibe os novos itens no painel do meio, sem tocar no editor
    unsubscribeMiddlePanel = fetchAndDisplayItems(folderId, middlePanelList, null);
}


// Adiciona/Atualiza isto dentro da displayNote e displayArchive:
function syncVisualSelection(selectedId) {
    // 1. Remove destaques antigos apenas da segunda coluna (para n√£o matar a Coluna 1)
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });

    // 2. Aplica o destaque ao item clicado na Coluna 2
    const target = document.querySelector(`#file-list .list-item[data-id="${selectedId}"]`);
    if (target) {
        const isShared = (currentViewMode === 'shared');
        target.classList.add(isShared ? 'selected-red' : 'selected');
    }
}



async function displayNote(noteId, noteElement, searchTerm = null) {
     document.body.classList.remove('show-fab');
    // 1. Limpeza Imediata e Reset de Scroll
    const noteTitleInput = document.getElementById('note-title-input');
    const noteContentEditor = document.getElementById('note-content-editor');
    const editorArea = document.getElementById('editor-area');
    const rightPanel = document.getElementById('right-panel');

    if (noteTitleInput) noteTitleInput.value = ""; 
    if (noteContentEditor) noteContentEditor.innerHTML = ""; 
    
    if (editorArea) editorArea.scrollTop = 0;
    if (noteContentEditor) noteContentEditor.scrollTop = 0;
    if (rightPanel) rightPanel.scrollTop = 0;

    selectedNoteId = noteId;
    isClosingNote = false;

    const placeholder = document.getElementById('editor-placeholder');
    const archiveArea = document.getElementById('archive-area');

    // Gerir visibilidade dos pain√©is (esconde placeholder e arquivo, mostra editor)
    if (placeholder) placeholder.style.setProperty('display', 'none', 'important');
    if (archiveArea) archiveArea.style.setProperty('display', 'none', 'important');
    
    if (editorArea) {
        editorArea.style.setProperty('display', 'flex', 'important');
        editorArea.style.visibility = 'visible';
        editorArea.style.opacity = '1';
    }

    // Limpeza visual da sele√ß√£o na lista lateral
 document.querySelectorAll('#file-list .list-item').forEach(el => {
    el.classList.remove('selected', 'selected-red');
    });

    if (noteElement) {
        const isSharedTab = (currentViewMode === 'shared');
        noteElement.classList.add(isSharedTab ? 'selected-red' : 'selected');
    }

    try {
        // 2. Pedido dos dados ao Firestore
        const noteRef = doc(db, 'pastas', noteId);
        const noteSnap = await getDoc(noteRef);

        if (noteSnap.exists()) {
            let data = noteSnap.data();
            
            // Se o tipo for arquivo/feed, redireciona para a fun√ß√£o de arquivo
            if (data.tipo === 'partilhado' || data.tipo === 'arquivo') {
                displayArchive(noteId, data);
                return;
            }

            // Injetar dados no editor
            noteTitleInput.value = data.nome || '';
            noteContentEditor.innerHTML = data.conteudo || '';
            
            // 3. P√≥s-processamento: Widgets, Calend√°rios e Notas Antigas
            if (typeof fixLegacyMiniNotes === 'function') fixLegacyMiniNotes(); 
            if (typeof refreshAllCalendars === 'function') refreshAllCalendars();

            // ============================================================
            // üöÄ SINCRONIZA√á√ÉO DE T√çTULOS (ESTADO DA CONFIGURA√á√ÉO)
            // ============================================================
            // Usamos um setTimeout de 200ms para dar tempo ao browser de 
            // processar o HTML injetado antes de aplicarmos os estilos din√¢micos.
            setTimeout(() => {
                if (typeof applyTitleWrappingEffect === 'function') {
                    applyTitleWrappingEffect();
                }

                // Se a nota foi aberta via Pesquisa Global, faz scroll at√© ao termo
                if (searchTerm) {
                    scrollToAndHighlightText(searchTerm);
                }
            }, 200); 

            updateSaveStatus('saved');

        } else {
            alert("Nota n√£o encontrada.");
            resetEditor();
        }
    } catch (error) {
        console.error("Erro no displayNote:", error);
    }
    
    // Ajuste de Navega√ß√£o para Mobile (Sistema de Pilha)
    if (window.innerWidth <= 768) {
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
    }
}


function scrollToAndHighlightText(term) {
    if (!term) return;
    const lowerTerm = term.toLowerCase();

    // 1. Procura em Inputs (T√≠tulos de Subnotas/Quest√µes)
    const inputs = noteContentEditor.querySelectorAll('input');
    for (const input of inputs) {
        if (input.value.toLowerCase().includes(lowerTerm)) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            input.focus();
            // Adiciona efeito visual
            input.parentElement.classList.add('temporary-highlight');
            setTimeout(() => input.parentElement.classList.remove('temporary-highlight'), 2000);
            return; // Encontrou, para aqui.
        }
    }

    // 2. Procura no Texto (TreeWalker para encontrar n√≥s de texto)
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT, null, false);
    let node;
    while (node = walker.nextNode()) {
        const text = node.textContent;
        const index = text.toLowerCase().indexOf(lowerTerm);

        if (index >= 0) {
            // Encontrou o texto!
            
            // A. Tenta identificar se est√° dentro de um Post-it ou Subnota para destacar o contentor
            const container = node.parentElement.closest('.post-it-note, .mini-note-wrapper');
            if (container) {
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                container.classList.add('temporary-highlight');
                setTimeout(() => container.classList.remove('temporary-highlight'), 2000);
            } else {
                // Scroll no elemento pai direto
                node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // B. Selecionar o texto exato (Highlight nativo do browser)
            const range = document.createRange();
            range.setStart(node, index);
            range.setEnd(node, index + term.length);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            return; // Encontrou, para a pesquisa.
        }
    }
}

function saveNote(forceImmediate = false) {
    clearTimeout(saveTimeout);

    if (forceImmediate) {
        // Retorna a promessa da grava√ß√£o real
        return executeSave(); 
    }

    // Grava√ß√£o autom√°tica normal (espera 2 minutos)
    updateSaveStatus('unsaved');
    saveTimeout = setTimeout(async () => {
        await executeSave();
    }, 120000); 
}

// ============================================================
// FUN√á√ÉO AUXILIAR: Extrair todos os t√≥picos do HTML (Caixas)
// ============================================================
function extractTopicsFromEditorHTML() {
    // Encontra todas as caixas (Quest√µes, Subnotas, Contentores)
    const allWrappers = document.getElementById('note-content-editor').querySelectorAll('.mini-note-wrapper');
    const aggregatedTopics = {};

    allWrappers.forEach(wrapper => {
        try {
            // L√™ o atributo data-topics
            const jsonStr = wrapper.getAttribute('data-topics');
            
            // Ignora se estiver vazio
            if (!jsonStr || jsonStr === '{}') return;

            const topics = JSON.parse(jsonStr);

            // Junta tudo num √∫nico objeto grande
            for (const [topicId, subArray] of Object.entries(topics)) {
                
                // Se o t√≥pico ainda n√£o existe, cria array vazio
                if (!aggregatedTopics[topicId]) {
                    aggregatedTopics[topicId] = [];
                }

                // Adiciona subt√≥picos sem duplicar
                if (Array.isArray(subArray)) {
                    subArray.forEach(subId => {
                        if (!aggregatedTopics[topicId].includes(subId)) {
                            aggregatedTopics[topicId].push(subId);
                        }
                    });
                }
            }
        } catch (e) {
            console.warn("Erro ao ler t√≥picos de uma caixa:", e);
        }
    });

    return aggregatedTopics;
}

// Fun√ß√£o que faz a grava√ß√£o real no Firebase
async function executeSave() {
    // 1. Verifica√ß√£o de seguran√ßa: se n√£o h√° ID ou se a nota est√° a ser fechada, cancela.
    if (!selectedNoteId || isClosingNote) return;

    // 2. MODO ARQUIVO (FEED): Se o painel de arquivo estiver aberto, a l√≥gica de save √© diferente.
    const archiveArea = document.getElementById('archive-area');
    if (archiveArea && archiveArea.style.display !== 'none') {
        if (activeEditingPostId) {
            await saveArchivePost(activeEditingPostId);
            updateSaveStatus('saved');
            return true;
        }
        return true; 
    }

    // 3. SINCRONIZA√á√ÉO CR√çTICA (O Cora√ß√£o da Corre√ß√£o)
    // Antes de extrair o .innerHTML, for√ßamos os valores dos inputs/textareas para dentro do DOM.
    // Sem isto, o innerHTML ignora o que foi digitado nas caixas e salva-as vazias.
    const editor = document.getElementById('note-content-editor');
    if (editor) {
        const allTitles = editor.querySelectorAll('.mini-note-title-input');
        allTitles.forEach(t => {
            if (t.tagName === 'TEXTAREA') {
                // Sincroniza o valor digitado com o conte√∫do interno da tag para o innerHTML ler
                t.textContent = t.value; 
            } else {
                // Suporte para vers√µes antigas que usam <input>
                t.setAttribute('value', t.value);
            }
        });
    }

    // 4. In√≠cio do processo de grava√ß√£o no Firebase
    updateSaveStatus('saving');

    // Determina o ID de destino (lida com ponteiros/atalhos se existirem)
    let targetId = selectedNoteId;
    const realId = editor ? editor.getAttribute('data-real-id') : null;
    if (realId) targetId = realId;

    const noteRef = doc(db, 'pastas', targetId);

    try {
        // Captura os dados ATUALIZADOS ap√≥s a sincroniza√ß√£o acima
        const finalTitle = document.getElementById('note-title-input').value;
        const finalContent = editor.innerHTML;
const usedColors = extractUsedColorsFromEditor();

        // 5. Grava√ß√£o Principal na cole√ß√£o 'pastas'
        await updateDoc(noteRef, { 
            nome: finalTitle, 
            conteudo: finalContent,
             coresUsadas: usedColors,
            ultimaedicao: serverTimestamp()
        });

        // 6. SINCRONIZA√á√ÉO COM LINK P√öBLICO (Se a nota estiver partilhada)
        if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
            try {
                const shareId = currentNoteShareData.shareId;
                const publicNoteRef = doc(db, 'shared_notes', shareId);
                
                await setDoc(publicNoteRef, {
                    nome: finalTitle,
                    conteudo: finalContent,
                    authorName: currentUserData?.nome || "An√≥nimo",
                    updatedAt: serverTimestamp(),
                    type: 'full_note' 
                }, { merge: true });
                
            } catch (e) {
                console.warn("‚ö†Ô∏è Falha ao sincronizar com link p√∫blico:", e);
            }
        }

        // Finaliza com sucesso
        updateSaveStatus('saved');
        return true; 

    } catch (error) {
        console.error("‚ùå ERRO CR√çTICO AO GUARDAR:", error);
        updateSaveStatus('error');
        return false;
    }
}


// SINCRONIZA√á√ÉO P√öBLICA (Se a nota estiver partilhada)
    if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
        try {
            // Grava na cole√ß√£o 'shared_notes' sem bloquear a grava√ß√£o principal
            setDoc(doc(db, 'shared_notes', currentNoteShareData.shareId), {
                nome: noteTitleInput.value,
                conteudo: noteContentEditor.innerHTML,
                authorName: currentUserData?.nome || "An√≥nimo",
                updatedAt: serverTimestamp(),
                type: 'full_note' // Marca como nota completa
            }, { merge: true }).catch(err => console.error("Erro sync partilha:", err));
            
        } catch (e) {
            console.warn("Falha silenciosa ao sincronizar partilha p√∫blica.");
        }
    }

function insertMiniNoteAtCursor(type = 'default') {
    const editor = document.getElementById('note-content-editor');
    
    // 1. Obter a sele√ß√£o atual
    let selection = window.getSelection();
    let range;

    if (selection.rangeCount > 0) {
        const anchorNode = selection.anchorNode;
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        
        if (!editor.contains(safeNode)) {
            selection = null; 
        } else {
            if (safeNode.closest('.mini-note-wrapper')) {
                alert("N√£o pode inserir uma caixa dentro de outra. Clique fora primeiro.");
                return;
            }
            range = selection.getRangeAt(0);
        }
    }

    // Fallback: criar no final se n√£o houver sele√ß√£o
    if (!selection || !range) {
        editor.focus();
        range = document.createRange();
        range.selectNodeContents(editor);
        range.collapse(false);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }

    const miniNoteId = `mn_${Date.now()}`;
    let wrapperClass = 'mini-note-wrapper';
    let titleHTML = ''; 
    
    // Configura√ß√£o do T√≠tulo como TEXTAREA ( rows="1" para come√ßar pequeno )
    if (type === 'question') {
        wrapperClass += ' question-mode';
        titleHTML = `<textarea class="mini-note-title-input" placeholder="T√≠tulo da Quest√£o..." rows="1"></textarea>`;
    } else if (type === 'free') {
        wrapperClass += ' free-mode';
        titleHTML = ''; 
    } else {
        titleHTML = `<textarea class="mini-note-title-input" placeholder="T√≠tulo da Sub-Nota..." rows="1"></textarea>`;
    }

    const commonToolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Remover">üóëÔ∏è</button>
        </div>`;

    const miniNoteHTML = `
        <p><br></p>
        <div class="${wrapperClass}" contenteditable="false" id="${miniNoteId}" data-topics='{}' data-shared="false" data-box-links='{}'>
            ${titleHTML}
            ${commonToolbarHTML}
            <div class="mini-note-content" contenteditable="true">
                <p><br></p>
            </div>
        </div>
        <p><br></p>
    `;

    document.execCommand('insertHTML', false, miniNoteHTML);
    
    // Focar e aplicar l√≥gica de redimensionamento imediato
    setTimeout(() => {
        const insertedWrapper = document.getElementById(miniNoteId);
        if (insertedWrapper) {
            const titleArea = insertedWrapper.querySelector('.mini-note-title-input');
            if (titleArea) {
                titleArea.focus();
                // Se a configura√ß√£o estiver ativa, aplicamos o comportamento de wrap
                if (appSettings.showFullTitles) {
                    titleArea.classList.add('wrap-enabled');
                    titleArea.addEventListener('input', () => autoResizeTitle(titleArea));
                    autoResizeTitle(titleArea);
                }
            } else {
                const contentDiv = insertedWrapper.querySelector('.mini-note-content');
                if (contentDiv) contentDiv.focus();
            }
            insertedWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 50);
    
    saveNote();
}


// ====================================================================
// L√ìGICA DE IDEIAS (üí°)
// ====================================================================

// 1. CRIAR IDEIA (No evento do Selection Popup)
// Adicione este bloco dentro do listener existente 'selectionPopup.addEventListener' 
// Pode copiar este bloco e colocar junto aos outros 'else if' desse listener, ou adicionar separado se preferir
selectionPopup.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // ------------------------------------------
    // A√á√ÉO 1: CRIAR CART√ÉO WEB (üé¥) - NOVO!
    // ------------------------------------------
    if (action === 'create-url-card') {
        // Chama a fun√ß√£o auxiliar que cri√°mos para lidar com a API e o HTML
        await convertSelectionToUrlCard();
        
        // Fecha o popup
        selectionPopup.style.display = 'none';
        window.getSelection().removeAllRanges();
        currentSelectionRange = null;
        return; 
    }

    // ------------------------------------------
    // A√á√ÉO 2: CRIAR IDEIA (üí°)
    // ------------------------------------------
    else if (action === 'create-idea') {
        // Tenta recuperar a sele√ß√£o global guardada
        if (!currentSelectionRange) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0).cloneRange();
        }

        if (!currentSelectionRange) return;

        const text = currentSelectionRange.toString();
        if (!text.trim()) return;

        try {
            // Gravar no Firebase
            const ideaRef = await addDoc(collection(db, 'ideias'), {
                texto: text,
                origemNoteId: selectedNoteId,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Criar o SPAN visual vermelho
            const span = document.createElement('span');
            span.className = 'idea-span';
            span.dataset.ideaId = ideaRef.id;
            span.setAttribute('spellcheck', 'false');
            span.textContent = text;

            // Substitui√ß√£o
            currentSelectionRange.deleteContents();
            currentSelectionRange.insertNode(span);

            // Inserir espa√ßo invis√≠vel depois para n√£o prender o cursor
            const space = document.createTextNode('\u00A0');
            if (span.nextSibling) {
                span.parentNode.insertBefore(space, span.nextSibling);
            } else {
                span.parentNode.appendChild(space);
            }

            // Move cursor para fora
            const newRange = document.createRange();
            newRange.setStartAfter(space);
            newRange.collapse(true);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(newRange);

            saveNote();

        } catch (error) {
            console.error("Erro ao criar ideia:", error);
            alert("Erro ao criar ideia.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 3: CRIAR LINK / EDITAR LINK (üîó)
    // ------------------------------------------
    else if (action === 'create-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        // Verifica se j√° estamos dentro de um link
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }

        if (linkElement) {
            // Modo Edi√ß√£o
            openLinkModal(true, { 
                id: linkElement.dataset.anexoId, 
                title: linkElement.textContent, 
                url: linkElement.href 
            });
        } else {
            // Modo Cria√ß√£o
            if (currentSelectionRange) {
                const selectedText = currentSelectionRange.toString().trim();
                openLinkModal(false, selectedText);
            } else {
                alert("Por favor, selecione o texto novamente.");
            }
        }
    }

    // ------------------------------------------
    // A√á√ÉO 4: REMOVER LINK (‚õìÔ∏è‚Äçüí•)
    // ------------------------------------------
    else if (action === 'break-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }
        
        if (linkElement) {
            // Abre modal em modo edi√ß√£o (que tem o bot√£o remover)
            openLinkModal(true, { id: linkElement.dataset.anexoId });
        } else {
            alert("O cursor n√£o est√° sobre um anexo.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 5: CRIAR ENTIDADE (üìç, üë§, üìÖ, üìñ)
    // ------------------------------------------
    else if (action === 'create-entity') {
        const type = btn.dataset.type; // ex: 'local', 'personagem'
        const selectedText = currentSelectionRange ? currentSelectionRange.toString().trim() : "";

        if(selectedText) {
            openEntityModal(type, selectedText);
        } else {
            alert("Selecione texto para criar uma entidade.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 6: CRIAR POST-IT (üìí)
    // ------------------------------------------
    else if (action === 'highlight') { 
        if (!currentSelectionRange) {
            // Tenta obter do window se a global falhar
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0);
        }

        const selectedText = currentSelectionRange ? currentSelectionRange.toString() : ""; 

        if (!selectedText.trim()) {
            alert("Selecione algum texto para criar um post-it.");
        } else {
            // Cria o Container
            const container = document.createElement('div');
            container.className = 'post-it-note active-note';
            container.contentEditable = "false";
            
            // Posi√ß√£o (perto do scroll atual)
            const scrollTop = noteContentEditor.scrollTop;
            container.style.top = (scrollTop + 50) + 'px'; 
            container.style.left = '50px';
            container.id = 'postit_' + Date.now();

            // Puxador
            const handle = document.createElement('div');
            handle.className = 'post-it-drag-handle';
            handle.innerHTML = '‚ú•';
            handle.contentEditable = "false"; 

            // Bot√£o Cortar (Tesoura)
            const cutBtn = document.createElement('div');
            cutBtn.className = 'post-it-cut-btn';
            cutBtn.title = "Reverter para texto normal";
            cutBtn.innerHTML = '‚úÇÔ∏è';
            cutBtn.contentEditable = "false";

            // Conte√∫do
            const content = document.createElement('div');
            content.className = 'post-it-content';
            content.contentEditable = "true"; 
            content.innerHTML = selectedText; // Usa innerHTML para manter formata√ß√£o b√°sica

            container.appendChild(handle);
            container.appendChild(cutBtn);
            container.appendChild(content);

            // Remove o texto original e insere o post-it
            currentSelectionRange.deleteContents();
            noteContentEditor.appendChild(container);
            
            saveNote(); 
        }
    }

    // ------------------------------------------
    // FINALIZA√á√ÉO (Limpeza Comum)
    // ------------------------------------------
    selectionPopup.style.display = 'none';
    window.getSelection().removeAllRanges();
    currentSelectionRange = null; 
});





function validateAndCleanBiblicalLinks() {
    
    const biblicalBooksPattern = `${BIBLICAL_BOOKS.join('|')}`;

    // =======================================================
    // AQUI ESTAVA O ERRO PERSISTENTE - ESTA √â A REGEX CORRETA E RIGOROSA
    // =======================================================
    const validPattern = new RegExp(`^${biblicalBooksPattern}\\s+\\d+:\\d[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    


    let domChanged = false;

    links.forEach((link, index) => {
        const originalText = link.textContent;
        const trimmedText = originalText.trim();
        

        if (!validPattern.test(trimmedText)) {
            
            const textNode = document.createTextNode(originalText);
            link.parentNode.replaceChild(textNode, link);

            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(textNode, textNode.length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            domChanged = true;
        } else {
        }
    });

    if (domChanged) {
    } else {
    }
    
    return domChanged;
}



/**
 * Percorre o editor para remover caracteres invis√≠veis (como o Zero-Width Space)
 * que podem ter sido deixados por outras opera√ß√µes, garantindo que a l√≥gica de 
 * reconhecimento de entidades funcione em texto limpo.
 * A posi√ß√£o do cursor √© cuidadosamente preservada.
 */
function cleanupInvisibleCharacters() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) return;

    // Salva a posi√ß√£o original do cursor
    const originalRange = selection.getRangeAt(0);
    let originalContainer = originalRange.startContainer;
    let originalOffset = originalRange.startOffset;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        nodesToProcess.push(node);
    }
    
    const ZWSP = /\u200B/g; // Regex para o caractere invis√≠vel (Zero-Width Space)

    for (const textNode of nodesToProcess) {
        if (ZWSP.test(textNode.textContent)) {
            // Se o cursor estiver neste n√≥, ajustamos a sua posi√ß√£o futura
            if (textNode === originalContainer) {
                // Conta quantos caracteres invis√≠veis existem ANTES da posi√ß√£o do cursor
                const charsToRemoveBeforeCursor = (textNode.textContent.substring(0, originalOffset).match(ZWSP) || []).length;
                originalOffset -= charsToRemoveBeforeCursor;
            }
            // Remove todos os caracteres invis√≠veis do n√≥ de texto
            textNode.textContent = textNode.textContent.replace(ZWSP, '');
        }
    }

    // Normaliza o editor para juntar n√≥s de texto que possam ter sido separados
    noteContentEditor.normalize();

    // Restaura a posi√ß√£o do cursor, garantindo que o n√≥ ainda existe
    try {
        const newRange = document.createRange();
        // Verifica se o container original ainda faz parte do documento
        if (document.body.contains(originalContainer)) {
             // Garante que a posi√ß√£o n√£o exceda o novo comprimento do texto
            const newOffset = Math.min(originalOffset, originalContainer.textContent.length);
            newRange.setStart(originalContainer, newOffset);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
        }
    } catch (e) {
        console.error("Erro ao restaurar a posi√ß√£o do cursor ap√≥s a limpeza:", e);
    }
}




 // ===================================================================
// FUN√á√ÉO SCANANDLINKENTITIES - VERS√ÉO COM REGEX CORRIGIDA
// ===================================================================
 async function scanAndLinkEntities() {
    const logStyles = {
        header: 'color: white; background-color: #1abc9c; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;',
        automation: 'color: white; background-color: #8e44ad; font-weight: bold; padding: 2px 5px; border-radius: 3px;'
    };


    noteContentEditor.normalize();
    
    // --- CORRE√á√ÉO AQUI ---
    const hasCleanedLinks = await validateAndCleanBiblicalLinks(); 
    // ---------------------

    if (hasCleanedLinks) {
        updateSaveStatus('unsaved');
        saveNote(); 
        console.groupEnd();
        return; 
    } else {
    }

    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
        console.groupEnd();
        return;
    }
    const originalRange = selection.getRangeAt(0).cloneRange();

    console.group('%cFASE 1: Liga√ß√£o de Formato Padr√£o (Livro C:V)', logStyles.phase);
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const standardBiblicalRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'giu');
    

    let domModified = false;
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) {
            nodesToProcess.push(node);
        }
    }

    for (const textNode of nodesToProcess) {
        standardBiblicalRegex.lastIndex = 0;
        let match;
        if ((match = standardBiblicalRegex.exec(textNode.textContent)) !== null) {
            domModified = true;
            
            const matchedName = match[1].trim(); 
            const cleanedName = matchedName.replace(/[.,;]+$/, '');

            const matchStartIndex = match.index;
            
            textNode.splitText(matchStartIndex + matchedName.length);
            let matchNode = textNode.splitText(matchStartIndex);
            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = 'textobiblico';
            span.dataset.entityName = cleanedName;
            span.textContent = cleanedName;
            matchNode.parentNode.replaceChild(span, matchNode);
            
            const allExistingEntities = Object.values(allEntities).flat();
            let entity = allExistingEntities.find(e => e.tipo === 'textobiblico' && e.nome.toLowerCase() === cleanedName.toLowerCase());
            
            if (!entity) {
                console.group('%c[Automa√ß√£o] Nova Entidade B√≠blica Detetada', logStyles.automation);
                const collectionName = ENTITY_CONFIG['textobiblico'].collection;

                try {
                    await addDoc(collection(db, collectionName), { 
                        nome: cleanedName, 
                        descricao: "", 
                        userId: auth.currentUser.uid, 
                        createdAt: serverTimestamp(), 
                        referencias: { [selectedNoteId]: true } 
                    });

                } catch (error) {
                    console.error(`%c  - ERRO: Falha ao criar a entidade autom√°tica na base de dados.`, 'color: red; font-weight: bold;', error);
                } finally {
                    await fetchAllEntities(); 
                    console.groupEnd(); 
                }
            }
            break; 
        }
    }
    console.groupEnd(); 
    
    if (domModified) {
        selection.removeAllRanges();
        selection.addRange(originalRange);
        updateSaveStatus('unsaved');
        saveNote();
    }
}





function maintainEntityProtection() {
    const entityLinks = noteContentEditor.querySelectorAll('.entity-link');
    let domModified = false;

    entityLinks.forEach(link => {
        const parent = link.parentNode;
        let needsProtectionBefore = true;
        let needsProtectionAfter = true;

        // Verifica o que existe ANTES do link
        if (link.previousSibling && link.previousSibling.nodeType === Node.TEXT_NODE && link.previousSibling.textContent.endsWith('\u200B')) {
            needsProtectionBefore = false;
        }

        // Verifica o que existe DEPOIS do link
        if (link.nextSibling && link.nextSibling.nodeType === Node.TEXT_NODE && link.nextSibling.textContent.startsWith('\u200B')) {
            needsProtectionAfter = false;
        }

        // Se faltar prote√ß√£o antes, adiciona-a
        if (needsProtectionBefore) {
            const zeroWidthSpace = document.createTextNode('\u200B');
            parent.insertBefore(zeroWidthSpace, link);
            domModified = true;
        }

        // Se faltar prote√ß√£o depois, adiciona-a
        if (needsProtectionAfter) {
            const zeroWidthSpace = document.createTextNode('\u200B');
            // insertBefore √© usado para inserir depois, passando o "irm√£o" seguinte como refer√™ncia
            parent.insertBefore(zeroWidthSpace, link.nextSibling);
            domModified = true;
        }
    });

    if (domModified) {
        // A normaliza√ß√£o junta n√≥s de texto adjacentes, limpando o c√≥digo
        noteContentEditor.normalize();
    }
}


    async function validateAndReconcileAllEntities() {
    // Estilos para os logs na consola
    const logStyles = {
        header: 'color: white; background-color: #00a8ff; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;'
    };

    console.groupCollapsed('%c[Reconcilia√ß√£o] Iniciando verifica√ß√£o completa de entidades...', logStyles.header);

    // ETAPA 1: Preservar a posi√ß√£o do cursor
    const selection = window.getSelection();
    let cursorMarker = null;
    let originalRange = null;
    if (selection && selection.rangeCount > 0) {
        originalRange = selection.getRangeAt(0).cloneRange();
        if (selection.isCollapsed) {
            cursorMarker = document.createElement('span');
            cursorMarker.id = 'cursor-marker'; // A nossa "bandeira"
            try {
                originalRange.insertNode(cursorMarker);
            } catch (e) {
                console.warn('  - N√£o foi poss√≠vel inserir o marcador de cursor. A sele√ß√£o pode estar num local inv√°lido.', e);
                cursorMarker = null; // Garante que n√£o tentaremos encontr√°-lo mais tarde
            }
        } else {
        }
    } else {
    }
    
    // ETAPA 2: Varrer e corrigir
    const allKnownEntities = Object.values(allEntities).flat();
    if (!allKnownEntities || allKnownEntities.length === 0) {
        // Ainda assim, remove o marcador se ele foi inserido
        if (cursorMarker) cursorMarker.parentNode.removeChild(cursorMarker);
        console.groupEnd();
        return;
    }


    let keepLooping = true;
    let pass = 0;
    while (keepLooping) {
        pass++;
        keepLooping = false; // Assume que esta ser√° a √∫ltima passagem, a menos que uma altera√ß√£o seja feita
        
        const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
        const nodesToProcess = [];
        let n;
        while (n = walker.nextNode()) {
            nodesToProcess.push(n);
        }


        for (const node of nodesToProcess) {
            // Ignora n√≥s que j√° est√£o dentro de elementos especiais para evitar trabalho desnecess√°rio
            if (!node.parentElement || node.parentElement.closest('.entity-link, .tag, a, #cursor-marker')) {
                continue;
            }

            for (const entity of allKnownEntities) {
                // A l√≥gica de textos b√≠blicos √© tratada noutra fun√ß√£o, por isso ignoramo-la aqui.
                if (entity.tipo === 'textobiblico') continue;
                
                const entityName = entity.nome;
                // Usa uma RegEx com `\b` (word boundary) para encontrar a palavra exata
                const regex = new RegExp(`\\b(${escapeRegExp(entityName)})\\b`);
                
                if (regex.test(node.textContent)) {


                    // Divide o n√≥ de texto em tr√™s partes: antes, durante e depois da correspond√™ncia
                    const matchIndex = node.textContent.search(regex);
                    node.splitText(matchIndex + entityName.length); // Divide depois
                    const matchNode = node.splitText(matchIndex); // Divide antes
                    
                    // Cria o novo elemento <span> para a entidade
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = entity.tipo;
                    span.dataset.entityName = entity.nome;
                    span.textContent = entity.nome;
                    
                    // Substitui o n√≥ de texto (que agora cont√©m apenas o nome da entidade) pelo <span> formatado
                    matchNode.parentNode.replaceChild(span, matchNode);
                    
                    keepLooping = true; // For√ßa uma nova passagem porque o DOM foi alterado
                    break; // Sai do loop de entidades
                }
            }
            if (keepLooping) break; // Sai do loop de n√≥s para reiniciar a passagem
        }
        if (!keepLooping) {
        }
    }
    
    // ETAPA 3: Restaurar a posi√ß√£o do cursor
    const markerInDom = document.getElementById('cursor-marker');
    if (markerInDom) {
        const newRange = document.createRange();
        // Colocamos o cursor ANTES da √¢ncora para que ele fique na posi√ß√£o correta
        newRange.setStartBefore(markerInDom);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);
        // Removemos a √¢ncora depois de a usarmos
        markerInDom.parentNode.removeChild(markerInDom);
    } else if (originalRange) {
        // Fallback: se n√£o t√≠nhamos uma √¢ncora (ex: sele√ß√£o de texto), restauramos o range original
        selection.removeAllRanges();
        selection.addRange(originalRange);
    } else {
    }
    
    console.groupEnd();
}

function requestPassword(mode, itemId) {
    return new Promise((resolve) => {
        const modal = document.getElementById('password-modal');
        const input = document.getElementById('password-input');
        const confirmBtn = document.getElementById('password-confirm-btn');
        const cancelBtn = document.querySelector('#password-modal [data-action="cancel"]');
        const errorMsg = document.getElementById('password-error');

        if (!modal) return resolve(null);

        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "10000000";

        input.value = '';
        if (errorMsg) errorMsg.style.display = 'none';

        const title = document.getElementById('password-modal-title');
        const desc = document.getElementById('password-modal-desc');

        if (mode === 'create') {
            title.textContent = 'Definir Prote√ß√£o';
            desc.textContent = 'Escolha uma palavra-passe para este item.';
        } else {
            title.textContent = 'Item Protegido';
            desc.textContent = 'Insira a palavra-passe para aceder.';
        }

        setTimeout(() => input.focus(), 200);

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const cleanup = (value) => {
            modal.style.display = 'none';
            resolve(value);
        };

    newConfirmBtn.onclick = async (e) => {
    e.preventDefault();
    const pass = input.value.trim();
    if (!pass) return;

    if (mode === 'create') {
        cleanup(pass);
    } else {
        // MODO ACESSO ou REMOVE
        try {
            const docRef = doc(db, 'pastas', itemId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists() && docSnap.data().passe === pass) {
                if (mode === 'remove') {
                    // SE FOR PARA REMOVER, APAGA O CAMPO NO FIREBASE
                    await updateDoc(docRef, {
                        passe: deleteField() 
                    });
                }
                cleanup(true);
            } else {
                if (errorMsg) errorMsg.style.display = 'block';
                input.value = '';
                input.focus();
            }
        } catch (err) {
            console.error(err);
            cleanup(false);
        }
    }
};

        if (cancelBtn) cancelBtn.onclick = () => cleanup(null);
    });
}

// --- FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS ---

function showContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const item = e.target.closest('.list-item');
    if (!item) return;

    const menu = document.getElementById('context-menu');
    const myUid = auth.currentUser.uid;
    
    // Captura os dados do item
    activeItemContext = {
        id: item.dataset.id,
        name: item.dataset.name,
        type: item.dataset.type,
        emoji: item.dataset.emoji,
        parentId: item.dataset.parentId === "null" ? null : item.dataset.parentId,
        isSuperfolder: item.dataset.superpasta === "true",
        isPinned: item.dataset.pinned === "true",
        isProtected: item.dataset.protected === "true",
        userId: item.dataset.userid || myUid
    };

    // 1. Esconde tudo para come√ßar do zero
    menu.querySelectorAll('button').forEach(b => b.style.display = 'none');
    menu.querySelectorAll('.menu-sep').forEach(d => d.style.display = 'none');

    // 2. REGRAS PARA COSMOS (Temas/Subtemas)
    if (activeItemContext.type === 'cosmos-parent' || activeItemContext.type === 'subcosmos') {
        menu.querySelector('[data-action="rename"]').style.display = 'block';
        const iconBtn = menu.querySelector('[data-action="change-cosmos-emoji"]');
        if (iconBtn) iconBtn.style.display = 'block';
        menu.querySelector('.menu-sep').style.display = 'block';
        menu.querySelector('[data-action="hide"]').style.display = 'block';
    } 
    // 3. REGRAS PARA PASTAS, NOTAS E ARQUIVOS
    else {
        // Op√ß√µes Universais
        menu.querySelector('[data-action="rename"]').style.display = 'block';
        menu.querySelector('[data-action="hide"]').style.display = 'block';

        // Op√ß√µes Exclusivas do MODO LOCAL
        if (currentViewMode === 'local' || currentViewMode === 'pins') {
            // Grupo 1: Pin e Prote√ß√£o
            menu.querySelector('[data-action="toggle-pin"]').style.display = 'block';
            menu.querySelector('[data-action="toggle-pin"]').textContent = activeItemContext.isPinned ? "Remover Pin" : "Adicionar Pin";
            
            const protectBtn = menu.querySelector('[data-action="protect"]');
            const unprotectBtn = menu.querySelector('[data-action="unprotect"]');
            if (activeItemContext.isProtected) unprotectBtn.style.display = 'block';
            else protectBtn.style.display = 'block';

            // Grupo 2: Movimenta√ß√£o
            menu.querySelector('[data-action="move-position"]').style.display = 'block';
            menu.querySelector('[data-action="move-folder"]').style.display = 'block';

            // Grupo 3: T√≥picos e Superpastas (AQUI ESTAVAM AS QUE FALTAREVM)
            menu.querySelector('[data-action="manage-topics"]').style.display = 'block';
            
            // S√≥ mostra op√ß√µes de Superpasta se for uma PASTA
            if (activeItemContext.type === 'pasta') {
                const superBtn = menu.querySelector('[data-action="toggle-superfolder"]');
                if (superBtn) {
                    superBtn.style.display = 'block';
                    superBtn.textContent = activeItemContext.isSuperfolder ? "Tornar Pasta Normal" : "Tornar Superpasta";
                }
                
                // Se j√° for superpasta, permite mudar o icon
                if (activeItemContext.isSuperfolder) {
                    const iconBtn = menu.querySelector('[data-action="change-icon"]');
                    if (iconBtn) iconBtn.style.display = 'block';
                }
            }

            // Ativa os separadores visuais
            menu.querySelectorAll('.menu-sep').forEach(sep => sep.style.display = 'block');
        }
    }

    // --- POSICIONAMENTO INTELIGENTE ---
    menu.style.opacity = "0";
    menu.style.display = 'flex';
    menu.style.position = 'fixed';
    menu.style.zIndex = "10000000";

    const menuWidth = menu.offsetWidth;
    const menuHeight = menu.offsetHeight;
    let posX = e.clientX;
    let posY = e.clientY;

    if (posX + menuWidth > window.innerWidth) posX = window.innerWidth - menuWidth - 10;
    if (posY + menuHeight > window.innerHeight) posY = window.innerHeight - menuHeight - 10;

    menu.style.left = `${posX}px`;
    menu.style.top = `${posY}px`;
    menu.style.opacity = "1";
}



function hideContextMenu() {
    document.getElementById('context-menu').style.display = 'none';
    activeItemContext = null;
}



function showConfirmation(title, message) {
    const modal = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    modal.style.display = 'flex';

    return new Promise(resolve => {
        const confirmBtn = modal.querySelector('[data-action="confirm"]');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');

        const onConfirm = () => {
            modal.style.display = 'none';
            resolve(true); // <--- ISTO D√Å A√á√ÉO AO BOT√ÉO
        };

        const onCancel = () => {
            modal.style.display = 'none';
            resolve(false);
        };

        // Usa {once: true} para n√£o acumular cliques
        confirmBtn.onclick = onConfirm;
        cancelBtn.onclick = onCancel;
    });
}

async function updateTagLink(tagName, noteId, shouldExist) {
    const tag = allTags.find(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tag) {
        console.error(`Tag "${tagName}" n√£o encontrada no cache para atualiza√ß√£o.`);
        return;
    }
    const tagRef = doc(db, 'tags', tag.id);
    const updateData = {};
    if (shouldExist) {
        updateData[`notas.${noteId}`] = true;
    } else {
        updateData[`notas.${noteId}`] = deleteField();
    }
    try {
        await updateDoc(tagRef, updateData);
    } catch (error) {
        console.error(`Erro ao atualizar v√≠nculo da tag "${tagName}":`, error);
    }
}

// --- L√ìGICA DE MODAIS E PAIN√âIS ADICIONAIS ---

async function openMoveModal(itemContext) {
    if (!itemContext) return;

    const modal = document.getElementById('move-item-modal');
    const list = document.getElementById('move-list');
    
    list.innerHTML = '<li style="padding:10px;">Carregando...</li>';
    modal.style.display = 'flex';
    
    try {
        let pId = itemContext.parentId;

        // SEURAN√áA PARA SUPERPASTAS: 
        // Se pId for null mas o itemContext n√£o tiver essa info, vamos validar no Firebase
        if (pId === undefined) {
            const docSnap = await getDoc(doc(db, 'pastas', itemContext.id));
            if (docSnap.exists()) {
                pId = docSnap.data().parentId;
            }
        }

        // Query: Busca todos os itens que t√™m o MESMO pai que o item clicado
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', pId), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('ordem')
        );
        
        const snapshot = await getDocs(q);
        let items = [];
        snapshot.forEach(doc => {
            items.push({ id: doc.id, ...doc.data() });
        });

        if (items.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum item encontrado nesta localiza√ß√£o.</li>';
        } else {
            renderMoveList(items);
        }

    } catch (error) {
        console.error("Erro ao carregar itens para mover:", error);
        list.innerHTML = '<li style="padding:10px; color:#e74c3c;">Erro ao carregar dados.</li>';
    }
}

// --- NOVA FUN√á√ÉO PARA GERIR O MODAL "MOVER DE PASTA" ---
 async function openMoveToFolderModal(itemContext) {
    if (!itemContext) return;

    itemToMoveRef = itemContext; // { id, name, parentId, type... }
    const modal = document.getElementById('move-to-folder-modal');
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const nameSpan = document.getElementById('item-to-move-name');
    
    // Atualiza o nome no t√≠tulo
    if(nameSpan) nameSpan.textContent = itemContext.name;

    // --- CONFIGURA√á√ÉO DA BARRA DE NAVEGA√á√ÉO (BREADCRUMBS) ---
    // Verifica se j√° cri√°mos a barra de navega√ß√£o personalizada. Se n√£o, cria agora.
    let navContainer = document.getElementById('move-folder-nav-container');
    
    if (!navContainer) {
        // Remove elementos antigos de descri√ß√£o para limpar a vista
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        // Cria a nova barra igual √† do bot√£o üß¨
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        `;
        
        // Insere antes da lista
        list.parentNode.insertBefore(navContainer, list);
        
        // Listener do bot√£o Voltar
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : rootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(rootId);
            }
        });
    }

    // Reset da navega√ß√£o
    moveStack = []; 
    selectedDestFolderId = null; // Reseta a sele√ß√£o
    
    modal.style.display = 'flex';

    // Determina o in√≠cio (Raiz Global ou Superpasta)
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    // Carrega a lista inicial
    loadMoveFolderList(startRootId);

    // --- RECONFIGURAR BOT√ÉO CONFIRMAR ---
   const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        let targetId = selectedDestFolderId;
        
        // (L√≥gica de fallback se n√£o selecionar nada...)
        if (targetId === null) {
            const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
            const currentViewId = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : startRootId;
            if(!confirm(`Mover "${itemContext.name}" para a pasta que est√° a ver agora?`)) return;
            targetId = currentViewId;
        }

 if (targetId === itemContext.id) {
            alert("N√£o pode mover uma pasta para dentro de si mesma.");
            return;
        }

        try {
            const itemRef = doc(db, 'pastas', itemContext.id);
            
            // ATUALIZA A LOCALIZA√á√ÉO
            await updateDoc(itemRef, {
                parentId: targetId, 
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
        
            // 1. Verifica se estamos a mover a nota que est√° aberta no editor
           // >>> ADICIONE ESTES LOGS AQUI <<<

// Verifica se s√£o iguais (tenta converter para string para garantir)
const isMovingCurrentNote = (String(itemContext.id) === String(selectedNoteId));



            
            // 2. Chama a atualiza√ß√£o da vista
            if (typeof updateNavigationView === 'function') {

    updateNavigationView(isMovingCurrentNote);
}
            
        } catch (error) {
            console.error("Erro ao mover:", error);
            alert("Erro ao mover o item.");
        }
    };
}

// ============================================================
// 2. CARREGAR LISTA (VISUAL IGUAL AO üß¨)
// ============================================================
async function loadMoveFolderList(parentId, isLoadMore = false) {
    const list = document.getElementById('folder-selection-list');
    const navContainer = document.getElementById('move-folder-nav-container');
    const backBtn = document.getElementById('move-folder-back-btn');
    const pathLabel = document.getElementById('move-folder-path');
    const LOAD_LIMIT = 15;

    // 1. MOSTRAR A BARRA DE NAVEGA√á√ÉO (Para saber onde estamos)
    if (navContainer) {
        navContainer.style.display = 'flex';
    }

    // Se N√ÉO for "Carregar Mais", √© uma navega√ß√£o nova (limpar tudo)
    if (!isLoadMore) {
        list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
        moveFolderLastDoc = null; // Reset do cursor
        
        // Atualiza o Texto do Topo (Breadcrumbs)
        if (moveStack.length > 0) {
            pathLabel.textContent = moveStack[moveStack.length - 1].name;
            backBtn.style.display = 'block';
        } else {
            pathLabel.textContent = parentId ? "Pasta Atual" : "Raiz (N√≠vel 1)";
            backBtn.style.display = 'none';
        }
    } else {
        const oldBtn = document.getElementById('move-folder-load-more');
        if (oldBtn) oldBtn.remove();
    }

    try {
        // --- QUERY HIER√ÅRQUICA (Filtra por Pasta Pai) ---
        let constraints = [
            collection(db, 'pastas'),
            where('parentId', '==', parentId), // O SEGREDO: S√≥ carrega filhos desta pasta
            where('tipo', '==', 'pasta'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome'),
            limit(LOAD_LIMIT)
        ];

        // Pagina√ß√£o
        if (isLoadMore && moveFolderLastDoc) {
            constraints.push(startAfter(moveFolderLastDoc));
        }

        const q = query(...constraints);
        const snapshot = await getDocs(q);

        // Se for o in√≠cio, limpa e adiciona a op√ß√£o "Ficar Aqui"
        if (!isLoadMore) {
            list.innerHTML = '';

            // --- OP√á√ÉO 1: SELECIONAR A PASTA ATUAL ONDE ESTAMOS ---
            const currentLi = document.createElement('li');
            currentLi.className = 'list-item';
            currentLi.style.fontWeight = 'bold';
            currentLi.style.borderBottom = '2px solid var(--border-color)';
            currentLi.style.color = 'var(--accent-color)';
            currentLi.style.padding = '12px';
            currentLi.style.cursor = 'pointer';
            
            // Texto din√¢mico: Se estamos na raiz diz "Raiz", se n√£o diz o nome da pasta
            const currentName = moveStack.length > 0 ? moveStack[moveStack.length - 1].name : "Raiz Principal";
            currentLi.innerHTML = `üì• Guardar nesta pasta: <u>${currentName}</u>`;
            
            currentLi.onclick = () => {
                handleMoveSelection(currentLi, parentId);
            };
            list.appendChild(currentLi);

            if (snapshot.empty) {
                const emptyLi = document.createElement('li');
                emptyLi.textContent = "Sem subpastas. (Pode guardar aqui)";
                emptyLi.style.padding = "10px";
                emptyLi.style.color = "var(--text-muted-color)";
                list.appendChild(emptyLi);
                return;
            }
        }

        // Atualiza o cursor
        const lastVisible = snapshot.docs[snapshot.docs.length - 1];
        if (lastVisible) {
            moveFolderLastDoc = lastVisible;
        }

        // --- RENDERIZA√á√ÉO DA LISTA ---
     snapshot.forEach(doc => {
            if (itemToMoveRef && doc.id === itemToMoveRef.id) return;

            const folder = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            
            li.className = 'list-item move-folder-item';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.padding = '12px';
            li.style.borderBottom = '1px solid var(--border-color)';
            li.style.cursor = 'pointer';

            // DIVIDIDO EM DUAS √ÅREAS:
            li.innerHTML = `
                <div class="move-select-area" style="flex-grow:1; display:flex; align-items:center;" title="Clique para selecionar esta pasta">
                    <!-- CORRE√á√ÉO AQUI: flex: none !important impede o √≠cone de esticar -->
                    <span style="font-size:1.2em; margin-right:10px; flex: none !important;">üìÅ</span>
                    <span>${folder.nome}</span>
                </div>
                <div class="move-nav-btn" style="padding: 5px 15px; border-left:1px solid var(--border-color); color:var(--text-muted-color); font-weight:bold;" title="Entrar na pasta">
                    ‚ûî
                </div>
            `;

            // ... resto dos listeners de clique (mant√™m-se iguais) ...
            const selectArea = li.querySelector('.move-select-area');
            selectArea.onclick = (e) => {
                e.stopPropagation();
                handleMoveSelection(li, folder.id);
            };

            const navBtn = li.querySelector('.move-nav-btn');
            navBtn.onclick = (e) => {
                e.stopPropagation();
                moveStack.push({ id: folder.id, name: folder.nome });
                loadMoveFolderList(folder.id, false);
            };
            
            navBtn.onmouseover = () => { navBtn.style.color = 'var(--accent-color)'; navBtn.style.backgroundColor = 'var(--hover-color)'; };
            navBtn.onmouseout = () => { navBtn.style.color = 'var(--text-muted-color)'; navBtn.style.backgroundColor = 'transparent'; };

            list.appendChild(li);
        });

        // --- BOT√ÉO CARREGAR MAIS ---
        if (snapshot.docs.length === LOAD_LIMIT) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'move-folder-load-more';
            loadMoreBtn.textContent = "Carregar mais subpastas...";
            loadMoreBtn.style.width = "100%";
            loadMoreBtn.style.padding = "10px";
            loadMoreBtn.style.marginTop = "5px";
            loadMoreBtn.style.background = "none";
            loadMoreBtn.style.border = "1px dashed var(--text-muted-color)";
            loadMoreBtn.style.color = "var(--text-muted-color)";
            loadMoreBtn.style.cursor = "pointer";
            
            loadMoreBtn.onclick = () => {
                loadMoreBtn.textContent = "A carregar...";
                loadMoveFolderList(parentId, true); // Mant√©m o mesmo n√≠vel, carrega mais
            };

            list.appendChild(loadMoreBtn);
        }

    } catch (e) {
        console.error(e);
        if (!isLoadMore) list.innerHTML = '<li>Erro ao carregar pastas.</li>';
    }
}


// --- FUN√á√ÉO AUXILIAR DE SELE√á√ÉO VISUAL ---
function handleMoveSelection(liElement, folderId) {
    // 1. Remove sele√ß√£o de todos
    const list = document.getElementById('folder-selection-list');
    list.querySelectorAll('li').forEach(el => {
        el.style.backgroundColor = 'transparent';
        el.classList.remove('selected');
    });

    // 2. Seleciona o atual
    liElement.classList.add('selected');
    liElement.style.backgroundColor = 'var(--selected-color)'; // Usa a cor do seu tema
    
    // 3. Atualiza vari√°vel de estado
    selectedDestFolderId = folderId;
}

function renderMoveList(items) {
    const list = document.getElementById('move-list');
    list.innerHTML = '';

    items.forEach((item, index) => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        
        // Determina o √≠cone
        const icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';

        li.innerHTML = `
            <span>${icon} ${item.nome}</span>
            <div class="order-controls">
                <button data-action="up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button data-action="down" ${index === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
            </div>
        `;
        list.appendChild(li);
    });

    // Delegar cliques nas setas
    list.onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const currentLi = btn.closest('li');
        const currentIndex = Array.from(list.children).indexOf(currentLi);
        const action = btn.dataset.action;

        if (action === 'up' && currentIndex > 0) {
            // Troca no array
            [items[currentIndex], items[currentIndex - 1]] = [items[currentIndex - 1], items[currentIndex]];
        } else if (action === 'down' && currentIndex < items.length - 1) {
            // Troca no array
            [items[currentIndex], items[currentIndex + 1]] = [items[currentIndex + 1], items[currentIndex]];
        }
        
        // Re-renderiza a lista localmente
        renderMoveList(items);
    };

    // Configurar o bot√£o "Salvar Ordem"
    const saveBtn = document.querySelector('#move-item-modal [data-action="save-order"]');
    saveBtn.onclick = async () => {
        saveBtn.disabled = true;
        saveBtn.textContent = "A guardar...";

        const batch = writeBatch(db);
        
        items.forEach((item, index) => {
            const docRef = doc(db, 'pastas', item.id);
            // Atualiza o campo 'ordem' baseado no novo √≠ndice do array
            batch.update(docRef, { 
                ordem: index,
                ultimaedicao: serverTimestamp()
            });
        });

        try {
            await batch.commit();
            document.getElementById('move-item-modal').style.display = 'none';
            // O onSnapshot autom√°tico da lista principal tratar√° de atualizar a vista
        } catch (err) {
            console.error("Erro ao salvar ordem:", err);
            alert("Erro ao salvar nova ordem.");
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = "Salvar Ordem";
        }
    };
}

async function showHiddenItemsModal() {
    const modal = document.getElementById('hidden-items-modal');
    const list = document.getElementById('hidden-items-list');
    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar itens ocultos...</span></div>';
    modal.style.display = 'flex';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'desativa'), 
            where('userId', '==', auth.currentUser.uid) 
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:15px; color:#888; text-align:center;">A reciclagem est√° vazia.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.padding = '10px';
            li.style.borderBottom = '1px solid var(--border-color)';

            const icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';

            li.innerHTML = `
                <span class="item-name" style="font-weight:500;">${icon} ${item.nome}</span> 
                <div style="display:flex; gap:10px;">
                    <button class="modal-btn primary" data-action="restore" data-id="${item.id}" style="font-size:0.8em; padding:5px 10px;">Restaurar</button>
                    <button class="modal-btn" data-action="delete" data-id="${item.id}" style="background-color:#c0392b; color:white; font-size:0.8em; padding:5px 10px; border:none; border-radius:5px; cursor:pointer;">Eliminar</button>
                </div>
            `;
            list.appendChild(li);
        });
    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar itens.</li>';
    }
}

function addUrlField(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'url-field-wrapper';
    const urlInput = document.createElement('input');
    urlInput.type = 'text';
    urlInput.placeholder = 'URL da hiperliga√ß√£o';
    urlInput.value = urlValue;
    urlInput.style.flexGrow = '1';
    urlInput.style.padding = '12px';
    urlInput.style.backgroundColor = 'var(--bg-color)';
    urlInput.style.border = '1px solid var(--border-color)';
    urlInput.style.borderRadius = '5px';
    urlInput.style.color = 'var(--text-color)';
    urlInput.style.fontSize = '16px';
    const removeUrlBtn = document.createElement('button');
    removeUrlBtn.textContent = '‚Äì';
    removeUrlBtn.className = 'modal-btn remove-url-btn'; 
    removeUrlBtn.onclick = () => {
        if (container.childElementCount > 1) {
            fieldWrapper.remove();
        } else {
            alert('√â necess√°rio pelo menos um campo de URL.');
        }
    };
    fieldWrapper.appendChild(urlInput);
    fieldWrapper.appendChild(removeUrlBtn);
    container.appendChild(fieldWrapper);
}


// --- FUN√á√ÉO PARA ABRIR/CRIAR VERS√çCULO AUTOMATICAMENTE ---
async function createOrOpenVerse(book, chapter, verse) {
    const fullName = `${book} ${chapter}:${verse}`;
    
    // 1. Verifica se j√° existe no cache local
    const allBibleEntities = allEntities['textobiblico'] || [];
    const existing = allBibleEntities.find(e => e.nome === fullName);

    if (existing) {
        // Se existe, abre o painel
        showReferencesPanel(existing.id, existing.nome, 'textobiblico');
    } else {
        // --- ALTERA√á√ÉO AQUI: Usa o Popup Personalizado em vez do confirm() ---
        const confirmCreate = await showConfirmation(
            "Criar Novo Registo", 
            `O texto "${fullName}" ainda n√£o existe na base de dados.\nDeseja criar agora?`
        );
        
        if (!confirmCreate) return;

        try {
            // Cria no Firebase
            const docRef = await addDoc(collection(db, 'textosbiblicos'), {
                nome: fullName,
                descricao: "",
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                referencias: {} // Come√ßa vazio
            });

            // Adiciona ao cache local para n√£o ter de recarregar a p√°gina
            if (!allEntities['textobiblico']) allEntities['textobiblico'] = [];
            allEntities['textobiblico'].push({
                id: docRef.id,
                nome: fullName,
                tipo: 'textobiblico'
            });

            // Abre o painel
            showReferencesPanel(docRef.id, fullName, 'textobiblico');
            
            // Opcional: Recarregar a lista do meio para o bot√£o ficar verde
            updateNavigationView(true);

        } catch (error) {
            console.error("Erro ao criar vers√≠culo:", error);
            alert("Erro ao criar o registo.");
        }
    }
}

// ============================================================
// L√ìGICA DO PAINEL PUZZLE (4¬™ Coluna)
// ============================================================

// 1. Alternar Abas (Puzzle vs Refer√™ncias)
document.getElementById('ref-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const target = btn.dataset.refTab;
    
    e.currentTarget.querySelectorAll('button').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.ref-tab-content').forEach(el => el.style.display = 'none');
    
    // Mostra o container correto
    const contentEl = document.getElementById(`ref-content-${target}`);
    if (contentEl) {
        contentEl.style.display = (target === 'links' || target === 'puzzle' || target === 'dossie') ? 'flex' : 'block';
    }

    if (target === 'links') renderPanelLinks();
    if (target === 'dossie') {
        activeMicaId = null; // Sempre volta para a lista ao trocar de aba
        isDossieEditMode = false;
        renderDossie();
    }
});

// 2. Bot√£o Editar do Painel
document.getElementById('toggle-links-edit-btn').addEventListener('click', (e) => {
    isPanelEditMode = !isPanelEditMode;
    const btn = e.target;
    const actions = document.getElementById('links-edit-actions');

    if (isPanelEditMode) {
        btn.textContent = "Salvar";
        btn.classList.add('is-active');
        actions.style.display = 'flex';
    } else {
        btn.textContent = "Editar";
        btn.classList.remove('is-active');
        actions.style.display = 'none';
    }
    renderPanelLinks();
});

// 3. Abrir Criadores (Reaproveita os modais existentes com contextos diferentes)
window.openPanelLinkCreator = function(type) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // 1. Configura√ß√£o Visual para ENTIDADE
    urlsContainer.innerHTML = '';
    document.getElementById('codex-rows-container').innerHTML = '';
    document.getElementById('link-remove-btn').style.display = 'none';

    if (type === 'link') {
        modalTitle.textContent = "Documenta√ß√£o: " + activeReferenceEntity.name;
        document.querySelector('[data-box-tab="refs"]').click();
        document.querySelector('[data-box-tab="codex"]').style.display = 'none'; // Esconde Codex
        addUrlField();
    } else {
        modalTitle.textContent = "Codex: " + activeReferenceEntity.name;
        document.querySelector('[data-box-tab="codex"]').click();
        document.querySelector('[data-box-tab="refs"]').style.display = 'none'; // Esconde Links
        window.createCodexRow();
    }

    // 2. LIMPAR MEM√ìRIA DO BOT√ÉO (O SEGREDO)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    // 3. L√≥gica de Gravar da ENTIDADE
    newSaveBtn.onclick = async () => {
        let dataToSave = null;

        if (type === 'link') {
            const urlsMap = {};
            urlsContainer.querySelectorAll('input').forEach((inp, i) => {
                if(inp.value.trim()) urlsMap[`url_${i}`] = inp.value.trim();
            });
            dataToSave = { type: 'link', title: titleInput.value.trim() || "Link", urls: urlsMap };
        } else {
            const row = document.querySelector('.codex-row');
            const rowData = getCodexDataFromRow(row);
            dataToSave = { type: 'codex', ...rowData, total: rowData.serie + (rowData.paginas.length ? `, p√°g. ${rowData.paginas.join(',')}` : '') };
        }

        await saveLinkToEntity(dataToSave); // Usa a tua fun√ß√£o do print!
        modal.style.display = 'none';
        renderPanelLinks(); // Atualiza a lista na 4¬™ coluna
    };

    modal.style.display = 'flex';
};

// 4. Renderizar Lista de Links/Codex da Entidade
async function renderPanelLinks() {
    const container = document.getElementById('panel-links-list');
    container.innerHTML = '';

    if (!activeReferenceEntity.id) return;

    const collectionName = getCollectionFromType(activeReferenceEntity.type);
    const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));

    if (!docSnap.exists() || !docSnap.data().panelLinks) {
        container.innerHTML = '<p style="text-align:center; color:#888; font-size:0.9em; margin-top:20px;">Nenhuma documenta√ß√£o associada.</p>';
        return;
    }

    const links = docSnap.data().panelLinks || [];

    links.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'board-card'; 
        div.style.borderLeft = item.type === 'codex' ? '3px solid #d35400' : '3px solid #795548';
        
        let contentHTML = "";
        if (item.type === 'codex') {
            contentHTML = `<strong>${item.serie}</strong><br><small>${item.total}</small>`;
        } else {
            const urls = item.urls ? Object.values(item.urls) : [item.url];
            const linksList = urls.map(u => 
                `<div style="color:var(--accent-color); cursor:pointer; font-size:0.85em; margin-top:4px; word-break:break-all;" 
                      onclick="window.open('${u}', '_blank')">üîó ${u}</div>`
            ).join('');
            contentHTML = `<strong>${item.title}</strong>${linksList}`;
        }

        // --- BOT√ïES DE MOVIMENTO, EDITAR E REMOVER ---
        div.innerHTML = `
            <div style="font-size:0.9em;">${contentHTML}</div>
            ${isPanelEditMode ? `
                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px; border-top:1px solid var(--border-color); padding-top:5px;">
                    <!-- BOT√ïES DE MOVIMENTO -->
                    <button onclick="movePanelLink(${index}, -1)" ${index === 0 ? 'style="display:none"' : ''} style="background:none; border:none; cursor:pointer; font-size:14px;">üî∫</button>
                    <button onclick="movePanelLink(${index}, 1)" ${index === links.length - 1 ? 'style="display:none"' : ''} style="background:none; border:none; cursor:pointer; font-size:14px;">üîª</button>
                    
                    <div style="flex-grow:1"></div> <!-- Espa√ßador -->

                    <button onclick="window.openPanelLinkCreator('${item.type}', ${index})" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:12px; font-weight:bold;">Editar</button>
                    <button onclick="deletePanelLink(${index})" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:12px; font-weight:bold;">Remover</button>
                </div>
            ` : ''}
        `;
        container.appendChild(div);
    });
}

// 5. Grava√ß√£o de Link do Painel
async function openLinkModalForPanel() {
    // Aqui podes usar um simple prompt ou o teu modal de link
    const title = prompt("T√≠tulo do Link:");
    if (!title) return;
    let url = prompt("URL:");
    if (!url) return;
    if (!url.startsWith('http')) url = 'https://' + url;

    const newLink = { type: 'link', title, url, createdAt: Date.now() };
    await saveLinkToEntity(newLink);
}

// 6. Grava√ß√£o de Codex do Painel (Sincronizado com firebase->codex)
async function openCodexModalForPanel() {
    // Vamos usar a mesma estrutura do createCodexRow para manter consist√™ncia
    // Para simplificar esta resposta, vamos simular a abertura de um modal
    // que recolhe os dados e chama:
    
    const serie = prompt("S√©rie (ex: w24 05):");
    if (!serie) return;
    const pags = prompt("P√°ginas:");
    
    const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // 1. Grava na cole√ß√£o global CODEX
    const codexDoc = await addDoc(collection(db, 'codex'), {
        serie,
        paginas: [pags],
        userId: auth.currentUser.uid,
        entityId: activeReferenceEntity.id,
        entityName: activeReferenceEntity.name,
        timestamp: serverTimestamp()
    });

    // 2. Grava a refer√™ncia no documento da Entidade
    const newCodex = { 
        type: 'codex', 
        id: codexDoc.id, 
        serie, 
        total: `${serie}, p√°g. ${pags}`,
        createdAt: Date.now() 
    };
    
    await saveLinkToEntity(newCodex);
}

async function saveLinkToEntity(linkObj) {
    const { id, type } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    const docRef = doc(db, collectionName, id);
    
    const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    await updateDoc(docRef, {
        panelLinks: arrayUnion(linkObj)
    });
    
    renderPanelLinks();
}

window.deletePanelLink = async function(index) {
    if (!confirm("Remover este item?")) return;
    
    const { id, type } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    const docRef = doc(db, collectionName, id);
    
    const docSnap = await getDoc(docRef);
    const links = docSnap.data().panelLinks || [];
    
    const itemToRemove = links[index];
    
    // Se for codex, opcionalmente podes apagar tamb√©m da cole√ß√£o 'codex'
    if (itemToRemove.type === 'codex' && itemToRemove.id) {
        await deleteDoc(doc(db, 'codex', itemToRemove.id));
    }

    links.splice(index, 1);
    await updateDoc(docRef, { panelLinks: links });
    renderPanelLinks();
};


// 3. Fun√ß√£o para Adicionar Item da Lista "Refer√™ncias" para "Escolhidas"
window.addItemToPuzzle = function(noteId, noteName, snippetHTML) {

    // 1. Verificar se a fun√ß√£o createBoardItem existe
    if (typeof createBoardItem === 'function') {
        
        // 2. Mudar automaticamente para a aba "Puzzle" para o utilizador ver o item a chegar
        const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
        if (puzzleTabBtn) puzzleTabBtn.click();

        // 3. Chamar a fun√ß√£o do Quadro para criar o cart√£o
        createBoardItem('ref', {
            noteId: noteId,
            noteName: noteName,
            snippet: snippetHTML,
            isClone: false // √â uma refer√™ncia de texto, n√£o uma caixa completa
        }, true); // O 'true' faz scroll autom√°tico at√© ao novo cart√£o

        // 4. Se o modo de edi√ß√£o estiver ativo, grava logo na BD
        if (document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active')) {
            savePuzzleData();
        }
        
    } else {
        console.error("‚ùå Erro: Fun√ß√£o createBoardItem n√£o encontrada.");
    }
};

// ====================================================================
// L√ìGICA DE TELEPORTE (CONVERTER QUADRO EM NOTA) üì°
// ====================================================================

// 1. Vari√°veis de Estado para o Teleporte
let teleportContentHTML = ""; // Guarda o conte√∫do compilado
let teleportNoteTitle = "";   // Guarda o t√≠tulo limpo

// 2. Listener do Bot√£o üì°
document.getElementById('teleport-puzzle-btn').addEventListener('click', async (e) => {
    e.preventDefault(); e.stopPropagation();

    // --- A. CONFIRMA√á√ÉO COM POPUP PERSONALIZADO ---
    // Usamos a fun√ß√£o 'showConfirmation' que j√° existe no seu c√≥digo
    const confirmed = await showConfirmation(
        "Converter em Nota", 
        "Deseja mesmo gerar uma nota atrav√©s desta refer√™ncia?"
    );

    if (!confirmed) return; // Se clicar em Cancelar, p√°ra aqui.

    // --- B. Preparar T√≠tulo ---
    const panelTitle = document.getElementById('references-panel-title').textContent.trim();
    // Regex para limpar o lixo √† volta
    teleportNoteTitle = panelTitle.replace(/^Refer√™ncias para [üîñ]*["‚Äú](.+)["‚Äù]$/i, '$1');

    // --- C. Compilar Conte√∫do do Quadro ---
    teleportContentHTML = "";
    const cards = document.querySelectorAll('#puzzle-board-container .board-card');

    if (cards.length === 0) {
        alert("O quadro est√° vazio. Adicione algo antes de converter.");
        return;
    }

    cards.forEach(card => {
        // TIPO 1: Texto Edit√°vel
        if (card.classList.contains('type-text')) {
            const textDiv = card.querySelector('.board-text-content');
            if (textDiv) {
                teleportContentHTML += `<p>${textDiv.innerHTML}</p>`; 
            }
        } 
        // TIPO 2: Refer√™ncia
        else if (card.classList.contains('type-ref')) {
            let snippet = decodeURIComponent(card.dataset.snippet || "");
            snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

            if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
                teleportContentHTML += snippet;
            } else {
                teleportContentHTML += `
                    <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                        ${snippet}
                        <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
                    </blockquote>
                `;
            }
        }
        teleportContentHTML += "<p><br></p>";
    });

    // --- D. Abrir o Seletor de Pastas ---
    openTeleportFolderSelector();
});

// 3. Abrir Modal de Sele√ß√£o de Pasta (Reutiliza o estilo do Append/Move)
function openTeleportFolderSelector() {
    const modal = document.getElementById('move-to-folder-modal'); 
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const titleEl = modal.querySelector('h3');
    const descEl = modal.querySelector('p');

    // 1. RESET DE VARI√ÅVEIS CR√çTICO
    selectedDestFolderId = null; // Garante que n√£o usa uma sele√ß√£o antiga
    moveStack = []; 

    // Configurar UI
    titleEl.textContent = "Guardar Nota em...";
    descEl.innerHTML = `A criar nota: <strong>${teleportNoteTitle}</strong>`;
    
    // Configura√ß√£o da Barra de Navega√ß√£o (Breadcrumbs)
    let navContainer = document.getElementById('move-folder-nav-container');
    if (!navContainer) {
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz Global</span>
        `;
        list.parentNode.insertBefore(navContainer, list);
        
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const globalRootId = null; 
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : globalRootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(globalRootId);
            }
        });
    }

    modal.style.display = 'flex';
    
    // Inicia na Raiz Global (null)
    loadMoveFolderList(null);

    // --- SUBSTITUIR A√á√ÉO DO BOT√ÉO CONFIRMAR ---
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = "Gerar Nota";
    
    newConfirmBtn.onclick = async () => {
        // L√≥gica de Destino: Se n√£o selecionou (azul), assume a pasta onde est√° a navegar
        let targetFolderId = selectedDestFolderId;
        if (targetFolderId === null && moveStack.length > 0) {
            targetFolderId = moveStack[moveStack.length - 1].id;
        }
        
        // Se targetFolderId continuar null, √© a Raiz Global.

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A processar...";

        try {
            // =================================================================
            // PASSO C: GERAR CONTE√öDO E ANEXOS
            // =================================================================
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = teleportContentHTML;
            const anexosMap = {}; 
            
            // 1. Processar Links de Texto (Criados via bot√£o Globo üåê)
            const textLinks = tempDiv.querySelectorAll('a.board-link');
            textLinks.forEach((link, index) => {
                const anexoId = `anexo_txt_${Date.now()}_${index}`;
                let urls = {};
                try {
                    const rawUrls = JSON.parse(decodeURIComponent(link.dataset.json));
                    rawUrls.forEach((u, i) => urls[`url_${i}`] = u);
                } catch(e) { if (link.href) urls['url_0'] = link.href; }

                if (Object.keys(urls).length > 0) {
                    anexosMap[anexoId] = { titulo: link.textContent, urls: urls, timestamp: Date.now() };
                    // Transformar em link de nota
                    link.classList.remove('board-link');
                    link.removeAttribute('data-json');
                    link.setAttribute('data-anexo-id', anexoId);
                    link.style.borderBottom = '1px dotted var(--accent-color)';
                    link.style.color = 'inherit';
                    link.style.textDecoration = 'none';
                }
            });

            // 2. Processar Refer√™ncias do Quadro (Cart√µes Verdes) - PARA CRIAR ANEXO
            // Se o cart√£o for uma refer√™ncia a outra nota, criamos um "Anexo" para ela tamb√©m
          const refCards = document.querySelectorAll('#puzzle-board-container .board-card.type-ref');
refCards.forEach((card, index) => {
    let snippet = decodeURIComponent(card.dataset.snippet || "");
    
    // Limpeza b√°sica
    snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

    // VERIFICA√á√ÉO DE CAIXAS ESPECIAIS (CLONAGEM PERFEITA)
    if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
        
        // Se for uma caixa, injetamos o HTML direto (Clone Perfeito)
        // Dica: Podemos gerar um novo ID para evitar duplicados no sistema
        snippet = snippet.replace(/id="[^"]*"/, `id="clone_${Date.now()}_${index}"`);
        
        teleportContentHTML += snippet;
    } 
    // TRATAMENTO ESPECIAL PARA POST-ITS (Para n√£o ficarem sobrepostos)
    else if (snippet.includes('post-it-note')) {
        // 1. For√ßa posi√ß√£o relativa (para entrar no fluxo do texto)
        // 2. Remove coordenadas top/left antigas
        // 3. Mant√©m a cor e o visual
        let safePostIt = snippet.replace(/position:\s*absolute/g, 'position: relative; margin: 15px 0');
        safePostIt = safePostIt.replace(/top:\s*[^;]+;/g, '').replace(/left:\s*[^;]+;/g, '');
        
        // Remove o puxador de arrasto (j√° que na nova nota ser√° texto fixo)
        // (Opcional, mas fica mais limpo)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = safePostIt;
        const dragHandle = tempDiv.querySelector('.post-it-drag-handle');
        if(dragHandle) dragHandle.remove();
        
        teleportContentHTML += tempDiv.innerHTML;
    }
    // TEXTO SIMPLES (Cita√ß√£o padr√£o)
    else {
        teleportContentHTML += `
            <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                ${snippet}
                <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
            </blockquote>
        `;
    }
    
    // Adiciona o anexo l√≥gico (para o clip)
    const noteId = card.dataset.noteId;
    const noteName = card.dataset.noteName;
    if (noteId) {
        const anexoId = `anexo_ref_${Date.now()}_${index}`;
        anexosMap[anexoId] = {
            titulo: `Ref: ${noteName}`,
            urls: { 'url_0': `internal://note/${noteId}` }, 
            timestamp: Date.now()
        };
    }
});

            const finalContentHTML = tempDiv.innerHTML;

            // =================================================================
            // PASSO D: CRIAR NOTA NO FIREBASE
            // =================================================================
            
            // Calcular Ordem Segura (Para evitar NaN)
            let newOrder = 0;
            try {
                const qOrder = query(
                    collection(db, 'pastas'), 
                    where('parentId', '==', targetFolderId), 
                    where('userId', '==', auth.currentUser.uid)
                );
                const snapOrder = await getDocs(qOrder);
                newOrder = snapOrder.size || 0;
            } catch(e) { console.log("Erro ordem, usando 0"); }

            // Criar Documento
            const docRef = await addDoc(collection(db, 'pastas'), {
                nome: teleportNoteTitle,
                parentId: targetFolderId, 
                tipo: 'nota',
                conteudo: finalContentHTML,
                anexos: anexosMap, // Agora inclui links de texto E refer√™ncias
                userId: auth.currentUser.uid,
                estado: 'ativa',
                ordem: Number(newOrder), // For√ßa n√∫mero
                tags: [], 
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            
            // =================================================================
            // PASSO E: FOR√áAR ATUALIZA√á√ÉO VISUAL (CORRE√á√ÉO DA LISTA)
            // =================================================================
            
            // Se a pasta onde guard√°mos √© a mesma que est√° aberta no painel do meio...
            const currentMiddleFolderId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
            
            if (targetFolderId === currentMiddleFolderId) {
                // ...Recarregamos a lista explicitamente para garantir que aparece
                fetchAndDisplayItems(targetFolderId, middlePanelList, null);
            }

            // Popup de Sucesso
            const shouldOpen = await showConfirmation(
                "Sucesso!", 
                "Nota criada com sucesso.\nDeseja abrir a nota agora?"
            );
            
            if(shouldOpen) {
                displayNote(docRef.id, null);
            }

        } catch (error) {
            console.error("Erro ao criar nota:", error);
            alert("Erro ao gravar. Verifique a consola para detalhes de √≠ndices.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gerar Nota";
        }
    };
}

// ============================================================
// FUN√á√ÉO PARA EXIBIR DETALHES DO T√ìPICO (4¬™ COLUNA)
// ============================================================
async function showTopicReferencesPanel(id, name, description, type) {

    
    // 1. Gravar o puzzle/quadro anterior antes de mudar o contexto
    // Isto evita que percas altera√ß√µes se estivesses a editar outro t√≥pico
    await forceSaveAndClosePuzzleMode();
  resetReferencesPanelUI();
    // 2. DEFINIR ENTIDADE ATIVA (CR√çTICO para o +Ref funcionar)
    // Se o 'type' vier vazio, assume 'topico' por padr√£o
    activeReferenceEntity = { 
        id: id, 
        type: type || 'topico', 
        name: name 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'block';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel lateral
    notebookContainer.classList.add('references-panel-visible');
    
    // Define o T√≠tulo do painel (ex: T√≥pico: Santifica√ß√£o)
referencesPanelTitle.textContent = `Cita√ß√µes: ${name}`;
    document.getElementById('references-panel-description').textContent = description || 'Sem descri√ß√£o definida.';

    // 4. Sincronizar Abas: Abre sempre na aba "Puzzle" (Quadro)
    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTabBtn) puzzleTabBtn.classList.add('active');

    document.getElementById('ref-content-puzzle').style.display = 'flex';
    document.getElementById('ref-content-references').style.display = 'none';

    // 5. Carregar os dados do Quadro (Puzzle) salvos para este t√≥pico
    loadPuzzleData(id, type || 'topico');
    
    // 6. Pesquisar e listar as notas que usam este t√≥pico (para a aba Refer√™ncias)
    // Esta fun√ß√£o analisa o campo 'topicosSelecionados' de todas as notas
    renderTopicResultsList(id, type || 'topico'); 
}

// Fun√ß√£o Auxiliar para preencher a lista de refer√™ncias (Aba 2)
async function renderTopicResultsList(id, type) {
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar contextos...</span></div>';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        
        // Reset da lista global de resultados
        allCitationsResults = []; 

        snapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            if (!data.topicosSelecionados) return;

            let match = false;
            // Se for T√≥pico Pai
            if (type === 'topico') {
                if (data.topicosSelecionados.hasOwnProperty(id)) match = true;
            } 
            // Se for Subt√≥pico
            else {
                const allSubtopics = Object.values(data.topicosSelecionados).flat();
                if (allSubtopics.map(String).includes(String(id))) match = true;
            }

            if (match) {
                // Filtro de privacidade
                let isProtected = (data.passe && data.passe.trim() !== "");
                if (isProtected && !appSettings.searchTopicsInProtected) return;

                allCitationsResults.push({ 
                    id: docSnapshot.id, 
                    name: data.nome,
                    isProtected: isProtected,
                    snippet: "T√≥pico atribu√≠do a esta nota.",
                    ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
                });
            }
        });

        // ORDENAR: Mais recente primeiro
        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);

        // Renderiza a lista paginada
        window.renderCitationsPage(false);

    } catch (e) {
        console.error("Erro ao listar refer√™ncias do t√≥pico:", e);
        listElement.innerHTML = '<li>Erro ao carregar lista.</li>';
    }
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function openLinkModal(isEditing, data) {
    // 1. CAPTURA ROBUSTA DA SELE√á√ÉO (CR√çTICO)
    // Tentamos garantir que temos o texto selecionado guardado antes de qualquer outra coisa.
    // Isto resolve o problema de perder a sele√ß√£o quando se clica nos inputs do modal.
    let savedRange = null;

    if (!isEditing) {
        if (currentSelectionRange) {
            // Tenta usar a vari√°vel global gerida pelo handleTextSelection
            savedRange = currentSelectionRange.cloneRange();
        } else {
            // Fallback: Tenta obter diretamente do navegador
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && !sel.isCollapsed) {
                savedRange = sel.getRangeAt(0).cloneRange();
            }
        }
    }

    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const addUrlBtn = document.getElementById('add-url-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // Reset UI
    urlsContainer.innerHTML = '';
    
    // Clonar bot√µes para limpar listeners antigos (Evita cliques duplicados)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);

    newAddUrlBtn.onclick = () => addUrlField();

    // --- MODO EDI√á√ÉO ---
    if (isEditing) {
        modalTitle.textContent = "Editar/Remover Anexo";
        newRemoveBtn.style.display = 'block';

        // Preenche os dados atuais
        (async () => {
            try {
                const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
                if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                    const anexoFromDb = noteSnap.data().anexos[data.id];
                    titleInput.value = anexoFromDb.titulo;
                    
                    if (anexoFromDb.urls && Object.keys(anexoFromDb.urls).length > 0) {
                        Object.values(anexoFromDb.urls).forEach(url => addUrlField(url));
                    } else if (anexoFromDb.hiperligacao) {
                         // Suporte legado
                         addUrlField(anexoFromDb.hiperligacao);
                    } else { 
                        addUrlField(); 
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar dados do anexo:", e);
            }
        })();

        // Gravar Edi√ß√£o
        newSaveBtn.onclick = async () => {
            const newTitle = titleInput.value.trim();
            if (!newTitle) return alert("O t√≠tulo √© obrigat√≥rio.");

            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;

            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });

            if (Object.keys(urlsToSave).length === 0) return alert('Preencha pelo menos uma URL.');

            try {
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, {
                    [`anexos.${data.id}.titulo`]: newTitle,
                    [`anexos.${data.id}.urls`]: urlsToSave,
                    [`anexos.${data.id}.hiperligacao`]: deleteField(), // Limpa campo antigo se existir
                    [`anexos.${data.id}.timestamp`]: serverTimestamp()
                });

                // Atualiza o href no editor visualmente
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) linkInEditor.href = firstUrl;

                modal.style.display = 'none';
                saveNote();
            } catch (e) {
                console.error("Erro ao editar anexo:", e);
                alert("Erro ao gravar altera√ß√µes.");
            }
        };

        // Remover Anexo
    newRemoveBtn.onclick = async () => {
        
        // 1. Truque de UI: For√ßar o modal de confirma√ß√£o a ficar acima do modal de links
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.style.zIndex = '3200'; // Valor alto para garantir topo absoluto

        // 2. Chama o seu popup personalizado
        const confirmed = await showConfirmation(
            "Limpar Links", 
            "Tem a certeza que deseja remover todos os links desta caixa?"
        );

        // 3. Restaura o z-index para n√£o afetar outros usos futuros
        confirmModal.style.zIndex = ''; 

        // 4. Se confirmou, executa a limpeza
        if (confirmed) {
            wrapper.setAttribute('data-box-links', '{}');
            updateBoxLinkButtonState(wrapper);
            modal.style.display = 'none';
            saveNote(true);
        }
    };
    } 


    // --- MODO CRIA√á√ÉO (COM A CORRE√á√ÉO DO "GRAVAR") ---
    else {
        modalTitle.textContent = "Criar Anexo";
        titleInput.value = (typeof data === 'string') ? data : ''; 
        newRemoveBtn.style.display = 'none';
        addUrlField();

        // L√≥gica do Bot√£o Gravar (Nova Vers√£o Robusta)
        newSaveBtn.onclick = async () => {
            try {
                // 1. Valida√ß√£o de Dados
                const titleForDb = titleInput.value.trim();
                if (!titleForDb) { alert('T√≠tulo obrigat√≥rio.'); return; }
                
                const urlInputs = urlsContainer.querySelectorAll('input');
                const urlsToSave = {};
                let firstUrl = null;
                
                urlInputs.forEach((input, index) => {
                    let url = input.value.trim();
                    if (url) {
                        if (!url.startsWith('http')) url = 'https://' + url;
                        if (!firstUrl) firstUrl = url;
                        urlsToSave[`url_${Date.now() + index}`] = url;
                    }
                });
                
                if (Object.keys(urlsToSave).length === 0) { alert('Preencha pelo menos uma URL.'); return; }

                // 2. Verifica√ß√µes de Seguran√ßa Cr√≠ticas
                if (!selectedNoteId) throw new Error("ID da nota n√£o encontrado.");
                if (!savedRange) throw new Error("A sele√ß√£o de texto foi perdida. Cancele e tente novamente.");

                // 3. Gravar na Base de Dados (Firebase)
                const anexoId = `anexo_${Date.now()}`;
                const noteRef = doc(db, 'pastas', selectedNoteId);
                
                await updateDoc(noteRef, { 
                    [`anexos.${anexoId}`]: { 
                        titulo: titleForDb, 
                        urls: urlsToSave, 
                        timestamp: serverTimestamp() 
                    } 
                }, { merge: true });

                // 4. Prepara√ß√£o Visual (Preservar Entidades)
                const tempDiv = document.createElement('div');
                tempDiv.appendChild(savedRange.cloneContents()); 

                const anchorsInSelection = Array.from(tempDiv.querySelectorAll('.entity-link'));
                const preservedAnchors = anchorsInSelection.map(span => ({
                    name: span.dataset.entityName,
                    type: span.dataset.entityType
                }));
                
                // 5. Aplicar o Link no Editor
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange); // Restaura a sele√ß√£o guardada
                
                document.execCommand('createLink', false, firstUrl || '#');
                
                // Encontrar o link rec√©m-criado (onde est√° o cursor)
                const createdLink = selection.anchorNode.parentElement.closest('a');

                if (createdLink) {
                    createdLink.dataset.anexoId = anexoId;
                    
                    // Se havia entidades coloridas, restaura-as dentro do link
                    if (preservedAnchors.length > 0) {
                        let reconstructedHTML = createdLink.textContent;
                        
                        preservedAnchors.forEach(anchor => {
                            const anchorHTML = `<span class="entity-link" data-entity-type="${anchor.type}" data-entity-name="${anchor.name}">${anchor.name}</span>`;
                            const replaceRegex = new RegExp(escapeRegExp(anchor.name), 'g');
                            reconstructedHTML = reconstructedHTML.replace(replaceRegex, anchorHTML);
                        });

                        createdLink.innerHTML = reconstructedHTML;
                    }
                }
                
                // 6. Fechar e Gravar Nota
                modal.style.display = 'none';
                saveNote();

            } catch (error) {
                console.error("Erro ao criar link:", error);
                alert("Ocorreu um erro: " + error.message);
            }
        };
    }
    
    modal.style.display = 'flex';
}
// ====================================================================


async function openEntityModal(type, name) {
    // 1. Tenta guardar a sele√ß√£o se ela existir (para quando est√°s dentro de uma nota)
    const savedRange = (currentSelectionRange) ? currentSelectionRange.cloneRange() : null;

    const modal = document.getElementById('entity-modal');
    const title = document.getElementById('entity-modal-title');
    const nameInput = document.getElementById('entity-name-input');
    const descriptionInput = document.getElementById('entity-description-input');
    const errorMsg = document.getElementById('entity-error-message');
    
    // Configura o t√≠tulo do popup
    const singularNames = {
        personagem: "Personagem",
        local: "Local",
        data: "Data"
    };
    title.textContent = `Criar ${singularNames[type] || type}`;
    
    nameInput.value = name;
    descriptionInput.value = '';
    errorMsg.style.display = 'none';
    modal.style.display = 'flex';
    
    setTimeout(() => nameInput.focus(), 50);

    const saveBtn = document.getElementById('entity-save-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const entityName = nameInput.value.trim();
        const entityDescription = descriptionInput.value.trim();
        if (!entityName) return;

        const collectionName = ENTITY_CONFIG[type]?.collection;
        if (!collectionName) return;

        try {
            const collectionRef = collection(db, collectionName);
            const q = query(collectionRef, where("nome", "==", entityName), where("userId", "==", auth.currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            let entityId = "";

            if (querySnapshot.empty) {
                // CRIAR NOVO REGISTO
                const docRef = await addDoc(collectionRef, {
                    nome: entityName,
                    descricao: entityDescription,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp(),
                    referencias: (selectedNoteId && savedRange) ? { [selectedNoteId]: true } : {}
                });
                entityId = docRef.id;
            } else {
                // SE J√Å EXISTE, APENAS ATUALIZA A REFER√äNCIA SE ESTIVERMOS NUMA NOTA
                entityId = querySnapshot.docs[0].id;
                if (selectedNoteId && savedRange) {
                    const entityRef = doc(db, collectionName, entityId);
                    await updateDoc(entityRef, { [`referencias.${selectedNoteId}`]: true });
                }
            }

            // 2. L√ìGICA VISUAL (S√≥ executa se houver texto selecionado no editor)
            if (savedRange && selectedNoteId) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);

                const span = document.createElement('span');
                span.className = 'entity-link';
                span.dataset.entityType = type;
                span.dataset.entityName = entityName;
                span.textContent = entityName;
                
                savedRange.deleteContents();
                savedRange.insertNode(span);
                saveNote();
            }

            modal.style.display = 'none';
            
            // 3. ATUALIZA√á√ÉO DA LISTA (Se estiveres na aba Lists, recarrega os itens para o novo aparecer)
            if (currentTab === 'lists') {
                renderListCategoryItems(type);
            }
            
            fetchAllEntities(); 

        } catch (e) {
            console.error("Erro ao guardar entidade:", e);
            alert("Erro ao guardar.");
        }
    };
}

  async function openGenericListModal(title, dataPromise) {
    const modal = document.getElementById('generic-list-modal');
    const titleEl = document.getElementById('generic-list-title');
    const contentEl = document.getElementById('generic-list-content');
    
    titleEl.textContent = title;
    contentEl.innerHTML = '<li>Carregando...</li>';
    modal.style.display = 'flex';

    try {
        const items = await dataPromise;
        contentEl.innerHTML = ''; 
        if (!items || items.length === 0) {
            contentEl.innerHTML = '<li>Nenhum item encontrado.</li>';
            return;
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.style.alignItems = 'flex-start';
            
            // <<<<<<< ALTERA√á√ÉO IMPORTANTE >>>>>>>>>
            // Adiciona um data-attribute se o t√≠tulo for uma tag
            if (item.title.startsWith('#')) {
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = item.title.replace('#', '');
                li.style.cursor = 'pointer'; // Muda o cursor para indicar que √© clic√°vel
            }
            
            let contentHTML = '';

            if (Array.isArray(item.content) && item.content.length > 0) {
                const linksHTML = item.content.map((url, index) => {
                    if (!url) return '';
                    return `<div style="display: flex; align-items: baseline; margin-top: 5px; gap: 8px;"><span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span><a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; word-break: break-all;">${url}</a></div>`;
                }).join('');
                contentHTML = `<div style="margin-top: 4px;">${linksHTML}</div>`;
            } 
            else if (typeof item.content === 'string' && item.content) {
                contentHTML = `<small style="color: var(--text-muted-color); margin-top: 4px;">${item.content}</small>`;
            }

            let editButtonHTML = '';
            if (item.type === 'anexo' && item.id) {
                editButtonHTML = `<button data-action="edit-anexo" data-id="${item.id}" title="Editar Anexo" style="background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; margin-left: auto; padding: 5px;">‚úèÔ∏è</button>`;
            }

            li.innerHTML = `<div style="display: flex; flex-direction: column; flex-grow: 1;"><strong style="font-size: 1.1em;">${item.title}</strong>${contentHTML}</div>${editButtonHTML}`;
            contentEl.appendChild(li);
        });

    } catch (error) {
        console.error("Erro ao carregar dados para o modal:", error);
        contentEl.innerHTML = '<li>Ocorreu um erro ao carregar os itens.</li>';
    }
}

 function openAttachmentsModal() {
    if (!selectedNoteId) return;
    
    const fetchData = async () => {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (noteSnap.exists() && noteSnap.data().anexos) {
            const anexosMap = noteSnap.data().anexos;
            // A MUDAN√áA PRINCIPAL: Agora usamos Object.entries para ter acesso √† CHAVE (ID do anexo)
            return Object.entries(anexosMap).map(([anexoId, anexoData]) => {
                const urlsArray = anexoData.urls ? Object.values(anexoData.urls) : (anexoData.hiperligacao ? [anexoData.hiperligacao] : []);
                return { 
                    id: anexoId, // <<<<<<< IMPORTANTE: Passamos o ID do anexo
                    title: anexoData.titulo, 
                    content: urlsArray,
                    type: 'anexo' // <<<<<<< Adicionamos um tipo para identifica√ß√£o
                };
            });
        }
        return [];
    };

    openGenericListModal("Anexos na Nota", fetchData());
}

 




// --- FUN√á√ÉO UNIFICADA: EXPLORADOR (TAGS + ENTIDADES) ---
async function openExplorerModal() {
    const modal = document.getElementById('anchors-modal');
    const filterBtn = document.getElementById('toggle-search-filters-btn');
    const container = document.getElementById('anchors-content-container');
    
    if (!modal || !container) return;

    modal.style.display = 'flex';
    
    // Reset do visual do bot√£o e abertura da aba padr√£o (Pesquisa)
    filterBtn.textContent = "‚öôÔ∏è Filtros";
    renderSearchTab(); 

    // Alternar entre Pesquisa e Filtros
    filterBtn.onclick = (e) => {
        e.preventDefault();
        // Verificamos se o que est√° l√° dentro √© a pesquisa ou filtros
        const isShowingSearch = !!document.getElementById('global-search-input');
        
        if (isShowingSearch) {
            renderFiltersTab();
            filterBtn.textContent = "üîç Pesquisa";
        } else {
            renderSearchTab();
            filterBtn.textContent = "‚öôÔ∏è Filtros";
        }
    };
}

// Renderiza a aba de Pesquisa
function renderSearchTab() {
    const container = document.getElementById('anchors-content-container');
    const scopeContainer = document.getElementById('search-scope-container');
    const scopeToggle = document.getElementById('search-scope-toggle');
    const scopeText = document.getElementById('scope-text');

    container.innerHTML = `
        <div class="search-container">
            <input type="text" id="global-search-input" class="global-search-input" 
                   placeholder='Ex: eva "ad√£o"'>
            <div id="global-search-results">
                <p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">
                    Pesquise por termos soltos ou use "aspas" para palavras exatas.
                </p>
            </div>
        </div>
    `;

    const searchInput = document.getElementById('global-search-input');
    const resultsContainer = document.getElementById('global-search-results');
 const scopeBtn = document.getElementById('search-scope-btn');

   scopeBtn.onclick = (e) => {
        e.preventDefault();
        if (globalSearchScope === 'paragraph') {
            globalSearchScope = 'page';
            scopeBtn.classList.add('active');
            scopeBtn.querySelector('span').textContent = 'Na P√°gina';
        } else {
            globalSearchScope = 'paragraph';
            scopeBtn.classList.remove('active');
            scopeBtn.querySelector('span').textContent = 'No Par√°grafo';
        }
        // Refaz a pesquisa com o novo escopo
        if (searchInput.value.trim().length >= 2) executeGlobalSearch(searchInput.value.trim(), resultsContainer);
    };

      let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const terms = parseSearchQuery(val);
        
        // MOSTRAR/ESCONDER: S√≥ aparece se houver 2 ou mais termos
        scopeBtn.style.display = (terms.length >= 2) ? 'flex' : 'none';

        clearTimeout(searchTimeout);
        if (val.length < 2) {
            resultsContainer.innerHTML = '<p style="text-align:center; color:var(--text-muted-color); margin-top:20px;">Escreva para pesquisar...</p>';
            return;
        }
        searchTimeout = setTimeout(() => { executeGlobalSearch(val, resultsContainer); }, 600);
    });

    setTimeout(() => searchInput.focus(), 200);
}


    // Renderiza a aba de Filtros com Toggles
function renderFiltersTab() {
    const container = document.getElementById('anchors-content-container');
    if (!container) return;
    
    const f = window.searchFilters;

    container.innerHTML = `
        <div class="filters-container" style="padding: 10px;">
            <div class="setting-toggle-container" style="background: rgba(74, 144, 226, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--accent-color);">
                <label class="setting-switch">
                    <input type="checkbox" id="f-all" ${f.all ? 'checked' : ''} onchange="window.toggleAllFilters(this.checked)">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label"><strong>Pesquisar em Tudo</strong></span>
            </div>

            <h4 style="color: var(--accent-color); margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">1. Localiza√ß√£o</h4>
            ${createFilterToggle('f-notes', 'Notas', 'notes')}
            ${createFilterToggle('f-superfolders', 'SuperPastas', 'superfolders')}
            ${createFilterToggle('f-archives', 'Arquivo', 'archives')}

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">2. Contexto Visual</h4>
            ${createFilterToggle('f-subnote', 'SubNotas', 'subnote')}
            ${createFilterToggle('f-question', 'Quest√µes', 'question')}
            ${createFilterToggle('f-free', 'Contentores', 'free')}
            ${createFilterToggle('f-postit', 'Post-its', 'postit')}

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">3. Metadados e Entidades</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                ${createFilterToggle('f-topics', 'T√≥picos', 'topics')}
                ${createFilterToggle('f-subtopics', 'SubT√≥picos', 'subtopics')}
                ${createFilterToggle('f-highlights', 'Destaques', 'highlights')}
                ${createFilterToggle('f-bookmarks', 'Marcadores', 'bookmarks')}
                ${createFilterToggle('f-personagem', 'Personagens', 'personagem')}
                ${createFilterToggle('f-local', 'Locais', 'local')}
                ${createFilterToggle('f-data', 'Datas', 'data')}
                ${createFilterToggle('f-cosmos', 'Temas (Cosmos)', 'cosmos')}
                ${createFilterToggle('f-subcosmos', 'SubTemas', 'subcosmos')}
                ${createFilterToggle('f-tags', 'Tags', 'tags')}
            </div>

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">4. Conte√∫do Extra</h4>
            ${createFilterToggle('f-fourthColumn', 'Texto 4¬™ Coluna (Puzzle)', 'fourthColumn')}
        </div>
    `;
}

function createFilterToggle(id, label, property) {
    // Busca o estado atual com fallback para evitar erros
    const isChecked = (window.searchFilters && window.searchFilters[property]) ? 'checked' : '';
    
    return `
        <div class="setting-toggle-container" style="margin-bottom: 10px;">
            <label class="setting-switch">
                <input type="checkbox" id="${id}" ${isChecked} 
                       onchange="window.updateSearchFilter('${property}', this.checked)">
                <span class="slider round"></span>
            </label>
            <span class="setting-label" style="font-size: 0.9em;">${label}</span>
        </div>
    `;
}

// --- FUN√á√ÉO DE PESQUISA REAL ---
async function executeGlobalSearch(queryText, container) {
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A procurar...</span></div>';
    
    const terms = parseSearchQuery(queryText);
    if (terms.length === 0) return;

    const isMultiMode = terms.length >= 2;
    const f = window.searchFilters;
    const myUid = auth.currentUser.uid;
    const foundResults = [];

    try {
        const qPastas = query(collection(db, 'pastas'), where('estado', '==', 'ativa'), where('userId', '==', myUid));
        const snapPastas = await getDocs(qPastas);

        snapPastas.forEach(docSnap => {
            const data = docSnap.data();
            const content = data.conteudo || "";
            const noteName = data.nome || "";
            
            const isArchive = (data.tipo === 'arquivo' || data.tipo === 'partilhado');
            if (isArchive && !f.archives) return;
            if (data.superpasta && !f.superfolders) return;

            let matched = false;
            let context = "";

            // --- L√ìGICA DE VERIFICA√á√ÉO ---
            const checkAgainstText = (text) => {
                // Retorna true se TODOS os termos da pesquisa passarem no teste
                return terms.every(termObj => {
                    const regex = getAccentInsensitiveRegex(termObj.text, termObj.exact);
                    return regex.test(text);
                });
            };

            if (isMultiMode && globalSearchScope === 'paragraph') {
                const parser = new DOMParser();
                const docHTML = parser.parseFromString(content, 'text/html');
                // Procura em par√°grafos, caixas de texto e t√≠tulos de entidades
                const blocks = docHTML.querySelectorAll('p, div, li, h1, h2, h3, .mini-note-content, .mini-note-title-input');

                for (const block of blocks) {
                    const blockText = block.tagName === 'INPUT' || block.tagName === 'TEXTAREA' ? block.value : block.innerText;
                    if (checkAgainstText(blockText)) {
                        matched = true;
                        context = generateSearchContext(blockText, terms[0].text, terms[0].exact);
                        break;
                    }
                }
            } else {
                // Pesquisa na p√°gina toda (T√≠tulo + Conte√∫do limpo de HTML)
                const fullText = noteName + " " + content.replace(/<[^>]*>/g, ' ');
                if (checkAgainstText(fullText)) {
                    matched = true;
                    context = generateSearchContext(fullText, terms[0].text, terms[0].exact);
                }
            }

            if (matched) {
                foundResults.push({
                    id: docSnap.id, name: noteName, badge: isArchive ? "Arquivo" : "Nota",
                    context: context, updatedAt: data.ultimaedicao?.toMillis() || 0,
                    rawSearchTerm: terms[0].text, clickAction: 'note'
                });
            }
        });

        // 4¬™ COLUNA (PUZZLE)
        if (f.fourthColumn) {
            const entityCollections = ['personagens', 'locais', 'topicos', 'textosbiblicos', 'marcadores', 'cosmos', 'subcosmos'];
            for (const colName of entityCollections) {
                const qEntity = query(collection(db, colName), where('userId', '==', myUid));
                const snapEntity = await getDocs(qEntity);

                snapEntity.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data.puzzleBoard) return;

                    let matched = false;
                    let context = "";

                    const checkAgainstText = (text) => {
                        return terms.every(termObj => {
                            const regex = getAccentInsensitiveRegex(termObj.text, termObj.exact);
                            return regex.test(text);
                        });
                    };

                    if (isMultiMode && globalSearchScope === 'paragraph') {
                        for (const item of data.puzzleBoard) {
                            const cardText = item.content || "";
                            if (checkAgainstText(cardText)) {
                                matched = true;
                                context = generateSearchContext(cardText, terms[0].text, terms[0].exact);
                                break;
                            }
                        }
                    } else {
                        const allPuzzleText = data.puzzleBoard.map(i => i.content).join(" ");
                        if (checkAgainstText(allPuzzleText)) {
                            matched = true;
                            context = generateSearchContext(allPuzzleText, terms[0].text, terms[0].exact);
                        }
                    }

                    if (matched) {
                        foundResults.push({
                            id: docSnap.id, name: data.nome, badge: "Puzzle",
                            context: context, updatedAt: data.updatedAt?.toMillis() || 0,
                            clickAction: 'entity', entityType: colName
                        });
                    }
                });
            }
        }

        foundResults.sort((a, b) => b.updatedAt - a.updatedAt);
        globalExplorerResults = foundResults;
        currentExplorerPage = 0;
        renderExplorerResultsPage(container, terms[0].text, {}, true);

    } catch (error) {
        console.error(error);
        container.innerHTML = '<p>Erro na pesquisa.</p>';
    }
}


// --- GERAR CONTEXTO (TEXTO AO REDOR) ---
function generateSearchContext(fullText, term, isExact) {
    const normalizedText = removeAccents(fullText);
    const normalizedTerm = removeAccents(term);
    
    let index = -1;

    if (isExact) {
        // Usa Regex para encontrar a posi√ß√£o da palavra inteira
        const regex = new RegExp(`\\b${escapeRegExp(normalizedTerm)}\\b`, 'i');
        const match = normalizedText.match(regex);
        index = match ? match.index : -1;
    } else {
        index = normalizedText.indexOf(normalizedTerm);
    }

    if (index === -1) return "";

    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + term.length + 40);
    
    let snippet = fullText.substring(start, end);
    
    if (start > 0) snippet = "..." + snippet;
    if (end < fullText.length) snippet = snippet + "...";

    // Passamos o isExact para o highlightMatch tamb√©m
    return highlightMatch(snippet, term, isExact);
}


// --- RENDERIZAR RESULTADOS ---
function renderExplorerResultsPage(container, term, folderMap, reset = false) {
    // 1. Se for um reset (nova pesquisa), limpa o contentor
    if (reset) {
        container.innerHTML = '';
    }

    if (globalExplorerResults.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">Nenhum resultado encontrado.</p>';
        return;
    }

    // 2. C√°lculo de Pagina√ß√£o
    const start = currentExplorerPage * EXPLORER_RESULTS_PER_PAGE;
    const end = start + EXPLORER_RESULTS_PER_PAGE;
    const pageResults = globalExplorerResults.slice(start, end);

    // Remove o bot√£o "Carregar mais" antigo se existir
    const oldBtn = document.getElementById('explorer-load-more-btn');
    if (oldBtn) oldBtn.remove();

    // 3. Loop de Renderiza√ß√£o dos Itens
    pageResults.forEach(item => {
        const divItem = document.createElement('div');
        divItem.className = 'search-result-item';

        // Definir cores e √≠cones baseados no Badge (Etiqueta)
        let borderLeftColor = "var(--border-color)";
        let icon = "üìÑ";
        let badgeStyle = "background: rgba(255,255,255,0.1); color: var(--text-muted-color);";

        switch (item.badge) {
            case 'Puzzle':
                borderLeftColor = "#2ecc71"; // Verde
                icon = "üß©";
                badgeStyle = "background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71;";
                break;
            case 'Arquivo':
                borderLeftColor = "#e74c3c"; // Vermelho
                icon = "üóÑÔ∏è";
                badgeStyle = "background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c;";
                break;
            case 'SuperPasta':
                borderLeftColor = "#f1c40f"; // Dourado
                icon = "üóÉÔ∏è";
                badgeStyle = "background: rgba(241, 196, 15, 0.2); color: #f1c40f; border: 1px solid #f1c40f;";
                break;
            case 'Quest√£o':
                borderLeftColor = "#1e8449"; // Verde escuro
                icon = "üìó";
                badgeStyle = "background: rgba(30, 132, 73, 0.2); color: #2ecc71;";
                break;
        }

        divItem.style.borderLeft = `4px solid ${borderLeftColor}`;

        // Construir HTML do item
        divItem.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span class="search-result-title">
                    ${icon} ${highlightMatch(item.name, term)} 
                </span>
                <span class="search-badge" style="${badgeStyle} font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase;">
                    ${item.badge}
                </span>
            </div>
            ${item.context ? `<div class="search-match-context" style="margin-top: 5px; font-size: 0.85em; opacity: 0.8;">${item.context}</div>` : ''}
        `;

        // 4. L√ìGICA DE CLIQUE INTELIGENTE
        divItem.onclick = () => {
            // Fecha o modal de pesquisa
            document.getElementById('anchors-modal').style.display = 'none';

            if (item.clickAction === 'entity') {
                // SE FOR PUZZLE: Abre o painel de Refer√™ncias da 4¬™ Coluna
                // Nota: Mapeamos o nome da cole√ß√£o para o tipo singular esperado pelo painel
                const typeMap = {
                    'personagens': 'personagem',
                    'locais': 'local',
                    'topicos': 'topico',
                    'textosbiblicos': 'textobiblico',
                    'marcadores': 'marcadores',
                    'cosmos': 'cosmos',
                    'subcosmos': 'subcosmos'
                };
                const singularType = typeMap[item.type] || item.type;
                showReferencesPanel(item.id, item.name, singularType);
            } else {
                // SE FOR NOTA: Abre a nota no editor principal
                navigateWithUnsavedCheck(() => {
                    navigateToNoteSmart(item.id, item.rawSearchTerm);
                });
            }
        };

        container.appendChild(divItem);
    });

    // 5. Adicionar Bot√£o "Carregar Mais" se houver mais resultados
    if (end < globalExplorerResults.length) {
        const remaining = globalExplorerResults.length - end;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'explorer-load-more-btn';
        loadMoreBtn.className = 'modal-btn secondary';
        loadMoreBtn.style.width = "100%";
        loadMoreBtn.style.marginTop = "15px";
        loadMoreBtn.textContent = `Mostrar mais ${remaining} resultados`;
        
        loadMoreBtn.onclick = (e) => {
            e.preventDefault();
            currentExplorerPage++;
            renderExplorerResultsPage(container, term, folderMap, false);
        };
        
        container.appendChild(loadMoreBtn);
    }
}



// Fun√ß√£o auxiliar para atualizar as abas visualmente (se ainda n√£o existir)
function updateTabsUI() {
    document.querySelectorAll('.tabs-container button').forEach(btn => {
        if (btn.dataset.tab === 'note') btn.classList.add('active');
        else btn.classList.remove('active');
    });
}

// Auxiliar para destacar t√≠tulo
function highlightMatch(text, term, isExact) {
    if (!text) return "";
    // Usamos a fun√ß√£o acima que j√° devolve a Regex com par√™nteses
    const regex = getAccentInsensitiveRegex(term, isExact);
    
    // Agora o $1 vai representar exatamente o que a Regex encontrou (ex: "Eva", "eva" ou "√âva")
    return text.replace(regex, "<mark>$1</mark>");
}

// --- FUN√á√ïES AUXILIARES DE CARREGAMENTO (Refatoradas para limpar o c√≥digo principal) ---
async function loadTagsForExplorer(container) {
    try {
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const activeTagsSet = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach(t => activeTagsSet.add(t));
            }
        });
        const tagsArray = Array.from(activeTagsSet).sort((a, b) => a.localeCompare(b));

        container.innerHTML = ''; 
        if (tagsArray.length === 0) {
            container.innerHTML = '<p style="padding:15px; color:#888;">Nenhuma tag encontrada.</p>';
        } else {
            const ul = document.createElement('ul');
            tagsArray.forEach(tagName => {
                const li = document.createElement('li');
                li.textContent = `#${tagName}`;
                li.style.cursor = 'pointer';
                li.style.color = 'var(--accent-color)';
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = tagName;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }
    } catch (e) {
        container.innerHTML = '<p style="color:red;">Erro ao carregar tags.</p>';
    }
}

function renderEntityTab(container, type, onPageNames) {
    const sortedEntities = [...allEntities[type]].sort((a, b) => a.nome.localeCompare(b.nome));
    
    // (Pode reinserir aqui a l√≥gica de separa√ß√£o "Nesta Nota" vs "Banco de Dados" se desejar,
    //  o c√≥digo √© id√™ntico ao que tinha antes na fun√ß√£o gigante)
    
    const ul = document.createElement('ul');
    if (sortedEntities.length === 0) {
        container.innerHTML = '<p style="padding:15px; color:#888;">Sem registos.</p>';
        return;
    }

    sortedEntities.forEach(entity => {
        const li = document.createElement('li');
        li.textContent = entity.nome;
        li.dataset.entityId = entity.id;
        li.dataset.entityName = entity.nome;
        li.dataset.entityType = entity.tipo;
        li.dataset.action = 'show-entity-references';
        
        if (onPageNames.has(entity.nome)) li.classList.add('is-on-page');

        const editBtn = document.createElement('button');
        editBtn.className = 'entity-edit-btn';
        editBtn.innerHTML = '‚Ä¶';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditEntityModal(entity.id, entity.tipo); };
        
        li.appendChild(editBtn);
        ul.appendChild(li);
    });
    container.appendChild(ul);
}



async function openEditEntityModal(entityId, entityType) {
    const modal = document.getElementById('edit-entity-modal');
    const title = document.getElementById('edit-entity-title');
    const nameInput = document.getElementById('edit-entity-name-input');
    const descriptionInput = document.getElementById('edit-entity-description-input');
    const saveBtn = document.getElementById('edit-entity-save-btn');
    
    // Refer√™ncias do novo input de emoji
    const emojiContainer = document.getElementById('edit-emoji-container');
    const emojiInput = document.getElementById('edit-emoji-input');

    modal.style.display = 'flex';
    nameInput.value = 'A carregar...';
    descriptionInput.value = 'A carregar...';
    
    // 1. Mostrar seletor de emoji APENAS para subcosmos
    if (entityType === 'subcosmos') {
        emojiContainer.style.display = 'block';
    } else {
        emojiContainer.style.display = 'none';
    }

    const collectionName = getCollectionFromType(entityType);
    
    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (!entitySnap.exists()) return;

        const entityData = entitySnap.data();
        title.textContent = `Editar "${entityData.nome}"`;
        nameInput.value = entityData.nome;
        descriptionInput.value = entityData.descricao || '';
        
        // 2. Preencher o input com o emoji atual se for subtema
        if (entityType === 'subcosmos') {
            emojiInput.value = entityData.emoji || "üíº";
        }

        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDescription = descriptionInput.value.trim();
            const newEmoji = emojiInput.value.trim(); // Pega o que o user colou

            if (!newName) return alert('O nome √© obrigat√≥rio.');

            const updateData = {
                nome: newName,
                descricao: newDescription
            };

            // 3. Se for subtema, inclui o novo emoji no update
            if (entityType === 'subcosmos') {
                updateData.emoji = newEmoji || "üíº"; // Fallback se ficar vazio
            }

            await updateDoc(entityRef, updateData);

            modal.style.display = 'none';
            
            // Atualizar cache e interface
            await fetchAllEntities();
            if (activeReferenceEntity.id === entityId) {
                activeReferenceEntity.name = newName;
                document.getElementById('references-panel-title').textContent = `Refer√™ncias: ${newName}`;
                document.getElementById('references-panel-description').textContent = newDescription;
            }
            
            if (currentTab === 'lists') renderListCategoryItems('cosmos');
        };

    } catch (error) {
        console.error("Erro ao editar:", error);
        modal.style.display = 'none';
    }
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function appendLinkInfoToPanel(anexoId) {
    if (!selectedNoteId) {
        console.error('ID da nota n√£o encontrado. A abortar.');
        console.groupEnd();
        return;
    }

    const noteRef = doc(db, 'pastas', selectedNoteId);
    const noteSnap = await getDoc(noteRef);
    
    if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[anexoId]) {
        const anexo = noteSnap.data().anexos[anexoId];
        const list = document.getElementById('references-list');

        const details = document.createElement('details');
        details.className = 'reference-item link-info';
        details.open = true;

        const summary = document.createElement('summary');
        summary.innerHTML = `üîó Anexo: ${anexo.titulo}`;
        
        const contextDiv = document.createElement('div');
        contextDiv.className = 'reference-context';
        
        const urls = anexo.urls ? Object.values(anexo.urls) : [anexo.hiperligacao];
        urls.forEach(url => {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.textContent = url;
                link.target = '_blank';
                link.style.display = 'block';
                link.style.marginBottom = '5px';
                contextDiv.appendChild(link);
            }
        });

        details.appendChild(summary);
        details.appendChild(contextDiv);
        
        const separator = document.createElement('hr');
        separator.style.borderColor = 'var(--border-color)';
        separator.style.margin = '15px 0';
        
        list.appendChild(separator);
        list.appendChild(details);
    } else {
        console.error(`Anexo com ID "${anexoId}" n√£o foi encontrado nos dados da nota.`);
    }
    console.groupEnd();
}
// ====================================================================


// --- LISTENERS DOS BOT√ïES DO CABE√áALHO ---
document.getElementById('add-text-btn').addEventListener('click', () => createBoardItem('text', {}, true));
document.getElementById('add-ref-btn').addEventListener('click', () => openReferenceSelectionPopup());

// Fun√ß√£o Unificada para Criar Cart√µes no Quadro
function createBoardItem(type, data = {}, shouldScroll = false) {
    const container = document.getElementById('puzzle-board-container');
    const emptyMsg = document.getElementById('puzzle-empty-msg');
    if (emptyMsg) emptyMsg.style.display = 'none';

    const card = document.createElement('div');
    card.className = `board-card type-${type}`;

    const puzzleContainer = document.getElementById('ref-content-puzzle');
    const isEditMode = puzzleContainer && puzzleContainer.classList.contains('edit-mode-active');
    let innerHTML = '';
    let headerHtml = "";
    let displayHtml = "";

    // --- TIPO 1: TEXTO (Criado manualmente) ---
    if (type === 'text') {
        const contentHtml = data.content || '';
        const initialStyle = isEditMode
            ? "width:100%; min-height:40px; outline:none; white-space: pre-wrap; word-break: break-word; color:var(--text-color); border:1px solid var(--border-color); padding:8px; border-radius:4px; background-color:var(--bg-color);"
            : "width:100%; min-height:40px; outline:none; white-space: pre-wrap; word-break: break-word; color:var(--text-color); border:none; padding:0; background:transparent;";

        innerHTML = `<div class="board-text-content" style="${initialStyle}" ${isEditMode ? 'contenteditable="true"' : 'contenteditable="false"'}>${contentHtml}</div>`;
        card.style.borderLeft = "3px solid var(--accent-color)"; // Azul padr√£o para novos textos
    }

    // --- TIPO 2: REFER√äNCIA (Importado via +Ref) ---
    else if (type === 'ref') {
        card.dataset.noteId = data.noteId;
        card.dataset.noteName = data.noteName || "Nota";

        let rawSnippet = data.snippet || '';
        try {
            if (rawSnippet.includes('%3C')) rawSnippet = decodeURIComponent(rawSnippet);
        } catch (e) { }
        card.dataset.snippet = encodeURIComponent(rawSnippet);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawSnippet;

        // 1. EXTRA√á√ÉO DE T√çTULO (Subnota, Quest√£o, Toggle ou Ideia)
        const titleEl = tempDiv.querySelector('.mini-note-title-input');
        const h2El = tempDiv.querySelector('h2');
        const ideaEl = tempDiv.querySelector('.idea-span');
        
        let extractedTitle = "";
        if (titleEl) {
            extractedTitle = titleEl.textContent || titleEl.value || titleEl.getAttribute('value') || "";
        } else if (h2El) {
            extractedTitle = h2El.textContent;
        } else if (ideaEl) {
            extractedTitle = ideaEl.textContent;
        }

        // 2. L√ìGICA DE PRIORIDADE: Se n√£o houver t√≠tulo na caixa, usa o nome da nota (Ex: G√©nesis 1:1-4)
        // Removemos o texto fixo "Texto da Nota" para permitir que a refer√™ncia b√≠blica suba para o t√≠tulo
        let finalDisplayTitle = extractedTitle.trim();
        if (!finalDisplayTitle || finalDisplayTitle === "Texto da Nota") {
            finalDisplayTitle = data.noteName || "Sem T√≠tulo";
        }

        // 3. DEFINI√á√ÉO DE √çCONE E COR (Apenas para a borda e √≠cone lateral)
        let icon = "üìÑ"; 
        let color = "#95a5a6"; // Cinzento (Corpo da nota)
        
        if (rawSnippet.includes('question-mode')) { icon = "üìó"; color = "#2ecc71"; }
        else if (rawSnippet.includes('free-mode')) { icon = "üìô"; color = "#e67e22"; }
        else if (rawSnippet.includes('toggle-section')) { icon = "‚òÇ"; color = "#9b59b6"; }
        else if (rawSnippet.includes('idea-span')) { icon = "üí°"; color = "#e74c3c"; }
        else if (rawSnippet.includes('mini-note-wrapper')) { icon = "üìò"; color = "#3498db"; }

        card.style.borderLeft = `4px solid ${color}`;

        // 4. EXTRA√á√ÉO DE CONTE√öDO (PREVIEW)
        const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content') || tempDiv;
        let bodyText = contentDiv.innerText.replace(/\s+/g, ' ').trim();
        if (bodyText.length > 150) bodyText = bodyText.substring(0, 150) + "...";

        // 5. CONSTRU√á√ÉO DO HTML (Sem o "REF" e com T√≠tulo/Refer√™ncia no topo)
        headerHtml = `
            <div style="padding-left: 5px; margin-bottom: 5px;">
                <div style="font-weight:bold; font-size:1em; cursor:pointer; color:var(--text-color); display: flex; align-items: center; gap: 8px;" 
                     onclick="window.openNoteFromBoard('${data.noteId}', '${encodeURIComponent(finalDisplayTitle)}')"
                     onmouseover="this.style.textDecoration='underline'" 
                     onmouseout="this.style.textDecoration='none'">
                    <span style="font-size: 1.2em;">${icon}</span> ${finalDisplayTitle}
                </div>
            </div>`;

        displayHtml = `<div style="font-size:0.9em; color:var(--text-muted-color); padding-left: 8px; line-height:1.4;">${bodyText}</div>`;

        innerHTML = `<div class="ref-card-content">${headerHtml}${displayHtml}</div>`;
    }

    // Adiciona controlos (Lixo, Setas)
    innerHTML += `
        <div class="card-controls"> 
            ${type === 'text' ? '<button class="add-board-link" title="Gerir Links" style="margin-right: auto;">üåê</button>' : ''}
            <button class="move-up" title="Mover para Cima">üî∫</button>
            <button class="move-down" title="Mover para Baixo">üîª</button>
            <button class="delete" title="Remover" style="color:#e74c3c; border-color:#e74c3c;">üóëÔ∏è</button>
        </div>
    `;

    card.innerHTML = innerHTML;

    // Listener para o Lixo
    card.querySelector('.delete').onclick = async () => {
        const confirmModal = document.getElementById('confirm-modal');
        if (confirmModal) confirmModal.style.zIndex = "30000";
        const confirmed = await showConfirmation("Remover Item", "Deseja remover este item do quadro?");
        if (confirmed) { 
            card.remove(); 
            if(container.querySelectorAll('.board-card').length === 0 && emptyMsg) emptyMsg.style.display = 'block';
            if(isEditMode) savePuzzleData(); 
        }
    };

    // Listeners de Movimento
    card.querySelector('.move-up').onclick = () => {
        const p = card.previousElementSibling; if (p && p.classList.contains('board-card')) container.insertBefore(card, p);
    };
    card.querySelector('.move-down').onclick = () => {
        const n = card.nextElementSibling; if (n && n.classList.contains('board-card')) container.insertBefore(n, card);
    };

    container.appendChild(card);

    if (shouldScroll) {
        setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
}




// Fun√ß√£o para abrir nota a partir do Quadro (Puzzle) - VERS√ÉO ATUALIZADA
window.openNoteFromBoard = function(noteId, encodedSearchTerm = null) {
    
    // 1. Descodifica o termo de pesquisa (t√≠tulo da caixa) se ele existir
    // Se n√£o existir, tenta usar o nome da entidade ativa como fallback (comportamento antigo)
    let term = encodedSearchTerm 
        ? decodeURIComponent(encodedSearchTerm) 
        : (typeof activeReferenceEntity !== 'undefined' && activeReferenceEntity ? activeReferenceEntity.name : null);

    // 2. Usa a Navega√ß√£o Inteligente (que lida com Superpastas e Grava√ß√£o)
    // A fun√ß√£o navigateWithUnsavedCheck garante que gravamos o quadro antes de sair
    navigateWithUnsavedCheck(() => {
        if (typeof navigateToNoteSmart === 'function') {
            // Usa a fun√ß√£o moderna que sabe mudar de p√°gina
            navigateToNoteSmart(noteId, term);
        } else {
            // Fallback de seguran√ßa (caso a fun√ß√£o smart n√£o exista por algum motivo)
            displayNote(noteId, null, term);
        }
    });
};

// --- L√ìGICA DO POPUP DE SELE√á√ÉO DE REFER√äNCIAS ---
async function openReferenceSelectionPopup() {
    const modal = document.getElementById('puzzle-ref-selection-modal');
    const list = document.getElementById('puzzle-ref-selection-list');
    
    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        alert("Selecione um t√≥pico, tag ou entidade primeiro.");
        return;
    }

    modal.style.display = 'flex';
    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar notas e ideias...</span></div>';

    allFoundReferenceBoxes = [];
    currentReferencePageIndex = 0;

    const { id, type, name } = activeReferenceEntity;
    const isHighlightSearch = (type === 'destaque');
    const searchTerm = name.toLowerCase();
    const hexToFind = isHighlightSearch ? id.toUpperCase() : null;

    try {
        let q;
        if (isHighlightSearch) {
            q = query(collection(db, 'pastas'), where('coresUsadas', 'array-contains', hexToFind), where('estado', '==', 'ativa'), where('userId', '==', auth.currentUser.uid), where('tipo', '==', 'nota'));
        } else {
            q = query(collection(db, 'pastas'), where('estado', '==', 'ativa'), where('userId', '==', auth.currentUser.uid), where('tipo', '==', 'nota'));
        }
        
        const snapshot = await getDocs(q);
        const parser = new DOMParser();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const content = data.conteudo || "";
            const noteTitle = data.nome || "Sem T√≠tulo";
            const updatedTime = data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0;

            if (data.passe && data.passe.trim() !== "" && !appSettings.searchAnchorsInProtected) return;

            const docHTML = parser.parseFromString(content, 'text/html');

            // --- 1. PROCURAR EM CAIXAS E ESTRUTURAS ---
            const allWrappers = docHTML.querySelectorAll('.mini-note-wrapper, details.toggle-section');
            allWrappers.forEach((w) => {
                let match = false;
                if (isHighlightSearch) {
                    const elColor = w.getAttribute('data-highlight');
                    if (elColor && elColor.toUpperCase() === hexToFind) match = true;
                } else {
                    if (w.textContent.toLowerCase().includes(searchTerm)) match = true;
                }

                if (match) {
                    let boxType = "Bloco"; let boxIcon = "üì¶"; let boxTitle = "";
                    if (w.tagName === 'DETAILS') {
                        boxType = "Sec√ß√£o"; boxIcon = "‚òÇÔ∏è";
                        boxTitle = w.querySelector('h2')?.textContent || "T√≠tulo da Sec√ß√£o";
                    } else if (w.classList.contains('question-mode')) {
                        boxType = "Quest√£o"; boxIcon = "üìó";
                        const t = w.querySelector('.mini-note-title-input');
                        boxTitle = t ? (t.textContent || t.value || t.getAttribute('value')) : "Quest√£o";
                    } else if (w.classList.contains('free-mode')) {
                        boxType = "Contentor"; boxIcon = "üìô";
                        boxTitle = w.querySelector('.mini-note-content')?.textContent.substring(0, 50) + "...";
                    } else {
                        boxType = "SubNota"; boxIcon = "üìò";
                        const t = w.querySelector('.mini-note-title-input');
                        boxTitle = t ? (t.textContent || t.value || t.getAttribute('value')) : "SubNota";
                    }

                    allFoundReferenceBoxes.push({
                        id: docSnap.id, name: noteTitle, snippet: w.outerHTML,
                        displaySnippet: boxTitle || "Conte√∫do da caixa",
                        typeName: boxType, typeIcon: boxIcon, updatedTime: updatedTime
                    });
                }
            });

            // --- 2. PROCURAR EM IDEIAS (üí°) ---
            if (!isHighlightSearch) {
                const allIdeas = docHTML.querySelectorAll('.idea-span');
                allIdeas.forEach(idea => {
                    if (idea.textContent.toLowerCase().includes(searchTerm)) {
                        allFoundReferenceBoxes.push({
                            id: docSnap.id, name: noteTitle, 
                            snippet: `<div style="padding:10px; border:1px solid #e74c3c; border-radius:6px; background:rgba(231,76,60,0.05); color:var(--text-color);"><span class="idea-span">${idea.innerHTML}</span></div>`,
                            displaySnippet: idea.textContent,
                            typeName: "Ideia", typeIcon: "üí°", color: "#e74c3c", 
                            updatedTime: updatedTime
                        });
                    }
                });
            }

            // --- 3. PROCURAR NO TEXTO SOLTO DA NOTA ---
            if (!isHighlightSearch && content.toLowerCase().includes(searchTerm)) {
                const bodyClone = docHTML.body.cloneNode(true);
                // Remove caixas e ideias da pesquisa de corpo para n√£o duplicar
                bodyClone.querySelectorAll('.mini-note-wrapper, details, .idea-span').forEach(el => el.remove());
                
                if (bodyClone.textContent.toLowerCase().includes(searchTerm)) {
                    const fullTxt = bodyClone.textContent;
                    const idx = fullTxt.toLowerCase().indexOf(searchTerm);
                    const start = Math.max(0, idx - 40);
                    const end = Math.min(fullTxt.length, idx + searchTerm.length + 40);
                    const snippetPreview = "..." + fullTxt.substring(start, end).trim() + "...";

                    allFoundReferenceBoxes.push({
                        id: docSnap.id, name: noteTitle,
                        snippet: `<blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; font-style: italic;">${snippetPreview}</blockquote>`,
                        displaySnippet: snippetPreview,
                        typeName: "Corpo da Nota", typeIcon: "üìÑ", updatedTime: updatedTime
                    });
                }
            }
        });

        allFoundReferenceBoxes.sort((a, b) => b.updatedTime - a.updatedTime);
        list.innerHTML = '';
        renderReferenceBoxesPage();

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar lista.</li>';
    }
}

function renderReferenceBoxesPage() {
    const list = document.getElementById('puzzle-ref-selection-list');
    const ITEMS_PER_PAGE = 15;
    
    // Remove o bot√£o "Carregar mais" antigo se existir
    const oldBtn = document.getElementById('load-more-refs-btn');
    if (oldBtn) oldBtn.remove();

    if (allFoundReferenceBoxes.length === 0) {
        list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhuma refer√™ncia encontrada.</li>';
        return;
    }

    const start = currentReferencePageIndex * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = allFoundReferenceBoxes.slice(start, end);

    pageItems.forEach(item => {
        const li = document.createElement('li');
        li.className = 'puzzle-ref-item';
        
        li.innerHTML = `
            <div class="puzzle-ref-header">
                <span class="puzzle-ref-type" style="color: var(--accent-color)">
                    ${item.typeIcon} ${item.typeName}
                </span>
                <span class="puzzle-ref-note">em ${item.name}</span>
            </div>
            <div class="puzzle-ref-snippet">
                ${item.displaySnippet}
            </div>
        `;

        // --- L√ìGICA DE CLIQUE INTELIGENTE ---
        li.onclick = async () => {
            // Se existir um activeMicaId, significa que estamos na aba Dossi√©
            if (window.activeMicaId) {
                try {
                    const collectionName = getCollectionFromType(activeReferenceEntity.type);
                    const docRef = doc(db, collectionName, activeReferenceEntity.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        let dossie = docSnap.data().dossie || [];
                        const mica = dossie.find(m => m.id === window.activeMicaId);
                        
                        if (mica) {
                            if (!mica.items) mica.items = [];
                            mica.items.push({
                                noteId: item.id,
                                noteName: item.name,
                                snippet: encodeURIComponent(item.snippet)
                            });
                            
                            await updateDoc(docRef, { dossie: dossie });
                            window.renderDossie(); // Atualiza a lista visual da Mica
                        }
                    }
                } catch (e) {
                    console.error("Erro ao salvar na Mica:", e);
                }
            } else {
                // Se n√£o houver Mica aberta, envia para o Quadro (Puzzle)
                createBoardItem('ref', {
                    noteId: item.id,
                    noteName: item.name,
                    snippet: item.snippet,
                    isClone: true
                }, true);
                if (document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active')) {
                    savePuzzleData();
                }
            }
            
            // Fecha o modal ap√≥s selecionar
            document.getElementById('puzzle-ref-selection-modal').style.display = 'none';
        };
        list.appendChild(li);
    });

    // Adiciona bot√£o "Carregar mais" se houver mais resultados
    if (end < allFoundReferenceBoxes.length) {
        currentReferencePageIndex++;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-refs-btn';
        loadMoreBtn.className = 'modal-btn secondary';
        loadMoreBtn.style.width = "100%";
        loadMoreBtn.style.marginTop = "10px";
        loadMoreBtn.textContent = `+ ${allFoundReferenceBoxes.length - end} resultados`;
        loadMoreBtn.onclick = () => renderReferenceBoxesPage();
        list.appendChild(loadMoreBtn);
    }
}

// 4. Adicionar ao Dossi√© (+Add)
document.getElementById('mica-add-content-btn').onclick = async () => {
    // Apenas abre o modal. O clique no item agora √© gerido pela fun√ß√£o de renderiza√ß√£o abaixo.
    await openReferenceSelectionPopup();
};
// --- FUN√á√ÉO DE NAVEGA√á√ÉO INTELIGENTE ENTRE SUPERPASTAS ---

/**
 * Verifica a ancestralidade da nota e decide se abre diretamente
 * ou se redireciona para outra p√°gina (note.html vs superpasta.html)
 */
async function navigateToNoteSmart(targetNoteId, searchTerm = null) {
    if (!targetNoteId) return;

    // CORRE√á√ÉO: N√£o usamos updateSaveStatus('saving') aqui.
    // Apenas mudamos o texto visualmente para o utilizador saber que algo est√° a acontecer.
    const statusEl = document.getElementById('save-status-indicator');
    if(statusEl) {
        statusEl.textContent = "A localizar nota...";
        statusEl.style.opacity = "1";
    }


    try {
        // 1. Buscar dados da nota
        const noteSnap = await getDoc(doc(db, 'pastas', targetNoteId));
        if (!noteSnap.exists()) {
            alert("Nota n√£o encontrada.");
            if(statusEl) statusEl.textContent = ""; // Limpa mensagem
            console.groupEnd();
            return;
        }
        const noteData = noteSnap.data();
        
        // 2. DETETIVE: Verificar Ancestrais (Procurar Superpasta)
        let currentParentId = noteData.parentId;
        let foundSuperfolderId = null;
        let safety = 0;

        while (currentParentId && safety < 50) {
            const parentSnap = await getDoc(doc(db, 'pastas', currentParentId));
            if (!parentSnap.exists()) break;
            
            const parentData = parentSnap.data();
            
            // Se encontrar uma superpasta
            if (parentData.superpasta === true) {
                foundSuperfolderId = currentParentId;
                break; 
            }
            currentParentId = parentData.parentId;
            safety++;
        }

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

       // 3. DECIS√ÉO FINAL (Unificada)
        console.groupEnd();
        
        // Reconstr√≥i caminho e abre nota
        await reconstructNavigationPath(targetNoteId);
        displayNote(targetNoteId, null, searchTerm);
        
        // Restaura o texto de estado
        if(statusEl) updateSaveStatus('saved');

    } catch (error) {
        console.error("Erro navega√ß√£o:", error);
        console.groupEnd();
        if(statusEl) statusEl.textContent = "Erro ao navegar";
    }
}

async function reconstructNavigationPath(noteId) {
    let currentId = noteId;
    const path = [];
    let safety = 0;
    while (currentId && safety < 20) {
        const docSnap = await getDoc(doc(db, 'pastas', currentId));
        if (!docSnap.exists()) break;
        const data = docSnap.data();
        if (!data.parentId) { // Raiz
            if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
            break;
        }
        if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
        currentId = data.parentId;
        safety++;
    }
    navigationStack = path;
    updateNavigationView(true, noteId); 
}

// ============================================================
// FUN√á√ïES AUXILIARES EM FALTA (COLE ISTO ANTES DO savePuzzleData)
// ============================================================

// 1. Mapear tipos para nomes de cole√ß√µes no Firebase
function getCollectionFromType(type) {
    if (ENTITY_CONFIG[type]) return ENTITY_CONFIG[type].collection;
    
    // Casos especiais
    if (type === 'topico') return 'topicos';
    if (type === 'subtopico') return 'subtopicos';
    if (type === 'tag') return 'tags';
     if (type === 'marcadores') return 'marcadores';
    
    return null;
}

// 2. For√ßar a grava√ß√£o e sa√≠da do modo de edi√ß√£o (Crucial para a navega√ß√£o)
async function forceSaveAndClosePuzzleMode() {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // S√≥ faz algo se estivermos no modo "Conclu√≠do" (ativo)
    if (container && container.classList.contains('edit-mode-active')) {

        // 1. GRAVAR NO FIREBASE (Aguarda terminar antes de continuar)
        await savePuzzleData();

        // 2. DESLIGAR MODO DE EDI√á√ÉO (Visual)
        container.classList.remove('edit-mode-active');

        // Restaurar bot√£o principal
        if (btn) {
            btn.textContent = "Editar";
            btn.style.color = "";
            btn.style.borderColor = "";
            btn.style.backgroundColor = "";
        }

        // Esconder bot√µes de adicionar
        if (addButtons) {
            addButtons.style.display = 'none';
        }

        // 3. BLOQUEAR AS CAIXAS DE TEXTO
        // Transformar de edit√°veis para est√°ticas
        const editableDivs = container.querySelectorAll('.board-text-content');
        editableDivs.forEach(div => {
            div.setAttribute('contenteditable', 'false');
            // Remove estilo de input
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
}

// ============================================================

async function savePuzzleData() {
    if (!activeReferenceEntity || !activeReferenceEntity.name) return;

    const { id, type, name } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    
    const saveBtn = document.getElementById('toggle-puzzle-edit-btn');
    if(saveBtn) saveBtn.textContent = "A gravar...";

    try {
        const itemsToSave = [];
        const cards = document.querySelectorAll('#puzzle-board-container .board-card');

        cards.forEach(card => {
            if (card.classList.contains('type-text')) {
                const contentDiv = card.querySelector('.board-text-content');
                if (contentDiv) itemsToSave.push({ type: 'text', content: contentDiv.innerHTML });
            } 
            else if (card.classList.contains('type-ref')) {
                itemsToSave.push({ 
                    type: 'ref', 
                    noteId: card.dataset.noteId,
                    noteName: card.dataset.noteName,
                    snippet: decodeURIComponent(card.dataset.snippet)
                });
            }
        });

        // --- CORRE√á√ÉO DE SEGURAN√áA ---
        let docRef;
        
        // Se o ID atual parece um nome de vers√≠culo (tem espa√ßos ou :), ou se √© null
        // vamos procurar se o user j√° tem um doc real para isto
        if (!id || id.includes(' ') || id.includes(':')) {
            const q = query(
                collection(db, collectionName), 
                where("nome", "==", name),
                where("userId", "==", auth.currentUser.uid)
            );
            const snap = await getDocs(q);
            
            if (!snap.empty) {
                // J√° existe um documento real, usamos o ID dele
                docRef = doc(db, collectionName, snap.docs[0].id);
                activeReferenceEntity.id = snap.docs[0].id; 
            } else {
                // N√£o existe? Criamos um NOVO documento com ID aleat√≥rio (addDoc)
                const newDoc = await addDoc(collection(db, collectionName), {
                    nome: name,
                    userId: auth.currentUser.uid,
                    puzzleBoard: itemsToSave,
                    updatedAt: serverTimestamp(),
                    createdAt: serverTimestamp()
                });
                activeReferenceEntity.id = newDoc.id; // Atualiza para o ID novo
                return; // J√° gravou, podemos sair
            }
        } else {
            // Se j√° temos um ID hexadecimal (aleat√≥rio), gravamos direto
            docRef = doc(db, collectionName, id);
        }

        // Grava√ß√£o final (Update ou Set)
        await setDoc(docRef, {
            nome: name,
            userId: auth.currentUser.uid,
            puzzleBoard: itemsToSave,
            updatedAt: serverTimestamp()
        }, { merge: true });

    } catch (e) {
        console.error("‚ùå Erro ao gravar:", e);
        alert("Erro de permiss√£o: Este vers√≠culo pode estar mal configurado no banco de dados.");
    } finally {
        if(saveBtn) saveBtn.textContent = "Editar";
    }
}

// --- NOVO LOAD (Unificado) ---
async function loadPuzzleData(entityId, entityType) {
    const container = document.getElementById('puzzle-board-container');
    const emptyMsg = document.getElementById('puzzle-empty-msg');

    // 1. Limpeza visual imediata do quadro antes de carregar
    if (container) container.querySelectorAll('.board-card').forEach(el => el.remove());

    const collectionName = getCollectionFromType(entityType);
    if (!collectionName) return;

    try {
        let entityDoc = null;

        // 2. Tentar carregar por ID (se o ID for enviado e for v√°lido)
        if (entityId) {
            const docRef = doc(db, collectionName, entityId);
            const snap = await getDoc(docRef);
            if (snap.exists()) entityDoc = snap;
        }

        // 3. Se n√£o encontrou por ID (ou ID era null), procura pelo CAMPO "nome"
        if (!entityDoc) {
            const nameToFind = activeReferenceEntity.name; // "Ecclesiastes 9:11"
            
            // IMPORTANTE: Precisamos importar query, where e getDocs se n√£o estiverem no topo
            const q = query(
                collection(db, collectionName), 
                where("nome", "==", nameToFind),
                where("userId", "==", auth.currentUser.uid)
            );
            
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                entityDoc = querySnapshot.docs[0];
                // Sincroniza o ID real do documento na vari√°vel global para permitir edi√ß√£o/save
                activeReferenceEntity.id = entityDoc.id; 
            }
        }

        // 4. Verifica√ß√£o final: se ap√≥s a busca ainda n√£o existe nada
        if (!entityDoc || !entityDoc.exists()) {
            if (emptyMsg) emptyMsg.style.display = 'block';
            return;
        }

        // 5. Renderizar os dados encontrados
        const data = entityDoc.data();
        let boardItems = data.puzzleBoard || [];

        if (boardItems.length === 0) {
            if (emptyMsg) emptyMsg.style.display = 'block';
            return;
        }
        
        if (emptyMsg) emptyMsg.style.display = 'none';

        boardItems.forEach(item => {
            createBoardItem(item.type, {
                content: item.content,
                noteId: item.noteId,
                noteName: item.noteName,
                snippet: item.snippet
            });
        });

    } catch (e) { 
        console.error("‚ùå [PUZZLE] Erro ao carregar dados do quadro:", e); 
    }
}

// ====================================================================
// ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT JAVASCRIPT
// ====================================================================
async function showTagReferencesPanel(tagName) {
    
    // 1. Gravar o puzzle anterior se estivesse em modo edi√ß√£o
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI();

    // 2. DEFINIR ENTIDADE ATIVA (Essencial para o +Ref do Quadro)
    activeReferenceEntity = { 
        id: tagName, 
        type: 'tag', 
        name: tagName 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Cita√ß√µes de #${tagName}`;

    // For√ßar a aba "Cita√ß√µes" a abrir para listar as notas
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Carregar os dados do Quadro (Puzzle) salvos para esta Tag
    loadPuzzleData(tagName, 'tag');
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar notas com #${tagName}...</span>
        </div>`;

    try {
        // 4. Pesquisa no Firestore: Notas ativas com a tag espec√≠fica
        const q = query(
            collection(db, 'pastas'), 
            where('tags', 'array-contains', tagName),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const querySnapshot = await getDocs(q);
        
        // 5. Reset da lista global de resultados
        allCitationsResults = []; 

        querySnapshot.forEach(noteDoc => {
            const data = noteDoc.data();
            
            // Filtro de Privacidade
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            if (isItemProtected && !appSettings.searchTagsInProtected) {
                return; 
            }
            
            // Preparar o Snippet visual para quando for adicionado ao quadro
            const tagSnippet = `<p style="color:#3498db; font-weight:bold;">üè∑Ô∏è Nota com tag #${tagName}</p>`;

            // Alimenta o array global para pagina√ß√£o
            allCitationsResults.push({ 
                id: noteDoc.id, 
                name: data.nome, 
                isProtected: isItemProtected,
                snippet: tagSnippet,
                ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
            });
        });

        // 6. ORDENAR: Mais recente primeiro
        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);

        // 7. Renderizar a primeira p√°gina (false = resetar lista visual)
        window.renderCitationsPage(false);

    } catch (error) {
        console.error("Erro ao carregar cita√ß√µes da tag:", error);
        listElement.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao processar as notas no banco de dados.</li>';
    }
}


// ============================================================
// MOTOR DA 4¬™ COLUNA - B√çBLIA P√öBLICA + PUZZLE PRIVADO (FIXED)
// ============================================================

function resetReferencesPanelUI() {
    // 1. Esconder todos os conte√∫dos de abas
    document.querySelectorAll('.ref-tab-content').forEach(el => {
        el.style.display = 'none';
    });

    // 2. Mostrar apenas o conte√∫do do Puzzle (padr√£o de abertura)
    const puzzleContent = document.getElementById('ref-content-puzzle');
    if (puzzleContent) puzzleContent.style.display = 'flex';

    // 3. Resetar visual dos bot√µes das abas
    document.querySelectorAll('#ref-tabs button').forEach(btn => {
        btn.classList.remove('active');
    });
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTabBtn) puzzleTabBtn.classList.add('active');

    // 4. Limpar a lista de Links (Doc.)
    const linksList = document.getElementById('panel-links-list');
    if (linksList) linksList.innerHTML = '';

    // 5. RESET DO MODO EDI√á√ÉO (Links/Doc)
    isPanelEditMode = false;
 isPanelEditMode = false;
    const editLinksBtn = document.getElementById('toggle-links-edit-btn');
    const linksActions = document.getElementById('links-edit-actions');
    if (editLinksBtn) {
        editLinksBtn.textContent = "Editar";
        editLinksBtn.style.color = "";
        editLinksBtn.style.borderColor = "";
        editLinksBtn.style.backgroundColor = "";
    }
    if (linksActions) linksActions.style.display = 'none';

    // ============================================================
    // üöÄ LIMPEZA AGRESSIVA DO DOSSI√â (IMPEDE O BOT√ÉO DE PISCAR)
    // ============================================================
    window.isDossieEditMode = false; 
    window.activeMicaId = null;

    // A. Esconder IMEDIATAMENTE o contentor de bot√µes de edi√ß√£o (+ Micas)
    const dossieEditActions = document.getElementById('dossie-edit-actions');
    if (dossieEditActions) {
        dossieEditActions.style.display = 'none';
    }

    // B. Resetar o bot√£o de altern√¢ncia "Editar"
    const dossieEditBtn = document.getElementById('toggle-dossie-edit-btn');
    if (dossieEditBtn) {
        dossieEditBtn.textContent = "Editar";
        dossieEditBtn.style.display = 'block';
        dossieEditBtn.style.color = "";
        dossieEditBtn.style.borderColor = "";
        dossieEditBtn.style.backgroundColor = "";
    }
    
    // C. Esconder bot√µes de navega√ß√£o interna
    const micaBackBtn = document.getElementById('mica-back-btn');
    const micaAddBtn = document.getElementById('mica-add-content-btn');
    if (micaBackBtn) micaBackBtn.style.display = 'none';
    if (micaAddBtn) micaAddBtn.style.display = 'none';

    // D. Limpar o t√≠tulo visual
    const dossieTitle = document.getElementById('dossie-view-title');
    if (dossieTitle) dossieTitle.textContent = "Micas";

    // E. Limpar a lista visual para n√£o mostrar as micas da nota anterior
    const dossieContainer = document.getElementById('dossie-list-container');
    if (dossieContainer) dossieContainer.innerHTML = '';
}




async function showReferencesPanel(entityId, entityName, entityType, anexoId = null) {
    if (window.innerWidth <= 768) {
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
            document.activeElement.blur();
        }
    }

    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI(); 

    activeReferenceEntity = { 
        id: entityId || entityName, 
        type: entityType, 
        name: entityName 
    };

    notebookContainer.classList.add('references-panel-visible');

    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    const puzzleTab = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTab) puzzleTab.classList.add('active');

    document.getElementById('ref-content-puzzle').style.display = 'flex';
    document.getElementById('ref-content-references').style.display = 'none';

    referencesPanelTitle.textContent = `Refer√™ncias: ${entityName}`;
    const descElement = document.getElementById('references-panel-description');
    const editBtn = document.getElementById('references-edit-btn');
    
    // Configura bot√µes padr√£o
    editBtn.style.display = 'block';
    document.getElementById('references-wol-btn').style.display = 'none';
    document.getElementById('references-bookmark-btn').style.display = 'none';

    // ============================================================
    // ROTEAMENTO DE BUSCA (A M√ÅGICA EST√Å AQUI)
    // ============================================================
    
    // A. PESQUISA POR METADADOS (T√≥picos e Vers√≠culos Salvos)
    if (entityType === 'topico' || entityType === 'textobiblico') {
        if (entityType === 'textobiblico') {
            editBtn.style.display = 'none';
            document.getElementById('references-wol-btn').style.display = 'block';
            document.getElementById('references-bookmark-btn').style.display = 'block';
            
            descElement.innerHTML = `<em>A consultar biblioteca...</em>`;
            const texto = await fetchBibleText(entityName);
            descElement.innerHTML = texto ? `<div style="color:var(--text-color); font-size:0.95em;">"${texto}"</div>` : `<em>Texto n√£o dispon√≠vel.</em>`;
        }
        renderTopicResultsList(entityId, entityType); 
    } 
    
    // B. PESQUISA POR TEXTO EXATO (Personagens, Locais, Datas e Cosmos)
    else {
        // Personagem, Local, Data, Subcosmos
        renderUniversalTextSearch(entityName);
        
        // Tenta carregar a descri√ß√£o do item
        try {
            const coll = getCollectionFromType(entityType);
            if (coll) {
                const docSnap = await getDoc(doc(db, coll, entityId));
                if (docSnap.exists()) {
                    descElement.textContent = docSnap.data().descricao || 'Sem descri√ß√£o definida.';
                }
            }
        } catch(e) { descElement.textContent = 'Sem descri√ß√£o.'; }
    }

    loadPuzzleData(entityId, entityType);
}


// 2. BUSCAR TEXTO NA BIBLIOTECA P√öBLICA (COMUM)
async function fetchBibleText(fullReference) {
    try {
        const q = query(collection(db, 'bible_verses_public'), where('nome', '==', fullReference));
        const snap = await getDocs(q);
        if (!snap.empty) {
            return snap.docs[0].data().texto;
        }
    } catch (e) { console.error("Erro na bibl. p√∫blica:", e); }
    return null;
}

// 3. GRAVA√á√ÉO P√öBLICA + PRIVADA
async function saveTextToFirestore(name, text) {
    try {
        // Grava no P√∫blico (Texto para todos)
        const publicRef = collection(db, 'bible_verses_public');
        const qPub = query(publicRef, where('nome', '==', name));
        const snapPub = await getDocs(qPub);
        if (snapPub.empty) {
            await addDoc(publicRef, { nome: name, texto: text, contribuidoPor: auth.currentUser.uid, createdAt: serverTimestamp() });
        }

        // Grava no Privado (Cria entrada para o utilizador ter o seu pr√≥prio Puzzle)
        const userColl = collection(db, 'textosbiblicos');
        const qUser = query(userColl, where('nome', '==', name), where('userId', '==', auth.currentUser.uid));
        const snapUser = await getDocs(qUser);
        if (snapUser.empty) {
            await addDoc(userColl, { nome: name, descricao: text, userId: auth.currentUser.uid, createdAt: serverTimestamp(), referencias: {} });
        }
        
        if (typeof fetchAllEntities === 'function') fetchAllEntities();
    } catch (e) { console.error("Erro ao salvar:", e); }
}

// Prompt manual
window.manualInsertBibleText = async function(name) {
    const text = prompt(`Copie o texto e cole aqui para ficar dispon√≠vel na biblioteca comum (${name}):`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        showReferencesPanel(null, name, 'textobiblico');
    }
};



window.manualInsertBibleText = async function(name) {
    const text = prompt(`Digite ou cole o texto de ${name}:`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        // Recarrega o painel
        showReferencesPanel(null, name, 'textobiblico');
    }
};

// ============================================================
// 3. INSER√á√ÉO MANUAL E GRAVA√á√ÉO DEFINITIVA
// ============================================================
window.manualInsertBibleText = async function(name) {
    const text = prompt(`Digite ou cole o texto de ${name}:`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        // Recarrega o painel para exibir o texto gravado
        showReferencesPanel(null, name, 'textobiblico');
    }
};


window.manualInsertBibleText = async function(name) {
    const text = prompt(`Copie o texto da B√≠blia Online e cole aqui (${name}):`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        showReferencesPanel(null, name, 'textobiblico');
    }
};


async function hideReferencesPanel() {
    // 1. Grava o puzzle anterior se estivesse em modo edi√ß√£o (J√° existente)
    await forceSaveAndClosePuzzleMode();

    // 2. RESET DO DOSSI√â: Volta ao modo visualiza√ß√£o e sai de dentro de qualquer Mica
    window.isDossieEditMode = false;
    window.activeMicaId = null; // Garante que ao reabrir, volta a ver a lista de Micas
    
    // Atualiza o visual do Dossi√© (remove bot√µes de edi√ß√£o e limpa filtros)
    if (typeof window.renderDossie === 'function') {
        window.renderDossie();
    }

    // 3. L√≥gica de fecho visual (CSS)
    notebookContainer.classList.remove('references-panel-visible');
    
    // Limpar Vers√≠culo Selecionado (caso estivesse na B√≠blia)
    currentlyOpenVerseName = null;
    document.querySelectorAll('.bible-grid-btn.active-verse').forEach(btn => {
        btn.classList.remove('active-verse');
    });

    const descriptionElement = document.getElementById('references-panel-description');
    if (descriptionElement) {
        descriptionElement.textContent = '';
    }

    // Ajuste de altura para Mobile (Reset do arraste)
    const refPanel = document.getElementById('references-panel');
    if (window.innerWidth <= 768 && refPanel) {
        setTimeout(() => {
            refPanel.style.height = "60vh"; 
        }, 400);
    }
}

 function generateReferenceContext(noteContent, entityName) {
    // 1. Criar um contentor tempor√°rio
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = noteContent;

    // SEPARADOR M√ÅGICO
    const SEPARATOR = " ||| "; 

    // 2. ESTRAT√âGIA DE INJE√á√ÉO MELHORADA
    
    // A. Substituir quebras de linha manuais (<br>) pelo separador
    const brs = tempDiv.querySelectorAll('br');
    brs.forEach(br => {
        br.replaceWith(document.createTextNode(SEPARATOR));
    });

    // B. Injetar separador no IN√çCIO de cada bloco
    // Isto resolve o problema "fiel[NOVA LINHA]David". 
    // Ao p√¥r no in√≠cio da div do "David", garantimos "fiel ||| David".
    const blockTags = 'p, div, li, h1, h2, h3, h4, h5, h6, tr, td, th, blockquote, ul, ol, pre, section, article';
    const blocks = tempDiv.querySelectorAll(blockTags);
    
    blocks.forEach(el => {
        // Prepend (Inserir antes do primeiro filho)
        el.insertBefore(document.createTextNode(SEPARATOR), el.firstChild);
        
        // (Opcional) Tamb√©m adicionar ao fim para garantir isolamento total
        el.appendChild(document.createTextNode(SEPARATOR));
    });

    // 3. EXTRAIR TEXTO (Agora "David" est√° protegido por separadores)
    let plainText = tempDiv.textContent;
    
    // Normalizar espa√ßos
    plainText = plainText.replace(/\s+/g, ' ');

    // 4. ENCONTRAR A ENTIDADE
    const lowerText = plainText.toLowerCase();
    const lowerEntity = entityName.toLowerCase();
    const position = lowerText.indexOf(lowerEntity);

    if (position === -1) {
        return '<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>';
    }

    // 5. DELIMITAR IN√çCIO (Recuar at√© Pontua√ß√£o ou Separador)
    const textBefore = plainText.substring(0, position);
    const lastSeparatorIndex = textBefore.lastIndexOf(SEPARATOR);
    
    // Regex para √∫ltima pontua√ß√£o (., !, ?) seguida de espa√ßo
    const punctuationMatch = textBefore.match(/([.!?])\s+(?!.*[.!?])/); 
    const lastPunctuationIndex = punctuationMatch ? punctuationMatch.index + 1 : -1;

    let start = 0;
    // Quem estiver mais perto da palavra (maior √≠ndice) ganha
    if (lastSeparatorIndex > lastPunctuationIndex) {
        start = lastSeparatorIndex + SEPARATOR.length;
    } else if (lastPunctuationIndex > -1) {
        start = lastPunctuationIndex + 1;
    }

    // 6. DELIMITAR FIM (Avan√ßar at√© Pontua√ß√£o ou Separador)
    // AQUI √â QUE A M√ÅGICA ACONTECE PARA O SEU EXEMPLO
    
    // A. Separador depois da palavra
    let nextSeparatorIndex = plainText.indexOf(SEPARATOR, position + entityName.length);
    if (nextSeparatorIndex === -1) nextSeparatorIndex = plainText.length;

    // B. Pontua√ß√£o depois da palavra
    const textAfter = plainText.substring(position + entityName.length);
    const nextPunctuationMatch = textAfter.match(/[.!?]/);
    
    let nextPunctuationIndex = plainText.length;
    if (nextPunctuationMatch) {
        nextPunctuationIndex = position + entityName.length + nextPunctuationMatch.index + 1;
    }

    // Regra: O que aparecer PRIMEIRO corta a frase.
    // No seu exemplo: N√£o h√° pontua√ß√£o, mas h√° o SEPARATOR do "David". O SEPARATOR ganha.
    let end = Math.min(nextSeparatorIndex, nextPunctuationIndex);

    // 7. CORTE FINAL E LIMPEZA
    let snippet = plainText.substring(start, end).trim();

    // Remove qualquer lixo de separador que tenha sobrado
    snippet = snippet.split(SEPARATOR)[0].trim(); // Seguran√ßa extra
    snippet = snippet.replace(/\|\|\|/g, '').trim();

    // Corte de seguran√ßa para textos gigantes
    if (snippet.length > 250) {
        const localPos = snippet.toLowerCase().indexOf(lowerEntity);
        const cutStart = Math.max(0, localPos - 60);
        const cutEnd = Math.min(snippet.length, localPos + entityName.length + 100);
        snippet = (cutStart > 0 ? "..." : "") + snippet.substring(cutStart, cutEnd) + "...";
    }

    // 8. HIGHLIGHT
    const safeEntity = entityName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedText = snippet.replace(
        new RegExp(`(${safeEntity})`, 'gi'), 
        `<mark>$1</mark>`
    );

    return `<p>${highlightedText}</p>`;
}

// ====================================================================
// FUN√á√ÉO: CONVERTER SELE√á√ÉO EM CART√ÉO WEB (Com Timeout de 10s)
// ====================================================================
async function convertSelectionToUrlCard() {
    let selection = window.getSelection();
    
    // --- 1. SMART SELECT (Corre√ß√£o para o seu problema) ---
    // Se n√£o houver nada selecionado (cursor apenas a piscar),
    // ou se estivermos dentro de um link, vamos tentar selecionar o elemento todo.
    
    const anchorNode = selection.anchorNode ? (selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode) : null;
    const linkElement = anchorNode ? anchorNode.closest('a') : null;

    if (linkElement) {
        // Se o cursor estiver dentro de um <a>, seleciona o <a> inteiro
        const range = document.createRange();
        range.selectNode(linkElement);
        selection.removeAllRanges();
        selection.addRange(range);
    } 
    else if (selection.isCollapsed && anchorNode) {
        // Se for texto solto (n√£o link) e n√£o houver sele√ß√£o,
        // tenta selecionar a "palavra" inteira onde o cursor est√° (o URL gigante)
        if (selection.modify) {
            selection.modify('move', 'backward', 'word');
            selection.modify('extend', 'forward', 'word');
        }
    }
    // -----------------------------------------------------

    if (!selection.rangeCount) return;

    // Guardar o texto para usar como t√≠tulo se necess√°rio
    const userSelectedText = selection.toString().trim();

    // 2. Obter URL
    let url = userSelectedText;
    
    // Se acab√°mos de selecionar um elemento <a>, usamos o href real
    if (selection.anchorNode) {
        const parentA = selection.anchorNode.parentElement.closest('a');
        if (parentA) url = parentA.href;
    }

    if (!url || !url.includes('.')) { 
        alert("Selecione um link v√°lido primeiro."); 
        return; 
    }

    if (!url.startsWith('http')) url = 'https://' + url;

    // 3. Criar Placeholder
    const cardId = `card_${Date.now()}`;
    
    // NOTA: Adicionamos um espa√ßo &nbsp; no fim para o cursor poder sair do card
    const cardHtml = `
        <div class="url-card-widget" id="${cardId}" draggable="true" contenteditable="false" data-original-url="${url}">
            <div class="url-card-loading">
                <div class="spinner" style="width:20px; height:20px; border-width:2px; margin-right:10px;"></div>
                A gerar...
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        </div><span>&nbsp;</span>
    `;

    // 4. SUBSTITUI√á√ÉO TOTAL
    // Como garantimos a sele√ß√£o no passo 1, este comando vai apagar o texto do link
    // e colocar o card no lugar dele.
    document.execCommand('insertHTML', false, cardHtml);
    
    // Esconder popup se estiver aberto
    if(document.getElementById('selection-popup')) 
        document.getElementById('selection-popup').style.display = 'none';

    // --- FUN√á√ïES AUXILIARES (Mant√™m-se iguais) ---
    const getRandomImage = () => {
        const images = [
            "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=400&q=80",
            "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=400&q=80",
            "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=400&q=80",
            "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&q=80",
            "https://images.unsplash.com/photo-1506259091721-347f7d3bbcff?w=400&q=80"
        ];
        return images[Math.floor(Math.random() * images.length)];
    };

    const formatFallbackTitle = (link) => {
        if (userSelectedText && userSelectedText !== link && !userSelectedText.startsWith('http')) {
            return userSelectedText;
        }
        try {
            const urlObj = new URL(link);
            if (urlObj.hostname.includes('jw.org') || urlObj.hostname.includes('wol.jw')) {
                return "Publica√ß√£o JW";
            }
            return urlObj.hostname.replace('www.', '');
        } catch (e) { return "Liga√ß√£o Externa"; }
    };

    const updateCardUI = (title, image, logo, publisher) => {
        const cardEl = document.getElementById(cardId);
        if (!cardEl) return;

        let displayTitle = title;
        if (!displayTitle || displayTitle.toLowerCase() === 'finder' || displayTitle.toLowerCase() === 'watchtower online library') {
            displayTitle = null;
        }
        if (!displayTitle && userSelectedText && !userSelectedText.startsWith('http')) {
            displayTitle = userSelectedText;
        }
        if (!displayTitle) {
            displayTitle = formatFallbackTitle(url);
        }

        cardEl.innerHTML = `
            <div class="url-card-image" style="background-image: url('${image}');"></div>
            <div class="url-card-info">
                <div class="url-card-title">${displayTitle}</div>
                <div class="url-card-domain">
                    <img src="${logo}" style="width:12px; height:12px; vertical-align:middle; margin-right:4px; border-radius:50%;">
                    ${publisher}
                </div>
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        `;
        saveNote();
    };

    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
    const fetchPromise = fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`).then(res => res.json());

    try {
        const data = await Promise.race([fetchPromise, timeoutPromise]);
        const meta = (data.status === 'success' && data.data) ? data.data : {};
        
        const finalTitle = meta.title;
        const finalImage = meta.image?.url || getRandomImage();
        const finalPublisher = meta.publisher || new URL(url).hostname;
        const finalLogo = meta.logo?.url || 'https://cdn-icons-png.flaticon.com/128/1006/1006771.png';

        updateCardUI(finalTitle, finalImage, finalLogo, finalPublisher);
    } catch (err) {
        const fallbackTitle = formatFallbackTitle(url);
        const fallbackImg = getRandomImage();
        const domain = new URL(url).hostname;
        const fallbackLogo = 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
        updateCardUI(fallbackTitle, fallbackImg, fallbackLogo, domain);
    }
}

// --- L√ìGICA DO EDITOR RICO E TAGS ---

function showTagPopup(query) {
    const filteredTags = allTags.filter(tag => tag.nome.toLowerCase().includes(query.toLowerCase()));
    tagSuggestionList.innerHTML = '';
    if (filteredTags.length > 0) {
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag.nome;
            li.dataset.tagNome = tag.nome;
            tagSuggestionList.appendChild(li);
        });
    } else if (query) {
        const li = document.createElement('li');
        li.innerHTML = `Criar nova tag: "<strong>${query}</strong>"`;
        li.dataset.tagNome = query;
        tagSuggestionList.appendChild(li);
    } else {
         hideTagPopup(); return;
    }
    const rect = currentTagQueryRange.getBoundingClientRect();
    tagSuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
    tagSuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
    tagSuggestionPopup.style.display = 'block';
    isTagPopupOpen = true;
    tagSuggestionList.firstChild.classList.add('selected');
}

 function hideTagPopup() {
    tagSuggestionPopup.style.display = 'none';
    isTagPopupOpen = false;
    currentTagQueryRange = null; // Importante: limpa o range para evitar reaberturas acidentais
}


function navigateTagSuggestions(key) {
    const items = Array.from(tagSuggestionList.children);
    if(items.length === 0) return;
    const selected = tagSuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

async function commitTagSelection() {
    const selectedLi = tagSuggestionList.querySelector('.selected');
    if (!selectedLi) {
        hideTagPopup();
        return;
    }

    const tagName = selectedLi.dataset.tagNome.trim();
    if (!tagName) { 
        hideTagPopup(); 
        return; 
    }

    // Verifica/Cria a tag no banco de dados
    let tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tagExists) await createNewTag(tagName);

    // Insere no editor
    insertTagIntoEditor(tagName);
    
    // FOR√áA O FECHO IMEDIATO
    hideTagPopup();
}

async function createNewTag(tagName) {
    try {
        // Verifica se a tag j√° existe na lista LOCAL (que j√° √© filtrada por user)
        // para evitar chamadas desnecess√°rias √† base de dados.
        const tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
        
        if (tagExists) {
            return;
        }

        const tagsCollection = collection(db, 'tags');
        const newTagRef = await addDoc(tagsCollection, { 
            nome: tagName, 
            userId: auth.currentUser.uid, // GRAVA√á√ÉO DO USER ID
            createdAt: serverTimestamp() 
        });
        
        // Atualiza o cache local imediatamente
        allTags.push({ id: newTagRef.id, nome: tagName });

    } catch (error) { 
        console.error("Erro ao criar nova tag:", error); 
    }
}


async function fetchAllTags() {
    if (!auth.currentUser) return;
    try {
        const tagsCollection = collection(db, 'tags');
        // FILTRO OBRIGAT√ìRIO
        const q = query(tagsCollection, where('userId', '==', auth.currentUser.uid));
        
        const tagsSnapshot = await getDocs(q);
        
        // Limpa e reconstr√≥i o array global
        allTags = tagsSnapshot.docs.map(doc => ({
            id: doc.id,
            nome: doc.data().nome || doc.data().name 
        })).filter(tag => tag.nome); // Filtra tags sem nome
        
    } catch (error) {
        console.error("Erro ao carregar tags:", error);
    }
}


function insertTagIntoEditor(tagName) {
    if (!currentTagQueryRange) return;

    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = `#${tagName}`;
    tagSpan.setAttribute('contenteditable', 'false'); 
    const spaceNode = document.createTextNode('\u00A0');
    currentTagQueryRange.deleteContents();
    currentTagQueryRange.insertNode(spaceNode); 
    currentTagQueryRange.insertNode(tagSpan);  
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
    currentTagQueryRange = null;
}



// ============================================================
// L√ìGICA DE NAVEGA√á√ÉO MOBILE
// ============================================================

// 1. Ao clicar numa PASTA (Esquerda -> Meio)
// Adicione isto ao seu listener existente do 'leftPanelList' ou use este auxiliar:
const originalLeftClick = leftPanelList.onclick; // Preserva l√≥gica antiga se existir
leftPanelList.addEventListener('click', (e) => {
    const item = e.target.closest('.list-item');
    if (!item) return;
    
    // Se for clique em menu ou expandir, ignora
    if (e.target.closest('.item-menu-btn')) return;

    // Se a largura for mobile, avan√ßa para o painel do meio
    if (window.innerWidth <= 768) {
        document.body.classList.add('mobile-view-middle');
        document.body.classList.remove('mobile-view-editor');
    }
});



// 3. Bot√£o VOLTAR (Corre√ß√£o: Refer√™ncia Global + Clique √önico)
// Certifique-se que n√£o apaga a linha 'const backBtn = ...' no in√≠cio do script

if (backBtn) {
    backBtn.onclick = () => {
        // A√ß√£o encapsulada para verificar altera√ß√µes n√£o guardadas antes de retroceder
        const goBackAction = () => {
            
            // CASO 1: Navega√ß√£o Profunda (Pastas ou B√≠blia)
            if (navigationStack.length > 0) {
                // Remove o √∫ltimo n√≠vel da pilha (ex: sai do Cap√≠tulo para o Livro)
                navigationStack.pop();
                
                // Limpa a nota selecionada para resetar o estado visual do editor
                selectedNoteId = null;
                
                // No Mobile: Se a pilha ficar vazia, voltamos ao Painel Esquerdo (Pastas/Categorias)
                if (navigationStack.length === 0 && window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.remove('mobile-view-editor');
                }
                
                // Atualiza a vista dos pain√©is com base no novo estado da stack
                // O par√¢metro 'true' mant√©m o editor aberto se houver conte√∫do
                updateNavigationView(true);
            } 
            
            // CASO 2: Sair do modo "Partilha" para o modo "Local"
            // Se estivermos na raiz da partilha, o bot√£o voltar regressa √†s pastas locais
            else if (currentViewMode === 'shared') {
                
                // Fun√ß√£o global que j√° limpa ouvintes e reseta a stack
                if (typeof window.switchFolderView === 'function') {
                    window.switchFolderView('local');
                }
                
                // No Mobile: Garante que volta para a vis√£o da barra lateral esquerda
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                }
            }
        };

        // Executa o Gatekeeper de grava√ß√£o antes de realizar a navega√ß√£o
        if (typeof navigateWithUnsavedCheck === 'function') {
            navigateWithUnsavedCheck(goBackAction);
        } else {
            // Fallback caso a fun√ß√£o de prote√ß√£o n√£o esteja dispon√≠vel
            goBackAction();
        }
    };
}

// 4. Bot√£o VOLTAR do Editor (Direita -> Meio)
 if (mobileBackBtn) {
    mobileBackBtn.addEventListener('click', async (e) => {
        e.preventDefault(); 
        
        // 1. Grava o estado atual da nota antes de sair
        if (typeof saveNote === 'function' && selectedNoteId) {
            await saveNote(true); 
        }

        // 2. Ativa o escudo para impedir grava√ß√µes acidentais durante o fecho
        isClosingNote = true; 

        // 3. Limpa timers pendentes
        if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);

        const idToScroll = selectedNoteId;
        selectedNoteId = null;

        // 4. Limpa o visual do editor
        const titleInput = document.getElementById('note-title-input');
        const contentEditor = document.getElementById('note-content-editor');
        if (titleInput) titleInput.value = "";
        if (contentEditor) contentEditor.innerHTML = "";

        // 5. Troca as vistas Mobile (Esconde Editor, Mostra Lista)
        const container = document.querySelector('.notebook-container');
        if (container) container.classList.remove('middle-panel-collapsed');
        document.body.classList.remove('mobile-view-editor');
        document.body.classList.add('mobile-view-middle');

        // 6. Faz scroll para a nota que estava aberta na lista
        if (idToScroll) {
            setTimeout(() => {
                const noteItem = document.querySelector(`#file-list .list-item[data-id="${idToScroll}"]`);
                if (noteItem) {
                    noteItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 150);
        }

        // 7. ATUALIZA OS BOT√ïES FLUTUANTES
        updateMobileFABVisibility();
    });
}


// ====================================================================
// MOTOR DO CALEND√ÅRIO (Agenda Firebase)
// ====================================================================

// 1. Delegar eventos globais no Editor (porque o HTML √© din√¢mico)
noteContentEditor.addEventListener('click', (e) => {
    // A. Clique no bot√£o de defini√ß√µes (‚öôÔ∏è)
    if (e.target.closest('.cal-settings')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const menu = widget.querySelector('.cal-settings-menu');
        menu.classList.toggle('visible');
    }
 // >>> NOVO BLOCO: ELIMINAR CALEND√ÅRIO <<<
    else if (e.target.classList.contains('cal-delete-btn')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        
        // Pede confirma√ß√£o (pode usar o seu showConfirmation ou o confirm nativo)
        if (confirm("Tem a certeza que deseja eliminar esta agenda?")) {
            widget.remove(); // Remove do DOM
            saveNote();      // Grava a nota sem o calend√°rio
        }
    }
    // >>> FIM DO NOVO BLOCO <<<
    
    // B. Mudar Visualiza√ß√£o (Semana/M√™s/Ano)
    else if (e.target.classList.contains('cal-view-btn')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        // Atualiza bot√µes
        widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        // Atualiza estado e re-renderiza
        widget.dataset.view = e.target.dataset.view;
        renderCalendarUI(widget);
        // Fecha o menu
        widget.querySelector('.cal-settings-menu').classList.remove('visible');
    }

    // C. Navega√ß√£o (‚óÄ / ‚ñ∂)
    else if (e.target.closest('.cal-prev') || e.target.closest('.cal-next')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const isNext = e.target.closest('.cal-next');
        changeCalendarDate(widget, isNext ? 1 : -1);
    }

    // D. Clique num Dia (Adicionar Tarefa)
    else if (e.target.classList.contains('cal-day') && !e.target.classList.contains('empty')) {
        const day = e.target.dataset.day;
        const widget = e.target.closest('.jwn-calendar-widget');
        const month = parseInt(widget.dataset.month); // 0-11
        const year = parseInt(widget.dataset.year);
        
        // Formata data ISO (YYYY-MM-DD)
        const dateObj = new Date(year, month, parseInt(day));
        // Ajuste fuso hor√°rio simples
        const dateISO = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

        openCalendarModal(dateISO, widget);
    }
});

// 2. Fun√ß√£o Principal de Renderiza√ß√£o
async function renderCalendarUI(widget) {
    if (!widget) return;

    const view = widget.dataset.view || 'month';
    const month = parseInt(widget.dataset.month);
    const year = parseInt(widget.dataset.year);
    const grid = widget.querySelector('.cal-grid');
    const title = widget.querySelector('.cal-title');

    grid.innerHTML = ''; // Limpa

    // Carregar tarefas do Firebase para este m√™s
    const tasksMap = await fetchTasksForMonth(year, month);

    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    // --- MODO M√äS (Padr√£o) ---
    if (view === 'month') {
        title.textContent = `${monthNames[month]} ${year}`;

        // Cabe√ßalhos (D S T Q Q S S)
        const days = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        days.forEach(d => grid.innerHTML += `<div class="cal-day-header">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay(); // 0 = Domingo
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // Espa√ßos vazios antes do dia 1
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div class="cal-day empty"></div>`;
        }

        // Dias
        for (let i = 1; i <= daysInMonth; i++) {
            const dateISO = new Date(year, month, i).toLocaleDateString('en-CA'); // YYYY-MM-DD local hack
            // Nota: constru√ß√£o de ISO manual √© mais segura:
            const realISO = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            
            const isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear());
            const hasTask = tasksMap[realISO]; // Verifica se h√° tarefa no map

            const div = document.createElement('div');
            div.className = `cal-day ${isToday ? 'today' : ''} ${hasTask ? 'has-task' : ''}`;
            div.textContent = i;
            div.dataset.day = i;
            if (hasTask) div.title = "Tem tarefas";
            grid.appendChild(div);
        }
    } 
    // --- MODO ANO (Simplificado) ---
    else if (view === 'year') {
        title.textContent = `${year}`;
        grid.style.gridTemplateColumns = "repeat(3, 1fr)"; // 3 colunas de meses
        grid.style.gap = "10px";
        
        monthNames.forEach((mName, idx) => {
            const btn = document.createElement('div');
            btn.className = 'cal-day'; // Reusa estilo
            btn.textContent = mName.substring(0, 3);
            btn.onclick = (e) => {
                e.stopPropagation();
                // Ao clicar no m√™s, entra no modo m√™s
                widget.dataset.month = idx;
                widget.dataset.view = 'month';
                // Atualiza bot√£o visual
                widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
                widget.querySelector('[data-view="month"]').classList.add('active');
                renderCalendarUI(widget);
            };
            grid.appendChild(btn);
        });
    }
    // --- MODO SEMANA (Placeholder funcional) ---
    else if (view === 'week') {
        title.textContent = `Semana (Demo) - ${monthNames[month]}`;
        grid.innerHTML = '<div style="grid-column: span 7; padding:10px; color:#888;">Modo semana simplificado para o dia 1 a 7.</div>';
        // (Pode expandir se quiser, mas m√™s √© o mais √∫til)
    }
}

// 3. Navega√ß√£o
function changeCalendarDate(widget, direction) {
    let m = parseInt(widget.dataset.month);
    let y = parseInt(widget.dataset.year);
    const view = widget.dataset.view;

    if (view === 'year') {
        y += direction;
    } else {
        m += direction;
        if (m > 11) { m = 0; y++; }
        if (m < 0) { m = 11; y--; }
    }

    widget.dataset.month = m;
    widget.dataset.year = y;
    renderCalendarUI(widget);
}

// 4. Integra√ß√£o Firebase (Buscar Tarefas)
async function fetchTasksForMonth(year, month) {
    if (!auth.currentUser) return {};

    // Define intervalo do m√™s para query
    // Constru√≠mos strings YYYY-MM para filtrar (simplificado: pegamos tudo e filtramos)
    // Para produ√ß√£o ideal: `where('data', '>=', startStr)`
    
    const startStr = `${year}-${String(month+1).padStart(2,'0')}-01`;
    const endStr = `${year}-${String(month+1).padStart(2,'0')}-31`;

    const q = query(
        collection(db, 'agenda'),
        where('userId', '==', auth.currentUser.uid),
        where('data', '>=', startStr),
        where('data', '<=', endStr)
    );

    const snapshot = await getDocs(q);
    const map = {};
    snapshot.forEach(doc => {
        const d = doc.data();
        map[d.data] = true; // Marca que este dia tem algo
    });
    return map;
}

// 5. Modal de Tarefas
let currentCalendarWidget = null; // Para saber qual atualizar ao fechar

async function openCalendarModal(dateISO, widget) {
    const modal = document.getElementById('calendar-task-modal');
    const displaySpan = document.getElementById('cal-selected-date-display');
    const isoInput = document.getElementById('cal-selected-date-iso');
    const descInput = document.getElementById('cal-task-desc');
    const existingList = document.getElementById('cal-existing-tasks');
    const saveBtn = document.getElementById('cal-save-task-btn');

    currentCalendarWidget = widget;
    displaySpan.textContent = dateISO; // Ex: 2024-05-25
    isoInput.value = dateISO;
    descInput.value = '';
    existingList.innerHTML = 'Carregando...';
    
    modal.style.display = 'flex';
    descInput.focus();

    // Carregar tarefas existentes desse dia
    const q = query(
        collection(db, 'agenda'),
        where('userId', '==', auth.currentUser.uid),
        where('data', '==', dateISO)
    );
    const snap = await getDocs(q);
    existingList.innerHTML = '';
    
    if (snap.empty) {
        existingList.innerHTML = '<small style="color:#888;">Sem tarefas.</small>';
    } else {
        snap.forEach(doc => {
            const task = doc.data();
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid var(--border-color)';
            div.style.padding = '5px';
            div.style.fontSize = '0.9em';
            div.innerHTML = `‚Ä¢ ${task.descricao}`;
            existingList.appendChild(div);
        });
    }

    // Gravar Nova Tarefa
    // (Removemos listeners antigos clonando)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const desc = descInput.value.trim();
        if (!desc) return;

        try {
            await addDoc(collection(db, 'agenda'), {
                data: dateISO,
                descricao: desc,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            
            modal.style.display = 'none';
            // Atualiza o widget para mostrar a bolinha vermelha
            renderCalendarUI(currentCalendarWidget); 
            
        } catch (e) {
            console.error(e);
            alert("Erro ao gravar tarefa.");
        }
    };
}

// 6. AUTO-INICIAR CALEND√ÅRIOS AO ABRIR NOTA
// Adicione esta chamada dentro da fun√ß√£o displayNote()
// Logo a seguir a noteContentEditor.innerHTML = conteudo...
function refreshAllCalendars() {
    const calendars = document.querySelectorAll('.jwn-calendar-widget');
    calendars.forEach(cal => renderCalendarUI(cal));
}

// --- NOVAS FUN√á√ïES PARA SUGEST√ÉO DE ENTIDADES ---

function showEntityPopup(query) {
    // Junta todas as entidades de todos os tipos num √∫nico array
    const flatEntities = Object.values(allEntities).flat();
    const filteredEntities = flatEntities.filter(entity => 
        entity.nome.toLowerCase().includes(query.toLowerCase())
    );

    entitySuggestionList.innerHTML = '';
    if (filteredEntities.length > 0) {
        filteredEntities.forEach(entity => {
            const li = document.createElement('li');
            // Guardamos os dados da entidade no elemento li
            li.dataset.entityName = entity.nome;
            li.dataset.entityType = entity.tipo;
            
            // Mostra o nome e o tipo para ser mais f√°cil de identificar
            li.innerHTML = `${entity.nome} <span style="font-size: 0.8em;">[${entity.tipo}]</span>`;
            
            entitySuggestionList.appendChild(li);
        });
        
        const rect = currentEntityQueryRange.getBoundingClientRect();
        entitySuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
        entitySuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
        entitySuggestionPopup.style.display = 'block';
        isEntityPopupOpen = true;
        entitySuggestionList.firstChild.classList.add('selected');
    } else {
        hideEntityPopup();
    }
}

function hideEntityPopup() {
    entitySuggestionPopup.style.display = 'none';
    isEntityPopupOpen = false;
    currentEntityQueryRange = null;
}

function navigateEntitySuggestions(key) {
    const items = Array.from(entitySuggestionList.children);
    if(items.length === 0) return;
    const selected = entitySuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

function insertEntityIntoEditor(entityName, entityType) {
    if (!currentEntityQueryRange) return;

    const entitySpan = document.createElement('span');
    entitySpan.className = 'entity-link';
    entitySpan.dataset.entityType = entityType;
    entitySpan.dataset.entityName = entityName;
    entitySpan.textContent = entityName;
    
    const spaceNode = document.createTextNode('\u00A0');

    // Substitui o texto que o utilizador digitou (ex: @Jeremias)
    currentEntityQueryRange.deleteContents();
    currentEntityQueryRange.insertNode(spaceNode);
    currentEntityQueryRange.insertNode(entitySpan);
    
    // P√µe o cursor a seguir ao espa√ßo, pronto para continuar a escrever
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}

async function commitEntitySelection() {
    const selectedLi = entitySuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    
    const entityName = selectedLi.dataset.entityName;
    const entityType = selectedLi.dataset.entityType;
    
    if (entityName && entityType) {
        // A L√ìGICA DE ATUALIZA√á√ÉO FOI ADICIONADA AQUI
        const collectionName = ENTITY_CONFIG[entityType]?.collection;
        if (collectionName) {
            const allKnownEntities = Object.values(allEntities).flat();
            const entity = allKnownEntities.find(e => e.tipo === entityType && e.nome === entityName);

            if (entity) {
                // Se a entidade foi encontrada no cache, atualiza as suas refer√™ncias no Firestore
                const entityRef = doc(db, collectionName, entity.id);
                try {
                    await updateDoc(entityRef, {
                        [`referencias.${selectedNoteId}`]: true
                    });

                } catch (error) {
                    console.error("Erro ao atualizar refer√™ncia da entidade:", error);
                }
            }
        }

        // Insere o <span> no editor (comportamento visual)
        insertEntityIntoEditor(entityName, entityType);
    }
    
    hideEntityPopup();
}



function escapeStyledElements(event) {
    const selection = window.getSelection();
    if (!selection.isCollapsed || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    // Garante que pegamos o elemento HTML, n√£o o n√≥ de texto
    const parentElement = currentNode.nodeType === Node.TEXT_NODE ? currentNode.parentElement : currentNode;

    // 1. Identifica se estamos dentro de algo "especial"
    // Lista de classes que queremos "escapar"
    let styledContainer = parentElement.closest('.entity-link, .tag, a[data-anexo-id], .idea-span');

    // 2. L√ìGICA DE HIERARQUIA (CRUCIAL):
    // Se encontrarmos uma entidade ou tag, verificamos se ela est√° dentro de um link (Anexo).
    // Se estiver, o "contentor a escapar" deve ser o LINK, n√£o a entidade interna.
    if (styledContainer && (styledContainer.classList.contains('entity-link') || styledContainer.classList.contains('tag'))) {
        const parentLink = styledContainer.closest('a[data-anexo-id]');
        if (parentLink) {
            styledContainer = parentLink;
        }
    }

    if (styledContainer) {
        const isAtTheStart = range.startOffset === 0;
        // Verifica√ß√£o do final do n√≥ de texto atual
        const isAtTheEnd = range.startOffset === currentNode.textContent.length;
        
        const isPrintableChar = (event.key.length === 1 || event.key === 'Enter') && !event.ctrlKey && !event.metaKey && !event.altKey;

        // =========================================================================
        // CEN√ÅRIO 1: Escrever no IN√çCIO do elemento (|Link)
        // =========================================================================
        if (isAtTheStart && isPrintableChar && event.key !== 'Backspace') {

            
            event.preventDefault(); // Impede o navegador de colocar a letra dentro do link

            // Cria o texto digitado e a barreira invis√≠vel
            const typedTextNode = document.createTextNode(event.key);
            const zeroWidthSpace = document.createTextNode('\u200B');
            const parent = styledContainer.parentNode;

            // Insere ANTES do contentor especial
            parent.insertBefore(typedTextNode, styledContainer);
            parent.insertBefore(zeroWidthSpace, styledContainer);

            // Coloca o cursor depois do texto novo (mas antes da barreira)
            // Assim, a pr√≥xima letra continuar√° "fora"
            const newRange = document.createRange();
            newRange.setStartAfter(typedTextNode);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            return;
        }

        // =========================================================================
        // CEN√ÅRIO 2: Escrever no FIM do elemento (Link|)
        // =========================================================================
        if (isAtTheEnd && isPrintableChar) {
            // Verifica se este n√≥ √© realmente o √∫ltimo n√≥ de texto dentro do contentor
            // (Para evitar sair do link se estivermos no meio de uma frase composta, ex: <b>Negrito</b>|Normal)
            const isReallyLastNode = (currentNode === styledContainer.lastChild) || 
                                     (styledContainer.lastChild && currentNode === styledContainer.lastChild.lastChild);
            
            if (isReallyLastNode) {
                
                // Nota: N√£o usamos preventDefault aqui para deixar a letra ser processada,
                // mas movemos o cursor para garantir que ela cai "fora".
                
                const zeroWidthSpace = document.createTextNode('\u200B');
                const parent = styledContainer.parentNode;
                
                // Insere DEPOIS do contentor
                if (styledContainer.nextSibling) {
                    parent.insertBefore(zeroWidthSpace, styledContainer.nextSibling);
                } else {
                    parent.appendChild(zeroWidthSpace);
                }
                
                // Move o cursor para a barreira, FORA do link
                const newRange = document.createRange();
                newRange.setStartAfter(zeroWidthSpace); // P√µe depois da barreira
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                
                // A letra digitada ser√° inserida na nova posi√ß√£o do cursor (fora)
            }
        }
    }
    
    // =========================================================================
    // CEN√ÅRIO 3: Prote√ß√£o contra DELETE (Forward Delete)
    // =========================================================================
    // Impede que, ao clicar "Delete" no fim de um texto normal, se apague a fronteira
    // e o link seguinte seja "sugado" para dentro do texto atual.
    else if (event.key === 'Delete') {
         if (range.startOffset === currentNode.textContent.length) {
            const elementAfter = parentElement.nextElementSibling;
            
            // Se o pr√≥ximo elemento for um dos nossos especiais
            if (elementAfter && elementAfter.matches('.entity-link, .tag, a[data-anexo-id], .idea-span')) {
                event.preventDefault(); // Impede apagar
                
                // Foca no in√≠cio do elemento seguinte em vez de o apagar
                const newRange = document.createRange();
                
                // Tenta encontrar o primeiro n√≥ de texto l√° dentro para p√¥r o cursor
                let targetNode = elementAfter.firstChild;
                while(targetNode && targetNode.firstChild) targetNode = targetNode.firstChild;
                
                if (targetNode) {
                    newRange.setStart(targetNode, 0);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            }
        }
    }
}
    

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
function handleTextSelection() {
    const selectionPopup = document.getElementById('selection-popup');
    const insertionPopup = document.getElementById('insertion-popup');
    
    // 1. VERIFICA√á√ÉO DE TEXTO NORMAL
    const selection = window.getSelection();
    let hasStandardSelection = false;
    
    if (selection && selection.rangeCount > 0 && !selection.isCollapsed) {
        const anchorNode = selection.anchorNode;
        // Garante que o elemento faz parte do editor
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const isInEditor = noteContentEditor.contains(safeNode);
        
        if (isInEditor && selection.toString().trim().length > 0) {
            hasStandardSelection = true;
        }
    }

    // 2. VERIFICA√á√ÉO DE INPUTS
    let hasInputSelection = false;
    const activeEl = document.activeElement;
    if (activeEl && activeEl.tagName === 'INPUT' && activeEl.classList.contains('mini-note-title-input') && noteContentEditor.contains(activeEl)) {
        if (activeEl.selectionStart !== activeEl.selectionEnd) {
            hasInputSelection = true;
        }
    }

    // =========================================================
    // L√ìGICA DE VISIBILIDADE
    // =========================================================

    // A. ESCONDER MENU DE INSER√á√ÉO (üìò) se houver sele√ß√£o
    if (hasStandardSelection || hasInputSelection) {
        if (insertionPopup) insertionPopup.style.display = 'none';
    }

    // B. MOSTRAR/ESCONDER MENU DE FORMATA√á√ÉO (üîó üé¥)
    if (hasStandardSelection) {
        
        // --- L√ìGICA INTELIGENTE DO BOT√ÉO üé¥ (CART√ÉO WEB) ---
        const btnCard = selectionPopup.querySelector('button[data-action="create-url-card"]');
        if (btnCard) {
            const selectedText = selection.toString().trim();
            
            // 1. Verifica se o texto parece um URL (Regex)
            const urlRegex = /^(https?:\/\/|www\.)|[\w-]+\.[a-z]{2,}(\/.*)?$/i;
            const looksLikeUrl = urlRegex.test(selectedText);

            // 2. Verifica se a sele√ß√£o est√° DENTRO de um link <a> existente
            let isInsideLink = false;
            if (selection.anchorNode) {
                const anchorEl = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
                isInsideLink = !!anchorEl.closest('a');
            }

            // Decis√£o: Mostra ou Esconde o üé¥
            if (looksLikeUrl || isInsideLink) {
                btnCard.style.display = 'flex'; // Mostra
            } else {
                btnCard.style.display = 'none'; // Esconde
            }
        }
        // -----------------------------------------------------

       currentSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = currentSelectionRange.getBoundingClientRect();
        
        if (selectionPopup) {
            selectionPopup.style.display = 'flex'; // Mostra primeiro para calcular a largura
            
            // --- C√ÅLCULO DE POSI√á√ÉO INTELIGENTE ---
            const popupWidth = selectionPopup.offsetWidth;
            const windowWidth = window.innerWidth;
            const scrollX = window.scrollX;
            const padding = 10; 

            // 1. Centralizar
            let leftPos = rect.left + (rect.width / 2) - (popupWidth / 2);

            // 2. Limites Ecr√£
            if (leftPos < padding) {
                leftPos = padding;
            } else if (leftPos + popupWidth > windowWidth - padding) {
                leftPos = windowWidth - popupWidth - padding;
            }
            leftPos += scrollX;

            // 3. Vertical (Y)
            const popupHeight = selectionPopup.offsetHeight || 50; 
            const gap = 10; 

            let topPos = (rect.top + window.scrollY) - popupHeight - gap;
            
            // Prote√ß√£o de Topo (se n√£o couber em cima, p√µe em baixo)
            if (rect.top < (popupHeight + gap + 50)) { 
               topPos = rect.bottom + window.scrollY + gap;
            }

            // APLICA AS POSI√á√ïES FINAIS
            selectionPopup.style.top = `${topPos}px`;
            selectionPopup.style.left = `${leftPos}px`;
            selectionPopup.style.zIndex = '2000';
        }
    } 
    // >>> O C√ìDIGO NOVO EST√Å AQUI (O ELSE) <<<
    else {
        // Se N√ÉO houver sele√ß√£o, esconde o popup imediatamente
        if (selectionPopup) {
            selectionPopup.style.display = 'none';
        }
    }
}
// ====================================================================



// ====================================================================
// NAVEGA√á√ÉO MOBILE: FECHAR LISTA AO CLICAR NO VAZIO
// ====================================================================



function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.seconds) {
            return 'Data inv√°lida';
        }
        const date = new Date(timestamp.seconds * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    /**
     * Carrega e exibe a lista de backups para a nota atual.
     */
async function loadBackupsForNote() {
    if (!selectedNoteId) return;

    const listEl = document.getElementById('history-list-content');
    listEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar hist√≥rico...</span></div>';

    try {
        // 1. Carregar Backups (Todos)
        const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
        const qBackups = query(backupsRef, orderBy('timestamp', 'desc'));
        const backupsSnap = await getDocs(qBackups);

        // 2. Carregar Itens Ocultos (Subnotas/Reciclagem)
        const noteDocRef = doc(db, 'pastas', selectedNoteId);
        const noteDocSnap = await getDoc(noteDocRef);
        const hiddenNotes = (noteDocSnap.exists() && noteDocSnap.data().subnotasocultas) 
                            ? noteDocSnap.data().subnotasocultas 
                            : {};

        listEl.innerHTML = '';

        // Separar os backups em dois grupos
        const safetyBackups = [];
        const manualBackups = [];

        backupsSnap.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            if (data.isSafetyBackup === true) {
                safetyBackups.push(data);
            } else {
                manualBackups.push(data);
            }
        });

        // ============================================================
        // BLOCO 1: üóëÔ∏è Reciclagem (Itens Ocultos / Caixas Apagadas)
        // ============================================================
        if (Object.keys(hiddenNotes).length > 0) {
            const headerNotes = document.createElement('h4');
            headerNotes.textContent = "üóëÔ∏è Reciclagem (Itens Ocultos)";
            headerNotes.style.color = "var(--text-muted-color)";
            headerNotes.style.borderBottom = "1px solid var(--border-color)";
            headerNotes.style.paddingBottom = "5px";
            listEl.appendChild(headerNotes);

            const sortedHidden = Object.values(hiddenNotes).sort((a, b) => {
                const timeA = a.deletedAt?.seconds || 0;
                const timeB = b.deletedAt?.seconds || 0;
                return timeB - timeA;
            });

            sortedHidden.forEach(note => {
                let displayTitle = note.titulo || "Item Sem T√≠tulo";
                let borderColor = '#3498db'; 
                let icon = 'üìò';
                
                if (note.tipo === 'question') { borderColor = '#2ecc71'; icon = 'üìó'; }
                else if (note.tipo === 'free') { borderColor = '#e67e22'; icon = 'üìô'; }
                else if (note.tipo === 'toggle') { borderColor = '#9b59b6'; icon = '‚òÇ'; }

                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                li.style.marginBottom = '6px';
                li.style.backgroundColor = 'var(--bg-color)'; 
                li.style.padding = '8px';
                li.style.borderRadius = '4px';
                li.style.borderLeft = `4px solid ${borderColor}`;

                li.innerHTML = `
                    <span style="font-weight:bold; font-size: 0.95em;">${icon} ${displayTitle}</span>
                    <button class="modal-btn primary" onclick="restoreHiddenMiniNote('${note.id}')" style="padding: 5px 12px; font-size: 0.8em;">Restaurar</button>
                `;
                listEl.appendChild(li);
            });

            const hr = document.createElement('hr');
            hr.style.margin = "20px 0";
            hr.style.border = "0";
            hr.style.borderTop = "1px solid var(--border-color)";
            listEl.appendChild(hr);
        }

        // ============================================================
        // BLOCO 2: üö® Vers√µes Guardadas por Seguran√ßa (AUTO-SAFETY)
        // ============================================================
        // Mostramos estes PRIMEIRO porque geralmente s√£o os mais urgentes
        if (safetyBackups.length > 0) {
            const headerSafety = document.createElement('h4');
            headerSafety.textContent = "üö® Backups de Emerg√™ncia (Auto)";
            headerSafety.style.color = "#e74c3c"; // Vermelho
            headerSafety.style.borderBottom = "1px solid #e74c3c";
            headerSafety.style.paddingBottom = "5px";
            headerSafety.style.marginTop = "0";
            listEl.appendChild(headerSafety);

            safetyBackups.forEach(backup => {
                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                // Estilo de alerta
                li.style.backgroundColor = "rgba(231, 76, 60, 0.1)"; 
                li.style.borderLeft = "4px solid #e74c3c";
                li.style.marginTop = "5px";
                li.style.padding = "10px";
                
                const backupDate = formatTimestamp(backup.timestamp);
                
                li.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:bold; color:#e74c3c;">${backupDate}</span>
                        <small style="color:var(--text-muted-color);">Recupera√ß√£o Autom√°tica (Apag√£o Detetado)</small>
                    </div>
                    <div style="display:flex; gap: 5px;">
                        <button class="modal-btn secondary" data-action="view" data-backup-id="${backup.id}" style="padding: 5px 10px;">Ver</button>
                        <button class="modal-btn primary" data-action="restore" data-backup-id="${backup.id}" style="padding: 5px 10px; background-color:#e74c3c;">Restaurar</button>
                    </div>
                `;
                listEl.appendChild(li);
            });

            // Separador
            const hrSafety = document.createElement('hr');
            hrSafety.style.margin = "25px 0 10px 0";
            hrSafety.style.border = "0";
            hrSafety.style.borderTop = "1px solid var(--border-color)";
            listEl.appendChild(hrSafety);
        }

        // ============================================================
        // BLOCO 3: üíæ Vers√µes Anteriores (Manuais)
        // ============================================================
        const headerBackups = document.createElement('h4');
        headerBackups.textContent = "üíæ Vers√µes Guardadas Manualmente";
        listEl.appendChild(headerBackups);

        if (manualBackups.length === 0) {
            const emptyLi = document.createElement('li');
            emptyLi.textContent = "Nenhum backup manual encontrado.";
            emptyLi.style.fontStyle = "italic";
            emptyLi.style.color = "var(--text-muted-color)";
            emptyLi.style.padding = "10px";
            listEl.appendChild(emptyLi);
        } else {
            manualBackups.forEach(backup => {
                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                li.style.padding = "10px";
                li.style.borderBottom = "1px solid var(--border-color)";
                
                const backupDate = formatTimestamp(backup.timestamp);
                
                li.innerHTML = `
                    <span>Vers√£o de ${backupDate}</span>
                    <div style="display:flex; gap: 5px;">
                        <button class="modal-btn secondary" data-action="view" data-backup-id="${backup.id}" style="padding: 5px 10px;">Ver</button>
                        <button class="modal-btn primary" data-action="restore" data-backup-id="${backup.id}" style="padding: 5px 10px;">Restaurar</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }

    } catch (error) {
        console.error("Erro ao carregar hist√≥rico:", error);
        listEl.innerHTML = '<li style="color:#e74c3c;">Ocorreu um erro ao carregar os dados.</li>';
    }
}
    

    /**
     * Abre o modal de hist√≥rico e configura os seus eventos.
     */
 async function openHistoryModal() {
    if (!selectedNoteId) {
        alert("Por favor, selecione uma nota primeiro.");
        return;
    }

    console.log("üöÄ Abrindo modal de Hist√≥rico para a nota:", selectedNoteId);
    
    const modal = document.getElementById('history-modal');
    const backupBtn = document.getElementById('backup-now-btn');
    const titleEl = document.getElementById('history-modal-title');

    if (!modal || !backupBtn) return console.error("Elementos do Hist√≥rico n√£o encontrados!");

    // 1. GARANTIA DE VISIBILIDADE (O que j√° fizemos antes)
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";

    if (titleEl) titleEl.textContent = `Hist√≥rico de "${noteTitleInput.value}"`;

    // 2. RECONFIGURAR O BOT√ÉO DE BACKUP (Limpa e cria novo evento)
    // Clonamos para garantir que n√£o h√° acumula√ß√£o de cliques
    const newBackupBtn = backupBtn.cloneNode(true);
    backupBtn.parentNode.replaceChild(newBackupBtn, backupBtn);

    newBackupBtn.onclick = async () => {
        console.log("üíæ Iniciando cria√ß√£o de backup manual...");
        
        // Feedback visual no bot√£o
        const originalText = newBackupBtn.textContent;
        newBackupBtn.disabled = true;
        newBackupBtn.textContent = 'A guardar vers√£o...';

        try {
            const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
            
            // Captura o conte√∫do atual do editor
            const currentTitle = document.getElementById('note-title-input').value || "Sem T√≠tulo";
            const currentContent = document.getElementById('note-content-editor').innerHTML;

            await addDoc(backupsRef, {
                titulo: currentTitle,
                conteudo: currentContent,
                timestamp: serverTimestamp(),
                isSafetyBackup: false // Marca como backup manual
            });

            console.log("‚úÖ Backup criado com sucesso!");
            
            // Feedback de sucesso no bot√£o
            newBackupBtn.textContent = 'Vers√£o Guardada!';
            newBackupBtn.style.backgroundColor = '#27ae60';

            // Recarrega a lista abaixo para mostrar o novo backup
            await loadBackupsForNote();

            // Restaura o bot√£o ap√≥s 2 segundos
            setTimeout(() => {
                newBackupBtn.disabled = false;
                newBackupBtn.textContent = originalText;
                newBackupBtn.style.backgroundColor = '';
            }, 2000);

        } catch (error) {
            console.error("‚ùå Erro ao criar backup:", error);
            alert("Erro ao criar o backup. Verifique a sua liga√ß√£o.");
            newBackupBtn.disabled = false;
            newBackupBtn.textContent = originalText;
        }
    };

    // 3. CARREGAR A LISTA DE BACKUPS EXISTENTES
    await loadBackupsForNote();
}

    /**
     * Restaura um backup criando uma nova nota.
     * @param {string} backupId O ID do documento de backup.
     */
  async function restoreBackup(backupId) {
    if (!selectedNoteId) return;
    if (!auth.currentUser) {
        alert("Sess√£o expirada. Recarregue a p√°gina.");
        return;
    }
    
    // Feedback visual
    const modalContent = document.querySelector('#history-modal .modal-content');
    modalContent.style.opacity = '0.5';
    modalContent.style.pointerEvents = 'none';

    try {

        const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
        const backupSnap = await getDoc(backupRef);
        
        if (!backupSnap.exists()) throw new Error("O ficheiro de backup j√° n√£o existe.");
        const backupData = backupSnap.data();

        const originalNoteRef = doc(db, 'pastas', selectedNoteId);
        const originalNoteSnap = await getDoc(originalNoteRef);
        
        // Se a original n√£o existir, usa null como parent (Raiz)
        const parentId = originalNoteSnap.exists() ? originalNoteSnap.data().parentId : null;
        
        // Preparar T√≠tulo
        const backupDate = formatTimestamp(backupData.timestamp);
        const newTitle = `${backupData.titulo} (Restaurado ${backupDate})`;

        // Calcular Ordem
        let newOrder = 0;
        try {
            const q = query(collection(db, 'pastas'), where('parentId', '==', parentId), where('estado', '==', 'ativa'));
            const siblingsSnap = await getDocs(q);
            newOrder = siblingsSnap.size;
        } catch(e) { console.warn("Erro ao calcular ordem, usando 0"); }

        // Criar Nova Nota
        const newDocRef = await addDoc(collection(db, 'pastas'), {
            nome: newTitle,
            conteudo: backupData.conteudo,
            parentId: parentId,
            tipo: 'nota',
            userId: auth.currentUser.uid, // FUNDAMENTAL PARA AS REGRAS
            estado: 'ativa',
            ordem: newOrder,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp(),
            tags: []
        });

        // Finaliza√ß√£o
        modalContent.style.opacity = '1';
        modalContent.style.pointerEvents = 'auto';
        document.getElementById('history-modal').style.display = 'none';

        const confirmed = await showConfirmation(
            "C√≥pia Restaurada!", 
            `Foi criada uma nova nota: "${newTitle}".\nDeseja abrir a nota restaurada agora?`
        );

        if (confirmed) {
            if (typeof navigateToNoteSmart === 'function') {
                await navigateToNoteSmart(newDocRef.id);
            } else {
                displayNote(newDocRef.id, null);
            }
        } else {
            updateNavigationView(true, selectedNoteId);
        }

    } catch (error) {
        console.error("‚ùå ERRO NO PROCESSO DE RESTAURO:", error);
        alert("Ocorreu um erro de permiss√µes ou rede.\nVerifique a consola para detalhes.");
        modalContent.style.opacity = '1';
        modalContent.style.pointerEvents = 'auto';
    }
}

    /**
     * Exibe o conte√∫do de um backup num modal de visualiza√ß√£o.
     * @param {string} backupId O ID do documento de backup.
     */
 async function viewBackup(backupId) {
    if (!selectedNoteId) return;

    const modal = document.getElementById('view-backup-modal');
    const titleEl = document.getElementById('view-backup-title');
    const contentEl = document.getElementById('view-backup-content');

    if (!modal) return console.error("Modal #view-backup-modal n√£o encontrado!");

    // 1. FOR√áA HIERARQUIA (Z-Index maior que o do Hist√≥rico)
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.setProperty('z-index', '9000000', 'important'); // Hist√≥rico est√° em 8M
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    contentEl.innerHTML = '<div class="spinner"></div><p>A carregar conte√∫do...</p>';

    try {
        // 2. BUSCA OS DADOS NO FIREBASE
        const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
        const backupSnap = await getDoc(backupRef);

        if (backupSnap.exists()) {
            const data = backupSnap.data();
            const dateStr = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Data desconhecida';
            
            titleEl.textContent = `Conte√∫do da Vers√£o: ${dateStr}`;
            
            // 3. RENDERIZA√á√ÉO SEGURA
            // Removemos as tags de toolbar e bot√µes para a pr√©-visualiza√ß√£o ser limpa
            let cleanHTML = data.conteudo || "";
            cleanHTML = cleanHTML.replace(/<div class="mini-note-toolbar".*?<\/div>/g, '');
            
            contentEl.innerHTML = cleanHTML;
        } else {
            alert("Erro: O backup j√° n√£o existe.");
            modal.style.display = 'none';
        }
    } catch (error) {
        console.error("Erro ao carregar backup:", error);
        alert("N√£o foi poss√≠vel carregar o conte√∫do.");
        modal.style.display = 'none';
    }
}
    

    // --- LISTENER DO PAINEL ESQUERDO COM LOGS DE DEPURA√á√ÉO ---
leftPanelList.addEventListener('click', async (e) => {
    // 1. Identifica o que foi clicado (o item da lista)
    const listItem = e.target.closest('.list-item');
    if (!listItem) return;

    // --- A. DETE√á√ÉO DO BOT√ÉO DE MENU (TR√äS PONTOS OU L√ÅPIS ‚úè) ---
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) {
        console.log("üõ†Ô∏è Abrindo menu para:", listItem.dataset.name);
        showContextMenu(e); // O menu de contexto trata as a√ß√µes de edi√ß√£o e Cosmos
        return; // P√°ra aqui para n√£o tentar navegar/abrir o item
    }

    // --- B. CAPTURA DE DADOS DO ITEM ---
    const id = listItem.dataset.id;
    const name = listItem.dataset.name;
    const type = listItem.dataset.type;
    const emoji = listItem.dataset.emoji;

    // --- C. VERIFICA√á√ÉO DE PROTE√á√ÉO (APENAS MODO NOTE) ---
    if (currentTab === 'note') {
        // Se for pasta, nota ou superpasta, verifica se tem senha antes de prosseguir
        const canAccess = await checkItemProtection(id, name);
        if (!canAccess) return; // Se o usu√°rio cancelar ou errar a senha, sai
    }

    // --- D. L√ìGICA DE NAVEGA√á√ÉO: ABA "LISTS" (CATEGORIAS E COSMOS) ---
    if (currentTab === 'lists') {
        const listNavigationAction = async () => {
            // Caso 1: Categoria base (ex: T√≥picos, B√≠blia) ou Livro B√≠blico
            if (type === 'list-category' || type === 'bible-book') {
                if (type === 'list-category') {
                    navigationStack = [{ id, name, type }];
                } else {
                    navigationStack.push({ id, name, type });
                }
                updateNavigationView(true);
            } 
            // Caso 2: Tema do Cosmos (Entra para ver Subtemas)
            else if (type === 'cosmos-parent') {
                navigationStack.push({ id, name, type, emoji });
                updateNavigationView(true);
            }
            // Caso 3: Subtema do Cosmos (Abre Cita√ß√µes na 4¬™ Coluna)
            else if (type === 'subcosmos') {
                leftPanelList.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
                listItem.classList.add('selected');
                showReferencesPanel(id, name, 'subcosmos');
            }
        };

        navigateWithUnsavedCheck(listNavigationAction);
        return;
    }

    // --- E. L√ìGICA DE NAVEGA√á√ÉO: ABA "NOTE" (PASTAS E NOTAS LOCAIS) ---
    if (currentTab === 'note') {
        
        // Caso 1: PASTA ou AGREGA√á√ÉO
        if (type === 'pasta' || type === 'agregacao') {
            // Superpasta: Redireciona para o isolamento de raiz
            if (listItem.dataset.superpasta === "true") {
                navigateWithUnsavedCheck(() => { 
                    window.location.href = `note.html?rootId=${id}`; 
                });
            } 
            // Pasta Normal: Navega para dentro
            else {
                const folderAction = () => {
                    if (window.innerWidth <= 768) {
                        document.body.classList.add('mobile-view-middle');
                    }
                    if (navigationStack.length === 0) navigationStack.push({ id, name });
                    else navigationStack[navigationStack.length - 1] = { id, name };
                    updateNavigationView(true);
                };
                navigateWithUnsavedCheck(folderAction);
            }
        }

        // Caso 2: NOTA (Abre o editor principal)
        else if (type === 'nota') {
            const noteAction = () => {
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.add('mobile-view-editor');
                }
                displayNote(id, listItem);
            };
            navigateWithUnsavedCheck(noteAction);
        }
    }
});


// ====================================================================
// L√ìGICA DE MOVIMENTO DAS CAIXAS (üî∫ üîª)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    // S√≥ nos interessa se for um dos bot√µes de movimento
    if (action !== 'move-up' && action !== 'move-down') return;

    e.preventDefault(); e.stopPropagation();

    // 1. Identificar a Caixa (Wrapper) e o Pai (Editor)
    const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
    
    if (!wrapper) return;
    const parent = wrapper.parentNode;

    // 2. A√ß√£o MOVER PARA CIMA
    if (action === 'move-up') {
        const prevElement = wrapper.previousElementSibling;
        
        if (prevElement) {
            // Verifica se o elemento anterior √© um "div de espa√ßamento" (aqueles com height: 20px)
            // Se for, queremos saltar por cima dele tamb√©m para chegar ao conte√∫do real
            let target = prevElement;
            if (target.style.height === '20px' && target.previousElementSibling) {
                target = target.previousElementSibling;
            }

            // Move o wrapper para antes do alvo
            parent.insertBefore(wrapper, target);
            
            // Scroll suave para acompanhar o movimento
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            saveNote();
        }
    }

    // 3. A√ß√£o MOVER PARA BAIXO
    else if (action === 'move-down') {
        const nextElement = wrapper.nextElementSibling;
        
        if (nextElement) {
            // Mesma l√≥gica: saltar espa√ßadores vazios se existirem
            let target = nextElement;
            if (target.style.height === '20px' && target.nextElementSibling) {
                target = target.nextElementSibling;
            }

            // Para mover para baixo, inserimos o elemento SEGUINTE antes do ATUAL
            // (Basicamente trocamos a ordem)
            // Ou inserimos o ATUAL depois do SEGUINTE (usando nextSibling do seguinte)
            parent.insertBefore(wrapper, target.nextSibling);

            // Scroll suave
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            saveNote();
        }
    }
});


// ====================================================================
// GESTOR DE LINHA CRONOL√ìGICA (TIMELINE)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    // 1. Adicionar Ponto
    if (e.target.classList.contains('t-btn-add')) {
        e.preventDefault(); e.stopPropagation();
        
        const wrapper = e.target.closest('.jwn-timeline-wrapper');
        const container = wrapper.querySelector('.timeline-container');
        
        const newEntry = document.createElement('div');
        newEntry.className = 'timeline-entry';
        newEntry.innerHTML = `
            <div class="t-marker"></div>
            <div class="t-date" contenteditable="true">Nova Data</div>
            <div class="t-text" contenteditable="true">Novo evento...</div>
            <button class="t-btn-del" title="Remover Ponto">√ó</button>
        `;
        
      container.appendChild(newEntry);

// --- SUBSTITUI ESTA PARTE DO SETTIMEOUT ---
setTimeout(() => {
    const dateField = newEntry.querySelector('.t-date');
    dateField.focus();

    // Cria uma sele√ß√£o precisa apenas no texto da data
    const range = document.createRange();
    range.selectNodeContents(dateField);
    
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
}, 10);
// ------------------------------------------

saveNote();
    }
    
    // 2. Remover Ponto
    else if (e.target.classList.contains('t-btn-del')) {
        e.preventDefault(); e.stopPropagation();
        
        const entry = e.target.closest('.timeline-entry');
        const container = entry.parentElement;
        
        // Se for o √∫ltimo ponto, pergunta se quer apagar a timeline toda
        if (container.children.length <= 1) {
            if (confirm("Apagar toda a Linha Cronol√≥gica?")) {
                entry.closest('.jwn-timeline-wrapper').remove();
            }
        } else {
            entry.remove();
        }
        
        saveNote();
    }
});



    // --- EVENT LISTENER MODIFICADO ---







    // --- NOVO LISTENER PARA O DROPDOWN DE ZOOM ---
    const zoomSelect = document.getElementById('editor-zoom');
    if (zoomSelect) {
        zoomSelect.addEventListener('change', () => {
            const selectedValue = zoomSelect.value;
            
            // 1. Aplica o tamanho ao contentor principal
            noteContentEditor.style.fontSize = selectedValue;
            
            // 2. LIMPEZA PROFUNDA: Remove tamanhos fixos antigos de todo o texto dentro da nota
            const elementsWithFixedSize = noteContentEditor.querySelectorAll('*');
            
            elementsWithFixedSize.forEach(el => {
                // Remove estilo inline de font-size (ex: style="font-size: 18px")
                if (el.style.fontSize) {
                    el.style.fontSize = ''; 
                }
                // Remove a tag antiga <font size="..."> se existir (usada por alguns browsers antigos)
                if (el.tagName === 'FONT') {
                    el.removeAttribute('size');
                }
            });

            // 3. Ajuste da altura da linha para ficar leg√≠vel
            if (selectedValue.includes('%')) {
                 noteContentEditor.style.lineHeight = '1.6';
            } else {
                 // C√°lculo para pixels (1.5x o tamanho da fonte)
                 const sizeNum = parseInt(selectedValue);
                 noteContentEditor.style.lineHeight = (sizeNum * 1.5) + 'px';
            }
        });
    }



    // --- NOVO EVENT LISTENER PARA O MODAL DE HIST√ìRICO ---
    
   document.getElementById('history-list-content').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    const backupId = btn.dataset.backupId;

    if (action === 'view') {
        console.log("üìÑ Solicitando visualiza√ß√£o do backup:", backupId);
        viewBackup(backupId);
    } else if (action === 'restore') {
        console.log("‚ôªÔ∏è Solicitando restauro do backup:", backupId);
        restoreBackup(backupId);
    }
});


// --- EVENT LISTENERS ---

// Listeners de Conectividade e Sa√≠da
window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);
window.addEventListener('beforeunload', (event) => {
    let isPending = false;

    // Caso A: Nota normal por guardar
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        executeSave(); // Dispara o save da nota
        isPending = true;
    }

    // Caso B: Post de Arquivo em modo Edi√ß√£o (Lock ativo)
    if (activeEditingPostId) {
        console.log("üîå [DESLIGAR] Utilizador saindo com Post aberto. For√ßando Unlock...");
        // Dispara o save e unlock sem o await (fire and forget)
        window.saveArchivePost(activeEditingPostId);
        isPending = true;
    }

    if (isPending) {
        // Mostra o aviso do navegador "Tem a certeza que quer sair?"
        // Isto d√° tempo extra para o Firebase processar o pedido de Unlock
        event.preventDefault();
        event.returnValue = ''; 
        return '';
    }
});

// Listeners de Navega√ß√£o (Protegidos pelo Gatekeeper)


// LISTENER √öNICO DA COLUNA 2 (Unifica Logs, Navega√ß√£o e Mobile)
middlePanelList.addEventListener('click', async (e) => {
    // 1. Identifica o item da lista (a linha inteira)
    const item = e.target.closest('.list-item');
    if (!item) return;

    // --- A. DETE√á√ÉO EXCLUSIVA DO BOT√ÉO DE MENU (...) ---
    // Verificamos se o clique foi EXATAMENTE no bot√£o de 3 pontos ou l√°pis
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) { 
        console.log("üõ†Ô∏è Abrindo menu de contexto para:", item.dataset.name);
        showContextMenu(e); 
        return; // IMPORTANTE: Para aqui. N√£o executa a prote√ß√£o nem a navega√ß√£o.
    }

    // --- B. CAPTURA DE DADOS PARA NAVEGA√á√ÉO ---
    const id = item.getAttribute('data-id');
    const type = item.getAttribute('data-type');
    const name = item.getAttribute('data-name');

    // --- C. VERIFICA√á√ÉO DE PROTE√á√ÉO (S√ì AO TENTAR ABRIR) ---
    // Se o item tiver senha, o popup abre aqui. Se cancelar, a fun√ß√£o para.
    const canAccess = await checkItemProtection(id, name);
    if (!canAccess) return; 

    // --- D. L√ìGICA DE NAVEGA√á√ÉO / ABERTURA ---
    const action = async () => {
        // Caso 1: Clicou numa Pasta ou Agrega√ß√£o (Navega para dentro)
        if (type === 'pasta' || type === 'agregacao') {
            if (item.dataset.superpasta === "true") {
                navigateWithUnsavedCheck(() => { 
                    window.location.href = `note.html?rootId=${id}`; 
                });
                return;
            }
            
            // Navega√ß√£o normal para pastas
            navigationStack.push({ id, name });
            updateNavigationView(true);
            
            // Mobile: Garante que mostra a lista
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view-middle');
            }
        }
        // Caso 2: Clicou numa Nota ou Arquivo (Abre no painel direito)
        else if (type === 'nota' || type === 'arquivo' || type === 'partilhado') {
            // Remove sele√ß√µes anteriores e marca a nova
            document.querySelectorAll('#file-list .list-item').forEach(el => {
                el.classList.remove('selected', 'selected-red');
            });
            
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            item.classList.add(selectionClass);

            // Mobile: Salta para o Editor
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view-editor');
            }
            
            if (type === 'nota') {
                displayNote(id, item);
            } else {
                displayArchive(id, { id, nome: name, tipo: type }, item);
            }
        }
    };

    // Executa a a√ß√£o verificando se h√° notas n√£o guardadas no editor
    navigateWithUnsavedCheck(action);
});





function setLeftPanelTitle(text, isBackAction = false) {
    const titleEl = document.getElementById('left-panel-title');
    if (!titleEl) return;

    // Verifica se estamos dentro de uma Superpasta (ID presente no URL/Vari√°vel)
    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // ============================================================
    // REGRA 1: MODO SUPERPASTA (Mant√©m o bot√£o de Sair para seguran√ßa)
    // ============================================================
    if (isSuperContext) {
        titleEl.className = ''; 
        titleEl.style.display = 'block';
        titleEl.onclick = null;

        titleEl.innerHTML = `
            <h2 style="font-size:18px; cursor:pointer; display: flex; align-items: center;" title="Sair desta Superpasta">
                <span style="font-size: 0.8em; opacity: 0.7; margin-right: 8px;">üîô</span> 
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${text}</span>
            </h2>`;
        
        titleEl.onclick = () => {
            navigateWithUnsavedCheck(() => {
                if (isBackAction && navigationStack.length > 0) {
                    navigationStack.pop();
                    selectedNoteId = null; 
                    updateNavigationView();
                } else {
                    window.location.href = "note.html"; 
                }
            });
        };
        return;
    }

    // ============================================================
    // REGRA 2: ABA NOTE (SELETOR SEMPRE VIS√çVEL)
    // ============================================================
    // Aqui for√ßamos o seletor mesmo que isBackAction seja true.
    if (currentTab === 'note') {
        titleEl.className = 'folder-mode-container';
        titleEl.style.display = 'flex';
        titleEl.onclick = null;

        const localActive = currentViewMode === 'local' ? 'active' : '';
        const sharedActive = currentViewMode === 'shared' ? 'active mode-shared' : '';
        const pinsActive = currentViewMode === 'pins' ? 'active mode-pins' : '';

        titleEl.innerHTML = `
            <span class="folder-mode-item ${localActive}" onclick="window.switchFolderView('local')">Local</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${sharedActive}" onclick="window.switchFolderView('shared')">Partilha</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${pinsActive}" onclick="window.switchFolderView('pins')">Pins</span>
        `;
    } 
    // ============================================================
    // REGRA 3: OUTRAS ABAS (Lists, etc - Mant√©m comportamento de voltar)
    // ============================================================
    else if (isBackAction) {
        titleEl.className = ''; 
        titleEl.style.display = 'block';
        titleEl.innerHTML = `<h2 style="font-size:18px; cursor:pointer;"><span style="font-size: 0.8em; opacity: 0.7; margin-right: 8px;">üîô</span> ${text}</h2>`;
        titleEl.onclick = () => {
            navigateWithUnsavedCheck(() => {
                if (navigationStack.length > 0) {
                    navigationStack.pop();
                    selectedNoteId = null; 
                    updateNavigationView();
                }
            });
        };
    } 
    else {
        titleEl.className = '';
        titleEl.style.display = 'block';
        titleEl.innerHTML = `<h2 style="font-size:18px; margin:0;">${text}</h2>`;
        titleEl.onclick = null;
    }
}


// ====================================================================
// FUN√á√ÉO: MOSTRAR REFER√äNCIAS DE DESTAQUE (4¬™ COLUNA)
// ====================================================================
async function showHighlightReferencesPanel(hexCode, colorName) {
    // 1. Gravar antes de mudar
    await forceSaveAndClosePuzzleMode();
  resetReferencesPanelUI();

    // 2. Configura√ß√£o Visual
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // For√ßar aba "Refer√™ncias"
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Esconder bot√µes irrelevantes
    document.getElementById('references-wol-btn').style.display = 'none';
    document.getElementById('references-bookmark-btn').style.display = 'none';

    notebookContainer.classList.add('references-panel-visible');
    
    const titleEl = document.getElementById('references-panel-title');
    titleEl.innerHTML = `
        <span style="display:inline-block; width:15px; height:15px; background:${hexCode}; border-radius:50%; border:1px solid #ccc; margin-right:5px; vertical-align:middle;"></span>
        ${colorName}
    `;
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar destaques...</span>
        </div>`;

    try {
        // 3. Pesquisa por coresUsadas (Garante que est√° em mai√∫sculas para comparar)
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            where('coresUsadas', 'array-contains', hexCode.toUpperCase())
        );

        const snapshot = await getDocs(q);
        const results = [];
        const parser = new DOMParser();

        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            if (isItemProtected && !appSettings.searchTagsInProtected) continue;

            const docHTML = parser.parseFromString(data.conteudo, 'text/html');
            const coloredElements = docHTML.querySelectorAll(`[data-highlight="${hexCode}"]`);
            
            coloredElements.forEach(el => {
                let displayTitle = "Sem T√≠tulo";
                let displayIcon = "üü¶"; 
                let snippet = "";
                let contextType = "Item";

                if (el.tagName === 'DETAILS' && el.classList.contains('toggle-section')) {
                    displayIcon = "‚òÇ";
                    contextType = "Toggle";
                    const h2 = el.querySelector('h2');
                    displayTitle = h2 ? h2.textContent : "T√≠tulo Expans√≠vel";
                    const contentDiv = el.querySelector('.toggle-content');
                    snippet = contentDiv ? contentDiv.textContent.trim().substring(0, 100) + "..." : "";
                }
                else if (el.classList.contains('mini-note-wrapper')) {
                    const titleInput = el.querySelector('.mini-note-title-input');
                    const contentDiv = el.querySelector('.mini-note-content');

                    if (el.classList.contains('question-mode')) {
                        displayIcon = "üìó";
                        contextType = "Quest√£o";
                        displayTitle = titleInput ? (titleInput.value || titleInput.textContent) : "Quest√£o";
                    } else if (el.classList.contains('free-mode')) {
                        displayIcon = "üìô";
                        contextType = "Contentor";
                        const txt = contentDiv ? contentDiv.textContent.trim() : "";
                        displayTitle = txt.length > 40 ? txt.substring(0, 40) + "..." : (txt || "Contentor");
                    } else {
                        displayIcon = "üìò"; 
                        contextType = "SubNota";
                        displayTitle = titleInput ? (titleInput.value || titleInput.textContent) : "SubNota";
                    }
                    snippet = contentDiv ? contentDiv.innerHTML : "";
                }

                results.push({
                    noteId: docSnap.id,
                    noteName: data.nome,
                    displayTitle: displayTitle,
                    displayIcon: displayIcon,
                    contextType: contextType,
                    snippet: snippet || el.outerHTML // Usa o snippet se houver, ou o HTML todo
                });
            });
        }

        listElement.innerHTML = '';
        if (results.length === 0) {
            listElement.innerHTML = '<li style="padding:15px; color:#888;">Nenhuma caixa encontrada com esta cor.</li>';
            return;
        }

        results.forEach(item => {
            const details = document.createElement('details');
            details.className = 'reference-item';
            details.style.borderLeft = `3px solid ${hexCode}`;
            
            // --- AQUI ESTAVA O ERRO: DEFINIR AS VARI√ÅVEIS ANTES DO INNERHTML ---
            const safeName = encodeURIComponent(item.noteName);
            const safeSnippet = encodeURIComponent(item.snippet);

            const summary = document.createElement('summary');
            summary.style.listStyle = "none"; 

            const goToBtn = `<button class="go-to-note-btn" 
                data-note-id="${item.noteId}" 
                data-search-term="${item.displayTitle}"
                title="Ir para nota">‚ûî</button>`;

            summary.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="add-to-puzzle-btn" 
                                    onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${item.noteId}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                            <span style="font-weight:500; color:var(--text-color);">${item.displayIcon} ${item.displayTitle}</span>
                        </div>
                        ${goToBtn}
                    </div>
                    <small style="color:var(--text-muted-color); margin-top:2px;">em üìÑ ${item.noteName}</small>
                </div>
            `;
            
            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Se for HTML (Subnotas), mostramos um texto limpo como preview
            const previewText = item.snippet.replace(/<[^>]*>/g, '').substring(0, 150);
            contextDiv.innerHTML = `<p>${previewText}...</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias de cor:", error);
        listElement.innerHTML = '<li>Erro ao processar dados.</li>';
    }
}

function checkToolbarStatus() {
    // 1. Pergunta ao browser o estado da formata√ß√£o atual
    const isBold = document.queryCommandState('bold');
    const isItalic = document.queryCommandState('italic');
    const isUnderline = document.queryCommandState('underline');

    // 2. Fun√ß√£o auxiliar para ligar/desligar a classe visual
    const toggleBtn = (selector, isActive) => {
        // Seleciona tanto os bot√µes da barra principal como das mini-notas
        const btns = document.querySelectorAll(selector);
        btns.forEach(btn => {
            if (isActive) btn.classList.add('active-tool');
            else btn.classList.remove('active-tool');
        });
    };

    // 3. Atualiza os bot√µes (considerando os dois tipos de data-attribute que usamos)
    // Para Negrito
    toggleBtn('button[data-command="bold"]', isBold);
    toggleBtn('button[data-cmd="bold"]', isBold);

    // Para It√°lico
    toggleBtn('button[data-command="italic"]', isItalic);
    toggleBtn('button[data-cmd="italic"]', isItalic);

    // Para Sublinhado
    toggleBtn('button[data-command="underline"]', isUnderline);
    toggleBtn('button[data-cmd="underline"]', isUnderline);
}



// Gera uma cor consistente baseada no ID do utilizador
function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return '#' + "00000".substring(0, 6 - c.length) + c;
}

// --- LIGAR O DETETOR ---



document.querySelector('.tabs-container').addEventListener('click', (e) => {
    leaveArchivePresence(); 
    const clickedTabBtn = e.target.closest('button');
    if (!clickedTabBtn) return;

    const newTab = clickedTabBtn.dataset.tab;
    if (newTab === 'book') {
        window.open('book.html', '_blank'); 
        return; 
    }

    if (currentSaveStatus === 'unsaved') {
        saveNote(true); // Grava imediatamente se houver altera√ß√µes
    }

    // --- SISTEMA DE MEM√ìRIA ---
    // 1. Antes de mudar, guarda a navega√ß√£o da aba ATUAL na mem√≥ria dela
    if (currentTab === 'note') noteStackMemory = [...navigationStack];
    if (currentTab === 'lists') listsStackMemory = [...navigationStack];

    // 2. Atualiza visual das abas
    e.currentTarget.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
    clickedTabBtn.classList.add('active');

    // 3. Muda a aba ativa
    currentTab = newTab;

    // 4. Carrega a navega√ß√£o da NOVA aba a partir da mem√≥ria dela
    if (currentTab === 'note') navigationStack = [...noteStackMemory];
    if (currentTab === 'lists') navigationStack = [...listsStackMemory];
    
     // Adiciona esta linha aqui por seguran√ßa extra:
    updateMobileFABVisibility(); 
    // 5. Atualiza a vista (mantendo o editor aberto se houver uma nota ativa)
    updateNavigationView(true);
});


// Listeners do Editor
noteTitleInput.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
noteContentEditor.addEventListener('input', () => {
      lastContentEditTime = Date.now(); 
    updateSaveStatus('unsaved');
    saveNote();

  
});
document.addEventListener('selectionchange', handleTextSelection);

noteContentEditor.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter faz quebra de linha normal
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const anchorNode = selection.anchorNode;
        // Garante que pegamos o elemento HTML da linha, n√£o o texto
        const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const draggableLine = element.closest('.draggable-line');

        if (draggableLine) {
            e.preventDefault(); // Impede o navegador de fazer o comportamento padr√£o (sair da caixa)
            e.stopPropagation();

            const contentArea = draggableLine.querySelector('.drag-content-area');
            const newParagraph = document.createElement('p');
            
            // Estilo b√°sico para manter alinhamento
            newParagraph.style.margin = "4px 0";

            // --- 1. CORTAR O TEXTO (Se houver texto √† frente do cursor) ---
            const range = selection.getRangeAt(0);
            const rangeToEnd = document.createRange();
            rangeToEnd.selectNodeContents(contentArea);
            rangeToEnd.setStart(range.endContainer, range.endOffset);
            
            const fragment = rangeToEnd.extractContents();
            newParagraph.appendChild(fragment);

            // Se a linha for vazia, mete um <br> para o cursor entrar
            if (newParagraph.innerHTML.trim() === '') {
                newParagraph.innerHTML = '<br>';
            }

            // --- 2. DETETAR O CONTENTOR (A CORRE√á√ÉO EST√Å AQUI) ---
            // Procura se estamos dentro de um Toggle ou de uma Mini-Nota
            const toggleContentBox = draggableLine.closest('.toggle-content');
            const miniNoteContentBox = draggableLine.closest('.mini-note-content');
            
            // Define qual √© a caixa certa
            const targetContainer = toggleContentBox || miniNoteContentBox;

            if (targetContainer) {
                // ESTAMOS DENTRO DE UMA CAIXA
                if (draggableLine.nextElementSibling) {
                    // Se houver linhas abaixo, insere no meio
                    targetContainer.insertBefore(newParagraph, draggableLine.nextElementSibling);
                } else {
                    // Se for a √∫ltima linha, FOR√áA o append dentro da caixa espec√≠fica
                    targetContainer.appendChild(newParagraph);
                }
            } else {
                // ESTAMOS NO EDITOR PRINCIPAL (Fora de caixas)
                // Usa o pai direto (comportamento normal)
                if (draggableLine.nextElementSibling) {
                    draggableLine.parentNode.insertBefore(newParagraph, draggableLine.nextElementSibling);
                } else {
                    draggableLine.parentNode.appendChild(newParagraph);
                }
            }

            // --- 3. MOVER O CURSOR PARA A NOVA LINHA ---
            const newRange = document.createRange();
            if (newParagraph.firstChild && newParagraph.firstChild.nodeType === 3) {
                newRange.setStart(newParagraph.firstChild, 0);
            } else {
                newRange.selectNodeContents(newParagraph);
            }
            newRange.collapse(true);
            
            selection.removeAllRanges();
            selection.addRange(newRange);

            // Grava a altera√ß√£o
            saveNote();
        }
    }
});

// ADICIONA ESTA LINHA AQUI:
noteContentEditor.addEventListener('keydown', handleBoundaryProtection);

// E ADICIONA TAMB√âM ESTA PARA O ARQUIVO:
document.getElementById('archive-feed').addEventListener('keydown', (e) => {
    if (e.target.classList.contains('post-editor-content')) {
        handleBoundaryProtection(e);
    }
});

// ====================================================================
// L√ìGICA DE CORES DO TOGGLE
// ====================================================================
let activeToggleForColor = null;
const toggleColorPopup = document.getElementById('toggle-color-popup');

// 1. Abrir o Popup ao clicar no Pincel
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('.toggle-color-btn');
    if (!colorBtn) return;

    e.preventDefault(); e.stopPropagation();

    // Identifica o Toggle
    activeToggleForColor = colorBtn.closest('details.toggle-section');
    
    // Posiciona o Popup
    const rect = colorBtn.getBoundingClientRect();
    toggleColorPopup.style.display = 'block';
    toggleColorPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
    // Alinha para n√£o sair do ecr√£ √† direita
    toggleColorPopup.style.left = `${(rect.left + window.scrollX) - 100}px`;
});

// 2. Escolher a Cor (Delegation no Popup)
toggleColorPopup.addEventListener('click', (e) => {
    e.stopPropagation(); // Impede fechar ao clicar dentro

    // Bot√£o de cor
    if (e.target.classList.contains('color-choice')) {
        if (activeToggleForColor) {
            const color = e.target.dataset.color;
            // Aplica a cor ao fundo do Toggle e do conte√∫do
            activeToggleForColor.style.backgroundColor = color;
            activeToggleForColor.style.borderColor = color;
            
            // Opcional: Ajustar a cor do texto para preto para garantir contraste
            activeToggleForColor.style.color = '#333333'; 
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '#000000';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
    
    // Bot√£o Reset (Sem Cor)
    else if (e.target.classList.contains('color-choice-reset')) {
        if (activeToggleForColor) {
            activeToggleForColor.style.backgroundColor = '';
            activeToggleForColor.style.borderColor = '';
            activeToggleForColor.style.color = ''; // Volta ao padr√£o
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
});

// 3. Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (toggleColorPopup.style.display !== 'none') {
        if (!toggleColorPopup.contains(e.target) && !e.target.closest('.toggle-color-btn')) {
            toggleColorPopup.style.display = 'none';
            activeToggleForColor = null;
        }
    }
});

// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
document.getElementById('generic-list-modal').addEventListener('click', (e) => {
    // Procura por um bot√£o de edi√ß√£o de anexo
    const editButton = e.target.closest('button[data-action="edit-anexo"]');
    if (editButton) {
        const anexoId = editButton.dataset.id;
        if (anexoId) {
            document.getElementById('generic-list-modal').style.display = 'none';
            openLinkModal(true, { id: anexoId });
        }
        return; // Termina a execu√ß√£o aqui
    }

    // <<<<<<< NOVO: Procura por um item de lista de tag clic√°vel >>>>>>>>>
    const tagListItem = e.target.closest('li[data-action="show-tag-references"]');
    if (tagListItem) {
        const tagName = tagListItem.dataset.tagName;
        if (tagName) {
            // 1. Fecha o modal de tags
            document.getElementById('generic-list-modal').style.display = 'none';
            // 2. Abre o painel de refer√™ncias para essa tag
            showTagReferencesPanel(tagName);
        }
    }
});


// ====================================================================
// 2. DETETAR CLIQUE NA IDEIA (Abrir Menu ‚úÇÔ∏è üß≤)
// ====================================================================
 let activeIdeaElement = null; 

noteContentEditor.addEventListener('click', (e) => {
    // Tenta encontrar o span da ideia onde clic√°mos
    const ideaSpan = e.target.closest('.idea-span');
    const ideaPopup = document.getElementById('idea-actions-popup');

    // Se clicou numa ideia
    if (ideaSpan) {
        // --- CORRE√á√ÉO DO ERRO ORTOGR√ÅFICO ---
        // For√ßa o navegador a ignorar erros ortogr√°ficos NESTE elemento espec√≠fico.
        // Isto remove o sublinhado vermelho e impede o menu nativo do browser de aparecer.
        if (ideaSpan.spellcheck !== false) {
            ideaSpan.spellcheck = false;
            // Opcional: for√ßa um "repaint" leve se o browser n√£o atualizar logo
            ideaSpan.setAttribute('spellcheck', 'false'); 
        }
        // -------------------------------------

        // Guardamos a refer√™ncia globalmente
        activeIdeaElement = ideaSpan;

        // Calcula a posi√ß√£o para o menu aparecer logo abaixo do texto
        const rect = ideaSpan.getBoundingClientRect();
        
        ideaPopup.style.display = 'flex';
        ideaPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        ideaPopup.style.left = `${rect.left + window.scrollX}px`;
        
        // Impede que o clique se propague e ative outros listeners
        e.stopPropagation(); 
        e.preventDefault();
        return;
    } 
    
    // Se clicou fora, fecha o popup
    if (ideaPopup && ideaPopup.style.display === 'flex' && !e.target.closest('#idea-actions-popup')) {
        ideaPopup.style.display = 'none';
        activeIdeaElement = null;
    }
});

// ====================================================================
// 3. A√á√ïES DO MENU DA IDEIA (‚úÇÔ∏è e üß≤)
// ====================================================================
const ideaPopupElement = document.getElementById('idea-actions-popup');
if (ideaPopupElement) {
    ideaPopupElement.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeIdeaElement) return;

        e.stopPropagation(); // Impede fechar o menu ao clicar no bot√£o

        const action = btn.dataset.action;

        // --- A√á√ÉO ‚úÇÔ∏è: REMOVER IDEIA ---
        if (action === 'remove-idea') {
            const text = activeIdeaElement.textContent;
            const parent = activeIdeaElement.parentNode;
            
            // Substitui o span pelo texto simples
            const textNode = document.createTextNode(text);
            parent.replaceChild(textNode, activeIdeaElement);
            parent.normalize(); // Junta n√≥s de texto adjacentes

            saveNote();
            ideaPopupElement.style.display = 'none';
        }

        // --- A√á√ÉO üß≤: ADICIONAR A OUTRA NOTA ---
        else if (action === 'append-idea') {
            ideaPopupElement.style.display = 'none'; // Fecha o menu pequeno
            await openNoteSelectorForIdea();  // Abre o seletor de notas
        }
    });
}

// ====================================================================
// 4. FUN√á√ïES AUXILIARES PARA IDEIAS (Seletor e Transfer√™ncia)
// ====================================================================

// A. SELETOR DE NOTAS
async function openNoteSelectorForIdea() {
    if (!selectedNoteId) return;

    const modal = document.getElementById('select-note-modal');
    const list = document.getElementById('select-note-list');
    
    modal.style.display = 'flex';
    list.innerHTML = '<li>A carregar notas...</li>';

    try {
        // 1. Descobrir o parentId da nota atual
        const currentNoteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        const currentParentId = currentNoteSnap.exists() ? currentNoteSnap.data().parentId : null;

        // 2. Buscar todas as NOTAS (n√£o pastas) que est√£o na MESMA pasta
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', currentParentId),
            where('tipo', '==', 'nota'), // S√≥ queremos notas
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty || (snapshot.size === 1 && snapshot.docs[0].id === selectedNoteId)) {
            list.innerHTML = '<li>Nenhuma outra nota nesta pasta.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            // N√£o mostrar a pr√≥pria nota atual
            if (docSnap.id === selectedNoteId) return;

            const noteData = docSnap.data();
            const li = document.createElement('li');
            li.textContent = "üìÑ " + noteData.nome;
            li.style.cursor = 'pointer';
            li.style.padding = '10px';
            li.style.borderBottom = '1px solid var(--border-color)';
            
            // Ao clicar numa nota da lista
            li.onclick = () => transferIdeaToNote(docSnap.id, noteData);
            
            list.appendChild(li);
        });

    } catch (error) {
        console.error(error);
        list.innerHTML = '<li>Erro ao carregar notas.</li>';
    }
}

// B. TRANSFERIR O TEXTO
async function transferIdeaToNote(targetNoteId, targetNoteData) {
    if (!activeIdeaElement) return;

    const textToTransfer = activeIdeaElement.textContent;
    const modal = document.getElementById('select-note-modal');

    try {
        // Adiciona o texto ao final do conte√∫do existente da nota alvo
        const newContent = (targetNoteData.conteudo || "") + `<br><p>üí° ${textToTransfer}</p>`;

        const targetRef = doc(db, 'pastas', targetNoteId);
        await updateDoc(targetRef, {
            conteudo: newContent,
            ultimaedicao: serverTimestamp()
        });

        alert(`Ideia adicionada √† nota "${targetNoteData.nome}" com sucesso!`);
        modal.style.display = 'none';

    } catch (error) {
        console.error("Erro ao transferir:", error);
        alert("Erro ao adicionar ideia √† nota.");
    }
}


// 1. Abrir o Modal e Iniciar Navega√ß√£o
function openAggregationSelector() {
    const modal = document.getElementById('aggregation-modal');
    const nameSpan = document.getElementById('aggregation-new-name');
    
    // Reset das vari√°veis de navega√ß√£o do modal
    aggregationStack = []; 
    aggregationSelectedItems = [];
    updateAggregationCount();
    
    nameSpan.textContent = aggregationTargetName;
    modal.style.display = 'flex';
    
    // L√ìGICA ALTERADA:
    // Verifica se estamos numa Superpasta. Se sim, a "Raiz" √© a Superpasta.
    // Se n√£o, a "Raiz" √© null (In√≠cio absoluto).
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    // Carrega sempre a partir do in√≠cio, independentemente de onde vamos gravar a nota
    loadAggregationLevel(startRootId);
}

// 2. Carregar N√≠vel (Pastas e Notas)
async function loadAggregationLevel(parentId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    
    // Atualiza breadcrumbs
    if (aggregationStack.length > 0) {
        pathSpan.textContent = aggregationStack[aggregationStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathSpan.textContent = parentId ? "Pasta Atual" : "Pasta Raiz";
        backBtn.style.display = 'none'; // Se estamos na base, esconde voltar
    }

    try {
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', parentId),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('tipo'), // Pastas primeiro, depois notas (alfabeticamente depende do locale)
            orderBy('nome')
        );
        
        const snapshot = await getDocs(q);
        list.innerHTML = '';
        
        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Pasta vazia.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            
            const li = document.createElement('li');
            li.className = 'agreg-item';
            
            if (item.tipo === 'pasta') {
                li.classList.add('agreg-type-folder');
                li.innerHTML = `üìÅ ${item.nome}`;
                li.onclick = () => {
                    aggregationStack.push({ id: item.id, name: item.nome });
                    loadAggregationLevel(item.id);
                };
            } else if (item.tipo === 'nota') {
                li.classList.add('agreg-type-note');
                li.innerHTML = `üìÑ ${item.nome}`;
                li.onclick = () => {
                    // Ao clicar na nota, carregamos as caixas dentro dela
                    aggregationStack.push({ id: item.id, name: item.nome, type: 'nota' });
                    loadNoteBoxesForAggregation(item.id);
                };
            }
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar itens.</li>';
    }
}

// 3. Carregar Caixas dentro de uma Nota (Parsing HTML)
async function loadNoteBoxesForAggregation(noteId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');

    // Atualiza UI
    pathSpan.textContent = "üìÑ " + aggregationStack[aggregationStack.length - 1].name;
    backBtn.style.display = 'block';
    list.innerHTML = '<li style="padding:10px;">A analisar conte√∫do da nota...</li>';

    try {
        const noteDoc = await getDoc(doc(db, 'pastas', noteId));
        if (!noteDoc.exists()) return;

        const content = noteDoc.data().conteudo || "";
        
        // Parse do HTML da nota
        const parser = new DOMParser();
        const docHTML = parser.parseFromString(content, 'text/html');
        const wrappers = docHTML.querySelectorAll('.mini-note-wrapper');

        list.innerHTML = '';
        
        if (wrappers.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Esta nota n√£o tem Subnotas, Quest√µes ou Contentores.</li>';
            return;
        }

        wrappers.forEach((wrapper, index) => {
            // Extrair T√≠tulo
            let title = "Sem T√≠tulo";
            let typeClass = "";
            let typeLabel = "";

            // Detetar Tipo
            if (wrapper.classList.contains('question-mode')) {
                typeClass = "agreg-box-question";
                typeLabel = "Quest√£o";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "Quest√£o sem t√≠tulo";
            } else if (wrapper.classList.contains('free-mode')) {
                typeClass = "agreg-box-free";
                typeLabel = "Contentor";
                // L√≥gica de primeira frase para contentores livres
                const text = wrapper.querySelector('.mini-note-content').textContent.trim();
                if (text) {
                    const firstSentence = text.split(/[.!?]/)[0];
                    title = firstSentence.length > 50 ? firstSentence.substring(0, 50) + "..." : firstSentence;
                } else {
                    title = "Contentor Vazio";
                }
            } else {
                typeClass = "agreg-box-subnote";
                typeLabel = "SubNota";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "SubNota sem t√≠tulo";
            }

            // Criar ID √∫nico tempor√°rio para controlo de sele√ß√£o
            const uniqueId = `${noteId}_${index}`;
            const isSelected = aggregationSelectedItems.some(i => i.uniqueId === uniqueId);

            const li = document.createElement('li');
            li.className = `agreg-box-item ${typeClass} ${isSelected ? 'selected' : ''}`;
            
            // Checkbox visual
            const check = isSelected ? "‚òëÔ∏è" : "‚¨ú";

            li.innerHTML = `
                <div style="font-size:1.2em;">${check}</div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:0.9em; color:var(--text-muted-color); text-transform:uppercase;">${typeLabel}</span>
                    <span style="color:var(--text-color);">${title}</span>
                </div>
            `;

            li.onclick = () => {
                toggleAggregationItem(uniqueId, wrapper.outerHTML, li);
            };

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao ler nota.</li>';
    }
}

// 4. Selecionar/Desselecionar Item
function toggleAggregationItem(uniqueId, htmlContent, liElement) {
    const existingIndex = aggregationSelectedItems.findIndex(i => i.uniqueId === uniqueId);

    if (existingIndex > -1) {
        // Remover
        aggregationSelectedItems.splice(existingIndex, 1);
        liElement.classList.remove('selected');
        liElement.querySelector('div').textContent = "‚¨ú";
    } else {
        // Adicionar
        aggregationSelectedItems.push({ uniqueId, html: htmlContent });
        liElement.classList.add('selected');
        liElement.querySelector('div').textContent = "‚òëÔ∏è";
    }
    updateAggregationCount();
}

function updateAggregationCount() {
    document.getElementById('agreg-count').textContent = `${aggregationSelectedItems.length} itens selecionados`;
}

// 5. Navega√ß√£o "Voltar"
document.getElementById('agreg-back-btn').addEventListener('click', () => {
    
    // Determina qual √© a raiz l√≥gica (Superpasta ou Global)
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (aggregationStack.length > 0) {
        aggregationStack.pop(); // Remove n√≠vel atual
        
        if (aggregationStack.length > 0) {
            // Se ainda houver itens no hist√≥rico, carrega esse n√≠vel
            const parent = aggregationStack[aggregationStack.length - 1];
            if (parent.type === 'nota') {
                loadNoteBoxesForAggregation(parent.id);
            } else {
                loadAggregationLevel(parent.id);
            }
        } else {
            // Se o hist√≥rico ficou vazio, voltamos √† Raiz
            loadAggregationLevel(rootId);
        }
    } else {
        // Seguran√ßa: se clicar e j√° estiver vazio
        loadAggregationLevel(rootId);
    }
});

// 6. FINALIZAR: Criar a Nota com as Caixas
document.getElementById('agreg-finish-btn').addEventListener('click', async () => {
    if (aggregationSelectedItems.length === 0) {
        alert("Selecione pelo menos uma caixa.");
        return;
    }

    const btn = document.getElementById('agreg-finish-btn');
    btn.textContent = "A criar...";
    btn.disabled = true;

    try {
        // Constr√≥i o HTML final
        let finalHTML = "";
        aggregationSelectedItems.forEach(item => {
            finalHTML += item.html + "<p><br></p>"; 
        });

        // Determina a ordem
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', aggregationParentId), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const siblingsSnap = await getDocs(q);
        const newOrder = siblingsSnap.size;

        // --- ALTERA√á√ÉO AQUI: Guardamos a refer√™ncia do documento criado ---
        const docRef = await addDoc(collection(db, 'pastas'), {
            nome: aggregationTargetName, 
            parentId: aggregationParentId, 
            tipo: 'nota', 
            conteudo: finalHTML,
            userId: auth.currentUser.uid, 
            estado: 'ativa',
            ordem: newOrder, 
            createdAt: serverTimestamp(), 
            ultimaedicao: serverTimestamp()
        });

        // 1. Fechar o Modal
        document.getElementById('aggregation-modal').style.display = 'none';
        
        // 2. Abrir a Nota Imediatamente
        // Passamos 'null' no segundo argumento porque o elemento da lista 
        // ainda pode n√£o ter sido renderizado pelo onSnapshot, mas a fun√ß√£o abre pelo ID na mesma.
        displayNote(docRef.id, null); 
        
    } catch (e) {
        console.error("Erro ao criar agrega√ß√£o:", e);
        alert("Erro ao criar.");
    } finally {
        btn.textContent = "Criar Agrega√ß√£o";
        btn.disabled = false;
    }
});

// ====================================================================
// SCANNER UNIVERSAL (üé∞) - B√≠blia, Personagens, Locais, Datas
// ====================================================================

let universalScanResults = {
    textobiblico: { new: [], existing: [] },
    personagem: { new: [], existing: [] },
    local: { new: [], existing: [] },
    data: { new: [], existing: [] }
};
let currentScanTab = 'textobiblico';


// 2. FUN√á√ÉO PRINCIPAL: ANALISAR TEXTO
async function openUniversalScanner() {
    const modal = document.getElementById('universal-scan-modal');
    if (!modal) return;

    // --- FOR√áA BRUTA DE VISIBILIDADE ---
    document.body.appendChild(modal); // Move para a raiz do body
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9000000"; // Acima de quase tudo
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Reset total de resultados
    universalScanResults = {
        textobiblico: { new: [], existing: [] },
        personagem: { new: [], existing: [] },
        local: { new: [], existing: [] },
        data: { new: [], existing: [] }
    };
    

    // --- FASE 1: J√Å EXISTENTES (Guardar refer√™ncia do elemento) ---
    const existingLinks = noteContentEditor.querySelectorAll('.entity-link');
    existingLinks.forEach(link => {
        const type = link.dataset.entityType;
        if (universalScanResults[type]) {
            universalScanResults[type].existing.push({
                linkElement: link, // Guardamos o elemento DOM para poder remover
                text: link.textContent,
                line: getApproximateLineNumber(link),
                selected: true // J√° √© link, logo come√ßa "Ativo"
            });
        }
    });

    // --- FASE 2: NOVOS CANDIDATOS ---
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const bibleRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'gi');
    const dateRegex = /\b\d{1,2}[-\/]\d{1,2}[-\/]\d{4}\b/g;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    let node;

    while (node = walker.nextNode()) {
        if (node.parentElement.closest('.entity-link, a, .tag, script, style')) continue;

        const text = node.textContent;
        const lineNum = getApproximateLineNumber(node);

        // A. B√≠blia
        let match;
        while ((match = bibleRegex.exec(text)) !== null) {
            addCandidate('textobiblico', match[0], node, match.index, lineNum);
        }
        // B. Datas
        while ((match = dateRegex.exec(text)) !== null) {
            addCandidate('data', match[0], node, match.index, lineNum);
        }
        // C. Personagens/Locais (BD)
        checkDatabaseEntities(text, node, lineNum, 'personagem');
        checkDatabaseEntities(text, node, lineNum, 'local');
    }

    renderScanTab(currentScanTab);
    modal.style.display = 'flex';
}

function addCandidate(type, matchText, textNode, index, lineNum, cleanName = null) {
    const finalName = cleanName || matchText.trim().replace(/[.,;]+$/, '');
    
    const exists = universalScanResults[type].new.some(c => c.textNode === textNode && c.index === index);
    if (exists) return;

    universalScanResults[type].new.push({
        textNode: textNode,
        matchText: matchText,
        cleanName: finalName,
        index: index,
        line: lineNum,
        contextSnippet: getContextSnippet(textNode.textContent, index, matchText.length),
        selected: false // Novos come√ßam "Inativos" (Texto simples)
    });
}

function checkDatabaseEntities(text, node, lineNum, type) {
    if (!allEntities[type]) return;
    allEntities[type].forEach(entity => {
        const regex = new RegExp(`\\b${escapeRegExp(entity.nome)}\\b`, 'g');
        let match;
        while ((match = regex.exec(text)) !== null) {
            addCandidate(type, match[0], node, match.index, lineNum, entity.nome); 
        }
    });
}

// 3. RENDERIZA√á√ÉO DA ABA ATUAL
function renderScanTab(type) {
    const container = document.getElementById('scan-lists-container');
    container.innerHTML = '';
    const data = universalScanResults[type];
    
    // Atualiza o texto do bot√£o Select All
    updateSelectAllButtonState();

    // --- LISTA DE NOVOS (Check = Criar Link) ---
    if (data.new.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.textContent = `‚ö° Novos Detetados (${data.new.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.new.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'new');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    } else {
        container.innerHTML += '<div style="padding:10px; color:#888;">Nada novo aqui.</div>';
    }

    // --- LISTA DE EXISTENTES (Uncheck = Remover Link) ---
    if (data.existing.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.style.color = "#2ecc71";
        title.textContent = `‚úì J√° Identificados (${data.existing.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.existing.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'existing');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    }
}

// Fun√ß√£o auxiliar para criar o HTML da linha
function createScanListItem(item, idx, listType) {
    const li = document.createElement('li');
    li.className = 'scan-item-row';
    
    // Nome do item (cleanName para novos, text para existentes)
    const displayName = listType === 'new' ? item.cleanName : item.text;
    const isChecked = item.selected ? 'checked' : '';
    
    // Estilo visual: se for existente e estiver desmarcado, risca o texto
    const textStyle = (listType === 'existing' && !item.selected) ? 'text-decoration: line-through; opacity: 0.6;' : '';

    li.innerHTML = `
        <input type="checkbox" class="scan-checkbox" id="scan-${listType}-${idx}" ${isChecked}>
        <div class="scan-info" style="${textStyle}">
            <span class="scan-name">${displayName}</span>
            <span class="scan-location">Linha aprox. ${item.line}</span>
        </div>
        ${listType === 'new' ? '<button class="scan-preview-btn" title="Ver Contexto">üîç</button>' : ''}
    `;

    // Evento de Clique na Linha
    li.addEventListener('click', (e) => {
        if (e.target.closest('.scan-preview-btn')) return;
        
        const checkbox = li.querySelector('input');
        if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
        
        // Atualiza modelo
        item.selected = checkbox.checked;
        
        // Atualiza visual (riscar se for para remover)
        const infoDiv = li.querySelector('.scan-info');
        if (listType === 'existing') {
            infoDiv.style.textDecoration = item.selected ? 'none' : 'line-through';
            infoDiv.style.opacity = item.selected ? '1' : '0.6';
        }

        updateSelectAllButtonState();
    });

    // Lupa (apenas para novos)
    if (listType === 'new') {
        li.querySelector('.scan-preview-btn').onclick = (e) => {
            e.stopPropagation();
            showScanPreview(item.cleanName, item.contextSnippet);
        };
    }

    return li;
}

// 4. L√ìGICA DO BOT√ÉO "SELECIONAR TODOS / REMOVER TODOS"
const toggleAllBtn = document.getElementById('scan-toggle-all-btn');

function updateSelectAllButtonState() {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    
    if (totalItems === 0) {
        toggleAllBtn.style.display = 'none';
        return;
    }
    toggleAllBtn.style.display = 'block';
    
    // Verifica se TODOS (novos e existentes) est√£o marcados
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    
    // Se tudo estiver marcado, o bot√£o diz "Remover Todos". Sen√£o, "Selecionar Todos".
    const allSelected = allNewSelected && allExistSelected;
    toggleAllBtn.textContent = allSelected ? "Desmarcar Todos" : "Selecionar Todos";
}

toggleAllBtn.addEventListener('click', () => {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    if (totalItems === 0) return;

    // L√≥gica: Se tudo marcado -> desmarca tudo. Sen√£o -> marca tudo.
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    const newState = !(allNewSelected && allExistSelected);

    // 1. Atualiza Dados
    data.new.forEach(i => i.selected = newState);
    data.existing.forEach(i => i.selected = newState);

    // 2. Re-renderiza a lista para atualizar visuais (riscos e checkboxes)
    renderScanTab(currentScanTab);
});

// 5. GEST√ÉO DE ABAS
document.querySelector('.scan-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('scan-tab-btn')) {
        document.querySelectorAll('.scan-tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentScanTab = e.target.dataset.target;
        document.getElementById('scan-preview-popup').style.display = 'none';
        renderScanTab(currentScanTab);
    }
});

// 6. PREVIEW e CONTEXTO
function showScanPreview(name, snippet) {
    const popup = document.getElementById('scan-preview-popup');
    const content = document.getElementById('scan-preview-content');
    const safeName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedHTML = snippet.replace(new RegExp(`(${safeName})`, 'gi'), '<mark>$1</mark>');
    content.innerHTML = `... ${highlightedHTML} ...`;
    popup.style.display = 'block';
}

function getContextSnippet(fullText, index, length) {
    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + length + 40);
    return fullText.substring(start, end);
}

function getApproximateLineNumber(node) {
    const block = node.nodeType === 3 ? node.parentElement.closest('p, div, li, h1, h2') : node.closest('p, div, li, h1, h2');
    if (!block) return 1;
    let count = 1;
    let current = block;
    while (current = current.previousElementSibling) count++;
    return count;
}

// 7. APLICAR MUDAN√áAS (CONVERTER E REVERTER)
document.getElementById('confirm-scan-btn').addEventListener('click', async () => {
    
    // Altera o texto do bot√£o para feedback
    const confirmBtn = document.getElementById('confirm-scan-btn');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = "A processar...";
    confirmBtn.disabled = true;

    let changesMade = false;

    // Percorre TODAS as abas (tipos)
    for (const type in universalScanResults) {
        
        // --- A. CONVERTER NOVOS (Que est√£o selecionados) ---
        const newToConvert = universalScanResults[type].new.filter(i => i.selected);
        
        // Ordena inversamente (baixo para cima) para n√£o estragar √≠ndices
        newToConvert.sort((a, b) => {
            if (a.textNode === b.textNode) return b.index - a.index;
            return 0;
        });

        for (const item of newToConvert) {
            try {
                if (item.textNode.textContent.includes(item.matchText)) {
                    const textNode = item.textNode;
                    const splitTarget = textNode.splitText(item.index);
                    splitTarget.splitText(item.matchText.length); // Isola o texto
                    
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = type;
                    span.dataset.entityName = item.cleanName;
                    span.textContent = item.cleanName;

                    splitTarget.parentNode.replaceChild(span, splitTarget);
                    
                    // Atualiza BD
                    await ensureEntityReference(type, item.cleanName);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro convers√£o:", e); }
        }

        // --- B. REMOVER EXISTENTES (Que foram desmarcados) ---
        const existingToRemove = universalScanResults[type].existing.filter(i => !i.selected);
        
        for (const item of existingToRemove) {
            try {
                const linkEl = item.linkElement;
                if (linkEl && linkEl.parentNode) {
                    const textNode = document.createTextNode(linkEl.textContent);
                    linkEl.parentNode.replaceChild(textNode, linkEl);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro revers√£o:", e); }
        }
    }

    if (changesMade) {
        noteContentEditor.normalize(); // Limpa DOM
        updateSaveStatus('unsaved');
        saveNote();
        
        // Recarrega cache
        if(typeof fetchAllEntities === 'function') fetchAllEntities();
    }

    document.getElementById('universal-scan-modal').style.display = 'none';
    
    // Restaura bot√£o
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
});

// Auxiliar BD (Igual)
async function ensureEntityReference(type, name) {
    const flatEntities = Object.values(allEntities).flat();
    const existing = flatEntities.find(e => e.tipo === type && e.nome === name);
    const collectionName = ENTITY_CONFIG[type].collection;

    if (!existing) {
        try {
            await addDoc(collection(db, collectionName), {
                nome: name, descricao: "", userId: auth.currentUser.uid,
                createdAt: serverTimestamp(), referencias: { [selectedNoteId]: true }
            });
            if(!allEntities[type]) allEntities[type] = [];
            allEntities[type].push({ id: 'temp', nome: name, tipo: type });
        } catch(e) { console.error(e); }
    }
}

// ====================================================================
// L√ìGICA DE CRIA√á√ÉO DE NOVOS MARCADORES (+)
// ====================================================================

// 1. Abrir o popup de criar marcador ao clicar no "+"
const openCreateBookmarkBtn = document.getElementById('open-create-bookmark-btn');
if (openCreateBookmarkBtn) {
    // Removemos o listener antigo para evitar conflitos e criamos um novo
    const newBtn = openCreateBookmarkBtn.cloneNode(true);
    openCreateBookmarkBtn.parentNode.replaceChild(newBtn, openCreateBookmarkBtn);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const modal = document.getElementById('create-bookmark-modal');
        if (!modal) return;

        // --- CORRE√á√ÉO DE HIERARQUIA ---
        // Move o modal para o final do body para n√£o ficar preso atr√°s de outros modais
        document.body.appendChild(modal);
        
        // Limpa os campos
        document.getElementById('new-bookmark-title').value = '';
        document.getElementById('new-bookmark-desc').value = '';
        
        // For√ßa a visibilidade no topo absoluto
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "10000000"; // Um n√≠vel acima do modal anterior
        modal.style.visibility = "visible";
        modal.style.opacity = "1";
        
        // Foca no input
        setTimeout(() => {
            const input = document.getElementById('new-bookmark-title');
            if(input) input.focus();
        }, 100);
    });
}

// 2. Bot√£o Cancelar (Fechar o popup)
const cancelCreateBookmarkBtn = document.getElementById('cancel-create-bookmark');
if (cancelCreateBookmarkBtn) {
    cancelCreateBookmarkBtn.addEventListener('click', () => {
        document.getElementById('create-bookmark-modal').style.display = 'none';
    });
}

// 3. Bot√£o Criar (Gravar na Base de Dados)
const confirmCreateBookmarkBtn = document.getElementById('confirm-create-bookmark');
if (confirmCreateBookmarkBtn) {
    confirmCreateBookmarkBtn.addEventListener('click', async () => {
        const titleInput = document.getElementById('new-bookmark-title');
        const descInput = document.getElementById('new-bookmark-desc');
        
        const nome = titleInput.value.trim();
        const descricao = descInput.value.trim();

        if (!nome) {
            alert("O t√≠tulo do marcador √© obrigat√≥rio.");
            return;
        }

        // Feedback visual
        const originalText = confirmCreateBookmarkBtn.textContent;
        confirmCreateBookmarkBtn.textContent = "A criar...";
        confirmCreateBookmarkBtn.disabled = true;

        try {
            // Importar fun√ß√µes do Firestore (j√° devem estar importadas no topo do seu ficheiro)
            // addDoc, collection, serverTimestamp, auth, db...

            await addDoc(collection(db, 'marcadores'), {
                nome: nome,
                descricao: descricao,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Sucesso: Fecha o modal e recarrega a lista
            document.getElementById('create-bookmark-modal').style.display = 'none';
            
            // Recarrega a lista do modal principal para mostrar o novo item
            await openBookmarksModal(); 

        } catch (error) {
            console.error("Erro ao criar marcador:", error);
            alert("Erro ao criar o marcador. Verifique a consola.");
        } finally {
            // Restaura o bot√£o
            confirmCreateBookmarkBtn.textContent = originalText;
            confirmCreateBookmarkBtn.disabled = false;
        }
    });
}

  noteContentEditor.addEventListener('keyup', (event) => {
    // Ignora teclas de navega√ß√£o
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(event.key)) {
        return;
    }
    
    if (isTagPopupOpen || isEntityPopupOpen) {
        if (['Enter', ' '].includes(event.key)) return;
    }

    if (event.key === 'Escape') { 
        hideTagPopup();
        hideEntityPopup();
        return; 
    }

    const selection = window.getSelection();
    if (!selection.rangeCount > 0) return;
    const range = selection.getRangeAt(0);
    const container = range.startContainer;
    const offset = range.startOffset;

    // Texto ANTES do cursor
    const textBeforeCursor = container.textContent.substring(0, offset);
    
    // Texto DEPOIS do cursor
    const textAfterCursor = container.textContent.substring(offset);

    const tagMatch = textBeforeCursor.match(/#(\w*)$/);
    const entityMatch = textBeforeCursor.match(/@([\w\s]*)$/);

    if (tagMatch) {
        hideEntityPopup();
        currentTagQueryRange = document.createRange();
        currentTagQueryRange.setStart(container, tagMatch.index);
        currentTagQueryRange.setEnd(container, offset);
        showTagPopup(tagMatch[1]);

    } else if (entityMatch) {
        hideTagPopup();
        currentEntityQueryRange = document.createRange();
        
        // Ponto de in√≠cio: onde est√° o @
        currentEntityQueryRange.setStart(container, entityMatch.index);

        // --- L√ìGICA DE "ETIQUETAGEM INTELIGENTE" ---
        
        // Verifica se o utilizador acabou de digitar o @ (query vazia)
        // E se existe uma palavra "colada" logo √† frente do cursor
        const isAtStartOfWord = entityMatch[1] === '' && /^\w/.test(textAfterCursor);

        if (isAtStartOfWord) {
            // Identifica a palavra que est√° √† frente (ex: "David" em "@|David")
            const wordAfterMatch = textAfterCursor.match(/^(\w+)/);
            
            if (wordAfterMatch) {
                const wordToConsume = wordAfterMatch[1];
                
                // Expande o range de substitui√ß√£o para incluir a palavra da frente
                currentEntityQueryRange.setEnd(container, offset + wordToConsume.length);
                
                // Usa a palavra da frente como pesquisa para o popup
                showEntityPopup(wordToConsume);
                return; // Sai para n√£o executar o showEntityPopup normal abaixo
            }
        }

        // Comportamento normal (escrevendo novo texto)
        currentEntityQueryRange.setEnd(container, offset);
        showEntityPopup(entityMatch[1]);

    } else {
        hideTagPopup();
        hideEntityPopup();
    }
    
});



// 1. ESCUTAR O CLIQUE NO BOT√ÉO üß¨
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="append-mini-note"]');
    if (!btn) return;

    e.preventDefault(); e.stopPropagation();

    // Captura o HTML da caixa inteira
    const wrapper = btn.closest('.mini-note-wrapper');
    if (wrapper) {
        // Clonamos para garantir que n√£o alteramos o original durante a c√≥pia
        htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
        openAppendModal();
    }
});

// 2. ABRIR O MODAL
function openAppendModal() {
    console.log("üöÄ Abrindo seletor de destino para clonagem...");
    
    const modal = document.getElementById('append-to-note-modal');
    if (!modal) return console.error("Modal #append-to-note-modal n√£o encontrado!");

    // 1. MOVE PARA O BODY (Camada Superior)
    document.body.appendChild(modal);

    // 2. FOR√áA VISIBILIDADE E Z-INDEX ALTO
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "5000000"; // N√≠vel de prioridade alto
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 3. RESET DA NAVEGA√á√ÉO INTERNA
    appendStack = [];
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    loadAppendList(rootId);
}

// 3. CARREGAR LISTA (PASTAS E NOTAS)
async function loadAppendList(parentId) {
    const list = document.getElementById('append-list');
    const backBtn = document.getElementById('append-back-btn');
    const pathLabel = document.getElementById('append-current-path');
    const myUid = auth.currentUser.uid;
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    // Identifica o ponto de partida (Raiz Global ou ID da Superpasta)
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    // Gest√£o de T√≠tulos e Bot√£o Voltar (Breadcrumbs)
    if (parentId === "VIRTUAL_SHARED_ROOT") {
        pathLabel.textContent = "ü§ù Partilha";
        backBtn.style.display = 'block';
    } else if (appendStack.length > 0) {
        pathLabel.textContent = appendStack[appendStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathLabel.textContent = (startRootId) ? "üè† Superpasta" : "üåç Raiz Global";
        backBtn.style.display = 'none';
    }

    try {
        const foldersRef = collection(db, 'pastas');
        let unifiedDocs = new Map();

        // --- BLOCO A: BUSCAR ARQUIVOS PARTILHADOS (Se estivermos dentro da "pasta" Partilha) ---
        if (parentId === "VIRTUAL_SHARED_ROOT") {
            const qOwner = query(foldersRef, 
                where('tipo', '==', 'partilhado'), 
                where('estado', '==', 'ativa'),
                where('userId', '==', myUid)
            );
            const qCollab = query(foldersRef, 
                where('tipo', '==', 'partilhado'), 
                where('estado', '==', 'ativa'),
                where(`colaboradores.${myUid}`, '==', true)
            );

            const [snapOwner, snapCollab] = await Promise.all([getDocs(qOwner), getDocs(qCollab)]);
            snapOwner.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
            snapCollab.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
        } 
        // --- BLOCO B: BUSCAR PASTAS E NOTAS LOCAIS (Comportamento normal) ---
        else {
            const qNormal = query(foldersRef,
                where('parentId', '==', parentId),
                where('estado', '==', 'ativa'),
                where('userId', '==', myUid),
                orderBy('tipo'),
                orderBy('nome')
            );
            const snapNormal = await getDocs(qNormal);
            snapNormal.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
        }

        // LIMPAR LISTA E COME√áAR A RENDERIZAR
        list.innerHTML = '';

        // 1. INJETAR O ACESSO √Ä PARTILHA (Apenas se estivermos no "in√≠cio" da navega√ß√£o)
        if (parentId === startRootId) {
            const sharedLink = document.createElement('li');
            sharedLink.style.cssText = "display:flex; justify-content:space-between; padding:12px; border-bottom:2px solid var(--border-color); background: rgba(231, 76, 60, 0.05); cursor:pointer; color: #e74c3c; font-weight: bold;";
            sharedLink.innerHTML = `<span>ü§ù Partilha (Arquivos)</span> <span>‚ûî</span>`;
            sharedLink.onclick = () => loadAppendList("VIRTUAL_SHARED_ROOT");
            list.appendChild(sharedLink);
        }

        // 2. RENDERIZAR AS PASTAS E NOTAS LOCAIS (O que tinha desaparecido)
        if (unifiedDocs.size === 0 && parentId !== startRootId && parentId !== null) {
            list.innerHTML += '<li style="padding:20px; color:#888; text-align:center;">Vazio.</li>';
        }

        Array.from(unifiedDocs.values())
        .sort((a, b) => (a.tipo === b.tipo) ? (a.nome || "").localeCompare(b.nome || "") : (a.tipo === 'pasta' ? -1 : 1))
        .forEach(item => {
            const li = document.createElement('li');
            li.className = "list-item";
            li.style.cssText = "display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border-color); cursor:pointer;";
            
            if (item.tipo === 'pasta') {
                li.innerHTML = `<span>üìÅ ${item.nome}</span> <span>‚ûî</span>`;
                li.onclick = () => {
                    appendStack.push({ id: item.id, name: item.nome });
                    loadAppendList(item.id);
                };
            } else {
                const isOwner = item.userId === myUid;
                const icon = (item.tipo === 'partilhado' || item.tipo === 'arquivo') ? 'üóÑÔ∏è' : 'üìÑ';
                const collabIcon = (parentId === "VIRTUAL_SHARED_ROOT") ? (isOwner ? 'üëë' : 'ü§ù') : '';
                
                li.innerHTML = `
                    <span>${icon} ${collabIcon} ${item.nome}</span> 
                    <span title="Enviar para o Topo">üì•</span>
                `;
                li.onclick = () => confirmAppendToNote(item.id, item.nome, item.tipo);
            }
            list.appendChild(li);
        });

    } catch (e) {
        console.error("Erro no modal:", e);
        list.innerHTML = '<li>Erro de liga√ß√£o.</li>';
    }
}

// 4. BOT√ÉO VOLTAR (L√≥gica de "Escape" da Superpasta)
// Remova o listener antigo e coloque este:
const appendBackBtn = document.getElementById('append-back-btn');
// Clonamos para remover listeners antigos e evitar duplica√ß√£o
const newAppendBackBtn = appendBackBtn.cloneNode(true);
appendBackBtn.parentNode.replaceChild(newAppendBackBtn, appendBackBtn);

newAppendBackBtn.addEventListener('click', () => {
    // Verifica se estamos numa Superpasta
    const superRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (appendStack.length > 0) {
        // Comportamento normal: remove o √∫ltimo passo
        appendStack.pop();
        
        // Se a pilha ainda tiver itens, carrega o anterior.
        // Se ficou vazia, carrega o ponto de partida (que √© o superRootId)
        const parent = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : superRootId;
        
        loadAppendList(parent);
    } else {
        // A pilha est√° vazia, mas clic√°mos em "Voltar".
        // Isso significa que estamos na raiz da Superpasta e queremos ir para a GLOBAL.
        loadAppendList(null);
    }
});

// 5. CONFIRMAR E GRAVAR
async function confirmAppendToNote(targetId, targetName, targetType) {
    const confirmModal = document.getElementById('confirm-modal');
    const appendModal = document.getElementById('append-to-note-modal');

    // 1. REBAIXAR O MODAL "ENVIAR PARA..."
    // Diminu√≠mos o n√≠vel dele para que ele fique "ao fundo"
    if (appendModal) {
        appendModal.style.setProperty('z-index', '1000000', 'important');
    }

    // 2. ELEVAR O MODAL DE CONFIRMA√á√ÉO AO TOPO ABSOLUTO
    // Usamos o maior valor de Z-Index poss√≠vel (2147483647)
    document.body.appendChild(confirmModal); // Move para o fim do body
    confirmModal.style.setProperty('display', 'flex', 'important');
    confirmModal.style.setProperty('z-index', '2147483647', 'important'); 
    confirmModal.style.visibility = "visible";
    confirmModal.style.opacity = "1";

    // 3. EXECUTAR A CONFIRMA√á√ÉO
    const confirmed = await showConfirmation(
        "Confirmar Envio", 
        `Deseja enviar esta caixa para o Topo de "${targetName}"?`
    );

    // 4. L√ìGICA DE RETORNO OU SUCESSO
    if (!confirmed) {
        // Se o utilizador cancelar, restauramos o modal "Enviar para..." ao topo
        if (appendModal) appendModal.style.setProperty('z-index', '5000000', 'important');
        confirmModal.style.zIndex = ""; 
        return;
    }

    // Se confirmou, processa a grava√ß√£o
    try {
        const noteRef = doc(db, 'pastas', targetId);
        const docSnap = await getDoc(noteRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Grava√ß√£o para Arquivo ou Nota (mant√©m a sua l√≥gica original)
            if (targetType === 'partilhado' || targetType === 'arquivo') {
                const authorName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
                const newPost = {
                    id: 'post_' + Date.now(),
                    type: 'entity',
                    title: 'Recebido de Estudo',
                    content: htmlToAppend,
                    createdBy: authorName,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                const updatedPosts = [newPost, ...(data.posts || [])];
                await updateDoc(noteRef, { posts: updatedPosts, ultimaedicao: serverTimestamp() });
            } else {
                const currentContent = data.conteudo || "";
                await updateDoc(noteRef, {
                    conteudo: htmlToAppend + "<p><br></p>" + currentContent,
                    ultimaedicao: serverTimestamp()
                });
            }

            // FECHO TOTAL AP√ìS SUCESSO
            confirmModal.style.display = 'none';
            if (appendModal) appendModal.style.display = 'none';
            
            alert(`Enviado para "${targetName}" com sucesso!`);
        }
    } catch (e) {
        console.error("Erro ao enviar:", e);
        alert("Erro ao realizar o envio.");
    } finally {
        confirmModal.style.zIndex = "";
    }
}


// --- FUN√á√ÉO UNIFICADA DE PARTILHA E CO-EDI√á√ÉO ---
async function updateSharingSettings() {
    if (!selectedNoteId || !auth.currentUser) return;

    try {
        const isShared = document.getElementById('note-share-toggle').checked;
        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        let shareId = currentNoteShareData?.shareId || selectedNoteId;

        // 1. Atualizar Nota Privada
        const newSettings = {
            ...currentNoteShareData, // Mant√©m defini√ß√µes existentes (como collab)
            shared: isShared,
            shareId: shareId,
            updatedAt: serverTimestamp()
        };

        await updateDoc(noteRef, { shareSettings: newSettings });
        currentNoteShareData = newSettings;

        // 2. Gerir Documento P√∫blico
        if (isShared) {
            
            // Obter dados atuais para garantir que n√£o enviamos lixo
            const currentTitle = document.getElementById('archive-title-input').value || 
                               document.getElementById('note-title-input').value || 
                               "Sem T√≠tulo";

            // Nome do Autor Robusto
            let finalAuthorName = "An√≥nimo";
            if (currentUserData && currentUserData.nome) finalAuthorName = currentUserData.nome;
            else if (auth.currentUser.email) finalAuthorName = auth.currentUser.email.split('@')[0];

            // Detetar se √© Arquivo ou Nota
            // (Verifica se estamos no modo arquivo ou nota normal)
            const isArchive = document.getElementById('archive-area').style.display !== 'none';
            const docType = isArchive ? 'arquivo' : 'full_note';
            
            // Dados a enviar
            const publicData = {
                nome: currentTitle,
                authorName: finalAuthorName,
                authorId: auth.currentUser.uid,
                isPublic: true,
                sharedAt: serverTimestamp(),
                type: docType,
                originalNoteId: selectedNoteId
            };

            // Se for arquivo, anexa os posts. Se for nota, anexa o conteudo.
            if (isArchive) {
                publicData.posts = currentArchiveData.posts || [];
            } else {
                publicData.conteudo = document.getElementById('note-content-editor').innerHTML;
            }
            
            await setDoc(doc(db, 'shared_notes', shareId), publicData, { merge: true });
            
            // Gerar link visualmente
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            document.getElementById('note-share-url').value = `${baseUrl}/sharenote.html?id=${shareId}`;

        } else {
            // Se desligar a partilha, apaga o documento p√∫blico
            await deleteDoc(doc(db, 'shared_notes', shareId));
        }

    } catch (e) {
        console.error("Erro partilha:", e);
    }
}

// Fun√ß√£o auxiliar para copiar
window.copyLink = function(elementId) {
    const input = document.getElementById(elementId);
    input.select();
    document.execCommand('copy');
    // Feedback visual breve
    const originalBg = input.style.backgroundColor;
    input.style.backgroundColor = "rgba(46, 204, 113, 0.2)";
    setTimeout(() => input.style.backgroundColor = originalBg, 500);
}



    // --- Listener para o Bot√£o de Colapsar/Expandir o Painel do Meio ---
const middlePanelToggleBtn = document.getElementById('middle-panel-toggle-btn');

if (middlePanelToggleBtn) { 
    middlePanelToggleBtn.addEventListener('click', () => {
        // Liga/Desliga a classe CSS
        const isCollapsed = notebookContainer.classList.toggle('middle-panel-collapsed');
        
        // Muda o √≠cone
        if (isCollapsed) {
            middlePanelToggleBtn.textContent = '¬ª'; 
            middlePanelToggleBtn.title = "Restaurar Painel";
        } else {
            middlePanelToggleBtn.textContent = '‚Üñ'; 
            middlePanelToggleBtn.title = "Expandir Lista";
        }
    });
}


window.restoreHiddenMiniNote = async function(miniNoteId) {
    if (!selectedNoteId) return;

    const confirmRestore = confirm("Restaurar para a posi√ß√£o original?");
    if (!confirmRestore) return;

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (!noteSnap.exists() || !noteSnap.data().subnotasocultas || !noteSnap.data().subnotasocultas[miniNoteId]) {
            alert("Erro: Dados n√£o encontrados.");
            return;
        }

        const noteData = noteSnap.data().subnotasocultas[miniNoteId];
        let restoredHTML = '';

        // --- CONSTRU√á√ÉO DO HTML ---

        if (noteData.tipo === 'toggle') {
            // RECONSTRU√á√ÉO DO TOGGLE
            restoredHTML = `
                <details class="toggle-section" open id="${noteData.id}">
                    <summary>
                        <h2>${noteData.titulo}</h2>
                        <button class="toggle-delete-btn" contenteditable="false" title="Ocultar Sec√ß√£o">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content">
                        ${noteData.conteudo}
                    </div>
                </details>
                <p><br></p>`;
        } 
        else {
            // RECONSTRU√á√ÉO DE SUBNOTAS (C√≥digo antigo)
            let wrapperClass = 'mini-note-wrapper';
            let titleHTML = '';

            if (noteData.tipo === 'question') {
                wrapperClass += ' question-mode';
                titleHTML = `<input type="text" class="mini-note-title-input" placeholder="T√≠tulo..." value="${noteData.titulo}">`;
            } else if (noteData.tipo === 'free') {
                wrapperClass += ' free-mode';
                titleHTML = '';
            } else {
                titleHTML = `<input type="text" class="mini-note-title-input" placeholder="T√≠tulo..." value="${noteData.titulo}">`;
            }

            restoredHTML = `
                <div contenteditable="false" style="height: 20px;"></div>
                <div class="${wrapperClass}" contenteditable="false" id="${noteData.id}" data-topics='${noteData.topicsJSON || '{}'}'>
                    ${titleHTML}
                    <div class="mini-note-toolbar">
                         <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
                         <button type="button" data-action="move-up">üî∫</button>
                         <button type="button" data-action="move-down">üîª</button>
                         <button type="button" data-action="append-mini-note">üß¨</button>
                         <button type="button" data-action="highlight-color">üé®</button>
                         <button type="button" data-action="manage-mini-note-topics">üìã</button>
                         <button type="button" data-action="delete-mini-note">üóëÔ∏è</button>
                    </div>
                    <div class="mini-note-content" contenteditable="true">
                        ${noteData.conteudo}
                    </div>
                </div>
                <div contenteditable="false" style="height: 20px;"></div>
                <p><br></p>`;
        }

        // --- INSER√á√ÉO NO DOM ---
        const marker = document.getElementById(`marker_${miniNoteId}`);
        let restoredElement = null;

        if (marker) {
            marker.outerHTML = restoredHTML;
            restoredElement = document.getElementById(noteData.id);
        } else {
            alert("A posi√ß√£o original foi perdida. A adicionar ao final.");
            noteContentEditor.insertAdjacentHTML('beforeend', restoredHTML);
            restoredElement = document.getElementById(noteData.id);
        }
        
        // Se for subnota, atualiza bot√µes
        if (restoredElement && noteData.tipo !== 'toggle') {
            updateMiniNoteButtonState(restoredElement);
            if(typeof updateHighlightButtonState === 'function') updateHighlightButtonState(restoredElement);
            if(typeof updateSharingButtonState === 'function') updateSharingButtonState(restoredElement);
        }

        // --- LIMPEZA ---
        await updateDoc(noteRef, {
            [`subnotasocultas.${miniNoteId}`]: deleteField(),
            conteudo: noteContentEditor.innerHTML,
            ultimaedicao: serverTimestamp()
        });

        document.getElementById('history-modal').style.display = 'none';
        saveNote();

    } catch (error) {
        console.error("Erro ao restaurar:", error);
        alert("Erro ao restaurar item.");
    }
};


// --- EVENTO PARA FECHAR O MENU AO CLICAR NOS PAIN√âIS LATERAIS ---
// Isto garante que o menu üìòüìóüìôüìí desapare√ßa ao navegar pelas pastas ou notas
document.getElementById('left-panel').addEventListener('click', () => {
    const insPopup = document.getElementById('insertion-popup');
    if (insPopup) insPopup.style.display = 'none';
});

document.getElementById('middle-panel').addEventListener('click', () => {
    const insPopup = document.getElementById('insertion-popup');
    if (insPopup) insPopup.style.display = 'none';
});

// Outros Listeners
document.addEventListener('click', (e) => {
    // 1. Fechar Context Menu
    if (!e.target.closest('.context-menu')) hideContextMenu();
    
    // 2. Fechar Tag Popup
    const tagPop = document.getElementById('tag-suggestion-popup');
    if (tagPop && !noteContentEditor.contains(e.target) && !tagPop.contains(e.target)) hideTagPopup();

    // 3. Fechar Formatting Popup (Aqui estava o erro)
    const fPopup = document.getElementById('formatting-popup');
    const fBtn = document.getElementById('more-formatting-btn');
    if (fPopup && fPopup.style.display === 'block') {
        if (!fPopup.contains(e.target) && e.target !== fBtn) {
            fPopup.style.display = 'none';
            if (fBtn) fBtn.classList.remove('active');
        }
    }
});

leftPanelToggleBtn.addEventListener('click', () => {
    notebookContainer.classList.toggle('left-panel-collapsed');
});


// Listener do bot√£o "+" (Adicionar Item)
addItemBtn.addEventListener('click', async () => {
    
    // 1. GRAVA√á√ÉO DE SEGURAN√áA: Se houver altera√ß√µes na nota atual, grava antes de abrir o modal
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        console.log("üíæ Gravando altera√ß√µes antes de abrir criador...");
        await saveNote(true); 
    }

    // ============================================================
    // CASO A: ABA DE LISTAS (Categorias do Banco de Dados)
    // ============================================================
    if (currentTab === 'lists') {
        const rootCategoryId = navigationStack[0]?.id;

         // --- ADICIONA ESTE BLOCO AQUI ---
         if (rootCategoryId === 'marcadores') {
            openCreateBookmarkPopup(); // Fun√ß√£o que vamos criar abaixo
            return;
        }
        // -------------------------------

        // 1. T√≥picos (Abre o modal de gest√£o/cria√ß√£o)
        if (rootCategoryId === 'topico') {
            const manageModal = document.getElementById('manage-topics-modal');
            document.body.appendChild(manageModal); // For√ßa hierarquia
            manageModal.style.setProperty('display', 'flex', 'important');
            manageModal.style.zIndex = "8000000";
            activeTopicIdForManagement = null;
            renderManageTopicsList();
            document.getElementById('create-new-subtopic-btn').style.display = 'none';
        } 
        // 2. Entidades Simples (Personagens, Locais, Datas)
        else if (['personagem', 'local', 'data'].includes(rootCategoryId)) {
            openEntityModal(rootCategoryId, ""); 
        }
        // 3. Cosmos (Temas e Subtemas)
        else if (rootCategoryId === 'cosmos') {
            const lastNav = navigationStack[navigationStack.length - 1];
            if (lastNav.type === 'list-category') {
                // Se est√° na raiz do Cosmos, cria um Tema
                window.openCosmosCreator('cosmos');
            } else if (lastNav.type === 'cosmos-parent') {
                // Se est√° dentro de um tema, cria um Subtema
                window.openCosmosCreator('subcosmos', lastNav.id);
            }
        }
        return; // Sai da fun√ß√£o ap√≥s tratar a aba de listas
    }

    // ============================================================
    // CASO B: ABA NOTE (Pastas, Notas e Arquivos)
    // ============================================================
    const modal = document.getElementById('add-item-modal');
    if (!modal) return;

    // --- GARANTIA DE VISIBILIDADE ---
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";

    const modalTitle = modal.querySelector('h3');
    const addFolderBtn = modal.querySelector('button[data-type="pasta"]');
    const addNoteBtn = modal.querySelector('button[data-type="nota"]');
    const addAgregBtn = modal.querySelector('button[data-type="agregacao"]');
    const addArchiveBtn = modal.querySelector('button[data-type="arquivo"]');

    // Reset da interface interna do Modal
    newItemNameInput.value = '';
    newItemNameInput.style.display = 'none';
    document.getElementById('confirm-item-addition').style.display = 'none';
    document.getElementById('add-item-options').style.display = 'flex';

    // L√≥gica de Visibilidade de Bot√µes conforme o Contexto
    if (currentViewMode === 'shared') {
        // MODO PARTILHA: Apenas permite adicionar Arquivos Partilhados
        modalTitle.textContent = "Adicionar Item Partilhado";
        addFolderBtn.style.display = 'none';
        addNoteBtn.style.display = 'none';
        addAgregBtn.style.display = 'none';
        addArchiveBtn.style.display = 'block';
    } 
    else {
        // MODO LOCAL
        modalTitle.textContent = "Adicionar Item";
        
        let isInSharedFolder = false;
        if (navigationStack.length > 0) {
            const currentFolder = navigationStack[navigationStack.length - 1];
            if (currentFolder.name === 'Partilhadas') isInSharedFolder = true;
        }

        if (isInSharedFolder) {
            // Na pasta de sistema "Partilhadas", apenas Notas e Arquivos s√£o permitidos
            addFolderBtn.style.display = 'none';
            addAgregBtn.style.display = 'none';
            addNoteBtn.style.display = 'block';
            addArchiveBtn.style.display = 'block';
        } 
        else if (navigationStack.length === 0) {
            // Raiz Local (N√≠vel 1): Apenas Pastas, Agrega√ß√µes ou Arquivos (Notas s√≥ dentro de pastas)
            addFolderBtn.style.display = 'block';
            addAgregBtn.style.display = 'block'; 
            addNoteBtn.style.display = 'none';
            addArchiveBtn.style.display = 'block';
        } 
        else {
            // Dentro de pastas normais: Permite tudo
            addFolderBtn.style.display = 'block';
            addAgregBtn.style.display = 'block'; 
            addNoteBtn.style.display = 'block';
            addArchiveBtn.style.display = 'block';
        }
    }
});


// ====================================================================
// FOR√áAR COLAGEM COMO TEXTO SIMPLES (PLAIN TEXT)
// ====================================================================
 document.addEventListener('paste', (e) => {
    // 1. Verifica se estamos num campo edit√°vel
    const target = e.target;
    const isEditable = target.isContentEditable || 
                       (target.tagName === 'INPUT' && target.type === 'text') ||
                       target.tagName === 'TEXTAREA';

    if (!isEditable) return;

    // 2. Impede o comportamento padr√£o
    e.preventDefault();

    // 3. Obt√©m apenas o texto limpo
    let text = (e.clipboardData || window.clipboardData).getData('text/plain');

    // >>> CORRE√á√ÉO AQUI: Remove espa√ßos vazios antes e depois <<<
    text = text.trim(); 

    // 4. Se estiver dentro de Toggle ou Mini-Nota, usa <br>
    if (target.closest('.toggle-content') || target.closest('.mini-note-content')) {
        // Substitui quebras de linha por <br>
        const htmlContent = text.replace(/\r\n|\r|\n/g, '<br>');
        document.execCommand('insertHTML', false, htmlContent);
    } else {
        // Nos outros s√≠tios, texto normal
        document.execCommand('insertText', false, text);
    }
    
    // 5. Grava
    if (typeof saveNote === 'function') {
        if (target.id === 'note-content-editor' || target.closest('#note-content-editor')) {
            saveNote(); 
        }
    }
});


let itemTypeToAdd = '';
document.getElementById('add-item-options').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    itemTypeToAdd = btn.dataset.type;
    document.getElementById('add-item-options').style.display = 'none';
    newItemNameInput.style.display = 'block';
    newItemNameInput.placeholder = `Nome d${itemTypeToAdd === 'pasta' ? 'a' : 'a'} ${itemTypeToAdd}...`;
    newItemNameInput.focus();
    document.getElementById('confirm-item-addition').style.display = 'block';
});

document.getElementById('confirm-item-addition').addEventListener('click', async () => {
    const confirmBtn = document.getElementById('confirm-item-addition');
    if (confirmBtn.disabled) return;

    const itemName = newItemNameInput.value.trim();
    if (!itemName || !itemTypeToAdd) return;

    // --- L√ìGICA DE AGREGA√á√ÉO (Mant√©m-se √† parte) ---
    if (itemTypeToAdd === 'agregacao') {
        aggregationTargetName = itemName;
        aggregationParentId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
        if (!aggregationParentId && typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) aggregationParentId = SUPERFOLDER_ID;
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';
        openAggregationSelector();
        return; 
    }

    try {
        confirmBtn.disabled = true;
        confirmBtn.textContent = "A criar...";

        let parentId = null;
        if (navigationStack.length > 0) {
            parentId = navigationStack[navigationStack.length - 1].id;
        } 
        else if (currentViewMode === 'shared') {
            parentId = null; 
        }
        else if (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) {
            parentId = SUPERFOLDER_ID;
        }

        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', parentId), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const newOrder = snapshot.size;

        const docData = {
            nome: itemName,
            parentId: parentId,
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ordem: newOrder,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        };

        // ============================================================
        // L√ìGICA DE TIPO PERSONALIZADA PARA ARQUIVOS
        // ============================================================
        if (itemTypeToAdd === 'arquivo') {
            // Se estiver no modo partilha (Bot√£o Vermelho / Popup "Item Partilhado")
            if (currentViewMode === 'shared') {
                docData.tipo = 'partilhado'; // CAMPO SOLICITADO
                docData.partilhado = "inativo";
            } 
            // Se estiver no modo local (Bot√£o Azul / Popup "Adicionar Item")
            else {
                docData.tipo = 'arquivo'; // TIPO PADR√ÉO
                docData.partilhado = "pessoal";
            }
            
            docData.posts = [];
            docData.deletedPosts = [];
            docData.colaboradores = { [auth.currentUser.uid]: true };
        }
        else {
            // Outros tipos (nota, pasta, etc)
            docData.tipo = itemTypeToAdd;
            if (itemTypeToAdd === 'nota') {
                docData.conteudo = '';
                docData.tags = [];
            }
        }

      const docRef = await addDoc(collection(db, 'pastas'), docData);

document.getElementById('add-item-modal').style.display = 'none';
newItemNameInput.value = '';

// L√≥gica de abertura inteligente ap√≥s criar:
if (docData.tipo === 'nota') {
    // Se for nota, abre o editor normal
    displayNote(docRef.id, null);
} 
else if (docData.tipo === 'arquivo' || docData.tipo === 'partilhado') {
    // Se for arquivo ou partilhado, abre o Feed (o que estava a acontecer com as pastas)
    displayArchive(docRef.id, { ...docData, id: docRef.id });
} 
else if (docData.tipo === 'pasta') {
    // SE FOR PASTA: Apenas entra nela e atualiza a lista no meio
    navigationStack.push({ id: docRef.id, name: itemName });
    updateNavigationView();
    resetEditor(); // Limpa o painel da direita para n√£o mostrar lixo
}

    } catch (error) {
        console.error("Erro ao criar item:", error);
        alert("Erro ao criar o item.");
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Criar";
    }
});

document.getElementById('context-menu').addEventListener('click', async (e) => {
    const action = e.target.dataset.action;
    
    // 1. Verifica√ß√£o de Seguran√ßa
    if (!action || !activeItemContext) {
        console.warn("‚ö†Ô∏è Clique no menu de contexto ignorado: a√ß√£o ou item n√£o definidos.");
        return;
    }

    // Criamos uma c√≥pia local do contexto para evitar erros durante processos ass√≠ncronos
    const itemContext = { ...activeItemContext };
    console.group(`üéØ Context Menu: ${action.toUpperCase()}`);
    console.log("üì¶ Item:", itemContext.name, `(ID: ${itemContext.id})`);
    
    hideContextMenu(); 

    try {
        // --- A√á√ÉO: PROTEGER (üîí) ---
        if (action === 'protect') {
            console.log("üõ°Ô∏è Iniciando cria√ß√£o de prote√ß√£o...");
            const newPass = await requestPassword('create', itemContext.id);
            
            if (newPass) {
                console.log("üîë Senha definida. Gravando no Firebase...");
                await updateDoc(doc(db, 'pastas', itemContext.id), {
                    passe: newPass,
                    ultimaedicao: serverTimestamp()
                });
                console.log("‚úÖ Prote√ß√£o aplicada com sucesso.");
                // O √≠cone de cadeado aparecer√° via onSnapshot
            } else {
                console.log("‚ÑπÔ∏è Prote√ß√£o cancelada.");
            }
        }

        // --- A√á√ÉO: TIRAR PROTE√á√ÉO (üîì) ---
        else if (action === 'unprotect') {
            console.log("üîì Solicitando remo√ß√£o de prote√ß√£o...");
            // O modo 'remove' na fun√ß√£o requestPassword valida a senha e apaga o campo no Firebase
            const authorized = await requestPassword('remove', itemContext.id);
            
            if (authorized === true) {
                console.log("‚úÖ Prote√ß√£o removida com sucesso do banco de dados.");
                // Limpa o cache de desbloqueio da sess√£o
                sessionUnlockedFolders.delete(itemContext.id);
            } else {
                console.log("‚ÑπÔ∏è Remo√ß√£o de prote√ß√£o cancelada ou senha incorreta.");
            }
        }

        // --- A√á√ÉO: RENOMEAR (‚úèÔ∏è) ---
        else if (action === 'rename') {
            console.log("üìù Abrindo modal de renomea√ß√£o...");
            openRenameModal(itemContext.name, async (newName) => {
                console.log(`üíæ Gravando novo nome: "${newName}"`);
                const collectionName = itemContext.type === 'cosmos-parent' ? 'cosmos' : 'pastas';
                await updateDoc(doc(db, collectionName, itemContext.id), {
                    nome: newName,
                    ultimaedicao: serverTimestamp()
                });
                
                if (itemContext.type === 'cosmos-parent') renderListCategoryItems('cosmos');
                if (selectedNoteId && itemContext.id === selectedNoteId) {
                    const titleInput = document.getElementById('note-title-input');
                    if(titleInput) titleInput.value = newName;
                }
                console.log("‚úÖ Nome atualizado.");
            });
        }

        // --- A√á√ÉO: MUDAR EMOJI COSMOS ---
        else if (action === 'change-cosmos-emoji') {
            console.log("üé® Abrindo seletor de emoji para Cosmos...");
            if (typeof openCosmosEditPopup === 'function') {
                openCosmosEditPopup(itemContext.id, itemContext.name, itemContext.emoji, itemContext.type);
            }
        }

        // --- A√á√ÉO: MUDAR √çCONE SUPERPASTA ---
        else if (action === 'change-icon') {
            console.log("üñºÔ∏è Abrindo seletor de √≠cone para Superpasta...");
            const modal = document.getElementById('icon-picker-modal');
            modal.dataset.targetFolderId = itemContext.id; 
            modal.style.display = 'flex';
        }

        // --- A√á√ÉO: ALTERNAR PIN (üìå) ---
        else if (action === 'toggle-pin') {
            const newState = !itemContext.isPinned;
            console.log(`üìå Pin: ${newState}`);
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                isPinned: newState,
                ultimaedicao: serverTimestamp()
            });
        }

        // --- A√á√ÉO: MOVER POSI√á√ÉO ---
        else if (action === 'move-position') {
            console.log("‚ÜïÔ∏è Abrindo modal de reordena√ß√£o...");
            await openMoveModal(itemContext);
        }

        // --- A√á√ÉO: MOVER DE PASTA ---
        else if (action === 'move-folder') {
            console.log("üìÇ Abrindo modal de transfer√™ncia de pasta...");
            await openMoveToFolderModal(itemContext);
        }

        // --- A√á√ÉO: ANEXAR T√ìPICOS ---
        else if (action === 'manage-topics') {
            console.log("üè∑Ô∏è Abrindo gestor de t√≥picos...");
            openTopicsModal(itemContext.id, itemContext.type);
        }

        // --- A√á√ÉO: OCULTAR ---
        else if (action === 'hide') {
            const confirmed = await showConfirmation('Ocultar Item?', `Deseja mover "${itemContext.name}" para a lixeira?`);
            if (confirmed) {
                const collectionName = itemContext.type === 'cosmos-parent' ? 'cosmos' : 'pastas';
                await updateDoc(doc(db, collectionName, itemContext.id), { 
                    estado: 'desativa',
                    ultimaedicao: serverTimestamp()
                });
                console.log("‚úÖ Item ocultado.");
            }
        }

        // --- A√á√ÉO: TORNAR SUPERPASTA ---
        else if (action === 'toggle-superfolder') {
            const newState = !itemContext.isSuperfolder;
            console.log(`üóÉÔ∏è Superpasta: ${newState}`);
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                superpasta: newState,
                ultimaedicao: serverTimestamp()
            });
            window.location.reload(); 
        }

    } catch (error) {
        console.error(`‚ùå Erro na a√ß√£o "${action}":`, error);
        alert("Erro ao processar o pedido.");
    }

    console.groupEnd();
});


document.querySelectorAll('.modal-overlay [data-action="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal-overlay').style.display = 'none';
    });
});

document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-modal').style.display = 'flex';
});

document.getElementById('settings-modal').addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    if (action === 'show-hidden-items') {
        document.getElementById('settings-modal').style.display = 'none';
        showHiddenItemsModal();
    }
});

document.getElementById('hidden-items-list').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const listItem = btn.closest('li');

    // ============================================================
    // A√á√ÉO: RESTAURAR (Traz de volta, atualiza colunas e abre)
    // ============================================================
    if (action === 'restore') {
        
        // 1. TRUQUE Z-INDEX
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.style.zIndex = '9999';

        // 2. Confirma√ß√£o
        const confirmed = await showConfirmation(
            "Restaurar Item?",
            "O item voltar√° para a sua pasta original e ser√° aberto imediatamente."
        );

        confirmModal.style.zIndex = ''; // Limpeza

        if (!confirmed) return;

        try {
            // A. Atualizar na Base de Dados (Espera terminar!)
            await updateDoc(doc(db, 'pastas', id), { 
                estado: 'ativa',
                ultimaedicao: serverTimestamp()
            });
            
            // B. Fechar o Modal de Itens Ocultos visualmente
            document.getElementById('hidden-items-modal').style.display = 'none';

            // C. NAVEGA√á√ÉO INTELIGENTE (Atualiza Colunas e Abre Nota)
            // Esta fun√ß√£o vai:
            // 1. Descobrir a pasta pai da nota.
            // 2. Atualizar a coluna da esquerda (Pastas).
            // 3. Atualizar a coluna do meio (Lista de ficheiros).
            // 4. Abrir a nota no editor.
            if (typeof navigateToNoteSmart === 'function') {
                await navigateToNoteSmart(id);
            } else {
                // Fallback de seguran√ßa
                displayNote(id, null); 
            }

        } catch (err) {
            console.error(err);
            alert("Erro ao restaurar.");
        }
    }

    // ============================================================
    // A√á√ÉO: ELIMINAR (Mover para Blackbox) - MANT√âM-SE IGUAL
    // ============================================================
    else if (action === 'delete') {
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.style.zIndex = '9999';

        const confirmed = await showConfirmation(
            "Eliminar Permanentemente?", 
            "Esta a√ß√£o √© irrevers√≠vel. O item ser√° apagado do sistema."
        );

        confirmModal.style.zIndex = ''; 

        if (!confirmed) return;

        btn.textContent = "A apagar...";
        btn.disabled = true;

        try {
            const docRef = doc(db, 'pastas', id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();

                // COPIAR PARA BLACKBOX
                await addDoc(collection(db, 'blackbox'), {
                    originalId: id,
                    nome: data.nome,
                    conteudo: data.conteudo || "",
                    tipo: data.tipo,
                    userId: auth.currentUser.uid,
                    deletedAt: serverTimestamp(),
                    reason: "Manual Delete from Hidden Menu",
                    fullSnapshot: data
                });

                // APAGAR DA COLE√á√ÉO ORIGINAL
                await deleteDoc(docRef);

                // Remover da lista visualmente
                listItem.style.opacity = '0';
                setTimeout(() => listItem.remove(), 300);
                
                const list = document.getElementById('hidden-items-list');
                if (list.children.length <= 1) {
                    list.innerHTML = '<li style="padding:15px; color:#888; text-align:center;">A reciclagem est√° vazia.</li>';
                }
            }
        } catch (error) {
            console.error("Erro ao eliminar:", error);
            alert("Ocorreu um erro ao tentar eliminar.");
            btn.textContent = "Eliminar";
            btn.disabled = false;
        }
    }
});


// ====================================================================
// L√ìGICA DE PARTILHA DA CAIXA (CADEADO)
// ====================================================================
let activeWrapperForSharing = null;
const sharePopup = document.getElementById('share-settings-popup');
const shareToggle = document.getElementById('mini-note-share-toggle');

// 1. Abrir Popup ao clicar no cadeado
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="sharing-settings"]');
    if (!btn) return;

    console.log("üîê Bot√£o de partilha da caixa clicado!");
    e.preventDefault(); 
    e.stopPropagation(); // Impede o editor de fechar o popup imediatamente

    const wrapper = btn.closest('.mini-note-wrapper');
    if (!wrapper) return;

    activeWrapperForSharing = wrapper;

    const popup = document.getElementById('share-settings-popup');
    if (!popup) return;

    // 1. MOVE PARA O BODY (Para ignorar o overflow:hidden do editor)
    document.body.appendChild(popup);

    // 2. LER ESTADO ATUAL
    const isShared = wrapper.getAttribute('data-shared') === 'true';
    const shareToggle = document.getElementById('mini-note-share-toggle');
    if (shareToggle) shareToggle.checked = isShared;

    // 3. POSICIONAMENTO E Z-INDEX
    const rect = btn.getBoundingClientRect();
    
    popup.style.setProperty('display', 'flex', 'important');
    popup.style.position = 'fixed'; // Fixed √© melhor quando est√° no body
    popup.style.zIndex = "7000000"; // Mais alto que o editor
    
    // Posiciona logo abaixo do bot√£o
    popup.style.top = `${rect.bottom + 5}px`;
    popup.style.left = `${rect.left - 100}px`; // Ajuste para a esquerda para n√£o fugir do ecr√£
    
    popup.style.visibility = "visible";
    popup.style.opacity = "1";
});

// 2. Alterar o Toggle
shareToggle.addEventListener('change', () => {
    if (activeWrapperForSharing) {
        // Atualiza o atributo no HTML da nota
        activeWrapperForSharing.setAttribute('data-shared', shareToggle.checked);
        
        // Atualiza o visual do bot√£o imediatamente
        updateSharingButtonState(activeWrapperForSharing);
        
        // Grava a nota no Firebase
        saveNote();
    }
});

// 3. Fechar Popup ao clicar fora
document.addEventListener('click', (e) => {
    if (sharePopup.style.display !== 'none') {
        if (!sharePopup.contains(e.target) && !e.target.closest('button[data-action="sharing-settings"]')) {
            sharePopup.style.display = 'none';
            activeWrapperForSharing = null;
        }
    }
});

// --- EVENT LISTENER PARA O INDICADOR DE STATUS ---
if (saveStatusIndicator) {
    saveStatusIndicator.addEventListener('click', () => {
        // Se estiver "por guardar" ou deu "erro", o clique for√ßa a grava√ß√£o
        if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'error') {
            saveNote(true); // O par√¢metro 'true' ignora o temporizador e grava logo
        }
    });
}

 // --- EVENT LISTENER: BOT√ÉO DA TOOLBAR ---
editorToolbar.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    if (!action) return;

    // Impedir que o clique tire o foco do editor se necess√°rio
    if (['show-topics', 'show-history', 'note-sharing-settings', 'show-attachments', 'show-explorer', 'bible-scan', 'more-formatting'].includes(action)) {
        e.preventDefault();
        e.stopPropagation();
    }

    // 1. GERIR T√ìPICOS (üìë)
    if (action === 'show-topics') {
        if (selectedNoteId) {
            openTopicsModal(selectedNoteId, 'nota');
        } else {
            alert("Selecione uma nota primeiro.");
        }
    }
    
    // 2. HIST√ìRICO E BACKUPS (üïí)
    else if (action === 'show-history') {
        if (selectedNoteId) {
            openHistoryModal();
        }
    }
    
    // 3. DEFINI√á√ïES DE PARTILHA (üîê)
    else if (action === 'note-sharing-settings') {
        if (selectedNoteId) {
            openShareModalForArchive();
        }
    }
    
    // 4. ANEXOS (üìé)
    else if (action === 'show-attachments') {
        openAttachmentsModal();
    }
    
    // 5. EXPLORADOR / PESQUISA (üîç)
    else if (action === 'show-explorer') {
        openExplorerModal();
    }

    // 6. SCANNER UNIVERSAL (üé∞)
    else if (action === 'bible-scan') {
        if (typeof openUniversalScanner === 'function') {
            openUniversalScanner();
        }
    }

    // 7. EDITOR DE MARGEM (üî¨)
    else if (action === 'open-margin-editor') {
        if (!selectedNoteId) return alert("Selecione uma nota primeiro.");
        
        // Feedback visual
        const originalText = btn.textContent;
        btn.textContent = "üíæ";
        
        // Grava antes de sair para n√£o perder dados
        await saveNote(true);
        window.location.href = `editnote.html?noteId=${selectedNoteId}`;
    }

    // 8. MAIS FORMATA√á√ïES (‚ãÆ)
    else if (action === 'more-formatting' || btn.id === 'more-formatting-btn') {
        const popup = document.getElementById('formatting-popup');
        if (!popup) return;

        const isVisible = popup.style.display === 'block';

        if (isVisible) {
            popup.style.display = 'none';
            btn.classList.remove('active');
        } else {
            // FOR√áA O POPUP PARA O TOPO (BODY)
            document.body.appendChild(popup);
            
            const rect = btn.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed'; // Para flutuar sobre tudo
            popup.style.zIndex = "9999999"; 
            
            // Posicionamento inteligente (evita sair do ecr√£ √† direita)
            let leftPos = rect.left;
            if (leftPos + 250 > window.innerWidth) {
                leftPos = window.innerWidth - 260;
            }

            popup.style.top = `${rect.bottom + 8}px`;
            popup.style.left = `${leftPos}px`;
            
            btn.classList.add('active');
        }
    }
});

    
// Listener espec√≠fico para cliques dentro do Popup de Formata√ß√£o
document.getElementById('formatting-popup').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    if (action === 'open-robot') {
        e.preventDefault(); e.stopPropagation();
        openRobotModal();
    }
    
    else if (action === 'open-margin-editor') {
        e.preventDefault(); e.stopPropagation();
        if (!selectedNoteId) return alert("Selecione uma nota primeiro.");
        document.getElementById('formatting-popup').style.display = 'none';
        document.getElementById('more-formatting-btn').classList.remove('active');
        await saveNote(true);
        window.location.href = `editnote.html?noteId=${selectedNoteId}`;
    }

    // NOVA A√á√ÉO: Modo Criativo ü™Å
    else if (action === 'creative-mode') {
        e.preventDefault();
        e.stopPropagation();

        const container = document.querySelector('.notebook-container');
        
        // 1. Alterna a classe no contentor principal (esconde/mostra colunas)
        const isActive = container.classList.toggle('creative-mode-active');

        // 2. Marca o bot√£o como selecionado ou normal
        if (isActive) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }

        // Opcional: Fecha o popup para ver o resultado
        document.getElementById('formatting-popup').style.display = 'none';
        document.getElementById('more-formatting-btn').classList.remove('active');
    }
});


// =========================================================
// LISTENERS DE PARTILHA (VERS√ÉO SEGURA)
// =========================================================

// 1. LISTENER DO BOT√ÉO PRINCIPAL (LINK P√öBLICO)
const shareToggleBtn = document.getElementById('note-share-toggle');
if (shareToggleBtn) {
    shareToggleBtn.addEventListener('change', async () => {
        const isShared = shareToggleBtn.checked;
        const linkRead = document.getElementById('note-share-link-container');
        
        // Corrigido: Removidas vari√°veis inexistentes que causavam erro
        if (linkRead) {
            linkRead.style.display = isShared ? 'block' : 'none';
        }

        updateNoteSharingButtonUI(isShared);
        await updateSharingSettings();
    });
}



// Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (noteSharePopup.style.display !== 'none') {
        if (!noteSharePopup.contains(e.target) && !e.target.closest('button[data-action="note-sharing-settings"]')) {
            noteSharePopup.style.display = 'none';
        }
    }
});

// ====================================================================
// NOVA FUN√á√ÉO PARA O POPUP DE VISUALIZA√á√ÉO
// ====================================================================
 async function openViewLinkModal(anexoId) {
    const modal = document.getElementById('view-link-modal');
    const titleEl = document.getElementById('view-link-title');
    const listEl = document.getElementById('view-link-urls-list');
    const editBtn = document.getElementById('view-link-edit-btn');

    titleEl.textContent = 'A carregar...';
    listEl.innerHTML = '';
    modal.style.display = 'flex';

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists() || !noteSnap.data().anexos?.[anexoId]) {
            throw new Error('Anexo n√£o encontrado na base de dados.');
        }

        const anexo = noteSnap.data().anexos[anexoId];
        titleEl.textContent = anexo.titulo;
        const urls = anexo.urls ? Object.values(anexo.urls) : [];

        if (urls.length > 0) {
            // A L√ìGICA DE RENDERIZA√á√ÉO √â AGORA ID√äNTICA √Ä DO OUTRO MODAL
            urls.forEach((url, index) => {
                const li = document.createElement('li');
                
                // Criamos a estrutura com n√∫mero (branco) e link (azul)
                const linkHTML = `
                    <div style="display: flex; align-items: baseline; gap: 8px;">
                        <span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" 
                           style="color: var(--accent-color); text-decoration: none; word-break: break-all;">
                            ${url}
                        </a>
                    </div>
                `;
                li.innerHTML = linkHTML;
                listEl.appendChild(li);
            });
        } else {
            listEl.innerHTML = '<li>Nenhuma URL associada a este anexo.</li>';
        }
        
        const newEditBtn = editBtn.cloneNode(true);
        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
        newEditBtn.onclick = () => {
            modal.style.display = 'none'; 
            openLinkModal(true, { id: anexoId });
        };

    } catch (error) {
        console.error("Erro ao abrir o modal de visualiza√ß√£o:", error);
        alert(error.message);
        modal.style.display = 'none';
    }
}


// ====================================================================
// CORRE√á√ÉO PARA O UNDO/REDO EM SUBNOTAS E QUEST√ïES
// ====================================================================

// Quando escrevemos no t√≠tulo, for√ßamos o atributo HTML 'value' a atualizar.
// Isto permite que o document.execCommand('undo') saiba que o texto mudou.
noteContentEditor.addEventListener('input', (e) => {
    // Se o utilizador estiver a escrever no t√≠tulo da Entidade (Quest√£o/Subnota)
    if (e.target.classList.contains('mini-note-title-input')) {
        
        // SINCRONIZA√á√ÉO CR√çTICA:
        // Atualiza o conte√∫do interno (para o innerHTML apanhar o texto novo)
        if (e.target.tagName === 'TEXTAREA') {
            e.target.textContent = e.target.value;
        } else {
            // Mant√©m suporte para inputs antigos
            e.target.setAttribute('value', e.target.value);
        }

        // Se a op√ß√£o de t√≠tulo completo estiver ligada, ajusta a altura enquanto escreves
        if (appSettings.showFullTitles) {
            autoResizeTitle(e.target);
        }

        // Dispara a grava√ß√£o autom√°tica
        updateSaveStatus('unsaved');
        saveNote();
    }
});

// ====================================================================
// GESTOR DE CLIQUES (√ÇNCORAS, LINKS E TAGS)
// ====================================================================
document.getElementById('right-panel').addEventListener('click', (event) => {
    const target = event.target;
    
    // LOG 1: O clique chegou ao painel?

    // 1. Verificar se √© um bot√£o (para ignorar)
    if (target.closest('button')) {
        return;
    }

    // 2. Tentar encontrar as nossas refer√™ncias
    const anchor = target.closest('.entity-link');
    const link = target.closest('a[data-anexo-id]');
    const tag = target.closest('.tag');

    // LOG 2: O c√≥digo reconheceu algum destes?
    console.log("Resultados da busca:", { 
        isAnchor: !!anchor, 
        isLink: !!link, 
        isTag: !!tag 
    });

    if (anchor || link || tag) {
        // Bloquear comportamento de edi√ß√£o para o clique funcionar
        event.preventDefault();
        event.stopPropagation();
        

        if (anchor) {
            const name = anchor.dataset.entityName;
            const type = anchor.dataset.entityType;
            
            // LOG 3: Verificar se o cache de entidades est√° vazio
            const all = Object.values(allEntities).flat();
            
            const entity = all.find(e => e.nome === name);
            if (entity) {
                showReferencesPanel(entity.id, name, type);
            } else {
                console.error("ERRO: Entidade n√£o encontrada no cache local!");
                // Tentativa de emerg√™ncia se o cache falhar
                showReferencesPanel(null, name, type);
            }
        } 
        else if (link) {
            const id = link.dataset.anexoId;
            openViewLinkModal(id);
        } 
        else if (tag) {
            const tagName = tag.textContent.replace('#', '').trim();
            showTagReferencesPanel(tagName);
        }
        
        // LOG 4: Verificar se a classe de visibilidade foi adicionada
        setTimeout(() => {
            const visible = notebookContainer.classList.contains('references-panel-visible');
        }, 100);
    } else {
    }
}, true);

// ====================================================================
// FUN√á√ÉO: ARQUIVAR MINI-NOTA (Mover para Reciclagem no Firebase)
// ====================================================================
async function archiveMiniNote(element, silentMode = false) {
    if (!element) return false;

    const itemId = element.id;
    let title = "Sem T√≠tulo";
    let content = "";
    let type = "default";
    let topicsJSON = '{}';

    // --- DETE√á√ÉO DO TIPO DE ELEMENTO ---
    
    // CASO 1: √â um TOGGLE (Details)
    if (element.tagName === 'DETAILS') {
        type = 'toggle';
        const h2 = element.querySelector('h2');
        title = h2 ? h2.textContent : "Toggle Sem T√≠tulo";
        
        // Guarda apenas o interior do content
        const innerContentDiv = element.querySelector('.toggle-content');
        content = innerContentDiv ? innerContentDiv.innerHTML : "";
        
        // Toggles por enquanto n√£o t√™m t√≥picos, mas mantemos o formato
        topicsJSON = '{}';
    } 
    // CASO 2: √â uma SUBNOTA/QUEST√ÉO (Wrapper normal)
    else {
        const titleInput = element.querySelector('.mini-note-title-input');
        const contentDiv = element.querySelector('.mini-note-content');
        
        if (element.classList.contains('question-mode')) type = 'question';
        else if (element.classList.contains('free-mode')) type = 'free';
        
        if (titleInput) title = titleInput.value;
        else if (type === 'free') {
            const text = contentDiv ? contentDiv.textContent.trim() : "";
            title = text.length > 30 ? text.substring(0, 30) + "..." : (text || "Contentor Livre");
        }
        
        content = contentDiv ? contentDiv.innerHTML : "";
        topicsJSON = element.getAttribute('data-topics') || '{}';
    }

    // Confirma√ß√£o
    if (!silentMode) {
        const label = type === 'toggle' ? "Sec√ß√£o Expans√≠vel" : (type === 'question' ? "Quest√£o" : "SubNota");
        const confirmed = await showConfirmation(
            "Mover para a Lixeira?", 
            `Deseja ocultar "${title}" (${label})?`
        );
        if (!confirmed) return false;
    }

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        await updateDoc(noteRef, {
            [`subnotasocultas.${itemId}`]: {
                id: itemId,
                titulo: title,
                conteudo: content, // HTML interior
                tipo: type,
                topicsJSON: topicsJSON,
                deletedAt: serverTimestamp()
            },
            ultimaedicao: serverTimestamp()
        });
        return true;
    } catch (error) {
        console.error("Erro ao arquivar:", error);
        return false;
    }
}

// ====================================================================

// ==========================================================
// GEST√ÉO DE LINKS DO QUADRO (PUZZLE)
// ==========================================================

let currentBoardRange = null; // Guarda a sele√ß√£o dentro do cart√£o

function openBoardLinkManager(contentDiv) {
    const selection = window.getSelection();
    
    // 1. Validar Sele√ß√£o
    if (selection.rangeCount === 0 || selection.isCollapsed) {
        // Se n√£o houver sele√ß√£o, ver se o cursor est√° dentro de um link existente
        const anchorNode = selection.anchorNode;
        const targetEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const existingLink = targetEl.closest('a.board-link');
        
        if (existingLink) {
            // Editar link existente
            openBoardLinkModal(true, existingLink);
            return;
        } else {
            alert("Selecione o texto que quer transformar em link.");
            return;
        }
    }

    // Verifica se a sele√ß√£o est√° DENTRO da caixa atual
    if (!contentDiv.contains(selection.anchorNode)) return;

    // Guarda a sele√ß√£o para usar depois de fechar o modal
    currentBoardRange = selection.getRangeAt(0).cloneRange();
    
    // Abrir Modal em modo Cria√ß√£o
    openBoardLinkModal(false, selection.toString());
}

function openBoardLinkModal(isEdit, data) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const saveBtn = document.getElementById('link-save-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // Reset UI
    urlsContainer.innerHTML = '';
    modal.style.display = 'flex';
    modal.style.zIndex = '3000'; // Acima de tudo

    // Preparar Bot√µes (Clones para limpar listeners antigos)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    // CONFIGURAR BOT√ÉO ADICIONAR URL
    const addUrlBtn = document.getElementById('add-url-btn');
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = () => addUrlField();

    let existingLinkElement = null;

    if (isEdit) {
        modalTitle.textContent = "Editar Link do Quadro";
        existingLinkElement = data; // O elemento <a>
        titleInput.value = existingLinkElement.textContent;
        newRemoveBtn.style.display = 'block';

        // Ler URLs do atributo data-json
        try {
            const urls = JSON.parse(decodeURIComponent(existingLinkElement.dataset.json));
            urls.forEach(u => addUrlField(u));
        } catch(e) {
            addUrlField(existingLinkElement.href); // Fallback
        }
    } else {
        modalTitle.textContent = "Novo Link no Quadro";
        titleInput.value = data; // O texto selecionado
        newRemoveBtn.style.display = 'none';
        addUrlField();
    }

    // --- A√á√ÉO: GRAVAR ---
    newSaveBtn.onclick = () => {
        const urls = [];
        urlsContainer.querySelectorAll('input').forEach(inp => {
            if(inp.value.trim()) {
                let u = inp.value.trim();
                if(!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (urls.length === 0) return alert("Insira pelo menos um link.");

        // Cria o elemento <a>
        const a = isEdit ? existingLinkElement : document.createElement('a');
        a.href = "#"; // Dummy href
        a.className = "board-link";
        a.style.cursor = "pointer";
        a.textContent = titleInput.value;
        
        // Guarda as URLs no dataset (codificado para seguran√ßa)
        a.dataset.json = encodeURIComponent(JSON.stringify(urls));

        if (!isEdit && currentBoardRange) {
            // Inserir novo
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(currentBoardRange);
            currentBoardRange.deleteContents();
            currentBoardRange.insertNode(a);
        }
        
        modal.style.display = 'none';
    };

    // --- A√á√ÉO: REMOVER ---
    newRemoveBtn.onclick = () => {
        if (existingLinkElement) {
            const text = document.createTextNode(existingLinkElement.textContent);
            existingLinkElement.parentNode.replaceChild(text, existingLinkElement);
        }
        modal.style.display = 'none';
    };
}

// 5. VISUALIZAR LINKS (Ao clicar no texto azul)
function viewBoardLink(linkElement) {
    const modal = document.getElementById('view-link-modal');
    const list = document.getElementById('view-link-urls-list');
    const editBtn = document.getElementById('view-link-edit-btn');
    
    document.getElementById('view-link-title').textContent = linkElement.textContent;
    list.innerHTML = '';
    
    try {
        const urls = JSON.parse(decodeURIComponent(linkElement.dataset.json));
        
        urls.forEach((url, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div style="display: flex; gap: 10px;">
                    <span style="font-weight:bold;">${idx+1}.</span>
                    <a href="${url}" target="_blank" style="color:var(--accent-color); word-break:break-all;">${url}</a>
                </div>
            `;
            list.appendChild(li);
        });

        // Configurar bot√£o de editar do visualizador
        const newEditBtn = editBtn.cloneNode(true);
        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
        
        // S√≥ permite editar se estivermos em modo de edi√ß√£o
        const isEditMode = document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active');
        
        if (isEditMode) {
            newEditBtn.style.display = 'block';
            newEditBtn.onclick = () => {
                modal.style.display = 'none';
                openBoardLinkModal(true, linkElement);
            };
        } else {
            newEditBtn.style.display = 'none';
        }

        modal.style.display = 'flex';
        modal.style.zIndex = '3000';

    } catch(e) {
        console.error("Erro ao ler links:", e);
    }
}


// ====================================================================

tagSuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const li = e.target.closest('li');
    if (li) {
        const selected = tagSuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitTagSelection();
    }
});

entitySuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Impede que o editor perca o foco
    const li = e.target.closest('li');
    if (li) {
        const selected = entitySuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitEntitySelection();
    }
});

// ====================================================================
// L√ìGICA DA TESOURA (Converter Post-it em Texto)
// ====================================================================
noteContentEditor.addEventListener('click', async (e) => {

// -----------------------------------------------------------
// 1. L√ìGICA DO POST-IT (‚úÇÔ∏è) - TESOURA
// -----------------------------------------------------------
if (e.target.classList.contains('post-it-cut-btn')) {
    e.preventDefault(); e.stopPropagation();
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    const contentDiv = postIt.querySelector('.post-it-content');
    const savedHTML = contentDiv.innerHTML;
    const postItRect = postIt.getBoundingClientRect();
    
    const newPara = document.createElement('p');
    newPara.innerHTML = savedHTML || "<br>";
    
    const children = Array.from(noteContentEditor.children);
    let inserted = false;
    for (const child of children) {
        if (child === postIt || child.classList.contains('post-it-note')) continue;
        if (child.getBoundingClientRect().top > postItRect.top) {
            noteContentEditor.insertBefore(newPara, child);
            inserted = true;
            break;
        }
    }
    if (!inserted) noteContentEditor.appendChild(newPara);

    postIt.remove();
    
    // Focar
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(newPara);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
    
    saveNote();
    return; 
}

// -----------------------------------------------------------
// 2. L√ìGICA DO CART√ÉO WEB (‚úï) - REVERTER PARA LINK
// -----------------------------------------------------------
if (e.target.classList.contains('url-card-close')) {
    e.preventDefault(); e.stopPropagation();

    const card = e.target.closest('.url-card-widget');
    if (!card) return;

    const originalUrl = card.dataset.originalUrl;

    // Criar o link de texto original
    const a = document.createElement('a');
    a.href = originalUrl;
    a.textContent = originalUrl;
    a.target = "_blank";
    a.style.color = "var(--accent-color)";
    a.style.textDecoration = "underline";

    card.replaceWith(a);
    
    const space = document.createTextNode('\u00A0');
    a.after(space);

    saveNote();
    return;
}

// -----------------------------------------------------------
// 3. NAVEGA√á√ÉO DO CART√ÉO WEB (Abrir Link) - NOVO!
// -----------------------------------------------------------
const cardWidget = e.target.closest('.url-card-widget');
// Se clicou num card, MAS N√ÉO no bot√£o de fechar
if (cardWidget && !e.target.classList.contains('url-card-close')) {
    e.preventDefault(); 
    e.stopPropagation();

    const url = cardWidget.dataset.originalUrl;
    
    if (url) {
        // Abre numa nova aba
        window.open(url, '_blank');
    }
    return;
}

// -----------------------------------------------------------
// 4. L√ìGICA DE APAGAR SEC√á√ÉO/TOGGLE (üóëÔ∏è)
// -----------------------------------------------------------
const toggleDelBtn = e.target.closest('.toggle-delete-btn');
if (toggleDelBtn) {
    e.preventDefault(); e.stopPropagation();
    const detailsElement = toggleDelBtn.closest('details');
    if (!detailsElement) return;

    const success = await archiveMiniNote(detailsElement); 
    if (success) {
        const marker = document.createElement('span');
        marker.id = `marker_${detailsElement.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        detailsElement.replaceWith(marker);
        saveNote();
    }
    return;
}

// -----------------------------------------------------------
// 5. L√ìGICA DE APAGAR SUBNOTA/QUEST√ÉO (üóëÔ∏è)
// -----------------------------------------------------------
const deleteBtn = e.target.closest('button[data-action="delete-mini-note"]');
    if (deleteBtn) {
        // 1. Verifica√ß√µes de seguran√ßa
        if (noteContentEditor.contentEditable === "false") {
            alert("N√£o tem permiss√£o para editar esta nota partilhada.");
            return;
        }
        e.preventDefault(); 
        e.stopPropagation();

        // 2. Identificar a caixa
        const wrapper = deleteBtn.closest('.mini-note-wrapper');
        if (!wrapper) return; // Seguran√ßa extra

        const wrapperId = wrapper.id; // Guardamos o ID antes de mexer no DOM
        const isQuestion = wrapper.classList.contains('question-mode');
        const label = isQuestion ? "Quest√£o" : "SubNota";

        // 3. Confirma√ß√£o
        const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar esta ${label}?`);
        if (!confirmed) return;

        // --- TRUQUE VISUAL IMEDIATO ---
        // Escondemos logo a caixa para o utilizador sentir que apagou
        // Se der erro depois, voltamos a mostrar.
        wrapper.style.display = 'none';

        try {
            // 4. Arquivar na Base de Dados (Isto pode demorar 1-2 segundos)
            // Passamos o elemento wrapper que ainda existe no DOM (apenas invis√≠vel)
            const success = await archiveMiniNote(wrapper, true);
            
            if (success) {
                // 5. Se gravou com sucesso, removemos permanentemente do HTML
                const marker = document.createElement('span');
                marker.id = `marker_${wrapperId}`;
                marker.className = 'hidden-note-marker';
                marker.style.display = 'none';
                
                // Substitui√ß√£o segura: Tenta encontrar o elemento pelo ID novamente
                // (caso o DOM tenha mudado ligeiramente durante o await)
                const elementToRemove = document.getElementById(wrapperId) || wrapper;
                
                if (elementToRemove && elementToRemove.parentNode) {
                    elementToRemove.replaceWith(marker);
                }
                
                // 6. Gravar o HTML atualizado da nota (sem a caixa)
                // Usamos 'true' para for√ßar grava√ß√£o imediata e evitar conflitos de vers√£o
                await saveNote(true);
            } else {
                // Se falhou o arquivo, mostra a caixa de volta
                wrapper.style.display = 'block';
                alert("N√£o foi poss√≠vel arquivar. A caixa foi restaurada.");
            }
        } catch (err) {
            console.error("Erro ao apagar:", err);
            wrapper.style.display = 'block'; // Restaura em caso de erro
        }
        return;
    }
});

// ====================================================================
// PROTE√á√ÉO: DETETAR DELETE EM MASSA DE MINI-NOTAS
// ====================================================================
noteContentEditor.addEventListener('keydown', async (event) => {
    if (event.key !== 'Delete' && event.key !== 'Backspace') return;

    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    
    // Obt√©m o elemento HTML atual
    const anchorNode = selection.anchorNode;
    const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

    // =================================================================
    // 1. TRATAMENTO ESPEC√çFICO PARA TOGGLES (BACKSPACE)
    // =================================================================
    if (event.key === 'Backspace' && selection.isCollapsed) {
        
        const toggleEl = currentEl.closest('details.toggle-section');

        if (toggleEl) {
            // 1.1: PROTE√á√ÉO DO T√çTULO (Apagar o Toggle inteiro)
            const summary = toggleEl.querySelector('summary');
            if (summary && summary.contains(currentEl)) {
                // Se estiver no in√≠cio do t√≠tulo (offset 0), pergunta se quer apagar
                if (range.startOffset === 0) {
                    event.preventDefault();
                    event.stopPropagation();
                    const success = await archiveMiniNote(toggleEl, false);
                    if (success) {
                        const marker = document.createElement('span');
                        marker.id = `marker_${toggleEl.id}`;
                        marker.className = 'hidden-note-marker';
                        marker.style.display = 'none';
                        toggleEl.replaceWith(marker);
                        saveNote();
                    }
                    return;
                }
            }

            // 1.2: PROTE√á√ÉO DO √çCONE (Ir do Conte√∫do para o T√≠tulo)
            // Se estamos na √°rea de conte√∫do...
            const contentDiv = toggleEl.querySelector('.toggle-content');
            if (contentDiv && contentDiv.contains(currentEl)) {
                
                // ...e estamos no in√≠cio absoluto dessa √°rea (offset 0)
                // (Verifica se √© o primeiro par√°grafo dentro do conte√∫do)
                const firstElement = contentDiv.firstElementChild; // Geralmente o <p>
                const isAtStart = (range.startOffset === 0) && (currentEl === firstElement || firstElement.contains(currentEl));

                if (isAtStart) {
                    // IMPEDE A FUS√ÉO (que apagaria o bot√£o)
                    event.preventDefault();

                    // Mover o cursor manualmente para o fim do H2
                    const h2 = toggleEl.querySelector('h2');
                    if (h2) {
                        const newRange = document.createRange();
                        newRange.selectNodeContents(h2);
                        newRange.collapse(false); // false = ir para o fim do texto
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                    return;
                }
            }
        }
    }

    // 1.3: PROTE√á√ÉO EXTERNA (Backspace de baixo para cima contra o Toggle)
   if (event.key === 'Backspace' && selection.isCollapsed && range.startOffset === 0) {
        
        // 1. Encontra o bloco atual onde estamos a escrever (ex: <p>)
        const currentBlock = currentEl.closest('p, div, h1, h2, h3, h4, h5, h6, li');
        
        if (currentBlock) {
            let prevEl = currentBlock.previousElementSibling;

            // 2. Loop para saltar "lixo" invis√≠vel (BRs, divs vazias de espa√ßamento, etc.)
            // Continua a procurar para tr√°s enquanto o elemento for "vazio" ou irrelevante
            while (prevEl && (
                prevEl.tagName === 'BR' || 
                (prevEl.tagName === 'DIV' && prevEl.style.height === '20px') ||
                (prevEl.textContent.trim() === '' && !prevEl.matches('.mini-note-wrapper, details'))
            )) {
                prevEl = prevEl.previousElementSibling;
            }

            // 3. SE O ELEMENTO REAL ANTERIOR FOR UM TOGGLE
            if (prevEl && prevEl.tagName === 'DETAILS' && prevEl.classList.contains('toggle-section')) {
                event.preventDefault(); // P√ÅRA TUDO! N√£o deixa o navegador apagar nada.
                event.stopPropagation();

                // L√≥gica de Navega√ß√£o Manual (Foca sem destruir)
                if (prevEl.open) {
                    // Se aberto, tenta focar no √∫ltimo par√°grafo do conte√∫do
                    const contentDiv = prevEl.querySelector('.toggle-content');
                    if (contentDiv) {
                        // Tenta encontrar o √∫ltimo elemento edit√°vel l√° dentro
                        const lastEditable = contentDiv.lastElementChild; 
                        if (lastEditable) {
                            const newRange = document.createRange();
                            newRange.selectNodeContents(lastEditable);
                            newRange.collapse(false); // Cursor no fim
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                            return;
                        }
                    }
                }
                
                // Se fechado (ou falha acima), foca no fim do T√≠tulo H2
                const h2 = prevEl.querySelector('h2');
                if (h2) {
                    const newRange = document.createRange();
                    newRange.selectNodeContents(h2);
                    newRange.collapse(false); // Cursor no fim do t√≠tulo
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
                return;
            }
        }
    }
    // =================================================================

    // 2. SE N√ÉO HOUVER SELE√á√ÉO DE TEXTO, SAI AQUI
    if (selection.isCollapsed) return;

    // --- VERIFICA√á√ÉO DE SEGURAN√áA PARA EDI√á√ÉO INTERNA ---
    const focusNode = selection.focusNode;
    const endEl = focusNode.nodeType === 3 ? focusNode.parentElement : focusNode;

    const startWrapper = currentEl.closest('.mini-note-wrapper, details.toggle-section');
    const endWrapper = endEl.closest('.mini-note-wrapper, details.toggle-section');

    if (startWrapper && startWrapper === endWrapper) {
        return; 
    }

    // 3. PROCURAR SELE√á√ÉO EM MASSA
    const allWrappers = noteContentEditor.querySelectorAll('.mini-note-wrapper, details.toggle-section');
    const wrappersToDelete = [];

    allWrappers.forEach(wrapper => {
        if (selection.containsNode(wrapper, true)) {
            wrappersToDelete.push(wrapper);
        }
    });

    // 4. SE ENCONTRAR ITENS ESPECIAIS:
    if (wrappersToDelete.length > 0) {
        event.preventDefault();
        event.stopPropagation();

        const count = wrappersToDelete.length;
        
        const confirmDelete = await showConfirmation(
            "‚ö†Ô∏è Aten√ß√£o: Dados Importantes", 
            `A sua sele√ß√£o cont√©m ${count} item(s) complexos. \n\nSe continuar, o conte√∫do ser√° salvo no Hist√≥rico antes de apagar. Deseja continuar?`
        );

        if (!confirmDelete) return;

        const modalBtn = document.querySelector('#confirm-modal .modal-btn.primary');
        if(modalBtn) modalBtn.textContent = "A Arquivar...";

        const archivePromises = wrappersToDelete.map(wrapper => archiveMiniNote(wrapper, true)); 
        await Promise.all(archivePromises);

        range.deleteContents();
        saveNote();
    }
});


// --- L√ìGICA DA BARRA DE INSER√á√ÉO R√ÅPIDA (üìò üìí) ---

const insertionPopup = document.getElementById('insertion-popup');

 // 1. APARECER: Ao clicar no editor
noteContentEditor.addEventListener('click', (e) => {
    
    // A. Guardar a altura do clique IMEDIATAMENTE (Esta √© a fonte da verdade para a altura)
    const clickY = e.clientY;

    // PROTE√á√ÉO 1: Se clicou numa ideia, esconder e sair
    if (e.target.closest('.idea-span')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }

    // PROTE√á√ÉO 2: Se clicou DENTRO de um quadrado (Subnota, Quest√£o, etc), esconder e sair.
    // Usamos e.target diretamente, que √© mais fi√°vel que a sele√ß√£o neste momento.
    if (e.target.closest('.mini-note-wrapper')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }

     // >>>>> NOVA PROTE√á√ÉO 3: Se clicou DENTRO do Calend√°rio <<<<<
    if (e.target.closest('.jwn-calendar-widget')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
    // >>>>> FIM DA NOVA PROTE√á√ÉO <<<<<

    // >>>>> NOVA PROTE√á√ÉO 4: Se clicou DENTRO de uma Tabela <<<<<
    if (e.target.closest('table')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
    // >>>>> FIM DA NOVA PROTE√á√ÉO <<<<<

    // ==========================================================
    // >>> ADICIONE ESTE BLOCO NOVO AQUI <<<
    // PROTE√á√ÉO 6: Se clicou DENTRO da Linha Cronol√≥gica
    if (e.target.closest('.jwn-timeline-wrapper')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
     // >>> COLE O C√ìDIGO NOVO AQUI <<<
    // PROTE√á√ÉO 7: T√≠tulo Expans√≠vel (Toggle)
    // Impede o menu de aparecer na barra de t√≠tulo, mas permite no conte√∫do
    if (e.target.closest('summary')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
    // >>> FIM DO C√ìDIGO NOVO <<<
    // ==========================================================
    // Timeout breve apenas para verificar se o utilizador n√£o selecionou texto
    setTimeout(() => {
        const selection = window.getSelection();
        
        // S√≥ mostramos se N√ÉO houver texto selecionado (isCollapsed = true)
        if (selection && selection.rangeCount > 0 && selection.isCollapsed) {
            
            // Fecha outros popups
            if(document.getElementById('selection-popup')) document.getElementById('selection-popup').style.display = 'none';
            if(document.getElementById('idea-actions-popup')) document.getElementById('idea-actions-popup').style.display = 'none';

            const popup = document.getElementById('insertion-popup');
            
            // --- POSICIONAMENTO DEFINITIVO ---

            // 1. Horizontal (X): Sempre alinhado √† margem esquerda do Editor
            const editorRect = noteContentEditor.getBoundingClientRect();
            const leftPos = editorRect.left;

            // 2. Vertical (Y): A altura onde o rato clicou
            const topPos = clickY;

            popup.style.display = 'flex';
            
            // Aplica as posi√ß√µes (com ajuste de scroll e offset de 45px para cima)
            popup.style.top = `${topPos + window.scrollY - 85}px`; 
            popup.style.left = `${leftPos + window.scrollX + 10}px`; // +10px de margem visual

        } else {
            // Se houver texto selecionado, esconde este popup
            document.getElementById('insertion-popup').style.display = 'none';
        }
    }, 10); 
});

// 2. DESAPARECER: Ao come√ßar a escrever
noteContentEditor.addEventListener('keydown', () => {
    insertionPopup.style.display = 'none';
});

// 3. A√á√ïES DOS BOT√ïES
insertionPopup.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    if (action === 'quick-mini-note') {
        insertMiniNoteAtCursor('default'); // Subnota normal
        saveNote();
        insertionPopup.style.display = 'none';
    } 
    else if (action === 'insert-free-container') {
    insertMiniNoteAtCursor('free'); // Contentor Laranja
    saveNote();
    insertionPopup.style.display = 'none';
}
    // NOVO BLOCO PARA QUEST√ÉO
    else if (action === 'insert-question') {
        insertMiniNoteAtCursor('question'); // Quest√£o Verde
        saveNote();
        insertionPopup.style.display = 'none';
    }
    else if (action === 'quick-placeholder') {
        // A√á√ÉO DO BOT√ÉO üìí: ABRE O MENU DE TAMANHOS
        const sizePopup = document.getElementById('postit-size-popup');
        
        // Posiciona ao lado do menu atual
        const rect = insertionPopup.getBoundingClientRect();
        sizePopup.style.top = rect.top + 'px';
        sizePopup.style.left = (rect.right + 5) + 'px';
        sizePopup.style.display = 'flex';
        
        // N√£o escondemos o insertionPopup ainda para n√£o perder contexto visual
    }
});

// Garante que esconde se fizermos scroll
document.addEventListener('scroll', () => {
    insertionPopup.style.display = 'none';
}, true);

// --- L√ìGICA INTELIGENTE DE ARRASTO ---
noteContentEditor.addEventListener('mouseover', (e) => {
    // Verifica se estamos a passar o rato por cima de um post-it
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    // Verifica se estamos EXATAMENTE em cima do puxador amarelo
    const isHandle = e.target.closest('.post-it-drag-handle');
    
    if (isHandle) {
        // RATO NO PUXADOR: Ativa o modo de arrastar
        postIt.setAttribute('draggable', 'true');
    } else {
        // RATO NO TEXTO: Desativa o modo de arrastar (para permitir selecionar texto)
        postIt.setAttribute('draggable', 'false');
    }
});


// ====================================================================
// L√ìGICA DO MENU DE TAMANHOS DE POST-IT
// ====================================================================
document.getElementById('postit-size-popup').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const size = btn.dataset.size;
    
    // Define dimens√µes baseadas na escolha
    let width, height;
    
    if (size === 'small') {
        width = '150px'; height = '100px';
    } else if (size === 'medium') {
        width = '250px'; height = '180px';
    } else if (size === 'large') {
        width = '400px'; height = '300px';
    }

    // Cria o post-it vazio
    createPostItElement("", width, height);

    // Fecha tudo
    document.getElementById('postit-size-popup').style.display = 'none';
    document.getElementById('insertion-popup').style.display = 'none';
});

// Fechar menu de tamanhos se clicar fora
document.addEventListener('click', (e) => {
    const sizePopup = document.getElementById('postit-size-popup');
    if (sizePopup.style.display !== 'none' && !sizePopup.contains(e.target)) {
        sizePopup.style.display = 'none';
    }
});

// ====================================================================
// FECHAR MENUS FLUTUANTES AO CLICAR NA 4¬™ COLUNA
// ====================================================================
document.getElementById('references-panel').addEventListener('click', () => {
    // 1. Esconde a barra de inser√ß√£o (üìò üìó üìô üìí)
    const insertionPopup = document.getElementById('insertion-popup');
    if (insertionPopup) {
        insertionPopup.style.display = 'none';
    }

    // 2. (Recomendado) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üìç) se estiver aberto
    const selectionPopup = document.getElementById('selection-popup');
    if (selectionPopup) {
        selectionPopup.style.display = 'none';
    }
    
    // 3. (Recomendado) Esconde o menu de a√ß√µes da Ideia (‚úÇÔ∏è)
    const ideaPopup = document.getElementById('idea-actions-popup');
    if (ideaPopup) {
        ideaPopup.style.display = 'none';
    }
});

// ====================================================================
// L√ìGICA DE MOVIMENTO LIVRE (ABSOLUTO) PARA POST-ITS
// ====================================================================

let activePostIt = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

// 1. Clicar no Puxador (Iniciar)
noteContentEditor.addEventListener('mousedown', (e) => {
    const handle = e.target.closest('.post-it-drag-handle');
    if (!handle) return;

    e.preventDefault(); // Impede sele√ß√£o de texto

    activePostIt = handle.closest('.post-it-note');
    
    // Calcula onde clic√°mos DENTRO do post-it (o "ponto de agarre")
    const rect = activePostIt.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    activePostIt.style.opacity = '0.8';
    activePostIt.style.zIndex = '100';
});

// 2. Mover o Rato (Arrastar)
document.addEventListener('mousemove', (e) => {
    if (!activePostIt) return;

    e.preventDefault();

    const container = document.getElementById('note-content-editor');
    
    // Obter as coordenadas do contentor (Editor)
    const containerRect = container.getBoundingClientRect();

    // Calcular a posi√ß√£o X/Y desejada relativa ao contentor
    // (Posi√ß√£oRato - Posi√ß√£oContainer + ScrollContainer - PontoDeAgarre)
    let newLeft = (e.clientX - containerRect.left + container.scrollLeft) - dragOffsetX;
    let newTop = (e.clientY - containerRect.top + container.scrollTop) - dragOffsetY;

    // --- APLICAR LIMITES (CLAMPING) ---
    
    // Limite Horizontal (0 at√© LarguraContainer - LarguraPostIt)
    // Subtra√≠mos 2px extra de seguran√ßa para bordas
    const maxLeft = container.clientWidth - activePostIt.offsetWidth;
    if (newLeft < 0) newLeft = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;

    // Limite Vertical (0 at√© AlturaTotalContainer - AlturaPostIt)
    // Usamos scrollHeight para permitir arrastar at√© ao fundo do texto longo
    const maxTop = container.scrollHeight - activePostIt.offsetHeight;
    if (newTop < 0) newTop = 0;
    if (newTop > maxTop) newTop = maxTop;

    // Aplicar
    activePostIt.style.left = newLeft + 'px';
    activePostIt.style.top = newTop + 'px';
});

// 3. Largar o Rato (Finalizar)
document.addEventListener('mouseup', () => {
    if (activePostIt) {
        activePostIt.style.opacity = '1';
        activePostIt.style.zIndex = '20';
        activePostIt = null;
        saveNote(); 
    }
});

// ====================================================================
// ADICIONE ESTE BLOCO DE EVENT LISTENERS NO FINAL DO SCRIPT
// ====================================================================
document.getElementById('references-toolbar').addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;

    console.log("üõ†Ô∏è Clique na Toolbar da 4¬™ Coluna:", button.id);

    const { id, type, name } = activeReferenceEntity;
    if (!name) {
        console.warn("‚ö†Ô∏è Nenhuma entidade ativa no painel.");
        return;
    }

    switch (button.id) {
        case 'references-refresh-btn':
            showReferencesPanel(id, name, type);
            break;

        case 'references-bookmark-btn':
            console.log("üîñ Solicitando abertura de Marcadores para:", name);
            // LOG DE VERIFICA√á√ÉO DE TIPO
            console.log("üîç Tipo da entidade ativa:", type);
            if (type === 'textobiblico') {
                openBookmarksModal();
            } else {
                console.warn("üö´ Marcadores s√≥ funcionam em Textos B√≠blicos.");
                alert("Marcadores s√£o exclusivos para Textos B√≠blicos.");
            }
            break;

        case 'references-wol-btn':
            const encodedQuery = encodeURIComponent(name).replace(/%20/g, '+');
            const wolUrl = `https://wol.jw.org/pt-PT/wol/l/r296/lp-tpo?q=${encodedQuery}`;
            window.open(wolUrl, '_blank');
            break;

        case 'references-search-btn':
            window.open(`https://wol.jw.org/pt/wol/s/r5/lp-t?q=${encodeURIComponent(name)}`, '_blank');
            break;

        case 'references-edit-btn':
            if (id) openEditEntityModal(id, type);
            break;

        case 'references-toggle-btn':
            const allDetails = document.querySelectorAll('#references-list details');
            const openCount = document.querySelectorAll('#references-list details[open]').length;
            const shouldOpen = openCount <= allDetails.length / 2;
            allDetails.forEach(detail => detail.open = shouldOpen);
            break;
    }
});

document.getElementById('toggle-puzzle-edit-btn').addEventListener('click', async () => {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // MODO: ENTRAR EM EDI√á√ÉO (Atualmente est√° em modo visualiza√ß√£o)
    if (!container.classList.contains('edit-mode-active')) {
        container.classList.add('edit-mode-active');
        
        // 1. Ajuste Visual do Bot√£o (Usa a classe is-active para ficar azul)
        btn.textContent = "Salvar";
        btn.classList.add('is-active'); 
        
        // 2. Mostrar os bot√µes de adicionar (+ Txt, + Ref, üì°)
        if(addButtons) addButtons.style.display = 'flex';

        // 3. Ativar a edi√ß√£o nos blocos de texto do quadro
        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'true');
            div.style.border = "1px solid var(--border-color)";
            div.style.padding = "8px";
            div.style.borderRadius = "4px";
            div.style.backgroundColor = "var(--bg-color)";
        });
    } 
    // MODO: SALVAR E SAIR (Atualmente est√° em modo edi√ß√£o)
    else {
        // 1. Feedback de grava√ß√£o e execu√ß√£o do Save no Firebase
        btn.textContent = "A gravar...";
        btn.disabled = true;
        await savePuzzleData();
        btn.disabled = false;

        // 2. Reverter Visual do Bot√£o (Volta ao cinza normal)
        container.classList.remove('edit-mode-active');
        btn.textContent = "Editar";
        btn.classList.remove('is-active'); 
        
        // 3. Esconder os bot√µes de adicionar
        if(addButtons) addButtons.style.display = 'none';

        // 4. Bloquear a edi√ß√£o visualmente (Limpa bordas e fundos de input)
        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'false');
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
});



 document.getElementById('anchors-modal').addEventListener('click', (e) => {
    // 1. CLIQUE NAS ABAS
    const tabButton = e.target.closest('button[data-tab]');
    if (tabButton) {
        // Remove active de todos
        document.querySelectorAll('#anchors-tabs-container button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#anchors-content-container .tab-content').forEach(content => content.classList.remove('active'));
        
        // Ativa o selecionado
        tabButton.classList.add('active');
        const contentId = `tab-${tabButton.dataset.tab}`;
        const contentDiv = document.getElementById(contentId);
        if(contentDiv) contentDiv.classList.add('active');
        return;
    }

    // 2. CLIQUE NUM ITEM DA LISTA (Tag ou Entidade)
    const listItem = e.target.closest('li');
    if (listItem) {
        // A√ß√£o para TAGS
        if (listItem.dataset.action === 'show-tag-references') {
            const tagName = listItem.dataset.tagName;
            if (tagName) {
                document.getElementById('anchors-modal').style.display = 'none';
                showTagReferencesPanel(tagName);
            }
        }
        // A√ß√£o para ENTIDADES (Usa o dataset action ou verifica entityId como fallback)
        else if (listItem.dataset.entityId || listItem.dataset.action === 'show-entity-references') {
            const { entityId, entityName, entityType } = listItem.dataset;
            if (entityId) {
                document.getElementById('anchors-modal').style.display = 'none';
                showReferencesPanel(entityId, entityName, entityType);
            }
        }
    }
});

referencesPanelCloseBtn.addEventListener('click', hideReferencesPanel);


// 1. Abrir Modal de Conta
document.getElementById('account-btn').addEventListener('click', () => {
    const modal = document.getElementById('account-modal');
    const nameDisplay = document.getElementById('profile-name-display');
    const emailDisplay = document.getElementById('profile-email-display');

    // Preenche os dados
    if (currentUserData) {
        nameDisplay.textContent = currentUserData.nome || "Sem Nome";
        emailDisplay.textContent = currentUserData.email || auth.currentUser.email;
    } else if (auth.currentUser) {
        nameDisplay.textContent = "Usu√°rio";
        emailDisplay.textContent = auth.currentUser.email;
    }

    modal.style.display = 'flex';
});

// 2. Bot√£o de Logout (Dentro do Modal de Conta)
document.getElementById('logout-btn').addEventListener('click', async () => {
    const confirmLogout = confirm("Tem certeza que deseja sair?");
    if (confirmLogout) {
        try {
            await signOut(auth);
            // onAuthStateChanged vai redirecionar
        } catch (error) {
            console.error("Erro ao sair", error);
        }
    }
});

document.execCommand('defaultParagraphSeparator', false, 'p');


// 1. Listener para abrir o modal a partir do menu
document.getElementById('context-menu').addEventListener('click', (e) => {
    if (e.target.dataset.action === 'change-icon') {
        // Esconde o menu
        document.getElementById('context-menu').style.display = 'none';
        
        // Abre o modal de √≠cones
        document.getElementById('icon-picker-modal').style.display = 'flex';
    }
});

// 2. Listener para quando escolhe um Emoji
document.getElementById('emoji-grid').addEventListener('click', async (e) => {
    const btn = e.target.closest('.emoji-btn');
    
    // CORRE√á√ÉO: Ler o ID que guard√°mos no modal
    const modal = document.getElementById('icon-picker-modal');
    const targetId = modal.dataset.targetFolderId;

    // Se n√£o houver bot√£o ou ID, sai
    if (!btn || !targetId) return;

    const selectedIcon = btn.dataset.icon;
    const isDefault = selectedIcon === 'üóÉÔ∏è';

    try {
        // Usa targetId em vez de activeItemContext.id
        const docRef = doc(db, 'pastas', targetId);
        
        if (isDefault) {
            await updateDoc(docRef, {
                customIcon: deleteField(),
                ultimaedicao: serverTimestamp()
            });
        } else {
            await updateDoc(docRef, {
                customIcon: selectedIcon,
                ultimaedicao: serverTimestamp()
            });
        }

        modal.style.display = 'none';
        // Limpa o dataset por seguran√ßa
        modal.removeAttribute('data-target-folder-id');

    } catch (error) {
        console.error("Erro ao mudar √≠cone:", error);
        alert("Erro ao atualizar √≠cone.");
    }
});


// --- L√ìGICA DO EDITOR DE MARGEM (BOT√ÉO üî¨) ---
document.querySelector('button[data-action="open-margin-editor"]').addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (!selectedNoteId) {
        alert("Selecione uma nota primeiro.");
        return;
    }

    // 1. Feedback Visual
    const btn = e.target;
    const originalText = btn.textContent;
    btn.textContent = "üíæ"; // √çcone de disquete tempor√°rio
    
    // 2. Gravar a nota atual (For√ßa grava√ß√£o imediata)
    // A fun√ß√£o saveNote(true) devolve uma Promise, por isso usamos await
    await saveNote(true);

    // 3. Redirecionar para a nova p√°gina enviando o ID da nota
    window.location.href = `editnote.html?noteId=${selectedNoteId}`;
});


// ====================================================================
// FECHAR POPUPS AO CLICAR NAS BARRAS DE FERRAMENTAS
// ====================================================================
const toolbars = [
    document.getElementById('editor-toolbar'),    // Barra Principal (onde est√£o üîì, üìë, üïí)
    document.getElementById('secondary-toolbar')  // Barra Secund√°ria (onde est√£o H1, H2, Cor)
];

toolbars.forEach(toolbar => {
    if (toolbar) {
        toolbar.addEventListener('click', () => {
            // 1. Esconde o menu de inser√ß√£o r√°pida (üìò üìó üìô üìí)
            const insertPopup = document.getElementById('insertion-popup');
            if (insertPopup) insertPopup.style.display = 'none';

            // 2. (Opcional) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üé¥) se estiver aberto
            const selectPopup = document.getElementById('selection-popup');
            if (selectPopup) selectPopup.style.display = 'none';
        });
    }
});

// --- BOT√ÉO DE PESQUISA GLOBAL (RODAP√â ESQUERDO) ---
const globalSearchBtn = document.getElementById('global-search-btn');
if (globalSearchBtn) {
    globalSearchBtn.addEventListener('click', () => {
        // Usa a mesma fun√ß√£o que a lupa da barra de ferramentas
        openExplorerModal();
    });
}


// ====================================================================
// L√ìGICA DO ENTER EM LINHAS MOV√çVEIS (SAIR PARA LINHA NORMAL)
// ====================================================================
noteContentEditor.addEventListener('keydown', (e) => {
    // 1. DETETOR B√ÅSICO
    if (e.key === 'Enter') {

        
        if (e.shiftKey) {
            console.log("   (Shift+Enter detetado -> Ignorando l√≥gica customizada)");
            return;
        }

        const selection = window.getSelection();
        if (!selection.rangeCount) {
            console.log("‚ùå Sem sele√ß√£o de cursor ativa.");
            return;
        }

        const anchorNode = selection.anchorNode;
        console.log("üìç N√≥ do cursor:", anchorNode);

        // Garante que pegamos o elemento HTML da linha
        const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        console.log("   Elemento HTML:", element);

        const draggableLine = element.closest('.draggable-line');
        console.log("üîç √â linha arrast√°vel?", draggableLine ? "SIM" : "N√ÉO");

        if (draggableLine) {
            console.group("üöÄ A INICIAR L√ìGICA DE INSER√á√ÉO");
            e.preventDefault(); 
            e.stopPropagation();

            // 1. AN√ÅLISE DO PAI ORIGINAL
            const currentParent = draggableLine.parentElement;
            console.log("1. Pai da linha atual:", currentParent);
            console.log("   Classes:", currentParent.className);

            const contentArea = draggableLine.querySelector('.drag-content-area');
            const newParagraph = document.createElement('p');
            newParagraph.style.margin = "4px 0";
            newParagraph.setAttribute('data-debug', 'nova-linha-' + Date.now()); // Marca para identificar

            // Corte de texto
            const range = selection.getRangeAt(0);
            const rangeToEnd = document.createRange();
            rangeToEnd.selectNodeContents(contentArea);
            rangeToEnd.setStart(range.endContainer, range.endOffset);
            
            const fragment = rangeToEnd.extractContents();
            newParagraph.appendChild(fragment);

            if (newParagraph.innerHTML.trim() === '') newParagraph.innerHTML = '<br>';

            // 2. INSER√á√ÉO (M√âTODO AFTEREND)
            console.log("2. A executar: draggableLine.insertAdjacentElement('afterend', newParagraph)");
            draggableLine.insertAdjacentElement('afterend', newParagraph);

            // 3. VERIFICA√á√ÉO P√ìS-INSER√á√ÉO
            const newParent = newParagraph.parentElement;
            console.log("3. Pai da NOVA linha:", newParent);

            if (currentParent !== newParent) {
                console.error("üö® ERRO CR√çTICO: O pai mudou! A linha fugiu.");
                console.warn("   Esperado:", currentParent);
                console.warn("   Obtido:", newParent);
                
                // CORRE√á√ÉO FOR√áADA
                console.log("üõ†Ô∏è APLICANDO CORRE√á√ÉO FOR√áADA: currentParent.appendChild");
                currentParent.appendChild(newParagraph);
            } else {
                console.log("‚úÖ SUCESSO: A linha ficou no mesmo pai.");
            }

            console.groupEnd();

            // Foco
            const newRange = document.createRange();
            if (newParagraph.firstChild && newParagraph.firstChild.nodeType === 3) {
                newRange.setStart(newParagraph.firstChild, 0);
            } else {
                newRange.selectNodeContents(newParagraph);
            }
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);

            saveNote();
        } else {
            console.log("‚ÑπÔ∏è Enter normal (fora de linha mov√≠vel).");
        }
    }
});


// --- FUN√á√ÉO PARA CRIAR UMA LINHA DE CODEX (FIX) ---
window.createCodexRow = function(data = null) {
    const container = document.getElementById('codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    // Se estiver editando um item existente, guardamos o ID do Firestore
    if (data && data.id) row.setAttribute('data-firestore-id', data.id);

    row.innerHTML = `
        <button class="remove-codex-row" onclick="window.removeCodexRow(this)">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                <!-- Onde aparecer√° o nome completo da publica√ß√£o -->
                <div class="serie-fullname" style="font-size: 11px; color: var(--accent-color); margin-top: 4px; height: 14px; font-weight: 500; font-style: italic;"></div>
            </div>
            <div class="manual-controls">
                <label class="codex-label">OP√á√ïES</label>
                <div style="display:flex; gap:4px;">
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'A')" title="Ano Manual">A</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'M')" title="M√™s Manual">M</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'T')" title="Tempo (H:M:S)">T</button>
                </div>
            </div>
        </div>
        <div class="manual-inputs-area"></div> 
        <div class="codex-content-grid">
            <div class="unit-section">
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div class="unit-section">
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;

    // --- L√ìGICA DE IDENTIFICA√á√ÉO DA SIGLA ---
    const inputSerie = row.querySelector('.serie-main');
    const displayFullName = row.querySelector('.serie-fullname');

    const updateFullName = (val) => {
        if (!val) {
            displayFullName.textContent = "";
            return;
        }

        const valorBaixo = val.toLowerCase().trim();
        
        // 1. Extra√ß√£o da Sigla: 
        // Pega as letras iniciais. Se houver h√≠fen e n√∫mero (ex: it-1), pega tamb√©m.
        // Se houver espa√ßo ou n√∫mero logo ap√≥s as letras (ex: w24), isola as letras.
        let sigla = "";
        const match = valorBaixo.match(/^[a-z]+(?:-[0-9])?/);
        if (match) sigla = match[0];

        // 2. Busca no dicion√°rio importado (SIGLAS_PUBLICACOES)
        // Nota: Certifique-se de que SIGLAS_PUBLICACOES est√° acess√≠vel neste escopo
        const nomeCompleto = SIGLAS_PUBLICACOES[sigla];

        if (nomeCompleto) {
            displayFullName.textContent = `üìö ${nomeCompleto}`;
        } else {
            displayFullName.textContent = "";
        }
    };

    // Listener para quando o utilizador escreve
    inputSerie.addEventListener('input', (e) => updateFullName(e.target.value));

    container.appendChild(row);

    // Se houver dados (edi√ß√£o), preenchemos os chips e o nome completo
    if (data) {
        updateFullName(data.serie);
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addCodexUnit(pgContainer, 'Par', p));
    } else {
        // Linha nova: adiciona chips vazios para facilitar
        window.addCodexUnit(row.querySelector('.pages-container'), 'P√°g');
        window.addCodexUnit(row.querySelector('.paragraphs-container'), 'Par');
    }
};

// 1. Fun√ß√£o Auxiliar: Atualizar Estado Visual do Bot√£o
function updateBoxLinkButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="manage-box-links"]');
    if (!btn) return;

    const linksJson = wrapper.getAttribute('data-box-links') || '{}';
    let hasContent = false;

    try {
        const links = JSON.parse(linksJson);
        const hasUrls = links.urls && Object.keys(links.urls).length > 0;
        const hasCodex = links.codex && links.codex.length > 0;
        if (hasUrls || hasCodex) hasContent = true;
    } catch (e) { hasContent = false; }

    if (hasContent) {
        btn.classList.add('has-links');
        btn.title = "Gerir Conte√∫do (Ativo)";
        btn.style.borderColor = "#f1c40f";
        btn.style.color = "#f1c40f";
    } else {
        btn.classList.remove('has-links');
        btn.style.borderColor = "";
        btn.style.color = "";
        btn.title = "Adicionar Hiperliga√ß√µes ou Codex";
    }
}

// 2. Fun√ß√µes Globais para o Codex (Escopo Window)
 window.addCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    // Insere antes do bot√£o "+"
    container.insertBefore(unit, container.lastChild);
};

// Gerencia os bot√µes A e M (Ano e M√™s manuais)
window.toggleManual = function(btn, type) {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    btn.classList.toggle('active');
    
    if (btn.classList.contains('active')) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = `codex-input-manual manual-${type === 'A' ? 'year' : 'month'}`;
        input.placeholder = type === 'A' ? "Ano" : "M√™s";
        area.appendChild(input);
    } else {
        const target = area.querySelector(`.manual-${type === 'A' ? 'year' : 'month'}`);
        if (target) target.remove();
    }
};

// Remove a linha inteira do Codex
window.removeCodexRow = function(btn) {
    if (document.querySelectorAll('.codex-row').length > 1) {
        btn.closest('.codex-row').remove();
    } else {
        alert("√â necess√°rio pelo menos uma linha.");
    }
};

window.removeManualField = function(btn, type) {
    const row = btn.closest('.codex-row');
    const fieldGroup = btn.closest('.manual-field-group');
    
    // 1. Encontra o bot√£o A ou M correspondente e desativa-o
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if (toggleBtn) toggleBtn.classList.remove('active');
    
    // 2. Remove o campo do ecr√£
    fieldGroup.remove();
};




// 3. Fun√ß√µes de Suporte para Processamento
function parseSerieInfo(serie, manualYear, manualMonth) {
    let ano = manualYear || "";
    let mes = manualMonth || "";
    const s = serie.toLowerCase();
    const yearMatch = s.match(/[wg](\d{2})/);
    if (yearMatch && !ano) {
        const yy = parseInt(yearMatch[1]);
        ano = yy > 35 ? (1900 + yy).toString() : (2000 + yy).toString();
    }
    const monthMatch = s.match(/\d{1,2}\/(\d{1,2})/);
    if (monthMatch && !mes) {
        const mIdx = parseInt(monthMatch[1]) - 1;
        if (mIdx >= 0 && mIdx < 12) mes = MESES_LISTA[mIdx];
    }
    if (!mes) MESES_LISTA.forEach(m => { if (s.includes(m.toLowerCase())) mes = m; });
    return { ano, mes };
}

function getCodexDataFromRow(row) {
    return {
        serie: row.querySelector('.serie-main')?.value.trim() || "",
        paginas: Array.from(row.querySelectorAll('.pages-container input')).map(i => i.value.trim()).filter(v => v !== ""),
        paragrafos: Array.from(row.querySelectorAll('.paragraphs-container input')).map(i => i.value.trim()).filter(v => v !== ""),
        manualYear: row.querySelector('.manual-year')?.value || null,
        manualMonth: row.querySelector('.manual-month')?.value || null,
        // Novos campos de tempo:
        h: row.querySelector('.h-input')?.value || "",
        m: row.querySelector('.m-input')?.value || "",
        s: row.querySelector('.s-input')?.value || ""
    };
}

// 4. Gest√£o do Modal (Abertura e Grava√ß√£o)
 async function openBoxLinkManager(wrapper) {
    console.log("üöÄ [GESTOR] Abertura iniciada para caixa:", wrapper.id);
    
    const modal = document.getElementById('link-modal');
    const tabHeader = document.getElementById('box-link-tabs');
    const refsDiv = document.getElementById('box-content-refs');
    const codexDiv = document.getElementById('box-content-codex');
    const saveBtn = document.getElementById('link-save-btn');
    const addUrlBtn = document.getElementById('add-url-btn');
    const addCodexBtn = document.getElementById('add-codex-row-btn');

    // --- 1. RESET IMEDIATO DO ESTADO DO BOT√ÉO E INTERFACE ---
    saveBtn.disabled = false;
    saveBtn.textContent = "Gravar";
    document.getElementById('codex-rows-container').innerHTML = '';
    document.getElementById('link-urls-container').innerHTML = '';
    document.getElementById('link-remove-btn').style.display = 'none';

    // --- 2. GARANTIR VISIBILIDADE DOS COMPONENTES ---
    if (tabHeader) tabHeader.style.display = 'flex';
    if (addCodexBtn) addCodexBtn.style.display = 'block';
    if (addUrlBtn) addUrlBtn.style.display = 'block';

    // --- 3. RE-LIGAR EVENTOS DE ADICIONAR ---
    addUrlBtn.onclick = (e) => {
        e.preventDefault();
        addUrlField();
    };

    addCodexBtn.onclick = (e) => {
        e.preventDefault();
        window.createCodexRow();
    };

    // --- 4. CONFIGURA√á√ÉO DE ABAS ---
    if (tabHeader) {
        const tabButtons = tabHeader.querySelectorAll('button');
        tabButtons.forEach(btn => {
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const target = btn.getAttribute('data-box-tab');
                
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (target === 'refs') {
                    refsDiv.style.display = 'block';
                    codexDiv.style.display = 'none';
                } else {
                    refsDiv.style.display = 'none';
                    codexDiv.style.display = 'block';
                }
            };
        });
    }

    // --- 5. CARREGAMENTO DE DADOS EXISTENTES ---
    let currentData = {};
    try {
        currentData = JSON.parse(wrapper.getAttribute('data-box-links') || '{}');
    } catch (e) { currentData = {}; }

    document.getElementById('link-title-input').value = currentData.title || "";

    const urls = currentData.urls ? Object.values(currentData.urls) : [];
    if (urls.length > 0) {
        urls.forEach(url => addUrlField(url));
    } else {
        addUrlField();
    }

    if (currentData.codex && currentData.codex.length > 0) {
        currentData.codex.forEach(item => window.createCodexRow(item));
    } else {
        window.createCodexRow(); 
    }

    const btnRefs = document.querySelector('[data-box-tab="refs"]');
    if (btnRefs) btnRefs.click();

    // --- 6. CONFIGURAR O CLIQUE DO "GRAVAR" COM RESET ---
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A processar...";

        try {
            // Recolha de URLs
            const urlsToSave = {};
            document.querySelectorAll('#link-urls-container input').forEach((inp, i) => {
                if(inp.value.trim()) {
                    let val = inp.value.trim();
                    if(!val.startsWith('http')) val = 'https://' + val;
                    urlsToSave[`url_${Date.now()}_${i}`] = val;
                }
            });

            // Recolha de Codex
            const codexToSave = [];
            document.querySelectorAll('.codex-row').forEach(row => {
                const rowData = getCodexDataFromRow(row);
                if (rowData.serie) {
                    rowData.total = rowData.serie + (rowData.paginas.length ? `, p√°g. ${rowData.paginas.join(',')}` : '');
                    codexToSave.push(rowData);
                }
            });

            // Atualiza Atributo HTML
            const finalJson = { 
                title: document.getElementById('link-title-input').value.trim(), 
                urls: urlsToSave, 
                codex: codexToSave 
            };
            wrapper.setAttribute('data-box-links', JSON.stringify(finalJson));
            
            updateBoxLinkButtonState(wrapper);

            // Grava a Nota no Firebase (usamos forceImmediate=true)
            await saveNote(true);

            // SUCESSO: Fecha o modal
            modal.style.display = 'none';

        } catch (err) {
            console.error("‚ùå [ERRO]:", err);
            alert("Erro ao gravar. Tente novamente.");
        } finally {
            // ESTA √â A CHAVE: Garante que o bot√£o volta ao normal mesmo que haja erro
            // ou para quando o popup reabrir
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
        }
    };

    modal.style.display = 'flex';
}



// 5. Listener para o bot√£o ‚ö° no editor
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="manage-box-links"]');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const wrapper = btn.closest('.mini-note-wrapper');
    if (wrapper) openBoxLinkManager(wrapper);
});




// --- CRIA√á√ÉO DOS BOT√ïES FLUTUANTES (MOBILE) ---
// Injetamos o HTML via JS para n√£o poluir a estrutura original
(function createMobileFABs() {
    const fabContainer = document.createElement('div');
    fabContainer.id = 'mobile-fab-container';
    
    // A ordem HTML define a ordem visual (Coluna: de cima para baixo)
    // Pediu o "+" acima dos outros.
    fabContainer.innerHTML = `
        <button id="mobile-fab-add" class="fab-btn" title="Adicionar Item">+</button>
        <button id="mobile-fab-account" class="fab-btn" title="Minha Conta">üë§</button>
        <button id="mobile-fab-search" class="fab-btn" title="Pesquisa Global">üîé</button>
        <button id="mobile-fab-settings" class="fab-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
    `;
    
    document.body.appendChild(fabContainer);

    // --- LIGA√á√ÉO DE EVENTOS (Mapear cliques para os bot√µes originais) ---
    // Usamos .click() nos bot√µes originais para manter toda a l√≥gica existente.

    document.getElementById('mobile-fab-add').addEventListener('click', () => {
        const originalBtn = document.getElementById('add-item-btn');
        if(originalBtn) originalBtn.click();
    });

    document.getElementById('mobile-fab-account').addEventListener('click', () => {
        const originalBtn = document.getElementById('account-btn');
        if(originalBtn) originalBtn.click();
    });

    document.getElementById('mobile-fab-search').addEventListener('click', () => {
        const originalBtn = document.getElementById('global-search-btn');
        if(originalBtn) originalBtn.click();
    });

    document.getElementById('mobile-fab-settings').addEventListener('click', () => {
        const originalBtn = document.getElementById('settings-btn');
        if(originalBtn) originalBtn.click();
    });

})(); // Executa imediatamente

// ====================================================================
// MOTOR DE ARRASTO UNIFICADO (LINHAS ·Øì + CART√ïES üé¥)
// ====================================================================
let dragSrcEl = null;   // Para Linhas
let draggedCard = null; // Para Cart√µes

// 1. INICIAR ARRASTO (DRAGSTART)
noteContentEditor.addEventListener('dragstart', (e) => {
    // --- CEN√ÅRIO A: CART√ïES (üé¥) ---
    const card = e.target.closest('.url-card-widget');
    if (card && !e.target.classList.contains('url-card-close')) {
        draggedCard = card;
        dragSrcEl = null; // Garante que n√£o mistura
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', card.id); // Necess√°rio para Firefox
        e.dataTransfer.setDragImage(card, 0, 0);

        setTimeout(() => card.classList.add('sortable-dragging'), 0);
        return; // Sai da fun√ß√£o, j√° trat√°mos do cart√£o
    }

    // --- CEN√ÅRIO B: LINHAS (·Øì) ---
    const line = e.target.closest('.draggable-line');
    if (line) {
        dragSrcEl = line;
        draggedCard = null; // Garante que n√£o mistura

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', line.outerHTML);
        
        line.classList.add('dragging');
        setTimeout(() => line.style.opacity = '0.4', 0);
    }
});

// 2. TERMINAR ARRASTO (DRAGEND - LIMPEZA)
noteContentEditor.addEventListener('dragend', (e) => {
    // Limpeza de Cart√µes
    if (draggedCard) {
        draggedCard.classList.remove('sortable-dragging');
        document.querySelectorAll('.drop-target-left, .drop-target-right').forEach(el => {
            el.classList.remove('drop-target-left', 'drop-target-right');
        });
        draggedCard = null;
    }

    // Limpeza de Linhas
    if (dragSrcEl) {
        dragSrcEl.classList.remove('dragging');
        dragSrcEl.style.opacity = '1';
        document.querySelectorAll('.drop-target-top, .drop-target-bottom').forEach(el => {
            el.classList.remove('drop-target-top', 'drop-target-bottom');
        });
        dragSrcEl = null;
    }
});

// 3. ARRASTAR POR CIMA (DRAGOVER - C√ÅLCULOS)
noteContentEditor.addEventListener('dragover', (e) => {
    e.preventDefault(); // Necess√°rio para permitir o drop

    // --- L√ìGICA DE CART√ïES (Horizontal) ---
    if (draggedCard) {
        const targetCard = e.target.closest('.url-card-widget');
        
        if (targetCard && targetCard !== draggedCard) {
            const rect = targetCard.getBoundingClientRect();
            const midPoint = rect.left + (rect.width / 2);
            
            targetCard.classList.remove('drop-target-left', 'drop-target-right');

            if (e.clientX < midPoint) targetCard.classList.add('drop-target-left');
            else targetCard.classList.add('drop-target-right');
        }
        return;
    }

    // --- L√ìGICA DE LINHAS (Vertical + AutoScroll) ---
    if (dragSrcEl) {
        const editor = document.getElementById('note-content-editor');
        
        // Auto-Scroll
        const editorRect = editor.getBoundingClientRect();
        const scrollThreshold = 60;
        const scrollSpeed = 10;

        if (e.clientY > editorRect.bottom - scrollThreshold) editor.scrollTop += scrollSpeed;
        else if (e.clientY < editorRect.top + scrollThreshold) editor.scrollTop -= scrollSpeed;

        // Identificar Alvo
        const target = e.target.closest('.draggable-line, .mini-note-wrapper, details.toggle-section, p');
        
        if (target && target !== dragSrcEl && noteContentEditor.contains(target)) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
            
            document.querySelectorAll('.drop-target-top, .drop-target-bottom').forEach(el => {
                if(el !== target) el.classList.remove('drop-target-top', 'drop-target-bottom');
            });

            if (next) {
                target.classList.remove('drop-target-top');
                target.classList.add('drop-target-bottom');
            } else {
                target.classList.remove('drop-target-bottom');
                target.classList.add('drop-target-top');
            }
        }
    }
});

// 4. LARGAR (DROP - A√á√ÉO FINAL)
noteContentEditor.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();

    // --- DROP DE CART√ïES ---
    if (draggedCard) {
        const targetCard = e.target.closest('.url-card-widget');
        if (targetCard && targetCard !== draggedCard) {
            const rect = targetCard.getBoundingClientRect();
            const midPoint = rect.left + (rect.width / 2);
            const parent = targetCard.parentNode;

            targetCard.classList.remove('drop-target-left', 'drop-target-right');

            if (e.clientX < midPoint) parent.insertBefore(draggedCard, targetCard);
            else parent.insertBefore(draggedCard, targetCard.nextSibling);
            
            saveNote();
        }
        return;
    }

    // --- DROP DE LINHAS ---
    if (dragSrcEl) {
        const target = e.target.closest('.draggable-line, .mini-note-wrapper, details.toggle-section, p');
        
        if (target && target !== dragSrcEl) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
            
            // Limpa classes visuais
            target.classList.remove('drop-target-top', 'drop-target-bottom');

            if (next) target.parentNode.insertBefore(dragSrcEl, target.nextSibling);
            else target.parentNode.insertBefore(dragSrcEl, target);
            
            saveNote();
        }
        
        // Reset visual extra para garantir
        if (dragSrcEl) {
            dragSrcEl.style.opacity = '1';
            dragSrcEl.classList.remove('dragging');
        }
    }
});

// --- NOVA FUN√á√ÉO: MUDAR ENTRE LOCAL E PARTILHA ---
async function switchFolderView(mode) {
    // 1. Remove bot√µes flutuantes durante a transi√ß√£o
    document.body.classList.remove('show-fab');

    // 2. Evita recarregar se j√° estivermos no modo e na raiz
    if (mode === currentViewMode && navigationStack.length === 0) return;

    // 3. GRAVA√á√ÉO AUTOM√ÅTICA DE SEGURAN√áA (Antes de mudar a vista)
    // Verifica se h√° uma nota normal por guardar ou um Post em edi√ß√£o
    const idToSave = activeEditingPostId || window.activeEditingPostId;
    
    if (currentSaveStatus === 'unsaved' || idToSave) {
        console.log("üíæ [SISTEMA] Gravando altera√ß√µes pendentes antes de mudar de modo...");
        try {
            if (idToSave) {
                // Se for um post de Arquivo, grava e remove o cadeado (Unlock)
                const tempId = idToSave;
                activeEditingPostId = null;
                window.activeEditingPostId = null;
                await window.saveArchivePost(tempId);
            } else if (selectedNoteId) {
                // Se for uma nota normal, for√ßa a grava√ß√£o imediata
                await saveNote(true);
            }
        } catch (e) {
            console.error("Erro ao gravar durante mudan√ßa de modo:", e);
        }
    }

    // 4. LIMPEZA TOTAL DE ESTADO E OUVINTES (Snapshot Cleanup)
    col1SelectedId = null;
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }
    if (unsubscribeShared2) { unsubscribeShared2(); unsubscribeShared2 = null; }
    if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    // Reseta o editor e limpa sele√ß√£o visual da Coluna 2
    resetEditor();             

    // 5. ATUALIZA O MODO E ESTADO DE NAVEGA√á√ÉO
    currentViewMode = mode;    
    navigationStack = [];      

    // 6. RECONSTR√ìI A INTERFACE (Cabe√ßalhos e Abas)
    updateNavigationView(true);

    // 7. CARREGAMENTO ESPEC√çFICO DE DADOS
    if (mode === 'pins') {
        console.log("üìå [SISTEMA] Modo Pins Ativado.");
        loadPinsView(); 
    } 
    else if (mode === 'shared') {
        console.log("ü§ù [SISTEMA] Modo Partilha Ativado.");
        loadSharedFilesRoot(); // Carrega arquivos na Coluna 2

        // --- SALTO PARA MOBILE (Coluna 2) ---
        if (window.innerWidth <= 768) {
            // No mobile, for√ßa a vista para a lista de arquivos imediatamente
            document.body.classList.add('mobile-view-middle');
            document.body.classList.remove('mobile-view-editor');
        }
    }
    else if (mode === 'local') {
        console.log("üè† [SISTEMA] Modo Local Ativado.");
        const addItemBtn = document.getElementById('add-item-btn');
        if (addItemBtn) addItemBtn.classList.remove('shared-mode', 'yellow-mode');
        // A lista local √© carregada automaticamente pelo updateNavigationView()
    }

    // 8. ATUALIZA BOT√ïES FLUTUANTES (Se aplic√°vel)
    updateMobileFABVisibility();
}

// Exp√µe a fun√ß√£o globalmente para os bot√µes HTML
window.switchFolderView = switchFolderView;

// ============================================================
// L√ìGICA DO MODO ARQUIVO (FEED DE POSTS)
// ============================================================

// 1. Exibir o Arquivo
function displayArchive(id, data, element = null) {
    document.body.classList.remove('show-fab');
    console.log(`%cüé® [SISTEMA] Preparando entrada no Arquivo: ${data.nome}`, "color: #e74c3c; font-weight: bold;");
    
    // 1. Reset de Estado e Limpeza
    window.activeGavetaId = null;
    window.activeGavetaData = null;
    currentArchiveTab = 'prateleira';
    
    document.querySelectorAll('.archive-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.archiveTab === 'prateleira') btn.classList.add('active');
    });
    
    const postBtn = document.getElementById('create-post-btn');
    const drawerBtn = document.getElementById('create-drawer-trigger-btn');
    if (postBtn) postBtn.style.display = 'block';
    if (drawerBtn) drawerBtn.style.display = 'none';

    // 2. Definir IDs Globais
    selectedNoteId = id; 
    currentArchiveId = id; 
    currentArchiveData = data;

    // 3. Regra de Seguran√ßa: Ocultar cadeado para colaboradores
    const shareBtn = document.querySelector('button[data-action="archive-share"]');
    if (shareBtn) {
        const isOwner = data.userId === auth.currentUser.uid;
        const isSharedType = (data.tipo === 'partilhado');

        if (isSharedType && !isOwner) {
            console.log("üõ°Ô∏è [SEGURAN√áA] Arquivo partilhado detetado. Ocultando cadeado para colaborador.");
            shareBtn.style.display = 'none';
        } else {
            shareBtn.style.display = 'block';
        }
    }

    // 4. Sincroniza√ß√£o Visual da Lista Lateral (Coluna 2)
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });

    if (element) {
        const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
        element.classList.add(selectionClass);
    }

    // 5. Visibilidade dos Pain√©is
    const placeholder = document.getElementById('editor-placeholder');
    const editorArea = document.getElementById('editor-area');
    const archiveArea = document.getElementById('archive-area');

    if (placeholder) placeholder.style.setProperty('display', 'none', 'important');
    if (editorArea) editorArea.style.setProperty('display', 'none', 'important');
    
    if (archiveArea) {
        archiveArea.style.display = 'flex';
        archiveArea.scrollTop = 0;
    }

    const titleInput = document.getElementById('archive-title-input');
    if (titleInput) titleInput.value = data.nome || "";

    // 6. Iniciar Colabora√ß√£o e Presen√ßa
    if (typeof leaveArchivePresence === 'function') leaveArchivePresence(); 
    initRealtimeCollab(id);
    initPresenceSystem(id);

    renderArchiveFeed();

    // Ajuste Mobile
    if (window.innerWidth <= 768) {
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
    }
}


// 2. Renderizar o Feed
window.renderArchiveFeed = async function() {
    const feed = document.getElementById('archive-feed');
    const postBtn = document.getElementById('create-post-btn');
    const drawerBtn = document.getElementById('create-drawer-trigger-btn');
    const separatorBtn = document.getElementById('create-separator-btn');

    if (!feed) return;

    // --- RESET: Esconde todos os bot√µes de a√ß√£o ---
    if (postBtn) postBtn.style.display = 'none';
    if (drawerBtn) drawerBtn.style.display = 'none';
    if (separatorBtn) separatorBtn.style.display = 'none';

    // --- CASO 1: DENTRO DE UMA GAVETA ---
    if (window.activeGavetaId) {
        // Mostra o bot√£o verde de Separador. Post e Gavet√£o somem.
        if (separatorBtn) separatorBtn.style.display = 'block';
        
        renderOpenedGavetaView(feed, currentArchiveData.posts || []);
        return; 
    }

    // --- CASO 2: ABA PRATELEIRA ---
    if (currentArchiveTab === 'prateleira') {
        if (postBtn) postBtn.style.display = 'block';

        feed.innerHTML = '';
        const posts = currentArchiveData?.posts || [];
        if (posts.length === 0) {
            feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Nenhum post criado.</div>';
            return;
        }
        posts.forEach(post => feed.appendChild(createPostElement(post)));
    } 
    // --- CASO 3: ABA GAVET√ÉO ---
    else if (currentArchiveTab === 'gavet√µes') {
        if (drawerBtn) drawerBtn.style.display = 'block';

        feed.innerHTML = '<div style="text-align:center; padding:20px;">A carregar gavet√µes...</div>';
        try {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId), orderBy('ordem', 'asc'));
            const drawerSnap = await getDocs(q);
            feed.innerHTML = '';
            if (drawerSnap.empty) {
                feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Nenhum gavet√£o criado.</div>';
            } else {
                for (const docSnap of drawerSnap.docs) {
                    const drawer = { id: docSnap.id, ...docSnap.data() };
                    feed.appendChild(await createGavetaoUI(drawer));
                }
            }
        } catch (e) { console.error(e); }
    }
}


window.toggleGavetaViewMode = async () => {
    if (!window.activeGavetaId || !window.activeGavetaData) return;

    // Alterna entre 'full' e 'titles' (se n√£o existir, o padr√£o √© 'titles')
    const currentMode = window.activeGavetaData.viewMode || 'titles';
    const newMode = currentMode === 'titles' ? 'full' : 'titles';
    
    try {
        // 1. Atualiza no Firebase para ficar guardado permanentemente
        await updateDoc(doc(db, 'gavetas', window.activeGavetaId), {
            viewMode: newMode
        });
        
        // 2. Atualiza os dados na mem√≥ria e redesenha a vista
        window.activeGavetaData.viewMode = newMode;
        renderArchiveFeed();
    } catch (e) {
        console.error("Erro ao mudar modo de vista:", e);
    }
};

// Fun√ß√£o para criar o elemento visual do Gavet√£o
async function createGavetaoUI(drawer) {
    const div = document.createElement('div');
    div.style.position = 'relative';
    div.style.marginBottom = '15px';

    // Geramos um ID limpo para o container
    const containerId = `gavetas-of-${drawer.id}`;

    div.innerHTML = `
        <button class="corner-close-btn" onclick="window.deleteGavetao('${drawer.id}')">x</button>
        <details class="drawer-toggle" open>
            <summary>
                <span>üìÇ ${drawer.nome}</span>
                <div class="drawer-controls" onclick="event.stopPropagation();">
                    <button class="mini-btn" onclick="window.moveGavetao('${drawer.id}', -1)">‚Üë</button>
                    <button class="mini-btn" onclick="window.moveGavetao('${drawer.id}', 1)">‚Üì</button>
                    <button class="mini-btn" onclick="window.openEditDrawerModal('${drawer.id}', '${drawer.nome}', '${drawer.descricao}')">‚úèÔ∏è</button>
                    <button class="mini-btn" onclick="event.preventDefault(); event.stopPropagation(); window.openCreateGavetaModal('${drawer.id}')"> + </button>
                </div>
            </summary>
            <div class="gavetas-container" id="${containerId}" style="padding: 10px 0; min-height:30px;">
                <div style="text-align:center; padding:20px; color:#888; font-size:0.9em;">
                   <div class="spinner" style="width:15px; height:15px; border-width:2px; display:inline-block; margin-right:10px;"></div>
                   A carregar pastas...
                </div>
            </div>
        </details>
    `;
    
    // O TRUQUE: Esperar um folego para o DOM processar o ID novo
    setTimeout(() => {
        window.loadGavetasInternas(drawer.id);
    }, 50);
    
    return div;
}

// Fun√ß√£o para carregar as pastas (gavetas) dentro do gavet√£o
window.loadGavetasInternas = async function(gavetaoId) {
    const container = document.getElementById(`gavetas-of-${gavetaoId}`);
    if (!container) {
        console.warn("‚ö†Ô∏è Container ainda n√£o encontrado para o Gavet√£o:", gavetaoId);
        return;
    }

    try {
        const q = query(
            collection(db, 'gavetas'), 
            where('gavetaoId', '==', gavetaoId), 
            orderBy('ordem', 'asc')
        );
        
        const snap = await getDocs(q);
        
        // S√≥ limpa o "A carregar" se a resposta do Firebase chegar
        container.innerHTML = ''; 

        if (snap.empty) {
            container.innerHTML = '<div style="text-align:center; color:#555; font-size:0.8em; padding:10px; font-style:italic;">Gavet√£o vazio.</div>';
            return;
        }

        snap.forEach(docSnap => {
            const gaveta = { id: docSnap.id, ...docSnap.data() };
            const gDiv = document.createElement('div');
            gDiv.className = 'gaveta-folder';
            
            gDiv.innerHTML = `
                <div class="gaveta-title-area" style="flex-grow:1; cursor:pointer;" onclick="window.openGaveta('${gaveta.id}')">
                    <span>üìÅ</span>
                    <span style="margin-left:8px;">${gaveta.nome}</span>
                </div>
                <div class="drawer-controls">
                    <button class="mini-btn" onclick="window.moveGaveta('${gaveta.id}', '${gavetaoId}', -1); event.stopPropagation();">‚Üë</button>
                    <button class="mini-btn" onclick="window.moveGaveta('${gaveta.id}', '${gavetaoId}', 1); event.stopPropagation();">‚Üì</button>
                    <button class="corner-close-btn" style="position:static; opacity:1; margin-left:10px;" onclick="window.deleteGaveta('${gaveta.id}'); event.stopPropagation();">x</button>
                </div>
            `;
            container.appendChild(gDiv);
        });
    } catch (e) {
        console.error("‚ùå Erro ao carregar gavetas:", e);
        container.innerHTML = '<div style="text-align:center; color:#e74c3c; font-size:0.8em;">Erro ao carregar dados.</div>';
    }
};

// 3. Criar Elemento HTML do Post
function createPostElement(post) {
    const div = document.createElement('div');
    div.className = 'archive-post';
    div.id = `post-${post.id}`;
    div.dataset.id = post.id;

    // Verifica se este post deve renderizar em modo edi√ß√£o ou visualiza√ß√£o
    // (Por defeito renderiza view, a menos que tenhamos acabado de criar)
    if (activeEditingPostId === post.id) {
        renderPostEditMode(div, post);
    } else {
        renderPostViewMode(div, post);
    }

    return div;
}

// 4. Renderizar Modo Visualiza√ß√£o
function renderPostViewMode(container, post) {
    const createdDate = post.createdAt ? new Date(post.createdAt).toLocaleString() : 'Desconhecido';
    const updatedDate = post.updatedAt ? new Date(post.updatedAt).toLocaleString() : '-';
    const creatorName = post.createdBy || 'Desconhecido';

    // 1. L√ìGICA DE VISIBILIDADE DO AUTOR
    // S√≥ mostramos o "Criado por:" se o arquivo pai for do tipo "partilhado"
    const isSharedType = currentArchiveData && currentArchiveData.tipo === 'partilhado';
    const authorSpan = isSharedType 
        ? `<span style="font-weight: bold; color: var(--accent-color);">Criado por: ${creatorName}</span>` 
        : '';

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = post.content;

    tempDiv.querySelectorAll('input, textarea').forEach(input => {
        input.setAttribute('readonly', 'true');
        input.style.cursor = 'default';
    });

    tempDiv.querySelectorAll('[contenteditable]').forEach(el => {
        el.setAttribute('contenteditable', 'false');
    });

    let safeContent = tempDiv.innerHTML;

    if (post.type === 'entity' && !safeContent.includes('mini-note-wrapper') && !safeContent.includes('toggle-section') && !safeContent.includes('idea-span')) {
        safeContent = `<div class="post-view-content">${safeContent}</div>`;
    }

    const btnStyle = "position: static !important; background:var(--bg-color); border:1px solid var(--border-color); color:var(--text-muted-color); border-radius:4px; padding:0 10px; cursor:pointer; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1;";

    const controlsHTML = `
        <div class="post-controls" style="position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 5px; opacity: 0.6; transition: opacity 0.2s; z-index: 10; background-color: var(--panel-color); border-radius: 4px; padding: 2px;">
            <button class="post-move-btn" onclick="moveArchivePost('${post.id}', -1)" title="Mover para Cima" style="${btnStyle}">‚Üë</button>
            <button class="post-move-btn" onclick="moveArchivePost('${post.id}', 1)" title="Mover para Baixo" style="${btnStyle}">‚Üì</button>
            <button class="post-edit-btn" onclick="editArchivePost('${post.id}')" style="${btnStyle}">Editar</button>
        </div>
    `;

    container.innerHTML = `
        ${controlsHTML}
        <div class="post-view-title" style="padding-right: 140px;">${post.title || 'Sem T√≠tulo'}</div>
        <div class="post-view-content">${safeContent}</div>
        
        <div class="post-footer" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Criado: ${createdDate}</span>
            ${authorSpan} 
            <span>Editado: ${updatedDate}</span>
        </div>
    `;
    
    container.onmouseenter = () => { 
        const ctrls = container.querySelector('.post-controls');
        if(ctrls) ctrls.style.opacity = '1'; 
    };
    container.onmouseleave = () => { 
        const ctrls = container.querySelector('.post-controls');
        if(ctrls) ctrls.style.opacity = '0.6'; 
    };
}


// 5. Renderizar Modo Edi√ß√£o
function renderPostEditMode(container, post) {
    const textToolbarHTML = `
        <div class="post-toolbar" style="margin-bottom:5px;">
            <button onclick="execCmdOnPost('bold')"><b>B</b></button>
            <button onclick="execCmdOnPost('italic')"><i>I</i></button>
            <button onclick="execCmdOnPost('underline')"><u>U</u></button>
        </div>
    `;

    const genericTitleInput = `<input type="text" class="post-title-input" value="${post.title || ''}" placeholder="T√≠tulo do Post..." style="margin-bottom:10px;">`;

    const isEntity = post.type === 'entity' && post.subType !== 'idea';
    const isContainerEditable = isEntity ? "false" : "true";
    const editorStyle = isEntity ? "border:none; background:transparent; padding:0;" : "";

   container.innerHTML = `
    <div class="post-edit-container">
        ${genericTitleInput}
        ${!isEntity ? textToolbarHTML : ''} 
        
        <div class="post-editor-content" contenteditable="${isContainerEditable}" id="editor-${post.id}" style="${editorStyle}">
            ${post.content}
        </div>
        
        <!-- CONTENTOR COM A NOVA CLASSE post-edit-actions -->
        <div class="post-edit-actions">
           <button class="modal-btn" style="background-color: var(--sidebar-color); color: var(--text-color);" 
        onclick="window.openGavetaSelection('${post.id}'); event.stopPropagation();">üìÅ Gaveta</button>
            
            <button class="modal-btn" style="background-color:#c0392b; color:white;" 
                    onclick="deleteArchivePost('${post.id}')">Eliminar</button>
            
            <button class="modal-btn secondary" 
                    onclick="cancelArchiveEdit('${post.id}')">Cancelar</button>
            
            <button class="modal-btn primary" 
                    onclick="saveArchivePost('${post.id}')">Salvar</button>
        </div>
    </div>
`;
    
    // P√ìS-PROCESSAMENTO (IGUAL)
    setTimeout(() => {
        const editorDiv = container.querySelector('.post-editor-content');
        const titleInput = container.querySelector('.post-title-input');

        const startAutoSaveTimer = () => {
            const statusEl = document.getElementById('archive-save-status');
            if(statusEl) statusEl.textContent = "por guardar...";
            currentSaveStatus = 'unsaved'; 
            clearTimeout(archiveAutoSaveTimer);
            archiveAutoSaveTimer = setTimeout(() => { saveCurrentPostInBackground(); }, 180000);
        };

        if (editorDiv) editorDiv.addEventListener('input', startAutoSaveTimer);
        if (titleInput) titleInput.addEventListener('input', startAutoSaveTimer);

        if (isEntity) {
            const toolbar = editorDiv.querySelector('.mini-note-toolbar');
            if (toolbar) toolbar.setAttribute('contenteditable', 'false');
            const innerContent = editorDiv.querySelector('.mini-note-content, .toggle-content');
            if (innerContent) innerContent.setAttribute('contenteditable', 'true');
            const internalInput = editorDiv.querySelector('.mini-note-title-input');
            if (internalInput) {
                internalInput.removeAttribute('readonly');
                if(!internalInput.value) internalInput.focus();
                internalInput.addEventListener('input', startAutoSaveTimer);
            }
       if (!post.title && titleInput) {
                titleInput.focus();
            } else if (editorDiv) {
                editorDiv.focus();
            }
        }
    }, 50);
}

// --- A√á√ïES DO ARQUIVO ---

// A. Bot√£o "Criar Post" Principal
document.getElementById('create-post-btn').addEventListener('click', async () => {
    if (activeEditingPostId) {
        await saveArchivePost(activeEditingPostId);
    }
    document.getElementById('post-type-popup').style.display = 'flex';
});

// B. Escolha: Gerar Texto
document.getElementById('gen-text-btn').addEventListener('click', () => {
    document.getElementById('post-type-popup').style.display = 'none';
    createNewPost('text');
});

// C. Escolha: Gerar Entidade (Abre submenu)
document.getElementById('gen-entity-btn').addEventListener('click', () => {
    document.getElementById('post-type-popup').style.display = 'none';
    document.getElementById('entity-type-popup').style.display = 'flex';
});

// D. Criar a Entidade Espec√≠fica
window.createArchiveEntity = (subType) => {
    document.getElementById('entity-type-popup').style.display = 'none';
    createNewPost('entity', subType);
};

// L√≥gica de Cria√ß√£o de Post Novo
async function createNewPost(type, subType = null) {
    if (!currentArchiveData) return;
    if (!currentArchiveData.posts) currentArchiveData.posts = [];

    const newId = 'post_' + Date.now();
    let initialContent = '';
    let initialTitle = '';
    const authorName = currentUserData?.nome || auth.currentUser.email.split('@')[0];

    const commonToolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Apagar Caixa">üóëÔ∏è</button>
        </div>
    `;

    if (type === 'text') {
        initialTitle = ''; 
        initialContent = '<p><br></p>';
    } 
    else if (type === 'entity') {
        if (subType === 'question') {
            // Usando TEXTAREA para o t√≠tulo da quest√£o
            initialContent = `
                <div class="mini-note-wrapper question-mode" data-topics="{}" data-shared="false" data-box-links="{}" contenteditable="false">
                    <textarea class="mini-note-title-input" placeholder="Pergunta?" rows="1"></textarea>
                    ${commonToolbarHTML}
                    <div class="mini-note-content" contenteditable="true"><p><br></p></div>
                </div>`;
            initialTitle = 'Nova Quest√£o';
        } else if (subType === 'toggle') {
            // Toggles j√° usam H2, que quebra linha naturalmente
            initialContent = `
                <details class="toggle-section" open>
                    <summary>
                        <h2>T√≠tulo Expans√≠vel</h2>
                        <button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content" contenteditable="true"><p><br></p></div>
                </details>`;
            initialTitle = 'Novo T√≠tulo Toggle';
        } else if (subType === 'idea') {
             initialContent = `<div style="padding:10px;"><span class="idea-span" spellcheck="false">Nova Ideia</span></div>`;
             initialTitle = 'Ideia';
        } else {
            const isFree = subType === 'free';
            const cls = isFree ? 'mini-note-wrapper free-mode' : 'mini-note-wrapper';
            // Usando TEXTAREA para Subnota normal
            const titleHTML = isFree ? '' : `<textarea class="mini-note-title-input" placeholder="T√≠tulo..." rows="1"></textarea>`;
            initialContent = `
                <div class="${cls}" data-topics="{}" data-shared="false" data-box-links="{}" contenteditable="false">
                    ${titleHTML}
                    ${commonToolbarHTML}
                    <div class="mini-note-content" contenteditable="true"><p><br></p></div>
                </div>`;
            initialTitle = isFree ? 'Novo Contentor' : 'Nova Subnota';
        }
    }

    const newPost = {
        id: newId,
        type: type,
        subType: subType, 
        title: initialTitle,
        content: initialContent,
        createdBy: authorName,
        createdAt: Date.now(),
        updatedAt: Date.now()
    };

    currentArchiveData.posts.unshift(newPost);
    activeEditingPostId = newId;
    
    renderArchiveFeed();
    
    const feedContainer = document.getElementById('archive-feed');
    if (feedContainer) feedContainer.scrollTop = 0;

    await saveFullArchive();
}

// E. Editar Post
window.editArchivePost = async (postId) => {
    console.log("üîí [LOCK] A tentar bloquear post existente:", postId);

    // 1. Verifica se j√° est√° bloqueado por outro (Seguran√ßa Local)
    if (currentLocks[postId] && currentLocks[postId].userId !== auth.currentUser.uid) {
        alert(`Este post est√° a ser editado por ${currentLocks[postId].userName}.`);
        return;
    }

    // 2. Tenta obter o bloqueio no Firebase (Seguran√ßa Remota)
    const locked = await lockPost(postId);
    if (!locked) {
        alert("N√£o foi poss√≠vel editar este post. Algu√©m pode ter sido mais r√°pido.");
        return;
    }

    // 3. Se j√° estivesse a editar outro, guarda-o
    if (activeEditingPostId && activeEditingPostId !== postId) {
        await saveArchivePost(activeEditingPostId);
    }

    // 4. Ativa modo edi√ß√£o
    activeEditingPostId = postId;
    const postDiv = document.getElementById(`post-${postId}`);
    const postData = currentArchiveData.posts.find(p => p.id === postId);
    
    if (postDiv && postData) {
        renderPostEditMode(postDiv, postData);
    }
};

// F. Salvar Post (Fecha edi√ß√£o)
window.saveArchivePost = async (postId) => {
    console.log(`üíæ [SAVE] Processando: ${postId}`);
    
    // For√ßa a limpeza do estado de edi√ß√£o global
    activeEditingPostId = null;
    window.activeEditingPostId = null;

    const postDiv = document.getElementById(`post-${postId}`);
    
    // Se o post n√£o estiver no DOM, n√£o podemos ler o texto, mas DEVEMOS desbloquear
    if (!postDiv) {
        console.warn(`"‚ö†Ô∏è [SAVE] Post ${postId} j√° n√£o est√° no DOM. Apenas libertando bloqueio.`);
        await unlockPost(postId);
        return;
    }

    const titleInputGeneric = postDiv.querySelector('.post-title-input');
    const contentEditor = postDiv.querySelector('.post-editor-content');

    if (contentEditor && titleInputGeneric) {
        const postIndex = currentArchiveData.posts.findIndex(p => p.id === postId);
        if (postIndex > -1) {
            // Sincroniza√ß√£o de inputs internos
            contentEditor.querySelectorAll('.mini-note-title-input').forEach(t => {
                if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                else t.setAttribute('value', t.value);
            });

            const finalTitle = titleInputGeneric.value.trim() || "Sem T√≠tulo";
            currentArchiveData.posts[postIndex].title = finalTitle;
            currentArchiveData.posts[postIndex].content = contentEditor.innerHTML;
            currentArchiveData.posts[postIndex].updatedAt = Date.now();
            console.log(`üìù [DADOS] T√≠tulo guardado: "${finalTitle}"`);
        }
    }

    // Fecha visualmente o modo edi√ß√£o
    const postData = currentArchiveData.posts.find(p => p.id === postId);
    if (postData) renderPostViewMode(postDiv, postData);

    // Grava tudo no Firebase e remove o cadeado
    await saveFullArchive();
    await unlockPost(postId);
    console.log(`üîì [LOCK] Post ${postId} totalmente libertado.`);
};



// G. Apagar Post
window.deleteArchivePost = async (postId) => {
    if (!confirm("Tem a certeza que deseja apagar este post? (Ficar√° no Hist√≥rico)")) return;

    const postToDelete = currentArchiveData.posts.find(p => p.id === postId);
    if (postToDelete) {
        if (!currentArchiveData.deletedPosts) currentArchiveData.deletedPosts = [];
        currentArchiveData.deletedPosts.unshift({
            ...postToDelete,
            deletedAt: Date.now(),
            deleteReason: 'Post Eliminado'
        });
    }

    currentArchiveData.posts = currentArchiveData.posts.filter(p => p.id !== postId);
    activeEditingPostId = null;
    
    const div = document.getElementById(`post-${postId}`);
    if(div) div.remove();

    await saveFullArchive();
};

// H. Cancelar Edi√ß√£o (Reverter)
window.cancelArchiveEdit = async (postId) => {
    const postDiv = document.getElementById(`post-${postId}`);
    if (!postDiv) return;

    // 1. Para o temporizador de grava√ß√£o autom√°tica
    clearTimeout(archiveAutoSaveTimer);

    // 2. Reseta o estado global de edi√ß√£o
    activeEditingPostId = null;
    currentSaveStatus = 'saved'; 
    
    // 3. Atualiza o status visual no topo
    const statusEl = document.getElementById('archive-save-status');
    if(statusEl) {
        statusEl.textContent = "Edi√ß√£o cancelada";
        setTimeout(() => { 
            if(statusEl.textContent === "Edi√ß√£o cancelada") statusEl.textContent = "Guardado"; 
        }, 2000);
    }

    // 4. Restaura o visual do post
    const originalPost = currentArchiveData.posts.find(p => p.id === postId);
    
    if (originalPost) {
        // Se o post j√° existia, volta a mostrar a vers√£o que est√° na mem√≥ria
        renderPostViewMode(postDiv, originalPost);
    } else {
        // Se era um post NOVO (que nunca foi salvo), removemos o elemento do ecr√£
        postDiv.remove();
        currentArchiveData.posts = currentArchiveData.posts.filter(p => p.id !== postId);
    }

    // 5. O PASSO MAIS IMPORTANTE: Remover o bloqueio no Firebase
    await unlockPost(postId);
    
    console.log(`üîì [SISTEMA] Post ${postId} foi desbloqueado (Cancelado).`);
};

// I. Fun√ß√£o Auxiliar de Comandos (Executa no editor ativo)
window.execCmdOnPost = (command) => {
    if(command === 'boldBlue') {
        document.execCommand('bold', false, null);
        document.execCommand('foreColor', false, '#4a90e2');
    } else {
        document.execCommand(command, false, null);
    }
};

// J. Grava√ß√£o Geral no Firestore
async function saveFullArchive() {
    const statusEl = document.getElementById('archive-save-status');
    statusEl.textContent = "A guardar...";
    
    try {
        const docRef = doc(db, 'pastas', currentArchiveId);
        
        const updateData = {
            posts: currentArchiveData.posts || [],
            deletedPosts: currentArchiveData.deletedPosts || [], 
            ultimaedicao: serverTimestamp()
        };

        await updateDoc(docRef, updateData);
        
        statusEl.textContent = "Guardado";
        statusEl.classList.add('status-saved');
        setTimeout(() => statusEl.classList.remove('status-saved'), 2000);
    } catch (e) {
        console.error("Erro ao gravar arquivo:", e);
        statusEl.textContent = "Erro ao guardar";
        statusEl.classList.add('status-error');
    }
};

// K. Mover Post (Cima/Baixo)
window.moveArchivePost = async (postId, direction) => {
    // direction: -1 (Cima/Recente), 1 (Baixo/Antigo)
    
    const index = currentArchiveData.posts.findIndex(p => p.id === postId);
    if (index === -1) return;

    // Verifica limites
    if (direction === -1 && index === 0) return; // J√° est√° no topo
    if (direction === 1 && index === currentArchiveData.posts.length - 1) return; // J√° est√° no fundo

    const targetIndex = index + direction;

    // Troca no array
    const temp = currentArchiveData.posts[index];
    currentArchiveData.posts[index] = currentArchiveData.posts[targetIndex];
    currentArchiveData.posts[targetIndex] = temp;

    // Atualiza Visual
    renderArchiveFeed();
    
    // Anima√ß√£o/Scroll para acompanhar o post movido
    const movedElement = document.getElementById(`post-${postId}`);
    if (movedElement) {
        movedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Feedback visual tempor√°rio
        movedElement.style.borderColor = 'var(--accent-color)';
        setTimeout(() => movedElement.style.borderColor = 'var(--border-color)', 500);
    }

    // Grava a nova ordem
    await saveFullArchive();
};

// ============================================================
// LISTENER DA TOOLBAR DO ARQUIVO (üîì üìë üïí)
// ============================================================
document.getElementById('archive-toolbar').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    if (action === 'archive-share') {
        e.stopPropagation(); // ‚úã PARA TUDO! N√£o deixa o clique sair daqui
        window.openShareModalForArchive();
    }
    else if (action === 'archive-topics') {
        e.stopPropagation(); 
        openTopicsModal(selectedNoteId, 'arquivo');
    }
    else if (action === 'archive-history') {
        e.stopPropagation(); 
        openArchiveRecycleBin();
    }
});

// Fun√ß√£o Auxiliar para abrir Partilha (C√≥pia adaptada da Nota)
async function openShareModalForArchive() {
    if (!selectedNoteId) return;

    const modal = document.getElementById('note-share-popup');
    if (!modal) return console.error("Modal #note-share-popup n√£o encontrado!");

    // 1. FOR√áA HIERARQUIA (Move para o body e define Z-Index alto)
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8500000"; // Acima do editor e abas
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    try {
        const docRef = doc(db, 'pastas', selectedNoteId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            // Carrega defini√ß√µes existentes ou inicia padr√£o
            currentNoteShareData = data.shareSettings || { shared: false, shareId: null };
            
            // 2. CONFIGURA O TOGGLE DE LEITURA
            const mainToggle = document.getElementById('note-share-toggle');
            mainToggle.checked = currentNoteShareData.shared;

            const linkContainer = document.getElementById('note-share-link-container');
            if (currentNoteShareData.shared) {
                linkContainer.style.display = 'block';
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                const shareId = currentNoteShareData.shareId || selectedNoteId;
                document.getElementById('note-share-url').value = `${baseUrl}/sharenote.html?id=${shareId}`;
            } else {
                linkContainer.style.display = 'none';
            }

            // 3. CONFIGURA SEC√á√ÉO DE COLABORA√á√ÉO (Apenas para Arquivos)
            const collabSection = document.getElementById('archive-collab-section');
            if ((data.tipo === 'arquivo' || data.tipo === 'partilhado') && currentViewMode === 'shared') {
                collabSection.style.display = 'block';
                const collabToggle = document.getElementById('collab-share-toggle');
                collabToggle.checked = (data.partilhado === "ativo");
                
                const collabLinkContainer = document.getElementById('collab-share-link-container');
                if (data.partilhado === "ativo") {
                    collabLinkContainer.style.display = 'block';
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                    document.getElementById('collab-share-url').value = `${baseUrl}/note.html?openArchive=${selectedNoteId}&mode=collab`;
                } else {
                    collabLinkContainer.style.display = 'none';
                }
            } else {
                collabSection.style.display = 'none';
            }
        }
    } catch (err) {
        console.error("Erro ao carregar dados de partilha:", err);
    }
}

// --- ADICIONE ESTE LISTENER NO FINAL DO SCRIPT (Para o novo Toggle de Colabora√ß√£o) ---

const collabShareToggle = document.getElementById('collab-share-toggle');
if (collabShareToggle) {
    collabShareToggle.addEventListener('change', async () => {
        if (!selectedNoteId || !auth.currentUser) return;

        const isCollabActive = collabShareToggle.checked;
        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        try {
            const updateData = {
                "partilhado": isCollabActive ? "ativo" : "inativo",
                "ultimaedicao": serverTimestamp()
            };

            await updateDoc(noteRef, updateData);

            // Atualiza a interface
            const collabLinkContainer = document.getElementById('collab-share-link-container');
            collabLinkContainer.style.display = isCollabActive ? 'block' : 'none';
            
            if (isCollabActive) {
                const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                document.getElementById('collab-share-url').value = `${baseUrl}/note.html?openArchive=${selectedNoteId}&mode=collab`;
            }
        } catch (e) {
            console.error("‚ùå Erro ao atualizar colabora√ß√£o:", e);
        }
    });
}

// ============================================================
// DELEGA√á√ÉO DE EVENTOS PARA O ARQUIVO (Para bot√µes funcionarem)
// ============================================================
const archiveFeed = document.getElementById('archive-feed');

if (archiveFeed) {
    archiveFeed.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        const toggleColorBtn = e.target.closest('.toggle-color-btn');

        // --- 1. Bot√£o de Cor (üé®) ---
        if (btn && btn.dataset.action === 'highlight-color') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
            if (wrapper) openHighlightPopup(wrapper);
            return;
        }

        // --- 2. Bot√£o de T√≥picos (üìã) ---
        if (btn && btn.dataset.action === 'manage-mini-note-topics') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openTopicsModalForMiniNote(wrapper);
            return;
        }

        // --- 3. Bot√£o de Links (‚ö°) ---
        if (btn && btn.dataset.action === 'manage-box-links') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openBoxLinkManager(wrapper);
            return;
        }

        // --- 4. Bot√£o de Cor do Toggle (üñåÔ∏è) ---
        if (toggleColorBtn) {
            e.preventDefault(); e.stopPropagation();
            activeToggleForColor = toggleColorBtn.closest('details.toggle-section');
            const rect = toggleColorBtn.getBoundingClientRect();
            const popup = document.getElementById('toggle-color-popup');
            popup.style.display = 'block';
            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popup.style.left = `${(rect.left + window.scrollX) - 100}px`;
            return;
        }

        // --- 5. Bot√£o Enviar para Nota (üß¨) ---
        if (btn && btn.dataset.action === 'append-mini-note') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) {
                htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
                openAppendModal();
            }
            return;
        }
        
        // --- 6. ELIMINAR ENTIDADE (üóëÔ∏è) -> IGUAL A ELIMINAR POST ---
        if (btn && btn.dataset.action === 'delete-mini-note') {
            e.preventDefault(); e.stopPropagation();
            
            // Identifica o Post Pai
            const postDiv = btn.closest('.archive-post');
            const postId = postDiv ? postDiv.dataset.id : null;
            
            if (postId) {
                // Chama a fun√ß√£o principal de eliminar.
                // Isto faz tudo automaticamente: 
                // 1. Pede confirma√ß√£o
                // 2. Move para a Reciclagem (üïí)
                // 3. Remove o post do ecr√£
                // 4. Grava na base de dados
                deleteArchivePost(postId);
            }
            return;
        }
    });
}

// ============================================================
// GEST√ÉO DA RECICLAGEM DO ARQUIVO
// ============================================================

function openArchiveRecycleBin() {
    console.log("üïí [SISTEMA] A abrir Reciclagem do Arquivo...");
    
    const modal = document.getElementById('history-modal');
    const titleEl = document.getElementById('history-modal-title');
    const listEl = document.getElementById('history-list-content');
    const backupBtn = document.getElementById('backup-now-btn');

    if (!modal) return console.error("Modal #history-modal n√£o encontrado!");

    // --- TRUQUE DE CAMADA (Z-INDEX) ---
    // Move o modal para a raiz do body para ele n√£o ficar escondido
    document.body.appendChild(modal);
    
    // For√ßa a visibilidade total
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999"; 
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Configurar o T√≠tulo do Modal
    if (titleEl) titleEl.textContent = "Hist√≥rico & Reciclagem";
    
    // Esconde o bot√£o de backup manual (que √© para notas normais)
    if (backupBtn) backupBtn.style.display = 'none'; 
    
    listEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar itens eliminados...</span></div>';

    // Carregar os dados
    const deletedItems = currentArchiveData.deletedPosts || [];

    if (deletedItems.length === 0) {
        listEl.innerHTML = '<li style="padding:15px; color:#888; text-align:center;">A reciclagem est√° vazia.</li>';
        return;
    }

    // Ordenar por data (mais recente primeiro)
    const sortedItems = [...deletedItems].sort((a, b) => b.deletedAt - a.deletedAt);

    listEl.innerHTML = '';
    sortedItems.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'list-item';
        li.style.flexDirection = 'column';
        li.style.alignItems = 'flex-start';
        li.style.borderBottom = '1px solid var(--border-color)';
        li.style.padding = '10px';
        li.style.backgroundColor = 'rgba(255,255,255,0.02)';
        li.style.marginBottom = '5px';

        const dateStr = new Date(item.deletedAt).toLocaleString();
        const icon = item.deleteReason?.includes('Limpo') ? 'üßπ' : 'üóëÔ∏è';

        li.innerHTML = `
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <strong style="color:var(--text-color);">${item.title || 'Sem T√≠tulo'}</strong>
                <span style="font-size:0.7em; background:#c0392b; color:white; padding:2px 6px; border-radius:4px;">${icon} ELIMINADO</span>
            </div>
            <div style="font-size:0.8em; color:var(--text-muted-color); margin-top:5px;">
                ${dateStr}
            </div>
            <div style="margin-top:10px; width:100%; display:flex; justify-content:flex-end;">
                <button class="modal-btn primary" onclick="restoreArchiveItem(${index})" style="padding:5px 15px; font-size:0.85em;">Restaurar</button>
            </div>
        `;
        listEl.appendChild(li);
    });
}

// Fun√ß√£o para Restaurar Item
window.restoreArchiveItem = async (index) => {
    // 1. Organiza a lixeira para garantir que o √≠ndice est√° correto
    const deletedItems = currentArchiveData.deletedPosts.sort((a, b) => b.deletedAt - a.deletedAt);
    const itemToRestore = deletedItems[index];

    if (!itemToRestore) return;

    if (confirm(`Deseja restaurar "${itemToRestore.title}" para o topo do feed?`)) {
        
        // 2. Remove da lista de eliminados (mem√≥ria local)
        const realIndex = currentArchiveData.deletedPosts.indexOf(itemToRestore);
        if (realIndex > -1) {
            currentArchiveData.deletedPosts.splice(realIndex, 1);
        }

        // 3. Limpa os dados de elimina√ß√£o e prepara o post
        const restoredPost = { ...itemToRestore };
        delete restoredPost.deletedAt;
        delete restoredPost.deleteReason;
        
        // Define a data de atualiza√ß√£o como "agora" para ele subir no feed
        restoredPost.updatedAt = Date.now();

        // 4. Insere no in√≠cio do feed ativo (mem√≥ria local)
        if (!currentArchiveData.posts) currentArchiveData.posts = [];
        currentArchiveData.posts.unshift(restoredPost);

        // 5. Fecha o modal de hist√≥rico
        document.getElementById('history-modal').style.display = 'none';

        // 6. Atualiza a interface visualmente
        renderArchiveFeed();
        
        // 7. GRAVA√á√ÉO NO FIREBASE
        // Primeiro salvamos o estado do arquivo
        await saveFullArchive();
        
        // GARANTIA: Removemos qualquer bloqueio (lock) que pudesse existir para este ID
        // Assim o post volta totalmente livre para qualquer um clicar em "Editar"
        await unlockPost(itemToRestore.id);

        console.log(`‚ôªÔ∏è Post ${itemToRestore.id} restaurado e desbloqueado.`);
        
        // Feedback visual: faz scroll at√© ao post restaurado (que agora est√° no topo)
        document.getElementById('archive-feed').scrollTop = 0;
    }
};

// Listener para Grava√ß√£o Manual no Status do Arquivo
const archiveStatus = document.getElementById('archive-save-status');
if (archiveStatus) {
    archiveStatus.addEventListener('click', () => {
        if (activeEditingPostId) {
            saveCurrentPostInBackground();
        }
    });
}


// Listener para Gravar T√≠tulo do Arquivo (Renomear)
const archiveTitleInput = document.getElementById('archive-title-input');
if (archiveTitleInput) {
    let titleTimer = null;
    
    archiveTitleInput.addEventListener('input', () => {
        // Mostra estado visual
        const statusEl = document.getElementById('archive-save-status');
        if(statusEl) statusEl.textContent = "por guardar...";
        currentSaveStatus = 'unsaved';

        // Debounce para n√£o gravar a cada tecla
        clearTimeout(titleTimer);
        titleTimer = setTimeout(async () => {
            const newName = archiveTitleInput.value.trim();
            if (newName && currentArchiveId) {
                try {
                    const docRef = doc(db, 'pastas', currentArchiveId);
                    await updateDoc(docRef, { 
                        nome: newName,
                        ultimaedicao: serverTimestamp()
                    });
                    
                    // Atualiza visualmente na lista lateral se poss√≠vel
                    const listItem = document.querySelector(`.list-item[data-id="${currentArchiveId}"] span`);
                    if (listItem) {
                        // Mant√©m o √≠cone e atualiza o texto
                        const icon = listItem.textContent.split(' ')[0]; 
                        listItem.textContent = `${icon} ${newName}`;
                    }

                    if(statusEl) {
                        statusEl.textContent = "Guardado";
                        statusEl.classList.add('status-saved');
                        setTimeout(() => statusEl.classList.remove('status-saved'), 2000);
                    }
                    currentSaveStatus = 'saved';
                } catch (e) {
                    console.error("Erro ao renomear arquivo:", e);
                }
            }
        }, 1000); // Grava 1 segundo depois de parar de escrever
    });
}

// ============================================================
// MOTOR DE COLABORA√á√ÉO REAL-TIME
// ============================================================

// 1. Ouvir mudan√ßas no documento (Locks e Conte√∫do)
function initRealtimeCollab(docId) {
    const docRef = doc(db, 'pastas', docId);

    collabUnsubscribe = onSnapshot(docRef, (docSnap) => {
        if (!docSnap.exists()) return;

        const newData = docSnap.data();
        currentLocks = newData.locks || {};
        applyVisualLocks();

        // --- REAVALIA√á√ÉO DE SEGURAN√áA DO CADEADO EM TEMPO REAL ---
        const shareBtn = document.querySelector('button[data-action="archive-share"]');
        if (shareBtn) {
            const isOwner = newData.userId === auth.currentUser.uid;
            const isSharedType = (newData.tipo === 'partilhado');
            
            if (isSharedType && !isOwner) {
                shareBtn.style.display = 'none';
            } else {
                shareBtn.style.display = 'block';
            }
        }
        // -------------------------------------------------------

        if (!activeEditingPostId) {
            currentArchiveData.posts = newData.posts;
            renderArchiveFeed();
            applyVisualLocks();
        }
    });
}

// 2. Sistema de Presen√ßa (Heartbeat)
async function initPresenceSystem(docId) {
    if (!auth.currentUser || !docId) return;

    const userId = auth.currentUser.uid;
    const userName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
    
    // Refer√™ncia para o meu estado dentro deste Arquivo espec√≠fico
    const myPresenceRef = doc(db, 'pastas', docId, 'collaborators', userId);

    // 1. FUN√á√ÉO HEARTBEAT: Avisa o Firebase que eu estou aqui
    const sendHeartbeat = async () => {
        try {
            await setDoc(myPresenceRef, {
                name: userName,
                lastSeen: serverTimestamp(),
                activeIn: docId // Garante o v√≠nculo com este arquivo
            }, { merge: true });
        } catch (e) {
            console.warn("Erro ao enviar batimento de presen√ßa:", e);
        }
    };

    // Envia o primeiro sinal mal entra
    await sendHeartbeat();

    // Configura o batimento para cada 45 segundos (mais frequente para ser mais preciso)
    if (presenceInterval) clearInterval(presenceInterval);
    presenceInterval = setInterval(sendHeartbeat, 45000);

    // 2. OUVIR COLABORADORES: Quem mais est√° a ver este ficheiro agora?
    const colRef = collection(db, 'pastas', docId, 'collaborators');
    
    collabUnsubscribe = onSnapshot(colRef, (snapshot) => {
        const listDiv = document.getElementById('active-users-list');
        const barDiv = document.getElementById('collab-bar');
        
        if (!listDiv || !barDiv) return;
        
        listDiv.innerHTML = '';
        const now = Date.now();
        let otherUsersCount = 0;

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const isMe = (docSnap.id === userId);
            
            // Calcula h√° quanto tempo o utilizador foi visto
            // (Usa Date.now() como fallback enquanto o timestamp do servidor n√£o chega)
            const lastSeenTime = data.lastSeen ? data.lastSeen.toMillis() : now;
            
            // REGRA: S√≥ conta como "Online" se foi visto nos √∫ltimos 90 segundos
            const isOnline = (now - lastSeenTime < 90000);

            if (isOnline) {
                // Se for outra pessoa, incrementamos o contador
                if (!isMe) otherUsersCount++;

                // Criar o c√≠rculo visual (Bubble)
                const bubble = document.createElement('div');
                bubble.className = 'user-presence-bubble';
                bubble.textContent = data.name.charAt(0).toUpperCase();
                bubble.title = data.name + (isMe ? " (Voc√™)" : "");
                
                // Estilos din√¢micos
                if (isMe) {
                    bubble.style.backgroundColor = "var(--sidebar-color)";
                    bubble.style.border = "2px solid var(--accent-color)";
                    bubble.style.color = "var(--accent-color)";
                } else {
                    // Fun√ß√£o stringToColor gera uma cor √∫nica baseada no nome
                    bubble.style.backgroundColor = stringToColor(data.name);
                    bubble.style.color = "white";
                }
                
                listDiv.appendChild(bubble);
            }
        });

        // REGRAS DE VISIBILIDADE DA BARRA:
        // A barra (Online: [A][B]) s√≥ aparece se houver PELO MENOS uma pessoa al√©m de mim.
        if (otherUsersCount > 0) {
            barDiv.style.display = 'flex';
        } else {
            barDiv.style.display = 'none';
        }

    }, (error) => {
        console.error("Erro ao monitorizar presen√ßa:", error);
    });
}

// 3. Aplicar Bloqueios Visuais (CSS)
function applyVisualLocks() {
    const myUserId = auth.currentUser.uid;

    // 1. LIMPEZA: Remove bloqueios de todos os posts primeiro
    document.querySelectorAll('.archive-post').forEach(postDiv => {
        postDiv.classList.remove('is-locked');
        postDiv.style.opacity = "1";
        postDiv.style.pointerEvents = "auto";
        const badge = postDiv.querySelector('.locked-badge');
        if (badge) badge.remove();
        
        const editBtn = postDiv.querySelector('.post-edit-btn');
        if (editBtn) {
            editBtn.disabled = false;
            editBtn.style.display = "flex";
        }
    });

    // 2. APLICA√á√ÉO: Percorre a lista de locks do Firebase
    if (!currentLocks) return;

    Object.entries(currentLocks).forEach(([postId, lockData]) => {
        // S√≥ aplica se o lock N√ÉO for meu
        if (lockData.userId !== myUserId) {
            
            // Procura o elemento no HTML
            const postDiv = document.getElementById(`post-${postId}`);
            
            if (postDiv) {
                postDiv.classList.add('is-locked');
                postDiv.style.opacity = "0.5";
                postDiv.style.pointerEvents = "none";

                // Badge vermelha
                if (!postDiv.querySelector('.locked-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'locked-badge';
                    badge.innerHTML = `üîí ${lockData.userName} est√° a editar...`;
                    badge.style.cssText = "position:absolute; top:-10px; right:10px; background:#e74c3c; color:white; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:bold; z-index:100; box-shadow:0 2px 5px rgba(0,0,0,0.3);";
                    postDiv.appendChild(badge);
                }

                const editBtn = postDiv.querySelector('.post-edit-btn');
                if (editBtn) editBtn.style.display = "none";
            }
        }
    });
}

// 4. Bloquear Post (Chamar ao clicar em Editar)
async function lockPost(postId) {
    if (!currentArchiveId) {
        console.error("‚ùå Erro: ID do Arquivo n√£o encontrado para bloquear.");
        return false;
    }

    const docRef = doc(db, 'pastas', currentArchiveId);
    const myName = currentUserData?.nome || auth.currentUser.email.split('@')[0];

    try {
        // Grava no campo 'locks' do documento pai
        await updateDoc(docRef, {
            [`locks.${postId}`]: {
                userId: auth.currentUser.uid,
                userName: myName,
                timestamp: Date.now()
            }
        });
    
        return true;
    } catch (e) {
        console.error("‚ùå Erro ao enviar bloqueio:", e);
        return false;
    }
}

async function unlockPost(postId) {
    if (!currentArchiveId) return;
    
    const docRef = doc(db, 'pastas', currentArchiveId);
    
    try {
        // Remove a entrada do objeto 'locks' no Firebase
        await updateDoc(docRef, {
            [`locks.${postId}`]: deleteField()
        });
        console.log(`üîì [SISTEMA] Cadeado removido de: ${postId}`);
    } catch (e) {
        console.error("‚ùå [ERRO] Falha ao remover cadeado na sa√≠da:", e);
    }
}

// --- L√ìGICA DO BOT√ÉO VOLTAR NO ARQUIVO (MOBILE) ---
const archiveBackBtn = document.getElementById('archive-back-btn');
if (archiveBackBtn) {
    archiveBackBtn.addEventListener('click', async () => {
        // 1. Sai da presen√ßa em tempo real (Colabora√ß√£o)
        await leaveArchivePresence();

        // 2. Grava o post se houver algum em edi√ß√£o
        if (activeEditingPostId) {
            await saveArchivePost(activeEditingPostId);
        }

        // 3. Troca as vistas Mobile (Esconde Arquivo, Mostra Lista)
        const container = document.querySelector('.notebook-container');
        if (container) container.classList.remove('middle-panel-collapsed');
        
        document.body.classList.remove('mobile-view-editor');
        document.body.classList.add('mobile-view-middle');

        // 4. Limpa estados de sele√ß√£o
        selectedNoteId = null;
        activeEditingPostId = null;

        // 5. ATUALIZA OS BOT√ïES FLUTUANTES
        updateMobileFABVisibility();
    });
}

// --- DIAGN√ìSTICO DE LAYOUT (DEBUG) ---
window.debugMobileLayout = function() {
    console.group("üïµÔ∏è DEBUG VISUAL MOBILE");
    
    const rightPanel = document.getElementById('right-panel');
    const rightStyle = window.getComputedStyle(rightPanel);
    

    Array.from(rightPanel.children).forEach(child => {
        const style = window.getComputedStyle(child);
        if (style.display !== 'none') {
        } else {
        }
    });
    console.groupEnd();
};

// Executa automaticamente se estivermos a ver o arquivo
setInterval(() => {
    if (document.getElementById('archive-area').style.display !== 'none' && window.innerWidth < 768) {
        // Descomente a linha abaixo apenas se quiser ver o log repetidamente
        // window.debugMobileLayout();
    }
}, 5000);

// Fun√ß√£o para sair formalmente da presen√ßa do Arquivo
async function leaveArchivePresence() {
    // 1. Para o "cora√ß√£o" (heartbeat)
    if (presenceInterval) {
        clearInterval(presenceInterval);
        presenceInterval = null;
    }

    // 2. Desliga o ouvinte de quem est√° online
    if (collabUnsubscribe) {
        collabUnsubscribe();
        collabUnsubscribe = null;
    }

    // 3. Remove o meu rasto do Firebase (se eu estiver num arquivo)
    if (currentArchiveId && auth.currentUser) {
        try {
            const myUid = auth.currentUser.uid;
            const presenceRef = doc(db, 'pastas', currentArchiveId, 'collaborators', myUid);
            await deleteDoc(presenceRef);
        } catch (e) {
            console.warn("Erro ao limpar presen√ßa:", e);
        }
    }

    // 4. Limpa e esconde a barra visualmente
    const barDiv = document.getElementById('collab-bar');
    const listDiv = document.getElementById('active-users-list');
    if (barDiv) barDiv.style.display = 'none';
    if (listDiv) listDiv.innerHTML = '';
}

// Fun√ß√£o Mestra para garantir que NADA no notebook est√° selecionado visualmente
function clearAllListSelections() {
    // Agora limpamos apenas a Coluna 2. 
    // A Coluna 1 √© gerida automaticamente pelo onSnapshot + col1SelectedId
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });
    console.log("üßπ [SISTEMA] Sele√ß√£o visual da Coluna 2 limpa.");
}

// === GEST√ÉO DE GAVETAS (ADICIONAR NO FIM DO SCRIPT) ===


// 1. Alternar entre Prateleira e Gavet√£o
document.querySelectorAll('.archive-tab-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const targetTab = btn.dataset.archiveTab;
        console.group(`üîÑ [TRANSICAO] Indo para: ${targetTab}`);

        // A. AUTO-SAVE (Mesma l√≥gica robusta anterior)
        const idToSave = activeEditingPostId || window.activeEditingPostId;
        if (idToSave) { 
            console.log(`%c‚ö†Ô∏è [AUTO-SAVE] Gravando post ${idToSave} antes de mudar de aba...`, "color: #e67e22; font-weight: bold;");
            const tempId = idToSave;
            activeEditingPostId = null;
            window.activeEditingPostId = null;
            await window.saveArchivePost(tempId);
        }

        // B. L√ìGICA DE NAVEGA√á√ÉO: SE CLICOU NA PRATELEIRA, SAI DA GAVETA
        if (targetTab === 'prateleira') {
            if (window.activeGavetaId) {
                console.log(`%cüìÇ [RESET] Limpando activeGavetaId (${window.activeGavetaId}) para mostrar feed completo.`, "color: #3498db;");
                window.activeGavetaId = null;
                window.activeGavetaData = null;
            }
        }

        // C. Atualiza√ß√£o Visual das Abas
        document.querySelectorAll('.archive-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentArchiveTab = targetTab;
        
        const postBtn = document.getElementById('create-post-btn');
        const drawerBtn = document.getElementById('create-drawer-trigger-btn');
        if (currentArchiveTab === 'prateleira') {
            postBtn.style.display = 'block';
            drawerBtn.style.display = 'none';
        } else {
            postBtn.style.display = 'none';
            drawerBtn.style.display = 'block';
        }

        // D. RENDERIZA√á√ÉO FINAL
        console.log(`üé¨ [RENDER] Desenhando feed para: ${currentArchiveTab}`);
        renderArchiveFeed();
        console.groupEnd();
    });
});






// 3. Editar Gavet√£o
window.openEditDrawerModal = (id, nome, desc) => {
    const modal = document.getElementById('create-drawer-modal');
    const titleEl = modal.querySelector('h3');
    const nameInput = document.getElementById('new-drawer-name');
    const descInput = document.getElementById('new-drawer-desc');
    const confirmBtn = document.getElementById('confirm-create-drawer');

    if (!modal) return;

    // 1. CONFIGURA√á√ÉO VISUAL DO MODAL PARA EDI√á√ÉO
    titleEl.textContent = "Editar Gavet√£o";
    nameInput.value = nome;
    descInput.value = desc === 'undefined' ? "" : desc; // Limpa se vier como string 'undefined'
    confirmBtn.textContent = "Gravar Altera√ß√µes";

    // 2. LIMPEZA DE LISTENERS ANTIGOS (Muito importante!)
    // Clonamos o bot√£o para garantir que a fun√ß√£o de "Criar" n√£o seja disparada por engano
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    // 3. L√ìGICA DE ATUALIZA√á√ÉO NO FIREBASE
    newConfirmBtn.onclick = async (e) => {
        e.preventDefault();
        
        const novoNome = nameInput.value.trim();
        if (!novoNome) return alert("O nome do gavet√£o √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A guardar...";

        try {
            // Importa√ß√£o din√¢mica por seguran√ßa
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const drawerRef = doc(db, 'gavetoes', id);
            
            await updateDoc(drawerRef, {
                nome: novoNome,
                descricao: descInput.value.trim(),
                ultimaEdicao: Date.now()
            });

            // 4. SUCESSO: FECHAR E RESETAR
            modal.style.display = 'none';
            
            // Restaura o t√≠tulo padr√£o do modal para a pr√≥xima vez que for usado para criar
            titleEl.textContent = "Criar Gavet√£o";
            
            if (typeof renderArchiveFeed === 'function') {
                renderArchiveFeed();
            }

        } catch (error) {
            console.error("‚ùå [ERRO] Falha ao editar gavet√£o:", error);
            alert("Ocorreu um erro ao gravar as altera√ß√µes.");
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gravar Altera√ß√µes";
        }
    };

    // 5. MOSTRAR O MODAL (Com refor√ßo de Z-Index)
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "99999";
    
    setTimeout(() => nameInput.focus(), 150);
};






// 2. Aplicar o Estilo e Fechar
window.applyColorStyle = function(command, color) {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    if (typeof currentSelectionRange !== 'undefined' && currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    }

    document.execCommand(command, false, null);
    document.execCommand('foreColor', false, color);
    
    if (typeof saveNote === 'function') saveNote();

    // Fecha e limpa o estado do bot√£o
    formattingPopup.style.display = 'none';
    formattingBtn.classList.remove('active'); 
};

// 3. Fechar se clicar fora
document.addEventListener('click', (e) => {
    const sharePop = document.getElementById('note-share-popup');
    
    // 1. Fechar Context Menu
    if (!e.target.closest('.context-menu')) hideContextMenu();

    // 2. L√≥gica do Popup de Partilha (Ajustada)
    if (sharePop && sharePop.style.display === 'flex') {
        // Se o clique N√ÉO foi dentro do popup E N√ÉO foi nos bot√µes de abrir partilha...
        if (!sharePop.contains(e.target) && 
            !e.target.closest('button[data-action="note-sharing-settings"]') && 
            !e.target.closest('button[data-action="archive-share"]')) {
            
            console.log("üßπ Fechando partilha por clique fora.");
            sharePop.style.display = 'none';
        }
    }

    // 3. Fechar Formatting Popup
    const fPopup = document.getElementById('formatting-popup');
    const fBtn = document.getElementById('more-formatting-btn');
    if (fPopup && fPopup.style.display === 'block') {
        if (!fPopup.contains(e.target) && e.target !== fBtn) {
            fPopup.style.display = 'none';
            if (fBtn) fBtn.classList.remove('active');
        }
    }
});


// --- L√ìGICA EXPORTAR SENTINELA ü§ñ ---

let detectedQuestions = [];

window.openRobotModal = function() {
    const modal = document.getElementById('robot-modal');
    if (!modal) return;

    // 1. Esconde o menu de cores
    document.getElementById('formatting-popup').style.display = 'none';
    document.getElementById('more-formatting-btn').classList.remove('active');

    // 2. Limpa os campos do rob√¥
    document.getElementById('robot-input-text').value = '';
    document.getElementById('robot-preview-container').style.display = 'none';
    document.getElementById('robot-insert-btn').style.display = 'none';
    document.getElementById('robot-input-container').style.display = 'block';
    detectedQuestions = [];

    // 3. FOR√áA O MODAL PARA O TOPO E MOSTRA
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";
};

// Fun√ß√£o para Gerar/Detetar Perguntas
document.getElementById('robot-generate-btn').addEventListener('click', () => {
    const rawText = document.getElementById('robot-input-text').value;
    if (!rawText.trim()) return alert("Cole o texto primeiro.");

    detectedQuestions = []; // Array de objetos { type: 'header' | 'question', text: '...' }
    
    // 1. IDENTIFICAR SE√á√ÉO DE RECAPITULA√á√ÉO (QUAL √â A SUA RESPOSTA?)
    const recapMarkers = ["QUAL √â A SUA RESPOSTA?", "COMO RESPONDERIA?"];
    let mainBody = rawText;
    let recapBody = "";

    recapMarkers.forEach(marker => {
        if (rawText.toUpperCase().includes(marker)) {
            const index = rawText.toUpperCase().indexOf(marker);
            mainBody = rawText.substring(0, index);
            recapBody = rawText.substring(index);
        }
    });

    // 2. FASE 1: PROCESSAR CORPO PRINCIPAL (Perguntas numeradas)
    const mainParts = mainBody.split(/(?:As|A) (?:vossas?|suas?) respostas?/i);
    for (let i = 0; i < mainParts.length - 1; i++) {
        let block = mainParts[i].trim();
        const lastNumberMatch = block.match(/\d+(?:-\d+)?\.\s+/g);
        if (lastNumberMatch) {
            const lastMatch = lastNumberMatch[lastNumberMatch.length - 1];
            const startIndex = block.lastIndexOf(lastMatch);
            let questionLine = block.substring(startIndex).trim();

            if (questionLine.includes('(a)') && questionLine.includes('(b)')) {
                const subParts = questionLine.split(/(?=\([b-z]\))/);
                subParts.forEach(sp => {
                    if (sp.trim()) detectedQuestions.push({ type: 'question', text: sp.trim() });
                });
            } else {
                detectedQuestions.push({ type: 'question', text: questionLine });
            }
        }
    }

    // 3. FASE 2: PROCESSAR RECAPITULA√á√ÉO
    if (recapBody) {
        // Extrair o t√≠tulo (ex: QUAL √â A SUA RESPOSTA?)
        const titleMatch = recapBody.match(/(QUAL √â A SUA RESPOSTA\?|COMO RESPONDERIA\?)/i);
        if (titleMatch) {
            detectedQuestions.push({ type: 'header', text: titleMatch[0] });
        }

        // Isolar apenas at√© chegar ao C√ÇNTICO ou notas finais
        const recapLimit = recapBody.split(/C√ÇNTICO|Veja o quadro|Por exemplo, veja/i)[0];
        
        // Procurar frases que terminam em "?" seguidas por "A sua resposta"
        const recapParts = recapLimit.split(/(?:As|A) (?:vossas?|suas?) respostas?/i);
        recapParts.forEach(part => {
            const lines = part.trim().split('\n');
            const lastLine = lines[lines.length - 1].trim();
            if (lastLine.endsWith('?')) {
                detectedQuestions.push({ type: 'question', text: lastLine });
            }
        });
    }

    // 4. RENDERIZAR PR√â-VISUALIZA√á√ÉO
    const list = document.getElementById('preview-list');
    list.innerHTML = '';
    
    if (detectedQuestions.length > 0) {
        detectedQuestions.forEach((item, index) => {
            const li = document.createElement('li');
            if (item.type === 'header') {
                li.style.cssText = "margin: 15px 0 5px 0; padding: 5px; color: #4a90e2; font-weight: bold; border-bottom: 1px solid #333; list-style: none;";
                li.innerHTML = `üìå ${item.text}`;
            } else {
                li.style.cssText = "margin-bottom: 8px; padding: 10px; background: rgba(46, 204, 113, 0.1); border-left: 4px solid #2ecc71; border-radius: 4px; color: #f0f0f0; font-size: 13px;";
                li.innerHTML = item.text;
            }
            list.appendChild(li);
        });

        document.getElementById('preview-count').textContent = `Detetados ${detectedQuestions.filter(i => i.type==='question').length} itens:`;
        document.getElementById('robot-preview-container').style.display = 'block';
        document.getElementById('robot-insert-btn').style.display = 'block';
    } else {
        alert("Nenhuma pergunta encontrada.");
    }
});



// Fun√ß√£o para Inserir as Perguntas no Editor
document.getElementById('robot-insert-btn').addEventListener('click', () => {
    const editor = document.getElementById('note-content-editor');
    
    const toolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Remover">üóëÔ∏è</button>
        </div>`;

    let fullHTML = "";
    let firstItemId = null; // Guardar√° o ID do primeiro item para o scroll

    detectedQuestions.forEach((item, index) => {
        // Criamos um ID √∫nico para este item
        const uniqueId = `sentinela_${Date.now()}_${index}`;
        
        // Se for o primeiro item da lista (header ou quest√£o), guardamos o ID
        if (index === 0) firstItemId = uniqueId;

        if (item.type === 'header') {
            // T√≠tulo de se√ß√£o
            fullHTML += `<p id="${uniqueId}"><br></p><p><strong>${item.text}</strong></p>`;
        } else {
            // Caixa de Quest√£o
    fullHTML += `
    <div class="mini-note-wrapper question-mode" id="${uniqueId}">
        <textarea class="mini-note-title-input" rows="1">${item.text}</textarea>
        ${toolbarHTML}
        <div class="mini-note-content" contenteditable="true">
            <p><br></p>
        </div>
    </div><p><br></p>`;
        }
    });

    // 1. Inser√ß√£o no Editor
    if (typeof currentSelectionRange !== 'undefined' && currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    } else {
        editor.focus();
    }

    document.execCommand('insertHTML', false, fullHTML);
    
    // 2. L√≥gica de Scroll para o Topo (com um pequeno delay para o browser renderizar o HTML)
    setTimeout(() => {
        if (firstItemId) {
            const firstEl = document.getElementById(firstItemId);
            if (firstEl) {
                // Scroll suave para o primeiro item inserido
                firstEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }, 150);

    // 3. Finaliza√ß√£o
    document.getElementById('robot-modal').style.display = 'none';
    if (typeof saveNote === 'function') saveNote();
    if (typeof fixLegacyMiniNotes === 'function') fixLegacyMiniNotes();
});




document.getElementById('append-back-btn').onclick = () => {
    const pathLabel = document.getElementById('append-current-path').textContent;
    
    if (pathLabel === "ü§ù Partilha") {
        // Se estiver na raiz da partilha, volta para a Raiz Global
        loadAppendList(null);
    } else if (appendStack.length > 0) {
        appendStack.pop();
        const prevId = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : null;
        loadAppendList(prevId);
    } else {
        loadAppendList(null);
    }
};

function applyTitleWrappingEffect() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    const allTitles = editor.querySelectorAll('.mini-note-title-input');
    
    allTitles.forEach(t => {
        // Se ainda for um INPUT, converte para TEXTAREA (necess√°rio para quebra de linha)
        if (t.tagName === 'INPUT') {
            const textarea = document.createElement('textarea');
            textarea.className = t.className;
            // Pega o valor do atributo value ou do valor atual
            textarea.value = t.getAttribute('value') || t.value || ""; 
            textarea.placeholder = t.placeholder || "";
            textarea.setAttribute('spellcheck', 'false');
            if (t.readOnly) textarea.readOnly = true;
            t.parentNode.replaceChild(textarea, t);
            t = textarea; 
        }

        if (appSettings && appSettings.showFullTitles === true) {
            t.classList.add('wrap-enabled');
            t.style.whiteSpace = "pre-wrap";
            t.style.overflow = "hidden";
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
            
            t.oninput = function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                // Sincroniza o textContent para o save n√£o falhar
                this.textContent = this.value; 
            };
        } else {
            t.classList.remove('wrap-enabled');
            t.style.whiteSpace = "nowrap";
            t.style.height = ""; 
            t.style.overflow = "hidden";
            t.oninput = null;
        }
    });
}

// Fun√ß√£o auxiliar para garantir que o campo cresce com o texto
function autoResizeTitle(el) {
    if (!el) return;
    
    // Se a configura√ß√£o estiver desligada, n√£o for√ßamos o ajuste
    if (!appSettings.showFullTitles) {
        el.style.height = ""; 
        return;
    }

    // Reset para calcular o scrollHeight real
    el.style.height = 'auto';
    
    // Define a altura baseada no conte√∫do. 
    // Usamos o scrollHeight (altura total do texto l√° dentro)
    el.style.height = (el.scrollHeight) + 'px';
}

// Fun√ß√£o para converter Inputs antigos em Textareas din√¢micos
function convertToTextarea(inputEl) {
    const textarea = document.createElement('textarea');
    textarea.className = inputEl.className;
    textarea.value = inputEl.value;
    textarea.placeholder = inputEl.placeholder;
    textarea.rows = 1;
    // Copia os datasets
    Object.assign(textarea.dataset, inputEl.dataset);
    
    inputEl.parentNode.replaceChild(textarea, inputEl);
    
    textarea.addEventListener('input', () => {
        autoResizeTitle(textarea);
        saveNote();
    });
}

async function renderListCategoryItems(categoryId) {
    const listElement = middlePanelList;
    const myUid = auth.currentUser.uid;
    
    // 1. ESTADO DE CARREGAMENTO
    listElement.innerHTML = `
        <div class="spinner-container" style="margin-top:50px;">
            <div class="spinner"></div>
            <span>A processar categoria...</span>
        </div>`;
    
    // Identifica onde estamos na navega√ß√£o
    const lastNav = navigationStack[navigationStack.length - 1];
    const origin = navigationStack[0]?.id || categoryId;

    try {
        // ==========================================
        // 1. CAMINHO: COSMOS (TEMAS E SUBTEMAS)
        // ==========================================
        if (origin === 'cosmos') {
            // N√çVEL 1: LISTA DE TEMAS PRINCIPAIS
            if (lastNav.type === 'list-category') {
                middlePanelTitle.textContent = "üíº Cosmos: Temas";
                updateAddButtonState(true, true); // Bot√£o + amarelo ativo

                const q = query(collection(db, 'cosmos'), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                listElement.innerHTML = '';

                if (snap.empty) {
                    listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum tema criado. Clique no + para come√ßar.</li>';
                    return;
                }

                snap.forEach(docSnap => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    
                    // ATRIBUTOS PARA O POPUP DE EDI√á√ÉO
                    li.setAttribute('data-id', item.id);
                    li.setAttribute('data-type', 'cosmos-parent'); 
                    li.setAttribute('data-name', item.nome);
                    li.setAttribute('data-emoji', item.emoji || 'üíº');

                    // SUBSTITU√çDO: "‚Ä¶" por "‚úè"
                   li.innerHTML = `<span>${item.emoji || 'üíº'} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

                    
                    li.onclick = (e) => {
                        // IMPORTANTE: Se clicar no l√°pis, para a execu√ß√£o aqui para o listener global abrir o editor
                        if (e.target.closest('.item-menu-btn')) return;

                        // Navega para dentro do Tema para ver os Subtemas
                        navigationStack.push({ id: item.id, name: item.nome, type: 'cosmos-parent', emoji: item.emoji || 'üíº' });
                        updateNavigationView(true);
                    };
                    listElement.appendChild(li);
                });
            }
            // N√çVEL 2: LISTA DE SUBTEMAS DENTRO DE UM TEMA
            else if (lastNav.type === 'cosmos-parent') {
                middlePanelTitle.textContent = `${lastNav.emoji} ${lastNav.name}`;
                updateAddButtonState(true, true);

                const q = query(collection(db, 'subcosmos'), where('cosmosId', '==', lastNav.id), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                listElement.innerHTML = '';

                if (snap.empty) {
                    listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Esta pasta est√° vazia.</li>';
                    return;
                }

                snap.forEach(docSnap => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    
                    // ATRIBUTOS PARA O POPUP DE EDI√á√ÉO
                    li.setAttribute('data-id', item.id);
                    li.setAttribute('data-type', 'subcosmos');
                    li.setAttribute('data-name', item.nome);
                    li.setAttribute('data-emoji', item.emoji || 'üîπ');

                    // Destaque visual se estiver aberto na 4¬™ coluna
                    if (activeReferenceEntity && activeReferenceEntity.id === item.id) {
                        li.classList.add('selected');
                    }

                    // SUBSTITU√çDO: "‚Ä¶" por "‚úè"
                    li.innerHTML = `<span>${item.emoji || 'üîπ'} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;
                    
                    li.onclick = (e) => {
                        // IMPORTANTE: Se clicar no l√°pis, para a execu√ß√£o aqui para o listener global abrir o editor
                        if (e.target.closest('.item-menu-btn')) return;

                        // Limpa sele√ß√£o anterior e abre o painel de refer√™ncias (Cita√ß√µes)
                        listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
                        li.classList.add('selected');
                        showReferencesPanel(item.id, item.nome, 'subcosmos');
                    };
                    listElement.appendChild(li);
                });
            }
            return;
        }

        // ==========================================
        // 2. CAMINHO: B√çBLIA (LIVROS > CAPS > VERS)
        // ==========================================
        if (origin === 'biblia-root') {
            // N√≠vel 1: Lista de Livros
            if (lastNav.type === 'list-category') {
                middlePanelTitle.textContent = "B√≠blia: Livros";
                updateAddButtonState(false);
                listElement.innerHTML = '';
                BIBLE_DATA.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>üìñ ${book.nome}</span>`;
                    li.onclick = () => {
                        navigationStack.push({ id: book.nome, name: book.nome, type: 'bible-book', caps: book.caps });
                        updateNavigationView(true);
                    };
                    listElement.appendChild(li);
                });
            } 
            // N√≠vel 2: Grade de Cap√≠tulos
            else if (lastNav.type === 'bible-book') {
                middlePanelTitle.textContent = lastNav.name;
                listElement.innerHTML = '<div class="bible-grid"></div>';
                const grid = listElement.querySelector('.bible-grid');
                for (let i = 1; i <= lastNav.caps; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'bible-grid-btn';
                    btn.textContent = i;
                    btn.onclick = () => {
                        navigationStack.push({ id: `${lastNav.name} ${i}`, name: `Cap. ${i}`, type: 'bible-chapter', book: lastNav.name, chapter: i });
                        updateNavigationView(true);
                    };
                    grid.appendChild(btn);
                }
            } 
            // N√≠vel 3: Grade de Vers√≠culos
            else if (lastNav.type === 'bible-chapter') {
                const bookData = BIBLE_DATA.find(b => b.nome === lastNav.book);
                const prefix = `${lastNav.book} ${lastNav.chapter}:`;
                middlePanelTitle.textContent = prefix.replace(':', '');
                listElement.innerHTML = '<div class="bible-grid"></div>';
                const grid = listElement.querySelector('.bible-grid');
                
                const totalV = bookData?.versiculos?.[lastNav.chapter - 1] || 50;
                const existingVerses = allEntities['textobiblico'] || [];

                for (let v = 1; v <= totalV; v++) {
                    const fullVerse = `${prefix}${v}`;
                    const exists = existingVerses.some(e => e.nome === fullVerse);
                    const isActive = fullVerse === currentlyOpenVerseName;
                    
                    const btn = document.createElement('div');
                    btn.className = `bible-grid-btn ${exists ? 'exists' : ''} ${isActive ? 'active-verse' : ''}`;
                    btn.textContent = v;
                    btn.onclick = () => {
                        currentlyOpenVerseName = fullVerse;
                        grid.querySelectorAll('.bible-grid-btn').forEach(b => b.classList.remove('active-verse'));
                        btn.classList.add('active-verse');
                        showReferencesPanel(null, fullVerse, 'textobiblico');
                    };
                    grid.appendChild(btn);
                }
            }
            return;
        }

        // ==========================================
        // 3. OUTRAS CATEGORIAS (T√ìPICOS, TAGS, ENTIDADES)
        // ==========================================
        if (lastNav.type === 'list-category') {
            let items = [];
            
            if (categoryId === 'topico') {
                middlePanelTitle.textContent = "T√≥picos";
                updateAddButtonState(true, true);
                const q = query(collection(db, 'topicos'), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                snap.forEach(doc => items.push({ id: doc.id, nome: doc.data().nome, type: 'topico', desc: doc.data().descricao }));
            } 
            else if (categoryId === 'tag') {
                middlePanelTitle.textContent = "Tags (#)";
                updateAddButtonState(false);
                const q = query(collection(db, 'pastas'), where('tipo', '==', 'nota'), where('userId', '==', myUid));
                const snap = await getDocs(q);
                const tagSet = new Set();
                snap.forEach(doc => { if (doc.data().tags) doc.data().tags.forEach(t => tagSet.add(t)); });
                items = Array.from(tagSet).sort().map(t => ({ id: t, nome: t, type: 'tag' }));
            }
            else {
                const config = ENTITY_CONFIG[categoryId];
                if (config) {
                    middlePanelTitle.textContent = config.displayName;
                    updateAddButtonState(true, true);
                    const q = query(collection(db, config.collection), where('userId', '==', myUid), orderBy('nome'));
                    const snap = await getDocs(q);
                    snap.forEach(doc => items.push({ id: doc.id, nome: doc.data().nome, type: categoryId }));
                }
            }
            
            renderStandardList(items);
        }

    } catch (e) {
        console.error("Erro ao renderizar lista de categorias:", e);
        listElement.innerHTML = '<li style="color:red; padding:20px; text-align:center;">Erro ao ligar √† base de dados.</li>';
    }
}

// Fun√ß√£o auxiliar para n√£o repetir c√≥digo de renderiza√ß√£o
function renderStandardList(items) {
    // 1. Limpa apenas a Coluna 2
    middlePanelList.innerHTML = '';
    
    if (items.length === 0) {
        middlePanelList.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nada encontrado.</li>';
        return;
    }
    
    items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-item';
        
        // ============================================================
        // REGRA DE COR DIN√ÇMICA PARA LISTAS (COLUNA 2)
        // ============================================================
        // Verifica se o item √© o que est√° atualmente aberto no painel de refer√™ncias
        if (activeReferenceEntity && activeReferenceEntity.id === item.id) {
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            li.classList.add(selectionClass);
        }

        let icon = 'üîπ';
        if (item.type === 'topico') icon = 'üìë';
        if (item.type === 'tag') icon = 'üè∑Ô∏è';
        if (item.type === 'textobiblico') icon = 'üìú';
        if (item.type === 'marcadores') icon = 'üîñ';
        if (item.type === 'destaque') icon = 'üé®';
        
        li.innerHTML = `<span>${icon} ${item.nome}</span>`;
        
        li.onclick = () => {
            // Limpa a sele√ß√£o visual apenas da Coluna 2 antes de marcar o novo
            document.querySelectorAll('#file-list .list-item').forEach(el => {
                el.classList.remove('selected', 'selected-red');
            });
            
            // Aplica a cor correta baseada no modo
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            li.classList.add(selectionClass);

            // A√ß√£o de abrir as refer√™ncias
            if (item.type === 'topico') showTopicReferencesPanel(item.id, item.nome, item.desc, 'topico');
            else if (item.type === 'tag') showTagReferencesPanel(item.nome);
            else if (item.type === 'destaque') showHighlightReferencesPanel(item.id, item.nome);
            else if (item.type === 'marcadores') showMarkerReferencesPanel(item.id, item.nome); 
            else showReferencesPanel(item.id, item.nome, item.type);
        };
        
        middlePanelList.appendChild(li);
    });
}



// ============================================================
// L√ìGICA DE ARRASTO DO PAINEL DE REFER√äNCIAS (MOBILE)
// ============================================================
const refPanel = document.getElementById('references-panel');

// Pontos de encaixe em % (O 95 garante que o bot√£o X nunca sai do ecr√£)
const snapPoints = [95, 80, 60, 50, 30, 20, 10]; 
let startY = 0;
let startHeight = 0;
let isDraggingPanel = false;

// In√≠cio do Toque
refPanel.addEventListener('touchstart', (e) => {
    // S√≥ inicia o arrasto se tocar no header (t√≠tulo/bot√£o fechar) ou no fundo do painel
    if (e.target.closest('.panel-header') || e.target.id === 'references-panel') {
        isDraggingPanel = true;
        startY = e.touches[0].clientY;
        startHeight = refPanel.offsetHeight;
        refPanel.classList.add('is-dragging');
    }
}, { passive: true });

// Movimento do Dedo
window.addEventListener('touchmove', (e) => {
    if (!isDraggingPanel) return;

    const currentY = e.touches[0].clientY;
    const deltaY = startY - currentY; // Arrastar para cima aumenta a altura
    let newHeight = startHeight + deltaY;

    const screenHeight = window.innerHeight;
    const newHeightPct = (newHeight / screenHeight) * 100;

    // LIMITES DE ARRASTO: M√≠nimo 5% e M√°ximo 95% para n√£o tapar o topo total
    if (newHeightPct >= 5 && newHeightPct <= 95) {
        refPanel.style.height = `${newHeight}px`;
    }
}, { passive: false });

// Final do Toque (Snap)
window.addEventListener('touchend', () => {
    if (!isDraggingPanel) return;
    
    isDraggingPanel = false;
    refPanel.classList.remove('is-dragging');

    const screenHeight = window.innerHeight;
    const currentHeightPct = (refPanel.offsetHeight / screenHeight) * 100;
    
    // Encontra o ponto de snap mais pr√≥ximo
    const closestSnap = snapPoints.reduce((prev, curr) => {
        return (Math.abs(curr - currentHeightPct) < Math.abs(prev - currentHeightPct) ? curr : prev);
    });

    // Fixa na altura de encaixe (vh)
    refPanel.style.height = `${closestSnap}vh`;
});

// RESET PARA 60% AO FECHAR E REABRIR
const originalHidePanel = window.hideReferencesPanel;
window.hideReferencesPanel = async function() {
    if (typeof originalHidePanel === 'function') await originalHidePanel();
    
    // Pequeno delay para a anima√ß√£o de descida terminar antes de resetar a altura para 60%
    setTimeout(() => {
        refPanel.style.height = "60vh"; 
    }, 400);
};

async function showMarkerReferencesPanel(markerId, markerName) {
    
    // 1. Gravar o puzzle anterior se estivesse em modo edi√ß√£o
    await forceSaveAndClosePuzzleMode();

    // 2. CONFIGURAR A ENTIDADE ATIVA (Para o bot√£o +Ref do Quadro saber o que procurar)
    activeReferenceEntity = { 
        id: markerId, 
        type: 'marcadores', 
        name: markerName 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel lateral
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Textos com üîñ ${markerName}`;

    // For√ßa a aba "Refer√™ncias" a abrir para mostrar os vers√≠culos encontrados
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Carrega o Quadro (Puzzle) associado a este Marcador
    loadPuzzleData(markerId, 'marcadores');

    // Limpa a lista e mostra o sinal de carregamento
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar textos b√≠blicos marcados...</span>
        </div>`;

    try {
        // 4. Query ao Firebase: Procura na cole√ß√£o 'textosbiblicos' 
        // onde o ID do marcador existe dentro do mapa 'marcadoresAssociados'
        const q = query(
            collection(db, 'textosbiblicos'),
            where(`marcadoresAssociados.${markerId}`, '==', true),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        listElement.innerHTML = '';

        if (snapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum texto b√≠blico foi associado a este marcador ainda.</li>';
            return;
        }

        // 5. Renderizar a lista de Vers√≠culos encontrados
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            // Dados para o bot√£o de adicionar ao quadro
            const safeName = encodeURIComponent(data.nome);
            const markerSnippet = `<p style="color:#9b59b2; font-weight:bold;">üîñ Texto marcado como: ${markerName}</p>`;
            const safeSnippet = encodeURIComponent(markerSnippet);

            const summary = document.createElement('summary');
            summary.style.display = 'flex';
            summary.style.alignItems = 'center';
            summary.style.width = '100%';
            summary.style.listStyle = "none";

            // Bot√£o "Ir para" (neste caso, abre as refer√™ncias desse vers√≠culo espec√≠fico)
            const goToBtn = `<button class="go-to-note-btn" 
                onclick="event.preventDefault(); event.stopPropagation(); showReferencesPanel('${docSnap.id}', '${data.nome}', 'textobiblico')" 
                title="Ver notas sobre este texto">‚ûî</button>`;

            summary.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; flex-grow:1; overflow:hidden;">
                    <button class="add-to-puzzle-btn" title="Adicionar ao Quadro" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${docSnap.id}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                    <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:500; color:var(--text-color);">
                        üìú ${data.nome}
                    </span>
                </div>
                ${goToBtn}
            `;

            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Mostra a descri√ß√£o do texto b√≠blico se existir
            contextDiv.innerHTML = `<p>${data.descricao || 'Sem anota√ß√µes gerais para este texto.'}</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao carregar vers√≠culos do marcador:", error);
        listElement.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao carregar refer√™ncias da base de dados.</li>';
    }
}

function updateAddButtonState(visible, yellowMode = false) {
    const btn = document.getElementById('add-item-btn');
    if (!btn) return;

    if (visible) {
        btn.style.display = 'flex';
        if (yellowMode) {
            btn.classList.add('yellow-mode');
        } else {
            btn.classList.remove('yellow-mode');
        }
    } else {
        btn.style.display = 'none';
    }
}

// Fun√ß√£o para varrer o editor e descobrir quais cores de destaque est√£o a ser usadas
function extractUsedColorsFromEditor() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return [];

    // Procura todos os elementos que t√™m o atributo data-highlight
    const coloredElements = editor.querySelectorAll('[data-highlight]');
    const colorsSet = new Set();

    coloredElements.forEach(el => {
        const color = el.getAttribute('data-highlight');
        if (color) {
            // Guardamos sempre em mai√∫sculas para evitar erros de pesquisa (#fff vs #FFF)
            colorsSet.add(color.toUpperCase());
        }
    });

    return Array.from(colorsSet);
}

// ============================================================
// PROTE√á√ÉO DE LIMITES: ESCAPA DE ENTIDADES (PERSONAGENS, TAGS, LINKS)
// ============================================================
function handleBoundaryProtection(event) {
    const selection = window.getSelection();
    if (!selection.rangeCount || !selection.isCollapsed) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    const offset = range.startOffset;

    // 1. Identificar se o cursor toca numa entidade protegida
    let styledEl = currentNode.nodeType === 3 ? currentNode.parentElement : currentNode;
    styledEl = styledEl.closest('.entity-link, .tag, a[data-anexo-id], .idea-span');

    if (!styledEl) return;

    // 2. Teclas de escrita (letras, n√∫meros, espa√ßo, enter)
    const isPrintable = event.key.length === 1 || event.key === 'Enter';
    if (!isPrintable) return;

    // --- L√ìGICA DE POSI√á√ÉO ---
    const isAtStart = (offset === 0);
    const isAtEnd = (currentNode.nodeType === 3 && offset === currentNode.textContent.length);

    if (isAtStart || isAtEnd) {
        // TRUQUE: Em vez de inserirmos o caractere n√≥s mesmos, inserimos um 
        // caractere invis√≠vel (Zero-Width Space) FORA do span e movemos o cursor para l√°.
        // O navegador ent√£o processar√° o seu "Enter" ou "Espa√ßo" nesse local limpo.
        
        const invisibleBridge = document.createTextNode('\u200B'); // Caractere invis√≠vel
        const parent = styledEl.parentNode;

        if (isAtStart) {
            parent.insertBefore(invisibleBridge, styledEl);
        } else {
            if (styledEl.nextSibling) {
                parent.insertBefore(invisibleBridge, styledEl.nextSibling);
            } else {
                parent.appendChild(invisibleBridge);
            }
        }

        // Move o cursor para depois da ponte invis√≠vel
        const newRange = document.createRange();
        newRange.setStartAfter(invisibleBridge);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);

    }
}


// --- FUN√á√ïES TORNADAS GLOBAIS PARA O ONCLICK FUNCIONAR ---
window.addSmallField = function(container, label, value = '') {
    const inp = document.createElement('input');
    inp.className = 'codex-input';
    inp.style.width = '45px';
    inp.placeholder = label;
    inp.value = value;
    // Insere antes do bot√£o +
    container.insertBefore(inp, container.lastChild);
};

window.toggleManual = function(btn, type, val = '') {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    
    // Se j√° estiver ativo, removemos
    if (btn.classList.contains('active')) {
        const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : '.manual-time-group');
        const el = area.querySelector(selector)?.closest('.manual-field-group');
        if (el) el.remove();
        btn.classList.remove('active');
        return;
    }

    btn.classList.add('active');

    const group = document.createElement('div');
    group.className = 'manual-field-group';

    if (type === 'A') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-year" placeholder="Ano" value="${val}" style="width: 45px;">`;
    } 
    else if (type === 'M') {
        group.innerHTML = `
            <select class="codex-input-manual manual-month" style="cursor:pointer;">
                <option value="">M√™s...</option>
                ${MESES_LISTA.map(m => `<option value="${m}" ${val===m?'selected':''}>${m}</option>`).join('')}
            </select>`;
    } 
 else if (type === 'T') {
        const t = val ? val.split(':') : ['', '', ''];
        group.classList.add('manual-time-group');
        group.innerHTML = `
            <input type="text" class="codex-input-manual h-input" 
                   placeholder="00" maxlength="2" value="${t[0]}" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 2) this.nextElementSibling?.focus();"
                   style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual m-input" 
                   placeholder="00" maxlength="2" value="${t[1]}" 
                  oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 2) this.nextElementSibling?.focus();"
                   style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual s-input" 
                   placeholder="00" maxlength="2" value="${t[2]}" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                   style="width:20px; text-align:center;">
        `;
    }

    // Adiciona o bot√£o de fechar no final da p√≠lula (como parte do flex)
    group.innerHTML += `<button class="btn-close-manual" onclick="window.removeManualField(this, '${type}')">√ó</button>`;
    area.appendChild(group);
};

window.removeCodexRow = async function(btn) {
    const row = btn.closest('.codex-row');
    const firestoreId = row.getAttribute('data-firestore-id');
    const confirmModal = document.getElementById('confirm-modal');

    if (confirmModal) {
        confirmModal.style.setProperty('z-index', '9999', 'important');
    }

    const confirmed = await showConfirmation(
        "Eliminar Permanente?", 
        "Deseja remover esta refer√™ncia? Ela ser√° apagada permanentemente da base de dados agora."
    );

    if (confirmed) {
        // 1. ELIMINA√á√ÉO NO FIREBASE
        if (firestoreId) {
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                
                // Tenta apagar no Firestore
                await deleteDoc(doc(db, 'codex', firestoreId));
                console.log("üî• Documento apagado com sucesso:", firestoreId);
            } catch (e) {
                console.error("‚ùå Erro ao apagar:", e);
                if (e.code === 'permission-denied') {
                    alert("Erro: N√£o tem permiss√£o para apagar este documento (pode faltar o campo userId no Firebase).");
                } else {
                    alert("Erro ao ligar ao Firebase. O item ser√° removido apenas do ecr√£.");
                }
                // Se quiser impedir a remo√ß√£o visual caso falhe no banco, d√™ 'return' aqui
            }
        }

        // 2. ELIMINA√á√ÉO NO ECR√É
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(30px)';
        
        setTimeout(() => {
            row.remove();
            // 3. Importante: For√ßa a grava√ß√£o da NOTA para atualizar o JSON dela sem este item
            saveNote(true);
        }, 300);
    }

    if (confirmModal) confirmModal.style.zIndex = "";
};

window.removeManualField = function(closeBtn, type) {
    const row = closeBtn.closest('.codex-row');
    const fieldGroup = closeBtn.closest('.manual-field-group');
    
    // Encontra o bot√£o (A, M ou T) correspondente e desativa a cor azul
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if (toggleBtn) toggleBtn.classList.remove('active');
    
    fieldGroup.remove();
};

window.openPanelLinkCreator = async function(type, editingIndex = null) {
    const modal = document.getElementById('link-modal');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');
    const tabHeader = document.getElementById('box-link-tabs');
    const addCodexBtn = document.getElementById('add-codex-row-btn');
    const addUrlBtn = document.getElementById('add-url-btn'); 
    const refsTabContent = document.getElementById('box-content-refs');
    const codexTabContent = document.getElementById('box-content-codex');
    const codexContainer = document.getElementById('codex-rows-container');
    const urlsContainer = document.getElementById('link-urls-container');
    const titleInput = document.getElementById('link-title-input');

    // --- 1. RESET TOTAL DA INTERFACE ---
    if (tabHeader) tabHeader.style.display = 'none'; 
    if (addCodexBtn) addCodexBtn.style.display = 'none'; 
    
    document.getElementById('link-remove-btn').style.display = 'none';
    codexContainer.innerHTML = '';
    urlsContainer.innerHTML = '';
    titleInput.value = "";
    saveBtn.disabled = false;
    saveBtn.textContent = "Gravar";

    // --- 2. CONFIGURAR T√çTULO E CARREGAR DADOS SE FOR EDI√á√ÉO ---
    modalTitle.textContent = (editingIndex !== null ? "Editar " : "Novo ") + (type === 'link' ? "Link" : "Codex");

    let existingData = null;
    if (editingIndex !== null) {
        try {
            const collectionName = getCollectionFromType(activeReferenceEntity.type);
            const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));
            if (docSnap.exists() && docSnap.data().panelLinks) {
                existingData = docSnap.data().panelLinks[editingIndex];
            }
        } catch (e) { console.error("Erro ao carregar edi√ß√£o:", e); }
    }

    // --- 3. PREPARAR O FORMUL√ÅRIO ---
    if (type === 'link') {
        refsTabContent.style.display = 'block';
        codexTabContent.style.display = 'none';
        if (addUrlBtn) addUrlBtn.style.display = 'block';
        
        titleInput.value = existingData ? existingData.title : "";
        if (existingData && existingData.urls) {
            Object.values(existingData.urls).forEach(url => addUrlField(url));
        } else { addUrlField(); }
    } else {
        codexTabContent.style.display = 'block';
        refsTabContent.style.display = 'none';
        if (addCodexBtn) addCodexBtn.style.display = 'block';
        
        window.createCodexRow(existingData); 

        if (existingData) {
            const row = codexContainer.querySelector('.codex-row');
            if (existingData.ano) window.toggleManual(row.querySelector("button[onclick*='A']"), 'A', existingData.ano);
            if (existingData.mes) window.toggleManual(row.querySelector("button[onclick*='M']"), 'M', existingData.mes);
            if (existingData.tempo) window.toggleManual(row.querySelector("button[onclick*='T']"), 'T', existingData.tempo);
        }
    }

    // --- 4. CLONAR BOT√ÉO PARA LIMPAR EVENTOS ---
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A processar...";

        try {
            const myUid = auth.currentUser.uid;
            let dataToSave = null;

            if (type === 'link') {
                // L√ìGICA DE LINKS WEB
                const urlsMap = {};
                urlsContainer.querySelectorAll('input').forEach((inp, i) => {
                    if(inp.value.trim()) {
                        let val = inp.value.trim();
                        if(!val.startsWith('http')) val = 'https://' + val;
                        urlsMap[`url_${Date.now()}_${i}`] = val;
                    }
                });
                if (Object.keys(urlsMap).length === 0) throw new Error("Insira pelo menos um link.");
                dataToSave = { type: 'link', title: titleInput.value.trim() || "Link", urls: urlsMap, createdAt: existingData?.createdAt || Date.now() };
            } 
            else {
                // --- L√ìGICA CODEX: IDENTIFICA√á√ÉO E FORMATA√á√ÉO ---
                const row = codexContainer.querySelector('.codex-row');
                const rowData = getCodexDataFromRow(row);
                if (!rowData.serie) throw new Error("A S√©rie √© obrigat√≥ria.");

                // A. Identificar Nome da Publica√ß√£o
                const valorBaixo = rowData.serie.toLowerCase().trim();
                const siglaMatch = valorBaixo.match(/^[a-z]+(?:-[0-9])?/);
                const sigla = siglaMatch ? siglaMatch[0] : "";
                const pubNome = SIGLAS_PUBLICACOES[sigla] || rowData.serie;

                // B. Processar Data e Tempo
                const auto = parseSerieInfo(rowData.serie);
                const finalYear = rowData.manualYear || auto.ano || "";
                const finalMonth = rowData.manualMonth || auto.mes || "";
                
                let tempoFinal = "";
                if (rowData.h || rowData.m || rowData.s) {
                    const pad = (v) => v.toString().padStart(2, '0');
                    tempoFinal = `${pad(rowData.h || 0)}:${pad(rowData.m || 0)}:${pad(rowData.s || 0)}`;
                }

                // C. Gerar o campo "codiceshow" (String amig√°vel)
                let codiceShow = pubNome;
                if (finalMonth && finalYear) codiceShow += ` ${finalMonth}/${finalYear}`;
                else if (finalYear) codiceShow += ` ${finalYear}`;

                if (rowData.paginas.length > 0) codiceShow += `, p√°gina ${rowData.paginas.join(', ')}`;
                if (rowData.paragrafos.length > 0) codiceShow += `, par√°grafo ${rowData.paragrafos.join(', ')}`;
                if (tempoFinal) codiceShow += `, [${tempoFinal}]`;

                // D. Gravar na Cole√ß√£o Global 'codex'
                let globalId = existingData?.id || null;
                const globalData = {
                    nome: codiceShow,
                    publicacaonome: pubNome, // Campo solicitado
                    codiceshow: codiceShow,   // Campo solicitado
                    userId: myUid,
                    entityId: activeReferenceEntity.id,
                    entityName: activeReferenceEntity.name,
                    entityType: activeReferenceEntity.type,
                    serie: rowData.serie,
                    paginas: rowData.paginas,
                    paragrafos: rowData.paragrafos,
                    ano: finalYear,
                    mes: finalMonth,
                    tempo: tempoFinal,
                    updatedAt: serverTimestamp()
                };

                if (!globalId) {
                    const newGlobalRef = await addDoc(collection(db, 'codex'), { ...globalData, createdAt: serverTimestamp() });
                    globalId = newGlobalRef.id;
                } else {
                    await setDoc(doc(db, 'codex', globalId), globalData, { merge: true });
                }

                // E. Preparar objeto para o array panelLinks
                dataToSave = { 
                    ...rowData,
                    id: globalId, 
                    type: 'codex', 
                    publicacaonome: pubNome,
                    codiceshow: codiceShow,
                    ano: finalYear,
                    mes: finalMonth,
                    tempo: tempoFinal,
                    createdAt: existingData?.createdAt || Date.now() 
                };
            }

            // --- 5. ATUALIZAR O DOCUMENTO DA ENTIDADE (Personagem/Local/etc) ---
            const collectionName = getCollectionFromType(activeReferenceEntity.type);
            const docRef = doc(db, collectionName, activeReferenceEntity.id);
            const docSnap = await getDoc(docRef);
            let currentLinks = docSnap.exists() ? (docSnap.data().panelLinks || []) : [];

            if (editingIndex !== null) currentLinks[editingIndex] = dataToSave;
            else currentLinks.push(dataToSave);

            await updateDoc(docRef, { panelLinks: currentLinks });

            modal.style.display = 'none';
            renderPanelLinks(); 

        } catch (e) {
            console.error("Erro ao gravar:", e);
            alert(e.message || "Erro ao gravar.");
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
        }
    };

    modal.style.display = 'flex';
};


window.movePanelLink = async function(index, direction) {
    // index: posi√ß√£o atual | direction: -1 (subir) ou 1 (descer)
    const targetIndex = index + direction;
    
    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) return;

        let links = docSnap.data().panelLinks || [];
        
        // Verifica se o movimento √© poss√≠vel
        if (targetIndex < 0 || targetIndex >= links.length) return;

        // TROCA DE POSI√á√ÉO (Destructuring swap)
        [links[index], links[targetIndex]] = [links[targetIndex], links[index]];

        // Grava o array inteiro novamente na ordem certa
        await updateDoc(docRef, { panelLinks: links });
        
        // Atualiza a visualiza√ß√£o
        renderPanelLinks();

    } catch (e) {
        console.error("Erro ao mover link no painel:", e);
    }
};

function loadSharedFilesRoot() {
    console.log("%c[SISTEMA] A carregar raiz de Partilha...", "color: #e74c3c;");
    
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }
    if (unsubscribeShared2) { unsubscribeShared2(); unsubscribeShared2 = null; }

    middlePanelTitle.textContent = "Arquivos Partilhados";
    middlePanelList.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A procurar arquivos...</span></div>';

    let resultsMap = new Map();
    const myUid = auth.currentUser.uid;
    const foldersRef = collection(db, 'pastas');

    const renderUnifiedList = () => {
        middlePanelList.innerHTML = '';
        console.log("Renderizando lista unificada. selectedNoteId ativo:", selectedNoteId);

        Array.from(resultsMap.values())
            .sort((a, b) => (a.nome || "").localeCompare(b.nome || ""))
            .forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.setAttribute('data-id', item.id);
                li.setAttribute('data-type', item.tipo);
                li.setAttribute('data-name', item.nome);
                

                if (item.id === selectedNoteId) {
                    li.classList.add('selected-red');
                    console.log(`%cMATCH! Pintando o item ${item.nome} de vermelho via Re-render.`, "background: #e74c3c; color: white; padding: 2px;");
                }

                li.style.borderLeft = "4px solid #e74c3c";
                const isOwner = item.userId === myUid;
                li.innerHTML = `<span>${isOwner ? 'üëë' : 'ü§ù'} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;
                
                if (isOwner && item.partilhado !== "ativo") li.style.opacity = "0.7";
                middlePanelList.appendChild(li);
            });
    };

    // Queries (q1 e q2 seguem iguais...)
    const q1 = query(foldersRef, where('userId', '==', myUid), where('tipo', '==', 'partilhado'), where('estado', '==', 'ativa'));
    const q2 = query(foldersRef, where(`colaboradores.${myUid}`, '==', true), where('partilhado', '==', 'ativo'), where('tipo', '==', 'partilhado'), where('estado', '==', 'ativa'));

    unsubscribeShared1 = onSnapshot(q1, (snapshot) => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "removed") resultsMap.delete(change.doc.id);
            else resultsMap.set(change.doc.id, { ...change.doc.data(), id: change.doc.id });
        });
        renderUnifiedList();
    });

    unsubscribeShared2 = onSnapshot(q2, (snapshot) => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "removed") resultsMap.delete(change.doc.id);
            else resultsMap.set(change.doc.id, { ...change.doc.data(), id: change.doc.id });
        });
        renderUnifiedList();
    });
}

// --- L√ìGICA DO DOSSI√â ---

// --- VARI√ÅVEIS DE ESTADO DO DOSSI√â (Expostas para o m√≥dulo) ---
// Definimos como window. para que o HTML consiga ler e alterar
window.isDossieEditMode = false;
window.activeMicaId = null;

// 1. Tornar a fun√ß√£o de renderiza√ß√£o global
window.renderDossie = async function() {
    const container = document.getElementById('dossie-list-container');
    const titleEl = document.getElementById('dossie-view-title');
    const editBtn = document.getElementById('toggle-dossie-edit-btn');
    const editActions = document.getElementById('dossie-edit-actions');
    const backBtn = document.getElementById('mica-back-btn');
    const addBtn = document.getElementById('mica-add-content-btn');
    const bibleBtn = document.getElementById('mica-add-bible-btn');

    if (!container) return;

    // --- 1. SEGURAN√áA E LOADING ---
    const thisVersion = ++currentDossieVersion;

    if (container.innerHTML === "") {
        container.innerHTML = `<div class="spinner-container" style="margin-top: 50px; text-align:center;"><div class="spinner"></div></div>`;
    }
    
    container.innerHTML = ''; // Limpeza imediata

    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        container.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Selecione um t√≥pico ou vers√≠culo.</p>';
        return;
    }

    // Mostrar Spinner centralizado
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A organizar Dossi√©...</span>
        </div>`;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));
        
        // Aborta se o utilizador j√° mudou de contexto
        if (thisVersion !== currentDossieVersion) return;

        const dossieData = docSnap.exists() ? (docSnap.data().dossie || []) : [];
        editBtn.textContent = window.isDossieEditMode ? "Salvar" : "Editar";
        
        if (window.activeMicaId) {
            // ==========================================
            // MODO: CONTE√öDO DA MICA (CARDS)
            // ==========================================
            const mica = dossieData.find(m => m.id === window.activeMicaId);
            if (!mica) { window.activeMicaId = null; window.renderDossie(); return; }

            titleEl.textContent = mica.name;
            backBtn.style.display = 'block';
            addBtn.style.display = 'block';
            bibleBtn.style.display = 'block';
            editBtn.style.display = 'none'; 
            editActions.style.display = 'none';

            if (!mica.items || mica.items.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; font-style:italic; margin-top:40px;">Mica vazia. Clique em +Add ou +B√≠blia.</p>';
            } else {
                const tempFragment = document.createDocumentFragment();

                for (let idx = 0; idx < mica.items.length; idx++) {
                    const item = mica.items[idx];
                    const card = document.createElement('div');
                    card.className = 'board-card type-ref';
                    card.style.position = 'relative';

                    let rawSnippet = decodeURIComponent(item.snippet || '');
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = rawSnippet;

                    let icon = "üì¶"; let label = "Ref"; let color = "#95a5a6";
                    let isBible = rawSnippet.includes('bible-card-mica') || item.noteId === 'bible_internal';
                    let bodyText = ""; let titleText = "";

                    // L√≥gica de salto: Se tem nota f√≠sica e n√£o √© b√≠blia interna, pode saltar
                    const isJumpable = item.noteId && item.noteId !== 'bible_internal';

                    if (isBible) {
                        icon = "üìñ"; 
                        color = "#5d4037"; // Cor do bot√£o +B√≠blia
                        label = item.title || "B√≠blia";
                        titleText = item.noteName;
                        try {
                            const verseText = await fetchBibleRangeText(item.noteName);
                            if (thisVersion !== currentDossieVersion) return;
                            bodyText = verseText || 'Texto n√£o dispon√≠vel.';
                        } catch(e) { bodyText = "Erro ao carregar vers√≠culos."; }
                    } else {
                        // Notas normais
                        if (rawSnippet.includes('question-mode')) { icon = "üìó"; label = "Quest√£o"; color = "#2ecc71"; }
                        else if (rawSnippet.includes('free-mode')) { icon = "üìô"; label = "Contentor"; color = "#e67e22"; }
                        else if (rawSnippet.includes('toggle-section')) { icon = "‚òÇ"; label = "Sec√ß√£o"; color = "#9b59b6"; }
                        else if (rawSnippet.includes('idea-span')) { icon = "üí°"; label = "Ideia"; color = "#e74c3c"; }
                        else if (rawSnippet.includes('mini-note-wrapper')) { icon = "üìò"; label = "SubNota"; color = "#3498db"; }

                        const titleInput = tempDiv.querySelector('.mini-note-title-input');
                        const h2El = tempDiv.querySelector('h2');
                        const ideaEl = tempDiv.querySelector('.idea-span');
                        titleText = titleInput ? (titleInput.textContent || titleInput.value || titleInput.getAttribute('value')) : 
                                    (h2El ? h2El.textContent : (ideaEl ? ideaEl.textContent : "Texto da Nota"));

                        const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content') || tempDiv;
                        bodyText = contentDiv.innerText.replace(/\s+/g, ' ').trim();
                        if (bodyText.length > 400) bodyText = bodyText.substring(0, 400) + "...";
                    }

                    card.style.borderLeft = `4px solid ${color}`;
                    card.innerHTML = `
                        <!-- CONTROLOS: SETAS ‚ñ≤ ‚ñº E FECHAR X -->
                        <div style="position:absolute; top:8px; right:8px; display:flex; gap:3px; z-index:20; background:var(--panel-color); border-radius:5px; padding:2px;">
                            <button class="mica-nav-btn" onclick="window.moveMicaItem(${idx}, -1); event.stopPropagation();">‚ñ≤</button>
                            <button class="mica-nav-btn" onclick="window.moveMicaItem(${idx}, 1); event.stopPropagation();">‚ñº</button>
                            <button class="mica-nav-btn" onclick="window.removeItemFromMica(${idx}); event.stopPropagation();" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='var(--text-muted-color)'">√ó</button>
                        </div>

                        <div class="ref-card-content ${isBible ? 'bible-clickable-area' : ''}" 
                             ${isBible ? `onclick="this.parentElement.classList.toggle('bible-open')"` : ""}>
                            <div style="padding-left: 5px; margin-bottom: 2px;">
                                <div style="font-size:0.72em; font-weight:bold; color:${color}; text-transform:uppercase; margin-bottom:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">
                                    ${icon} ${label}
                                </div>
                                <div class="ref-title-text" 
                                     style="font-weight:bold; font-size:0.95em; color:var(--text-color); padding-right:75px; ${isJumpable ? 'cursor:pointer;' : ''}"
                                     onclick="${isJumpable ? `window.openNoteFromBoard('${item.noteId}', '${encodeURIComponent(titleText)}'); event.stopPropagation();` : ''}"
                                     onmouseover="${isJumpable ? "this.style.textDecoration='underline'" : ""}"
                                     onmouseout="this.style.textDecoration='none'">
                                    ${titleText}
                                </div>
                            </div>
                            
                            ${isBible ? 
                                `<div class="bible-collapsible-content">${bodyText}</div>` : 
                                `<div class="post-view-content" style="font-size:0.9em; color:var(--text-muted-color); padding-left: 8px; line-height:1.4; margin-top:8px; user-select:text;">${bodyText}</div>`
                            }
                        </div>`;
                    
                    tempFragment.appendChild(card);
                }
                
                if (thisVersion === currentDossieVersion) {
                    container.innerHTML = ''; 
                    container.appendChild(tempFragment);
                }
            }
        } else {
            // ==========================================
            // MODO: LISTA DE MICAS (PASTAS)
            // ==========================================
            titleEl.textContent = "Micas";
            backBtn.style.display = 'none';
            addBtn.style.display = 'none';
            bibleBtn.style.display = 'none';
            editBtn.style.display = 'block';
            editActions.style.display = (window.isDossieEditMode) ? 'flex' : 'none';

            if (dossieData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Nenhuma mica criada.</p>';
            } else {
                const listFragment = document.createDocumentFragment();
                dossieData.forEach((mica) => {
                    const div = document.createElement('div');
div.className = 'mica-card';
div.style.borderLeft = `6px solid ${mica.color || '#95a5a6'}`;

// Mantemos o efeito visual de transi√ß√£o suave
div.style.transition = "transform 0.1s, opacity 0.1s";
div.style.padding = "10px 15px"; // Ajuste fino direto aqui para garantir que fique elegante

div.innerHTML = `
    <div style="pointer-events: none;"> 
        <strong style="color:var(--text-color); display:block; font-size: 1.05em;">${mica.name}</strong>
        ${mica.description ? `<p style="margin:2px 0 0 0; font-size:0.82em; color:var(--text-muted-color);">${mica.description}</p>` : ''}
    </div>
    ${window.isDossieEditMode ? `
       <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px; border-top:1px solid var(--border-color); padding-top:8px;">
        <button onclick="event.stopPropagation(); window.changeMicaColor(event, '${mica.id}')" style="font-size:12px; cursor:pointer;">üé®</button>
        <button onclick="event.stopPropagation(); window.moveMica('${mica.id}', -1)" style="font-size:12px; cursor:pointer;">‚Üë</button>
        <button onclick="event.stopPropagation(); window.moveMica('${mica.id}', 1)" style="font-size:12px; cursor:pointer;">‚Üì</button>
        <button onclick="event.stopPropagation(); window.deleteMica('${mica.id}')" style="color:#e74c3c; font-size:12px; cursor:pointer;">üóëÔ∏è</button>
    </div>
    ` : ''}`;

                   // --- O SEGREDO DA ABERTURA IMEDIATA ---
    // Evento de clique para abrir
div.onclick = (e) => {
    if (e.target.closest('button')) return;
    
    // Efeito visual de "apertar"
    div.style.transform = "scale(0.97)";
    div.style.opacity = "0.7";

    window.activeMicaId = mica.id;
    
    // Abertura r√°pida
    setTimeout(() => {
        window.renderDossie();
    }, 50);
};

    listFragment.appendChild(div);
});
                if (thisVersion === currentDossieVersion) {
                    container.innerHTML = '';
                    container.appendChild(listFragment);
                }
            }
        }
    } catch (error) {
        if (thisVersion === currentDossieVersion) {
            console.error("Erro no Dossi√©:", error);
            container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar dados.</p>';
        }
    }
};

// 2. Outras fun√ß√µes expostas globalmente
window.moveMica = async function(id, dir) {
    const col = getCollectionFromType(activeReferenceEntity.type);
    const docRef = doc(db, col, activeReferenceEntity.id);
    const snap = await getDoc(docRef);
    let dossie = snap.data().dossie || [];
    const idx = dossie.findIndex(m => m.id === id);
    const newIdx = idx + dir;
    if (newIdx >= 0 && newIdx < dossie.length) {
        [dossie[idx], dossie[newIdx]] = [dossie[newIdx], dossie[idx]];
        await updateDoc(docRef, { dossie });
        window.renderDossie();
    }
};

window.deleteMica = async function(id) {
    if (!confirm("Apagar esta Mica e todo o seu conte√∫do?")) return;
    const col = getCollectionFromType(activeReferenceEntity.type);
    const docRef = doc(db, col, activeReferenceEntity.id);
    const snap = await getDoc(docRef);
    const dossie = (snap.data().dossie || []).filter(m => m.id !== id);
    await updateDoc(docRef, { dossie });
    window.renderDossie();
};

window.removeItemFromMica = async function(itemIdx) {
    // Pedimos confirma√ß√£o apenas para evitar cliques acidentais
    if (!confirm("Remover esta cita√ß√£o do Dossi√©?")) return;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const snap = await getDoc(docRef);

        if (!snap.exists()) return;

        let dossie = snap.data().dossie || [];
        // Encontra a mica onde estamos atualmente
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica && mica.items) {
            // Remove o item pelo √≠ndice
            mica.items.splice(itemIdx, 1);

            // Grava o dossie atualizado de volta no documento da entidade
            await updateDoc(docRef, { dossie: dossie });
            
            // Recarrega a interface
            window.renderDossie();
        }
    } catch (e) {
        console.error("Erro ao remover item da mica:", e);
        alert("Erro ao remover item.");
    }
};

// 3. Listeners de bot√µes (IDs fixos)
document.getElementById('add-mica-btn').onclick = async () => {
    // 1. Pedir o nome da Mica (Usa o teu modal de input personalizado)
    const result = await showCustomInput("Nova Mica", "Ex: Promessas, Profecias...");
    
    if (result && result.name) {
        const { id, type, name } = activeReferenceEntity;
        const collectionName = getCollectionFromType(type);
        
        // Refer√™ncia para o documento (pode ser o ID hexadecimal ou o nome do vers√≠culo)
        let docRef = doc(db, collectionName, id);
        let docSnap = await getDoc(docRef);

        // --- AJUSTE PARA VERS√çCULOS NOVOS ---
        // Se o documento n√£o existe (comum em vers√≠culos acabados de abrir), criamos agora
        if (!docSnap.exists()) {
            // Se for vers√≠culo, o 'id' costuma ser o pr√≥prio nome (ex: "Jo√£o 3:16")
            // Criamos o registo privado para o utilizador poder ter o seu Dossi√™/Micas
            await setDoc(docRef, {
                nome: name,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                dossie: [] 
            }, { merge: true });
            
            // Recarrega o snapshot ap√≥s criar
            docSnap = await getDoc(docRef);
        }

        const dossie = docSnap.data().dossie || [];
        
        // 2. Adicionar a nova Mica ao array
        dossie.push({
            id: 'mica_' + Date.now(),
            name: result.name,
            description: result.description || '',
            color: '#95a5a6', // Cinza padr√£o
            items: []
        });
        
        // 3. Gravar de volta no Firebase
        await updateDoc(docRef, { dossie: dossie });
        
        // 4. Feedback visual e fechar teclado
        if (document.activeElement) document.activeElement.blur();
        window.renderDossie();
    }
};

document.getElementById('mica-back-btn').onclick = () => {
    window.activeMicaId = null;
    window.renderDossie();
};

// --- IMPORTANTE: Coloque estas fun√ß√µes no seu script debaixo das l√≥gicas de Mica ---

// ============================================================
// MOTOR DA B√çBLIA PARA O DOSSI√â (MICAS)
// ============================================================

// 1. A√á√ÉO AO CLICAR NO BOT√ÉO "+B√≠blia"
document.getElementById('mica-add-bible-btn').onclick = () => {
    const modal = document.getElementById('mica-bible-modal');
    const bookSelect = document.getElementById('bible-book-select');
    const chapterSelect = document.getElementById('bible-chapter-select');
    const container = document.getElementById('verse-inputs-container');
    const titleInput = document.getElementById('bible-card-title');

    if (!modal) return;

    // For√ßar o modal para o topo do body (evita ficar escondido)
    document.body.appendChild(modal);
    
    titleInput.value = "";
    container.innerHTML = "";
    
    // Preenche livros
    bookSelect.innerHTML = BIBLE_DATA.map(b => `<option value="${b.nome}">${b.nome}</option>`).join('');
    
    const updateVerseLimits = () => {
        const book = BIBLE_DATA.find(b => b.nome === bookSelect.value);
        chapterSelect.innerHTML = Array.from({length: book.caps}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
        container.innerHTML = "";
        window.addMicaVerseRow('single'); // Nome corrigido aqui
    };

    bookSelect.onchange = updateVerseLimits;
    chapterSelect.onchange = () => { 
        container.innerHTML = ""; 
        window.addMicaVerseRow('single'); // Nome corrigido aqui
    };

    // Inicializa os limites
    updateVerseLimits();

    // Ligar bot√µes internos do modal com nomes corrigidos
    document.getElementById('add-single-verse-btn').onclick = (e) => { 
        e.preventDefault(); 
        window.addMicaVerseRow('single'); 
    };
    document.getElementById('add-range-verse-btn').onclick = (e) => { 
        e.preventDefault(); 
        window.addMicaVerseRow('range'); 
    };

    // MOSTRAR MODAL
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
};

// 2. ATUALIZAR DROPDOWNS (CAP√çTULOS E LIMITES DE VERS√çCULOS)
function updateMicaBibleDropdowns() {
    const bookName = document.getElementById('bible-book-select').value;
    const chapterSelect = document.getElementById('bible-chapter-select');
    const book = BIBLE_DATA.find(b => b.nome === bookName);

    // Se o cap√≠tulo selecionado for maior que o novo livro permite, reseta para 1
    let currentCap = parseInt(chapterSelect.value) || 1;
    if (currentCap > book.caps) currentCap = 1;

    // Atualizar dropdown de cap√≠tulos
    chapterSelect.innerHTML = Array.from({length: book.caps}, (_, i) => 
        `<option value="${i+1}" ${i+1 === currentCap ? 'selected' : ''}>${i+1}</option>`
    ).join('');

    // Sempre que mudar Livro ou Cap√≠tulo, resetamos as linhas de vers√≠culos para evitar erros de limites
    const container = document.getElementById('verse-inputs-container');
    if (container.innerHTML !== "") {
        container.innerHTML = "";
        addVerseRow('single');
    }
}

// 3. ADICIONAR LINHA DE VERS√çCULO (Simples ou Intervalo)
window.addMicaVerseRow = (type) => {
    const container = document.getElementById('verse-inputs-container');
    const bookSelect = document.getElementById('bible-book-select');
    const chapterSelect = document.getElementById('bible-chapter-select');

    // Preparar as op√ß√µes de vers√≠culos
    const book = BIBLE_DATA.find(b => b.nome === bookSelect.value);
    const totalV = book.versiculos[parseInt(chapterSelect.value) - 1] || 50;
    const options = Array.from({length: totalV}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');

    // Pegamos na √∫ltima linha que est√° no container
    const lastRow = container.lastElementChild;

    // --- SE FOR INTERVALO: TRANSFORMAR A LINHA ATUAL SE ELA FOR SIMPLES ---
    if (type === 'range' && lastRow && lastRow.dataset.type === 'single') {
        console.log("üõ†Ô∏è Transformando linha atual em intervalo...");
        lastRow.dataset.type = 'range'; // Muda o estado para intervalo

        const separator = document.createElement('span');
        separator.textContent = '-';
        separator.style.padding = '0 4px';
        separator.style.color = 'var(--text-muted-color)';

        const selectEnd = document.createElement('select');
        selectEnd.className = 'codex-input-modern v-end';
        selectEnd.style.flex = '1';
        selectEnd.innerHTML = options;

        // Inserir ANTES do bot√£o de apagar (o √∫ltimo elemento da linha)
        const delBtn = lastRow.querySelector('button');
        lastRow.insertBefore(separator, delBtn);
        lastRow.insertBefore(selectEnd, delBtn);
        return; 
    }

    // --- CASO CONTR√ÅRIO: CRIAR LINHA NOVA (Normal) ---
    const row = document.createElement('div');
    row.className = 'verse-selection-row';
    row.style.cssText = "display:flex; align-items:center; gap:8px; margin-bottom:8px;";
    row.dataset.type = type;

    if (type === 'single') {
        row.innerHTML = `<select class="codex-input-modern v-start" style="flex:1">${options}</select>`;
    } else {
        row.innerHTML = `
            <select class="codex-input-modern v-start" style="flex:1">${options}</select>
            <span style="color:var(--text-muted-color);">-</span>
            <select class="codex-input-modern v-end" style="flex:1">${options}</select>
        `;
    }

    const delBtn = document.createElement('button');
    delBtn.innerHTML = '√ó';
    delBtn.style.cssText = "background:none; border:none; color:#e74c3c; cursor:pointer; font-size:22px; font-weight:bold; padding:0 5px;";
    delBtn.onclick = () => {
        if (container.querySelectorAll('.verse-selection-row').length > 1) row.remove();
    };

    row.appendChild(delBtn);
    container.appendChild(row);
};

// Ligar bot√µes de + e - do modal
document.getElementById('add-single-verse-btn').onclick = (e) => { e.preventDefault(); addVerseRow('single'); };
document.getElementById('add-range-verse-btn').onclick = (e) => { e.preventDefault(); addVerseRow('range'); };

// 4. GRAVAR: FIREBASE + 4¬™ COLUNA
document.getElementById('confirm-mica-bible-save').onclick = async () => {
    const book = document.getElementById('bible-book-select').value;
    const chapter = document.getElementById('bible-chapter-select').value;
    const title = document.getElementById('bible-card-title').value.trim();
    const rows = document.querySelectorAll('.verse-selection-row');
    const myUid = auth.currentUser.uid;

    let parts = [];
    rows.forEach(r => {
        const s = r.querySelector('.v-start').value;
        if (r.dataset.type === 'range') {
            const e = r.querySelector('.v-end').value;
            parts.push(s === e ? s : (parseInt(s) < parseInt(e) ? `${s}-${e}` : `${e}-${s}`));
        } else parts.push(s);
    });

    const fullName = `${book} ${chapter}:${parts.join(',')}`;

    try {
        // Verifica se j√° existe no Firebase (textosbiblicos)
        const q = query(collection(db, 'textosbiblicos'), where('userId', '==', myUid), where('nome', '==', fullName));
        const snap = await getDocs(q);
        if (snap.empty) {
            await addDoc(collection(db, 'textosbiblicos'), {
                nome: fullName, userId: myUid, createdAt: serverTimestamp(), referencias: {}
            });
        }

        // Adiciona ao Dossi√© da Mica ativa
        const col = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, col, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        const dossie = docSnap.data().dossie || [];
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica) {
            const bibleSnippet = `
                <div class="bible-card-mica" style="border-left: 4px solid #9b59b6; padding-left:10px;">
                    ${title ? `<div style="font-weight:bold; color:var(--accent-color); margin-bottom:4px;">${title}</div>` : ''}
                    <div style="font-size: 1.1em; color:var(--text-color);">üìú ${fullName}</div>
                </div>`;
            if (!mica.items) mica.items = [];
            mica.items.push({
                noteId: 'bible_internal', noteName: fullName, title: title, snippet: encodeURIComponent(bibleSnippet)
            });
            await updateDoc(docRef, { dossie });
            document.getElementById('mica-bible-modal').style.display = 'none';
            window.renderDossie(); // Atualiza a vista da Mica
        }
    } catch (e) { console.error(e); alert("Erro ao gravar."); }
};

async function renderUniversalTextSearch(name) {
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar notas...</span></div>';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        allCitationsResults = [];

        const wholeWordRegex = new RegExp(`\\b${escapeRegExp(name)}\\b`, 'i');

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const content = data.conteudo || "";
            let isProtected = (data.passe && data.passe.trim() !== "");
            if (isProtected && !appSettings.searchAnchorsInProtected) return;

            if (wholeWordRegex.test(content)) {
                const snippet = generateReferenceContext(content, name);
                allCitationsResults.push({
                    id: docSnap.id,
                    name: data.nome,
                    isProtected: isProtected,
                    snippet: snippet,
                    ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
                });
            }
        });

        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);
        window.renderCitationsPage(false);

    } catch (e) {
        console.error("Erro na busca universal:", e);
        listElement.innerHTML = '<li>Erro ao carregar cita√ß√µes.</li>';
    }
}
window.renderCitationsPage = function(append = false) {
    const listElement = document.getElementById('references-list');
    if (!listElement) return;

    if (!append) {
        listElement.innerHTML = '';
        currentCitationsPageIndex = 0;
    }

    // Remove o bot√£o "Carregar mais" antigo se ele existir
    const oldBtn = document.getElementById('load-more-citations-btn');
    if (oldBtn) oldBtn.remove();

    if (allCitationsResults.length === 0) {
        listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhuma cita√ß√£o encontrada.</li>';
        return;
    }

    // Define quantos itens mostrar (usa a constante CITATIONS_PER_PAGE ou o padr√£o 10)
    const perPage = typeof CITATIONS_PER_PAGE !== 'undefined' ? CITATIONS_PER_PAGE : 10;
    const start = currentCitationsPageIndex * perPage;
    const end = start + perPage;
    const pageItems = allCitationsResults.slice(start, end);

    pageItems.forEach(item => {
        const details = document.createElement('details');
        details.className = 'reference-item';
        
        // Prote√ß√£o para caracteres especiais no nome e snippet
        const safeName = encodeURIComponent(item.name);
        const safeSnippet = encodeURIComponent(item.snippet);

        details.innerHTML = `
            <summary>
                <div class="ref-item-header">
                    <button class="add-to-puzzle-btn" title="Adicionar ao Quadro" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${item.id}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                    <span class="ref-item-title">${item.isProtected ? 'üîí' : 'üìÑ'} ${item.name}</span>
                    <button class="go-to-note-btn" onclick="event.preventDefault(); event.stopPropagation(); window.navigateToNoteSmart('${item.id}')" title="Ir para a nota">‚ûî</button>
                </div>
            </summary>
            <div class="reference-context">${item.snippet}</div>
        `;
        listElement.appendChild(details);
    });

    // Adiciona o bot√£o "Mostrar mais" se houver mais resultados
    if (end < allCitationsResults.length) {
        currentCitationsPageIndex++;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-citations-btn';
        loadMoreBtn.style.cssText = "width: 100%; margin: 15px 0; padding: 12px; border: 1px dashed var(--accent-color); color: var(--accent-color); background: none; cursor: pointer; font-weight: bold; border-radius: 6px;";
        loadMoreBtn.textContent = `+ resultados (${allCitationsResults.length - end} restantes)`;
        loadMoreBtn.onclick = () => window.renderCitationsPage(true);
        listElement.appendChild(loadMoreBtn);
    }
};

async function fetchBibleRangeText(fullRef) {
    // Regex para separar Livro Cap√≠tulo:Vers√≠culos
    const match = fullRef.match(/(.+)\s(\d+):(.+)/);
    if (!match) return await fetchBibleText(fullRef);

    const book = match[1];
    const chapter = match[2];
    const versePart = match[3];
    let allTexts = [];

    // Lida com m√∫ltiplos segmentos (ex: 1-3, 5)
    const segments = versePart.split(',');

    for (const segment of segments) {
        if (segment.includes('-')) {
            // √â um intervalo (ex: 1-5)
            const [start, end] = segment.split('-').map(Number);
            for (let v = start; v <= end; v++) {
                const text = await fetchBibleText(`${book} ${chapter}:${v}`);
                if (text) allTexts.push(text.trim());
            }
        } else {
            // √â um vers√≠culo √∫nico
            const text = await fetchBibleText(`${book} ${chapter}:${segment.trim()}`);
            if (text) allTexts.push(text.trim());
        }
    }

    return allTexts.length > 0 ? allTexts.join(' ') : null;
}

// --- L√ìGICA DE REORDENA√á√ÉO DO DOSSI√â ---
const dossieContainer = document.getElementById('dossie-list-container');



// --- L√ìGICA DE MOVIMENTO POR BOT√ïES NO DOSSI√â ---
window.moveMicaItem = async function(oldIdx, direction) {
    const newIdx = oldIdx + direction;
    
    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) return;

        let dossie = docSnap.data().dossie || [];
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica && mica.items) {
            // Verifica se o movimento √© v√°lido (dentro dos limites do array)
            if (newIdx < 0 || newIdx >= mica.items.length) return;

            // Troca os itens de lugar
            const item = mica.items[oldIdx];
            mica.items.splice(oldIdx, 1);
            mica.items.splice(newIdx, 0, item);

            // Grava no Firebase
            await updateDoc(docRef, { dossie: dossie });
            
            // Recarrega a vista imediatamente
            window.renderDossie();
        }
    } catch (e) {
        console.error("Erro ao mover item da mica:", e);
    }
};

// --- GATILHO DO BOT√ÉO EDITAR DO DOSSI√â ---
document.getElementById('toggle-dossie-edit-btn').addEventListener('click', () => {
    // 1. Inverte o valor (se era falso fica verdadeiro, e vice-versa)
    window.isDossieEditMode = !window.isDossieEditMode;
    
    // 2. Chama a fun√ß√£o de renderiza√ß√£o para mostrar as setas e o bot√£o "+ Micas"
    window.renderDossie();
});

// Vari√°vel para saber qual Mica estamos a pintar
let activeMicaIdForColor = null;

// 1. FUN√á√ÉO PARA ABRIR O POPUP DE CORES
window.changeMicaColor = function(event, micaId) {
    // 1. Para o evento aqui tamb√©m por seguran√ßa
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    activeMicaIdForColor = micaId;
    const popup = document.getElementById('mica-color-popup');
    if (!popup) return;

    // 2. Garante que o popup est√° no body para n√£o ser cortado pelo painel lateral
    document.body.appendChild(popup);

    // 3. Preenche as cores se estiver vazio
    if (popup.innerHTML === '') {
        popup.style.display = 'grid'; // Define como grid antes de calcular
        MICA_COLORS.forEach(color => {
            const dot = document.createElement('div');
            dot.className = 'mica-color-dot';
            dot.style.backgroundColor = color.hex;
            dot.title = color.name;
            dot.style.cursor = 'pointer';
            dot.onclick = (e) => {
                e.stopPropagation();
                window.applyColorToMica(color.hex);
            };
            popup.appendChild(dot);
        });
    }

    // 4. Posicionamento Inteligente (Fixed)
    const rect = event.target.getBoundingClientRect();
    popup.style.position = 'fixed';
    popup.style.display = 'grid';
    popup.style.zIndex = '10000000'; // Valor absurdo para ficar √† frente de tudo
    
    // Calcula a posi√ß√£o (ajusta se estiver muito perto do fundo da tela)
    let top = rect.bottom + 5;
    if (top + 150 > window.innerHeight) top = rect.top - 155;

    popup.style.top = top + 'px';
    popup.style.left = (rect.left - 60) + 'px';
};

// 2. FUN√á√ÉO PARA GRAVAR A COR NO FIREBASE
window.applyColorToMica = async function(hexColor) {
    if (!activeMicaIdForColor) return;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            let dossie = docSnap.data().dossie || [];
            const micaIndex = dossie.findIndex(m => m.id === activeMicaIdForColor);

            if (micaIndex > -1) {
                // Atualiza a cor no array
                dossie[micaIndex].color = hexColor;
                
                // Grava de volta no Firestore
                await updateDoc(docRef, { dossie: dossie });
                
                // Fecha o popup e atualiza a vista
                document.getElementById('mica-color-popup').style.display = 'none';
                window.renderDossie();
            }
        }
    } catch (e) {
        console.error("Erro ao mudar cor da mica:", e);
    }
};

// 3. FECHAR POPUP AO CLICAR FORA
document.addEventListener('click', (e) => {
    const popup = document.getElementById('mica-color-popup');
    if (popup && popup.style.display === 'grid' && !popup.contains(e.target) && !e.target.closest('button')) {
        popup.style.display = 'none';
    }
});


function loadPinsView() {
    // Limpeza de seguran√ßa para n√£o duplicar ouvintes
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }

    const listElement = document.getElementById('left-panel-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
    
    middlePanelTitle.textContent = "Selecione um Pin";
    middlePanelList.innerHTML = '<li style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Os detalhes aparecer√£o aqui ao clicar.</li>';

    const myUid = auth.currentUser.uid;
    
    const q = query(
        collection(db, 'pastas'), 
        where('userId', '==', myUid), 
        where('isPinned', '==', true),
        where('estado', '==', 'ativa'),
        orderBy('nome')
    );

    unsubscribeShared1 = onSnapshot(q, (snapshot) => {
        listElement.innerHTML = '';
        
        if (snapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Ainda n√£o tens Pins.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Atributos cruciais
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo); // O CSS usa isto para o √≠cone correto
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-pinned', 'true'); // O CSS usa isto para o Pin rosa
            
            // Adiciona a borda rosa lateral apenas nesta vista
            li.style.borderLeft = "4px solid #ff69b4";

            // REMOVIDO O ${icon} DAQUI PARA EVITAR DUPLICA√á√ÉO
            li.innerHTML = `<span>${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            // L√ìGICA DO SALTO
            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                middlePanelList.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

                navigateWithUnsavedCheck(async () => {
                    currentViewMode = 'local';
                    if (item.tipo === 'nota' || item.tipo === 'arquivo' || item.tipo === 'partilhado') {
                        await navigateToNoteSmart(item.id);
                    } else {
                        await reconstructFolderNavigation(item.id);
                    }

                    if (window.innerWidth <= 768) {
                        if (item.tipo === 'nota') document.body.classList.add('mobile-view-editor');
                        else document.body.classList.add('mobile-view-middle');
                    }
                });
            };

            listElement.appendChild(li);
        });
    });
}

// FUN√á√ÉO UNIVERSAL PARA RENOMEAR VIA POPUP
function openRenameModal(currentName, onConfirm) {
    const modal = document.getElementById('rename-modal');
    const input = document.getElementById('rename-input');
    const confirmBtn = document.getElementById('confirm-rename-btn');
    const cancelBtn = document.getElementById('cancel-rename-btn');

    input.value = currentName;
    modal.style.display = 'flex';
    setTimeout(() => { input.focus(); input.select(); }, 100);

    // Limpa listeners antigos
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    const closeModal = () => { modal.style.display = 'none'; };

    newConfirmBtn.onclick = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
            onConfirm(newName);
        }
        closeModal();
    };

    cancelBtn.onclick = closeModal;

    // Atalhos de teclado
    input.onkeydown = (e) => {
        if (e.key === 'Enter') newConfirmBtn.onclick();
        if (e.key === 'Escape') closeModal();
    };
}

// Fun√ß√£o para configurar e abrir o modal de cria√ß√£o de Temas/Subtemas
window.openCosmosCreator = function(targetType, parentId = null) {
    const modal = document.getElementById('cosmos-modal');
    if (!modal) return console.error("Modal #cosmos-modal n√£o encontrado!");

    // 1. MOVE PARA O BODY E DEFINE Z-INDEX ALTO
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 2. RESET DOS CAMPOS
    const nameInput = document.getElementById('cosmos-name-input');
    const descInput = document.getElementById('cosmos-desc-input');
    const title = document.getElementById('cosmos-modal-title');

    nameInput.value = "";
    descInput.value = "";
    selectedCosmosEmoji = targetType === 'cosmos' ? "üíº" : "üîπ"; 

    title.textContent = targetType === 'cosmos' ? "Novo Tema (Cosmos)" : "Novo Subtema";
    
    // Reset da sele√ß√£o de emojis visual
    document.querySelectorAll('#cosmos-emoji-grid .emoji-btn').forEach(b => b.classList.remove('selected'));

    setTimeout(() => nameInput.focus(), 100);

    // 3. RECONFIGURAR BOT√ÉO SALVAR (Clonar para limpar eventos)
    const saveBtn = document.getElementById('save-cosmos-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const nome = nameInput.value.trim();
        if (!nome) return alert("O nome √© obrigat√≥rio.");

        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A gravar...";

        try {
            const collectionName = targetType === 'cosmos' ? 'cosmos' : 'subcosmos';
            const data = {
                nome: nome,
                descricao: descInput.value.trim(),
                emoji: selectedCosmosEmoji,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            };

            if (targetType === 'subcosmos') data.cosmosId = parentId;

            await addDoc(collection(db, collectionName), data);

            modal.style.display = 'none';
            // Recarrega a lista lateral para o novo item aparecer
            if (typeof renderListCategoryItems === 'function') renderListCategoryItems('cosmos');
            
        } catch (e) {
            console.error("Erro ao criar item no Cosmos:", e);
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Criar";
        }
    };
};

function updateMobileFABVisibility() {
    // 1. Se n√£o for mobile (ecr√£ maior que 768px), n√£o faz nada
    if (window.innerWidth > 768) return;

    // 2. CONDI√á√ïES PARA MOSTRAR OS BOT√ïES:
    // - Tem de estar na aba 'Note'
    // - O modo tem de ser 'Local'
    // - N√£o pode estar dentro de nenhuma pasta (pilha de navega√ß√£o vazia)
    // - N√£o pode estar dentro de uma Superpasta (ID de isolamento nulo)
    const isLocalRoot = (currentTab === 'note') && 
                        (currentViewMode === 'local') && 
                        (navigationStack.length === 0) &&
                        (!SUPERFOLDER_ID);

    // 3. Aplica a classe ao body para o CSS mostrar/esconder
    if (isLocalRoot) {
        document.body.classList.add('show-fab');
    } else {
        document.body.classList.remove('show-fab');
    }
}

// Listener para sele√ß√£o de emojis no modal do Cosmos
document.getElementById('cosmos-emoji-grid').addEventListener('click', (e) => {
    const btn = e.target.closest('.emoji-btn');
    if (!btn || btn.id === 'custom-emoji-btn') return;

    const emoji = btn.dataset.emoji;
    if (emoji) {
        selectedCosmosEmoji = emoji;

        // 1. Remove a classe 'selected' de todos os bot√µes da grelha
        document.querySelectorAll('#cosmos-emoji-grid .emoji-btn').forEach(b => {
            b.classList.remove('selected');
        });

        // 2. Adiciona a classe ao bot√£o atual
        btn.classList.add('selected');
    }
});

// Fun√ß√£o auxiliar para quebrar a string de pesquisa em termos (considerando aspas ou espa√ßos)
function parseSearchQuery(query) {
    const terms = [];
    // Esta regex captura o que est√° entre aspas OU palavras soltas
    const regex = /"([^"]+)"|(\S+)/g;
    let match;

    while ((match = regex.exec(query)) !== null) {
        if (match[1]) {
            // Termo entre aspas (Exato)
            terms.push({ text: match[1], exact: true });
        } else if (match[2]) {
            // Termo solto (Abrangente)
            terms.push({ text: match[2], exact: false });
        }
    }
    return terms;
}

// ============================================================
// GEST√ÉO INTEGRAL DE GAVET√ïES (ARQUIVO) - VERS√ÉO CORRIGIDA
// ============================================================

// 1. FUN√á√ÉO MESTRE PARA ABRIR O MODAL DE CRIA√á√ÉO
function openCreateDrawerModal() {
    console.log("%c[GAVET√ÉO] üü¶ Iniciando Abertura Blindada...", "color: #3498db; font-weight: bold;");
    
    const modal = document.getElementById('create-drawer-modal');
    if (!modal) {
        console.error("ERRO: O elemento 'create-drawer-modal' n√£o existe no HTML!");
        return;
    }

    // --- TRUQUE MESTRE: MOVER O MODAL PARA O BODY ---
    // Isto retira o modal de dentro de qualquer div escondida e p√µe-no na raiz do site
    document.body.appendChild(modal);

    // Limpeza de campos
    document.getElementById('new-drawer-name').value = '';
    document.getElementById('new-drawer-desc').value = '';

    // --- FOR√áAR CSS ABSOLUTO VIA JS (Ignora o ficheiro CSS) ---
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.85) !important;
        z-index: 1000000 !important;
        align-items: center !important;
        justify-content: center !important;
    `;

    console.log("%c[GAVET√ÉO] Modal movido para o <body> e estilos for√ßados.", "color: #3498db;");

    setTimeout(() => {
        const input = document.getElementById('new-drawer-name');
        if(input) {
            input.focus();
            console.log("%c[GAVET√ÉO] Teclado/Foco acionado.", "color: #3498db;");
        }
    }, 200);
}

// 2. CONFIGURA√á√ÉO DOS TRIGGERS (BOT√ïES)
function setupDrawerEventListeners() {
    console.log("%c[SISTEMA] Configurando listeners dos Gavet√µes...", "color: #95a5a6;");

    // Bot√£o das Abas
    const mainBtn = document.getElementById('create-drawer-trigger-btn');
    if (mainBtn) {
        console.log("%c[OK] Bot√£o '+ Gavet√£o' encontrado.", "color: #2ecc71;");
        mainBtn.onclick = (e) => {
            console.log("%c[CLIQUE] Bot√£o '+ Gavet√£o' (Abas) clicado!", "background: #2ecc71; color: white; padding: 2px 5px;");
            e.preventDefault();
            window.postToAssignDrawer = null;
            openCreateDrawerModal();
        };
    } else {
        console.warn("%c[AVISO] Bot√£o 'create-drawer-trigger-btn' n√£o existe nesta vista ainda.", "color: #f39c12;");
    }

    // Bot√£o "+" dentro do seletor
    const popupBtn = document.getElementById('open-create-drawer-btn');
    if (popupBtn) {
        popupBtn.onclick = (e) => {
            console.log("%c[CLIQUE] Bot√£o '+' (Popup) clicado!", "background: #3498db; color: white; padding: 2px 5px;");
            e.preventDefault();
            e.stopPropagation();
            openCreateDrawerModal();
        };
    }
}

// Executa a configura√ß√£o inicial e tenta re-vincular quando muda de aba
setupDrawerEventListeners();

// 3. GRAVA√á√ÉO NO FIREBASE (Bot√£o "Criar")
const confirmCreateBtn = document.getElementById('confirm-create-drawer');
if (confirmCreateBtn) {
    confirmCreateBtn.onclick = async () => {
        console.log("%c[GAVET√ÉO] üíæ Tentando salvar novo Gavet√£o...", "color: #27ae60; font-weight: bold;");
        
        const name = document.getElementById('new-drawer-name').value.trim();
        const desc = document.getElementById('new-drawer-desc').value.trim();
        
        if(!name) {
            console.warn("%c[VALIDA√á√ÉO] Nome vazio. Abortando.", "color: #f39c12;");
            alert("O nome √© obrigat√≥rio.");
            return;
        }

        if (!currentArchiveId) {
            console.error("%c[ERRO] currentArchiveId est√° vazio!", "color: red;");
            alert("Erro: ID do Arquivo n√£o detetado.");
            return;
        }

        confirmCreateBtn.disabled = true;
        confirmCreateBtn.textContent = "A gravar...";

        try {
            const qDrawers = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId));
            const snap = await getDocs(qDrawers);
            
            await addDoc(collection(db, 'gavetoes'), {
                arquivoId: currentArchiveId,
                userId: auth.currentUser.uid,
                nome: name,
                descricao: desc,
                posts: [],
                ordem: snap.size,
                viewMode: 'full',
                createdAt: serverTimestamp()
            });

            console.log("%c[SUCESSO] Gavet√£o gravado no Firebase!", "color: #27ae60;");
            document.getElementById('create-drawer-modal').style.display = 'none';

            if (window.postToAssignDrawer) {
                window.openDrawerSelection(window.postToAssignDrawer);
            } else {
                renderArchiveFeed();
            }
        } catch (e) {
            console.error("Erro na grava√ß√£o:", e);
        } finally {
            confirmCreateBtn.disabled = false;
            confirmCreateBtn.textContent = "Criar";
        }
    };
}

// 4. SELECIONAR GAVET√ÉO (O resto da l√≥gica mant√©m-se est√°vel)
window.openDrawerSelection = async (postId) => {
    window.postToAssignDrawer = postId; 
    const modal = document.getElementById('drawer-selection-modal');
    const list = document.getElementById('drawer-list-select');
    list.innerHTML = '<li style="padding:10px; text-align:center;">A carregar...</li>';
    modal.style.display = 'flex';
    try {
        const q = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId), orderBy('ordem', 'asc'));
        const snap = await getDocs(q);
        list.innerHTML = '';
        if (snap.empty) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Sem gavet√µes.</li>';
            return;
        }
        snap.forEach(docSnap => {
            const drawer = { id: docSnap.id, ...docSnap.data() };
            const isInside = drawer.posts && drawer.posts.includes(postId);
            const li = document.createElement('li');
            li.className = 'list-item';
            if (isInside) { li.style.backgroundColor = 'rgba(46, 204, 113, 0.1)'; li.style.borderLeft = '4px solid #2ecc71'; }
            li.innerHTML = `<span>üìÇ ${drawer.nome}</span><span style="color:#2ecc71; font-weight:bold;">${isInside ? '‚úì' : ''}</span>`;
            li.onclick = () => togglePostInDrawer(drawer.id, isInside);
            list.appendChild(li);
        });
    } catch (e) { console.error(e); }
};



window.openGaveta = async (gavetaId) => {
    console.group(`üìÇ [SISTEMA] Abrindo Gaveta: ${gavetaId}`);
    
    // 1. AUTO-SAVE: Se houver algum post em edi√ß√£o (na Prateleira ou noutra Gaveta), 
    // guarda-o e liberta o cadeado antes de mudar de vista.
    const idToSave = activeEditingPostId || window.activeEditingPostId;
    if (idToSave) {
        console.log("üíæ [AUTO-SAVE] Gravando post ativo antes de entrar na gaveta...");
        await window.saveArchivePost(idToSave);
    }

    try {
        // 2. BUSCAR DADOS: Obt√©m os dados da gaveta diretamente do Firestore
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docSnap = await getDoc(doc(db, 'gavetas', gavetaId));
        
        if (docSnap.exists()) {
            const data = docSnap.data();

            // 3. DEFINIR ESTADO GLOBAL: Define o ID no window para que o bot√£o "Voltar"
            // e os scripts de movimento saibam onde estamos.
            window.activeGavetaId = gavetaId;
            
            // 4. PREPARAR DADOS DE VISTA: Carrega os posts e metadados
            window.activeGavetaData = { 
                id: docSnap.id, 
                ...data,
                // Define o modo 'titles' (acorde√£o) como padr√£o ao entrar
                viewMode: data.viewMode || 'titles' 
            };
            
            console.log("‚úÖ Gaveta carregada. Modo atual:", window.activeGavetaData.viewMode);

            // 5. RENDERIZAR: Chama a fun√ß√£o global que desenha o feed
            if (typeof window.renderArchiveFeed === 'function') {
                window.renderArchiveFeed();
            } else {
                console.error("‚ùå Erro: window.renderArchiveFeed n√£o encontrada no escopo global.");
            }

        } else {
            console.error("‚ùå Erro: O documento da gaveta n√£o existe no Firebase.");
        }
    } catch (e) {
        console.error("‚ùå Erro ao abrir gaveta:", e);
        alert("Erro ao aceder √† pasta. Verifique a sua liga√ß√£o.");
    }
    console.groupEnd();
};

function renderOpenedGavetaView(feed, allPosts) {
    if (!window.activeGavetaData) return;

    const viewMode = window.activeGavetaData.viewMode || 'titles';
    const orderArray = window.activeGavetaData.posts || [];
    const sepMetadata = window.activeGavetaData.separatorData || {};
    const isFullView = (viewMode === 'full'); // üëÅÔ∏è modo completo
    
    feed.innerHTML = '';

    // --- CABE√áALHO ---
    const header = document.createElement('div');
    header.style.cssText = "display: flex; align-items: center; padding: 15px; background: var(--panel-color); border-radius: 8px; border-left: 5px solid var(--accent-color); margin-bottom: 20px;";
    header.innerHTML = `
        <button class="mini-btn" onclick="window.activeGavetaId=null; window.renderArchiveFeed();" style="margin-right: 15px;"> ‚Üê Voltar </button>
        <strong style="color: white; font-size: 1.1em;">üìÅ ${window.activeGavetaData.nome}</strong>
        <button onclick="window.toggleGavetaViewMode()" title="Alternar visualiza√ß√£o" 
                style="margin-left: auto; background: none; border: none; font-size: 20px; cursor: pointer; opacity: ${isFullView ? '1' : '0.4'};">
            ${isFullView ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
        </button>
    `;
    feed.appendChild(header);

    if (orderArray.length === 0) {
        feed.innerHTML += `<div style="text-align:center; padding:50px; color:#888; font-style:italic;">Gaveta vazia.</div>`;
        return;
    }

    // --- LISTAGEM ---
    orderArray.forEach((id) => {
        if (id.startsWith('sep_')) {
            // --- RENDERIZAR SEPARADOR VERDE ---
            const info = sepMetadata[id] || { title: "Separador" };
            const sepDiv = document.createElement('div');
            sepDiv.className = 'archive-separator';
            
            // L√≥gica: S√≥ inclui a div 'drawer-controls' se for Full View (üëÅÔ∏è)
            const controlsHTML = isFullView ? `
                <div class="drawer-controls">
                    <button class="mini-btn" onclick="window.movePostInGaveta('${id}', -1)">‚Üë</button>
                    <button class="mini-btn" onclick="window.movePostInGaveta('${id}', 1)">‚Üì</button>
                    <button class="mini-btn" onclick="window.editSeparator('${id}', '${info.title}')">Editar</button>
                    <button class="mini-btn" style="color:#e74c3c" onclick="window.deleteSeparator('${id}')">√ó</button>
                </div>` : '';

            sepDiv.innerHTML = `
                <span class="separator-title"># ${info.title}</span>
                ${controlsHTML}
            `;
            feed.appendChild(sepDiv);

        } else {
            // --- RENDERIZAR POST ---
            const post = allPosts.find(p => p.id === id);
            if (post) {
                const postEl = createPostElement(post);
                const controls = postEl.querySelector('.post-controls');
                
                // Injetar controlos se for Full View, sen√£o limpa-os
                if (controls) {
                    if (isFullView) {
                        controls.innerHTML = `
                            <button class="mini-btn" onclick="window.movePostInGaveta('${post.id}', -1)">‚Üë</button>
                            <button class="mini-btn" onclick="window.movePostInGaveta('${post.id}', 1)">‚Üì</button>
                            <button class="mini-btn" onclick="window.editArchivePost('${post.id}')">Editar</button>
                            <button class="mini-btn" title="Remover da Gaveta" onclick="window.togglePostInGaveta('${window.activeGavetaId}', true, '${post.id}')">√ó</button>
                        `;
                        controls.style.display = 'flex';
                        controls.style.opacity = '1';
                    } else {
                        controls.style.display = 'none';
                    }
                }

                // Modo T√≠tulos (Acorde√£o)
                if (!isFullView) {
                    const content = postEl.querySelector('.post-view-content');
                    const footer = postEl.querySelector('.post-footer');
                    if (content) content.style.display = 'none';
                    if (footer) footer.style.display = 'none';
                    
                    postEl.style.cursor = "pointer";
                    postEl.onclick = (e) => {
                        if (e.target.closest('button')) return;
                        const isCollapsed = content.style.display === 'none';
                        content.style.display = isCollapsed ? 'block' : 'none';
                        footer.style.display = isCollapsed ? 'flex' : 'none';
                        postEl.style.backgroundColor = isCollapsed ? "rgba(255,255,255,0.03)" : "";
                    };
                }
                feed.appendChild(postEl);
            }
        }
    });
}

 





window.togglePostInGaveta = async (gavetaId, alreadyPresent) => {
    if (!window.postToAssignDrawer) return;
    
    try {
        const { arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', gavetaId);
        
        if (alreadyPresent) {
            await updateDoc(gavetaRef, { posts: arrayRemove(window.postToAssignDrawer) });
        } else {
            await updateDoc(gavetaRef, { posts: arrayUnion(window.postToAssignDrawer) });
        }
        
        // --- FEEDBACK IMEDIATO ---
        // Recarrega a lista do popup para o utilizador ver o "visto" (‚úì)
        window.openGavetaSelection(window.postToAssignDrawer);
        
        // Se estivermos a ver a gaveta aberta ao fundo, atualiza a vista para o post aparecer/sumir
        if (window.activeGavetaId) renderArchiveFeed();
        
    } catch (e) {
        console.error("Erro ao vincular post √† gaveta:", e);
    }
};

// --- FUN√á√ïES GLOBAIS PARA O ARQUIVO ---

// 1. Apagar Gavet√£o (O "x" pequeno no canto)
window.deleteGavetao = async (id) => {
    const confirmed = await showConfirmation("Eliminar Gavet√£o?", "Isto apagar√° o Gavet√£o e todas as Gavetas dentro dele.");
    if(confirmed) {
        try {
            // Apaga as gavetas ligadas a ele
            const q = query(collection(db, 'gavetas'), where('gavetaoId', '==', id));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            
            // Apaga o gavet√£o
            batch.delete(doc(db, 'gavetoes', id));
            await batch.commit();
            renderArchiveFeed();
        } catch (e) { console.error("Erro ao apagar:", e); }
    }
};


// 3. Abrir o Modal de Criar Gaveta (O bot√£o "+")
window.openCreateGavetaModal = (gavetaoId) => {
    console.log(`%c[GAVETA] ‚ûï Abrindo modal para o Gavet√£o: ${gavetaoId}`, "color: #3498db; font-weight: bold;");

    const modal = document.getElementById('create-gaveta-modal');
    
    if (!modal) {
        console.error("‚ùå ERRO: Elemento 'create-gaveta-modal' n√£o encontrado!");
        return;
    }

    // 1. Mover o modal para o body para evitar que fique preso em divs com scroll ou z-index baixo
    document.body.appendChild(modal);

    // 2. Limpar campos
    document.getElementById('new-gaveta-name').value = "";
    document.getElementById('new-gaveta-desc').value = "";

    // 3. For√ßar visibilidade m√°xima via JS (ignora conflitos de CSS)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.85) !important;
        z-index: 2000000 !important; 
        align-items: center !important;
        justify-content: center !important;
    `;

    // 4. Configurar o bot√£o de confirma√ß√£o
    const confirmBtn = document.getElementById('confirm-create-gaveta');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        const name = document.getElementById('new-gaveta-name').value.trim();
        const desc = document.getElementById('new-gaveta-desc').value.trim();

        if (!name) return alert("O nome da gaveta √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A criar...";

        try {
            // Conta quantas gavetas j√° existem para definir a ordem
            const q = query(collection(db, 'gavetas'), where('gavetaoId', '==', gavetaoId));
            const snap = await getDocs(q);

            await addDoc(collection(db, 'gavetas'), {
                gavetaoId: gavetaoId,
                nome: name,
                descricao: desc,
                posts: [],
                ordem: snap.size,
                 viewMode: 'titles', 
                viewMode: 'full',
                createdAt: Date.now()
            });

            console.log("‚úÖ Gaveta criada com sucesso!");
            modal.style.display = 'none';
            renderArchiveFeed(); // Recarrega a lista para mostrar a nova pasta
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar gaveta:", error);
            alert("Erro ao salvar no banco de dados.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Criar";
        }
    };
    
    // Focar no input ap√≥s abrir
    setTimeout(() => {
        const input = document.getElementById('new-gaveta-name');
        if(input) input.focus();
    }, 200);
};



// 5. Apagar Gaveta interna
window.deleteGaveta = async (id) => {
    if (confirm("Apagar esta gaveta?")) {
        await deleteDoc(doc(db, 'gavetas', id));
        renderArchiveFeed();
    }
};

window.moveGavetao = async (drawerId, direction) => {
    console.log("üì¶ Movendo Gavet√£o:", drawerId);
    try {
        const q = query(
            collection(db, 'gavetoes'), 
            where('arquivoId', '==', currentArchiveId), 
            orderBy('ordem', 'asc')
        );
        const snap = await getDocs(q);
        const drawers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const index = drawers.findIndex(d => d.id === drawerId);
        const targetIndex = index + direction;

        if (targetIndex >= 0 && targetIndex < drawers.length) {
            const batch = writeBatch(db);
            batch.update(doc(db, 'gavetoes', drawers[index].id), { ordem: targetIndex });
            batch.update(doc(db, 'gavetoes', drawers[targetIndex].id), { ordem: index });
            await batch.commit();
            renderArchiveFeed();
        }
    } catch (e) {
        console.error("Erro ao mover gavet√£o:", e);
    }
};



window.openGavetaSelection = async (postId) => {
    console.log("üìÇ [SISTEMA] Abrindo seletor para:", postId);
    
    const modal = document.getElementById('drawer-selection-modal');
    const list = document.getElementById('drawer-list-select');
    const modalTitle = modal.querySelector('h3');
    
    if (!modal || !list) return;

    window.postToAssignDrawer = postId; 
    modalTitle.textContent = "Guardar em qual Gaveta?";
    list.innerHTML = '<li style="padding:20px; text-align:center;"><div class="spinner"></div><p>A organizar...</p></li>';
    
    modal.style.display = 'flex';
    modal.style.zIndex = "1000000"; 
    document.body.appendChild(modal);

    try {
        const arcId = typeof currentArchiveId !== 'undefined' ? currentArchiveId : null;
        if (!arcId) return;

        const qGavetoes = query(
            collection(db, 'gavetoes'), 
            where('arquivoId', '==', arcId), 
            orderBy('ordem', 'asc')
        );
        const snapGavetoes = await getDocs(qGavetoes);
        
        list.innerHTML = '';

        if (snapGavetoes.empty) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Crie um Gavet√£o primeiro.</li>';
            return;
        }

        for (const gDoc of snapGavetoes.docs) {
            const gavetao = gDoc.data();
            
            const header = document.createElement('div');
            header.className = 'modal-gavetao-header';
            header.innerHTML = `üì¶ GAVET√ÉO: ${gavetao.nome}`;
            list.appendChild(header);

            const groupContainer = document.createElement('div');
            groupContainer.className = 'modal-gavetas-group';

            const qGavetas = query(
                collection(db, 'gavetas'), 
                where('gavetaoId', '==', gDoc.id), 
                orderBy('ordem', 'asc')
            );
            const snapGavetas = await getDocs(qGavetas);

            if (snapGavetas.empty) {
                groupContainer.innerHTML = '<small style="color:#555; padding:5px; font-style:italic;">(Vazio)</small>';
            } else {
                snapGavetas.forEach(gavDoc => {
                    const gaveta = { id: gavDoc.id, ...gavDoc.data() };
                    const isInside = (gaveta.posts || []).includes(postId);
                    
                    const li = document.createElement('li');
                    li.className = 'list-item gaveta-interna';
                    
                    // Reset de estilos para garantir alinhamento √† esquerda
                    li.style.display = "flex";
                    li.style.alignItems = "center";
                    li.style.justifyContent = "flex-start"; // For√ßa in√≠cio √† esquerda
                    li.style.textAlign = "left";
                    li.style.padding = "10px 12px";

                    if (isInside) {
                        li.style.borderLeft = '4px solid #2ecc71';
                        li.style.backgroundColor = 'rgba(46, 204, 113, 0.15)'; 
                    }

                    // Estrutura simplificada e colada √† esquerda
                    li.innerHTML = `
                        <span style="font-size:1.2em; margin-right:10px; flex-shrink:0;">üìÅ</span> 
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white; font-size:0.95em;">
                            ${gaveta.nome}
                        </span>
                    `;
                    
                    li.onclick = (e) => {
                        e.stopPropagation();
                        window.togglePostInGaveta(gaveta.id, isInside);
                    };
                    
                    groupContainer.appendChild(li);
                });
            }
            list.appendChild(groupContainer);
        }
    } catch (e) {
        console.error(e);
        list.innerHTML = '<li style="padding:10px; color:red;">Erro ao carregar dados.</li>';
    }
};

// Localiza o bot√£o + dentro do modal de sele√ß√£o
const manageBtn = document.getElementById('manage-topics-btn');

if (manageBtn) {
    // Clonamos para limpar qualquer listener antigo e garantir que o clique √© √∫nico
    const newManageBtn = manageBtn.cloneNode(true);
    manageBtn.parentNode.replaceChild(newManageBtn, manageBtn);

    newManageBtn.addEventListener('click', () => {
        console.log("‚ûï Abrindo modal de GEST√ÉO de t√≥picos (Camada Superior)...");
        
        const manageModal = document.getElementById('manage-topics-modal');
        if (!manageModal) return;

        // 1. MOVE PARA O BODY (Essencial para n√£o ficar preso atr√°s de nada)
        document.body.appendChild(manageModal);

        // 2. FOR√áA HIERARQUIA SUPERIOR
        // O primeiro modal tem 8.000.000, por isso este precisa de mais.
        manageModal.style.setProperty('display', 'flex', 'important');
        manageModal.style.setProperty('z-index', '9000000', 'important'); 
        manageModal.style.setProperty('visibility', 'visible', 'important');
        manageModal.style.setProperty('opacity', '1', 'important');

        // 3. Reseta o estado e carrega a lista
        activeTopicIdForManagement = null;
        renderManageTopicsList();
        
        // Limpa a coluna da direita do modal de gest√£o at√© selecionar um t√≥pico
        const subBtn = document.getElementById('create-new-subtopic-btn');
        if(subBtn) subBtn.style.display = 'none';
        
        const subList = document.getElementById('subtopics-list-manage');
        if(subList) subList.innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico para ver os subt√≥picos.</li>';
    });
}

const closeManageBtn = document.getElementById('close-manage-topics-btn');
if (closeManageBtn) {
    closeManageBtn.onclick = () => {
        document.getElementById('manage-topics-modal').style.display = 'none';
        // Atualiza a lista do primeiro modal caso tenhamos criado algo novo
        renderTopicsSelectionList(); 
    };
}


// A. BOT√ÉO CRIAR NOVO T√ìPICO
const createTopicBtn = document.getElementById('create-new-topic-btn');
if (createTopicBtn) {
    const newBtn = createTopicBtn.cloneNode(true);
    createTopicBtn.parentNode.replaceChild(newBtn, createTopicBtn);

    newBtn.addEventListener('click', async () => {
        console.log("üÜï Solicitando input para novo T√≥pico...");
        const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina, Estudo Pessoal...");
        
        if (result && result.name) {
            try {
                await addDoc(collection(db, 'topicos'), {
                    nome: result.name,
                    descricao: result.description,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                renderManageTopicsList(); // Atualiza a lista
            } catch (e) {
                console.error("Erro ao salvar t√≥pico:", e);
            }
        }
    });
}

// B. BOT√ÉO CRIAR NOVO SUBT√ìPICO
const createSubtopicBtn = document.getElementById('create-new-subtopic-btn');
if (createSubtopicBtn) {
    const newSubBtn = createSubtopicBtn.cloneNode(true);
    createSubtopicBtn.parentNode.replaceChild(newSubBtn, createSubtopicBtn);

    newSubBtn.addEventListener('click', async () => {
        if (!activeTopicIdForManagement) return alert("Selecione um t√≥pico pai primeiro.");

        const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo, Ora√ß√£o...");
        
        if (result && result.name) {
            try {
                await addDoc(collection(db, 'subtopicos'), {
                    nome: result.name,
                    descricao: result.description,
                    topicId: activeTopicIdForManagement,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                renderManageSubtopicsList(activeTopicIdForManagement); // Atualiza a lista da direita
            } catch (e) {
                console.error("Erro ao salvar subt√≥pico:", e);
            }
        }
    });
}

// No ouvinte de cliques do editor:
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('button[data-action="highlight-color"]');
    
    if (colorBtn) {
        e.preventDefault(); 
        e.stopPropagation(); // Impede o editor de fechar o popup
        
        const wrapper = colorBtn.closest('.mini-note-wrapper, details.toggle-section');
        if (wrapper) {
            openHighlightPopup(wrapper);
        }
        return; // Sai da fun√ß√£o para n√£o disparar outros cliques
    }
});

// No ouvinte de cliques do editor (ou arquivo):
noteContentEditor.addEventListener('click', (e) => {
    const appendBtn = e.target.closest('button[data-action="append-mini-note"]');
    
    if (appendBtn) {
        e.preventDefault(); 
        e.stopPropagation(); // Essencial para o popup n√£o fechar sozinho
        
        const wrapper = appendBtn.closest('.mini-note-wrapper');
        if (wrapper) {
            // Captura o HTML da caixa
            htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
            openAppendModal();
        } else {
            console.error("‚ùå Erro: Wrapper .mini-note-wrapper n√£o encontrado.");
        }
        return;
    }
});


const miniNoteShareToggle = document.getElementById('mini-note-share-toggle');
if (miniNoteShareToggle) {
    miniNoteShareToggle.onchange = () => {
        if (activeWrapperForSharing) {
            const newState = miniNoteShareToggle.checked;
            
            // 1. Atualiza o atributo no HTML da caixa
            activeWrapperForSharing.setAttribute('data-shared', newState);
            
            // 2. Atualiza o visual do bot√£o (mudar √≠cone ou cor)
            updateSharingButtonState(activeWrapperForSharing);
            
            console.log(`‚úÖ Partilha da caixa ${activeWrapperForSharing.id} definida como: ${newState}`);
            
            // 3. Grava a nota
            saveNote(true);
        }
    };
}

const customEmojiBtn = document.getElementById('custom-emoji-btn');
if (customEmojiBtn) {
    customEmojiBtn.onclick = () => {
        const modal = document.getElementById('custom-emoji-modal');
        if (!modal) return;

        // MOVE PARA O BODY E Z-INDEX M√ÅXIMO (Para ficar √† frente do modal anterior)
        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "9000000";

        const input = document.getElementById('custom-emoji-input');
        const confirmBtn = document.getElementById('confirm-custom-emoji-btn');

        input.value = "";
        setTimeout(() => input.focus(), 100);

        confirmBtn.onclick = () => {
            const val = input.value.trim();
            if (val) {
                selectedCosmosEmoji = val;
                // Atualiza visualmente o bot√£o do Cosmos para mostrar o emoji escolhido
                customEmojiBtn.textContent = val;
                customEmojiBtn.classList.add('selected');
            }
            modal.style.display = 'none';
        };
    };
}


function openCosmosEditPopup(id, currentName, currentEmoji, type) {
    const modal = document.getElementById('custom-emoji-modal');
    const nameInput = document.getElementById('custom-theme-name-input');
    const emojiInput = document.getElementById('custom-emoji-input');
    const confirmBtn = document.getElementById('confirm-custom-emoji-btn');

    if (!modal) {
        console.error("‚ùå Erro: Modal 'custom-emoji-modal' n√£o encontrado no HTML!");
        return;
    }

    nameInput.value = currentName;
    emojiInput.value = currentEmoji || "üíº";

    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";

    setTimeout(() => nameInput.focus(), 150);

    // 3. Grava√ß√£o
    confirmBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newEmoji = emojiInput.value.trim();

        if (!newName) return alert("Nome √© obrigat√≥rio.");

        confirmBtn.disabled = true;
        confirmBtn.textContent = "...";

        try {
            const collectionName = type === 'cosmos-parent' ? 'cosmos' : 'subcosmos';
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await updateDoc(doc(db, collectionName, id), {
                nome: newName,
                emoji: newEmoji
            });

            modal.style.display = 'none';
            renderListCategoryItems('cosmos'); // Atualiza a lista lateral
        } catch (e) {
            console.error(e);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Confirmar";
        }
    };
}

async function checkItemProtection(itemId, itemName) {
    // 1. Se j√° desbloqueamos nesta sess√£o, deixa passar
    if (sessionUnlockedFolders.has(itemId)) return true;

    // 2. Verifica se o item tem senha (buscando metadados r√°pidos)
    const docSnap = await getDoc(doc(db, 'pastas', itemId));
    if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.passe && data.passe.trim() !== "") {
            // 3. Pede a senha
            const authorized = await requestPassword('access', itemId);
            if (authorized === true) {
                sessionUnlockedFolders.add(itemId); // Salva o desbloqueio na sess√£o
                return true;
            }
            return false; // Cancelou ou errou
        }
    }
    return true; // N√£o tem prote√ß√£o
}

window.addSeparatorToGaveta = async () => {
    if (!window.activeGavetaId) return;

    const result = await showCustomInput("Novo Separador", "Ex: Parte 1, Refer√™ncias Extras...");
    if (!result || !result.name) return;

    const sepId = 'sep_' + Date.now();
    
    try {
        const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);

        // Salvamos o ID no array de posts e o nome num mapa de metadados
        await updateDoc(gavetaRef, {
            posts: arrayUnion(sepId),
            [`separatorData.${sepId}`]: {
                title: result.name,
                createdAt: Date.now()
            }
        });

        // Atualiza a mem√≥ria local e renderiza
        if (!window.activeGavetaData.posts) window.activeGavetaData.posts = [];
        window.activeGavetaData.posts.push(sepId);
        if (!window.activeGavetaData.separatorData) window.activeGavetaData.separatorData = {};
        window.activeGavetaData.separatorData[sepId] = { title: result.name };

        renderArchiveFeed();
    } catch (e) {
        console.error("Erro ao criar separador:", e);
    }
};

// Ligar o clique do bot√£o
document.getElementById('create-separator-btn').onclick = window.addSeparatorToGaveta;


window.editSeparator = async (id, currentName) => {
    const result = await showCustomInput("Renomear Separador", "Novo nome...");
    if (!result || !result.name) return;

    try {
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
        await updateDoc(gavetaRef, {
            [`separatorData.${id}.title`]: result.name
        });
        window.activeGavetaData.separatorData[id].title = result.name;
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

window.deleteSeparator = async (id) => {
    if (!confirm("Remover este separador?")) return;
    try {
        const { arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
        await updateDoc(gavetaRef, {
            posts: arrayRemove(id),
            [`separatorData.${id}`]: deleteField()
        });
        window.activeGavetaData.posts = window.activeGavetaData.posts.filter(item => item !== id);
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

// Fun√ß√£o de movimento unificada (funciona para posts e separadores)
window.movePostInGaveta = async (id, direction) => {
    const order = [...window.activeGavetaData.posts];
    const index = order.indexOf(id);
    const newIndex = index + direction;

    if (newIndex >= 0 && newIndex < order.length) {
        [order[index], order[newIndex]] = [order[newIndex], order[index]];
        try {
            const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
            await updateDoc(gavetaRef, { posts: order });
            window.activeGavetaData.posts = order;
            renderArchiveFeed();
        } catch (e) { console.error(e); }
    }
};

document.getElementById('create-separator-btn').onclick = async () => {
    const result = await showCustomInput("Novo Separador", "Ex: Parte 1, Fontes Extra...");
    if (!result || !result.name) return;

    const sepId = 'sep_' + Date.now();
    try {
        const { doc, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);

        await updateDoc(gavetaRef, {
            posts: arrayUnion(sepId),
            [`separatorData.${sepId}`]: { title: result.name }
        });

        // Atualiza cache local para refletir na UI sem refresh
        window.activeGavetaData.posts.push(sepId);
        if(!window.activeGavetaData.separatorData) window.activeGavetaData.separatorData = {};
        window.activeGavetaData.separatorData[sepId] = { title: result.name };
        
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

// 1. Definir a fun√ß√£o como global para evitar conflitos de nome
window.openShareModalForArchive = async function() {
    console.log("üöÄ [NUCLEAR-START] A abrir popup de partilha...");
    
    const modal = document.getElementById('note-share-popup');
    if (!modal) return console.error("‚ùå Erro: #note-share-popup n√£o encontrado.");

    // 1. Configura√ß√£o de IDs
    const id = selectedNoteId || currentArchiveId;
    if (!id) return;

    // 2. RECONSTRU√á√ÉO F√çSICA DO MODAL (For√ßa Bruta)
    document.body.appendChild(modal); 
    modal.style.cssText = `
        display: flex !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 9999999 !important;
        justify-content: center !important;
        align-items: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: all !important;
    `;

    const content = modal.querySelector('.modal-content');
    if (content) {
        content.style.cssText = `
            display: block !important;
            background-color: var(--sidebar-color, #252528) !important;
            padding: 30px !important;
            border-radius: 12px !important;
            width: 90% !important;
            max-width: 450px !important;
            position: relative !important;
            z-index: 10000000 !important;
            opacity: 1 !important;
            visibility: visible !important;
        `;
    }

    try {
        const docRef = doc(db, 'pastas', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();

            // üõ°Ô∏è BLOQUEIO DE SEGURAN√áA: Se n√£o for o dono, fecha e sai
            if (data.userId !== auth.currentUser.uid) {
                console.warn("üö´ Acesso negado: Apenas o dono pode gerir a partilha.");
                modal.style.display = 'none';
                return;
            }

            currentNoteShareData = data.shareSettings || { shared: false, shareId: null };

            // A. Configurar Link de Leitura
            const mainToggle = document.getElementById('note-share-toggle');
            if(mainToggle) mainToggle.checked = currentNoteShareData.shared || false;

            const linkContainer = document.getElementById('note-share-link-container');
            if (currentNoteShareData.shared) {
                if(linkContainer) linkContainer.style.display = 'block';
                const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                const shareId = currentNoteShareData.shareId || id;
                const urlInput = document.getElementById('note-share-url');
                if(urlInput) urlInput.value = `${baseUrl}/sharenote.html?id=${shareId}`;
            } else {
                if(linkContainer) linkContainer.style.display = 'none';
            }

            // B. Configurar Link de Colabora√ß√£o (Vis√≠vel apenas se estiver no modo partilha)
            const collabSection = document.getElementById('archive-collab-section');
            if (currentViewMode === 'shared') {
                if(collabSection) collabSection.style.display = 'block';
                const collabToggle = document.getElementById('collab-share-toggle');
                if(collabToggle) collabToggle.checked = (data.partilhado === "ativo");
                
                const collabLinkContainer = document.getElementById('collab-share-link-container');
                if (data.partilhado === "ativo") {
                    if(collabLinkContainer) collabLinkContainer.style.display = 'block';
                    const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                    const collabUrl = `${baseUrl}/note.html?openArchive=${id}&mode=collab`;
                    const collabInput = document.getElementById('collab-share-url');
                    if(collabInput) collabInput.value = collabUrl;
                } else {
                    if(collabLinkContainer) collabLinkContainer.style.display = 'none';
                }
            } else {
                if(collabSection) collabSection.style.display = 'none';
            }
            
            console.log("‚ú® [NUCLEAR-SUCCESS] Configura√ß√£o de partilha carregada.");
        }
    } catch (err) {
        console.error("üî• Erro ao carregar dados de partilha:", err);
    }
};

// Fun√ß√£o centralizada para abrir o criador de marcadores
function openCreateBookmarkPopup() {
    const modal = document.getElementById('create-bookmark-modal');
    if (!modal) return;

    // Garante que o modal est√° no topo do body
    document.body.appendChild(modal);

    // Limpa os campos
    document.getElementById('new-bookmark-title').value = '';
    document.getElementById('new-bookmark-desc').value = '';

    // For√ßa visibilidade absoluta
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "10000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Foco no input
    setTimeout(() => {
        const input = document.getElementById('new-bookmark-title');
        if (input) input.focus();
    }, 100);
}

    </script>
</body>
</html>
