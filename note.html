<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - Notes</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczNbOBxcAwWmdQfM23rP7EAZINaQRQFX53uMo14hPhWvC3lsPy1inv3b42P5T2iFJ8Ot-bsLFUcOb0G4tVevedv1jtFxTlzGHyc00ddx94QViaji6vp0KuRcw1eC_WbddVVCPidHPoCJLZuwNdbr02ZC=w192-h192-s-no-gm?authuser=4">

   
  
<style>
/* ============================================================
   VARI√ÅVEIS E RESET
   ============================================================ */
:root {
    --bg-color: #1a1a1d;
    --sidebar-color: #252528;
    --panel-color: #1f1f22;
    --accent-color: #4a90e2;
    --text-color: #f0f0f0;
    --text-muted-color: #888;
    --border-color: #333;
    --hover-color: #2c2c30;
    --selected-color: #3a5370;
    
    /* Cores Espec√≠ficas para Modos */
    --question-color: #1e8449;
    --question-bg: rgba(20, 90, 50, 0.08);
    --container-color: #e67e22; /* Laranja */
    --container-bg: rgba(230, 126, 34, 0.08);
    
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-color); 
    overflow: hidden; 
    height: 100vh; 
}

/* Scrollbars Modernas */
* { scrollbar-width: thin; scrollbar-color: var(--text-muted-color) var(--panel-color); }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--panel-color); border-radius: 10px; }
::-webkit-scrollbar-thumb {
    background-color: var(--text-muted-color); border-radius: 10px;
    border: 2px solid var(--panel-color);
}
::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

/* ============================================================
   ESTRUTURA PRINCIPAL (LAYOUT)
   ============================================================ */
.notebook-container { display: flex; height: 100vh; width: 100vw; }
#left-panel, #middle-panel, #right-panel { height: 100%; display: flex; flex-direction: column; }

/* 1. PAINEL ESQUERDO (PASTAS) */
#left-panel { 
    flex: 0 0 240px; 
    background-color: var(--sidebar-color); 
    border-right: 1px solid var(--border-color); 
    padding: 15px; 
    justify-content: space-between; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden;
}

/* 2. PAINEL DO MEIO (LISTA DE NOTAS) */
#middle-panel { 
    flex: 0 0 240px; 
    background-color: var(--panel-color); 
    border-right: 1px solid var(--border-color); 
    
    /* MANTENHA O RESTO, MAS ALTERE O PADDING: */
    padding: 20px 20px 0 20px !important; /* Topo, Dir, Fundo=0, Esq */
    
    transition: all 0.3s ease; 
    overflow: hidden;
    display: flex;       /* Garante que √© flex */
    flex-direction: column;
}

/* 3. PAINEL DIREITO (EDITOR - A NOTA) */
#right-panel { 
    flex: 1; /* Ocupa o espa√ßo que sobrar */
    min-width: 0; /* CR√çTICO: Permite que o editor encolha quando a 4¬™ coluna abre */
    background-color: var(--bg-color); 
    padding: 20px; 
    position: relative; 
    transition: all 0.3s ease;
}

/* ESTILOS DO SELETOR LOCAL | PARTILHA */
.folder-mode-container {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Espalha os itens uniformemente */
    gap: 2px; /* Reduz o espa√ßo entre itens para caber tudo */
    font-size: 13px; /* Reduzido de 18px para caber na linha */
    font-weight: 600; /* Um pouco mais de peso para compensar o tamanho */
    color: var(--text-muted-color);
    width: 100%;
    white-space: nowrap; /* Impede quebra de linha */
    padding: 0 2px; /* Pequena margem de seguran√ßa */
}

.folder-mode-item {
    cursor: pointer;
    transition: color 0.2s, text-shadow 0.2s;
    user-select: none;
    position: relative;
    padding: 4px 0; /* Aumenta √°rea de toque vertical */
}

.folder-mode-item:hover {
    color: var(--text-color);
}

.folder-mode-item.active {
    color: var(--text-color);
    font-weight: bold;
}

/* Pequeno ponto azul por baixo do ativo */
.folder-mode-item.active::after {
    content: '';
    position: absolute;
    bottom: 0px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--accent-color);
    border-radius: 2px;
}

/* Separador mais fino */
.folder-mode-separator {
    color: var(--border-color);
    font-weight: normal;
    font-size: 0.8em;
    opacity: 0.5;
}

/* Adicione tamb√©m o estilo para o modo Flash (Amarelo, por exemplo) */
.folder-mode-item.active.mode-flash {
    color: #f1c40f !important; /* Amarelo */
}
.folder-mode-item.active.mode-flash::after {
    background-color: #f1c40f !important;
}

/* ============================================================
   4. PAINEL DE REFER√äNCIAS (4¬™ COLUNA) - AJUSTE DE TAMANHO
   ============================================================ */
#references-panel {
    flex: 0 0 0; 
    width: 0; 
    background-color: var(--sidebar-color); 
    padding: 0; 
    height: 100%;
    display: flex; 
    flex-direction: column; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden; 
    opacity: 0;
    border-left: 1px solid var(--border-color);
}

/* QUANDO ABERTO: FOR√áA 50% DA LARGURA DO ECR√É */
.notebook-container.references-panel-visible #references-panel {
    display: flex !important; /* Garante que n√£o est√° como none */
    flex: 0 0 400px !important; 
    width: 400px !important;
    min-width: 400px !important;
    opacity: 1 !important;
    visibility: visible !important;
    padding: 20px !important;
    border-left: 1px solid var(--border-color) !important;
}

/* No PC, o painel direito deve encolher para dar lugar √† 4¬™ coluna */
.notebook-container.references-panel-visible #right-panel {
    flex: 1 !important;
    min-width: 0 !important;
}


/* ============================================================
   CORRE√á√ÉO DO BOT√ÉO TOGGLE ‚Üñ (COLLAPSE DA ESQUERDA)
   ============================================================ */

/* 1. Quando ativo, ESCONDE o painel esquerdo (Pastas) */
.notebook-container.middle-panel-collapsed #left-panel {
    display: none !important;
    width: 0 !important;
    flex: 0 0 0 !important;
    padding: 0 !important;
    border: none !important;
}

/* 2. O painel do Meio (Lista) mant√©m o tamanho normal */
.notebook-container.middle-panel-collapsed #middle-panel {
    width: 240px !important; 
    flex: 0 0 240px !important;
}

/* 3. O painel da Direita (Editor) ocupa todo o espa√ßo restante */
.notebook-container.middle-panel-collapsed #right-panel {
    display: flex !important;
    flex: 1 !important;
    opacity: 1 !important;
}

/* 4. Ajustes do Cabe√ßalho para manter tudo bonito */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header {
    display: flex !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
}

/* Garante que os bot√µes do cabe√ßalho continuam vis√≠veis */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header > * {
    display: flex !important;
}

/* --- ESTILO VERMELHO PARA O BOT√ÉO ADICIONAR (MODO PARTILHA) --- */
#add-item-btn.shared-mode {
    border-color: #e74c3c !important;
    color: #e74c3c !important;
}

#add-item-btn.shared-mode:hover {
    background-color: #e74c3c !important;
    color: white !important;
}

/* ============================================================
   ELEMENTOS INTERNOS (Listas, Bot√µes, etc)
   ============================================================ */
.panel-content { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
#left-panel-list, #file-list { list-style-type: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }

/* Cabe√ßalhos e Rodap√©s de Painel */
.panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.panel-header h2 { font-size: 18px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
.panel-footer { height: 50px !important; /* Mesma altura da direita */ border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-around; /* Se o #left-panel tiver padding de 15px, usamos isto para colar √†s bordas: */ margin: 0 -15px -15px -15px !important; padding: 0 10px; flex-shrink: 0; background-color: var(--sidebar-color); /* Garante que o fundo tapa tudo */ z-index: 5; }

/* Bot√µes de Controlo de Painel */
#left-panel-toggle-btn { display: none; background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 32px; height: 32px; border-radius: 5px; font-size: 20px; cursor: pointer; margin: 15px auto; }
#left-panel-toggle-btn:hover { background-color: var(--accent-color); }

#middle-panel-toggle-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; line-height: 1; margin-right: 10px; }
#middle-panel-toggle-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

#back-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; margin-right: 10px; }
#back-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

/* Tabs */
.tabs-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
.tabs-container button { background: none; border: none; color: var(--text-muted-color); padding: 10px; flex-grow: 1; text-align: center; font-size: 15px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
.tabs-container button:hover { background-color: var(--hover-color); color: var(--text-color); }
.tabs-container button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
#left-panel hr { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0 15px 0; }

/* Listas (Esquerda e Meio) */
.list-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s ease; display: flex; align-items: center; user-select: none; position: relative; }
.list-item:before { font-size: 18px; margin-right: 10px; }
.list-item[data-type="pasta"]:before { content: 'üìÅ'; }
.list-item[data-type="nota"]:before { content: 'üìÑ'; }
.list-item[data-type="agregacao"]:before { content: 'üß¨'; } 
.list-item[data-type="arquivo"]:before { content: 'üóÑÔ∏è'; }
.list-item[data-type="partilhado"]:before { content: 'üóÑÔ∏è'; }
.list-item[data-type="jornal"]:before { content: 'üì∞'; }
.list-item:hover { background-color: var(--hover-color); }
.list-item.selected { background-color: var(--selected-color); }

/* Menu de 3 pontos no item */
.item-menu-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 20px; padding: 0 8px; border-radius: 5px; cursor: pointer; display: none; }
.list-item:hover .item-menu-btn { display: block; }
.item-menu-btn:hover { background-color: var(--bg-color); color: var(--text-color); }

/* Bot√µes de A√ß√£o Rodap√©/Topo */
#add-item-btn { background: none; border: 2px solid var(--accent-color); color: var(--accent-color); width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
#add-item-btn:hover { background-color: var(--accent-color); color: white; }
#settings-btn, #account-btn, #global-search-btn { background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; flex-grow: 1; /* Isto faz com que dividam o espa√ßo igualmente */ text-align: center; padding: 5px; border-radius: 5px; }
#settings-btn:hover, #account-btn:hover, #global-search-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* ============================================================
   CORRE√á√ÉO DE TEXTO LONGO NAS LISTAS (QUEBRA DE LINHA)
   ============================================================ */

/* 1. Garante que a lista nunca tem scroll horizontal */
#left-panel-list, #file-list {
    overflow-x: hidden !important;
}

/* 2. Ajuste no contentor do item para permitir altura vari√°vel */
.list-item {
    height: auto !important; /* Permite crescer em altura */
    min-height: 44px; /* Altura m√≠nima para ser clic√°vel */
    align-items: center !important; /* Mant√©m √≠cone centrado verticalmente */
}

/* 3. A regra principal: For√ßa o texto (span) a quebrar linha */
.list-item span {
    white-space: normal !important;   /* Permite quebra de linha */
    word-break: break-word !important; /* Quebra palavras muito longas */
    overflow-wrap: break-word !important; /* Standard moderno */
    line-height: 1.4 !important;      /* Espa√ßamento para leitura f√°cil */
    flex: 1;                          /* Ocupa o espa√ßo dispon√≠vel */
    padding-right: 5px;               /* Espa√ßo para n√£o colar √† direita */
}

/* ============================================================
   PAINEL DIREITO: EDITOR
   ============================================================ */
#editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted-color); text-align: center; height: 100%;}
#editor-placeholder .placeholder-icon { font-size: 60px; margin-bottom: 20px; }
#note-title-input { background: none; border: none; color: var(--text-color); font-size: 2.5em; font-weight: bold; padding: 10px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); outline: none; width: 100%; }

/* Barra de Ferramentas Principal */
#editor-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 6px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
}
.toolbar-group { display: flex; align-items: center; gap: 5px; }
#editor-toolbar button, #secondary-toolbar button {
    background: var(--hover-color); border: none; color: var(--text-color); min-width: 32px; height: 32px;
    padding: 0 8px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#editor-toolbar button:hover, #secondary-toolbar button:hover { background-color: var(--accent-color); }
#editor-toolbar input[type="color"], #secondary-toolbar input[type="color"] {
    width: 32px; height: 32px; border: none; background: none; cursor: pointer; padding: 2px;
}
.toolbar-separator { width: 1px; height: 25px; background-color: var(--border-color); margin: 0 10px; }
.toolbar-history { margin-left: auto; display: flex; align-items: center; }

/* Barra de Ferramentas Secund√°ria */
#secondary-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 0 0 6px 6px; margin-top: -10px; margin-bottom: 15px; flex-wrap: wrap;
    gap: 10px; border-top: 1px solid var(--border-color); animation: slideDown 0.2s ease-out;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
#toggle-more-tools-btn.active { background-color: var(--selected-color); transform: rotate(180deg); }

/* Zoom Select */
#editor-zoom {
    background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color);
    border-radius: 5px; padding: 0 5px; height: 32px; cursor: pointer; outline: none; font-size: 14px; margin-right: 5px;
}
#editor-zoom:hover { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
#editor-zoom option { background-color: var(--sidebar-color); color: var(--text-color); }

/* Conte√∫do Edit√°vel */
#note-content-editor {
    position: relative; 
    background: none; 
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; 
    padding: 5px;
    
    /* --- CORRE√á√ÉO PARA MOBILE --- */
    -webkit-overflow-scrolling: touch; /* Ativa o scroll suave (in√©rcia) no iPhone/Android */
    overscroll-behavior-y: contain;    /* Impede que o scroll "puxe" a p√°gina toda */
    touch-action: pan-y;               /* Melhora a dete√ß√£o do dedo para scroll vertical */
     overflow-wrap: break-word; 
    word-wrap: break-word;
    word-break: break-word;
}

/* Adicione isto em qualquer lugar no seu CSS principal */
#note-content-editor {
    position: relative; 
    background: none; 
     overflow-anchor: none !important;  /* Impede o navegador de ajustar o scroll */
    overscroll-behavior-y: contain;    /* Evita o efeito el√°stico no topo/fundo */
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    
    /* --- CORRE√á√ÉO DE SCROLL --- */
    flex: 1;                 /* Ocupa todo o espa√ßo restante */
    overflow-y: auto;        /* Ativa o scroll vertical AQUI */
    overflow-x: hidden; 
    min-height: 0;           /* Refor√ßo para o Firefox/Safari mobile */
    padding: 5px 5px 50px 5px; /* Padding extra no fundo para o teclado n√£o tapar texto */
    
    /* --- MOTOR DE TOQUE NATIVO --- */
    -webkit-overflow-scrolling: touch; 
    touch-action: pan-y;
}

#note-content-editor h1 { font-size: 2em; font-weight: bold; border-bottom: 1px solid var(--border-color); color: var(--accent-color); margin: 0.6em 0; }
#note-content-editor h2 { font-size: 1.5em; font-weight: bold; color: var(--text-color); margin: 0.5em 0; }
#note-content-editor h3 { font-size: 1.17em; font-weight: bold; color: var(--text-muted-color); margin-bottom: 0.5em; }
#note-content-editor h4 { font-size: 1em; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5em; }
#note-content-editor p { margin: 0.5em 0; }

/* For√ßa consist√™ncia de tamanho dentro do editor */
#note-content-editor p, 
#note-content-editor div, 
#note-content-editor li, 
#note-content-editor span {
    font-size: inherit; /* Herda o tamanho do pai (o editor) */
    line-height: inherit;
}

/* Tags e Entidades no Texto */
.tag { background-color: var(--selected-color); color: var(--accent-color); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
.entity-link { background-color: rgba(74, 144, 226, 0.2); border-bottom: 1px dashed var(--accent-color); cursor: pointer; }
.entity-link[data-entity-type="personagem"] { background-color: rgba(230, 126, 34, 0.2); border-bottom-color: #e67e22; }
.entity-link[data-entity-type="local"] { background-color: rgba(46, 204, 113, 0.2); border-bottom-color: #2ecc71; }
.entity-link[data-entity-type="data"] { background-color: rgba(155, 89, 182, 0.2); border-bottom-color: #9b59b2; }
a[data-anexo-id] { color: inherit; text-decoration: none; border-bottom: 1px dotted var(--accent-color); cursor: pointer; }
.idea-span { text-decoration: underline; text-decoration-color: #e74c3c; text-decoration-thickness: 3px; cursor: pointer; background-color: rgba(231, 76, 60, 0.1); }
.idea-span:hover { background-color: rgba(231, 76, 60, 0.2); }

/* ============================================================
   POST-IT FLUTUANTE (Amarelo, Arrast√°vel)
   ============================================================ */
.post-it-note {
    position: absolute; display: flex; flex-direction: column;
    background-color: #fff9c4; border: 1px solid #f1c40f;
    resize: both; overflow: hidden; min-width: 150px; min-height: 80px;
    box-shadow: 4px 4px 10px rgba(0,0,0,0.2); z-index: 20;
}
.post-it-note::-webkit-resizer { background-color: #f1c40f; }
.post-it-note.active-note { border-color: #f39c12; z-index: 50; }

.post-it-drag-handle {
    position: absolute; top: 0; right: 0; width: 25px; height: 25px;
    background-color: #f1c40f; color: #333; cursor: grab; z-index: 10;
    display: flex; align-items: center; justify-content: center;
    border-bottom-left-radius: 4px; user-select: none;
}
.post-it-drag-handle:active { cursor: grabbing; background-color: #d4ac0d; }
.post-it-drag-handle:hover { background-color: #d4ac0d; }

.post-it-cut-btn {
    position: absolute; top: 0; left: 0; width: 25px; height: 25px;
    background-color: transparent; cursor: pointer; z-index: 100;
    display: none; align-items: center; justify-content: center;
    font-size: 16px; user-select: none; border-bottom-right-radius: 4px;
}
.post-it-note.active-note .post-it-cut-btn { display: flex; }
.post-it-cut-btn:hover { background-color: rgba(0,0,0,0.1); }

.post-it-content {
    background-color: transparent; color: #333; padding: 10px;
    height: 100%; width: 100%; outline: none; overflow-y: auto; cursor: text; user-select: text;
}

/* ============================================================
   MINI-NOTAS & QUEST√ïES (Embutidas no texto)
   ============================================================ */
/* Estilo Base (SubNota Padr√£o) */
.mini-note-wrapper {
    display: block; 
    position: relative; 
    margin: 30px -25px; 
    width: auto;
    
    /* --- MUDAN√áA 1: Fundo Azul Suave (igual √† l√≥gica da Quest√£o) --- */
    background-color: rgba(74, 144, 226, 0.08); 
    
    /* --- MUDAN√áA 2: Bordas superior/inferior Azuis --- */
    border-top: 1px solid var(--accent-color); 
    border-bottom: 1px solid var(--accent-color);
    
    padding: 20px 25px; 
    box-sizing: border-box;
}

/* A barra grossa no topo (Mant√©m-se azul) */
.mini-note-wrapper::before {
    content: ''; 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 4px;
    background: var(--accent-color); 
    opacity: 0.8;
}

/* Modo Quest√£o (Verde) */
.mini-note-wrapper.question-mode {
    background-color: var(--question-bg);
    border-color: var(--question-color);
}
.mini-note-wrapper.question-mode::before { background: var(--question-color); }

/* Componentes Internos */
.mini-note-title-input {
    display: block;
    width: 100%;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid var(--border-color) !important;
    color: var(--accent-color) !important;
    
    /* FOR√áA A FONTE ORIGINAL DO TEU SITE */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 1.4em !important;
    font-weight: bold !important;
    
    padding: 0 !important;
    margin: 0 0 15px 0 !important;
    outline: none !important;
    resize: none !important;
    
    /* REMOVE BARRA DE SCROLL E SETA */
    overflow: hidden !important; 
    line-height: 1.2 !important;
}

/* QUANDO A OP√á√ÉO EST√Å DESLIGADA (Imita o input antigo) */
.mini-note-title-input:not(.wrap-enabled) {
    white-space: nowrap !important; /* Impede quebra de linha */
    height: 1.5em !important;       /* Altura exata de uma linha */
}

/* QUANDO A OP√á√ÉO EST√Å LIGADA */
.mini-note-title-input.wrap-enabled {
    white-space: pre-wrap !important; /* Permite quebra de linha */
    height: auto;
}

/* Garante que se for Quest√£o, mant√©m o Verde */
.mini-note-wrapper.question-mode .mini-note-title-input {
    color: var(--question-color) !important;
}

/* Quando a configura√ß√£o estiver ativa, o campo expande */
.mini-note-title-input.wrap-enabled {
    word-break: break-word;
}

.mini-note-wrapper.question-mode .mini-note-title-input { color: var(--question-color); }

.mini-note-content {
    outline: none; min-height: 60px; font-size: 1em; line-height: 1.6; color: var(--text-color); padding: 5px;
}

.mini-note-toolbar {
    display: flex; justify-content: flex-end; background: transparent;
    padding: 0; margin-bottom: 5px; border: none; height: 30px;
    font-size: 0 !important;
}
.mini-note-toolbar button[data-action="delete-mini-note"] {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); color: #e74c3c; border-color: #e74c3c;
}
.mini-note-wrapper.question-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(30, 132, 73, 0.15); color: var(--question-color); border-color: var(--question-color);
}
/* Esconde bot√µes desnecess√°rios dentro da mini-nota */
.mini-note-toolbar button:not([data-action="sharing-settings"]):not([data-action="delete-mini-note"]):not([data-action="manage-mini-note-topics"]):not([data-action="highlight-color"]):not([data-action="append-mini-note"]):not([data-action="move-up"]):not([data-action="move-down"]):not([data-action="manage-box-links"]),
.mini-note-toolbar input[type="color"],
.mini-note-toolbar .toolbar-separator { 
    display: none !important; 
}

/* Atualiza√ß√£o na sec√ß√£o .mini-note-toolbar */
.mini-note-toolbar button {
    background: none; 
    border: 1px solid var(--border-color); 
    color: var(--text-muted-color);
    width: 30px; 
    height: 30px; 
    border-radius: 4px; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s;
    margin-left: 5px; /* Espa√ßo entre bot√µes */
    font-size: 14px !important;
}

/* Hover espec√≠fico para o bot√£o de T√≥picos */
.mini-note-toolbar button[data-action="manage-mini-note-topics"]:hover {
    background-color: rgba(74, 144, 226, 0.1); 
    color: var(--accent-color); 
    border-color: var(--accent-color);
}

/* Mant√©m o hover vermelho para o lixo */
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); 
    color: #e74c3c; 
    border-color: #e74c3c;
}

/* Modo Contentor Livre (Laranja) */
.mini-note-wrapper.free-mode {
    background-color: var(--container-bg);
    border-color: var(--container-color);
}
.mini-note-wrapper.free-mode::before { 
    background: var(--container-color); 
}

/* Ajuste da Toolbar no modo livre (j√° que n√£o tem t√≠tulo, garantimos que fica no topo) */
.mini-note-wrapper.free-mode .mini-note-toolbar {
    margin-bottom: 0;
    padding-bottom: 5px;
}

/* Hover dos bot√µes no modo laranja */
.mini-note-wrapper.free-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(230, 126, 34, 0.15); 
    color: var(--container-color); 
    border-color: var(--container-color);
}

/* ============================================================
   POPUPS E MODAIS
   ============================================================ */
/* Popups Flutuantes (Sele√ß√£o e Inser√ß√£o) */
#selection-popup, #insertion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 30px; padding: 5px 10px; display: flex; gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4); align-items: center; z-index: 1010;
}
#selection-popup button, #insertion-popup button {
    background: none; border: none; color: var(--text-color); padding: 6px;
    cursor: pointer; border-radius: 50%; font-size: 18px; line-height: 1;
    transition: transform 0.2s, background-color 0.2s; width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
}
#selection-popup button:hover, #insertion-popup button:hover {
    background-color: var(--hover-color); transform: scale(1.15);
}


.popup-separator { width: 1px; height: 20px; background-color: var(--text-muted-color); opacity: 0.4; margin: 0 4px; }

/* Popup de Sugest√£o (Tags/Entidades) */
.suggestion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-height: 250px; overflow-y: auto; width: 350px;
}
.suggestion-list { list-style: none; padding: 5px; }
.suggestion-list li {
    padding: 8px 12px; border-radius: 4px; cursor: pointer; color: var(--text-color);
    display: flex; align-items: center;
}
.suggestion-list li:hover, .suggestion-list li.selected { background-color: var(--accent-color); color: white; }
#entity-suggestion-popup .suggestion-list li span { margin-left: auto; padding-left: 1em; }
#entity-suggestion-popup .suggestion-list li:hover span, #entity-suggestion-popup .suggestion-list li.selected span { color: white !important; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="personagem"] span { color: #e67e22; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="local"] span { color: #2ecc71; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="data"] span { color: #9b59b2; font-weight: 500; }

/* Menu de Contexto (3 Pontos) */
.context-menu {
    position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001;
    display: flex; flex-direction: column; padding: 5px; width: 160px;
}
.context-menu button {
    background: none; border: none; color: var(--text-color); padding: 8px 15px;
    text-align: left; cursor: pointer; border-radius: 4px; width: 100%; white-space: nowrap;
}
.context-menu button:hover { background-color: var(--accent-color); color: white; }

/* Modais (Sobreposi√ß√£o) */
.modal-overlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: none; /* O JS muda isto para flex */
    justify-content: center;
    align-items: center; 
    
    /* O JS vai sobrescrever isto para 2147483647 quando estiver no Aqu√°rio */
    z-index: 20000; 
}
.modal-content {
    background-color: var(--sidebar-color); padding: 30px; border-radius: 8px;
    width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-content h3 { margin-bottom: 20px; font-size: 22px; }
.modal-content p { margin-bottom: 20px; color: var(--text-muted-color); }
.modal-content input[type="text"], .modal-content input[type="password"], .modal-content textarea {
    width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color);
    border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;
}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
.modal-btn:hover { opacity: 0.9; }
.modal-btn.primary { background-color: var(--accent-color); color: white; }
.modal-btn.secondary { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos Espec√≠ficos de Modais */
#add-item-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
#add-item-options button {
    background-color: var(--panel-color); border: 1px solid var(--border-color);
    color: var(--text-color); padding: 15px; text-align: left; border-radius: 5px;
    cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#add-item-options button:hover { background-color: var(--hover-color); }

.move-list { list-style: none; max-height: 40vh; overflow-y: auto; }
.move-list li {
    background-color: var(--bg-color); padding: 10px; border-radius: 5px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
}
.move-list .order-controls button {
    background: none; border: 1px solid var(--border-color); color: var(--text-color);
    width: 28px; height: 28px; cursor: pointer; border-radius: 5px; margin-left: 5px;
}
.move-list .order-controls button:hover { background-color: var(--hover-color); }
.move-list .order-controls button:disabled { opacity: 0.3; cursor: not-allowed; }

#link-modal .url-field-wrapper { display: flex; gap: 8px; }
#link-modal .remove-url-btn {
    background-color: #c0392b; color: white; padding: 0; width: 38px; height: 38px;
    min-width: unset; flex-shrink: 0; font-size: 24px; display: flex;
    align-items: center; justify-content: center;
}
#generic-list-modal-content, #view-link-modal .modal-content { max-width: 700px; }
#view-link-urls-list li { padding: 12px; background-color: var(--bg-color); }
#view-link-urls-list li a {
    color: var(--accent-color); text-decoration: none; display: block;
    word-break: break-all; font-weight: 500;
}
#view-link-urls-list li a:hover { text-decoration: underline; }

/* ============================================================
   PAINEL DE REFER√äNCIAS (4¬™ COLUNA)
   ============================================================ */
#references-panel {
    flex: 0 0 0; width: 0; background-color: var(--sidebar-color); padding: 0; height: 100%;
    display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; opacity: 0;
    border-left: 1px solid var(--border-color);
}

#references-panel-close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 24px; cursor: pointer; }
#references-panel-description {
    font-size: 0.85em;
    color: var(--text-muted-color);
    margin-bottom: 8px; /* Reduzido de 20px para 8px */
    padding: 0 5px;
    line-height: 1.5;
    font-style: italic;
    border-left: 3px solid var(--accent-color);
    padding-left: 10px;
}
.references-separator { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0; /* Reduzido de 15px para 5px */ }
#references-toolbar { display: flex; justify-content: space-around; align-items: center; padding: 0 10px; }
#references-toolbar button {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 20px;
    cursor: pointer; padding: 8px; border-radius: 5px; transition: all 0.2s ease; line-height: 1;
}
#references-toolbar button:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--border-color); }

#references-list { list-style-type: none; overflow-y: auto; flex-grow: 1; }
#references-list li {
    padding: 12px; border-radius: 5px; cursor: pointer; margin-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
}
#references-list li:hover { background-color: var(--hover-color); }
#references-list details.reference-item {
    padding: 12px; border-radius: 5px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color);
}
#references-list details.reference-item[open] { background-color: var(--hover-color); }
#references-list summary { cursor: pointer; font-weight: 500; list-style: none; display: flex; justify-content: space-between; align-items: center; }
#references-list summary::-webkit-details-marker { display: none; }
#references-list summary:hover { color: var(--accent-color); }
.reference-item.link-info summary { color: var(--accent-color); font-weight: bold; }
.reference-context {
    margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--accent-color);
    color: var(--text-muted-color); font-size: 0.9em; line-height: 1.5;
}
.reference-context mark { background-color: rgba(74, 144, 226, 0.4); color: var(--text-color); border-radius: 3px; padding: 1px 3px; }

/* Bot√£o "Ir para" nas refer√™ncias */
.go-to-note-btn {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 18px;
    cursor: pointer; padding: 4px 8px; border-radius: 5px; margin-left: 10px; line-height: 1;
    transition: all 0.2s ease; display: none;
}
.reference-item:hover .go-to-note-btn { display: block; }
.go-to-note-btn:hover { background-color: var(--hover-color); color: var(--accent-color); }

/* ============================================================
   OUTROS PAINEIS E UTILIT√ÅRIOS
   ============================================================ */
/* Modal de T√≥picos */
.topics-layout { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
.topics-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background-color: var(--bg-color);
    padding: 10px;
    min-height: 0; /* IMPORTANTE: permite que o conte√∫do interno encolha e ative o scroll */
}


.topics-list li {
    padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;
    display: flex; align-items: center; transition: background 0.2s;
}
.topics-list {
    list-style: none;
    overflow-y: auto;   /* Ativa o scroll vertical */
    flex-grow: 1;       /* Faz a lista ocupar o espa√ßo todo da coluna */
    max-height: 100%;   /* Garante que n√£o ultrapassa o limite do pai */
    padding-right: 5px; /* Espa√ßo para a barra de scroll n√£o tapar o texto */
}

/* Mantenha o que j√° tem abaixo */
.topics-list li {
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background 0.2s;
}
.topics-list li:hover { background-color: var(--hover-color); }
.topics-list li.active-topic { background-color: rgba(74, 144, 226, 0.2); border-left: 3px solid var(--accent-color); }
.topic-checkbox { margin-right: 10px; width: 16px; height: 16px; cursor: pointer; }
.create-btn { width: 100%; padding: 8px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
.topic-search-input { width: 100%; padding: 8px; margin-bottom: 10px; background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; }

/* Filtro e Pesquisa */
.filter-bar { display: flex; justify-content: flex-end; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); position: relative; }
.filter-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
.filter-btn:hover, .filter-btn.active { background-color: var(--hover-color); color: var(--text-color); border-color: var(--accent-color); }
.filter-popup { position: absolute; top: 35px; right: 0; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; width: 150px; display: none; flex-direction: column; }
.filter-popup button { background: none; border: none; color: var(--text-color); padding: 10px; text-align: left; cursor: pointer; font-size: 0.9em; }
.filter-popup button:hover { background-color: var(--hover-color); }
.filter-popup button.selected { color: var(--accent-color); font-weight: bold; }
.group-header { background-color: var(--hover-color); color: var(--accent-color); padding: 8px 10px; font-weight: bold; font-size: 0.85em; border-radius: 4px; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
.list-search-container { padding-bottom: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); cursor: default; }
.list-search-input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; outline: none; transition: border-color 0.2s; }
.list-search-input:focus { border-color: var(--accent-color); }

/* Configura√ß√µes (Switches) */
.setting-toggle-container { display: flex; align-items: center; margin-bottom: 15px; }
.setting-label { margin-left: 12px; font-size: 0.95em; color: var(--text-color); }
.setting-switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 20px; }
.slider.round:before { border-radius: 50%; }

/* Perfil */
.profile-info { text-align: center; margin-bottom: 20px; }
.profile-avatar { font-size: 50px; margin-bottom: 10px; display: block; }
.profile-name { font-size: 1.2em; font-weight: bold; color: var(--text-color); display: block; margin-bottom: 5px; }
.profile-email { color: var(--text-muted-color); font-size: 0.9em; }

/* Status de Grava√ß√£o */
.save-status { 
    font-size: 0.8em; 
    color: var(--text-muted-color); 
    margin-right: 15px; 
    transition: all 0.3s ease; 
    font-style: italic; 
    font-weight: 500;
    cursor: pointer;
}

.save-status:hover {
    text-decoration: underline;
    color: var(--accent-color);
}

.save-status.status-saved { color: #27ae60; cursor: default; }
.save-status.status-error { color: #c0392b; cursor: pointer; }
#connectivity-status { display: none; color: #e74c3c; font-weight: bold; margin-right: 15px; font-size: 0.8em; animation: blink 1.5s linear infinite; }
#connectivity-status.visible { display: inline; }
@keyframes blink { 50% { opacity: 0.5; } }

/* Spinner */
.spinner-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 0; color: var(--text-muted-color); font-size: 0.9em; font-style: italic; }
.spinner { width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1); border-left-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Marcadores (Bookmarks) */
.bookmark-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
.bookmark-item:hover { background-color: var(--hover-color); }
.bookmark-info { display: flex; flex-direction: column; }
.bookmark-title { font-weight: 500; color: var(--text-color); }
.bookmark-desc { font-size: 0.8em; color: var(--text-muted-color); }
.bookmark-check { width: 20px; height: 20px; border: 2px solid var(--text-muted-color); border-radius: 4px; margin-left: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.bookmark-item.active .bookmark-check { background-color: var(--accent-color); border-color: var(--accent-color); }
.bookmark-item.active .bookmark-check::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

/* √Çncoras e Tabs */
#anchors-content-container .tab-content { display: none; max-height: 50vh; overflow-y: auto; }
#anchors-content-container .tab-content.active { display: block; }
#anchors-content-container li { padding: 10px; border-radius: 5px; cursor: pointer; position: relative; }
#anchors-content-container li:hover { background-color: var(--hover-color); }
#anchors-content-container li.is-on-page { background-color: #27ae60; color: white; }
.entity-edit-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 22px; line-height: 1; padding: 5px; border-radius: 5px; cursor: pointer; display: none; }
#anchors-content-container li:hover .entity-edit-btn { display: block; }
.entity-edit-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos para a Aba de Pesquisa Global */
.search-container { padding: 10px; }
.global-search-input {
    width: 100%; padding: 12px; font-size: 16px;
    background-color: var(--bg-color); border: 2px solid var(--border-color);
    border-radius: 8px; color: var(--text-color); outline: none;
    transition: border-color 0.3s; margin-bottom: 20px;
}
.global-search-input:focus { border-color: var(--accent-color); }

.search-results-group { margin-bottom: 20px; }
.search-results-header {
    font-size: 0.9em; text-transform: uppercase; color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color); margin-bottom: 10px; padding-bottom: 5px;
}
.search-result-item {
    background-color: rgba(255, 255, 255, 0.03); border-radius: 6px;
    padding: 12px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
    border-left: 3px solid transparent;
}
.search-result-item:hover { background-color: var(--hover-color); border-left-color: var(--accent-color); }
.search-result-title { font-weight: bold; color: var(--accent-color); display: block; margin-bottom: 4px; }
.search-result-path { font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 6px; display: block; }
.search-match-context {
    font-size: 0.9em; color: var(--text-color); line-height: 1.5;
    background-color: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;
    font-family: monospace;
}
.search-match-context mark { background-color: rgba(241, 196, 15, 0.4); color: white; border-radius: 2px; padding: 0 2px; }
.search-badge {
    font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 8px;
    text-transform: uppercase; font-weight: bold;
}
.badge-pasta { background-color: rgba(52, 152, 219, 0.2); color: #3498db; }
.badge-nota { background-color: rgba(46, 204, 113, 0.2); color: #2ecc71; }
.badge-postit { background-color: rgba(241, 196, 15, 0.2); color: #f1c40f; }
.badge-question { background-color: rgba(39, 174, 96, 0.2); color: #27ae60; }

@keyframes flash-highlight {
    0% { background-color: rgba(241, 196, 15, 0.8); }
    100% { background-color: transparent; }
}

.temporary-highlight {
    animation: flash-highlight 2s ease-out;
}

/* --- ESTILOS DO MODAL DE DESTAQUES (NOVO) --- */
/* 1. Contentor do Modal */
/* 1. Contentor do Modal */
#highlight-modal .modal-content {
    max-width: 500px !important; 
    width: 95%;
    padding: 20px;
}

/* 2. Grelha das Op√ß√µes */
#highlight-options-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 colunas no PC */
    gap: 12px;
    max-height: 65vh; 
    overflow-y: auto;
    overflow-x: hidden;
    margin-top: 15px;
    padding: 5px;
}

/* 3. Item Individual (O Quadrado) */
#highlight-options-container .highlight-option-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 15px 5px 10px 5px; /* Espa√ßo no topo para o l√°pis n√£o bater */
    border-radius: 8px;
    cursor: pointer;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s;
    height: 100px; 
    position: relative; /* CR√çTICO: Base para o l√°pis no canto */
    text-align: center;
    box-sizing: border-box;
}

/* 4. A BOLA DA COR */
#highlight-options-container .color-preview-box {
    width: 28px !important;
    height: 28px !important;
    border-radius: 50%;
    margin-bottom: 8px;
    flex-shrink: 0;
    display: block !important;
    border: 1px solid rgba(255,255,255,0.2);
}

/* 5. O BOT√ÉO DO L√ÅPIS (REPOSICIONADO NO CANTO) */
#highlight-options-container .highlight-options-btn {
    position: absolute !important; /* Retira do fluxo vertical */
    top: 5px !important;           /* Cola no topo */
    right: 5px !important;         /* Cola na direita */
    width: 22px !important;        /* Tamanho pequeno */
    height: 22px !important;
    font-size: 12px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 0 !important;
    margin: 0 !important;
    opacity: 0.6;
    transition: opacity 0.2s, background 0.2s;
}

#highlight-options-container .highlight-options-btn:hover {
    opacity: 1;
    background: var(--accent-color) !important;
    color: white;
}

/* 6. Ajuste do Nome/Label */
#highlight-options-container .highlight-name-label {
    font-size: 11px;
    font-weight: 500;
    line-height: 1.2;
    color: var(--text-color);
    width: 90%;
    overflow: hidden;
}

/* 7. Media Query para Mobile (At√© 480px) */
@media (max-width: 480px) {
    #highlight-options-container {
        grid-template-columns: repeat(2, 1fr); /* 2 colunas no Mobile */
        gap: 10px;
    }
    #highlight-options-container .highlight-option-row {
        height: 110px;
    }
    #highlight-options-container .highlight-name-label {
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
}

/* 8. Bot√£o Remover Destaque */
#highlight-options-container .remove-highlight-row {
    grid-column: 1 / -1;
    flex-direction: row;
    height: 48px;
    gap: 10px;
    border: 1px dashed #e74c3c;
    color: #e74c3c;
    font-weight: bold;
}

/* 8. Estilo do Selecionado */
.highlight-option-row.selected-color-row {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,0.3);
}

.highlight-option-row.selected-color-row .highlight-options-btn {
    color: white !important;
    opacity: 1;
}

/* Check no canto */
.highlight-option-row.selected-color-row::after {
    content: '‚úì';
    position: absolute;
    top: 2px;
    left: 6px;
    font-weight: bold;
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ============================================================
   ESTILOS DE TABELA E MENU FLUTUANTE
   ============================================================ */
/* Estilo da Tabela no Editor */
.jwn-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 0.95em;
}
.jwn-table th, .jwn-table td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    min-width: 50px;
    position: relative;
}
.jwn-table th {
    background-color: var(--sidebar-color);
    font-weight: bold;
    text-align: left;
    color: var(--accent-color);
}
/* Efeito hover para saber onde estamos */
.jwn-table td:hover, .jwn-table th:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* Menu de Ferramentas de Tabela */
#table-tools-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2000;
    padding: 5px;
    gap: 5px;
    flex-wrap: wrap;
    max-width: 220px;
}
#table-tools-popup button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 14px;
    flex-grow: 1;
}
#table-tools-popup button:hover {
    background-color: var(--accent-color);
    color: white;
}
#table-tools-popup .sep {
    width: 100%;
    height: 1px;
    background: var(--border-color);
    margin: 3px 0;
}

/* Wrapper para posicionar o bot√£o relativo √† tabela */
.jwn-table-wrapper {
    position: relative;
    margin-top: 25px; /* Espa√ßo para o bot√£o */
    margin-bottom: 15px;
}

/* Bot√£o de Ferramentas da Tabela */
.table-settings-btn {
    position: absolute;
    top: -28px;
    right: 0;
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    border-radius: 4px 4px 0 0;
    padding: 2px 8px;
    font-size: 14px;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 5px;
}
.table-settings-btn:hover, .table-settings-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* ============================================================
   WIDGET DE CALEND√ÅRIO
   ============================================================ */
.jwn-calendar-widget {
    border: 1px solid var(--border-color);
    background-color: var(--sidebar-color);
    border-radius: 8px;
    padding: 10px;
    margin: 15px 0;
    width: 100%;
    max-width: 350px; /* Tamanho compacto */
    user-select: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Cabe√ßalho: M√™s + Bot√µes */
.cal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    color: var(--accent-color);
    font-weight: bold;
}
.cal-btn {
    background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text-muted-color); padding: 4px 8px; border-radius: 4px;
}
.cal-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Menu de Defini√ß√µes (Semana/M√™s/Ano) */
.cal-settings-menu {
    display: none;
    flex-direction: column; /* Organiza bot√µes verticalmente */
    gap: 8px;
    margin-bottom: 10px;
    background: var(--panel-color); /* Fundo um pouco mais claro que a base */
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
/* Bot√£o Eliminar Agenda */
.cal-delete-btn {
    width: 100%;
    background-color: rgba(231, 76, 60, 0.1); /* Fundo vermelho muito subtil */
    border: 1px solid #c0392b; /* Borda vermelha escura */
    color: #e74c3c; /* Texto vermelho vivo */
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}/* Efeito Hover (Ao passar o rato) */
.cal-delete-btn:hover {
    background-color: #c0392b; /* Fica vermelho s√≥lido */
    color: white; /* Texto passa a branco */
    border-color: #c0392b;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.cal-settings-menu.visible { display: flex; }
.cal-view-btn {
    font-size: 0.8em; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; background: var(--panel-color); color: var(--text-color);
}
.cal-view-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }

/* Grelha de Dias */
.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
}
.cal-day-header {
    font-size: 0.75em; color: var(--text-muted-color); padding-bottom: 5px;
}
.cal-day {
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    position: relative;
    border: 1px solid transparent;
}
.cal-day:hover { background-color: var(--hover-color); border-color: var(--border-color); }
.cal-day.empty { background: transparent; cursor: default; }
.cal-day.today { border: 1px solid var(--accent-color); font-weight: bold; color: var(--accent-color); }

/* Ponto indicador de tarefa */
.cal-day.has-task {
    font-weight: bold; /* Opcional: p√µe o n√∫mero a negrito */
}


.cal-day.has-task::after { content: ''; position: absolute; bottom: 4px; /* Ajuste a altura */ left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #e74c3c; /* Vermelho */ border-radius: 50%; z-index: 2; }
/* Garante que o dia tem posi√ß√£o relativa para o ponto ficar dentro dele */
.cal-day {
    position: relative; 
}

/* Estilos para o Seletor de Agrega√ß√£o */
.agreg-item {
    display: flex; 
    align-items: center; 
    padding: 10px; 
    border-bottom: 1px solid var(--border-color); 
    cursor: pointer;
}
.agreg-item:hover { background-color: var(--hover-color); }

/* Tipos de Item */
.agreg-type-folder { font-weight: bold; color: var(--text-color); }
.agreg-type-note { color: var(--text-muted-color); }

/* Caixas de Conte√∫do (Miniaturas) */
.agreg-box-item {
    background-color: rgba(255,255,255,0.03);
    margin: 5px 0;
    border-left: 4px solid transparent;
    padding: 10px;
    border-radius: 4px;
    display: flex;
    gap: 10px;
}
.agreg-box-item.selected {
    background-color: rgba(74, 144, 226, 0.15);
    border: 1px solid var(--accent-color);
}

/* Cores das Bordas das Caixas */
.agreg-box-question { border-left-color: #2ecc71; } /* Verde */
.agreg-box-subnote { border-left-color: #3498db; }  /* Azul */
.agreg-box-free { border-left-color: #e67e22; }     /* Laranja */

/* --- NOVO: POPUP DE DEFINI√á√ïES DE PARTILHA --- */
#share-settings-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2200;
    padding: 15px;
    width: 220px;
    flex-direction: column;
    gap: 10px;
}

#share-settings-popup h4 {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    text-transform: uppercase;
    color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
}

.share-toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95em;
    color: var(--text-color);
}

/* Estado visual do bot√£o na toolbar quando partilhado */
button.sharing-active {
    color: #2ecc71 !important; /* Verde */
    border-color: #2ecc71 !important;
    background-color: rgba(46, 204, 113, 0.1) !important;
}

/* ============================================================
   ESTILO T√çTULO TOGGLE (EXPANS√çVEL)
   ============================================================ */
details.toggle-section {
    margin: 15px 0;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.02);
    display: block; 
    height: auto; /* Garante que a altura √© autom√°tica */
}

details.toggle-section summary {
    padding: 10px;
    cursor: pointer;
    list-style: none !important;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
    user-select: none;
}

/* Remove a seta padr√£o no Chrome/Safari */
details.toggle-section summary::-webkit-details-marker {
   display: none !important;
}

details.toggle-section summary:hover {
    background-color: var(--hover-color);
}

details.toggle-section summary::marker {
    display: none !important; /* Refor√ßo para navegadores modernos */
}

/* A nossa seta personalizada */
details.toggle-section summary::before {
    content: '‚òÇ';
    display: inline-block;
    width: 20px;
    font-size: 12px;
    color: var(--text-muted-color);
    transition: transform 0.2s ease;
    margin-right: 8px;
}

/* Quando aberto, roda a seta */
details.toggle-section[open] summary::before {
    transform: rotate(90deg);
}

/* O T√≠tulo H2 l√° dentro */
details.toggle-section summary h2 {
    margin: 0;
    display: inline;
    border: none;
    font-size: 1.5em; /* Tamanho A2 */
    font-weight: bold;
    color: var(--text-color); /* Herda cor ou usa padr√£o */
}

/* O conte√∫do oculto */
details.toggle-section .toggle-content {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: rgba(0, 0, 0, 0.1);
    
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* Usa normal em vez de pre-wrap para evitar conflito com <br> */
    display: block;
    height: auto !important; /* For√ßa altura autom√°tica */
}

/* Bot√£o de eliminar dentro do Toggle */
.toggle-delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-delete-btn:hover {
    opacity: 1;
    background-color: rgba(192, 57, 43, 0.1); /* Fundo vermelho suave */
}

/* Garante que o T√≠tulo ocupa o espa√ßo todo para empurrar o lixo para a direita */
details.toggle-section summary h2 {
    flex-grow: 1;
}

/* Bot√£o do Pincel (igual ao do lixo, mas margem ajustada) */
.toggle-color-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-color-btn:hover {
    opacity: 1;
    background-color: rgba(255, 255, 255, 0.1);
}

/* Estilo das bolas de cor no popup */
.color-choice {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}
.color-choice:hover {
    transform: scale(1.15);
    border-color: var(--text-color);
}

/* Bot√µes de Mover dentro do Toggle */
.toggle-move-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px; /* Um pouco menor que o t√≠tulo */
    margin-left: 5px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-move-btn:hover {
    opacity: 1;
    background-color: var(--hover-color);
}


/* Corre√ß√£o de tamanho de texto dentro dos Toggles */
details.toggle-section .toggle-content, 
details.toggle-section .toggle-content p, 
details.toggle-section .toggle-content div {
    font-size: 1em !important; /* 1em significa "igual ao tamanho atual" */
    line-height: inherit !important;
}

/* ============================================================
   ESTILO DO AGRUPADOR DE SETAS (NOVO)
   ============================================================ */
.toolbar-btn-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color); /* A borda do ret√¢ngulo */
    border-radius: 4px;
    margin-left: 5px;
    height: 30px;
    overflow: hidden; /* Garante cantos arredondados */
    background-color: transparent;
}

/* Removemos o estilo padr√£o dos bot√µes APENAS quando est√£o dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button {
    border: none !important;       /* Sem borda individual */
    border-radius: 0 !important;   /* Sem cantos redondos individuais */
    margin-left: 0 !important;     /* Sem espa√ßo entre eles */
    width: 28px !important;        /* Largura fixa */
    height: 100% !important;
}

/* Adiciona a linha separadora no meio */
.mini-note-toolbar .toolbar-btn-group button:first-child {
    border-right: none !important; /* <--- MUDAR AQUI PARA "none" */
}

/* Efeito Hover dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button:hover {
    background-color: var(--hover-color);
}
/* ============================================================
   WIDGET DE LINHA CRONOL√ìGICA (TIMELINE)
   ============================================================ */
.jwn-timeline-wrapper {
    position: relative;
    padding: 20px 10px;
    margin: 15px 0;
    background-color: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* A Linha Vertical */
.timeline-track {
    position: absolute;
    left: 30px; /* Posi√ß√£o da linha */
    top: 20px;
    bottom: 50px; /* Espa√ßo para o bot√£o adicionar */
    width: 2px;
    background-color: var(--accent-color);
    opacity: 0.5;
}

/* O item individual */
.timeline-entry {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-left: 45px; /* Espa√ßo para a bolinha e linha */
}

/* A bolinha (marcador) */
.t-marker {
    position: absolute;
    left: 24px; /* Centrado na linha (30px - metade da bola) */
    top: 5px;
    width: 14px;
    height: 14px;
    background-color: var(--bg-color);
    border: 2px solid var(--accent-color);
    border-radius: 50%;
    z-index: 2;
    transition: background-color 0.2s;
}

.timeline-entry:hover .t-marker {
    background-color: var(--accent-color);
}

/* Campos de Texto */
.t-date {
    font-weight: bold;
    color: var(--accent-color);
    min-width: 80px;
    margin-right: 10px;
    font-size: 0.9em;
    border-bottom: 1px dashed transparent;
}

.t-text {
    flex-grow: 1;
    color: var(--text-color);
    line-height: 1.4;
}

.t-date:focus, .t-text:focus {
    outline: none;
    border-bottom-color: var(--accent-color);
}

/* Bot√µes de A√ß√£o */
.t-btn-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0;
    margin-left: 10px;
    transition: opacity 0.2s;
}

.timeline-entry:hover .t-btn-del {
    opacity: 1;
}

.t-btn-add {
    display: block;
    margin-left: 23px; /* Alinhado com a linha */
    background: none;
    border: 1px dashed var(--text-muted-color);
    color: var(--text-muted-color);
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    margin-top: 10px;
    transition: all 0.2s;
}

.t-btn-add:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

   /* --- ESTILOS DO SCANNER UNIVERSAL --- */
/* Estilo para os itens do scanner b√≠blico */
.bible-scan-item {
    display: flex;
    align-items: center;
    padding: 8px;
    background-color: var(--bg-color);
    border-radius: 4px;
    margin-bottom: 5px;
    cursor: pointer;
}
.bible-scan-item:hover {
    background-color: var(--hover-color);
}
.bible-scan-item input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.bible-scan-item label {
    flex-grow: 1;
    cursor: pointer;
    font-weight: 500;
}
.bible-scan-existing-item {
    padding: 8px;
    color: #2ecc71; /* Verde */
    font-weight: 500;
    display: flex;
    align-items: center;
}
.bible-scan-existing-item::before {
    content: '‚úì';
    margin-right: 10px;
    font-weight: bold;
}
/* Abas */
.scan-tabs {
    display: flex;
    gap: 10px;
}
.scan-tab-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: var(--text-muted-color);
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: all 0.2s;
}
.scan-tab-btn:hover {
    color: var(--text-color);
    background-color: var(--hover-color);
    border-radius: 4px 4px 0 0;
}
.scan-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

/* Itens da Lista */
.scan-item-row {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-color);
    margin-bottom: 5px;
    border-radius: 4px;
}
.scan-item-row:hover {
    background-color: var(--hover-color);
}
.scan-checkbox {
    width: 18px; height: 18px; margin-right: 10px; cursor: pointer;
}
.scan-info {
    flex-grow: 1; display: flex; flex-direction: column;
}
.scan-name {
    font-weight: bold; color: var(--text-color);
}
.scan-location {
    font-size: 0.8em; color: var(--text-muted-color);
}
.scan-preview-btn {
    background: none; border: 1px solid var(--border-color);
    color: var(--text-muted-color); border-radius: 50%;
    width: 30px; height: 30px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    margin-left: 10px; transition: all 0.2s;
}
.scan-preview-btn:hover {
    background-color: var(--accent-color); color: white; border-color: var(--accent-color);
}

/* Sec√ß√µes (Novos vs Existentes) */
.scan-section-title {
    font-size: 0.85em; text-transform: uppercase; 
    color: var(--text-muted-color); margin: 15px 0 10px 0;
    font-weight: bold; border-bottom: 1px solid var(--border-color);
}

/* Popup de Preview Flutuante */
#scan-preview-popup {
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80%; max-width: 350px;
    background-color: var(--panel-color);
    border: 1px solid var(--accent-color);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    border-radius: 8px;
    z-index: 10;
    overflow: hidden;
}
.preview-header {
    background-color: var(--sidebar-color);
    padding: 8px 12px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border-color);
}
.preview-header button {
    background: none; border: none; color: var(--text-color); font-size: 18px; cursor: pointer;
}
#scan-preview-content {
    padding: 15px;
    font-size: 0.9em;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
}
#scan-preview-content mark {
    background-color: rgba(241, 196, 15, 0.4);
    color: white; padding: 2px 4px; border-radius: 4px;
}

/* --- CSS PARA O BOT√ÉO "VOLTAR √Ä NOTA" --- */


/* Garante que o Painel do Meio ocupa 100% da tela no Mobile */
@media (max-width: 768px) {
    #middle-panel {
        width: 100% !important;
        right: 0 !important;
        max-width: none !important;
    }
}

/* --- ESTILOS DO PAINEL DE REFER√äNCIAS (ABAS E PUZZLE) --- */

/* Caixas de M√≥dulo de Texto (Puzzle) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: transform 0.2s;
}

.puzzle-module-card textarea {
    width: 100%;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    border-radius: 4px;
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
}

.puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
}

.puzzle-controls button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.puzzle-controls button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.puzzle-controls button.delete:hover {
    background-color: rgba(192, 57, 43, 0.2);
    color: #e74c3c;
    border-color: #e74c3c;
}

/* Item da Lista de Refer√™ncias Escolhidas */
#puzzle-chosen-list li {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background-color: rgba(255, 255, 255, 0.03);
    border-left: 3px solid var(--accent-color);
}

.chosen-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 0.9em;
}

.chosen-ref-snippet {
    font-size: 0.85em;
    color: var(--text-muted-color);
    font-style: italic;
    margin-top: 3px;
    padding: 5px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}

/* Bot√£o adicionar ao puzzle (na aba Refer√™ncias) */
.add-to-puzzle-btn {
    background-color: var(--hover-color);
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 14px;
    cursor: pointer;
    margin-right: 5px;
}
.add-to-puzzle-btn:hover {
    background-color: var(--accent-color);
    color: white;
}

/* --- ESTILOS DO PUZZLE (MODO LEITURA VS EDI√á√ÉO) --- */

/* Estilo do Card (Contentor) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: all 0.2s;
}

/* O Textarea por padr√£o (MODO LEITURA - "Bonito") */
.puzzle-module-card textarea {
    width: 100%;
    /* Remove as bordas e fundo para parecer texto limpo */
    background: transparent; 
    border: none; 
    color: var(--text-color);
    padding: 5px;
    resize: none; /* Impede redimensionar */
    min-height: auto;
    font-family: inherit;
    font-size: 0.95em;
    line-height: 1.5;
    outline: none;
    overflow: hidden; /* Esconde scrollbar */
}

/* Os bot√µes de controlo por padr√£o (ESCONDIDOS) */
.puzzle-module-card .puzzle-controls {
    display: none; 
}

/* --- CLASSE ATIVADORA: .edit-mode-active --- */
/* Quando o contentor pai tem esta classe, mudamos o visual */

/* 1. Mostra o bot√£o "+ Criar" */
#ref-content-puzzle.edit-mode-active #add-puzzle-module-btn {
    display: block !important;
}

/* 2. Muda o Textarea para parecer um campo de input */
#ref-content-puzzle.edit-mode-active .puzzle-module-card textarea {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    resize: vertical; /* Permite redimensionar */
    min-height: 60px;
}

/* 3. Mostra os bot√µes de controlo (Setas e Lixo) */
#ref-content-puzzle.edit-mode-active .puzzle-module-card .puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-top: 5px;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}


/* Bot√µes do Quadro */
.puzzle-edit-toggle {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    border-radius: 4px; padding: 4px 10px; cursor: pointer; transition: all 0.2s;
}
.puzzle-action-btn {
    border: none; color: white; border-radius: 4px; padding: 4px 10px; 
    cursor: pointer; font-weight: bold; font-size: 0.85em;
}
.btn-blue { background-color: #3498db; }
.btn-blue:hover { background-color: #2980b9; }
.btn-green { background-color: #2ecc71; }
.btn-green:hover { background-color: #27ae60; }

/* Estilo do Cart√£o no Quadro (Gen√©rico) */
.board-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Tipo TEXTO */
.board-card.type-text textarea {
    width: 100%; background: transparent; border: none; color: var(--text-color);
    resize: none; font-family: inherit; line-height: 1.5; outline: none;
}
/* No modo edi√ß√£o, o textarea parece um input */
.edit-mode-active .board-card.type-text textarea {
    background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; resize: vertical;
}

/* Tipo REFER√äNCIA */
.board-card.type-ref {
    border-left: 3px solid #2ecc71; /* Borda verde para identificar */
}
.ref-card-content {
    font-size: 0.9em; color: var(--text-color);
}
.ref-card-title {
    font-weight: bold; color: var(--accent-color); display: flex; align-items: center; gap: 5px;
}
.ref-card-snippet {
    background-color: transparent; /* Remove fundo amarelo se houver */
    padding: 5px 0; 
    margin: 5px 0; 
    color: var(--text-muted-color); 
    font-size: 0.9em; 
    line-height: 1.5;
    /* Adiciona a barra lateral de cita√ß√£o para ficar igual */
    border-left: 2px solid var(--accent-color);
    padding-left: 10px;
}

/* Garante que o <mark> dentro do snippet tem a cor correta */
.ref-card-snippet mark {
    background-color: rgba(74, 144, 226, 0.4); /* Azul suave */
    color: var(--text-color); 
    border-radius: 3px; 
    padding: 1px 3px;
}

/* Controlos (Lixo, Setas) */
.card-controls {
    display: none; /* Escondido por padr√£o */
    margin-top: 5px; 
    border-top: 1px solid var(--border-color); 
    padding-top: 5px; 
    justify-content: flex-end; 
    gap: 5px;
}
.edit-mode-active .card-controls { display: flex; } /* Mostra ao editar */

/* A MAGIA: S√≥ mostra quando o painel tem esta classe */
#ref-content-puzzle.edit-mode-active .card-controls {
    display: flex !important;
}

.card-controls button {
    background: none; border: 1px solid var(--border-color); cursor: pointer; padding: 2px 6px; border-radius: 4px;
}
.card-controls button:hover { background-color: var(--hover-color); }

/* Estilo Base (Modo Visualiza√ß√£o - Limpo) */
.board-text-content {
    width: 100%;
    min-height: 40px;
    outline: none;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-color);
    
    /* O SEGREDO: Bordas e fundo transparentes por defeito */
    border: 1px solid transparent; 
    background-color: transparent;
    padding: 2px 5px; /* Padding pequeno para leitura */
    transition: all 0.2s ease;
}

/* Estilo Modo Edi√ß√£o (Quando o pai tem a classe activa) */
.edit-mode-active .board-text-content {
    border: 1px solid var(--border-color);
    background-color: var(--bg-color); /* Fundo da caixa de input */
    border-radius: 4px;
    padding: 8px; /* Mais espa√ßo para escrever */
    cursor: text;
}

/* Efeito Hover opcional no modo edi√ß√£o para saber que pode clicar */
.edit-mode-active .board-text-content:hover {
    border-color: var(--accent-color);
}

/* ============================================================
   ESTILO PERSONALIZADO PARA LINKS DO QUADRO
   ============================================================ */
a.board-link {
    /* 1. Mant√©m a cor do texto original (branco/cinza) */
    color: inherit !important; 
    
    /* 2. Remove o sublinhado padr√£o */
    text-decoration: none !important; 
    
    /* 3. Cria a linha picotada azul por baixo */
    border-bottom: 1px dotted #4a90e2 !important; 
    
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Efeito ao passar o rato (Opcional: torna a linha s√≥lida) */
a.board-link:hover {
    border-bottom-style: solid !important;
    background-color: rgba(74, 144, 226, 0.1); /* Fundo azul muito suave */
}

/* --- ESTILO PARA O ITEM DO POPUP DE REFER√äNCIA --- */
.puzzle-ref-item {
    display: flex !important;        /* For√ßa layout flex√≠vel */
    flex-direction: column !important; /* Organiza em colunas (Cima/Baixo) */
    align-items: flex-start !important;
    justify-content: center !important;
    width: 100%;
    padding: 12px 15px !important;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    box-sizing: border-box; /* Garante que padding n√£o aumenta largura */
    overflow: hidden;       /* Impede barras de scroll */
}

.puzzle-ref-item:hover {
    background-color: var(--hover-color);
}

/* Linha de Cima (Tipo + Nome da Nota) */
.puzzle-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 6px;
}

/* O Tipo (Ex: Quest√£o) */
.puzzle-ref-type {
    font-weight: bold;
    color: var(--text-color);
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0; /* Impede de encolher */
}

/* O Nome da Nota (Direita) */
.puzzle-ref-note {
    font-size: 0.8em;
    color: var(--text-muted-color);
    text-align: right;
    
    /* Truncar texto longo com ... */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%; /* Ocupa no m√°ximo 60% da linha */
}

/* O Texto de Contexto (Baixo) */
.puzzle-ref-snippet {
    font-size: 0.9em;
    color: var(--text-muted-color);
    width: 100%;
    line-height: 1.4;
    
    /* Truncar texto longo com ... */
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================================
   WIDGET CARD DE LINK (üé¥)
   ============================================================ */
  .url-card-widget {
    /* MUDAN√áA 1: inline-flex permite que fiquem lado a lado */
    display: inline-flex; 
    flex-direction: column;
    width: 240px;             
    height: 180px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin: 5px; 
    vertical-align: top; /* Alinha pelo topo quando h√° texto ao lado */
    position: relative;
    background-color: var(--panel-color);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    user-select: none;
    text-decoration: none;
    cursor: grab; /* M√£ozinha para indicar que pode arrastar */
}

.url-card-widget:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border-color: var(--accent-color);
}

/* Estado enquanto est√° a ser arrastado (Fica transparente) */
.url-card-widget.sortable-dragging {
    opacity: 0.4;
    border: 2px dashed var(--accent-color);
}

/* Indicadores de onde vai cair (Esquerda ou Direita) */
.url-card-widget.drop-target-left {
    border-left: 4px solid var(--accent-color) !important;
    transform: none !important;
}

.url-card-widget.drop-target-right {
    border-right: 4px solid var(--accent-color) !important;
    transform: none !important;
}

/* √Årea da Imagem */
.url-card-image {
    width: 100%;
    height: 100px;
    background-color: #2c2c30;
    background-size: cover;
    background-position: center;
    position: relative;
}

/* T√≠tulo e Dom√≠nio */
.url-card-info {
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex-grow: 1;
}

.url-card-title {
    font-weight: bold;
    font-size: 0.9em;
    color: var(--text-color);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* M√°ximo 2 linhas */
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 5px;
}

.url-card-domain {
    font-size: 0.75em;
    color: var(--text-muted-color);
    text-transform: uppercase;
    font-weight: 600;
}

/* Bot√£o de Fechar (X) - S√≥ aparece no hover */
.url-card-close {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 50%;
    display: none; /* Escondido por defeito */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    transition: background 0.2s;
}

.url-card-close:hover {
    background-color: #e74c3c; /* Vermelho ao passar o rato */
}

.url-card-widget:hover .url-card-close {
    display: flex; /* Mostra ao passar o rato no card */
}

/* Loading State */
.url-card-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 0.8em;
    color: var(--text-muted-color);
    font-style: italic;
}

/* Estilo para a nova Dropdown de Formata√ß√£o */
#editor-format {
    background-color: var(--hover-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    padding: 0 5px;
    height: 32px;
    cursor: pointer;
    outline: none;
    font-size: 14px;
    margin-right: 5px;
   width: 105px; /* Largura suficiente para o texto */
}

#editor-format:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

#editor-format option {
    background-color: var(--sidebar-color);
    color: var(--text-color);
}

/* Grelha de Vers√≠culos B√≠blicos */
.bible-verses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 8px;
    padding: 10px 0;
}

.verse-btn {
    aspect-ratio: 1; /* Quadrado */
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    background-color: var(--panel-color);
    color: var(--text-muted-color);
    transition: all 0.2s;
}

.verse-btn:hover {
    border-color: var(--accent-color);
    color: var(--text-color);
}

/* Vers√≠culo que j√° existe (Verde) */
.verse-btn.exists {
    background-color: rgba(46, 204, 113, 0.15);
    border-color: #2ecc71;
    color: #2ecc71;
    font-weight: bold;
}

.verse-btn.exists:hover {
    background-color: #2ecc71;
    color: white;
}

/* --- √çCONE DE SUPERPASTA (üóÉÔ∏è) --- */

/* Substitui o √≠cone padr√£o (üìÅ) pelo arquivo (üóÉÔ∏è) quando √© superpasta */
.list-item[data-superpasta="true"]::before {
    content: 'üóÉÔ∏è' !important; 
    font-size: 20px; /* Um pouco maior para destacar */
}

/* (Opcional) Mant√©m o estilo dourado que cri√°mos antes para o texto */
.list-item[data-superpasta="true"] {
    border-left: 3px solid #f1c40f !important;
}

/* Estilo dos bot√µes de Emoji */
.emoji-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    font-size: 24px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}
.emoji-btn:hover {
    background-color: var(--hover-color);
    transform: scale(1.1);
}

/* L√ìGICA M√ÅGICA PARA MOSTRAR O √çCONE PERSONALIZADO NA LISTA */
/* Se o item tiver a vari√°vel --custom-icon definida, usa isso em vez do padr√£o */
.list-item[style*="--custom-icon"]::before {
    content: var(--custom-icon) !important;
    font-size: 20px;
}

#context-menu {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 10000000 !important;
    
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    
    display: none; 
    flex-direction: column;
    padding: 15px; /* Reduzi o padding geral */
    width: 90%;
    max-width: 360px;
    
    /* L√ìGICA DE SCROLL */
    max-height: 85vh; /* O popup nunca ocupar√° mais de 85% da altura da tela */
    overflow-y: auto; /* Ativa scroll vertical se houver muitas op√ß√µes */
    scrollbar-width: thin; /* Scroll fino para Firefox */
    animation: popupScale 0.2s ease-out;
}

/* T√≠tulo fixo no topo do popup */
#context-menu::before {
    content: 'Op√ß√µes';
    display: block;
    text-align: center;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 12px;
    text-transform: uppercase;
    font-size: 0.75em;
    letter-spacing: 1px;
}

/* Grid de Bot√µes */
.context-menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px; /* Espa√ßo reduzido entre bot√µes */
    width: 100%;
}

#context-menu button {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px 10px; /* Padding reduzido para diminuir a altura */
    text-align: center;
    cursor: pointer;
    border-radius: 8px;
    font-size: 12px; /* Fonte ligeiramente menor */
    font-weight: 500;
    transition: all 0.2s;
    
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    height: 42px; /* ALTURA REDUZIDA (antes era 55px) */
}

#context-menu button:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Linha Separadora Compacta */
#context-menu hr.menu-sep {
    grid-column: span 2;
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 5px 0; /* Margem reduzida */
    opacity: 0.4;
}

/* Bot√£o Fechar */
.context-menu-close {
    grid-column: span 2;
    margin-top: 5px;
    background: none !important;
    border: none !important;
    color: var(--text-muted-color) !important;
    font-size: 11px !important;
    text-decoration: none !important;
    height: 30px !important; /* Altura menor para o cancelar */
}

/* Personaliza√ß√£o da Scrollbar interna do popup */
#context-menu::-webkit-scrollbar {
    width: 6px;
}
#context-menu::-webkit-scrollbar-track {
    background: var(--panel-color);
}
#context-menu::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

/* ============================================================
   LINHAS ARRAST√ÅVEIS (·Øì)
   ============================================================ */
.draggable-line {
    display: flex;
    align-items: baseline; /* Alinha o texto pela base da letra, n√£o pelo topo da caixa */
    margin: 2px 0;         /* Margem m√≠nima para n√£o criar buracos */
    padding: 2px 0;        /* Padding reduzido */
    width: 100%;           /* Garante que ocupa a largura toda */
    box-sizing: border-box;
}

.draggable-line:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* O √çcone/Puxador */
.drag-handle-icon {
    cursor: grab;
    margin-right: 8px;
    font-weight: normal; /* Remove negrito excessivo */
    color: var(--accent-color);
    user-select: none; 
    font-size: 1.1em;    /* Tamanho ajustado ao texto */
    line-height: 1.4;    /* Igual ao texto normal */
    flex-shrink: 0; 
    transform: translateY(2px); /* Pequeno ajuste fino vertical */
}

/* O Conte√∫do do Texto */
.drag-content-area {
    flex: 1;
    outline: none;
    min-width: 0; 
    line-height: 1.4; /* For√ßa a mesma altura de linha do editor */
    white-space: pre-wrap; /* Mant√©m quebras de linha se existirem */
}

/* Garante que os par√°grafos vizinhos n√£o empurram */
.toggle-content p, 
.mini-note-content p {
    margin: 4px 0 !important;
    line-height: 1.4 !important;
}




/* ============================================================
   ESTILOS H√çBRIDOS DE TOOLBAR (DESKTOP vs MOBILE)
   ============================================================ */

/* --- PADR√ÉO (DESKTOP) --- */
/* Faz com que os grupos novos (toolbar-nav-section, etc) sejam ignorados pelo layout flex pai */
.toolbar-nav-section, 
.toolbar-tools-section {
    display: contents; 
}

/* Oculta separadores exclusivos de mobile */
.mobile-only-sep {
    display: none;
}

/* --- VERS√ÉO MOBILE (LAYOUT DUAS LINHAS NO TOPO) --- */
@media (max-width: 768px) {

    /* 1. Mudar a ordem geral do Editor */
    #editor-area {
        display: flex;
        flex-direction: column;
    }

    /* 2. Mover a Toolbar para o TOPO (Acima do T√≠tulo) */
    #editor-toolbar {
        order: -1; /* Coloca antes do input de t√≠tulo */
        display: flex;
        flex-direction: column; /* Organiza as duas barras verticalmente */
        padding: 0;
        background-color: var(--panel-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
        width: 100%;
    }

    /* 3. DESATIVA O 'display: contents' para assumir controlo no Mobile */
    .toolbar-nav-section, 
    .toolbar-tools-section {
        display: flex; 
    }


    /* ==================================================
       LINHA 1: FERRAMENTAS (Scroll Horizontal)
       ================================================== */
    .toolbar-tools-section {
        order: 1; /* Primeira Linha */
        width: 100%;
        overflow-x: auto; /* Permite scroll lateral */
        white-space: nowrap;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        align-items: center;
        
        /* Esconde barra de scroll feia */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .toolbar-tools-section::-webkit-scrollbar { 
        display: none; 
    }

    /* For√ßa a Barra Secund√°ria a aparecer e integrar-se na linha */
    #secondary-toolbar {
        display: flex !important; /* For√ßa visibilidade */
        position: static !important; /* Remove posicionamento absoluto se houver */
        background: none !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
        animation: none !important;
        flex-shrink: 0; /* Impede que encolha */
    }

    /* Ajustes nos bot√µes para mobile */
    #editor-toolbar button, 
    #secondary-toolbar button,
    #editor-toolbar select,
    #secondary-toolbar select,
    #editor-toolbar input[type="color"] {
        flex-shrink: 0; /* Garante que n√£o ficam esmagados */
        height: 34px; /* Altura de toque amig√°vel */
        min-width: 34px;
        margin: 0 1px;
    }

    /* Esconder a seta de "Mais Ferramentas" no mobile (j√° est√° tudo vis√≠vel) */
    #toggle-more-tools-btn {
        display: none !important;
    }

    /* Mostra separador extra */
    .mobile-only-sep {
        display: block;
        width: 1px;
        height: 20px;
        background-color: var(--border-color);
        margin: 0 8px;
        flex-shrink: 0;
    }

    /* ==================================================
       LINHA 2: NAVEGA√á√ÉO E STATUS (Fundo)
       ================================================== */
    .toolbar-nav-section {
        order: 2; /* Segunda Linha */
        width: 100%;
        padding: 5px 10px;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(0,0,0,0.1); /* Ligeiramente mais escuro */
        height: 40px;
    }

    /* Bot√£o Back */
    #mobile-back-btn {
        display: flex !important;
        background: none;
        border: none;
        color: var(--accent-color);
        font-size: 1.2em;
        padding: 5px;
        margin: 0 !important;
    }

    /* Status de Grava√ß√£o */
    .save-status {
        font-size: 0.75em;
        margin: 0;
        text-align: center;
        flex-grow: 1; /* Ocupa o centro */
    }

    /* Grupo da Direita (Share, History) */
    .toolbar-history {
        margin: 0 !important;
        gap: 8px;
    }

    .desktop-spacer {
        display: none;
    }
    
    /* Remover margem do input de t√≠tulo para colar √† barra */
    #note-title-input {
        margin-top: 5px;
    }
}

/* ============================================================
   CORRE√á√ÉO DE PISCAR NO MOBILE (FOR√áA BRUTA)
   ============================================================ */
@media (max-width: 768px) {

    /* 1. Garante que o Painel do Meio ocupa sempre o ecr√£ todo quando ativo */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        width: 100% !important;
        height: 100% !important;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 60;
    }

    /* 2. O MAIS IMPORTANTE: For√ßa o Cabe√ßalho a existir */
    /* Isto impede que regras de desktop escondam o header */
    #middle-panel .panel-header {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        height: auto !important;
        min-height: 50px; /* Garante altura m√≠nima */
        width: 100% !important;
        flex-shrink: 0 !important; /* Impede de encolher a zero */
    }

    /* 3. Garante que o conte√∫do do header (t√≠tulo e bot√µes) est√° vis√≠vel */
    #middle-panel .panel-header > * {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* 4. Corrige o bot√£o de voltar no header da lista */
    #middle-panel .panel-header #back-btn {
        display: flex !important; /* Garante que √© flex para centrar a seta */
    }
}



/* ============================================================
   RESPONSIVIDADE MOBILE (SISTEMA DE PILHA)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Reset do Contentor Principal */
    .notebook-container {
        display: block !important;
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* 2. Configura√ß√£o Base dos 3 Pain√©is (Ecr√£ Cheio) */
    #left-panel, #middle-panel, #right-panel {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        flex: none !important;
        z-index: 10;
        border: none !important;
        border-radius: 0 !important;
        /* Reset de estilos desktop que causam cortes */
        margin: 0 !important;
        max-width: none !important;
        min-width: 0 !important;
    }

    /* --- L√ìGICA DE VISIBILIDADE (Quem est√° no topo?) --- */

    /* ESTADO 1: Painel Esquerdo (Pastas + Abas) */
    body:not(.mobile-view-middle):not(.mobile-view-editor) #left-panel {
        display: flex !important;
        z-index: 50; /* No topo */
        background-color: var(--sidebar-color);
    }
    body:not(.mobile-view-middle):not(.mobile-view-editor) #middle-panel,
    body:not(.mobile-view-middle):not(.mobile-view-editor) #right-panel {
        display: none !important;
    }

    /* ESTADO 2: Painel do Meio (Lista de Notas) */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        flex-direction: column !important;
        z-index: 60; /* Acima da esquerda */
        background-color: var(--panel-color);
        padding: 15px !important; /* Espa√ßo para n√£o cortar o topo */
    }
    body.mobile-view-middle #left-panel {
        display: none !important; 
    }
    body.mobile-view-middle #right-panel {
        display: none !important;
    }

    /* ESTADO 3: Editor (Nota Aberta) */
    body.mobile-view-editor #right-panel {
        display: flex !important;
        z-index: 70; /* Acima de tudo */
        background-color: var(--bg-color);
    }
    body.mobile-view-editor #left-panel, 
    body.mobile-view-editor #middle-panel {
        display: none !important;
    }

    /* --- CORRE√á√ïES ESPEC√çFICAS --- */

    /* 1. For√ßar as ABAS (Note/Lists/Book) a aparecerem bem */
    #left-panel .panel-content {
        padding-top: 10px;
    }
    .tabs-container {
        display: flex !important;
        margin-bottom: 15px !important;
        flex-shrink: 0; /* Impede que encolham */
    }
    
    /* 2. Corrigir o Cabe√ßalho da Coluna 2 (Para n√£o cortar) */
    #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        height: auto !important;
        min-height: 50px;
        margin-bottom: 20px;
        width: 100%;
        flex-shrink: 0;
    }
    
    /* For√ßar a visibilidade dos elementos internos do header */
    #middle-panel .panel-header h2,
    #middle-panel .panel-header #back-btn,
    #middle-panel .panel-header #add-item-btn {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* 3. Bot√£o de Voltar no Editor (Topo) */
    #mobile-back-btn {
        display: flex !important;
        align-items: center;
        padding: 5px 12px;
        background: var(--panel-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-right: 10px;
    }

    /* 4. Esconder bot√µes desktop in√∫teis */
    #middle-panel-toggle-btn,
    #left-panel-toggle-btn {
        display: none !important;
    }
}
/* ==========================================================
       CORRE√á√ÉO IPHONE 13 E BOT√ïES SUMIDOS
       ========================================================== */

    /* 1. Ajuste do Painel para respeitar o "Notch" (C√¢mara) do iPhone */
    #middle-panel,
    .notebook-container.middle-panel-collapsed #middle-panel {
        /* Adiciona espa√ßo no topo seguro para o iPhone */
        padding-top: calc(15px + env(safe-area-inset-top)) !important;
    }

    /* 2. For√ßa o cabe√ßalho a ser vis√≠vel e Horizontal */
    #middle-panel .panel-header,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important; /* Linha horizontal */
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        min-height: 50px !important;
        margin-bottom: 20px !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* 3. O MAIS IMPORTANTE: For√ßa os bot√µes e t√≠tulo a aparecerem! 
       (Anula a regra que os escondia no modo colapsado) */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header > *,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #back-btn,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #add-item-btn {
        display: flex !important; /* Traz de volta os elementos! */
        visibility: visible !important;
        opacity: 1 !important;
        height: 32px !important;
        align-items: center;
    }

    /* Ajuste fino para o T√≠tulo (H2) ser bloco e n√£o flex */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2 {
        display: block !important;
        text-align: center;
        flex-grow: 1;
    }

/* ============================================================
   CORRE√á√ÉO H√çBRIDA TOOLBAR (PC Fiel + Mobile 2 Linhas)
   ============================================================ */

/* --- PADR√ÉO (PC) - Mant√©m o visual original --- */
#editor-toolbar {
    display: flex;
    flex-wrap: wrap; /* Permite que a barra secund√°ria quebre linha se necess√°rio */
    align-items: center;
    position: relative;
}

.tools-wrapper {
    display: contents; /* No PC, ignora este wrapper e mostra os bot√µes diretamente */
}

/* Oculta separadores exclusivos de mobile */
.toolbar-separator.mobile-only { display: none; }

/* Barra Secund√°ria no PC (Comportamento de Dropdown) */
/* Quando vis√≠vel via JS, ela aparece como flex */
#secondary-toolbar {
    width: 100%; /* For√ßa nova linha no PC */
    flex-basis: 100%;
    order: 10; /* Garante que fica abaixo de tudo */
    padding-top: 10px;
    margin-top: 5px;
    border-top: 1px solid var(--border-color);
    /* Mant√©m o display: none inline do HTML at√© o JS ativar */
}

/* --- VERS√ÉO MOBILE (LAYOUT FOR√áADO) --- */
@media (max-width: 768px) {

    /* 1. Mover Toolbar para cima do T√≠tulo */
    #editor-area {
        display: flex;
        flex-direction: column;
    }
    #toolbar-container {
        order: -1; /* Sobe para o topo */
        width: 100%;
        background-color: var(--panel-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
    }

    #editor-toolbar {
        flex-direction: column; /* Organiza em 2 linhas verticais */
        padding: 0;
        gap: 0;
    }

    /* 2. LINHA 1: Ferramentas (Scroll Horizontal) */
    .tools-wrapper {
        display: flex !important; /* Ativa o wrapper */
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        align-items: center;
        scrollbar-width: none; /* Esconde scrollbar Firefox */
    }
    .tools-wrapper::-webkit-scrollbar { display: none; } /* Esconde scrollbar Chrome */

    /* For√ßa a barra secund√°ria a aparecer e integrar-se na linha */
    #secondary-toolbar {
        display: contents !important; /* O SEGREDO: Faz os bot√µes filhos subirem para a linha principal */
    }

    /* Ajustes dos bot√µes no scroll */
    .tools-wrapper button, 
    .tools-wrapper select, 
    .tools-wrapper input {
        flex-shrink: 0;
        margin: 0 2px;
        height: 36px;
    }

    /* Esconde elementos in√∫teis no mobile */
    #toggle-more-tools-btn { display: none !important; }
    .toolbar-separator.desktop-only { display: none; }
    .toolbar-separator.mobile-only { 
        display: block; width: 1px; height: 24px; background: var(--border-color); margin: 0 8px; flex-shrink: 0; 
    }

    /* 3. LINHA 2: Navega√ß√£o e Status (Fixo em baixo) */
    .toolbar-history {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 10px;
        background-color: rgba(0,0,0,0.1);
        height: 44px;
        margin: 0 !important;
    }

    /* Bot√£o Voltar (Aparece na esquerda da linha 2) */
    #mobile-back-btn {
        display: flex !important;
        background: none;
        border: none;
        font-size: 20px;
        margin-right: auto; /* Empurra o resto para a direita */
    }

    /* Status no meio */
    .save-status {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8em;
        white-space: nowrap;
    }
}

/* ============================================================
   ORDEM DA BARRA DE FERRAMENTAS (PC vs MOBILE)
   ============================================================ */

/* --- PADR√ÉO (PC): Barra ABAIXO do t√≠tulo --- */
#editor-area {
    display: flex;
    flex-direction: column;
}

/* O input do t√≠tulo fica em 1¬∫ lugar (order: 0 √© o padr√£o) */
#note-title-input {
    order: 0;
    margin-bottom: 20px; /* Espa√ßo entre t√≠tulo e barra */
}

/* A barra de ferramentas fica em 2¬∫ lugar */
#toolbar-container {
    order: 1;
    margin-bottom: 10px; /* Espa√ßo entre barra e editor */
}

/* O editor fica em 3¬∫ lugar */
#note-content-editor {
    order: 2;
}


/* --- VERS√ÉO MOBILE: Barra ACIMA do t√≠tulo --- */
@media (max-width: 768px) {
    
    /* Inverte a ordem visualmente */
    
    /* A barra sobe para o topo (order negativo) */
    #toolbar-container {
        order: -1; 
        margin-bottom: 10px;
        position: sticky; /* Opcional: Mant√©m a barra vis√≠vel no topo ao fazer scroll */
        top: 0;
        z-index: 100;
    }

    /* O t√≠tulo desce para depois da barra */
    #note-title-input {
        order: 0;
        margin-top: 5px;
        margin-bottom: 15px;
    }

    /* O editor mant√©m-se no fim */
    #note-content-editor {
        order: 1;
    }
}

/* ============================================================
   TOOLBAR PERSONALIZADA (PC vs MOBILE)
   ============================================================ */

/* --- CONFIGURA√á√ÉO PC (LAYOUT ORIGINAL) --- */
#editor-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    background-color: var(--panel-color);
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 15px;
    gap: 5px;
}

/* O "Truque": No PC, esta div √© invis√≠vel estruturalmente */
.tools-scroll-container {
    display: contents; 
}

/* Grupo da Direita (Status + √çcones) */
.toolbar-history-group {
    display: flex;
    align-items: center;
    margin-left: auto; /* Empurra para a direita no PC */
    gap: 15px;
}

/* Separadores Verticais */
.toolbar-separator {
    width: 1px;
    height: 24px;
    background-color: var(--border-color);
    margin: 0 5px;
    display: block; /* Vis√≠veis no PC */
}
.toolbar-separator.mobile-only { display: none; } /* Esconde extras no PC */

/* Barra Secund√°ria (PC) - Quebra para nova linha */
#secondary-toolbar {
    width: 100%;
    flex-basis: 100%;
    border-top: 1px solid var(--border-color);
    padding-top: 10px;
    margin-top: 5px;
    display: none; /* Controlado pelo JS */
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

/* Bot√£o Toggle (Seta) Ativo */
#toggle-more-tools-btn.active {
    background-color: var(--selected-color) !important;
}

/* ESTILO ESPEC√çFICO PARA O MODO PARTILHA (VERMELHO) */
.folder-mode-item.active.mode-shared {
    color: #e74c3c; /* Texto vermelho */
}

.folder-mode-item.active.mode-shared::after {
    background-color: #e74c3c !important; /* Linha vermelha for√ßada */
    height: 3px; /* Um pouco mais grossa para destaque */
}


/* --- ESTILOS DO ARQUIVO (FEED) --- */
.archive-post {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    position: relative;
    transition: box-shadow 0.2s;
}

.archive-post:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Modo Edi√ß√£o do Post */
.post-edit-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    animation: fadeIn 0.3s;
}

.post-title-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 4px;
}

.post-editor-content {
    min-height: 100px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 4px;
    outline: none;
    color: var(--text-color);
}

/* Toolbar Espec√≠fica do Post */
.post-toolbar {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    background: rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 4px;
}

.post-toolbar button {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 3px;
}
.post-toolbar button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Modo Visualiza√ß√£o do Post */
.post-view-container {
    display: flex;
    flex-direction: column;
}

.post-view-title {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 10px;
}

.post-view-content {
    line-height: 1.5;
    color: var(--text-color);
}

.post-edit-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.8em;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.archive-post:hover .post-edit-btn {
    opacity: 1;
}

.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    font-size: 0.75em;
    color: var(--text-muted-color);
    display: flex;
    justify-content: space-between;
}

/* ============================================================
   VISIBILIDADE DA TOOLBAR DAS ENTIDADES (ARQUIVO)
   ============================================================ */

/* 1. MODO VISUALIZA√á√ÉO: ESCONDER A BARRA */
/* Esconde a barra laranja/azul/verde com os √≠cones */
.post-view-content .mini-note-toolbar {
    display: none !important;
}

/* Esconde tamb√©m os bot√µes espec√≠ficos dos T√≠tulos Toggle (caso use) */
.post-view-content .toggle-color-btn,
.post-view-content .toggle-delete-btn,
.post-view-content .toggle-move-btn {
    display: none !important;
}

/* 2. MODO EDI√á√ÉO: GARANTIR VISIBILIDADE */
/* Quando clica em "Editar", a classe muda para .post-editor-content e a barra reaparece */
.post-editor-content .mini-note-toolbar {
    display: flex !important;
}

/* ============================================================
   CORRE√á√ÉO DE LAYOUT: ENTIDADES DENTRO DE POSTS
   ============================================================ */

/* 1. Remove margens negativas que causam transbordo */
/* O estilo original tem 'margin: 30px -25px', o que empurra para fora */
.post-editor-content .mini-note-wrapper,
.post-view-content .mini-note-wrapper {
    margin: 10px 0 !important; /* Margem vertical pequena, zero lateral */
    width: 100% !important;    /* For√ßa a caber no pai */
    box-sizing: border-box;    /* Garante que padding n√£o aumenta largura */
}

/* 2. Ajuste para Toggles (T√≠tulos Expans√≠veis) */
.post-editor-content details.toggle-section,
.post-view-content details.toggle-section {
    margin: 10px 0 !important;
    width: 100% !important;
}

/* 3. Ajuste fino do conte√∫do do post para evitar scroll horizontal desnecess√°rio */
.post-editor-content,
.post-view-content {
    overflow-x: hidden; /* Corta o que sobrar */
    width: 100%;        /* Garante largura total */
    word-wrap: break-word; /* Quebra palavras longas */
}

/* ============================================================
   PROTE√á√ÉO DA TOOLBAR INTERNA (ARQUIVO)
   ============================================================ */
.post-editor-content .mini-note-toolbar {
    user-select: none;          /* Impede selecionar os bot√µes com o rato */
    -webkit-user-select: none;  /* Safari/Chrome */
    -moz-user-select: none;     /* Firefox */
    cursor: default;
}

/* Garante que a barra √© considerada um bloco s√≥lido n√£o edit√°vel */
.post-editor-content .mini-note-toolbar[contenteditable="false"] {
    outline: none !important;
    border: none !important;
}

/* Garante espa√ßo para os bot√µes √† direita */
.post-view-title {
    padding-right: 120px; /* Espa√ßo para 3 bot√µes */
}

/* --- SELE√á√ÉO VERMELHA (MODO PARTILHA) --- */
.list-item.selected-red {
    background-color: rgba(231, 76, 60, 0.25) !important; /* Fundo vermelho suave */
    border-left: 4px solid #e74c3c !important; /* Borda vermelha forte */
    color: white !important;
}

/* Garante que o texto fica leg√≠vel */
.list-item.selected-red span {
    font-weight: bold;
}


/* --- BARRA DE COLABORA√á√ÉO --- */
#collab-bar {
    display: none; /* S√≥ aparece se houver colaboradores */
    align-items: center;
    padding: 0 20px;
    margin-bottom: 10px;
    gap: 5px;
}

.user-presence-bubble {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--accent-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    border: 2px solid var(--sidebar-color);
    cursor: default;
    position: relative;
    transition: transform 0.2s;
}

.user-presence-bubble:hover {
    transform: translateY(-2px);
    z-index: 10;
}

/* Tooltip do nome */
.user-presence-bubble::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.user-presence-bubble:hover::after { opacity: 1; }

/* --- POST BLOQUEADO (EDITADO POR OUTRO) --- */
.archive-post.is-locked {
    opacity: 0.7;
    border: 1px dashed #e74c3c !important;
    background: repeating-linear-gradient(
        45deg,
        rgba(231, 76, 60, 0.05),
        rgba(231, 76, 60, 0.05) 10px,
        rgba(231, 76, 60, 0.1) 10px,
        rgba(231, 76, 60, 0.1) 20px
    );
    pointer-events: none; /* Bloqueia cliques */
    position: relative;
}

.locked-badge {
    position: absolute;
    top: -10px;
    right: 10px;
    background-color: #e74c3c;
    color: white;
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
    z-index: 20;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 5px;
}

.list-item.selected, .list-item.selected-red {
    transition: background-color 0.1s ease-in-out, border-left 0.1s ease-in-out;
}


.archive-tab-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 10px 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 15px;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.archive-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.archive-tab-btn:hover {
    color: var(--text-color);
}
.drawer-toggle {
    margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px;
    background: rgba(255,255,255,0.02);
}
.drawer-toggle summary {
    padding: 15px; cursor: pointer; font-weight: bold; color: var(--accent-color);
    list-style: none; display: flex; justify-content: space-between;
}
.drawer-toggle[open] { border-color: var(--accent-color); }


.mini-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}
.mini-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}
/* Estilo para que o cabe√ßalho n√£o abra o toggle ao clicar nos bot√µes */
.drawer-controls {
    pointer-events: auto;
}


/* Estilo do bot√£o Criar Post ao lado das abas */
.archive-inline-create-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 14px; /* Tamanho igual √†s abas */
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 5px; /* Alinhamento visual com a borda de baixo */
    transition: opacity 0.2s;
    white-space: nowrap;
}

.archive-inline-create-btn:hover {
    opacity: 0.8;
}

/* Ajuste na div pai para o bot√£o n√£o esticar */
.archive-tabs {
    display: flex;
    align-items: center;
}

/* Efeito Hover no Popup de Formata√ß√£o Extra */
#formatting-popup button {
    background: rgba(255,255,255,0.05);
    border: 1px solid #444;
    border-radius: 4px;
    padding: 6px 0;
    cursor: pointer;
    transition: all 0.2s ease;
}

#formatting-popup button:hover {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important; /* O texto fica branco para contrastar com o fundo azul */
}

/* Estado ativo do bot√£o de mais formata√ß√µes */
#more-formatting-btn.active {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
}

/* --- AJUSTE DE BOT√ïES DE A√á√ÉO DOS POSTS --- */

/* 1. Contentor dos bot√µes no modo edi√ß√£o */
.post-edit-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    padding-top: 12px;
    margin-top: 10px;
}

.post-edit-actions .modal-btn {
    padding: 6px 12px !important;
    font-size: 13px !important;
    height: 32px !important;
    flex: 1 1 auto;
    min-width: fit-content;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}

/* --- L√ìGICA MOBILE (AT√â 480PX) --- */
@media (max-width: 480px) {
    .post-edit-actions {
        justify-content: center;
    }
    
    .post-edit-actions .modal-btn {
        font-size: 12px !important;
        padding: 6px 8px !important;
        flex: 1 1 45%; /* Garante 2 bot√µes por linha */
    }

    /* REORDENA√á√ÉO DOS BOT√ïES NO MOBILE */
    /* Ordem original no HTML: 1. Gavet√£o, 2. Eliminar, 3. Cancelar, 4. Salvar */
    
    .post-edit-actions .modal-btn:nth-child(1) { order: 1; } /* Gavet√£o continua em 1¬∫ */
    .post-edit-actions .modal-btn:nth-child(4) { order: 2; } /* SALVAR sobe para 2¬∫ (lugar do eliminar) */
    .post-edit-actions .modal-btn:nth-child(3) { order: 3; } /* Cancelar continua em 3¬∫ */
    .post-edit-actions .modal-btn:nth-child(2) { order: 4; } /* ELIMINAR desce para 4¬∫ (lugar do salvar) */
}


/* --- CONFIGURA√á√ÉO MOBILE (LAYOUT 2 LINHAS NO TOPO) --- */
@media (max-width: 768px) {

    /* 1. Mover Toolbar para cima do T√≠tulo */
    #editor-area { display: flex; flex-direction: column; }
    #toolbar-container {
        order: -1; 
        position: sticky; top: 0; z-index: 100;
        background-color: var(--panel-color);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    #note-title-input { order: 0; margin-top: 10px; }
    #note-content-editor { order: 1; }

    /* 2. Layout da Barra Principal */
    #editor-toolbar {
        flex-direction: column; /* Pilha vertical */
        padding: 0;
        gap: 0;
        border-radius: 0;
        margin-bottom: 0;
    }

    /* LINHA 1: Ferramentas com Scroll */
    .tools-scroll-container {
        display: flex; /* Ativa o flex para scroll */
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 5px;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        /* Esconde scrollbars */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .tools-scroll-container::-webkit-scrollbar { display: none; }

    /* For√ßa a barra secund√°ria a aparecer e integrar-se na linha 1 */
    #secondary-toolbar {
        display: contents !important; /* Faz os bot√µes subirem para a linha principal */
    }

    /* Separadores no Mobile */
    .toolbar-separator { margin: 0 8px; flex-shrink: 0; height: 20px; }
    .toolbar-separator.mobile-only { display: block; }

    /* Esconde a seta de toggle no mobile (tudo vis√≠vel) */
    #toggle-more-tools-btn { display: none !important; }

    /* Ajuste de bot√µes para toque */
    #editor-toolbar button, #editor-toolbar select, #editor-toolbar input {
        flex-shrink: 0; height: 34px; margin: 0 1px;
    }

    /* LINHA 2: Navega√ß√£o e Hist√≥rico (Barra Inferior) */
    .toolbar-history-group {
        width: 100%;
        height: 45px;
        background-color: rgba(0,0,0,0.2);
        justify-content: space-between; /* Espalha: Back - Status - √çcones */
        padding: 0 10px;
        margin: 0;
    }

    /* Bot√£o Back vis√≠vel */
    #mobile-back-btn {
        display: flex !important;
        background: none; border: none; font-size: 22px; color: var(--accent-color);
        padding: 0; margin: 0;
    }

    /* Ajuste do Status */
    .save-status {
        position: absolute; left: 50%; transform: translateX(-50%);
        font-size: 0.75em; opacity: 0.8;
    }
}

/* ============================================================
   NOVA REGRA: BOT√ïES FLUTUANTES (MOBILE FAB)
   ============================================================ */
#mobile-fab-container {
    display: none; /* Escondido por padr√£o em Desktop */
}

@media (max-width: 768px) {
    /* Esconde o rodap√© original do painel esquerdo */
    #left-panel .panel-footer {
        display: none !important;
    }

    /* O contentor s√≥ aparece se o body tiver a classe 'show-fab' */
       #mobile-fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none; /* Escondido por padr√£o */
        flex-direction: column;
        gap: 12px;
        z-index: 900;
        align-items: center;
    }

    body.show-fab #mobile-fab-container {
        display: flex !important; /* Mostra apenas quando a classe existir */
    }

    /* Prote√ß√£o extra: se mudar de ecr√£, os bot√µes morrem sempre */
    body.mobile-view-middle #mobile-fab-container,
    body.mobile-view-editor #mobile-fab-container {
        display: none !important;
    }

    /* Estilo das Bolinhas */
    .fab-btn {
        width: 48px; height: 48px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        background-color: var(--panel-color);
        color: var(--text-color);
        font-size: 20px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        cursor: pointer;
    }

    #mobile-fab-add {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        font-size: 28px;
        width: 56px; height: 56px;
    }

    /* Bot√£o Flash (‚ö°) - Ligeiramente menor e Laranja */
    #mobile-fab-flash {
    background-color: #e67e22 !important;
    color: white !important;
    border-color: #e67e22 !important;
    
    font-size: 18px !important; /* √çcone mais pequeno */
    width: 38px !important;      /* Di√¢metro reduzido */
    height: 38px !important;
    
    margin-bottom: 2px !important; /* Mais perto do bot√£o azul */
    box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
}
}

/* ============================================================
   MODO "APP NATIVA" (SEM SALTOS DE TELA) - MOBILE
   ============================================================ */
@media (max-width: 768px) {

    /* 1. TRAVAR A P√ÅGINA INTEIRA (O Segredo) */
    /* Isto impede que o site "fuja" quando faz scroll agressivo ou abre o teclado */
    html, body {
        height: 100% !important;
        width: 100% !important;
        overflow: hidden !important;
        position: fixed !important; 
    }

    /* 2. Painel da Direita (Contentor Fixo) */
    #right-panel {
        position: fixed !important;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw !important;
        height: 100% !important;
        display: none !important; /* Escondido por padr√£o */
        flex-direction: column !important;
        z-index: 70;
        background-color: var(--bg-color);
    }
  /* Quando a nota est√° aberta, mostramos o painel */
    body.mobile-view-editor #right-panel {
        display: flex !important;
    }

    /* 3. √Årea do Editor (O Motor de Scroll) */
    /* √â AQUI e S√ì AQUI que o scroll acontece */
    #editor-area {
        display: none;
        flex-direction: column;
        width: 100% !important;
        height: 100% !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
          overflow-anchor: none !important;
    }

    /* 4. Barra de Ferramentas (STICKY) */
    /* Sticky dentro de um contentor fixo √© muito mais est√°vel que Fixed */
    #toolbar-container {
        position: -webkit-sticky !important; /* Safari */
        position: sticky !important;         /* Android/Modern */
        top: 0 !important;                   /* Cola no teto do #editor-area */
        z-index: 9999 !important;            /* Acima de tudo */
        
        width: 100% !important;
        background-color: var(--panel-color) !important;
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        
        /* Truques para evitar piscar */
        transform: translateZ(0);
        margin: 0 !important;
    }

    /* 5. Ajuste do T√≠tulo */
    /* Como usamos Sticky, a barra ocupa espa√ßo f√≠sico. N√£o precisamos de margem gigante */
    #note-title-input {
        display: block !important;
        margin-top: 20px !important; 
        margin-left: 15px !important;
        width: calc(100% - 30px) !important;
        position: relative;
        z-index: 1;
    }

    /* 6. Conte√∫do da Nota (Padding Gigante para o Teclado) */
    #note-content-editor {
        display: block !important;
        overflow: visible !important; /* O scroll √© gerido pelo pai (#editor-area) */
        height: auto !important;
        
        /* Espa√ßo enorme no fundo para conseguir fazer scroll 
           e ver o texto mesmo com o teclado aberto */
        padding: 10px 15px 400px 15px !important; 
    }
}

@media (max-width: 768px) {
    /* 1. Mostra a barra de voltar apenas no mobile */
    #archive-mobile-nav {
        display: flex !important;
    }

    /* 2. Remove o espa√ßo excessivo acima do t√≠tulo */
    #archive-area > div[style*="padding: 20px"] {
        padding-top: 10px !important;
    }

    /* 3. For√ßa o conte√∫do a colar ao topo (elimina o buraco negro) */
    #right-panel, #archive-area {
        justify-content: flex-start !important;
    }
}

/* ============================================================
   CORRE√á√ÉO FINAL DE ESPA√áAMENTO NO TOPO (MOBILE)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßa o painel da direita a alinhar tudo ao TOPO */
    #right-panel {
        display: block !important; /* Remove o Flexbox que centra as coisas */
        padding-top: 0 !important;
        justify-content: flex-start !important;
    }

    /* 2. Garante que o Arquivo ocupa a altura toda e cola ao topo */
    #archive-area {
        display: none;
        flex-direction: column !important;
        height: 100vh !important;
        justify-content: flex-start !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* 3. Se tiver a barra de navega√ß√£o que cri√°mos antes, garante que ela n√£o tem margem */
    #archive-mobile-nav {
        flex-shrink: 0; /* Impede que encolha */
        margin-top: 0 !important;
    }
    
    /* 4. Remove padding extra do t√≠tulo do arquivo */
    #archive-area > div:nth-child(2) { /* Seleciona a div do input de t√≠tulo */
        padding-top: 10px !important;
    }
}

/* ============================================================
   CORRE√á√ÉO FINAL DE ALINHAMENTO VERTICAL (MOBILE)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar o contentor principal a alinhar ao TOPO */
    #right-panel {
        display: block !important;       /* Desliga o Flexbox centrado */
        padding-top: 0 !important;       /* Remove padding do topo */
        justify-content: flex-start !important; /* Se ficar flex, cola ao topo */
        overflow-y: auto !important;     /* Permite scroll se necess√°rio */
    }

    /* 2. Garantir que o Arquivo ocupa o espa√ßo e n√£o tem margens estranhas */
    #archive-area {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;         /* Altura autom√°tica para n√£o esticar */
        min-height: 100vh !important;    /* M√≠nimo ecra todo */
        justify-content: flex-start !important; /* Cola conte√∫dos ao topo */
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* 3. Se tiver a barra de navega√ß√£o "Voltar", cola-a ao teto */
    #archive-mobile-nav {
        margin-top: 0 !important;
        flex-shrink: 0;
    }
}

/* ============================================================
   CORRE√á√ÉO DO √çCONE SOBREPOSTO (LIVRO)
   ============================================================ */
@media (max-width: 768px) {
    /* Quando o modo de edi√ß√£o/arquivo est√° ativo,
       DESTR√ìI o placeholder (livro) completamente */
    body.mobile-view-editor #editor-placeholder {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
    }
}

/* Contentor da linha da refer√™ncia */
.reference-item {
    border-bottom: 1px solid var(--border-color);
    padding: 5px 0;
    transition: background 0.2s;
}

.reference-item summary {
    list-style: none;
    padding: 8px 10px;
    cursor: pointer;
}

/* Esconde a seta padr√£o do summary */
.reference-item summary::-webkit-details-marker { display: none; }

/* Alinhamento da linha: [+] [T√≠tulo] [Seta] */
.ref-item-header {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.ref-item-title {
    flex-grow: 1;
    font-size: 0.95em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-color);
}

/* O bot√£o "+" mais discreto */
.add-to-puzzle-btn {
    background: var(--hover-color);
    border: 1px solid var(--border-color);
    color: var(--accent-color);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    flex-shrink: 0;
    transition: all 0.2s;
}

.add-to-puzzle-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* O "Contexto" (Snippets) agora sem caixas azuis, apenas texto discreto */
.reference-context {
    padding: 0 10px 10px 44px; /* Alinhado com o texto acima */
    font-size: 0.85em;
    color: var(--text-muted-color);
    line-height: 1.4;
}

/* Remove qualquer background azul ou borda que tenhas nos snippets anteriores */
.reference-context p, .reference-context mark {
    background: transparent;
    border: none;
}

.reference-context mark {
    color: var(--accent-color);
    font-weight: bold;
    text-decoration: underline;
}

/* ============================================================
   PAINEL DE REFER√äNCIAS MOBILE (CORRE√á√ÉO DE HIERARQUIA)
   ============================================================ */
@media (max-width: 768px) {
    /* 1. O PAINEL FICA NUM N√çVEL ALTO */
    #references-panel, 
    .notebook-container.references-panel-visible #references-panel {
        display: flex !important;
        position: fixed !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        min-width: 100vw !important;
        max-width: 100vw !important;
        flex: none !important; 
        height: 60vh; 
        
        /* Valor alto, mas menor que o dos modais */
        z-index: 10000 !important; 
        
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        border-top: 1px solid var(--border-color) !important;
        border-radius: 15px 15px 0 0 !important;
        max-height: calc(100dvh - env(safe-area-inset-top, 20px)) !important;
        background-color: var(--sidebar-color) !important;
        box-shadow: 0 -10px 50px rgba(0,0,0,0.9) !important;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s ease !important;
        transform: translateY(100%) !important; 
        visibility: visible !important;
        touch-action: none; 
    }

    /* 2. OS MODAIS (EDICAO, CONFIGS, ETC) FICAM NO TOPO ABSOLUTO */
    .modal-overlay {
        z-index: 20000 !important; /* Dobro do valor do painel */
    }

    /* ESTADO ATIVO DO PAINEL */
    .notebook-container.references-panel-visible #references-panel {
        transform: translateY(0) !important;
    }

    #references-panel.is-dragging {
        transition: none !important;
    }

    /* AJUSTES DE CONTE√öDO */
    #references-panel .panel-content,
    #ref-content-puzzle,
    #ref-content-references {
        padding: 0 15px 30px 15px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        overflow-y: auto !important;
        touch-action: pan-y; 
    }

    #references-panel .panel-header {
        padding: 25px 20px 10px 20px !important;
        cursor: grab;
        touch-action: none;
    }

    #references-panel::before {
        content: '';
        width: 60px;
        height: 6px;
        background: var(--border-color);
        border-radius: 10px;
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
    }

    /* IMPEDE QUE A NOTA AO FUNDO SE MOVA ENQUANTO O PAINEL EST√Å ABERTO */
    body.mobile-view-editor.references-panel-visible {
        overflow: hidden !important;
    }
}

/* Outros ajustes Mobile */
@media (max-width: 768px) {
    .entity-link, .tag, a[data-anexo-id] { position: relative; display: inline-block; padding: 4px 0; touch-action: manipulation; }
    #note-content-editor, .post-editor-content { -webkit-tap-highlight-color: transparent; }
}

#settings-modal .modal-content.settings-expanded { max-width: 550px; width: 94%; max-height: 85vh; display: flex; flex-direction: column; padding: 20px; }
.modal-scroll-area { overflow-y: auto; flex: 1; padding-right: 10px; margin-bottom: 10px; }
#settings-modal [data-action="cancel"]:hover { color: var(--accent-color) !important; }

@media (max-width: 768px) {
    #references-panel-title { font-size: 1.1em; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
}

/* ============================================================
   DESIGN MODERNO DA GRELHA B√çBLICA
   ============================================================ */
.bible-grid {
    display: grid;
    /* FR divide o espa√ßo dispon√≠vel em partes iguais. 4 colunas = 25% cada. */
    grid-template-columns: repeat(4, 1fr); 
    gap: 8px; /* Espa√ßo fixo entre bot√µes */
    padding: 10px;
    width: 100%;
    box-sizing: border-box; /* Garante que o padding n√£o aumenta a largura */
}

.bible-grid-btn {
    /* Mant√©m o bot√£o quadrado independentemente da largura */
    aspect-ratio: 1 / 1; 
    display: flex;
    align-items: center;
    justify-content: center;
    
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    
    color: var(--text-color);
    /* Fonte ajustada para bot√µes de ~50px */
    font-size: 1.1rem; 
    font-weight: 700;
    
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Estilo de SELE√á√ÉO (Hover / Rato por cima) */
.bible-grid-btn:hover {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important;
    transform: translateY(-2px); /* Salta para cima */
    box-shadow: 0 4px 8px rgba(74, 144, 226, 0.4);
    z-index: 2;
}

/* Feedback ao carregar (Telem√≥vel) */
.bible-grid-btn:active {
    transform: scale(0.9);
}

/* Estilo para Vers√≠culo que J√Å EXISTE (VERDE) */
.bible-grid-btn.exists {
    background-color: rgba(46, 204, 113, 0.1);
    border: 1px solid #2ecc71;
    color: #2ecc71;
}

.bible-grid-btn.exists:hover {
    background-color: #2ecc71 !important;
    color: white !important;
}

/* Ajuste de scrollbar para a lista do meio n√£o bater nos bot√µes */
#file-list {
    padding-right: 5px;
    overflow-x: hidden;
}

/* Estilo Amarelo para o bot√£o Adicionar em Listas */
#add-item-btn.yellow-mode {
    border-color: #f1c40f !important;
    color: #f1c40f !important;
}

#add-item-btn.yellow-mode:hover {
    background-color: #f1c40f !important;
    color: white !important;
}

/* Estilos para o Layout do Codex */
.codex-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: flex-end;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid var(--accent-color);
    position: relative;
}

.codex-field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.codex-field-group label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-muted-color);
}

.codex-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 13px;
}

.multi-input-container {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-add-small {
    background: var(--hover-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.btn-toggle-codex {
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}

.btn-toggle-codex.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.remove-codex-row {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e74c3c;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    border: none;
}


.codex-row {
    background: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: border-color 0.2s;
}

.codex-row:hover {
    border-color: var(--accent-color);
}

/* Header da Linha (Serie + A/M + Lixo) */
.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.serie-wrapper { flex: 1; position: relative; }

.codex-label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted-color);
    margin-bottom: 6px;
    letter-spacing: 0.5px;
}

/* Inputs elegantes */
.codex-input-modern {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    outline: none;
    transition: all 0.2s;
}

.codex-input-modern:focus {
    border-color: var(--accent-color);
    background: var(--sidebar-color);
}

/* Bot√µes A e M */
.btn-control-small {
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    width: 34px;
    height: 34px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-control-small.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Bot√£o Lixo */
.btn-delete-row {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
    transition: color 0.2s;
}
.btn-delete-row:hover { color: #e74c3c; }

/* Grid de Baixo (P√°ginas e Par√°grafos) */
.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

/* Estilo das Unidades (Chips/P√≠lulas) */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-right: 6px;
    margin-bottom: 6px;
    overflow: hidden;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: var(--text-color);
    width: 40px;
    padding: 6px 4px 6px 8px;
    font-size: 13px;
    outline: none;
    text-align: center;
}

.btn-unit-del {
    background: rgba(231, 76, 60, 0.1);
    border: none;
    color: #e74c3c;
    padding: 0 8px;
    cursor: pointer;
    height: 28px;
    font-size: 12px;
}
.btn-unit-del:hover { background: #e74c3c; color: white; }

/* Bot√£o Adicionar Unidade (+) */
.btn-unit-add {
    background: var(--bg-color);
    border: 1px dashed var(--border-color);
    color: var(--accent-color);
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.btn-unit-add:hover { background: var(--accent-color); color: white; border-style: solid; }

.manual-inputs-area { display: flex; flex-wrap: wrap; /* Permite quebrar linha se n√£o houver espa√ßo */ gap: 8px; margin-bottom: 10px; margin-top: 10px; }

.manual-field-group {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid var(--border-color);
    padding: 5px 10px;
    border-radius: 6px;
    gap: 5px;
}

/* Inputs dentro das p√≠lulas manuais */
.codex-input-manual {
    background: transparent !important;
    border: none !important;
    color: var(--text-color) !important;
    font-size: 13px;
    padding: 0 !important;
    outline: none;
}

.btn-close-manual {
    background: none !important;
    border: none !important;
    color: #e74c3c !important;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    margin-left: 5px;
    display: flex;
    align-items: center;
}

.btn-close-manual:hover {
    color: #ff4d4d !important;
}

/* Garante que o modal de confirma√ß√£o fique sempre no topo absoluto */
#confirm-modal {
    z-index: 5000 !important;
}

/* O Link Modal (Gest√£o) fica numa camada alta */
#link-modal {
    z-index: 2000 !important;
}

/* O Confirm Modal (Eliminar) fica na camada m√°xima */
#confirm-modal {
    z-index: 10000000 !important;
}

/* Garante que o fundo escuro do confirm tamb√©m fique √† frente */
#confirm-modal, 
#confirm-modal.modal-overlay {
    z-index: 10000000 !important;
}

/* For√ßa a caixa de texto da confirma√ß√£o a acompanhar a camada */
#confirm-modal .modal-content {
    z-index: 10000001 !important;
}

/* Estilo espec√≠fico para as abas da 4¬™ Coluna */
#ref-tabs {
    border-bottom: 1px solid var(--border-color);
    gap: 15px;
    justify-content: flex-start;
    padding-left: 10px;
}

#ref-tabs button {
    background: none !important; /* Remove o fundo azul antigo */
    border-radius: 0;
    position: relative;
    padding: 10px 5px;
    flex-grow: 0; /* N√£o estica os bot√µes */
    color: var(--text-muted-color);
}

#ref-tabs button.active {
    color: var(--text-color) !important;
}

/* A linha azul ACIMA ou ABAIXO (como pediu 'acima', vou colocar no topo) */
#ref-tabs button.active::after {
    content: '';
    position: absolute;
    top: 0; /* Coloca a linha no topo do bot√£o */
    left: 0;
    width: 100%;
    height: 3px;
    background-color: var(--accent-color);
    border-radius: 0 0 2px 2px;
}

/* Cores para os bot√µes de a√ß√£o do painel lateral */
.btn-brown { background-color: #795548 !important; }
.btn-brown:hover { background-color: #5d4037 !important; }

.btn-orange-dark { background-color: #d35400 !important; }
.btn-orange-dark:hover { background-color: #a04000 !important; }

/* Classe base para garantir que o tamanho e fonte s√£o iguais aos do Puzzle */
.panel-action-btn-styled {
    border: none;
    color: white;
    border-radius: 4px;
    padding: 0 12px;
    height: 30px;
    cursor: pointer;
    font-weight: bold;
    font-size: 13px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

/* Estilo para o vers√≠culo que est√° aberto na 4¬™ coluna */
.bible-grid-btn.active-verse {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: white !important;
    transform: scale(1.1);
    z-index: 5;
    box-shadow: 0 0 12px rgba(74, 144, 226, 0.5);
}

/* Estilo dos Cards das Micas */
.mica-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    position: relative;
    transition: transform 0.2s;
    cursor: pointer;
}

.mica-card:hover { border-color: var(--accent-color); }

.mica-card.active-view {
    cursor: default;
    border-color: var(--accent-color);
    background-color: rgba(255,255,255,0.02);
}

/* Popup de Cores das Micas */
#mica-color-popup {
    display: none;
    position: fixed; /* Mudado de absolute para fixed para ignorar scroll do pai */
    z-index: 30000 !important; /* Muito acima dos 10000 da 4¬™ coluna */
    background: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    padding: 12px;
    border-radius: 12px;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    /* Garante que n√£o saia da tela no mobile */
    max-width: 160px;
}

.mica-color-dot {
    width: 35px; /* Ligeiramente maior para facilitar o toque */
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid rgba(255,255,255,0.1);
    transition: transform 0.1s;
}

.mica-color-dot:active {
    transform: scale(0.9);
}

/* Estilo Unificado para os bot√µes Editar das abas da 4¬™ Coluna */
.ref-panel-edit-btn {
    background: none !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-muted-color) !important;
    border-radius: 4px;
    padding: 4px 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
    height: 28px; /* Altura fixa para alinhar com o t√≠tulo */
    display: flex;
    align-items: center;
    justify-content: center;
}

.ref-panel-edit-btn:hover {
    background-color: var(--hover-color) !important;
    color: var(--text-color) !important;
}

/* Design azul quando est√° em modo "Salvar" */
.ref-panel-edit-btn.is-active {
    color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1) !important;
}

/* Classe unificada para os bot√µes Editar da 4¬™ coluna */
.btn-editar-custom {
    background: none !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-muted-color) !important;
    border-radius: 4px !important;
    padding: 4px 10px !important;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
}

.btn-editar-custom:hover {
    background-color: var(--hover-color) !important;
    color: var(--text-color) !important;
}

/* Estado quando est√° em modo "Salvar" (Azul) */
.btn-editar-custom.is-active {
    color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1) !important;
}




/* Estado visual do card sendo arrastado */
.board-card.dragging-mica {
    opacity: 0.4;
    border: 1px dashed var(--accent-color);
}

/* Estilo para o conte√∫do oculto da B√≠blia no Dossi√© */
.bible-collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.2s, margin-top 0.3s;
    opacity: 0;
    font-size: 0.92em;
    color: var(--text-color);
    padding-left: 8px;
    line-height: 1.5;
    font-style: italic;
    opacity: 0.9;
}

/* Quando o card est√° expandido */
.board-card.bible-open .bible-collapsible-content {
    max-height: 1000px; /* Valor alto para permitir qualquer tamanho de texto */
    opacity: 1;
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding-top: 10px;
}

/* Cursor e Seta no T√≠tulo da B√≠blia */
.bible-clickable-area {
    cursor: pointer;
}

.bible-clickable-area .ref-title-text::after {
    content: ' ‚ñæ';
    font-size: 0.8em;
    opacity: 0.5;
    display: inline-block;
    transition: transform 0.3s;
}

.board-card.bible-open .ref-title-text::after {
    transform: rotate(180deg);
}

/* Bot√µes de navega√ß√£o subir/descer no Dossi√© */
.mica-nav-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 4px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mica-nav-btn:hover {
    background-color: var(--hover-color);
    color: var(--accent-color);
    border-color: var(--border-color);
}

/* Garante que o texto dos cards seja selecion√°vel para c√≥pia */
.board-card.type-ref {
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: default !important;
}

/* Ajuste na √°rea clic√°vel da b√≠blia para n√£o interferir na sele√ß√£o */
.bible-clickable-area {
    user-select: text;
}

.mica-card {
    transition: transform 0.1s, background-color 0.2s;
    /* Impede que o texto seja selecionado enquanto tentas clicar r√°pido */
    user-select: none; 
}

.mica-card:active {
    transform: scale(0.98); /* Efeito de "apertar" o bot√£o ao clicar */
    background-color: var(--hover-color);
}

.bible-card-mica {
    border-left: 4px solid #5d4037 !important; /* Castanho em vez de Roxo */
    padding-left: 10px;
}

/* Estilo para o Modo Pins (Rosa) */
.folder-mode-item.active.mode-pins {
    color: #ff69b4 !important; /* Hot Pink */
}

.folder-mode-item.active.mode-pins::after {
    background-color: #ff69b4 !important;
    height: 3px;
}

/* √çcone de Pin na lista */
.list-item[data-pinned="true"]::after {
    content: 'üìå';
    font-size: 14px;            /* Tamanho do pin */
    position: absolute;
    left: 18px;                 /* Ajusta horizontalmente sobre o √≠cone */
    top: 8px;                   /* Ajusta verticalmente (sobe um pouco) */
    z-index: 10;                /* Garante que fica por cima do √≠cone */
    pointer-events: none;       /* O clique passa atrav√©s do pin para a pasta */
    
    /* Efeito de sombra para o pin destacar-se do √≠cone amarelo */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.6); 
    
    /* Leve inclina√ß√£o para parecer espetado na pasta */
    transform: rotate(-10deg); 
}

/* Garante que o √≠cone original n√£o seja empurrado */
.list-item {
    position: relative; 
}

/* Linha divis√≥ria dentro do menu de contexto */
.menu-sep {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 4px 5px;
    opacity: 0.4;
}

/* Ajuste da Grelha de Emojis do Cosmos */
#cosmos-emoji-grid {
    display: grid;
    /* auto-fill: preenche o espa√ßo dispon√≠vel / minmax: tamanho m√≠nimo de 45px por bot√£o */
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
    gap: 10px;
    width: 100%;
    max-width: 100%; /* Impede que a grelha saia para fora */
    box-sizing: border-box;
    margin-bottom: 20px;
    padding: 5px;
}

/* Ajuste dos bot√µes de Emoji */
.emoji-btn {
    aspect-ratio: 1 / 1; /* Mant√©m o bot√£o sempre quadrado */
    width: 100%;       /* Ocupa a largura da coluna da grelha */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    padding: 0;
}

/* Feedback visual de selecionado */
.emoji-btn.selected {
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1);
    box-shadow: 0 0 5px var(--accent-color);
}

/* No mobile, o modal em si deve ter um limite de largura */
@media (max-width: 480px) {
    #cosmos-modal .modal-content {
        width: 90%;
        max-width: 320px;
        padding: 20px;
    }
    
    .emoji-btn {
        font-size: 18px; /* Reduz ligeiramente o emoji no telem√≥vel */
    }
}


/* Toggle de Escopo de Pesquisa */
#search-scope-container {
    display: none; /* Escondido por padr√£o, aparece via JS */
    align-items: center;
    gap: 8px;
    background: var(--panel-color);
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    margin-right: 10px;
}

.scope-label {
    font-size: 11px;
    font-weight: bold;
    color: var(--text-muted-color);
    text-transform: uppercase;
}

.scope-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
}

.scope-switch input { opacity: 0; width: 0; height: 0; }

.scope-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--sidebar-color);
    transition: .4s;
    border-radius: 20px;
    border: 1px solid var(--border-color);
}

.scope-slider:before {
    position: absolute;
    content: "";
    height: 12px; width: 12px;
    left: 2px; bottom: 2px;
    background-color: var(--text-muted-color);
    transition: .4s;
    border-radius: 50%;
}

input:checked + .scope-slider { background-color: var(--accent-color); }
input:checked + .scope-slider:before { transform: translateX(16px); background-color: white; }

/* Bot√£o de Escopo de Pesquisa (Quadrado como o Filtros) */
#search-scope-btn {
    display: none; /* Escondido por padr√£o */
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    margin-left: 10px; /* Espa√ßo √† direita do Filtros */
    white-space: nowrap;
    align-items: center;
    gap: 8px;
}

#search-scope-btn:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Estado Ativo (Na P√°gina) */
#search-scope-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}


/* Bot√£o X no canto superior direito */
.corner-close-btn {
    position: absolute;
    top: 5px;
    right: 8px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-muted-color);
    opacity: 0.5;
    transition: opacity 0.2s, color 0.2s;
    background: none;
    border: none;
    padding: 2px;
    z-index: 5;
}
.corner-close-btn:hover {
    opacity: 1;
    color: #e74c3c;
}

/* Estilo da Gaveta (Pasta) dentro do Gavet√£o */
.gaveta-folder {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px 15px;
    margin: 5px 0 5px 20px; /* Recuo para parecer interno */
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
}
.gaveta-folder:hover {
    background-color: var(--hover-color);
}

.gaveta-title-area {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-color);
    font-weight: 500;
}

/* Header da Gaveta Aberta */
.opened-gaveta-header {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: var(--panel-color);
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid var(--accent-color);
}


/* Garante que o fundo do modal seja vis√≠vel e cubra tudo */
#create-gaveta-modal.modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.85) !important; /* Fundo escuro */
    display: none; /* Controlado pelo JS */
    align-items: center !important;
    justify-content: center !important;
    z-index: 9999999 !important;
}

/* Garante que a caixa branca/escura apare√ßa no meio */
#create-gaveta-modal .modal-content {
    background-color: var(--sidebar-color) !important;
    border: 1px solid var(--accent-color) !important;
    padding: 30px !important;
    border-radius: 12px !important;
    width: 90% !important;
    max-width: 400px !important;
    box-shadow: 0 10px 50px rgba(0,0,0,1) !important;
    color: white !important;
}

#drawer-selection-modal.modal-overlay {
    z-index: 30000 !important;
}

/* Quando o post est√° em modo lista (t√≠tulos apenas) */
.archive-post {
    transition: all 0.2s ease;
}

.archive-post:hover {
    background-color: var(--hover-color);
}

/* Cabe√ßalho do Gavet√£o no Modal */
.modal-gavetao-header {
    background-color: rgba(74, 144, 226, 0.1);
    color: var(--accent-color);
    padding: 8px 12px;
    border-radius: 6px 6px 0 0;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 15px;
    border-left: 4px solid var(--accent-color);
}

/* Container que agrupa as gavetas de um gavet√£o */
.modal-gavetas-group {
    background-color: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 6px 6px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Ajuste do item da gaveta para parecer interno */
.list-item.gaveta-interna {
    margin: 0 !important;
    padding: 10px 15px !important;
    background-color: var(--panel-color);
    border: 1px solid transparent;
}

.list-item.gaveta-interna:hover {
    border-color: var(--accent-color);
}

/* Esconder o bot√£o em ecr√£s pequenos (Mobile) */
@media (max-width: 768px) {
    .pc-only { display: none !important; }
}

/* Regras para o Modo Criativo Ativo */
.notebook-container.creative-mode-active #left-panel,
.notebook-container.creative-mode-active #middle-panel {
    display: none !important;
}

/* Estilo para o bot√£o ü™Å quando est√° ativo no menu */
button[data-action="creative-mode"].active {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important;
}

.archive-separator {
    background-color: rgba(46, 204, 113, 0.05); /* Fundo verde muito subtil */
    border: 1px dashed #2ecc71;
    border-left: 5px solid #2ecc71; /* Barra lateral s√≥lida verde */
    border-radius: 8px;
    padding: 10px 15px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 50px;
    position: relative;
}

.separator-title {
    font-weight: bold;
    color: #27ae60; /* Verde escuro para leitura */
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Cor vermelha para o toggle de colabora√ß√£o quando ativo */
#collab-share-toggle:checked + .slider {
    background-color: #e74c3c !important;
}

/* Opcional: Efeito visual para a bolinha branca quando est√° em modo vermelho */
#collab-share-toggle:checked + .slider:before {
    box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}

/* ============================================================
   ESTILO DO ESCUDO DE CARREGAMENTO (APP LOADER)
   ============================================================ */
#app-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: #1a1a1d; /* Mesma cor do seu --bg-color */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999999; /* Fica por cima de absolutamente tudo */
    transition: opacity 0.5s ease, visibility 0.5s;
}

.loader-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.loader-circle {
    width: 60px;
    height: 60px;
    border: 3px solid rgba(74, 144, 226, 0.1);
    border-top: 3px solid #4a90e2; /* Cor --accent-color */
    border-radius: 50%;
    animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

.loader-logo {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    font-size: 32px;
}

.logo-text {
    font-size: 24px;
    font-weight: bold;
    color: #f0f0f0;
    letter-spacing: 1px;
}

.loader-status {
    color: #888;
    font-size: 0.9em;
    font-style: italic;
    animation: pulse 1.5s infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Classe para esconder com suavidade */
#app-loader.fade-out {
    opacity: 0;
    visibility: hidden;
}


.notebook-container { 
    display: none !important; /* Adiciona isto: O site nasce escondido */
    height: 100vh; 
    width: 100vw; 
}



/* Garante que o visualizador de links fique acima da 4¬™ coluna (que tem 10000 no mobile) */
#view-link-modal.modal-overlay {
    z-index: 30000 !important;
}

#view-link-modal .modal-content {
    z-index: 30001 !important;
}

/* Ajuste para os itens da lista dentro do modal serem mais f√°ceis de clicar no telem√≥vel */
#view-link-urls-list li {
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}

#view-link-urls-list li:active {
    background-color: rgba(74, 144, 226, 0.2) !important;
}

#link-modal.modal-overlay {
    z-index: 30000 !important;
}


/* Remove o sublinhado vermelho de erro ortogr√°fico nos links do quadro */
.board-link, .board-text-content {
    spellcheck: false;
    -webkit-spellcheck: false;
}

/* Garante que o clique passe para o JS mesmo com o aviso de erro */
.board-link {
    pointer-events: auto !important;
}


/* ============================================================
   AJUSTE DO POPUP MUDAR ICON (SUPERPASTA)
   ============================================================ */

/* 1. Torna o conte√∫do do modal scrol√°vel e limita a altura */
#icon-picker-modal .modal-content {
    max-height: 80vh; /* Altura m√°xima de 80% do ecr√£ */
    overflow-y: auto; /* Ativa scroll vertical */
    padding: 20px;
    width: 90%;
    max-width: 380px;
    scrollbar-width: thin;
}

/* 2. Reduz drasticamente a zona do bot√£o "Padr√£o" */
#icon-picker-modal .emoji-btn[data-icon="üóÉÔ∏è"] {
    grid-column: span 4 !important; /* Continua a ocupar a largura toda */
    height: 50px !important;        /* Mas com altura reduzida */
    font-size: 16px !important;     /* Texto menor */
    display: flex !important;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;            /* Espa√ßo para os √≠cones de baixo */
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
}

/* 3. Garante que a grelha de emojis em baixo est√° correta */
#emoji-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding-bottom: 10px;
}

/* 4. Estilo individual dos bot√µes de emoji (mais compactos) */
#emoji-grid .emoji-btn {
    height: 60px; /* Altura fixa para os quadrados */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border-radius: 10px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s;
}

#emoji-grid .emoji-btn:hover {
    border-color: var(--accent-color);
    background-color: var(--hover-color);
    transform: scale(1.05);
}

/* Customiza√ß√£o da scrollbar para este modal */
#icon-picker-modal .modal-content::-webkit-scrollbar {
    width: 6px;
}
#icon-picker-modal .modal-content::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

/* Notifica√ß√£o na Lista Lateral */
.notif-badge {
    background-color: #e74c3c;
    color: white;
    font-size: 10px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
    position: absolute;
    right: 35px; /* Ajustado para n√£o bater no bot√£o de menu */
    top: 50%;
    transform: translateY(-50%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}


/* Ponto de Estado (Canto Superior Esquerdo) */
.post-status-dot {
    width: 12px !important;
    height: 12px !important;
    border-radius: 50% !important;
    position: absolute !important;
    
    /* Posi√ß√£o ajustada para o canto superior esquerdo do cart√£o */
    top: 12px !important;  
    left: 8px !important;
    
    z-index: 20 !important;
    box-shadow: 0 0 4px rgba(0,0,0,0.5) !important;
    border: 2px solid var(--panel-color) !important; /* Borda da cor do fundo para "recortar" */
    transition: opacity 0.6s ease, transform 0.6s ease;
}

.post-status-dot.dot-vanish {
    opacity: 0 !important;
    transform: scale(0) !important;
}

/* O QUE FALTAVA: As cores */
.dot-new {
    background-color: #e74c3c !important; /* Vermelho (Novo) */
    animation: pulse-dot 2s infinite;
}

.dot-edited {
    background-color: #f1c40f !important; /* Amarelo (Editado) */
}

/* Anima√ß√£o opcional para chamar a aten√ß√£o */
@keyframes pulse-dot {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 4px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

/* Indicador de menu no bot√£o B Azul */
/* Bot√£o B Azul com Pontos de Menu */
button[data-command="boldBlue"] {
    position: relative; 
}

button[data-command="boldBlue"]::after {
    display: none !important;
    content: '‚Ä¢‚Ä¢';
    position: absolute;
    top: -2px;       /* Ajuste fino para ficar bem no canto */
    right: 2px;
    font-size: 10px;
    line-height: 1;
    color: var(--text-muted-color);
    /* Removemos pointer-events: none para permitir detetar que o rato est√° ali */
    cursor: context-menu; /* Muda o cursor para indicar que √© um menu */
}

button[data-command="boldBlue"]:hover::after {
    color: white; /* Destaca os pontos ao passar o rato */
}

/* Novo Popup de Cores de Negrito */
#bold-palette-popup {
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    padding: 8px;
    display: none;
    position: absolute;
    z-index: 3000;
    width: auto;
}

/* Estilo para os dois pontos clic√°veis */
.dots-trigger {
    position: absolute;
    top: 0;
    right: 0;
    width: 15px;       /* √Årea de clique mais larga */
    height: 100%;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 2px;
    border-radius: 0 4px 4px 0;
    transition: background 0.2s, color 0.2s;
    pointer-events: auto; /* Garante que o span recebe o clique */
    z-index: 10;          /* Garante que est√° acima do bot√£o */
}

.dots-trigger:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: var(--text-color);
}


/* Quando o popup est√° em modo Jornal, ajustamos a largura e layout */
#formatting-popup.journal-mode {
    width: 240px !important; /* Mais largo para caberem os √≠cones */
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 5px !important;
}

/* Container para os √≠cones do Jornal dentro do popup */
#journal-tools-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color); /* A divis√£o visual leve */
    margin-bottom: 5px;
}

/* Garante que os bot√µes dentro do container novo mant√™m o estilo */
#journal-tools-container button {
    width: 32px !important;
    height: 32px !important;
    font-size: 16px !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* O container original dos bot√µes (ü§ñ üî¨ ü™Å) */
#formatting-popup .default-tools-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
}

/* --- WIDGET DE IMAGEM DO JORNAL --- */

/* Contentor Principal */
.journal-img-wrapper {
    position: relative;
    display: inline-block; /* Permite texto ao lado ou bloco */
    margin: 10px 0;
    max-width: 100%;
    transition: all 0.2s;
    user-select: none;
}

/* A Imagem em si */
.journal-img-wrapper img {
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    object-fit: cover;
    display: block;
    border: 2px solid transparent;
}

/* Estado de Edi√ß√£o (Input de URL) */
.journal-img-placeholder {
    display: flex;
    gap: 5px;
    background: var(--panel-color);
    padding: 10px;
    border: 1px dashed var(--accent-color);
    border-radius: 8px;
    align-items: center;
    width: 100%;
    max-width: 400px;
}

.journal-img-placeholder input {
    flex-grow: 1;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 5px 10px;
    border-radius: 4px;
}

/* Bot√£o de Editar (Canto Superior Direito) */
.journal-img-edit-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    display: none; /* S√≥ aparece no hover */
    z-index: 10;
}

.journal-img-wrapper:hover .journal-img-edit-btn {
    display: block;
}

/* Menu de Op√ß√µes de Edi√ß√£o */
.journal-img-menu {
    position: absolute;
    top: 35px;
    right: 5px;
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 5px;
    display: none; /* Controlado via JS */
    flex-direction: column;
    gap: 5px;
    z-index: 20;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    min-width: 120px;
}

.journal-img-menu.visible { display: flex; }

.journal-img-menu button {
    background: none;
    border: none;
    color: var(--text-color);
    text-align: left;
    padding: 5px;
    cursor: pointer;
    font-size: 12px;
}
.journal-img-menu button:hover { background-color: var(--hover-color); }

/* Dimens√µes */
.img-size-sm img { max-width: 150px; max-height: 150px; }
.img-size-md img { max-width: 300px; max-height: 300px; }
.img-size-lg img { max-width: 500px; max-height: 500px; }
.img-size-xl img { max-width: 100%; height: auto; }



/* --- WIDGET CUBO (CAIXA DE TEXTO FLUTUANTE) --- */

.journal-cube-wrapper {
    background-color: rgba(74, 144, 226, 0.1); /* Fundo Azul Claro */
    border: 1px solid #4a90e2;               /* Borda Azul */
    border-radius: 8px;
    padding: 0;
    margin: 10px;
    width: 100%;
    box-sizing: border-box;
    transition: all 0.2s ease;
    position: relative;
    min-width: 200px;
}

/* --- MODOS DE ALINHAMENTO --- */
.journal-cube-wrapper.float-left {
    float: left;
    width: 45%;
    margin-right: 15px;
}

.journal-cube-wrapper.float-right {
    float: right;
    width: 45%;
    margin-left: 15px;
}

/* Toolbar do Cubo */
.cube-toolbar {
    display: none; /* Escondido por defeito */
    position: absolute;
    top: -35px;
    right: 0;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 3px;
    gap: 3px;
    z-index: 20;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    align-items: center;
}

/* Mostra a toolbar quando passa o rato */
.journal-cube-wrapper:hover .cube-toolbar {
    display: flex;
}

/* Estilo do Puxador */
.cube-drag-handle {
    cursor: grab;
    font-size: 16px;
    padding: 2px 6px;
    color: var(--accent-color);
    display: flex;
    align-items: center;
}
.cube-drag-handle:hover { background-color: var(--hover-color); }

/* √Årea de Texto Edit√°vel */
.cube-content {
    padding: 15px;
    outline: none;
    min-height: 60px;
    color: var(--text-color);
    line-height: 1.5;
}

/* Corre√ß√£o para quando se arrasta */
.journal-cube-wrapper.sortable-dragging {
    opacity: 0.5;
    border: 2px dashed var(--accent-color);
}

/* Puxador de Arrasto do Cubo */
.cube-drag-handle {
    cursor: grab;
    font-size: 16px;
    padding: 2px 6px;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    border-radius: 3px;
}

.cube-drag-handle:hover {
    background-color: var(--hover-color);
}

.cube-drag-handle:active {
    cursor: grabbing;
}

/* Quando est√° a ser arrastado */
.journal-cube-wrapper.sortable-dragging {
    opacity: 0.4;
    border: 2px dashed var(--accent-color);
    transform: scale(0.98);
}

/* Indicadores de Drop Lateral */
.drop-target-left {
    border-left: 4px solid var(--accent-color) !important;
    padding-left: 10px;
}

.drop-target-right {
    border-right: 4px solid var(--accent-color) !important;
    padding-right: 10px;
}

/* --- CAIXA DE RACIOC√çNIO (PLACA ü™ß) --- */

.journal-sign-wrapper {
    background-color: var(--sidebar-color); /* Fundo escuro/neutro */
    border: 1px solid #f1c40f;            /* Borda Amarela */
    border-radius: 8px;
    margin: 15px 0;
    padding: 0;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Toolbar (Topo) */
.sign-toolbar {
    background-color: rgba(241, 196, 15, 0.1); /* Amarelo muito suave */
    border-bottom: 1px solid #f1c40f;
    padding: 5px 10px;
    display: flex;
    align-items: center;
    color: #f1c40f;
    font-weight: bold;
    font-size: 0.9em;
}

.sign-btn-del {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.sign-btn-del:hover { opacity: 1; }

/* Cabe√ßalho (T√≠tulo) */
.sign-header {
    padding: 10px;
    border-bottom: 1px dashed var(--border-color);
}

.sign-title-input {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--text-color);
    font-size: 1.1em;
    font-weight: bold;
    outline: none;
}

/* Conte√∫do (Resposta) */
.sign-content {
    padding: 10px;
    min-height: 60px;
    color: var(--text-color);
    line-height: 1.5;
    outline: none;
}

/* √Årea de Anexos */
.sign-attachments-area {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 0 10px;
}

/* Item de Anexo (Link ou Imagem) */
.sign-attachment-item {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
    max-width: 100%;
    font-size: 0.9em;
}

.sign-attachment-item img {
    max-height: 100px;
    border-radius: 4px;
}

.sign-attachment-item a {
    color: var(--accent-color);
    text-decoration: none;
    word-break: break-all;
}

.sign-attachment-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-weight: bold;
    margin-left: 5px;
}

/* Bot√£o Adicionar (+) */
.sign-add-btn-area {
    padding: 10px;
    text-align: center;
}

.sign-add-btn {
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border: 1px dashed var(--border-color);
    color: var(--text-muted-color);
    padding: 5px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1.2em;
}

.sign-add-btn:hover {
    background: var(--hover-color);
    color: var(--text-color);
    border-color: var(--accent-color);
}

/* Placeholder para div contenteditable */
.sign-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted-color);
    opacity: 0.6;
    pointer-events: none; /* Deixa clicar atrav√©s do texto */
    font-style: italic;
}

/* Garante que o cursor aparece mesmo quando est√° vazio */
.sign-content {
    min-height: 60px;
    padding: 10px;
    color: var(--text-color);
    line-height: 1.5;
    outline: none;
    /* Corre√ß√£o para Firefox/Chrome: evita colapso total */
    display: block; 
}

/* --- NUMERA√á√ÉO AUTOM√ÅTICA DE RACIOC√çNIOS --- */

/* 1. Iniciar o contador no editor */
#note-content-editor {
    counter-reset: raciocinio-counter;
}

/* 2. Incrementar o contador em cada caixa */
.journal-sign-wrapper {
    counter-increment: raciocinio-counter;
}

/* 3. Injetar o n√∫mero no t√≠tulo (Span espec√≠fico que vamos criar) */
.sign-number-display::after {
    content: " #" counter(raciocinio-counter);
}

/* --- ESTILO DOS NOVOS BOT√ïES --- */
.sign-move-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    opacity: 0.6;
    margin: 0 2px;
    color: #f1c40f; /* Amarelo para combinar */
}
.sign-move-btn:hover { opacity: 1; background-color: rgba(0,0,0,0.1); border-radius: 3px; }


/* --- ESTILO DA LISTA DE ANEXOS (LINHAS) --- */

/* Contentor da lista */
.sign-attachments-area {
    display: flex;
    flex-direction: column; /* For√ßa lista vertical */
    gap: 0; /* Sem espa√ßo extra entre linhas, usamos border */
    padding: 0;
    margin-top: 5px;
    border-top: 1px dashed var(--border-color); /* Linha separadora do conte√∫do */
}

/* Item Individual (Linha) */
.sign-attachment-row {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    background-color: transparent;
    font-size: 0.9em;
    transition: background 0.2s;
}

.sign-attachment-row:hover {
    background-color: var(--hover-color);
}

/* Texto do Link */
.sign-link-text {
    flex-grow: 1;
    color: var(--accent-color);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 10px;
}

.sign-link-text:hover { text-decoration: underline; }

/* Bot√µes de A√ß√£o (Ir e Editar) */
.sign-row-btn {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sign-row-btn:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.sign-row-btn.delete:hover {
    background-color: #e74c3c;
    border-color: #e74c3c;
}

/* --- CART√ÉO TEM√ÅTICO (ID CARD ü™™) --- */

.journal-id-card {
    background-color: #d7ccc8; /* Cor "Bege/Terra" da tua imagem */
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
    position: relative;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border: 1px solid #a1887f;
    overflow: hidden;
}

/* Toolbar Flutuante (Setas + Lixo) */
.card-toolbar {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 2px;
    z-index: 10;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    padding: 2px;
}

.card-toolbar button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 12px;
    color: #5d4037;
    opacity: 0.6;
}
.card-toolbar button:hover { opacity: 1; font-weight: bold; }
.card-del-btn:hover { color: #e74c3c !important; }

/* Layout Flex (Imagem | Texto) */
.card-body {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

/* Coluna da Imagem */
.card-image-area {
    flex: 0 0 100px; /* Largura fixa de 100px */
    width: 100px;
    height: 120px; /* Altura fixa para manter formato retrato */
}

/* Placeholder da Imagem (Quadrado com √≠cone) */
.card-img-placeholder {
    width: 100%;
    height: 100%;
    background-color: #f5f5f5;
    border: 2px dashed #a1887f;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #8d6e63;
    transition: background 0.2s;
}

.card-img-placeholder:hover {
    background-color: #ffffff;
    border-color: var(--accent-color);
}

/* A Imagem Real (quando inserida) */
.card-real-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Coluna de Texto */
.card-text-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* T√≠tulo */
.card-title-input {
    width: 100%;
    background: rgba(0,0,0,0.05);
    border: none;
    border-radius: 4px;
    padding: 8px;
    font-size: 1.2em;
    font-weight: bold;
    color: #3e2723;
    outline: none;
}

/* Descri√ß√£o */
.card-desc-content {
    min-height: 80px;
    color: #4e342e;
    line-height: 1.4;
    outline: none;
    font-size: 0.95em;
    background: rgba(255,255,255,0.3); /* Fundo subtil para √°rea de texto */
    padding: 8px;
    border-radius: 4px;
}

/* Placeholder CSS para a descri√ß√£o */
.card-desc-content:empty:before {
    content: attr(data-placeholder);
    color: #8d6e63;
    font-style: italic;
    opacity: 0.7;
}

/* --- WIDGET DUAS COLUNAS --- */

.journal-cols-container {
    display: flex;
    gap: 15px; /* Espa√ßo entre colunas */
    margin: 15px 0;
    width: 100%;
}

.journal-col {
    flex: 1; /* Divide o espa√ßo igualmente (50%) */
    min-height: 50px;
    padding: 10px;
    border: 1px dashed var(--border-color);
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.02);
    outline: none;
}

/* No Telem√≥vel, empilha verticalmente */
@media (max-width: 768px) {
    .journal-cols-container {
        flex-direction: column;
    }
}

/* Placeholder para as Colunas */
.journal-col:empty::before {
    content: attr(data-placeholder);
    color: var(--text-muted-color);
    opacity: 0.5;
    font-style: italic;
    pointer-events: none; /* Permite clicar atrav√©s do texto */
}

/* Garante que a coluna tem altura mesmo vazia */
.journal-col {
    /* Mant√©m os teus estilos existentes e garante estes: */
    min-height: 60px; 
    display: block;
}


/* --- WRAPPER E TOOLBAR DAS COLUNAS --- */

.journal-cols-wrapper {
    position: relative;
    margin: 15px 0;
    transition: all 0.2s;
    border: 1px solid transparent; /* Para evitar saltos no hover */
}

/* Mostra uma borda suave ao passar o rato para identificar o bloco */
.journal-cols-wrapper:hover {
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    padding: 5px;
    margin: 10px -5px; /* Compensa o padding */
}

.cols-toolbar {
    position: absolute;
    /* 1. Aproxim√°mos a barra (estava -30px) */
    top: -25px; 
    right: 0;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 4px 4px 0 0; /* Cantos redondos s√≥ em cima */
    padding: 2px 8px;
    display: none; 
    z-index: 10;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    
    /* 2. Mant√©m a barra vis√≠vel se o rato estiver em cima dela */
    pointer-events: auto; 
}

/* 3. A PONTE M√ÅGICA: Cria uma √°rea invis√≠vel que liga a caixa √† barra */
.cols-toolbar::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 15px; /* Altura suficiente para preencher o espa√ßo */
    bottom: -10px; /* Estica para baixo em dire√ß√£o √† caixa */
    background: transparent; /* Invis√≠vel */
    z-index: -1;
}

/* Garante que a barra aparece no hover da caixa OU da pr√≥pria barra */
.journal-cols-wrapper:hover .cols-toolbar,
.cols-toolbar:hover {
    display: flex;
    align-items: center;
    gap: 5px;
}


/* ============================================================
   ESTILO: REDATOR (Glassmorphism & Dock)
   ============================================================ */
.redator-wrapper {
    position: relative;
    width: 100%; /* Adapta-se √† largura da nota */
    min-height: 150px;
    margin: 25px 0;
    
    /* Efeito de Vidro */
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    
    /* Bordas Finas */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    
    /* Sombra */
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.02);
    
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

.redator-wrapper:hover {
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 15px 50px -10px rgba(0,0,0,0.6), 0 0 15px rgba(255, 255, 255, 0.05);
    z-index: 10; /* Garante que a dock sobrep√µe o resto */
}

/* Cabe√ßalho */
.redator-header {
    padding: 12px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.redator-input {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.1em;
    font-weight: 500;
    width: 100%;
    outline: none;
    font-family: inherit;
}

.redator-input::placeholder {
    color: rgba(255, 255, 255, 0.2);
    font-style: italic;
}

/* Ferramentas de Topo (Discretas) */
.redator-top-tools {
    display: flex;
    gap: 10px;
    opacity: 0.3;
    transition: opacity 0.2s;
}
.redator-wrapper:hover .redator-top-tools { opacity: 1; }

.tool-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #fff;
    opacity: 0.7;
    padding: 2px;
    transition: transform 0.2s;
}
.tool-icon-btn:hover { opacity: 1; transform: scale(1.1); }

/* Conte√∫do */
.redator-content {
    padding: 20px;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.6;
    font-weight: 300;
    outline: none;
    min-height: 80px;
    white-space: pre-wrap;
}

/* --- DOCK INFERIOR (Bot√µes Especiais) --- */
.redator-dock {
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 5px;
    
    background: #1a1a1d; /* Cor do fundo do body para cortar a linha */
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 3px 6px;
    
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s;
    z-index: 20;
}

.redator-wrapper:hover .redator-dock {
    opacity: 1;
    pointer-events: auto;
    bottom: -22px;
}

.dock-btn {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.2s;
}

.dock-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

.dock-btn svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
}

.dock-sep {
    width: 1px;
    height: 16px;
    background: rgba(255, 255, 255, 0.1);
}

/* Tooltips */
.dock-btn::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    color: #000;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    border-radius: 4px;
    opacity: 0;
    pointer-events: none;
    white-space: nowrap;
    transition: opacity 0.2s;
}
.dock-btn:hover::after { opacity: 1; }

/* Contentor da Toolbar (Agora √© flex√≠vel para alinhar o bot√£o de menu √† direita) */
.redator-top-tools {
    display: flex;
    justify-content: flex-end; /* Encosta √† direita */
    align-items: center;
    position: relative; /* Necess√°rio para o menu absoluto funcionar */
    height: 30px;
}

/* O Bot√£o de Menu (Tr√™s Pontos) */
.redator-menu-trigger {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    font-size: 18px;
    cursor: pointer;
    padding: 0 5px;
    z-index: 20; /* Fica por cima do menu a deslizar */
    transition: color 0.2s;
}
.redator-menu-trigger:hover {
    color: #fff;
}

/* O Menu Deslizante (Escondido por defeito) */
.redator-slide-menu {
    position: absolute;
    top: 0;
    right: 30px; /* Come√ßa √† esquerda do bot√£o de menu */
    
    display: flex;
    gap: 5px;
    align-items: center;
    
    background: rgba(0, 0, 0, 0.6);
    border-radius: 20px; /* Forma de p√≠lula */
    padding: 4px 10px;
    
    /* Estado Inicial: Escondido e deslocado para a direita */
    opacity: 0;
    transform: translateX(20px);
    pointer-events: none; /* N√£o clic√°vel quando invis√≠vel */
    
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Estado Ativo: Vis√≠vel e na posi√ß√£o correta */
.redator-slide-menu.visible {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
}

/* Estilo dos bot√µes dentro do menu (pequenos e elegantes) */
.redator-slide-menu .tool-icon-btn {
    font-size: 14px;
    padding: 4px;
    color: rgba(255,255,255,0.8);
}
.redator-slide-menu .tool-icon-btn:hover {
    color: #fff;
    transform: scale(1.1);
}


/* --- ESTADO COLAPSADO DO CABE√áALHO --- */

/* Quando colapsado, o cabe√ßalho fica quase invis√≠vel (altura zero) */
.redator-header.collapsed {
    height: 0;
    padding: 0;
    border-bottom: none;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
}

/* O bot√£o de reabrir (pequeno √≠cone flutuante) */
.redator-reopen-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 14px;
    cursor: pointer;
    z-index: 15;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    opacity: 0;           /* Escondido por padr√£o */
    pointer-events: none; /* N√£o clic√°vel */
    transition: opacity 0.3s ease;
}

.redator-reopen-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

/* Mostra o bot√£o APENAS quando o cabe√ßalho est√° colapsado */
.redator-wrapper.header-hidden .redator-reopen-btn {
    opacity: 1;
    pointer-events: auto;
}

/* ============================================================
   JANELAS FLUTUANTES REDATOR (Multitarefa)
   ============================================================ */

/* A Janela Flutuante */
.redator-popup-window {
    position: fixed;
    top: 100px;
    left: 100px;
    width: 500px;
    height: 400px;
    
    /* Vidro Fosco Escuro */
    background: rgba(30, 30, 35, 0.95);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    border-radius: 12px;
    
    display: flex;
    flex-direction: column;
    z-index: 10000; /* Alto, mas permite sobreposi√ß√£o entre elas */
    transition: transform 0.1s, opacity 0.2s;
    resize: both; /* Permite redimensionar */
    overflow: hidden;
    min-width: 300px;
    min-height: 200px;
}

/* Cabe√ßalho de Arrasto */
.redator-popup-header {
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    cursor: grab; /* M√£ozinha */
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
}

.redator-popup-header:active {
    cursor: grabbing;
    background: rgba(255, 255, 255, 0.1);
}

.popup-title-label {
    font-size: 0.8em;
    font-weight: bold;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Bot√£o Fechar (Salvar) */
.btn-close-popup {
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 18px;
    padding: 0 5px;
}
.btn-close-popup:hover { color: #ff6b6b; }

/* Corpo da Janela */
.redator-popup-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
}

/* Ajustes nos inputs clonados dentro da janela */
.redator-popup-window .redator-input {
    padding: 15px;
    font-size: 1.2em;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.redator-popup-window .redator-content {
    flex-grow: 1;
    overflow-y: auto; /* Scroll interno */
    padding: 15px;
}

/* --- ESTADO DO REDATOR ORIGINAL (Bloqueado) --- */
.redator-wrapper.in-popup-mode {
    opacity: 0.3;
    pointer-events: none; /* Impede cliques no original */
    filter: grayscale(1);
    border: 1px dashed rgba(255,255,255,0.3);
}

/* Aviso visual sobre o original */
.redator-wrapper.in-popup-mode::after {
    content: "Aberto em Janela ‚Üó";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    background: rgba(0,0,0,0.8);
    padding: 5px 10px;
    border-radius: 4px;
}

/* ============================================================
   ESTILOS DAS ABAS DO PAINEL DO MEIO (BOTTOM TABS)
   ============================================================ */

/* Garante que o painel do meio usa todo o espa√ßo vertical corretamente */
#middle-panel {
    display: flex;
    flex-direction: column;
    padding-bottom: 0 !important; /* Remove padding do fundo para a barra colar */
    overflow: hidden; /* Impede scroll no painel principal */
}

/* Contentor das Vistas (Onde as listas aparecem) */
#middle-views-container {
    flex: 1; /* Ocupa todo o espa√ßo dispon√≠vel */
    overflow-y: auto; /* Scroll acontece AQUI */
    position: relative;
    padding-bottom: 10px;
    /* Scrollbar fina */
    scrollbar-width: thin;
}

/* Esconde scrollbar horizontal */
#middle-views-container::-webkit-scrollbar { width: 6px; }
#middle-views-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

/* Barra de Abas no Fundo */
.middle-bottom-tabs {
    display: none; /* Controlado pelo JS */
    height: 50px !important; /* Altura fixa e igual √† esquerda */
    
    background-color: var(--sidebar-color);
    border-top: 1px solid var(--border-color);
    
    /* ALTERA√á√ÉO CR√çTICA AQUI: */
    /* Margem negativa apenas nos lados (-20px), zero em baixo */
    margin: 0 -20px 0 -20px !important; 
    
    padding: 0;
    flex-shrink: 0;
    z-index: 10;
    box-sizing: border-box;
}

/* Ajuste dos bot√µes para caberem na nova altura */
.middle-bottom-tabs button {
    flex: 1;
    height: 100%;
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 0;
    font-size: 10px;
    text-transform: uppercase;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px; /* Gap menor */
    border-top: 2px solid transparent; /* Linha de topo mais fina */
}

.middle-bottom-tabs button span {
    font-size: 16px;
    font-family: 'Material Icons', sans-serif; /* Se usar icons de fonte */
}

.middle-bottom-tabs button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.middle-bottom-tabs button.active {
    color: var(--accent-color);
    border-top-color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.05);
}

/* --- ESTILOS DO √çNDICE E FONTES --- */

.middle-view {
    list-style: none;
    padding: 0;
    margin: 0;
}

.empty-msg {
    text-align: center;
    color: var(--text-muted-color);
    padding: 30px 10px;
    font-style: italic;
    font-size: 0.9em;
}

/* Item do √çndice */
.index-item {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}

.index-item:hover {
    background-color: var(--hover-color);
    padding-left: 15px; /* Efeito de movimento */
}

.index-icon {
    font-size: 1.2em;
    min-width: 20px;
    text-align: center;
}

/* Cores dos tipos no √≠ndice */
.idx-question .index-icon { color: #2ecc71; }
.idx-subnote .index-icon { color: #3498db; }
.idx-redator .index-icon { color: #9b59b6; }
.idx-free .index-icon { color: #e67e22; }
.idx-card .index-icon { color: #795548; }

/* Item das Fontes (Lista Hier√°rquica) */
.source-group {
    margin-bottom: 15px;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
}

.source-header {
    font-weight: bold;
    color: var(--text-color);
    padding: 5px 10px;
    background: rgba(255,255,255,0.03);
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}
.source-header:hover { background: var(--hover-color); }

.source-links {
    padding-left: 25px;
    margin-top: 5px;
}

.source-link-item {
    display: flex;
    gap: 6px;
    font-size: 0.8em;
    padding: 3px 0;
    color: var(--accent-color);
    cursor: pointer;
    word-break: break-all;
}
.source-link-item:hover { text-decoration: underline; }

.source-codex-item {
    display: block;
    font-size: 0.8em;
    padding: 3px 0;
    color: #e67e22; /* Laranja Codex */
}

/* Bot√£o de Vistas Mobile */
@media (max-width: 768px) {
    #mobile-views-btn {
        display: block !important;
    }
    
    /* Ajuste para as abas dentro do modal */
    #mobile-views-modal .middle-bottom-tabs button {
        font-size: 11px;
        padding: 8px 0;
    }
    
    /* Garante que o conte√∫do copiado (listas) fica bonito no modal */
    #mobile-views-content .list-item, 
    #mobile-views-content .index-item {
        background-color: var(--panel-color);
        margin-bottom: 5px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }
}

/* ============================================================
   CORRE√á√ÉO: ESCONDER ABAS DA LISTA NO MOBILE
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Esconde a barra de abas APENAS no painel do meio (lista) */
    #middle-panel .middle-bottom-tabs {
        display: none !important;
    }

    /* 2. Garante que dentro do Popup (‚õ∂) elas continuam vis√≠veis */
    #mobile-views-modal .middle-bottom-tabs {
        display: flex !important;
    }

    /* 3. Remove o padding extra que servia para dar espa√ßo √†s abas */
    #middle-views-container {
        padding-bottom: 0 !important;
    }
}

/* ============================================================
   CORRE√á√ÉO DE BARRAS DE FUNDO (TABLET/MOBILE HORIZONTAL)
   ============================================================ */

/* 1. Mudar a altura para Din√¢mica (dvh) */
/* Isto faz com que a app se ajuste automaticamente quando as barras do navegador aparecem/desaparecem */
body, .notebook-container {
    height: 100vh; /* Fallback para browsers antigos */
    height: 100dvh !important; /* O SEGREDO: Altura real vis√≠vel */
    overflow: hidden !important;
}

/* 2. For√ßar a estrutura Flex Vertical R√≠gida */
/* Garante que o painel √© uma coluna que ocupa 100% e n√£o deixa transbordar */
#left-panel, #middle-panel {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    max-height: 100dvh !important;
    overflow: hidden !important;
    justify-content: space-between !important;
    padding-bottom: 0 !important; /* Removemos padding do fundo para a barra colar */
}

/* 3. Conte√∫do com Scroll (Listas) */
/* As listas devem ocupar o espa√ßo que sobra (flex: 1) e encolher se necess√°rio (min-height: 0) */
.panel-content, 
#middle-views-container {
    flex: 1 !important;
    overflow-y: auto !important;
    min-height: 0 !important; /* CR√çTICO: Permite que a lista encolha para dar espa√ßo ao rodap√© */
}

/* 4. Fixar os Rodap√©s (Settings e Pastas/√çndice) */
/* flex-shrink: 0 impede que sejam esmagados */
.panel-footer,
.middle-bottom-tabs {
    flex-shrink: 0 !important;
    z-index: 50 !important;
    background-color: var(--sidebar-color); /* Garante que o fundo n√£o √© transparente */
    position: relative !important;
    bottom: 0 !important;
    margin-bottom: 0 !important;
}

/* Corre√ß√£o espec√≠fica para a margem negativa do painel do meio */
.middle-bottom-tabs {
    margin: 0 -20px 0 -20px !important; /* Mant√©m largura total, mas zera margem de baixo */
}

/* Corre√ß√£o espec√≠fica para o rodap√© da esquerda */
#left-panel .panel-footer {
    margin: 0 -15px 0 -15px !important; /* Mant√©m largura total, zera margem de baixo */
    padding-bottom: env(safe-area-inset-bottom, 10px) !important; /* Respeita a barra de gestos do tablet */
}


/* ============================================================
   ANIMA√á√ÉO "SOFT FLASH SNAP" (R√°pida, Impactante, Luz Suave)
   ============================================================ */

@keyframes redatorFlashSnap {
    0% {
        opacity: 0;
        transform: scale(0.92) translateY(10px);
        /* Brilho inicial concentrado (Branco Suave) */
        background-color: rgba(255, 255, 255, 0.4); 
        box-shadow: 0 0 0 rgba(255, 255, 255, 0);
    }
    40% {
        opacity: 1;
        /* Ligeiro exagero no tamanho para o impacto (Snap) */
        transform: scale(1.02) translateY(0);
        
        /* A "Onda de Luz": Brilho difuso e elegante */
        background-color: rgba(255, 255, 255, 0.15); 
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 50px rgba(200, 220, 255, 0.25), inset 0 0 20px rgba(255, 255, 255, 0.1);
    }
    100% {
        transform: scale(1);
        /* Estabiliza no Vidro Escuro Padr√£o */
        background-color: rgba(255, 255, 255, 0.02);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.02);
    }
}

.redator-spawn-effect {
    /* 0.4s √© muito r√°pido. O bezier faz o movimento "bater" e travar. */
    animation: redatorFlashSnap 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.2) forwards;
    will-change: transform, opacity, box-shadow, background-color;
}

/* ============================================================
   CORRE√á√ÉO REDATOR MOBILE (Auto-Collapse)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar o colapso agressivo no Mobile */
    /* Garante que o cabe√ßalho desaparece mesmo com outros estilos mobile */
    .redator-header.collapsed {
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        opacity: 0 !important;
        border: none !important;
        pointer-events: none !important;
    }

    /* 2. Bot√£o "T" Amig√°vel para o Dedo */
    /* Aumenta a √°rea de toque para ser f√°cil reabrir */
    .redator-reopen-btn {
        width: 36px !important;
        height: 36px !important;
        top: 8px !important;
        left: 8px !important;
        
        font-size: 16px !important;
        font-weight: bold !important;
        
        /* Fundo mais vis√≠vel para se destacar no ecr√£ pequeno */
        background-color: rgba(255, 255, 255, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        
        z-index: 50 !important; /* Garante que fica por cima de tudo */
    }
}

/* ============================================================
   CORRE√á√ÉO DA DOCK DO REDATOR (MOBILE/TABLET)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar a Dock a estar SEMPRE VIS√çVEL no Mobile */
    /* No PC s√≥ aparece no hover, no mobile precisamos dela sempre */
    .redator-wrapper .redator-dock {
        opacity: 1 !important;
        pointer-events: auto !important;
        bottom: -22px !important; /* Posi√ß√£o fixa */
        
        /* Aumentar o fundo para ser mais f√°cil de ver/tocar */
        padding: 5px 10px !important;
        background-color: var(--panel-color) !important;
        border: 1px solid var(--accent-color) !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
    }

    /* 2. Bot√µes Maiores (√Årea de Toque) */
    .dock-btn {
        width: 40px !important;  /* Aumentado de 32px */
        height: 40px !important;
    }
    
    /* √çcones maiores */
    .dock-btn svg {
        width: 20px !important;
        height: 20px !important;
    }

    /* 3. Separador Ajustado */
    .dock-sep {
        height: 20px !important;
        margin: 0 5px !important;
    }
    
    /* 4. Esconder Tooltips no Mobile (atrapalham) */
    .dock-btn::after {
        display: none !important;
    }
}

/* Transi√ß√£o mais lenta (0.6s) para um efeito de "respira√ß√£o" suave */
.redator-wrapper {
    transition: border-color 0.6s ease, box-shadow 0.6s ease;
}

/* O estado ativo enquanto escreve */
.redator-wrapper.typing-border-glow {
    /* A borda fica apenas um pouco mais clara, n√£o branca total */
    border-color: rgba(255, 255, 255, 0.35) !important;
    
    /* O brilho √© muito difuso e com pouca opacidade (apenas 10%) */
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.1) !important;
}

/* Destaque do item ativo no √çndice */
.index-item.active-scroll {
    background-color: rgba(74, 144, 226, 0.15) !important; /* Fundo azul suave */
    border-left: 4px solid var(--accent-color) !important; /* Borda azul forte */
    color: var(--text-color) !important;
    font-weight: bold;
    transition: all 0.2s ease;
}


/* Item da Lista de √Çncoras */
.anchor-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s;
}

.anchor-item-row:hover {
    background-color: var(--hover-color);
}

/* Estado Selecionado (Visualmente Assinalado) */
.anchor-item-row.selected {
    background-color: rgba(74, 144, 226, 0.15); /* Fundo azul suave */
    border-left: 4px solid var(--accent-color);
}

.anchor-item-row.selected .anchor-name {
    color: var(--accent-color);
    font-weight: bold;
}

/* Check visual */
.anchor-check-icon {
    display: none;
    color: var(--accent-color);
    font-weight: bold;
}

.anchor-item-row.selected .anchor-check-icon {
    display: block;
}

/* Estilo para item da lista de √¢ncoras */
.anchor-select-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s;
}

.anchor-select-item:hover {
    background-color: var(--hover-color);
}

/* Estilo Selecionado (Verde) */
.anchor-select-item.selected {
    background-color: rgba(46, 204, 113, 0.15); /* Fundo verde suave */
    border-left: 4px solid #2ecc71;
    color: #2ecc71;
    font-weight: bold;
}

.anchor-check {
    display: none;
    font-size: 1.2em;
}

.anchor-select-item.selected .anchor-check {
    display: block;
}

/* Bot√£o Editar na lista de √Çncoras */
.anchor-edit-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 5px;
    display: none; /* Escondido por padr√£o */
}

.anchor-edit-btn:hover {
    color: var(--text-color);
    background-color: rgba(255, 255, 255, 0.1);
}

/* Mostra o bot√£o apenas quando o rato passa por cima da linha */
.anchor-item-row:hover .anchor-edit-btn {
    display: block;
}

/* Item da Lista de √Çncoras */
.anchor-select-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s;
    position: relative; /* Necess√°rio para posicionamento */
}

.anchor-select-item:hover {
    background-color: var(--hover-color);
}

/* Bot√£o Editar (L√°pis) - S√≥ aparece ao passar o rato (no PC) ou sempre (no layout flex) */
.anchor-item-edit-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 16px;
    padding: 8px;
    margin-right: 5px;
    border-radius: 4px;
    transition: color 0.2s, background 0.2s;
    z-index: 10; /* Fica acima do clique da linha */
}

.anchor-item-edit-btn:hover {
    color: var(--text-color);
    background-color: rgba(255, 255, 255, 0.1);
}

/* √Årea de texto cresce para empurrar os bot√µes */
.anchor-info-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}


/* Painel de Sincroniza√ß√£o (Overlay sobre o Editor) */
#editor-sync-overlay {
    display: none; /* Escondido por defeito */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(26, 26, 29, 0.85); /* Fundo escuro semi-transparente */
    z-index: 5000; /* Acima do texto */
    justify-content: center;
    align-items: center;
    flex-direction: column;
    backdrop-filter: blur(2px);
    transition: opacity 0.3s ease;
}

#editor-sync-overlay.visible {
    display: flex;
}

.sync-message {
    background-color: var(--panel-color);
    padding: 15px 25px;
    border-radius: 8px;
    border: 1px solid var(--accent-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    gap: 15px;
    color: var(--text-color);
    font-weight: 500;
}

/* ============================================================
   ESTILOS DO DEP√ìSITO DE REFER√äNCIAS (DESIGN PREMIUM) üèóÔ∏è
   ============================================================ */

/* 1. O Contentor Principal */
.ref-depot-wrapper {
    background: linear-gradient(180deg, #202023 0%, #1a1a1d 100%);
    border: 1px solid #333;
    border-top: 4px solid #f39c12; /* Laranja Constru√ß√£o */
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* 2. Cabe√ßalho do Dep√≥sito */
.depot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(243, 156, 18, 0.2);
}

.depot-title {
    background: transparent;
    border: none;
    color: #f39c12;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 1.1em;
    letter-spacing: 1.5px;
    width: 100%;
    outline: none;
}
.depot-title::placeholder { opacity: 0.4; color: #f39c12; }

/* 3. Bot√µes de A√ß√£o (Estilo P√≠lula) */
.depot-btn {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-muted-color);
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    margin-left: 6px;
    transition: all 0.2s ease;
}
.depot-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
.btn-del-node:hover { color: #e74c3c; border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

/* ============================================================
   4. ESTILO ZEBRADO DAS PASTAS (CATEGORIAS)
   ============================================================ */

.depot-category {
    margin-bottom: 10px;
    border-radius: 6px;
    padding: 10px;
    transition: background-color 0.2s;
    border-left: 4px solid transparent;
}

/* --- PASTA √çMPAR (Laranja - Tema Constru√ß√£o) --- */
.depot-category:nth-of-type(odd) {
    background-color: rgba(243, 156, 18, 0.04); 
    border-left-color: #f39c12;
    border-top: 1px solid rgba(243, 156, 18, 0.05);
}
/* Linha da √°rvore √çmpar */
.depot-category:nth-of-type(odd) .depot-tree-line {
    border-left: 1px dashed rgba(243, 156, 18, 0.3) !important;
}

/* --- PASTA PAR (Azul - Tema Tecnologia) --- */
.depot-category:nth-of-type(even) {
    background-color: rgba(52, 152, 219, 0.04);
    border-left-color: #3498db;
    border-top: 1px solid rgba(52, 152, 219, 0.05);
}
/* Linha da √°rvore Par */
.depot-category:nth-of-type(even) .depot-tree-line {
    border-left: 1px dashed rgba(52, 152, 219, 0.3) !important;
}

/* Hover na Pasta */
.depot-category:hover {
    background-color: rgba(255, 255, 255, 0.06);
}

/* T√≠tulo da Categoria */
.depot-input-title {
    background: transparent;
    border: none;
    border-bottom: 1px dashed transparent;
    color: #e0e0e0;
    padding: 4px 0;
    width: 200px;
    flex-grow: 1;
    font-weight: 700;
    font-size: 1.05em;
    outline: none;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 10px;
}
.depot-input-title:focus { border-bottom-color: var(--accent-color); }

/* 5. Subt√≠tulos (Dentro das Pastas) */
.depot-subtitle {
    margin-top: 5px;
}
.depot-subtitle .depot-input-title {
    font-size: 0.9em;
    font-weight: 500;
    color: #aab7c4; /* Cinza azulado */
    text-transform: none;
}

/* Linha da √Årvore (Margens) */
.depot-tree-line {
    margin-left: 9px;
    padding-left: 15px;
    padding-top: 5px;
    padding-bottom: 5px;
}

/* √çcone de Expandir/Recolher */
.depot-toggle-icon {
    display: inline-block;
    cursor: pointer;
    transition: transform 0.2s;
    user-select: none;
    width: 20px; 
    text-align: center; 
    
    /* AQUI EST√Å A MUDAN√áA DO ESPA√áAMENTO: */
    margin-right: 15px !important; /* Aumentado para separar do texto */
    
    opacity: 0.8;
}

.is-collapsed > div > .depot-toggle-icon {
    transform: rotate(-90deg); opacity: 0.5;
}
.is-collapsed > .depot-tree-line { display: none !important; }

/* ============================================================
   6. CART√ÉO DE LINK (LAYOUT DE DUAS LINHAS)
   ============================================================ */

.depot-link-card {
    /* Estrutura Base */
    background-color: rgba(40, 40, 45, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 8px 10px;
    margin-bottom: 6px;
    position: relative;
    
    /* Layout Vertical (Empilhado) */
    display: flex;
    flex-direction: column;
    gap: 4px; /* Espa√ßo entre Descri√ß√£o e URL */
    
    transition: all 0.2s ease;
}

/* Cores Zebradas (Mant√™m-se para ajudar a distinguir) */
.depot-link-card:nth-of-type(odd) {
    border-left: 3px solid #3498db;
    background-color: rgba(52, 152, 219, 0.04);
}
.depot-link-card:nth-of-type(even) {
    border-left: 3px solid #f39c12;
    background-color: rgba(243, 156, 18, 0.04);
}

.depot-link-card:hover {
    background-color: rgba(60, 60, 65, 0.8) !important;
    border-left-width: 5px;
    transform: translateX(2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* --- LINHA 1: DESCRI√á√ÉO --- */
.depot-desc {
    background: transparent;
    border: none;
    color: var(--text-color); /* Texto normal */
    font-weight: 600;
    font-size: 0.9em;
    width: 90%; /* Deixa espa√ßo para o X */
    outline: none;
    padding: 0;
}
.depot-desc::placeholder { 
    font-weight: normal; 
    color: rgba(255,255,255,0.2); 
    font-style: italic;
}

/* --- LINHA 2: URL + BOT√ÉO --- */
.depot-url-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.depot-url {
    background: transparent;
    border: none;
    font-family: 'Consolas', monospace;
    font-size: 0.8em;
    color: var(--accent-color); /* Azul link */
    flex-grow: 1; /* Ocupa o espa√ßo todo */
    outline: none;
    padding: 0;
    opacity: 0.8;
}
.depot-url:focus { opacity: 1; color: #fff; }
.depot-url::placeholder { color: rgba(74, 144, 226, 0.3); }

/* Bot√£o Visitar [‚Üó] */
.depot-visit-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-muted-color);
    border-radius: 4px;
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}
.depot-visit-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Bot√£o Fechar (X) */
.depot-del-card {
    position: absolute;
    top: 6px; 
    right: 6px;
    
    background: none; border: none;
    color: #e74c3c;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    line-height: 1;
    opacity: 0; /* Invis√≠vel at√© passar o rato */
    transition: opacity 0.2s;
    padding: 2px;
}
.depot-link-card:hover .depot-del-card { opacity: 0.7; }
.depot-del-card:hover { opacity: 1 !important; transform: scale(1.2); }

/* ============================================================
   CABE√áALHOS FIXOS (STICKY HEADERS)
   ============================================================ */

/* Aplica √† barra de t√≠tulo da Categoria (üìÇ) e do Subt√≠tulo (üîπ) */
.depot-category > div:first-child,
.depot-subtitle > div:first-child {
    position: sticky;
    position: -webkit-sticky; /* Para Safari */
    top: 0;
    
    z-index: 10; /* Garante que fica por cima dos links */
    
    /* Fundo opaco para os links n√£o aparecerem por tr√°s do texto */
    background-color: #1a1a1d; /* Mesma cor de fundo do seu tema */
    
    /* Pequeno ajuste visual */
    padding: 8px 0;
    margin-bottom: 5px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* Linha subtil para separar */
}

/* Opcional: Faz o mesmo para o cabe√ßalho principal do Dep√≥sito (üèóÔ∏è) */
.depot-header {
    position: sticky;
    position: -webkit-sticky;
    top: 0;
    z-index: 20; /* Fica acima das categorias */
    background-color: #1a1a1d;
    padding-top: 10px; /* Compensar margem */
}


/* ============================================================
   ESTILOS DO AQU√ÅRIO (AMBIENTE ISOLADO)
   ============================================================ */
#aquarium-environment {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10000; /* Acima da interface normal, abaixo dos modais de sistema */
    background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%); /* Fundo "Fundo do Mar" */
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Barra de Topo (Estilo Windows/Mac) */
#aquarium-bar {
    height: 50px;
    background-color: rgba(0, 0, 0, 0.5);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    flex-shrink: 0;
    backdrop-filter: blur(5px);
}

#aquarium-title-display {
    color: white;
    font-size: 1.1em;
    font-weight: 500;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Bot√£o Sair */
#aquarium-exit-btn {
    background: rgba(231, 76, 60, 0.2);
    border: 1px solid #e74c3c;
    color: #e74c3c;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
#aquarium-exit-btn:hover {
    background: #e74c3c;
    color: white;
}

/* √Årea de Trabalho Infinita */
#aquarium-desktop {
    flex-grow: 1;
    position: relative;
    overflow: hidden; /* O conte√∫do ser√° arrast√°vel, n√£o scrol√°vel */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Atualiza√ß√£o da Barra */
#aquarium-bar {
    height: 60px;
    background-color: rgba(30, 30, 35, 0.95);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between; /* Espalha os grupos */
    padding: 0 20px;
    flex-shrink: 0;
    z-index: 20000;
}

/* Grupos */
.aquarium-nav-group, 
.aquarium-tools-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.aquarium-title-group {
    /* Mant√©m alinhado √† direita, mas for√ßa um espa√ßo de seguran√ßa */
    justify-content: flex-end !important;
    
    /* AQUI EST√Å A CORRE√á√ÉO: Afasta 60px da borda direita */
    padding-right: 60px !important; 
    
    /* Impede que o t√≠tulo empurre a barra para fora do ecr√£ */
    min-width: 0; 
    overflow: hidden;
}

/* 2. Texto do T√≠tulo */
#aquarium-title-display {
    /* Se o t√≠tulo for gigante, p√µe "..." em vez de cortar feio */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 100%;
    
    /* Alinha o texto √† direita dentro do seu espa√ßo */
    text-align: right;
}

/* 3. Caixa de Edi√ß√£o (Input) */
/* Garante que quando clica para editar, a caixa de texto tamb√©m respeita a margem */
.aquarium-header-input {
    margin-right: 60px !important;
}

/* Bot√µes do Aqu√°rio */
#aquarium-bar button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-color);
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

#aquarium-bar button:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* POPUP DE NAVEGA√á√ÉO R√ÅPIDA */
#aquarium-jump-popup {
    position: absolute;
    top: 65px; /* Logo abaixo da barra */
    left: 80px; /* Perto do bot√£o */
    width: 300px;
    background: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    padding: 10px;
    z-index: 30000;
}

#aquarium-jump-search {
    width: 100%;
    padding: 10px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: white;
    margin-bottom: 10px;
}

#aquarium-jump-list {
    list-style: none;
    max-height: 300px;
    overflow-y: auto;
}

#aquarium-jump-list li {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex; 
    align-items: center;
    gap: 8px;
}

#aquarium-jump-list li:hover {
    background-color: var(--hover-color);
    color: var(--accent-color);
}

/* Barra de Ferramentas (Secund√°ria) */
#aquarium-toolbar {
    height: 50px;
    background-color: rgba(40, 40, 45, 0.9); /* Um pouco mais clara que a de cima */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 15px;
    flex-shrink: 0;
    overflow-x: auto; /* Permite scroll se o ecr√£ for pequeno */
}

/* Grupos */
.aq-tool-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Bot√µes */
#aquarium-toolbar button {
    background: transparent;
    border: 1px solid transparent;
    color: #ccc;
    min-width: 32px;
    height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
}

#aquarium-toolbar button:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
}

/* Bot√µes Especiais (B Azul / I Dots) */
.btn-blue-b { color: #4a90e2 !important; font-weight: bold; position: relative; padding-right: 12px; }
.btn-italic { position: relative; padding-right: 12px; }
.dots { font-size: 10px; margin-left: 2px; opacity: 0.7; }

/* Separador Vertical */
.aq-sep {
    width: 1px;
    height: 25px;
    background: rgba(255, 255, 255, 0.1);
}

/* Inputs e Selects */
#aquarium-toolbar select {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    padding: 4px;
    border-radius: 4px;
    height: 30px;
    outline: none;
}

/* √Årea de Scroll */
#aquarium-scroll-area {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 40px;
    display: flex;
    justify-content: center;
}

/* O "Papel" Infinito (Canvas) */
#aquarium-content-canvas {
    width: 100%;
    max-width: 900px; 
    min-height: 80vh;
    padding-bottom: 50vh !important; 
    pointer-events: auto !important;
    
    /* ADICIONE ESTA LINHA PARA O CRESCIMENTO SER SUAVE */
    transition: min-height 0.3s ease-out; 
    
    cursor: text; 
}

/* O BLOCO FANTASMA üëª */
.ghost-block {
    position: relative;
    width: 100%;
  min-height: 44px;
    margin-bottom: 10px;
    padding: 10px 15px;
    
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.1em;
    line-height: 1.6;
    outline: none; /* Remove o contorno azul feio do browser */
    
    /* O Efeito Fantasma */
    background: transparent;
    border: 1px solid transparent; /* Invis√≠vel por padr√£o */
    border-radius: 8px;
    transition: all 0.2s ease;
}

/* Quando focado ou com o rato em cima */
.ghost-block:hover {
    background: rgba(255, 255, 255, 0.02); /* Sombra ultra leve */
}

.ghost-block:focus {
    background: rgba(255, 255, 255, 0.05); /* Fundo ligeiramente vis√≠vel */
    border-color: rgba(255, 255, 255, 0.1); /* Borda subtil */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Sombra para destacar */
}

/* Placeholder */
.ghost-block:empty::before,
.ghost-block:has(.ghost-actions:only-child)::before {
    content: attr(data-placeholder);
    color: rgba(255, 255, 255, 0.3);
    pointer-events: none; /* Deixa o clique passar para o texto */
    position: absolute;   /* Garante que fica no topo/esquerda */
    top: 10px;
    left: 15px;
}

#semantic-type-popup {
    position: fixed;
    z-index: 30000;
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 6px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    width: 150px;
}

.semantic-header {
    font-size: 0.75em;
    color: var(--text-muted-color);
    padding: 5px 10px;
    text-transform: uppercase;
    font-weight: bold;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 5px;
}

#semantic-type-popup button {
    background: none;
    border: none;
    color: var(--text-color);
    text-align: left;
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9em;
    transition: background 0.2s;
}

#semantic-type-popup button:hover {
    background-color: var(--hover-color);
}

/* Indica qual est√° ativo atualmente */
#semantic-type-popup button.active {
    background-color: rgba(74, 144, 226, 0.15) !important; /* Fundo azul suave */
    color: var(--accent-color) !important; /* Texto azul */
    font-weight: bold !important;
    border-left: 3px solid var(--accent-color) !important; /* Linha indicadora */
    padding-left: 8px !important; /* Ajuste para a borda */
}
#semantic-type-popup button.active::after {
    content: '‚úì';
    float: right;
}

/* √çcone espec√≠fico para o tipo Aqu√°rio */
.list-item[data-type="aquario"]:before { 
    content: 'ü™∏'; 
    font-size: 18px;
    margin-right: 10px;
}


/* ============================================================
   CORRE√á√ÉO VISUAL DO AQU√ÅRIO
   ============================================================ */

/* 1. BLINDAGEM CONTRA DESALINHAMENTO */
/* Quando um fantasma ganha a classe de wrapper, ignoramos as margens antigas */
.ghost-block.mini-note-wrapper {
    margin: 0 0 10px 0 !important;      /* Mant√©m a margem vertical simples */
    width: 100% !important;             /* Mant√©m a largura total */
    box-sizing: border-box !important;  /* Garante que o padding n√£o aumenta a largura */
    background-color: transparent;      /* Remove fundos indesejados */
    border: 1px solid transparent;      /* Prepara a borda para n√£o saltar */
}

/* 1. REGRA SUPREMA: MATA A BORDA DE CIMA EM TODAS AS SITUA√á√ïES */
/* Aplica-se ao estado normal, focado, selecionado ou quando a ferramenta √© clicada (.mini-note-wrapper) */
.ghost-block,
.ghost-block:focus,
.ghost-block.active-selection,
.ghost-block.mini-note-wrapper,
.ghost-block.mini-note-wrapper.active-selection {
    border-top: 0 !important;
    border-top-width: 0 !important;
    border-top-style: none !important;
    border-top-color: transparent !important;
    
    /* Remove outline padr√£o do browser */
    outline: none !important;
    box-shadow: none !important;
    
    /* Garante alinhamento */
    margin: 0 0 10px 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 2. ESTILO DE SELE√á√ÉO (Apenas linha Esquerda) */
.ghost-block:focus,
.ghost-block.active-selection {
    background-color: rgba(255, 255, 255, 0.04) !important;
    border-left: 3px solid var(--accent-color) !important;
    border-right: none !important;
    border-bottom: none !important;
}

/* 3. EXCE√á√ïES SEM√ÇNTICAS (S√ì ESTES PODEM TER LINHA NO TOPO) */
/* Usamos seletores fortes para vencer a Regra 1 apenas nestes casos */

/* T√≠tulo H1 (Verde) */
.ghost-block[data-semantic="h1"],
.ghost-block[data-semantic="h1"].active-selection,
.ghost-block[data-semantic="h1"].mini-note-wrapper {
    border-top: 3px solid #2ecc71 !important;
    padding-top: 15px !important;
    font-size: 1.6em;
    font-weight: bold;
}

/* T√≠tulo H2 (Laranja) */
.ghost-block[data-semantic="h2"],
.ghost-block[data-semantic="h2"].active-selection,
.ghost-block[data-semantic="h2"].mini-note-wrapper {
    border-top: 3px solid #e67e22 !important;
    padding-top: 15px !important;
    font-size: 1.3em;
    font-weight: bold;
}

/* Nota (Vermelho Tracejado) */
.ghost-block[data-semantic="note"],
.ghost-block[data-semantic="note"].active-selection,
.ghost-block[data-semantic="note"].mini-note-wrapper {
    border-top: 2px dashed #e74c3c !important;
    background-color: rgba(231, 76, 60, 0.05) !important;
    font-style: italic;
    color: #e6b0aa;
    font-size: 0.9em;
}

/* Subpar√°grafo (Apenas recuo, SEM borda) */
.ghost-block[data-semantic="sub"] {
    margin-left: 30px !important;
    border-top: none !important; /* Refor√ßo */
    font-size: 0.95em;
    opacity: 0.9;
}

/* 5. Par√°grafo Normal (P) - Limpo */
.ghost-block[data-semantic="p"] {
    border-top: none !important;
}


/* ============================================================
   CORRE√á√ÉO NUCLEAR DA BORDA AZUL (AQU√ÅRIO)
   ============================================================ */

/* Aplica-se a qualquer bloco fantasma, independentemente de outras classes */
div#aquarium-content-canvas .ghost-block {
    border-top-color: transparent !important;
    border-top-style: none !important;
    border-top-width: 0 !important;
    outline: none !important;
    box-shadow: none !important;
}

/* Restaura apenas as exce√ß√µes sem√¢nticas que queremos */
div#aquarium-content-canvas .ghost-block[data-semantic="h1"] {
    border-top: 3px solid #2ecc71 !important;
}
div#aquarium-content-canvas .ghost-block[data-semantic="h2"] {
    border-top: 3px solid #e67e22 !important;
}
div#aquarium-content-canvas .ghost-block[data-semantic="note"] {
    border-top: 2px dashed #e74c3c !important;
}

/* Garante que o Subpar√°grafo e Normal N√ÉO t√™m borda, mesmo selecionados */
div#aquarium-content-canvas .ghost-block[data-semantic="sub"],
div#aquarium-content-canvas .ghost-block[data-semantic="p"],
div#aquarium-content-canvas .ghost-block:not([data-semantic]) {
    border-top: none !important;
}

/* Se por acaso a classe .mini-note-wrapper estiver a adicionar pseudo-elementos (::before) */
.ghost-block.mini-note-wrapper::before {
    display: none !important;
    content: none !important;
    height: 0 !important;
    width: 0 !important;
    background: transparent !important;
}

/* ============================================================
   AQU√ÅRIO: SIDEBAR MEDUSA (ü™º)
   ============================================================ */
#aquarium-sidebar {
    position: absolute; 
    
    /* CORRE√á√ÉO AQUI: 60px (Barra Topo) + 50px (Toolbar B/I/U) = 110px */
    top: 110px !important;          
    
    left: 0;
    bottom: 0; /* Vai at√© ao fundo do ecr√£ */
    width: 0;
    
    /* Visual de Vidro Escuro */
    background-color: rgba(20, 20, 23, 0.95);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    
    /* Z-Index ajustado para n√£o tapar modais, mas ficar acima do texto */
    z-index: 500; 
    
    display: flex;
    flex-direction: column;
}

/* Quando aberto */
#aquarium-environment.sidebar-open #aquarium-sidebar {
    width: 360px !important; /* Aumentado de 300px para 360px */
}

/* 2. AJUSTAR OS BOT√ïES DAS ABAS */
.aq-tab {
    background: none;
    border: none;
    color: #888;
    
    /* MUDAN√áA: Padding menor nos lados, mas flex: 1 para ocupar espa√ßo igual */
    padding: 12px 0; 
    flex: 1;         /* Faz com que os 6 √≠cones dividam a largura exata */
    text-align: center;
    
    font-size: 18px;
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    line-height: 1;
}

/* Garante que o container n√£o tem scroll */
.aq-tabs-header {
    display: flex;
    width: 100%;       /* Garante largura total */
    overflow-x: hidden; /* Remove scroll horizontal */
    background: rgba(0,0,0,0.3);
    flex-shrink: 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.aq-tabs-header::-webkit-scrollbar { display: none; }

.aq-tab {
    background: none;
    border: none;
    color: #888;
    padding: 12px 15px; /* Espa√ßamento confort√°vel */
    cursor: pointer;
    
    /* AUMENTADO DE 13px PARA 18px PARA OS √çCONES FICAREM BONS */
    font-size: 18px; 
    
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    line-height: 1; /* Garante alinhamento vertical */
}

.aq-tab:hover { 
    color: #fff; 
    background: rgba(255,255,255,0.05); 
}

.aq-tab.active { 
    color: var(--accent-color); 
    border-bottom-color: var(--accent-color); 
}

#aq-sidebar-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0;
}

/* Listas internas */
#aq-sidebar-content ul { list-style: none; padding: 0; margin: 0; }
#aq-sidebar-content li {
    padding: 10px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    font-size: 0.9em;
    color: #e0e0e0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#aq-sidebar-content li:hover { background-color: rgba(255,255,255,0.05); }

/* Card do √çndice */
.aq-index-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 6px;
    margin: 8px 10px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.aq-index-card:hover {
    border-color: var(--accent-color);
    background: rgba(255,255,255,0.06);
}
.aq-card-title {
    font-weight: bold;
    color: var(--accent-color);
    font-size: 0.85em;
    display: block;
    margin-bottom: 3px;
}
.aq-card-preview {
    font-size: 0.8em;
    color: #888;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================================
   AQU√ÅRIO: NAVEGA√á√ÉO DA ABA üß≠
   ============================================================ */
.aq-nav-header {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 5px;
}

.aq-nav-back-btn {
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 18px;
    cursor: pointer;
    margin-right: 10px;
    padding: 0;
}

.aq-nav-title {
    font-weight: bold;
    color: #fff;
    font-size: 0.95em;
}

/* Estilo para Grelhas (Cap√≠tulos/Vers√≠culos na B√≠blia) */
.aq-grid-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* 5 por linha */
    gap: 5px;
    padding: 10px;
}

.aq-grid-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: #e0e0e0;
    text-align: center;
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
.aq-grid-btn:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* ============================================================
   FOR√áAR 4¬™ COLUNA NO AQU√ÅRIO (DIREITA)
   ============================================================ */
/* Quando esta classe √© adicionada ao painel, ele flutua sobre o aqu√°rio */
#references-panel.aquarium-overlay-mode {
    display: flex !important;
    position: fixed !important;
    top: 110px !important; /* Abaixo das barras de topo */
    right: 0 !important;
    bottom: 0 !important;
    height: auto !important;
    width: 400px !important; /* Largura fixa */
    
    z-index: 600 !important; /* Acima da sidebar esquerda (500), abaixo de popups */
    
    background-color: rgba(20, 20, 23, 0.95) !important;
    border-left: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: -5px 0 20px rgba(0,0,0,0.5) !important;
    backdrop-filter: blur(10px);
    
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateX(0) !important;
    flex: none !important; /* Remove flexibilidade do layout principal */
}

/* Em mobile, ocupa largura total */
@media (max-width: 768px) {
    #references-panel.aquarium-overlay-mode {
        width: 100% !important;
        top: 60px !important; /* Mais espa√ßo em mobile */
        bottom: 0 !important;
    }
}

/* ============================================================
   ANIMA√á√ÉO DE FA√çSCA PARA O BOT√ÉO DE LINKS (‚ö°)
   ============================================================ */
@keyframes electricPulse {
    0% { 
        box-shadow: 0 0 0 rgba(241, 196, 15, 0); 
        color: #888;
        border-color: transparent;
    }
    50% { 
        box-shadow: 0 0 10px rgba(241, 196, 15, 0.4); 
        color: #f1c40f; 
        border-color: #f1c40f;
        background-color: rgba(241, 196, 15, 0.1);
    }
    100% { 
        box-shadow: 0 0 2px rgba(241, 196, 15, 0.2); 
        color: #f1c40f; /* Mant√©m amarelo no fim */
        border-color: rgba(241, 196, 15, 0.5);
    }
}

/* Classe aplicada via JS quando h√° links */
.aq-tool-group button[data-ctx="links"].has-links-sparkle {
    animation: electricPulse 1.5s infinite alternate ease-in-out;
    color: #f1c40f !important; /* For√ßa √≠cone amarelo */
    border: 1px solid #f1c40f !important; /* Borda amarela */
}

/* ============================================================
   AQU√ÅRIO: BOT√ïES DE CANTO (üêö ‚á±)
   ============================================================ */
/* Contentor dos bot√µes (canto superior direito do bloco) */
.ghost-actions {
    position: absolute;
    top: 5px;
    right: 5px;
    display: none; 
    gap: 5px;
    z-index: 50; 
    
    /* MUDAN√áA CR√çTICA AQUI: */
    pointer-events: none !important; /* O clique passa atrav√©s da caixa transparente */
}

/* Mostra os bot√µes no hover */
.ghost-block:hover .ghost-actions,
.ghost-block.active-selection .ghost-actions {
    display: flex;
}

.ghost-action-btn {
    background: rgba(0,0,0,0.5); /* Fundo escuro para ser clic√°vel */
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
     pointer-events: auto !important;
}

.ghost-action-btn:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
    transform: scale(1.1);
}

/* ============================================================
   AQU√ÅRIO: JANELA POPUP FLUTUANTE
   ============================================================ */
.aq-popup-window {
    position: fixed; /* Sempre relativo √† janela do browser */
    
    /* Z-Index superior ao Aqu√°rio (2000000000) e Modais (2147483647) */
    z-index: 2147483647 !important; 
    
    top: 150px;
    left: 150px;
    width: 400px;
    height: 300px;
    
    background-color: rgba(30, 30, 35, 0.98); /* Quase opaco para leitura */
    border: 1px solid var(--accent-color);    /* Borda azul para destaque */
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
    border-radius: 8px;
    
    display: flex;
    flex-direction: column;
    overflow: hidden;
    
    /* Anima√ß√£o de entrada */
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.aq-popup-header {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    cursor: grab; /* M√£ozinha para arrastar */
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
}
.aq-popup-header:active { cursor: grabbing; }

.aq-popup-title {
    font-size: 0.85em;
    font-weight: bold;
    color: #aaa;
    text-transform: uppercase;
}

.aq-popup-close {
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
}

.aq-popup-content {
    flex-grow: 1;
    padding: 15px;
    color: #e0e0e0;
    outline: none;
    overflow-y: auto;
    font-family: inherit;
    line-height: 1.5;
}

/* Estado bloqueado do bloco original */
.ghost-block.locked-popup {
    opacity: 0.4;
    background-color: rgba(0, 0, 0, 0.3) !important;
    border: 1px dashed rgba(255, 255, 255, 0.3) !important;
    
    /* A CORRE√á√ÉO EST√Å AQUI: */
    pointer-events: auto !important; /* Impede que o clique atravesse para o fundo */
    cursor: not-allowed;             /* Mostra o √≠cone de proibido */
    
    user-select: none;
}


/* Aviso visual */
.ghost-block.locked-popup::after {
    content: "Aberto em Janela ‚á±";
    position: absolute;
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: bold;
    pointer-events: none;
    white-space: nowrap;
    z-index: 5;
    border: 1px solid var(--accent-color);
}

/* Bloco que est√° a ser visualizado no Armaz√©m */
.ghost-block.active-store-target {
    border: 1px solid var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.05) !important;
    box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);
}

/* --- ESTILOS DOS CARDS DE ANOTA√á√ÉO (ARMAZ√âM üêö) --- */
.store-annotation-card {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-left: 3px solid #f39c12; /* Laranja para diferenciar das notas */
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: all 0.2s ease;
}

.store-annotation-card:hover {
    background-color: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2);
}

.store-card-header {
    display: flex;
    align-items: center;
    gap: 5px;
}

.store-card-title {
    background: transparent;
    border: none;
    color: var(--text-color);
    font-weight: bold;
    font-size: 0.95em;
    width: 100%;
    outline: none;
    padding-bottom: 2px;
    border-bottom: 1px dashed transparent;
}

.store-card-title:focus {
    border-bottom-color: var(--accent-color);
}

.store-card-body {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    padding: 8px;
    color: var(--text-muted-color);
    font-size: 0.9em;
    min-height: 40px;
    outline: none;
    white-space: pre-wrap;
    line-height: 1.4;
}

.store-card-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding-top: 5px;
}

.store-btn-action {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
}

.store-btn-action:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-color);
}

.store-btn-action.active-link {
    color: var(--accent-color);
    border-color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

.store-btn-action.delete:hover {
    color: #e74c3c;
    border-color: #e74c3c;
    background-color: rgba(231, 76, 60, 0.1);
}

/* Link clic√°vel no t√≠tulo quando existe */
.store-link-indicator {
    cursor: pointer;
    text-decoration: underline;
    text-decoration-color: var(--accent-color);
}

/* ESTADO ATIVO DO BOT√ÉO MEDUSA */
#aquarium-sidebar-toggle.active {
    background-color: var(--accent-color) !important; /* Fica Azul */
    color: white !important;
    border-color: var(--accent-color) !important;
    box-shadow: 0 0 15px rgba(74, 144, 226, 0.3); /* Brilho suave */
    transform: scale(1.1); /* Ligeiro aumento */
}


/* Bot√£o de Inser√ß√£o R√°pida */
.ghost-add-between-btn {
    position: absolute;
    bottom: -12px;
    left: -24px;
    
    width: 20px;
    height: 20px;
    border-radius: 50%;
    
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    
    /* TRUQUE: Tamanho 0 esconde o texto antigo do HTML */
    font-size: 0 !important; 
    color: transparent; 
    
    display: none; 
    align-items: center;
    justify-content: center;
    
    cursor: pointer;
    z-index: 100;
    
    transition: all 0.2s ease;
    
    /* Garante que o bot√£o recebe cliques */
    pointer-events: auto !important; 
    user-select: none !important;
    -webkit-user-select: none !important;
}

/* O "+" visual (Pseudo-elemento) */
.ghost-add-between-btn::before {
    content: '+';
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Restaura o tamanho e cor para o √≠cone */
    font-size: 16px !important; 
    color: var(--text-muted-color);
    
    width: 100%;
    height: 100%;
    margin-top: -2px; /* Ajuste fino vertical */
}

/* Hover */
.ghost-add-between-btn:hover {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    transform: scale(1.2);
}

.ghost-add-between-btn:hover::before {
    color: white; /* Muda a cor do + para branco no hover */
}

/* Visibilidade controlada pelo JS */
.ghost-block.active-selection.has-next .ghost-add-between-btn {
    display: flex !important;
    animation: fadeIn 0.2s ease;
}


/* ============================================================
   ESTILOS DO ARMAZ√âM (STORE) - ABAS E CARDS
   ============================================================ */

/* Barra de Abas do Armaz√©m */
.store-tabs-header {
    display: flex;
    gap: 8px;
    padding: 10px 10px 0 10px; /* Padding no topo e lados, zero em baixo para colar √† borda */
    border-bottom: 1px solid var(--border-color);
    background-color: var(--sidebar-color); /* Garante fundo s√≥lido */
    overflow-x: auto;
    white-space: nowrap; /* Impede quebra de linha */
    
    /* Esconde barra de scroll feia mas permite scroll */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}

.store-tabs-header::-webkit-scrollbar { display: none; }

.store-tab-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px 6px 0 0; /* Cantos redondos s√≥ em cima */
    font-size: 0.9em;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
    
    /* Importante: Borda inferior transparente por defeito */
    border-bottom: 3px solid transparent;
    margin-bottom: -1px; /* Faz a borda ativa sobrepor a linha do header */
}

.store-tab-btn:hover {
    color: var(--text-color);
    background-color: var(--hover-color);
}

.store-tab-btn.active {
    color: var(--accent-color); /* Azul do texto */
    font-weight: bold;
    border-bottom-color: var(--accent-color); /* Linha azul por baixo */
    background-color: rgba(74, 144, 226, 0.1); /* Fundo azul muito suave */
}

/* √Årea de Conte√∫do */
.store-content-area {
    padding: 15px;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Bot√µes de A√ß√£o (+ Anota√ß√£o, + Concha, etc) */
.store-create-btn {
    width: 100%;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px dashed var(--border-color);
    color: var(--text-muted-color);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 15px;
}

.store-create-btn:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

/* --- CARD DE NOTA (Store Note) --- */
.store-note-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
    transition: border-color 0.2s;
}

.store-note-card:hover {
    border-color: var(--accent-color);
}

.store-note-title {
    background: transparent;
    border: none;
    color: var(--text-color);
    font-weight: bold;
    font-size: 1em;
    width: 100%;
    outline: none;
    border-bottom: 1px solid transparent;
}

.store-note-title:focus {
    border-bottom-color: var(--accent-color);
}

.store-note-body {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    color: var(--text-color);
    font-size: 0.9em;
    min-height: 60px;
    outline: none;
    white-space: pre-wrap;
}

/* Rodap√© do Card (Links e Bot√µes) */
.store-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding-top: 8px;
}

.store-links-area {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-grow: 1;
}

.store-link-row {
    display: flex;
    gap: 5px;
    align-items: center;
}

.store-link-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--accent-color);
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.8em;
    width: 80%;
}

.store-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.store-icon-btn:hover { opacity: 1; }

/* --- CARD DE CONCHA (Pasta) --- */
.store-shell-card {
    background-color: rgba(230, 126, 34, 0.1);
    border: 1px solid #e67e22;
    border-radius: 12px; /* Mais redondo como uma concha */
    padding: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s;
}

.store-shell-card:hover {
    background-color: rgba(230, 126, 34, 0.2);
    transform: translateX(5px);
}

.shell-icon { font-size: 1.5em; margin-right: 10px; }
.shell-name { font-weight: bold; color: #e67e22; flex-grow: 1; }

/* --- CARD DE MULTIM√âDIA (Imagem) --- */
.store-media-card {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    position: relative;
}

.store-media-img {
    width: 100%;
    border-radius: 4px;
    display: block;
    margin-bottom: 5px;
}

.store-media-input {
    width: 100%;
    background: var(--panel-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 5px;
    border-radius: 4px;
}

/* Header de Navega√ß√£o (Dentro da Concha) */
.store-nav-header {
    display: flex;
    align-items: center;
    padding: 10px;
    background-color: rgba(230, 126, 34, 0.15);
    border-bottom: 1px solid #e67e22;
    margin-bottom: 10px;
}

/* Bot√£o de Localiza√ß√£o no Card (Aba Par√°grafos) */
.btn-locate-block {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    margin-right: auto; /* Empurra os outros bot√µes para a direita */
}

.btn-locate-block:hover {
    background-color: var(--accent-color);
    color: white;
}

/* Bot√£o de V√≠nculo ao Par√°grafo (Dentro do Card) */
.store-link-indicator-btn {
    background: transparent;
    border: 1px solid var(--text-muted-color); /* Borda cinza subtil */
    color: var(--text-muted-color);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 14px; /* √çcone um pouco maior */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    transition: all 0.2s;
    opacity: 0.7;
}

.store-link-indicator-btn:hover {
    border-color: #2ecc71; /* Verde ao passar o rato */
    color: #2ecc71;
    background: rgba(46, 204, 113, 0.1);
    opacity: 1;
}

/* Input de T√≠tulo no Topo do Aqu√°rio */
.aquarium-header-input {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.2em;
    font-weight: bold;
    text-align: right;
    outline: none;
    width: 300px;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.aquarium-header-input:focus {
    border-bottom-color: var(--accent-color);
}

.aquarium-header-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
}

/* ============================================================
   EFEITO DE BOLHAS DO AQU√ÅRIO
   ============================================================ */
.aquarium-bubble {
    position: fixed;
    bottom: -100px; /* Come√ßa fora do ecr√£ */
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    pointer-events: none; /* N√£o interfere com cliques */
    z-index: 1999999999; /* Logo abaixo do painel do aqu√°rio (2bi) */
    animation: bubbleUp linear forwards;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2);
}

@keyframes bubbleUp {
    0% {
        transform: translateY(0) scale(1);
        opacity: 0;
    }
    10% {
        opacity: 0.6;
    }
    100% {
        transform: translateY(-120vh) scale(1.5);
        opacity: 0;
    }
}

/* Estado Ativo/Focado (Se existir, garantir que √© subtil ou igual ao normal) */
.store-note-card:focus, 
.store-note-card:active {
    border-color: var(--border-color); /* Mant√©m a cor original */
    background-color: var(--panel-color); /* Mant√©m o fundo original */
}

/* Remover sele√ß√£o azul padr√£o do browser */
*:focus {
    outline: none;
}

/* --- AJUSTES MOBILE DO AQU√ÅRIO --- */
@media (max-width: 768px) {
    
    /* 1. Barra de Topo com Scroll Horizontal */
    #aquarium-bar {
        overflow-x: auto;      /* Permite scroll lateral */
        white-space: nowrap;   /* Impede quebra de linha */
        justify-content: flex-start !important; /* Alinha tudo √† esquerda */
        gap: 15px;             /* Espa√ßo entre grupos */
        
        /* Esconde barra de scroll feia */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    #aquarium-bar::-webkit-scrollbar { display: none; }

    /* Garante que os grupos n√£o encolhem */
    .aquarium-nav-group, 
    .aquarium-tools-group {
        flex-shrink: 0;
    }

    /* 2. Reordena√ß√£o do Status "Guardado" */
    /* No HTML original, o status est√° num div separado no fim. Vamos mov√™-lo visualmente. */
    /* Mas como pediu para ficar ao lado do bot√£o íÜú, vamos fazer isso via JS, 
       pois √© mais seguro mover o elemento no DOM do que tentar CSS order complexo */
}

/* Grupo de Navega√ß√£o do Topo (Esquerda) */
.aquarium-nav-group {
    display: flex;
    align-items: center;
    gap: 10px; /* Espa√ßo consistente entre bot√µes */
    flex-shrink: 0;
}

/* Ajuste espec√≠fico para o texto de status no topo */
#aq-save-status {
    white-space: nowrap;
    margin-left: 5px; /* Margem extra para n√£o colar */
    font-weight: 500;
}

/* --- CORRE√á√ÉO DA TOOLBAR JORNAL MOBILE --- */
@media (max-width: 768px) {
    
    /* Garante que o grupo de extras do jornal aparece em linha */
    #group-journal-extras {
        display: none; /* Controlado via JS (displayNote), passa a flex */
        align-items: center;
        flex-shrink: 0; /* Impede que seja esmagado */
    }

    /* Quando ativado pelo JS, for√ßa flex */
    #group-journal-extras[style*="display: flex"] {
        display: flex !important;
    }
    
    /* Ajuste dos bot√µes do jornal para terem tamanho de toque correto */
    #group-journal-extras button {
        min-width: 34px;
        height: 34px;
        margin: 0 2px;
        flex-shrink: 0;
    }

    /* O separador dentro do grupo jornal */
    #group-journal-extras div[style*="width:1px"] {
        height: 20px !important;
        background: rgba(255,255,255,0.2) !important;
        margin: 0 8px !important;
    }
    
    /* Garante que o bot√£o do Redator (no fundo) aparece */
    #btn-insert-redator {
        font-size: 20px !important; /* Um pouco maior no mobile */
        padding: 5px 10px;
    }
}

/* --- CORRE√á√ÉO DE SELE√á√ÉO DE TEXTO EM T√çTULOS (MOBILE) --- */
/* Adicione isto ao seu CSS */
@media (max-width: 768px) {
    
    /* Obriga todas as √°reas de conte√∫do a serem selecion√°veis */
    .mini-note-content,
    .redator-content,
    .cube-content,
    .sign-content,
    .card-desc-content,
    .toggle-content {
        user-select: text !important;
        -webkit-user-select: text !important; /* Essencial para iPhone */
        cursor: text !important;
        pointer-events: auto !important;
        
        /* Garante que o toque √© interpretado como intera√ß√£o e n√£o scroll */
        touch-action: pan-y !important; 
        
        /* Remove qualquer highlight de clique cinzento */
        -webkit-tap-highlight-color: transparent;
        
        /* Garante altura m√≠nima para o dedo acertar */
        min-height: 50px !important;
        
        /* Z-index ligeiramente maior para ficar "acima" do fundo da caixa */
        position: relative !important;
        z-index: 10 !important;
    }

    /* Garante que os inputs de t√≠tulo tamb√©m funcionam */
    .mini-note-title-input, 
    .redator-input {
        pointer-events: auto !important;
        z-index: 10 !important;
    }
}

/* ============================================================
   CORRE√á√ÉO CR√çTICA MOBILE: ESCRITA E MENU NATIVO
   ============================================================ */

/* 1. For√ßa a sele√ß√£o de texto em todos os inputs e √°reas edit√°veis */
.mini-note-title-input,
.mini-note-content,
.redator-input,
.redator-content,
.sign-title-input,
.sign-content,
.card-title-input,
.card-desc-content,
.cube-content,
.toggle-content,
#note-title-input,
.post-title-input,
.post-editor-content {
    /* Permite selecionar texto (iOS e Android) */
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
    
    /* Garante que o toque funciona */
    pointer-events: auto !important;
    cursor: text !important;
    
    /* Remove a cor de toque padr√£o cinzenta */
    -webkit-tap-highlight-color: transparent !important;
    
    /* Garante que o sistema sabe que √© para intera√ß√£o de toque */
    touch-action: manipulation !important;
    
    /* Corrige bug visual no iOS onde o cursor fica escondido */
    transform: translateZ(0); 
}

/* 2. Remove restri√ß√µes dos pais para n√£o bloquear os filhos */
.mini-note-wrapper,
.redator-wrapper,
.journal-sign-wrapper,
.journal-id-card,
.journal-cube-wrapper,
details.toggle-section {
    -webkit-user-select: none; /* O contentor n√£o se seleciona... */
    user-select: none;
}

/* ...Mas o conte√∫do dentro dele SIM: */
.mini-note-wrapper *,
.redator-wrapper *,
.journal-sign-wrapper *,
.journal-id-card *,
.journal-cube-wrapper *,
details.toggle-section * {
    -webkit-user-select: text;
    user-select: text;
}

/* 3. Garante que a Toolbar n√£o rouba o foco */
.mini-note-toolbar,
.redator-dock,
.sign-toolbar,
.card-toolbar,
.cube-toolbar {
    -webkit-user-select: none !important;
    user-select: none !important;
}

/* ============================================================
   CORRE√á√ÉO CR√çTICA MOBILE: MENU NATIVO (COPIAR/COLAR)
   ============================================================ */

/* Aplica-se a todos os inputs, textareas e divs edit√°veis dentro do editor */
#note-content-editor input,
#note-content-editor textarea,
#note-content-editor [contenteditable="true"],
.mini-note-title-input,
.mini-note-content,
.redator-input,
.redator-content,
.sign-title-input,
.sign-content,
.card-title-input,
.card-desc-content,
.cube-content,
.toggle-content,
.post-title-input,
.post-editor-content {
    /* 1. Permite sele√ß√£o de texto (Android/PC) */
    user-select: text !important;
    
    /* 2. Permite sele√ß√£o de texto (iOS Safari) */
    -webkit-user-select: text !important;
    
    /* 3. Permite o menu de contexto/lupa ao segurar (iOS) */
    -webkit-touch-callout: default !important;
    
    /* 4. Garante que o cursor √© de texto */
    cursor: text !important;
    
    /* 5. Garante que o elemento recebe eventos de ponteiro */
    pointer-events: auto !important;
    
    /* 6. Remove a cor de "tap" cinzenta padr√£o no mobile */
    -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
}

/* Garante que o container pai n√£o rouba o clique */
.mini-note-wrapper, 
.redator-wrapper, 
.journal-sign-wrapper, 
.journal-id-card, 
.journal-cube-wrapper {
    /* O pai n√£o √© selecion√°vel (para arrastar) */
    user-select: none;
    -webkit-user-select: none;
}

/* Garante que as vistas da Medusa ocupam o espa√ßo todo sem lixo visual */
.aq-view {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}

#aq-store-view {
    flex-direction: column; /* Necess√°rio para o cabe√ßalho das sub-abas ficar no topo */
}

#note-content-editor, .post-editor-content {
    overflow-anchor: none !important; /* Impede o "Scroll Anchoring" autom√°tico do browser */
}

/* ============================================================
   AJUSTE AUTOM√ÅTICO DO TEXTO NO AQU√ÅRIO (SQUEEZE)
   ============================================================ */

/* Define a transi√ß√£o suave para o texto n√£o saltar bruscamente */
#aquarium-scroll-area {
    transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%; /* Garante que ocupa o espa√ßo */
    box-sizing: border-box;
}

/* QUANDO A ESQUERDA (MEDUSA) EST√Å ABERTA */
#aquarium-environment.left-open #aquarium-scroll-area {
    margin-left: 360px !important; /* Mesma largura da sidebar esquerda */
}

/* QUANDO A DIREITA (REFER√äNCIAS) EST√Å ABERTA */
#aquarium-environment.right-open #aquarium-scroll-area {
    margin-right: 400px !important; /* Mesma largura do painel direito */
}

/* NO MOBILE: Ignora isto (continua a sobrepor para poupar espa√ßo) */
@media (max-width: 768px) {
    #aquarium-environment.left-open #aquarium-scroll-area,
    #aquarium-environment.right-open #aquarium-scroll-area {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Efeito de Flash ao clicar no √çndice */
@keyframes target-flash {
    0% { box-shadow: 0 0 0 rgba(74, 144, 226, 0); border-color: var(--border-color); }
    50% { box-shadow: 0 0 20px rgba(74, 144, 226, 0.6); border-color: var(--accent-color); }
    100% { box-shadow: 0 0 0 rgba(74, 144, 226, 0); border-color: var(--border-color); }
}

.flash-target {
    animation: target-flash 1.5s ease-out;
}

/* --- MODO FLASH (LARANJA) --- */
.folder-mode-item.active.mode-flash {
    color: #e67e22 !important; /* Laranja */
}

.folder-mode-item.active.mode-flash::after {
    background-color: #e67e22 !important;
    height: 3px;
}

/* Estilo Laranja para o bot√£o Adicionar (+) */
#add-item-btn.flash-mode {
    border-color: #e67e22 !important;
    color: #e67e22 !important;
}

#add-item-btn.flash-mode:hover {
    background-color: #e67e22 !important;
    color: white !important;
}

/* Sele√ß√£o Laranja (Modo Flash) */
.list-item.selected-orange {
    background-color: rgba(230, 126, 34, 0.15) !important;
    border-left: 4px solid #e67e22 !important;
    color: white !important;
}

/* Notifica√ß√£o na Aba Share */
.folder-mode-item {
    position: relative; /* Necess√°rio para posicionar a bola */
}

.tab-notification-dot {
    position: absolute;
    top: -2px;
    right: -6px;
    width: 8px;
    height: 8px;
    background-color: #e74c3c;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(231, 76, 60, 0.6);
    display: none; /* Escondido por defeito */
    pointer-events: none;
    animation: pulse-dot 2s infinite;
}

.tab-notification-dot.visible {
    display: block !important;
}

/* No seu <style> */
    #category-search-input {
    background-color: var(--bg-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    cursor: text; /* Garante cursor de texto */
}

#category-search-input:focus {
    border-color: var(--accent-color);
    outline: none;
}

/* Bot√£o de Menu Flutuante (Aparece s√≥ quando colapsado) */
.redator-collapsed-menu-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    cursor: pointer;
    z-index: 15;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.redator-collapsed-menu-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

/* Mostra o bot√£o APENAS quando o cabe√ßalho est√° escondido */
.redator-wrapper.header-hidden .redator-collapsed-menu-btn {
    opacity: 1;
    pointer-events: auto;
}

/* Ajuste do Menu Deslizante (Agora relativo ao Wrapper, n√£o ao Header) */
.redator-slide-menu {
    top: 5px !important;       /* Cola ao topo da caixa */
    right: 35px !important;    /* Fica √† esquerda dos 3 pontos */
    z-index: 50 !important;    /* Garante que fica por cima de tudo */
}

/* Bot√£o de Link Externo nas Listas */
.external-open-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 14px;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: auto; /* Empurra para a direita */
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.external-open-btn:hover {
    color: var(--accent-color);
    background-color: var(--hover-color);
    transform: scale(1.1);
}

/* Estilo para Links de Texto no Aqu√°rio (Subtil) */
 a.silent-link {
    color: inherit !important;
    text-decoration: none !important;
    cursor: text !important;
    
    /* Garante que o texto flui normalmente sem criar degraus */
    display: inline !important;
    line-height: inherit !important;
    vertical-align: baseline !important;

    /* Pequeno espa√ßo f√≠sico entre frases coladas */
    margin: 0 2px !important; 
    padding: 0 2px !important; 
    border-radius: 3px;

    /* Garante que a cor segue a frase se ela mudar de linha */
    -webkit-box-decoration-break: clone !important;
    box-decoration-break: clone !important;

    transition: all 0.2s;
}

/* 2. √çMPARES (1¬∫, 3¬∫...): ROXO SUAVE */
a.silent-link:nth-of-type(odd) {
    background-color: rgba(155, 89, 182, 0.15) !important; /* Roxo Transl√∫cido */
    border-bottom: 1px dotted rgba(155, 89, 182, 0.6) !important;
}

/* 3. PARES (2¬∫, 4¬∫...): VERDE TURQUESA */
a.silent-link:nth-of-type(even) {
    background-color: rgba(26, 188, 156, 0.15) !important; /* Verde Transl√∫cido */
    border-bottom: 1px dotted rgba(26, 188, 156, 0.6) !important;
}

/* 4. HOVER (Ao passar o rato) */
a.silent-link:hover {
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    border-bottom-style: solid !important;
    box-shadow: 0 0 8px rgba(255,255,255,0.1);
    opacity: 1 !important;
    z-index: 10;
    position: relative;
}


.dynamic-url-row {
    display: flex;
    gap: 5px;
    align-items: center;
}

.dynamic-url-row input {
    flex-grow: 1;
    padding: 8px;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-color);
}

.btn-remove-url {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid #e74c3c;
    color: #e74c3c;
    width: 34px;
    height: 34px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.btn-remove-url:hover {
    background: #e74c3c;
    color: white;
}

/* Bot√£o de Lixo no Modal de Links */
.btn-delete-link-ref {
    background-color: transparent;
    border: 1px solid #c0392b;
    color: #c0392b;
    font-size: 18px;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-right: auto; /* Empurra os outros bot√µes para a direita */
    transition: all 0.2s;
}

.btn-delete-link-ref:hover {
    background-color: #c0392b;
    color: white;
}

/* Contentor Lateral (Agrupa Setas e +) */
.ghost-side-controls {
    position: absolute;
    left: -22px;
    top: 0;           /* Come√ßa no topo */
    bottom: 0;        /* Vai at√© ao fundo */
    height: 100%;     /* Garante altura total */
    
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* CENTRA AS SETAS VERTICALMENTE */
    gap: 4px;
    z-index: 100;
    
    user-select: none;
    -webkit-user-select: none;
    pointer-events: none; /* O contentor √© invis√≠vel ao clique */
}

/* Mostra quando ativo */
.ghost-block.active-selection .ghost-side-controls {
    display: flex !important;
    animation: fadeIn 0.2s ease;
}

/* Bot√µes de Seta */
.ghost-move-btn {
    pointer-events: auto; /* Reativa cliques nos bot√µes */
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    border-radius: 4px;
}
.ghost-move-btn:hover { color: var(--accent-color); background-color: rgba(255, 255, 255, 0.1); }

/* Bot√£o Adicionar (+) - POSICIONADO NO FUNDO */
.ghost-add-between-btn {
    position: absolute; /* Sai do fluxo flex */
    bottom: -12px;      /* Cola ao fundo (ajuste fino para alinhar com a borda) */
    left: 50%;
    transform: translateX(-50%); /* Centra horizontalmente */
    
    pointer-events: auto; /* Reativa cliques */
    
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.ghost-add-between-btn:hover {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
    transform: translateX(-50%) scale(1.1); /* Mant√©m centrado ao aumentar */
}

.ghost-add-between-btn::before {
    content: '+';
    font-size: 16px;
    line-height: 1;
    margin-top: -1px;
}

</style>




</head>
<body>

    <div class="notebook-container">
        <!-- PAINEL DA ESQUERDA -->
    <aside id="left-panel">
    <button id="left-panel-toggle-btn" title="Mostrar Painel">‚ò∞</button>
    
    <!-- WRAPPER DE CONTE√öDO (Mant√©m tudo alinhado no topo) -->
    <div class="panel-content">
        
        <!-- 1. Tabs (Note, Lists, Book) -->
        <div class="tabs-container">
            <button class="active" data-tab="note">Note</button>
            <button data-tab="lists">Lists</button>
            <button data-tab="book">Book</button>
        </div>
        
        <hr>
        
        <!-- 2. O Cabe√ßalho com o Seletor (TEM DE ESTAR ANTES DA LISTA) -->
        <div class="panel-header">
            <div id="left-panel-title" class="folder-mode-container">
                <!-- O JavaScript vai preencher isto, mas deixamos o padr√£o aqui -->
                <span class="folder-mode-item active" onclick="window.switchFolderView('local')">Local</span>
                <span class="folder-mode-separator">|</span>
                <span class="folder-mode-item" onclick="window.switchFolderView('shared')">Partilha</span>
                <span class="folder-mode-separator">|</span>
    <span class="folder-mode-item" onclick="window.switchFolderView('pins')">Pins</span>
            </div>
        </div>
        
        <!-- 3. A Lista de Pastas (Ocupa o espa√ßo restante) -->
        <ul id="left-panel-list">
            <!-- Itens da coluna esquerda gerados via JS -->
        </ul>
    </div>

    <!-- 4. Rodap√© (Fixo em baixo) -->
    <div class="panel-footer">
        <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
        <button id="global-search-btn" title="Pesquisa Global">üîé</button>
        <button id="account-btn" title="Minha Conta">üë§</button>
    </div>
</aside>

      <!-- PAINEL DO MEIO -->
     <main id="middle-panel">
    <!-- Cabe√ßalho (Mant√©m-se igual) -->
    <div class="panel-header">
        <button id="back-btn" title="Voltar">‚Üê</button>
        <button id="middle-panel-toggle-btn" title="Expandir/Recolher" style="margin-right: 10px;">‚Üñ</button>
        <h2 id="middle-panel-title">Selecione</h2>
        <button id="add-item-btn" title="Adicionar item">+</button>
    </div>

    <!-- √ÅREA DE CONTE√öDO (VISTAS) -->
    <div id="middle-views-container">
        
        <!-- VISTA 1: PASTAS (Padr√£o) -->
        <ul id="file-list" class="middle-view active">
            <!-- Lista de ficheiros aparece aqui -->
        </ul>

        <!-- VISTA 2: √çNDICE (Estrutura da Nota) -->
        <ul id="note-index-list" class="middle-view" style="display: none;">
            <li class="empty-msg">Nenhuma estrutura detetada.</li>
        </ul>

      <!-- VISTA 3: TEXTOS -->
<div id="note-texts-view" class="middle-view" style="display: none;">
    <!-- O JavaScript vai preencher isto automaticamente -->
</div>

        <!-- VISTA 4: FONTES (Links/Codex das Caixas) -->
        <ul id="note-sources-list" class="middle-view" style="display: none;">
            <li class="empty-msg">Nenhuma fonte vinculada (‚ö°).</li>
        </ul>
    </div>

    <!-- BARRA DE ABAS DO FUNDO -->
    <div class="middle-bottom-tabs">
        <button class="active" data-mid-tab="files" title="Ficheiros">
            <span>üìÇ</span> Pastas
        </button>
        <button data-mid-tab="index" title="Estrutura da Nota">
            <span>‚âî</span> √çndice
        </button>
        <button data-mid-tab="texts" title="Textos B√≠blicos/Outros">
            <span>üìú</span> Textos
        </button>
        <button data-mid-tab="sources" title="Fontes e Refer√™ncias">
            <span>‚ö°</span> Fontes
        </button>
    </div>
</main>

 <!-- PAINEL DA DIREITA - EDITOR -->
      <!-- PAINEL DA DIREITA - EDITOR -->
<section id="right-panel">

    <!-- ECR√É DE BOAS-VINDAS (Placeholder) -->
    <div id="editor-placeholder">
        <div class="placeholder-icon">üìñ</div>
        <h2>Selecione uma nota para come√ßar</h2>
        <p>Ou crie uma nova pasta e uma nota.</p>
    </div>
    
    <!-- √ÅREA DO EDITOR (NOTA NORMAL) -->
    <div id="editor-area" style="display: none; flex-direction: column; height: 100%;">
        
        <!-- √ÅREA DE FERRAMENTAS -->
        <div id="toolbar-container">
            <div id="editor-toolbar">
                
                <!-- √ÅREA DE SCROLL (NO MOBILE) / CONTE√öDO NORMAL (NO PC) -->
                <div class="tools-scroll-container">
                    
                    <!-- GRUPO 1: Formata√ß√£o -->
                    <div class="toolbar-group">
                        <button data-command="bold" title="Negrito"><b>B</b></button>
                        <button data-command="boldBlue" title="Negrito Azul" style="color: #4a90e2; font-weight: bold; position: relative; padding-right: 15px; display: flex; align-items: center; justify-content: center;"> B <span class="dots-trigger">‚Ä¢‚Ä¢</span> </button>
                        <button data-command="italic" title="It√°lico" style="position: relative; padding-right: 15px; display: flex; align-items: center; justify-content: center;"> <i>I</i> <span class="dots-trigger">‚Ä¢‚Ä¢</span> </button>
                        <button data-command="underline" title="Sublinhado"><u>U</u></button>
                        <button id="toggle-more-tools-btn" title="Mais Ferramentas" style="font-size: 12px; background-color: rgba(255,255,255,0.1);">‚ñº</button>
                    </div>
                    
                    <div class="toolbar-separator"></div>
                    
                    <!-- GRUPO 2: A√ß√µes -->
                    <div class="toolbar-group">
                        <button data-action="show-explorer" title="Explorador">üîç</button>
                        <button data-action="show-attachments" title="Anexos">üìé</button>
                        <button data-command="undo" title="Retroceder">‚Ü©Ô∏è</button>
                        <button data-command="redo" title="Refazer">‚Ü™Ô∏è</button>
                    </div>

                    <div class="toolbar-separator mobile-only"></div>

                    <!-- BARRA SECUND√ÅRIA -->
                    <div id="secondary-toolbar" style="display: none;">
                        
                        <!-- Grupo 3: Estilo e Cor -->
                        <div class="toolbar-group" id="group-style">
                            <select id="editor-zoom" title="Zoom">
                                <option value="12px">50%</option>
                                <option value="100%" selected>100%</option>
                                <option value="18px">110%</option>
                                <option value="24px">150%</option>
                            </select>
                            <select id="editor-format" title="Estilo" style="width: 90px;">
                                <option value="P" selected>¬∂ Normal</option>
                                <option value="H1">A1 T√≠tulo</option>
                                <option value="H2">A2 T√≠tulo</option>
                                <option value="H3">A3 T√≠tulo</option>
                            </select>
                            <input type="color" data-command="foreColor" title="Cor" style="margin: 0 5px;">
                            
                            <!-- √çcones que se movem no Jornal -->
                            <button data-action="insert-toggle-h2" title="Toggle">‚òÇ</button>
                            <button data-action="make-draggable" title="Arrastar">·Øì</button>
                        </div>
                        
                        <div class="toolbar-separator"></div>

                        <!-- Grupo 4: Widgets Simples -->
                        <div class="toolbar-group" id="group-simple">
                            <button data-action="insert-checkbox" title="Check">‚òëÔ∏è</button>
                            <button data-cmd-sec="insertHorizontalRule" title="Linha">‚Äï</button>
                        </div>

                        <div class="toolbar-separator"></div>

                        <!-- Grupo 4b: Widgets Complexos -->
                        <div class="toolbar-group" id="group-complex">
                            <button data-action="insert-table" title="Tabela">üßÆ</button>
                            <button data-action="insert-date" title="Data">üìÖ</button>
                            <button data-action="insert-timeline" title="Timeline">üå≥</button>
                        </div>

                        <div class="toolbar-separator"></div>

                        <!-- NOVO GRUPO JORNAL (Escondido por padr√£o) -->
                        <div class="toolbar-group" id="group-journal-extras" style="display: none; align-items: center;">
                            <button data-action="insert-2-cols" title="Duas Colunas">‚è∏Ô∏è</button>
                            <div style="width:1px; height:20px; background:var(--border-color); margin:0 6px;"></div>
                            <button data-action="insert-image" title="Imagem">üñºÔ∏è</button>
                            <button data-action="insert-sign" title="Bloco de Racioc√≠nio">ü™ß</button>
                            <button data-action="insert-card" title="Cart√£o Tem√°tico">ü™™</button>
                            <button data-action="insert-cube" title="Cubo">üßä</button>
                        </div>

                        <div class="toolbar-separator" id="sep-journal-extras" style="display: none;"></div>

                        <!-- Grupo 5: Avan√ßado (Fixo) -->
                        <div class="toolbar-group">
                            <button data-action="bible-scan" title="Scanner">üé∞</button>
                            <button id="more-formatting-btn" type="button" data-action="more-formatting" title="Mais Formata√ß√µes" style="font-weight: bold; font-size: 18px;">‚ãÆ</button>
                        </div>
                    </div>
                </div>

                <!-- GRUPO DE NAVEGA√á√ÉO E HIST√ìRICO -->
                <div class="toolbar-history-group">
                    <div style="display:flex; align-items:center; gap: 10px;">
                        <button id="mobile-back-btn" title="Voltar" style="display: none;">‚¨Ö</button>
                        <!-- BOT√ÉO DE VISTAS MOBILE -->
                        <button id="mobile-views-btn" title="Vistas" style="display:none; background:none; border:none; font-size:22px; color:var(--text-color); cursor:pointer;">‚õ∂</button>
                    </div>

                    <span id="save-status-indicator" class="save-status"></span>
                    
                    <div style="display: flex; gap: 5px;">
                        <!-- √çcone do Redator (oculto por padr√£o, aparece em Jornal) -->
                        <button id="btn-insert-redator" data-action="insert-redator" title="Inserir Redator" style="display: none; background:none; border:none; font-size:18px; cursor:pointer;">üìì</button>
                        
                        <button data-action="note-sharing-settings" title="Partilha">üîê</button> 
                        <button data-action="show-topics" title="T√≥picos">üìë</button> 
                        <button data-action="show-history" title="Hist√≥rico">üïí</button>
                    </div>
                </div>
            </div> <!-- FECHO EDITOR TOOLBAR -->
        </div> <!-- FECHO TOOLBAR CONTAINER -->

        <!-- INPUT T√çTULO -->
        <input type="text" id="note-title-input" placeholder="T√≠tulo da nota...">
        
        <!-- EDITOR DE CONTE√öDO -->
        <div id="note-content-editor" contenteditable="true" spellcheck="true"></div>

        <!-- >>> NOVO: PAINEL DE LOADING DE SINCRONIZA√á√ÉO <<< -->
        <div id="editor-sync-overlay">
            <div class="sync-message">
                <div class="spinner" style="width:20px; height:20px; border-width:2px; margin:0;"></div>
                <span>A atualizar conte√∫do...</span>
            </div>
        </div>

    </div>

    <!-- √ÅREA DE ARQUIVO (FEED) -->
    <div id="archive-area" style="display: none; flex-direction: column; height: 100%; position: relative;">
        <div id="archive-mobile-nav" style="display: none; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--panel-color);">
            <button id="archive-back-btn" style="background: none; border: none; font-size: 22px; color: var(--accent-color); cursor: pointer; padding: 0;">‚¨Ö</button>
            <span style="margin-left: 15px; font-weight: bold; color: var(--text-color);">Arquivo</span>
        </div>

        <div id="collab-bar" style="display:none; align-items: center; padding: 10px 20px; gap: 10px; background: rgba(74, 144, 226, 0.05); border-bottom: 1px solid var(--border-color);">
            <span style="font-size: 0.7em; color: var(--text-muted-color); text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">Online agora:</span>
            <div id="active-users-list" style="display: flex; gap: 5px;"></div>
        </div>

        <div style="padding: 20px 20px 10px 20px;">
            <input type="text" id="archive-title-input" placeholder="T√≠tulo do Arquivo..." 
                   style="width: 100%; background: none; border: none; border-bottom: 1px solid var(--border-color); color: var(--text-color); font-size: 2.5em; font-weight: bold; outline: none; padding-bottom: 5px;">
        </div>

        <div id="archive-toolbar" style="padding: 10px 20px; display: flex; align-items: center; justify-content: flex-end; margin-bottom: 5px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="archive-save-status" class="save-status" style="margin: 0; font-size: 0.8em; font-style: italic;">Guardado</span>
                <div style="display: flex; gap: 10px;">
                    <button data-action="archive-share" title="Partilha" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted-color);">üîì</button>
                    <button data-action="archive-topics" title="T√≥picos" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted-color);">üìë</button>
                    <button data-action="archive-history" title="Hist√≥rico/Reciclagem" style="background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted-color);">üïí</button>
                </div>
            </div>
        </div>

        <div class="archive-tabs" style="padding: 0 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border-color);">
            <button class="archive-tab-btn active" data-archive-tab="prateleira">Prateleira</button>
            <button class="archive-tab-btn" data-archive-tab="gavet√µes">Gavet√£o</button>
            <button id="create-post-btn" class="archive-inline-create-btn">+ Post</button>
            <button id="create-drawer-trigger-btn" class="archive-inline-create-btn" style="display: none;">+ Gavet√£o</button>
            <button id="create-separator-btn" class="archive-inline-create-btn" style="display: none; background-color: #2ecc71;">+ Separador</button>
        </div>

        <div id="archive-feed" style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; display: flex; flex-direction: column; gap: 20px;">
            <!-- Posts inseridos aqui -->
        </div>
    </div>
</section>

        <!-- PAINEL DA DIREITA (QUARTA COLUNA) PARA REFER√äNCIAS -->
        <aside id="references-panel">
            <div class="panel-header">
                <h2 id="references-panel-title">Refer√™ncias</h2>
                <button id="references-panel-close-btn" title="Fechar">√ó</button>
            </div>
            
            <p id="references-panel-description"></p>
            
            <hr class="references-separator">
            <div id="references-toolbar">
                <button id="references-refresh-btn" title="Atualizar">üîÑ</button>
                <button id="references-wol-btn" title="Ler na WOL" style="display: none;">üìñ</button>
                <button id="references-search-btn" title="Pesquisar na JW">üîç</button>
                 <button id="references-anchor-btn" title="Anexar √Çncora" style="display: none;">‚öì</button>
                <button id="references-edit-btn" title="Editar">‚úèÔ∏è</button>
                <button id="references-bookmark-btn" title="Marcadores" style="display: none;">üîñ</button> 
                <button id="references-toggle-btn" title="Expandir/Recolher">‚ÜïÔ∏è</button>
            </div>
            <hr class="references-separator">

       <div class="tabs-container" id="ref-tabs">
                <button class="active" data-ref-tab="puzzle">üß© Puzzle</button>
                <button data-ref-tab="links">‚ö° Links</button>
                <button data-ref-tab="dossie">üìº Dossi√©</button>
                <button data-ref-tab="references">‚ùù Cita</button>
            </div>

            <!-- ABA 1: PUZZLE (QUADRO) -->
            <div id="ref-content-puzzle" class="ref-tab-content active" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 0 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Quadro</h3>
                    <div id="puzzle-header-actions" style="display:flex; gap: 5px; align-items: center;">
                        <div id="puzzle-add-buttons" style="display:none; gap:5px;">
                            <button id="teleport-puzzle-btn" title="Converter em Nota" style="background-color: #8e44ad; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">üì°</button>    
                            <button id="add-text-btn" title="Adicionar Texto" style="background-color: #3498db; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; display: flex; align-items: center;">+ Txt</button>
                            <button id="add-ref-btn" title="Adicionar Refer√™ncia Existente" style="background-color: #2ecc71; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; display: flex; align-items: center;">+ Ref</button>
                        </div>
                        <button id="toggle-puzzle-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>

                <div id="puzzle-board-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;">
                    <p id="puzzle-empty-msg" style="font-style:italic; color:var(--text-muted-color); font-size:0.9em; text-align:center;">
                        O quadro est√° vazio. Clique em "Editar" para adicionar notas ou refer√™ncias.
                    </p>
                </div>
            </div>

            <!-- ABA 2: DOSSI√â (MICAS) -->
            <div id="ref-content-dossie" class="ref-tab-content" style="display: none; flex-direction: column; padding: 0 10px; flex-grow: 1; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 id="dossie-view-title" style="color:var(--text-color); margin:0; font-size: 1.1em;">Micas</h3>
                    <div style="display:flex; gap: 5px; align-items: center;">
                        <button id="mica-back-btn" class="panel-action-btn-styled" style="display:none; background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color); height:30px;">Back</button>
                       <button id="mica-add-bible-btn" class="panel-action-btn-styled" style="display:none; background-color: #5d4037; color: white; height:30px;">+B√≠blia</button>
                        <button id="mica-add-content-btn" class="panel-action-btn-styled btn-green" style="display:none; height:30px;">+ Add</button>
                        <div id="dossie-edit-actions" style="display:none;">
                            <button id="add-mica-btn" class="panel-action-btn-styled btn-orange-dark" style="height:30px;">+ Micas</button>
                        </div>
                        <button id="toggle-dossie-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>
                <div id="dossie-list-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;"></div>
            </div>

            <!-- ABA 3: CITA (REFER√äNCIAS) -->
            <div id="ref-content-references" class="ref-tab-content" style="flex-grow: 1; overflow-y: auto; display: none;">
                <ul id="references-list"></ul>
            </div>

            <!-- ABA 4: LINKS (DOC.) -->
            <div id="ref-content-links" class="ref-tab-content" style="display: none; flex-direction: column; padding: 0 10px; flex-grow: 1; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Doc.</h3>
                    <div style="display:flex; gap: 5px; align-items: center;">
                        <div id="links-edit-actions" style="display:none; gap:5px;">
                            <button onclick="window.openPanelLinkCreator('link')" class="panel-action-btn-styled btn-brown">+ Link</button>
                            <button onclick="window.openPanelLinkCreator('codex')" class="panel-action-btn-styled btn-orange-dark">+ Codex</button>
                        </div>
                        <button id="toggle-links-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>
                <div id="panel-links-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </aside>

    </div> 

    <!-- MODAIS E POPUPS GLOBAIS -->
    <div id="post-type-popup" class="modal-overlay" style="z-index: 2100;">
        <div class="modal-content" style="max-width: 300px; text-align: center;">
            <h3>Novo Post</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <button class="modal-btn" id="gen-text-btn" style="padding: 15px; text-align: left;">üìù Gerar Texto</button>
                <button class="modal-btn" id="gen-entity-btn" style="padding: 15px; text-align: left;">üõ∏ Gerar Entidade</button>
            </div>
            <button class="modal-btn secondary" onclick="document.getElementById('post-type-popup').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="entity-type-popup" class="modal-overlay" style="z-index: 2200;">
        <div class="modal-content" style="max-width: 300px;">
            <h3>Escolher Entidade</h3>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                <button class="modal-btn" onclick="createArchiveEntity('subnota')">üìò Subnota</button>
                <button class="modal-btn" onclick="createArchiveEntity('question')">üìó Quest√£o</button>
                <button class="modal-btn" onclick="createArchiveEntity('free')">üìô Contentor</button>
                <button class="modal-btn" onclick="createArchiveEntity('toggle')">‚òÇ T√≠tulo Toggle</button>
                <button class="modal-btn" onclick="createArchiveEntity('idea')">üí° Ideia</button>
            </div>
            <button class="modal-btn secondary" onclick="document.getElementById('entity-type-popup').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="puzzle-ref-selection-modal" class="modal-overlay" style="z-index: 2300;">
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3>Escolher Refer√™ncia</h3>
            <p style="font-size:0.9em; color:var(--text-muted-color); margin-bottom:10px;">Selecione uma ocorr√™ncia para adicionar ao Quadro:</p>
            <ul id="puzzle-ref-selection-list" class="move-list" style="flex-grow: 1; overflow-y: auto;"></ul>
            <div class="modal-actions" style="margin-top: 15px;">
                <button class="modal-btn secondary" onclick="document.getElementById('puzzle-ref-selection-modal').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="selection-popup" style="display: none; position: absolute; z-index: 1010;">
        <button data-action="create-link" title="Criar Link / Anexo">üîó</button>
        <button data-action="break-link" title="Remover Link">‚õìÔ∏è‚Äçüí•</button> 
        <button data-action="create-entity" data-type="local" title="Local">üìç</button>
        <button data-action="create-entity" data-type="personagem" title="Personagem">üë§</button>
        <button data-action="create-entity" data-type="data" title="Data">üìÖ</button>
        <button data-action="create-entity" data-type="textobiblico" title="Texto B√≠blico">üìñ</button>
        <div class="popup-separator"></div>
        <button data-action="highlight" title="Criar Post-it">üìí</button>
        <button data-action="create-idea" title="Converter em Ideia">üí°</button>
        <button data-action="create-url-card" title="Criar Cart√£o Web">üé¥</button>
    </div>

  <div id="insertion-popup" style="display: none; position: absolute; z-index: 1010;">
    <button data-action="quick-mini-note" title="Inserir Mini-Nota">üìò</button>
    <button data-action="insert-question" title="Inserir Quest√£o">üìó</button>
    <button data-action="insert-free-container" title="Inserir Contentor Livre">üìô</button>
    <button id="popup-btn-redator" data-action="insert-redator" title="Inserir Redator" style="display: none;">üìì</button>
    <div class="popup-separator"></div>
    <button data-action="quick-placeholder" title="Inserir Post-it">üìí</button>
    <button id="popup-btn-sign" data-action="insert-sign" title="Inserir Racioc√≠nio" style="display: none;">ü™ß</button>
</div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Adicionar Item</h3>
            <div id="add-item-options">
                 <button data-type="pasta">üìÅ Criar Pasta</button>
                 <button data-type="nota">üìÑ Criar Nota</button>
                 <button data-type="agregacao">üß¨ Criar Agrega√ß√£o</button>
                 <button data-type="arquivo">üóÑÔ∏è Criar Arquivo</button>
                 <button data-type="jornal">üì∞ Criar Jornal</button>
                  <button data-type="aquario">ü™∏ Criar Aqu√°rio</button>
            </div>
            <input type="text" id="new-item-name" placeholder="Nome do item" style="display: none;">
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-item-addition" style="display: none;">Criar</button>
            </div>
        </div>
    </div>

 <div id="context-menu" class="context-menu">
    <div class="context-menu-grid">
        <!-- GRUPO 1: Identidade -->
        <button data-action="rename">Mudar Nome</button>
        <button data-action="toggle-pin">Adicionar Pin</button>
        <button data-action="protect">Proteger</button>
        <button data-action="unprotect" style="display:none;">Tirar Prote√ß√£o</button>
        
        <hr class="menu-sep">
        
        <!-- GRUPO 2: Organiza√ß√£o -->
        <button data-action="move-position">Mover Posi√ß√£o</button>
        <button data-action="move-folder">Mover de Pasta</button>
        
        <hr class="menu-sep">
        
        <!-- GRUPO 3: Atribui√ß√µes -->
        <button data-action="manage-topics">Anexar T√≥pico</button>
        <button data-action="toggle-superfolder">Superpasta</button>
        <button data-action="change-icon" style="display: none;">Mudar Icon</button>
        
        <hr class="menu-sep">
        
        <!-- GRUPO 4: Perigo -->
        <button data-action="hide" style="color: #e74c3c;">Ocultar Item</button>
        <button class="context-menu-close" onclick="hideContextMenu()">Cancelar</button>
    </div>
</div>

    <div id="move-to-folder-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover para a Pasta</h3>
            <p>Selecione a pasta de destino para "<span id="item-to-move-name"></span>".</p>
            <div id="move-modal-current-path"></div>
            <ul id="folder-selection-list" class="move-list" style="max-height: 50vh;"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-folder-move">Mover</button>
            </div>
        </div>
    </div>

    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover Item</h3>
            <ul id="move-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="save-order">Salvar Ordem</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title">Voc√™ tem certeza?</h3>
            <p id="confirm-message">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="confirm">Confirmar</button>
            </div>
        </div>
    </div>




    <!-- MODAL DE CONFIGURA√á√ïES -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal-content settings-expanded">
        <!-- Cabe√ßalho com T√≠tulo e Bot√£o X -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
            <h3 style="margin: 0;">Configura√ß√µes</h3>
            <button data-action="cancel" style="background: none; border: none; color: var(--text-muted-color); font-size: 28px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- √Årea de Conte√∫do com Scroll -->
        <div class="modal-scroll-area">
            <button class="modal-btn primary" data-action="show-hidden-items" style="width: 100%; margin-bottom: 20px;">
                Ver Pastas Ocultas
            </button>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
            
            <h4 style="margin-bottom: 10px; color: var(--accent-color);">Privacidade & Pesquisa</h4>
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
                Defina se os itens protegidos com palavra-passe devem aparecer no Painel de Refer√™ncias.
            </p>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-tags">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>Tags</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-topics">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>T√≥picos</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-anchors">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>√Çncoras</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-global-search-superfolder">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>Globalmente</strong> dentro de Superpastas</span>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: var(--accent-color);">T√≠tulos Entidades</h4>
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
                Permite que os t√≠tulos de Quest√µes e Subnotas ocupem v√°rias linhas se o texto for grande.
            </p>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-full-titles">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Mostrar T√≠tulo Completo de Entidade</span>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel" style="width: 100%;">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL MINHA CONTA -->
<div id="account-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Minha Conta</h3>
        
        <div class="profile-info">
            <span class="profile-avatar">üë§</span>
            <span id="profile-name-display" class="profile-name">Carregando...</span>
            <span id="profile-email-display" class="profile-email">...</span>
        </div>

        <button class="modal-btn secondary" id="logout-btn" style="width: 100%; background-color: #c0392b; color: white;">
            Sair da Conta (Logout)
        </button>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

    <!-- MODAL DE ITENS OCULTOS -->
    <div id="hidden-items-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Itens Ocultos</h3>
            <ul id="hidden-items-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR/EDITAR LINK (ANEXO) -->
<div id="link-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 650px; width: 95%;">
        <h3 id="link-modal-title">Gest√£o</h3>
        
        <!-- ABAS ATUALIZADAS -->
        <div class="tabs-container" id="box-link-tabs" style="margin-top: 15px;">
            <button class="active" data-box-tab="refs">Refer√™ncias</button>
            <button data-box-tab="codex">Codex</button>
            <button data-box-tab="categories">Categorias</button> <!-- NOVA ABA -->
        </div>

        <!-- CONTE√öDO ABA REFER√äNCIAS -->
        <div id="box-content-refs" class="box-tab-content">
            <div style="margin-top: 15px;">
                <label style="font-size: 0.85em; color: var(--text-muted-color);">T√≠tulo do Grupo</label>
                <input type="text" id="link-title-input" placeholder="T√≠tulo do anexo">
                <div id="link-urls-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; mt: 10px;"></div>
                <button id="add-url-btn" class="modal-btn" style="width: 100%; background-color: var(--hover-color); text-align: center;">+ Adicionar URL</button>
            </div>
        </div>

        <!-- CONTE√öDO ABA CODEX -->
        <div id="box-content-codex" class="box-tab-content" style="display: none; margin-top: 15px;">
            <div id="codex-rows-container" style="display: flex; flex-direction: column; gap: 15px; max-height: 40vh; overflow-y: auto; padding-right: 5px;"></div>
            <button id="add-codex-row-btn" class="modal-btn" style="width: 100%; margin-top: 10px; border: 1px dashed var(--accent-color); color: var(--accent-color);">+ Adicionar Nova Linha Codex</button>
        </div>

        <!-- NOVA ABA: CONTE√öDO CATEGORIAS -->
    <div id="box-content-categories" class="box-tab-content" style="display: none; margin-top: 15px;">
    <input type="text" id="category-search-input" placeholder="Pesquisar categoria..." 
           style="width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: white;">
    
    <!-- NOVO: Toggle Procurar na B√≠blia -->
    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 0 5px;">
        <label class="setting-switch">
            <input type="checkbox" id="search-bible-toggle">
            <span class="slider round"></span>
        </label>
        <span style="font-size: 0.85em; color: var(--text-muted-color);">Procurar na B√≠blia (Biblioteca Global)</span>
    </div>
    
    <div id="category-search-results" style="max-height: 200px; overflow-y: auto; margin-top: 10px; border-bottom: 1px solid var(--border-color);"></div>
            
            <div style="margin-top: 15px;">
                <label style="font-size: 0.85em; color: var(--text-muted-color); text-transform: uppercase; font-weight: bold;">Categorias Anexadas:</label>
                <div id="attached-categories-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; min-height: 40px;">
                    <!-- Chips das categorias aparecer√£o aqui -->
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="modal-btn" id="link-remove-btn" style="background-color: #c0392b; color: white; display: none;">Limpar Tudo</button>
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="link-save-btn">Gravar</button>
        </div>
    </div>
</div>

    <!-- MODAL PARA CRIAR ENTIDADE (Local, Personagem, Data) -->
    <div id="entity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="entity-modal-title">Criar Entidade</h3>
            <input type="text" id="entity-name-input" placeholder="Nome">
            <textarea id="entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 80px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
            <p id="entity-error-message" style="color: #e74c3c; display: none;">J√° existe uma entidade com este nome.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="entity-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA LISTAS (Tags, Anexos, etc.) -->
    <div id="generic-list-modal" class="modal-overlay">
    <div id="generic-list-modal-content" class="modal-content">
        <h3 id="generic-list-title">Lista</h3>
        <ul id="generic-list-content" class="move-list" style="max-height: 60vh;">
            <!-- O conte√∫do ser√° preenchido via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>
    <!-- MODAL DE √ÇNCORAS COM ABAS -->
   <div id="anchors-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; display: flex; flex-direction: column; max-height: 85vh;">
        <h3 id="explorer-title">Pesquisa Global</h3>
        
        <div id="anchors-content-container" style="flex-grow: 1; overflow-y: auto; margin-top: 15px;">
            <!-- Onde a pesquisa ou os filtros aparecer√£o -->
        </div>

  <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; align-items: center; justify-content: flex-end;">
    
    <!-- Bot√£o Filtros -->
    <button id="toggle-search-filters-btn" class="modal-btn secondary">‚öôÔ∏è Filtros</button>
    <!-- Bot√£o Escopo (Aparece via JS) -->
    <button id="search-scope-btn" title="Alternar escopo de pesquisa">
        <span>No Par√°grafo</span>
    </button>
    <div style="flex-grow: 1;"></div> <!-- Empurra o bot√£o Fechar para a direita -->
    <button class="modal-btn secondary" data-action="cancel">Fechar</button>
</div>



    <!-- MODAL PARA EDITAR ENTIDADE -->
<div id="edit-entity-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="edit-entity-title">Editar Entidade</h3>
        <input type="text" id="edit-entity-name-input" placeholder="Nome da entidade">
        
        <!-- NOVO: Sec√ß√£o de Emoji exclusiva para Subtemas -->
        <div id="edit-emoji-container" style="display: none; margin-bottom: 20px;">
    <label style="display:block; margin-bottom:10px; font-size: 0.85em; color: var(--text-muted-color);">Mudar Emoji:</label>
    <input type="text" id="edit-emoji-input" maxlength="5" 
           style="width: 70px; height: 70px; text-align: center; font-size: 35px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; color: white; outline: none; transition: border-color 0.2s;"
           onfocus="this.style.borderColor='var(--accent-color)'" 
           onblur="this.style.borderColor='var(--border-color)'">
</div>

        <textarea id="edit-entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 120px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="edit-entity-save-btn">Gravar Altera√ß√µes</button>
        </div>
    </div>
</div>


    <!-- POPUP DE SUGEST√ÉO DE TAGS (escondido por padr√£o) -->
<div id="tag-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="tag-suggestion-list" class="suggestion-list"></ul>
</div>

<!-- POPUP DE SUGEST√ÉO DE ENTIDADES (escondido por padr√£o) -->
<div id="entity-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="entity-suggestion-list" class="suggestion-list"></ul>
</div>


<!-- NOVO MODAL DE HIST√ìRICO ORGANIZADO POR ABAS -->
<div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        <h3 id="history-modal-title">Gest√£o da Nota</h3>
        
        <!-- Sistema de Abas Interno -->
        <div class="tabs-container" id="history-tabs" style="margin-top: 15px;">
            <button class="active" data-hist-tab="backup">Backup</button>
            <button data-hist-tab="recycling">Reciclagem</button>
            <button data-hist-tab="timeline">Hist√≥rico</button>
        </div>

        <div id="history-tab-content" style="flex-grow: 1; overflow-y: auto; margin-top: 15px; padding-right: 5px;">
            
            <!-- ABA 1: BACKUP -->
            <div id="hist-content-backup" class="hist-tab-div">
                <button id="backup-now-btn" class="modal-btn primary" style="width: 100%; margin-bottom: 20px;">
                    Fazer backup do estado atual
                </button>
                <ul id="history-list-backups" class="move-list">
                    <!-- Backups Manuais e de Emerg√™ncia aqui -->
                </ul>
            </div>

            <!-- ABA 2: RECICLAGEM -->
            <div id="hist-content-recycling" class="hist-tab-div" style="display: none;">
                <h4 style="color: var(--text-muted-color); margin-bottom: 10px;">Itens Ocultos (Caixas Apagadas)</h4>
                <ul id="history-list-recycling" class="move-list">
                    <!-- Itens de subnotasocultas aqui -->
                </ul>
            </div>

            <!-- ABA 3: LINHA DO TEMPO (HIST√ìRICO) -->
            <div id="hist-content-timeline" class="hist-tab-div" style="display: none;">
                <div id="note-creation-info" style="margin-bottom: 20px; padding: 10px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                    <!-- Data de cria√ß√£o da nota principal -->
                </div>
                <h4 style="font-size: 0.9em; text-transform: uppercase; color: var(--accent-color); margin-bottom: 10px;">Cria√ß√£o de Blocos:</h4>
                <ul id="history-list-timeline" class="move-list">
                    <!-- Timeline das caixas extra√≠da do DOM -->
                </ul>
            </div>

        </div>

        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER O CONTE√öDO DO BACKUP -->
<div id="view-backup-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 80vw; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="view-backup-title">Visualizando Backup</h3>
        <div id="view-backup-content" style="background-color: var(--bg-color); padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            <!-- Conte√∫do do backup aqui -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VISUALIZAR LINK -->
<div id="view-link-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="view-link-title">Visualizar Anexo</h3>
        <ul id="view-link-urls-list" class="move-list" style="margin-top: 20px; margin-bottom: 20px; max-height: 40vh;">
            <!-- URLs ser√£o preenchidas via JS -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn primary" id="view-link-edit-btn">Editar</button>
        </div>
    </div>
</div>

<!-- MODAL PRINCIPAL: SELE√á√ÉO DE T√ìPICOS -->
<div id="topics-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="topics-modal-title">Gest√£o da Nota</h3>
            <button id="manage-topics-btn" title="Criar/Gerir T√≥picos" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer;">+</button>
        </div>
        
        <!-- NOVO: ABAS DE NAVEGA√á√ÉO -->
        <div class="tabs-container" id="topics-modal-tabs" style="margin-bottom: 15px;">
            <button class="active" data-tab="topics">üìë T√≥picos</button>
            <button data-tab="anchors">‚öì √Çncoras</button>
        </div>

        <!-- CONTE√öDO 1: T√ìPICOS (Original) -->
        <div id="tm-content-topics" class="tm-tab-content" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;">
            <div class="topics-layout" style="flex-grow: 1; overflow: hidden;">
                <!-- Coluna da Esquerda: Lista de T√≥picos -->
                <div class="topics-column">
                    <h4>T√≥picos</h4>
                    <ul id="topics-list-select" class="topics-list"></ul>
                </div>
                <!-- Coluna da Direita: Lista de Subt√≥picos -->
                <div class="topics-column">
                    <h4 id="subtopics-title-select">Subt√≥picos</h4>
                    <ul id="subtopics-list-select" class="topics-list">
                        <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CONTE√öDO 2: √ÇNCORAS (Novo) -->
        <div id="tm-content-anchors" class="tm-tab-content" style="display: none; flex-direction: column; flex-grow: 1; overflow: hidden;">
            
            <!-- Barra de Pesquisa -->
            <div style="margin-bottom: 10px;">
                <input type="text" id="anchor-search-input" placeholder="Pesquisar √¢ncoras..." 
                       style="width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px;">
            </div>

            <!-- Lista de √Çncoras -->
            <div class="topics-column" style="width: 100%; flex-grow: 1; display: flex; flex-direction: column;">
                <ul id="note-anchors-list" class="topics-list" style="flex-grow: 1; overflow-y: auto;">
                    <!-- Preenchido via JS -->
                </ul>
                <button id="load-more-anchors-btn" class="modal-btn secondary" style="width: 100%; margin-top: 10px; display: none;">Carregar mais 30 itens</button>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="save-topics-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- MODAL SECUND√ÅRIO: CRIA√á√ÉO DE T√ìPICOS (GEST√ÉO) -->
<div id="manage-topics-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
        <div style="margin-bottom: 15px;">
            <h3>Criar T√≥picos e Subt√≥picos</h3>
            <p style="font-size: 0.9em; color: var(--text-muted-color);">Adicione novos itens √† base de dados global.</p>
        </div>

        <div class="topics-layout">
            <!-- Coluna da Esquerda: Gerir T√≥picos -->
            <div class="topics-column">
                <button id="create-new-topic-btn" class="create-btn">+ Criar Novo T√≥pico</button>
                <input type="text" id="search-topic-input" placeholder="Filtrar t√≥picos..." class="topic-search-input">
                <ul id="topics-list-manage" class="topics-list"></ul>
            </div>
            <!-- Coluna da Direita: Gerir Subt√≥picos -->
            <div class="topics-column">
                <button id="create-new-subtopic-btn" class="create-btn" style="display: none;">+ Criar Novo Subt√≥pico</button>
                <ul id="subtopics-list-manage" class="topics-list">
                    <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico para adicionar subt√≥picos.</li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" id="close-manage-topics-btn">Voltar</button>
        </div>
    </div>
</div>

<!-- MODAL DE INPUT DUPLO (Nome + Descri√ß√£o) -->
<div id="custom-input-modal" class="modal-overlay" style="z-index: 1200;">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="custom-input-title">Novo Item</h3>
        
        <!-- Campo Nome -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Nome</label>
        <input type="text" id="custom-input-name" placeholder="Escreva o nome aqui..." 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <!-- Campo Descri√ß√£o (Novo) -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Descri√ß√£o <small>(Opcional)</small></label>
        <textarea id="custom-input-desc" placeholder="Detalhes adicionais..." 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none; font-family: inherit;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="custom-input-cancel">Cancelar</button>
            <button class="modal-btn primary" id="custom-input-confirm">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE PALAVRA-PASSE -->
<div id="password-modal" class="modal-overlay" style="z-index: 2000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3 id="password-modal-title">Proteger Item</h3>
        <p id="password-modal-desc" style="margin-bottom: 15px; font-size: 0.9em;">Defina uma palavra-passe.</p>
        
       <input type="password" id="password-input" placeholder="Palavra-passe" 
       autocomplete="new-password"
       style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <p id="password-error" style="color: #e74c3c; font-size: 0.9em; display: none; margin-bottom: 10px;">Palavra-passe incorreta.</p>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="password-confirm-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE GEST√ÉO DE MARCADORES (Lista) -->
<div id="bookmarks-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Marcadores</h3>
            <!-- Bot√£o '+' no canto superior direito -->
            <button id="open-create-bookmark-btn" title="Novo Marcador" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Selecione os marcadores para associar a este texto b√≠blico.
        </p>

        <ul id="bookmarks-list" class="move-list" style="max-height: 50vh;">
            <!-- A lista ser√° preenchida via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL DE CRIA√á√ÉO DE NOVO MARCADOR (Sub-popup) -->
<div id="create-bookmark-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Novo G√©nero de Marcador</h3>
        
        <input type="text" id="new-bookmark-title" placeholder="T√≠tulo (ex: Profecias)" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="new-bookmark-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-create-bookmark">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-bookmark">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE BLOQUEIO DE GRAVA√á√ÉO -->
<div id="forcing-save-modal" class="modal-overlay" style="z-index: 9999; background-color: rgba(0,0,0,0.85);">
    <div class="modal-content" style="text-align: center; max-width: 300px; border: 1px solid var(--accent-color);">
        <div class="spinner" style="margin: 0 auto 15px auto; border-left-color: var(--accent-color);"></div>
        <h3 style="margin-bottom: 10px; color: white;">A Guardar...</h3>
        <p style="color: var(--text-muted-color); font-size: 0.9em;">Por favor, aguarde enquanto as suas altera√ß√µes s√£o enviadas.</p>
    </div>
</div>

<!-- POPUP DE ESCOLHA DE TAMANHO DO POST-IT -->
<div id="postit-size-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020; flex-direction: column; width: 180px; padding: 5px;">
    <button data-size="small" style="text-align:left; width:100%; border-radius:4px; padding:8px; background:none; border:none; color:var(--text-color); cursor:pointer;">‚ñ´Ô∏è Pequeno</button>
    <button data-size="medium" style="text-align:left; width:100%; border-radius:4px; padding:8px; background:none; border:none; color:var(--text-color); cursor:pointer;">‚óªÔ∏è M√©dio</button>
    <button data-size="large" style="text-align:left; width:100%; border-radius:4px; padding:8px; background:none; border:none; color:var(--text-color); cursor:pointer;">‚¨ú Grande</button>
</div>

<!-- POPUP DE A√á√ïES DA IDEIA (‚úÇÔ∏è üß≤) -->
<div id="idea-actions-popup" style="display: none; position: absolute; background: var(--sidebar-color); border: 1px solid var(--border-color); padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; gap: 5px;">
    <button data-action="remove-idea" title="Remover Ideia" style="background:none; border:none; cursor:pointer; font-size:18px;">‚úÇÔ∏è</button>
    <button data-action="append-idea" title="Adicionar a outra nota" style="background:none; border:none; cursor:pointer; font-size:18px;">üß≤</button>
</div>

<!-- MODAL DE SELE√á√ÉO DE NOTA (Para transferir a ideia) -->
<div id="select-note-modal" class="modal-overlay" style="z-index: 2100;">
    <div class="modal-content">
        <h3>Adicionar Ideia a...</h3>
        <p style="font-size:0.9em; color:#888;">Selecione uma nota nesta pasta:</p>
        <ul id="select-note-list" class="move-list" style="max-height: 50vh;"></ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- NOVO MODAL DE DESTAQUES (POPUP CENTRAL) -->
<div id="highlight-modal" class="modal-overlay" style="z-index: 2200;">
    <div class="modal-content" style="max-width: 500px;">
        <h3>Escolher o Marcador</h3>
        <div id="highlight-options-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <!-- As cores ser√£o geradas aqui via JS -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- MENU FLUTUANTE PARA TABELAS -->
<div id="table-tools-popup">
    <div style="font-size:0.8em; color:#888; width:100%; text-align:center; padding-bottom:4px;">Tabela</div>
    <button data-action="add-row-above" title="Linha Acima">‚¨ÜÔ∏è Linha</button>
    <button data-action="add-row-below" title="Linha Abaixo">‚¨áÔ∏è Linha</button>
    <button data-action="add-col-left" title="Coluna Esquerda">‚¨ÖÔ∏è Coluna</button>
    <button data-action="add-col-right" title="Coluna Direita">‚û°Ô∏è Coluna</button>
    <div class="sep"></div>
    <button data-action="del-row" title="Apagar Linha" style="color:#e74c3c;">‚ùå Linha</button>
    <button data-action="del-col" title="Apagar Coluna" style="color:#e74c3c;">‚ùå Coluna</button>
    <button data-action="del-table" title="Apagar Tabela Inteira" style="width:100%; border-color:#e74c3c; color:#e74c3c; margin-top:3px;">üóëÔ∏è Apagar Tabela</button>
</div>


<!-- MODAL DE TAREFA DE CALEND√ÅRIO -->
<div id="calendar-task-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Agenda: <span id="cal-selected-date-display"></span></h3>
        <input type="hidden" id="cal-selected-date-iso"> <!-- Guarda YYYY-MM-DD -->
        
        <textarea id="cal-task-desc" placeholder="Descreva a tarefa ou evento..." 
                  style="width: 100%; height: 100px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); margin-bottom: 15px; resize: none;"></textarea>
        
        <!-- Lista de tarefas existentes neste dia -->
        <div id="cal-existing-tasks" style="margin-bottom: 15px; max-height: 100px; overflow-y: auto;"></div>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="cal-save-task-btn">Gravar Tarefa</button>
        </div>
    </div>
</div>

<!-- MODAL DE AGREGA√á√ÉO (SELETOR DE CONTE√öDO) -->
<div id="aggregation-modal" class="modal-overlay" style="z-index: 1500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        <h3>Criar Agrega√ß√£o: <span id="aggregation-new-name" style="color: var(--accent-color);"></span></h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue pelas pastas e notas. Selecione as caixas que deseja copiar para esta nova nota.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs e Bot√£o Voltar) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="agreg-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="agreg-current-path" style="font-weight: bold; color: var(--text-color);">Pasta Raiz</span>
        </div>

        <!-- Lista de Conte√∫do (Pastas, Notas ou Caixas) -->
        <ul id="aggregation-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px;">
            <!-- Preenchido via JS -->
        </ul>

        <!-- Rodap√© com Contador e Bot√£o Criar -->
        <div class="modal-actions" style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px; align-items: center;">
            <span id="agreg-count" style="margin-right: auto; font-weight: bold; color: var(--accent-color);">0 itens selecionados</span>
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="agreg-finish-btn">Criar Agrega√ß√£o</button>
        </div>
    </div>
</div>

<!-- MODAL DE CLONAR PARA NOTA (DESTINO) -->
<div id="append-to-note-modal" class="modal-overlay" style="z-index: 1600;">
    <div class="modal-content" style="max-width: 500px; height: 70vh; display: flex; flex-direction: column;">
        <h3>Enviar para...</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue e selecione a <strong>Nota</strong> onde deseja colar este conte√∫do.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="append-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="append-current-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        </div>

        <!-- Lista de Pastas e Notas -->
        <ul id="append-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px; overflow-y: auto;">
            <!-- Preenchido via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- POPUP DE DEFINI√á√ïES DE PARTILHA DA CAIXA -->
<div id="share-settings-popup">
    <h4>Seguran√ßa da Caixa</h4>
    <div class="share-toggle-row">
        <span>Permitir Partilha</span>
        <label class="setting-switch">
            <input type="checkbox" id="mini-note-share-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    <p style="font-size: 0.75em; color: var(--text-muted-color); margin-top: 10px; line-height: 1.3;">
        Se desativado, o conte√∫do n√£o aparecer√° em links p√∫blicos, mesmo que tenham sido gerados anteriormente.
    </p>
</div>

<!-- POPUP DE PARTILHA (AGORA √â UM MODAL CENTRAL) -->
<div id="note-share-popup" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 400px;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;">Partilha</h3>
            <button onclick="document.getElementById('note-share-popup').style.display='none'" style="background:none; border:none; color:var(--text-muted-color); font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <!-- 1. LINK DE LEITURA (Padr√£o) -->
        <div class="share-toggle-row" style="background-color: var(--bg-color); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <span style="font-weight:bold; color: var(--text-color); display:block;">Link de Leitura</span>
                <small style="color:var(--text-muted-color); font-size:0.75em;">P√∫blico (Apenas Ver)</small>
            </div>
            <label class="setting-switch">
                <input type="checkbox" id="note-share-toggle">
                <span class="slider round"></span>
            </label>
        </div>

        <div id="note-share-link-container" style="display: none; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid var(--accent-color);">
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="note-share-url" readonly 
                       style="flex-grow: 1; height: 36px; padding: 0 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); outline: none; font-size: 0.85em;">
                <button onclick="copyLink('note-share-url')" style="height: 36px; padding: 0 15px; background: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; cursor: pointer; font-size: 0.85em;">Copiar</button>
            </div>
        </div>

        <!-- 2. LINK DE COLABORA√á√ÉO (Apenas Arquivos Partilhados) -->
        <div id="archive-collab-section" style="display: none;">
            <div class="share-toggle-row" style="background-color: rgba(231, 76, 60, 0.1); padding: 12px; border-radius: 8px; border: 1px solid #c0392b; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <span style="font-weight:bold; color: #e74c3c; display:block;">Link de Colabora√ß√£o</span>
                    <small style="color:var(--text-muted-color); font-size:0.75em;">Permite Criar/Editar Posts</small>
                </div>
                <label class="setting-switch">
                    <input type="checkbox" id="collab-share-toggle">
                    <span class="slider round" style="background-color: #ccc;"></span>
                </label>
            </div>

            <div id="collab-share-link-container" style="display: none; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid #e74c3c;">
                <p style="font-size:0.8em; color:#e74c3c; margin-bottom:5px;">‚ö†Ô∏è Quem tiver este link poder√° editar o seu Arquivo.</p>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="collab-share-url" readonly 
                           style="flex-grow: 1; height: 36px; padding: 0 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); outline: none; font-size: 0.85em;">
                    <button onclick="copyLink('collab-share-url')" style="height: 36px; padding: 0 15px; background: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; cursor: pointer; font-size: 0.85em;">Copiar</button>
                </div>
            </div>
        </div>

    </div>
</div>




<!-- POPUP DE CORES DO TOGGLE -->
<div id="toggle-color-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 2500; width: 160px; padding: 10px;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        <!-- As cores ser√£o geradas aqui ou fixas -->
        <button class="color-choice" style="background-color: #ffcdd2;" data-color="#ffcdd2" title="Rosa Suave"></button>
        <button class="color-choice" style="background-color: #ffe0b2;" data-color="#ffe0b2" title="Laranja P√™ssego"></button>
        <button class="color-choice" style="background-color: #fff9c4;" data-color="#fff9c4" title="Amarelo Creme"></button>
        <button class="color-choice" style="background-color: #c8e6c9;" data-color="#c8e6c9" title="Verde Menta"></button>
        <button class="color-choice" style="background-color: #b3e5fc;" data-color="#b3e5fc" title="Azul C√©u"></button>
        <button class="color-choice" style="background-color: #e1bee7;" data-color="#e1bee7" title="Lil√°s"></button>
    </div>
    <div style="margin-top: 8px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 5px;">
        <button class="color-choice-reset" style="background: none; border: none; font-size: 0.8em; color: var(--text-muted-color); cursor: pointer;">Sem Cor</button>
    </div>
</div>

<!-- MODAL DE SCANNER UNIVERSAL (üé∞) -->
<div id="universal-scan-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column; padding: 0;">
        
        <!-- Cabe√ßalho com Abas -->
        <div class="scan-header" style="padding: 15px 15px 0 15px; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 15px;">Detetor de Entidades</h3>
            <div class="scan-tabs">
                <button class="scan-tab-btn active" data-target="textobiblico">üìñ B√≠blia</button>
                <button class="scan-tab-btn" data-target="personagem">üë§ Personagens</button>
                <button class="scan-tab-btn" data-target="local">üìç Locais</button>
                <button class="scan-tab-btn" data-target="data">üìÖ Datas</button>
            </div>
        </div>

        <!-- Corpo das Listas -->
        <div class="scan-body" style="flex-grow: 1; overflow-y: auto; padding: 15px; position: relative;">
            
            <!-- Contentor para as listas (Preenchido via JS) -->
            <div id="scan-lists-container">
                <!-- As listas <ul> ser√£o geradas aqui dinamicamente -->
            </div>

            <!-- POPUP DE PREVIEW (CONTEXTO) -->
            <div id="scan-preview-popup" style="display: none;">
                <div class="preview-header">
                    <strong>Contexto</strong>
                    <button onclick="document.getElementById('scan-preview-popup').style.display='none'">√ó</button>
                </div>
                <div id="scan-preview-content"></div>
            </div>

        </div>

        <!-- Rodap√© -->
        <div class="modal-actions" style="padding: 15px; border-top: 1px solid var(--border-color);">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn secondary" id="scan-toggle-all-btn" style="margin-right: auto;">Selecionar Todos</button>
            <button class="modal-btn primary" id="confirm-scan-btn">Converter Selecionados</button>
        </div>
    </div>
</div>

<!-- Modal de Escolha de √çcone -->
<div id="icon-picker-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>Escolher √çcone</h3>
        <p style="color: var(--text-muted-color); margin-bottom: 15px;">Personalize a sua Superpasta.</p>
        
        <!-- Grelha de Emojis -->
        <div id="emoji-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
            <!-- Padr√£o -->
            <button class="emoji-btn" data-icon="üóÉÔ∏è" style="grid-column: span 4; background: var(--panel-color); border: 1px solid var(--accent-color);">üóÉÔ∏è Padr√£o</button>
            
            <!-- Paisagens -->
            <button class="emoji-btn" data-icon="üèûÔ∏è">üèûÔ∏è</button>
            <button class="emoji-btn" data-icon="üåÖ">üåÖ</button>
            <button class="emoji-btn" data-icon="üåÑ">üåÑ</button>
            <button class="emoji-btn" data-icon="üèúÔ∏è">üèúÔ∏è</button>
            
            <!-- Cidades -->
            <button class="emoji-btn" data-icon="üèôÔ∏è">üèôÔ∏è</button>
            <button class="emoji-btn" data-icon="üåá">üåá</button>
            <button class="emoji-btn" data-icon="üåÜ">üåÜ</button>
            <button class="emoji-btn" data-icon="üåÉ">üåÉ</button>
            
            <!-- Noite/C√©u -->
            <button class="emoji-btn" data-icon="üéë">üéë</button>
            <button class="emoji-btn" data-icon="üåå">üåå</button>
            <button class="emoji-btn" data-icon="üå†">üå†</button>
            <button class="emoji-btn" data-icon="üåâ">üåâ</button>
            
            <!-- Fogos/Estrada -->
            <button class="emoji-btn" data-icon="üéÜ">üéÜ</button>
            <button class="emoji-btn" data-icon="üéá">üéá</button>
            <button class="emoji-btn" data-icon="üõ£Ô∏è">üõ£Ô∏è</button>
            <button class="emoji-btn" data-icon="üõ§Ô∏è">üõ§Ô∏è</button>
        </div>

        <button class="modal-btn secondary" onclick="document.getElementById('icon-picker-modal').style.display='none'" style="width: 100%;">Cancelar</button>
    </div>
</div>

<!-- 2. Modal: Selecionar Gavet√£o (Adicione no final do body) -->
<div id="drawer-selection-modal" class="modal-overlay" style="z-index: 2300;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3>Gavet√£o</h3>
            <button id="open-create-drawer-btn" style="background:var(--accent-color); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer;">+</button>
        </div>
        <ul id="drawer-list-select" class="move-list" style="max-height: 300px; overflow-y: auto;">
            <!-- Gavet√µes aqui -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('drawer-selection-modal').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<!-- 3. Modal: Criar Gavet√£o (CORRIGIDO) -->
<div id="create-drawer-modal" class="modal-overlay" style="z-index: 99999;">
    <div class="modal-content" style="max-width: 350px;">
        <form onsubmit="return false;" autocomplete="off">
            <h3>Criar Gavet√£o</h3>
            
            <input type="text" id="new-drawer-name" placeholder="Nome do gavet√£o" autocomplete="off" 
                   style="width: 100%; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white;">
            
            <textarea id="new-drawer-desc" placeholder="Descri√ß√£o (opcional)" 
                      style="width:100%; height:80px; margin-top:10px; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; resize: none;"></textarea>
            
            <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="modal-btn secondary" onclick="document.getElementById('create-drawer-modal').style.display='none'">Voltar</button>
                <button type="button" class="modal-btn primary" id="confirm-create-drawer">Criar</button>
            </div>
        </form>
    </div>
</div>


<!-- POPUP DE FORMATA√á√ÉO COLORIDA (PC) -->
<!-- POPUP DE FORMATA√á√ÉO (3 PONTOS) - ATUALIZADO -->
<div id="formatting-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 3000; width: 180px; padding: 10px; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5);">
    <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
        <button data-action="open-robot" style="width: 40px; height: 40px; font-size: 20px;" title="Exportar Sentinela">ü§ñ</button>
        <button data-action="open-margin-editor" style="width: 40px; height: 40px; font-size: 20px;" title="Editor de Margem">üî¨</button>
        <button data-action="creative-mode" class="pc-only" style="width: 40px; height: 40px; font-size: 20px;" title="Modo Criativo">ü™Å</button>
          <button data-action="insert-ref-depot" style="width: 40px; height: 40px; font-size: 20px;" title="Grua de Refer√™ncias">üèóÔ∏è</button>
    </div>
</div>



<!-- NOVO POPUP PARA O BOT√ÉO B AZUL -->
<div id="bold-palette-popup">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
        <!-- Os 6 bot√µes pedidos -->
        <button onclick="applyColorStyle('bold', '#ffff00')" style="color: #ffff00; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#ff4d4d')" style="color: #ff4d4d; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#ffa500')" style="color: #ffa500; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#4dff4d')" style="color: #4dff4d; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#b366ff')" style="color: #b366ff; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#ffffff')" style="color: #ffffff; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        
    </div>
</div>


<!-- POPUP EXCLUSIVO DO BOT√ÉO I (IT√ÅLICO) -->
<div id="italic-palette-popup" style="display: none; position: absolute; z-index: 3000; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); padding: 8px; width: 140px;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
        <button onclick="applyColorStyle('italic', '#ffff00')" style="color: #ffff00; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#ff4d4d')" style="color: #ff4d4d; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#ffa500')" style="color: #ffa500; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#4dff4d')" style="color: #4dff4d; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#4da6ff')" style="color: #4da6ff; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#ffffff')" style="color: #ffffff; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
    </div>
</div>





<!-- MODAL DO ROB√î (CAIXA DE TEXTO) -->
<div id="robot-modal" class="modal-overlay" style="z-index: 3100;">
    <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">ü§ñ Exportar Sentinela</h3>
        
        <!-- √Årea de Colagem -->
        <div id="robot-input-container">
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 8px;">Cole aqui o texto do artigo (JW.ORG):</p>
            <textarea id="robot-input-text" placeholder="Cole o conte√∫do aqui..." 
                      style="width: 100%; height: 150px; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 10px; resize: none; outline: none;"></textarea>
            <button class="modal-btn primary" id="robot-generate-btn" style="width: 100%; margin-bottom: 15px;">Gerar Perguntas</button>
        </div>

        <!-- √Årea de Pr√©-visualiza√ß√£o (Escondida inicialmente) -->
        <div id="robot-preview-container" style="display: none; flex-grow: 1; overflow-y: auto; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <h4 id="preview-count" style="color: var(--accent-color); margin-bottom: 10px;">Encontradas 0 perguntas:</h4>
            <ul id="preview-list" style="list-style: none; padding: 0; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <!-- Lista gerada aqui -->
            </ul>
        </div>
        
        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" onclick="document.getElementById('robot-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="robot-insert-btn" style="display: none;">Inserir na Nota</button>
        </div>
    </div>
</div>

<!-- MODAL PARA RENOMEAR DESTAQUE -->
<div id="rename-highlight-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3>Renomear Marcador</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">Defina um nome personalizado para esta cor:</p>
        
        <input type="text" id="new-highlight-name-input" placeholder="Ex: Importante, Revisar..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-rename-highlight-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-rename-highlight-btn">Gravar</button>
        </div>
    </div>
</div>


<!-- MODAL CRIAR/EDITAR COSMOS -->
<div id="cosmos-modal" class="modal-overlay" style="z-index: 2600;">
    <div class="modal-content" style="max-width: 400px;">
        <h3 id="cosmos-modal-title">Novo Tema/Conceito</h3>
        
        <input type="text" id="cosmos-name-input" placeholder="Nome do Tema" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="cosmos-desc-input" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 15px; resize: none;"></textarea>
        
        <label style="display:block; margin-bottom:10px; font-size: 0.85em; color: var(--text-muted-color);">Escolher Emoji:</label>
        <div id="cosmos-emoji-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
            <button class="emoji-btn" data-emoji="ü¶ñ">ü¶ñ</button>
            <button class="emoji-btn" data-emoji="üå∫">üå∫</button>
            <button class="emoji-btn" data-emoji="üå±">üå±</button>
            <button class="emoji-btn" data-emoji="üß™">üß™</button>
            <button class="emoji-btn" data-emoji="üìú">üìú</button>
            <button class="emoji-btn" data-emoji="üèõÔ∏è">üèõÔ∏è</button>
            <button class="emoji-btn" data-emoji="üìê">üìê</button>
            <button class="emoji-btn" data-emoji="‚òÑÔ∏è">‚òÑÔ∏è</button>
            <button class="emoji-btn" data-emoji="‚öîÔ∏è">‚öîÔ∏è</button>
            <button class="emoji-btn" id="custom-emoji-btn" style="background: var(--panel-color); border: 1px dashed var(--accent-color);">+</button>
        </div>

        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('cosmos-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="save-cosmos-btn">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA EMOJI PERSONALIZADO -->
<div id="custom-emoji-modal" class="modal-overlay" style="z-index: 9000000;">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>Editar Tema</h3>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">Ajuste o nome e o √≠cone do tema:</p>
        
        <!-- Campo Nome -->
        <input type="text" id="custom-theme-name-input" placeholder="Nome do Tema" 
               style="width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: white; margin-bottom: 15px; outline: none;">

        <!-- Campo Emoji -->
        <label style="display:block; margin-bottom:8px; font-size: 0.75em; text-transform: uppercase; color: var(--text-muted-color);">Emoji / √çcone:</label>
        <input type="text" id="custom-emoji-input" maxlength="5" placeholder="üòä"
               style="width: 80px; height: 80px; text-align: center; font-size: 40px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; color: white; margin: 0 auto 20px auto; outline: none; display: block;">
        
        <div class="modal-actions" style="justify-content: center; gap: 10px;">
            <button class="modal-btn secondary" onclick="document.getElementById('custom-emoji-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-custom-emoji-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE SELE√á√ÉO B√çBLICA PARA MICA -->
<div id="mica-bible-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 450px;">
        <h3>Adicionar Texto B√≠blico</h3>
        
        <label class="codex-label">T√≠tulo do Card (Opcional)</label>
        <input type="text" id="bible-card-title" placeholder="Ex: Base para a esperan√ßa" class="codex-input-modern" style="margin-bottom: 15px;">

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div>
                <label class="codex-label">Livro</label>
                <select id="bible-book-select" class="codex-input-modern"></select>
            </div>
            <div>
                <label class="codex-label">Cap√≠tulo</label>
                <select id="bible-chapter-select" class="codex-input-modern"></select>
            </div>
        </div>

        <label class="codex-label">Vers√≠culos</label>
        <div id="verse-inputs-container" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
            <!-- Linhas de vers√≠culos entrar√£o aqui -->
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="add-single-verse-btn" class="modal-btn" style="flex: 1; background: var(--panel-color); border: 1px solid var(--border-color);">+ Vers√≠culo</button>
            <button id="add-range-verse-btn" class="modal-btn" style="flex: 1; background: var(--panel-color); border: 1px solid var(--border-color);">- Intervalo</button>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('mica-bible-modal').style.display='none'">Cancelar</button>
            <button id="confirm-mica-bible-save" class="modal-btn primary">Adicionar √† Mica</button>
        </div>
    </div>
</div>

<!-- Popup de Cores das Micas -->
<div id="mica-color-popup" style="display: none;"></div>

<!-- MODAL PARA RENOMEAR ITENS -->
<div id="rename-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3>Mudar Nome</h3>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 10px;">Insira o novo nome para o item:</p>
        <input type="text" id="rename-input" placeholder="Novo nome..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-rename-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-rename-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- Modal: Criar Gaveta (Interna) -->
<div id="create-gaveta-modal" class="modal-overlay" style="z-index: 9999999 !important;">
    <div class="modal-content" style="max-width: 350px; background-color: var(--sidebar-color); border: 1px solid var(--accent-color);">
        <h3>Nova Gaveta</h3>
        <p style="font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 10px;">Crie uma pasta dentro deste gavet√£o.</p>
        
        <input type="text" id="new-gaveta-name" placeholder="Nome da gaveta" 
               style="width: 100%; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white;">
        
        <textarea id="new-gaveta-desc" placeholder="Descri√ß√£o (opcional)" 
                  style="width:100%; height:80px; margin-top:10px; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; resize: none;"></textarea>
        
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('create-gaveta-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-gaveta">Criar</button>
        </div>
    </div>
</div>

<!-- ESCUDO DE CARREGAMENTO INICIAL (√öNICO) -->
<div id="app-loader">
    <div class="loader-content">
        <div class="loader-circle"></div>
        <div class="loader-logo">
            <span class="logo-icon">üìñ</span>
            <span class="logo-text">NotaBook</span>
        </div>
        <p class="loader-status">A validar acesso...</p>
    </div>
</div>

<!-- MODAL DE ANEXAR LINK/IMAGEM (Para a Caixa de Racioc√≠nio) -->
<div id="attachment-modal" class="modal-overlay" style="z-index: 9999999;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Adicionar Anexo</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Cole o endere√ßo de uma imagem ou p√°gina web:
        </p>
        
        <input type="text" id="attachment-url-input" placeholder="https://..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-attachment-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-attachment-btn">Adicionar</button>
        </div>
    </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE LINK (RACIOC√çNIO) -->
<div id="edit-link-modal" class="modal-overlay" style="z-index: 10000000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Editar Link</h3>
        <input type="text" id="edit-link-url-input" placeholder="https://..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('edit-link-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-edit-link-btn">Gravar</button>
        </div>
    </div>
</div>


<!-- MODAL DE IMAGEM DO CART√ÉO -->
<div id="card-image-modal" class="modal-overlay" style="z-index: 10000000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Definir Imagem</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Cole o link da imagem (URL):
        </p>
        
        <input type="text" id="card-image-url-input" placeholder="https://exemplo.com/foto.jpg" 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('card-image-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-card-image-btn">Confirmar</button>
        </div>
    </div>
</div>



<!-- MODAL DE FOCO DO REDATOR -->
<div id="redator-focus-modal" class="modal-overlay" style="z-index: 100000;">
    <div class="modal-content" style="max-width: 800px; width: 90%; height: 80vh; background: #1a1a1d; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;">
        
        <div style="display: flex; justify-content: flex-end; padding-bottom: 10px;">
            <button class="modal-btn secondary" onclick="closeRedatorFocus()">Fechar & Gravar</button>
        </div>

        <!-- Onde o Redator ser√° clonado -->
        <div id="redator-focus-container" style="flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <!-- O Redator aparecer√° aqui -->
        </div>
    </div>
</div>


<!-- MODAL DE VISTAS MOBILE (Pastas, √çndice, Textos, Fontes) -->
<div id="mobile-views-modal" class="modal-overlay" style="z-index: 20000;">
    <div class="modal-content" style="width: 95%; height: 80vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background-color: var(--panel-color);">
        
        <!-- Cabe√ßalho do Modal -->
        <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--sidebar-color);">
            <h3 id="mobile-views-title" style="margin: 0;">√çndice</h3>
            <button onclick="document.getElementById('mobile-views-modal').style.display='none'" style="background: none; border: none; font-size: 24px; color: var(--text-muted-color);">√ó</button>
        </div>

        <!-- √Årea de Conte√∫do -->
        <div id="mobile-views-content" style="flex-grow: 1; overflow-y: auto; padding: 10px; background-color: var(--bg-color);">
            <!-- O conte√∫do ser√° injetado aqui via JS -->
        </div>

        <!-- Barra de Abas (Igual √† do PC) -->
        <div class="middle-bottom-tabs" style="display: flex !important; position: relative; margin: 0 !important; border-top: 1px solid var(--border-color);">
            <button data-mob-tab="files"><span>üìÇ</span> Pastas</button>
            <button data-mob-tab="index" class="active"><span>üìë</span> √çndice</button>
            <button data-mob-tab="texts"><span>üìñ</span> Textos</button>
            <button data-mob-tab="sources"><span>‚ö°</span> Fontes</button>
        </div>
    </div>
</div>

<!-- MODAL DE GEST√ÉO DE √ÇNCORAS (LISTA) -->
<div id="anchors-manager-modal" class="modal-overlay" style="z-index: 50000;">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Anexar √Çncora</h3>
            <!-- Bot√£o '+' no canto superior direito -->
            <button id="open-create-anchor-btn" title="Criar Nova √Çncora" 
                    style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Selecione as √¢ncoras para associar a esta entidade.
        </p>

        <ul id="anchors-manager-list" class="move-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- A lista ser√° preenchida via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('anchors-manager-modal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL DE CRIA√á√ÉO DE NOVA √ÇNCORA -->
<div id="create-anchor-modal" class="modal-overlay" style="z-index: 55000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Adicionar √Çncoras</h3>
        
        <input type="text" id="new-anchor-name" placeholder="Nome da √Çncora" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="new-anchor-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('create-anchor-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-anchor">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE √ÇNCORA -->
<div id="edit-anchor-modal" class="modal-overlay" style="z-index: 60000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Editar √Çncora</h3>
        
        <input type="text" id="edit-anchor-name" placeholder="Nome da √Çncora" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="edit-anchor-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions" style="display: flex; justify-content: space-between;">
            <!-- Bot√£o Eliminar √† Esquerda -->
            <button class="modal-btn" id="delete-anchor-btn" style="background-color: #c0392b; color: white;">Eliminar</button>
            
            <div style="display: flex; gap: 10px;">
                <button class="modal-btn secondary" onclick="document.getElementById('edit-anchor-modal').style.display='none'">Cancelar</button>
                <button class="modal-btn primary" id="confirm-edit-anchor">Gravar</button>
            </div>
        </div>
    </div>
</div>

<!-- AMBIENTE AQU√ÅRIO (Fica por cima de tudo) -->
<div id="aquarium-environment" style="display: none;">
    
    <!-- Barra de Tarefas do Aqu√°rio -->
    <div id="aquarium-bar">
        <!-- ESQUERDA: NAVEGA√á√ÉO -->
        <div class="aquarium-nav-group">
            <button id="aquarium-back-btn" title="Sair e Gravar">‚¨Ö Voltar</button>
            
            <!-- NOVO √çCONE DA MEDUSA -->
            <button id="aquarium-sidebar-toggle" title="Menu Lateral" style="font-size: 18px;">ü™º</button>
            
            <button id="aquarium-jump-btn" title="Saltar para outra nota">íÜú</button>
        </div>

        <!-- CENTRO-ESQUERDA: FERRAMENTAS -->
          <div class="aquarium-tools-group">
            <button data-action="note-sharing-settings" title="Partilha">üîê</button>
            <button data-action="show-topics" title="T√≥picos">üìë</button>
            <button data-action="show-history" title="Hist√≥rico">üïí</button>
            
            <!-- SEPARADOR VISUAL -->
            <div style="width:1px; background:rgba(255,255,255,0.2); height:20px; margin:0 5px;"></div>
            
            <!-- NOVOS BOT√ïES -->
            <button data-action="undo" title="Desfazer (Ctrl+Z)">‚Ü©Ô∏è</button>
            <button data-action="redo" title="Refazer (Ctrl+Y)">‚Ü™Ô∏è</button>
        </div>

        <!-- DIREITA: T√çTULO -->
        <div class="aquarium-title-group">
            <h2 id="aquarium-title-display">Sem T√≠tulo</h2>
        </div>
    </div>

    <!-- NOVA SIDEBAR DO AQU√ÅRIO (MEDUSA) -->
    <aside id="aquarium-sidebar">
        <!-- Cabe√ßalho das Abas -->
        <div class="aq-tabs-header">
    <button class="aq-tab active" data-tab="listas" title="Listas">üß≠</button>
        <button class="aq-tab" data-tab="indice" title="√çndice">‚âî</button>
        <button class="aq-tab" data-tab="textos" title="Textos B√≠blicos">üìú</button>
        <button class="aq-tab" data-tab="navega" title="Navega√ß√£o">‚öì</button>
        <button class="aq-tab" data-tab="links" title="Links e Fontes">‚ö°</button>
        <button class="aq-tab" data-tab="armazem" title="Armaz√©m">üêö</button>
        </div>

        <!-- Conte√∫do das Vistas -->
        <div id="aq-sidebar-content">
            <ul id="aq-list-view" class="aq-view active">
                <!-- Preenchido via JS (Listas) -->
            </ul>
            <div id="aq-index-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Cards do √çndice) -->
            </div>
            <div id="aq-texts-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Textos B√≠blicos) -->
            </div>
            <div id="aq-nav-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Navega√ß√£o Entidades) -->
            </div>
            <ul id="aq-links-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Links das Caixas) -->
            </ul>
         <div id="aq-store-view" class="aq-view" style="display:none; height: 100%; flex-direction: column;">
    <!-- O conte√∫do ser√° injetado aqui -->
</div>
        </div>
    </aside>

    <!-- POPUP DE NAVEGA√á√ÉO R√ÅPIDA (Fica escondido) -->
    <div id="aquarium-jump-popup" style="display:none;">
        <input type="text" id="aquarium-jump-search" placeholder="Pesquisar nota...">
        <ul id="aquarium-jump-list"></ul>
    </div>

    <!-- Barra de Ferramentas Funcional -->
   

  <div id="aquarium-toolbar">
        
        <!-- GRUPO 1: Estilo e Tamanho (MOVIDO PARA O IN√çCIO) -->
        <div class="aq-tool-group">
            <select id="aq-zoom" title="Zoom">
                <option value="12px">50%</option>
                <option value="100%" selected>100%</option>
                <option value="18px">110%</option>
                <option value="24px">150%</option>
            </select>
            <select id="aq-format" title="Estilo" style="width: 100px;">
                <option value="P" selected>¬∂ Normal</option>
                <option value="H1">A1 T√≠tulo</option>
                <option value="H2">A2 T√≠tulo</option>
                <option value="H3">A3 T√≠tulo</option>
            </select>
            <input type="color" id="aq-color" title="Cor do Texto" style="width:30px; height:30px; border:none; background:none; cursor:pointer;">
        </div>

        <div class="aq-sep"></div>

        <!-- GRUPO 2: Formata√ß√£o B√°sica (MOVIDO PARA SEGUNDO) -->
        <div class="aq-tool-group">
            <button data-cmd="bold" title="Negrito"><b>B</b></button>
            <button data-cmd="boldBlue" title="Negrito Azul" class="btn-blue-b">B <span class="dots">‚Ä¢‚Ä¢</span></button>
            <button data-cmd="italic" title="It√°lico" class="btn-italic"><i>I</i> <span class="dots">‚Ä¢‚Ä¢</span></button>
            <button data-cmd="underline" title="Sublinhado"><u>U</u></button>
        </div>

        <div class="aq-sep"></div>

        <!-- GRUPO 3: Widgets Especiais (MANTEVE-SE) -->
        <div class="aq-tool-group">
            <button data-action="insert-toggle-h2" title="Sec√ß√£o Expans√≠vel (Toggle)">‚òÇ</button>
            <button data-action="make-draggable" title="Texto Arrast√°vel">·Øì</button>
            <button data-action="insert-checkbox" title="Checkbox">‚òëÔ∏è</button>
            <button data-action="insertHorizontalRule" title="Linha Horizontal">‚Äï</button>
            <button data-action="insert-table" title="Tabela">üßÆ</button>
            <button data-action="insert-date" title="Calend√°rio">üìÖ</button>
            <button data-action="insert-timeline" title="Linha Cronol√≥gica">üå≥</button>
            <button data-action="bible-scan" title="Scanner B√≠blico">üé∞</button>
        </div>

        <div class="aq-sep"></div>

        <!-- GRUPO 4: Contexto do Fantasma (MANTEVE-SE) -->
       <div id="aq-context-tools" class="aq-tool-group" style="display: none; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 10px;">
        <span style="font-size:10px; color:#888; margin-right:5px; text-transform:uppercase;">BLOCO</span>
        <button data-ctx="sharing" title="Partilha">üîê</button>
        <button data-ctx="links" title="Links/Codex">‚ö°</button>
        <button data-ctx="clone" title="Clonar">üß¨</button>
        <button data-ctx="color" title="Cor de Fundo">üé®</button>
        <button data-ctx="topics" title="T√≥picos">üìã</button>
        <button data-ctx="semantic-type" title="Definir Tipo Sem√¢ntico">‚òÑÔ∏é</button>
        <div style="width:1px; background:rgba(255,255,255,0.2); margin:0 5px; height:20px;"></div>
<button data-ctx="text-link" title="Anexar Link ao Texto" style="color:var(--accent-color);">üîó</button>
        <button data-ctx="delete" title="Apagar Bloco" style="color:#e74c3c;">üóëÔ∏è</button>
    </div>

      <!-- NOVO: STATUS DE GRAVA√á√ÉO (EMPUBRADO PARA A DIREITA) -->
       <div style="margin-left: auto; padding-right: 10px; display: flex; align-items: center;">
            <span id="aq-save-status" class="save-status" style="cursor: pointer; font-size: 0.8em; font-weight: 500;"></span>
       </div>

    </div>

    <!-- O "Desktop" do Aqu√°rio -->
    <div id="aquarium-desktop">
        <!-- √Årea de Scroll -->
        <div id="aquarium-scroll-area">
            <!-- Onde os Fantasmas vivem -->
            <div id="aquarium-content-canvas">
                <!-- Um Fantasma inicial para come√ßar -->
                <div class="ghost-block" contenteditable="true" data-placeholder=""></div>
            </div>
        </div>
    </div>
</div>

<!-- POPUP DE TIPO SEM√ÇNTICO (‚òÑÔ∏é) -->
<div id="semantic-type-popup" style="display: none;">
    <div class="semantic-header">Definir como:</div>
    <button data-sem="h1">T√≠tulo H1</button>
    <button data-sem="h2">T√≠tulo H2</button>
    <button data-sem="p">Par√°grafo (Normal)</button>
    <button data-sem="sub">Subpar√°grafo</button>
    <button data-sem="note">Nota / Obs</button>
</div>

<!-- POPUP DO BURACO NEGRO (üï≥Ô∏è) -->
<div id="black-hole-modal" class="modal-overlay" style="z-index: 40000;">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 5px;">üï≥Ô∏è Itens Perdidos</h3>
        <p style="font-size:0.8em; color:var(--text-muted-color); margin-bottom:15px;">Recupere blocos que foram apagados nesta sess√£o.</p>
        
        <ul id="black-hole-list" class="move-list" style="flex-grow: 1; overflow-y: auto;">
            <li style="text-align:center; padding:20px; color:#888;">O buraco est√° vazio.</li>
        </ul>
        
        <div class="modal-actions" style="margin-top: 15px;">
            <button class="modal-btn secondary" onclick="document.getElementById('black-hole-modal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>


<!-- MODAL DE LIGA√á√ïES DE TEXTO (MULTIPLE LINKS) -->
<div id="text-link-modal" class="modal-overlay" style="z-index: 2147483647;">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="text-link-title">Refer√™ncia de Texto</h3>
        
        <!-- Campo de T√≠tulo (Preenchido com o texto selecionado) -->
        <label style="font-size:0.8em; color:var(--text-muted-color); margin-bottom:5px; display:block;">T√≠tulo da Refer√™ncia</label>
        <input type="text" id="text-link-name" placeholder="T√≠tulo..." 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">

        <!-- Contentor de URLs Din√¢micos -->
        <label style="font-size:0.8em; color:var(--text-muted-color); margin-bottom:5px; display:block;">Links / URLs</label>
        <div id="text-link-list" style="display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto; margin-bottom:10px;">
            <!-- Os inputs aparecem aqui -->
        </div>

        <!-- Bot√£o Adicionar Mais -->
        <button id="add-text-url-btn" style="background:none; border:1px dashed var(--accent-color); color:var(--accent-color); width:100%; padding:5px; border-radius:4px; cursor:pointer; margin-bottom:20px;">+ Adicionar Link</button>

        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('text-link-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="save-text-link-btn">Gravar</button>
        </div>
    </div>
</div>


</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
   <script type="module">
    
  // 1. Importa√ß√µes de Configura√ß√£o
    import { db, auth } from './js/firebase-config.js';
    import { BIBLE_DATA, BIBLICAL_BOOKS } from './js/bible-data.js';
    import { sanitizeHTML, debounce, removeAccents, escapeRegExp } from './js/utils.js';
    import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';



    // 2. Importa√ß√µes do Firestore
    import { 
    collection, query, where, addDoc, serverTimestamp, onSnapshot, 
    doc, getDoc, updateDoc, orderBy, getDocs, writeBatch, deleteField, deleteDoc,
    setDoc, limit, startAfter, runTransaction 
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // 3. Importa√ß√µes de Autentica√ß√£o
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";



document.addEventListener('DOMContentLoaded', () => {
    checkInitialConnection(); // Verifica a conex√£o ao carregar

    // 1. Gravar ao mudar de aba ou minimizar (Muito fi√°vel em telem√≥veis e PC)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        
        // A. Se estiver no Aqu√°rio
        const aquariumEnv = document.getElementById('aquarium-environment');
        if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
            console.log("üåä [SA√çDA] Aqu√°rio escondido. A gravar...");
            // Chama a fun√ß√£o de grava√ß√£o do aqu√°rio diretamente
            window.saveAquariumState();
        }
        
        // B. Se estiver num Post de Arquivo
        else if (activeEditingPostId) {
            console.log("üì± [SA√çDA] Post aberto. A gravar...");
            const tempId = activeEditingPostId;
            activeEditingPostId = null;
            window.activeEditingPostId = null;
            window.saveArchivePost(tempId);
        }

        // C. Se estiver numa Nota Normal (e houver altera√ß√µes pendentes)
        else if (currentSaveStatus === 'unsaved') {
            console.log("üìÑ [SA√çDA] Nota normal. A gravar...");
            executeSave();
        }
    }
});

// 2. Gravar ao perder o foco da janela (ex: clicar noutra janela do Windows)
window.addEventListener('blur', () => {
    if (currentSaveStatus === 'unsaved') {
        executeSave();
    }
});

    const modalObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const target = mutation.target;
                
                // Se o modal passou de 'none' para 'flex' (ou seja, abriu)
                if (target.style.display !== 'none' && target.style.display !== '') {
                    
                    // 1. Fecha a Barra de Ferramentas de Sele√ß√£o
                    if (selectionPopup) selectionPopup.style.display = 'none';

                     if (document.getElementById('insertion-popup')) document.getElementById('insertion-popup').style.display = 'none';

                    // 2. (Opcional) Fecha tamb√©m popups de sugest√£o (@ e #) se estiverem abertos
                    if (tagSuggestionPopup) tagSuggestionPopup.style.display = 'none';
                    if (entitySuggestionPopup) entitySuggestionPopup.style.display = 'none';
                    if (isTagPopupOpen) isTagPopupOpen = false;
                    if (isEntityPopupOpen) isEntityPopupOpen = false;
                }
            }
        });
    });

    // Ativa o observador em todos os elementos com a classe .modal-overlay
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modalObserver.observe(modal, { 
            attributes: true, 
            attributeFilter: ['style'] // S√≥ vigia altera√ß√µes no estilo (display block/none)
        });
    });
});


const editorElement = document.getElementById('note-content-editor');

if (editorElement) {
    editorElement.addEventListener('touchstart', (e) => {
        // Verifica se tocou num input de t√≠tulo ou textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.target.classList.contains('mini-note-title-input') || 
                e.target.classList.contains('redator-input') ||
                e.target.classList.contains('sign-title-input')) {
                
                // P√°ra a propaga√ß√£o. O evento fica "preso" no input.
                // Assim o pai (a caixa) n√£o sabe que houve toque e n√£o tenta mexer-se.
                e.stopPropagation(); 
            }
        }
    }, { passive: false }); // 'passive: false' permite que o input controle o evento
}

// --- REFER√äNCIAS AO DOM ---
const notebookContainer = document.querySelector('.notebook-container');
const leftPanelToggleBtn = document.getElementById('left-panel-toggle-btn');
const referencesPanel = document.getElementById('references-panel');
const referencesPanelTitle = document.getElementById('references-panel-title');
const referencesList = document.getElementById('references-list');
const referencesPanelCloseBtn = document.getElementById('references-panel-close-btn');
const leftPanelList = document.getElementById('left-panel-list');
const leftPanelTitle = document.getElementById('left-panel-title');
const middlePanelList = document.getElementById('file-list');
const middlePanelTitle = document.getElementById('middle-panel-title');
const backBtn = document.getElementById('back-btn');
const addItemBtn = document.getElementById('add-item-btn');
const editorPlaceholder = document.getElementById('editor-placeholder');
const editorArea = document.getElementById('editor-area');
const noteTitleInput = document.getElementById('note-title-input');
const newItemNameInput = document.getElementById('new-item-name');
const editorToolbar = document.getElementById('editor-toolbar');
const noteContentEditor = document.getElementById('note-content-editor');
const selectionPopup = document.getElementById('selection-popup');
const tagSuggestionPopup = document.getElementById('tag-suggestion-popup');
const tagSuggestionList = document.getElementById('tag-suggestion-list');
const saveStatusIndicator = document.getElementById('save-status-indicator');
const connectivityStatus = document.getElementById('connectivity-status');
const entitySuggestionPopup = document.getElementById('entity-suggestion-popup');
const entitySuggestionList = document.getElementById('entity-suggestion-list');
const noteSharePopup = document.getElementById('note-share-popup');
const noteShareToggle = document.getElementById('note-share-toggle');
const noteShareLinkContainer = document.getElementById('note-share-link-container');
const noteShareUrlInput = document.getElementById('note-share-url');
const copyNoteLinkBtn = document.getElementById('copy-note-link-btn');
const mobileBackBtn = document.getElementById('mobile-back-btn');
const debouncedScanAndLink = debounce(scanAndLinkEntities, 2000);
const MESES_LISTA = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
const ENTITY_CONFIG = {
    personagem: { collection: 'personagens', displayName: 'Personagens' },
    local: { collection: 'locais', displayName: 'Locais' },
    data: { collection: 'datas', displayName: 'Datas' },
    textobiblico: { collection: 'textosbiblicos', displayName: 'Textos B√≠blicos' },
    marcadores: { collection: 'marcadores', displayName: 'Marcadores' },
    cosmos: { collection: 'cosmos', displayName: 'Cosmos' },
    subcosmos: { collection: 'subcosmos', displayName: 'Sub-Cosmos' }
};

// 10 Cores diferentes das padr√£o (Azul/Verde/Laranja)
const DEFAULT_HIGHLIGHTS = [
    { code: "#8B0037", name: "Vermelho Coral" },    // Vermelho avermelhado
    { code: "#A05930", name: "Laranja Sol" },       // Laranja bem distinto
    { code: "#BAA81B", name: "Amarelo Intenso" },   // Amarelo "Post-it" forte
    { code: "#415329", name: "Verde Lima" },        // Verde amarelado
    { code: "#007B69", name: "Verde Esmeralda" },   // Verde menta forte
    { code: "#006967", name: "Turquesa" },          // Ciano vibrante
    { code: "#221B6C", name: "Roxo Lavanda" },      // Roxo el√©trico claro
    { code: "#7C1851", name: "Rosa Choque" },       // Rosa forte
    { code: "#4C5B67", name: "Cinza Met√°lico" }     // Neutro
];
const EXPLORER_RESULTS_PER_PAGE = 15;
const MICA_COLORS = [
    { name: 'Laranja', hex: '#e67e22' }, { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' }, { name: 'Verde', hex: '#2ecc71' },
    { name: 'Roxo', hex: '#9b59b6' }, { name: 'Rosa', hex: '#e91e63' },
    { name: 'Vermelho', hex: '#e74c3c' }, { name: 'Castanho', hex: '#795548' },
    { name: 'Cinza', hex: '#95a5a6' }
];
const CITATIONS_PER_PAGE = 10; // Limite por p√°gina
const DEFAULT_FILTERS = {
    all: false,
    notes: true,
    superfolders: false,
    archives: false,
    subnote: true,
    question: true,
    free: true,
    postit: true,
    topics: false,
    subtopics: false,
    highlights: false,
    bookmarks: false,
    personagem: false,
    local: false,
    data: false,
    cosmos: false,
    subcosmos: false,
    tags: false,
    fourthColumn: false
};
const MAX_POPUPS = 3;
const AUTO_BACKUP_INTERVAL = 50; 
const aqCanvasListener = document.getElementById('aquarium-content-canvas');
const MAX_AQ_POPUPS = 6;


// --- ESTADO DA APLICA√á√ÉO ---
  let currentUserData = null;
let allEntities = {};
let sessionUnlockedFolders = new Set(); 
let navigationStack = [];
let selectedNoteId = null;
let unsubscribeLeftPanel = null;
let unsubscribeMiddlePanel = null;
let saveTimeout = null;
let activeItemContext = null;
let currentSelectionRange = null;
let allTags = [];
let isTagPopupOpen = false;
let currentTagQueryRange = null;
let currentSaveStatus = 'hidden';
let isEntityPopupOpen = false;
let currentEntityQueryRange = null;
let activeReferenceEntity = { id: null, type: null, name: null };
let currentTab = 'note';
let SUPERFOLDER_ID = null;
let currentSuperfolderParentId = null;
let currentSuperfolderParentName = "Raiz Global";
let currentNoteTopics = {}; // Estado local dos t√≥picos da nota: { topicId: [subId1, subId2] }
let activeTopicIdForSelection = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Sele√ß√£o)
let activeTopicIdForManagement = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Gest√£o)
let currentViewMode = 'local'; // 'local' ou 'shared'
let systemSharedFolderId = null; // Vai guardar o ID da pasta "Partilhadas"
let isClosingNote = false;
let currentShortcutId = null;
window.topicTargetId = null;
let currentSuperfolderName = "";
let appSettings = {
    searchTagsInProtected: false,
    searchTopicsInProtected: false,
    searchAnchorsInProtected: false,
    searchGlobalInSuperfolder: false,
    showFullTitles: false // Nova defini√ß√£o
};
let currentBookmarkSort = 'texto'; // Op√ß√µes: 'texto', 'categoria', 'descricao'
let savedRange = null;
let userCustomHighlights = {}; // Cache dos nomes personalizados
let aggregationStack = []; // Para navegar nas pastas dentro do modal
let aggregationSelectedItems = []; // Guarda o HTML das caixas selecionadas
let aggregationTargetName = ""; // Nome da nova nota a criar
let aggregationParentId = null; // Onde a nova nota ser√° criada
let appendStack = [];  // Hist√≥rico de navega√ß√£o do modal
let currentNoteShareData = null;
let moveStack = []; // Hist√≥rico de navega√ß√£o (como no Append/Aggregation)
let itemToMoveRef = null; // Guarda o objeto do item que estamos a mover
let selectedDestFolderId = null; // Guarda o ID da pasta destino selecionada
let globalExplorerResults = []; // Guarda todos os resultados (Pastas + Notas)
let lastContentEditTime = 0;
let currentExplorerPage = 0;
let moveFolderLastDoc = null;
let currentArchiveId = null;
let currentArchiveData = null;
let activeEditingPostId = null; // ID do post que est√° aberto para edi√ß√£o
let archiveAutoSaveTimer = null;
let collabUnsubscribe = null; // Para parar de ouvir quando sair
let presenceInterval = null;  // Para o "heartbeat"
let currentLocks = {};        // Cache local dos bloqueios
let unsubscribeShared1 = null;
let unsubscribeShared2 = null;
let currentArchiveTab = 'prateleira';
let postToAssignDrawer = null; // Guarda o ID do post que vai para o gavet√£o
let colorHexBeingRenamed = null;
let isPanelEditMode = false;
let allFoundReferenceBoxes = [];
let currentReferencePageIndex = 0;
let noteStackMemory = [];
let listsStackMemory = [];
let currentlyOpenVerseName = null;
let isDossieEditMode = false;
let activeMicaId = null; 
let allCitationsResults = []; // Guarda todos os resultados encontrados
let currentCitationsPageIndex = 0; // Controla a p√°gina atual
let col1SelectedId = null;
let selectedCosmosEmoji = "üíº"; // Antes era ü™ê
let tempEditEmoji = "üíº";
let currentDossieVersion = 0;
let globalSearchScope = 'paragraph'; 
let activeGavetaId = null; // Controla se estamos visualizando uma gaveta espec√≠fica
let activeGavetaData = null;
let selectedCategoriesForBox = []; 
let categoryFullResults = []; // Armazena todos os matches encontrados
let categoryDisplayCount = 0; // Quantos itens est√£o vis√≠veis no momento
let userLastSeenArchives = {};
let sessionStartTimeForArchive = 0;
let journalCursorRange = null;
let activeSignBtn = null;
let activeEditRow = null;
let activeCardImageElement = null;
let currentNoteType = null;
let activeRedatorPopups = [];
let highestZIndex = 10000;
let mDragCube = null;        // O cubo original
let mDragClone = null;       // O fantasma visual que segue o dedo
let mDragTarget = null;      // Onde vamos largar
let mTouchOffsetX = 0;
let mTouchOffsetY = 0;
let currentMobileRequestId = 0;
let currentNoteAnchors = {}; // Guarda o estado: { anchorId: true }
let anchorLastDoc = null;    // Cursor para pagina√ß√£o
let currentAnchorSearch = ""; 
let activeNoteAnchorsIds = []; 
let unsubscribeCurrentNote = null;
let aqListStack = [];
let aqLiveTimer = null;
let activeAquariumPopups = []; 
let activeStoreGhostId = null;
let scrollTimer = null;
let aqAutoSaveTimer = null;
let hasGlobalShareNotification = false;
let globalFoldersCache = []; 


window.currentNoteHybridMode = false;
window.activeStoreGhostId = null;
window.nextSelectedId = null;
window.activeMiniNoteElement = null;
window.activeWrapperForColor = null;
window.htmlToAppend = "";
window.activeStorePopups = window.activeStorePopups || [];





// Fun√ß√£o: Grava√ß√£o Silenciosa (Mant√©m o editor aberto)
// Usada pelo temporizador de 3 minutos e pelo clique no status
async function saveCurrentPostInBackground() {
    if (!activeEditingPostId) return;

    const postDiv = document.getElementById(`post-${activeEditingPostId}`);
    if (!postDiv) return;

    const statusEl = document.getElementById('archive-save-status');
    statusEl.textContent = "A guardar auto...";

    // 1. Capturar Dados do DOM
    const titleInput = postDiv.querySelector('.post-title-input');
    const contentEditor = postDiv.querySelector('.post-editor-content');

    if (titleInput && contentEditor) {
        const postIndex = currentArchiveData.posts.findIndex(p => p.id === activeEditingPostId);
        if (postIndex > -1) {
            
            // L√≥gica de T√≠tulo (Igual ao Save normal)
            let finalTitle = titleInput.value.trim();
            if (!finalTitle) finalTitle = "Sem T√≠tulo";

            // Sincroniza HTML interno (Entidades)
            const internalInput = contentEditor.querySelector('.mini-note-title-input');
            if (internalInput) internalInput.setAttribute('value', finalTitle);
            
            const internalH2 = contentEditor.querySelector('summary h2');
            if (internalH2) internalH2.textContent = finalTitle;

            // Atualiza Mem√≥ria
            currentArchiveData.posts[postIndex].title = finalTitle;
            currentArchiveData.posts[postIndex].content = contentEditor.innerHTML;
            currentArchiveData.posts[postIndex].updatedAt = Date.now();
        }
    }

    // 2. Gravar na BD (Sem fechar o editor)
    await saveFullArchive();
    
    // Reset do Status Visual
    statusEl.textContent = "Guardado";
    setTimeout(() => {
        if(statusEl.textContent === "Guardado") statusEl.textContent = "Guardado";
    }, 2000);
}



// Carrega do localStorage ou usa o padr√£o
window.searchFilters = JSON.parse(localStorage.getItem('jwn_search_filters')) || DEFAULT_FILTERS;

window.updateSearchFilter = function(property, value) {
    window.searchFilters[property] = value;
    
    // Se desativar qualquer um, o "Todos" deixa de estar ativo
    if (!value) {
        window.searchFilters.all = false;
        const allCb = document.getElementById('f-all');
        if (allCb) allCb.checked = false;
    }
    
    // Grava no navegador para n√£o perder ao fechar
    localStorage.setItem('jwn_search_filters', JSON.stringify(window.searchFilters));
};

window.toggleAllFilters = function(checked) {
    window.searchFilters.all = checked;
    Object.keys(window.searchFilters).forEach(key => {
        window.searchFilters[key] = checked;
        const el = document.getElementById(`f-${key}`);
        if (el) el.checked = checked;
    });
    localStorage.setItem('jwn_search_filters', JSON.stringify(window.searchFilters));
};


// --- NOVA FUN√á√ÉO: Reconstruir caminho para uma Pasta ---
async function reconstructFolderNavigation(targetFolderId, targetNoteId = null) {
    let currentId = targetFolderId;
    const path = [];
    let safety = 0;

    // Sobe na √°rvore geneal√≥gica at√© encontrar a raiz
    while (currentId && safety < 20) {
        const docSnap = await getDoc(doc(db, 'pastas', currentId));
        
        if (!docSnap.exists()) break;
        
        const data = docSnap.data();
        
        // Adiciona ao IN√çCIO do array
        path.unshift({ id: docSnap.id, name: data.nome });
        
        currentId = data.parentId; 
        safety++;
    }

    // Define o hist√≥rico de navega√ß√£o
    navigationStack = path;
    
    // AQUI EST√Å A CORRE√á√ÉO:
    // Passamos o targetNoteId (o ID da nota nova) para a fun√ß√£o que desenha a lista.
    // Assim a lista j√° nasce com a nota pintada de azul.
    updateNavigationView(false, targetNoteId);
}

// --- PROTE√á√ÉO DE ROTA E CARREGAMENTO DE USU√ÅRIO ---
 onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('app-loader');
    const container = document.querySelector('.notebook-container');

    if (!user) {
        // üõ°Ô∏è SEGURO: Se n√£o h√° login, salta para fora. 
        // Como o container est√° com "display: none", o interior nunca √© visto.
        window.location.href = "index.html";
        return; 
    } else {
        console.log("üîê Login confirmado. A preparar dados...");

        // --- TODA A TUA L√ìGICA DE CARREGAMENTO (Par√¢metros, Perfil, Pastas) ---
        const params = new URLSearchParams(window.location.search);
        const urlRootId = params.get('rootId');
        const openFolderId = params.get('openFolder'); 
        const targetNoteId = params.get('noteId');
        const redirectSearch = params.get('search');
        const viewParam = params.get('view');
        const openArchiveId = params.get('openArchive'); 
        const modeParam = params.get('mode');           

        SUPERFOLDER_ID = urlRootId || null; 
        if (viewParam === 'shared' || modeParam === 'collab') currentViewMode = 'shared';

        try {
            // Carregar Perfil e Configura√ß√µes
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) currentUserData = userDoc.data();
            
            const configRef = doc(db, "configuracoes", user.uid);
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) appSettings = { ...appSettings, ...configSnap.data() };

            // >>> INICIALIZA√á√ÉO DO MOTOR DE NOTIFICA√á√ïES GLOBAIS <<<
            // Inicia o listener silencioso para acender a luz vermelha na aba Share
            if (typeof startGlobalNotificationListener === 'function') {
                startGlobalNotificationListener();
            }

            // Inicializar a navega√ß√£o (Pastas/Arquivos)
            if (openFolderId) {
                await reconstructFolderNavigation(openFolderId, targetNoteId);
            } else if (SUPERFOLDER_ID) {
                const rootSnap = await getDoc(doc(db, 'pastas', SUPERFOLDER_ID));
                if (rootSnap.exists()) {
                    currentSuperfolderName = rootSnap.data().nome;
                    updateNavigationView(false, targetNoteId);
                }
            } else {
                updateNavigationView(false, targetNoteId); 
            }

            if (targetNoteId) displayNote(targetNoteId, null, redirectSearch);
            if (openArchiveId) {
                const arcSnap = await getDoc(doc(db, 'pastas', openArchiveId));
                if (arcSnap.exists()) displayArchive(openArchiveId, arcSnap.data());
            }

            // Iniciar caches de fundo
            fetchAllEntities();
            fetchAllTags();
            loadUserHighlights();

        } catch (e) { console.error(e); }

        // ============================================================
        // üöÄ O MOMENTO DA REVELA√á√ÉO (S√≥ ap√≥s os dados estarem prontos)
        // ============================================================
        
        // 1. Esperamos um pequeno f√¥lego para o navegador processar o HTML das listas
        setTimeout(() => {
            if (container) {
                // Remove o "display: none" e mostra a interface
                container.style.setProperty('display', 'flex', 'important');
            }
            
            if (loader) {
                // Efeito suave de sa√≠da do loader
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.remove();
                }, 500);
            }
        }, 800); // 800ms √© o tempo perfeito para evitar qualquer "pulo" visual
    }
});

     

// --- FUN√á√ÉO PARA SALVAR CONFIGURA√á√ïES ---
async function saveUserSettings() {
    if (!auth.currentUser) return;
    
    // 1. Atualiza a vari√°vel global de imediato
    appSettings.showFullTitles = document.getElementById('setting-full-titles').checked;
    appSettings.searchTagsInProtected = document.getElementById('setting-search-tags').checked;
    appSettings.searchTopicsInProtected = document.getElementById('setting-search-topics').checked;
    appSettings.searchAnchorsInProtected = document.getElementById('setting-search-anchors').checked;

    // 2. Tenta aplicar o efeito agora (se houver nota aberta)
    applyTitleWrappingEffect();

    // 3. Salva no Firebase para persist√™ncia
    try {
        const configRef = doc(db, 'configuracoes', auth.currentUser.uid);
        await setDoc(configRef, appSettings, { merge: true });
    } catch (e) {
        console.error("Erro ao salvar:", e);
    }
}

// Adicione os listeners aos checkboxes
document.getElementById('setting-search-tags').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-topics').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-anchors').addEventListener('change', saveUserSettings);
document.getElementById('setting-full-titles').addEventListener('change', saveUserSettings);

const globalSearchToggle = document.getElementById('setting-global-search-superfolder');
if (globalSearchToggle) {
    globalSearchToggle.addEventListener('change', saveUserSettings);
}



// --- GEST√ÉO DE ESTADO E CONECTIVIDADE ---

function updateSaveStatus(status) {
    currentSaveStatus = status;
    if (!saveStatusIndicator) return;

    saveStatusIndicator.classList.remove('status-saved', 'status-error');
    switch (status) {
        case 'unsaved':
            saveStatusIndicator.textContent = 'por guardar...';
            break;
        case 'saving':
            saveStatusIndicator.textContent = 'A guardar...';
            break;
        case 'saved':
            saveStatusIndicator.textContent = 'Guardado';
            saveStatusIndicator.classList.add('status-saved');
            break;
        case 'error':
            saveStatusIndicator.textContent = 'Erro ao guardar';
            saveStatusIndicator.classList.add('status-error');
            break;
        case 'hidden':
        default:
            saveStatusIndicator.textContent = '';
            break;
    }
}

function handleOffline() {
    connectivityStatus.textContent = 'Sem liga√ß√£o';
    connectivityStatus.classList.add('visible');
    updateSaveStatus('error'); 
    saveStatusIndicator.textContent = 'Offline - Altera√ß√µes n√£o guardadas';
}

function handleOnline() {
    connectivityStatus.classList.remove('visible');
    updateSaveStatus('saving');
    clearTimeout(saveTimeout);
    saveNote();
}

function checkInitialConnection() {
    if (!navigator.onLine) {
        handleOffline();
         leaveArchivePresence();
    }
}

/**
 * Verifica se existem altera√ß√µes n√£o guardadas antes de executar uma a√ß√£o de navega√ß√£o.
 * @param {function} navigationAction A fun√ß√£o a ser executada se a navega√ß√£o for confirmada.
 */
async function navigateWithUnsavedCheck(navigationAction) {
    // Verifica se h√° algo por guardar
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        const savingModal = document.getElementById('forcing-save-modal');
        
        if (savingModal) {
            console.log("‚è≥ Mostrando painel de grava√ß√£o for√ßada...");
            // MOVE PARA O TOPO E FOR√áA VISIBILIDADE
            document.body.appendChild(savingModal);
            savingModal.style.setProperty('display', 'flex', 'important');
            savingModal.style.zIndex = "9999999"; // O n√≠vel mais alto
            savingModal.style.opacity = "1";
            savingModal.style.visibility = "visible";
        }

        try {
            // Executa a grava√ß√£o e ESPERA (await) que o Firebase confirme
            await saveNote(true); 

            // Esconde o painel ap√≥s o sucesso
            if (savingModal) savingModal.style.display = 'none';
            
            // Segue com a navega√ß√£o que o utilizador queria fazer
            navigationAction();

        } catch (error) {
            console.error("‚ùå Erro na grava√ß√£o for√ßada:", error);
            if (savingModal) savingModal.style.display = 'none';
            alert("N√£o foi poss√≠vel guardar as altera√ß√µes. Verifique a sua liga√ß√£o.");
        }
    } else {
        // Se j√° estava tudo guardado, apenas navega
        navigationAction();
    }
}

// --- 1. FUN√á√ïES DE ABERTURA E RENDERIZA√á√ÉO (MODAL SELE√á√ÉO) ---

async function openTopicsModal(targetId, type) {
    if (!targetId) return alert("Erro: Nenhum item selecionado.");

    console.log(`üöÄ Abrindo painel de gest√£o para ${type}: ${targetId}`);
    
    // 1. CONFIGURA√á√ÉO DE ESTADO
    topicTargetId = targetId; 
    activeMiniNoteElement = null; 

    // Reset das vari√°veis das √¢ncoras
    currentNoteAnchors = {};
    anchorLastDoc = null;
    currentAnchorSearch = "";
    document.getElementById('anchor-search-input').value = "";

    const modal = document.getElementById('topics-modal');
    if (!modal) return;

    // 2. FOR√áAR VISIBILIDADE
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 3. RESET DE ABAS (Volta sempre para T√≥picos)
    document.querySelectorAll('#topics-modal-tabs button').forEach(b => b.classList.remove('active'));
    document.querySelector('#topics-modal-tabs button[data-tab="topics"]').classList.add('active');
    document.getElementById('tm-content-topics').style.display = 'flex';
    document.getElementById('tm-content-anchors').style.display = 'none';

    // --- NOVO: Resetar o bot√£o H√≠brido ---
    // Como a aba inicial √© T√≥picos, o bot√£o h√≠brido deve come√ßar escondido
    const hybridContainer = document.getElementById('hybrid-toggle-container');
    if (hybridContainer) hybridContainer.style.display = 'none';

    // 4. CARREGAR DADOS ATUAIS (T√ìPICOS E √ÇNCORAS)
    try {
        let data = {};
        
        // Se for caixa (subnota)
        if (targetId instanceof HTMLElement || (typeof targetId === 'object' && targetId.dataset)) {
             // L√≥gica para caixa
        } else {
            // Nota ou Pasta
            const docSnap = await getDoc(doc(db, 'pastas', targetId));
            if (docSnap.exists()) data = docSnap.data();
        }

        // Carrega T√≥picos
        currentNoteTopics = data.topicosSelecionados || {};
        
        // Carrega √Çncoras
        currentNoteAnchors = data.ancorasSelecionadas || {};

        // --- NOVO: CARREGAR ESTADO H√çBRIDO ---
        const isHybrid = data.isHybridMode || false;
        const hybridToggle = document.getElementById('hybrid-mode-toggle');
        if (hybridToggle) {
            hybridToggle.checked = isHybrid;
        }

        // Renderiza a lista de T√≥picos (Aba 1)
        activeTopicIdForSelection = null;
        document.getElementById('subtopics-list-select').innerHTML = '<li style="color: #888; font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>';
        await renderTopicsSelectionList();

        // Limpa a lista de √Çncoras (Aba 2) para carregar apenas quando clicar na aba
        document.getElementById('note-anchors-list').innerHTML = '';

    } catch (e) {
        console.error("Erro ao carregar dados da nota:", e);
    }
}

async function renderTopicsSelectionList() {
    const list = document.getElementById('topics-list-select');
    if (!list) return;

    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    try {
        console.log("üì° [FIREBASE] Buscando t√≥picos...");
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        if (snapshot.empty) {
            console.log("‚ÑπÔ∏è [FIREBASE] Nenhum t√≥pico encontrado.");
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum t√≥pico criado.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            const topic = { id: docSnap.id, ...docSnap.data() };
            const li = document.createElement('li');
            
            // Verifica se este t√≥pico (ou subt√≥picos dele) j√° est√£o no data-topics da caixa
            const isSelected = !!currentNoteTopics[topic.id];
            
            li.innerHTML = `
                <input type="checkbox" class="topic-checkbox" ${isSelected ? 'checked' : ''}>
                <span>${topic.nome}</span>
            `;

            li.onclick = () => {
                activeTopicIdForSelection = topic.id;
                document.querySelectorAll('#topics-list-select li').forEach(el => el.classList.remove('active-topic'));
                li.classList.add('active-topic');
                renderSubtopicsSelectionList(topic.id, topic.nome);
            };

            const cb = li.querySelector('.topic-checkbox');
            cb.onclick = (e) => {
                e.stopPropagation();
                toggleTopicSelection(topic.id, cb.checked);
            };

            list.appendChild(li);
        });
        console.log("üé® [UI] Lista de t√≥picos renderizada.");

    } catch (error) {
        console.error("‚ùå [ERRO] Falha ao renderizar lista de t√≥picos:", error);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar.</li>';
    }
}

async function renderSubtopicsSelectionList(topicId, topicName) {
    const list = document.getElementById('subtopics-list-select');
    const title = document.getElementById('subtopics-title-select');
    
    title.textContent = `Subt√≥picos de "${topicName}"`;
    list.innerHTML = '<li>A carregar...</li>';

    const q = query( collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome') );
    const snapshot = await getDocs(q);

    list.innerHTML = '';

    if (snapshot.empty) {
        list.innerHTML = '<li style="font-style:italic; color: #888;">Nenhum subt√≥pico dispon√≠vel.</li>';
        return;
    }

    // Obt√©m os subt√≥picos j√° selecionados para este t√≥pico espec√≠fico
    const selectedSubtopics = currentNoteTopics[topicId] || [];

    snapshot.forEach(doc => {
        const sub = { id: doc.id, ...doc.data() };
        const isSelected = selectedSubtopics.includes(sub.id);

        const li = document.createElement('li');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'topic-checkbox';
        checkbox.checked = isSelected;
        
        checkbox.onclick = (e) => {
            e.stopPropagation();
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };
        
        // Clicar na linha tamb√©m seleciona
        li.onclick = () => {
            checkbox.checked = !checkbox.checked;
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };

        const span = document.createElement('span');
        span.textContent = sub.nome;

        li.appendChild(checkbox);
        li.appendChild(span);
        list.appendChild(li);
    });
}

// --- 2. L√ìGICA DE SELE√á√ÉO (ESTADO LOCAL) ---

function toggleTopicSelection(topicId, isChecked) {
    if (isChecked) {
        // Se n√£o existia, cria entrada (array vazio de subt√≥picos)
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
        }
    } else {
        // Se desmarcar o t√≥pico, removemos tudo (incluindo subt√≥picos)
        delete currentNoteTopics[topicId];
        // Se este era o t√≥pico ativo na direita, atualiza a UI da direita
        if (activeTopicIdForSelection === topicId) {
             const subInputs = document.querySelectorAll('#subtopics-list-select input');
             subInputs.forEach(input => input.checked = false);
        }
    }
}

function toggleSubtopicSelection(topicId, subtopicId, isChecked) {
    // Se selecionar um subt√≥pico, garantimos que o pai est√° selecionado
    if (isChecked) {
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
            // Atualiza visualmente o checkbox do pai na esquerda
            renderTopicsSelectionList(); // Re-renderiza para atualizar o check
        }
        if (!currentNoteTopics[topicId].includes(subtopicId)) {
            currentNoteTopics[topicId].push(subtopicId);
        }
    } else {
        // Remove o subt√≥pico do array
        if (currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = currentNoteTopics[topicId].filter(id => id !== subtopicId);
        }
    }
}

editorToolbar.addEventListener('mousedown', (e) => {
    
    // --- 1. VERIFICA√á√ÉO DE PONTOS (‚Ä¢‚Ä¢) ---
    if (e.target.classList.contains('dots-trigger')) {
        e.preventDefault();
        e.stopPropagation();

        // Identifica qual o bot√£o pai (B ou I)
        const parentBtn = e.target.closest('button');
        const command = parentBtn.dataset.command;
        
        let popupId = '';
        if (command === 'boldBlue') popupId = 'bold-palette-popup';
        if (command === 'italic')   popupId = 'italic-palette-popup'; // Novo ID

        const popup = document.getElementById(popupId);
        if (!popup) return;

        // Fecha outros popups para n√£o sobrepor
        document.querySelectorAll('#bold-palette-popup, #italic-palette-popup').forEach(p => {
            if(p.id !== popupId) p.style.display = 'none';
        });

        document.body.appendChild(popup);

        if (popup.style.display === 'block') {
            popup.style.display = 'none';
        } else {
            const rect = e.target.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed';
            popup.style.zIndex = "5000";
            popup.style.top = `${rect.bottom + 5}px`;
            popup.style.left = `${rect.left - 100}px`; 
        }
        return; 
    }

    // --- 2. VERIFICA√á√ÉO DE BOT√ÉO (Corpo) ---
    const target = e.target.closest('button');
    if (!target || target.tagName === 'INPUT') return;

    if (target.dataset.command) {
        e.preventDefault(); 
        const command = target.dataset.command;

        // A. Negrito Azul
        if (command === 'boldBlue') {
            // Usa a fun√ß√£o inteligente que j√° cri√°mos, for√ßando Azul
            // Se j√° for bold azul, mant√©m. Se n√£o for, aplica.
            applyColorStyle('bold', '#4a90e2'); 
        } 
        // B. It√°lico (Padr√£o: sem cor ou branco/tema)
        else if (command === 'italic') {
            // Clicar no corpo do I faz it√°lico simples (toggle normal)
            document.execCommand('italic', false, null);
        }
        // C. Tamanho Fonte
        else if (command.includes('FontSize')) {
            /* ... (c√≥digo existente de tamanho) ... */
             const currentSize = window.getComputedStyle(noteContentEditor, null).getPropertyValue('font-size');
            let newSize = parseFloat(currentSize) + (command === 'increaseFontSize' ? 1 : -1);
            document.execCommand("fontSize", false, "7");
            const selection = window.getSelection();
            if (selection.anchorNode && selection.anchorNode.parentNode) {
                let fontElement = selection.anchorNode.parentNode;
                if (fontElement.nodeType === 3) fontElement = fontElement.parentNode;
                if (fontElement.tagName === 'FONT') {
                    fontElement.removeAttribute('size');
                    fontElement.style.fontSize = newSize + "px";
                }
            }
        } 
        // D. Outros
        else {
            document.execCommand(command, false, null);
        }
        saveNote();
    }
});



// ------------------------------------------------------------------
// L√ìGICA DE MARCADORES (BOOKMARKS)
// ------------------------------------------------------------------

// 1. Abrir o Modal Principal de Marcadores
async function openBookmarksModal() {
    console.log("üöÄ [IN√çCIO] openBookmarksModal acionado.");
    
    const modal = document.getElementById('bookmarks-modal');
    const list = document.getElementById('bookmarks-list');
    
    if (!modal || !list) {
        console.error("‚ùå [ERRO] Elementos do modal n√£o encontrados no DOM.");
        return;
    }

    // 1. FOR√áAR EXIBI√á√ÉO IMEDIATA (Para sabermos que o JS chegou aqui)
    document.body.appendChild(modal); // Move para a raiz para evitar ser tapado
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
    modal.style.opacity = "1";
    modal.style.visibility = "visible";

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar marcadores...</span></div>';

    if (!activeReferenceEntity || activeReferenceEntity.type !== 'textobiblico') {
        console.warn("‚ö†Ô∏è Entidade ativa n√£o √© texto b√≠blico ou est√° vazia.", activeReferenceEntity);
        list.innerHTML = '<li style="padding:20px; color:orange;">Selecione um vers√≠culo b√≠blico primeiro.</li>';
        return;
    }

    try {
        const nameToFind = activeReferenceEntity.name;
        const myUid = auth.currentUser.uid;
        console.log("üì° [FIREBASE] Iniciando busca para:", nameToFind, "UID:", myUid);

        // A. Buscar se o texto j√° existe no DB do usu√°rio
        const qTexto = query(
            collection(db, 'textosbiblicos'), 
            where('nome', '==', nameToFind),
            where('userId', '==', myUid)
        );
        
        const textoSnap = await getDocs(qTexto);
        let marcadoresAssociados = {};
        
        if (!textoSnap.empty) {
            console.log("‚úÖ Texto b√≠blico encontrado no DB.");
            const data = textoSnap.docs[0].data();
            marcadoresAssociados = data.marcadoresAssociados || {};
            activeReferenceEntity.id = textoSnap.docs[0].id;
        } else {
            console.log("‚ÑπÔ∏è Texto b√≠blico novo (ainda n√£o est√° no DB).");
        }

        // B. Buscar lista global de Marcadores do usu√°rio
        console.log("üì° [FIREBASE] Buscando lista de g√™neros de marcadores...");
        const qMarcadores = query(
            collection(db, 'marcadores'), 
            where('userId', '==', myUid), 
            orderBy('nome')
        );
        
        const marcadoresSnap = await getDocs(qMarcadores);
        console.log("üìä Total de marcadores encontrados:", marcadoresSnap.size);

        list.innerHTML = '';

        if (marcadoresSnap.empty) {
            list.innerHTML = `
                <li style="padding: 20px; text-align: center; color: #888;">
                    Nenhum marcador criado.<br>
                    <button class="modal-btn primary" style="margin-top:10px;" onclick="document.getElementById('open-create-bookmark-btn').click()">+ Criar Novo Marcador</button>
                </li>`;
            return;
        }

        marcadoresSnap.forEach(docSnap => {
            const marcador = { id: docSnap.id, ...docSnap.data() };
            const isChecked = !!marcadoresAssociados[marcador.id]; 

            const li = document.createElement('li');
            li.className = `bookmark-item ${isChecked ? 'active' : ''}`;
            li.innerHTML = `
                <div class="bookmark-info">
                    <span class="bookmark-title">${marcador.nome}</span>
                    <span class="bookmark-desc">${marcador.descricao || ''}</span>
                </div>
                <div class="bookmark-check"></div>
            `;

            li.onclick = () => toggleBookmark(marcador.id, !li.classList.contains('active'), li);
            list.appendChild(li);
        });

    } catch (error) {
        console.error("‚ùå [ERRO CR√çTICO] Falha no openBookmarksModal:", error);
        list.innerHTML = `<li style="color:red; padding:20px;">
            <strong>Erro ao carregar:</strong><br>
            ${error.message}<br><br>
            <small>Verifique se os √≠ndices do Firestore foram criados.</small>
        </li>`;
    }
}

async function toggleBookmark(marcadorId, shouldAdd, liElement) {
    // Atualiza√ß√£o Visual Imediata (Feedback R√°pido)
    if (shouldAdd) liElement.classList.add('active');
    else liElement.classList.remove('active');

    // Atualiza o listener para o pr√≥ximo clique (toggle inverso)
    liElement.onclick = () => toggleBookmark(marcadorId, !shouldAdd, liElement);

    // Atualiza T√≠tulo em Tempo Real
    const activeCount = document.querySelectorAll('#bookmarks-list .bookmark-item.active').length;
    const titleElement = document.getElementById('references-panel-title');
    const entityName = activeReferenceEntity.name;

    if (titleElement) {
        titleElement.textContent = activeCount > 0 
            ? `Refer√™ncias para üîñ"${entityName}"` 
            : `Refer√™ncias para "${entityName}"`;
    }

    try {
        const { collection, query, where, getDocs, addDoc, updateDoc, doc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let targetId = activeReferenceEntity.id;
        let docRef;

        // 1. VERIFICA√á√ÉO DE EXIST√äNCIA (O Segredo da Corre√ß√£o)
        // Se o ID for igual ao Nome (indicando que ainda n√£o tem ID real) ou se sabemos que √© novo
        const q = query(
            collection(db, 'textosbiblicos'), 
            where('nome', '==', entityName),
            where('userId', '==', auth.currentUser.uid)
        );
        
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            // --- CEN√ÅRIO A: N√ÉO EXISTE -> CRIAR NOVO ---
            console.log("üÜï Criando registo para o vers√≠culo na BD...");
            
            const newDoc = await addDoc(collection(db, 'textosbiblicos'), {
                nome: entityName,
                descricao: "", // Descri√ß√£o vazia por defeito
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                // Se estamos a adicionar, j√° cria com o marcador. Se for remover (raro num novo), cria vazio.
                marcadoresAssociados: shouldAdd ? { [marcadorId]: true } : {},
                referencias: {} 
            });

            // Atualiza o ID globalmente para pr√≥ximos cliques n√£o criarem duplicados
            targetId = newDoc.id;
            activeReferenceEntity.id = newDoc.id;
            
            console.log("‚úÖ Vers√≠culo criado com ID:", targetId);
            return; // Sai, pois o addDoc j√° gravou o marcador
        } else {
            // --- CEN√ÅRIO B: J√Å EXISTE -> PEGAR ID REAL ---
            targetId = snapshot.docs[0].id;
            activeReferenceEntity.id = targetId; // Atualiza refer√™ncia para garantir
        }

        // 2. ATUALIZA√á√ÉO (UPDATE)
        docRef = doc(db, 'textosbiblicos', targetId);

        if (shouldAdd) {
            await updateDoc(docRef, { [`marcadoresAssociados.${marcadorId}`]: true });
        } else {
            await updateDoc(docRef, { [`marcadoresAssociados.${marcadorId}`]: deleteField() });
        }

    } catch (error) {
        console.error("‚ùå Erro ao atualizar marcador:", error);
        alert("Erro de conex√£o ao gravar marcador.");
        
        // Reverter visual em caso de erro
        if (shouldAdd) liElement.classList.remove('active');
        else liElement.classList.add('active');
    }
}

// --- FUN√á√ÉO UTILIT√ÅRIA PARA O PROMPT PERSONALIZADO ---
window.showCustomInput = function(title, namePlaceholder = "", initialValue = "") {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-input-modal');
        if (!modal) return resolve(null);

        const titleEl = document.getElementById('custom-input-title');
        const nameInput = document.getElementById('custom-input-name');
        const descInput = document.getElementById('custom-input-desc'); // √Årea da descri√ß√£o
        const confirmBtn = document.getElementById('custom-input-confirm');
        const cancelBtn = document.getElementById('custom-input-cancel');

        // --- O SEGREDO: ESCONDER A DESCRI√á√ÉO ---
        if (descInput) {
            descInput.style.display = 'none'; // Esconde a caixa de texto
            // Esconde tamb√©m a etiqueta (label) que est√° logo acima dela
            if (descInput.previousElementSibling) {
                descInput.previousElementSibling.style.display = 'none';
            }
        }

        document.body.appendChild(modal);

        modal.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            background-color: rgba(0, 0, 0, 0.9) !important;
            z-index: 2147483647 !important;
            justify-content: center !important;
            align-items: center !important;
            pointer-events: auto !important;
        `;

        titleEl.textContent = title;
        nameInput.value = initialValue;
        nameInput.placeholder = namePlaceholder;

        // Foco autom√°tico no Nome para abrir o teclado
        setTimeout(() => {
            nameInput.focus();
            const len = nameInput.value.length;
            nameInput.setSelectionRange(len, len);
        }, 300);

        const cleanup = () => { 
            modal.style.setProperty('display', 'none', 'important'); 
        };

        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        const newCancel = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        newConfirm.onclick = (e) => {
            e.preventDefault();
            const val = nameInput.value.trim();
            if (!val) return;
            cleanup();
            // Retorna apenas o nome, descri√ß√£o vai vazia
            resolve({ name: val, description: "" }); 
        };

        newCancel.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
};



// ============================================================
// L√ìGICA DO MODAL DE GEST√ÉO (CRIAR T√ìPICOS)
// ============================================================

// A. LISTENER DE CLIQUE NO BOT√ÉO üìã
noteContentEditor.addEventListener('click', (e) => {

    const topicBtn = e.target.closest('button[data-action="manage-mini-note-topics"]');
    
    if (topicBtn) {
        console.log("‚úÖ Bot√£o üìã identificado com sucesso!");
        e.preventDefault(); 
        e.stopPropagation();
        
        const wrapper = topicBtn.closest('.mini-note-wrapper');
        if (wrapper) {
            console.log("üì¶ Pai .mini-note-wrapper encontrado (ID:", wrapper.id, ")");
            openTopicsModalForMiniNote(wrapper);
        } else {
            console.error("‚ùå ERRO: Clique no bot√£o üìã mas n√£o encontrei o pai .mini-note-wrapper.");
        }
    } else {
    }
});

// OUVINTE PARA O FEED DO ARQUIVO (Caso use t√≥picos l√° tamb√©m)
const archiveFeedEl = document.getElementById('archive-feed');
if (archiveFeedEl) {
    archiveFeedEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="manage-mini-note-topics"]');
        if (btn) {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openTopicsModalForMiniNote(wrapper);
        }
    });
}

// B. FUN√á√ÉO PARA ABRIR O MODAL (Modo SubNota)
window.openTopicsModalForMiniNote = async function(wrapperElement) {
    console.log("üöÄ [T√ìPICOS] Iniciando abertura para caixa...");

    if (!wrapperElement) return console.error("‚ùå [ERRO] wrapperElement nulo.");

    // 1. Configura√ß√£o de Estado Global
    window.activeMiniNoteElement = wrapperElement; 
    window.topicTargetId = null; 

    // 2. Leitura dos Dados
    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    try {
        currentNoteTopics = JSON.parse(topicsString);
    } catch (e) {
        console.warn("‚ö†Ô∏è JSON de t√≥picos inv√°lido, resetando.");
        currentNoteTopics = {};
    }

    // 3. CAPTURA E MOVIMENTA√á√ÉO DO MODAL
    const modal = document.getElementById('topics-modal');
    if (!modal) return console.error("‚ùå Modal #topics-modal n√£o encontrado!");

    // Move para o body (topo da hierarquia)
    document.body.appendChild(modal);

    // 4. FOR√áAR VISIBILIDADE SUPREMA (Z-Index: 2147483647)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.85) !important;
        justify-content: center !important;
        align-items: center !important;
    `;

    // 5. Configura√ß√£o Visual
    const modalTitle = modal.querySelector('h3');
    if (modalTitle) {
        const isQuestion = wrapperElement.classList.contains('question-mode');
        modalTitle.textContent = isQuestion ? "T√≥picos da Quest√£o" : "T√≥picos do Bloco";
    }

    // Reset de busca e sele√ß√£o anterior
    activeTopicIdForSelection = null;
    const subList = document.getElementById('subtopics-list-select');
    if(subList) subList.innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico √† esquerda.</li>';

    // 6. Carregar a Lista
    if (typeof renderTopicsSelectionList === 'function') {
        await renderTopicsSelectionList();
    } else {
        console.error("‚ùå Fun√ß√£o renderTopicsSelectionList n√£o encontrada!");
    }
};

// --- FUN√á√ÉO UNIFICADA E √öNICA PARA O BOT√ÉO GRAVAR T√ìPICOS ---
document.getElementById('save-topics-btn').onclick = async () => {
    const btn = document.getElementById('save-topics-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "A gravar...";

    try {
        // --- CEN√ÅRIO A: Caixa Individual (Aqu√°rio ou Subnota) ---
        if (window.activeMiniNoteElement) {
            console.log("üíæ Gravando t√≥picos na CAIXA...");
            
            // 1. Atualiza o atributo HTML
            window.activeMiniNoteElement.setAttribute('data-topics', JSON.stringify(currentNoteTopics));
            
            // 2. Atualiza visual do bot√£o na caixa (se existir)
            if (typeof updateMiniNoteButtonState === 'function') {
                updateMiniNoteButtonState(window.activeMiniNoteElement);
            }

            // 3. DECIS√ÉO DE GRAVA√á√ÉO (Aqu√°rio vs Nota)
            const isAquarium = document.getElementById('aquarium-environment').style.display !== 'none';
            
            if (isAquarium) {
                console.log("üåä [AQU√ÅRIO] Gravando estado global...");
                if (typeof window.saveAquariumState === 'function') await window.saveAquariumState();
            } else {
                console.log("üìÑ [NOTA] Gravando nota...");
                // Se for subnota normal, grava a nota inteira
                // (Se for caixa do Arquivo, a l√≥gica de arquivo trata disso)
                if (selectedNoteId && typeof saveNote === 'function') await saveNote(true);
            }
        } 
        
        // --- CEN√ÅRIO B: Nota ou Pasta Principal (Gest√£o Global) ---
        else if (window.topicTargetId) {
            console.log("üíæ Gravando T√≥picos na NOTA:", window.topicTargetId);
            
            // (C√≥digo de grava√ß√£o da nota mant√©m-se igual, pois o Aqu√°rio n√£o usa topicTargetId)
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const hybridToggle = document.getElementById('hybrid-mode-toggle');
            const isHybridActive = hybridToggle ? hybridToggle.checked : false;

            const updateData = {
                topicosSelecionados: currentNoteTopics,
                ancorasSelecionadas: currentNoteAnchors,
                isHybridMode: isHybridActive,
                ultimaedicao: serverTimestamp()
            };

            const itemRef = doc(db, 'pastas', window.topicTargetId);
            await updateDoc(itemRef, updateData);

            // Atualiza√ß√£o da Interface (Abas do meio)
            activeNoteAnchorsIds = Object.keys(currentNoteAnchors);
            window.currentNoteHybridMode = isHybridActive;
            if (typeof refreshMiddlePanelTabIcon === 'function') refreshMiddlePanelTabIcon();
            if (window.topicTargetId === selectedNoteId) updateSaveStatus('saved');
        }

        // FECHAR MODAL
        document.getElementById('topics-modal').style.display = 'none';

    } catch (error) {
        console.error("‚ùå Erro ao gravar t√≥picos:", error);
        alert("Erro ao gravar.");
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

document.getElementById('manage-topics-btn').addEventListener('click', () => {
    activeTopicIdForManagement = null;
    document.getElementById('manage-topics-modal').style.display = 'flex';
    renderManageTopicsList();
    document.getElementById('create-new-subtopic-btn').style.display = 'none';
    document.getElementById('subtopics-list-manage').innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico.</li>';
});

document.getElementById('close-manage-topics-btn').addEventListener('click', () => {
    document.getElementById('manage-topics-modal').style.display = 'none';
    // Recarrega a lista de sele√ß√£o principal para mostrar os novos itens
    renderTopicsSelectionList(); 
});

// --- Renderiza√ß√£o Gest√£o ---

async function renderManageTopicsList(filterText = '') {
    const list = document.getElementById('topics-list-manage');
    if (!list) return;

    list.innerHTML = '<li>Carregando...</li>';

    try {
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        snapshot.forEach(docSnap => {
            const topic = { id: docSnap.id, ...docSnap.data() };
            if (filterText && !topic.nome.toLowerCase().includes(filterText.toLowerCase())) return;

            const li = document.createElement('li');
            li.textContent = topic.nome;
            if (topic.id === activeTopicIdForManagement) li.classList.add('active-topic');
            
            li.onclick = () => {
                document.querySelectorAll('#topics-list-manage li').forEach(el => el.classList.remove('active-topic'));
                li.classList.add('active-topic');
                activeTopicIdForManagement = topic.id;
                
                const createSubBtn = document.getElementById('create-new-subtopic-btn');
                if (createSubBtn) {
                    createSubBtn.style.display = 'block';
                    createSubBtn.textContent = `+ Subt√≥pico em "${topic.nome}"`;
                }
                
                renderManageSubtopicsList(topic.id);
            };
            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erro ao carregar gest√£o de t√≥picos:", e);
    }
}

async function renderManageSubtopicsList(topicId) {
    const list = document.getElementById('subtopics-list-manage');
    list.innerHTML = '<li>Carregando...</li>';

    const q = query(collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome'));
    const snapshot = await getDocs(q);

    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
        return;
    }

    snapshot.forEach(doc => {
        const sub = doc.data();
        const li = document.createElement('li');
        li.textContent = sub.nome;
        li.style.cursor = 'default'; // Apenas visualiza√ß√£o na gest√£o
        list.appendChild(li);
    });
}

// --- Pesquisa ---
document.getElementById('search-topic-input').addEventListener('input', (e) => {
    renderManageTopicsList(e.target.value);
});

// --- Cria√ß√£o de Novos Itens ---

document.getElementById('create-new-topic-btn').addEventListener('click', async () => {
    const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina...");
    
    // Verifica se result existe e se tem nome (descri√ß√£o √© opcional)
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'topicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageTopicsList(document.getElementById('search-topic-input').value);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar t√≥pico."); 
        }
    }
});


 document.getElementById('create-new-subtopic-btn').addEventListener('click', async () => {
    if (!activeTopicIdForManagement) return;
    
    const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo...");
    
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'subtopicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                topicId: activeTopicIdForManagement,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageSubtopicsList(activeTopicIdForManagement);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar subt√≥pico."); 
        }
    }
});

// --- LIGAR O BOT√ÉO DA BARRA DE FERRAMENTAS ---


// 2. EVENTO INPUT: Exclusivo para o Seletor de Cores
// O seletor de cores precisa do evento 'input' para funcionar em tempo real
editorToolbar.addEventListener('input', (e) => {
    const target = e.target;
    // Verifica se √© o input de cor da barra
    if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
        document.execCommand('foreColor', false, target.value);
        saveNote(); 
    }
});




/**
 * Remove a refer√™ncia de uma nota a uma entidade de texto b√≠blico.
 * Se for a √∫ltima refer√™ncia, apaga a pr√≥pria entidade.
 * @param {string} entityName O nome da entidade de texto b√≠blico (ex: "Daniel 4:3")
 */
async function cleanupBiblicalEntityReference(entityName) {
    if (!selectedNoteId || !entityName) return;

    const collectionRef = collection(db, 'textosbiblicos');
    const q = query(collectionRef, where("nome", "==", entityName));
    
    try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            return;
        }

        const entityDoc = snapshot.docs[0];
        const entityRef = entityDoc.ref;
        const entityData = entityDoc.data();
        const references = entityData.referencias || {};
        
        // Verifica se a nota atual est√° nas refer√™ncias
        if (references[selectedNoteId]) {
            const numReferences = Object.keys(references).length;

            if (numReferences === 1) {
                // √â a √∫ltima refer√™ncia, apagar o documento inteiro
                await deleteDoc(entityRef);
            } else {
                // Existem outras refer√™ncias, remover apenas a atual

                await updateDoc(entityRef, {
                    [`referencias.${selectedNoteId}`]: deleteField()
                });
            }
            
            // Atualiza o cache de entidades local
            await fetchAllEntities();
        }

    } catch (error) {
        console.error(`Erro ao limpar a refer√™ncia para "${entityName}":`, error);
    }
}

async function fetchAllEntities() {
    if (!auth.currentUser) return;
    allEntities = {}; 
    for (const type in ENTITY_CONFIG) {
        const config = ENTITY_CONFIG[type];
        const collectionName = config.collection;
        try {
            const q = query(
                collection(db, collectionName), 
                where('userId', '==', auth.currentUser.uid)
            );
            
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                allEntities[type] = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    nome: doc.data().nome,
                    tipo: type,
                    descricao: doc.data().descricao,
                    ancorasAssociadas: doc.data().ancorasAssociadas || {},
                    // --- NOVA LINHA: Carregar o Emoji do Cosmos/Subcosmos ---
                    emoji: doc.data().emoji 
                }));
            }
        } catch (error) {
            console.error(`Erro ao carregar a cole√ß√£o ${collectionName}:`, error);
        }
    }
}

function resetEditor() {
    // --- NOVO: Desliga o ouvinte da nota em tempo real ---
    if (unsubscribeCurrentNote) {
        unsubscribeCurrentNote();
        unsubscribeCurrentNote = null;
    }
    // -----------------------------------------------------

    leaveArchivePresence(); 
    toggleJournalToolbar(false);
    selectedNoteId = null;
    currentArchiveId = null; 
    activeEditingPostId = null; 

    if (document.getElementById('insertion-popup')) document.getElementById('insertion-popup').style.display = 'none';

    editorArea.style.display = 'none';
    document.getElementById('archive-area').style.display = 'none';
    editorPlaceholder.style.display = 'flex';

    const tabsBar = document.querySelector('.middle-bottom-tabs');
    if (tabsBar) tabsBar.style.display = 'none';

    const filesTabBtn = document.querySelector('button[data-mid-tab="files"]');
    if (filesTabBtn) filesTabBtn.click();

    document.querySelectorAll('#middle-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('#file-list .list-item.selected').forEach(el => el.classList.remove('selected', 'selected-red'));
    
    updateSaveStatus('hidden');
}

function fetchAndDisplayItems(parentId, listElement, selectedId = null) {
    if (!auth.currentUser) return;

    // Defini√ß√£o dos tipos permitidos (c√≥digo existente...)
    let allowedTypes = currentViewMode === 'local' 
        ? ['pasta', 'nota', 'agregacao', 'arquivo', 'jornal', 'aquario'] 
        : ['pasta', 'nota', 'agregacao', 'arquivo', 'partilhado', 'jornal', 'aquario'];

    const itemsRef = collection(db, 'pastas');
    
    // --- QUERY BASE ---
    let constraints = [
        where('parentId', '==', parentId), 
        where('estado', '==', 'ativa'), 
        where('userId', '==', auth.currentUser.uid), 
        where('tipo', 'in', allowedTypes), 
        orderBy('ordem')
    ];

    // --- FILTRO DE EXCLUS√ÉO FLASH (NOVO) ---
    // Se estivermos no modo LOCAL, queremos esconder os itens Flash
    if (currentViewMode === 'local') {
        // O Firestore n√£o suporta '!=', por isso a l√≥gica √©:
        // Os itens normais N√ÉO T√äM o campo 'oque' ou t√™m valor diferente.
        // Como o Firestore 9 n√£o permite filtrar por "campo n√£o existe", 
        // a solu√ß√£o mais robusta √© filtrar no cliente (dentro do onSnapshot).
        // MAS, se preferir via query, ter√≠amos de adicionar 'oque: normal' a todos os itens normais.
        
        // ABORDAGEM FILTRO CLIENT-SIDE (Mais segura para dados j√° existentes):
        // Vamos manter a query como est√° e filtrar no loop forEach abaixo.
    }

    const q = query(itemsRef, ...constraints);

    return onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        const isColumn1 = (listElement.id === 'left-panel-list');

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            
            // --- BLOQUEIO DE ITENS FLASH NA ABA LOCAL ---
            if (currentViewMode === 'local' && item.oque === 'flash') {
                return; // Pula este item, n√£o o mostra na lista
            }
            // ---------------------------------------------

            const li = document.createElement('li');
            // ... (resto do c√≥digo de renderiza√ß√£o do item igual ao que j√° tem) ...
            li.className = 'list-item';
            
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo);
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-userid', item.userId);
            li.setAttribute('data-parent-id', item.parentId || "null");
            li.setAttribute('data-protected', (item.passe && item.passe.trim() !== "") ? "true" : "false");
            li.setAttribute('data-pinned', item.isPinned ? "true" : "false");
            li.setAttribute('data-superpasta', item.superpasta || "false");
            
            if (item.customIcon) {
                li.style.setProperty('--custom-icon', `"${item.customIcon}"`);
            }

            let lockIcon = (item.passe && item.passe.trim() !== "") ? "üîí " : "";
            
            li.innerHTML = `<span>${lockIcon}${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            // ... (l√≥gica de sele√ß√£o active/selected) ...
             let active = false;
            if (isColumn1) {
                if (item.id === col1SelectedId) active = true;
                else if (navigationStack.some(nav => nav.id === item.id)) active = true;
            } else {
                if (window.nextSelectedId) {
                    if (item.id === window.nextSelectedId) active = true;
                } else if (selectedNoteId && item.id === selectedNoteId) {
                    active = true;
                }
            }

            if (active) {
                if (isColumn1) li.classList.add('selected');
                else {
                    const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                    li.classList.add(selectionClass);
                }
            }

            listElement.appendChild(li);
        });
    });
}


async function updateNavigationView(keepEditorOpen = false, targetSelectId = null) {
    // 1. PRIMEIRA COISA: Atualizar a visibilidade dos bot√µes flutuantes
    updateMobileFABVisibility();

    // 2. Remove qualquer estado colapsado ao navegar
    notebookContainer.classList.remove('left-panel-collapsed');

    // 1. Limpeza de Ouvintes (Listeners) ativos para evitar fugas de mem√≥ria
    if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    // 2. Reset do Editor se n√£o for solicitado manter aberto
    if (!keepEditorOpen) {
        resetEditor();
    }

    const depth = navigationStack.length;
    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // ============================================================
    // CASO A: ABA DE LISTAS (T√≥picos, B√≠blia, Personagens, etc)
    // ============================================================
   if (currentTab === 'lists') {
        const activeCategory = navigationStack.length > 0 ? navigationStack[0].id : null;

        // Gerar categorias dinamicamente
        const categories = [
            { id: 'topico', icon: 'üìë', name: 'T√≥picos' },
            { id: 'destaque', icon: 'üé®', name: 'Destaques' },
            { separator: true },
            { id: 'biblia-root', icon: 'üìñ', name: 'B√≠blia' }, // <--- O bot√£o ser√° adicionado aqui
            { id: 'textobiblico', icon: 'üìú', name: 'Textos B√≠blicos' },
            { id: 'marcadores', icon: 'üîñ', name: 'Marcadores' },
            { separator: true },
            { id: 'personagem', icon: 'üë§', name: 'Personagens' },
            { id: 'local', icon: 'üìç', name: 'Locais' },
            { id: 'data', icon: 'üìÖ', name: 'Datas' },
            { id: 'cosmos', icon: 'ü™ê', name: 'Cosmos' },
            { id: 'tag', icon: 'üè∑Ô∏è', name: 'Tags' }
        ];

        let categoriesHTML = '';
        categories.forEach(cat => {
            if (cat.separator) {
                categoriesHTML += `<hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 5px; opacity: 0.3;">`;
            } else {
                const isSelected = activeCategory === cat.id ? 'selected' : '';
                
                // --- L√ìGICA DO BOT√ÉO EXTERNO ---
                let extraAction = '';
                if (cat.id === 'biblia-root') {
                    // event.stopPropagation() impede que o clique abra a lista da B√≠blia no painel
                    extraAction = `<button class="external-open-btn" title="Abrir Leitura em Nova Janela" onclick="event.stopPropagation(); window.open('bible.html', '_blank');">‚ÜóÔ∏è</button>`;
                }
                
                // Note o style="flex-grow:1" no span para empurrar o bot√£o para a direita
                categoriesHTML += `
                <li class="list-item ${isSelected}" data-type="list-category" data-id="${cat.id}">
                    <span style="flex-grow: 1;">${cat.icon} ${cat.name}</span>
                    ${extraAction}
                </li>`;
            }
        });

        leftPanelList.innerHTML = categoriesHTML;

        if (depth === 0) {
            addItemBtn.style.display = 'none';
            setLeftPanelTitle('Categorias'); 
            middlePanelTitle.textContent = 'Selecione uma categoria';
            middlePanelList.innerHTML = '';
            backBtn.style.display = 'none';
        } else {
            const currentContext = navigationStack[depth - 1];
            setLeftPanelTitle('Categorias', true); 
            middlePanelTitle.textContent = currentContext.name;
            backBtn.style.display = 'flex';
            
            const rootCategoryId = navigationStack[0].id;
            const validYellowCategories = ['topico', 'personagem', 'local', 'data', 'marcadores', 'cosmos']; 
            updateAddButtonState(validYellowCategories.includes(rootCategoryId), true);
            renderListCategoryItems(currentContext.id);
        }
        return; 
    }

    // ============================================================
    // CASO B: MODO PINS (NOVO)
    // ============================================================
    if (currentViewMode === 'pins' && currentTab === 'note') {
        addItemBtn.style.display = 'none'; 
        backBtn.style.display = 'none';
        setLeftPanelTitle('Pins'); 
        
        // FOR√áA O CARREGAMENTO DA COLUNA 1 SEMPRE QUE ENTRA/VOLTA
        loadPinsView(); 
        
        return; 
    }

    // ============================================================
    // CASO C: MODO NOTE (LOCAL OU PARTILHA)
    // ============================================================
    addItemBtn.style.display = 'flex';
    addItemBtn.classList.remove('yellow-mode');

    // 1. Definir T√≠tulo da Esquerda (Coluna 1)
    if (depth === 0) {
        setLeftPanelTitle(currentViewMode === 'local' ? 'Pastas' : 'Partilha'); 
    } else {
        const parentFolder = (depth > 1) ? navigationStack[depth - 2] : null;
        const parentName = parentFolder ? parentFolder.name : (currentViewMode === 'shared' ? 'Partilhadas' : 'Pastas');
        setLeftPanelTitle(parentName, true);
    }

    let leftPanelParentId = null;
    let middlePanelParentId = null;

    // 2. Definir o que mostrar em cada coluna baseando-se na profundidade
    if (depth === 0) {
        // RAIZ
        if (currentViewMode === 'shared') {
            leftPanelParentId = "EMPTY_SIDEBAR_FOR_SHARED"; // A coluna 1 fica limpa para focar na lista
        } else {
            leftPanelParentId = isSuperContext ? SUPERFOLDER_ID : null;
        }
        middlePanelTitle.textContent = 'Selecione';
        middlePanelList.innerHTML = '';
        backBtn.style.display = 'none';
        
        if (currentViewMode === 'shared') loadSharedFilesRoot();
    } else {
        // DENTRO DE PASTAS
        const currentFolder = navigationStack[depth - 1];
        middlePanelParentId = currentFolder.id;
        middlePanelTitle.textContent = currentFolder.name;
        backBtn.style.display = 'flex';
        
        if (depth === 1) {
            leftPanelParentId = (currentViewMode === 'local') ? (isSuperContext ? SUPERFOLDER_ID : null) : "EMPTY_SIDEBAR_FOR_SHARED";
        } else {
            leftPanelParentId = navigationStack[depth - 2].id;
        }
    }
    
    // 3. Disparar a renderiza√ß√£o das listas via onSnapshot
    unsubscribeLeftPanel = fetchAndDisplayItems(leftPanelParentId, leftPanelList, null);
    if (middlePanelParentId) {
        unsubscribeMiddlePanel = fetchAndDisplayItems(middlePanelParentId, middlePanelList, targetSelectId);
    }
    updateMobileFABVisibility();
}



// 2. Cria Regex que entende acentos (ex: "joao" vira regex para encontrar "jo√£o", "Jo√£o", "J√íAO")
function getAccentInsensitiveRegex(term, isExact = false) {
    const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    let regexStr = escaped
        .replace(/a/gi, '[a√†√°√¢√£√§√•]')
        .replace(/e/gi, '[e√®√©√™√´]')
        .replace(/i/gi, '[i√¨√≠√Æ√Ø]')
        .replace(/o/gi, '[o√≤√≥√¥√µ√∂]')
        .replace(/u/gi, '[u√π√∫√ª√º]')
        .replace(/c/gi, '[c√ß]');
        
    // AQUI: Envolvemos o padr√£o em par√™nteses (Capturing Group) para o $1 funcionar
    return isExact ? new RegExp(`(\\b${regexStr}\\b)`, 'gi') : new RegExp(`(${regexStr})`, 'gi');
}



// --- L√ìGICA DA BARRA SECUND√ÅRIA ---

setTimeout(() => {
    const toggleMoreBtn = document.getElementById('toggle-more-tools-btn');
    const secondaryToolbar = document.getElementById('secondary-toolbar');
    
    // 1. Abrir/Fechar Painel Secund√°rio
    if (toggleMoreBtn && secondaryToolbar) {
        
        // A. REMOVER EVENTOS ANTIGOS (Clonagem)
        const newToggleBtn = toggleMoreBtn.cloneNode(true);
        toggleMoreBtn.parentNode.replaceChild(newToggleBtn, toggleMoreBtn);

        // B. PRESERVAR O CURSOR (O Segredo)
        newToggleBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();     // N√£o muda o foco
            e.stopPropagation();    // N√£o propaga para o editor
        });

        // C. A√á√ÉO DE ABRIR/FECHAR
        newToggleBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            
            const isHidden = secondaryToolbar.style.display === 'none';
            
            if (isHidden) {
                secondaryToolbar.style.display = 'flex';
                newToggleBtn.classList.add('active');
                newToggleBtn.textContent = '‚ñ≤';
                secondaryToolbar.style.animation = "slideDown 0.2s ease-out";
            } else {
                secondaryToolbar.style.display = 'none';
                newToggleBtn.classList.remove('active');
                newToggleBtn.textContent = '‚ñº';
            }
        });
    }

// 2. Funcionalidade dos Bot√µes da Barra Secund√°ria
    if (secondaryToolbar) {
        secondaryToolbar.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            e.preventDefault(); // Impede perda de foco

            // A. T√≠tulos e Texto Normal (A1, A2, P)
            if (btn.dataset.cmdSec === 'formatBlock') {
                const value = btn.dataset.val;
                
                // 1. Aplica o formato de bloco (H1, H2...)
                document.execCommand('formatBlock', false, value);

                // 2. LIMPEZA PROFUNDA
                const selection = window.getSelection();
                if (selection.anchorNode && safeNoteEditor) {
                    let block = selection.anchorNode;
                    if (block.nodeType === 3) block = block.parentNode; 
                    
                    while(block && block.id !== 'note-content-editor' && block.tagName !== value) {
                        block = block.parentNode;
                    }

                    if (block && block.tagName === value) {
                        block.removeAttribute('style'); 
                        const dirtyChildren = block.querySelectorAll('span, font, b, i, u');
                        dirtyChildren.forEach(child => {
                             child.style.fontSize = '';
                             child.style.fontWeight = '';
                             if (child.tagName === 'FONT') {
                                 child.removeAttribute('size');
                                 child.removeAttribute('face');
                             }
                        });
                    }
                }
                
                safeNoteEditor.focus(); 
                saveNote();
            }

            // B. Outros Comandos (Linha Horizontal)
            else if (btn.dataset.cmdSec) {
                const command = btn.dataset.cmdSec;
                document.execCommand(command, false, null);
                safeNoteEditor.focus();
                saveNote();
            }

            // C. Inserir Checkbox
            else if (btn.dataset.action === 'insert-checkbox') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.marginRight = '8px';
                checkbox.style.cursor = 'pointer';
                const space = document.createTextNode('\u00A0'); 

                insertNodeAtCursor(checkbox);
                insertNodeAtCursor(space);
                saveNote();
            }

            // D. Inserir Tabela (üßÆ) - NOVO
        else if (btn.dataset.action === 'insert-table') {
                const tableHTML = `
                    <div class="jwn-table-wrapper">
                        <button class="table-settings-btn" contenteditable="false">üõ†Ô∏è Op√ß√µes</button>
                        <table class="jwn-table">
                            <thead>
                                <tr>
                                    <th>T√≠tulo 1</th>
                                    <th>T√≠tulo 2</th>
                                    <th>T√≠tulo 3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td><br></td><td><br></td><td><br></td></tr>
                                <tr><td><br></td><td><br></td><td><br></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p><br></p>`;
                
                document.execCommand('insertHTML', false, tableHTML);
                saveNote();
            }

            // F. Inserir Linha Cronol√≥gica (NOVO)
else if (btn.dataset.action === 'insert-timeline') {
    const timelineId = `tl_${Date.now()}`;
    
    const timelineHTML = `
        <div class="jwn-timeline-wrapper" contenteditable="false" id="${timelineId}">
            <div class="timeline-track"></div>
            
            <div class="timeline-container">
                <!-- Ponto 1 -->
                <div class="timeline-entry">
                    <div class="t-marker"></div>
                    <div class="t-date" contenteditable="true">Data 1</div>
                    <div class="t-text" contenteditable="true">Descri√ß√£o do evento...</div>
                    <button class="t-btn-del" title="Remover Ponto">√ó</button>
                </div>
                <!-- Ponto 2 -->
                <div class="timeline-entry">
                    <div class="t-marker"></div>
                    <div class="t-date" contenteditable="true">Data 2</div>
                    <div class="t-text" contenteditable="true">Descri√ß√£o do evento...</div>
                    <button class="t-btn-del" title="Remover Ponto">√ó</button>
                </div>
            </div>

            <button class="t-btn-add" title="Adicionar Novo Ponto">‚ûï Adicionar Ponto</button>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, timelineHTML);
    saveNote();
}

// --- H. Inserir Calend√°rio (üìÖ) - CORRIGIDO ---
            else if (btn.dataset.action === 'insert-date') {
                e.preventDefault(); 
                e.stopPropagation();
                e.stopImmediatePropagation(); // P√ÅRA TUDO: Garante que s√≥ executa uma vez

                const calId = `cal_${Date.now()}`;
                const today = new Date();
                
                const widgetHTML = `
                    <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
                        <div class="cal-header">
                            <button class="cal-btn cal-prev">‚óÄ</button>
                            <span class="cal-title">Carregando...</span>
                            <div style="display:flex; gap:5px;">
                                <button class="cal-btn cal-next">‚ñ∂</button>
                                <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="cal-settings-menu">
                            <div style="display:flex; gap:5px; justify-content:center; width:100%;">
                                <button class="cal-view-btn" data-view="week" style="flex:1;">Semana</button>
                                <button class="cal-view-btn active" data-view="month" style="flex:1;">M√™s</button>
                                <button class="cal-view-btn" data-view="year" style="flex:1;">Ano</button>
                            </div>
                            <hr style="border:0; border-top:1px solid var(--border-color); opacity: 0.5;">
                            <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
                        </div>
                        
                        <div class="cal-grid"></div>
                    </div>
                    <p><br></p>`;
                
                document.execCommand('insertHTML', false, widgetHTML);
                
                setTimeout(() => {
                    if (typeof renderCalendarUI === 'function') {
                        renderCalendarUI(document.getElementById(calId));
                    }
                }, 50);
                
                saveNote();
                return; // Sai da fun√ß√£o para evitar conflitos
            }

   // G. TORNAR TEXTO MOV√çVEL (·Øì) - C√ìDIGO CORRIGIDO E INTEGRADO
       else if (btn.dataset.action === 'make-draggable') {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const anchorNode = selection.anchorNode;
            const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

            // 1. REVERTER: Se j√° estiver dentro de uma linha mov√≠vel
            const existingLine = element.closest('.draggable-line');
            if (existingLine) {
                const contentDiv = existingLine.querySelector('.drag-content-area');
                const content = contentDiv ? contentDiv.innerHTML : existingLine.textContent.replace('·Øì', '');
                
                const p = document.createElement('p');
                p.innerHTML = content || "<br>";
                
                existingLine.replaceWith(p);
                
                // Focar no p revertido
                p.focus();
                
                saveNote();
                return;
            }

            // H. Inserir Imagem Jornal (üñºÔ∏è)
else if (btn.dataset.action === 'insert-image') {
    const uniqueId = `img_${Date.now()}`;
    const widgetHTML = `
        <div class="journal-img-wrapper img-size-md" id="${uniqueId}" contenteditable="false">
            <!-- MODO INPUT (Inicial) -->
            <div class="journal-img-placeholder">
                <span>üñºÔ∏è</span>
                <input type="text" placeholder="Cole o link da imagem aqui..." class="img-url-input">
                <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px;">OK</button>
            </div>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, widgetHTML);
    
    // Foca logo no input
    setTimeout(() => {
        const input = document.getElementById(uniqueId).querySelector('input');
        if(input) input.focus();
    }, 50);
    
    saveNote();
}

            // 2. CRIAR: Preparar o conte√∫do
            let contentHTML = "";
            let blockToRemove = null;

            if (!selection.isCollapsed) {
                const fragment = range.cloneContents();
                const div = document.createElement('div');
                div.appendChild(fragment);
                contentHTML = div.innerHTML;
            } else {
                const block = element.closest('p, div, h1, h2, h3, li');
                if (block && !block.id.includes('note-content-editor') && !block.classList.contains('mini-note-wrapper')) {
                    contentHTML = block.innerHTML;
                    blockToRemove = block;
                } else {
                    contentHTML = "Texto mov√≠vel";
                }
            }

            // 3. LIMPEZA DE SEGURAN√áA
            const cleaner = document.createElement('div');
            cleaner.innerHTML = contentHTML;
            cleaner.querySelectorAll('.drag-handle-icon').forEach(i => i.remove());
            cleaner.querySelectorAll('.draggable-line').forEach(line => {
                const inner = line.querySelector('.drag-content-area');
                line.outerHTML = inner ? inner.innerHTML : line.textContent;
            });
            contentHTML = cleaner.innerHTML;

            // 4. APLICA√á√ÉO
            const uniqueId = `drag_${Date.now()}`;
            const draggableHTML = `
                <div class="draggable-line" draggable="true" id="${uniqueId}">
                    <span class="drag-handle-icon" contenteditable="false">·Øì</span>
                    <div class="drag-content-area" contenteditable="true">${contentHTML}</div>
                </div>`;

            if (blockToRemove) {
                blockToRemove.outerHTML = draggableHTML;
            } else {
                document.execCommand('insertHTML', false, draggableHTML);
            }

            // --- CORRE√á√ÉO DE CURSOR AQUI ---
            // Espera o HTML renderizar, encontra o novo elemento e move o cursor para o fim
            setTimeout(() => {
                const newLine = document.getElementById(uniqueId);
                if (newLine) {
                    const contentArea = newLine.querySelector('.drag-content-area');
                    if (contentArea) {
                        contentArea.focus(); // Foca na caixa de texto

                        // Cria um novo range
                        const newRange = document.createRange();
                        
                        // Seleciona todo o conte√∫do da caixa
                        newRange.selectNodeContents(contentArea);
                        
                        // COLAPSA PARA O FIM (true = in√≠cio, false = fim)
                        newRange.collapse(false); 
                        
                        // Aplica a sele√ß√£o
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(newRange);
                    }
                }
            }, 10); // Pequeno delay de 10ms √© suficiente

            saveNote();
        }

        // 5. INSERIR DUAS COLUNAS (‚è∏Ô∏è) - COM APAGAR
else if (action === 'insert-2-cols') {
    e.preventDefault();
    
    // For√ßar foco (como fizemos antes)
    const editor = document.getElementById('note-content-editor');
    if (document.activeElement !== editor && !editor.contains(document.activeElement)) {
        editor.focus();
    }
    
    const uniqueId = `cols_${Date.now()}`;
    
    // HTML com Wrapper e Toolbar
    const colsHTML = `
        <div class="journal-cols-wrapper" id="${uniqueId}" contenteditable="false">
            
            <!-- Toolbar (Aparece no Hover) -->
            <div class="cols-toolbar">
                <span style="font-size:10px; color:#888; margin-right:5px;">COLUNAS</span>
                <button class="cols-btn-del" onclick="window.deleteCols(this)" title="Apagar Colunas">üóëÔ∏è</button>
            </div>

            <!-- O Contentor Flex Original -->
            <div class="journal-cols-container">
                <div class="journal-col" contenteditable="true" data-placeholder="Escreva na esquerda..."></div>
                <div class="journal-col" contenteditable="true" data-placeholder="Escreva na direita..."></div>
            </div>

        </div>
        <p><br></p>`;

    document.execCommand('insertHTML', false, colsHTML);
    
    setTimeout(() => {
        const container = document.getElementById(uniqueId);
        if (container) {
            const firstCol = container.querySelector('.journal-col');
            if (firstCol) firstCol.focus();
        }
    }, 50);
    
    if (typeof saveNote === 'function') saveNote();
}

  


if (btn.dataset.action === 'insert-toggle-h2') {
    const selection = window.getSelection();

    // =================================================================
    // 1. VERIFICA√á√ÉO DE ANINHAMENTO (IMPEDIR TOGGLE DENTRO DE TOGGLE)
    // =================================================================
    if (selection.rangeCount > 0) {
        const node = selection.anchorNode;
        // Garante que temos o elemento HTML
        const element = node.nodeType === 3 ? node.parentElement : node;
        
        // Verifica se o cursor j√° est√° dentro de um <details>
        if (element.closest('details.toggle-section')) {
            alert("N√£o √© permitido criar um Toggle dentro de outro.");
            return; // Cancela a a√ß√£o imediatamente
        }
    }
    // =================================================================

    let text = selection.toString();
    
    if (!text.trim()) {
        text = "T√≠tulo Expans√≠vel";
    }

    const uniqueId = 'toggle_' + Date.now();

 const toggleHTML = `
        <details class="toggle-section" open id="${uniqueId}">
            <summary>
                <h2>${text}</h2>
                
                <!-- NOVOS BOT√ïES DE MOVIMENTO -->
                <button class="toggle-move-btn" data-action="move-up" contenteditable="false" title="Mover para Cima">üî∫</button>
                <button class="toggle-move-btn" data-action="move-down" contenteditable="false" title="Mover para Baixo">üîª</button>
                
                <!-- BOT√ïES ANTIGOS -->
                <button class="toggle-color-btn" contenteditable="false" title="Mudar Cor">üñåÔ∏è</button>
                <button class="toggle-delete-btn" contenteditable="false" title="Ocultar Sec√ß√£o">üóëÔ∏è</button>
            </summary>
            <div class="toggle-content">
                <p><br></p>
            </div>
        </details>
        <p><br></p>`;

    document.execCommand('insertHTML', false, toggleHTML);
    saveNote();
}

           // E. Inserir Calend√°rio (üìÖ) - ATUALIZADO
     else if (btn.dataset.action === 'insert-date') {
    const calId = `cal_${Date.now()}`;
    const today = new Date();
    
    const widgetHTML = `
        <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
            <div class="cal-header">
                <button class="cal-btn cal-prev">‚óÄ</button>
                <span class="cal-title">Carregando...</span>
                <div style="display:flex; gap:5px;">
                    <button class="cal-btn cal-next">‚ñ∂</button>
                    <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                </div>
            </div>
            
            <!-- Menu de Defini√ß√µes -->
            <div class="cal-settings-menu">
                <!-- Bot√µes de Vista -->
                <div style="display:flex; gap:5px; justify-content:center; width:100%;">
                    <button class="cal-view-btn" data-view="week" style="flex:1;">Semana</button>
                    <button class="cal-view-btn active" data-view="month" style="flex:1;">M√™s</button>
                    <button class="cal-view-btn" data-view="year" style="flex:1;">Ano</button>
                </div>
                
                <!-- Separador -->
                <hr style="border:0; border-top:1px solid var(--border-color); opacity: 0.5;">
                
                <!-- Bot√£o Eliminar com classe CSS -->
                <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
            </div>
            
            <div class="cal-grid">
                <!-- Dias ser√£o gerados via JS -->
            </div>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, widgetHTML);
    
    setTimeout(() => renderCalendarUI(document.getElementById(calId)), 50);
    saveNote();
}
        });

        // 3. Listener para Cor (Separado, mant√©m-se igual)
        secondaryToolbar.addEventListener('input', (e) => {
            const target = e.target;
            if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
                document.execCommand('foreColor', false, target.value);
                saveNote(); 
            }
        });
    }
}, 500);

// Fun√ß√£o Auxiliar (Mant√©m-se a mesma, mas garante que est√° presente)
function insertNodeAtCursor(node) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node);
        range.setEndAfter(node);
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante)
// ====================================================================

// --- NOVO C√ìDIGO PARA A DROPDOWN DE FORMATOS ---
    const formatSelect = document.getElementById('editor-format');
    if (formatSelect) {
        formatSelect.addEventListener('change', () => {
            const value = formatSelect.value; // Pega H1, H2, P, etc.
            
            // 1. Aplica o formato
            document.execCommand('formatBlock', false, value);

            // 2. LIMPEZA PROFUNDA (Mesma l√≥gica que tinhas nos bot√µes)
            const selection = window.getSelection();
            if (selection.anchorNode && safeNoteEditor) {
                let block = selection.anchorNode;
                if (block.nodeType === 3) block = block.parentNode; 
                
                // Sobe at√© encontrar o bloco alterado
                while(block && block.id !== 'note-content-editor' && block.tagName !== value) {
                    block = block.parentNode;
                }

                if (block && block.tagName === value) {
                    block.removeAttribute('style'); 
                    const dirtyChildren = block.querySelectorAll('span, font, b, i, u');
                    dirtyChildren.forEach(child => {
                            child.style.fontSize = '';
                            child.style.fontWeight = '';
                            if (child.tagName === 'FONT') {
                                child.removeAttribute('size');
                                child.removeAttribute('face');
                            }
                    });
                }
            }
            
            // 3. Foca de volta no editor e grava
            safeNoteEditor.focus();
            saveNote();
            
            // Opcional: Voltar visualmente para "Normal" para a pr√≥xima a√ß√£o
            // formatSelect.value = "P"; 
        });
    }

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante Controlado)
// ====================================================================
let activeTableCell = null; // Memoriza a √∫ltima c√©lula clicada/focada
let activeTableWrapper = null; // Memoriza qual a tabela ativa
const tablePopup = document.getElementById('table-tools-popup');

// 1. Detetar cliques (Memorizar C√©lula OU Abrir Menu)
noteContentEditor.addEventListener('click', (e) => {
    
    // CASO A: Clicou numa c√©lula (Apenas memorizamos, N√ÉO abrimos menu)
    const cell = e.target.closest('td, th');
    if (cell) {
        activeTableCell = cell; // Guardamos a refer√™ncia para saber onde inserir linhas
        activeTableWrapper = cell.closest('.jwn-table-wrapper');
        
        // Se o menu estiver aberto noutra tabela, fecha-o
        if (tablePopup.style.display === 'flex' && !activeTableWrapper.contains(e.target)) {
            tablePopup.style.display = 'none';
        }
        return;
    }

    // CASO B: Clicou no bot√£o de Ferramentas (üõ†Ô∏è)
    const settingsBtn = e.target.closest('.table-settings-btn');
    if (settingsBtn) {
        // Encontra a tabela associada a este bot√£o
        activeTableWrapper = settingsBtn.closest('.jwn-table-wrapper');
        const table = activeTableWrapper.querySelector('table');
        
        // Se n√£o tivermos clicado numa c√©lula recentemente, assumimos a primeira c√©lula da tabela
        if (!activeTableCell || !table.contains(activeTableCell)) {
            activeTableCell = table.querySelector('td, th');
        }

        // Toggle do Menu
        if (tablePopup.style.display === 'flex') {
            tablePopup.style.display = 'none';
            settingsBtn.classList.remove('active');
        } else {
            // Posicionar Menu
            const rect = settingsBtn.getBoundingClientRect();
            tablePopup.style.display = 'flex';
            tablePopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            // Alinha √† direita do bot√£o
            tablePopup.style.left = `${(rect.right + window.scrollX) - tablePopup.offsetWidth}px`;
            
            settingsBtn.classList.add('active');
        }
        return;
    }

    // CASO C: Clicou fora (Fechar Menu)
    if (tablePopup.style.display === 'flex' && !tablePopup.contains(e.target)) {
        tablePopup.style.display = 'none';
        // Remove estado ativo de todos os bot√µes
        document.querySelectorAll('.table-settings-btn').forEach(b => b.classList.remove('active'));
    }
});

// 2. A√ß√µes dos bot√µes do menu (Adicionar/Remover)
if (tablePopup) {
    tablePopup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeTableCell) return;
        
        e.preventDefault(); e.stopPropagation();

        const action = btn.dataset.action;
        const cell = activeTableCell;
        const row = cell.parentElement;
        const table = row.closest('table');
        
        const rowIndex = row.rowIndex;
        const colIndex = cell.cellIndex;
        const currentCols = row.cells.length;
        const currentRows = table.rows.length;

        // --- ADICIONAR ---
        if (action === 'add-row-above' || action === 'add-row-below') {
            if (currentRows >= 50) return alert("Limite de linhas atingido.");
            const newRow = table.insertRow(action === 'add-row-above' ? rowIndex : rowIndex + 1);
            for (let i = 0; i < currentCols; i++) {
                newRow.insertCell(i).innerHTML = '<br>';
            }
        }
        else if (action === 'add-col-left' || action === 'add-col-right') {
            if (currentCols >= 15) return alert("Limite de colunas atingido.");
            for (let i = 0; i < table.rows.length; i++) {
                const tr = table.rows[i];
                const isHeadRow = tr.parentNode.tagName === 'THEAD';
                const refIndex = action === 'add-col-left' ? colIndex : colIndex + 1;
                const newCell = tr.insertCell(refIndex);
                if (isHeadRow) newCell.outerHTML = '<th>T√≠tulo</th>';
                else newCell.innerHTML = '<br>';
            }
        }

        // --- APAGAR ---
        else if (action === 'del-row') {
            table.deleteRow(rowIndex);
            if (table.rows.length === 0) activeTableWrapper.remove();
        }
        else if (action === 'del-col') {
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].deleteCell(colIndex);
            }
            if (table.rows[0] && table.rows[0].cells.length === 0) activeTableWrapper.remove();
        }
        else if (action === 'del-table') {
            if (confirm("Apagar toda a tabela?")) {
                activeTableWrapper.remove();
            }
        }

        saveNote();
        // N√£o fechamos o menu automaticamente para permitir m√∫ltiplas a√ß√µes r√°pidas
        // Se quiser fechar, descomente a linha abaixo:
        // tablePopup.style.display = 'none'; 
    });
}

// --- FUN√á√ÉO AUXILIAR: ATUALIZAR VISUAL DO BOT√ÉO DE T√ìPICOS ---
function updateMiniNoteButtonState(wrapperElement) {
    if (!wrapperElement) return;

    const btn = wrapperElement.querySelector('button[data-action="manage-mini-note-topics"]');
    if (!btn) return;

    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    let hasTopics = false;

    try {
        const topics = JSON.parse(topicsString);
        // Verifica se h√° chaves no objeto (t√≥picos selecionados)
        hasTopics = Object.keys(topics).length > 0;
    } catch (e) {
        hasTopics = false;
    }

    if (hasTopics) {
        // --- ESTILO DESTACADO (COM T√ìPICOS) ---
        btn.style.backgroundColor = "rgba(74, 144, 226, 0.3)"; // Fundo azulado semi-transparente
        btn.style.color = "var(--accent-color)";               // √çcone azul forte
        btn.style.borderColor = "var(--accent-color)";         // Borda azul forte
        btn.title = "Gerir T√≥picos (Ativos)";
    } else {
        // --- ESTILO PADR√ÉO (SEM T√ìPICOS) ---
        btn.style.backgroundColor = "";
        btn.style.color = "";
        btn.style.borderColor = "";
        btn.title = "Gerir T√≥picos";
    }
}

// --- FUN√á√ÉO PARA CORRIGIR SUBNOTAS ANTIGAS ---
function fixLegacyMiniNotes() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    // 1. LIMPEZA DE SEGURAN√áA (Remove elementos √≥rf√£os de vers√µes antigas)
    const ghostArrows = editor.querySelectorAll('.title-expand-arrow');
    ghostArrows.forEach(arrow => arrow.remove());

    const wrappers = editor.querySelectorAll('.mini-note-wrapper');
    
    wrappers.forEach(wrapper => {
        // 2. GARANTIA DE ATRIBUTOS ESSENCIAIS (Inicia se n√£o existirem)
        if (!wrapper.hasAttribute('data-topics')) wrapper.setAttribute('data-topics', '{}');
        if (!wrapper.hasAttribute('data-shared')) wrapper.setAttribute('data-shared', 'false');
        if (!wrapper.hasAttribute('data-box-links')) wrapper.setAttribute('data-box-links', '{}');

        // 3. RECONSTRU√á√ÉO DA TOOLBAR
        let toolbar = wrapper.querySelector('.mini-note-toolbar');
        if (!toolbar) {
            toolbar = document.createElement('div');
            toolbar.className = 'mini-note-toolbar';
            toolbar.setAttribute('contenteditable', 'false');
            // Insere a toolbar antes do conte√∫do da nota
            const content = wrapper.querySelector('.mini-note-content');
            wrapper.insertBefore(toolbar, content);
        }

        // Garante que o grupo de setas (Mover) existe
        let arrowGroup = toolbar.querySelector('.toolbar-btn-group');
        if (!arrowGroup) {
            arrowGroup = document.createElement('div');
            arrowGroup.className = 'toolbar-btn-group';
            toolbar.appendChild(arrowGroup);
        }

        // Configura√ß√£o de todos os bot√µes necess√°rios
        const buttonsConfig = [
            { action: 'sharing-settings', icon: 'üîê', title: 'Partilha', parent: toolbar },
            { action: 'move-up', icon: 'üî∫', title: 'Subir', parent: arrowGroup },
            { action: 'move-down', icon: 'üîª', title: 'Descer', parent: arrowGroup },
            { action: 'manage-box-links', icon: '‚ö°', title: 'Links/Codex', parent: toolbar },
            { action: 'append-mini-note', icon: 'üß¨', title: 'Clonar para Nota', parent: toolbar },
            { action: 'highlight-color', icon: 'üé®', title: 'Destacar Cor', parent: toolbar },
            { action: 'manage-mini-note-topics', icon: 'üìã', title: 'Gerir T√≥picos', parent: toolbar },
            { action: 'delete-mini-note', icon: 'üóëÔ∏è', title: 'Apagar', parent: toolbar }
        ];

        buttonsConfig.forEach(cfg => {
            let btn = toolbar.querySelector(`button[data-action="${cfg.action}"]`);
            if (!btn) {
                btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.action = cfg.action;
                btn.textContent = cfg.icon;
                btn.title = cfg.title;
                cfg.parent.appendChild(btn);
            }
        });

        // 4. CONVERS√ÉO DE T√çTULOS (Input -> Textarea para m√∫ltiplas linhas)
        let titleArea = wrapper.querySelector('.mini-note-title-input');
        if (titleArea && titleArea.tagName === 'INPUT') {
            const textarea = document.createElement('textarea');
            textarea.className = titleArea.className;
            textarea.value = titleArea.getAttribute('value') || titleArea.value || "";
            textarea.placeholder = titleArea.placeholder;
            textarea.setAttribute('spellcheck', 'false');
            titleArea.parentNode.replaceChild(textarea, titleArea);
            titleArea = textarea;
        }

        // Aplica o comportamento de quebra de linha se a configura√ß√£o global estiver ativa
        if (titleArea && typeof appSettings !== 'undefined' && appSettings.showFullTitles) {
            titleArea.classList.add('wrap-enabled');
            // Ajusta a altura inicial baseado no conte√∫do
            setTimeout(() => {
                titleArea.style.height = 'auto';
                titleArea.style.height = titleArea.scrollHeight + 'px';
            }, 0);
        }

        // 5. GARANTIA DE EDI√á√ÉO
        toolbar.setAttribute('contenteditable', 'false');
        const contentDiv = wrapper.querySelector('.mini-note-content');
        if (contentDiv) contentDiv.setAttribute('contenteditable', 'true');

        // 6. ATUALIZA√á√ÉO VISUAL (Cores dos bot√µes baseadas nos dados)
        if (typeof updateMiniNoteButtonState === 'function') updateMiniNoteButtonState(wrapper); 
        if (typeof updateHighlightButtonState === 'function') updateHighlightButtonState(wrapper); 
        if (typeof updateSharingButtonState === 'function') updateSharingButtonState(wrapper); 
        if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(wrapper);
    });
}





// 1. Carregar Destaques Personalizados do Firebase
window.loadUserHighlights = async function() {
    if (!auth.currentUser) return;
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            userCustomHighlights = docSnap.data().colors || {};
        }
    } catch (e) {
        console.error("Erro ao carregar destaques:", e);
    }
};

// 2. Abrir Popup de Cores
window.renderHighlightList = function() {
    const container = document.getElementById('highlight-options-container');
    container.innerHTML = '';

    // 1. Descobrir qual a cor ativa na caixa atual
    const activeColor = window.activeWrapperForColor && window.activeWrapperForColor.dataset.highlight 
                      ? window.activeWrapperForColor.dataset.highlight.toLowerCase() 
                      : null;

    // Op√ß√£o de Remover
    const removeRow = document.createElement('div');
    removeRow.className = 'highlight-option-row remove-highlight-row';
    removeRow.innerHTML = '<span>üö´ Remover Destaque</span>';
    removeRow.onclick = () => window.applyHighlight(null);
    container.appendChild(removeRow);

    // Lista de Cores
    DEFAULT_HIGHLIGHTS.forEach(colorObj => {
        const hex = colorObj.code;
        const displayName = userCustomHighlights[hex] || colorObj.name;

        const row = document.createElement('div');
        row.className = 'highlight-option-row';

        if (hex.toLowerCase() === activeColor) {
            row.classList.add('selected-color-row');
        }

        // Bola de Cor
        const colorBox = document.createElement('div');
        colorBox.className = 'color-preview-box';
        colorBox.style.backgroundColor = hex;

        // Nome
        const nameLabel = document.createElement('span');
        nameLabel.className = 'highlight-name-label';
        nameLabel.textContent = displayName;

        // L√°pis (Renomear)
        const editBtn = document.createElement('button');
        editBtn.className = 'highlight-options-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.title = "Mudar Nome";
        editBtn.onclick = (e) => {
            e.stopPropagation(); 
            // Assume que renameHighlight tamb√©m ser√° convertida ou est√° acess√≠vel
            if(typeof renameHighlight === 'function') renameHighlight(hex, displayName);
        };

        // AQUI: Chama a fun√ß√£o global window.applyHighlight
        row.onclick = () => window.applyHighlight(hex);

        row.appendChild(colorBox);
        row.appendChild(nameLabel);
        row.appendChild(editBtn);
        container.appendChild(row);
    });
};

// 2. Abrir Modal de Cores (Agora muito mais simples)
window.openHighlightPopup = async function(wrapper) {
    console.log("üé® [CORES] Abrindo seletor...");
    window.activeWrapperForColor = wrapper; 

    const modal = document.getElementById('highlight-modal');
    if (!modal) return console.error("Modal #highlight-modal n√£o encontrado!");

    // 1. MOVE PARA O TOPO (Body)
    document.body.appendChild(modal);

    // 2. FOR√áA VISIBILIDADE M√ÅXIMA (Z-Index Supremo)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        z-index: 2147483647 !important; /* Max Int 32-bit */
        top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.7) !important;
        justify-content: center !important;
        align-items: center !important;
    `;

    // 3. CARREGA DADOS
    await window.loadUserHighlights();
    window.renderHighlightList(); 
};

// 3. Renomear Destaque
async function renameHighlight(hexCode, currentName) {
    const modal = document.getElementById('rename-highlight-modal');
    if (!modal) return;

    // Move para o body e define Z-index supremo
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "4000000"; // Acima do seletor de cores

    const input = document.getElementById('new-highlight-name-input');
    colorHexBeingRenamed = hexCode;
    input.value = currentName;
    
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);

    // L√≥gica dos bot√µes Cancelar/Gravar (mant√©m a tua original, apenas garante o fecho)
    document.getElementById('confirm-rename-highlight-btn').onclick = async () => {
        const newName = input.value.trim();
        if (newName) {
            userCustomHighlights[hexCode] = newName;
            await syncColorsToFirebase();
            renderHighlightList();
        }
        modal.style.display = 'none';
    };

    document.getElementById('cancel-rename-highlight-btn').onclick = () => {
        modal.style.display = 'none';
    };
}

function updateSharingButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="sharing-settings"]');
    if (!btn) return;

    const isShared = wrapper.getAttribute('data-shared') === 'true';

    if (isShared) {
        btn.textContent = 'üîì'; // Cadeado aberto
        btn.classList.add('sharing-active');
        btn.title = "Partilha Permitida (P√∫blico)";
    } else {
        btn.textContent = 'üîê'; // Cadeado fechado
        btn.classList.remove('sharing-active');
        btn.title = "Partilha Bloqueada (Privado)";
    }
}

// Atualiza o √≠cone na toolbar principal
function updateNoteSharingButtonUI(isShared) {
    const btn = document.querySelector('button[data-action="note-sharing-settings"]');
    if (!btn) return;

    if (isShared) {
        // ESTADO P√öBLICO
        btn.textContent = 'üîì'; // Cadeado Aberto
        btn.style.color = '#2ecc71'; // Verde
        btn.title = "Nota P√∫blica (Clique para gerir)";
    } else {
        // ESTADO PRIVADO
        btn.textContent = 'üîê'; // Cadeado Fechado
        btn.style.color = ''; // Cor padr√£o do tema
        btn.title = "Nota Privada (Clique para partilhar)";
    }
}

// Fun√ß√£o Central: Grava as cores e o UserID no Firebase
// (Cria se n√£o existir, Atualiza se j√° existir)
async function syncColorsToFirebase() {
    if (!auth.currentUser) return;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // Prepara os dados
        const dataToSave = {
            userId: auth.currentUser.uid, // Garante que o ID do user est√° gravado
            colors: userCustomHighlights    // Grava o mapa de cores (Hex -> Nome)
        };

        // O { merge: true } √© a chave aqui:
        // - Se o doc n√£o existir: CRIA com estes dados.
        // - Se o doc existir: ATUALIZA/JUNTA estes dados.
        await setDoc(docRef, dataToSave, { merge: true });
        

    } catch (e) {
        console.error("Erro ao sincronizar cores:", e);
    }
}

// 4. Aplicar Destaque √† Caixa
window.applyHighlight = async function(colorCode) {
    if (!window.activeWrapperForColor) return;

    // 1. Aplica a cor no HTML (Visual)
    if (colorCode) {
        window.activeWrapperForColor.setAttribute('data-highlight', colorCode);
        window.activeWrapperForColor.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; // Feedback visual no bloco
        window.activeWrapperForColor.style.borderColor = colorCode;
    } else {
        window.activeWrapperForColor.removeAttribute('data-highlight');
        window.activeWrapperForColor.style.backgroundColor = '';
        window.activeWrapperForColor.style.borderColor = '';
    }

    // Atualiza bot√£o da toolbar se existir (apenas para notas normais)
    if (typeof updateHighlightButtonState === 'function') {
        updateHighlightButtonState(window.activeWrapperForColor);
    }
    
    // 2. FECHA O MODAL
    document.getElementById('highlight-modal').style.display = 'none';
    
    // 3. GRAVA√á√ÉO INTELIGENTE (Aqu√°rio vs Nota)
    const isAquarium = document.getElementById('aquarium-environment').style.display !== 'none';
    
    if (isAquarium) {
        console.log("üíæ [AQU√ÅRIO] Gravando cor...");
        if (typeof window.saveAquariumState === 'function') await window.saveAquariumState();
    } else {
        if (typeof saveNote === 'function') saveNote(true);
    }

    window.activeWrapperForColor = null;
};


// Fun√ß√£o Auxiliar: Garante que a cor existe na cole√ß√£o 'destaques'
async function ensureColorExistsInFirebase(hexCode, defaultName) {
    // Se j√° temos esta cor carregada localmente, n√£o precisamos de ir √† BD
    if (userCustomHighlights[hexCode]) return;

    const nameToSave = defaultName;
    
    // Atualiza cache local
    userCustomHighlights[hexCode] = nameToSave;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // --- ALTERA√á√ÉO AQUI ---
        // Adicionamos userId: auth.currentUser.uid ao objeto
        await setDoc(docRef, {
            userId: auth.currentUser.uid, // <--- CAMPO NOVO
            colors: {
                [hexCode]: nameToSave
            }
        }, { merge: true });
        
    } catch (e) {
        console.error("Erro ao registar cor:", e);
    }
}

// Listener para o bot√£o üé®
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="highlight-color"]');
    if (btn) {
        e.preventDefault(); 
        e.stopPropagation();
        
     const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
if (!wrapper) return;
        
        // Simplesmente abre o popup, sem c√°lculos de posi√ß√£o nem toggle complexo
        openHighlightPopup(wrapper);
        return;
    }
});

// Fechar popup ao clicar fora
document.addEventListener('click', (e) => {
    // 1. DECLARA√á√ÉO DAS VARI√ÅVEIS (O erro estava na falta disto)
    const sharePop = document.getElementById('note-share-popup');
    const fPopup = document.getElementById('formatting-popup');
    const fBtn = document.getElementById('more-formatting-btn');
    const bPopup = document.getElementById('bold-palette-popup'); // <--- A LINHA QUE FALTAVA
    const iPopup = document.getElementById('italic-palette-popup');

    // 2. Fechar Context Menu
    if (!e.target.closest('.context-menu')) {
        if (typeof hideContextMenu === 'function') hideContextMenu();
    }

    // 3. Popup Partilha
    if (sharePop && sharePop.style.display === 'flex') {
        if (!sharePop.contains(e.target) && 
            !e.target.closest('button[data-action="note-sharing-settings"]') && 
            !e.target.closest('button[data-action="archive-share"]')) {
            sharePop.style.display = 'none';
        }
    }

    // 4. Popup 3 Pontos (Formatting)
    if (fPopup && fPopup.style.display === 'block') {
        if (!fPopup.contains(e.target) && e.target !== fBtn) {
            fPopup.style.display = 'none';
            if (fBtn) fBtn.classList.remove('active');
        }
    }

    // 5. Popup do B Azul (CORRE√á√ÉO DO ERRO)
    if (bPopup && bPopup.style.display === 'block') {
        // Se o clique N√ÉO foi dentro do popup E N√ÉO foi nos pontos
        if (!bPopup.contains(e.target) && !e.target.classList.contains('dots-trigger')) {
            bPopup.style.display = 'none';
        }
    }
     // Fechar Popup It√°lico
    if (iPopup && iPopup.style.display === 'block') {
        if (!iPopup.contains(e.target) && !e.target.closest('button[data-command="italic"]')) {
            iPopup.style.display = 'none';
        }
    }
});

// 5. Atualizar Estado Visual do Bot√£o (Ao carregar a nota)
 function updateHighlightButtonState(wrapper) {
    const color = wrapper.dataset.highlight;
    const btn = wrapper.querySelector('button[data-action="highlight-color"]');
    const contentDiv = wrapper.querySelector('.mini-note-content');

    if (!btn) return;

    if (color) {
        // --- ESTILO ATIVO (PREENCHIDO) ---
        // Fundo ligeiramente claro para destacar que est√° ativo
        btn.style.backgroundColor = "rgba(255, 255, 255, 0.15)"; 
        // Borda com a cor do destaque escolhido
        btn.style.borderColor = color; 
        // √çcone com a cor do destaque escolhido
        btn.style.color = color; 
        
        btn.classList.add('has-color');
        
        // Garante que a caixa de texto tem a cor correta
        if (contentDiv) {
            contentDiv.style.backgroundColor = color;
            contentDiv.style.color = "#222222"; // Texto escuro para contraste
        }
    } else {
        // --- ESTILO INATIVO (RESET) ---
        btn.style.backgroundColor = "";
        btn.style.borderColor = "";
        btn.style.color = "";
        btn.classList.remove('has-color');
        
        if (contentDiv) {
            contentDiv.style.backgroundColor = ""; // Remove fundo
            contentDiv.style.color = ""; // Volta √† cor do tema
        }
    }
}


function updateMiddlePanelForFolderSelection(folderId, folderName, selectedElement) {
    // 1. Atualiza o estado da sele√ß√£o visual no painel esquerdo
    document.querySelectorAll('#left-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    selectedElement.classList.add('selected');

    // 2. Atualiza o stack de navega√ß√£o para refletir a nova pasta
    if (navigationStack.length > 0) {
        // Se j√° est√°vamos numa pasta, substitu√≠mos o √∫ltimo item
        navigationStack[navigationStack.length - 1] = { id: folderId, name: folderName };
    } else {
        // Se est√°vamos na raiz, adicionamos a pasta ao stack
        navigationStack.push({ id: folderId, name: folderName });
    }
    
    // 3. Atualiza o t√≠tulo do painel do meio e o bot√£o "Voltar"
    middlePanelTitle.textContent = folderName;
    backBtn.style.display = 'flex';

    // 4. Limpa o listener antigo do painel do meio para evitar fugas de mem√≥ria
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();

    // 5. Busca e exibe os novos itens no painel do meio, sem tocar no editor
    unsubscribeMiddlePanel = fetchAndDisplayItems(folderId, middlePanelList, null);
}


// Adiciona/Atualiza isto dentro da displayNote e displayArchive:
function syncVisualSelection(selectedId) {
    // 1. Remove destaques antigos apenas da segunda coluna (para n√£o matar a Coluna 1)
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });

    // 2. Aplica o destaque ao item clicado na Coluna 2
    const target = document.querySelector(`#file-list .list-item[data-id="${selectedId}"]`);
    if (target) {
        const isShared = (currentViewMode === 'shared');
        target.classList.add(isShared ? 'selected-red' : 'selected');
    }
}



async function displayNote(noteId, noteElement, searchTerm = null) {
    // 0. Reset de Estados Globais
    window.nextSelectedId = null; 
    document.body.classList.remove('show-fab');
    
    // Limpa ouvinte anterior para evitar fugas de mem√≥ria
    if (unsubscribeCurrentNote) { 
        unsubscribeCurrentNote(); 
        unsubscribeCurrentNote = null; 
    }
    
    // 1. Reset de Vari√°veis Locais
    window.currentNoteHybridMode = false;
    activeNoteAnchorsIds = [];
    
    // Refer√™ncias DOM
    const noteTitleInput = document.getElementById('note-title-input');
    const noteContentEditor = document.getElementById('note-content-editor');
    const editorArea = document.getElementById('editor-area');
    const zoomSelect = document.getElementById('editor-zoom'); // Refer√™ncia ao bot√£o de zoom
    
    // Limpeza Visual Imediata
    if (noteTitleInput) noteTitleInput.value = ""; 
    if (noteContentEditor) noteContentEditor.innerHTML = ""; 
    
    selectedNoteId = noteId;
    isClosingNote = false;

    // Gest√£o de Paineis (Esconder Placeholder / Arquivo, Mostrar Editor)
    document.getElementById('editor-placeholder').style.setProperty('display', 'none', 'important');
    document.getElementById('archive-area').style.setProperty('display', 'none', 'important');
    if (editorArea) editorArea.style.setProperty('display', 'flex', 'important');

    try {
        const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', noteId);

        // --- LISTENER EM TEMPO REAL ---
        unsubscribeCurrentNote = onSnapshot(noteRef, (noteSnap) => {
            if (!noteSnap.exists()) return;
            const data = noteSnap.data();

            // --- ATUALIZA√á√ÉO DO TIPO GLOBAL ---
            window.currentNoteType = data.tipo; 

            // Ativa a toolbar do Jornal (√≠cones de cima) se necess√°rio
            if (typeof toggleJournalToolbar === 'function') {
                toggleJournalToolbar(window.currentNoteType === 'jornal');
            }
            
            // 2. Definir Vari√°veis Cr√≠ticas
            window.currentNoteHybridMode = (data.isHybridMode === true);
            activeNoteAnchorsIds = Object.keys(data.ancorasSelecionadas || {});

            // 3. Atualizar HTML (T√≠tulo e Conte√∫do)
            const serverTitle = data.nome || '';
            const serverContent = data.conteudo || '';
            
            noteTitleInput.value = serverTitle;
            noteContentEditor.innerHTML = serverContent;

            // ============================================================
            // 4. APLICAR ZOOM GUARDADO (A CORRE√á√ÉO PEDIDA)
            // ============================================================
            const savedZoom = data.zoomLevel || '100%'; // Padr√£o 100% se n√£o existir
            
            // A. Atualiza o valor visual da Dropdown
            if (zoomSelect) {
                zoomSelect.value = savedZoom;
            }
            
            // B. Aplica o tamanho da fonte ao Editor
            if (noteContentEditor) {
                noteContentEditor.style.fontSize = savedZoom;
                
                // C. Ajuste inteligente da altura da linha
                if (!savedZoom.includes('%')) { 
                    // Se for Pixels (ex: 18px), calculamos 1.5x
                    const sizeNum = parseInt(savedZoom);
                    if (!isNaN(sizeNum)) {
                        noteContentEditor.style.lineHeight = (sizeNum * 1.5) + 'px';
                    }
                } else {
                    // Se for Percentagem, usamos o padr√£o
                    noteContentEditor.style.lineHeight = '1.6';
                }
            }
            // ============================================================

            // Scripts de ajuste p√≥s-carregamento
            setTimeout(() => {
                if (typeof refreshAllCalendars === 'function') refreshAllCalendars();
            }, 100);

            if (typeof fixLegacyMiniNotes === 'function') fixLegacyMiniNotes(); 
            if (typeof updateRedatorParagraphs === 'function') updateRedatorParagraphs();

            // 5. For√ßar Router e Atualiza√ß√µes Visuais
            setTimeout(() => {
                // Atualiza o √≠cone da aba central (Textos/Misto)
                if (typeof refreshMiddlePanelTabIcon === 'function') refreshMiddlePanelTabIcon();

                // Mostra a barra de abas no fundo da lista
                const tabsBar = document.querySelector('.middle-bottom-tabs');
                if (tabsBar) tabsBar.style.display = 'flex';

                // Se houver uma aba aberta no painel do meio, atualiza o conte√∫do
                if (typeof updateMiddlePanelViews === 'function') {
                    updateMiddlePanelViews(); 
                }
                
                // Se houver um termo de pesquisa (vindo da lupa), foca nele
                if (searchTerm && typeof scrollToAndHighlightText === 'function') {
                    scrollToAndHighlightText(searchTerm);
                }

                updateSaveStatus('saved');
            }, 100);
        });
    } catch (error) { 
        console.error("Erro ao carregar nota:", error); 
    }
    
    // For√ßa a transi√ß√£o de ecr√£ no Mobile
    if (window.innerWidth <= 768) {
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
    }
}


function scrollToAndHighlightText(term) {
    if (!term) return;
    const lowerTerm = term.toLowerCase();

    // 1. Procura em Inputs (T√≠tulos de Subnotas/Quest√µes)
    const inputs = noteContentEditor.querySelectorAll('input');
    for (const input of inputs) {
        if (input.value.toLowerCase().includes(lowerTerm)) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            input.focus();
            // Adiciona efeito visual
            input.parentElement.classList.add('temporary-highlight');
            setTimeout(() => input.parentElement.classList.remove('temporary-highlight'), 2000);
            return; // Encontrou, para aqui.
        }
    }

    // 2. Procura no Texto (TreeWalker para encontrar n√≥s de texto)
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT, null, false);
    let node;
    while (node = walker.nextNode()) {
        const text = node.textContent;
        const index = text.toLowerCase().indexOf(lowerTerm);

        if (index >= 0) {
            // Encontrou o texto!
            
            // A. Tenta identificar se est√° dentro de um Post-it ou Subnota para destacar o contentor
            const container = node.parentElement.closest('.post-it-note, .mini-note-wrapper');
            if (container) {
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                container.classList.add('temporary-highlight');
                setTimeout(() => container.classList.remove('temporary-highlight'), 2000);
            } else {
                // Scroll no elemento pai direto
                node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // B. Selecionar o texto exato (Highlight nativo do browser)
            const range = document.createRange();
            range.setStart(node, index);
            range.setEnd(node, index + term.length);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            return; // Encontrou, para a pesquisa.
        }
    }
}

function saveNote(forceImmediate = false) {
    clearTimeout(saveTimeout);

    if (forceImmediate) {
        // Retorna a promessa da grava√ß√£o real
        return executeSave(); 
    }

    // Grava√ß√£o autom√°tica normal (espera 2 minutos)
    updateSaveStatus('unsaved');
    saveTimeout = setTimeout(async () => {
        await executeSave();
    }, 120000); 
}

// ============================================================
// FUN√á√ÉO AUXILIAR: Extrair todos os t√≥picos do HTML (Caixas)
// ============================================================
function extractTopicsFromEditorHTML() {
    // Encontra todas as caixas (Quest√µes, Subnotas, Contentores)
    const allWrappers = document.getElementById('note-content-editor').querySelectorAll('.mini-note-wrapper');
    const aggregatedTopics = {};

    allWrappers.forEach(wrapper => {
        try {
            // L√™ o atributo data-topics
            const jsonStr = wrapper.getAttribute('data-topics');
            
            // Ignora se estiver vazio
            if (!jsonStr || jsonStr === '{}') return;

            const topics = JSON.parse(jsonStr);

            // Junta tudo num √∫nico objeto grande
            for (const [topicId, subArray] of Object.entries(topics)) {
                
                // Se o t√≥pico ainda n√£o existe, cria array vazio
                if (!aggregatedTopics[topicId]) {
                    aggregatedTopics[topicId] = [];
                }

                // Adiciona subt√≥picos sem duplicar
                if (Array.isArray(subArray)) {
                    subArray.forEach(subId => {
                        if (!aggregatedTopics[topicId].includes(subId)) {
                            aggregatedTopics[topicId].push(subId);
                        }
                    });
                }
            }
        } catch (e) {
            console.warn("Erro ao ler t√≥picos de uma caixa:", e);
        }
    });

    return aggregatedTopics;
}

// Fun√ß√£o que faz a grava√ß√£o real no Firebase
async function executeSave() {
    // 1. Verifica√ß√£o de seguran√ßa
    if (!selectedNoteId && !activeEditingPostId) return;
    if (isClosingNote) return;

    // 2. MODO ARQUIVO (FEED) - L√≥gica separada
    const archiveArea = document.getElementById('archive-area');
    if (archiveArea && archiveArea.style.display !== 'none') {
        if (activeEditingPostId) {
            await saveArchivePost(activeEditingPostId);
            updateSaveStatus('saved');
            return true;
        }
        return true; 
    }

    // 3. SINCRONIZA√á√ÉO CR√çTICA (Inputs -> HTML) - COM ESTABILIZADOR DE SCROLL
    const editor = document.getElementById('note-content-editor');
    let currentScrollPos = 0;
    
    if (editor) {
        // A. Guarda a posi√ß√£o exata do scroll ANTES de qualquer altera√ß√£o
        currentScrollPos = editor.scrollTop;

        // Seleciona todos os campos que precisam de sincroniza√ß√£o
        const allInputs = editor.querySelectorAll('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
        
        allInputs.forEach(t => {
            // Se for TEXTAREA: Sincroniza textContent
            if (t.tagName === 'TEXTAREA') {
                if (t.textContent !== t.value) {
                    t.textContent = t.value; 
                }
            } 
            // Se for INPUT: Sincroniza atributo value
            else {
                // OTIMIZA√á√ÉO: S√≥ toca no DOM se o valor for realmente diferente
                // Isto evita que o navegador "pisque" ou salte em inputs que n√£o mudaram
                if (t.getAttribute('value') !== t.value) {
                    t.setAttribute('value', t.value);
                }
            }
        });

        // B. RESTAURA√á√ÉO IMEDIATA DO SCROLL (O SEGREDO)
        // Fazemos isto AGORA, antes mesmo de falar com o Firebase.
        // Isto anula qualquer salto que a sincroniza√ß√£o acima tenha causado.
        if (editor.scrollTop !== currentScrollPos) {
            editor.scrollTop = currentScrollPos;
        }
    }

    updateSaveStatus('saving');

    let targetId = selectedNoteId;
    const realId = editor ? editor.getAttribute('data-real-id') : null;
    if (realId) targetId = realId;

    try {
        const { doc, updateDoc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', targetId);

        const titleInput = document.getElementById('note-title-input');
        const finalTitle = titleInput ? titleInput.value : "Sem T√≠tulo";
        
        // Captura o HTML j√° estabilizado
        const finalContent = editor ? editor.innerHTML : "";
        
         const zoomSelect = document.getElementById('editor-zoom');
        const currentZoom = zoomSelect ? zoomSelect.value : '100%';

        // Extrai cores (se a fun√ß√£o existir)
        const usedColors = typeof extractUsedColorsFromEditor === 'function' ? extractUsedColorsFromEditor() : [];

        // Envio para o Firebase
        await updateDoc(noteRef, { 
            nome: finalTitle, 
            conteudo: finalContent,
            coresUsadas: usedColors,
             zoomLevel: currentZoom,
            ultimaedicao: serverTimestamp()
        });

        // Sincroniza√ß√£o P√∫blica (se necess√°rio)
        if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
             try {
                const shareId = currentNoteShareData.shareId;
                const publicNoteRef = doc(db, 'shared_notes', shareId);
                setDoc(publicNoteRef, {
                    nome: finalTitle,
                    conteudo: finalContent,
                    authorName: currentUserData?.nome || "An√≥nimo",
                    updatedAt: serverTimestamp(),
                    type: 'full_note' 
                }, { merge: true }).catch(e => {});
            } catch (e) {}
        }

        updateSaveStatus('saved');
        return true; 

    } catch (error) {
        console.error("‚ùå ERRO AO GUARDAR:", error);
        updateSaveStatus('error');
        return false;
    }
}


// SINCRONIZA√á√ÉO P√öBLICA (Se a nota estiver partilhada)
    if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
        try {
            // Grava na cole√ß√£o 'shared_notes' sem bloquear a grava√ß√£o principal
            setDoc(doc(db, 'shared_notes', currentNoteShareData.shareId), {
                nome: noteTitleInput.value,
                conteudo: noteContentEditor.innerHTML,
                authorName: currentUserData?.nome || "An√≥nimo",
                updatedAt: serverTimestamp(),
                type: 'full_note' // Marca como nota completa
            }, { merge: true }).catch(err => console.error("Erro sync partilha:", err));
            
        } catch (e) {
            console.warn("Falha silenciosa ao sincronizar partilha p√∫blica.");
        }
    }

    function insertMiniNoteAtCursor(type = 'default') {
    const editor = document.getElementById('note-content-editor');
    
    // 1. Obter a sele√ß√£o e validar
    let selection = window.getSelection();
    let range;

    if (selection.rangeCount > 0) {
        const anchorNode = selection.anchorNode;
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        
        if (!editor.contains(safeNode)) {
            selection = null; 
        } else {
            if (safeNode.closest('.mini-note-wrapper') || safeNode.closest('.redator-wrapper')) {
                alert("N√£o pode inserir uma caixa dentro de outra. Clique numa linha vazia primeiro.");
                return;
            }
            range = selection.getRangeAt(0);
        }
    }

    if (!selection || !range) {
        editor.focus();
        range = document.createRange();
        range.selectNodeContents(editor);
        range.collapse(false);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }

    // 2. Toolbar Comum
    const commonToolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Remover">üóëÔ∏è</button>
        </div>`;

    let finalHTML = '';
    const uniqueId = type === 'redator' ? `red_${Date.now()}` : `mn_${Date.now()}`;
    const inputStyle = "user-select: text; -webkit-user-select: text; pointer-events: auto; touch-action: manipulation;";

    // --- TIPO: REDATOR ---
   if (type === 'redator') {
        finalHTML = `
        <div class="redator-wrapper" id="${uniqueId}" contenteditable="false" data-shared="false" data-box-links='{}' data-paragraph="0">
            
            <!-- Bot√£o T (Esquerda) -->
            <button class="redator-reopen-btn" onclick="window.toggleRedatorHeader('${uniqueId}', true)">T</button>
            
            <!-- NOVO: Bot√£o ‚ãÆ (Direita - S√≥ aparece quando colapsado) -->
            <button class="redator-collapsed-menu-btn" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>

            <!-- MENU (Agora vive aqui fora para funcionar nos dois modos) -->
            <div class="redator-slide-menu">
                <button class="tool-icon-btn" data-action="sharing-settings" title="Partilha">üîê</button>
                <button class="tool-icon-btn" data-action="manage-box-links" title="Links/Codex">‚ö°</button>
                <button class="tool-icon-btn" data-action="move-up" title="Subir">üî∫</button>
                <button class="tool-icon-btn" data-action="move-down" title="Descer">üîª</button>
                <button class="tool-icon-btn" data-action="highlight-color" title="Cor">üé®</button>
                <button class="tool-icon-btn" data-action="manage-mini-note-topics" title="T√≥picos">üìã</button>
                <button class="tool-icon-btn" data-action="append-mini-note" title="Clonar">üß¨</button>
                <div style="width:1px; background:rgba(255,255,255,0.2); height:15px; margin:0 2px;"></div>
                <button class="tool-icon-btn" data-action="delete-mini-note" style="color:#e74c3c;">üóëÔ∏è</button>
            </div>

            <div class="redator-header" id="header-${uniqueId}">
               <input type="text" class="redator-input" placeholder="T√≠tulo do Redator..." value="" 
                      oninput="this.setAttribute('value', this.value)" 
                      style="${inputStyle}">
                <div class="redator-top-tools">
                    <!-- O bot√£o ‚ãÆ normal do cabe√ßalho -->
                    <button class="redator-menu-trigger" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>
                </div>
            </div>
            
            <div class="redator-content" contenteditable="true" data-placeholder="" oninput="window.checkRedatorFocus(this, '${uniqueId}')"><p><br></p></div>
            
            <div class="redator-dock">
                 <button class="dock-btn" onclick="event.preventDefault(); window.openRedatorFocus('${uniqueId}')"><svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg></button>
                 <div class="dock-sep"></div>
                 <button class="dock-btn" onclick="event.preventDefault(); window.addRedatorBelow('${uniqueId}')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
            </div>
        </div>
        <p><br></p>`;
    }
    
    // --- OUTROS TIPOS ---
    else {
        let wrapperClass = 'mini-note-wrapper';
        let titleHTML = `<textarea class="mini-note-title-input" placeholder="T√≠tulo..." rows="1" style="${inputStyle}"></textarea>`;

        if (type === 'question') {
            wrapperClass += ' question-mode';
            titleHTML = `<textarea class="mini-note-title-input" placeholder="Pergunta?" rows="1" style="${inputStyle}"></textarea>`;
        } else if (type === 'free') {
            wrapperClass += ' free-mode';
            titleHTML = ''; 
        }

        finalHTML = `
            <p><br></p>
            <div class="${wrapperClass}" contenteditable="false" id="${uniqueId}" data-topics='{}' data-shared="false" data-box-links='{}'>
                ${titleHTML}
                ${commonToolbarHTML} 
                <div class="mini-note-content" contenteditable="true">
                    <p><br></p>
                </div>
            </div>
            <p><br></p>
        `;
    }

    // 1. INSERIR HTML
   document.execCommand('insertHTML', false, finalHTML);
    
    // 2. MARCAR COMO "POR GUARDAR"
    if (typeof updateSaveStatus === 'function') updateSaveStatus('unsaved');
    if (typeof saveNote === 'function') saveNote(false); 

    // 3. APLICAR FOCO (L√ìGICA CORRIGIDA COM GPS)
   setTimeout(() => {
        const insertedEl = document.getElementById(uniqueId);
        if (insertedEl) {
            
            // --- DECIS√ÉO DE ALVO DO CURSOR ---
            let targetToFocus = null;
            let isTitleInput = false;

            if (type === 'redator') {
                targetToFocus = insertedEl.querySelector('.redator-content');
            } 
            else if (type === 'free') {
                targetToFocus = insertedEl.querySelector('.mini-note-content');
            } 
            else {
                // SUBNOTA E QUEST√ÉO: VAI PARA O T√çTULO
                targetToFocus = insertedEl.querySelector('.mini-note-title-input');
                isTitleInput = true;
            }

            // --- EXECU√á√ÉO DO FOCO ---
            if (targetToFocus) {
                // Remove foco do editor principal
                if(editor) editor.blur(); 
                
                targetToFocus.focus();
                
                // Se for div contenteditable (Redator/Contentor)
                if (targetToFocus.getAttribute('contenteditable') === 'true') {
                    const range = document.createRange();
                    range.selectNodeContents(targetToFocus);
                    range.collapse(false); 
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    
                    // Chama o GPS normal para conte√∫do
                    if (typeof trackCursorPosition === 'function') trackCursorPosition();
                } 
                // Se for INPUT/TEXTAREA (SubNota/Quest√£o) - FOR√áA MANUAL
                else {
                    window.lastCursorGPS = {
                        active: true,
                        type: 'input', // For√ßa 'input' para garantir que volta ao t√≠tulo
                        containerId: uniqueId,
                        path: [], 
                        offset: 0,
                        timestamp: Date.now()
                    };
                    console.log("üìç [GPS] Posi√ß√£o for√ßada no T√≠tulo da nova caixa.");
                }
            }
            
            // Scroll suave
            insertedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 50); 
}

// Fun√ß√£o auxiliar para aplicar o foco (Reutiliz√°vel)
function applyFocusLogic(uniqueId, type, editor) {
    const insertedEl = document.getElementById(uniqueId);
    if (!insertedEl) return;

    // A. Scroll para ver o elemento
    insertedEl.scrollIntoView({ behavior: 'auto', block: 'center' });

    // B. Decidir o Alvo
    let targetToFocus = null;

    if (type === 'redator') {
        targetToFocus = insertedEl.querySelector('.redator-content');
    } 
    else if (type === 'free') {
        targetToFocus = insertedEl.querySelector('.mini-note-content');
    } 
    else {
        // SubNota e Quest√£o -> T√çTULO
        targetToFocus = insertedEl.querySelector('.mini-note-title-input');
    }

    // C. Executar Foco
    if (targetToFocus) {
        editor.blur(); 
        
        targetToFocus.focus();
        targetToFocus.click(); 

        if (targetToFocus.tagName === 'TEXTAREA' || targetToFocus.tagName === 'INPUT') {
            const val = targetToFocus.value;
            targetToFocus.value = '';
            targetToFocus.value = val;
        }
        else if (targetToFocus.getAttribute('contenteditable') === 'true') {
            const range = document.createRange();
            range.selectNodeContents(targetToFocus);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // >>> CORRE√á√ÉO FUNDAMENTAL AQUI TAMB√âM <<<
        // Atualiza o GPS manualmente
        if (typeof trackCursorPosition === 'function') {
            trackCursorPosition();
        }
    }
}
                
       


// ====================================================================
// L√ìGICA DE IDEIAS (üí°)
// ====================================================================

// 1. CRIAR IDEIA (No evento do Selection Popup)
// Adicione este bloco dentro do listener existente 'selectionPopup.addEventListener' 
// Pode copiar este bloco e colocar junto aos outros 'else if' desse listener, ou adicionar separado se preferir
selectionPopup.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // ------------------------------------------
    // A√á√ÉO 1: CRIAR CART√ÉO WEB (üé¥) - NOVO!
    // ------------------------------------------
    if (action === 'create-url-card') {
        // Chama a fun√ß√£o auxiliar que cri√°mos para lidar com a API e o HTML
        await convertSelectionToUrlCard();
        
        // Fecha o popup
        selectionPopup.style.display = 'none';
        window.getSelection().removeAllRanges();
        currentSelectionRange = null;
        return; 
    }

    // ------------------------------------------
    // A√á√ÉO 2: CRIAR IDEIA (üí°)
    // ------------------------------------------
    else if (action === 'create-idea') {
        // Tenta recuperar a sele√ß√£o global guardada
        if (!currentSelectionRange) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0).cloneRange();
        }

        if (!currentSelectionRange) return;

        const text = currentSelectionRange.toString();
        if (!text.trim()) return;

        try {
            // Gravar no Firebase
            const ideaRef = await addDoc(collection(db, 'ideias'), {
                texto: text,
                origemNoteId: selectedNoteId,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Criar o SPAN visual vermelho
            const span = document.createElement('span');
            span.className = 'idea-span';
            span.dataset.ideaId = ideaRef.id;
            span.setAttribute('spellcheck', 'false');
            span.textContent = text;

            // Substitui√ß√£o
            currentSelectionRange.deleteContents();
            currentSelectionRange.insertNode(span);

            // Inserir espa√ßo invis√≠vel depois para n√£o prender o cursor
            const space = document.createTextNode('\u00A0');
            if (span.nextSibling) {
                span.parentNode.insertBefore(space, span.nextSibling);
            } else {
                span.parentNode.appendChild(space);
            }

            // Move cursor para fora
            const newRange = document.createRange();
            newRange.setStartAfter(space);
            newRange.collapse(true);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(newRange);

            saveNote();

        } catch (error) {
            console.error("Erro ao criar ideia:", error);
            alert("Erro ao criar ideia.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 3: CRIAR LINK / EDITAR LINK (üîó)
    // ------------------------------------------
    else if (action === 'create-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        // Verifica se j√° estamos dentro de um link
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }

        if (linkElement) {
            // Modo Edi√ß√£o
            openLinkModal(true, { 
                id: linkElement.dataset.anexoId, 
                title: linkElement.textContent, 
                url: linkElement.href 
            });
        } else {
            // Modo Cria√ß√£o
            if (currentSelectionRange) {
                const selectedText = currentSelectionRange.toString().trim();
                openLinkModal(false, selectedText);
            } else {
                alert("Por favor, selecione o texto novamente.");
            }
        }
    }

    // ------------------------------------------
    // A√á√ÉO 4: REMOVER LINK (‚õìÔ∏è‚Äçüí•)
    // ------------------------------------------
    else if (action === 'break-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }
        
        if (linkElement) {
            // Abre modal em modo edi√ß√£o (que tem o bot√£o remover)
            openLinkModal(true, { id: linkElement.dataset.anexoId });
        } else {
            alert("O cursor n√£o est√° sobre um anexo.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 5: CRIAR ENTIDADE (üìç, üë§, üìÖ, üìñ)
    // ------------------------------------------
    else if (action === 'create-entity') {
        const type = btn.dataset.type; // ex: 'local', 'personagem'
        const selectedText = currentSelectionRange ? currentSelectionRange.toString().trim() : "";

        if(selectedText) {
            openEntityModal(type, selectedText);
        } else {
            alert("Selecione texto para criar uma entidade.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 6: CRIAR POST-IT (üìí)
    // ------------------------------------------
    else if (action === 'highlight') { 
        if (!currentSelectionRange) {
            // Tenta obter do window se a global falhar
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0);
        }

        const selectedText = currentSelectionRange ? currentSelectionRange.toString() : ""; 

        if (!selectedText.trim()) {
            alert("Selecione algum texto para criar um post-it.");
        } else {
            // Cria o Container
            const container = document.createElement('div');
            container.className = 'post-it-note active-note';
            container.contentEditable = "false";
            
            // Posi√ß√£o (perto do scroll atual)
            const scrollTop = noteContentEditor.scrollTop;
            container.style.top = (scrollTop + 50) + 'px'; 
            container.style.left = '50px';
            container.id = 'postit_' + Date.now();

            // Puxador
            const handle = document.createElement('div');
            handle.className = 'post-it-drag-handle';
            handle.innerHTML = '‚ú•';
            handle.contentEditable = "false"; 

            // Bot√£o Cortar (Tesoura)
            const cutBtn = document.createElement('div');
            cutBtn.className = 'post-it-cut-btn';
            cutBtn.title = "Reverter para texto normal";
            cutBtn.innerHTML = '‚úÇÔ∏è';
            cutBtn.contentEditable = "false";

            // Conte√∫do
            const content = document.createElement('div');
            content.className = 'post-it-content';
            content.contentEditable = "true"; 
            content.innerHTML = selectedText; // Usa innerHTML para manter formata√ß√£o b√°sica

            container.appendChild(handle);
            container.appendChild(cutBtn);
            container.appendChild(content);

            // Remove o texto original e insere o post-it
            currentSelectionRange.deleteContents();
            noteContentEditor.appendChild(container);
            
            saveNote(); 
        }
    }

    // ------------------------------------------
    // FINALIZA√á√ÉO (Limpeza Comum)
    // ------------------------------------------
    selectionPopup.style.display = 'none';
    window.getSelection().removeAllRanges();
    currentSelectionRange = null; 
});





function validateAndCleanBiblicalLinks() {
    
    const biblicalBooksPattern = `${BIBLICAL_BOOKS.join('|')}`;

    // =======================================================
    // AQUI ESTAVA O ERRO PERSISTENTE - ESTA √â A REGEX CORRETA E RIGOROSA
    // =======================================================
    const validPattern = new RegExp(`^${biblicalBooksPattern}\\s+\\d+:\\d[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    


    let domChanged = false;

    links.forEach((link, index) => {
        const originalText = link.textContent;
        const trimmedText = originalText.trim();
        

        if (!validPattern.test(trimmedText)) {
            
            const textNode = document.createTextNode(originalText);
            link.parentNode.replaceChild(textNode, link);

            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(textNode, textNode.length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            domChanged = true;
        } else {
        }
    });

    if (domChanged) {
    } else {
    }
    
    return domChanged;
}



/**
 * Percorre o editor para remover caracteres invis√≠veis (como o Zero-Width Space)
 * que podem ter sido deixados por outras opera√ß√µes, garantindo que a l√≥gica de 
 * reconhecimento de entidades funcione em texto limpo.
 * A posi√ß√£o do cursor √© cuidadosamente preservada.
 */
function cleanupInvisibleCharacters() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) return;

    // Salva a posi√ß√£o original do cursor
    const originalRange = selection.getRangeAt(0);
    let originalContainer = originalRange.startContainer;
    let originalOffset = originalRange.startOffset;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        nodesToProcess.push(node);
    }
    
    const ZWSP = /\u200B/g; // Regex para o caractere invis√≠vel (Zero-Width Space)

    for (const textNode of nodesToProcess) {
        if (ZWSP.test(textNode.textContent)) {
            // Se o cursor estiver neste n√≥, ajustamos a sua posi√ß√£o futura
            if (textNode === originalContainer) {
                // Conta quantos caracteres invis√≠veis existem ANTES da posi√ß√£o do cursor
                const charsToRemoveBeforeCursor = (textNode.textContent.substring(0, originalOffset).match(ZWSP) || []).length;
                originalOffset -= charsToRemoveBeforeCursor;
            }
            // Remove todos os caracteres invis√≠veis do n√≥ de texto
            textNode.textContent = textNode.textContent.replace(ZWSP, '');
        }
    }

    // Normaliza o editor para juntar n√≥s de texto que possam ter sido separados
    noteContentEditor.normalize();

    // Restaura a posi√ß√£o do cursor, garantindo que o n√≥ ainda existe
    try {
        const newRange = document.createRange();
        // Verifica se o container original ainda faz parte do documento
        if (document.body.contains(originalContainer)) {
             // Garante que a posi√ß√£o n√£o exceda o novo comprimento do texto
            const newOffset = Math.min(originalOffset, originalContainer.textContent.length);
            newRange.setStart(originalContainer, newOffset);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
        }
    } catch (e) {
        console.error("Erro ao restaurar a posi√ß√£o do cursor ap√≥s a limpeza:", e);
    }
}




 // ===================================================================
// FUN√á√ÉO SCANANDLINKENTITIES - VERS√ÉO COM REGEX CORRIGIDA
// ===================================================================
 async function scanAndLinkEntities() {
    const logStyles = {
        header: 'color: white; background-color: #1abc9c; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;',
        automation: 'color: white; background-color: #8e44ad; font-weight: bold; padding: 2px 5px; border-radius: 3px;'
    };


    noteContentEditor.normalize();
    
    // --- CORRE√á√ÉO AQUI ---
    const hasCleanedLinks = await validateAndCleanBiblicalLinks(); 
    // ---------------------

    if (hasCleanedLinks) {
        updateSaveStatus('unsaved');
        saveNote(); 
        console.groupEnd();
        return; 
    } else {
    }

    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
        console.groupEnd();
        return;
    }
    const originalRange = selection.getRangeAt(0).cloneRange();

    console.group('%cFASE 1: Liga√ß√£o de Formato Padr√£o (Livro C:V)', logStyles.phase);
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const standardBiblicalRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)\\b`, 'giu');
    

    let domModified = false;
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) {
            nodesToProcess.push(node);
        }
    }

    for (const textNode of nodesToProcess) {
        standardBiblicalRegex.lastIndex = 0;
        let match;
        if ((match = standardBiblicalRegex.exec(textNode.textContent)) !== null) {
            domModified = true;
            
            const matchedName = match[1].trim(); 
            const cleanedName = matchedName.replace(/[.,;]+$/, '');

            const matchStartIndex = match.index;
            
            textNode.splitText(matchStartIndex + matchedName.length);
            let matchNode = textNode.splitText(matchStartIndex);
            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = 'textobiblico';
            span.dataset.entityName = cleanedName;
            span.textContent = cleanedName;
            matchNode.parentNode.replaceChild(span, matchNode);
            
            const allExistingEntities = Object.values(allEntities).flat();
            let entity = allExistingEntities.find(e => e.tipo === 'textobiblico' && e.nome.toLowerCase() === cleanedName.toLowerCase());
            
            if (!entity) {
                console.group('%c[Automa√ß√£o] Nova Entidade B√≠blica Detetada', logStyles.automation);
                const collectionName = ENTITY_CONFIG['textobiblico'].collection;

                try {
                    await addDoc(collection(db, collectionName), { 
                        nome: cleanedName, 
                        descricao: "", 
                        userId: auth.currentUser.uid, 
                        createdAt: serverTimestamp(), 
                        referencias: { [selectedNoteId]: true } 
                    });

                } catch (error) {
                    console.error(`%c  - ERRO: Falha ao criar a entidade autom√°tica na base de dados.`, 'color: red; font-weight: bold;', error);
                } finally {
                    await fetchAllEntities(); 
                    console.groupEnd(); 
                }
            }
            break; 
        }
    }
    console.groupEnd(); 
    
    if (domModified) {
        selection.removeAllRanges();
        selection.addRange(originalRange);
        updateSaveStatus('unsaved');
        saveNote();
    }
}





function maintainEntityProtection() {
    const entityLinks = noteContentEditor.querySelectorAll('.entity-link');
    let domModified = false;

    entityLinks.forEach(link => {
        const parent = link.parentNode;
        let needsProtectionBefore = true;
        let needsProtectionAfter = true;

        // Verifica o que existe ANTES do link
        if (link.previousSibling && link.previousSibling.nodeType === Node.TEXT_NODE && link.previousSibling.textContent.endsWith('\u200B')) {
            needsProtectionBefore = false;
        }

        // Verifica o que existe DEPOIS do link
        if (link.nextSibling && link.nextSibling.nodeType === Node.TEXT_NODE && link.nextSibling.textContent.startsWith('\u200B')) {
            needsProtectionAfter = false;
        }

        // Se faltar prote√ß√£o antes, adiciona-a
        if (needsProtectionBefore) {
            const zeroWidthSpace = document.createTextNode('\u200B');
            parent.insertBefore(zeroWidthSpace, link);
            domModified = true;
        }

        // Se faltar prote√ß√£o depois, adiciona-a
        if (needsProtectionAfter) {
            const zeroWidthSpace = document.createTextNode('\u200B');
            // insertBefore √© usado para inserir depois, passando o "irm√£o" seguinte como refer√™ncia
            parent.insertBefore(zeroWidthSpace, link.nextSibling);
            domModified = true;
        }
    });

    if (domModified) {
        // A normaliza√ß√£o junta n√≥s de texto adjacentes, limpando o c√≥digo
        noteContentEditor.normalize();
    }
}


    async function validateAndReconcileAllEntities() {
    // Estilos para os logs na consola
    const logStyles = {
        header: 'color: white; background-color: #00a8ff; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;'
    };

    console.groupCollapsed('%c[Reconcilia√ß√£o] Iniciando verifica√ß√£o completa de entidades...', logStyles.header);

    // ETAPA 1: Preservar a posi√ß√£o do cursor
    const selection = window.getSelection();
    let cursorMarker = null;
    let originalRange = null;
    if (selection && selection.rangeCount > 0) {
        originalRange = selection.getRangeAt(0).cloneRange();
        if (selection.isCollapsed) {
            cursorMarker = document.createElement('span');
            cursorMarker.id = 'cursor-marker'; // A nossa "bandeira"
            try {
                originalRange.insertNode(cursorMarker);
            } catch (e) {
                console.warn('  - N√£o foi poss√≠vel inserir o marcador de cursor. A sele√ß√£o pode estar num local inv√°lido.', e);
                cursorMarker = null; // Garante que n√£o tentaremos encontr√°-lo mais tarde
            }
        } else {
        }
    } else {
    }
    
    // ETAPA 2: Varrer e corrigir
    const allKnownEntities = Object.values(allEntities).flat();
    if (!allKnownEntities || allKnownEntities.length === 0) {
        // Ainda assim, remove o marcador se ele foi inserido
        if (cursorMarker) cursorMarker.parentNode.removeChild(cursorMarker);
        console.groupEnd();
        return;
    }


    let keepLooping = true;
    let pass = 0;
    while (keepLooping) {
        pass++;
        keepLooping = false; // Assume que esta ser√° a √∫ltima passagem, a menos que uma altera√ß√£o seja feita
        
        const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
        const nodesToProcess = [];
        let n;
        while (n = walker.nextNode()) {
            nodesToProcess.push(n);
        }


        for (const node of nodesToProcess) {
            // Ignora n√≥s que j√° est√£o dentro de elementos especiais para evitar trabalho desnecess√°rio
            if (!node.parentElement || node.parentElement.closest('.entity-link, .tag, a, #cursor-marker')) {
                continue;
            }

            for (const entity of allKnownEntities) {
                // A l√≥gica de textos b√≠blicos √© tratada noutra fun√ß√£o, por isso ignoramo-la aqui.
                if (entity.tipo === 'textobiblico') continue;
                
                const entityName = entity.nome;
                // Usa uma RegEx com `\b` (word boundary) para encontrar a palavra exata
                const regex = new RegExp(`\\b(${escapeRegExp(entityName)})\\b`);
                
                if (regex.test(node.textContent)) {


                    // Divide o n√≥ de texto em tr√™s partes: antes, durante e depois da correspond√™ncia
                    const matchIndex = node.textContent.search(regex);
                    node.splitText(matchIndex + entityName.length); // Divide depois
                    const matchNode = node.splitText(matchIndex); // Divide antes
                    
                    // Cria o novo elemento <span> para a entidade
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = entity.tipo;
                    span.dataset.entityName = entity.nome;
                    span.textContent = entity.nome;
                    
                    // Substitui o n√≥ de texto (que agora cont√©m apenas o nome da entidade) pelo <span> formatado
                    matchNode.parentNode.replaceChild(span, matchNode);
                    
                    keepLooping = true; // For√ßa uma nova passagem porque o DOM foi alterado
                    break; // Sai do loop de entidades
                }
            }
            if (keepLooping) break; // Sai do loop de n√≥s para reiniciar a passagem
        }
        if (!keepLooping) {
        }
    }
    
    // ETAPA 3: Restaurar a posi√ß√£o do cursor
    const markerInDom = document.getElementById('cursor-marker');
    if (markerInDom) {
        const newRange = document.createRange();
        // Colocamos o cursor ANTES da √¢ncora para que ele fique na posi√ß√£o correta
        newRange.setStartBefore(markerInDom);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);
        // Removemos a √¢ncora depois de a usarmos
        markerInDom.parentNode.removeChild(markerInDom);
    } else if (originalRange) {
        // Fallback: se n√£o t√≠nhamos uma √¢ncora (ex: sele√ß√£o de texto), restauramos o range original
        selection.removeAllRanges();
        selection.addRange(originalRange);
    } else {
    }
    
    console.groupEnd();
}

function requestPassword(mode, itemId) {
    return new Promise((resolve) => {
        const modal = document.getElementById('password-modal');
        const input = document.getElementById('password-input');
        const confirmBtn = document.getElementById('password-confirm-btn');
        const cancelBtn = document.querySelector('#password-modal [data-action="cancel"]');
        const errorMsg = document.getElementById('password-error');

        if (!modal) return resolve(null);

        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "10000000";

        input.value = '';
        if (errorMsg) errorMsg.style.display = 'none';

        const title = document.getElementById('password-modal-title');
        const desc = document.getElementById('password-modal-desc');

        if (mode === 'create') {
            title.textContent = 'Definir Prote√ß√£o';
            desc.textContent = 'Escolha uma palavra-passe para este item.';
        } else {
            title.textContent = 'Item Protegido';
            desc.textContent = 'Insira a palavra-passe para aceder.';
        }

        setTimeout(() => input.focus(), 200);

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const cleanup = (value) => {
            modal.style.display = 'none';
            resolve(value);
        };

    newConfirmBtn.onclick = async (e) => {
    e.preventDefault();
    const pass = input.value.trim();
    if (!pass) return;

    if (mode === 'create') {
        cleanup(pass);
    } else {
        // MODO ACESSO ou REMOVE
        try {
            const docRef = doc(db, 'pastas', itemId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists() && docSnap.data().passe === pass) {
                if (mode === 'remove') {
                    // SE FOR PARA REMOVER, APAGA O CAMPO NO FIREBASE
                    await updateDoc(docRef, {
                        passe: deleteField() 
                    });
                }
                cleanup(true);
            } else {
                if (errorMsg) errorMsg.style.display = 'block';
                input.value = '';
                input.focus();
            }
        } catch (err) {
            console.error(err);
            cleanup(false);
        }
    }
};

        if (cancelBtn) cancelBtn.onclick = () => cleanup(null);
    });
}

// --- FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS ---

function showContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const item = e.target.closest('.list-item');
    if (!item) return;

    const menu = document.getElementById('context-menu');
    const myUid = auth.currentUser.uid;
    
    // Captura os dados do item
    activeItemContext = {
        id: item.dataset.id,
        name: item.dataset.name,
        type: item.dataset.type,
        emoji: item.dataset.emoji,
        parentId: item.dataset.parentId === "null" ? null : item.dataset.parentId,
        isSuperfolder: item.dataset.superpasta === "true",
        isPinned: item.dataset.pinned === "true",
        isProtected: item.dataset.protected === "true",
        oque: item.dataset.oque, // <--- IMPORTANTE: L√™ se √© flash
        userId: item.dataset.userid || myUid
    };

    // 1. Esconder tudo primeiro
    menu.querySelectorAll('button').forEach(b => {
        if(!b.classList.contains('context-menu-close')) b.style.display = 'none';
    });
    menu.querySelectorAll('.menu-sep').forEach(sep => sep.style.display = 'none');

    // 2. L√≥gica de exibi√ß√£o
    if (activeItemContext.type === 'cosmos-parent' || activeItemContext.type === 'subcosmos') {
        // ... (l√≥gica cosmos mant√©m-se) ...
        menu.querySelector('[data-action="rename"]').style.display = 'flex';
        menu.querySelector('[data-action="hide"]').style.display = 'flex';
    } else {
        // SEMPRE VIS√çVEIS (Renomear e Ocultar)
        menu.querySelector('[data-action="rename"]').style.display = 'flex';
        menu.querySelector('[data-action="hide"]').style.display = 'flex';

        // CONDI√á√ïES PARA BOT√ïES EXTRAS (Local, Pins OU FLASH)
        if (currentViewMode === 'local' || currentViewMode === 'pins' || currentViewMode === 'flash') {
            
            // --- PROTE√á√ÉO ---
            if (activeItemContext.isProtected) {
                menu.querySelector('[data-action="unprotect"]').style.display = 'flex';
            } else {
                menu.querySelector('[data-action="protect"]').style.display = 'flex';
            }

            // --- MOVIMENTO ---
            // "Mover Posi√ß√£o" s√≥ faz sentido em listas ordenadas (Local), mas "Mover Pasta" serve para todos
            if (currentViewMode === 'local') {
                menu.querySelector('[data-action="move-position"]').style.display = 'flex';
            }
            menu.querySelector('[data-action="move-folder"]').style.display = 'flex';
            
            // --- T√ìPICOS ---
            menu.querySelector('[data-action="manage-topics"]').style.display = 'flex';
            
            // --- PIN (Opcional no Flash, mas pode manter) ---
            menu.querySelector('[data-action="toggle-pin"]').style.display = 'flex';
            menu.querySelector('[data-action="toggle-pin"]').textContent = activeItemContext.isPinned ? "Remover Pin" : "Adicionar Pin";

            // --- SUPERPASTA (Apenas se for pasta) ---
            if (activeItemContext.type === 'pasta') {
                menu.querySelector('[data-action="toggle-superfolder"]').style.display = 'flex';
                // ...
            }
        }
    }

    // 3. Gest√£o de Separadores (Mant√©m-se igual)
    const separators = menu.querySelectorAll('.menu-sep');
    separators.forEach(sep => {
        let hasVisibleBefore = false;
        let prev = sep.previousElementSibling;
        while(prev && !prev.classList.contains('menu-sep')) {
            if(prev.style.display === 'flex') { hasVisibleBefore = true; break; }
            prev = prev.previousElementSibling;
        }
        if(hasVisibleBefore) sep.style.display = 'block';
    });

    // 4. Exibir o Popup
    menu.style.display = 'flex';
    let overlay = document.getElementById('context-menu-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'context-menu-overlay';
        overlay.style.cssText = "position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999999; display:none;";
        overlay.onclick = window.hideContextMenu;
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'block';
}

// Atualizar a fun√ß√£o de fechar para esconder o overlay tamb√©m
// Define a fun√ß√£o globalmente para que o bot√£o "Cancelar" no HTML a consiga encontrar
window.hideContextMenu = function() {
    
    const menu = document.getElementById('context-menu');
    if (menu) menu.style.display = 'none';
    
    // Esconde tamb√©m o fundo escuro (overlay) se ele existir
    const overlay = document.getElementById('context-menu-overlay');
    if (overlay) overlay.style.display = 'none';
    
    activeItemContext = null;
};



function showConfirmation(title, message) {
    const modal = document.getElementById('confirm-modal');
    if (!modal) return Promise.resolve(false);

    const titleEl = document.getElementById('confirm-title');
    const messageEl = document.getElementById('confirm-message');
    const confirmBtn = modal.querySelector('[data-action="confirm"]');
    const cancelBtn = modal.querySelector('[data-action="cancel"]');

    // 1. Atualiza Texto
    titleEl.textContent = title;
    messageEl.textContent = message;

    // 2. FOR√áA BRUTA DE VISIBILIDADE (CORRE√á√ÉO)
    document.body.appendChild(modal); // Move para o topo da hierarquia
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO 32-BIT INT */
        justify-content: center !important;
        align-items: center !important;
    `;

    // 3. Reset do Bot√£o
    if (confirmBtn) {
        confirmBtn.textContent = "Confirmar";
        confirmBtn.disabled = false;
        
        // Remove ouvintes antigos clonando
        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        
        const newCancel = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        return new Promise(resolve => {
            newConfirm.onclick = () => {
                modal.style.display = 'none';
                resolve(true);
            };
            newCancel.onclick = () => {
                modal.style.display = 'none';
                resolve(false);
            };
        });
    }
    return Promise.resolve(false);
}

async function updateTagLink(tagName, noteId, shouldExist) {
    const tag = allTags.find(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tag) {
        console.error(`Tag "${tagName}" n√£o encontrada no cache para atualiza√ß√£o.`);
        return;
    }
    const tagRef = doc(db, 'tags', tag.id);
    const updateData = {};
    if (shouldExist) {
        updateData[`notas.${noteId}`] = true;
    } else {
        updateData[`notas.${noteId}`] = deleteField();
    }
    try {
        await updateDoc(tagRef, updateData);
    } catch (error) {
        console.error(`Erro ao atualizar v√≠nculo da tag "${tagName}":`, error);
    }
}

// --- L√ìGICA DE MODAIS E PAIN√âIS ADICIONAIS ---

async function openMoveModal(itemContext) {
    if (!itemContext) return;

    const modal = document.getElementById('move-item-modal');
    const list = document.getElementById('move-list');
    
    list.innerHTML = '<li style="padding:10px;">Carregando...</li>';
    modal.style.display = 'flex';
    
    try {
        let pId = itemContext.parentId;

        // SEURAN√áA PARA SUPERPASTAS: 
        // Se pId for null mas o itemContext n√£o tiver essa info, vamos validar no Firebase
        if (pId === undefined) {
            const docSnap = await getDoc(doc(db, 'pastas', itemContext.id));
            if (docSnap.exists()) {
                pId = docSnap.data().parentId;
            }
        }

        // Query: Busca todos os itens que t√™m o MESMO pai que o item clicado
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', pId), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('ordem')
        );
        
        const snapshot = await getDocs(q);
        let items = [];
        snapshot.forEach(doc => {
            items.push({ id: doc.id, ...doc.data() });
        });

        if (items.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum item encontrado nesta localiza√ß√£o.</li>';
        } else {
            renderMoveList(items, itemContext.id); 
        }

    } catch (error) {
        console.error("Erro ao carregar itens para mover:", error);
        list.innerHTML = '<li style="padding:10px; color:#e74c3c;">Erro ao carregar dados.</li>';
    }
}

// --- NOVA FUN√á√ÉO PARA GERIR O MODAL "MOVER DE PASTA" ---
 async function openMoveToFolderModal(itemContext) {
    if (!itemContext) return;

    itemToMoveRef = itemContext; 
    const modal = document.getElementById('move-to-folder-modal');
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const nameSpan = document.getElementById('item-to-move-name');
    
    if (!modal) return;

    // --- APLICA√á√ÉO DA BLINDAGEM (IGUAL AO RENAME) ---
    document.body.appendChild(modal); 
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.setProperty('z-index', '20000000', 'important');
    modal.style.setProperty('visibility', 'visible', 'important');
    modal.style.setProperty('opacity', '1', 'important');

    if(nameSpan) nameSpan.textContent = itemContext.name;

    // --- RECONFIGURA√á√ÉO DA NAVEGA√á√ÉO (Mant√©m o resto do teu c√≥digo) ---
    let navContainer = document.getElementById('move-folder-nav-container');
    if (!navContainer) {
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        `;
        list.parentNode.insertBefore(navContainer, list);
        
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : rootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(rootId);
            }
        });
    }

    moveStack = []; 
    selectedDestFolderId = null; 
    
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    loadMoveFolderList(startRootId);

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        let targetId = selectedDestFolderId;
        
        // Se n√£o selecionou nada, assume a pasta atual da navega√ß√£o do modal
        if (targetId === null) {
            const currentViewId = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : startRootId;
            if(!confirm(`Mover "${itemContext.name}" para a pasta que est√° a ver agora?`)) return;
            targetId = currentViewId;
        }

        if (targetId === itemContext.id) {
            alert("N√£o pode mover uma pasta para dentro de si mesma.");
            return;
        }

        try {
            // Importar deleteField se necess√°rio (ou use 'deleteField()' direto se j√° importado no topo)
            const { doc, updateDoc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const itemRef = doc(db, 'pastas', itemContext.id);
            
            // Dados base da atualiza√ß√£o
            const updateData = {
                parentId: targetId, 
                ultimaedicao: serverTimestamp()
            };

            // --- L√ìGICA DE REMO√á√ÉO DO FLASH ---
            // Se estamos no modo Flash OU se o item tem o marcador 'flash'
            if (currentViewMode === 'flash' || itemContext.oque === 'flash') {
                console.log("‚ö° Removendo estado 'Flash' ao mover para pasta normal.");
                // Remove o campo 'oque' do documento no Firebase
                updateData.oque = deleteField();
            }
            // ----------------------------------

            await updateDoc(itemRef, updateData);
            
            modal.style.display = 'none';
            
            // Atualiza a vista para refletir que o item saiu daqui
            // Se estivermos em Flash, o item vai desaparecer da lista
            if (currentViewMode === 'flash') {
                 loadFlashListLeftPanel();
            } else {
                 updateNavigationView(true);
            }
            
        } catch (error) {
            console.error("Erro ao mover:", error);
            alert("Erro ao mover item.");
        }
    };
}

// ============================================================
// 2. CARREGAR LISTA (VISUAL IGUAL AO üß¨)
// ============================================================
async function loadMoveFolderList(parentId, isLoadMore = false) {
    const list = document.getElementById('folder-selection-list');
    const navContainer = document.getElementById('move-folder-nav-container');
    const backBtn = document.getElementById('move-folder-back-btn');
    const pathLabel = document.getElementById('move-folder-path');
    const LOAD_LIMIT = 15;

    // 1. MOSTRAR A BARRA DE NAVEGA√á√ÉO (Para saber onde estamos)
    if (navContainer) {
        navContainer.style.display = 'flex';
    }

    // Se N√ÉO for "Carregar Mais", √© uma navega√ß√£o nova (limpar tudo)
    if (!isLoadMore) {
        list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
        moveFolderLastDoc = null; // Reset do cursor
        
        // Atualiza o Texto do Topo (Breadcrumbs)
        if (moveStack.length > 0) {
            pathLabel.textContent = moveStack[moveStack.length - 1].name;
            backBtn.style.display = 'block';
        } else {
            pathLabel.textContent = parentId ? "Pasta Atual" : "Raiz (N√≠vel 1)";
            backBtn.style.display = 'none';
        }
    } else {
        const oldBtn = document.getElementById('move-folder-load-more');
        if (oldBtn) oldBtn.remove();
    }

    try {
        // --- QUERY HIER√ÅRQUICA (Filtra por Pasta Pai) ---
        let constraints = [
            collection(db, 'pastas'),
            where('parentId', '==', parentId), // O SEGREDO: S√≥ carrega filhos desta pasta
            where('tipo', '==', 'pasta'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome'),
            limit(LOAD_LIMIT)
        ];

        // Pagina√ß√£o
        if (isLoadMore && moveFolderLastDoc) {
            constraints.push(startAfter(moveFolderLastDoc));
        }

        const q = query(...constraints);
        const snapshot = await getDocs(q);

        // Se for o in√≠cio, limpa e adiciona a op√ß√£o "Ficar Aqui"
        if (!isLoadMore) {
            list.innerHTML = '';

            // --- OP√á√ÉO 1: SELECIONAR A PASTA ATUAL ONDE ESTAMOS ---
            const currentLi = document.createElement('li');
            currentLi.className = 'list-item';
            currentLi.style.fontWeight = 'bold';
            currentLi.style.borderBottom = '2px solid var(--border-color)';
            currentLi.style.color = 'var(--accent-color)';
            currentLi.style.padding = '12px';
            currentLi.style.cursor = 'pointer';
            
            // Texto din√¢mico: Se estamos na raiz diz "Raiz", se n√£o diz o nome da pasta
            const currentName = moveStack.length > 0 ? moveStack[moveStack.length - 1].name : "Raiz Principal";
            currentLi.innerHTML = `üì• Guardar nesta pasta: <u>${currentName}</u>`;
            
            currentLi.onclick = () => {
                handleMoveSelection(currentLi, parentId);
            };
            list.appendChild(currentLi);

            if (snapshot.empty) {
                const emptyLi = document.createElement('li');
                emptyLi.textContent = "Sem subpastas. (Pode guardar aqui)";
                emptyLi.style.padding = "10px";
                emptyLi.style.color = "var(--text-muted-color)";
                list.appendChild(emptyLi);
                return;
            }
        }

        // Atualiza o cursor
        const lastVisible = snapshot.docs[snapshot.docs.length - 1];
        if (lastVisible) {
            moveFolderLastDoc = lastVisible;
        }

        // --- RENDERIZA√á√ÉO DA LISTA ---
     snapshot.forEach(doc => {
            if (itemToMoveRef && doc.id === itemToMoveRef.id) return;

            const folder = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            
            li.className = 'list-item move-folder-item';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.padding = '12px';
            li.style.borderBottom = '1px solid var(--border-color)';
            li.style.cursor = 'pointer';

            // DIVIDIDO EM DUAS √ÅREAS:
            li.innerHTML = `
                <div class="move-select-area" style="flex-grow:1; display:flex; align-items:center;" title="Clique para selecionar esta pasta">
                    <!-- CORRE√á√ÉO AQUI: flex: none !important impede o √≠cone de esticar -->
                    <span style="font-size:1.2em; margin-right:10px; flex: none !important;">üìÅ</span>
                    <span>${folder.nome}</span>
                </div>
                <div class="move-nav-btn" style="padding: 5px 15px; border-left:1px solid var(--border-color); color:var(--text-muted-color); font-weight:bold;" title="Entrar na pasta">
                    ‚ûî
                </div>
            `;

            // ... resto dos listeners de clique (mant√™m-se iguais) ...
            const selectArea = li.querySelector('.move-select-area');
            selectArea.onclick = (e) => {
                e.stopPropagation();
                handleMoveSelection(li, folder.id);
            };

            const navBtn = li.querySelector('.move-nav-btn');
            navBtn.onclick = (e) => {
                e.stopPropagation();
                moveStack.push({ id: folder.id, name: folder.nome });
                loadMoveFolderList(folder.id, false);
            };
            
            navBtn.onmouseover = () => { navBtn.style.color = 'var(--accent-color)'; navBtn.style.backgroundColor = 'var(--hover-color)'; };
            navBtn.onmouseout = () => { navBtn.style.color = 'var(--text-muted-color)'; navBtn.style.backgroundColor = 'transparent'; };

            list.appendChild(li);
        });

        // --- BOT√ÉO CARREGAR MAIS ---
        if (snapshot.docs.length === LOAD_LIMIT) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'move-folder-load-more';
            loadMoreBtn.textContent = "Carregar mais subpastas...";
            loadMoreBtn.style.width = "100%";
            loadMoreBtn.style.padding = "10px";
            loadMoreBtn.style.marginTop = "5px";
            loadMoreBtn.style.background = "none";
            loadMoreBtn.style.border = "1px dashed var(--text-muted-color)";
            loadMoreBtn.style.color = "var(--text-muted-color)";
            loadMoreBtn.style.cursor = "pointer";
            
            loadMoreBtn.onclick = () => {
                loadMoreBtn.textContent = "A carregar...";
                loadMoveFolderList(parentId, true); // Mant√©m o mesmo n√≠vel, carrega mais
            };

            list.appendChild(loadMoreBtn);
        }

    } catch (e) {
        console.error(e);
        if (!isLoadMore) list.innerHTML = '<li>Erro ao carregar pastas.</li>';
    }
}


// --- FUN√á√ÉO AUXILIAR DE SELE√á√ÉO VISUAL ---
function handleMoveSelection(liElement, folderId) {
    // 1. Remove sele√ß√£o de todos
    const list = document.getElementById('folder-selection-list');
    list.querySelectorAll('li').forEach(el => {
        el.style.backgroundColor = 'transparent';
        el.classList.remove('selected');
    });

    // 2. Seleciona o atual
    liElement.classList.add('selected');
    liElement.style.backgroundColor = 'var(--selected-color)'; // Usa a cor do seu tema
    
    // 3. Atualiza vari√°vel de estado
    selectedDestFolderId = folderId;
}

function renderMoveList(items, activeItemId = null) {
    const list = document.getElementById('move-list');
    list.innerHTML = '';

    items.forEach((item, index) => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        
        // Determina o √≠cone
        const icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';

        li.innerHTML = `
            <span>${icon} ${item.nome}</span>
            <div class="order-controls">
                <button data-action="up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button data-action="down" ${index === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
            </div>
        `;

        // === NOVO: Se este √© o item que clicou ===
        if (activeItemId && item.id === activeItemId) {
            // 1. Destaca visualmente (fundo azulado e borda)
            li.style.backgroundColor = "var(--selected-color)";
            li.style.border = "1px solid var(--accent-color)";
            li.classList.add('active-move-target'); // Classe para encontrar depois
        }

        list.appendChild(li);
    });

    // Delegar cliques nas setas (L√≥gica original)
    list.onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const currentLi = btn.closest('li');
        const currentIndex = Array.from(list.children).indexOf(currentLi);
        const action = btn.dataset.action;

        // Precisamos manter o ID do item que est√° a ser movido para o re-focar
        const movingItemId = items[currentIndex].id;

        if (action === 'up' && currentIndex > 0) {
            [items[currentIndex], items[currentIndex - 1]] = [items[currentIndex - 1], items[currentIndex]];
        } else if (action === 'down' && currentIndex < items.length - 1) {
            [items[currentIndex], items[currentIndex + 1]] = [items[currentIndex + 1], items[currentIndex]];
        }
        
        // Re-renderiza mantendo o foco no item que estamos a mover
        renderMoveList(items, movingItemId);
    };

    // === NOVO: SCROLL AUTOM√ÅTICO ===
    setTimeout(() => {
        const activeItem = list.querySelector('.active-move-target');
        if (activeItem) {
            // center = coloca o item no meio do modal
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100); // Pequeno delay para garantir que o modal j√° abriu visualmente

    // Configurar o bot√£o "Salvar Ordem" (Mant√©m a l√≥gica original)
    const saveBtn = document.querySelector('#move-item-modal [data-action="save-order"]');
    // Removemos ouvintes antigos para evitar duplica√ß√£o (boa pr√°tica)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A guardar...";

        const { writeBatch, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const batch = writeBatch(db);
        
        items.forEach((item, index) => {
            const docRef = doc(db, 'pastas', item.id);
            batch.update(docRef, { 
                ordem: index,
                ultimaedicao: serverTimestamp()
            });
        });

        try {
            await batch.commit();
            document.getElementById('move-item-modal').style.display = 'none';
        } catch (err) {
            console.error("Erro ao salvar ordem:", err);
            alert("Erro ao salvar nova ordem.");
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Salvar Ordem";
        }
    };
}

async function showHiddenItemsModal() {
    const modal = document.getElementById('hidden-items-modal');
    const list = document.getElementById('hidden-items-list');
    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar itens ocultos...</span></div>';
    
    // For√ßa visibilidade m√°xima
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9000000";

    try {
        // Importa√ß√£o din√¢mica para garantir acesso
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const myUid = auth.currentUser.uid;
        let allHiddenItems = [];

        // 1. BUSCAR PASTAS E NOTAS
        const qPastas = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'desativa'), 
            where('userId', '==', myUid) 
        );
        const snapPastas = await getDocs(qPastas);
        snapPastas.forEach(doc => {
            allHiddenItems.push({ id: doc.id, ...doc.data(), collectionName: 'pastas', isEntity: false });
        });

        // 2. BUSCAR ENTIDADES (Personagens, Locais, etc.)
        for (const key in ENTITY_CONFIG) {
            const config = ENTITY_CONFIG[key];
            const qEnt = query(
                collection(db, config.collection),
                where('estado', '==', 'desativa'),
                where('userId', '==', myUid)
            );
            const snapEnt = await getDocs(qEnt);
            snapEnt.forEach(doc => {
                allHiddenItems.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    collectionName: config.collection, 
                    tipo: key, 
                    isEntity: true 
                });
            });
        }

        // 3. BUSCAR √ÇNCORAS (NOVO C√ìDIGO AQUI)
        const qAncoras = query(
            collection(db, 'ancoras'),
            where('estado', '==', 'desativa'),
            where('userId', '==', myUid)
        );
        const snapAncoras = await getDocs(qAncoras);
        snapAncoras.forEach(doc => {
            allHiddenItems.push({
                id: doc.id,
                ...doc.data(),
                collectionName: 'ancoras', // Define a cole√ß√£o correta para restaurar/apagar
                tipo: 'ancora',            // Define o tipo para o √≠cone
                isEntity: true
            });
        });

        // Renderiza√ß√£o
        list.innerHTML = '';
        
        if (allHiddenItems.length === 0) {
            list.innerHTML = '<li style="padding:15px; color:#888; text-align:center;">A reciclagem est√° vazia.</li>';
            return;
        }

        allHiddenItems.forEach(item => {
            const li = document.createElement('li');
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.padding = '10px';
            li.style.borderBottom = '1px solid var(--border-color)';

            // √çcone base
            let icon = 'üìÑ';
            if (item.collectionName === 'pastas') {
                icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';
            } else {
                // √çcone para entidades
                if (item.tipo === 'personagem') icon = 'üë§';
                else if (item.tipo === 'local') icon = 'üìç';
                else if (item.tipo === 'data') icon = 'üìÖ';
                else if (item.tipo === 'ancora') icon = '‚öì'; // √çcone da √Çncora
                else icon = 'üîπ';
            }

            li.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:500;">${icon} ${item.nome}</span>
                    ${item.isEntity ? '<small style="color:#888; font-size:0.75em;">Entidade / Lista</small>' : ''}
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="modal-btn primary" 
                            data-action="restore-universal" 
                            data-id="${item.id}" 
                            data-collection="${item.collectionName}"
                            style="font-size:0.8em; padding:5px 10px;">Restaurar</button>
                    
                    <button class="modal-btn" 
                            data-action="delete-universal" 
                            data-id="${item.id}" 
                            data-collection="${item.collectionName}"
                            style="background-color:#c0392b; color:white; font-size:0.8em; padding:5px 10px; border:none; border-radius:5px; cursor:pointer;">Eliminar</button>
                </div>
            `;
            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar itens.</li>';
    }
}

function addUrlField(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'url-field-wrapper';
    const urlInput = document.createElement('input');
    urlInput.type = 'text';
    urlInput.placeholder = 'URL da hiperliga√ß√£o';
    urlInput.value = urlValue;
    urlInput.style.flexGrow = '1';
    urlInput.style.padding = '12px';
    urlInput.style.backgroundColor = 'var(--bg-color)';
    urlInput.style.border = '1px solid var(--border-color)';
    urlInput.style.borderRadius = '5px';
    urlInput.style.color = 'var(--text-color)';
    urlInput.style.fontSize = '16px';
    const removeUrlBtn = document.createElement('button');
    removeUrlBtn.textContent = '‚Äì';
    removeUrlBtn.className = 'modal-btn remove-url-btn'; 
    removeUrlBtn.onclick = () => {
        if (container.childElementCount > 1) {
            fieldWrapper.remove();
        } else {
            alert('√â necess√°rio pelo menos um campo de URL.');
        }
    };
    fieldWrapper.appendChild(urlInput);
    fieldWrapper.appendChild(removeUrlBtn);
    container.appendChild(fieldWrapper);
}


// --- FUN√á√ÉO PARA ABRIR/CRIAR VERS√çCULO AUTOMATICAMENTE ---
async function createOrOpenVerse(book, chapter, verse) {
    const fullName = `${book} ${chapter}:${verse}`;
    
    // 1. Verifica se j√° existe no cache local
    const allBibleEntities = allEntities['textobiblico'] || [];
    const existing = allBibleEntities.find(e => e.nome === fullName);

    if (existing) {
        // Se existe, abre o painel
        showReferencesPanel(existing.id, existing.nome, 'textobiblico');
    } else {
        // --- ALTERA√á√ÉO AQUI: Usa o Popup Personalizado em vez do confirm() ---
        const confirmCreate = await showConfirmation(
            "Criar Novo Registo", 
            `O texto "${fullName}" ainda n√£o existe na base de dados.\nDeseja criar agora?`
        );
        
        if (!confirmCreate) return;

        try {
            // Cria no Firebase
            const docRef = await addDoc(collection(db, 'textosbiblicos'), {
                nome: fullName,
                descricao: "",
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                referencias: {} // Come√ßa vazio
            });

            // Adiciona ao cache local para n√£o ter de recarregar a p√°gina
            if (!allEntities['textobiblico']) allEntities['textobiblico'] = [];
            allEntities['textobiblico'].push({
                id: docRef.id,
                nome: fullName,
                tipo: 'textobiblico'
            });

            // Abre o painel
            showReferencesPanel(docRef.id, fullName, 'textobiblico');
            
            // Opcional: Recarregar a lista do meio para o bot√£o ficar verde
            updateNavigationView(true);

        } catch (error) {
            console.error("Erro ao criar vers√≠culo:", error);
            alert("Erro ao criar o registo.");
        }
    }
}

// ============================================================
// L√ìGICA DO PAINEL PUZZLE (4¬™ Coluna)
// ============================================================

// 1. Alternar Abas (Puzzle vs Refer√™ncias)
document.getElementById('ref-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const target = btn.dataset.refTab;
    
    e.currentTarget.querySelectorAll('button').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.ref-tab-content').forEach(el => el.style.display = 'none');
    
    // Mostra o container correto
    const contentEl = document.getElementById(`ref-content-${target}`);
    if (contentEl) {
        contentEl.style.display = (target === 'links' || target === 'puzzle' || target === 'dossie') ? 'flex' : 'block';
    }

    if (target === 'links') renderPanelLinks();
    if (target === 'dossie') {
        activeMicaId = null; // Sempre volta para a lista ao trocar de aba
        isDossieEditMode = false;
        renderDossie();
    }
});

// 2. Bot√£o Editar do Painel
document.getElementById('toggle-links-edit-btn').addEventListener('click', (e) => {
    isPanelEditMode = !isPanelEditMode;
    const btn = e.target;
    const actions = document.getElementById('links-edit-actions');

    if (isPanelEditMode) {
        btn.textContent = "Salvar";
        btn.classList.add('is-active');
        actions.style.display = 'flex';
    } else {
        btn.textContent = "Editar";
        btn.classList.remove('is-active');
        actions.style.display = 'none';
    }
    renderPanelLinks();
});

// 3. Abrir Criadores (Reaproveita os modais existentes com contextos diferentes)
window.openPanelLinkCreator = function(type) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // 1. Configura√ß√£o Visual para ENTIDADE
    urlsContainer.innerHTML = '';
    document.getElementById('codex-rows-container').innerHTML = '';
    document.getElementById('link-remove-btn').style.display = 'none';

    if (type === 'link') {
        modalTitle.textContent = "Documenta√ß√£o: " + activeReferenceEntity.name;
        document.querySelector('[data-box-tab="refs"]').click();
        document.querySelector('[data-box-tab="codex"]').style.display = 'none'; // Esconde Codex
        addUrlField();
    } else {
        modalTitle.textContent = "Codex: " + activeReferenceEntity.name;
        document.querySelector('[data-box-tab="codex"]').click();
        document.querySelector('[data-box-tab="refs"]').style.display = 'none'; // Esconde Links
        window.createCodexRow();
    }

    // 2. LIMPAR MEM√ìRIA DO BOT√ÉO (O SEGREDO)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    // 3. L√≥gica de Gravar da ENTIDADE
    newSaveBtn.onclick = async () => {
        let dataToSave = null;

        if (type === 'link') {
            const urlsMap = {};
            urlsContainer.querySelectorAll('input').forEach((inp, i) => {
                if(inp.value.trim()) urlsMap[`url_${i}`] = inp.value.trim();
            });
            dataToSave = { type: 'link', title: titleInput.value.trim() || "Link", urls: urlsMap };
        } else {
            const row = document.querySelector('.codex-row');
            const rowData = getCodexDataFromRow(row);
            dataToSave = { type: 'codex', ...rowData, total: rowData.serie + (rowData.paginas.length ? `, p√°g. ${rowData.paginas.join(',')}` : '') };
        }

        await saveLinkToEntity(dataToSave); // Usa a tua fun√ß√£o do print!
        modal.style.display = 'none';
        renderPanelLinks(); // Atualiza a lista na 4¬™ coluna
    };

    modal.style.display = 'flex';
};

// 4. Renderizar Lista de Links/Codex da Entidade
async function renderPanelLinks() {
    const container = document.getElementById('panel-links-list');
    if (!container) return;

    // --- 1. EFEITO VISUAL DE LOADING (Igual ao Dossi√©) ---
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A carregar documenta√ß√£o...</span>
        </div>`;

    if (!activeReferenceEntity.id) {
        container.innerHTML = ''; 
        return;
    }

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));

        // --- 2. LIMPEZA DO LOADING AP√ìS RECEBER DADOS ---
        container.innerHTML = ''; 

        if (!docSnap.exists() || !docSnap.data().panelLinks || docSnap.data().panelLinks.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; font-size:0.9em; margin-top:20px; font-style: italic;">Nenhuma documenta√ß√£o associada.</p>';
            return;
        }

        const links = docSnap.data().panelLinks || [];

        links.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'board-card'; 
            div.style.borderLeft = item.type === 'codex' ? '3px solid #d35400' : '3px solid #795548';
            
            let contentHTML = "";
            if (item.type === 'codex') {
                contentHTML = `<strong>${item.serie}</strong><br><small>${item.codiceshow || item.total}</small>`;
            } else {
                const urls = item.urls ? Object.values(item.urls) : [item.url];
                const linksList = urls.map(u => 
                    `<div style="color:var(--accent-color); cursor:pointer; font-size:0.85em; margin-top:4px; word-break:break-all;" 
                          onclick="window.open('${u}', '_blank')">üîó ${u}</div>`
                ).join('');
                contentHTML = `<strong>${item.title}</strong>${linksList}`;
            }

            div.innerHTML = `
                <div style="font-size:0.9em;">${contentHTML}</div>
                ${isPanelEditMode ? `
                    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px; border-top:1px solid var(--border-color); padding-top:5px;">
                        <button onclick="movePanelLink(${index}, -1)" ${index === 0 ? 'style="display:none"' : ''} style="background:none; border:none; cursor:pointer; font-size:14px;">üî∫</button>
                        <button onclick="movePanelLink(${index}, 1)" ${index === links.length - 1 ? 'style="display:none"' : ''} style="background:none; border:none; cursor:pointer; font-size:14px;">üîª</button>
                        <div style="flex-grow:1"></div>
                        <button onclick="window.openPanelLinkCreator('${item.type}', ${index})" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:12px; font-weight:bold;">Editar</button>
                        <button onclick="deletePanelLink(${index})" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:12px; font-weight:bold;">Remover</button>
                    </div>
                ` : ''}
            `;
            container.appendChild(div);
        });
    } catch (e) {
        console.error("Erro ao carregar links:", e);
        container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar documenta√ß√£o.</p>';
    }
}

// 5. Grava√ß√£o de Link do Painel
async function openLinkModalForPanel() {
    // Aqui podes usar um simple prompt ou o teu modal de link
    const title = prompt("T√≠tulo do Link:");
    if (!title) return;
    let url = prompt("URL:");
    if (!url) return;
    if (!url.startsWith('http')) url = 'https://' + url;

    const newLink = { type: 'link', title, url, createdAt: Date.now() };
    await saveLinkToEntity(newLink);
}

// 6. Grava√ß√£o de Codex do Painel (Sincronizado com firebase->codex)
async function openCodexModalForPanel() {
    // Vamos usar a mesma estrutura do createCodexRow para manter consist√™ncia
    // Para simplificar esta resposta, vamos simular a abertura de um modal
    // que recolhe os dados e chama:
    
    const serie = prompt("S√©rie (ex: w24 05):");
    if (!serie) return;
    const pags = prompt("P√°ginas:");
    
    const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // 1. Grava na cole√ß√£o global CODEX
    const codexDoc = await addDoc(collection(db, 'codex'), {
        serie,
        paginas: [pags],
        userId: auth.currentUser.uid,
        entityId: activeReferenceEntity.id,
        entityName: activeReferenceEntity.name,
        timestamp: serverTimestamp()
    });

    // 2. Grava a refer√™ncia no documento da Entidade
    const newCodex = { 
        type: 'codex', 
        id: codexDoc.id, 
        serie, 
        total: `${serie}, p√°g. ${pags}`,
        createdAt: Date.now() 
    };
    
    await saveLinkToEntity(newCodex);
}

async function saveLinkToEntity(linkObj) {
    const { id, type } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    const docRef = doc(db, collectionName, id);
    
    const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    await updateDoc(docRef, {
        panelLinks: arrayUnion(linkObj)
    });
    
    renderPanelLinks();
}

window.deletePanelLink = async function(index) {
    if (!confirm("Remover este item?")) return;
    
    const { id, type } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    const docRef = doc(db, collectionName, id);
    
    const docSnap = await getDoc(docRef);
    const links = docSnap.data().panelLinks || [];
    
    const itemToRemove = links[index];
    
    // Se for codex, opcionalmente podes apagar tamb√©m da cole√ß√£o 'codex'
    if (itemToRemove.type === 'codex' && itemToRemove.id) {
        await deleteDoc(doc(db, 'codex', itemToRemove.id));
    }

    links.splice(index, 1);
    await updateDoc(docRef, { panelLinks: links });
    renderPanelLinks();
    await checkAndCleanVerseState(activeReferenceEntity.id);
};


// 3. Fun√ß√£o para Adicionar Item da Lista "Refer√™ncias" para "Escolhidas"
window.addItemToPuzzle = function(noteId, noteName, snippetHTML) {

    // 1. Verificar se a fun√ß√£o createBoardItem existe
    if (typeof createBoardItem === 'function') {
        
        // 2. Mudar automaticamente para a aba "Puzzle" para o utilizador ver o item a chegar
        const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
        if (puzzleTabBtn) puzzleTabBtn.click();

        // 3. Chamar a fun√ß√£o do Quadro para criar o cart√£o
        createBoardItem('ref', {
            noteId: noteId,
            noteName: noteName,
            snippet: snippetHTML,
            isClone: false // √â uma refer√™ncia de texto, n√£o uma caixa completa
        }, true); // O 'true' faz scroll autom√°tico at√© ao novo cart√£o

        // 4. Se o modo de edi√ß√£o estiver ativo, grava logo na BD
        if (document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active')) {
            savePuzzleData();
        }
        
    } else {
        console.error("‚ùå Erro: Fun√ß√£o createBoardItem n√£o encontrada.");
    }
};

// ====================================================================
// L√ìGICA DE TELEPORTE (CONVERTER QUADRO EM NOTA) üì°
// ====================================================================

// 1. Vari√°veis de Estado para o Teleporte
let teleportContentHTML = ""; // Guarda o conte√∫do compilado
let teleportNoteTitle = "";   // Guarda o t√≠tulo limpo

// 2. Listener do Bot√£o üì°
document.getElementById('teleport-puzzle-btn').addEventListener('click', async (e) => {
    e.preventDefault(); e.stopPropagation();

    // --- A. CONFIRMA√á√ÉO COM POPUP PERSONALIZADO ---
    // Usamos a fun√ß√£o 'showConfirmation' que j√° existe no seu c√≥digo
    const confirmed = await showConfirmation(
        "Converter em Nota", 
        "Deseja mesmo gerar uma nota atrav√©s desta refer√™ncia?"
    );

    if (!confirmed) return; // Se clicar em Cancelar, p√°ra aqui.

    // --- B. Preparar T√≠tulo ---
    const panelTitle = document.getElementById('references-panel-title').textContent.trim();
    // Regex para limpar o lixo √† volta
    teleportNoteTitle = panelTitle.replace(/^Refer√™ncias para [üîñ]*["‚Äú](.+)["‚Äù]$/i, '$1');

    // --- C. Compilar Conte√∫do do Quadro ---
    teleportContentHTML = "";
    const cards = document.querySelectorAll('#puzzle-board-container .board-card');

    if (cards.length === 0) {
        alert("O quadro est√° vazio. Adicione algo antes de converter.");
        return;
    }

    cards.forEach(card => {
        // TIPO 1: Texto Edit√°vel
        if (card.classList.contains('type-text')) {
            const textDiv = card.querySelector('.board-text-content');
            if (textDiv) {
                teleportContentHTML += `<p>${textDiv.innerHTML}</p>`; 
            }
        } 
        // TIPO 2: Refer√™ncia
        else if (card.classList.contains('type-ref')) {
            let snippet = decodeURIComponent(card.dataset.snippet || "");
            snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

            if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
                teleportContentHTML += snippet;
            } else {
                teleportContentHTML += `
                    <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                        ${snippet}
                        <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
                    </blockquote>
                `;
            }
        }
        teleportContentHTML += "<p><br></p>";
    });

    // --- D. Abrir o Seletor de Pastas ---
    openTeleportFolderSelector();
});

// 3. Abrir Modal de Sele√ß√£o de Pasta (Reutiliza o estilo do Append/Move)
function openTeleportFolderSelector() {
    const modal = document.getElementById('move-to-folder-modal'); 
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const titleEl = modal.querySelector('h3');
    const descEl = modal.querySelector('p');

    // 1. RESET DE VARI√ÅVEIS CR√çTICO
    selectedDestFolderId = null; // Garante que n√£o usa uma sele√ß√£o antiga
    moveStack = []; 

    // Configurar UI
    titleEl.textContent = "Guardar Nota em...";
    descEl.innerHTML = `A criar nota: <strong>${teleportNoteTitle}</strong>`;
    
    // Configura√ß√£o da Barra de Navega√ß√£o (Breadcrumbs)
    let navContainer = document.getElementById('move-folder-nav-container');
    if (!navContainer) {
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz Global</span>
        `;
        list.parentNode.insertBefore(navContainer, list);
        
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const globalRootId = null; 
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : globalRootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(globalRootId);
            }
        });
    }

    modal.style.display = 'flex';
    
    // Inicia na Raiz Global (null)
    loadMoveFolderList(null);

    // --- SUBSTITUIR A√á√ÉO DO BOT√ÉO CONFIRMAR ---
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = "Gerar Nota";
    
    newConfirmBtn.onclick = async () => {
        // L√≥gica de Destino: Se n√£o selecionou (azul), assume a pasta onde est√° a navegar
        let targetFolderId = selectedDestFolderId;
        if (targetFolderId === null && moveStack.length > 0) {
            targetFolderId = moveStack[moveStack.length - 1].id;
        }
        
        // Se targetFolderId continuar null, √© a Raiz Global.

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A processar...";

        try {
            // =================================================================
            // PASSO C: GERAR CONTE√öDO E ANEXOS
            // =================================================================
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = teleportContentHTML;
            const anexosMap = {}; 
            
            // 1. Processar Links de Texto (Criados via bot√£o Globo üåê)
            const textLinks = tempDiv.querySelectorAll('a.board-link');
            textLinks.forEach((link, index) => {
                const anexoId = `anexo_txt_${Date.now()}_${index}`;
                let urls = {};
                try {
                    const rawUrls = JSON.parse(decodeURIComponent(link.dataset.json));
                    rawUrls.forEach((u, i) => urls[`url_${i}`] = u);
                } catch(e) { if (link.href) urls['url_0'] = link.href; }

                if (Object.keys(urls).length > 0) {
                    anexosMap[anexoId] = { titulo: link.textContent, urls: urls, timestamp: Date.now() };
                    // Transformar em link de nota
                    link.classList.remove('board-link');
                    link.removeAttribute('data-json');
                    link.setAttribute('data-anexo-id', anexoId);
                    link.style.borderBottom = '1px dotted var(--accent-color)';
                    link.style.color = 'inherit';
                    link.style.textDecoration = 'none';
                }
            });

            // 2. Processar Refer√™ncias do Quadro (Cart√µes Verdes) - PARA CRIAR ANEXO
            // Se o cart√£o for uma refer√™ncia a outra nota, criamos um "Anexo" para ela tamb√©m
          const refCards = document.querySelectorAll('#puzzle-board-container .board-card.type-ref');
refCards.forEach((card, index) => {
    let snippet = decodeURIComponent(card.dataset.snippet || "");
    
    // Limpeza b√°sica
    snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

    // VERIFICA√á√ÉO DE CAIXAS ESPECIAIS (CLONAGEM PERFEITA)
    if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
        
        // Se for uma caixa, injetamos o HTML direto (Clone Perfeito)
        // Dica: Podemos gerar um novo ID para evitar duplicados no sistema
        snippet = snippet.replace(/id="[^"]*"/, `id="clone_${Date.now()}_${index}"`);
        
        teleportContentHTML += snippet;
    } 
    // TRATAMENTO ESPECIAL PARA POST-ITS (Para n√£o ficarem sobrepostos)
    else if (snippet.includes('post-it-note')) {
        // 1. For√ßa posi√ß√£o relativa (para entrar no fluxo do texto)
        // 2. Remove coordenadas top/left antigas
        // 3. Mant√©m a cor e o visual
        let safePostIt = snippet.replace(/position:\s*absolute/g, 'position: relative; margin: 15px 0');
        safePostIt = safePostIt.replace(/top:\s*[^;]+;/g, '').replace(/left:\s*[^;]+;/g, '');
        
        // Remove o puxador de arrasto (j√° que na nova nota ser√° texto fixo)
        // (Opcional, mas fica mais limpo)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = safePostIt;
        const dragHandle = tempDiv.querySelector('.post-it-drag-handle');
        if(dragHandle) dragHandle.remove();
        
        teleportContentHTML += tempDiv.innerHTML;
    }
    // TEXTO SIMPLES (Cita√ß√£o padr√£o)
    else {
        teleportContentHTML += `
            <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                ${snippet}
                <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
            </blockquote>
        `;
    }
    
    // Adiciona o anexo l√≥gico (para o clip)
    const noteId = card.dataset.noteId;
    const noteName = card.dataset.noteName;
    if (noteId) {
        const anexoId = `anexo_ref_${Date.now()}_${index}`;
        anexosMap[anexoId] = {
            titulo: `Ref: ${noteName}`,
            urls: { 'url_0': `internal://note/${noteId}` }, 
            timestamp: Date.now()
        };
    }
});

            const finalContentHTML = tempDiv.innerHTML;

            // =================================================================
            // PASSO D: CRIAR NOTA NO FIREBASE
            // =================================================================
            
            // Calcular Ordem Segura (Para evitar NaN)
            let newOrder = 0;
            try {
                const qOrder = query(
                    collection(db, 'pastas'), 
                    where('parentId', '==', targetFolderId), 
                    where('userId', '==', auth.currentUser.uid)
                );
                const snapOrder = await getDocs(qOrder);
                newOrder = snapOrder.size || 0;
            } catch(e) { console.log("Erro ordem, usando 0"); }

            // Criar Documento
            const docRef = await addDoc(collection(db, 'pastas'), {
                nome: teleportNoteTitle,
                parentId: targetFolderId, 
                tipo: 'nota',
                conteudo: finalContentHTML,
                anexos: anexosMap, // Agora inclui links de texto E refer√™ncias
                userId: auth.currentUser.uid,
                estado: 'ativa',
                ordem: Number(newOrder), // For√ßa n√∫mero
                tags: [], 
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            
            // =================================================================
            // PASSO E: FOR√áAR ATUALIZA√á√ÉO VISUAL (CORRE√á√ÉO DA LISTA)
            // =================================================================
            
            // Se a pasta onde guard√°mos √© a mesma que est√° aberta no painel do meio...
            const currentMiddleFolderId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
            
            if (targetFolderId === currentMiddleFolderId) {
                // ...Recarregamos a lista explicitamente para garantir que aparece
                fetchAndDisplayItems(targetFolderId, middlePanelList, null);
            }

            // Popup de Sucesso
            const shouldOpen = await showConfirmation(
                "Sucesso!", 
                "Nota criada com sucesso.\nDeseja abrir a nota agora?"
            );
            
            if(shouldOpen) {
                displayNote(docRef.id, null);
            }

        } catch (error) {
            console.error("Erro ao criar nota:", error);
            alert("Erro ao gravar. Verifique a consola para detalhes de √≠ndices.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gerar Nota";
        }
    };
}

// ============================================================
// FUN√á√ÉO PARA EXIBIR DETALHES DO T√ìPICO (4¬™ COLUNA)
// ============================================================
async function showTopicReferencesPanel(id, name, description, type) {

    
    // 1. Gravar o puzzle/quadro anterior antes de mudar o contexto
    // Isto evita que percas altera√ß√µes se estivesses a editar outro t√≥pico
    await forceSaveAndClosePuzzleMode();
  resetReferencesPanelUI();
    // 2. DEFINIR ENTIDADE ATIVA (CR√çTICO para o +Ref funcionar)
    // Se o 'type' vier vazio, assume 'topico' por padr√£o
    activeReferenceEntity = { 
        id: id, 
        type: type || 'topico', 
        name: name 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'block';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel lateral
    notebookContainer.classList.add('references-panel-visible');
    
    // Define o T√≠tulo do painel (ex: T√≥pico: Santifica√ß√£o)
referencesPanelTitle.textContent = `Cita√ß√µes: ${name}`;
    document.getElementById('references-panel-description').textContent = description || 'Sem descri√ß√£o definida.';

    // 4. Sincronizar Abas: Abre sempre na aba "Puzzle" (Quadro)
    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTabBtn) puzzleTabBtn.classList.add('active');

    document.getElementById('ref-content-puzzle').style.display = 'flex';
    document.getElementById('ref-content-references').style.display = 'none';

    // 5. Carregar os dados do Quadro (Puzzle) salvos para este t√≥pico
    loadPuzzleData(id, type || 'topico');
    
    // 6. Pesquisar e listar as notas que usam este t√≥pico (para a aba Refer√™ncias)
    // Esta fun√ß√£o analisa o campo 'topicosSelecionados' de todas as notas
    renderTopicResultsList(id, type || 'topico'); 
}

// Fun√ß√£o Auxiliar para preencher a lista de refer√™ncias (Aba 2)
async function renderTopicResultsList(id, type) {
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar contextos...</span></div>';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        
        // Reset da lista global de resultados
        allCitationsResults = []; 

        snapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            if (!data.topicosSelecionados) return;

            let match = false;
            // Se for T√≥pico Pai
            if (type === 'topico') {
                if (data.topicosSelecionados.hasOwnProperty(id)) match = true;
            } 
            // Se for Subt√≥pico
            else {
                const allSubtopics = Object.values(data.topicosSelecionados).flat();
                if (allSubtopics.map(String).includes(String(id))) match = true;
            }

            if (match) {
                // Filtro de privacidade
                let isProtected = (data.passe && data.passe.trim() !== "");
                if (isProtected && !appSettings.searchTopicsInProtected) return;

                allCitationsResults.push({ 
                    id: docSnapshot.id, 
                    name: data.nome,
                    isProtected: isProtected,
                    snippet: "T√≥pico atribu√≠do a esta nota.",
                    ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
                });
            }
        });

        // ORDENAR: Mais recente primeiro
        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);

        // Renderiza a lista paginada
        window.renderCitationsPage(false);

    } catch (e) {
        console.error("Erro ao listar refer√™ncias do t√≥pico:", e);
        listElement.innerHTML = '<li>Erro ao carregar lista.</li>';
    }
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function openLinkModal(isEditing, data) {
    // 1. CAPTURA ROBUSTA DA SELE√á√ÉO (CR√çTICO)
    // Tentamos garantir que temos o texto selecionado guardado antes de qualquer outra coisa.
    // Isto resolve o problema de perder a sele√ß√£o quando se clica nos inputs do modal.
    let savedRange = null;

    if (!isEditing) {
        if (currentSelectionRange) {
            // Tenta usar a vari√°vel global gerida pelo handleTextSelection
            savedRange = currentSelectionRange.cloneRange();
        } else {
            // Fallback: Tenta obter diretamente do navegador
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && !sel.isCollapsed) {
                savedRange = sel.getRangeAt(0).cloneRange();
            }
        }
    }

    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const addUrlBtn = document.getElementById('add-url-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // Reset UI
    urlsContainer.innerHTML = '';
    
    // Clonar bot√µes para limpar listeners antigos (Evita cliques duplicados)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);

    newAddUrlBtn.onclick = () => addUrlField();

    // --- MODO EDI√á√ÉO ---
    if (isEditing) {
        modalTitle.textContent = "Editar/Remover Anexo";
        newRemoveBtn.style.display = 'block';

        // Preenche os dados atuais
        (async () => {
            try {
                const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
                if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                    const anexoFromDb = noteSnap.data().anexos[data.id];
                    titleInput.value = anexoFromDb.titulo;
                    
                    if (anexoFromDb.urls && Object.keys(anexoFromDb.urls).length > 0) {
                        Object.values(anexoFromDb.urls).forEach(url => addUrlField(url));
                    } else if (anexoFromDb.hiperligacao) {
                         // Suporte legado
                         addUrlField(anexoFromDb.hiperligacao);
                    } else { 
                        addUrlField(); 
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar dados do anexo:", e);
            }
        })();

        // Gravar Edi√ß√£o
        newSaveBtn.onclick = async () => {
            const newTitle = titleInput.value.trim();
            if (!newTitle) return alert("O t√≠tulo √© obrigat√≥rio.");

            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;

            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });

            if (Object.keys(urlsToSave).length === 0) return alert('Preencha pelo menos uma URL.');

            try {
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, {
                    [`anexos.${data.id}.titulo`]: newTitle,
                    [`anexos.${data.id}.urls`]: urlsToSave,
                    [`anexos.${data.id}.hiperligacao`]: deleteField(), // Limpa campo antigo se existir
                    [`anexos.${data.id}.timestamp`]: serverTimestamp()
                });

                // Atualiza o href no editor visualmente
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) linkInEditor.href = firstUrl;

                modal.style.display = 'none';
                saveNote();
            } catch (e) {
                console.error("Erro ao editar anexo:", e);
                alert("Erro ao gravar altera√ß√µes.");
            }
        };

        // Remover Anexo
    newRemoveBtn.onclick = async () => {
        
        // 1. Truque de UI: For√ßar o modal de confirma√ß√£o a ficar acima do modal de links
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.style.zIndex = '3200'; // Valor alto para garantir topo absoluto

        // 2. Chama o seu popup personalizado
        const confirmed = await showConfirmation(
            "Limpar Links", 
            "Tem a certeza que deseja remover todos os links desta caixa?"
        );

        // 3. Restaura o z-index para n√£o afetar outros usos futuros
        confirmModal.style.zIndex = ''; 

        // 4. Se confirmou, executa a limpeza
        if (confirmed) {
            wrapper.setAttribute('data-box-links', '{}');
            updateBoxLinkButtonState(wrapper);
            modal.style.display = 'none';
            saveNote(true);
        }
    };
    } 


    // --- MODO CRIA√á√ÉO (COM A CORRE√á√ÉO DO "GRAVAR") ---
    else {
        modalTitle.textContent = "Criar Anexo";
        titleInput.value = (typeof data === 'string') ? data : ''; 
        newRemoveBtn.style.display = 'none';
        addUrlField();

        // L√≥gica do Bot√£o Gravar (Nova Vers√£o Robusta)
        newSaveBtn.onclick = async () => {
            try {
                // 1. Valida√ß√£o de Dados
                const titleForDb = titleInput.value.trim();
                if (!titleForDb) { alert('T√≠tulo obrigat√≥rio.'); return; }
                
                const urlInputs = urlsContainer.querySelectorAll('input');
                const urlsToSave = {};
                let firstUrl = null;
                
                urlInputs.forEach((input, index) => {
                    let url = input.value.trim();
                    if (url) {
                        if (!url.startsWith('http')) url = 'https://' + url;
                        if (!firstUrl) firstUrl = url;
                        urlsToSave[`url_${Date.now() + index}`] = url;
                    }
                });
                
                if (Object.keys(urlsToSave).length === 0) { alert('Preencha pelo menos uma URL.'); return; }

                // 2. Verifica√ß√µes de Seguran√ßa Cr√≠ticas
                if (!selectedNoteId) throw new Error("ID da nota n√£o encontrado.");
                if (!savedRange) throw new Error("A sele√ß√£o de texto foi perdida. Cancele e tente novamente.");

                // 3. Gravar na Base de Dados (Firebase)
                const anexoId = `anexo_${Date.now()}`;
                const noteRef = doc(db, 'pastas', selectedNoteId);
                
                await updateDoc(noteRef, { 
                    [`anexos.${anexoId}`]: { 
                        titulo: titleForDb, 
                        urls: urlsToSave, 
                        timestamp: serverTimestamp() 
                    } 
                }, { merge: true });

                // 4. Prepara√ß√£o Visual (Preservar Entidades)
                const tempDiv = document.createElement('div');
                tempDiv.appendChild(savedRange.cloneContents()); 

                const anchorsInSelection = Array.from(tempDiv.querySelectorAll('.entity-link'));
                const preservedAnchors = anchorsInSelection.map(span => ({
                    name: span.dataset.entityName,
                    type: span.dataset.entityType
                }));
                
                // 5. Aplicar o Link no Editor
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange); // Restaura a sele√ß√£o guardada
                
                document.execCommand('createLink', false, firstUrl || '#');
                
                // Encontrar o link rec√©m-criado (onde est√° o cursor)
                const createdLink = selection.anchorNode.parentElement.closest('a');

                if (createdLink) {
                    createdLink.dataset.anexoId = anexoId;
                    
                    // Se havia entidades coloridas, restaura-as dentro do link
                    if (preservedAnchors.length > 0) {
                        let reconstructedHTML = createdLink.textContent;
                        
                        preservedAnchors.forEach(anchor => {
                            const anchorHTML = `<span class="entity-link" data-entity-type="${anchor.type}" data-entity-name="${anchor.name}">${anchor.name}</span>`;
                            const replaceRegex = new RegExp(escapeRegExp(anchor.name), 'g');
                            reconstructedHTML = reconstructedHTML.replace(replaceRegex, anchorHTML);
                        });

                        createdLink.innerHTML = reconstructedHTML;
                    }
                }
                
                // 6. Fechar e Gravar Nota
                modal.style.display = 'none';
                saveNote();

            } catch (error) {
                console.error("Erro ao criar link:", error);
                alert("Ocorreu um erro: " + error.message);
            }
        };
    }
    
    modal.style.display = 'flex';
}
// ====================================================================


async function openEntityModal(type, name) {
    // 1. Tenta guardar a sele√ß√£o se ela existir (para quando est√°s dentro de uma nota)
    const savedRange = (currentSelectionRange) ? currentSelectionRange.cloneRange() : null;

    const modal = document.getElementById('entity-modal');
    const title = document.getElementById('entity-modal-title');
    const nameInput = document.getElementById('entity-name-input');
    const descriptionInput = document.getElementById('entity-description-input');
    const errorMsg = document.getElementById('entity-error-message');
    
    // Configura o t√≠tulo do popup
    const singularNames = {
        personagem: "Personagem",
        local: "Local",
        data: "Data"
    };
    title.textContent = `Criar ${singularNames[type] || type}`;
    
    nameInput.value = name;
    descriptionInput.value = '';
    errorMsg.style.display = 'none';
    modal.style.display = 'flex';
    
    setTimeout(() => nameInput.focus(), 50);

    const saveBtn = document.getElementById('entity-save-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const entityName = nameInput.value.trim();
        const entityDescription = descriptionInput.value.trim();
        if (!entityName) return;

        const collectionName = ENTITY_CONFIG[type]?.collection;
        if (!collectionName) return;

        try {
            const collectionRef = collection(db, collectionName);
            const q = query(collectionRef, where("nome", "==", entityName), where("userId", "==", auth.currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            let entityId = "";

            if (querySnapshot.empty) {
                // CRIAR NOVO REGISTO
                const docRef = await addDoc(collectionRef, {
                    nome: entityName,
                    descricao: entityDescription,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp(),
                    referencias: (selectedNoteId && savedRange) ? { [selectedNoteId]: true } : {}
                });
                entityId = docRef.id;
            } else {
                // SE J√Å EXISTE, APENAS ATUALIZA A REFER√äNCIA SE ESTIVERMOS NUMA NOTA
                entityId = querySnapshot.docs[0].id;
                if (selectedNoteId && savedRange) {
                    const entityRef = doc(db, collectionName, entityId);
                    await updateDoc(entityRef, { [`referencias.${selectedNoteId}`]: true });
                }
            }

            // 2. L√ìGICA VISUAL (S√≥ executa se houver texto selecionado no editor)
            if (savedRange && selectedNoteId) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);

                const span = document.createElement('span');
                span.className = 'entity-link';
                span.dataset.entityType = type;
                span.dataset.entityName = entityName;
                span.textContent = entityName;
                
                savedRange.deleteContents();
                savedRange.insertNode(span);
                saveNote();
            }

            modal.style.display = 'none';
            
            // 3. ATUALIZA√á√ÉO DA LISTA (Se estiveres na aba Lists, recarrega os itens para o novo aparecer)
            if (currentTab === 'lists') {
                renderListCategoryItems(type);
            }
            
            fetchAllEntities(); 

        } catch (e) {
            console.error("Erro ao guardar entidade:", e);
            alert("Erro ao guardar.");
        }
    };
}

  async function openGenericListModal(title, dataPromise) {
    const modal = document.getElementById('generic-list-modal');
    const titleEl = document.getElementById('generic-list-title');
    const contentEl = document.getElementById('generic-list-content');
    
    titleEl.textContent = title;
    contentEl.innerHTML = '<li>Carregando...</li>';
    modal.style.display = 'flex';

    try {
        const items = await dataPromise;
        contentEl.innerHTML = ''; 
        if (!items || items.length === 0) {
            contentEl.innerHTML = '<li>Nenhum item encontrado.</li>';
            return;
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.style.alignItems = 'flex-start';
            
            // <<<<<<< ALTERA√á√ÉO IMPORTANTE >>>>>>>>>
            // Adiciona um data-attribute se o t√≠tulo for uma tag
            if (item.title.startsWith('#')) {
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = item.title.replace('#', '');
                li.style.cursor = 'pointer'; // Muda o cursor para indicar que √© clic√°vel
            }
            
            let contentHTML = '';

            if (Array.isArray(item.content) && item.content.length > 0) {
                const linksHTML = item.content.map((url, index) => {
                    if (!url) return '';
                    return `<div style="display: flex; align-items: baseline; margin-top: 5px; gap: 8px;"><span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span><a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; word-break: break-all;">${url}</a></div>`;
                }).join('');
                contentHTML = `<div style="margin-top: 4px;">${linksHTML}</div>`;
            } 
            else if (typeof item.content === 'string' && item.content) {
                contentHTML = `<small style="color: var(--text-muted-color); margin-top: 4px;">${item.content}</small>`;
            }

            let editButtonHTML = '';
            if (item.type === 'anexo' && item.id) {
                editButtonHTML = `<button data-action="edit-anexo" data-id="${item.id}" title="Editar Anexo" style="background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; margin-left: auto; padding: 5px;">‚úèÔ∏è</button>`;
            }

            li.innerHTML = `<div style="display: flex; flex-direction: column; flex-grow: 1;"><strong style="font-size: 1.1em;">${item.title}</strong>${contentHTML}</div>${editButtonHTML}`;
            contentEl.appendChild(li);
        });

    } catch (error) {
        console.error("Erro ao carregar dados para o modal:", error);
        contentEl.innerHTML = '<li>Ocorreu um erro ao carregar os itens.</li>';
    }
}

 function openAttachmentsModal() {
    if (!selectedNoteId) return;
    
    const fetchData = async () => {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (noteSnap.exists() && noteSnap.data().anexos) {
            const anexosMap = noteSnap.data().anexos;
            // A MUDAN√áA PRINCIPAL: Agora usamos Object.entries para ter acesso √† CHAVE (ID do anexo)
            return Object.entries(anexosMap).map(([anexoId, anexoData]) => {
                const urlsArray = anexoData.urls ? Object.values(anexoData.urls) : (anexoData.hiperligacao ? [anexoData.hiperligacao] : []);
                return { 
                    id: anexoId, // <<<<<<< IMPORTANTE: Passamos o ID do anexo
                    title: anexoData.titulo, 
                    content: urlsArray,
                    type: 'anexo' // <<<<<<< Adicionamos um tipo para identifica√ß√£o
                };
            });
        }
        return [];
    };

    openGenericListModal("Anexos na Nota", fetchData());
}

 




// --- FUN√á√ÉO UNIFICADA: EXPLORADOR (TAGS + ENTIDADES) ---
async function openExplorerModal() {
    const modal = document.getElementById('anchors-modal');
    const filterBtn = document.getElementById('toggle-search-filters-btn');
    const container = document.getElementById('anchors-content-container');
    
    if (!modal || !container) return;

    modal.style.display = 'flex';
    
    // Reset do visual do bot√£o e abertura da aba padr√£o (Pesquisa)
    filterBtn.textContent = "‚öôÔ∏è Filtros";
    renderSearchTab(); 

    // Alternar entre Pesquisa e Filtros
    filterBtn.onclick = (e) => {
        e.preventDefault();
        // Verificamos se o que est√° l√° dentro √© a pesquisa ou filtros
        const isShowingSearch = !!document.getElementById('global-search-input');
        
        if (isShowingSearch) {
            renderFiltersTab();
            filterBtn.textContent = "üîç Pesquisa";
        } else {
            renderSearchTab();
            filterBtn.textContent = "‚öôÔ∏è Filtros";
        }
    };
}

// Renderiza a aba de Pesquisa
function renderSearchTab() {
    const container = document.getElementById('anchors-content-container');
    const scopeContainer = document.getElementById('search-scope-container');
    const scopeToggle = document.getElementById('search-scope-toggle');
    const scopeText = document.getElementById('scope-text');

    container.innerHTML = `
        <div class="search-container">
            <input type="text" id="global-search-input" class="global-search-input" 
                   placeholder='Ex: eva "ad√£o"'>
            <div id="global-search-results">
                <p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">
                    Pesquise por termos soltos ou use "aspas" para palavras exatas.
                </p>
            </div>
        </div>
    `;

    const searchInput = document.getElementById('global-search-input');
    const resultsContainer = document.getElementById('global-search-results');
 const scopeBtn = document.getElementById('search-scope-btn');

   scopeBtn.onclick = (e) => {
        e.preventDefault();
        if (globalSearchScope === 'paragraph') {
            globalSearchScope = 'page';
            scopeBtn.classList.add('active');
            scopeBtn.querySelector('span').textContent = 'Na P√°gina';
        } else {
            globalSearchScope = 'paragraph';
            scopeBtn.classList.remove('active');
            scopeBtn.querySelector('span').textContent = 'No Par√°grafo';
        }
        // Refaz a pesquisa com o novo escopo
        if (searchInput.value.trim().length >= 2) executeGlobalSearch(searchInput.value.trim(), resultsContainer);
    };

      let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const terms = parseSearchQuery(val);
        
        // MOSTRAR/ESCONDER: S√≥ aparece se houver 2 ou mais termos
        scopeBtn.style.display = (terms.length >= 2) ? 'flex' : 'none';

        clearTimeout(searchTimeout);
        if (val.length < 2) {
            resultsContainer.innerHTML = '<p style="text-align:center; color:var(--text-muted-color); margin-top:20px;">Escreva para pesquisar...</p>';
            return;
        }
        searchTimeout = setTimeout(() => { executeGlobalSearch(val, resultsContainer); }, 600);
    });

    setTimeout(() => searchInput.focus(), 200);
}


    // Renderiza a aba de Filtros com Toggles
function renderFiltersTab() {
    const container = document.getElementById('anchors-content-container');
    if (!container) return;
    
    const f = window.searchFilters;

    container.innerHTML = `
        <div class="filters-container" style="padding: 10px;">
            <div class="setting-toggle-container" style="background: rgba(74, 144, 226, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--accent-color);">
                <label class="setting-switch">
                    <input type="checkbox" id="f-all" ${f.all ? 'checked' : ''} onchange="window.toggleAllFilters(this.checked)">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label"><strong>Pesquisar em Tudo</strong></span>
            </div>

            <h4 style="color: var(--accent-color); margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">1. Localiza√ß√£o</h4>
            ${createFilterToggle('f-notes', 'Notas', 'notes')}
            ${createFilterToggle('f-superfolders', 'SuperPastas', 'superfolders')}
            ${createFilterToggle('f-archives', 'Arquivo', 'archives')}

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">2. Contexto Visual</h4>
            ${createFilterToggle('f-subnote', 'SubNotas', 'subnote')}
            ${createFilterToggle('f-question', 'Quest√µes', 'question')}
            ${createFilterToggle('f-free', 'Contentores', 'free')}
            ${createFilterToggle('f-postit', 'Post-its', 'postit')}

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">3. Metadados e Entidades</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                ${createFilterToggle('f-topics', 'T√≥picos', 'topics')}
                ${createFilterToggle('f-subtopics', 'SubT√≥picos', 'subtopics')}
                ${createFilterToggle('f-highlights', 'Destaques', 'highlights')}
                ${createFilterToggle('f-bookmarks', 'Marcadores', 'bookmarks')}
                ${createFilterToggle('f-personagem', 'Personagens', 'personagem')}
                ${createFilterToggle('f-local', 'Locais', 'local')}
                ${createFilterToggle('f-data', 'Datas', 'data')}
                ${createFilterToggle('f-cosmos', 'Temas (Cosmos)', 'cosmos')}
                ${createFilterToggle('f-subcosmos', 'SubTemas', 'subcosmos')}
                ${createFilterToggle('f-tags', 'Tags', 'tags')}
            </div>

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">4. Conte√∫do Extra</h4>
            ${createFilterToggle('f-fourthColumn', 'Texto 4¬™ Coluna (Puzzle)', 'fourthColumn')}
        </div>
    `;
}

function createFilterToggle(id, label, property) {
    // Busca o estado atual com fallback para evitar erros
    const isChecked = (window.searchFilters && window.searchFilters[property]) ? 'checked' : '';
    
    return `
        <div class="setting-toggle-container" style="margin-bottom: 10px;">
            <label class="setting-switch">
                <input type="checkbox" id="${id}" ${isChecked} 
                       onchange="window.updateSearchFilter('${property}', this.checked)">
                <span class="slider round"></span>
            </label>
            <span class="setting-label" style="font-size: 0.9em;">${label}</span>
        </div>
    `;
}

// --- FUN√á√ÉO DE PESQUISA REAL ---
async function executeGlobalSearch(queryText, container) {
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A procurar...</span></div>';
    
    const terms = parseSearchQuery(queryText);
    if (terms.length === 0) return;

    const isMultiMode = terms.length >= 2;
    const f = window.searchFilters;
    const myUid = auth.currentUser.uid;
    const foundResults = [];

    try {
        const qPastas = query(collection(db, 'pastas'), where('estado', '==', 'ativa'), where('userId', '==', myUid));
        const snapPastas = await getDocs(qPastas);

        snapPastas.forEach(docSnap => {
            const data = docSnap.data();
            const content = data.conteudo || "";
            const noteName = data.nome || "";
            
            const isArchive = (data.tipo === 'arquivo' || data.tipo === 'partilhado');
            if (isArchive && !f.archives) return;
            if (data.superpasta && !f.superfolders) return;

            let matched = false;
            let context = "";

            // --- L√ìGICA DE VERIFICA√á√ÉO ---
            const checkAgainstText = (text) => {
                // Retorna true se TODOS os termos da pesquisa passarem no teste
                return terms.every(termObj => {
                    const regex = getAccentInsensitiveRegex(termObj.text, termObj.exact);
                    return regex.test(text);
                });
            };

            if (isMultiMode && globalSearchScope === 'paragraph') {
                const parser = new DOMParser();
                const docHTML = parser.parseFromString(content, 'text/html');
                // Procura em par√°grafos, caixas de texto e t√≠tulos de entidades
                const blocks = docHTML.querySelectorAll('p, div, li, h1, h2, h3, .mini-note-content, .mini-note-title-input');

                for (const block of blocks) {
                    const blockText = block.tagName === 'INPUT' || block.tagName === 'TEXTAREA' ? block.value : block.innerText;
                    if (checkAgainstText(blockText)) {
                        matched = true;
                        context = generateSearchContext(blockText, terms[0].text, terms[0].exact);
                        break;
                    }
                }
            } else {
                // Pesquisa na p√°gina toda (T√≠tulo + Conte√∫do limpo de HTML)
                const fullText = noteName + " " + content.replace(/<[^>]*>/g, ' ');
                if (checkAgainstText(fullText)) {
                    matched = true;
                    context = generateSearchContext(fullText, terms[0].text, terms[0].exact);
                }
            }

            if (matched) {
                foundResults.push({
                    id: docSnap.id, name: noteName, badge: isArchive ? "Arquivo" : "Nota",
                    context: context, updatedAt: data.ultimaedicao?.toMillis() || 0,
                    rawSearchTerm: terms[0].text, clickAction: 'note'
                });
            }
        });

        // 4¬™ COLUNA (PUZZLE)
        if (f.fourthColumn) {
            const entityCollections = ['personagens', 'locais', 'topicos', 'textosbiblicos', 'marcadores', 'cosmos', 'subcosmos'];
            for (const colName of entityCollections) {
                const qEntity = query(collection(db, colName), where('userId', '==', myUid));
                const snapEntity = await getDocs(qEntity);

                snapEntity.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data.puzzleBoard) return;

                    let matched = false;
                    let context = "";

                    const checkAgainstText = (text) => {
                        return terms.every(termObj => {
                            const regex = getAccentInsensitiveRegex(termObj.text, termObj.exact);
                            return regex.test(text);
                        });
                    };

                    if (isMultiMode && globalSearchScope === 'paragraph') {
                        for (const item of data.puzzleBoard) {
                            const cardText = item.content || "";
                            if (checkAgainstText(cardText)) {
                                matched = true;
                                context = generateSearchContext(cardText, terms[0].text, terms[0].exact);
                                break;
                            }
                        }
                    } else {
                        const allPuzzleText = data.puzzleBoard.map(i => i.content).join(" ");
                        if (checkAgainstText(allPuzzleText)) {
                            matched = true;
                            context = generateSearchContext(allPuzzleText, terms[0].text, terms[0].exact);
                        }
                    }

                    if (matched) {
                        foundResults.push({
                            id: docSnap.id, name: data.nome, badge: "Puzzle",
                            context: context, updatedAt: data.updatedAt?.toMillis() || 0,
                            clickAction: 'entity', entityType: colName
                        });
                    }
                });
            }
        }

        foundResults.sort((a, b) => b.updatedAt - a.updatedAt);
        globalExplorerResults = foundResults;
        currentExplorerPage = 0;
        renderExplorerResultsPage(container, terms[0].text, {}, true);

    } catch (error) {
        console.error(error);
        container.innerHTML = '<p>Erro na pesquisa.</p>';
    }
}


// --- GERAR CONTEXTO (TEXTO AO REDOR) ---
function generateSearchContext(fullText, term, isExact) {
    const normalizedText = removeAccents(fullText);
    const normalizedTerm = removeAccents(term);
    
    let index = -1;

    if (isExact) {
        // Usa Regex para encontrar a posi√ß√£o da palavra inteira
        const regex = new RegExp(`\\b${escapeRegExp(normalizedTerm)}\\b`, 'i');
        const match = normalizedText.match(regex);
        index = match ? match.index : -1;
    } else {
        index = normalizedText.indexOf(normalizedTerm);
    }

    if (index === -1) return "";

    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + term.length + 40);
    
    let snippet = fullText.substring(start, end);
    
    if (start > 0) snippet = "..." + snippet;
    if (end < fullText.length) snippet = snippet + "...";

    // Passamos o isExact para o highlightMatch tamb√©m
    return highlightMatch(snippet, term, isExact);
}


// --- RENDERIZAR RESULTADOS ---
function renderExplorerResultsPage(container, term, folderMap, reset = false) {
    // 1. Se for um reset (nova pesquisa), limpa o contentor
    if (reset) {
        container.innerHTML = '';
    }

    if (globalExplorerResults.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">Nenhum resultado encontrado.</p>';
        return;
    }

    // 2. C√°lculo de Pagina√ß√£o
    const start = currentExplorerPage * EXPLORER_RESULTS_PER_PAGE;
    const end = start + EXPLORER_RESULTS_PER_PAGE;
    const pageResults = globalExplorerResults.slice(start, end);

    // Remove o bot√£o "Carregar mais" antigo se existir
    const oldBtn = document.getElementById('explorer-load-more-btn');
    if (oldBtn) oldBtn.remove();

    // 3. Loop de Renderiza√ß√£o dos Itens
    pageResults.forEach(item => {
        const divItem = document.createElement('div');
        divItem.className = 'search-result-item';

        // Definir cores e √≠cones baseados no Badge (Etiqueta)
        let borderLeftColor = "var(--border-color)";
        let icon = "üìÑ";
        let badgeStyle = "background: rgba(255,255,255,0.1); color: var(--text-muted-color);";

        switch (item.badge) {
            case 'Puzzle':
                borderLeftColor = "#2ecc71"; // Verde
                icon = "üß©";
                badgeStyle = "background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71;";
                break;
            case 'Arquivo':
                borderLeftColor = "#e74c3c"; // Vermelho
                icon = "üóÑÔ∏è";
                badgeStyle = "background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c;";
                break;
            case 'SuperPasta':
                borderLeftColor = "#f1c40f"; // Dourado
                icon = "üóÉÔ∏è";
                badgeStyle = "background: rgba(241, 196, 15, 0.2); color: #f1c40f; border: 1px solid #f1c40f;";
                break;
            case 'Quest√£o':
                borderLeftColor = "#1e8449"; // Verde escuro
                icon = "üìó";
                badgeStyle = "background: rgba(30, 132, 73, 0.2); color: #2ecc71;";
                break;
        }

        divItem.style.borderLeft = `4px solid ${borderLeftColor}`;

        // Construir HTML do item
        divItem.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span class="search-result-title">
                    ${icon} ${highlightMatch(item.name, term)} 
                </span>
                <span class="search-badge" style="${badgeStyle} font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase;">
                    ${item.badge}
                </span>
            </div>
            ${item.context ? `<div class="search-match-context" style="margin-top: 5px; font-size: 0.85em; opacity: 0.8;">${item.context}</div>` : ''}
        `;

        // 4. L√ìGICA DE CLIQUE INTELIGENTE
        divItem.onclick = () => {
            // Fecha o modal de pesquisa
            document.getElementById('anchors-modal').style.display = 'none';

            if (item.clickAction === 'entity') {
                // SE FOR PUZZLE: Abre o painel de Refer√™ncias da 4¬™ Coluna
                // Nota: Mapeamos o nome da cole√ß√£o para o tipo singular esperado pelo painel
                const typeMap = {
                    'personagens': 'personagem',
                    'locais': 'local',
                    'topicos': 'topico',
                    'textosbiblicos': 'textobiblico',
                    'marcadores': 'marcadores',
                    'cosmos': 'cosmos',
                    'subcosmos': 'subcosmos'
                };
                const singularType = typeMap[item.type] || item.type;
                showReferencesPanel(item.id, item.name, singularType);
            } else {
                // SE FOR NOTA: Abre a nota no editor principal
                navigateWithUnsavedCheck(() => {
                    navigateToNoteSmart(item.id, item.rawSearchTerm);
                });
            }
        };

        container.appendChild(divItem);
    });

    // 5. Adicionar Bot√£o "Carregar Mais" se houver mais resultados
    if (end < globalExplorerResults.length) {
        const remaining = globalExplorerResults.length - end;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'explorer-load-more-btn';
        loadMoreBtn.className = 'modal-btn secondary';
        loadMoreBtn.style.width = "100%";
        loadMoreBtn.style.marginTop = "15px";
        loadMoreBtn.textContent = `Mostrar mais ${remaining} resultados`;
        
        loadMoreBtn.onclick = (e) => {
            e.preventDefault();
            currentExplorerPage++;
            renderExplorerResultsPage(container, term, folderMap, false);
        };
        
        container.appendChild(loadMoreBtn);
    }
}



// Fun√ß√£o auxiliar para atualizar as abas visualmente (se ainda n√£o existir)
function updateTabsUI() {
    document.querySelectorAll('.tabs-container button').forEach(btn => {
        if (btn.dataset.tab === 'note') btn.classList.add('active');
        else btn.classList.remove('active');
    });
}

// Auxiliar para destacar t√≠tulo
function highlightMatch(text, term, isExact) {
    if (!text) return "";
    // Usamos a fun√ß√£o acima que j√° devolve a Regex com par√™nteses
    const regex = getAccentInsensitiveRegex(term, isExact);
    
    // Agora o $1 vai representar exatamente o que a Regex encontrou (ex: "Eva", "eva" ou "√âva")
    return text.replace(regex, "<mark>$1</mark>");
}

// --- FUN√á√ïES AUXILIARES DE CARREGAMENTO (Refatoradas para limpar o c√≥digo principal) ---
async function loadTagsForExplorer(container) {
    try {
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const activeTagsSet = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach(t => activeTagsSet.add(t));
            }
        });
        const tagsArray = Array.from(activeTagsSet).sort((a, b) => a.localeCompare(b));

        container.innerHTML = ''; 
        if (tagsArray.length === 0) {
            container.innerHTML = '<p style="padding:15px; color:#888;">Nenhuma tag encontrada.</p>';
        } else {
            const ul = document.createElement('ul');
            tagsArray.forEach(tagName => {
                const li = document.createElement('li');
                li.textContent = `#${tagName}`;
                li.style.cursor = 'pointer';
                li.style.color = 'var(--accent-color)';
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = tagName;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }
    } catch (e) {
        container.innerHTML = '<p style="color:red;">Erro ao carregar tags.</p>';
    }
}

function renderEntityTab(container, type, onPageNames) {
    const sortedEntities = [...allEntities[type]].sort((a, b) => a.nome.localeCompare(b.nome));
    
    // (Pode reinserir aqui a l√≥gica de separa√ß√£o "Nesta Nota" vs "Banco de Dados" se desejar,
    //  o c√≥digo √© id√™ntico ao que tinha antes na fun√ß√£o gigante)
    
    const ul = document.createElement('ul');
    if (sortedEntities.length === 0) {
        container.innerHTML = '<p style="padding:15px; color:#888;">Sem registos.</p>';
        return;
    }

    sortedEntities.forEach(entity => {
        const li = document.createElement('li');
        li.textContent = entity.nome;
        li.dataset.entityId = entity.id;
        li.dataset.entityName = entity.nome;
        li.dataset.entityType = entity.tipo;
        li.dataset.action = 'show-entity-references';
        
        if (onPageNames.has(entity.nome)) li.classList.add('is-on-page');

        const editBtn = document.createElement('button');
        editBtn.className = 'entity-edit-btn';
        editBtn.innerHTML = '‚Ä¶';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditEntityModal(entity.id, entity.tipo); };
        
        li.appendChild(editBtn);
        ul.appendChild(li);
    });
    container.appendChild(ul);
}



async function openEditEntityModal(entityId, entityType) {
    const modal = document.getElementById('edit-entity-modal');
    const modalContent = modal.querySelector('.modal-content'); 
    const title = document.getElementById('edit-entity-title');
    const nameInput = document.getElementById('edit-entity-name-input');
    const descriptionInput = document.getElementById('edit-entity-description-input');
    const saveBtn = document.getElementById('edit-entity-save-btn');
    const emojiContainer = document.getElementById('edit-emoji-container');
    const emojiInput = document.getElementById('edit-emoji-input');

    if (!modal) return;

    // 1. FOR√áAR VISIBILIDADE M√ÅXIMA
    document.body.appendChild(modal); // Move para o topo
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        justify-content: center !important;
        align-items: center !important;
    `;
    
    if (modalContent) modalContent.style.position = 'relative';

    nameInput.value = 'A carregar...';
    descriptionInput.value = 'A carregar...';
    
    if (entityType === 'subcosmos') {
        emojiContainer.style.display = 'block';
    } else {
        emojiContainer.style.display = 'none';
    }

    // --- BOT√ÉO OCULTAR (CANTO SUPERIOR DIREITO) ---
    const oldBtn = document.getElementById('btn-hide-entity-corner');
    if (oldBtn) oldBtn.remove();

    const hideBtn = document.createElement('button');
    hideBtn.id = 'btn-hide-entity-corner';
    hideBtn.textContent = "üëÅÔ∏è Ocultar";
    
    hideBtn.style.cssText = `
        position: absolute; top: 15px; right: 15px;
        background: none; border: 1px solid transparent;
        color: var(--text-muted-color); font-size: 0.75em;
        cursor: pointer; padding: 4px 8px; border-radius: 4px;
        transition: all 0.2s; opacity: 0.7;
    `;
    
    hideBtn.onmouseover = () => { hideBtn.style.color = "#e74c3c"; hideBtn.style.opacity = "1"; hideBtn.style.backgroundColor = "rgba(231, 76, 60, 0.1)"; };
    hideBtn.onmouseout = () => { hideBtn.style.color = "var(--text-muted-color)"; hideBtn.style.opacity = "0.7"; hideBtn.style.backgroundColor = "transparent"; };

    modalContent.appendChild(hideBtn);

    const collectionName = getCollectionFromType(entityType);
    
    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (!entitySnap.exists()) {
            modal.style.display = 'none';
            alert("Erro: Item n√£o encontrado.");
            return;
        }

        const entityData = entitySnap.data();
        title.textContent = `Editar "${entityData.nome}"`;
        nameInput.value = entityData.nome;
        descriptionInput.value = entityData.descricao || '';
        
        if (entityType === 'subcosmos') emojiInput.value = entityData.emoji || "üíº";

        // --- L√ìGICA DO BOT√ÉO OCULTAR ---
        hideBtn.onclick = async () => {
            // A. Trazemos o modal de confirma√ß√£o para a frente deste modal
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) {
                // Truque: remove e readiciona ao body para garantir que √© o √∫ltimo elemento
                document.body.appendChild(confirmModal); 
                confirmModal.style.setProperty('z-index', '2147483647', 'important'); 
            }

            const confirmed = await showConfirmation(
                "Ocultar Item?",
                `Deseja ocultar "${entityData.nome}"?\n\nEle sair√° das listas mas pode ser recuperado em Configura√ß√µes > Itens Ocultos.`
            );

            if (confirmed) {
                modal.style.display = 'none';
                await updateDoc(entityRef, { estado: 'desativa' });
                
                if (typeof hideReferencesPanel === 'function') hideReferencesPanel();
                if (typeof fetchAllEntities === 'function') fetchAllEntities();
                
                // Se estiver no modo lista, atualiza
                if (currentTab === 'lists' && navigationStack.length > 0) {
                    renderListCategoryItems(navigationStack[0].id);
                }
            }
        };

        // --- L√ìGICA DO BOT√ÉO GRAVAR ---
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDescription = descriptionInput.value.trim();
            const newEmoji = emojiInput.value.trim();

            if (!newName) return alert('O nome √© obrigat√≥rio.');

            const updateData = { nome: newName, descricao: newDescription };
            if (entityType === 'subcosmos') updateData.emoji = newEmoji || "üíº"; 

            await updateDoc(entityRef, updateData);

            // Atualiza Cache
            if (allEntities[entityType]) {
                const cached = allEntities[entityType].find(e => e.id === entityId);
                if (cached) {
                    cached.nome = newName;
                    cached.descricao = newDescription;
                    cached.emoji = newEmoji;
                }
            }

            modal.style.display = 'none';
            
            // Atualiza UI
            if (activeReferenceEntity && activeReferenceEntity.id === entityId) {
                activeReferenceEntity.name = newName;
                const tEl = document.getElementById('references-panel-title');
                const dEl = document.getElementById('references-panel-description');
                if (tEl) tEl.textContent = `Refer√™ncias: ${newName}`;
                if (dEl) dEl.textContent = newDescription;
            }
        };

    } catch (error) {
        console.error("Erro ao editar:", error);
        modal.style.display = 'none';
    }
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function appendLinkInfoToPanel(anexoId) {
    if (!selectedNoteId) {
        console.error('ID da nota n√£o encontrado. A abortar.');
        console.groupEnd();
        return;
    }

    const noteRef = doc(db, 'pastas', selectedNoteId);
    const noteSnap = await getDoc(noteRef);
    
    if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[anexoId]) {
        const anexo = noteSnap.data().anexos[anexoId];
        const list = document.getElementById('references-list');

        const details = document.createElement('details');
        details.className = 'reference-item link-info';
        details.open = true;

        const summary = document.createElement('summary');
        summary.innerHTML = `üîó Anexo: ${anexo.titulo}`;
        
        const contextDiv = document.createElement('div');
        contextDiv.className = 'reference-context';
        
        const urls = anexo.urls ? Object.values(anexo.urls) : [anexo.hiperligacao];
        urls.forEach(url => {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.textContent = url;
                link.target = '_blank';
                link.style.display = 'block';
                link.style.marginBottom = '5px';
                contextDiv.appendChild(link);
            }
        });

        details.appendChild(summary);
        details.appendChild(contextDiv);
        
        const separator = document.createElement('hr');
        separator.style.borderColor = 'var(--border-color)';
        separator.style.margin = '15px 0';
        
        list.appendChild(separator);
        list.appendChild(details);
    } else {
        console.error(`Anexo com ID "${anexoId}" n√£o foi encontrado nos dados da nota.`);
    }
    console.groupEnd();
}
// ====================================================================


// --- LISTENERS DOS BOT√ïES DO CABE√áALHO ---
document.getElementById('add-text-btn').addEventListener('click', () => createBoardItem('text', {}, true));
document.getElementById('add-ref-btn').addEventListener('click', () => openReferenceSelectionPopup());

// Fun√ß√£o Unificada para Criar Cart√µes no Quadro
function createBoardItem(type, data = {}, shouldScroll = false) {
    const container = document.getElementById('puzzle-board-container');
    const emptyMsg = document.getElementById('puzzle-empty-msg');
    if (emptyMsg) emptyMsg.style.display = 'none';

    const card = document.createElement('div');
    card.className = `board-card type-${type}`;

    const puzzleContainer = document.getElementById('ref-content-puzzle');
    const isEditMode = puzzleContainer && puzzleContainer.classList.contains('edit-mode-active');
    let innerHTML = '';
    let headerHtml = "";
    let displayHtml = "";

    // --- TIPO 1: TEXTO MANUAL ---
    if (type === 'text') {
        const contentHtml = data.content || '';
        const initialStyle = "width:100%; min-height:40px; outline:none; white-space:pre-wrap; word-break:break-word; color:var(--text-color); border:1px solid transparent; background-color:transparent; padding:2px 5px; transition:all 0.2s ease;";

        innerHTML = `<div class="board-text-content" spellcheck="false" style="${initialStyle}" ${isEditMode ? 'contenteditable="true"' : 'contenteditable="false"'}>${contentHtml}</div>`;
        card.style.borderLeft = "3px solid var(--accent-color)"; 
    }

    // --- TIPO 2: REFER√äNCIA (Importado ou Nota Flash) ---
    else if (type === 'ref') {
        card.dataset.noteId = data.noteId;
        card.dataset.noteName = data.noteName || "Nota";

        let rawSnippet = data.snippet || '';
        
        // >>> CORRE√á√ÉO CR√çTICA: DESCODIFICAR O HTML <<<
        try {
            // Se estiver codificado (com %20, %3C, etc), descodifica
            if (rawSnippet.includes('%3C') || rawSnippet.includes('%20')) {
                rawSnippet = decodeURIComponent(rawSnippet);
            }
        } catch (e) { console.warn("Erro ao descodificar snippet:", e); }
        
        // Guarda a vers√£o codificada no dataset para seguran√ßa ao gravar de volta
        card.dataset.snippet = encodeURIComponent(rawSnippet);

        // --- PARSING DO HTML PARA EXTRAIR TEXTO LIMPO ---
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawSnippet;

        // 1. Extra√ß√£o de T√≠tulo
        const titleEl = tempDiv.querySelector('.mini-note-title-input');
        const h2El = tempDiv.querySelector('h2');
        const ideaEl = tempDiv.querySelector('.idea-span');
        
        let extractedTitle = "";
        if (titleEl) {
            extractedTitle = titleEl.textContent || titleEl.value || titleEl.getAttribute('value') || "";
        } else if (h2El) {
            extractedTitle = h2El.textContent;
        } else if (ideaEl) {
            extractedTitle = ideaEl.textContent;
        }

        let finalDisplayTitle = extractedTitle.trim();
        if (!finalDisplayTitle || finalDisplayTitle === "Texto da Nota") {
            finalDisplayTitle = data.noteName || "Sem T√≠tulo";
        }

        // 2. Defini√ß√£o de √çcone e Cor
        let icon = "üìÑ"; 
        let color = "#95a5a6"; 
        
        if (rawSnippet.includes('question-mode')) { icon = "üìó"; color = "#2ecc71"; }
        else if (rawSnippet.includes('free-mode')) { icon = "üìô"; color = "#e67e22"; }
        else if (rawSnippet.includes('toggle-section')) { icon = "‚òÇ"; color = "#9b59b6"; }
        else if (rawSnippet.includes('idea-span')) { icon = "üí°"; color = "#e74c3c"; }
        else if (rawSnippet.includes('mini-note-wrapper')) { icon = "üìò"; color = "#3498db"; } // Subnota (Flash)

        card.style.borderLeft = `4px solid ${color}`;

        // 3. Extra√ß√£o de Conte√∫do (Body)
        const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content') || tempDiv;
        
        // Limpa o texto (remove quebras excessivas)
        let bodyText = contentDiv.innerText.replace(/\s+/g, ' ').trim();
        
        // Remove lixo de bot√µes se tiver ficado no innerText
        bodyText = bodyText.replace(/üîê|üî∫|üîª|‚ö°|üß¨|üé®|üìã|üóëÔ∏è/g, '');

        if (bodyText.length > 250) bodyText = bodyText.substring(0, 250) + "...";

        // Montagem do HTML Visual
        headerHtml = `
            <div style="padding-left: 5px; margin-bottom: 5px;">
                <div style="font-weight:bold; font-size:1em; cursor:pointer; color:var(--text-color); display: flex; align-items: center; gap: 8px;" 
                     onclick="window.openNoteFromBoard('${data.noteId}', '${encodeURIComponent(finalDisplayTitle)}')"
                     onmouseover="this.style.textDecoration='underline'" 
                     onmouseout="this.style.textDecoration='none'">
                    <span style="font-size: 1.2em;">${icon}</span> ${finalDisplayTitle}
                </div>
            </div>`;

        displayHtml = `<div style="font-size:0.9em; color:var(--text-muted-color); padding-left: 8px; line-height:1.4;">${bodyText}</div>`;

        innerHTML = `<div class="ref-card-content">${headerHtml}${displayHtml}</div>`;
    }

    // Adiciona controlos (Lixo, Setas)
    innerHTML += `
        <div class="card-controls"> 
            ${type === 'text' ? '<button class="add-board-link" title="Gerir Links" style="margin-right: auto;">üåê</button>' : ''}
            <button class="move-up" title="Mover para Cima">üî∫</button>
            <button class="move-down" title="Mover para Baixo">üîª</button>
            <button class="delete" title="Remover" style="color:#e74c3c; border-color:#e74c3c;">üóëÔ∏è</button>
        </div>
    `;

    card.innerHTML = innerHTML;

    // --- RECONFIGURA√á√ÉO DOS LISTENERS ---
    const linkBtn = card.querySelector('.add-board-link');
    if (linkBtn) {
        linkBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const contentDiv = card.querySelector('.board-text-content');
            if (typeof openBoardLinkManager === 'function') openBoardLinkManager(contentDiv);
        };
    }

    card.querySelector('.delete').onclick = async () => {
        const confirmModal = document.getElementById('confirm-modal');
        if (confirmModal) confirmModal.style.zIndex = "30000";
        const confirmed = await showConfirmation("Remover Item", "Deseja remover este item do quadro?");
        if (confirmed) { 
            card.remove(); 
            const container = document.getElementById('puzzle-board-container');
            const emptyMsg = document.getElementById('puzzle-empty-msg');
            if(container.querySelectorAll('.board-card').length === 0 && emptyMsg) emptyMsg.style.display = 'block';
            if(isEditMode) savePuzzleData(); 
        }
    };

    card.querySelector('.move-up').onclick = () => {
        const p = card.previousElementSibling; 
        if (p && p.classList.contains('board-card')) container.insertBefore(card, p);
    };
    card.querySelector('.move-down').onclick = () => {
        const n = card.nextElementSibling; 
        if (n && n.classList.contains('board-card')) container.insertBefore(n, card);
    };

    container.appendChild(card);

    if (shouldScroll) {
        setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
}




// Fun√ß√£o para abrir nota a partir do Quadro (Puzzle) - VERS√ÉO ATUALIZADA
window.openNoteFromBoard = function(noteId, encodedSearchTerm = null) {
    
    // 1. Descodifica o termo de pesquisa (t√≠tulo da caixa) se ele existir
    // Se n√£o existir, tenta usar o nome da entidade ativa como fallback (comportamento antigo)
    let term = encodedSearchTerm 
        ? decodeURIComponent(encodedSearchTerm) 
        : (typeof activeReferenceEntity !== 'undefined' && activeReferenceEntity ? activeReferenceEntity.name : null);

    // 2. Usa a Navega√ß√£o Inteligente (que lida com Superpastas e Grava√ß√£o)
    // A fun√ß√£o navigateWithUnsavedCheck garante que gravamos o quadro antes de sair
    navigateWithUnsavedCheck(() => {
        if (typeof navigateToNoteSmart === 'function') {
            // Usa a fun√ß√£o moderna que sabe mudar de p√°gina
            navigateToNoteSmart(noteId, term);
        } else {
            // Fallback de seguran√ßa (caso a fun√ß√£o smart n√£o exista por algum motivo)
            displayNote(noteId, null, term);
        }
    });
};

// --- L√ìGICA DO POPUP DE SELE√á√ÉO DE REFER√äNCIAS ---
async function openReferenceSelectionPopup() {
    const modal = document.getElementById('puzzle-ref-selection-modal');
    const list = document.getElementById('puzzle-ref-selection-list');
    
    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        alert("Selecione um t√≥pico, tag ou entidade primeiro.");
        return;
    }

    // ============================================================
    // CORRE√á√ÉO DE HIERARQUIA (AQU√ÅRIO FIX)
    // ============================================================
    document.body.appendChild(modal); // Move para o topo do DOM
    
    modal.style.cssText = `
        display: flex !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        justify-content: center !important;
        align-items: center !important;
        visibility: visible !important;
        opacity: 1 !important;
    `;
    // ============================================================

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar notas e categorias anexadas...</span></div>';

    allFoundReferenceBoxes = [];
    currentReferencePageIndex = 0;

    const { id, type, name } = activeReferenceEntity;
    const isHighlightSearch = (type === 'destaque');
    const searchTerm = name.toLowerCase().trim();
    const hexToFind = isHighlightSearch ? id.toUpperCase() : null;

    try {
        let q = query(collection(db, 'pastas'), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid),
            where('tipo', 'in', ['nota', 'arquivo', 'partilhado'])
        );
        
        const snapshot = await getDocs(q);
        const parser = new DOMParser();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const noteTitle = data.nome || "Sem T√≠tulo";
            const updatedTime = data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0;

            if (data.passe && data.passe.trim() !== "" && !appSettings.searchAnchorsInProtected) return;

            let contentsToScan = [];
            if (data.tipo === 'nota') {
                contentsToScan.push({ html: data.conteudo || "", originName: noteTitle });
            } else {
                const posts = data.posts || [];
                posts.forEach(post => {
                    contentsToScan.push({ html: post.content || "", originName: `${noteTitle} (Post: ${post.title || 'S/T'})` });
                });
            }

            contentsToScan.forEach(item => {
                const docHTML = parser.parseFromString(item.html, 'text/html');
                const allWrappers = docHTML.querySelectorAll('.mini-note-wrapper, details.toggle-section');
                
                allWrappers.forEach((w) => {
                    let boxTitle = "";
                    let boxContentOnly = "";

                    if (w.tagName === 'DETAILS') {
                        const h2 = w.querySelector('h2');
                        boxTitle = h2 ? h2.textContent : "Sec√ß√£o";
                        const contentDiv = w.querySelector('.toggle-content');
                        boxContentOnly = contentDiv ? contentDiv.textContent : "";
                    } else {
                        const titleInput = w.querySelector('.mini-note-title-input');
                        boxTitle = titleInput ? (titleInput.value || titleInput.getAttribute('value') || "") : "";
                        const contentDiv = w.querySelector('.mini-note-content');
                        boxContentOnly = contentDiv ? contentDiv.textContent : "";
                    }

                    const boxFullText = (boxTitle + " " + boxContentOnly).toLowerCase();
                    let match = false;

                    // 1. Match por Cor
                    if (isHighlightSearch) {
                        const elColor = w.getAttribute('data-highlight');
                        if (elColor && elColor.toUpperCase() === hexToFind) match = true;
                    } 
                    
                    // 2. Match por Texto
                    if (!match && boxFullText.includes(searchTerm)) {
                        match = true;
                    }

                    // 3. Match por Categorias Anexadas
                    const boxLinksRaw = w.getAttribute('data-box-links');
                    if (!match && boxLinksRaw) {
                        try {
                            const boxData = JSON.parse(boxLinksRaw);
                            if (boxData.categories && Array.isArray(boxData.categories)) {
                                match = boxData.categories.some(cat => 
                                    (cat.id && cat.id === id) || 
                                    (cat.name && cat.name.toLowerCase().trim() === searchTerm)
                                );
                            }
                        } catch (e) { }
                    }

                    if (match) {
                        let boxType = "Bloco"; let boxIcon = "üì¶";
                        if (w.tagName === 'DETAILS') { boxType = "Sec√ß√£o"; boxIcon = "‚òÇÔ∏è"; }
                        else if (w.classList.contains('question-mode')) { boxType = "Quest√£o"; boxIcon = "üìó"; }
                        else if (w.classList.contains('free-mode')) { boxType = "Contentor"; boxIcon = "üìô"; }
                        else { boxType = "SubNota"; boxIcon = "üìò"; }

                        let displayTitle = boxTitle.trim();
                        if (!displayTitle) {
                            displayTitle = boxContentOnly.trim().substring(0, 40) + "...";
                        }

                        allFoundReferenceBoxes.push({
                            id: docSnap.id, 
                            name: item.originName, 
                            snippet: w.outerHTML,
                            displaySnippet: displayTitle,
                            typeName: boxType, 
                            typeIcon: boxIcon, 
                            updatedTime: updatedTime
                        });
                    }
                });
            });
        });

        allFoundReferenceBoxes.sort((a, b) => b.updatedTime - a.updatedTime);
        list.innerHTML = '';
        renderReferenceBoxesPage(); 

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar resultados.</li>';
    }
}

function renderReferenceBoxesPage() {
    const list = document.getElementById('puzzle-ref-selection-list');
    const ITEMS_PER_PAGE = 15;
    
    const oldBtn = document.getElementById('load-more-refs-btn');
    if (oldBtn) oldBtn.remove();

    if (allFoundReferenceBoxes.length === 0) {
        list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhuma refer√™ncia encontrada.</li>';
        return;
    }

    const start = currentReferencePageIndex * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = allFoundReferenceBoxes.slice(start, end);

    pageItems.forEach(item => {
        const li = document.createElement('li');
        li.className = 'puzzle-ref-item';
        
        li.innerHTML = `
            <div class="puzzle-ref-header">
                <span class="puzzle-ref-type" style="color: var(--accent-color)">
                    ${item.typeIcon} ${item.typeName}
                </span>
                <span class="puzzle-ref-note">em ${item.name}</span>
            </div>
            <div class="puzzle-ref-snippet">
                ${item.displaySnippet}
            </div>
        `;

        li.onclick = async (e) => {
            e.preventDefault();
            e.stopPropagation();

            // --- 1. DETETAR QUAL A ABA QUE EST√Å REALMENTE ATIVA NO PAINEL ---
            const activeTabBtn = document.querySelector('#ref-tabs button.active');
            const activeTab = activeTabBtn ? activeTabBtn.dataset.refTab : 'puzzle';

            // --- 2. L√ìGICA DE DESTINO ---
            
            // CASO A: Aba DOSSI√â selecionada e temos uma Mica aberta
            if (activeTab === 'dossie' && window.activeMicaId) {
                try {
                    const collectionName = getCollectionFromType(activeReferenceEntity.type);
                    const docRef = doc(db, collectionName, activeReferenceEntity.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        let dossie = docSnap.data().dossie || [];
                        const mica = dossie.find(m => m.id === window.activeMicaId);
                        
                        if (mica) {
                            if (!mica.items) mica.items = [];
                            mica.items.push({
                                noteId: item.id,
                                noteName: item.name,
                                snippet: encodeURIComponent(item.snippet)
                            });
                            await updateDoc(docRef, { dossie: dossie });
                            window.renderDossie(); 
                        }
                    }
                } catch (err) { console.error("Erro Mica:", err); }
            } 
            // CASO B: Aba QUADRO (ou qualquer outra) -> Vai para o Quadro (Puzzle)
            else {
                if (typeof createBoardItem === 'function') {
                    // Adiciona ao container lateral do Quadro
                    createBoardItem('ref', {
                        noteId: item.id,
                        noteName: item.name,
                        snippet: item.snippet,
                        isClone: true
                    }, true);

                    // Se o Quadro estiver em modo edi√ß√£o (azul), grava logo no Firebase
                    const puzzleContainer = document.getElementById('ref-content-puzzle');
                    if (puzzleContainer && puzzleContainer.classList.contains('edit-mode-active')) {
                        savePuzzleData();
                    }
                }
            }
            
            // Fecha o modal ap√≥s a sele√ß√£o
            document.getElementById('puzzle-ref-selection-modal').style.display = 'none';
        };
        list.appendChild(li);
    });

    if (end < allFoundReferenceBoxes.length) {
        currentReferencePageIndex++;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-refs-btn';
        loadMoreBtn.className = 'modal-btn secondary';
        loadMoreBtn.style.width = "100%";
        loadMoreBtn.style.marginTop = "10px";
        loadMoreBtn.textContent = `+ ${allFoundReferenceBoxes.length - end} resultados`;
        loadMoreBtn.onclick = () => renderReferenceBoxesPage();
        list.appendChild(loadMoreBtn);
    }
}

// 4. Adicionar ao Dossi√© (+Add)
document.getElementById('mica-add-content-btn').onclick = async () => {
    // Apenas abre o modal. O clique no item agora √© gerido pela fun√ß√£o de renderiza√ß√£o abaixo.
    await openReferenceSelectionPopup();
};
// --- FUN√á√ÉO DE NAVEGA√á√ÉO INTELIGENTE ENTRE SUPERPASTAS ---

/**
 * Verifica a ancestralidade da nota e decide se abre diretamente
 * ou se redireciona para outra p√°gina (note.html vs superpasta.html)
 */
async function navigateToNoteSmart(targetNoteId, searchTerm = null) {
    if (!targetNoteId) return;

    // CORRE√á√ÉO: N√£o usamos updateSaveStatus('saving') aqui.
    // Apenas mudamos o texto visualmente para o utilizador saber que algo est√° a acontecer.
    const statusEl = document.getElementById('save-status-indicator');
    if(statusEl) {
        statusEl.textContent = "A localizar nota...";
        statusEl.style.opacity = "1";
    }


    try {
        // 1. Buscar dados da nota
        const noteSnap = await getDoc(doc(db, 'pastas', targetNoteId));
        if (!noteSnap.exists()) {
            alert("Nota n√£o encontrada.");
            if(statusEl) statusEl.textContent = ""; // Limpa mensagem
            console.groupEnd();
            return;
        }
        const noteData = noteSnap.data();
        
        // 2. DETETIVE: Verificar Ancestrais (Procurar Superpasta)
        let currentParentId = noteData.parentId;
        let foundSuperfolderId = null;
        let safety = 0;

        while (currentParentId && safety < 50) {
            const parentSnap = await getDoc(doc(db, 'pastas', currentParentId));
            if (!parentSnap.exists()) break;
            
            const parentData = parentSnap.data();
            
            // Se encontrar uma superpasta
            if (parentData.superpasta === true) {
                foundSuperfolderId = currentParentId;
                break; 
            }
            currentParentId = parentData.parentId;
            safety++;
        }

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

       // 3. DECIS√ÉO FINAL (Unificada)
        console.groupEnd();
        
        // Reconstr√≥i caminho e abre nota
        await reconstructNavigationPath(targetNoteId);
        displayNote(targetNoteId, null, searchTerm);
        
        // Restaura o texto de estado
        if(statusEl) updateSaveStatus('saved');

    } catch (error) {
        console.error("Erro navega√ß√£o:", error);
        console.groupEnd();
        if(statusEl) statusEl.textContent = "Erro ao navegar";
    }
}

async function reconstructNavigationPath(noteId) {
    let currentId = noteId;
    const path = [];
    let safety = 0;
    while (currentId && safety < 20) {
        const docSnap = await getDoc(doc(db, 'pastas', currentId));
        if (!docSnap.exists()) break;
        const data = docSnap.data();
        if (!data.parentId) { // Raiz
            if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
            break;
        }
        if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
        currentId = data.parentId;
        safety++;
    }
    navigationStack = path;
    updateNavigationView(true, noteId); 
}

// ============================================================
// FUN√á√ïES AUXILIARES EM FALTA (COLE ISTO ANTES DO savePuzzleData)
// ============================================================

// 1. Mapear tipos para nomes de cole√ß√µes no Firebase
function getCollectionFromType(type) {
    if (ENTITY_CONFIG[type]) return ENTITY_CONFIG[type].collection;
    
    // Casos especiais
    if (type === 'topico') return 'topicos';
    if (type === 'subtopico') return 'subtopicos';
    if (type === 'tag') return 'tags';
     if (type === 'marcadores') return 'marcadores';
    
    return null;
}

// 2. For√ßar a grava√ß√£o e sa√≠da do modo de edi√ß√£o (Crucial para a navega√ß√£o)
async function forceSaveAndClosePuzzleMode() {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // S√≥ faz algo se estivermos no modo "Conclu√≠do" (ativo)
    if (container && container.classList.contains('edit-mode-active')) {

        // 1. GRAVAR NO FIREBASE (Aguarda terminar antes de continuar)
        await savePuzzleData();

        // 2. DESLIGAR MODO DE EDI√á√ÉO (Visual)
        container.classList.remove('edit-mode-active');

        // Restaurar bot√£o principal
        if (btn) {
            btn.textContent = "Editar";
            btn.style.color = "";
            btn.style.borderColor = "";
            btn.style.backgroundColor = "";
        }

        // Esconder bot√µes de adicionar
        if (addButtons) {
            addButtons.style.display = 'none';
        }

        // 3. BLOQUEAR AS CAIXAS DE TEXTO
        // Transformar de edit√°veis para est√°ticas
        const editableDivs = container.querySelectorAll('.board-text-content');
        editableDivs.forEach(div => {
            div.setAttribute('contenteditable', 'false');
            // Remove estilo de input
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
}

// ============================================================

async function savePuzzleData() {
    if (!activeReferenceEntity || !activeReferenceEntity.name) return;

    const { id, type, name } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    
    const saveBtn = document.getElementById('toggle-puzzle-edit-btn');
    if(saveBtn) saveBtn.textContent = "A gravar...";

    try {
        const itemsToSave = [];
        const cards = document.querySelectorAll('#puzzle-board-container .board-card');

        cards.forEach(card => {
            if (card.classList.contains('type-text')) {
                const contentDiv = card.querySelector('.board-text-content');
                if (contentDiv) itemsToSave.push({ type: 'text', content: contentDiv.innerHTML });
            } 
            else if (card.classList.contains('type-ref')) {
                itemsToSave.push({ 
                    type: 'ref', 
                    noteId: card.dataset.noteId,
                    noteName: card.dataset.noteName,
                    snippet: decodeURIComponent(card.dataset.snippet)
                });
            }
        });

        // --- CORRE√á√ÉO DE SEGURAN√áA ---
        let docRef;
        
        // Se o ID atual parece um nome de vers√≠culo (tem espa√ßos ou :), ou se √© null
        // vamos procurar se o user j√° tem um doc real para isto
        if (!id || id.includes(' ') || id.includes(':')) {
            const q = query(
                collection(db, collectionName), 
                where("nome", "==", name),
                where("userId", "==", auth.currentUser.uid)
            );
            const snap = await getDocs(q);
            
            if (!snap.empty) {
                // J√° existe um documento real, usamos o ID dele
                docRef = doc(db, collectionName, snap.docs[0].id);
                activeReferenceEntity.id = snap.docs[0].id; 
            } else {
                // N√£o existe? Criamos um NOVO documento com ID aleat√≥rio (addDoc)
                const newDoc = await addDoc(collection(db, collectionName), {
                    nome: name,
                    userId: auth.currentUser.uid,
                    puzzleBoard: itemsToSave,
                    updatedAt: serverTimestamp(),
                    createdAt: serverTimestamp()
                });
                activeReferenceEntity.id = newDoc.id; // Atualiza para o ID novo
                return; // J√° gravou, podemos sair
            }
        } else {
            // Se j√° temos um ID hexadecimal (aleat√≥rio), gravamos direto
            docRef = doc(db, collectionName, id);
        }

        // Grava√ß√£o final (Update ou Set)
        await setDoc(docRef, {
            nome: name,
            userId: auth.currentUser.uid,
            puzzleBoard: itemsToSave,
            updatedAt: serverTimestamp()
        }, { merge: true });

    } catch (e) {
        console.error("‚ùå Erro ao gravar:", e);
        alert("Erro de permiss√£o: Este vers√≠culo pode estar mal configurado no banco de dados.");
    } finally {
        if(saveBtn) saveBtn.textContent = "Editar";
    }
}

// --- NOVO LOAD (Unificado) ---
async function loadPuzzleData(entityId, entityType) {
    const container = document.getElementById('puzzle-board-container');
    if (!container) return;

    // 1. MOSTRAR LOADING
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A carregar Quadro...</span>
        </div>`;

    const collectionName = getCollectionFromType(entityType);
    if (!collectionName) {
        container.innerHTML = '';
        return;
    }

    try {
        let foundData = null;

        // 2. TENTATIVA A: Busca direta pelo ID (se for ID v√°lido)
        if (entityId && entityId.length > 5 && !entityId.includes(' ')) {
            const docRef = doc(db, collectionName, entityId);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                foundData = snap.data();
            }
        }

        // 3. TENTATIVA B: Busca pelo Nome (CR√çTICO PARA VERS√çCULOS)
        // Se a busca por ID falhou, procura pelo nome exato (ex: "G√©nesis 1:1")
        if (!foundData) {
            const nameToFind = (typeof entityId === 'string' && entityId.includes(' ')) ? entityId : activeReferenceEntity.name;
            
            const q = query(
                collection(db, collectionName), 
                where("nome", "==", nameToFind), 
                where("userId", "==", auth.currentUser.uid)
            );
            
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                foundData = querySnapshot.docs[0].data();
                // Atualiza o ID da entidade ativa para o correto
                activeReferenceEntity.id = querySnapshot.docs[0].id;
            }
        }

        // 4. LIMPAR O LOADING
        container.innerHTML = '';

        // 5. VERIFICA√á√ÉO DE DADOS
        const boardItems = foundData ? (foundData.puzzleBoard || []) : [];

        if (boardItems.length === 0) {
            container.innerHTML = `
                <p id="puzzle-empty-msg" style="text-align:center; color:var(--text-muted-color); font-size:0.9em; margin-top:40px; font-style: italic;">
                    O quadro est√° vazio.<br>Clique em "Editar" para adicionar notas ou refer√™ncias.
                </p>`;
            return;
        }

        // 6. RENDERIZAR CART√ïES
        boardItems.forEach(item => {
            createBoardItem(item.type, {
                content: item.content,
                noteId: item.noteId,
                noteName: item.noteName,
                snippet: item.snippet
            });
        });

    } catch (e) { 
        console.error("Erro no Puzzle:", e); 
        container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar o Quadro.</p>';
    }
}

// ====================================================================
// ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT JAVASCRIPT
// ====================================================================
async function showTagReferencesPanel(tagName) {
    
    // 1. Gravar o puzzle anterior se estivesse em modo edi√ß√£o
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI();

    // 2. DEFINIR ENTIDADE ATIVA (Essencial para o +Ref do Quadro)
    activeReferenceEntity = { 
        id: tagName, 
        type: 'tag', 
        name: tagName 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Cita√ß√µes de #${tagName}`;

    // For√ßar a aba "Cita√ß√µes" a abrir para listar as notas
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Carregar os dados do Quadro (Puzzle) salvos para esta Tag
    loadPuzzleData(tagName, 'tag');
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar notas com #${tagName}...</span>
        </div>`;

    try {
        // 4. Pesquisa no Firestore: Notas ativas com a tag espec√≠fica
        const q = query(
            collection(db, 'pastas'), 
            where('tags', 'array-contains', tagName),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const querySnapshot = await getDocs(q);
        
        // 5. Reset da lista global de resultados
        allCitationsResults = []; 

        querySnapshot.forEach(noteDoc => {
            const data = noteDoc.data();
            
            // Filtro de Privacidade
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            if (isItemProtected && !appSettings.searchTagsInProtected) {
                return; 
            }
            
            // Preparar o Snippet visual para quando for adicionado ao quadro
            const tagSnippet = `<p style="color:#3498db; font-weight:bold;">üè∑Ô∏è Nota com tag #${tagName}</p>`;

            // Alimenta o array global para pagina√ß√£o
            allCitationsResults.push({ 
                id: noteDoc.id, 
                name: data.nome, 
                isProtected: isItemProtected,
                snippet: tagSnippet,
                ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
            });
        });

        // 6. ORDENAR: Mais recente primeiro
        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);

        // 7. Renderizar a primeira p√°gina (false = resetar lista visual)
        window.renderCitationsPage(false);

    } catch (error) {
        console.error("Erro ao carregar cita√ß√µes da tag:", error);
        listElement.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao processar as notas no banco de dados.</li>';
    }
}


// ============================================================
// MOTOR DA 4¬™ COLUNA - B√çBLIA P√öBLICA + PUZZLE PRIVADO (FIXED)
// ============================================================

function resetReferencesPanelUI() {
    // 1. Esconder todos os conte√∫dos de abas
    document.querySelectorAll('.ref-tab-content').forEach(el => {
        el.style.display = 'none';
    });

    // 2. Mostrar apenas o conte√∫do do Puzzle (padr√£o de abertura)
    const puzzleContent = document.getElementById('ref-content-puzzle');
    if (puzzleContent) puzzleContent.style.display = 'flex';

    // 3. Resetar visual dos bot√µes das abas
    document.querySelectorAll('#ref-tabs button').forEach(btn => {
        btn.classList.remove('active');
    });
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTabBtn) puzzleTabBtn.classList.add('active');

    // 4. Limpar a lista de Links (Doc.)
    const linksList = document.getElementById('panel-links-list');
    if (linksList) linksList.innerHTML = '';

    // 5. RESET DO MODO EDI√á√ÉO (Links/Doc)
    isPanelEditMode = false;
 isPanelEditMode = false;
    const editLinksBtn = document.getElementById('toggle-links-edit-btn');
    const linksActions = document.getElementById('links-edit-actions');
    if (editLinksBtn) {
        editLinksBtn.textContent = "Editar";
        editLinksBtn.style.color = "";
        editLinksBtn.style.borderColor = "";
        editLinksBtn.style.backgroundColor = "";
    }
    if (linksActions) linksActions.style.display = 'none';

    // ============================================================
    // üöÄ LIMPEZA AGRESSIVA DO DOSSI√â (IMPEDE O BOT√ÉO DE PISCAR)
    // ============================================================
    window.isDossieEditMode = false; 
    window.activeMicaId = null;

    // A. Esconder IMEDIATAMENTE o contentor de bot√µes de edi√ß√£o (+ Micas)
    const dossieEditActions = document.getElementById('dossie-edit-actions');
    if (dossieEditActions) {
        dossieEditActions.style.display = 'none';
    }

    // B. Resetar o bot√£o de altern√¢ncia "Editar"
    const dossieEditBtn = document.getElementById('toggle-dossie-edit-btn');
    if (dossieEditBtn) {
        dossieEditBtn.textContent = "Editar";
        dossieEditBtn.style.display = 'block';
        dossieEditBtn.style.color = "";
        dossieEditBtn.style.borderColor = "";
        dossieEditBtn.style.backgroundColor = "";
    }
    
    // C. Esconder bot√µes de navega√ß√£o interna
    const micaBackBtn = document.getElementById('mica-back-btn');
    const micaAddBtn = document.getElementById('mica-add-content-btn');
    if (micaBackBtn) micaBackBtn.style.display = 'none';
    if (micaAddBtn) micaAddBtn.style.display = 'none';

    // D. Limpar o t√≠tulo visual
    const dossieTitle = document.getElementById('dossie-view-title');
    if (dossieTitle) dossieTitle.textContent = "Micas";

    // E. Limpar a lista visual para n√£o mostrar as micas da nota anterior
    const dossieContainer = document.getElementById('dossie-list-container');
    if (dossieContainer) dossieContainer.innerHTML = '';
}




async function showReferencesPanel(entityId, entityName, entityType, anexoId = null) {
    // 1. Ajustes de Interface para Mobile
    if (window.innerWidth <= 768) {
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
            document.activeElement.blur();
        }
    }

    // 2. Gravar estado anterior e limpar UI
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI(); 

    // --- MODO AQU√ÅRIO ---
    const aquariumEnv = document.getElementById('aquarium-environment');
    const refPanel = document.getElementById('references-panel');

    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        refPanel.classList.add('aquarium-overlay-mode');
        aquariumEnv.appendChild(refPanel);

        aquariumEnv.classList.add('right-open');


    } else {
        refPanel.classList.remove('aquarium-overlay-mode');
        const mainContainer = document.querySelector('.notebook-container');
        if (mainContainer && refPanel.parentElement !== mainContainer) {
            mainContainer.appendChild(refPanel);
        }
    }

    // 3. Definir Entidade Ativa
    activeReferenceEntity = { 
        id: entityId || entityName, 
        type: entityType, 
        name: entityName 
    };

    // 4. Mostrar Painel
    notebookContainer.classList.add('references-panel-visible');

    // 5. Reset de Abas (Abre sempre no Puzzle)
    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    const puzzleTab = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTab) puzzleTab.classList.add('active');

    const contentPuzzle = document.getElementById('ref-content-puzzle');
    const contentRefs = document.getElementById('ref-content-references');
    
    if (contentPuzzle) contentPuzzle.style.display = 'flex';
    if (contentRefs) contentRefs.style.display = 'none';

    // 6. CONFIGURAR T√çTULO E DESCRI√á√ÉO
    const titleEl = document.getElementById('references-panel-title');
    const descElement = document.getElementById('references-panel-description');
    
    // Define t√≠tulo inicial padr√£o
    if (titleEl) titleEl.textContent = `Refer√™ncias: ${entityName}`;
    
    // --- L√ìGICA DO √çCONE DE MARCADOR (üîñ) ---
    // Se for texto b√≠blico, verifica se tem marcadores para adicionar o √≠cone
    if (entityType === 'textobiblico') {
        // Tenta obter ID real se n√£o tiver
        let realId = entityId;
        if (!realId) {
            // Se veio sem ID (ex: clique no texto da nota), tenta encontrar no cache ou BD
            const cached = allEntities['textobiblico']?.find(e => e.nome === entityName);
            realId = cached ? cached.id : null;
        }

        if (realId) {
            // Importa√ß√£o din√¢mica para garantir acesso
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Busca o documento para ver os marcadores
            try {
                const docRef = doc(db, 'textosbiblicos', realId);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    const marcadores = data.marcadoresAssociados || {};
                    const hasBookmarks = Object.keys(marcadores).length > 0;
                    
                    if (hasBookmarks) {
                        titleEl.textContent = `Refer√™ncias: üîñ ${entityName}`;
                    }
                    
                    // Atualiza o ID global caso estivesse em falta
                    activeReferenceEntity.id = realId;
                }
            } catch (e) {
                console.warn("Erro ao verificar marcadores:", e);
            }
        }
    }

    // 7. CONFIGURAR BOT√ïES
    const editBtn = document.getElementById('references-edit-btn');
    const anchorBtn = document.getElementById('references-anchor-btn'); 
    const wolBtn = document.getElementById('references-wol-btn');
    const bookmarkBtn = document.getElementById('references-bookmark-btn');
    
    if (editBtn) editBtn.style.display = 'block';
    if (wolBtn) wolBtn.style.display = 'none';
    if (bookmarkBtn) bookmarkBtn.style.display = 'none';

    const noAnchorTypes = ['textobiblico', 'topico', 'destaque', 'marcadores', 'tag'];

    if (anchorBtn) {
        if (noAnchorTypes.includes(entityType)) {
            anchorBtn.style.display = 'none'; 
        } else {
            anchorBtn.style.display = 'block'; 
        }
    }

    // 8. ROTEAMENTO DE CONTE√öDO
    if (entityType === 'topico' || entityType === 'textobiblico') {
        if (entityType === 'textobiblico') {
            if (editBtn) editBtn.style.display = 'none'; 
            if (wolBtn) wolBtn.style.display = 'block';
            if (bookmarkBtn) bookmarkBtn.style.display = 'block';
            
            if (descElement) {
                descElement.innerHTML = `<em>A consultar biblioteca...</em>`;
                const texto = await fetchBibleText(entityName);
                descElement.innerHTML = texto ? `<div style="color:var(--text-color); font-size:0.95em;">"${texto}"</div>` : `<em>Texto n√£o dispon√≠vel.</em>`;
            }
        }
        renderTopicResultsList(entityId, entityType); 
    } 
    else {
        if (entityType === 'tag') {
            showTagReferencesPanel(entityName); 
            return;
        }

        renderUniversalTextSearch(entityName);
        
        if (descElement) {
            try {
                const coll = getCollectionFromType(entityType);
                if (coll && entityId) {
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    const docSnap = await getDoc(doc(db, coll, entityId));
                    if (docSnap.exists()) {
                        descElement.textContent = docSnap.data().descricao || 'Sem descri√ß√£o definida.';
                    } else {
                        descElement.textContent = 'Sem descri√ß√£o.';
                    }
                }
            } catch(e) { 
                descElement.textContent = 'Sem descri√ß√£o.'; 
            }
        }
    }

    loadPuzzleData(entityId, entityType);
}



// 2. BUSCAR TEXTO NA BIBLIOTECA P√öBLICA (COMUM)
async function fetchBibleText(fullReference) {
    try {
        const q = query(collection(db, 'bible_verses_public'), where('nome', '==', fullReference));
        const snap = await getDocs(q);
        if (!snap.empty) {
            return snap.docs[0].data().texto;
        }
    } catch (e) { console.error("Erro na bibl. p√∫blica:", e); }
    return null;
}

// 3. GRAVA√á√ÉO P√öBLICA + PRIVADA
async function saveTextToFirestore(name, text) {
    try {
        // Grava no P√∫blico (Texto para todos)
        const publicRef = collection(db, 'bible_verses_public');
        const qPub = query(publicRef, where('nome', '==', name));
        const snapPub = await getDocs(qPub);
        if (snapPub.empty) {
            await addDoc(publicRef, { nome: name, texto: text, contribuidoPor: auth.currentUser.uid, createdAt: serverTimestamp() });
        }

        // Grava no Privado (Cria entrada para o utilizador ter o seu pr√≥prio Puzzle)
        const userColl = collection(db, 'textosbiblicos');
        const qUser = query(userColl, where('nome', '==', name), where('userId', '==', auth.currentUser.uid));
        const snapUser = await getDocs(qUser);
        if (snapUser.empty) {
            await addDoc(userColl, { nome: name, descricao: text, userId: auth.currentUser.uid, createdAt: serverTimestamp(), referencias: {} });
        }
        
        if (typeof fetchAllEntities === 'function') fetchAllEntities();
    } catch (e) { console.error("Erro ao salvar:", e); }
}

// Prompt manual
window.manualInsertBibleText = async function(name) {
    const text = prompt(`Copie o texto e cole aqui para ficar dispon√≠vel na biblioteca comum (${name}):`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        showReferencesPanel(null, name, 'textobiblico');
    }
};



window.manualInsertBibleText = async function(name) {
    const text = prompt(`Digite ou cole o texto de ${name}:`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        // Recarrega o painel
        showReferencesPanel(null, name, 'textobiblico');
    }
};

// ============================================================
// 3. INSER√á√ÉO MANUAL E GRAVA√á√ÉO DEFINITIVA
// ============================================================
window.manualInsertBibleText = async function(name) {
    const text = prompt(`Digite ou cole o texto de ${name}:`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        // Recarrega o painel para exibir o texto gravado
        showReferencesPanel(null, name, 'textobiblico');
    }
};


window.manualInsertBibleText = async function(name) {
    const text = prompt(`Copie o texto da B√≠blia Online e cole aqui (${name}):`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        showReferencesPanel(null, name, 'textobiblico');
    }
};


async function hideReferencesPanel() {
    const refPanel = document.getElementById('references-panel');
    const mainContainer = document.querySelector('.notebook-container');
    
    // --- CORRE√á√ÉO AQUI: Definir a vari√°vel que faltava ---
    const aquariumEnv = document.getElementById('aquarium-environment'); 
    // ----------------------------------------------------

    // 1. Grava o puzzle anterior se estivesse em modo edi√ß√£o
    if (typeof forceSaveAndClosePuzzleMode === 'function') {
        await forceSaveAndClosePuzzleMode();
    }

    // 2. RESET DO DOSSI√â
    window.isDossieEditMode = false;
    window.activeMicaId = null; 
    if (typeof window.renderDossie === 'function') {
        window.renderDossie();
    }

    // --- CORRE√á√ÉO DO AQU√ÅRIO ---
    // Verifica se estava em modo Overlay (Aqu√°rio)
    if (refPanel.classList.contains('aquarium-overlay-mode')) {
        // Remove a classe que for√ßa a posi√ß√£o fixa na direita
        refPanel.classList.remove('aquarium-overlay-mode');
        
        // --- AGORA J√Å FUNCIONA: Remove a margem do texto ---
        if (aquariumEnv) {
            aquariumEnv.classList.remove('right-open');
        }
        
        // Devolve o painel √† estrutura principal do site (sai do #aquarium-environment)
        if (mainContainer && !mainContainer.contains(refPanel)) {
            mainContainer.appendChild(refPanel);
        }
    }
    // ---------------------------

    // 3. L√≥gica padr√£o de fecho (CSS)
    notebookContainer.classList.remove('references-panel-visible');
    
    // Limpar Vers√≠culo Selecionado
    currentlyOpenVerseName = null;
    document.querySelectorAll('.bible-grid-btn.active-verse').forEach(btn => {
        btn.classList.remove('active-verse');
    });

    const descriptionElement = document.getElementById('references-panel-description');
    if (descriptionElement) {
        descriptionElement.textContent = '';
    }

    // Ajuste de altura para Mobile (Reset do arraste)
    if (window.innerWidth <= 768 && refPanel) {
        setTimeout(() => {
            refPanel.style.height = "60vh"; 
        }, 400);
    }
}

 function generateReferenceContext(noteContent, entityName) {
    // 1. Criar um contentor tempor√°rio
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = noteContent;

    // SEPARADOR M√ÅGICO
    const SEPARATOR = " ||| "; 

    // 2. ESTRAT√âGIA DE INJE√á√ÉO MELHORADA
    
    // A. Substituir quebras de linha manuais (<br>) pelo separador
    const brs = tempDiv.querySelectorAll('br');
    brs.forEach(br => {
        br.replaceWith(document.createTextNode(SEPARATOR));
    });

    // B. Injetar separador no IN√çCIO de cada bloco
    // Isto resolve o problema "fiel[NOVA LINHA]David". 
    // Ao p√¥r no in√≠cio da div do "David", garantimos "fiel ||| David".
    const blockTags = 'p, div, li, h1, h2, h3, h4, h5, h6, tr, td, th, blockquote, ul, ol, pre, section, article';
    const blocks = tempDiv.querySelectorAll(blockTags);
    
    blocks.forEach(el => {
        // Prepend (Inserir antes do primeiro filho)
        el.insertBefore(document.createTextNode(SEPARATOR), el.firstChild);
        
        // (Opcional) Tamb√©m adicionar ao fim para garantir isolamento total
        el.appendChild(document.createTextNode(SEPARATOR));
    });

    // 3. EXTRAIR TEXTO (Agora "David" est√° protegido por separadores)
    let plainText = tempDiv.textContent;
    
    // Normalizar espa√ßos
    plainText = plainText.replace(/\s+/g, ' ');

    // 4. ENCONTRAR A ENTIDADE
    const lowerText = plainText.toLowerCase();
    const lowerEntity = entityName.toLowerCase();
    const position = lowerText.indexOf(lowerEntity);

    if (position === -1) {
        return '<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>';
    }

    // 5. DELIMITAR IN√çCIO (Recuar at√© Pontua√ß√£o ou Separador)
    const textBefore = plainText.substring(0, position);
    const lastSeparatorIndex = textBefore.lastIndexOf(SEPARATOR);
    
    // Regex para √∫ltima pontua√ß√£o (., !, ?) seguida de espa√ßo
    const punctuationMatch = textBefore.match(/([.!?])\s+(?!.*[.!?])/); 
    const lastPunctuationIndex = punctuationMatch ? punctuationMatch.index + 1 : -1;

    let start = 0;
    // Quem estiver mais perto da palavra (maior √≠ndice) ganha
    if (lastSeparatorIndex > lastPunctuationIndex) {
        start = lastSeparatorIndex + SEPARATOR.length;
    } else if (lastPunctuationIndex > -1) {
        start = lastPunctuationIndex + 1;
    }

    // 6. DELIMITAR FIM (Avan√ßar at√© Pontua√ß√£o ou Separador)
    // AQUI √â QUE A M√ÅGICA ACONTECE PARA O SEU EXEMPLO
    
    // A. Separador depois da palavra
    let nextSeparatorIndex = plainText.indexOf(SEPARATOR, position + entityName.length);
    if (nextSeparatorIndex === -1) nextSeparatorIndex = plainText.length;

    // B. Pontua√ß√£o depois da palavra
    const textAfter = plainText.substring(position + entityName.length);
    const nextPunctuationMatch = textAfter.match(/[.!?]/);
    
    let nextPunctuationIndex = plainText.length;
    if (nextPunctuationMatch) {
        nextPunctuationIndex = position + entityName.length + nextPunctuationMatch.index + 1;
    }

    // Regra: O que aparecer PRIMEIRO corta a frase.
    // No seu exemplo: N√£o h√° pontua√ß√£o, mas h√° o SEPARATOR do "David". O SEPARATOR ganha.
    let end = Math.min(nextSeparatorIndex, nextPunctuationIndex);

    // 7. CORTE FINAL E LIMPEZA
    let snippet = plainText.substring(start, end).trim();

    // Remove qualquer lixo de separador que tenha sobrado
    snippet = snippet.split(SEPARATOR)[0].trim(); // Seguran√ßa extra
    snippet = snippet.replace(/\|\|\|/g, '').trim();

    // Corte de seguran√ßa para textos gigantes
    if (snippet.length > 250) {
        const localPos = snippet.toLowerCase().indexOf(lowerEntity);
        const cutStart = Math.max(0, localPos - 60);
        const cutEnd = Math.min(snippet.length, localPos + entityName.length + 100);
        snippet = (cutStart > 0 ? "..." : "") + snippet.substring(cutStart, cutEnd) + "...";
    }

    // 8. HIGHLIGHT
    const safeEntity = entityName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedText = snippet.replace(
        new RegExp(`(${safeEntity})`, 'gi'), 
        `<mark>$1</mark>`
    );

    return `<p>${highlightedText}</p>`;
}

// ====================================================================
// FUN√á√ÉO: CONVERTER SELE√á√ÉO EM CART√ÉO WEB (Com Timeout de 10s)
// ====================================================================
async function convertSelectionToUrlCard() {
    let selection = window.getSelection();
    
    // --- 1. SMART SELECT (Corre√ß√£o para o seu problema) ---
    // Se n√£o houver nada selecionado (cursor apenas a piscar),
    // ou se estivermos dentro de um link, vamos tentar selecionar o elemento todo.
    
    const anchorNode = selection.anchorNode ? (selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode) : null;
    const linkElement = anchorNode ? anchorNode.closest('a') : null;

    if (linkElement) {
        // Se o cursor estiver dentro de um <a>, seleciona o <a> inteiro
        const range = document.createRange();
        range.selectNode(linkElement);
        selection.removeAllRanges();
        selection.addRange(range);
    } 
    else if (selection.isCollapsed && anchorNode) {
        // Se for texto solto (n√£o link) e n√£o houver sele√ß√£o,
        // tenta selecionar a "palavra" inteira onde o cursor est√° (o URL gigante)
        if (selection.modify) {
            selection.modify('move', 'backward', 'word');
            selection.modify('extend', 'forward', 'word');
        }
    }
    // -----------------------------------------------------

    if (!selection.rangeCount) return;

    // Guardar o texto para usar como t√≠tulo se necess√°rio
    const userSelectedText = selection.toString().trim();

    // 2. Obter URL
    let url = userSelectedText;
    
    // Se acab√°mos de selecionar um elemento <a>, usamos o href real
    if (selection.anchorNode) {
        const parentA = selection.anchorNode.parentElement.closest('a');
        if (parentA) url = parentA.href;
    }

    if (!url || !url.includes('.')) { 
        alert("Selecione um link v√°lido primeiro."); 
        return; 
    }

    if (!url.startsWith('http')) url = 'https://' + url;

    // 3. Criar Placeholder
    const cardId = `card_${Date.now()}`;
    
    // NOTA: Adicionamos um espa√ßo &nbsp; no fim para o cursor poder sair do card
    const cardHtml = `
        <div class="url-card-widget" id="${cardId}" draggable="true" contenteditable="false" data-original-url="${url}">
            <div class="url-card-loading">
                <div class="spinner" style="width:20px; height:20px; border-width:2px; margin-right:10px;"></div>
                A gerar...
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        </div><span>&nbsp;</span>
    `;

    // 4. SUBSTITUI√á√ÉO TOTAL
    // Como garantimos a sele√ß√£o no passo 1, este comando vai apagar o texto do link
    // e colocar o card no lugar dele.
    document.execCommand('insertHTML', false, cardHtml);
    
    // Esconder popup se estiver aberto
    if(document.getElementById('selection-popup')) 
        document.getElementById('selection-popup').style.display = 'none';

    // --- FUN√á√ïES AUXILIARES (Mant√™m-se iguais) ---
    const getRandomImage = () => {
        const images = [
            "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=400&q=80",
            "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=400&q=80",
            "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=400&q=80",
            "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&q=80",
            "https://images.unsplash.com/photo-1506259091721-347f7d3bbcff?w=400&q=80"
        ];
        return images[Math.floor(Math.random() * images.length)];
    };

    const formatFallbackTitle = (link) => {
        if (userSelectedText && userSelectedText !== link && !userSelectedText.startsWith('http')) {
            return userSelectedText;
        }
        try {
            const urlObj = new URL(link);
            if (urlObj.hostname.includes('jw.org') || urlObj.hostname.includes('wol.jw')) {
                return "Publica√ß√£o JW";
            }
            return urlObj.hostname.replace('www.', '');
        } catch (e) { return "Liga√ß√£o Externa"; }
    };

    const updateCardUI = (title, image, logo, publisher) => {
        const cardEl = document.getElementById(cardId);
        if (!cardEl) return;

        let displayTitle = title;
        if (!displayTitle || displayTitle.toLowerCase() === 'finder' || displayTitle.toLowerCase() === 'watchtower online library') {
            displayTitle = null;
        }
        if (!displayTitle && userSelectedText && !userSelectedText.startsWith('http')) {
            displayTitle = userSelectedText;
        }
        if (!displayTitle) {
            displayTitle = formatFallbackTitle(url);
        }

        cardEl.innerHTML = `
            <div class="url-card-image" style="background-image: url('${image}');"></div>
            <div class="url-card-info">
                <div class="url-card-title">${displayTitle}</div>
                <div class="url-card-domain">
                    <img src="${logo}" style="width:12px; height:12px; vertical-align:middle; margin-right:4px; border-radius:50%;">
                    ${publisher}
                </div>
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        `;
        saveNote();
    };

    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
    const fetchPromise = fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`).then(res => res.json());

    try {
        const data = await Promise.race([fetchPromise, timeoutPromise]);
        const meta = (data.status === 'success' && data.data) ? data.data : {};
        
        const finalTitle = meta.title;
        const finalImage = meta.image?.url || getRandomImage();
        const finalPublisher = meta.publisher || new URL(url).hostname;
        const finalLogo = meta.logo?.url || 'https://cdn-icons-png.flaticon.com/128/1006/1006771.png';

        updateCardUI(finalTitle, finalImage, finalLogo, finalPublisher);
    } catch (err) {
        const fallbackTitle = formatFallbackTitle(url);
        const fallbackImg = getRandomImage();
        const domain = new URL(url).hostname;
        const fallbackLogo = 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
        updateCardUI(fallbackTitle, fallbackImg, fallbackLogo, domain);
    }
}

// --- L√ìGICA DO EDITOR RICO E TAGS ---

function showTagPopup(query) {
    const filteredTags = allTags.filter(tag => tag.nome.toLowerCase().includes(query.toLowerCase()));
    tagSuggestionList.innerHTML = '';
    if (filteredTags.length > 0) {
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag.nome;
            li.dataset.tagNome = tag.nome;
            tagSuggestionList.appendChild(li);
        });
    } else if (query) {
        const li = document.createElement('li');
        li.innerHTML = `Criar nova tag: "<strong>${query}</strong>"`;
        li.dataset.tagNome = query;
        tagSuggestionList.appendChild(li);
    } else {
         hideTagPopup(); return;
    }
    const rect = currentTagQueryRange.getBoundingClientRect();
    tagSuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
    tagSuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
    tagSuggestionPopup.style.display = 'block';
    isTagPopupOpen = true;
    tagSuggestionList.firstChild.classList.add('selected');
}

 function hideTagPopup() {
    tagSuggestionPopup.style.display = 'none';
    isTagPopupOpen = false;
    currentTagQueryRange = null; // Importante: limpa o range para evitar reaberturas acidentais
}


function navigateTagSuggestions(key) {
    const items = Array.from(tagSuggestionList.children);
    if(items.length === 0) return;
    const selected = tagSuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

async function commitTagSelection() {
    const selectedLi = tagSuggestionList.querySelector('.selected');
    if (!selectedLi) {
        hideTagPopup();
        return;
    }

    const tagName = selectedLi.dataset.tagNome.trim();
    if (!tagName) { 
        hideTagPopup(); 
        return; 
    }

    // Verifica/Cria a tag no banco de dados
    let tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tagExists) await createNewTag(tagName);

    // Insere no editor
    insertTagIntoEditor(tagName);
    
    // FOR√áA O FECHO IMEDIATO
    hideTagPopup();
}

async function createNewTag(tagName) {
    try {
        // Verifica se a tag j√° existe na lista LOCAL (que j√° √© filtrada por user)
        // para evitar chamadas desnecess√°rias √† base de dados.
        const tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
        
        if (tagExists) {
            return;
        }

        const tagsCollection = collection(db, 'tags');
        const newTagRef = await addDoc(tagsCollection, { 
            nome: tagName, 
            userId: auth.currentUser.uid, // GRAVA√á√ÉO DO USER ID
            createdAt: serverTimestamp() 
        });
        
        // Atualiza o cache local imediatamente
        allTags.push({ id: newTagRef.id, nome: tagName });

    } catch (error) { 
        console.error("Erro ao criar nova tag:", error); 
    }
}


async function fetchAllTags() {
    if (!auth.currentUser) return;
    try {
        const tagsCollection = collection(db, 'tags');
        // FILTRO OBRIGAT√ìRIO
        const q = query(tagsCollection, where('userId', '==', auth.currentUser.uid));
        
        const tagsSnapshot = await getDocs(q);
        
        // Limpa e reconstr√≥i o array global
        allTags = tagsSnapshot.docs.map(doc => ({
            id: doc.id,
            nome: doc.data().nome || doc.data().name 
        })).filter(tag => tag.nome); // Filtra tags sem nome
        
    } catch (error) {
        console.error("Erro ao carregar tags:", error);
    }
}


function insertTagIntoEditor(tagName) {
    if (!currentTagQueryRange) return;

    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = `#${tagName}`;
    tagSpan.setAttribute('contenteditable', 'false'); 
    const spaceNode = document.createTextNode('\u00A0');
    currentTagQueryRange.deleteContents();
    currentTagQueryRange.insertNode(spaceNode); 
    currentTagQueryRange.insertNode(tagSpan);  
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
    currentTagQueryRange = null;
}



// ============================================================
// L√ìGICA DE NAVEGA√á√ÉO MOBILE
// ============================================================

// 1. Ao clicar numa PASTA (Esquerda -> Meio)
// Adicione isto ao seu listener existente do 'leftPanelList' ou use este auxiliar:
const originalLeftClick = leftPanelList.onclick; // Preserva l√≥gica antiga se existir
leftPanelList.addEventListener('click', (e) => {
    const item = e.target.closest('.list-item');
    if (!item) return;
    
    // Se for clique em menu ou expandir, ignora
    if (e.target.closest('.item-menu-btn')) return;

    // Se a largura for mobile, avan√ßa para o painel do meio
    if (window.innerWidth <= 768) {
        document.body.classList.add('mobile-view-middle');
        document.body.classList.remove('mobile-view-editor');
    }
});



// 3. Bot√£o VOLTAR (Corre√ß√£o: Refer√™ncia Global + Clique √önico)
// Certifique-se que n√£o apaga a linha 'const backBtn = ...' no in√≠cio do script

if (backBtn) {
    backBtn.onclick = () => {
        // A√ß√£o encapsulada para verificar altera√ß√µes n√£o guardadas antes de retroceder
        const goBackAction = () => {
            
            // CASO 1: Navega√ß√£o Profunda (Pastas ou B√≠blia)
            if (navigationStack.length > 0) {
                // Remove o √∫ltimo n√≠vel da pilha (ex: sai do Cap√≠tulo para o Livro)
                navigationStack.pop();
                
                // Limpa a nota selecionada para resetar o estado visual do editor
                selectedNoteId = null;
                
                // No Mobile: Se a pilha ficar vazia, voltamos ao Painel Esquerdo (Pastas/Categorias)
                if (navigationStack.length === 0 && window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.remove('mobile-view-editor');
                }
                
                // Atualiza a vista dos pain√©is com base no novo estado da stack
                // O par√¢metro 'true' mant√©m o editor aberto se houver conte√∫do
                updateNavigationView(true);
            } 
            
            // CASO 2: Sair do modo "Partilha" para o modo "Local"
            // Se estivermos na raiz da partilha, o bot√£o voltar regressa √†s pastas locais
            else if (currentViewMode === 'shared') {
                
                // Fun√ß√£o global que j√° limpa ouvintes e reseta a stack
                if (typeof window.switchFolderView === 'function') {
                    window.switchFolderView('local');
                }
                
                // No Mobile: Garante que volta para a vis√£o da barra lateral esquerda
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                }
            }
        };

        // Executa o Gatekeeper de grava√ß√£o antes de realizar a navega√ß√£o
        if (typeof navigateWithUnsavedCheck === 'function') {
            navigateWithUnsavedCheck(goBackAction);
        } else {
            // Fallback caso a fun√ß√£o de prote√ß√£o n√£o esteja dispon√≠vel
            goBackAction();
        }
    };
}

// 4. Bot√£o VOLTAR do Editor (Direita -> Meio)
 if (mobileBackBtn) {
    // Removemos ouvintes antigos para evitar duplica√ß√£o
    const newMobileBtn = mobileBackBtn.cloneNode(true);
    mobileBackBtn.parentNode.replaceChild(newMobileBtn, mobileBackBtn);

    newMobileBtn.addEventListener('click', async (e) => {
        e.preventDefault(); 
        
        // 1. Grava o estado atual da nota antes de sair
        if (typeof saveNote === 'function' && selectedNoteId) {
            await saveNote(true); 
        }

        // 2. Ativa o escudo para impedir grava√ß√µes acidentais durante o fecho
        isClosingNote = true; 

        // 3. Limpa timers pendentes
        if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);

        const idToScroll = selectedNoteId;
        selectedNoteId = null;

        // 4. Limpa o visual do editor
        const titleInput = document.getElementById('note-title-input');
        const contentEditor = document.getElementById('note-content-editor');
        if (titleInput) titleInput.value = "";
        if (contentEditor) contentEditor.innerHTML = "";

        // 5. TROCA DE VISTAS (CORRIGIDA PARA FLASH)
        const container = document.querySelector('.notebook-container');
        if (container) container.classList.remove('middle-panel-collapsed');
        
        // Sai sempre do editor
        document.body.classList.remove('mobile-view-editor');

        if (currentViewMode === 'flash') {
            // --- MODO FLASH: VAI PARA A COLUNA 1 ---
            // Remover a classe 'mobile-view-middle' faz o CSS mostrar o #left-panel
            document.body.classList.remove('mobile-view-middle');
            
            // Scroll na lista da ESQUERDA
            if (idToScroll) {
                setTimeout(() => {
                    const noteItem = document.querySelector(`#left-panel-list .list-item[data-id="${idToScroll}"]`);
                    if (noteItem) noteItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 150);
            }
        } else {
            // --- MODO NORMAL: VAI PARA A COLUNA 2 ---
            document.body.classList.add('mobile-view-middle');

            // Scroll na lista do MEIO
            if (idToScroll) {
                setTimeout(() => {
                    const noteItem = document.querySelector(`#file-list .list-item[data-id="${idToScroll}"]`);
                    if (noteItem) noteItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 150);
            }
        }

        // 6. ATUALIZA OS BOT√ïES FLUTUANTES
        updateMobileFABVisibility();
    });
}


// ====================================================================
// MOTOR DO CALEND√ÅRIO (Agenda Firebase)
// ====================================================================

// 1. Delegar eventos globais no Editor (porque o HTML √© din√¢mico)
noteContentEditor.addEventListener('click', (e) => {
    // A. Clique no bot√£o de defini√ß√µes (‚öôÔ∏è)
    if (e.target.closest('.cal-settings')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const menu = widget.querySelector('.cal-settings-menu');
        menu.classList.toggle('visible');
    }
 // >>> NOVO BLOCO: ELIMINAR CALEND√ÅRIO <<<
    else if (e.target.classList.contains('cal-delete-btn')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        
        // Pede confirma√ß√£o (pode usar o seu showConfirmation ou o confirm nativo)
        if (confirm("Tem a certeza que deseja eliminar esta agenda?")) {
            widget.remove(); // Remove do DOM
            saveNote();      // Grava a nota sem o calend√°rio
        }
    }
    // >>> FIM DO NOVO BLOCO <<<
    
    // B. Mudar Visualiza√ß√£o (Semana/M√™s/Ano)
    else if (e.target.classList.contains('cal-view-btn')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        // Atualiza bot√µes
        widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        // Atualiza estado e re-renderiza
        widget.dataset.view = e.target.dataset.view;
        renderCalendarUI(widget);
        // Fecha o menu
        widget.querySelector('.cal-settings-menu').classList.remove('visible');
    }

    // C. Navega√ß√£o (‚óÄ / ‚ñ∂)
    else if (e.target.closest('.cal-prev') || e.target.closest('.cal-next')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const isNext = e.target.closest('.cal-next');
        changeCalendarDate(widget, isNext ? 1 : -1);
    }

    // D. Clique num Dia (Adicionar Tarefa)
    else if (e.target.classList.contains('cal-day') && !e.target.classList.contains('empty')) {
        const day = e.target.dataset.day;
        const widget = e.target.closest('.jwn-calendar-widget');
        const month = parseInt(widget.dataset.month); // 0-11
        const year = parseInt(widget.dataset.year);
        
        // Formata data ISO (YYYY-MM-DD)
        const dateObj = new Date(year, month, parseInt(day));
        // Ajuste fuso hor√°rio simples
        const dateISO = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

        openCalendarModal(dateISO, widget);
    }
});

// 2. Fun√ß√£o Principal de Renderiza√ß√£o
async function renderCalendarUI(widget) {
    if (!widget) return;

    const view = widget.dataset.view || 'month';
    const month = parseInt(widget.dataset.month);
    const year = parseInt(widget.dataset.year);
    const grid = widget.querySelector('.cal-grid');
    const title = widget.querySelector('.cal-title');

    // Limpa a grelha visualmente
    grid.innerHTML = ''; 

    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    // --------------------------------------------------------
    // VISTA: M√äS (Padr√£o)
    // --------------------------------------------------------
    if (view === 'month') {
        title.textContent = `${monthNames[month]} ${year}`;
        
        // Reset do CSS da grelha para 7 colunas
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(7, 1fr)";
        grid.style.gap = "2px";

        // 1. Carregar tarefas do Firebase
        const tasksMap = await fetchTasksForMonth(year, month);

        // Cabe√ßalhos
        const days = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        days.forEach(d => grid.innerHTML += `<div class="cal-day-header">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // Espa√ßos vazios
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div class="cal-day empty"></div>`;
        }

        // Dias
        for (let i = 1; i <= daysInMonth; i++) {
            // FORMATA√á√ÉO CR√çTICA (YYYY-MM-DD)
            const dayStr = String(i).padStart(2, '0');
            const monthStr = String(month + 1).padStart(2, '0');
            const dateKey = `${year}-${monthStr}-${dayStr}`; 
            
            const isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear());
            const hasTask = tasksMap[dateKey] === true;

            const div = document.createElement('div');
            div.className = `cal-day ${isToday ? 'today' : ''} ${hasTask ? 'has-task' : ''}`;
            div.textContent = i;
            div.dataset.day = i;
            
            if (hasTask) {
                div.title = "Ver tarefas";
            }
            
            grid.appendChild(div);
        }
    } 
    
    // --------------------------------------------------------
    // VISTA: ANO (Sele√ß√£o de Meses)
    // --------------------------------------------------------
    else if (view === 'year') {
        title.textContent = `${year}`;
        
        // Ajusta grelha para 3 colunas (4 linhas de meses)
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(3, 1fr)";
        grid.style.gap = "10px";
        
        monthNames.forEach((mName, idx) => {
            const btn = document.createElement('div');
            btn.className = 'cal-day'; 
            btn.style.padding = "15px 0"; // Bot√µes maiores
            btn.textContent = mName.substring(0, 3); // Jan, Fev...
            
            // Marca o m√™s atual se estivermos no ano corrente
            const now = new Date();
            if (now.getFullYear() === year && now.getMonth() === idx) {
                btn.classList.add('today');
            }

            btn.onclick = (e) => {
                e.stopPropagation();
                // Muda para a vista do m√™s selecionado
                widget.dataset.month = idx;
                widget.dataset.view = 'month';
                
                // Atualiza visual dos bot√µes de topo
                widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
                widget.querySelector('[data-view="month"]').classList.add('active');
                
                renderCalendarUI(widget);
            };
            grid.appendChild(btn);
        });
    }

    // --------------------------------------------------------
    // VISTA: SEMANA (Simplificada)
    // --------------------------------------------------------
    else if (view === 'week') {
        title.textContent = `Semana em ${monthNames[month]}`;
        
        grid.style.display = "flex";
        grid.style.flexDirection = "column";
        grid.style.gap = "5px";

        // Carrega tarefas para mostrar resumo
        const tasksMap = await fetchTasksForMonth(year, month);

        // L√≥gica: Mostra a semana atual (se for o m√™s corrente) ou a primeira semana
        let startDay = 1;
        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth()) {
            // Se for hoje, tenta come√ßar a semana no Domingo anterior
            startDay = today.getDate() - today.getDay(); 
            if (startDay < 1) startDay = 1;
        }

        const endDay = Math.min(startDay + 6, new Date(year, month + 1, 0).getDate());

        for (let i = startDay; i <= endDay; i++) {
            const dayStr = String(i).padStart(2, '0');
            const monthStr = String(month + 1).padStart(2, '0');
            const dateKey = `${year}-${monthStr}-${dayStr}`;
            const hasTask = tasksMap[dateKey] === true;
            
            // Cria uma linha por dia
            const row = document.createElement('div');
            row.className = 'cal-day'; // Reusa estilo base
            row.style.width = "100%";
            row.style.textAlign = "left";
            row.style.padding = "8px 15px";
            row.style.display = "flex";
            row.style.justifyContent = "space-between";
            
            // Conte√∫do
            let taskIndicator = hasTask ? '<span style="color:#e74c3c;">‚Ä¢ Tarefas</span>' : '<span style="color:#666; font-size:0.8em;">Vazio</span>';
            
            row.innerHTML = `<span>Dia ${i}</span> ${taskIndicator}`;
            row.dataset.day = i; // Permite clicar para abrir modal

            grid.appendChild(row);
        }
    }
}


// 3. Navega√ß√£o
function changeCalendarDate(widget, direction) {
    let m = parseInt(widget.dataset.month);
    let y = parseInt(widget.dataset.year);
    const view = widget.dataset.view;

    if (view === 'year') {
        y += direction;
    } else {
        m += direction;
        if (m > 11) { m = 0; y++; }
        if (m < 0) { m = 11; y--; }
    }

    widget.dataset.month = m;
    widget.dataset.year = y;
    renderCalendarUI(widget);
}

// 4. Integra√ß√£o Firebase (Buscar Tarefas)
async function fetchTasksForMonth(year, month) {
    if (!auth.currentUser) return {};

    // Formata o in√≠cio e fim do m√™s garantindo os zeros (01, 05, etc.)
    // M√™s em JS √© 0-11, por isso somamos 1
    const mStr = String(month + 1).padStart(2, '0');
    const startStr = `${year}-${mStr}-01`;
    const endStr = `${year}-${mStr}-31`;

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'agenda'),
            where('userId', '==', auth.currentUser.uid),
            where('data', '>=', startStr),
            where('data', '<=', endStr)
        );

        const snapshot = await getDocs(q);
        const map = {};
        
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.data) {
                map[d.data] = true; // Ex: map['2026-01-12'] = true
            }
        });
        
        return map;
    } catch (e) {
        console.error("Erro ao buscar tarefas:", e);
        return {};
    }
}

// 5. Modal de Tarefas
let currentCalendarWidget = null; 

async function openCalendarModal(dateISO, widget) {
    const modal = document.getElementById('calendar-task-modal');
    const displaySpan = document.getElementById('cal-selected-date-display');
    const isoInput = document.getElementById('cal-selected-date-iso');
    const descInput = document.getElementById('cal-task-desc');
    const existingList = document.getElementById('cal-existing-tasks');
    const saveBtn = document.getElementById('cal-save-task-btn');

    // Seguran√ßa: Se n√£o encontrar os elementos, sai sem erro
    if (!modal || !saveBtn) return;

    // 1. Garante que o modal est√° no DOM (Body) e vis√≠vel
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "10000000"; // Garante que fica no topo

    currentCalendarWidget = widget;
    displaySpan.textContent = dateISO; 
    isoInput.value = dateISO;
    descInput.value = '';
    existingList.innerHTML = 'Carregando...';
    
    descInput.focus();

    // 2. Carregar tarefas existentes desse dia
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'agenda'),
            where('userId', '==', auth.currentUser.uid),
            where('data', '==', dateISO)
        );
        const snap = await getDocs(q);
        
        existingList.innerHTML = '';
        if (snap.empty) {
            existingList.innerHTML = '<small style="color:#888;">Sem tarefas.</small>';
        } else {
            snap.forEach(doc => {
                const task = doc.data();
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid var(--border-color)';
                div.style.padding = '5px';
                div.style.fontSize = '0.9em';
                
                // Bot√£o de apagar tarefa individual
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>‚Ä¢ ${task.descricao}</span>
                        <button onclick="window.deleteCalendarTask('${doc.id}', '${dateISO}')" style="color:#e74c3c; background:none; border:none; cursor:pointer;">√ó</button>
                    </div>`;
                existingList.appendChild(div);
            });
        }
    } catch (e) {
        console.error(e);
        existingList.innerHTML = '<small style="color:red;">Erro ao carregar.</small>';
    }

    // 3. GRAVAR NOVA TAREFA (A CORRE√á√ÉO EST√Å AQUI)
    // Em vez de replaceChild, usamos onclick direto. √â mais seguro.
    saveBtn.onclick = async () => {
        const desc = descInput.value.trim();
        if (!desc) return;

        // Feedback visual
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "A gravar...";
        saveBtn.disabled = true;

        try {
            const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await addDoc(collection(db, 'agenda'), {
                data: dateISO,
                descricao: desc,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            
            modal.style.display = 'none';
            
            // Atualiza o widget para mostrar a bolinha vermelha
            if (currentCalendarWidget && typeof renderCalendarUI === 'function') {
                renderCalendarUI(currentCalendarWidget);
            }
            
        } catch (e) {
            console.error(e);
            alert("Erro ao gravar tarefa.");
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        }
    };
}

// Fun√ß√£o auxiliar para apagar tarefa (j√° inclu√≠da na l√≥gica acima)
window.deleteCalendarTask = async function(taskId, dateISO) {
    if(!confirm("Apagar esta tarefa?")) return;
    try {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        await deleteDoc(doc(db, 'agenda', taskId));
        
        // Recarrega o modal para atualizar a lista
        if (currentCalendarWidget) openCalendarModal(dateISO, currentCalendarWidget);
        
        // Atualiza o calend√°rio atr√°s
        renderCalendarUI(currentCalendarWidget);
    } catch(e) {
        console.error(e);
    }
};

// 6. AUTO-INICIAR CALEND√ÅRIOS AO ABRIR NOTA
// Adicione esta chamada dentro da fun√ß√£o displayNote()
// Logo a seguir a noteContentEditor.innerHTML = conteudo...
function refreshAllCalendars() {
    const calendars = document.querySelectorAll('.jwn-calendar-widget');
    calendars.forEach(cal => renderCalendarUI(cal));
}

// --- NOVAS FUN√á√ïES PARA SUGEST√ÉO DE ENTIDADES ---

function showEntityPopup(query) {
    // Junta todas as entidades de todos os tipos num √∫nico array
    const flatEntities = Object.values(allEntities).flat();
    const filteredEntities = flatEntities.filter(entity => 
        entity.nome.toLowerCase().includes(query.toLowerCase())
    );

    entitySuggestionList.innerHTML = '';
    if (filteredEntities.length > 0) {
        filteredEntities.forEach(entity => {
            const li = document.createElement('li');
            // Guardamos os dados da entidade no elemento li
            li.dataset.entityName = entity.nome;
            li.dataset.entityType = entity.tipo;
            
            // Mostra o nome e o tipo para ser mais f√°cil de identificar
            li.innerHTML = `${entity.nome} <span style="font-size: 0.8em;">[${entity.tipo}]</span>`;
            
            entitySuggestionList.appendChild(li);
        });
        
        const rect = currentEntityQueryRange.getBoundingClientRect();
        entitySuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
        entitySuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
        entitySuggestionPopup.style.display = 'block';
        isEntityPopupOpen = true;
        entitySuggestionList.firstChild.classList.add('selected');
    } else {
        hideEntityPopup();
    }
}

function hideEntityPopup() {
    entitySuggestionPopup.style.display = 'none';
    isEntityPopupOpen = false;
    currentEntityQueryRange = null;
}

function navigateEntitySuggestions(key) {
    const items = Array.from(entitySuggestionList.children);
    if(items.length === 0) return;
    const selected = entitySuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

function insertEntityIntoEditor(entityName, entityType) {
    if (!currentEntityQueryRange) return;

    const entitySpan = document.createElement('span');
    entitySpan.className = 'entity-link';
    entitySpan.dataset.entityType = entityType;
    entitySpan.dataset.entityName = entityName;
    entitySpan.textContent = entityName;
    
    const spaceNode = document.createTextNode('\u00A0');

    // Substitui o texto que o utilizador digitou (ex: @Jeremias)
    currentEntityQueryRange.deleteContents();
    currentEntityQueryRange.insertNode(spaceNode);
    currentEntityQueryRange.insertNode(entitySpan);
    
    // P√µe o cursor a seguir ao espa√ßo, pronto para continuar a escrever
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}

async function commitEntitySelection() {
    const selectedLi = entitySuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    
    const entityName = selectedLi.dataset.entityName;
    const entityType = selectedLi.dataset.entityType;
    
    if (entityName && entityType) {
        // A L√ìGICA DE ATUALIZA√á√ÉO FOI ADICIONADA AQUI
        const collectionName = ENTITY_CONFIG[entityType]?.collection;
        if (collectionName) {
            const allKnownEntities = Object.values(allEntities).flat();
            const entity = allKnownEntities.find(e => e.tipo === entityType && e.nome === entityName);

            if (entity) {
                // Se a entidade foi encontrada no cache, atualiza as suas refer√™ncias no Firestore
                const entityRef = doc(db, collectionName, entity.id);
                try {
                    await updateDoc(entityRef, {
                        [`referencias.${selectedNoteId}`]: true
                    });

                } catch (error) {
                    console.error("Erro ao atualizar refer√™ncia da entidade:", error);
                }
            }
        }

        // Insere o <span> no editor (comportamento visual)
        insertEntityIntoEditor(entityName, entityType);
    }
    
    hideEntityPopup();
}



function escapeStyledElements(event) {
    const selection = window.getSelection();
    if (!selection.isCollapsed || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    // Garante que pegamos o elemento HTML, n√£o o n√≥ de texto
    const parentElement = currentNode.nodeType === Node.TEXT_NODE ? currentNode.parentElement : currentNode;

    // 1. Identifica se estamos dentro de algo "especial"
    // Lista de classes que queremos "escapar"
    let styledContainer = parentElement.closest('.entity-link, .tag, a[data-anexo-id], .idea-span');

    // 2. L√ìGICA DE HIERARQUIA (CRUCIAL):
    // Se encontrarmos uma entidade ou tag, verificamos se ela est√° dentro de um link (Anexo).
    // Se estiver, o "contentor a escapar" deve ser o LINK, n√£o a entidade interna.
    if (styledContainer && (styledContainer.classList.contains('entity-link') || styledContainer.classList.contains('tag'))) {
        const parentLink = styledContainer.closest('a[data-anexo-id]');
        if (parentLink) {
            styledContainer = parentLink;
        }
    }

    if (styledContainer) {
        const isAtTheStart = range.startOffset === 0;
        // Verifica√ß√£o do final do n√≥ de texto atual
        const isAtTheEnd = range.startOffset === currentNode.textContent.length;
        
        const isPrintableChar = (event.key.length === 1 || event.key === 'Enter') && !event.ctrlKey && !event.metaKey && !event.altKey;

        // =========================================================================
        // CEN√ÅRIO 1: Escrever no IN√çCIO do elemento (|Link)
        // =========================================================================
        if (isAtTheStart && isPrintableChar && event.key !== 'Backspace') {

            
            event.preventDefault(); // Impede o navegador de colocar a letra dentro do link

            // Cria o texto digitado e a barreira invis√≠vel
            const typedTextNode = document.createTextNode(event.key);
            const zeroWidthSpace = document.createTextNode('\u200B');
            const parent = styledContainer.parentNode;

            // Insere ANTES do contentor especial
            parent.insertBefore(typedTextNode, styledContainer);
            parent.insertBefore(zeroWidthSpace, styledContainer);

            // Coloca o cursor depois do texto novo (mas antes da barreira)
            // Assim, a pr√≥xima letra continuar√° "fora"
            const newRange = document.createRange();
            newRange.setStartAfter(typedTextNode);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            return;
        }

        // =========================================================================
        // CEN√ÅRIO 2: Escrever no FIM do elemento (Link|)
        // =========================================================================
        if (isAtTheEnd && isPrintableChar) {
            // Verifica se este n√≥ √© realmente o √∫ltimo n√≥ de texto dentro do contentor
            // (Para evitar sair do link se estivermos no meio de uma frase composta, ex: <b>Negrito</b>|Normal)
            const isReallyLastNode = (currentNode === styledContainer.lastChild) || 
                                     (styledContainer.lastChild && currentNode === styledContainer.lastChild.lastChild);
            
            if (isReallyLastNode) {
                
                // Nota: N√£o usamos preventDefault aqui para deixar a letra ser processada,
                // mas movemos o cursor para garantir que ela cai "fora".
                
                const zeroWidthSpace = document.createTextNode('\u200B');
                const parent = styledContainer.parentNode;
                
                // Insere DEPOIS do contentor
                if (styledContainer.nextSibling) {
                    parent.insertBefore(zeroWidthSpace, styledContainer.nextSibling);
                } else {
                    parent.appendChild(zeroWidthSpace);
                }
                
                // Move o cursor para a barreira, FORA do link
                const newRange = document.createRange();
                newRange.setStartAfter(zeroWidthSpace); // P√µe depois da barreira
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                
                // A letra digitada ser√° inserida na nova posi√ß√£o do cursor (fora)
            }
        }
    }
    
    // =========================================================================
    // CEN√ÅRIO 3: Prote√ß√£o contra DELETE (Forward Delete)
    // =========================================================================
    // Impede que, ao clicar "Delete" no fim de um texto normal, se apague a fronteira
    // e o link seguinte seja "sugado" para dentro do texto atual.
    else if (event.key === 'Delete') {
         if (range.startOffset === currentNode.textContent.length) {
            const elementAfter = parentElement.nextElementSibling;
            
            // Se o pr√≥ximo elemento for um dos nossos especiais
            if (elementAfter && elementAfter.matches('.entity-link, .tag, a[data-anexo-id], .idea-span')) {
                event.preventDefault(); // Impede apagar
                
                // Foca no in√≠cio do elemento seguinte em vez de o apagar
                const newRange = document.createRange();
                
                // Tenta encontrar o primeiro n√≥ de texto l√° dentro para p√¥r o cursor
                let targetNode = elementAfter.firstChild;
                while(targetNode && targetNode.firstChild) targetNode = targetNode.firstChild;
                
                if (targetNode) {
                    newRange.setStart(targetNode, 0);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            }
        }
    }
}
    

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
function handleTextSelection() {
    const selectionPopup = document.getElementById('selection-popup');
    const insertionPopup = document.getElementById('insertion-popup');
    
    // 1. VERIFICA√á√ÉO DE TEXTO NORMAL
    const selection = window.getSelection();
    let hasStandardSelection = false;
    
    if (selection && selection.rangeCount > 0 && !selection.isCollapsed) {
        const anchorNode = selection.anchorNode;
        // Garante que o elemento faz parte do editor
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const isInEditor = noteContentEditor.contains(safeNode);
        
        if (isInEditor && selection.toString().trim().length > 0) {
            hasStandardSelection = true;
        }
    }

    // 2. VERIFICA√á√ÉO DE INPUTS
    let hasInputSelection = false;
    const activeEl = document.activeElement;
    if (activeEl && activeEl.tagName === 'INPUT' && activeEl.classList.contains('mini-note-title-input') && noteContentEditor.contains(activeEl)) {
        if (activeEl.selectionStart !== activeEl.selectionEnd) {
            hasInputSelection = true;
        }
    }

    // =========================================================
    // L√ìGICA DE VISIBILIDADE
    // =========================================================

    // A. ESCONDER MENU DE INSER√á√ÉO (üìò) se houver sele√ß√£o
    if (hasStandardSelection || hasInputSelection) {
        if (insertionPopup) insertionPopup.style.display = 'none';
    }

    // B. MOSTRAR/ESCONDER MENU DE FORMATA√á√ÉO (üîó üé¥)
    if (hasStandardSelection) {
        
        // --- L√ìGICA INTELIGENTE DO BOT√ÉO üé¥ (CART√ÉO WEB) ---
        const btnCard = selectionPopup.querySelector('button[data-action="create-url-card"]');
        if (btnCard) {
            const selectedText = selection.toString().trim();
            
            // 1. Verifica se o texto parece um URL (Regex)
            const urlRegex = /^(https?:\/\/|www\.)|[\w-]+\.[a-z]{2,}(\/.*)?$/i;
            const looksLikeUrl = urlRegex.test(selectedText);

            // 2. Verifica se a sele√ß√£o est√° DENTRO de um link <a> existente
            let isInsideLink = false;
            if (selection.anchorNode) {
                const anchorEl = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
                isInsideLink = !!anchorEl.closest('a');
            }

            // Decis√£o: Mostra ou Esconde o üé¥
            if (looksLikeUrl || isInsideLink) {
                btnCard.style.display = 'flex'; // Mostra
            } else {
                btnCard.style.display = 'none'; // Esconde
            }
        }
        // -----------------------------------------------------

       currentSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = currentSelectionRange.getBoundingClientRect();
        
        if (selectionPopup) {
            selectionPopup.style.display = 'flex'; // Mostra primeiro para calcular a largura
            
            // --- C√ÅLCULO DE POSI√á√ÉO INTELIGENTE ---
            const popupWidth = selectionPopup.offsetWidth;
            const windowWidth = window.innerWidth;
            const scrollX = window.scrollX;
            const padding = 10; 

            // 1. Centralizar
            let leftPos = rect.left + (rect.width / 2) - (popupWidth / 2);

            // 2. Limites Ecr√£
            if (leftPos < padding) {
                leftPos = padding;
            } else if (leftPos + popupWidth > windowWidth - padding) {
                leftPos = windowWidth - popupWidth - padding;
            }
            leftPos += scrollX;

            // 3. Vertical (Y)
            const popupHeight = selectionPopup.offsetHeight || 50; 
            const gap = 10; 

            let topPos = (rect.top + window.scrollY) - popupHeight - gap;
            
            // Prote√ß√£o de Topo (se n√£o couber em cima, p√µe em baixo)
            if (rect.top < (popupHeight + gap + 50)) { 
               topPos = rect.bottom + window.scrollY + gap;
            }

            // APLICA AS POSI√á√ïES FINAIS
            selectionPopup.style.top = `${topPos}px`;
            selectionPopup.style.left = `${leftPos}px`;
            selectionPopup.style.zIndex = '2000';
        }
    } 
    // >>> O C√ìDIGO NOVO EST√Å AQUI (O ELSE) <<<
    else {
        // Se N√ÉO houver sele√ß√£o, esconde o popup imediatamente
        if (selectionPopup) {
            selectionPopup.style.display = 'none';
        }
    }
}
// ====================================================================



// ====================================================================
// NAVEGA√á√ÉO MOBILE: FECHAR LISTA AO CLICAR NO VAZIO
// ====================================================================



function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.seconds) {
            return 'Data inv√°lida';
        }
        const date = new Date(timestamp.seconds * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }


  


    /**
     * Exibe o conte√∫do de um backup num modal de visualiza√ß√£o.
     * @param {string} backupId O ID do documento de backup.
     */
 // Torna a fun√ß√£o global para que o HTML (onclick) a encontre
// Torna a fun√ß√£o global para que o atributo onclick do HTML a encontre
window.restoreBackup = async function(backupId) {
    if (!selectedNoteId) return;

    // 1. Pedir confirma√ß√£o ao utilizador
    // Nota: A fun√ß√£o showConfirmation deve estar definida no seu c√≥digo
    const confirmed = await showConfirmation(
        "Restaurar Vers√£o?", 
        "Esta a√ß√£o criar√° uma NOVA nota com o conte√∫do desta vers√£o. A nota que tem aberta agora n√£o ser√° alterada."
    );

    if (!confirmed) return;

    // Feedback visual de processamento
    const historyModal = document.getElementById('history-modal');
    if (historyModal) historyModal.style.opacity = '0.7';

    try {
        // 2. Buscar os dados do backup espec√≠fico
        const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
        const backupSnap = await getDoc(backupRef);
        
        if (!backupSnap.exists()) {
            alert("Erro: O backup selecionado j√° n√£o existe.");
            return;
        }
        
        const backupData = backupSnap.data();

        // 3. Descobrir a pasta pai (parentId) da nota original para colocar a nova nota no mesmo s√≠tio
        const originalNoteRef = doc(db, 'pastas', selectedNoteId);
        const originalSnap = await getDoc(originalNoteRef);
        const parentId = originalSnap.exists() ? originalSnap.data().parentId : null;

        // 4. Preparar o novo t√≠tulo com a data da restaura√ß√£o
        const backupDate = backupData.timestamp 
            ? new Date(backupData.timestamp.seconds * 1000).toLocaleDateString('pt-PT') 
            : '';
        const newTitle = `${backupData.titulo} (Restaurado ${backupDate})`;

        // 5. Criar a NOVA nota no Firestore
        const newDocRef = await addDoc(collection(db, 'pastas'), {
            nome: newTitle,
            conteudo: backupData.conteudo,
            parentId: parentId,
            tipo: 'nota',
            userId: auth.currentUser.uid, // Atribui ao utilizador atual
            estado: 'ativa',
            ordem: 0, // Coloca no topo da lista
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp(),
            tags: []
        });

        // 6. Finaliza√ß√£o e Limpeza
        if (historyModal) {
            historyModal.style.display = 'none';
            historyModal.style.opacity = '1';
        }

        // 7. Feedback e Sugest√£o de abertura
        const shouldOpen = await showConfirmation(
            "C√≥pia Criada!", 
            `Foi gerada uma nova nota chamada "${newTitle}". Deseja abrir esta nota agora?`
        );

        if (shouldOpen) {
            // Se voc√™ tiver a fun√ß√£o de navega√ß√£o inteligente, use-a. 
            // Caso contr√°rio, use o displayNote direto.
            if (typeof navigateToNoteSmart === 'function') {
                await navigateToNoteSmart(newDocRef.id);
            } else {
                displayNote(newDocRef.id, null);
            }
        } else {
            // Apenas atualiza a lista lateral para mostrar a nota nova
            updateNavigationView(true, selectedNoteId);
        }

    } catch (error) {
        console.error("Erro cr√≠tico no processo de restauro:", error);
        alert("Ocorreu um erro ao restaurar a nota. Verifique a sua liga√ß√£o.");
        if (historyModal) historyModal.style.opacity = '1';
    }
};

    

    // --- LISTENER DO PAINEL ESQUERDO COM LOGS DE DEPURA√á√ÉO ---
leftPanelList.addEventListener('click', async (e) => {
    // 1. Identifica o que foi clicado (o item da lista)
    const listItem = e.target.closest('.list-item');
    if (!listItem) return;

    // --- A. DETE√á√ÉO DO BOT√ÉO DE MENU (TR√äS PONTOS OU L√ÅPIS ‚úè) ---
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) {
        console.log("üõ†Ô∏è Abrindo menu para:", listItem.dataset.name);
        showContextMenu(e); // O menu de contexto trata as a√ß√µes de edi√ß√£o e Cosmos
        return; // P√°ra aqui para n√£o tentar navegar/abrir o item
    }

    // --- B. CAPTURA DE DADOS DO ITEM ---
    const id = listItem.dataset.id;
    const name = listItem.dataset.name;
    const type = listItem.dataset.type;
    const emoji = listItem.dataset.emoji;

    // --- C. VERIFICA√á√ÉO DE PROTE√á√ÉO (APENAS MODO NOTE) ---
    if (currentTab === 'note') {
        // Se for pasta, nota ou superpasta, verifica se tem senha antes de prosseguir
        const canAccess = await checkItemProtection(id, name);
        if (!canAccess) return; // Se o usu√°rio cancelar ou errar a senha, sai
    }

    // --- D. L√ìGICA DE NAVEGA√á√ÉO: ABA "LISTS" (CATEGORIAS E COSMOS) ---
    if (currentTab === 'lists') {
        const listNavigationAction = async () => {
            // Caso 1: Categoria base (ex: T√≥picos, B√≠blia) ou Livro B√≠blico
            if (type === 'list-category' || type === 'bible-book') {
                if (type === 'list-category') {
                    navigationStack = [{ id, name, type }];
                } else {
                    navigationStack.push({ id, name, type });
                }
                updateNavigationView(true);
            } 
            // Caso 2: Tema do Cosmos (Entra para ver Subtemas)
            else if (type === 'cosmos-parent') {
                navigationStack.push({ id, name, type, emoji });
                updateNavigationView(true);
            }
            // Caso 3: Subtema do Cosmos (Abre Cita√ß√µes na 4¬™ Coluna)
            else if (type === 'subcosmos') {
                leftPanelList.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
                listItem.classList.add('selected');
                showReferencesPanel(id, name, 'subcosmos');
            }
        };

        navigateWithUnsavedCheck(listNavigationAction);
        return;
    }

    // --- E. L√ìGICA DE NAVEGA√á√ÉO: ABA "NOTE" (PASTAS E NOTAS LOCAIS) ---
    if (currentTab === 'note') {
        
        // Caso 1: PASTA ou AGREGA√á√ÉO
        if (type === 'pasta' || type === 'agregacao') {
            // Superpasta: Redireciona para o isolamento de raiz
            if (listItem.dataset.superpasta === "true") {
                navigateWithUnsavedCheck(() => { 
                    window.location.href = `note.html?rootId=${id}`; 
                });
            } 
            // Pasta Normal: Navega para dentro
            else {
                const folderAction = () => {
                    if (window.innerWidth <= 768) {
                        document.body.classList.add('mobile-view-middle');
                    }
                    if (navigationStack.length === 0) navigationStack.push({ id, name });
                    else navigationStack[navigationStack.length - 1] = { id, name };
                    updateNavigationView(true);
                };
                navigateWithUnsavedCheck(folderAction);
            }
        }

        // Caso 2: NOTA (Abre o editor principal)
        else if (type === 'nota') {
            const noteAction = () => {
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.add('mobile-view-editor');
                }
                displayNote(id, listItem);
            };
            navigateWithUnsavedCheck(noteAction);
        }
    }
});


// ====================================================================
// L√ìGICA DE MOVIMENTO DAS CAIXAS (üî∫ üîª)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    // S√≥ nos interessa se for um dos bot√µes de movimento
    if (action !== 'move-up' && action !== 'move-down') return;

    e.preventDefault(); e.stopPropagation();

    // 1. Identificar a Caixa (Wrapper) e o Pai (Editor)
    const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
    
    if (!wrapper) return;
    const parent = wrapper.parentNode;

    // 2. A√ß√£o MOVER PARA CIMA
    if (action === 'move-up') {
        const prevElement = wrapper.previousElementSibling;
        
        if (prevElement) {
            // Verifica se o elemento anterior √© um "div de espa√ßamento" (aqueles com height: 20px)
            // Se for, queremos saltar por cima dele tamb√©m para chegar ao conte√∫do real
            let target = prevElement;
            if (target.style.height === '20px' && target.previousElementSibling) {
                target = target.previousElementSibling;
            }

            // Move o wrapper para antes do alvo
            parent.insertBefore(wrapper, target);
            
            // Scroll suave para acompanhar o movimento
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
              updateRedatorParagraphs(); // Recalcula posi√ß√µes
            saveNote();
        }
    }

    // 3. A√ß√£o MOVER PARA BAIXO
    else if (action === 'move-down') {
        const nextElement = wrapper.nextElementSibling;
        
        if (nextElement) {
            // Mesma l√≥gica: saltar espa√ßadores vazios se existirem
            let target = nextElement;
            if (target.style.height === '20px' && target.nextElementSibling) {
                target = target.nextElementSibling;
            }

            // Para mover para baixo, inserimos o elemento SEGUINTE antes do ATUAL
            // (Basicamente trocamos a ordem)
            // Ou inserimos o ATUAL depois do SEGUINTE (usando nextSibling do seguinte)
            parent.insertBefore(wrapper, target.nextSibling);

            // Scroll suave
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateRedatorParagraphs(); // Recalcula posi√ß√µes
            saveNote();
        }
    }
});


// ====================================================================
// GESTOR DE LINHA CRONOL√ìGICA (TIMELINE)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    // 1. Adicionar Ponto
    if (e.target.classList.contains('t-btn-add')) {
        e.preventDefault(); e.stopPropagation();
        
        const wrapper = e.target.closest('.jwn-timeline-wrapper');
        const container = wrapper.querySelector('.timeline-container');
        
        const newEntry = document.createElement('div');
        newEntry.className = 'timeline-entry';
        newEntry.innerHTML = `
            <div class="t-marker"></div>
            <div class="t-date" contenteditable="true">Nova Data</div>
            <div class="t-text" contenteditable="true">Novo evento...</div>
            <button class="t-btn-del" title="Remover Ponto">√ó</button>
        `;
        
      container.appendChild(newEntry);

// --- SUBSTITUI ESTA PARTE DO SETTIMEOUT ---
setTimeout(() => {
    const dateField = newEntry.querySelector('.t-date');
    dateField.focus();

    // Cria uma sele√ß√£o precisa apenas no texto da data
    const range = document.createRange();
    range.selectNodeContents(dateField);
    
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
}, 10);
// ------------------------------------------

saveNote();
    }
    
    // 2. Remover Ponto
    else if (e.target.classList.contains('t-btn-del')) {
        e.preventDefault(); e.stopPropagation();
        
        const entry = e.target.closest('.timeline-entry');
        const container = entry.parentElement;
        
        // Se for o √∫ltimo ponto, pergunta se quer apagar a timeline toda
        if (container.children.length <= 1) {
            if (confirm("Apagar toda a Linha Cronol√≥gica?")) {
                entry.closest('.jwn-timeline-wrapper').remove();
            }
        } else {
            entry.remove();
        }
        
        saveNote();
    }
});



    // --- EVENT LISTENER MODIFICADO ---







    // --- NOVO LISTENER PARA O DROPDOWN DE ZOOM ---
const zoomSelect = document.getElementById('editor-zoom');
if (zoomSelect) {
    // Removemos clones antigos para evitar bugs
    const newZoomSelect = zoomSelect.cloneNode(true);
    zoomSelect.parentNode.replaceChild(newZoomSelect, zoomSelect);

    newZoomSelect.addEventListener('change', () => {
        const selectedValue = newZoomSelect.value;
        const editor = document.getElementById('note-content-editor');
        
        if (editor) {
            // 1. Aplica o tamanho
            editor.style.fontSize = selectedValue;
            
            // 2. Ajuste de altura da linha (UX)
            if (selectedValue.includes('%')) {
                 editor.style.lineHeight = '1.6';
            } else {
                 const sizeNum = parseInt(selectedValue);
                 editor.style.lineHeight = (sizeNum * 1.5) + 'px';
            }
            
            // 3. Grava imediatamente para persistir
            saveNote(true);
        }
    });
}





// --- EVENT LISTENERS ---

// ============================================================
// LISTENERS GLOBAIS DE CONECTIVIDADE E SA√çDA (FINAL)
// ============================================================

window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);

// 1. Gravar ao mudar de aba ou minimizar (Mobile & Desktop)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        
        // A. Se estiver no Aqu√°rio
        const aquariumEnv = document.getElementById('aquarium-environment');
        // Verifica se existe, se est√° vis√≠vel e se temos uma nota aberta
        if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
            console.log("üåä [SA√çDA] Aqu√°rio escondido. A gravar...");
            // Chama a fun√ß√£o de grava√ß√£o do aqu√°rio (que limpa o HTML)
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
        
        // B. Se estiver num Post de Arquivo (Feed) em edi√ß√£o
        else if (activeEditingPostId) {
            console.log("üì± [SA√çDA] Post de Arquivo aberto. A gravar e desbloquear...");
            const tempId = activeEditingPostId;
            // Limpa vari√°veis globais para evitar conflitos
            activeEditingPostId = null;
            window.activeEditingPostId = null;
            // Grava e liberta o cadeado
            if (typeof window.saveArchivePost === 'function') {
                window.saveArchivePost(tempId);
            }
        }

        // C. Se estiver numa Nota Normal (e houver altera√ß√µes pendentes)
        else if (currentSaveStatus === 'unsaved') {
            console.log("üìÑ [SA√çDA] Nota normal n√£o guardada. A gravar...");
            executeSave();
        }
    }
});

// 2. Gravar ao perder o foco da janela (ex: clicar no Desktop ou noutra app)
window.addEventListener('blur', () => {
    // Aplica a mesma l√≥gica de verifica√ß√£o
    const aquariumEnv = document.getElementById('aquarium-environment');
    
    if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
        // Verifica se h√° algo por guardar no Aqu√°rio
        const aqStatus = document.getElementById('aq-save-status');
        if (aqStatus && aqStatus.textContent === 'por guardar...') {
            window.saveAquariumState();
        }
    } 
    else if (currentSaveStatus === 'unsaved') {
        executeSave();
    }
});

// 3. Gravar ao Fechar Aba ou Fazer Refresh (Aviso de Seguran√ßa)
window.addEventListener('beforeunload', (event) => {
    let isPending = false;
    
    // A. Aqu√°rio Aberto
    const aquariumEnv = document.getElementById('aquarium-environment');
    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        // Verifica o texto do status espec√≠fico do aqu√°rio
        const aqStatus = document.getElementById('aq-save-status');
        
        if (aqStatus && (aqStatus.textContent === 'por guardar...' || aqStatus.textContent === 'A guardar...')) {
            console.log("üåä [REFRESH] Aqu√°rio por guardar. For√ßando...");
            // Dispara grava√ß√£o
            window.saveAquariumState();
            isPending = true;
        }
    }

    // B. Nota Normal ou Arquivo
    else {
        // Nota normal por guardar
        if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
            console.log("üìÑ [REFRESH] Nota por guardar. For√ßando...");
            executeSave();
            isPending = true;
        }

        // Post de Arquivo aberto
        if (activeEditingPostId) {
            console.log("üì± [REFRESH] Post aberto. For√ßando...");
            window.saveArchivePost(activeEditingPostId);
            isPending = true;
        }
    }

    // Se houver algo pendente, pede ao browser para esperar
    if (isPending) {
        event.preventDefault();
        event.returnValue = ''; // Standard para Chrome
        return ''; // Standard para outros browsers
    }
});

// Listeners de Navega√ß√£o (Protegidos pelo Gatekeeper)


// LISTENER √öNICO DA COLUNA 2 (Unifica Logs, Navega√ß√£o e Mobile)
middlePanelList.addEventListener('click', async (e) => {
    // 1. Identifica o item clicado
    const item = e.target.closest('.list-item');
    if (!item) return;

    // 2. Se clicou nos "tr√™s pontos", abre o menu de op√ß√µes e p√°ra aqui
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) {
        console.log("üõ†Ô∏è Abrindo menu para:", item.dataset.name);
        showContextMenu(e);
        return;
    }

    // 3. Captura dados do item
    const id = item.getAttribute('data-id');
    const type = item.getAttribute('data-type');
    const name = item.getAttribute('data-name');

    // --- CORRE√á√ÉO DE TRANSI√á√ÉO VISUAL ---
    // Define qual ser√° o pr√≥ximo item selecionado para a lista n√£o saltar para tr√°s
    window.nextSelectedId = id; 

    // 4. Verifica√ß√£o de Prote√ß√£o (Senha)
    const canAccess = await checkItemProtection(id, name);
    if (!canAccess) {
        window.nextSelectedId = null; // Se falhar senha, limpa transi√ß√£o
        return;
    }

    // 5. Defini√ß√£o da A√ß√£o de Navega√ß√£o
    const action = async () => {

        // --- CASO A: NAVEGAR (PASTAS) ---
        if (type === 'pasta' || type === 'agregacao') {

            // Se for Superpasta, redireciona para o isolamento de raiz
            if (item.dataset.superpasta === "true") {
                window.location.href = `note.html?rootId=${id}`;
                return;
            }

            // Navega√ß√£o normal
            navigationStack.push({ id, name });
            updateNavigationView(true);

            // Mobile: Salta para a vista de lista
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view-middle');
            }
        }

        // --- CASO B: ABRIR CONTE√öDO (NOTAS, ARQUIVOS, AQU√ÅRIOS, ETC) ---
        else if (type === 'nota' || type === 'arquivo' || type === 'partilhado' || type === 'jornal' || type === 'aquario') {

            // 1. Atualiza sele√ß√£o visual na lista (azul ou vermelho)
            document.querySelectorAll('#file-list .list-item').forEach(el => {
                el.classList.remove('selected', 'selected-red');
            });
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            item.classList.add(selectionClass);

            // 2. Mobile: Salta para o editor (que ser√° tapado pelo Aqu√°rio se for o caso)
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view-editor');
            }

            // 3. DECIS√ÉO DE ABERTURA

            // >>> AQU√ÅRIO ü™∏ (NOVO) <<<
            if (type === 'aquario') {
                console.log("üåä A carregar Aqu√°rio...");
                try {
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    
                    // Busca os dados atualizados ao Firebase (Conte√∫do dos blocos fantasmas)
                    const docRef = doc(db, 'pastas', id);
                    const snap = await getDoc(docRef);

                    if (snap.exists()) {
                        // Abre o ambiente isolado com os dados carregados
                        // A fun√ß√£o 'window.openAquariumEnvironment' (a vers√£o blindada) vai esconder a app principal
                        window.openAquariumEnvironment(id, { id: snap.id, ...snap.data() });
                    }
                } catch (err) {
                    console.error("Erro ao abrir Aqu√°rio:", err);
                    window.nextSelectedId = null;
                }
            }
            
            // --- NOTAS / JORNAIS ---
            else if (type === 'nota' || type === 'jornal') {
                displayNote(id, item);
            }
            
            // --- ARQUIVOS / PARTILHAS ---
            else {
                displayArchive(id, { id, nome: name, tipo: type }, item);
            }
        }
    };

    // Executa a a√ß√£o, verificando primeiro se h√° algo por gravar na nota atual
    navigateWithUnsavedCheck(action);
});





function setLeftPanelTitle(text, isBackAction = false) {
    const titleEl = document.getElementById('left-panel-title');
    if (!titleEl) return;

    // Verifica se estamos dentro de uma Superpasta (ID presente no URL/Vari√°vel)
    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // ============================================================
    // REGRA 1: MODO SUPERPASTA (Mant√©m o bot√£o de Sair para seguran√ßa)
    // ============================================================
    if (isSuperContext) {
        titleEl.className = ''; 
        titleEl.style.display = 'block';
        titleEl.onclick = null;

        titleEl.innerHTML = `
            <h2 style="font-size:18px; cursor:pointer; display: flex; align-items: center;" title="Sair desta Superpasta">
                <span style="font-size: 0.8em; opacity: 0.7; margin-right: 8px;">üîô</span> 
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${text}</span>
            </h2>`;
        
        titleEl.onclick = () => {
            navigateWithUnsavedCheck(() => {
                if (isBackAction && navigationStack.length > 0) {
                    navigationStack.pop();
                    selectedNoteId = null; 
                    updateNavigationView();
                } else {
                    window.location.href = "note.html"; 
                }
            });
        };
        return;
    }

    // ============================================================
    // REGRA 2: ABA NOTE (SELETOR SEMPRE VIS√çVEL)
    // ============================================================
    // Aqui for√ßamos o seletor mesmo que isBackAction seja true.
    if (currentTab === 'note') {
        titleEl.className = 'folder-mode-container';
        titleEl.style.display = 'flex';
        titleEl.onclick = null;

        const localActive = currentViewMode === 'local' ? 'active' : '';
        const sharedActive = currentViewMode === 'shared' ? 'active mode-shared' : '';
        const pinsActive = currentViewMode === 'pins' ? 'active mode-pins' : '';
        const flashActive = currentViewMode === 'flash' ? 'active mode-flash' : ''; 

        titleEl.innerHTML = `
            <span class="folder-mode-item ${localActive}" onclick="window.switchFolderView('local')">Local</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${sharedActive}" onclick="window.switchFolderView('shared')">Share</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${pinsActive}" onclick="window.switchFolderView('pins')">Pins</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${flashActive}" onclick="window.switchFolderView('flash')">Flash</span>
        `;

        // >>> ATUALIZA√á√ÉO DA NOTIFICA√á√ÉO GLOBAL <<<
        // Chamamos a fun√ß√£o para redesenhar a bolinha vermelha no novo HTML
        setTimeout(() => {
            if (typeof updateShareTabDot === 'function') updateShareTabDot();
        }, 50);
    }
    // ============================================================
    // REGRA 3: OUTRAS ABAS (Lists, etc - Mant√©m comportamento de voltar)
    // ============================================================
    else if (isBackAction) {
        titleEl.className = ''; 
        titleEl.style.display = 'block';
        titleEl.innerHTML = `<h2 style="font-size:18px; cursor:pointer;"><span style="font-size: 0.8em; opacity: 0.7; margin-right: 8px;">üîô</span> ${text}</h2>`;
        titleEl.onclick = () => {
            navigateWithUnsavedCheck(() => {
                if (navigationStack.length > 0) {
                    navigationStack.pop();
                    selectedNoteId = null; 
                    updateNavigationView();
                }
            });
        };
    } 
    else {
        titleEl.className = '';
        titleEl.style.display = 'block';
        titleEl.innerHTML = `<h2 style="font-size:18px; margin:0;">${text}</h2>`;
        titleEl.onclick = null;
    }
}


// ====================================================================
// FUN√á√ÉO: MOSTRAR REFER√äNCIAS DE DESTAQUE (4¬™ COLUNA)
// ====================================================================
async function showHighlightReferencesPanel(hexCode, colorName) {
    // 1. Gravar antes de mudar
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI();

    // --- DETE√á√ÉO DO MODO AQU√ÅRIO (IMPORTANTE) ---
    const aquariumEnv = document.getElementById('aquarium-environment');
    const refPanel = document.getElementById('references-panel');

    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        // Se o Aqu√°rio est√° aberto, for√ßamos o painel a flutuar sobre ele
        refPanel.classList.add('aquarium-overlay-mode');
        
        // Movemos o painel para dentro do ambiente do Aqu√°rio para garantir que fica vis√≠vel
        if (refPanel.parentElement !== aquariumEnv) {
            aquariumEnv.appendChild(refPanel);
        }

        // Adiciona classe para empurrar o texto do Aqu√°rio (Squeeze)
        aquariumEnv.classList.add('right-open');
    } else {
        // Modo Normal: Devolve √† estrutura principal
        refPanel.classList.remove('aquarium-overlay-mode');
        const mainContainer = document.querySelector('.notebook-container');
        if (mainContainer && refPanel.parentElement !== mainContainer) {
            mainContainer.appendChild(refPanel);
        }
    }
    // ---------------------------------------------

    // 2. Configura√ß√£o Visual
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // For√ßar aba "Refer√™ncias" (Cita)
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Esconder bot√µes irrelevantes
    document.getElementById('references-wol-btn').style.display = 'none';
    document.getElementById('references-bookmark-btn').style.display = 'none';

    // 3. Mostrar o Painel
    notebookContainer.classList.add('references-panel-visible');
    
    // 4. Configurar T√≠tulo e Cabe√ßalho
    const titleEl = document.getElementById('references-panel-title');
    titleEl.innerHTML = `
        <span style="display:inline-block; width:15px; height:15px; background:${hexCode}; border-radius:50%; border:1px solid #ccc; margin-right:5px; vertical-align:middle;"></span>
        ${colorName}
    `;
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar destaques...</span>
        </div>`;

    // 5. Definir a Entidade Ativa (Para o +Ref funcionar)
    // Usamos o c√≥digo Hex como ID e 'destaque' como tipo
    activeReferenceEntity = {
        id: hexCode,
        type: 'destaque',
        name: colorName
    };

    // Carregar dados do Quadro (Puzzle) para esta cor
    loadPuzzleData(hexCode, 'destaque');

    try {
        // 6. Pesquisa no Firestore (Notas com esta cor)
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            where('coresUsadas', 'array-contains', hexCode.toUpperCase())
        );

        const snapshot = await getDocs(q);
        const results = [];
        const parser = new DOMParser();

        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            if (isItemProtected && !appSettings.searchTagsInProtected) continue;

            const docHTML = parser.parseFromString(data.conteudo, 'text/html');
            const coloredElements = docHTML.querySelectorAll(`[data-highlight="${hexCode}"]`);
            
            coloredElements.forEach(el => {
                let displayTitle = "Sem T√≠tulo";
                let displayIcon = "üü¶"; 
                let snippet = "";
                let contextType = "Item";

                if (el.tagName === 'DETAILS' && el.classList.contains('toggle-section')) {
                    displayIcon = "‚òÇ";
                    contextType = "Toggle";
                    const h2 = el.querySelector('h2');
                    displayTitle = h2 ? h2.textContent : "T√≠tulo Expans√≠vel";
                    const contentDiv = el.querySelector('.toggle-content');
                    snippet = contentDiv ? contentDiv.textContent.trim().substring(0, 100) + "..." : "";
                }
                else if (el.classList.contains('mini-note-wrapper')) {
                    const titleInput = el.querySelector('.mini-note-title-input');
                    const contentDiv = el.querySelector('.mini-note-content');

                    if (el.classList.contains('question-mode')) {
                        displayIcon = "üìó";
                        contextType = "Quest√£o";
                        displayTitle = titleInput ? (titleInput.value || titleInput.textContent) : "Quest√£o";
                    } else if (el.classList.contains('free-mode')) {
                        displayIcon = "üìô";
                        contextType = "Contentor";
                        const txt = contentDiv ? contentDiv.textContent.trim() : "";
                        displayTitle = txt.length > 40 ? txt.substring(0, 40) + "..." : (txt || "Contentor");
                    } else {
                        displayIcon = "üìò"; 
                        contextType = "SubNota";
                        displayTitle = titleInput ? (titleInput.value || titleInput.textContent) : "SubNota";
                    }
                    snippet = contentDiv ? contentDiv.innerHTML : "";
                }

                results.push({
                    noteId: docSnap.id,
                    noteName: data.nome,
                    displayTitle: displayTitle,
                    displayIcon: displayIcon,
                    contextType: contextType,
                    snippet: snippet || el.outerHTML // Usa o snippet se houver, ou o HTML todo
                });
            });
        }

        listElement.innerHTML = '';
        if (results.length === 0) {
            listElement.innerHTML = '<li style="padding:15px; color:#888;">Nenhuma caixa encontrada com esta cor.</li>';
            return;
        }

        results.forEach(item => {
            const details = document.createElement('details');
            details.className = 'reference-item';
            details.style.borderLeft = `3px solid ${hexCode}`;
            
            const safeName = encodeURIComponent(item.noteName);
            const safeSnippet = encodeURIComponent(item.snippet);

            const summary = document.createElement('summary');
            summary.style.listStyle = "none"; 

            const goToBtn = `<button class="go-to-note-btn" 
                onclick="window.handleGoToNote('${item.noteId}')" 
                title="Ir para nota">‚ûî</button>`;

            summary.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="add-to-puzzle-btn" 
                                    onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${item.noteId}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                            <span style="font-weight:500; color:var(--text-color);">${item.displayIcon} ${item.displayTitle}</span>
                        </div>
                        ${goToBtn}
                    </div>
                    <small style="color:var(--text-muted-color); margin-top:2px;">em üìÑ ${item.noteName}</small>
                </div>
            `;
            
            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Limpa HTML para mostrar preview de texto
            const previewText = item.snippet.replace(/<[^>]*>/g, '').substring(0, 150);
            contextDiv.innerHTML = `<p>${previewText}...</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias de cor:", error);
        listElement.innerHTML = '<li>Erro ao processar dados.</li>';
    }
}

function checkToolbarStatus() {
    // 1. Pergunta ao browser o estado da formata√ß√£o atual
    const isBold = document.queryCommandState('bold');
    const isItalic = document.queryCommandState('italic');
    const isUnderline = document.queryCommandState('underline');

    // 2. Fun√ß√£o auxiliar para ligar/desligar a classe visual
    const toggleBtn = (selector, isActive) => {
        // Seleciona tanto os bot√µes da barra principal como das mini-notas
        const btns = document.querySelectorAll(selector);
        btns.forEach(btn => {
            if (isActive) btn.classList.add('active-tool');
            else btn.classList.remove('active-tool');
        });
    };

    // 3. Atualiza os bot√µes (considerando os dois tipos de data-attribute que usamos)
    // Para Negrito
    toggleBtn('button[data-command="bold"]', isBold);
    toggleBtn('button[data-cmd="bold"]', isBold);

    // Para It√°lico
    toggleBtn('button[data-command="italic"]', isItalic);
    toggleBtn('button[data-cmd="italic"]', isItalic);

    // Para Sublinhado
    toggleBtn('button[data-command="underline"]', isUnderline);
    toggleBtn('button[data-cmd="underline"]', isUnderline);
}



// Gera uma cor consistente baseada no ID do utilizador
function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return '#' + "00000".substring(0, 6 - c.length) + c;
}

// --- LIGAR O DETETOR ---



document.querySelector('.tabs-container').addEventListener('click', (e) => {
    leaveArchivePresence(); 
    const clickedTabBtn = e.target.closest('button');
    if (!clickedTabBtn) return;

    const newTab = clickedTabBtn.dataset.tab;
    if (newTab === 'book') {
        window.open('book.html', '_blank'); 
        return; 
    }

    if (currentSaveStatus === 'unsaved') {
        saveNote(true); // Grava imediatamente se houver altera√ß√µes
    }

    // --- SISTEMA DE MEM√ìRIA ---
    // 1. Antes de mudar, guarda a navega√ß√£o da aba ATUAL na mem√≥ria dela
    if (currentTab === 'note') noteStackMemory = [...navigationStack];
    if (currentTab === 'lists') listsStackMemory = [...navigationStack];

    // 2. Atualiza visual das abas
    e.currentTarget.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
    clickedTabBtn.classList.add('active');

    // 3. Muda a aba ativa
    currentTab = newTab;

    // 4. Carrega a navega√ß√£o da NOVA aba a partir da mem√≥ria dela
    if (currentTab === 'note') navigationStack = [...noteStackMemory];
    if (currentTab === 'lists') navigationStack = [...listsStackMemory];
    
     // Adiciona esta linha aqui por seguran√ßa extra:
    updateMobileFABVisibility(); 
    // 5. Atualiza a vista (mantendo o editor aberto se houver uma nota ativa)
    updateNavigationView(true);
});


// Listeners do Editor
noteTitleInput.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
noteContentEditor.addEventListener('input', () => {
    // 1. Marca como n√£o guardado e guarda data
    lastContentEditTime = Date.now(); 
    updateSaveStatus('unsaved');
    saveNote();

    // 2. ATUALIZA√á√ÉO DA 3¬™ ABA EM TEMPO REAL
    const activeTab = document.querySelector('.middle-bottom-tabs button.active');
    
    // S√≥ faz o scan se estivermos na aba de textos/navega/h√≠brido
    if (activeTab && activeTab.dataset.midTab === 'texts') {
        clearTimeout(window.textScanTimeout);
        
        window.textScanTimeout = setTimeout(() => {
            // --- CORRE√á√ÉO AQUI: Respeitar a hierarquia de modos ---
            if (window.currentNoteHybridMode) {
                 console.log("üõ≥Ô∏è [INPUT] Atualizando Modo H√≠brido...");
                 generateHybridView();
            } else if (activeTab.dataset.mode === 'navega') {
                 console.log("‚öì [INPUT] Atualizando Navega√ß√£o...");
                 generateAnchorNavigation();
            } else {
                 console.log("üìú [INPUT] Atualizando Textos B√≠blicos...");
                 generateNoteTexts();
            }
        }, 1000); // Espera 1 segundo ap√≥s parar de escrever
    }
});

document.addEventListener('selectionchange', handleTextSelection);

noteContentEditor.addEventListener('keydown', (e) => {
    // 1. Se estivermos a escrever DENTRO de um input do dep√≥sito, permite apagar texto normalmente
    if (e.target.tagName === 'INPUT' && e.target.closest('.ref-depot-wrapper')) {
        return; 
    }

    if (e.key === 'Backspace' || e.key === 'Delete') {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        const range = selection.getRangeAt(0);

        // --- CEN√ÅRIO A: UTILIZADOR SELECIONOU O BLOCO (HIGHLIGHT) ---
        if (!selection.isCollapsed) {
            // Verifica se a sele√ß√£o cont√©m um Dep√≥sito
            const commonAncestor = range.commonAncestorContainer;
            const element = commonAncestor.nodeType === 3 ? commonAncestor.parentElement : commonAncestor;
            
            // Se a sele√ß√£o engloba o dep√≥sito ou cruza por ele
            if (element.querySelector('.ref-depot-wrapper') || 
                (element.classList.contains('ref-depot-wrapper')) ||
                range.intersectsNode(document.querySelector('.ref-depot-wrapper') || document.body)) {
                
                // Verifica√ß√£o precisa: iterar pelos dep√≥sitos para ver se algum est√° na sele√ß√£o
                const depots = noteContentEditor.querySelectorAll('.ref-depot-wrapper');
                let isProtected = false;
                
                depots.forEach(depot => {
                    if (selection.containsNode(depot, true)) {
                        isProtected = true;
                    }
                });

                if (isProtected) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert("‚ö†Ô∏è Prote√ß√£o Ativa: Utilize o bot√£o de lixo (üóëÔ∏è) no canto do Dep√≥sito para o apagar.");
                    return;
                }
            }
        }

        // --- CEN√ÅRIO B: CURSOR ENCOSTADO AO BLOCO (BACKSPACE) ---
        if (e.key === 'Backspace' && selection.isCollapsed) {
            const anchorNode = selection.anchorNode;
            
            // Se estamos no in√≠cio de um bloco de texto (offset 0)
            if (range.startOffset === 0) {
                // Descobre o elemento HTML atual
                const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
                
                // V√™ quem √© o vizinho de cima
                let prevSibling = currentEl.previousElementSibling;
                
                // Se o vizinho de cima for um Dep√≥sito, BLOQUEIA
                if (prevSibling && prevSibling.classList.contains('ref-depot-wrapper')) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Opcional: Faz um pequeno flash visual para mostrar que bateu na parede
                    prevSibling.style.borderColor = "red";
                    setTimeout(() => prevSibling.style.borderColor = "", 300);
                    return;
                }
            }
        }

        // --- CEN√ÅRIO C: CURSOR ANTES DO BLOCO (DELETE) ---
        if (e.key === 'Delete' && selection.isCollapsed) {
            const anchorNode = selection.anchorNode;
            const textLength = anchorNode.textContent.length;

            // Se estamos no fim de um bloco de texto
            if (range.startOffset === textLength) {
                const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
                
                // V√™ quem √© o vizinho de baixo
                let nextSibling = currentEl.nextElementSibling;
                
                // Se o vizinho de baixo for um Dep√≥sito, BLOQUEIA
                if (nextSibling && nextSibling.classList.contains('ref-depot-wrapper')) {
                    e.preventDefault();
                    e.stopPropagation();
                    nextSibling.style.borderColor = "red";
                    setTimeout(() => nextSibling.style.borderColor = "", 300);
                    return;
                }
            }
        }
    }
});

// ADICIONA ESTA LINHA AQUI:
noteContentEditor.addEventListener('keydown', handleBoundaryProtection);

// E ADICIONA TAMB√âM ESTA PARA O ARQUIVO:
document.getElementById('archive-feed').addEventListener('keydown', (e) => {
    if (e.target.classList.contains('post-editor-content')) {
        handleBoundaryProtection(e);
    }
});

// ====================================================================
// L√ìGICA DE CORES DO TOGGLE
// ====================================================================
let activeToggleForColor = null;
const toggleColorPopup = document.getElementById('toggle-color-popup');

// 1. Abrir o Popup ao clicar no Pincel
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('.toggle-color-btn');
    if (!colorBtn) return;

    e.preventDefault(); e.stopPropagation();

    // Identifica o Toggle
    activeToggleForColor = colorBtn.closest('details.toggle-section');
    
    // Posiciona o Popup
    const rect = colorBtn.getBoundingClientRect();
    toggleColorPopup.style.display = 'block';
    toggleColorPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
    // Alinha para n√£o sair do ecr√£ √† direita
    toggleColorPopup.style.left = `${(rect.left + window.scrollX) - 100}px`;
});

// 2. Escolher a Cor (Delegation no Popup)
toggleColorPopup.addEventListener('click', (e) => {
    e.stopPropagation(); // Impede fechar ao clicar dentro

    // Bot√£o de cor
    if (e.target.classList.contains('color-choice')) {
        if (activeToggleForColor) {
            const color = e.target.dataset.color;
            // Aplica a cor ao fundo do Toggle e do conte√∫do
            activeToggleForColor.style.backgroundColor = color;
            activeToggleForColor.style.borderColor = color;
            
            // Opcional: Ajustar a cor do texto para preto para garantir contraste
            activeToggleForColor.style.color = '#333333'; 
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '#000000';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
    
    // Bot√£o Reset (Sem Cor)
    else if (e.target.classList.contains('color-choice-reset')) {
        if (activeToggleForColor) {
            activeToggleForColor.style.backgroundColor = '';
            activeToggleForColor.style.borderColor = '';
            activeToggleForColor.style.color = ''; // Volta ao padr√£o
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
});

// 3. Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (toggleColorPopup.style.display !== 'none') {
        if (!toggleColorPopup.contains(e.target) && !e.target.closest('.toggle-color-btn')) {
            toggleColorPopup.style.display = 'none';
            activeToggleForColor = null;
        }
    }
});

// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
document.getElementById('generic-list-modal').addEventListener('click', (e) => {
    // Procura por um bot√£o de edi√ß√£o de anexo
    const editButton = e.target.closest('button[data-action="edit-anexo"]');
    if (editButton) {
        const anexoId = editButton.dataset.id;
        if (anexoId) {
            document.getElementById('generic-list-modal').style.display = 'none';
            openLinkModal(true, { id: anexoId });
        }
        return; // Termina a execu√ß√£o aqui
    }

    // <<<<<<< NOVO: Procura por um item de lista de tag clic√°vel >>>>>>>>>
    const tagListItem = e.target.closest('li[data-action="show-tag-references"]');
    if (tagListItem) {
        const tagName = tagListItem.dataset.tagName;
        if (tagName) {
            // 1. Fecha o modal de tags
            document.getElementById('generic-list-modal').style.display = 'none';
            // 2. Abre o painel de refer√™ncias para essa tag
            showTagReferencesPanel(tagName);
        }
    }
});


// ====================================================================
// 2. DETETAR CLIQUE NA IDEIA (Abrir Menu ‚úÇÔ∏è üß≤)
// ====================================================================
 let activeIdeaElement = null; 

noteContentEditor.addEventListener('click', (e) => {
    // Tenta encontrar o span da ideia onde clic√°mos
    const ideaSpan = e.target.closest('.idea-span');
    const ideaPopup = document.getElementById('idea-actions-popup');

    // Se clicou numa ideia
    if (ideaSpan) {
        // --- CORRE√á√ÉO DO ERRO ORTOGR√ÅFICO ---
        // For√ßa o navegador a ignorar erros ortogr√°ficos NESTE elemento espec√≠fico.
        // Isto remove o sublinhado vermelho e impede o menu nativo do browser de aparecer.
        if (ideaSpan.spellcheck !== false) {
            ideaSpan.spellcheck = false;
            // Opcional: for√ßa um "repaint" leve se o browser n√£o atualizar logo
            ideaSpan.setAttribute('spellcheck', 'false'); 
        }
        // -------------------------------------

        // Guardamos a refer√™ncia globalmente
        activeIdeaElement = ideaSpan;

        // Calcula a posi√ß√£o para o menu aparecer logo abaixo do texto
        const rect = ideaSpan.getBoundingClientRect();
        
        ideaPopup.style.display = 'flex';
        ideaPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        ideaPopup.style.left = `${rect.left + window.scrollX}px`;
        
        // Impede que o clique se propague e ative outros listeners
        e.stopPropagation(); 
        e.preventDefault();
        return;
    } 
    
    // Se clicou fora, fecha o popup
    if (ideaPopup && ideaPopup.style.display === 'flex' && !e.target.closest('#idea-actions-popup')) {
        ideaPopup.style.display = 'none';
        activeIdeaElement = null;
    }
});

// ====================================================================
// 3. A√á√ïES DO MENU DA IDEIA (‚úÇÔ∏è e üß≤)
// ====================================================================
const ideaPopupElement = document.getElementById('idea-actions-popup');
if (ideaPopupElement) {
    ideaPopupElement.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeIdeaElement) return;

        e.stopPropagation(); // Impede fechar o menu ao clicar no bot√£o

        const action = btn.dataset.action;

        // --- A√á√ÉO ‚úÇÔ∏è: REMOVER IDEIA ---
        if (action === 'remove-idea') {
            const text = activeIdeaElement.textContent;
            const parent = activeIdeaElement.parentNode;
            
            // Substitui o span pelo texto simples
            const textNode = document.createTextNode(text);
            parent.replaceChild(textNode, activeIdeaElement);
            parent.normalize(); // Junta n√≥s de texto adjacentes

            saveNote();
            ideaPopupElement.style.display = 'none';
        }

        // --- A√á√ÉO üß≤: ADICIONAR A OUTRA NOTA ---
        else if (action === 'append-idea') {
            ideaPopupElement.style.display = 'none'; // Fecha o menu pequeno
            await openNoteSelectorForIdea();  // Abre o seletor de notas
        }
    });
}

// ====================================================================
// 4. FUN√á√ïES AUXILIARES PARA IDEIAS (Seletor e Transfer√™ncia)
// ====================================================================

// A. SELETOR DE NOTAS
async function openNoteSelectorForIdea() {
    if (!selectedNoteId) return;

    const modal = document.getElementById('select-note-modal');
    const list = document.getElementById('select-note-list');
    
    modal.style.display = 'flex';
    list.innerHTML = '<li>A carregar notas...</li>';

    try {
        // 1. Descobrir o parentId da nota atual
        const currentNoteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        const currentParentId = currentNoteSnap.exists() ? currentNoteSnap.data().parentId : null;

        // 2. Buscar todas as NOTAS (n√£o pastas) que est√£o na MESMA pasta
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', currentParentId),
            where('tipo', '==', 'nota'), // S√≥ queremos notas
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty || (snapshot.size === 1 && snapshot.docs[0].id === selectedNoteId)) {
            list.innerHTML = '<li>Nenhuma outra nota nesta pasta.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            // N√£o mostrar a pr√≥pria nota atual
            if (docSnap.id === selectedNoteId) return;

            const noteData = docSnap.data();
            const li = document.createElement('li');
            li.textContent = "üìÑ " + noteData.nome;
            li.style.cursor = 'pointer';
            li.style.padding = '10px';
            li.style.borderBottom = '1px solid var(--border-color)';
            
            // Ao clicar numa nota da lista
            li.onclick = () => transferIdeaToNote(docSnap.id, noteData);
            
            list.appendChild(li);
        });

    } catch (error) {
        console.error(error);
        list.innerHTML = '<li>Erro ao carregar notas.</li>';
    }
}

// B. TRANSFERIR O TEXTO
async function transferIdeaToNote(targetNoteId, targetNoteData) {
    if (!activeIdeaElement) return;

    const textToTransfer = activeIdeaElement.textContent;
    const modal = document.getElementById('select-note-modal');

    try {
        // Adiciona o texto ao final do conte√∫do existente da nota alvo
        const newContent = (targetNoteData.conteudo || "") + `<br><p>üí° ${textToTransfer}</p>`;

        const targetRef = doc(db, 'pastas', targetNoteId);
        await updateDoc(targetRef, {
            conteudo: newContent,
            ultimaedicao: serverTimestamp()
        });

        alert(`Ideia adicionada √† nota "${targetNoteData.nome}" com sucesso!`);
        modal.style.display = 'none';

    } catch (error) {
        console.error("Erro ao transferir:", error);
        alert("Erro ao adicionar ideia √† nota.");
    }
}


// 1. Abrir o Modal e Iniciar Navega√ß√£o
function openAggregationSelector() {
    const modal = document.getElementById('aggregation-modal');
    const nameSpan = document.getElementById('aggregation-new-name');
    
    // Reset das vari√°veis de navega√ß√£o do modal
    aggregationStack = []; 
    aggregationSelectedItems = [];
    updateAggregationCount();
    
    nameSpan.textContent = aggregationTargetName;
    modal.style.display = 'flex';
    
    // L√ìGICA ALTERADA:
    // Verifica se estamos numa Superpasta. Se sim, a "Raiz" √© a Superpasta.
    // Se n√£o, a "Raiz" √© null (In√≠cio absoluto).
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    // Carrega sempre a partir do in√≠cio, independentemente de onde vamos gravar a nota
    loadAggregationLevel(startRootId);
}

// 2. Carregar N√≠vel (Pastas e Notas)
async function loadAggregationLevel(parentId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    
    // Atualiza breadcrumbs
    if (aggregationStack.length > 0) {
        pathSpan.textContent = aggregationStack[aggregationStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathSpan.textContent = parentId ? "Pasta Atual" : "Pasta Raiz";
        backBtn.style.display = 'none'; // Se estamos na base, esconde voltar
    }

    try {
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', parentId),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('tipo'), // Pastas primeiro, depois notas (alfabeticamente depende do locale)
            orderBy('nome')
        );
        
        const snapshot = await getDocs(q);
        list.innerHTML = '';
        
        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Pasta vazia.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            
            const li = document.createElement('li');
            li.className = 'agreg-item';
            
            if (item.tipo === 'pasta') {
                li.classList.add('agreg-type-folder');
                li.innerHTML = `üìÅ ${item.nome}`;
                li.onclick = () => {
                    aggregationStack.push({ id: item.id, name: item.nome });
                    loadAggregationLevel(item.id);
                };
            } else if (item.tipo === 'nota') {
                li.classList.add('agreg-type-note');
                li.innerHTML = `üìÑ ${item.nome}`;
                li.onclick = () => {
                    // Ao clicar na nota, carregamos as caixas dentro dela
                    aggregationStack.push({ id: item.id, name: item.nome, type: 'nota' });
                    loadNoteBoxesForAggregation(item.id);
                };
            }
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar itens.</li>';
    }
}

// 3. Carregar Caixas dentro de uma Nota (Parsing HTML)
async function loadNoteBoxesForAggregation(noteId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');

    // Atualiza UI
    pathSpan.textContent = "üìÑ " + aggregationStack[aggregationStack.length - 1].name;
    backBtn.style.display = 'block';
    list.innerHTML = '<li style="padding:10px;">A analisar conte√∫do da nota...</li>';

    try {
        const noteDoc = await getDoc(doc(db, 'pastas', noteId));
        if (!noteDoc.exists()) return;

        const content = noteDoc.data().conteudo || "";
        
        // Parse do HTML da nota
        const parser = new DOMParser();
        const docHTML = parser.parseFromString(content, 'text/html');
        const wrappers = docHTML.querySelectorAll('.mini-note-wrapper');

        list.innerHTML = '';
        
        if (wrappers.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Esta nota n√£o tem Subnotas, Quest√µes ou Contentores.</li>';
            return;
        }

        wrappers.forEach((wrapper, index) => {
            // Extrair T√≠tulo
            let title = "Sem T√≠tulo";
            let typeClass = "";
            let typeLabel = "";

            // Detetar Tipo
            if (wrapper.classList.contains('question-mode')) {
                typeClass = "agreg-box-question";
                typeLabel = "Quest√£o";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "Quest√£o sem t√≠tulo";
            } else if (wrapper.classList.contains('free-mode')) {
                typeClass = "agreg-box-free";
                typeLabel = "Contentor";
                // L√≥gica de primeira frase para contentores livres
                const text = wrapper.querySelector('.mini-note-content').textContent.trim();
                if (text) {
                    const firstSentence = text.split(/[.!?]/)[0];
                    title = firstSentence.length > 50 ? firstSentence.substring(0, 50) + "..." : firstSentence;
                } else {
                    title = "Contentor Vazio";
                }
            } else {
                typeClass = "agreg-box-subnote";
                typeLabel = "SubNota";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "SubNota sem t√≠tulo";
            }

            // Criar ID √∫nico tempor√°rio para controlo de sele√ß√£o
            const uniqueId = `${noteId}_${index}`;
            const isSelected = aggregationSelectedItems.some(i => i.uniqueId === uniqueId);

            const li = document.createElement('li');
            li.className = `agreg-box-item ${typeClass} ${isSelected ? 'selected' : ''}`;
            
            // Checkbox visual
            const check = isSelected ? "‚òëÔ∏è" : "‚¨ú";

            li.innerHTML = `
                <div style="font-size:1.2em;">${check}</div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:0.9em; color:var(--text-muted-color); text-transform:uppercase;">${typeLabel}</span>
                    <span style="color:var(--text-color);">${title}</span>
                </div>
            `;

            li.onclick = () => {
                toggleAggregationItem(uniqueId, wrapper.outerHTML, li);
            };

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao ler nota.</li>';
    }
}

// 4. Selecionar/Desselecionar Item
function toggleAggregationItem(uniqueId, htmlContent, liElement) {
    const existingIndex = aggregationSelectedItems.findIndex(i => i.uniqueId === uniqueId);

    if (existingIndex > -1) {
        // Remover
        aggregationSelectedItems.splice(existingIndex, 1);
        liElement.classList.remove('selected');
        liElement.querySelector('div').textContent = "‚¨ú";
    } else {
        // Adicionar
        aggregationSelectedItems.push({ uniqueId, html: htmlContent });
        liElement.classList.add('selected');
        liElement.querySelector('div').textContent = "‚òëÔ∏è";
    }
    updateAggregationCount();
}

function updateAggregationCount() {
    document.getElementById('agreg-count').textContent = `${aggregationSelectedItems.length} itens selecionados`;
}

// 5. Navega√ß√£o "Voltar"
document.getElementById('agreg-back-btn').addEventListener('click', () => {
    
    // Determina qual √© a raiz l√≥gica (Superpasta ou Global)
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (aggregationStack.length > 0) {
        aggregationStack.pop(); // Remove n√≠vel atual
        
        if (aggregationStack.length > 0) {
            // Se ainda houver itens no hist√≥rico, carrega esse n√≠vel
            const parent = aggregationStack[aggregationStack.length - 1];
            if (parent.type === 'nota') {
                loadNoteBoxesForAggregation(parent.id);
            } else {
                loadAggregationLevel(parent.id);
            }
        } else {
            // Se o hist√≥rico ficou vazio, voltamos √† Raiz
            loadAggregationLevel(rootId);
        }
    } else {
        // Seguran√ßa: se clicar e j√° estiver vazio
        loadAggregationLevel(rootId);
    }
});

// 6. FINALIZAR: Criar a Nota com as Caixas
document.getElementById('agreg-finish-btn').addEventListener('click', async () => {
    if (aggregationSelectedItems.length === 0) {
        alert("Selecione pelo menos uma caixa.");
        return;
    }

    const btn = document.getElementById('agreg-finish-btn');
    btn.textContent = "A criar...";
    btn.disabled = true;

    try {
        // Constr√≥i o HTML final
        let finalHTML = "";
        aggregationSelectedItems.forEach(item => {
            finalHTML += item.html + "<p><br></p>"; 
        });

        // Determina a ordem
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', aggregationParentId), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const siblingsSnap = await getDocs(q);
        const newOrder = siblingsSnap.size;

        // --- ALTERA√á√ÉO AQUI: Guardamos a refer√™ncia do documento criado ---
        const docRef = await addDoc(collection(db, 'pastas'), {
            nome: aggregationTargetName, 
            parentId: aggregationParentId, 
            tipo: 'nota', 
            conteudo: finalHTML,
            userId: auth.currentUser.uid, 
            estado: 'ativa',
            ordem: newOrder, 
            createdAt: serverTimestamp(), 
            ultimaedicao: serverTimestamp()
        });

        // 1. Fechar o Modal
        document.getElementById('aggregation-modal').style.display = 'none';
        
        // 2. Abrir a Nota Imediatamente
        // Passamos 'null' no segundo argumento porque o elemento da lista 
        // ainda pode n√£o ter sido renderizado pelo onSnapshot, mas a fun√ß√£o abre pelo ID na mesma.
        displayNote(docRef.id, null); 
        
    } catch (e) {
        console.error("Erro ao criar agrega√ß√£o:", e);
        alert("Erro ao criar.");
    } finally {
        btn.textContent = "Criar Agrega√ß√£o";
        btn.disabled = false;
    }
});

// ====================================================================
// SCANNER UNIVERSAL (üé∞) - B√≠blia, Personagens, Locais, Datas
// ====================================================================

let universalScanResults = {
    textobiblico: { new: [], existing: [] },
    personagem: { new: [], existing: [] },
    local: { new: [], existing: [] },
    data: { new: [], existing: [] }
};
let currentScanTab = 'textobiblico';


// 2. FUN√á√ÉO PRINCIPAL: ANALISAR TEXTO
async function openUniversalScanner() {
    const modal = document.getElementById('universal-scan-modal');
    if (!modal) return;

    // --- FOR√áA BRUTA DE VISIBILIDADE ---
    document.body.appendChild(modal); // Move para a raiz do body
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9000000"; // Acima de quase tudo
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Reset total de resultados
    universalScanResults = {
        textobiblico: { new: [], existing: [] },
        personagem: { new: [], existing: [] },
        local: { new: [], existing: [] },
        data: { new: [], existing: [] }
    };
    

    // --- FASE 1: J√Å EXISTENTES (Guardar refer√™ncia do elemento) ---
    const existingLinks = noteContentEditor.querySelectorAll('.entity-link');
    existingLinks.forEach(link => {
        const type = link.dataset.entityType;
        if (universalScanResults[type]) {
            universalScanResults[type].existing.push({
                linkElement: link, // Guardamos o elemento DOM para poder remover
                text: link.textContent,
                line: getApproximateLineNumber(link),
                selected: true // J√° √© link, logo come√ßa "Ativo"
            });
        }
    });

    // --- FASE 2: NOVOS CANDIDATOS ---
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const bibleRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'gi');
    const dateRegex = /\b\d{1,2}[-\/]\d{1,2}[-\/]\d{4}\b/g;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    let node;

    while (node = walker.nextNode()) {
        if (node.parentElement.closest('.entity-link, a, .tag, script, style')) continue;

        const text = node.textContent;
        const lineNum = getApproximateLineNumber(node);

        // A. B√≠blia
        let match;
        while ((match = bibleRegex.exec(text)) !== null) {
            addCandidate('textobiblico', match[0], node, match.index, lineNum);
        }
        // B. Datas
        while ((match = dateRegex.exec(text)) !== null) {
            addCandidate('data', match[0], node, match.index, lineNum);
        }
        // C. Personagens/Locais (BD)
        checkDatabaseEntities(text, node, lineNum, 'personagem');
        checkDatabaseEntities(text, node, lineNum, 'local');
    }

    renderScanTab(currentScanTab);
    modal.style.display = 'flex';
}

function addCandidate(type, matchText, textNode, index, lineNum, cleanName = null) {
    const finalName = cleanName || matchText.trim().replace(/[.,;]+$/, '');
    
    const exists = universalScanResults[type].new.some(c => c.textNode === textNode && c.index === index);
    if (exists) return;

    universalScanResults[type].new.push({
        textNode: textNode,
        matchText: matchText,
        cleanName: finalName,
        index: index,
        line: lineNum,
        contextSnippet: getContextSnippet(textNode.textContent, index, matchText.length),
        selected: false // Novos come√ßam "Inativos" (Texto simples)
    });
}

function checkDatabaseEntities(text, node, lineNum, type) {
    if (!allEntities[type]) return;
    allEntities[type].forEach(entity => {
        const regex = new RegExp(`\\b${escapeRegExp(entity.nome)}\\b`, 'g');
        let match;
        while ((match = regex.exec(text)) !== null) {
            addCandidate(type, match[0], node, match.index, lineNum, entity.nome); 
        }
    });
}

// 3. RENDERIZA√á√ÉO DA ABA ATUAL
function renderScanTab(type) {
    const container = document.getElementById('scan-lists-container');
    container.innerHTML = '';
    const data = universalScanResults[type];
    
    // Atualiza o texto do bot√£o Select All
    updateSelectAllButtonState();

    // --- LISTA DE NOVOS (Check = Criar Link) ---
    if (data.new.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.textContent = `‚ö° Novos Detetados (${data.new.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.new.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'new');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    } else {
        container.innerHTML += '<div style="padding:10px; color:#888;">Nada novo aqui.</div>';
    }

    // --- LISTA DE EXISTENTES (Uncheck = Remover Link) ---
    if (data.existing.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.style.color = "#2ecc71";
        title.textContent = `‚úì J√° Identificados (${data.existing.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.existing.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'existing');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    }
}

// Fun√ß√£o auxiliar para criar o HTML da linha
function createScanListItem(item, idx, listType) {
    const li = document.createElement('li');
    li.className = 'scan-item-row';
    
    // Nome do item (cleanName para novos, text para existentes)
    const displayName = listType === 'new' ? item.cleanName : item.text;
    const isChecked = item.selected ? 'checked' : '';
    
    // Estilo visual: se for existente e estiver desmarcado, risca o texto
    const textStyle = (listType === 'existing' && !item.selected) ? 'text-decoration: line-through; opacity: 0.6;' : '';

    li.innerHTML = `
        <input type="checkbox" class="scan-checkbox" id="scan-${listType}-${idx}" ${isChecked}>
        <div class="scan-info" style="${textStyle}">
            <span class="scan-name">${displayName}</span>
            <span class="scan-location">Linha aprox. ${item.line}</span>
        </div>
        ${listType === 'new' ? '<button class="scan-preview-btn" title="Ver Contexto">üîç</button>' : ''}
    `;

    // Evento de Clique na Linha
    li.addEventListener('click', (e) => {
        if (e.target.closest('.scan-preview-btn')) return;
        
        const checkbox = li.querySelector('input');
        if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
        
        // Atualiza modelo
        item.selected = checkbox.checked;
        
        // Atualiza visual (riscar se for para remover)
        const infoDiv = li.querySelector('.scan-info');
        if (listType === 'existing') {
            infoDiv.style.textDecoration = item.selected ? 'none' : 'line-through';
            infoDiv.style.opacity = item.selected ? '1' : '0.6';
        }

        updateSelectAllButtonState();
    });

    // Lupa (apenas para novos)
    if (listType === 'new') {
        li.querySelector('.scan-preview-btn').onclick = (e) => {
            e.stopPropagation();
            showScanPreview(item.cleanName, item.contextSnippet);
        };
    }

    return li;
}

// 4. L√ìGICA DO BOT√ÉO "SELECIONAR TODOS / REMOVER TODOS"
const toggleAllBtn = document.getElementById('scan-toggle-all-btn');

function updateSelectAllButtonState() {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    
    if (totalItems === 0) {
        toggleAllBtn.style.display = 'none';
        return;
    }
    toggleAllBtn.style.display = 'block';
    
    // Verifica se TODOS (novos e existentes) est√£o marcados
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    
    // Se tudo estiver marcado, o bot√£o diz "Remover Todos". Sen√£o, "Selecionar Todos".
    const allSelected = allNewSelected && allExistSelected;
    toggleAllBtn.textContent = allSelected ? "Desmarcar Todos" : "Selecionar Todos";
}

toggleAllBtn.addEventListener('click', () => {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    if (totalItems === 0) return;

    // L√≥gica: Se tudo marcado -> desmarca tudo. Sen√£o -> marca tudo.
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    const newState = !(allNewSelected && allExistSelected);

    // 1. Atualiza Dados
    data.new.forEach(i => i.selected = newState);
    data.existing.forEach(i => i.selected = newState);

    // 2. Re-renderiza a lista para atualizar visuais (riscos e checkboxes)
    renderScanTab(currentScanTab);
});

// 5. GEST√ÉO DE ABAS
document.querySelector('.scan-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('scan-tab-btn')) {
        document.querySelectorAll('.scan-tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentScanTab = e.target.dataset.target;
        document.getElementById('scan-preview-popup').style.display = 'none';
        renderScanTab(currentScanTab);
    }
});

// 6. PREVIEW e CONTEXTO
function showScanPreview(name, snippet) {
    const popup = document.getElementById('scan-preview-popup');
    const content = document.getElementById('scan-preview-content');
    const safeName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedHTML = snippet.replace(new RegExp(`(${safeName})`, 'gi'), '<mark>$1</mark>');
    content.innerHTML = `... ${highlightedHTML} ...`;
    popup.style.display = 'block';
}

function getContextSnippet(fullText, index, length) {
    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + length + 40);
    return fullText.substring(start, end);
}

function getApproximateLineNumber(node) {
    const block = node.nodeType === 3 ? node.parentElement.closest('p, div, li, h1, h2') : node.closest('p, div, li, h1, h2');
    if (!block) return 1;
    let count = 1;
    let current = block;
    while (current = current.previousElementSibling) count++;
    return count;
}

// 7. APLICAR MUDAN√áAS (CONVERTER E REVERTER)
document.getElementById('confirm-scan-btn').addEventListener('click', async () => {
    
    // Altera o texto do bot√£o para feedback
    const confirmBtn = document.getElementById('confirm-scan-btn');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = "A processar...";
    confirmBtn.disabled = true;

    let changesMade = false;

    // Percorre TODAS as abas (tipos)
    for (const type in universalScanResults) {
        
        // --- A. CONVERTER NOVOS (Que est√£o selecionados) ---
        const newToConvert = universalScanResults[type].new.filter(i => i.selected);
        
        // Ordena inversamente (baixo para cima) para n√£o estragar √≠ndices
        newToConvert.sort((a, b) => {
            if (a.textNode === b.textNode) return b.index - a.index;
            return 0;
        });

        for (const item of newToConvert) {
            try {
                if (item.textNode.textContent.includes(item.matchText)) {
                    const textNode = item.textNode;
                    const splitTarget = textNode.splitText(item.index);
                    splitTarget.splitText(item.matchText.length); // Isola o texto
                    
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = type;
                    span.dataset.entityName = item.cleanName;
                    span.textContent = item.cleanName;

                    splitTarget.parentNode.replaceChild(span, splitTarget);
                    
                    // Atualiza BD
                    await ensureEntityReference(type, item.cleanName);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro convers√£o:", e); }
        }

        // --- B. REMOVER EXISTENTES (Que foram desmarcados) ---
        const existingToRemove = universalScanResults[type].existing.filter(i => !i.selected);
        
        for (const item of existingToRemove) {
            try {
                const linkEl = item.linkElement;
                if (linkEl && linkEl.parentNode) {
                    const textNode = document.createTextNode(linkEl.textContent);
                    linkEl.parentNode.replaceChild(textNode, linkEl);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro revers√£o:", e); }
        }
    }

    if (changesMade) {
        noteContentEditor.normalize(); // Limpa DOM
        updateSaveStatus('unsaved');
        saveNote();
        
        // Recarrega cache
        if(typeof fetchAllEntities === 'function') fetchAllEntities();
    }

    document.getElementById('universal-scan-modal').style.display = 'none';
    
    // Restaura bot√£o
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
});

// Auxiliar BD (Igual)
async function ensureEntityReference(type, name) {
    const flatEntities = Object.values(allEntities).flat();
    const existing = flatEntities.find(e => e.tipo === type && e.nome === name);
    const collectionName = ENTITY_CONFIG[type].collection;

    if (!existing) {
        try {
            await addDoc(collection(db, collectionName), {
                nome: name, descricao: "", userId: auth.currentUser.uid,
                createdAt: serverTimestamp(), referencias: { [selectedNoteId]: true }
            });
            if(!allEntities[type]) allEntities[type] = [];
            allEntities[type].push({ id: 'temp', nome: name, tipo: type });
        } catch(e) { console.error(e); }
    }
}

// ====================================================================
// L√ìGICA DE CRIA√á√ÉO DE NOVOS MARCADORES (+)
// ====================================================================

// 1. Abrir o popup de criar marcador ao clicar no "+"
const openCreateBookmarkBtn = document.getElementById('open-create-bookmark-btn');
if (openCreateBookmarkBtn) {
    // Removemos o listener antigo para evitar conflitos e criamos um novo
    const newBtn = openCreateBookmarkBtn.cloneNode(true);
    openCreateBookmarkBtn.parentNode.replaceChild(newBtn, openCreateBookmarkBtn);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const modal = document.getElementById('create-bookmark-modal');
        if (!modal) return;

        // --- CORRE√á√ÉO DE HIERARQUIA ---
        // Move o modal para o final do body para n√£o ficar preso atr√°s de outros modais
        document.body.appendChild(modal);
        
        // Limpa os campos
        document.getElementById('new-bookmark-title').value = '';
        document.getElementById('new-bookmark-desc').value = '';
        
        // For√ßa a visibilidade no topo absoluto
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "10000000"; // Um n√≠vel acima do modal anterior
        modal.style.visibility = "visible";
        modal.style.opacity = "1";
        
        // Foca no input
        setTimeout(() => {
            const input = document.getElementById('new-bookmark-title');
            if(input) input.focus();
        }, 100);
    });
}

// 2. Bot√£o Cancelar (Fechar o popup)
const cancelCreateBookmarkBtn = document.getElementById('cancel-create-bookmark');
if (cancelCreateBookmarkBtn) {
    cancelCreateBookmarkBtn.addEventListener('click', () => {
        document.getElementById('create-bookmark-modal').style.display = 'none';
    });
}

// 3. Bot√£o Criar (Gravar na Base de Dados)
const confirmCreateBookmarkBtn = document.getElementById('confirm-create-bookmark');
if (confirmCreateBookmarkBtn) {
    confirmCreateBookmarkBtn.addEventListener('click', async () => {
        const titleInput = document.getElementById('new-bookmark-title');
        const descInput = document.getElementById('new-bookmark-desc');
        
        const nome = titleInput.value.trim();
        const descricao = descInput.value.trim();

        if (!nome) {
            alert("O t√≠tulo do marcador √© obrigat√≥rio.");
            return;
        }

        // Feedback visual
        const originalText = confirmCreateBookmarkBtn.textContent;
        confirmCreateBookmarkBtn.textContent = "A criar...";
        confirmCreateBookmarkBtn.disabled = true;

        try {
            // Importar fun√ß√µes do Firestore (j√° devem estar importadas no topo do seu ficheiro)
            // addDoc, collection, serverTimestamp, auth, db...

            await addDoc(collection(db, 'marcadores'), {
                nome: nome,
                descricao: descricao,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Sucesso: Fecha o modal e recarrega a lista
            document.getElementById('create-bookmark-modal').style.display = 'none';
            
            // Recarrega a lista do modal principal para mostrar o novo item
            await openBookmarksModal(); 

        } catch (error) {
            console.error("Erro ao criar marcador:", error);
            alert("Erro ao criar o marcador. Verifique a consola.");
        } finally {
            // Restaura o bot√£o
            confirmCreateBookmarkBtn.textContent = originalText;
            confirmCreateBookmarkBtn.disabled = false;
        }
    });
}

  noteContentEditor.addEventListener('keyup', (event) => {
    // Ignora teclas de navega√ß√£o
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(event.key)) {
        return;
    }
    
    if (isTagPopupOpen || isEntityPopupOpen) {
        if (['Enter', ' '].includes(event.key)) return;
    }

    if (event.key === 'Escape') { 
        hideTagPopup();
        hideEntityPopup();
        return; 
    }

    const selection = window.getSelection();
    if (!selection.rangeCount > 0) return;
    const range = selection.getRangeAt(0);
    const container = range.startContainer;
    const offset = range.startOffset;

    // Texto ANTES do cursor
    const textBeforeCursor = container.textContent.substring(0, offset);
    
    // Texto DEPOIS do cursor
    const textAfterCursor = container.textContent.substring(offset);

    const tagMatch = textBeforeCursor.match(/#(\w*)$/);
    const entityMatch = textBeforeCursor.match(/@([\w\s]*)$/);

    if (tagMatch) {
        hideEntityPopup();
        currentTagQueryRange = document.createRange();
        currentTagQueryRange.setStart(container, tagMatch.index);
        currentTagQueryRange.setEnd(container, offset);
        showTagPopup(tagMatch[1]);

    } else if (entityMatch) {
        hideTagPopup();
        currentEntityQueryRange = document.createRange();
        
        // Ponto de in√≠cio: onde est√° o @
        currentEntityQueryRange.setStart(container, entityMatch.index);

        // --- L√ìGICA DE "ETIQUETAGEM INTELIGENTE" ---
        
        // Verifica se o utilizador acabou de digitar o @ (query vazia)
        // E se existe uma palavra "colada" logo √† frente do cursor
        const isAtStartOfWord = entityMatch[1] === '' && /^\w/.test(textAfterCursor);

        if (isAtStartOfWord) {
            // Identifica a palavra que est√° √† frente (ex: "David" em "@|David")
            const wordAfterMatch = textAfterCursor.match(/^(\w+)/);
            
            if (wordAfterMatch) {
                const wordToConsume = wordAfterMatch[1];
                
                // Expande o range de substitui√ß√£o para incluir a palavra da frente
                currentEntityQueryRange.setEnd(container, offset + wordToConsume.length);
                
                // Usa a palavra da frente como pesquisa para o popup
                showEntityPopup(wordToConsume);
                return; // Sai para n√£o executar o showEntityPopup normal abaixo
            }
        }

        // Comportamento normal (escrevendo novo texto)
        currentEntityQueryRange.setEnd(container, offset);
        showEntityPopup(entityMatch[1]);

    } else {
        hideTagPopup();
        hideEntityPopup();
    }
    
});



// 1. ESCUTAR O CLIQUE NO BOT√ÉO üß¨
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="append-mini-note"]');
    if (!btn) return;

    e.preventDefault(); e.stopPropagation();

    // Captura o HTML da caixa inteira
    const wrapper = btn.closest('.mini-note-wrapper');
    if (wrapper) {
        // Clonamos para garantir que n√£o alteramos o original durante a c√≥pia
        htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
        openAppendModal();
    }
});

// 2. ABRIR O MODAL
window.openAppendModal = function() {
    console.log("üöÄ [CLONAR] Abertura iniciada...");
    
    const modal = document.getElementById('append-to-note-modal');
    if (!modal) return console.error("Modal #append-to-note-modal n√£o encontrado!");

    // 1. MOVE PARA O BODY (Camada Superior para sair de dentro de divs com overflow)
    document.body.appendChild(modal);

    // 2. FOR√áA VISIBILIDADE E Z-INDEX ALTO (Para ficar acima do Aqu√°rio)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        justify-content: center !important;
        align-items: center !important;
    `;

    // 3. RESET DA NAVEGA√á√ÉO INTERNA
    appendStack = [];
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    // Chama a fun√ß√£o de carregar lista (esta pode ficar local, pois √© chamada daqui de dentro)
    loadAppendList(rootId);
};

// 3. CARREGAR LISTA (PASTAS E NOTAS)
async function loadAppendList(parentId) {
    const list = document.getElementById('append-list');
    const backBtn = document.getElementById('append-back-btn');
    const pathLabel = document.getElementById('append-current-path');
    const myUid = auth.currentUser.uid;
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    // Identifica o ponto de partida (Raiz Global ou ID da Superpasta)
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    // Gest√£o de T√≠tulos e Bot√£o Voltar (Breadcrumbs)
    if (parentId === "VIRTUAL_SHARED_ROOT") {
        pathLabel.textContent = "ü§ù Partilha";
        backBtn.style.display = 'block';
    } else if (appendStack.length > 0) {
        pathLabel.textContent = appendStack[appendStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathLabel.textContent = (startRootId) ? "üè† Superpasta" : "üåç Raiz Global";
        backBtn.style.display = 'none';
    }

    try {
        const foldersRef = collection(db, 'pastas');
        let unifiedDocs = new Map();

        // --- BLOCO A: BUSCAR ARQUIVOS PARTILHADOS (Se estivermos dentro da "pasta" Partilha) ---
        if (parentId === "VIRTUAL_SHARED_ROOT") {
            const qOwner = query(foldersRef, 
                where('tipo', '==', 'partilhado'), 
                where('estado', '==', 'ativa'),
                where('userId', '==', myUid)
            );
            const qCollab = query(foldersRef, 
                where('tipo', '==', 'partilhado'), 
                where('estado', '==', 'ativa'),
                where(`colaboradores.${myUid}`, '==', true)
            );

            const [snapOwner, snapCollab] = await Promise.all([getDocs(qOwner), getDocs(qCollab)]);
            snapOwner.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
            snapCollab.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
        } 
        // --- BLOCO B: BUSCAR PASTAS E NOTAS LOCAIS (Comportamento normal) ---
        else {
            const qNormal = query(foldersRef,
                where('parentId', '==', parentId),
                where('estado', '==', 'ativa'),
                where('userId', '==', myUid),
                orderBy('tipo'),
                orderBy('nome')
            );
            const snapNormal = await getDocs(qNormal);
            snapNormal.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
        }

        // LIMPAR LISTA E COME√áAR A RENDERIZAR
        list.innerHTML = '';

        // 1. INJETAR O ACESSO √Ä PARTILHA (Apenas se estivermos no "in√≠cio" da navega√ß√£o)
        if (parentId === startRootId) {
            const sharedLink = document.createElement('li');
            sharedLink.style.cssText = "display:flex; justify-content:space-between; padding:12px; border-bottom:2px solid var(--border-color); background: rgba(231, 76, 60, 0.05); cursor:pointer; color: #e74c3c; font-weight: bold;";
            sharedLink.innerHTML = `<span>ü§ù Partilha (Arquivos)</span> <span>‚ûî</span>`;
            sharedLink.onclick = () => loadAppendList("VIRTUAL_SHARED_ROOT");
            list.appendChild(sharedLink);
        }

        // 2. RENDERIZAR AS PASTAS E NOTAS LOCAIS (O que tinha desaparecido)
        if (unifiedDocs.size === 0 && parentId !== startRootId && parentId !== null) {
            list.innerHTML += '<li style="padding:20px; color:#888; text-align:center;">Vazio.</li>';
        }

        Array.from(unifiedDocs.values())
        .sort((a, b) => (a.tipo === b.tipo) ? (a.nome || "").localeCompare(b.nome || "") : (a.tipo === 'pasta' ? -1 : 1))
        .forEach(item => {
            const li = document.createElement('li');
            li.className = "list-item";
            li.style.cssText = "display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border-color); cursor:pointer;";
            
            if (item.tipo === 'pasta') {
                li.innerHTML = `<span>üìÅ ${item.nome}</span> <span>‚ûî</span>`;
                li.onclick = () => {
                    appendStack.push({ id: item.id, name: item.nome });
                    loadAppendList(item.id);
                };
            } else {
                const isOwner = item.userId === myUid;
                const icon = (item.tipo === 'partilhado' || item.tipo === 'arquivo') ? 'üóÑÔ∏è' : 'üìÑ';
                const collabIcon = (parentId === "VIRTUAL_SHARED_ROOT") ? (isOwner ? 'üëë' : 'ü§ù') : '';
                
                li.innerHTML = `
                    <span>${icon} ${collabIcon} ${item.nome}</span> 
                    <span title="Enviar para o Topo">üì•</span>
                `;
                li.onclick = () => confirmAppendToNote(item.id, item.nome, item.tipo);
            }
            list.appendChild(li);
        });

    } catch (e) {
        console.error("Erro no modal:", e);
        list.innerHTML = '<li>Erro de liga√ß√£o.</li>';
    }
}

// 4. BOT√ÉO VOLTAR (L√≥gica de "Escape" da Superpasta)
// Remova o listener antigo e coloque este:
const appendBackBtn = document.getElementById('append-back-btn');
// Clonamos para remover listeners antigos e evitar duplica√ß√£o
const newAppendBackBtn = appendBackBtn.cloneNode(true);
appendBackBtn.parentNode.replaceChild(newAppendBackBtn, appendBackBtn);

newAppendBackBtn.addEventListener('click', () => {
    // Verifica se estamos numa Superpasta
    const superRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (appendStack.length > 0) {
        // Comportamento normal: remove o √∫ltimo passo
        appendStack.pop();
        
        // Se a pilha ainda tiver itens, carrega o anterior.
        // Se ficou vazia, carrega o ponto de partida (que √© o superRootId)
        const parent = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : superRootId;
        
        loadAppendList(parent);
    } else {
        // A pilha est√° vazia, mas clic√°mos em "Voltar".
        // Isso significa que estamos na raiz da Superpasta e queremos ir para a GLOBAL.
        loadAppendList(null);
    }
});

// 5. CONFIRMAR E GRAVAR
window.confirmAppendToNote = async function(targetId, targetName, targetType) {
    console.log(`üì• [CLONAR] A enviar para: ${targetName}`);

    const confirmModal = document.getElementById('confirm-modal');
    const appendModal = document.getElementById('append-to-note-modal');

    // 1. REBAIXAR O MODAL "ENVIAR PARA..."
    // (Para o popup de "Tem a certeza?" ficar por cima dele)
    if (appendModal) {
        appendModal.style.zIndex = '2147483640'; 
    }

    // 2. ELEVAR O MODAL DE CONFIRMA√á√ÉO AO TOPO ABSOLUTO
    document.body.appendChild(confirmModal); 
    confirmModal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        z-index: 2147483647 !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        justify-content: center !important;
        align-items: center !important;
        top: 0; left: 0; width: 100vw; height: 100vh;
    `;

    // 3. EXECUTAR A CONFIRMA√á√ÉO
    const confirmed = await showConfirmation(
        "Confirmar Envio", 
        `Deseja clonar este bloco para o Topo de "${targetName}"?`
    );

    // 4. L√ìGICA DE RETORNO OU SUCESSO
    if (!confirmed) {
        // Se cancelar, restaura o modal de lista
        if (appendModal) appendModal.style.zIndex = '2147483647';
        confirmModal.style.display = 'none';
        return;
    }

    // Se confirmou, processa a grava√ß√£o
    try {
        const { doc, getDoc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', targetId);
        const docSnap = await getDoc(noteRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Grava√ß√£o para Arquivo ou Nota
            if (targetType === 'partilhado' || targetType === 'arquivo') {
                const authorName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
                const newPost = {
                    id: 'post_' + Date.now(),
                    type: 'entity',
                    title: 'Recebido do Aqu√°rio',
                    content: window.htmlToAppend, // Usa a vari√°vel global
                    createdBy: authorName,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                const updatedPosts = [newPost, ...(data.posts || [])];
                await updateDoc(noteRef, { posts: updatedPosts, ultimaedicao: serverTimestamp() });
            } else {
                const currentContent = data.conteudo || "";
                await updateDoc(noteRef, {
                    conteudo: window.htmlToAppend + "<p><br></p>" + currentContent,
                    ultimaedicao: serverTimestamp()
                });
            }

            // FECHO TOTAL AP√ìS SUCESSO
            confirmModal.style.display = 'none';
            if (appendModal) appendModal.style.display = 'none';
            
            alert(`Enviado para "${targetName}" com sucesso!`);
        }
    } catch (e) {
        console.error("Erro ao enviar:", e);
        alert("Erro ao realizar o envio.");
    }
};


// --- FUN√á√ÉO UNIFICADA DE PARTILHA E CO-EDI√á√ÉO ---
async function updateSharingSettings() {
    if (!selectedNoteId || !auth.currentUser) return;

    try {
        const isShared = document.getElementById('note-share-toggle').checked;
        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        let shareId = currentNoteShareData?.shareId || selectedNoteId;

        // 1. Atualizar Nota Privada
        const newSettings = {
            ...currentNoteShareData, // Mant√©m defini√ß√µes existentes (como collab)
            shared: isShared,
            shareId: shareId,
            updatedAt: serverTimestamp()
        };

        await updateDoc(noteRef, { shareSettings: newSettings });
        currentNoteShareData = newSettings;

        // 2. Gerir Documento P√∫blico
        if (isShared) {
            
            // Obter dados atuais para garantir que n√£o enviamos lixo
            const currentTitle = document.getElementById('archive-title-input').value || 
                               document.getElementById('note-title-input').value || 
                               "Sem T√≠tulo";

            // Nome do Autor Robusto
            let finalAuthorName = "An√≥nimo";
            if (currentUserData && currentUserData.nome) finalAuthorName = currentUserData.nome;
            else if (auth.currentUser.email) finalAuthorName = auth.currentUser.email.split('@')[0];

            // Detetar se √© Arquivo ou Nota
            // (Verifica se estamos no modo arquivo ou nota normal)
            const isArchive = document.getElementById('archive-area').style.display !== 'none';
            const docType = isArchive ? 'arquivo' : 'full_note';
            
            // Dados a enviar
            const publicData = {
                nome: currentTitle,
                authorName: finalAuthorName,
                authorId: auth.currentUser.uid,
                isPublic: true,
                sharedAt: serverTimestamp(),
                type: docType,
                originalNoteId: selectedNoteId
            };

            // Se for arquivo, anexa os posts. Se for nota, anexa o conteudo.
            if (isArchive) {
                publicData.posts = currentArchiveData.posts || [];
            } else {
                publicData.conteudo = document.getElementById('note-content-editor').innerHTML;
            }
            
            await setDoc(doc(db, 'shared_notes', shareId), publicData, { merge: true });
            
            // Gerar link visualmente
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            document.getElementById('note-share-url').value = `${baseUrl}/sharenote.html?id=${shareId}`;

        } else {
            // Se desligar a partilha, apaga o documento p√∫blico
            await deleteDoc(doc(db, 'shared_notes', shareId));
        }

    } catch (e) {
        console.error("Erro partilha:", e);
    }
}

// Fun√ß√£o auxiliar para copiar
window.copyLink = function(elementId) {
    const input = document.getElementById(elementId);
    input.select();
    document.execCommand('copy');
    // Feedback visual breve
    const originalBg = input.style.backgroundColor;
    input.style.backgroundColor = "rgba(46, 204, 113, 0.2)";
    setTimeout(() => input.style.backgroundColor = originalBg, 500);
}



    // --- Listener para o Bot√£o de Colapsar/Expandir o Painel do Meio ---
const middlePanelToggleBtn = document.getElementById('middle-panel-toggle-btn');

if (middlePanelToggleBtn) { 
    middlePanelToggleBtn.addEventListener('click', () => {
        // Liga/Desliga a classe CSS
        const isCollapsed = notebookContainer.classList.toggle('middle-panel-collapsed');
        
        // Muda o √≠cone
        if (isCollapsed) {
            middlePanelToggleBtn.textContent = '¬ª'; 
            middlePanelToggleBtn.title = "Restaurar Painel";
        } else {
            middlePanelToggleBtn.textContent = '‚Üñ'; 
            middlePanelToggleBtn.title = "Expandir Lista";
        }
    });
}



// --- EVENTO PARA FECHAR O MENU AO CLICAR NOS PAIN√âIS LATERAIS ---
// Isto garante que o menu üìòüìóüìôüìí desapare√ßa ao navegar pelas pastas ou notas
document.getElementById('left-panel').addEventListener('click', () => {
    const insPopup = document.getElementById('insertion-popup');
    if (insPopup) insPopup.style.display = 'none';
});

document.getElementById('middle-panel').addEventListener('click', () => {
    const insPopup = document.getElementById('insertion-popup');
    if (insPopup) insPopup.style.display = 'none';
});

// Outros Listeners
document.addEventListener('click', (e) => {
    // 1. Fechar Context Menu
    if (!e.target.closest('.context-menu')) hideContextMenu();
    
    // 2. Fechar Tag Popup
    const tagPop = document.getElementById('tag-suggestion-popup');
    if (tagPop && !noteContentEditor.contains(e.target) && !tagPop.contains(e.target)) hideTagPopup();

    // 3. Fechar Formatting Popup (Aqui estava o erro)
    const fPopup = document.getElementById('formatting-popup');
    const fBtn = document.getElementById('more-formatting-btn');
    if (fPopup && fPopup.style.display === 'block') {
        if (!fPopup.contains(e.target) && e.target !== fBtn) {
            fPopup.style.display = 'none';
            if (fBtn) fBtn.classList.remove('active');
        }
    }
});

leftPanelToggleBtn.addEventListener('click', () => {
    notebookContainer.classList.toggle('left-panel-collapsed');
});


// Listener do bot√£o "+" (Adicionar Item)
addItemBtn.addEventListener('click', async () => {
    
    // 1. GRAVA√á√ÉO DE SEGURAN√áA
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        console.log("üíæ Gravando altera√ß√µes antes de abrir criador...");
        await saveNote(true); 
    }

    // --- C√ìDIGO DA ABA LISTS (CORRIGIDO) ---
    if (currentTab === 'lists') {
        const rootCategoryId = navigationStack[0]?.id;

        // 1. MARCADORES
        if (rootCategoryId === 'marcadores') { 
            openCreateBookmarkPopup(); 
            return; 
        }

        // 2. T√ìPICOS (A CORRE√á√ÉO EST√Å AQUI)
        if (rootCategoryId === 'topico') { 
            const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina, Estudo Pessoal...");
            if (result && result.name) {
                try {
                    const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    await addDoc(collection(db, 'topicos'), {
                        nome: result.name,
                        descricao: result.description || "",
                        userId: auth.currentUser.uid,
                        estado: 'ativa',
                        createdAt: serverTimestamp()
                    });
                    // Atualiza a lista imediatamente
                    renderListCategoryItems('topico');
                } catch (e) {
                    console.error("Erro ao criar t√≥pico:", e);
                    alert("Erro ao criar t√≥pico.");
                }
            }
            return; 
        } 

        // 3. ENTIDADES (Personagem, Local, Data)
        if (['personagem', 'local', 'data'].includes(rootCategoryId)) { 
            openEntityModal(rootCategoryId, ""); 
            return; 
        }

        // 4. COSMOS (A CORRE√á√ÉO EST√Å AQUI)
        if (rootCategoryId === 'cosmos') { 
            // Verifica se estamos na raiz (Temas) ou dentro de um tema (Subtemas)
            const parentItem = navigationStack.length > 1 ? navigationStack[navigationStack.length - 1] : null;

            if (parentItem && parentItem.type === 'cosmos-parent') {
                // Criar Subtema
                openCosmosCreator('subcosmos', parentItem.id);
            } else {
                // Criar Tema Principal
                openCosmosCreator('cosmos');
            }
            return; 
        }

        return; // Sai se n√£o for nenhuma das categorias acima
    }

    // ============================================================
    // CASO B: ABA NOTE (Configura√ß√£o do Modal) - Mant√©m-se igual
    // ============================================================
    const modal = document.getElementById('add-item-modal');
    if (!modal) return;

    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";

    const modalTitle = modal.querySelector('h3');
    
    const addFolderBtn = modal.querySelector('button[data-type="pasta"]');
    const addNoteBtn = modal.querySelector('button[data-type="nota"]');
    const addAgregBtn = modal.querySelector('button[data-type="agregacao"]');
    const addArchiveBtn = modal.querySelector('button[data-type="arquivo"]');
    const addJornalBtn = modal.querySelector('button[data-type="jornal"]');
    const addAquarioBtn = modal.querySelector('button[data-type="aquario"]'); 

    newItemNameInput.value = '';
    newItemNameInput.style.display = 'none';
    document.getElementById('confirm-item-addition').style.display = 'none';
    document.getElementById('add-item-options').style.display = 'flex';

    if (currentViewMode === 'flash') {
        modalTitle.textContent = "‚ö° Cria√ß√£o R√°pida";
        modalTitle.style.color = "#e67e22"; 
        if(addNoteBtn) addNoteBtn.style.display = 'block';     
        if(addJornalBtn) addJornalBtn.style.display = 'block'; 
        if(addFolderBtn) addFolderBtn.style.display = 'none';
        if(addAgregBtn) addAgregBtn.style.display = 'none';
        if(addArchiveBtn) addArchiveBtn.style.display = 'none';
        if(addAquarioBtn) addAquarioBtn.style.display = 'none';
        return; 
    } 
    else if (currentViewMode === 'shared') {
        modalTitle.textContent = "Adicionar Item Partilhado";
        modalTitle.style.color = ""; 
        if(addFolderBtn) addFolderBtn.style.display = 'none';
        if(addNoteBtn) addNoteBtn.style.display = 'none';
        if(addAgregBtn) addAgregBtn.style.display = 'none';
        if(addArchiveBtn) addArchiveBtn.style.display = 'block'; 
        if(addJornalBtn) addJornalBtn.style.display = 'none';
        if(addAquarioBtn) addAquarioBtn.style.display = 'none';
    } 
    else {
        modalTitle.textContent = "Adicionar Item";
        modalTitle.style.color = ""; 
        
        let isInSharedFolder = false;
        if (navigationStack.length > 0) {
            const currentFolder = navigationStack[navigationStack.length - 1];
            if (currentFolder.name === 'Partilhadas') isInSharedFolder = true;
        }

        if (isInSharedFolder) {
            if(addFolderBtn) addFolderBtn.style.display = 'none';
            if(addAgregBtn) addAgregBtn.style.display = 'none';
            if(addNoteBtn) addNoteBtn.style.display = 'block';
            if(addArchiveBtn) addArchiveBtn.style.display = 'block';
            if(addJornalBtn) addJornalBtn.style.display = 'block';
            if(addAquarioBtn) addAquarioBtn.style.display = 'block';
        } 
        else if (navigationStack.length === 0) {
            if(addFolderBtn) addFolderBtn.style.display = 'block';
            if(addAgregBtn) addAgregBtn.style.display = 'block'; 
            if(addNoteBtn) addNoteBtn.style.display = 'none'; 
            if(addArchiveBtn) addArchiveBtn.style.display = 'block';
            if(addJornalBtn) addJornalBtn.style.display = 'block';
            if(addAquarioBtn) addAquarioBtn.style.display = 'block';
        } 
        else {
            if(addFolderBtn) addFolderBtn.style.display = 'block';
            if(addAgregBtn) addAgregBtn.style.display = 'block'; 
            if(addNoteBtn) addNoteBtn.style.display = 'block';
            if(addArchiveBtn) addArchiveBtn.style.display = 'block';
            if(addJornalBtn) addJornalBtn.style.display = 'block';
            if(addAquarioBtn) addAquarioBtn.style.display = 'block';
        }
    }
});


// ====================================================================
// FOR√áAR COLAGEM COMO TEXTO SIMPLES (PLAIN TEXT)
// ====================================================================
 document.addEventListener('paste', (e) => {
    // 1. Verifica se estamos num campo edit√°vel
    const target = e.target;
    const isEditable = target.isContentEditable || 
                       (target.tagName === 'INPUT' && target.type === 'text') ||
                       target.tagName === 'TEXTAREA';

    if (!isEditable) return;

    // 2. Impede o comportamento padr√£o
    e.preventDefault();

    // 3. Obt√©m apenas o texto limpo
    let text = (e.clipboardData || window.clipboardData).getData('text/plain');

    // >>> CORRE√á√ÉO AQUI: Remove espa√ßos vazios antes e depois <<<
    text = text.trim(); 

    // 4. Se estiver dentro de Toggle ou Mini-Nota, usa <br>
    if (target.closest('.toggle-content') || target.closest('.mini-note-content')) {
        // Substitui quebras de linha por <br>
        const htmlContent = text.replace(/\r\n|\r|\n/g, '<br>');
        document.execCommand('insertHTML', false, htmlContent);
    } else {
        // Nos outros s√≠tios, texto normal
        document.execCommand('insertText', false, text);
    }
    
    // 5. Grava
    if (typeof saveNote === 'function') {
        if (target.id === 'note-content-editor' || target.closest('#note-content-editor')) {
            saveNote(); 
        }
    }
});


let itemTypeToAdd = '';
document.getElementById('add-item-options').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    
    itemTypeToAdd = btn.dataset.type;

    // --- NOVA L√ìGICA: CRIA√á√ÉO IMEDIATA NO MODO FLASH ---
    if (currentViewMode === 'flash') {
        // 1. Gera um nome autom√°tico (Ex: Flash Note 10:45)
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        const defaultName = (itemTypeToAdd === 'jornal') ? `Jornal Flash ${timeString}` : `Nota Flash ${timeString}`;
        
        // 2. Preenche o input invis√≠vel
        newItemNameInput.value = defaultName;
        
        // 3. Simula o clique no bot√£o "Criar" para executar a fun√ß√£o de cria√ß√£o existente
        document.getElementById('confirm-item-addition').click();
        
        return; // P√°ra aqui, n√£o mostra o input de t√≠tulo
    }
    // ---------------------------------------------------

    // Comportamento normal (pede t√≠tulo)
    document.getElementById('add-item-options').style.display = 'none';
    newItemNameInput.style.display = 'block';
    newItemNameInput.placeholder = `Nome d${itemTypeToAdd === 'pasta' ? 'a' : 'a'} ${itemTypeToAdd}...`;
    newItemNameInput.focus();
    document.getElementById('confirm-item-addition').style.display = 'block';
});

document.getElementById('confirm-item-addition').addEventListener('click', async () => {
    const confirmBtn = document.getElementById('confirm-item-addition');
    if (confirmBtn.disabled) return;

    const itemName = newItemNameInput.value.trim();
    if (!itemName || !itemTypeToAdd) return;

    // --- L√ìGICA DE AGREGA√á√ÉO (Mant√©m-se √† parte) ---
    if (itemTypeToAdd === 'agregacao') {
        aggregationTargetName = itemName;
        aggregationParentId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
        if (!aggregationParentId && typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) aggregationParentId = SUPERFOLDER_ID;
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';
        openAggregationSelector();
        return; 
    }

    try {
        confirmBtn.disabled = true;
        confirmBtn.textContent = "A criar...";

        // Determina o Parent ID
        let parentId = null;
        if (navigationStack.length > 0) {
            parentId = navigationStack[navigationStack.length - 1].id;
        } else if (currentViewMode === 'shared') {
            parentId = null; 
        } else if (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) {
            parentId = SUPERFOLDER_ID;
        }

        // Calcula Ordem
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', parentId), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
           const newOrder = 0 - Date.now();

        // Dados Base
        const docData = {
            nome: itemName,
            parentId: parentId, // Ser√° null na raiz, ou o ID da pasta se estiver dentro de uma
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ordem: newOrder,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        };

        // --- NOVA L√ìGICA: MARCAR COMO FLASH ---
        if (currentViewMode === 'flash') {
            docData.oque = 'flash'; // Marca o item como pertencente √† aba Flash
            // No modo Flash, for√ßamos o parentId a null para n√£o ficar preso numa pasta visualmente,
            // ou mantemos se quiser que ele exista "fisicamente" numa pasta mas apare√ßa na aba Flash.
            // Para "aparecer apenas na aba Flash" e ser partilh√°vel, geralmente o parentId √© indiferente
            // desde que a query da aba Flash ignore o parentId.
        }

        

        // =========================================================
        // L√ìGICA DE TIPOS
        // =========================================================
        
        // 1. ARQUIVO / PARTILHADO
        if (itemTypeToAdd === 'arquivo') {
            if (currentViewMode === 'shared') {
                docData.tipo = 'partilhado';
                docData.partilhado = "inativo";
            } else {
                docData.tipo = 'arquivo';
                docData.partilhado = "pessoal";
            }
            docData.posts = [];
            docData.deletedPosts = [];
            docData.colaboradores = { [auth.currentUser.uid]: true };
        }
        
        // 2. JORNAL
        else if (itemTypeToAdd === 'jornal') {
            docData.tipo = 'jornal'; 
            docData.conteudo = '';
            docData.tags = [];
        }
        
        // 3. AQU√ÅRIO (NOVO) ü™∏
         else if (itemTypeToAdd === 'aquario') {
            docData.tipo = 'aquario';
            docData.conteudo = ''; 
            docData.customData = {}; 
        }
        
        // 4. PADR√ÉO (NOTA OU PASTA)
        else {
            docData.tipo = itemTypeToAdd;
            if (itemTypeToAdd === 'nota') {
                docData.conteudo = '';
                docData.tags = [];
            }
        }

        // CRIA√á√ÉO NO FIREBASE
        const docRef = await addDoc(collection(db, 'pastas'), docData);

        // FECHO DO MODAL
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';

        // =========================================================
        // L√ìGICA DE ABERTURA AP√ìS CRIAR
        // =========================================================
        
        // A. Abrir Aqu√°rio (NOVO)
        if (docData.tipo === 'aquario') {
            // Prepara os dados locais para n√£o precisar de ler do firebase de novo
            const localData = { id: docRef.id, ...docData };
            // Abre o ambiente
            window.openAquariumEnvironment(docRef.id, localData);
        } 
        
        // B. Abrir Nota ou Jornal
          else if (docData.tipo === 'nota' || docData.tipo === 'jornal') {
            displayNote(docRef.id, null);

            // --- NOVO: FOCAR NO EDITOR AUTOMATICAMENTE ---
            setTimeout(() => {
                const editor = document.getElementById('note-content-editor');
                if (editor) {
                    // 1. Foca o elemento
                    editor.focus();
                    
                    // 2. Garante que o cursor est√° l√° a piscar (Range)
                    const range = document.createRange();
                    range.selectNodeContents(editor);
                    range.collapse(false); // Colapsa para o fim (embora esteja vazia)
                    
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }, 600); // 600ms de atraso para dar tempo √† nota de carregar do Firebase
        }
        
        // C. Abrir Arquivo
        else if (docData.tipo === 'arquivo' || docData.tipo === 'partilhado') {
            displayArchive(docRef.id, { ...docData, id: docRef.id });
        } 
        
        // D. Entrar na Pasta
        else if (docData.tipo === 'pasta') {
            navigationStack.push({ id: docRef.id, name: itemName });
            updateNavigationView();
            resetEditor();
        }

    } catch (error) {
        console.error("Erro ao criar item:", error);
        alert("Erro ao criar o item.");
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Criar";
    }
});


document.getElementById('context-menu').addEventListener('click', async (e) => {
    // 1. Identifica o bot√£o clicado na grelha
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    if (!action) return;

    // 2. Captura os dados do item (pasta/nota) e fecha o menu de op√ß√µes imediatamente
    const itemContext = { ...activeItemContext };
    hideContextMenu(); 

    try {
        // --- A√á√ÉO: RENOMEAR (‚úèÔ∏è) ---
        if (action === 'rename') {
            openRenameModal(itemContext.name, async (newName) => {
                const collectionName = (itemContext.type === 'cosmos-parent') ? 'cosmos' : 'pastas';
                await updateDoc(doc(db, collectionName, itemContext.id), {
                    nome: newName,
                    ultimaedicao: serverTimestamp()
                });
                
                // Atualiza o t√≠tulo no editor se a nota renomeada for a que est√° aberta
                if (selectedNoteId && itemContext.id === selectedNoteId) {
                    const titleInput = document.getElementById('note-title-input');
                    if(titleInput) titleInput.value = newName;
                }
            });
        }

        // --- A√á√ÉO: MOVER DE PASTA (üìÇ) ---
        else if (action === 'move-folder') {
            await openMoveToFolderModal(itemContext);
        }

        // --- A√á√ÉO: MOVER POSI√á√ÉO/ORDEM (‚ÜïÔ∏è) ---
        else if (action === 'move-position') {
            await openMoveModal(itemContext);
        }

        // --- A√á√ÉO: ALTERNAR PIN (üìå) ---
        else if (action === 'toggle-pin') {
            const newState = !itemContext.isPinned;
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                isPinned: newState,
                ultimaedicao: serverTimestamp()
            });
        }

        // --- A√á√ÉO: PROTEGER COM SENHA (üîí) ---
        else if (action === 'protect') {
            const newPass = await requestPassword('create', itemContext.id);
            if (newPass) {
                await updateDoc(doc(db, 'pastas', itemContext.id), {
                    passe: newPass,
                    ultimaedicao: serverTimestamp()
                });
            }
        }

        // --- A√á√ÉO: REMOVER PROTE√á√ÉO (üîì) ---
        else if (action === 'unprotect') {
            const authorized = await requestPassword('remove', itemContext.id);
            if (authorized === true) {
                sessionUnlockedFolders.delete(itemContext.id);
                // A fun√ß√£o requestPassword('remove') j√° trata a exclus√£o no Firebase
            }
        }

        // --- A√á√ÉO: ANEXAR T√ìPICOS (üè∑Ô∏è) ---
        else if (action === 'manage-topics') {
            openTopicsModal(itemContext.id, itemContext.type);
        }

        // --- A√á√ÉO: TORNAR SUPERPASTA (üóÉÔ∏è) ---
        else if (action === 'toggle-superfolder') {
            const newState = !itemContext.isSuperfolder;
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                superpasta: newState,
                ultimaedicao: serverTimestamp()
            });
            window.location.reload(); // Recarrega para aplicar isolamento de raiz
        }

        // --- A√á√ÉO: MUDAR √çCONE (SUPERPASTA) ---
        else if (action === 'change-icon') {
            const modal = document.getElementById('icon-picker-modal');
            if (modal) {
                modal.dataset.targetFolderId = itemContext.id;
                modal.style.display = 'flex';
                document.body.appendChild(modal); // Garante visibilidade
            }
        }

        // --- A√á√ÉO: OCULTAR/MOVER PARA LIXEIRA (üóëÔ∏è) ---
       else if (action === 'hide') {
            const confirmed = await showConfirmation(
                'Ocultar Item?', 
                `Deseja mover "${itemContext.name}" para a lixeira?`
            );
            
            if (confirmed) {
                const collectionName = (itemContext.type === 'cosmos-parent') ? 'cosmos' : 'pastas';
                
               // 1. Atualiza no Firebase (Oculta a nota)
        await updateDoc(doc(db, collectionName, itemContext.id), { 
            estado: 'desativa',
            ultimaedicao: serverTimestamp()
        });

        // -----------------------------------------------------------
        // 2. NOVA CHAMADA: Limpa os Puzzles associados
        if (collectionName === 'pastas') {
            // Executa em background (n√£o precisa esperar para fechar o menu)
            cleanUpHiddenNoteReferences(itemContext.id);
        }
        // -----------------------------------------------------------

        // 3. L√≥gica visual existente...
        if (selectedNoteId === itemContext.id) {
            console.log("üôà A fechar editor pois a nota ativa foi ocultada.");
            resetEditor();
        }
            }
        }

    } catch (error) {
        console.error(`Erro ao executar a a√ß√£o ${action}:`, error);
        alert("Ocorreu um erro ao processar o seu pedido.");
    }
});


document.querySelectorAll('.modal-overlay [data-action="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal-overlay').style.display = 'none';
    });
});

// Listener para abrir o Modal de Configura√ß√µes
document.getElementById('settings-btn').addEventListener('click', () => {
    
    // --- CORRE√á√ÉO: Sincronizar interruptores com as vari√°veis guardadas ---
    // Isto garante que, se estiver True na mem√≥ria, o bot√£o aparece Ligado
    if (document.getElementById('setting-search-tags')) 
        document.getElementById('setting-search-tags').checked = appSettings.searchTagsInProtected;
    
    if (document.getElementById('setting-search-topics')) 
        document.getElementById('setting-search-topics').checked = appSettings.searchTopicsInProtected;
    
    if (document.getElementById('setting-search-anchors')) 
        document.getElementById('setting-search-anchors').checked = appSettings.searchAnchorsInProtected;
    
    if (document.getElementById('setting-global-search-superfolder')) 
        document.getElementById('setting-global-search-superfolder').checked = appSettings.searchGlobalInSuperfolder;

    // >>> A CORRE√á√ÉO PRINCIPAL PARA O SEU PROBLEMA <<<
    if (document.getElementById('setting-full-titles')) 
        document.getElementById('setting-full-titles').checked = appSettings.showFullTitles;

    // Mostrar o modal
    document.getElementById('settings-modal').style.display = 'flex';
});

document.getElementById('settings-modal').addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    if (action === 'show-hidden-items') {
        document.getElementById('settings-modal').style.display = 'none';
        showHiddenItemsModal();
    }
});

document.getElementById('hidden-items-list').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const collectionName = btn.dataset.collection; // Novo atributo que diz qual a tabela (pastas, personagens, etc)
    const listItem = btn.closest('li');

    // --- RESTAURAR ---
    if (action === 'restore-universal') {
        if (!confirm("Restaurar este item?")) return;

        try {
            // Remove o estado 'desativa' (apaga o campo ou muda para ativa)
            // Para entidades usamos deleteField() para limpar o campo estado, 
            // para pastas mudamos para 'ativa'
            const updatePayload = collectionName === 'pastas' 
                ? { estado: 'ativa', ultimaedicao: serverTimestamp() } 
                : { estado: deleteField() }; // Remove o campo 'estado' para voltar ao normal

            await updateDoc(doc(db, collectionName, id), updatePayload);
            
            // Remove da lista visual
            listItem.remove();
            if (document.getElementById('hidden-items-list').children.length === 0) {
                document.getElementById('hidden-items-list').innerHTML = '<li style="padding:15px; color:#888;">Reciclagem vazia.</li>';
            }

            // Atualiza caches globais se for entidade
            if (collectionName !== 'pastas') {
                if (typeof fetchAllEntities === 'function') fetchAllEntities();
                // Se estivermos a ver a lista dessa categoria, atualiza
                if (currentTab === 'lists') {
                    // Tenta adivinhar a categoria pelo nome da cole√ß√£o (ex: personagens -> personagem)
                    // Mas o ideal √© recarregar a navega√ß√£o atual
                    const currentNavId = navigationStack.length > 0 ? navigationStack[0].id : null;
                    if (currentNavId) renderListCategoryItems(currentNavId);
                }
            } else {
                // Se for nota, tenta abrir
                if (typeof navigateToNoteSmart === 'function') navigateToNoteSmart(id);
            }

        } catch (err) {
            console.error(err);
            alert("Erro ao restaurar.");
        }
    }

    // --- ELIMINAR PERMANENTE ---
    else if (action === 'delete-universal') {
        if (!confirm("Eliminar permanentemente? Esta a√ß√£o √© irrevers√≠vel.")) return;

        try {
            await deleteDoc(doc(db, collectionName, id));
            listItem.remove();
        } catch (err) {
            console.error(err);
            alert("Erro ao eliminar.");
        }
    }
});



// ====================================================================
// L√ìGICA DE PARTILHA DA CAIXA (CADEADO)
// ====================================================================
let activeWrapperForSharing = null;
const sharePopup = document.getElementById('share-settings-popup');
const shareToggle = document.getElementById('mini-note-share-toggle');

// 1. Abrir Popup ao clicar no cadeado
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="sharing-settings"]');
    if (!btn) return;

    console.log("üîê Bot√£o de partilha da caixa clicado!");
    e.preventDefault(); 
    e.stopPropagation(); // Impede o editor de fechar o popup imediatamente

    const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
    if (!wrapper) return;

    activeWrapperForSharing = wrapper;

    const popup = document.getElementById('share-settings-popup');
    if (!popup) return;

    // 1. MOVE PARA O BODY (Para ignorar o overflow:hidden do editor)
    document.body.appendChild(popup);

    // 2. LER ESTADO ATUAL
    const isShared = wrapper.getAttribute('data-shared') === 'true';
    const shareToggle = document.getElementById('mini-note-share-toggle');
    if (shareToggle) shareToggle.checked = isShared;

    // 3. POSICIONAMENTO E Z-INDEX
    const rect = btn.getBoundingClientRect();
    
    popup.style.setProperty('display', 'flex', 'important');
    popup.style.position = 'fixed'; // Fixed √© melhor quando est√° no body
    popup.style.zIndex = "7000000"; // Mais alto que o editor
    
    // Posiciona logo abaixo do bot√£o
    popup.style.top = `${rect.bottom + 5}px`;
    popup.style.left = `${rect.left - 100}px`; // Ajuste para a esquerda para n√£o fugir do ecr√£
    
    popup.style.visibility = "visible";
    popup.style.opacity = "1";
});

// 2. Alterar o Toggle
shareToggle.addEventListener('change', () => {
    if (activeWrapperForSharing) {
        // Atualiza o atributo no HTML da nota
        activeWrapperForSharing.setAttribute('data-shared', shareToggle.checked);
        
        // Atualiza o visual do bot√£o imediatamente
        updateSharingButtonState(activeWrapperForSharing);
        
        // Grava a nota no Firebase
        saveNote();
    }
});

// 3. Fechar Popup ao clicar fora
document.addEventListener('click', (e) => {
    if (sharePopup.style.display !== 'none') {
        if (!sharePopup.contains(e.target) && !e.target.closest('button[data-action="sharing-settings"]')) {
            sharePopup.style.display = 'none';
            activeWrapperForSharing = null;
        }
    }
});

// --- EVENT LISTENER PARA O INDICADOR DE STATUS ---
if (saveStatusIndicator) {
    saveStatusIndicator.addEventListener('click', () => {
        // Se estiver "por guardar" ou deu "erro", o clique for√ßa a grava√ß√£o
        if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'error') {
            saveNote(true); // O par√¢metro 'true' ignora o temporizador e grava logo
        }
    });
}

 // --- EVENT LISTENER: BOT√ÉO DA TOOLBAR ---
editorToolbar.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    if (!action) return;

    // Impedir que o clique tire o foco do editor se necess√°rio
    if (['show-topics', 'show-history', 'note-sharing-settings', 'show-attachments', 'show-explorer', 'bible-scan', 'more-formatting'].includes(action)) {
        e.preventDefault();
        e.stopPropagation();
    }

    // 1. GERIR T√ìPICOS (üìë)
    if (action === 'show-topics') {
        if (selectedNoteId) {
            openTopicsModal(selectedNoteId, 'nota');
        } else {
            alert("Selecione uma nota primeiro.");
        }
    }
    
    // 2. HIST√ìRICO E BACKUPS (üïí)
    else if (action === 'show-history') {
        if (selectedNoteId) {
            openHistoryModal();
        }
    }
    
    // 3. DEFINI√á√ïES DE PARTILHA (üîê)
    else if (action === 'note-sharing-settings') {
        if (selectedNoteId) {
            openShareModalForArchive();
        }
    }
    
    // 4. ANEXOS (üìé)
    else if (action === 'show-attachments') {
        openAttachmentsModal();
    }
    
    // 5. EXPLORADOR / PESQUISA (üîç)
    else if (action === 'show-explorer') {
        openExplorerModal();
    }

    // 6. SCANNER UNIVERSAL (üé∞)
    else if (action === 'bible-scan') {
        if (typeof openUniversalScanner === 'function') {
            openUniversalScanner();
        }
    }

    // 7. EDITOR DE MARGEM (üî¨)
    else if (action === 'open-margin-editor') {
        if (!selectedNoteId) return alert("Selecione uma nota primeiro.");
        
        // Feedback visual
        const originalText = btn.textContent;
        btn.textContent = "üíæ";
        
        // Grava antes de sair para n√£o perder dados
        await saveNote(true);
        window.location.href = `editnote.html?noteId=${selectedNoteId}`;
    }

    // 8. MAIS FORMATA√á√ïES (‚ãÆ)
    else if (action === 'more-formatting' || btn.id === 'more-formatting-btn') {
        const popup = document.getElementById('formatting-popup');
        if (!popup) return;

        const isVisible = popup.style.display === 'block';

        if (isVisible) {
            popup.style.display = 'none';
            btn.classList.remove('active');
        } else {
            // FOR√áA O POPUP PARA O TOPO (BODY)
            document.body.appendChild(popup);
            
            const rect = btn.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed'; // Para flutuar sobre tudo
            popup.style.zIndex = "9999999"; 
            
            // Posicionamento inteligente (evita sair do ecr√£ √† direita)
            let leftPos = rect.left;
            if (leftPos + 250 > window.innerWidth) {
                leftPos = window.innerWidth - 260;
            }

            popup.style.top = `${rect.bottom + 8}px`;
            popup.style.left = `${leftPos}px`;
            
            btn.classList.add('active');
        }
    }
});

    
// Listener espec√≠fico para cliques dentro do Popup de Formata√ß√£o
// Listener espec√≠fico para cliques dentro do Popup de Formata√ß√£o
document.getElementById('formatting-popup').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. DECLARA√á√ÉO GLOBAL DAS VARI√ÅVEIS (AQUI EST√Å A CORRE√á√ÉO)
    const action = btn.dataset.action;
    const cmdSec = btn.dataset.cmdSec;

    // --- A. A√á√ïES DO SISTEMA ---

    if (action === 'open-robot') {
        e.preventDefault(); e.stopPropagation();
        document.getElementById('formatting-popup').style.display = 'none';
        document.getElementById('more-formatting-btn').classList.remove('active');
        if (typeof openRobotModal === 'function') openRobotModal();
        return;
    }
    
    else if (action === 'open-margin-editor') {
        e.preventDefault(); e.stopPropagation();
        if (!selectedNoteId) return alert("Selecione uma nota primeiro.");
        document.getElementById('formatting-popup').style.display = 'none';
        await saveNote(true);
        window.location.href = `editnote.html?noteId=${selectedNoteId}`;
        return;
    }

    else if (action === 'creative-mode') {
        e.preventDefault(); e.stopPropagation();
        document.querySelector('.notebook-container').classList.toggle('creative-mode-active');
        btn.classList.toggle('active');
        document.getElementById('formatting-popup').style.display = 'none';
        return;
    }

    else if (action === 'insert-ref-depot') {
        // A l√≥gica do dep√≥sito j√° √© capturada pelo listener espec√≠fico do bot√£o, 
        // mas fechamos o menu aqui por seguran√ßa e consist√™ncia
        document.getElementById('formatting-popup').style.display = 'none';
        return;
    }

    // --- B. A√á√ïES DE WIDGETS E JORNAL ---
    // S√≥ executa se houver uma a√ß√£o v√°lida
    if (action || cmdSec) {
        e.preventDefault(); e.stopPropagation();

        const editor = document.getElementById('note-content-editor');
        editor.focus(); 
        
        // Restaura a posi√ß√£o do cursor guardada (se existir)
        if (typeof journalCursorRange !== 'undefined' && journalCursorRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(journalCursorRange);
        }

        // 1. DATA (üìÖ)
        if (action === 'insert-date') {
            const calId = `cal_${Date.now()}`;
            const today = new Date();
            const widgetHTML = `
                <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
                    <div class="cal-header">
                        <button class="cal-btn cal-prev">‚óÄ</button>
                        <span class="cal-title">Carregando...</span>
                        <div style="display:flex; gap:5px;">
                            <button class="cal-btn cal-next">‚ñ∂</button>
                            <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="cal-settings-menu">
                        <div style="display:flex; gap:5px; justify-content:center; width:100%;">
                            <button class="cal-view-btn" data-view="week" style="flex:1;">Semana</button>
                            <button class="cal-view-btn active" data-view="month" style="flex:1;">M√™s</button>
                            <button class="cal-view-btn" data-view="year" style="flex:1;">Ano</button>
                        </div>
                        <hr style="border:0; border-top:1px solid var(--border-color); opacity: 0.5;">
                        <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
                    </div>
                    <div class="cal-grid"></div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, widgetHTML);
            setTimeout(() => { if(typeof renderCalendarUI === 'function') renderCalendarUI(document.getElementById(calId)); }, 50);
        }

        // 2. TIMELINE (üå≥)
        else if (action === 'insert-timeline') {
            const timelineId = `tl_${Date.now()}`;
            const timelineHTML = `
                <div class="jwn-timeline-wrapper" contenteditable="false" id="${timelineId}">
                    <div class="timeline-track"></div>
                    <div class="timeline-container">
                        <div class="timeline-entry">
                            <div class="t-marker"></div>
                            <div class="t-date" contenteditable="true">Data 1</div>
                            <div class="t-text" contenteditable="true">Descri√ß√£o...</div>
                            <button class="t-btn-del">√ó</button>
                        </div>
                    </div>
                    <button class="t-btn-add">‚ûï Adicionar Ponto</button>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, timelineHTML);
        }

        // 3. TABELA (üßÆ)
        else if (action === 'insert-table') {
            const tableHTML = `
                <div class="jwn-table-wrapper">
                    <button class="table-settings-btn" contenteditable="false">üõ†Ô∏è Op√ß√µes</button>
                    <table class="jwn-table">
                        <thead><tr><th>T1</th><th>T2</th></tr></thead>
                        <tbody><tr><td><br></td><td><br></td></tr></tbody>
                    </table>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, tableHTML);
        }

        // 4. TOGGLE (‚òÇ)
        else if (action === 'insert-toggle-h2') {
            const uniqueId = 'toggle_' + Date.now();
            const toggleHTML = `
                <details class="toggle-section" open id="${uniqueId}">
                    <summary>
                        <h2>T√≠tulo</h2>
                        <button class="toggle-move-btn" data-action="move-up">üî∫</button>
                        <button class="toggle-move-btn" data-action="move-down">üîª</button>
                        <button class="toggle-color-btn" contenteditable="false">üñåÔ∏è</button>
                        <button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content" contenteditable="true"><p><br></p></div>
                </details><p><br></p>`;
            document.execCommand('insertHTML', false, toggleHTML);
        }

        // 5. CHECKBOX (‚òëÔ∏è)
        else if (action === 'insert-checkbox') {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.style.marginRight = '8px';
            if (typeof insertNodeAtCursor === 'function') insertNodeAtCursor(checkbox);
        }

        // 6. LINHA (‚Äï)
        else if (cmdSec === 'insertHorizontalRule') {
            document.execCommand('insertHorizontalRule', false, null);
        }

        // 7. ARRASTAR (·Øì)
        else if (action === 'make-draggable') {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
               const uniqueId = `drag_${Date.now()}`;
               const text = selection.toString() || "Texto";
               const draggableHTML = `
                <div class="draggable-line" draggable="true" id="${uniqueId}">
                    <span class="drag-handle-icon" contenteditable="false">·Øì</span>
                    <div class="drag-content-area" contenteditable="true">${text}</div>
                </div>`;
               document.execCommand('insertHTML', false, draggableHTML);
            }
        }
        
        // 8. DUAS COLUNAS (‚è∏Ô∏è)
        else if (action === 'insert-2-cols') {
            const uniqueId = `cols_${Date.now()}`;
            const colsHTML = `
                <div class="journal-cols-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cols-toolbar">
                        <span style="font-size:10px; color:#888; margin-right:5px;">COLUNAS</span>
                        <button class="cols-btn-del" onclick="window.deleteCols(this)" title="Apagar Colunas">üóëÔ∏è</button>
                    </div>
                    <div class="journal-cols-container">
                        <div class="journal-col" contenteditable="true" data-placeholder="Escreva na esquerda..."></div>
                        <div class="journal-col" contenteditable="true" data-placeholder="Escreva na direita..."></div>
                    </div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, colsHTML);
            
            setTimeout(() => {
                const container = document.getElementById(uniqueId);
                if (container) {
                    const firstCol = container.querySelector('.journal-col');
                    if (firstCol) firstCol.focus();
                }
            }, 50);
        }

        // 9. IMAGEM (üñºÔ∏è)
        else if (action === 'insert-image') {
            const uniqueId = `img_${Date.now()}`;
            const widgetHTML = `
                <div class="journal-img-wrapper img-size-md" id="${uniqueId}" contenteditable="false">
                    <div class="journal-img-placeholder">
                        <span style="font-size: 24px;">üñºÔ∏è</span>
                        <input type="text" placeholder="Cole o link da imagem aqui..." class="img-url-input">
                        <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px; cursor:pointer;">OK</button>
                    </div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, widgetHTML);
        }

        // 10. RACIOC√çNIO (ü™ß)
 else if (action === 'insert-sign') {
    e.preventDefault();
    const uniqueId = `sign_${Date.now()}`;
    
    const signHTML = `
        <div class="journal-sign-wrapper" id="${uniqueId}" contenteditable="false">
            <div class="sign-toolbar">
                <span style="font-size: 1.2em; margin-right: auto;">ü™ß Racioc√≠nio<span class="sign-number-display"></span></span>
                <button class="sign-move-btn" onclick="window.moveSign(this, -1)" title="Mover para Cima">‚ñ≤</button>
                <button class="sign-move-btn" onclick="window.moveSign(this, 1)" title="Mover para Baixo">‚ñº</button>
                <span style="border-left:1px solid rgba(0,0,0,0.2); height:15px; margin:0 5px;"></span>
                
                <!-- AQUI EST√Å A MUDAN√áA: USAR A NOVA FUN√á√ÉO -->
                <button class="sign-btn-del" onclick="window.confirmSignDelete(this)" title="Mover para a Reciclagem">üóëÔ∏è</button>
                
            </div>
            <div class="sign-header">
                <input type="text" class="sign-title-input" placeholder="Linha de Racioc√≠nio..." value="">
            </div>
            <div class="sign-content" contenteditable="true" data-placeholder="Escreva a sua resposta ou racioc√≠nio aqui..."></div>
            <div class="sign-attachments-area"></div>
            <div class="sign-add-btn-area">
                <button class="sign-add-btn" onclick="window.addAttachmentToSign(this)">+</button>
            </div>
        </div><p><br></p>`;
    
    // Se estiver a usar a fun√ß√£o auxiliar insertWidget (que existe no seu c√≥digo):
    if (typeof insertWidget === 'function') {
        insertWidget(signHTML, uniqueId, '.sign-title-input');
    } else {
        document.execCommand('insertHTML', false, signHTML);
    }
}

        // 11. CART√ÉO (ü™™)
        else if (action === 'insert-card') {
            const uniqueId = `card_${Date.now()}`;
            const cardHTML = `
                <div class="journal-id-card" id="${uniqueId}" contenteditable="false">
                    <div class="card-toolbar">
                        <button onclick="window.moveSign(this, -1)" title="Mover Cima">‚ñ≤</button>
                        <button onclick="window.moveSign(this, 1)" title="Mover Baixo">‚ñº</button>
                        <button class="card-del-btn" onclick="window.archiveMiniNote(this.closest('.journal-id-card'), false)">üóëÔ∏è</button>
                    </div>
                    <div class="card-body">
                        <div class="card-image-area">
                            <div class="card-img-placeholder" onclick="window.setCardImage(this)">
                                <span>üì∑</span><small>Add Foto</small>
                            </div>
                        </div>
                        <div class="card-text-area">
                            <input type="text" class="card-title-input" placeholder="Nome / T√≠tulo" value="">
                            <div class="card-desc-content" contenteditable="true" data-placeholder="Detalhes, biografia ou descri√ß√£o..."></div>
                        </div>
                    </div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, cardHTML);
        }

        // 12. CUBO (üßä)
        else if (action === 'insert-cube') {
            const uniqueId = `cube_${Date.now()}`;
            const cubeHTML = `
                <div class="journal-cube-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cube-toolbar" contenteditable="false">
                        <span class="cube-drag-handle" title="Segure para arrastar" draggable="true">‚ú•</span>
                        <div style="width:1px; background:#555; margin:0 4px;"></div>
                        <button data-cmd="float-left" title="Esquerda">‚¨Ö</button>
                        <button data-cmd="float-none" title="Largura Total">‚¨õ</button>
                        <button data-cmd="float-right" title="Direita">‚û°</button>
                        <div style="width:1px; background:#555; margin:0 4px;"></div>
                        <button data-cmd="delete-cube" style="color:#e74c3c;">üóëÔ∏è</button>
                    </div>
                    <div class="cube-content" contenteditable="true">
                        <strong>üßä T√≠tulo do Bloco</strong>
                        <p>Escreva aqui o seu texto...</p>
                    </div>
                </div><p style="clear:both;"><br></p>`;
            document.execCommand('insertHTML', false, cubeHTML);
        }

        // FECHAR O POPUP E GRAVAR
        document.getElementById('formatting-popup').style.display = 'none';
        document.getElementById('more-formatting-btn').classList.remove('active');
        saveNote();
    }
});


// ====================================================================
// CORRE√á√ÉO PARA O UNDO/REDO EM SUBNOTAS E QUEST√ïES
// ====================================================================

// Quando escrevemos no t√≠tulo, for√ßamos o atributo HTML 'value' a atualizar.
// Isto permite que o document.execCommand('undo') saiba que o texto mudou.
noteContentEditor.addEventListener('input', (e) => {
    // Se o utilizador estiver a escrever no t√≠tulo da Entidade (Quest√£o/Subnota)
    if (e.target.classList.contains('mini-note-title-input')) {
        
        // SINCRONIZA√á√ÉO CR√çTICA:
        // Atualiza o conte√∫do interno (para o innerHTML apanhar o texto novo)
        if (e.target.tagName === 'TEXTAREA') {
            e.target.textContent = e.target.value;
        } else {
            // Mant√©m suporte para inputs antigos
            e.target.setAttribute('value', e.target.value);
        }

        // Se a op√ß√£o de t√≠tulo completo estiver ligada, ajusta a altura enquanto escreves
        if (appSettings.showFullTitles) {
            autoResizeTitle(e.target);
        }

        // Dispara a grava√ß√£o autom√°tica
        updateSaveStatus('unsaved');
        saveNote();
    }
});

// ====================================================================
// GESTOR DE CLIQUES (√ÇNCORAS, LINKS E TAGS)
// ====================================================================
document.getElementById('right-panel').addEventListener('click', (event) => {
    const target = event.target;
    
    // LOG 1: O clique chegou ao painel?

    // 1. Verificar se √© um bot√£o (para ignorar)
    if (target.closest('button')) {
        return;
    }

    // 2. Tentar encontrar as nossas refer√™ncias
    const anchor = target.closest('.entity-link');
    const link = target.closest('a[data-anexo-id]');
    const tag = target.closest('.tag');


    if (anchor || link || tag) {
        // Bloquear comportamento de edi√ß√£o para o clique funcionar
        event.preventDefault();
        event.stopPropagation();
        

        if (anchor) {
            const name = anchor.dataset.entityName;
            const type = anchor.dataset.entityType;
            
            // LOG 3: Verificar se o cache de entidades est√° vazio
            const all = Object.values(allEntities).flat();
            
            const entity = all.find(e => e.nome === name);
            if (entity) {
                showReferencesPanel(entity.id, name, type);
            } else {
                console.error("ERRO: Entidade n√£o encontrada no cache local!");
                // Tentativa de emerg√™ncia se o cache falhar
                showReferencesPanel(null, name, type);
            }
        } 
        else if (link) {
            const id = link.dataset.anexoId;
            openViewLinkModal(id);
        } 
        else if (tag) {
            const tagName = tag.textContent.replace('#', '').trim();
            showTagReferencesPanel(tagName);
        }
        
        // LOG 4: Verificar se a classe de visibilidade foi adicionada
        setTimeout(() => {
            const visible = notebookContainer.classList.contains('references-panel-visible');
        }, 100);
    } else {
    }
}, true);

// ====================================================================
// FUN√á√ÉO: ARQUIVAR MINI-NOTA (Mover para Reciclagem no Firebase)
// ====================================================================
 window.archiveMiniNote = async function(element, skipConfirmation = false) {
    if (!element) return false;

    console.group("üì¶ [ARCHIVE] A processar item...");

    // Identifica√ß√£o de IDs
    let targetId = selectedNoteId;
    if (!targetId) {
        const urlParams = new URLSearchParams(window.location.search);
        targetId = urlParams.get('rootId') || urlParams.get('noteId');
    }
    
    if (!targetId) { 
        console.error("‚ùå ERRO: ID da Nota n√£o encontrado."); 
        console.groupEnd(); 
        return false; 
    }

    // Parar timers para evitar conflitos
    if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);
    if (typeof archiveAutoSaveTimer !== 'undefined') clearTimeout(archiveAutoSaveTimer);

    // Extra√ß√£o de dados da caixa
    const itemId = element.id; 
    let originalIndex = -1;
    if (element.parentNode) originalIndex = Array.from(element.parentNode.children).indexOf(element);

    // Limpeza de refer√™ncias remotas (links na 4¬™ coluna)
    const boxLinksJson = element.getAttribute('data-box-links');
    // (Omitido o bloco de limpeza de links para poupar espa√ßo, ele mant√©m-se igual)

    // --- DETE√á√ÉO DE TIPO E CONTE√öDO ---
    let title = "Sem T√≠tulo"; 
    let content = element.innerHTML; 
    let type = "default"; // Assume Subnota se nada for detetado
    let topicsJSON = element.getAttribute('data-topics') || '{}';

    // 1. Detetar T√≠tulo (Adicionado suporte para .sign-title-input)
    const inp = element.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
    if (inp) {
        title = inp.value;
    } else {
        const strong = element.querySelector('strong');
        if (strong) title = strong.textContent;
    }
    
    // ============================================================
    // 2. DETE√á√ÉO DE TIPO (AQUI EST√Å A CORRE√á√ÉO)
    // ============================================================
    
    if (element.classList.contains('redator-wrapper')) {
        type = 'redator';
    }
    else if (element.classList.contains('question-mode')) {
        type = 'question';
    }
    else if (element.classList.contains('free-mode')) {
        type = 'free'; // Contentor
    }
    // >>> CORRE√á√ÉO PARA A CAIXA DE RACIOC√çNIO <<<
    else if (element.classList.contains('journal-sign-wrapper')) {
        type = 'sign'; 
        console.log("‚úÖ Tipo identificado: RACIOC√çNIO (sign)");
    }
    // >>> CORRE√á√ÉO PARA O CART√ÉO TEM√ÅTICO <<<
    else if (element.classList.contains('journal-id-card')) {
        type = 'card';
    }
    // >>> CORRE√á√ÉO PARA O CUBO <<<
    else if (element.classList.contains('journal-cube-wrapper')) {
        type = 'cube';
    }
    else if (element.tagName === 'DETAILS') {
        type = 'toggle';
    }
    else if (element.classList.contains('ghost-block') || element.getAttribute('data-archive-type') === 'ghost') {
        type = 'ghost'; // Tipo espec√≠fico para o hist√≥rico
        title = element.innerText.split('\n')[0].substring(0, 30) + "..."; // Usa o in√≠cio do texto como t√≠tulo
        if (!title || title === "...") title = "Bloco de Texto";
        console.log("‚úÖ Tipo identificado: BLOCO FANTASMA (ghost)");
    }
    else {
        console.warn("‚ö†Ô∏è Tipo n√£o espec√≠fico. A gravar como Subnota (default).");
    }
    
    // ============================================================

    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', targetId);
        
        // Objeto que vai para o Firebase
        const trashItem = {
            id: itemId, 
            titulo: title, 
            conteudo: content, // HTML original
            type: type,        // AGORA GRAVA 'sign' CORRETAMENTE
            topicsJSON: topicsJSON, 
            originalIndex: originalIndex, 
            deletedAt: serverTimestamp()
        };

        // Sincroniza Inputs antes de remover do DOM
        const editor = document.getElementById('note-content-editor');
        if (editor) {
            editor.querySelectorAll('input, textarea').forEach(t => {
                if (t.tagName === 'INPUT') t.setAttribute('value', t.value);
                else t.textContent = t.value;
            });
        }

        // Substitui por marcador invis√≠vel
        const marker = document.createElement('span');
        marker.id = `marker_${itemId}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        if (element.parentNode) element.replaceWith(marker);

        const finalHTML = editor ? editor.innerHTML : "";

        await updateDoc(noteRef, {
            conteudo: finalHTML, 
            [`subnotasocultas.${itemId}`]: trashItem, 
            ultimaedicao: serverTimestamp()
        });
        
        console.log("‚úÖ Sucesso! Item arquivado na Reciclagem.");
        if (typeof updateSaveStatus === 'function') updateSaveStatus('saved');
        console.groupEnd();
        return true;

    } catch (error) {
        console.error("‚ùå Erro ao arquivar:", error);
        alert("Erro de conex√£o. Item n√£o removido.");
        // Restaura visualmente em caso de erro
        element.style.display = 'block';
        console.groupEnd();
        return false;
    }
};
  

 

// ====================================================================

// ==========================================================
// GEST√ÉO DE LINKS DO QUADRO (PUZZLE)
// ==========================================================

let currentBoardRange = null; // Guarda a sele√ß√£o dentro do cart√£o

window.openBoardLinkManager = function(contentDiv) {
    const selection = window.getSelection();
    let existingLink = null;

    // 1. Tentar detetar se o cursor ou a sele√ß√£o est√£o dentro de um link .board-link
    if (selection.rangeCount > 0) {
        const anchorNode = selection.anchorNode;
        // Obt√©m o elemento HTML pai do n√≥ onde est√° o cursor (se for n√≥ de texto, pega o pai)
        const targetEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        // Procura para cima na √°rvore se existe um link do quadro
        existingLink = targetEl.closest('a.board-link');
    }

    // --- CASO A: EDITAR LINK EXISTENTE ---
    if (existingLink) {
        console.log("‚úèÔ∏è Link detetado sob o cursor no Quadro. Abrindo edi√ß√£o...");
        openBoardLinkModal(true, existingLink);
        return;
    }

    // --- CASO B: CRIAR NOVO LINK ---
    // Se n√£o h√° link, mas tamb√©m n√£o h√° texto selecionado, avisa o utilizador
    if (selection.isCollapsed || selection.toString().trim() === "") {
        alert("Clique num link azul para o editar ou selecione um texto para criar um novo link.");
        return;
    }

    // Verifica se a sele√ß√£o est√° realmente dentro da caixa de texto do cart√£o para seguran√ßa
    if (!contentDiv.contains(selection.anchorNode)) {
        alert("Por favor, selecione o texto dentro do cart√£o.");
        return;
    }

    // Guarda a sele√ß√£o para inserir o link ap√≥s fechar o modal
    currentBoardRange = selection.getRangeAt(0).cloneRange();
    
    // Abre o modal em modo cria√ß√£o, passando o texto selecionado como t√≠tulo
    openBoardLinkModal(false, selection.toString());
};

window.openBoardLinkModal = function(isEdit, data) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const saveBtn = document.getElementById('link-save-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // 1. RESET E PREPARA√á√ÉO DA INTERFACE
    urlsContainer.innerHTML = '';
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = '30000'; // Garante que fica acima da 4¬™ coluna
    document.body.appendChild(modal); // Move para o body para evitar cortes de layout

    // Clonar bot√µes para limpar eventos antigos de cliques anteriores
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    // Configurar o bot√£o de adicionar URLs extra
    const addUrlBtn = document.getElementById('add-url-btn');
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = (e) => { e.preventDefault(); addUrlField(); };

    let existingLinkElement = null;

    // 2. CARREGAR DADOS (EDI√á√ÉO vs CRIA√á√ÉO)
    if (isEdit) {
        modalTitle.textContent = "Editar Link do Quadro";
        existingLinkElement = data; // O elemento <a> recebido
        titleInput.value = existingLinkElement.textContent;
        newRemoveBtn.style.display = 'block';
        newRemoveBtn.textContent = "Remover Link";

        // Tentar ler os URLs guardados no atributo data-json
        try {
            const rawJson = existingLinkElement.dataset.json;
            if (rawJson) {
                const urls = JSON.parse(decodeURIComponent(rawJson));
                urls.forEach(u => addUrlField(u));
            } else {
                addUrlField(existingLinkElement.href); // Fallback link simples
            }
        } catch(e) {
            console.warn("Erro ao ler JSON, usando href.");
            addUrlField(existingLinkElement.href);
        }
    } else {
        modalTitle.textContent = "Novo Link no Quadro";
        titleInput.value = data; // O texto que foi selecionado
        newRemoveBtn.style.display = 'none';
        addUrlField(); // Come√ßa com um campo vazio
    }

    // 3. A√á√ÉO: GRAVAR (Salvar Altera√ß√µes ou Criar Novo)
    newSaveBtn.onclick = (e) => {
        e.preventDefault();
        const urls = [];
        urlsContainer.querySelectorAll('input').forEach(inp => {
            if(inp.value.trim()) {
                let u = inp.value.trim();
                if(!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (urls.length === 0) {
            alert("Insira pelo menos um endere√ßo (URL).");
            return;
        }

        // Criar ou Atualizar o elemento <a>
        const a = isEdit ? existingLinkElement : document.createElement('a');
        a.href = "#"; // Href fict√≠cio pois usamos o data-json para abrir
        a.className = "board-link";
        a.style.cursor = "pointer";
        a.setAttribute('spellcheck', 'false');
        a.textContent = titleInput.value.trim() || "Link";
        
        // Guarda o array de URLs codificado no dataset
        a.dataset.json = encodeURIComponent(JSON.stringify(urls));

        // Se for cria√ß√£o, insere o elemento no local da sele√ß√£o guardada
        if (!isEdit && currentBoardRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(currentBoardRange);
            currentBoardRange.deleteContents();
            currentBoardRange.insertNode(a);
            
            // Adiciona um espa√ßo ap√≥s o link para facilitar continuar a escrever
            const space = document.createTextNode('\u00A0');
            a.parentNode.insertBefore(space, a.nextSibling);
        }
        
        modal.style.display = 'none';
        // Se estiveres no modo edi√ß√£o do Puzzle, a grava√ß√£o autom√°tica tratar√° do resto
    };

    // 4. A√á√ÉO: REMOVER (Transformar link em texto simples)
    newRemoveBtn.onclick = (e) => {
        e.preventDefault();
        if (existingLinkElement) {
            const textNode = document.createTextNode(existingLinkElement.textContent);
            existingLinkElement.parentNode.replaceChild(textNode, existingLinkElement);
        }
        modal.style.display = 'none';
    };
};

// 5. VISUALIZAR LINKS (Ao clicar no texto azul)
window.viewBoardLink = function(linkElement) {
    console.group("%cüîç [DEBUG] Visualizador de Links do Quadro", "color: #4a90e2; font-weight: bold;");
    
    const modal = document.getElementById('view-link-modal');
    const list = document.getElementById('view-link-urls-list');
    const titleEl = document.getElementById('view-link-title');
    
    if (!modal || !list) {
        console.error("‚ùå Elementos do modal n√£o encontrados!");
        console.groupEnd();
        return;
    }

    try {
        const rawJson = linkElement.dataset.json;
        const urls = JSON.parse(decodeURIComponent(rawJson));
        
        titleEl.textContent = linkElement.textContent;
        list.innerHTML = '';
        
        urls.forEach((url, idx) => {
            const li = document.createElement('li');
            li.style.cssText = `
                padding: 15px; 
                margin-bottom: 10px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: rgba(255,255,255,0.05);
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;

            li.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: baseline; pointer-events: none;">
                    <span style="font-weight:bold; color: var(--text-muted-color);">${idx + 1}.</span>
                    <span style="color: var(--accent-color); text-decoration: underline; word-break: break-all;">
                        ${url}
                    </span>
                </div>
                <span style="color: var(--text-muted-color);">‚ÜóÔ∏è</span>
            `;

            // Clique no item da lista abre o link
            li.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                window.open(url, '_blank');
            });

            list.appendChild(li);
        });

        // For√ßa o modal a ir para o body (topo da hierarquia) e aparecer
        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.opacity = "1";
        modal.style.visibility = "visible";
        
        console.log("‚úÖ Modal exibido no topo absoluto.");

    } catch(e) {
        console.error("‚ùå Erro ao processar links:", e);
    }
    console.groupEnd();
};


// ====================================================================

tagSuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const li = e.target.closest('li');
    if (li) {
        const selected = tagSuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitTagSelection();
    }
});

entitySuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Impede que o editor perca o foco
    const li = e.target.closest('li');
    if (li) {
        const selected = entitySuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitEntitySelection();
    }
});

// ====================================================================
// L√ìGICA DA TESOURA (Converter Post-it em Texto)
// ====================================================================
noteContentEditor.addEventListener('click', async (e) => {

// -----------------------------------------------------------
// 1. L√ìGICA DO POST-IT (‚úÇÔ∏è) - TESOURA
// -----------------------------------------------------------
if (e.target.classList.contains('post-it-cut-btn')) {
    e.preventDefault(); e.stopPropagation();
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    const contentDiv = postIt.querySelector('.post-it-content');
    const savedHTML = contentDiv.innerHTML;
    const postItRect = postIt.getBoundingClientRect();
    
    const newPara = document.createElement('p');
    newPara.innerHTML = savedHTML || "<br>";
    
    const children = Array.from(noteContentEditor.children);
    let inserted = false;
    for (const child of children) {
        if (child === postIt || child.classList.contains('post-it-note')) continue;
        if (child.getBoundingClientRect().top > postItRect.top) {
            noteContentEditor.insertBefore(newPara, child);
            inserted = true;
            break;
        }
    }
    if (!inserted) noteContentEditor.appendChild(newPara);

    postIt.remove();
    
    // Focar
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(newPara);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
    
    saveNote();
    return; 
}

// -----------------------------------------------------------
// 2. L√ìGICA DO CART√ÉO WEB (‚úï) - REVERTER PARA LINK
// -----------------------------------------------------------
if (e.target.classList.contains('url-card-close')) {
    e.preventDefault(); e.stopPropagation();

    const card = e.target.closest('.url-card-widget');
    if (!card) return;

    const originalUrl = card.dataset.originalUrl;

    // Criar o link de texto original
    const a = document.createElement('a');
    a.href = originalUrl;
    a.textContent = originalUrl;
    a.target = "_blank";
    a.style.color = "var(--accent-color)";
    a.style.textDecoration = "underline";

    card.replaceWith(a);
    
    const space = document.createTextNode('\u00A0');
    a.after(space);

    saveNote();
    return;
}

// -----------------------------------------------------------
// 3. NAVEGA√á√ÉO DO CART√ÉO WEB (Abrir Link) - NOVO!
// -----------------------------------------------------------
const cardWidget = e.target.closest('.url-card-widget');
// Se clicou num card, MAS N√ÉO no bot√£o de fechar
if (cardWidget && !e.target.classList.contains('url-card-close')) {
    e.preventDefault(); 
    e.stopPropagation();

    const url = cardWidget.dataset.originalUrl;
    
    if (url) {
        // Abre numa nova aba
        window.open(url, '_blank');
    }
    return;
}

// -----------------------------------------------------------
// 4. L√ìGICA DE APAGAR SEC√á√ÉO/TOGGLE (üóëÔ∏è)
// -----------------------------------------------------------
const toggleDelBtn = e.target.closest('.toggle-delete-btn');
if (toggleDelBtn) {
    e.preventDefault(); e.stopPropagation();
    const detailsElement = toggleDelBtn.closest('details');
    if (!detailsElement) return;

    const success = await archiveMiniNote(detailsElement); 
    if (success) {
        const marker = document.createElement('span');
        marker.id = `marker_${detailsElement.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        detailsElement.replaceWith(marker);
        saveNote();
    }
    return;
}

// -----------------------------------------------------------
// 5. L√ìGICA DE APAGAR SUBNOTA/QUEST√ÉO (üóëÔ∏è)
// -----------------------------------------------------------
const deleteBtn = e.target.closest('button[data-action="delete-mini-note"]');
if (deleteBtn) {
    console.group("üóëÔ∏è [DEBUG] Processo de Elimina√ß√£o Iniciado");
    console.log("1. Bot√£o clicado:", deleteBtn);

    // 1. Verifica√ß√µes de seguran√ßa
    if (noteContentEditor.contentEditable === "false") {
        console.warn("üö´ Tentativa de apagar em modo leitura.");
        alert("N√£o tem permiss√£o para editar esta nota partilhada.");
        console.groupEnd();
        return;
    }
    
    e.preventDefault(); 
    e.stopPropagation();

    // 2. Identificar a caixa (AQUI √â CR√çTICO: TEM DE TER .redator-wrapper)
    const wrapper = deleteBtn.closest('.mini-note-wrapper, .redator-wrapper');
    
    if (!wrapper) {
        console.error("‚ùå ERRO: N√£o encontrei o wrapper pai (.mini-note-wrapper ou .redator-wrapper)!");
        console.groupEnd();
        return; 
    }

    console.log("2. Wrapper Pai encontrado:", wrapper);
    console.log("   - Classes:", wrapper.className);
    console.log("   - ID:", wrapper.id);

    const wrapperId = wrapper.id; 
    
    // Identificar tipo para a mensagem
    let label = "Item";
    if (wrapper.classList.contains('redator-wrapper')) label = "Redator"; // <--- LOGICA NOVA
    else if (wrapper.classList.contains('question-mode')) label = "Quest√£o";
    else label = "SubNota";

    console.log("3. Tipo identificado para o popup:", label);

    // 3. Confirma√ß√£o
    const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar este ${label}?`);
    
    if (!confirmed) {
        console.log("üö´ Utilizador cancelou a a√ß√£o.");
        console.groupEnd();
        return;
    }

    console.log("‚úÖ Utilizador confirmou. Iniciando arquivo...");

    // Esconde logo visualmente
    wrapper.style.display = 'none';

    try {
        // 4. Arquivar na Base de Dados
        const success = await archiveMiniNote(wrapper, true);
        
        console.log("4. Resultado do archiveMiniNote:", success);

        if (success) {
            console.log("5. Sucesso! Removendo do DOM e criando marcador.");
            
            const marker = document.createElement('span');
            marker.id = `marker_${wrapperId}`;
            marker.className = 'hidden-note-marker';
            marker.style.display = 'none';
            
            // Substitui√ß√£o segura
            const elementToRemove = document.getElementById(wrapperId) || wrapper;
            if (elementToRemove && elementToRemove.parentNode) {
                elementToRemove.replaceWith(marker);
            }
            
            await saveNote(true);
            console.log("üíæ Nota guardada.");
        } else {
            console.error("‚ùå archiveMiniNote retornou false.");
            wrapper.style.display = 'block';
            alert("N√£o foi poss√≠vel arquivar. A caixa foi restaurada.");
        }
    } catch (err) {
        console.error("üî• Erro Cr√≠tico:", err);
        wrapper.style.display = 'block'; 
    }
    
    console.groupEnd();
    return;
}
});

// ====================================================================
// PROTE√á√ÉO: DETETAR DELETE EM MASSA DE MINI-NOTAS
// ====================================================================
noteContentEditor.addEventListener('keydown', async (event) => {
    // Apenas nos interessa Backspace ou Delete
    if (event.key !== 'Delete' && event.key !== 'Backspace') return;

    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const anchorNode = selection.anchorNode;
    // Garante que temos o elemento HTML
    const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

    // --- [MANT√âM-SE A PROTE√á√ÉO DE TOGGLES/BACKSPACE ANTERIOR AQUI] ---
    // (Pode manter o c√≥digo do bloco 1.1, 1.2 e 1.3 que j√° tinha para prote√ß√£o de Toggles, 
    //  pois ele lida com cursor colapsado. O foco agora √© a sele√ß√£o expandida.)
    
    // SE N√ÉO HOUVER SELE√á√ÉO DE TEXTO (CURSOR APENAS A PISCAR), SAI
    if (selection.isCollapsed) return;

    // --- VERIFICA√á√ÉO DE SEGURAN√áA PARA EDI√á√ÉO INTERNA ---
    const focusNode = selection.focusNode;
    const endEl = focusNode.nodeType === 3 ? focusNode.parentElement : focusNode;

    const startWrapper = currentEl.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
    const endWrapper = endEl.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');

    // Se a sele√ß√£o come√ßa e acaba DENTRO da mesma caixa, √© edi√ß√£o de texto normal. Permitir.
    if (startWrapper && startWrapper === endWrapper) {
        return; 
    }

    // 3. PROCURAR SELE√á√ÉO EM MASSA
    const allWrappers = noteContentEditor.querySelectorAll('.mini-note-wrapper, details.toggle-section, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .ref-depot-wrapper, .jwn-timeline-wrapper, .jwn-table-wrapper');
    
    const wrappersToDelete = [];
    allWrappers.forEach(wrapper => {
        if (selection.containsNode(wrapper, true)) {
            wrappersToDelete.push(wrapper);
        }
    });

    // 4. SE A SELE√á√ÉO CONT√âM ITENS COMPLEXOS:
    if (wrappersToDelete.length > 0) {
        event.preventDefault();
        event.stopPropagation();

        const count = wrappersToDelete.length;
        const totalInEditor = allWrappers.length;
        
        // DETE√á√ÉO DE "SELECIONAR TUDO" (Ou quase tudo)
        // Se a quantidade de itens a apagar for igual ao total, ou se for uma quantidade grande (> 2)
        const isMassiveDelete = (count === totalInEditor) || (count >= 3);

        if (isMassiveDelete) {
            // --- CEN√ÅRIO A: APAGAR TUDO (BACKUP DE SEGURAN√áA) ---
            const confirmed = await showConfirmation(
                "‚ö†Ô∏è Aten√ß√£o: Dados Importantes", 
                `Est√° prestes a apagar ${count} blocos de conte√∫do complexo.\n\nPara seguran√ßa, ser√° criado um Backup Autom√°tico antes de limpar a nota. Deseja continuar?`
            );

            if (!confirmed) return;

            // Feedback visual no bot√£o do modal (caso ainda estivesse vis√≠vel)
            const modalBtn = document.querySelector('#confirm-modal .modal-btn.primary');
            if(modalBtn) modalBtn.textContent = "A Criar Backup...";

            // 1. Criar o Backup Completo
            const currentHTML = noteContentEditor.innerHTML;
            const currentTitle = document.getElementById('note-title-input').value;
            
            await performSafetyBackup(selectedNoteId, currentHTML, currentTitle);

            // 2. Limpar o Editor
            // Se for "Selecionar Tudo", limpa tudo. Se for parcial, apaga s√≥ a sele√ß√£o.
            if (count === totalInEditor) {
                noteContentEditor.innerHTML = '<p><br></p>';
            } else {
                range.deleteContents();
            }

            // 3. Gravar o estado "Vazio"
            saveNote(true);

            // Feedback visual
            const statusEl = document.getElementById('save-status-indicator');
            if(statusEl) {
                statusEl.textContent = "Backup Criado & Nota Limpa";
                setTimeout(() => statusEl.textContent = "Guardado", 3000);
            }

        } else {
            // --- CEN√ÅRIO B: APAGAR 1 OU 2 ITENS (L√ìGICA ORIGINAL DE RECICLAGEM) ---
            // Mant√©m a l√≥gica de enviar para a lixeira individualmente
            const confirmDelete = await showConfirmation(
                "Mover para a Lixeira?", 
                `A sele√ß√£o cont√©m ${count} item(s). Eles ser√£o movidos para o Hist√≥rico/Reciclagem.`
            );

            if (!confirmDelete) return;

            const modalBtn = document.querySelector('#confirm-modal .modal-btn.primary');
            if(modalBtn) modalBtn.textContent = "A Arquivar...";

            const archivePromises = wrappersToDelete.map(wrapper => archiveMiniNote(wrapper, true)); 
            await Promise.all(archivePromises);

            range.deleteContents();
            saveNote();
        }
    }
});


// --- L√ìGICA DA BARRA DE INSER√á√ÉO R√ÅPIDA (üìò üìí) ---

const insertionPopup = document.getElementById('insertion-popup');

// 1. APARECER: Ao clicar no editor
noteContentEditor.addEventListener('click', (e) => {
    
    // A. Guardar a altura do clique IMEDIATAMENTE
    const clickY = e.clientY;

    // --- PROTE√á√ïES: Se clicar nestes elementos, o menu N√ÉO abre ---
    if (e.target.closest('.idea-span')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.mini-note-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.ref-depot-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.journal-sign-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.journal-id-card')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    
    const redator = e.target.closest('.redator-wrapper');
    if (redator) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    
    if (e.target.closest('.jwn-calendar-widget')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('table')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.jwn-timeline-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    
    // PROTE√á√ÉO 10: T√≠tulo Expans√≠vel / Toggle (‚òÇ)
    if (e.target.closest('summary')) { document.getElementById('insertion-popup').style.display = 'none'; return; }

    // --- C√ÅLCULO E EXIBI√á√ÉO DO POPUP ---
    setTimeout(() => {
        const selection = window.getSelection();
        
        // S√≥ mostramos se N√ÉO houver texto selecionado (cursor a piscar)
        if (selection && selection.rangeCount > 0 && selection.isCollapsed) {
            
            // Fecha outros popups que possam estar abertos
            if(document.getElementById('selection-popup')) document.getElementById('selection-popup').style.display = 'none';
            if(document.getElementById('idea-actions-popup')) document.getElementById('idea-actions-popup').style.display = 'none';

            const popup = document.getElementById('insertion-popup');
            const editor = document.getElementById('note-content-editor');
            
            // --- L√ìGICA DO √çCONE REDATOR (üìì) ---
            const redatorBtn = document.getElementById('popup-btn-redator');
            if (redatorBtn) {
                // Verifica a vari√°vel global definida no displayNote
                if (window.currentNoteType === 'jornal') {
                    redatorBtn.style.display = 'flex'; // Mostra no Jornal
                } else {
                    redatorBtn.style.display = 'none'; // Esconde nas Notas normais
                }
            }
            
            // ============================================================
            // >>> NOVA L√ìGICA INTELIGENTE DO √çCONE RACIOC√çNIO (ü™ß) <<<
            // ============================================================
            const signBtn = document.getElementById('popup-btn-sign');
            if (signBtn) {
                // Verifica se existe ALGUMA caixa de racioc√≠nio no editor
                const hasSignBox = editor.querySelector('.journal-sign-wrapper');
                
                if (hasSignBox) {
                    signBtn.style.display = 'flex'; // Mostra se j√° existir pelo menos uma
                } else {
                    signBtn.style.display = 'none'; // Esconde se n√£o houver nenhuma
                }
            }
            // ============================================================

            // --- POSICIONAMENTO DEFINITIVO ---
            const editorRect = noteContentEditor.getBoundingClientRect();
            const leftPos = editorRect.left;
            const topPos = clickY; // Usa a coordenada Y capturada no clique

            popup.style.display = 'flex';
            
            // Aplica as posi√ß√µes (com ajuste de scroll e offset de 85px para cima para n√£o tapar o texto)
            popup.style.top = `${topPos + window.scrollY - 85}px`; 
            popup.style.left = `${leftPos + window.scrollX + 10}px`; 

        } else {
            // Se houver texto selecionado, esconde este popup (para aparecer o de sele√ß√£o)
            document.getElementById('insertion-popup').style.display = 'none';
        }
    }, 10); 
});



// 2. DESAPARECER: Ao come√ßar a escrever
noteContentEditor.addEventListener('keydown', () => {
    insertionPopup.style.display = 'none';
});

// 3. A√á√ïES DOS BOT√ïES
insertionPopup.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation(); 

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // 1. SUBNOTA AZUL (üìò)
    if (action === 'quick-mini-note') {
        insertMiniNoteAtCursor('default'); 
        saveNote();
        insertionPopup.style.display = 'none';
    } 
    
    // 2. QUEST√ÉO VERDE (üìó)
    else if (action === 'insert-question') {
        insertMiniNoteAtCursor('question'); 
        saveNote();
        insertionPopup.style.display = 'none';
    }

    // 3. CONTENTOR LARANJA (üìô)
    else if (action === 'insert-free-container') {
        insertMiniNoteAtCursor('free'); 
        saveNote();
        insertionPopup.style.display = 'none';
    }

    // 4. REDATOR PRETO (üìì)
    else if (action === 'insert-redator') {
        insertMiniNoteAtCursor('redator');
        saveNote();
        insertionPopup.style.display = 'none';
    }

    // 5. POST-IT AMARELO (üìí)
    else if (action === 'quick-placeholder') {
        // ... (seu c√≥digo existente do post-it) ...
        const sizePopup = document.getElementById('postit-size-popup');
        if (sizePopup) {
            const rect = insertionPopup.getBoundingClientRect();
            sizePopup.style.top = rect.top + 'px';
            sizePopup.style.left = (rect.right + 5) + 'px';
            sizePopup.style.setProperty('display', 'flex', 'important');
        }
    }

    // ============================================================
    // 6. RACIOC√çNIO (ü™ß) - NOVO
    // ============================================================
    else if (action === 'insert-sign') {
        const uniqueId = `sign_${Date.now()}`;
        
        // Usa o HTML correto com a fun√ß√£o de confirma√ß√£o de delete
        const signHTML = `
            <div class="journal-sign-wrapper" id="${uniqueId}" contenteditable="false">
                <div class="sign-toolbar">
                    <span style="font-size: 1.2em; margin-right: auto;">ü™ß Racioc√≠nio<span class="sign-number-display"></span></span>
                    <button class="sign-move-btn" onclick="window.moveSign(this, -1)" title="Mover para Cima">‚ñ≤</button>
                    <button class="sign-move-btn" onclick="window.moveSign(this, 1)" title="Mover para Baixo">‚ñº</button>
                    <span style="border-left:1px solid rgba(0,0,0,0.2); height:15px; margin:0 5px;"></span>
                    <button class="sign-btn-del" onclick="window.confirmSignDelete(this)" title="Mover para a Reciclagem">üóëÔ∏è</button>
                </div>
                <div class="sign-header">
                    <input type="text" class="sign-title-input" placeholder="Linha de Racioc√≠nio..." value="">
                </div>
                <div class="sign-content" contenteditable="true" data-placeholder="Escreva a sua resposta ou racioc√≠nio aqui..."></div>
                <div class="sign-attachments-area"></div>
                <div class="sign-add-btn-area">
                    <button class="sign-add-btn" onclick="window.addAttachmentToSign(this)">+</button>
                </div>
            </div><p><br></p>`;
        
        // Insere onde estava o cursor
     document.execCommand('insertHTML', false, signHTML);
    
    // Foca no t√≠tulo com anima√ß√£o suave
    setTimeout(() => {
        const el = document.getElementById(uniqueId);
        if (el) {
            // 1. FOCA PRIMEIRO
            const input = el.querySelector('.sign-title-input');
            if (input) input.focus();

            // 2. SCROLL DEPOIS (Anima√ß√£o sobrep√µe o salto do foco)
            requestAnimationFrame(() => {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }
    }, 50); // Delay curto

    saveNote();
    insertionPopup.style.display = 'none';
}
});

// Garante que esconde se fizermos scroll
document.addEventListener('scroll', () => {
    insertionPopup.style.display = 'none';
}, true);

// --- L√ìGICA INTELIGENTE DE ARRASTO ---
noteContentEditor.addEventListener('mouseover', (e) => {
    // Verifica se estamos a passar o rato por cima de um post-it
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    // Verifica se estamos EXATAMENTE em cima do puxador amarelo
    const isHandle = e.target.closest('.post-it-drag-handle');
    
    if (isHandle) {
        // RATO NO PUXADOR: Ativa o modo de arrastar
        postIt.setAttribute('draggable', 'true');
    } else {
        // RATO NO TEXTO: Desativa o modo de arrastar (para permitir selecionar texto)
        postIt.setAttribute('draggable', 'false');
    }
});


// ====================================================================
// L√ìGICA DO MENU DE TAMANHOS DE POST-IT
// ====================================================================
document.getElementById('postit-size-popup').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const size = btn.dataset.size;
    let width = '250px', height = '180px'; // Padr√£o M√©dio
    
    if (size === 'small') { width = '150px'; height = '100px'; }
    if (size === 'large') { width = '400px'; height = '300px'; }

    // Fun√ß√£o que cria o HTML do post-it (deve existir no seu c√≥digo)
    // Se n√£o tiver a fun√ß√£o 'createPostItElement' separada, use a l√≥gica direta aqui:
    const container = document.createElement('div');
    container.className = 'post-it-note active-note';
    container.setAttribute('draggable', 'false'); // O drag √© ativado no hover
    container.style.width = width;
    container.style.height = height;
    // Posi√ß√£o aproximada (centro do ecr√£ ou perto do scroll)
    container.style.top = (window.scrollY + 150) + 'px';
    container.style.left = '50px';
    
    container.innerHTML = `
        <div class="post-it-drag-handle" contenteditable="false">‚ú•</div>
        <div class="post-it-cut-btn" contenteditable="false" title="Cortar">‚úÇÔ∏è</div>
        <div class="post-it-content" contenteditable="true"></div>
    `;
    
    document.getElementById('note-content-editor').appendChild(container);
    
    // Fecha os menus
    document.getElementById('postit-size-popup').style.display = 'none';
    document.getElementById('insertion-popup').style.display = 'none';
    
    saveNote();
});

// Fechar menu de tamanhos se clicar fora
document.addEventListener('click', (e) => {
    const sizePopup = document.getElementById('postit-size-popup');
    if (sizePopup.style.display !== 'none' && !sizePopup.contains(e.target)) {
        sizePopup.style.display = 'none';
    }
});

// ====================================================================
// FECHAR MENUS FLUTUANTES AO CLICAR NA 4¬™ COLUNA
// ====================================================================
document.getElementById('references-panel').addEventListener('click', () => {
    // 1. Esconde a barra de inser√ß√£o (üìò üìó üìô üìí)
    const insertionPopup = document.getElementById('insertion-popup');
    if (insertionPopup) {
        insertionPopup.style.display = 'none';
    }

    // 2. (Recomendado) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üìç) se estiver aberto
    const selectionPopup = document.getElementById('selection-popup');
    if (selectionPopup) {
        selectionPopup.style.display = 'none';
    }
    
    // 3. (Recomendado) Esconde o menu de a√ß√µes da Ideia (‚úÇÔ∏è)
    const ideaPopup = document.getElementById('idea-actions-popup');
    if (ideaPopup) {
        ideaPopup.style.display = 'none';
    }
});

// ====================================================================
// L√ìGICA DE MOVIMENTO LIVRE (ABSOLUTO) PARA POST-ITS
// ====================================================================

let activePostIt = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

// 1. Clicar no Puxador (Iniciar)
noteContentEditor.addEventListener('mousedown', (e) => {
    const handle = e.target.closest('.post-it-drag-handle');
    if (!handle) return;

    e.preventDefault(); // Impede sele√ß√£o de texto

    activePostIt = handle.closest('.post-it-note');
    
    // Calcula onde clic√°mos DENTRO do post-it (o "ponto de agarre")
    const rect = activePostIt.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    activePostIt.style.opacity = '0.8';
    activePostIt.style.zIndex = '100';
});

// 2. Mover o Rato (Arrastar)
document.addEventListener('mousemove', (e) => {
    if (!activePostIt) return;

    e.preventDefault();

    const container = document.getElementById('note-content-editor');
    
    // Obter as coordenadas do contentor (Editor)
    const containerRect = container.getBoundingClientRect();

    // Calcular a posi√ß√£o X/Y desejada relativa ao contentor
    // (Posi√ß√£oRato - Posi√ß√£oContainer + ScrollContainer - PontoDeAgarre)
    let newLeft = (e.clientX - containerRect.left + container.scrollLeft) - dragOffsetX;
    let newTop = (e.clientY - containerRect.top + container.scrollTop) - dragOffsetY;

    // --- APLICAR LIMITES (CLAMPING) ---
    
    // Limite Horizontal (0 at√© LarguraContainer - LarguraPostIt)
    // Subtra√≠mos 2px extra de seguran√ßa para bordas
    const maxLeft = container.clientWidth - activePostIt.offsetWidth;
    if (newLeft < 0) newLeft = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;

    // Limite Vertical (0 at√© AlturaTotalContainer - AlturaPostIt)
    // Usamos scrollHeight para permitir arrastar at√© ao fundo do texto longo
    const maxTop = container.scrollHeight - activePostIt.offsetHeight;
    if (newTop < 0) newTop = 0;
    if (newTop > maxTop) newTop = maxTop;

    // Aplicar
    activePostIt.style.left = newLeft + 'px';
    activePostIt.style.top = newTop + 'px';
});

// 3. Largar o Rato (Finalizar)
document.addEventListener('mouseup', () => {
    if (activePostIt) {
        activePostIt.style.opacity = '1';
        activePostIt.style.zIndex = '20';
        activePostIt = null;
        saveNote(); 
    }
});

// ====================================================================
// ADICIONE ESTE BLOCO DE EVENT LISTENERS NO FINAL DO SCRIPT
// ====================================================================
document.getElementById('references-toolbar').addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;

    console.log("üõ†Ô∏è Clique na Toolbar da 4¬™ Coluna:", button.id);

    const { id, type, name } = activeReferenceEntity;
    if (!name) {
        console.warn("‚ö†Ô∏è Nenhuma entidade ativa no painel.");
        return;
    }

    switch (button.id) {
        case 'references-refresh-btn':
            showReferencesPanel(id, name, type);
            break;

        case 'references-bookmark-btn':
            console.log("üîñ Solicitando abertura de Marcadores para:", name);
            // LOG DE VERIFICA√á√ÉO DE TIPO
            console.log("üîç Tipo da entidade ativa:", type);
            if (type === 'textobiblico') {
                openBookmarksModal();
            } else {
                console.warn("üö´ Marcadores s√≥ funcionam em Textos B√≠blicos.");
                alert("Marcadores s√£o exclusivos para Textos B√≠blicos.");
            }
            break;

        // --- NOVO: BOT√ÉO √ÇNCORA (‚öì) ---
        case 'references-anchor-btn':
            openAnchorManagerModal();
            break;
        // -----------------------------

        case 'references-wol-btn':
            const encodedQuery = encodeURIComponent(name).replace(/%20/g, '+');
            const wolUrl = `https://wol.jw.org/pt-PT/wol/l/r296/lp-tpo?q=${encodedQuery}`;
            window.open(wolUrl, '_blank');
            break;

        case 'references-search-btn':
            window.open(`https://wol.jw.org/pt/wol/s/r5/lp-t?q=${encodeURIComponent(name)}`, '_blank');
            break;

        case 'references-edit-btn':
            if (id) openEditEntityModal(id, type);
            break;

        case 'references-toggle-btn':
            const allDetails = document.querySelectorAll('#references-list details');
            const openCount = document.querySelectorAll('#references-list details[open]').length;
            const shouldOpen = openCount <= allDetails.length / 2;
            allDetails.forEach(detail => detail.open = shouldOpen);
            break;
    }
});

document.getElementById('toggle-puzzle-edit-btn').addEventListener('click', async () => {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // MODO: ENTRAR EM EDI√á√ÉO (Atualmente est√° em modo visualiza√ß√£o)
    if (!container.classList.contains('edit-mode-active')) {
        container.classList.add('edit-mode-active');
        
        // 1. Ajuste Visual do Bot√£o (Usa a classe is-active para ficar azul)
        btn.textContent = "Salvar";
        btn.classList.add('is-active'); 
        
        // 2. Mostrar os bot√µes de adicionar (+ Txt, + Ref, üì°)
        if(addButtons) addButtons.style.display = 'flex';

        // 3. Ativar a edi√ß√£o nos blocos de texto do quadro
        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'true');
            div.style.border = "1px solid var(--border-color)";
            div.style.padding = "8px";
            div.style.borderRadius = "4px";
            div.style.backgroundColor = "var(--bg-color)";
        });
    } 
    // MODO: SALVAR E SAIR (Atualmente est√° em modo edi√ß√£o)
    else {
        // 1. Feedback de grava√ß√£o e execu√ß√£o do Save no Firebase
        btn.textContent = "A gravar...";
        btn.disabled = true;
        await savePuzzleData();
        btn.disabled = false;

        // 2. Reverter Visual do Bot√£o (Volta ao cinza normal)
        container.classList.remove('edit-mode-active');
        btn.textContent = "Editar";
        btn.classList.remove('is-active'); 
        
        // 3. Esconder os bot√µes de adicionar
        if(addButtons) addButtons.style.display = 'none';

        // 4. Bloquear a edi√ß√£o visualmente (Limpa bordas e fundos de input)
        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'false');
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
});



 document.getElementById('anchors-modal').addEventListener('click', (e) => {
    // 1. CLIQUE NAS ABAS
    const tabButton = e.target.closest('button[data-tab]');
    if (tabButton) {
        // Remove active de todos
        document.querySelectorAll('#anchors-tabs-container button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#anchors-content-container .tab-content').forEach(content => content.classList.remove('active'));
        
        // Ativa o selecionado
        tabButton.classList.add('active');
        const contentId = `tab-${tabButton.dataset.tab}`;
        const contentDiv = document.getElementById(contentId);
        if(contentDiv) contentDiv.classList.add('active');
        return;
    }

    // 2. CLIQUE NUM ITEM DA LISTA (Tag ou Entidade)
    const listItem = e.target.closest('li');
    if (listItem) {
        // A√ß√£o para TAGS
        if (listItem.dataset.action === 'show-tag-references') {
            const tagName = listItem.dataset.tagName;
            if (tagName) {
                document.getElementById('anchors-modal').style.display = 'none';
                showTagReferencesPanel(tagName);
            }
        }
        // A√ß√£o para ENTIDADES (Usa o dataset action ou verifica entityId como fallback)
        else if (listItem.dataset.entityId || listItem.dataset.action === 'show-entity-references') {
            const { entityId, entityName, entityType } = listItem.dataset;
            if (entityId) {
                document.getElementById('anchors-modal').style.display = 'none';
                showReferencesPanel(entityId, entityName, entityType);
            }
        }
    }
});

referencesPanelCloseBtn.addEventListener('click', hideReferencesPanel);


// 1. Abrir Modal de Conta
document.getElementById('account-btn').addEventListener('click', () => {
    const modal = document.getElementById('account-modal');
    const nameDisplay = document.getElementById('profile-name-display');
    const emailDisplay = document.getElementById('profile-email-display');

    // Preenche os dados
    if (currentUserData) {
        nameDisplay.textContent = currentUserData.nome || "Sem Nome";
        emailDisplay.textContent = currentUserData.email || auth.currentUser.email;
    } else if (auth.currentUser) {
        nameDisplay.textContent = "Usu√°rio";
        emailDisplay.textContent = auth.currentUser.email;
    }

    modal.style.display = 'flex';
});

// 2. Bot√£o de Logout (Dentro do Modal de Conta)
document.getElementById('logout-btn').addEventListener('click', async () => {
    const confirmLogout = confirm("Tem certeza que deseja sair?");
    if (confirmLogout) {
        try {
            await signOut(auth);
            // onAuthStateChanged vai redirecionar
        } catch (error) {
            console.error("Erro ao sair", error);
        }
    }
});

document.execCommand('defaultParagraphSeparator', false, 'p');


// 1. Listener para abrir o modal a partir do menu
document.getElementById('context-menu').addEventListener('click', (e) => {
    if (e.target.dataset.action === 'change-icon') {
        // Esconde o menu
        document.getElementById('context-menu').style.display = 'none';
        
        // Abre o modal de √≠cones
        document.getElementById('icon-picker-modal').style.display = 'flex';
    }
});

// 2. Listener para quando escolhe um Emoji
document.getElementById('emoji-grid').addEventListener('click', async (e) => {
    const btn = e.target.closest('.emoji-btn');
    
    // CORRE√á√ÉO: Ler o ID que guard√°mos no modal
    const modal = document.getElementById('icon-picker-modal');
    const targetId = modal.dataset.targetFolderId;

    // Se n√£o houver bot√£o ou ID, sai
    if (!btn || !targetId) return;

    const selectedIcon = btn.dataset.icon;
    const isDefault = selectedIcon === 'üóÉÔ∏è';

    try {
        // Usa targetId em vez de activeItemContext.id
        const docRef = doc(db, 'pastas', targetId);
        
        if (isDefault) {
            await updateDoc(docRef, {
                customIcon: deleteField(),
                ultimaedicao: serverTimestamp()
            });
        } else {
            await updateDoc(docRef, {
                customIcon: selectedIcon,
                ultimaedicao: serverTimestamp()
            });
        }

        modal.style.display = 'none';
        // Limpa o dataset por seguran√ßa
        modal.removeAttribute('data-target-folder-id');

    } catch (error) {
        console.error("Erro ao mudar √≠cone:", error);
        alert("Erro ao atualizar √≠cone.");
    }
});


// --- L√ìGICA DO EDITOR DE MARGEM (BOT√ÉO üî¨) ---
document.querySelector('button[data-action="open-margin-editor"]').addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (!selectedNoteId) {
        alert("Selecione uma nota primeiro.");
        return;
    }

    // 1. Feedback Visual
    const btn = e.target;
    const originalText = btn.textContent;
    btn.textContent = "üíæ"; // √çcone de disquete tempor√°rio
    
    // 2. Gravar a nota atual (For√ßa grava√ß√£o imediata)
    // A fun√ß√£o saveNote(true) devolve uma Promise, por isso usamos await
    await saveNote(true);

    // 3. Redirecionar para a nova p√°gina enviando o ID da nota
    window.location.href = `editnote.html?noteId=${selectedNoteId}`;
});


// ====================================================================
// FECHAR POPUPS AO CLICAR NAS BARRAS DE FERRAMENTAS
// ====================================================================
const toolbars = [
    document.getElementById('editor-toolbar'),    // Barra Principal (onde est√£o üîì, üìë, üïí)
    document.getElementById('secondary-toolbar')  // Barra Secund√°ria (onde est√£o H1, H2, Cor)
];

toolbars.forEach(toolbar => {
    if (toolbar) {
        toolbar.addEventListener('click', () => {
            // 1. Esconde o menu de inser√ß√£o r√°pida (üìò üìó üìô üìí)
            const insertPopup = document.getElementById('insertion-popup');
            if (insertPopup) insertPopup.style.display = 'none';

            // 2. (Opcional) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üé¥) se estiver aberto
            const selectPopup = document.getElementById('selection-popup');
            if (selectPopup) selectPopup.style.display = 'none';
        });
    }
});

// --- BOT√ÉO DE PESQUISA GLOBAL (RODAP√â ESQUERDO) ---
const globalSearchBtn = document.getElementById('global-search-btn');
if (globalSearchBtn) {
    globalSearchBtn.addEventListener('click', () => {
        // Usa a mesma fun√ß√£o que a lupa da barra de ferramentas
        openExplorerModal();
    });
}


// ====================================================================
// L√ìGICA DO ENTER EM LINHAS MOV√çVEIS (SAIR PARA LINHA NORMAL)
// ====================================================================
noteContentEditor.addEventListener('keydown', (e) => {
    // 1. DETETOR B√ÅSICO
    if (e.key === 'Enter') {

        
        if (e.shiftKey) {
            console.log("   (Shift+Enter detetado -> Ignorando l√≥gica customizada)");
            return;
        }

        const selection = window.getSelection();
        if (!selection.rangeCount) {
            console.log("‚ùå Sem sele√ß√£o de cursor ativa.");
            return;
        }

        const anchorNode = selection.anchorNode;
        console.log("üìç N√≥ do cursor:", anchorNode);

        // Garante que pegamos o elemento HTML da linha
        const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        console.log("   Elemento HTML:", element);

        const draggableLine = element.closest('.draggable-line');
        console.log("üîç √â linha arrast√°vel?", draggableLine ? "SIM" : "N√ÉO");

        if (draggableLine) {
            console.group("üöÄ A INICIAR L√ìGICA DE INSER√á√ÉO");
            e.preventDefault(); 
            e.stopPropagation();

            // 1. AN√ÅLISE DO PAI ORIGINAL
            const currentParent = draggableLine.parentElement;
            console.log("1. Pai da linha atual:", currentParent);
            console.log("   Classes:", currentParent.className);

            const contentArea = draggableLine.querySelector('.drag-content-area');
            const newParagraph = document.createElement('p');
            newParagraph.style.margin = "4px 0";
            newParagraph.setAttribute('data-debug', 'nova-linha-' + Date.now()); // Marca para identificar

            // Corte de texto
            const range = selection.getRangeAt(0);
            const rangeToEnd = document.createRange();
            rangeToEnd.selectNodeContents(contentArea);
            rangeToEnd.setStart(range.endContainer, range.endOffset);
            
            const fragment = rangeToEnd.extractContents();
            newParagraph.appendChild(fragment);

            if (newParagraph.innerHTML.trim() === '') newParagraph.innerHTML = '<br>';

            // 2. INSER√á√ÉO (M√âTODO AFTEREND)
            console.log("2. A executar: draggableLine.insertAdjacentElement('afterend', newParagraph)");
            draggableLine.insertAdjacentElement('afterend', newParagraph);

            // 3. VERIFICA√á√ÉO P√ìS-INSER√á√ÉO
            const newParent = newParagraph.parentElement;
            console.log("3. Pai da NOVA linha:", newParent);

            if (currentParent !== newParent) {
                console.error("üö® ERRO CR√çTICO: O pai mudou! A linha fugiu.");
                console.warn("   Esperado:", currentParent);
                console.warn("   Obtido:", newParent);
                
                // CORRE√á√ÉO FOR√áADA
                console.log("üõ†Ô∏è APLICANDO CORRE√á√ÉO FOR√áADA: currentParent.appendChild");
                currentParent.appendChild(newParagraph);
            } else {
                console.log("‚úÖ SUCESSO: A linha ficou no mesmo pai.");
            }

            console.groupEnd();

            // Foco
            const newRange = document.createRange();
            if (newParagraph.firstChild && newParagraph.firstChild.nodeType === 3) {
                newRange.setStart(newParagraph.firstChild, 0);
            } else {
                newRange.selectNodeContents(newParagraph);
            }
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);

            saveNote();
        } else {
            console.log("‚ÑπÔ∏è Enter normal (fora de linha mov√≠vel).");
        }
    }
});


// --- FUN√á√ÉO PARA CRIAR UMA LINHA DE CODEX (FIX) ---
window.createCodexRow = function(data = null) {
    const container = document.getElementById('codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    // Se estiver editando um item existente, guardamos o ID do Firestore
    if (data && data.id) row.setAttribute('data-firestore-id', data.id);

    row.innerHTML = `
        <button class="remove-codex-row" onclick="window.removeCodexRow(this)">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                <!-- Onde aparecer√° o nome completo da publica√ß√£o -->
                <div class="serie-fullname" style="font-size: 11px; color: var(--accent-color); margin-top: 4px; height: 14px; font-weight: 500; font-style: italic;"></div>
            </div>
            <div class="manual-controls">
                <label class="codex-label">OP√á√ïES</label>
                <div style="display:flex; gap:4px;">
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'A')" title="Ano Manual">A</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'M')" title="M√™s Manual">M</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'T')" title="Tempo (H:M:S)">T</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'C')" title="Cap√≠tulo Manual">C</button>
                </div>
            </div>
        </div>
        <div class="manual-inputs-area"></div> 
        <div class="codex-content-grid">
            <div class="unit-section">
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div class="unit-section">
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;

    // --- L√ìGICA DE IDENTIFICA√á√ÉO DA SIGLA ---
    const inputSerie = row.querySelector('.serie-main');
    const displayFullName = row.querySelector('.serie-fullname');

    const updateFullName = (val) => {
        if (!val) {
            displayFullName.textContent = "";
            return;
        }

        const valorBaixo = val.toLowerCase().trim();
        
        // 1. Extra√ß√£o da Sigla: 
        // Pega as letras iniciais. Se houver h√≠fen e n√∫mero (ex: it-1), pega tamb√©m.
        // Se houver espa√ßo ou n√∫mero logo ap√≥s as letras (ex: w24), isola as letras.
        let sigla = "";
        const match = valorBaixo.match(/^[a-z]+(?:-[0-9])?/);
        if (match) sigla = match[0];

        // 2. Busca no dicion√°rio importado (SIGLAS_PUBLICACOES)
        // Nota: Certifique-se de que SIGLAS_PUBLICACOES est√° acess√≠vel neste escopo
        const nomeCompleto = SIGLAS_PUBLICACOES[sigla];

        if (nomeCompleto) {
            displayFullName.textContent = `üìö ${nomeCompleto}`;
        } else {
            displayFullName.textContent = "";
        }
    };

    // Listener para quando o utilizador escreve
    inputSerie.addEventListener('input', (e) => updateFullName(e.target.value));

    container.appendChild(row);

    // Se houver dados (edi√ß√£o), preenchemos os chips e o nome completo
    if (data) {
        updateFullName(data.serie);
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addCodexUnit(pgContainer, 'Par', p));
    } else {
        // Linha nova: adiciona chips vazios para facilitar
        window.addCodexUnit(row.querySelector('.pages-container'), 'P√°g');
        window.addCodexUnit(row.querySelector('.paragraphs-container'), 'Par');
    }
};

// 1. Fun√ß√£o Auxiliar: Atualizar Estado Visual do Bot√£o
function updateBoxLinkButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="manage-box-links"]');
    if (!btn) return;

    const linksJson = wrapper.getAttribute('data-box-links') || '{}';
    let hasContent = false;

    try {
        const links = JSON.parse(linksJson);
        
        // Verifica as tr√™s camadas de conte√∫do poss√≠vel
        const hasUrls = links.urls && Object.keys(links.urls).length > 0;
        const hasCodex = links.codex && links.codex.length > 0;
        const hasCategories = links.categories && links.categories.length > 0; // NOVA VERIFICA√á√ÉO

        // Se tiver QUALQUER uma das tr√™s, ativa a cor amarela
        if (hasUrls || hasCodex || hasCategories) {
            hasContent = true;
        }
    } catch (e) { 
        hasContent = false; 
    }

    if (hasContent) {
        // ESTADO ATIVO (AMARELO)
        btn.classList.add('has-links');
        btn.title = "Conte√∫do Anexado (Ativo)";
        btn.style.borderColor = "#f1c40f"; // Cor Amarela
        btn.style.color = "#f1c40f";
    } else {
        // ESTADO INATIVO (RESET)
        btn.classList.remove('has-links');
        btn.style.borderColor = "";
        btn.style.color = "";
        btn.title = "Adicionar Hiperliga√ß√µes, Codex ou Categorias";
    }
}

// 2. Fun√ß√µes Globais para o Codex (Escopo Window)
 window.addCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    // Insere antes do bot√£o "+"
    container.insertBefore(unit, container.lastChild);
};

// Gerencia os bot√µes A e M (Ano e M√™s manuais)
window.toggleManual = function(btn, type) {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    btn.classList.toggle('active');
    
    if (btn.classList.contains('active')) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = `codex-input-manual manual-${type === 'A' ? 'year' : 'month'}`;
        input.placeholder = type === 'A' ? "Ano" : "M√™s";
        area.appendChild(input);
    } else {
        const target = area.querySelector(`.manual-${type === 'A' ? 'year' : 'month'}`);
        if (target) target.remove();
    }
};

// Remove a linha inteira do Codex
window.removeCodexRow = function(btn) {
    if (document.querySelectorAll('.codex-row').length > 1) {
        btn.closest('.codex-row').remove();
    } else {
        alert("√â necess√°rio pelo menos uma linha.");
    }
};

window.removeManualField = function(btn, type) {
    const row = btn.closest('.codex-row');
    const fieldGroup = btn.closest('.manual-field-group');
    
    // 1. Encontra o bot√£o A ou M correspondente e desativa-o
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if (toggleBtn) toggleBtn.classList.remove('active');
    
    // 2. Remove o campo do ecr√£
    fieldGroup.remove();
};




// 3. Fun√ß√µes de Suporte para Processamento
function parseSerieInfo(serie, manualYear, manualMonth) {
    let ano = manualYear || "";
    let mes = manualMonth || "";
    const s = serie.toLowerCase();
    const yearMatch = s.match(/[wg](\d{2})/);
    if (yearMatch && !ano) {
        const yy = parseInt(yearMatch[1]);
        ano = yy > 35 ? (1900 + yy).toString() : (2000 + yy).toString();
    }
    const monthMatch = s.match(/\d{1,2}\/(\d{1,2})/);
    if (monthMatch && !mes) {
        const mIdx = parseInt(monthMatch[1]) - 1;
        if (mIdx >= 0 && mIdx < 12) mes = MESES_LISTA[mIdx];
    }
    if (!mes) MESES_LISTA.forEach(m => { if (s.includes(m.toLowerCase())) mes = m; });
    return { ano, mes };
}

function getCodexDataFromRow(row) {
    // Tenta apanhar valores, garantindo que n√£o falha se o elemento n√£o existir
    const serieInput = row.querySelector('.serie-main');
    const serieVal = serieInput ? serieInput.value.trim() : "";
    
    // Recolhe p√°ginas e par√°grafos
    const paginas = Array.from(row.querySelectorAll('.pages-container input'))
                         .map(i => i.value.trim()).filter(v => v !== "");
    const paragrafos = Array.from(row.querySelectorAll('.paragraphs-container input'))
                          .map(i => i.value.trim()).filter(v => v !== "");

    // Recolhe campos manuais (se existirem na linha)
    const yearInput = row.querySelector('.manual-year');
    const monthInput = row.querySelector('.manual-month');
    const chapInput = row.querySelector('.manual-chapter');
    
    // Novos campos de tempo (H:M:S) se existirem
    const hInput = row.querySelector('.h-input');
    const mInput = row.querySelector('.m-input');
    const sInput = row.querySelector('.s-input');
    
    let tempoStr = "";
    if (hInput || mInput || sInput) {
        const h = hInput ? hInput.value : "00";
        const m = mInput ? mInput.value : "00";
        const s = sInput ? sInput.value : "00";
        if (h!=="00" || m!=="00" || s!=="00") tempoStr = `${h}:${m}:${s}`;
    }

    return {
        serie: serieVal,
        paginas: paginas,
        paragrafos: paragrafos,
        manualYear: yearInput ? yearInput.value : null,
        manualMonth: monthInput ? monthInput.value : null,
        capitulo: chapInput ? chapInput.value : null,
        tempo: tempoStr
    };
}

window.openBoxLinkManager = async function(wrapper) {
    console.log("üöÄ [GESTOR] Abertura iniciada para caixa:", wrapper.id);
    
    // Guarda o ID para buscar o elemento "vivo" na hora de gravar
    const targetWrapperId = wrapper.id;

    const modal = document.getElementById('link-modal');
    const tabHeader = document.getElementById('box-link-tabs'); 
    const modalTitle = document.getElementById('link-modal-title'); 
    
    const refsDiv = document.getElementById('box-content-refs');
    const codexDiv = document.getElementById('box-content-codex');
    const categDiv = document.getElementById('box-content-categories'); 
    
    const saveBtn = document.getElementById('link-save-btn');
    const addUrlBtn = document.getElementById('add-url-btn'); 
    const addCodexBtn = document.getElementById('add-codex-row-btn'); // <--- O bot√£o que faltava ligar
    const bibleToggle = document.getElementById('search-bible-toggle');
    
    // 1. VISIBILIDADE
    document.body.appendChild(modal);
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        z-index: 2147483647 !important;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.85);
        justify-content: center; align-items: center;
    `;

    // 2. CARREGAR DADOS
    let currentData = {};
    try {
        currentData = JSON.parse(wrapper.getAttribute('data-box-links') || '{}');
    } catch (e) { currentData = {}; }

    // 3. RESET UI
    if (tabHeader) tabHeader.style.display = 'flex'; 
    if (modalTitle) modalTitle.textContent = "Gest√£o de Links"; 
    
    document.getElementById('codex-rows-container').innerHTML = '';
    document.getElementById('link-urls-container').innerHTML = '';
    document.getElementById('link-remove-btn').style.display = 'none';

    // Toggle B√≠blia
    if (bibleToggle) bibleToggle.checked = currentData.bibleMode === true;
    
    // T√≠tulo
    document.getElementById('link-title-input').value = currentData.title || "";
    
    // URLs
    const urls = currentData.urls ? Object.values(currentData.urls) : [];
    if (urls.length > 0) urls.forEach(url => addUrlField(url));
    else addUrlField(); 

    // Codex
    if (currentData.codex && currentData.codex.length > 0) {
        currentData.codex.forEach(item => window.createCodexRow(item));
    } else { 
        window.createCodexRow(); 
    }

    // Categorias
    selectedCategoriesForBox = currentData.categories || [];
    renderAttachedCategories();

    // 4. CONFIGURAR BOT√ÉO URL (+)
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = (e) => { e.preventDefault(); addUrlField(); };
    
    // ============================================================
    // 5. CONFIGURAR BOT√ÉO CODEX (+) -> ESTA FOI A PARTE ADICIONADA
    // ============================================================
 const newAddCodexBtn = addCodexBtn.cloneNode(true);
    addCodexBtn.parentNode.replaceChild(newAddCodexBtn, addCodexBtn);
    
    newAddCodexBtn.onclick = (e) => { 
        e.preventDefault(); 
        e.stopPropagation();
        
        // 1. Cria a linha
        window.createCodexRow(); 

        // 2. Faz Scroll e Foca na nova linha
        setTimeout(() => {
            const container = document.getElementById('codex-rows-container');
            const lastRow = container ? container.lastElementChild : null;
            
            if (lastRow) {
                // Scroll suave at√© √† nova linha
                lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Foca no primeiro campo (S√©rie) para escrever logo
                const firstInput = lastRow.querySelector('input');
                if (firstInput) firstInput.focus();
                
                // Opcional: Um flash visual r√°pido na borda para destacar
                lastRow.style.transition = "border-color 0.3s";
                lastRow.style.borderColor = "var(--accent-color)";
                setTimeout(() => {
                    lastRow.style.borderColor = ""; // Volta √† cor original (CSS hover trata do resto)
                }, 1000);
            }
        }, 50); // Pequeno atraso para o DOM atualizar
    };
    // ============================================================

    // 6. GEST√ÉO DE ABAS
    const tabButtons = tabHeader.querySelectorAll('button');
    tabButtons.forEach(btn => {
        btn.onclick = (e) => {
            e.preventDefault();
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const target = btn.getAttribute('data-box-tab');
            refsDiv.style.display = 'none';
            codexDiv.style.display = 'none';
            categDiv.style.display = 'none';
            newAddUrlBtn.style.display = 'none';
            newAddCodexBtn.style.display = 'none'; // Usa a nova refer√™ncia

            if (target === 'refs') {
                refsDiv.style.display = 'block';
                newAddUrlBtn.style.display = 'block';
            } else if (target === 'codex') {
                codexDiv.style.display = 'block';
                newAddCodexBtn.style.display = 'block'; // Mostra na aba certa
            } else if (target === 'categories') {
                categDiv.style.display = 'block';
            }
        };
    });

    // Abre a aba correta por defeito
    if (currentData.codex && currentData.codex.length > 0) {
        tabButtons[1].click(); // Aba Codex
    } else {
        tabButtons[0].click(); // Aba Refs
    }

    // 7. BOT√ÉO GRAVAR
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.textContent = "A gravar...";
        
        // RE-BUSCAR A CAIXA VIVA NO DOM
        const liveWrapper = document.getElementById(targetWrapperId);
        
        if (!liveWrapper) {
            alert("Erro cr√≠tico: A caixa original foi perdida. Tente abrir novamente.");
            modal.style.display = 'none';
            return;
        }

        try {
            // Processar URLs
            const urlsToSave = {};
            document.querySelectorAll('#link-urls-container input').forEach((inp, i) => {
                if(inp.value.trim()) {
                    let val = inp.value.trim();
                    if(!val.startsWith('http')) val = 'https://' + val;
                    urlsToSave[`url_${Date.now()}_${i}`] = val;
                }
            });

            // Processar Codex
            const codexToSave = [];
            modal.querySelectorAll('.codex-row').forEach(row => {
                const rowData = getCodexDataFromRow(row);
                
                // Grava se tiver S√©rie OU P√°ginas OU Ano manual
                if (rowData.serie || rowData.paginas.length > 0 || rowData.manualYear) {
                    let totalStr = rowData.serie || "Ref.";
                    if (rowData.manualMonth && rowData.manualYear) totalStr += ` ${rowData.manualMonth}/${rowData.manualYear}`;
                    else if (rowData.manualYear) totalStr += ` ${rowData.manualYear}`;
                    
                    if (rowData.capitulo) totalStr += `, cap. ${rowData.capitulo}`;
                    if (rowData.paginas.length > 0) totalStr += `, p√°g. ${rowData.paginas.join(', ')}`;
                    if (rowData.paragrafos.length > 0) totalStr += `, par. ${rowData.paragrafos.join(', ')}`;
                    if (rowData.tempo) totalStr += ` [${rowData.tempo}]`;

                    rowData.total = totalStr;
                    codexToSave.push(rowData);
                }
            });

            const finalJson = { 
                title: document.getElementById('link-title-input').value.trim(), 
                urls: urlsToSave, 
                codex: codexToSave,
                categories: selectedCategoriesForBox,
                bibleMode: bibleToggle ? bibleToggle.checked : false
            };
            
            liveWrapper.setAttribute('data-box-links', JSON.stringify(finalJson));
            
            if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(liveWrapper);
            if (typeof updateAquariumLinkButtonState === 'function') updateAquariumLinkButtonState(liveWrapper);
            
            const isAquarium = document.getElementById('aquarium-environment').style.display !== 'none';
            if (isAquarium && typeof saveAquariumState === 'function') {
                await window.saveAquariumState();
            } else {
                await saveNote(true);
            }
            
            modal.style.display = 'none';

        } catch (err) {
            console.error("Erro ao gravar links:", err);
            alert("Erro ao gravar dados da caixa.");
        } finally {
            newSaveBtn.textContent = "Gravar";
        }
    };
};




// 5. Listener para o bot√£o ‚ö° no editor (CORRIGIDO PARA REDATOR)
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="manage-box-links"]');
    if (!btn) return;
    
    e.preventDefault(); 
    e.stopPropagation();
    
    // Procura por Subnota OU Redator
    const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
    
    if (wrapper) {
        openBoxLinkManager(wrapper);
    } else {
        console.error("‚ùå Erro: Wrapper n√£o encontrado para o bot√£o de links.");
    }
});




// --- CRIA√á√ÉO DOS BOT√ïES FLUTUANTES (MOBILE) ---
// Injetamos o HTML via JS para n√£o poluir a estrutura original
(function createMobileFABs() {
    const existingContainer = document.getElementById('mobile-fab-container');
    if (existingContainer) existingContainer.remove();

    const fabContainer = document.createElement('div');
    fabContainer.id = 'mobile-fab-container';
    
    fabContainer.innerHTML = `
        <!-- BOT√ÉO FLASH (Laranja e Menor) -->
        <button id="mobile-fab-flash" class="fab-btn" title="Cria√ß√£o R√°pida Flash" 
                style="background-color: #e67e22; color: white; border-color: #e67e22; font-size: 18px; width: 38px; height: 38px; margin-bottom: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">‚ö°</button>
        
        <!-- BOT√ÉO ADICIONAR (Azul e Maior) -->
        <button id="mobile-fab-add" class="fab-btn" title="Adicionar Item"
                style="background-color: var(--accent-color); color: white; border-color: var(--accent-color); font-size: 28px; width: 56px; height: 56px;">+</button>
        
        <!-- OUTROS BOT√ïES -->
        <button id="mobile-fab-account" class="fab-btn" title="Minha Conta">üë§</button>
        <button id="mobile-fab-search" class="fab-btn" title="Pesquisa Global">üîé</button>
        <button id="mobile-fab-settings" class="fab-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
    `;
    
    document.body.appendChild(fabContainer);

    // --- LOGICA DO BOT√ÉO FLASH (CRUCIAL) ---
    document.getElementById('mobile-fab-flash').addEventListener('click', () => {
        // 1. Muda explicitamente para a aba Flash
        // Isto garante que currentViewMode = 'flash' e que a lista da esquerda carrega os itens flash
        window.switchFolderView('flash');

        // 2. Pequeno delay para a vari√°vel global atualizar antes de abrir o modal
        setTimeout(() => {
            const originalAddBtn = document.getElementById('add-item-btn');
            if(originalAddBtn) {
                // Simula o clique no bot√£o "+" normal.
                // Como j√° estamos em modo 'flash', ele abrir√° o menu restrito (Nota/Jornal)
                // e a cria√ß√£o ter√° o campo oque='flash' automaticamente.
                originalAddBtn.click();
            }
        }, 50);
    });

    // --- Outros Listeners ---
    document.getElementById('mobile-fab-add').addEventListener('click', () => {
        // Se estiver em modo Flash e clicar no bot√£o azul grande, 
        // talvez queira voltar ao modo Local?
        // Se sim, descomente a linha abaixo. Caso contr√°rio, mant√©m o modo atual.
        // if (currentViewMode === 'flash') window.switchFolderView('local');

        const btn = document.getElementById('add-item-btn');
        if(btn) btn.click();
    });

    document.getElementById('mobile-fab-account').addEventListener('click', () => {
        const btn = document.getElementById('account-btn');
        if(btn) btn.click();
    });

    document.getElementById('mobile-fab-search').addEventListener('click', () => {
        const btn = document.getElementById('global-search-btn');
        if(btn) btn.click();
    });

    document.getElementById('mobile-fab-settings').addEventListener('click', () => {
        const btn = document.getElementById('settings-btn');
        if(btn) btn.click();
    });

})();

// ====================================================================
// MOTOR DE ARRASTO UNIFICADO (LINHAS ·Øì + CART√ïES üé¥)
// ====================================================================
let dragSrcEl = null;   // Para Linhas
let draggedCard = null; // Para Cart√µes

// 1. INICIAR ARRASTO (DRAGSTART)
noteContentEditor.addEventListener('dragstart', (e) => {
    
    // --- 1. VERIFICA√á√ÉO DE CUBO (üßä) ---
    // S√≥ permite arrastar se clicou no puxador OU na borda
    const cubeHandle = e.target.closest('.cube-drag-handle');
    const cube = e.target.closest('.journal-cube-wrapper');

    if (cube && cubeHandle) {
        draggedCard = cube; // Reutilizamos a vari√°vel de cart√µes
        dragSrcEl = null;   // Garante que n√£o mistura com linhas

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', cube.id); // Necess√°rio para Firefox
        e.dataTransfer.setDragImage(cube, 0, 0);

        setTimeout(() => cube.classList.add('sortable-dragging'), 0);
        return; 
    }

    // --- 2. VERIFICA√á√ÉO DE CART√ÉO URL (üé¥) ---
    const card = e.target.closest('.url-card-widget');
    if (card && !e.target.classList.contains('url-card-close')) {
        draggedCard = card;
        dragSrcEl = null;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', card.id);
        e.dataTransfer.setDragImage(card, 0, 0);

        setTimeout(() => card.classList.add('sortable-dragging'), 0);
        return;
    }

    // --- 3. VERIFICA√á√ÉO DE LINHAS DE TEXTO (·Øì) ---
    const line = e.target.closest('.draggable-line');
    if (line) {
        dragSrcEl = line;
        draggedCard = null;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', line.outerHTML);
        
        line.classList.add('dragging');
        setTimeout(() => line.style.opacity = '0.4', 0);
    }
});

// 1. DRAG OVER (Calcular o lado: Esquerda vs Direita)
noteContentEditor.addEventListener('dragover', (e) => {
    e.preventDefault(); // Permite o drop

    // Se n√£o estivermos a arrastar um Cubo ou Cart√£o, sai
    if (!draggedCard) return;

    // Identifica o alvo (Imagem, Outro Cubo, Cart√£o)
    const target = e.target.closest('.journal-img-wrapper, .journal-cube-wrapper, .url-card-widget');
    
    // Se encontrou um alvo v√°lido e n√£o √© o pr√≥prio item que estamos a arrastar
    if (target && target !== draggedCard) {
        const rect = target.getBoundingClientRect();
        const midPoint = rect.left + (rect.width / 2);
        
        // Limpa classes antigas
        target.classList.remove('drop-target-left', 'drop-target-right');

        // Decide o lado baseado na posi√ß√£o do rato
        if (e.clientX < midPoint) {
            target.classList.add('drop-target-left');
        } else {
            target.classList.add('drop-target-right');
        }
    }
});

// 2. DRAG LEAVE (Limpeza visual ao sair de cima de um item)
noteContentEditor.addEventListener('dragleave', (e) => {
    const target = e.target.closest('.journal-img-wrapper, .journal-cube-wrapper, .url-card-widget');
    if (target) {
        target.classList.remove('drop-target-left', 'drop-target-right');
    }
});

// 3. DROP (Aplicar a L√≥gica de Flutua√ß√£o)
noteContentEditor.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();

    // Se estivermos a arrastar um Cubo ou Cart√£o
    if (draggedCard) {
        // Encontra o alvo
        const target = e.target.closest('.journal-img-wrapper, .journal-cube-wrapper, .url-card-widget, p');
        
        if (target && target !== draggedCard) {
            const rect = target.getBoundingClientRect();
            const midX = rect.left + (rect.width / 2);
            
            // Verifica se √© um widget (Imagem/Cubo) para aplicar l√≥gica lateral
            const isWidget = target.classList.contains('journal-img-wrapper') || 
                             target.classList.contains('journal-cube-wrapper') ||
                             target.classList.contains('url-card-widget');

            // --- L√ìGICA DE ENCAIXE LATERAL ---
            if (isWidget) {
                // Se largar na ESQUERDA
                if (e.clientX < midX) {
                    target.parentNode.insertBefore(draggedCard, target);
                    
                    // Se for um Cubo, for√ßa flutua√ß√£o √† esquerda para alinhar
                    if (draggedCard.classList.contains('journal-cube-wrapper')) {
                        draggedCard.classList.remove('float-right', 'float-none');
                        draggedCard.classList.add('float-left');
                    }
                } 
                // Se largar na DIREITA
                else {
                    target.parentNode.insertBefore(draggedCard, target.nextSibling);
                    
                    // Se for um Cubo, for√ßa flutua√ß√£o √† direita
                    if (draggedCard.classList.contains('journal-cube-wrapper')) {
                        draggedCard.classList.remove('float-left', 'float-none');
                        draggedCard.classList.add('float-right');
                    }
                }
            } 
            // --- L√ìGICA DE PAR√ÅGRAFOS (Cima/Baixo normal) ---
            else {
                const midY = rect.top + (rect.height / 2);
                if (e.clientY < midY) target.parentNode.insertBefore(draggedCard, target);
                else target.parentNode.insertBefore(draggedCard, target.nextSibling);
                
                // Se largar num par√°grafo vazio, remove flutua√ß√£o para ocupar largura total
                if (draggedCard.classList.contains('journal-cube-wrapper')) {
                    draggedCard.classList.remove('float-left', 'float-right');
                }
            }
            
            saveNote();
        }
        
        // Limpeza final
        if (target) target.classList.remove('drop-target-left', 'drop-target-right');
        draggedCard.classList.remove('sortable-dragging');
        draggedCard = null;
        return; // Sai para n√£o executar a l√≥gica de linhas
    }
    
    // --- L√ìGICA DE LINHAS (·Øì) ---
    if (dragSrcEl) {
        const target = e.target.closest('.draggable-line, .mini-note-wrapper, details.toggle-section, p');
        
        if (target && target !== dragSrcEl) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
            
            target.classList.remove('drop-target-top', 'drop-target-bottom');

            if (next) target.parentNode.insertBefore(dragSrcEl, target.nextSibling);
            else target.parentNode.insertBefore(dragSrcEl, target);
            
            saveNote();
        }
        
        if (dragSrcEl) {
            dragSrcEl.style.opacity = '1';
            dragSrcEl.classList.remove('dragging');
        }
    }
});

// --- NOVA FUN√á√ÉO: MUDAR ENTRE LOCAL E PARTILHA ---
async function switchFolderView(mode) {
    // 1. Remove bot√µes flutuantes durante a transi√ß√£o
    document.body.classList.remove('show-fab');

    // 2. Evita recarregar se j√° estivermos no modo e na raiz
    if (mode === currentViewMode && navigationStack.length === 0) return;

    // 3. GRAVA√á√ÉO AUTOM√ÅTICA DE SEGURAN√áA (Antes de mudar a vista)
    const idToSave = activeEditingPostId || window.activeEditingPostId;
    
    if (currentSaveStatus === 'unsaved' || idToSave) {
        console.log("üíæ [SISTEMA] Gravando altera√ß√µes pendentes antes de mudar de modo...");
        try {
            if (idToSave) {
                // Se for um post de Arquivo, grava e remove o cadeado
                const tempId = idToSave;
                activeEditingPostId = null;
                window.activeEditingPostId = null;
                await window.saveArchivePost(tempId);
            } else if (selectedNoteId) {
                // Se for uma nota normal, for√ßa a grava√ß√£o imediata
                await saveNote(true);
            }
        } catch (e) {
            console.error("Erro ao gravar durante mudan√ßa de modo:", e);
        }
    }

    // 4. LIMPEZA TOTAL DE ESTADO E OUVINTES (Snapshot Cleanup)
    col1SelectedId = null;
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }
    if (unsubscribeShared2) { unsubscribeShared2(); unsubscribeShared2 = null; }
    if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    // Reseta o editor e limpa sele√ß√£o visual da Coluna 2
    resetEditor();             

    // 5. ATUALIZA O MODO E ESTADO DE NAVEGA√á√ÉO
    currentViewMode = mode;    
    navigationStack = [];      

    // 6. RECONSTR√ìI A INTERFACE (Cabe√ßalhos e Abas da Esquerda)
    updateNavigationView(true);

    // Refer√™ncia ao bot√£o "+"
    const addItemBtn = document.getElementById('add-item-btn');

    // 7. CARREGAMENTO ESPEC√çFICO DE DADOS
    
    // --- MODO PINS ---
    if (mode === 'pins') {
        console.log("üìå [SISTEMA] Modo Pins Ativado.");
        loadPinsView(); 
        
        // No modo Pins, geralmente escondemos o bot√£o de adicionar na lista
        if (addItemBtn) addItemBtn.style.display = 'none';
    } 
    
    // --- MODO FLASH (NOVO - LARANJA) ---
    else if (mode === 'flash') {
        console.log("‚ö° [SISTEMA] Modo Flash Ativado.");
        
        // 1. Configura bot√£o "+"
        const addItemBtn = document.getElementById('add-item-btn');
        if (addItemBtn) {
            addItemBtn.style.display = 'flex';
            addItemBtn.className = ''; 
            addItemBtn.classList.add('flash-mode');
        }

        // 2. Limpa ouvintes antigos
        if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
        if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }

        // 3. COLUNA 1 (ESQUERDA): Lista de Itens Flash
        // Aqui vamos carregar a lista de itens Flash na esquerda tamb√©m, ou um menu espec√≠fico
        loadFlashListLeftPanel(); 

        // 4. COLUNA 2 (MEIO): Detalhes ou Lista Secund√°ria (depende da sua prefer√™ncia)
        // Se quiser que a Coluna 2 mostre o conte√∫do do item clicado na esquerda, 
        // ou se quiser que a Coluna 2 seja a lista principal e a esquerda fique vazia/est√°tica.
        
        // OP√á√ÉO A: A esquerda mostra a lista de itens Flash. O meio fica vazio at√© clicar.
        const midList = document.getElementById('file-list');
        midList.innerHTML = '<li style="padding:40px; text-align:center; color:#e67e22; opacity:0.5;">‚ö°<br>Selecione um item Flash<br>ou crie um novo.</li>';
        
        // OP√á√ÉO B (O que pediu): "s√≥ podem aparecer notas e jornais com oque=flash"
        // Se a ideia √© ter a lista na ESQUERDA, use a fun√ß√£o abaixo.
        
        // No mobile, salta para a lista (agora na esquerda)
        if (window.innerWidth <= 768) {
            document.body.classList.remove('mobile-view-editor');
            // Nota: No seu CSS mobile, a esquerda √© 'mobile-view-middle' ou normal?
            // Geralmente esquerda √© default. Vamos garantir que a esquerda est√° vis√≠vel.
            document.body.classList.remove('mobile-view-middle'); 
        }
    }

    // --- MODO PARTILHA (VERMELHO) ---
    else if (mode === 'shared') {
        console.log("ü§ù [SISTEMA] Modo Partilha Ativado.");
        loadSharedFilesRoot(); // Carrega arquivos na Coluna 2

        if (addItemBtn) {
            addItemBtn.style.display = 'flex';
            addItemBtn.classList.remove('flash-mode', 'yellow-mode');
            addItemBtn.classList.add('shared-mode'); // Adiciona estilo Vermelho
        }

        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-view-middle');
            document.body.classList.remove('mobile-view-editor');
        }
    }
    
    // --- MODO LOCAL (AZUL/PADR√ÉO) ---
    else if (mode === 'local') {
        console.log("üè† [SISTEMA] Modo Local Ativado.");
        
        if (addItemBtn) {
            addItemBtn.style.display = 'flex';
            // Remove estilos especiais para voltar ao azul padr√£o
            addItemBtn.classList.remove('shared-mode', 'yellow-mode', 'flash-mode');
        }
        // A lista local √© carregada automaticamente pelo updateNavigationView()
    }

    // 8. ATUALIZA BOT√ïES FLUTUANTES (Se aplic√°vel)
    updateMobileFABVisibility();
}

// Exp√µe a fun√ß√£o globalmente para os bot√µes HTML
window.switchFolderView = switchFolderView;

// ============================================================
// L√ìGICA DO MODO ARQUIVO (FEED DE POSTS)
// ============================================================




// 2. Renderizar o Feed
window.renderArchiveFeed = async function() {
    const feed = document.getElementById('archive-feed');
    const postBtn = document.getElementById('create-post-btn');
    const drawerBtn = document.getElementById('create-drawer-trigger-btn');
    const separatorBtn = document.getElementById('create-separator-btn');

    if (!feed) return;

    // --- RESET: Esconde todos os bot√µes de a√ß√£o ---
    if (postBtn) postBtn.style.display = 'none';
    if (drawerBtn) drawerBtn.style.display = 'none';
    if (separatorBtn) separatorBtn.style.display = 'none';

    // --- CASO 1: DENTRO DE UMA GAVETA ---
    if (window.activeGavetaId) {
        // Mostra o bot√£o verde de Separador. Post e Gavet√£o somem.
        if (separatorBtn) separatorBtn.style.display = 'block';
        
        renderOpenedGavetaView(feed, currentArchiveData.posts || []);
        return; 
    }

    // --- CASO 2: ABA PRATELEIRA ---
    if (currentArchiveTab === 'prateleira') {
        if (postBtn) postBtn.style.display = 'block';

        feed.innerHTML = '';
        const posts = currentArchiveData?.posts || [];
        if (posts.length === 0) {
            feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Nenhum post criado.</div>';
            return;
        }
        posts.forEach(post => feed.appendChild(createPostElement(post)));
    } 
    // --- CASO 3: ABA GAVET√ÉO ---
    else if (currentArchiveTab === 'gavet√µes') {
        if (drawerBtn) drawerBtn.style.display = 'block';

        feed.innerHTML = '<div style="text-align:center; padding:20px;">A carregar gavet√µes...</div>';
        try {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId), orderBy('ordem', 'asc'));
            const drawerSnap = await getDocs(q);
            feed.innerHTML = '';
            if (drawerSnap.empty) {
                feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Nenhum gavet√£o criado.</div>';
            } else {
                for (const docSnap of drawerSnap.docs) {
                    const drawer = { id: docSnap.id, ...docSnap.data() };
                    feed.appendChild(await createGavetaoUI(drawer));
                }
            }
        } catch (e) { console.error(e); }
    }
}


window.toggleGavetaViewMode = async () => {
    if (!window.activeGavetaId || !window.activeGavetaData) return;

    // Alterna entre 'full' e 'titles' (se n√£o existir, o padr√£o √© 'titles')
    const currentMode = window.activeGavetaData.viewMode || 'titles';
    const newMode = currentMode === 'titles' ? 'full' : 'titles';
    
    try {
        // 1. Atualiza no Firebase para ficar guardado permanentemente
        await updateDoc(doc(db, 'gavetas', window.activeGavetaId), {
            viewMode: newMode
        });
        
        // 2. Atualiza os dados na mem√≥ria e redesenha a vista
        window.activeGavetaData.viewMode = newMode;
        renderArchiveFeed();
    } catch (e) {
        console.error("Erro ao mudar modo de vista:", e);
    }
};

// Fun√ß√£o para criar o elemento visual do Gavet√£o
async function createGavetaoUI(drawer) {
    const div = document.createElement('div');
    div.style.position = 'relative';
    div.style.marginBottom = '15px';

    // Geramos um ID limpo para o container
    const containerId = `gavetas-of-${drawer.id}`;

    div.innerHTML = `
        <button class="corner-close-btn" onclick="window.deleteGavetao('${drawer.id}')">x</button>
        <details class="drawer-toggle" open>
            <summary>
                <span>üìÇ ${drawer.nome}</span>
                <div class="drawer-controls" onclick="event.stopPropagation();">
                    <button class="mini-btn" onclick="window.moveGavetao('${drawer.id}', -1)">‚Üë</button>
                    <button class="mini-btn" onclick="window.moveGavetao('${drawer.id}', 1)">‚Üì</button>
                    <button class="mini-btn" onclick="window.openEditDrawerModal('${drawer.id}', '${drawer.nome}', '${drawer.descricao}')">‚úèÔ∏è</button>
                    <button class="mini-btn" onclick="event.preventDefault(); event.stopPropagation(); window.openCreateGavetaModal('${drawer.id}')"> + </button>
                </div>
            </summary>
            <div class="gavetas-container" id="${containerId}" style="padding: 10px 0; min-height:30px;">
                <div style="text-align:center; padding:20px; color:#888; font-size:0.9em;">
                   <div class="spinner" style="width:15px; height:15px; border-width:2px; display:inline-block; margin-right:10px;"></div>
                   A carregar pastas...
                </div>
            </div>
        </details>
    `;
    
    // O TRUQUE: Esperar um folego para o DOM processar o ID novo
    setTimeout(() => {
        window.loadGavetasInternas(drawer.id);
    }, 50);
    
    return div;
}

// Fun√ß√£o para carregar as pastas (gavetas) dentro do gavet√£o
window.loadGavetasInternas = async function(gavetaoId) {
    const container = document.getElementById(`gavetas-of-${gavetaoId}`);
    if (!container) {
        console.warn("‚ö†Ô∏è Container ainda n√£o encontrado para o Gavet√£o:", gavetaoId);
        return;
    }

    try {
        const q = query(
            collection(db, 'gavetas'), 
            where('gavetaoId', '==', gavetaoId), 
            orderBy('ordem', 'asc')
        );
        
        const snap = await getDocs(q);
        
        // S√≥ limpa o "A carregar" se a resposta do Firebase chegar
        container.innerHTML = ''; 

        if (snap.empty) {
            container.innerHTML = '<div style="text-align:center; color:#555; font-size:0.8em; padding:10px; font-style:italic;">Gavet√£o vazio.</div>';
            return;
        }

        snap.forEach(docSnap => {
            const gaveta = { id: docSnap.id, ...docSnap.data() };
            const gDiv = document.createElement('div');
            gDiv.className = 'gaveta-folder';
            
            gDiv.innerHTML = `
                <div class="gaveta-title-area" style="flex-grow:1; cursor:pointer;" onclick="window.openGaveta('${gaveta.id}')">
                    <span>üìÅ</span>
                    <span style="margin-left:8px;">${gaveta.nome}</span>
                </div>
                <div class="drawer-controls">
                    <button class="mini-btn" onclick="window.moveGaveta('${gaveta.id}', '${gavetaoId}', -1); event.stopPropagation();">‚Üë</button>
                    <button class="mini-btn" onclick="window.moveGaveta('${gaveta.id}', '${gavetaoId}', 1); event.stopPropagation();">‚Üì</button>
                    <button class="corner-close-btn" style="position:static; opacity:1; margin-left:10px;" onclick="window.deleteGaveta('${gaveta.id}'); event.stopPropagation();">x</button>
                </div>
            `;
            container.appendChild(gDiv);
        });
    } catch (e) {
        console.error("‚ùå Erro ao carregar gavetas:", e);
        container.innerHTML = '<div style="text-align:center; color:#e74c3c; font-size:0.8em;">Erro ao carregar dados.</div>';
    }
};

// 3. Criar Elemento HTML do Post
function createPostElement(post) {
    const div = document.createElement('div');
    div.className = 'archive-post';
    div.id = `post-${post.id}`;
    div.dataset.id = post.id;

    // Verifica se este post deve renderizar em modo edi√ß√£o ou visualiza√ß√£o
    // (Por defeito renderiza view, a menos que tenhamos acabado de criar)
    if (activeEditingPostId === post.id) {
        renderPostEditMode(div, post);
    } else {
        renderPostViewMode(div, post);
    }

    return div;
}



// 5. Renderizar Modo Edi√ß√£o
function renderPostEditMode(container, post) {
    const textToolbarHTML = `
        <div class="post-toolbar" style="margin-bottom:5px;">
            <button onclick="execCmdOnPost('bold')"><b>B</b></button>
            <button onclick="execCmdOnPost('italic')"><i>I</i></button>
            <button onclick="execCmdOnPost('underline')"><u>U</u></button>
        </div>
    `;

    const genericTitleInput = `<input type="text" class="post-title-input" value="${post.title || ''}" placeholder="T√≠tulo do Post..." style="margin-bottom:10px;">`;

    const isEntity = post.type === 'entity' && post.subType !== 'idea';
    const isContainerEditable = isEntity ? "false" : "true";
    const editorStyle = isEntity ? "border:none; background:transparent; padding:0;" : "";

   container.innerHTML = `
    <div class="post-edit-container">
        ${genericTitleInput}
        ${!isEntity ? textToolbarHTML : ''} 
        
        <div class="post-editor-content" contenteditable="${isContainerEditable}" id="editor-${post.id}" style="${editorStyle}">
            ${post.content}
        </div>
        
        <!-- CONTENTOR COM A NOVA CLASSE post-edit-actions -->
        <div class="post-edit-actions">
           <button class="modal-btn" style="background-color: var(--sidebar-color); color: var(--text-color);" 
        onclick="window.openGavetaSelection('${post.id}'); event.stopPropagation();">üìÅ Gaveta</button>
            
            <button class="modal-btn" style="background-color:#c0392b; color:white;" 
                    onclick="deleteArchivePost('${post.id}')">Eliminar</button>
            
            <button class="modal-btn secondary" 
                    onclick="cancelArchiveEdit('${post.id}')">Cancelar</button>
            
            <button class="modal-btn primary" 
                    onclick="saveArchivePost('${post.id}')">Salvar</button>
        </div>
    </div>
`;
    
    // P√ìS-PROCESSAMENTO (IGUAL)
    setTimeout(() => {
        const editorDiv = container.querySelector('.post-editor-content');
        const titleInput = container.querySelector('.post-title-input');

        const startAutoSaveTimer = () => {
            const statusEl = document.getElementById('archive-save-status');
            if(statusEl) statusEl.textContent = "por guardar...";
            currentSaveStatus = 'unsaved'; 
            clearTimeout(archiveAutoSaveTimer);
            archiveAutoSaveTimer = setTimeout(() => { saveCurrentPostInBackground(); }, 180000);
        };

        if (editorDiv) editorDiv.addEventListener('input', startAutoSaveTimer);
        if (titleInput) titleInput.addEventListener('input', startAutoSaveTimer);

        if (isEntity) {
            const toolbar = editorDiv.querySelector('.mini-note-toolbar');
            if (toolbar) toolbar.setAttribute('contenteditable', 'false');
            const innerContent = editorDiv.querySelector('.mini-note-content, .toggle-content');
            if (innerContent) innerContent.setAttribute('contenteditable', 'true');
            const internalInput = editorDiv.querySelector('.mini-note-title-input');
            if (internalInput) {
                internalInput.removeAttribute('readonly');
                if(!internalInput.value) internalInput.focus();
                internalInput.addEventListener('input', startAutoSaveTimer);
            }
       if (!post.title && titleInput) {
                titleInput.focus();
            } else if (editorDiv) {
                editorDiv.focus();
            }
        }
    }, 50);
}

// --- A√á√ïES DO ARQUIVO ---

// A. Bot√£o "Criar Post" Principal
document.getElementById('create-post-btn').addEventListener('click', async () => {
    if (activeEditingPostId) {
        await saveArchivePost(activeEditingPostId);
    }
    document.getElementById('post-type-popup').style.display = 'flex';
});

// B. Escolha: Gerar Texto
document.getElementById('gen-text-btn').addEventListener('click', () => {
    document.getElementById('post-type-popup').style.display = 'none';
    createNewPost('text');
});

// C. Escolha: Gerar Entidade (Abre submenu)
document.getElementById('gen-entity-btn').addEventListener('click', () => {
    document.getElementById('post-type-popup').style.display = 'none';
    document.getElementById('entity-type-popup').style.display = 'flex';
});

// D. Criar a Entidade Espec√≠fica
window.createArchiveEntity = (subType) => {
    document.getElementById('entity-type-popup').style.display = 'none';
    createNewPost('entity', subType);
};

// L√≥gica de Cria√ß√£o de Post Novo
async function createNewPost(type, subType = null) {
    if (!currentArchiveData) return;
    if (!currentArchiveData.posts) currentArchiveData.posts = [];

    const newId = 'post_' + Date.now();
    let initialContent = '';
    let initialTitle = '';
    
    // Obt√©m o nome e ID do autor
    const authorName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
    const myUid = auth.currentUser.uid;

    const commonToolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Apagar Caixa">üóëÔ∏è</button>
        </div>
    `;

    if (type === 'text') {
        initialTitle = ''; 
        initialContent = '<p><br></p>';
    } 
    else if (type === 'entity') {
        if (subType === 'question') {
            initialContent = `
                <div class="mini-note-wrapper question-mode" data-topics="{}" data-shared="false" data-box-links="{}" contenteditable="false">
                    <textarea class="mini-note-title-input" placeholder="Pergunta?" rows="1"></textarea>
                    ${commonToolbarHTML}
                    <div class="mini-note-content" contenteditable="true"><p><br></p></div>
                </div>`;
            initialTitle = 'Nova Quest√£o';
        } else if (subType === 'toggle') {
            initialContent = `
                <details class="toggle-section" open>
                    <summary>
                        <h2>T√≠tulo Expans√≠vel</h2>
                        <button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content" contenteditable="true"><p><br></p></div>
                </details>`;
            initialTitle = 'Novo T√≠tulo Toggle';
        } else if (subType === 'idea') {
             initialContent = `<div style="padding:10px;"><span class="idea-span" spellcheck="false">Nova Ideia</span></div>`;
             initialTitle = 'Ideia';
        } else {
            const isFree = subType === 'free';
            const cls = isFree ? 'mini-note-wrapper free-mode' : 'mini-note-wrapper';
            const titleHTML = isFree ? '' : `<textarea class="mini-note-title-input" placeholder="T√≠tulo..." rows="1"></textarea>`;
            initialContent = `
                <div class="${cls}" data-topics="{}" data-shared="false" data-box-links="{}" contenteditable="false">
                    ${titleHTML}
                    ${commonToolbarHTML}
                    <div class="mini-note-content" contenteditable="true"><p><br></p></div>
                </div>`;
            initialTitle = isFree ? 'Novo Contentor' : 'Nova Subnota';
        }
    }

    const newPost = {
        id: newId,
        type: type,
        subType: subType, 
        title: initialTitle,
        content: initialContent,
        
        // >>> CORRE√á√ÉO CR√çTICA AQUI <<<
        userId: myUid, // Grava explicitamente o SEU ID
        createdBy: authorName,
        
        createdAt: Date.now(),
        updatedAt: Date.now()
    };

    currentArchiveData.posts.unshift(newPost);
    activeEditingPostId = newId;
    
    renderArchiveFeed();
    
    const feedContainer = document.getElementById('archive-feed');
    if (feedContainer) feedContainer.scrollTop = 0;

    await saveFullArchive();
}

// E. Editar Post
window.editArchivePost = async (postId) => {
    console.log("üîí [LOCK] A tentar bloquear post existente:", postId);

    // 1. Verifica se j√° est√° bloqueado por outro (Seguran√ßa Local)
    if (currentLocks[postId] && currentLocks[postId].userId !== auth.currentUser.uid) {
        alert(`Este post est√° a ser editado por ${currentLocks[postId].userName}.`);
        return;
    }

    // 2. Tenta obter o bloqueio no Firebase (Seguran√ßa Remota)
    const locked = await lockPost(postId);
    if (!locked) {
        alert("N√£o foi poss√≠vel editar este post. Algu√©m pode ter sido mais r√°pido.");
        return;
    }

    // 3. Se j√° estivesse a editar outro, guarda-o
    if (activeEditingPostId && activeEditingPostId !== postId) {
        await saveArchivePost(activeEditingPostId);
    }

    // 4. Ativa modo edi√ß√£o
    activeEditingPostId = postId;
    const postDiv = document.getElementById(`post-${postId}`);
    const postData = currentArchiveData.posts.find(p => p.id === postId);
    
    if (postDiv && postData) {
        renderPostEditMode(postDiv, postData);
    }
};

// F. Salvar Post (Fecha edi√ß√£o)
window.saveArchivePost = async (postId) => {
    console.log(`üíæ [SAVE] Processando: ${postId}`);
    
    // For√ßa a limpeza do estado de edi√ß√£o global
    activeEditingPostId = null;
    window.activeEditingPostId = null;

    const postDiv = document.getElementById(`post-${postId}`);
    
    // Se o post n√£o estiver no DOM, n√£o podemos ler o texto, mas DEVEMOS desbloquear
    if (!postDiv) {
        console.warn(`"‚ö†Ô∏è [SAVE] Post ${postId} j√° n√£o est√° no DOM. Apenas libertando bloqueio.`);
        await unlockPost(postId);
        return;
    }

    const titleInputGeneric = postDiv.querySelector('.post-title-input');
    const contentEditor = postDiv.querySelector('.post-editor-content');

    if (contentEditor && titleInputGeneric) {
        const postIndex = currentArchiveData.posts.findIndex(p => p.id === postId);
        if (postIndex > -1) {
            // Sincroniza√ß√£o de inputs internos
            contentEditor.querySelectorAll('.mini-note-title-input').forEach(t => {
                if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                else t.setAttribute('value', t.value);
            });

            const finalTitle = titleInputGeneric.value.trim() || "Sem T√≠tulo";
            
            // ATUALIZA√á√ÉO DOS DADOS NA MEM√ìRIA
            currentArchiveData.posts[postIndex].title = finalTitle;
            currentArchiveData.posts[postIndex].content = contentEditor.innerHTML;
            currentArchiveData.posts[postIndex].updatedAt = Date.now();
            
            // >>> NOVA LINHA CR√çTICA: GRAVA QUEM EDITOU <<<
            currentArchiveData.posts[postIndex].lastEditorId = auth.currentUser.uid;
            
            console.log(`üìù [DADOS] T√≠tulo guardado: "${finalTitle}"`);
        }
    }

    // Fecha visualmente o modo edi√ß√£o (volta ao modo leitura)
    const postData = currentArchiveData.posts.find(p => p.id === postId);
    if (postData) renderPostViewMode(postDiv, postData);

    // Grava tudo no Firebase e remove o cadeado
    await saveFullArchive();
    await unlockPost(postId);
    console.log(`üîì [LOCK] Post ${postId} totalmente libertado.`);
};



// G. Apagar Post
window.deleteArchivePost = async (postId) => {
    if (!confirm("Tem a certeza que deseja apagar este post? (Ficar√° no Hist√≥rico)")) return;

    const postToDelete = currentArchiveData.posts.find(p => p.id === postId);
    if (postToDelete) {
        if (!currentArchiveData.deletedPosts) currentArchiveData.deletedPosts = [];
        currentArchiveData.deletedPosts.unshift({
            ...postToDelete,
            deletedAt: Date.now(),
            deleteReason: 'Post Eliminado'
        });
    }

    currentArchiveData.posts = currentArchiveData.posts.filter(p => p.id !== postId);
    activeEditingPostId = null;
    
    const div = document.getElementById(`post-${postId}`);
    if(div) div.remove();

    await saveFullArchive();
};

// H. Cancelar Edi√ß√£o (Reverter)
window.cancelArchiveEdit = async (postId) => {
    const postDiv = document.getElementById(`post-${postId}`);
    if (!postDiv) return;

    // 1. Para o temporizador de grava√ß√£o autom√°tica
    clearTimeout(archiveAutoSaveTimer);

    // 2. Reseta o estado global de edi√ß√£o
    activeEditingPostId = null;
    currentSaveStatus = 'saved'; 
    
    // 3. Atualiza o status visual no topo
    const statusEl = document.getElementById('archive-save-status');
    if(statusEl) {
        statusEl.textContent = "Edi√ß√£o cancelada";
        setTimeout(() => { 
            if(statusEl.textContent === "Edi√ß√£o cancelada") statusEl.textContent = "Guardado"; 
        }, 2000);
    }

    // 4. Restaura o visual do post
    const originalPost = currentArchiveData.posts.find(p => p.id === postId);
    
    if (originalPost) {
        // Se o post j√° existia, volta a mostrar a vers√£o que est√° na mem√≥ria
        renderPostViewMode(postDiv, originalPost);
    } else {
        // Se era um post NOVO (que nunca foi salvo), removemos o elemento do ecr√£
        postDiv.remove();
        currentArchiveData.posts = currentArchiveData.posts.filter(p => p.id !== postId);
    }

    // 5. O PASSO MAIS IMPORTANTE: Remover o bloqueio no Firebase
    await unlockPost(postId);
    
    console.log(`üîì [SISTEMA] Post ${postId} foi desbloqueado (Cancelado).`);
};

// I. Fun√ß√£o Auxiliar de Comandos (Executa no editor ativo)
window.execCmdOnPost = (command) => {
    if(command === 'boldBlue') {
        document.execCommand('bold', false, null);
        document.execCommand('foreColor', false, '#4a90e2');
    } else {
        document.execCommand(command, false, null);
    }
};

// J. Grava√ß√£o Geral no Firestore
async function saveFullArchive() {
    const statusEl = document.getElementById('archive-save-status');
    if (statusEl) statusEl.textContent = "A guardar...";
    
    try {
        const docRef = doc(db, 'pastas', currentArchiveId);
        
        const updateData = {
            posts: currentArchiveData.posts || [],
            deletedPosts: currentArchiveData.deletedPosts || [], 
            ultimaedicao: serverTimestamp(),
            
            // === CORRE√á√ÉO AQUI ===
            // Grava o SEU ID na pasta principal.
            // Assim, a lista sabe que foi voc√™ e n√£o mostra a bola vermelha.
            lastEditorId: auth.currentUser.uid 
            // =====================
        };

        await updateDoc(docRef, updateData);
        
        // Atualiza a mem√≥ria local para o snapshot n√£o nos enganar
        if (currentArchiveData) {
            currentArchiveData.lastEditorId = auth.currentUser.uid;
        }

        if (statusEl) {
            statusEl.textContent = "Guardado";
            statusEl.classList.add('status-saved');
            setTimeout(() => statusEl.classList.remove('status-saved'), 2000);
        }
    } catch (e) {
        console.error("Erro ao gravar arquivo:", e);
        if (statusEl) {
            statusEl.textContent = "Erro ao guardar";
            statusEl.classList.add('status-error');
        }
    }
};

// K. Mover Post (Cima/Baixo)
window.moveArchivePost = async (postId, direction) => {
    // direction: -1 (Cima/Recente), 1 (Baixo/Antigo)
    
    const index = currentArchiveData.posts.findIndex(p => p.id === postId);
    if (index === -1) return;

    // Verifica limites
    if (direction === -1 && index === 0) return; // J√° est√° no topo
    if (direction === 1 && index === currentArchiveData.posts.length - 1) return; // J√° est√° no fundo

    const targetIndex = index + direction;

    // Troca no array
    const temp = currentArchiveData.posts[index];
    currentArchiveData.posts[index] = currentArchiveData.posts[targetIndex];
    currentArchiveData.posts[targetIndex] = temp;

    // Atualiza Visual
    renderArchiveFeed();
    
    // Anima√ß√£o/Scroll para acompanhar o post movido
    const movedElement = document.getElementById(`post-${postId}`);
    if (movedElement) {
        movedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Feedback visual tempor√°rio
        movedElement.style.borderColor = 'var(--accent-color)';
        setTimeout(() => movedElement.style.borderColor = 'var(--border-color)', 500);
    }

    // Grava a nova ordem
    await saveFullArchive();
};

// ============================================================
// LISTENER DA TOOLBAR DO ARQUIVO (üîì üìë üïí)
// ============================================================
document.getElementById('archive-toolbar').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    if (action === 'archive-share') {
        e.stopPropagation(); // ‚úã PARA TUDO! N√£o deixa o clique sair daqui
        window.openShareModalForArchive();
    }
    else if (action === 'archive-topics') {
        e.stopPropagation(); 
        openTopicsModal(selectedNoteId, 'arquivo');
    }
    else if (action === 'archive-history') {
        e.stopPropagation(); 
        openArchiveRecycleBin();
    }
});

// Fun√ß√£o Auxiliar para abrir Partilha (C√≥pia adaptada da Nota)
async function openShareModalForArchive() {
    if (!selectedNoteId) return;

    const modal = document.getElementById('note-share-popup');
    if (!modal) return console.error("Modal #note-share-popup n√£o encontrado!");

    // 1. FOR√áA HIERARQUIA (Move para o body e define Z-Index alto)
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8500000"; // Acima do editor e abas
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    try {
        const docRef = doc(db, 'pastas', selectedNoteId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            // Carrega defini√ß√µes existentes ou inicia padr√£o
            currentNoteShareData = data.shareSettings || { shared: false, shareId: null };
            
            // 2. CONFIGURA O TOGGLE DE LEITURA
            const mainToggle = document.getElementById('note-share-toggle');
            mainToggle.checked = currentNoteShareData.shared;

            const linkContainer = document.getElementById('note-share-link-container');
            if (currentNoteShareData.shared) {
                linkContainer.style.display = 'block';
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                const shareId = currentNoteShareData.shareId || selectedNoteId;
                document.getElementById('note-share-url').value = `${baseUrl}/sharenote.html?id=${shareId}`;
            } else {
                linkContainer.style.display = 'none';
            }

            // 3. CONFIGURA SEC√á√ÉO DE COLABORA√á√ÉO (Apenas para Arquivos)
            const collabSection = document.getElementById('archive-collab-section');
            if ((data.tipo === 'arquivo' || data.tipo === 'partilhado') && currentViewMode === 'shared') {
                collabSection.style.display = 'block';
                const collabToggle = document.getElementById('collab-share-toggle');
                collabToggle.checked = (data.partilhado === "ativo");
                
                const collabLinkContainer = document.getElementById('collab-share-link-container');
                if (data.partilhado === "ativo") {
                    collabLinkContainer.style.display = 'block';
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                    document.getElementById('collab-share-url').value = `${baseUrl}/note.html?openArchive=${selectedNoteId}&mode=collab`;
                } else {
                    collabLinkContainer.style.display = 'none';
                }
            } else {
                collabSection.style.display = 'none';
            }
        }
    } catch (err) {
        console.error("Erro ao carregar dados de partilha:", err);
    }
}

// --- ADICIONE ESTE LISTENER NO FINAL DO SCRIPT (Para o novo Toggle de Colabora√ß√£o) ---

const collabShareToggle = document.getElementById('collab-share-toggle');
if (collabShareToggle) {
    collabShareToggle.addEventListener('change', async () => {
        if (!selectedNoteId || !auth.currentUser) return;

        const isCollabActive = collabShareToggle.checked;
        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        try {
            const updateData = {
                "partilhado": isCollabActive ? "ativo" : "inativo",
                "ultimaedicao": serverTimestamp()
            };

            await updateDoc(noteRef, updateData);

            // Atualiza a interface
            const collabLinkContainer = document.getElementById('collab-share-link-container');
            collabLinkContainer.style.display = isCollabActive ? 'block' : 'none';
            
            if (isCollabActive) {
                const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                document.getElementById('collab-share-url').value = `${baseUrl}/note.html?openArchive=${selectedNoteId}&mode=collab`;
            }
        } catch (e) {
            console.error("‚ùå Erro ao atualizar colabora√ß√£o:", e);
        }
    });
}

// ============================================================
// DELEGA√á√ÉO DE EVENTOS PARA O ARQUIVO (Para bot√µes funcionarem)
// ============================================================
const archiveFeed = document.getElementById('archive-feed');

if (archiveFeed) {
    archiveFeed.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        const toggleColorBtn = e.target.closest('.toggle-color-btn');

        // --- 1. Bot√£o de Cor (üé®) ---
        if (btn && btn.dataset.action === 'highlight-color') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
            if (wrapper) openHighlightPopup(wrapper);
            return;
        }

        // --- 2. Bot√£o de T√≥picos (üìã) ---
        if (btn && btn.dataset.action === 'manage-mini-note-topics') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openTopicsModalForMiniNote(wrapper);
            return;
        }

        // --- 3. Bot√£o de Links (‚ö°) ---
        if (btn && btn.dataset.action === 'manage-box-links') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
            if (wrapper) openBoxLinkManager(wrapper);
            return;
        }

        // --- 4. Bot√£o de Cor do Toggle (üñåÔ∏è) ---
        if (toggleColorBtn) {
            e.preventDefault(); e.stopPropagation();
            activeToggleForColor = toggleColorBtn.closest('details.toggle-section');
            const rect = toggleColorBtn.getBoundingClientRect();
            const popup = document.getElementById('toggle-color-popup');
            popup.style.display = 'block';
            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popup.style.left = `${(rect.left + window.scrollX) - 100}px`;
            return;
        }

        // --- 5. Bot√£o Enviar para Nota (üß¨) ---
        if (btn && btn.dataset.action === 'append-mini-note') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
            if (wrapper) {
                htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
                openAppendModal();
            }
            return;
        }
        
        // --- 6. ELIMINAR ENTIDADE (üóëÔ∏è) -> IGUAL A ELIMINAR POST ---
        if (btn && btn.dataset.action === 'delete-mini-note') {
            e.preventDefault(); 
            e.stopImmediatePropagation(); 
            
            // 1. LIMPEZA DE CONFLITOS (CR√çTICO)
            // Cancela imediatamente qualquer temporizador de grava√ß√£o pendente.
            // Isto impede que uma grava√ß√£o autom√°tica atropele a elimina√ß√£o.
            if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);
            if (typeof archiveAutoSaveTimer !== 'undefined') clearTimeout(archiveAutoSaveTimer);
            
            const selection = window.getSelection();
            if (selection) selection.removeAllRanges();

            const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
            if (!wrapper) return;

            if (noteContentEditor.contentEditable === "false" || wrapper.classList.contains('locked-card')) {
                alert("N√£o tem permiss√£o para apagar este item.");
                return;
            }

            let label = "Item";
            if (wrapper.classList.contains('redator-wrapper')) label = "Redator";
            else if (wrapper.classList.contains('question-mode')) label = "Quest√£o";
            else label = "SubNota";

            // 2. FEEDBACK VISUAL IMEDIATO (Sem chamar o save real)
            // Dizemos ao utilizador "A guardar..." para ele saber que o processo come√ßou,
            // mas a grava√ß√£o real s√≥ acontece DENTRO do archiveMiniNote, atomicamente.
            if (typeof updateSaveStatus === 'function') updateSaveStatus('saving');
            const statusEl = document.getElementById('save-status-indicator');
            if (statusEl) {
                statusEl.textContent = "A processar...";
                statusEl.classList.remove('status-saved', 'status-error');
            }

            // 3. POPUP DE CONFIRMA√á√ÉO
            const confirmModal = document.getElementById('confirm-modal');
            if(confirmModal) confirmModal.style.zIndex = "9999999";

            const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar este ${label}?`);
            
            if(confirmModal) confirmModal.style.zIndex = ""; 

            if (!confirmed) {
                // Se cancelou, volta a agendar a grava√ß√£o normal para n√£o perder dados pendentes
                if (typeof saveNote === 'function') saveNote();
                return;
            }

            // 4. EXECU√á√ÉO SEGURA
            // Esta fun√ß√£o j√° trata de gravar a nota ATUALIZADA e o backup ao mesmo tempo.
            await archiveMiniNote(wrapper);
            return;
        }
    });
}

// ============================================================
// GEST√ÉO DA RECICLAGEM DO ARQUIVO
// ============================================================

window.openArchiveRecycleBin = function() {
    console.log("üïí [SISTEMA] A abrir Painel Hist√≥rico do Arquivo...");
    
    const modal = document.getElementById('history-modal');
    const titleEl = document.getElementById('history-modal-title');
    
    // Elementos das abas
    const backupDiv = document.getElementById('hist-content-backup');
    const recycleDiv = document.getElementById('hist-content-recycling');
    const backupList = document.getElementById('history-list-backups');
    const recycleList = document.getElementById('history-list-recycling');
    const backupBtn = document.getElementById('backup-now-btn');

    if (!modal) return;

    // 1. VISUALIZA√á√ÉO
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999"; 
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    if (titleEl) titleEl.textContent = "Arquivo: Hist√≥rico & Reciclagem";

    // 2. CONFIGURAR ABAS (Mostra Backup e Reciclagem, Esconde Timeline)
    document.querySelectorAll('.hist-tab-div').forEach(div => div.style.display = 'none');
    
    // Simula clique na aba Backup para come√ßar l√°
    const tabBackup = document.querySelector('button[data-hist-tab="backup"]');
    if(tabBackup) tabBackup.click();

    // 3. ABA BACKUP: Configurar Bot√£o e Lista
    if (backupBtn) {
        backupBtn.style.display = 'block'; // AGORA APARECE
        backupBtn.textContent = "Criar Ponto de Restauro do Arquivo";
        
        // L√≥gica de Backup do Arquivo (Diferente da Nota)
        backupBtn.onclick = async () => {
            backupBtn.disabled = true;
            backupBtn.textContent = "A gravar estado atual...";
            try {
                const backupsRef = collection(db, 'pastas', currentArchiveId, 'backups');
                await addDoc(backupsRef, {
                    titulo: currentArchiveData.nome,
                    posts: currentArchiveData.posts, // Guarda o array de posts
                    timestamp: serverTimestamp(),
                    isArchiveBackup: true
                });
                alert("Backup do Arquivo criado com sucesso!");
            } catch (e) {
                console.error(e);
                alert("Erro ao criar backup.");
            } finally {
                backupBtn.disabled = false;
                backupBtn.textContent = "Criar Ponto de Restauro do Arquivo";
            }
        };
    }

    // 4. ABA RECICLAGEM: Carregar Posts Eliminados E Caixas Ocultas
    recycleList.innerHTML = '<div class="spinner"></div>';
    
    // A. Posts Eliminados (Do array local)
    const deletedPosts = currentArchiveData.deletedPosts || [];
    
    // B. Caixas Ocultas (Do campo subnotasocultas do documento)
    // Precisamos buscar isto ao Firebase porque pode n√£o estar no objeto local
    (async () => {
        let hiddenBoxes = {};
        try {
            const docSnap = await getDoc(doc(db, 'pastas', currentArchiveId));
            if(docSnap.exists()) {
                hiddenBoxes = docSnap.data().subnotasocultas || {};
            }
        } catch(e) { console.error("Erro ao ler caixas ocultas", e); }

        recycleList.innerHTML = '';
        let hasItems = false;

        // RENDERIZAR POSTS ELIMINADOS
        if (deletedPosts.length > 0) {
            recycleList.innerHTML += `<li style="background:#444; color:white; padding:5px 10px; font-size:0.8em; font-weight:bold;">POSTS INTEIROS (${deletedPosts.length})</li>`;
            deletedPosts.forEach((item, index) => {
                const dateStr = new Date(item.deletedAt).toLocaleString();
                recycleList.innerHTML += `
                    <li class="list-item" style="flex-direction:column; align-items:flex-start; border-bottom:1px solid #333; padding:10px;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <strong>üóëÔ∏è ${item.title || 'Post Sem T√≠tulo'}</strong>
                            <button class="modal-btn primary" onclick="window.restoreArchiveItem(${index})" style="padding:2px 8px; font-size:0.8em;">Restaurar</button>
                        </div>
                        <small style="color:#888;">${dateStr}</small>
                    </li>`;
            });
            hasItems = true;
        }

        // RENDERIZAR CAIXAS OCULTAS
        const boxesArray = Object.values(hiddenBoxes);
        if (boxesArray.length > 0) {
            recycleList.innerHTML += `<li style="background:#444; color:white; padding:5px 10px; font-size:0.8em; font-weight:bold; margin-top:10px;">CAIXAS / ITENS (${boxesArray.length})</li>`;
            boxesArray.sort((a,b) => (b.deletedAt?.seconds || 0) - (a.deletedAt?.seconds || 0)).forEach(item => {
                recycleList.innerHTML += `
                    <li class="list-item" style="justify-content:space-between; padding:10px; border-bottom:1px solid #333;">
                        <span>üì¶ ${item.titulo || 'Caixa'}</span>
                        <button class="modal-btn primary" onclick="window.restoreHiddenBoxToArchive('${item.id}')" style="padding:2px 8px; font-size:0.8em;">Restaurar</button>
                    </li>`;
            });
            hasItems = true;
        }

        if (!hasItems) {
            recycleList.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">Reciclagem vazia.</li>';
        }
    })();
};


// Fun√ß√£o para Restaurar Item
window.restoreArchiveItem = async (index) => {
    // 1. Organiza a lixeira para garantir que o √≠ndice est√° correto
    const deletedItems = currentArchiveData.deletedPosts.sort((a, b) => b.deletedAt - a.deletedAt);
    const itemToRestore = deletedItems[index];

    if (!itemToRestore) return;

    if (confirm(`Deseja restaurar "${itemToRestore.title}" para o topo do feed?`)) {
        
        // 2. Remove da lista de eliminados (mem√≥ria local)
        const realIndex = currentArchiveData.deletedPosts.indexOf(itemToRestore);
        if (realIndex > -1) {
            currentArchiveData.deletedPosts.splice(realIndex, 1);
        }

        // 3. Limpa os dados de elimina√ß√£o e prepara o post
        const restoredPost = { ...itemToRestore };
        delete restoredPost.deletedAt;
        delete restoredPost.deleteReason;
        
        // Define a data de atualiza√ß√£o como "agora" para ele subir no feed
        restoredPost.updatedAt = Date.now();

        // 4. Insere no in√≠cio do feed ativo (mem√≥ria local)
        if (!currentArchiveData.posts) currentArchiveData.posts = [];
        currentArchiveData.posts.unshift(restoredPost);

        // 5. Fecha o modal de hist√≥rico
        document.getElementById('history-modal').style.display = 'none';

        // 6. Atualiza a interface visualmente
        renderArchiveFeed();
        
        // 7. GRAVA√á√ÉO NO FIREBASE
        // Primeiro salvamos o estado do arquivo
        await saveFullArchive();
        
        // GARANTIA: Removemos qualquer bloqueio (lock) que pudesse existir para este ID
        // Assim o post volta totalmente livre para qualquer um clicar em "Editar"
        await unlockPost(itemToRestore.id);

        console.log(`‚ôªÔ∏è Post ${itemToRestore.id} restaurado e desbloqueado.`);
        
        // Feedback visual: faz scroll at√© ao post restaurado (que agora est√° no topo)
        document.getElementById('archive-feed').scrollTop = 0;
    }
};

// Listener para Grava√ß√£o Manual no Status do Arquivo
const archiveStatus = document.getElementById('archive-save-status');
if (archiveStatus) {
    archiveStatus.addEventListener('click', () => {
        if (activeEditingPostId) {
            saveCurrentPostInBackground();
        }
    });
}


// Listener para Gravar T√≠tulo do Arquivo (Renomear)
const archiveTitleInput = document.getElementById('archive-title-input');
if (archiveTitleInput) {
    let titleTimer = null;
    
    archiveTitleInput.addEventListener('input', () => {
        // Mostra estado visual
        const statusEl = document.getElementById('archive-save-status');
        if(statusEl) statusEl.textContent = "por guardar...";
        currentSaveStatus = 'unsaved';

        // Debounce para n√£o gravar a cada tecla
        clearTimeout(titleTimer);
        titleTimer = setTimeout(async () => {
            const newName = archiveTitleInput.value.trim();
            if (newName && currentArchiveId) {
                try {
                    const docRef = doc(db, 'pastas', currentArchiveId);
                    await updateDoc(docRef, { 
                        nome: newName,
                        ultimaedicao: serverTimestamp()
                    });
                    
                    // Atualiza visualmente na lista lateral se poss√≠vel
                    const listItem = document.querySelector(`.list-item[data-id="${currentArchiveId}"] span`);
                    if (listItem) {
                        // Mant√©m o √≠cone e atualiza o texto
                        const icon = listItem.textContent.split(' ')[0]; 
                        listItem.textContent = `${icon} ${newName}`;
                    }

                    if(statusEl) {
                        statusEl.textContent = "Guardado";
                        statusEl.classList.add('status-saved');
                        setTimeout(() => statusEl.classList.remove('status-saved'), 2000);
                    }
                    currentSaveStatus = 'saved';
                } catch (e) {
                    console.error("Erro ao renomear arquivo:", e);
                }
            }
        }, 1000); // Grava 1 segundo depois de parar de escrever
    });
}

// ============================================================
// MOTOR DE COLABORA√á√ÉO REAL-TIME
// ============================================================

// 1. Ouvir mudan√ßas no documento (Locks e Conte√∫do)
function initRealtimeCollab(docId) {
    const docRef = doc(db, 'pastas', docId);

    collabUnsubscribe = onSnapshot(docRef, (docSnap) => {
        if (!docSnap.exists()) return;

        const newData = docSnap.data();
        currentLocks = newData.locks || {};
        applyVisualLocks();

        // --- REAVALIA√á√ÉO DE SEGURAN√áA DO CADEADO EM TEMPO REAL ---
        const shareBtn = document.querySelector('button[data-action="archive-share"]');
        if (shareBtn) {
            const isOwner = newData.userId === auth.currentUser.uid;
            const isSharedType = (newData.tipo === 'partilhado');
            
            if (isSharedType && !isOwner) {
                shareBtn.style.display = 'none';
            } else {
                shareBtn.style.display = 'block';
            }
        }
        // -------------------------------------------------------

        if (!activeEditingPostId) {
            currentArchiveData.posts = newData.posts;
            renderArchiveFeed();
            applyVisualLocks();
        }
    });
}

// 2. Sistema de Presen√ßa (Heartbeat)
async function initPresenceSystem(docId) {
    if (!auth.currentUser || !docId) return;

    const userId = auth.currentUser.uid;
    const userName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
    
    // Refer√™ncia para o meu estado dentro deste Arquivo espec√≠fico
    const myPresenceRef = doc(db, 'pastas', docId, 'collaborators', userId);

    // 1. FUN√á√ÉO HEARTBEAT: Avisa o Firebase que eu estou aqui
    const sendHeartbeat = async () => {
        try {
            await setDoc(myPresenceRef, {
                name: userName,
                lastSeen: serverTimestamp(),
                activeIn: docId // Garante o v√≠nculo com este arquivo
            }, { merge: true });
        } catch (e) {
            console.warn("Erro ao enviar batimento de presen√ßa:", e);
        }
    };

    // Envia o primeiro sinal mal entra
    await sendHeartbeat();

    // Configura o batimento para cada 45 segundos (mais frequente para ser mais preciso)
    if (presenceInterval) clearInterval(presenceInterval);
    presenceInterval = setInterval(sendHeartbeat, 45000);

    // 2. OUVIR COLABORADORES: Quem mais est√° a ver este ficheiro agora?
    const colRef = collection(db, 'pastas', docId, 'collaborators');
    
    collabUnsubscribe = onSnapshot(colRef, (snapshot) => {
        const listDiv = document.getElementById('active-users-list');
        const barDiv = document.getElementById('collab-bar');
        
        if (!listDiv || !barDiv) return;
        
        listDiv.innerHTML = '';
        const now = Date.now();
        let otherUsersCount = 0;

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const isMe = (docSnap.id === userId);
            
            // Calcula h√° quanto tempo o utilizador foi visto
            // (Usa Date.now() como fallback enquanto o timestamp do servidor n√£o chega)
            const lastSeenTime = data.lastSeen ? data.lastSeen.toMillis() : now;
            
            // REGRA: S√≥ conta como "Online" se foi visto nos √∫ltimos 90 segundos
            const isOnline = (now - lastSeenTime < 90000);

            if (isOnline) {
                // Se for outra pessoa, incrementamos o contador
                if (!isMe) otherUsersCount++;

                // Criar o c√≠rculo visual (Bubble)
                const bubble = document.createElement('div');
                bubble.className = 'user-presence-bubble';
                bubble.textContent = data.name.charAt(0).toUpperCase();
                bubble.title = data.name + (isMe ? " (Voc√™)" : "");
                
                // Estilos din√¢micos
                if (isMe) {
                    bubble.style.backgroundColor = "var(--sidebar-color)";
                    bubble.style.border = "2px solid var(--accent-color)";
                    bubble.style.color = "var(--accent-color)";
                } else {
                    // Fun√ß√£o stringToColor gera uma cor √∫nica baseada no nome
                    bubble.style.backgroundColor = stringToColor(data.name);
                    bubble.style.color = "white";
                }
                
                listDiv.appendChild(bubble);
            }
        });

        // REGRAS DE VISIBILIDADE DA BARRA:
        // A barra (Online: [A][B]) s√≥ aparece se houver PELO MENOS uma pessoa al√©m de mim.
        if (otherUsersCount > 0) {
            barDiv.style.display = 'flex';
        } else {
            barDiv.style.display = 'none';
        }

    }, (error) => {
        console.error("Erro ao monitorizar presen√ßa:", error);
    });
}

// 3. Aplicar Bloqueios Visuais (CSS)
function applyVisualLocks() {
    const myUserId = auth.currentUser.uid;

    // 1. LIMPEZA: Remove bloqueios de todos os posts primeiro
    document.querySelectorAll('.archive-post').forEach(postDiv => {
        postDiv.classList.remove('is-locked');
        postDiv.style.opacity = "1";
        postDiv.style.pointerEvents = "auto";
        const badge = postDiv.querySelector('.locked-badge');
        if (badge) badge.remove();
        
        const editBtn = postDiv.querySelector('.post-edit-btn');
        if (editBtn) {
            editBtn.disabled = false;
            editBtn.style.display = "flex";
        }
    });

    // 2. APLICA√á√ÉO: Percorre a lista de locks do Firebase
    if (!currentLocks) return;

    Object.entries(currentLocks).forEach(([postId, lockData]) => {
        // S√≥ aplica se o lock N√ÉO for meu
        if (lockData.userId !== myUserId) {
            
            // Procura o elemento no HTML
            const postDiv = document.getElementById(`post-${postId}`);
            
            if (postDiv) {
                postDiv.classList.add('is-locked');
                postDiv.style.opacity = "0.5";
                postDiv.style.pointerEvents = "none";

                // Badge vermelha
                if (!postDiv.querySelector('.locked-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'locked-badge';
                    badge.innerHTML = `üîí ${lockData.userName} est√° a editar...`;
                    badge.style.cssText = "position:absolute; top:-10px; right:10px; background:#e74c3c; color:white; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:bold; z-index:100; box-shadow:0 2px 5px rgba(0,0,0,0.3);";
                    postDiv.appendChild(badge);
                }

                const editBtn = postDiv.querySelector('.post-edit-btn');
                if (editBtn) editBtn.style.display = "none";
            }
        }
    });
}

// 4. Bloquear Post (Chamar ao clicar em Editar)
async function lockPost(postId) {
    if (!currentArchiveId) {
        console.error("‚ùå Erro: ID do Arquivo n√£o encontrado para bloquear.");
        return false;
    }

    const docRef = doc(db, 'pastas', currentArchiveId);
    const myName = currentUserData?.nome || auth.currentUser.email.split('@')[0];

    try {
        // Grava no campo 'locks' do documento pai
        await updateDoc(docRef, {
            [`locks.${postId}`]: {
                userId: auth.currentUser.uid,
                userName: myName,
                timestamp: Date.now()
            }
        });
    
        return true;
    } catch (e) {
        console.error("‚ùå Erro ao enviar bloqueio:", e);
        return false;
    }
}

async function unlockPost(postId) {
    if (!currentArchiveId) return;
    
    const docRef = doc(db, 'pastas', currentArchiveId);
    
    try {
        // Remove a entrada do objeto 'locks' no Firebase
        await updateDoc(docRef, {
            [`locks.${postId}`]: deleteField()
        });
        console.log(`üîì [SISTEMA] Cadeado removido de: ${postId}`);
    } catch (e) {
        console.error("‚ùå [ERRO] Falha ao remover cadeado na sa√≠da:", e);
    }
}

// --- L√ìGICA DO BOT√ÉO VOLTAR NO ARQUIVO (MOBILE) ---
const archiveBackBtn = document.getElementById('archive-back-btn');
if (archiveBackBtn) {
    archiveBackBtn.addEventListener('click', async () => {
        // 1. Sai da presen√ßa em tempo real (Colabora√ß√£o)
        await leaveArchivePresence();

        // 2. Grava o post se houver algum em edi√ß√£o
        if (activeEditingPostId) {
            await saveArchivePost(activeEditingPostId);
        }

        // 3. Troca as vistas Mobile (Esconde Arquivo, Mostra Lista)
        const container = document.querySelector('.notebook-container');
        if (container) container.classList.remove('middle-panel-collapsed');
        
        document.body.classList.remove('mobile-view-editor');
        document.body.classList.add('mobile-view-middle');

        // 4. Limpa estados de sele√ß√£o
        selectedNoteId = null;
        activeEditingPostId = null;

        // 5. ATUALIZA OS BOT√ïES FLUTUANTES
        updateMobileFABVisibility();
    });
}

// --- DIAGN√ìSTICO DE LAYOUT (DEBUG) ---
window.debugMobileLayout = function() {
    console.group("üïµÔ∏è DEBUG VISUAL MOBILE");
    
    const rightPanel = document.getElementById('right-panel');
    const rightStyle = window.getComputedStyle(rightPanel);
    

    Array.from(rightPanel.children).forEach(child => {
        const style = window.getComputedStyle(child);
        if (style.display !== 'none') {
        } else {
        }
    });
    console.groupEnd();
};

// Executa automaticamente se estivermos a ver o arquivo
setInterval(() => {
    if (document.getElementById('archive-area').style.display !== 'none' && window.innerWidth < 768) {
        // Descomente a linha abaixo apenas se quiser ver o log repetidamente
        // window.debugMobileLayout();
    }
}, 5000);

// Fun√ß√£o para sair formalmente da presen√ßa do Arquivo
async function leaveArchivePresence() {
    // 1. Para o "cora√ß√£o" (heartbeat)
    if (presenceInterval) {
        clearInterval(presenceInterval);
        presenceInterval = null;
    }

    // 2. Desliga o ouvinte de quem est√° online
    if (collabUnsubscribe) {
        collabUnsubscribe();
        collabUnsubscribe = null;
    }

    // 3. Remove o meu rasto do Firebase (se eu estiver num arquivo)
    if (currentArchiveId && auth.currentUser) {
        try {
            const myUid = auth.currentUser.uid;
            const presenceRef = doc(db, 'pastas', currentArchiveId, 'collaborators', myUid);
            await deleteDoc(presenceRef);
        } catch (e) {
            console.warn("Erro ao limpar presen√ßa:", e);
        }
    }

    // 4. Limpa e esconde a barra visualmente
    const barDiv = document.getElementById('collab-bar');
    const listDiv = document.getElementById('active-users-list');
    if (barDiv) barDiv.style.display = 'none';
    if (listDiv) listDiv.innerHTML = '';
}

// Fun√ß√£o Mestra para garantir que NADA no notebook est√° selecionado visualmente
function clearAllListSelections() {
    // Agora limpamos apenas a Coluna 2. 
    // A Coluna 1 √© gerida automaticamente pelo onSnapshot + col1SelectedId
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });
    console.log("üßπ [SISTEMA] Sele√ß√£o visual da Coluna 2 limpa.");
}

// === GEST√ÉO DE GAVETAS (ADICIONAR NO FIM DO SCRIPT) ===


// 1. Alternar entre Prateleira e Gavet√£o
document.querySelectorAll('.archive-tab-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const targetTab = btn.dataset.archiveTab;
        console.group(`üîÑ [TRANSICAO] Indo para: ${targetTab}`);

        // A. AUTO-SAVE (Mesma l√≥gica robusta anterior)
        const idToSave = activeEditingPostId || window.activeEditingPostId;
        if (idToSave) { 
            console.log(`%c‚ö†Ô∏è [AUTO-SAVE] Gravando post ${idToSave} antes de mudar de aba...`, "color: #e67e22; font-weight: bold;");
            const tempId = idToSave;
            activeEditingPostId = null;
            window.activeEditingPostId = null;
            await window.saveArchivePost(tempId);
        }

        // B. L√ìGICA DE NAVEGA√á√ÉO: SE CLICOU NA PRATELEIRA, SAI DA GAVETA
        if (targetTab === 'prateleira') {
            if (window.activeGavetaId) {
                console.log(`%cüìÇ [RESET] Limpando activeGavetaId (${window.activeGavetaId}) para mostrar feed completo.`, "color: #3498db;");
                window.activeGavetaId = null;
                window.activeGavetaData = null;
            }
        }

        // C. Atualiza√ß√£o Visual das Abas
        document.querySelectorAll('.archive-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentArchiveTab = targetTab;
        
        const postBtn = document.getElementById('create-post-btn');
        const drawerBtn = document.getElementById('create-drawer-trigger-btn');
        if (currentArchiveTab === 'prateleira') {
            postBtn.style.display = 'block';
            drawerBtn.style.display = 'none';
        } else {
            postBtn.style.display = 'none';
            drawerBtn.style.display = 'block';
        }

        // D. RENDERIZA√á√ÉO FINAL
        console.log(`üé¨ [RENDER] Desenhando feed para: ${currentArchiveTab}`);
        renderArchiveFeed();
        console.groupEnd();
    });
});






// 3. Editar Gavet√£o
window.openEditDrawerModal = (id, nome, desc) => {
    const modal = document.getElementById('create-drawer-modal');
    const titleEl = modal.querySelector('h3');
    const nameInput = document.getElementById('new-drawer-name');
    const descInput = document.getElementById('new-drawer-desc');
    const confirmBtn = document.getElementById('confirm-create-drawer');

    if (!modal) return;

    // 1. CONFIGURA√á√ÉO VISUAL DO MODAL PARA EDI√á√ÉO
    titleEl.textContent = "Editar Gavet√£o";
    nameInput.value = nome;
    descInput.value = desc === 'undefined' ? "" : desc; // Limpa se vier como string 'undefined'
    confirmBtn.textContent = "Gravar Altera√ß√µes";

    // 2. LIMPEZA DE LISTENERS ANTIGOS (Muito importante!)
    // Clonamos o bot√£o para garantir que a fun√ß√£o de "Criar" n√£o seja disparada por engano
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    // 3. L√ìGICA DE ATUALIZA√á√ÉO NO FIREBASE
    newConfirmBtn.onclick = async (e) => {
        e.preventDefault();
        
        const novoNome = nameInput.value.trim();
        if (!novoNome) return alert("O nome do gavet√£o √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A guardar...";

        try {
            // Importa√ß√£o din√¢mica por seguran√ßa
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const drawerRef = doc(db, 'gavetoes', id);
            
            await updateDoc(drawerRef, {
                nome: novoNome,
                descricao: descInput.value.trim(),
                ultimaEdicao: Date.now()
            });

            // 4. SUCESSO: FECHAR E RESETAR
            modal.style.display = 'none';
            
            // Restaura o t√≠tulo padr√£o do modal para a pr√≥xima vez que for usado para criar
            titleEl.textContent = "Criar Gavet√£o";
            
            if (typeof renderArchiveFeed === 'function') {
                renderArchiveFeed();
            }

        } catch (error) {
            console.error("‚ùå [ERRO] Falha ao editar gavet√£o:", error);
            alert("Ocorreu um erro ao gravar as altera√ß√µes.");
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gravar Altera√ß√µes";
        }
    };

    // 5. MOSTRAR O MODAL (Com refor√ßo de Z-Index)
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "99999";
    
    setTimeout(() => nameInput.focus(), 150);
};






// 2. Aplicar o Estilo e Fechar
window.applyColorStyle = function(command, color) {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    if (typeof currentSelectionRange !== 'undefined' && currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    }

    // --- L√ìGICA INTELIGENTE (B e I) ---
    if (command === 'bold' || command === 'italic') {
        
        // Verifica o estado atual (dependendo do comando)
        const isStateActive = document.queryCommandState(command);
        const currentColorRGB = document.queryCommandValue('foreColor');
        const currentColorHex = rgbToHex(currentColorRGB);
        
        const targetColor = color.toLowerCase();
        const activeColor = currentColorHex.toLowerCase();

        if (!isStateActive) {
            // Se N√ÉO est√° ativo -> Ativa Formato + Cor
            document.execCommand(command, false, null);
            document.execCommand('foreColor', false, color);
        } 
        else {
            // Se J√Å EST√Å ativo:
            const colorsAreSame = (activeColor === targetColor);

            if (colorsAreSame) {
                // Mesma cor -> Remove Formato (Toggle Off)
                document.execCommand(command, false, null);
            } else {
                // Cor diferente -> Mant√©m Formato, Muda Cor
                document.execCommand('foreColor', false, color);
            }
        }

    } else {
        // Fallback
        document.execCommand(command, false, null);
        document.execCommand('foreColor', false, color);
    }
    
    // Foco e Sele√ß√£o
    editor.focus();
    if (currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    }

    if (typeof saveNote === 'function') saveNote();

    // Fecha todos os menus
    const fPopup = document.getElementById('formatting-popup');
    const bPopup = document.getElementById('bold-palette-popup');
    const iPopup = document.getElementById('italic-palette-popup'); // NOVO
    const fBtn = document.getElementById('more-formatting-btn');

    if (fPopup) fPopup.style.display = 'none';
    if (bPopup) bPopup.style.display = 'none';
    if (iPopup) iPopup.style.display = 'none';
    if (fBtn) fBtn.classList.remove('active'); 
};


// --- L√ìGICA EXPORTAR SENTINELA ü§ñ ---

let detectedQuestions = [];

window.openRobotModal = function() {
    const modal = document.getElementById('robot-modal');
    if (!modal) return console.error("Modal do Rob√¥ n√£o encontrado!");

    // 1. Esconde menus
    const fPopup = document.getElementById('formatting-popup');
    if(fPopup) fPopup.style.display = 'none';

    // 2. Limpa campos
    document.getElementById('robot-input-text').value = '';
    document.getElementById('robot-preview-container').style.display = 'none';
    document.getElementById('robot-insert-btn').style.display = 'none';
    document.getElementById('robot-input-container').style.display = 'block';
    
    // 3. Mostra Modal
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";
};

// Fun√ß√£o para Gerar/Detetar Perguntas
document.getElementById('robot-generate-btn').addEventListener('click', () => {
    const rawText = document.getElementById('robot-input-text').value;
    if (!rawText.trim()) return alert("Cole o texto primeiro.");

    detectedQuestions = []; // Array de objetos { type: 'header' | 'question', text: '...' }
    
    // 1. IDENTIFICAR SE√á√ÉO DE RECAPITULA√á√ÉO (QUAL √â A SUA RESPOSTA?)
    const recapMarkers = ["QUAL √â A SUA RESPOSTA?", "COMO RESPONDERIA?"];
    let mainBody = rawText;
    let recapBody = "";

    recapMarkers.forEach(marker => {
        if (rawText.toUpperCase().includes(marker)) {
            const index = rawText.toUpperCase().indexOf(marker);
            mainBody = rawText.substring(0, index);
            recapBody = rawText.substring(index);
        }
    });

    // 2. FASE 1: PROCESSAR CORPO PRINCIPAL (Perguntas numeradas)
    const mainParts = mainBody.split(/(?:As|A) (?:vossas?|suas?) respostas?/i);
    for (let i = 0; i < mainParts.length - 1; i++) {
        let block = mainParts[i].trim();
        const lastNumberMatch = block.match(/\d+(?:-\d+)?\.\s+/g);
        if (lastNumberMatch) {
            const lastMatch = lastNumberMatch[lastNumberMatch.length - 1];
            const startIndex = block.lastIndexOf(lastMatch);
            let questionLine = block.substring(startIndex).trim();

            if (questionLine.includes('(a)') && questionLine.includes('(b)')) {
                const subParts = questionLine.split(/(?=\([b-z]\))/);
                subParts.forEach(sp => {
                    if (sp.trim()) detectedQuestions.push({ type: 'question', text: sp.trim() });
                });
            } else {
                detectedQuestions.push({ type: 'question', text: questionLine });
            }
        }
    }

    // 3. FASE 2: PROCESSAR RECAPITULA√á√ÉO
    if (recapBody) {
        // Extrair o t√≠tulo (ex: QUAL √â A SUA RESPOSTA?)
        const titleMatch = recapBody.match(/(QUAL √â A SUA RESPOSTA\?|COMO RESPONDERIA\?)/i);
        if (titleMatch) {
            detectedQuestions.push({ type: 'header', text: titleMatch[0] });
        }

        // Isolar apenas at√© chegar ao C√ÇNTICO ou notas finais
        const recapLimit = recapBody.split(/C√ÇNTICO|Veja o quadro|Por exemplo, veja/i)[0];
        
        // Procurar frases que terminam em "?" seguidas por "A sua resposta"
        const recapParts = recapLimit.split(/(?:As|A) (?:vossas?|suas?) respostas?/i);
        recapParts.forEach(part => {
            const lines = part.trim().split('\n');
            const lastLine = lines[lines.length - 1].trim();
            if (lastLine.endsWith('?')) {
                detectedQuestions.push({ type: 'question', text: lastLine });
            }
        });
    }

    // 4. RENDERIZAR PR√â-VISUALIZA√á√ÉO
    const list = document.getElementById('preview-list');
    list.innerHTML = '';
    
    if (detectedQuestions.length > 0) {
        detectedQuestions.forEach((item, index) => {
            const li = document.createElement('li');
            if (item.type === 'header') {
                li.style.cssText = "margin: 15px 0 5px 0; padding: 5px; color: #4a90e2; font-weight: bold; border-bottom: 1px solid #333; list-style: none;";
                li.innerHTML = `üìå ${item.text}`;
            } else {
                li.style.cssText = "margin-bottom: 8px; padding: 10px; background: rgba(46, 204, 113, 0.1); border-left: 4px solid #2ecc71; border-radius: 4px; color: #f0f0f0; font-size: 13px;";
                li.innerHTML = item.text;
            }
            list.appendChild(li);
        });

        document.getElementById('preview-count').textContent = `Detetados ${detectedQuestions.filter(i => i.type==='question').length} itens:`;
        document.getElementById('robot-preview-container').style.display = 'block';
        document.getElementById('robot-insert-btn').style.display = 'block';
    } else {
        alert("Nenhuma pergunta encontrada.");
    }
});



// Fun√ß√£o para Inserir as Perguntas no Editor
document.getElementById('robot-insert-btn').addEventListener('click', () => {
    const editor = document.getElementById('note-content-editor');
    
    const toolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Remover">üóëÔ∏è</button>
        </div>`;

    let fullHTML = "";
    let firstItemId = null; // Guardar√° o ID do primeiro item para o scroll

    detectedQuestions.forEach((item, index) => {
        // Criamos um ID √∫nico para este item
        const uniqueId = `sentinela_${Date.now()}_${index}`;
        
        // Se for o primeiro item da lista (header ou quest√£o), guardamos o ID
        if (index === 0) firstItemId = uniqueId;

        if (item.type === 'header') {
            // T√≠tulo de se√ß√£o
            fullHTML += `<p id="${uniqueId}"><br></p><p><strong>${item.text}</strong></p>`;
        } else {
            // Caixa de Quest√£o
    fullHTML += `
    <div class="mini-note-wrapper question-mode" id="${uniqueId}">
        <textarea class="mini-note-title-input" rows="1">${item.text}</textarea>
        ${toolbarHTML}
        <div class="mini-note-content" contenteditable="true">
            <p><br></p>
        </div>
    </div><p><br></p>`;
        }
    });

    // 1. Inser√ß√£o no Editor
    if (typeof currentSelectionRange !== 'undefined' && currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    } else {
        editor.focus();
    }

    document.execCommand('insertHTML', false, fullHTML);
    
    // 2. L√≥gica de Scroll para o Topo (com um pequeno delay para o browser renderizar o HTML)
    setTimeout(() => {
        if (firstItemId) {
            const firstEl = document.getElementById(firstItemId);
            if (firstEl) {
                // Scroll suave para o primeiro item inserido
                firstEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }, 150);

    // 3. Finaliza√ß√£o
    document.getElementById('robot-modal').style.display = 'none';
    if (typeof saveNote === 'function') saveNote();
    if (typeof fixLegacyMiniNotes === 'function') fixLegacyMiniNotes();
});




document.getElementById('append-back-btn').onclick = () => {
    const pathLabel = document.getElementById('append-current-path').textContent;
    
    if (pathLabel === "ü§ù Partilha") {
        // Se estiver na raiz da partilha, volta para a Raiz Global
        loadAppendList(null);
    } else if (appendStack.length > 0) {
        appendStack.pop();
        const prevId = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : null;
        loadAppendList(prevId);
    } else {
        loadAppendList(null);
    }
};

function applyTitleWrappingEffect() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    const allTitles = editor.querySelectorAll('.mini-note-title-input');
    
    allTitles.forEach(t => {
        // Se ainda for um INPUT, converte para TEXTAREA (necess√°rio para quebra de linha)
        if (t.tagName === 'INPUT') {
            const textarea = document.createElement('textarea');
            textarea.className = t.className;
            // Pega o valor do atributo value ou do valor atual
            textarea.value = t.getAttribute('value') || t.value || ""; 
            textarea.placeholder = t.placeholder || "";
            textarea.setAttribute('spellcheck', 'false');
            if (t.readOnly) textarea.readOnly = true;
            t.parentNode.replaceChild(textarea, t);
            t = textarea; 
        }

        if (appSettings && appSettings.showFullTitles === true) {
            t.classList.add('wrap-enabled');
            t.style.whiteSpace = "pre-wrap";
            t.style.overflow = "hidden";
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
            
            t.oninput = function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                // Sincroniza o textContent para o save n√£o falhar
                this.textContent = this.value; 
            };
        } else {
            t.classList.remove('wrap-enabled');
            t.style.whiteSpace = "nowrap";
            t.style.height = ""; 
            t.style.overflow = "hidden";
            t.oninput = null;
        }
    });
}

// Fun√ß√£o auxiliar para garantir que o campo cresce com o texto
function autoResizeTitle(el) {
    if (!el) return;
    
    if (typeof appSettings !== 'undefined' && !appSettings.showFullTitles) {
        el.style.height = ""; 
        return;
    }

    // TRUQUE ANTI-SALTO:
    // Em vez de zerar a altura para medir (o que causa o salto),
    // usamos o scrollHeight atual. Se ele aumentou, expandimos.
    // Se precisarmos mesmo encolher, fazemos com cuidado.

    const currentHeight = el.offsetHeight;
    
    // Reseta temporariamente para medir o tamanho real do texto
    // Mas guarda o scroll da p√°gina para restaurar se saltar
    const scrollParent = el.closest('#note-content-editor') || document.documentElement;
    const oldScroll = scrollParent.scrollTop;

    el.style.height = 'auto'; 
    const newHeight = el.scrollHeight;

    // Se a diferen√ßa for m√≠nima, n√£o mexe para evitar tremores
    if (Math.abs(newHeight - currentHeight) > 2) {
        el.style.height = newHeight + 'px';
        
        // Se o ajuste de altura fez o scroll saltar, restaura-o
        if (scrollParent.scrollTop !== oldScroll) {
            scrollParent.scrollTop = oldScroll;
        }
    } else {
        // Restaura a altura original se n√£o houve mudan√ßa real
        el.style.height = currentHeight + 'px';
    }
}

// Fun√ß√£o para converter Inputs antigos em Textareas din√¢micos
function convertToTextarea(inputEl) {
    const textarea = document.createElement('textarea');
    textarea.className = inputEl.className;
    textarea.value = inputEl.value;
    textarea.placeholder = inputEl.placeholder;
    textarea.rows = 1;
    // Copia os datasets
    Object.assign(textarea.dataset, inputEl.dataset);
    
    inputEl.parentNode.replaceChild(textarea, inputEl);
    
    textarea.addEventListener('input', () => {
        autoResizeTitle(textarea);
        saveNote();
    });
}

// ============================================================
// FUN√á√ÉO: RENDERIZAR ITENS DA CATEGORIA (COLUNA DO MEIO)
// ============================================================
async function renderListCategoryItems(categoryId) {
    const listElement = middlePanelList;
    const myUid = auth.currentUser.uid;
    
    // 1. ESTADO DE CARREGAMENTO
    listElement.innerHTML = `
        <div class="spinner-container" style="margin-top:50px;">
            <div class="spinner"></div>
            <span>A processar categoria...</span>
        </div>`;
    
    // Identifica onde estamos na navega√ß√£o
    const lastNav = navigationStack[navigationStack.length - 1];
    const origin = navigationStack[0]?.id || categoryId;

    try {
        // Importa√ß√µes necess√°rias
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // ==========================================
        // 1. N√çVEL PROFUNDO: DENTRO DE UM MARCADOR (Listar Vers√≠culos)
        // ==========================================
        if (lastNav && lastNav.type === 'marcadores') {
            middlePanelTitle.textContent = `üîñ ${lastNav.name}`;
            updateAddButtonState(false); 

            const q = query(
                collection(db, 'textosbiblicos'),
                where(`marcadoresAssociados.${lastNav.id}`, '==', true),
                where('userId', '==', myUid)
            );

            const snap = await getDocs(q);
            listElement.innerHTML = '';

            if (snap.empty) {
                listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum texto com este marcador.</li>';
                return;
            }

            snap.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                const li = document.createElement('li');
                li.className = 'list-item';
                
                if (activeReferenceEntity && activeReferenceEntity.id === item.id) {
                    li.classList.add(currentViewMode === 'shared' ? 'selected-red' : 'selected');
                }

                li.innerHTML = `<span>üìú ${item.nome}</span>`;

                li.onclick = () => {
                    listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                    const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                    li.classList.add(selectionClass);
                    showReferencesPanel(item.id, item.nome, 'textobiblico');
                };
                listElement.appendChild(li);
            });
            return; 
        }

        // ==========================================
        // 2. CAMINHO: COSMOS (TEMAS E SUBTEMAS)
        // ==========================================
        if (origin === 'cosmos') {
            if (lastNav.type === 'list-category') {
                middlePanelTitle.textContent = "üíº Cosmos: Temas";
                updateAddButtonState(true, true);

                const q = query(collection(db, 'cosmos'), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                listElement.innerHTML = '';

                if (snap.empty) {
                    listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum tema criado. Clique no + para come√ßar.</li>';
                    return;
                }

                snap.forEach(docSnap => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    if (item.estado === 'desativa') return;

                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>${item.emoji || 'üíº'} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;
                    
                    li.onclick = (e) => {
                        if (e.target.closest('.item-menu-btn')) return;
                        navigationStack.push({ id: item.id, name: item.nome, type: 'cosmos-parent', emoji: item.emoji || 'üíº' });
                        updateNavigationView(true);
                    };
                    listElement.appendChild(li);
                });
            }
            else if (lastNav.type === 'cosmos-parent') {
                middlePanelTitle.textContent = `${lastNav.emoji} ${lastNav.name}`;
                updateAddButtonState(true, true);

                const q = query(collection(db, 'subcosmos'), where('cosmosId', '==', lastNav.id), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                listElement.innerHTML = '';

                if (snap.empty) {
                    listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Esta pasta est√° vazia.</li>';
                    return;
                }

                snap.forEach(docSnap => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    if (item.estado === 'desativa') return;

                    const li = document.createElement('li');
                    li.className = 'list-item';
                    if (activeReferenceEntity && activeReferenceEntity.id === item.id) li.classList.add('selected');

                    li.innerHTML = `<span>${item.emoji || 'üîπ'} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;
                    
                    li.onclick = (e) => {
                        if (e.target.closest('.item-menu-btn')) return;
                        listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
                        li.classList.add('selected');
                        showReferencesPanel(item.id, item.nome, 'subcosmos');
                    };
                    listElement.appendChild(li);
                });
            }
            return;
        }

        // ==========================================
        // 3. CAMINHO: B√çBLIA
        // ==========================================
        if (origin === 'biblia-root') {
            if (lastNav.type === 'list-category') {
                middlePanelTitle.textContent = "B√≠blia: Livros";
                updateAddButtonState(false);
                listElement.innerHTML = '';
                BIBLE_DATA.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>üìñ ${book.nome}</span>`;
                    li.onclick = () => {
                        navigationStack.push({ id: book.nome, name: book.nome, type: 'bible-book', caps: book.caps });
                        updateNavigationView(true);
                    };
                    listElement.appendChild(li);
                });
            } else if (lastNav.type === 'bible-book') {
                middlePanelTitle.textContent = lastNav.name;
                listElement.innerHTML = '<div class="bible-grid"></div>';
                const grid = listElement.querySelector('.bible-grid');
                for (let i = 1; i <= lastNav.caps; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'bible-grid-btn';
                    btn.textContent = i;
                    btn.onclick = () => {
                        navigationStack.push({ id: `${lastNav.name} ${i}`, name: `Cap. ${i}`, type: 'bible-chapter', book: lastNav.name, chapter: i });
                        updateNavigationView(true);
                    };
                    grid.appendChild(btn);
                }
            } else if (lastNav.type === 'bible-chapter') {
                const bookData = BIBLE_DATA.find(b => b.nome === lastNav.book);
                const prefix = `${lastNav.book} ${lastNav.chapter}:`;
                middlePanelTitle.textContent = prefix.replace(':', '');
                listElement.innerHTML = '<div class="bible-grid"></div>';
                const grid = listElement.querySelector('.bible-grid');
                const totalV = bookData?.versiculos?.[lastNav.chapter - 1] || 50;
                const existingVerses = allEntities['textobiblico'] || [];
                for (let v = 1; v <= totalV; v++) {
                    const fullVerse = `${prefix}${v}`;
                    const exists = existingVerses.some(e => e.nome === fullVerse);
                    const isActive = fullVerse === currentlyOpenVerseName;
                    const btn = document.createElement('div');
                    btn.className = `bible-grid-btn ${exists ? 'exists' : ''} ${isActive ? 'active-verse' : ''}`;
                    btn.textContent = v;
                    btn.onclick = () => {
                        currentlyOpenVerseName = fullVerse;
                        grid.querySelectorAll('.bible-grid-btn').forEach(b => b.classList.remove('active-verse'));
                        btn.classList.add('active-verse');
                        showReferencesPanel(null, fullVerse, 'textobiblico');
                    };
                    grid.appendChild(btn);
                }
            }
            return;
        }

        // ==========================================
        // 4. LISTAS PRINCIPAIS (RAIZ)
        // ==========================================
        if (!lastNav || lastNav.type === 'list-category') {
            let items = [];
            
            // --- MARCADORES ---
            if (categoryId === 'marcadores') {
                middlePanelTitle.textContent = "Marcadores";
                updateAddButtonState(true, true); 
                const q = query(collection(db, 'marcadores'), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                listElement.innerHTML = '';
                if (snap.empty) {
                    listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum marcador criado.</li>';
                    return;
                }
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>üîñ ${data.nome}</span>`;
                    li.onclick = () => {
                        navigationStack.push({ id: docSnap.id, name: data.nome, type: 'marcadores' });
                        updateNavigationView(true);
                    };
                    listElement.appendChild(li);
                });
                return;
            }

            // --- DESTAQUES (CORES) - AQUI ESTAVA A FALTA ---
         else if (categoryId === 'destaque') {
                middlePanelTitle.textContent = "Destaques (Cores)";
                updateAddButtonState(false); 
                listElement.innerHTML = '';
                
                // Itera sobre as cores globais
                DEFAULT_HIGHLIGHTS.forEach(colorObj => {
                    // Verifica se o user deu um nome personalizado
                    const displayName = userCustomHighlights[colorObj.code] || colorObj.name;
                    
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    
                    // CORRE√á√ÉO VISUAL:
                    // 1. 'flex: none !important' impede a bola de esticar.
                    // 2. 'min-width' garante que n√£o encolhe.
                    // 3. Envolvemos o nome num <span> para ele ficar com o 'flex: 1' do CSS global.
                    const colorDot = `<span style="display:inline-block; width:16px; height:16px; min-width:16px; background:${colorObj.code}; border-radius:50%; margin-right:10px; border:1px solid rgba(255,255,255,0.3); flex: none !important;"></span>`;
                    
                    li.innerHTML = `${colorDot} <span>${displayName}</span>`;
                    
                    li.onclick = () => {
                        // Limpa sele√ß√£o visual
                        listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                        
                        // Aplica sele√ß√£o
                        const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                        li.classList.add(selectionClass);
                        
                        // Abre a 4¬™ coluna com as refer√™ncias desta cor
                        showHighlightReferencesPanel(colorObj.code, displayName);
                    };
                    
                    listElement.appendChild(li);
                });
                return;
            }

            // --- T√ìPICOS ---
            else if (categoryId === 'topico') {
                middlePanelTitle.textContent = "T√≥picos";
                updateAddButtonState(true, true);
                const q = query(collection(db, 'topicos'), where('userId', '==', myUid), orderBy('nome'));
                const snap = await getDocs(q);
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.estado !== 'desativa') items.push({ id: doc.id, nome: data.nome, type: 'topico', desc: data.descricao });
                });
            } 
            
            // --- TAGS ---
            else if (categoryId === 'tag') {
                middlePanelTitle.textContent = "Tags (#)";
                updateAddButtonState(false);
                const q = query(collection(db, 'pastas'), where('tipo', '==', 'nota'), where('userId', '==', myUid));
                const snap = await getDocs(q);
                const tagSet = new Set();
                snap.forEach(doc => { if(doc.data().tags) doc.data().tags.forEach(t => tagSet.add(t)); });
                items = Array.from(tagSet).sort().map(t => ({ id: t, nome: t, type: 'tag' }));
            }
            
            // --- GEN√âRICOS (Personagens, Locais, etc) ---
      else {
                const config = ENTITY_CONFIG[categoryId];
                if (config) {
                    middlePanelTitle.textContent = config.displayName;
                    
                    // --- CORRE√á√ÉO AQUI ---
                    // Se for Texto B√≠blico, ESCONDE o bot√£o "+".
                    // Para os outros (Personagem, Local, etc), mostra o bot√£o amarelo.
                    if (categoryId === 'textobiblico') {
                        updateAddButtonState(false);
                    } else {
                        updateAddButtonState(true, true);
                    }
                    // ---------------------

                    const q = query(collection(db, config.collection), where('userId', '==', myUid), orderBy('nome'));
                    const snap = await getDocs(q);
                    
                    snap.forEach(doc => {
                        const data = doc.data();
                        if (data.estado !== 'desativa') {
                            items.push({ id: doc.id, nome: data.nome, type: categoryId });
                        }
                    });
                }
            }
            
            // Renderiza para os casos padr√£o (T√≥picos, Tags, Entidades)
            renderStandardList(items);
        }

    } catch (e) {
        console.error("Erro ao renderizar lista de categorias:", e);
        listElement.innerHTML = '<li style="color:red; padding:20px; text-align:center;">Erro ao ligar √† base de dados.</li>';
    }
}


// Fun√ß√£o auxiliar para n√£o repetir c√≥digo de renderiza√ß√£o
function renderStandardList(items) {
    // 1. Limpa apenas a Coluna 2
    middlePanelList.innerHTML = '';
    
    if (items.length === 0) {
        middlePanelList.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nada encontrado.</li>';
        return;
    }
    
    items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-item';
        
        // ============================================================
        // REGRA DE COR DIN√ÇMICA PARA LISTAS (COLUNA 2)
        // ============================================================
        // Verifica se o item √© o que est√° atualmente aberto no painel de refer√™ncias
        if (activeReferenceEntity && activeReferenceEntity.id === item.id) {
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            li.classList.add(selectionClass);
        }

        let icon = 'üîπ';
        if (item.type === 'topico') icon = 'üìë';
        if (item.type === 'tag') icon = 'üè∑Ô∏è';
        if (item.type === 'textobiblico') icon = 'üìú';
        if (item.type === 'marcadores') icon = 'üîñ';
        if (item.type === 'destaque') icon = 'üé®';
        
        li.innerHTML = `<span>${icon} ${item.nome}</span>`;
        
        li.onclick = () => {
            // Limpa a sele√ß√£o visual apenas da Coluna 2 antes de marcar o novo
            document.querySelectorAll('#file-list .list-item').forEach(el => {
                el.classList.remove('selected', 'selected-red');
            });
            
            // Aplica a cor correta baseada no modo
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            li.classList.add(selectionClass);

            // A√ß√£o de abrir as refer√™ncias
            if (item.type === 'topico') showTopicReferencesPanel(item.id, item.nome, item.desc, 'topico');
            else if (item.type === 'tag') showTagReferencesPanel(item.nome);
            else if (item.type === 'destaque') showHighlightReferencesPanel(item.id, item.nome);
            else if (item.type === 'marcadores') showMarkerReferencesPanel(item.id, item.nome); 
            else showReferencesPanel(item.id, item.nome, item.type);
        };
        
        middlePanelList.appendChild(li);
    });
}



// ============================================================
// L√ìGICA DE ARRASTO DO PAINEL DE REFER√äNCIAS (MOBILE)
// ============================================================
const refPanel = document.getElementById('references-panel');

// Pontos de encaixe em % (O 95 garante que o bot√£o X nunca sai do ecr√£)
const snapPoints = [95, 80, 60, 50, 30, 20, 10]; 
let startY = 0;
let startHeight = 0;
let isDraggingPanel = false;

// In√≠cio do Toque
refPanel.addEventListener('touchstart', (e) => {
    // S√≥ inicia o arrasto se tocar no header (t√≠tulo/bot√£o fechar) ou no fundo do painel
    if (e.target.closest('.panel-header') || e.target.id === 'references-panel') {
        isDraggingPanel = true;
        startY = e.touches[0].clientY;
        startHeight = refPanel.offsetHeight;
        refPanel.classList.add('is-dragging');
    }
}, { passive: true });

// Movimento do Dedo
window.addEventListener('touchmove', (e) => {
    if (!isDraggingPanel) return;

    const currentY = e.touches[0].clientY;
    const deltaY = startY - currentY; // Arrastar para cima aumenta a altura
    let newHeight = startHeight + deltaY;

    const screenHeight = window.innerHeight;
    const newHeightPct = (newHeight / screenHeight) * 100;

    // LIMITES DE ARRASTO: M√≠nimo 5% e M√°ximo 95% para n√£o tapar o topo total
    if (newHeightPct >= 5 && newHeightPct <= 95) {
        refPanel.style.height = `${newHeight}px`;
    }
}, { passive: false });

// Final do Toque (Snap)
window.addEventListener('touchend', () => {
    if (!isDraggingPanel) return;
    
    isDraggingPanel = false;
    refPanel.classList.remove('is-dragging');

    const screenHeight = window.innerHeight;
    const currentHeightPct = (refPanel.offsetHeight / screenHeight) * 100;
    
    // Encontra o ponto de snap mais pr√≥ximo
    const closestSnap = snapPoints.reduce((prev, curr) => {
        return (Math.abs(curr - currentHeightPct) < Math.abs(prev - currentHeightPct) ? curr : prev);
    });

    // Fixa na altura de encaixe (vh)
    refPanel.style.height = `${closestSnap}vh`;
});

// RESET PARA 60% AO FECHAR E REABRIR
const originalHidePanel = window.hideReferencesPanel;
window.hideReferencesPanel = async function() {
    if (typeof originalHidePanel === 'function') await originalHidePanel();
    
    // Pequeno delay para a anima√ß√£o de descida terminar antes de resetar a altura para 60%
    setTimeout(() => {
        refPanel.style.height = "60vh"; 
    }, 400);
};

async function showMarkerReferencesPanel(markerId, markerName) {
    
    // 1. Gravar o puzzle anterior se estivesse em modo edi√ß√£o
    await forceSaveAndClosePuzzleMode();

    // 2. CONFIGURAR A ENTIDADE ATIVA (Para o bot√£o +Ref do Quadro saber o que procurar)
    activeReferenceEntity = { 
        id: markerId, 
        type: 'marcadores', 
        name: markerName 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel lateral
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Textos com üîñ ${markerName}`;

    // For√ßa a aba "Refer√™ncias" a abrir para mostrar os vers√≠culos encontrados
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Carrega o Quadro (Puzzle) associado a este Marcador
    loadPuzzleData(markerId, 'marcadores');

    // Limpa a lista e mostra o sinal de carregamento
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar textos b√≠blicos marcados...</span>
        </div>`;

    try {
        // 4. Query ao Firebase: Procura na cole√ß√£o 'textosbiblicos' 
        // onde o ID do marcador existe dentro do mapa 'marcadoresAssociados'
        const q = query(
            collection(db, 'textosbiblicos'),
            where(`marcadoresAssociados.${markerId}`, '==', true),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        listElement.innerHTML = '';

        if (snapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum texto b√≠blico foi associado a este marcador ainda.</li>';
            return;
        }

        // 5. Renderizar a lista de Vers√≠culos encontrados
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            // Dados para o bot√£o de adicionar ao quadro
            const safeName = encodeURIComponent(data.nome);
            const markerSnippet = `<p style="color:#9b59b2; font-weight:bold;">üîñ Texto marcado como: ${markerName}</p>`;
            const safeSnippet = encodeURIComponent(markerSnippet);

            const summary = document.createElement('summary');
            summary.style.display = 'flex';
            summary.style.alignItems = 'center';
            summary.style.width = '100%';
            summary.style.listStyle = "none";

            // Bot√£o "Ir para" (neste caso, abre as refer√™ncias desse vers√≠culo espec√≠fico)
            const goToBtn = `<button class="go-to-note-btn" 
                onclick="event.preventDefault(); event.stopPropagation(); showReferencesPanel('${docSnap.id}', '${data.nome}', 'textobiblico')" 
                title="Ver notas sobre este texto">‚ûî</button>`;

            summary.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; flex-grow:1; overflow:hidden;">
                    <button class="add-to-puzzle-btn" title="Adicionar ao Quadro" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${docSnap.id}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                   <span style="white-space:normal; word-break:break-word; font-weight:500; line-height:1.3;">${title}</span>

                        üìú ${data.nome}
                    </span>
                </div>
                ${goToBtn}
            `;

            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Mostra a descri√ß√£o do texto b√≠blico se existir
            contextDiv.innerHTML = `<p>${data.descricao || 'Sem anota√ß√µes gerais para este texto.'}</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao carregar vers√≠culos do marcador:", error);
        listElement.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao carregar refer√™ncias da base de dados.</li>';
    }
}

function updateAddButtonState(visible, yellowMode = false) {
    const btn = document.getElementById('add-item-btn');
    if (!btn) return;

    if (visible) {
        btn.style.display = 'flex';
        if (yellowMode) {
            btn.classList.add('yellow-mode');
        } else {
            btn.classList.remove('yellow-mode');
        }
    } else {
        btn.style.display = 'none';
    }
}

// Fun√ß√£o para varrer o editor e descobrir quais cores de destaque est√£o a ser usadas
function extractUsedColorsFromEditor() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return [];

    // Procura todos os elementos que t√™m o atributo data-highlight
    const coloredElements = editor.querySelectorAll('[data-highlight]');
    const colorsSet = new Set();

    coloredElements.forEach(el => {
        const color = el.getAttribute('data-highlight');
        if (color) {
            // Guardamos sempre em mai√∫sculas para evitar erros de pesquisa (#fff vs #FFF)
            colorsSet.add(color.toUpperCase());
        }
    });

    return Array.from(colorsSet);
}

// ============================================================
// PROTE√á√ÉO DE LIMITES: ESCAPA DE ENTIDADES (PERSONAGENS, TAGS, LINKS)
// ============================================================
function handleBoundaryProtection(event) {
    const selection = window.getSelection();
    if (!selection.rangeCount || !selection.isCollapsed) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    const offset = range.startOffset;

    // 1. Identificar se o cursor toca numa entidade protegida
    let styledEl = currentNode.nodeType === 3 ? currentNode.parentElement : currentNode;
    styledEl = styledEl.closest('.entity-link, .tag, a[data-anexo-id], .idea-span');

    if (!styledEl) return;

    // 2. Teclas de escrita (letras, n√∫meros, espa√ßo, enter)
    const isPrintable = event.key.length === 1 || event.key === 'Enter';
    if (!isPrintable) return;

    // --- L√ìGICA DE POSI√á√ÉO ---
    const isAtStart = (offset === 0);
    const isAtEnd = (currentNode.nodeType === 3 && offset === currentNode.textContent.length);

    if (isAtStart || isAtEnd) {
        // TRUQUE: Em vez de inserirmos o caractere n√≥s mesmos, inserimos um 
        // caractere invis√≠vel (Zero-Width Space) FORA do span e movemos o cursor para l√°.
        // O navegador ent√£o processar√° o seu "Enter" ou "Espa√ßo" nesse local limpo.
        
        const invisibleBridge = document.createTextNode('\u200B'); // Caractere invis√≠vel
        const parent = styledEl.parentNode;

        if (isAtStart) {
            parent.insertBefore(invisibleBridge, styledEl);
        } else {
            if (styledEl.nextSibling) {
                parent.insertBefore(invisibleBridge, styledEl.nextSibling);
            } else {
                parent.appendChild(invisibleBridge);
            }
        }

        // Move o cursor para depois da ponte invis√≠vel
        const newRange = document.createRange();
        newRange.setStartAfter(invisibleBridge);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);

    }
}


// --- FUN√á√ïES TORNADAS GLOBAIS PARA O ONCLICK FUNCIONAR ---
window.addSmallField = function(container, label, value = '') {
    const inp = document.createElement('input');
    inp.className = 'codex-input';
    inp.style.width = '45px';
    inp.placeholder = label;
    inp.value = value;
    // Insere antes do bot√£o +
    container.insertBefore(inp, container.lastChild);
};

window.toggleManual = function(btn, type, val = '') {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    
    // Se j√° estiver ativo, removemos
    if (btn.classList.contains('active')) {
        const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : '.manual-time-group');
        const el = area.querySelector(selector)?.closest('.manual-field-group');
        if (el) el.remove();
        btn.classList.remove('active');
        return;
    }

    btn.classList.add('active');

    const group = document.createElement('div');
    group.className = 'manual-field-group';

    if (type === 'A') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-year" placeholder="Ano" value="${val}" style="width: 45px;">`;
    } 
    else if (type === 'M') {
        group.innerHTML = `
            <select class="codex-input-manual manual-month" style="cursor:pointer;">
                <option value="">M√™s...</option>
                ${MESES_LISTA.map(m => `<option value="${m}" ${val===m?'selected':''}>${m}</option>`).join('')}
            </select>`;
    } 
 else if (type === 'T') {
        const t = val ? val.split(':') : ['', '', ''];
        group.classList.add('manual-time-group');
        group.innerHTML = `
            <input type="text" class="codex-input-manual h-input" 
                   placeholder="00" maxlength="2" value="${t[0]}" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 2) this.nextElementSibling?.focus();"
                   style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual m-input" 
                   placeholder="00" maxlength="2" value="${t[1]}" 
                  oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 2) this.nextElementSibling?.focus();"
                   style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual s-input" 
                   placeholder="00" maxlength="2" value="${t[2]}" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                   style="width:20px; text-align:center;">
        `;
    }

    else if (type === 'C') {
    group.innerHTML = `<input type="text" class="codex-input-manual manual-chapter" placeholder="Cap." value="${val}" style="width: 45px;">`;
}

// E atualize a linha do seletor de remo√ß√£o no in√≠cio da fun√ß√£o para incluir o cap√≠tulo:
const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));

    // Adiciona o bot√£o de fechar no final da p√≠lula (como parte do flex)
    group.innerHTML += `<button class="btn-close-manual" onclick="window.removeManualField(this, '${type}')">√ó</button>`;
    area.appendChild(group);
};

window.removeCodexRow = async function(btn) {
    const row = btn.closest('.codex-row');
    const firestoreId = row.getAttribute('data-firestore-id');
    const confirmModal = document.getElementById('confirm-modal');

    // --- CORRE√á√ÉO DE SOBREPOSI√á√ÉO ---
    if (confirmModal) {
        // Define um valor absurdamente alto para passar √† frente do Codex
        confirmModal.style.setProperty('z-index', '999999', 'important');
    }

    const confirmed = await showConfirmation(
        "Eliminar Permanente?", 
        "Deseja remover esta refer√™ncia? Ela ser√° apagada permanentemente da base de dados agora."
    );

    if (confirmed) {
        // 1. ELIMINA√á√ÉO NO FIREBASE
        if (firestoreId) {
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await deleteDoc(doc(db, 'codex', firestoreId));
                console.log("üî• Documento apagado com sucesso.");
            } catch (e) {
                console.error("‚ùå Erro ao apagar no Firebase:", e);
                alert("Erro ao apagar no servidor.");
                return; // Para aqui se houver erro no banco
            }
        }

        // 2. ELIMINA√á√ÉO NO ECR√É (Anima√ß√£o de sa√≠da)
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(30px)';
        
        setTimeout(() => {
            row.remove();
            saveNote(true); // Atualiza a nota principal
        }, 300);
    }

    if (confirmModal) confirmModal.style.zIndex = "";
};

window.removeManualField = function(closeBtn, type) {
    const row = closeBtn.closest('.codex-row');
    const fieldGroup = closeBtn.closest('.manual-field-group');
    
    // Encontra o bot√£o (A, M ou T) correspondente e desativa a cor azul
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if (toggleBtn) toggleBtn.classList.remove('active');
    
    fieldGroup.remove();
};

window.openPanelLinkCreator = async function(type, editingIndex = null) {
    console.log(`üöÄ [GESTOR PAINEL] Abertura iniciada (${type})...`);
    
    const modal = document.getElementById('link-modal');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');
    const tabHeader = document.getElementById('box-link-tabs');
    const addCodexBtn = document.getElementById('add-codex-row-btn');
    const addUrlBtn = document.getElementById('add-url-btn'); 
    
    // Divs de conte√∫do das abas
    const refsTabContent = document.getElementById('box-content-refs');
    const codexTabContent = document.getElementById('box-content-codex');
    const categoriesTabContent = document.getElementById('box-content-categories'); 
    
    const codexContainer = document.getElementById('codex-rows-container');
    const urlsContainer = document.getElementById('link-urls-container');
    const titleInput = document.getElementById('link-title-input');

    if (!modal) return;

    // 1. FOR√áAR HIERARQUIA
    document.body.appendChild(modal); 
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100dvh !important;
        background-color: rgba(0, 0, 0, 0.9) !important;
        z-index: 2147483647 !important;
        justify-content: center !important;
        align-items: center !important;
        padding: 0 !important;
        margin: 0 !important;
    `;

    // 2. LIMPEZA PROFUNDA
    if (tabHeader) tabHeader.style.display = 'none'; 
    if (categoriesTabContent) categoriesTabContent.style.display = 'none'; 
    if (refsTabContent) refsTabContent.style.display = 'none'; 
    if (codexTabContent) codexTabContent.style.display = 'none';
    
    document.getElementById('link-remove-btn').style.display = 'none';
    codexContainer.innerHTML = '';
    urlsContainer.innerHTML = '';
    titleInput.value = "";
    saveBtn.disabled = false;
    saveBtn.textContent = "Gravar";

    // 3. CARREGAR DADOS EXISTENTES (EDI√á√ÉO)
    let existingData = null; 
    if (editingIndex !== null) {
        try {
            const collectionName = getCollectionFromType(activeReferenceEntity.type);
            const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));
            if (docSnap.exists() && docSnap.data().panelLinks) {
                existingData = docSnap.data().panelLinks[editingIndex];
            }
        } catch (e) { console.error("Erro ao carregar edi√ß√£o:", e); }
    }

    // 4. CONFIGURAR VISUAL
    if (type === 'link') {
        modalTitle.textContent = (editingIndex !== null ? "Editar Link" : "Novo Link");
        refsTabContent.style.display = 'block';
        if (addUrlBtn) addUrlBtn.style.display = 'block';
        
        titleInput.value = existingData ? existingData.title : "";
        if (existingData && existingData.urls) {
            Object.values(existingData.urls).forEach(url => addUrlField(url));
        } else { addUrlField(); }
    } else {
        modalTitle.textContent = (editingIndex !== null ? "Editar Codex" : "Novo Codex");
        codexTabContent.style.display = 'block';
        if (addCodexBtn) addCodexBtn.style.display = 'block';
        
        window.createCodexRow(existingData); 

        // Ativar p√≠lulas se estiver em modo edi√ß√£o
        if (existingData) {
            // Pequeno delay para o DOM criar a linha
            setTimeout(() => {
                const row = codexContainer.querySelector('.codex-row');
                if(row) {
                    if (existingData.manualYear) window.toggleManual(row.querySelector("button[onclick*='A']"), 'A', existingData.manualYear);
                    if (existingData.manualMonth) window.toggleManual(row.querySelector("button[onclick*='M']"), 'M', existingData.manualMonth);
                    if (existingData.capitulo) window.toggleManual(row.querySelector("button[onclick*='C']"), 'C', existingData.capitulo);
                    if (existingData.tempo) window.toggleManual(row.querySelector("button[onclick*='T']"), 'T', existingData.tempo);
                }
            }, 50);
        }
    }
    
    setTimeout(() => {
        if (type === 'link') titleInput.focus();
    }, 300);

    // 5. BOT√ÉO GRAVAR
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A processar...";

        try {
            let dataToSave = null;

            if (type === 'link') {
                const urlsMap = {};
                urlsContainer.querySelectorAll('input').forEach((inp, i) => {
                    if(inp.value.trim()) {
                        let val = inp.value.trim();
                        if(!val.startsWith('http')) val = 'https://' + val;
                        urlsMap[`url_${Date.now()}_${i}`] = val;
                    }
                });
                dataToSave = { type: 'link', title: titleInput.value.trim() || "Link", urls: urlsMap, createdAt: existingData?.createdAt || Date.now() };
            } 
            else {
                // --- L√ìGICA DE CODEX ---
                const row = codexContainer.querySelector('.codex-row');
                const rowData = getCodexDataFromRow(row);
                
                // 1. Obter Nome da Publica√ß√£o
                const valorBaixo = rowData.serie.toLowerCase().trim();
                const siglaMatch = valorBaixo.match(/^[a-z]+(?:-[0-9])?/);
                const sigla = siglaMatch ? siglaMatch[0] : "";
                // Usa o dicion√°rio SIGLAS_PUBLICACOES se existir, sen√£o usa o texto original
                const pubNome = (typeof SIGLAS_PUBLICACOES !== 'undefined' && SIGLAS_PUBLICACOES[sigla]) ? SIGLAS_PUBLICACOES[sigla] : rowData.serie;

                // 2. Obter Data Autom√°tica ou Manual
                const auto = parseSerieInfo(rowData.serie);
                const finalYear = rowData.manualYear || auto.ano || "";
                const finalMonth = rowData.manualMonth || auto.mes || "";
                const finalCap = rowData.capitulo || "";

                // 3. CONSTRUIR STRING VISUAL (AQUI EST√Å A CORRE√á√ÉO "de")
                let codiceShow = pubNome;
                
                if (finalMonth && finalYear) {
                    // MUDAN√áA: de '/' para ' de '
                    codiceShow += ` ${finalMonth} de ${finalYear}`; 
                } 
                else if (finalYear) {
                    codiceShow += ` ${finalYear}`;
                }
                
                if (finalCap) codiceShow += `, cap√≠tulo ${finalCap}`;
                if (rowData.paginas.length > 0) codiceShow += `, p√°gina ${rowData.paginas.join(', ')}`;
                if (rowData.paragrafos.length > 0) codiceShow += `, par√°grafo ${rowData.paragrafos.join(', ')}`;
                if (rowData.tempo) codiceShow += ` [${rowData.tempo}]`;

                dataToSave = { 
                    ...rowData, 
                    type: 'codex', 
                    publicacaonome: pubNome, 
                    codiceshow: codiceShow, // Guarda a string formatada correta
                    createdAt: existingData?.createdAt || Date.now() 
                };
            }

            // GRAVA√á√ÉO NO FIREBASE
            const collectionName = getCollectionFromType(activeReferenceEntity.type);
            const docRef = doc(db, collectionName, activeReferenceEntity.id);
            const docSnap = await getDoc(docRef);
            let currentLinks = docSnap.exists() ? (docSnap.data().panelLinks || []) : [];

            if (editingIndex !== null) currentLinks[editingIndex] = dataToSave;
            else currentLinks.push(dataToSave);

            await updateDoc(docRef, { panelLinks: currentLinks });
            modal.style.display = 'none';
            
            // Atualiza a vista da 4¬™ coluna
            renderPanelLinks(); 

        } catch (e) {
            console.error("Erro ao gravar:", e);
            alert("Erro ao gravar. Verifique a consola.");
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
        }
    };
};


window.movePanelLink = async function(index, direction) {
    // index: posi√ß√£o atual | direction: -1 (subir) ou 1 (descer)
    const targetIndex = index + direction;
    
    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) return;

        let links = docSnap.data().panelLinks || [];
        
        // Verifica se o movimento √© poss√≠vel
        if (targetIndex < 0 || targetIndex >= links.length) return;

        // TROCA DE POSI√á√ÉO (Destructuring swap)
        [links[index], links[targetIndex]] = [links[targetIndex], links[index]];

        // Grava o array inteiro novamente na ordem certa
        await updateDoc(docRef, { panelLinks: links });
        
        // Atualiza a visualiza√ß√£o
        renderPanelLinks();

    } catch (e) {
        console.error("Erro ao mover link no painel:", e);
    }
};



// --- L√ìGICA DO DOSSI√â ---

// --- VARI√ÅVEIS DE ESTADO DO DOSSI√â (Expostas para o m√≥dulo) ---
// Definimos como window. para que o HTML consiga ler e alterar
window.isDossieEditMode = false;
window.activeMicaId = null;

// 1. Tornar a fun√ß√£o de renderiza√ß√£o global
window.renderDossie = async function() {
    const container = document.getElementById('dossie-list-container');
    const titleEl = document.getElementById('dossie-view-title');
    const editBtn = document.getElementById('toggle-dossie-edit-btn');
    const editActions = document.getElementById('dossie-edit-actions');
    const backBtn = document.getElementById('mica-back-btn');
    const addBtn = document.getElementById('mica-add-content-btn');
    const bibleBtn = document.getElementById('mica-add-bible-btn');

    if (!container) return;

    // --- 1. SEGURAN√áA E LOADING ---
    const thisVersion = ++currentDossieVersion;

    if (container.innerHTML === "") {
        container.innerHTML = `<div class="spinner-container" style="margin-top: 50px; text-align:center;"><div class="spinner"></div></div>`;
    }
    
    container.innerHTML = ''; // Limpeza imediata

    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        container.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Selecione um t√≥pico ou vers√≠culo.</p>';
        return;
    }

    // Mostrar Spinner centralizado
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A organizar Dossi√©...</span>
        </div>`;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));
        
        // Aborta se o utilizador j√° mudou de contexto
        if (thisVersion !== currentDossieVersion) return;

        const dossieData = docSnap.exists() ? (docSnap.data().dossie || []) : [];
        editBtn.textContent = window.isDossieEditMode ? "Salvar" : "Editar";
        
        if (window.activeMicaId) {
            // ==========================================
            // MODO: CONTE√öDO DA MICA (CARDS)
            // ==========================================
            const mica = dossieData.find(m => m.id === window.activeMicaId);
            if (!mica) { window.activeMicaId = null; window.renderDossie(); return; }

            titleEl.textContent = mica.name;
            backBtn.style.display = 'block';
            addBtn.style.display = 'block';
            bibleBtn.style.display = 'block';
            editBtn.style.display = 'none'; 
            editActions.style.display = 'none';

            if (!mica.items || mica.items.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; font-style:italic; margin-top:40px;">Mica vazia. Clique em +Add ou +B√≠blia.</p>';
            } else {
                const tempFragment = document.createDocumentFragment();

                for (let idx = 0; idx < mica.items.length; idx++) {
                    const item = mica.items[idx];
                    const card = document.createElement('div');
                    card.className = 'board-card type-ref';
                    card.style.position = 'relative';

                    let rawSnippet = decodeURIComponent(item.snippet || '');
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = rawSnippet;

                    let icon = "üì¶"; let label = "Ref"; let color = "#95a5a6";
                    let isBible = rawSnippet.includes('bible-card-mica') || item.noteId === 'bible_internal';
                    let bodyText = ""; let titleText = "";

                    // L√≥gica de salto: Se tem nota f√≠sica e n√£o √© b√≠blia interna, pode saltar
                    const isJumpable = item.noteId && item.noteId !== 'bible_internal';

                    if (isBible) {
                        icon = "üìñ"; 
                        color = "#5d4037"; // Cor do bot√£o +B√≠blia
                        label = item.title || "B√≠blia";
                        titleText = item.noteName;
                        try {
                            const verseText = await fetchBibleRangeText(item.noteName);
                            if (thisVersion !== currentDossieVersion) return;
                            bodyText = verseText || 'Texto n√£o dispon√≠vel.';
                        } catch(e) { bodyText = "Erro ao carregar vers√≠culos."; }
                    } else {
                        // Notas normais
                        if (rawSnippet.includes('question-mode')) { icon = "üìó"; label = "Quest√£o"; color = "#2ecc71"; }
                        else if (rawSnippet.includes('free-mode')) { icon = "üìô"; label = "Contentor"; color = "#e67e22"; }
                        else if (rawSnippet.includes('toggle-section')) { icon = "‚òÇ"; label = "Sec√ß√£o"; color = "#9b59b6"; }
                        else if (rawSnippet.includes('idea-span')) { icon = "üí°"; label = "Ideia"; color = "#e74c3c"; }
                        else if (rawSnippet.includes('mini-note-wrapper')) { icon = "üìò"; label = "SubNota"; color = "#3498db"; }

                        const titleInput = tempDiv.querySelector('.mini-note-title-input');
                        const h2El = tempDiv.querySelector('h2');
                        const ideaEl = tempDiv.querySelector('.idea-span');
                        titleText = titleInput ? (titleInput.textContent || titleInput.value || titleInput.getAttribute('value')) : 
                                    (h2El ? h2El.textContent : (ideaEl ? ideaEl.textContent : "Texto da Nota"));

                        const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content') || tempDiv;
                        bodyText = contentDiv.innerText.replace(/\s+/g, ' ').trim();
                        if (bodyText.length > 400) bodyText = bodyText.substring(0, 400) + "...";
                    }

                    card.style.borderLeft = `4px solid ${color}`;
                    card.innerHTML = `
                        <!-- CONTROLOS: SETAS ‚ñ≤ ‚ñº E FECHAR X -->
                        <div style="position:absolute; top:8px; right:8px; display:flex; gap:3px; z-index:20; background:var(--panel-color); border-radius:5px; padding:2px;">
                            <button class="mica-nav-btn" onclick="window.moveMicaItem(${idx}, -1); event.stopPropagation();">‚ñ≤</button>
                            <button class="mica-nav-btn" onclick="window.moveMicaItem(${idx}, 1); event.stopPropagation();">‚ñº</button>
                            <button class="mica-nav-btn" onclick="window.removeItemFromMica(${idx}); event.stopPropagation();" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='var(--text-muted-color)'">√ó</button>
                        </div>

                        <div class="ref-card-content ${isBible ? 'bible-clickable-area' : ''}" 
                             ${isBible ? `onclick="this.parentElement.classList.toggle('bible-open')"` : ""}>
                            <div style="padding-left: 5px; margin-bottom: 2px;">
                                <div style="font-size:0.72em; font-weight:bold; color:${color}; text-transform:uppercase; margin-bottom:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">
                                    ${icon} ${label}
                                </div>
                                <div class="ref-title-text" 
                                     style="font-weight:bold; font-size:0.95em; color:var(--text-color); padding-right:75px; ${isJumpable ? 'cursor:pointer;' : ''}"
                                     onclick="${isJumpable ? `window.openNoteFromBoard('${item.noteId}', '${encodeURIComponent(titleText)}'); event.stopPropagation();` : ''}"
                                     onmouseover="${isJumpable ? "this.style.textDecoration='underline'" : ""}"
                                     onmouseout="this.style.textDecoration='none'">
                                    ${titleText}
                                </div>
                            </div>
                            
                            ${isBible ? 
                                `<div class="bible-collapsible-content">${bodyText}</div>` : 
                                `<div class="post-view-content" style="font-size:0.9em; color:var(--text-muted-color); padding-left: 8px; line-height:1.4; margin-top:8px; user-select:text;">${bodyText}</div>`
                            }
                        </div>`;
                    
                    tempFragment.appendChild(card);
                }
                
                if (thisVersion === currentDossieVersion) {
                    container.innerHTML = ''; 
                    container.appendChild(tempFragment);
                }
            }
        } else {
            // ==========================================
            // MODO: LISTA DE MICAS (PASTAS)
            // ==========================================
            titleEl.textContent = "Micas";
            backBtn.style.display = 'none';
            addBtn.style.display = 'none';
            bibleBtn.style.display = 'none';
            editBtn.style.display = 'block';
            editActions.style.display = (window.isDossieEditMode) ? 'flex' : 'none';

            if (dossieData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Nenhuma mica criada.</p>';
            } else {
                const listFragment = document.createDocumentFragment();
                dossieData.forEach((mica) => {
                    const div = document.createElement('div');
div.className = 'mica-card';
div.style.borderLeft = `6px solid ${mica.color || '#95a5a6'}`;

// Mantemos o efeito visual de transi√ß√£o suave
div.style.transition = "transform 0.1s, opacity 0.1s";
div.style.padding = "10px 15px"; // Ajuste fino direto aqui para garantir que fique elegante

div.innerHTML = `
    <div style="pointer-events: none;"> 
        <strong style="color:var(--text-color); display:block; font-size: 1.05em;">${mica.name}</strong>
        ${mica.description ? `<p style="margin:2px 0 0 0; font-size:0.82em; color:var(--text-muted-color);">${mica.description}</p>` : ''}
    </div>
    ${window.isDossieEditMode ? `
       <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px; border-top:1px solid var(--border-color); padding-top:8px;">
        <button onclick="event.stopPropagation(); window.changeMicaColor(event, '${mica.id}')" style="font-size:12px; cursor:pointer;">üé®</button>
        <button onclick="event.stopPropagation(); window.moveMica('${mica.id}', -1)" style="font-size:12px; cursor:pointer;">‚Üë</button>
        <button onclick="event.stopPropagation(); window.moveMica('${mica.id}', 1)" style="font-size:12px; cursor:pointer;">‚Üì</button>
        <button onclick="event.stopPropagation(); window.deleteMica('${mica.id}')" style="color:#e74c3c; font-size:12px; cursor:pointer;">üóëÔ∏è</button>
    </div>
    ` : ''}`;

                   // --- O SEGREDO DA ABERTURA IMEDIATA ---
    // Evento de clique para abrir
div.onclick = (e) => {
    if (e.target.closest('button')) return;
    
    // Efeito visual de "apertar"
    div.style.transform = "scale(0.97)";
    div.style.opacity = "0.7";

    window.activeMicaId = mica.id;
    
    // Abertura r√°pida
    setTimeout(() => {
        window.renderDossie();
    }, 50);
};

    listFragment.appendChild(div);
});
                if (thisVersion === currentDossieVersion) {
                    container.innerHTML = '';
                    container.appendChild(listFragment);
                }
            }
        }
    } catch (error) {
        if (thisVersion === currentDossieVersion) {
            console.error("Erro no Dossi√©:", error);
            container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar dados.</p>';
        }
    }
};

// 2. Outras fun√ß√µes expostas globalmente
window.moveMica = async function(id, dir) {
    const col = getCollectionFromType(activeReferenceEntity.type);
    const docRef = doc(db, col, activeReferenceEntity.id);
    const snap = await getDoc(docRef);
    let dossie = snap.data().dossie || [];
    const idx = dossie.findIndex(m => m.id === id);
    const newIdx = idx + dir;
    if (newIdx >= 0 && newIdx < dossie.length) {
        [dossie[idx], dossie[newIdx]] = [dossie[newIdx], dossie[idx]];
        await updateDoc(docRef, { dossie });
        window.renderDossie();
    }
};

window.deleteMica = async function(id) {
    if (!confirm("Apagar esta Mica e todo o seu conte√∫do?")) return;
    const col = getCollectionFromType(activeReferenceEntity.type);
    const docRef = doc(db, col, activeReferenceEntity.id);
    const snap = await getDoc(docRef);
    const dossie = (snap.data().dossie || []).filter(m => m.id !== id);
    await updateDoc(docRef, { dossie });
    window.renderDossie();
};

window.removeItemFromMica = async function(itemIdx) {
    // Pedimos confirma√ß√£o apenas para evitar cliques acidentais
    if (!confirm("Remover esta cita√ß√£o do Dossi√©?")) return;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const snap = await getDoc(docRef);

        if (!snap.exists()) return;

        let dossie = snap.data().dossie || [];
        // Encontra a mica onde estamos atualmente
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica && mica.items) {
            // Remove o item pelo √≠ndice
            mica.items.splice(itemIdx, 1);

            // Grava o dossie atualizado de volta no documento da entidade
            await updateDoc(docRef, { dossie: dossie });
            
            // Recarrega a interface
            window.renderDossie();
        }
    } catch (e) {
        console.error("Erro ao remover item da mica:", e);
        alert("Erro ao remover item.");
    }
};

// 3. Listeners de bot√µes (IDs fixos)
document.getElementById('add-mica-btn').onclick = async () => {
    // 1. Pedir o nome da Mica (Usa o teu modal de input personalizado)
    const result = await showCustomInput("Nova Mica", "Ex: Promessas, Profecias...");
    
    if (result && result.name) {
        const { id, type, name } = activeReferenceEntity;
        const collectionName = getCollectionFromType(type);
        
        // Refer√™ncia para o documento (pode ser o ID hexadecimal ou o nome do vers√≠culo)
        let docRef = doc(db, collectionName, id);
        let docSnap = await getDoc(docRef);

        // --- AJUSTE PARA VERS√çCULOS NOVOS ---
        // Se o documento n√£o existe (comum em vers√≠culos acabados de abrir), criamos agora
        if (!docSnap.exists()) {
            // Se for vers√≠culo, o 'id' costuma ser o pr√≥prio nome (ex: "Jo√£o 3:16")
            // Criamos o registo privado para o utilizador poder ter o seu Dossi√™/Micas
            await setDoc(docRef, {
                nome: name,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                dossie: [] 
            }, { merge: true });
            
            // Recarrega o snapshot ap√≥s criar
            docSnap = await getDoc(docRef);
        }

        const dossie = docSnap.data().dossie || [];
        
        // 2. Adicionar a nova Mica ao array
        dossie.push({
            id: 'mica_' + Date.now(),
            name: result.name,
            description: result.description || '',
            color: '#95a5a6', // Cinza padr√£o
            items: []
        });
        
        // 3. Gravar de volta no Firebase
        await updateDoc(docRef, { dossie: dossie });
        
        // 4. Feedback visual e fechar teclado
        if (document.activeElement) document.activeElement.blur();
        window.renderDossie();
    }
};

document.getElementById('mica-back-btn').onclick = () => {
    window.activeMicaId = null;
    window.renderDossie();
};

// --- IMPORTANTE: Coloque estas fun√ß√µes no seu script debaixo das l√≥gicas de Mica ---

// ============================================================
// MOTOR DA B√çBLIA PARA O DOSSI√â (MICAS)
// ============================================================

// 1. A√á√ÉO AO CLICAR NO BOT√ÉO "+B√≠blia"
document.getElementById('mica-add-bible-btn').onclick = () => {
    const modal = document.getElementById('mica-bible-modal');
    const bookSelect = document.getElementById('bible-book-select');
    const chapterSelect = document.getElementById('bible-chapter-select');
    const container = document.getElementById('verse-inputs-container');
    const titleInput = document.getElementById('bible-card-title');

    if (!modal) return;

    // For√ßar o modal para o topo do body (evita ficar escondido)
    document.body.appendChild(modal);
    
    titleInput.value = "";
    container.innerHTML = "";
    
    // Preenche livros
    bookSelect.innerHTML = BIBLE_DATA.map(b => `<option value="${b.nome}">${b.nome}</option>`).join('');
    
    const updateVerseLimits = () => {
        const book = BIBLE_DATA.find(b => b.nome === bookSelect.value);
        chapterSelect.innerHTML = Array.from({length: book.caps}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
        container.innerHTML = "";
        window.addMicaVerseRow('single'); // Nome corrigido aqui
    };

    bookSelect.onchange = updateVerseLimits;
    chapterSelect.onchange = () => { 
        container.innerHTML = ""; 
        window.addMicaVerseRow('single'); // Nome corrigido aqui
    };

    // Inicializa os limites
    updateVerseLimits();

    // Ligar bot√µes internos do modal com nomes corrigidos
    document.getElementById('add-single-verse-btn').onclick = (e) => { 
        e.preventDefault(); 
        window.addMicaVerseRow('single'); 
    };
    document.getElementById('add-range-verse-btn').onclick = (e) => { 
        e.preventDefault(); 
        window.addMicaVerseRow('range'); 
    };

    // MOSTRAR MODAL
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
};

// 2. ATUALIZAR DROPDOWNS (CAP√çTULOS E LIMITES DE VERS√çCULOS)
function updateMicaBibleDropdowns() {
    const bookName = document.getElementById('bible-book-select').value;
    const chapterSelect = document.getElementById('bible-chapter-select');
    const book = BIBLE_DATA.find(b => b.nome === bookName);

    // Se o cap√≠tulo selecionado for maior que o novo livro permite, reseta para 1
    let currentCap = parseInt(chapterSelect.value) || 1;
    if (currentCap > book.caps) currentCap = 1;

    // Atualizar dropdown de cap√≠tulos
    chapterSelect.innerHTML = Array.from({length: book.caps}, (_, i) => 
        `<option value="${i+1}" ${i+1 === currentCap ? 'selected' : ''}>${i+1}</option>`
    ).join('');

    // Sempre que mudar Livro ou Cap√≠tulo, resetamos as linhas de vers√≠culos para evitar erros de limites
    const container = document.getElementById('verse-inputs-container');
    if (container.innerHTML !== "") {
        container.innerHTML = "";
        addVerseRow('single');
    }
}

// 3. ADICIONAR LINHA DE VERS√çCULO (Simples ou Intervalo)
window.addMicaVerseRow = (type) => {
    const container = document.getElementById('verse-inputs-container');
    const bookSelect = document.getElementById('bible-book-select');
    const chapterSelect = document.getElementById('bible-chapter-select');

    // Preparar as op√ß√µes de vers√≠culos
    const book = BIBLE_DATA.find(b => b.nome === bookSelect.value);
    const totalV = book.versiculos[parseInt(chapterSelect.value) - 1] || 50;
    const options = Array.from({length: totalV}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');

    // Pegamos na √∫ltima linha que est√° no container
    const lastRow = container.lastElementChild;

    // --- SE FOR INTERVALO: TRANSFORMAR A LINHA ATUAL SE ELA FOR SIMPLES ---
    if (type === 'range' && lastRow && lastRow.dataset.type === 'single') {
        console.log("üõ†Ô∏è Transformando linha atual em intervalo...");
        lastRow.dataset.type = 'range'; // Muda o estado para intervalo

        const separator = document.createElement('span');
        separator.textContent = '-';
        separator.style.padding = '0 4px';
        separator.style.color = 'var(--text-muted-color)';

        const selectEnd = document.createElement('select');
        selectEnd.className = 'codex-input-modern v-end';
        selectEnd.style.flex = '1';
        selectEnd.innerHTML = options;

        // Inserir ANTES do bot√£o de apagar (o √∫ltimo elemento da linha)
        const delBtn = lastRow.querySelector('button');
        lastRow.insertBefore(separator, delBtn);
        lastRow.insertBefore(selectEnd, delBtn);
        return; 
    }

    // --- CASO CONTR√ÅRIO: CRIAR LINHA NOVA (Normal) ---
    const row = document.createElement('div');
    row.className = 'verse-selection-row';
    row.style.cssText = "display:flex; align-items:center; gap:8px; margin-bottom:8px;";
    row.dataset.type = type;

    if (type === 'single') {
        row.innerHTML = `<select class="codex-input-modern v-start" style="flex:1">${options}</select>`;
    } else {
        row.innerHTML = `
            <select class="codex-input-modern v-start" style="flex:1">${options}</select>
            <span style="color:var(--text-muted-color);">-</span>
            <select class="codex-input-modern v-end" style="flex:1">${options}</select>
        `;
    }

    const delBtn = document.createElement('button');
    delBtn.innerHTML = '√ó';
    delBtn.style.cssText = "background:none; border:none; color:#e74c3c; cursor:pointer; font-size:22px; font-weight:bold; padding:0 5px;";
    delBtn.onclick = () => {
        if (container.querySelectorAll('.verse-selection-row').length > 1) row.remove();
    };

    row.appendChild(delBtn);
    container.appendChild(row);
};

// Ligar bot√µes de + e - do modal
document.getElementById('add-single-verse-btn').onclick = (e) => { e.preventDefault(); addVerseRow('single'); };
document.getElementById('add-range-verse-btn').onclick = (e) => { e.preventDefault(); addVerseRow('range'); };

// 4. GRAVAR: FIREBASE + 4¬™ COLUNA
document.getElementById('confirm-mica-bible-save').onclick = async () => {
    const book = document.getElementById('bible-book-select').value;
    const chapter = document.getElementById('bible-chapter-select').value;
    const title = document.getElementById('bible-card-title').value.trim();
    const rows = document.querySelectorAll('.verse-selection-row');
    const myUid = auth.currentUser.uid;

    let parts = [];
    rows.forEach(r => {
        const s = r.querySelector('.v-start').value;
        if (r.dataset.type === 'range') {
            const e = r.querySelector('.v-end').value;
            parts.push(s === e ? s : (parseInt(s) < parseInt(e) ? `${s}-${e}` : `${e}-${s}`));
        } else parts.push(s);
    });

    const fullName = `${book} ${chapter}:${parts.join(',')}`;

    try {
        // Verifica se j√° existe no Firebase (textosbiblicos)
        const q = query(collection(db, 'textosbiblicos'), where('userId', '==', myUid), where('nome', '==', fullName));
        const snap = await getDocs(q);
        if (snap.empty) {
            await addDoc(collection(db, 'textosbiblicos'), {
                nome: fullName, userId: myUid, createdAt: serverTimestamp(), referencias: {}
            });
        }

        // Adiciona ao Dossi√© da Mica ativa
        const col = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, col, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        const dossie = docSnap.data().dossie || [];
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica) {
            const bibleSnippet = `
                <div class="bible-card-mica" style="border-left: 4px solid #9b59b6; padding-left:10px;">
                    ${title ? `<div style="font-weight:bold; color:var(--accent-color); margin-bottom:4px;">${title}</div>` : ''}
                    <div style="font-size: 1.1em; color:var(--text-color);">üìú ${fullName}</div>
                </div>`;
            if (!mica.items) mica.items = [];
            mica.items.push({
                noteId: 'bible_internal', noteName: fullName, title: title, snippet: encodeURIComponent(bibleSnippet)
            });
            await updateDoc(docRef, { dossie });
            document.getElementById('mica-bible-modal').style.display = 'none';
            window.renderDossie(); // Atualiza a vista da Mica
        }
    } catch (e) { console.error(e); alert("Erro ao gravar."); }
};

async function renderUniversalTextSearch(name) {
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar notas...</span></div>';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        allCitationsResults = [];

        const wholeWordRegex = new RegExp(`\\b${escapeRegExp(name)}\\b`, 'i');
        const parser = new DOMParser();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const content = data.conteudo || "";
            let isProtected = (data.passe && data.passe.trim() !== "");
            if (isProtected && !appSettings.searchAnchorsInProtected) return;

            // 1. Verificamos se o nome aparece no texto bruto
            let hasTextMatch = wholeWordRegex.test(content);
            let hasCategoryMatch = false;

            // 2. Verificamos se existe alguma caixa com esta categoria anexada via ‚ö°
            const docHTML = parser.parseFromString(content, 'text/html');
            const boxes = docHTML.querySelectorAll('.mini-note-wrapper, details.toggle-section');
            
            boxes.forEach(box => {
                const boxLinksRaw = box.getAttribute('data-box-links');
                if (boxLinksRaw) {
                    try {
                        const boxData = JSON.parse(boxLinksRaw);
                        if (boxData.categories && Array.isArray(boxData.categories)) {
                            // Verifica match por ID ou por Nome
                            const match = boxData.categories.some(cat => 
                                (cat.id && cat.id === activeReferenceEntity.id) || 
                                (cat.name && cat.name.toLowerCase().trim() === name.toLowerCase().trim())
                            );
                            if (match) hasCategoryMatch = true;
                        }
                    } catch (e) { }
                }
            });

            // Se encontrou de alguma forma, preparamos o resultado
            if (hasTextMatch || hasCategoryMatch) {
                let finalSnippet = "";

                if (hasTextMatch) {
                    // Se existe no texto, gera o contexto normal (com marca√ß√£o azul)
                    finalSnippet = generateReferenceContext(content, name);
                } 
                
                // Se a fun√ß√£o de contexto falhou ou se s√≥ existe via Categoria
                if (!finalSnippet || finalSnippet.includes("Contexto n√£o encontrado")) {
                    if (hasCategoryMatch) {
                        finalSnippet = `<p style="font-style: italic; opacity: 0.8; color: var(--accent-color);">Est√° Anexado a uma Categoria...</p>`;
                    } else {
                        finalSnippet = `<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>`;
                    }
                }

                allCitationsResults.push({
                    id: docSnap.id,
                    name: data.nome,
                    isProtected: isProtected,
                    snippet: finalSnippet,
                    ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
                });
            }
        });

        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);
        window.renderCitationsPage(false);

    } catch (e) {
        console.error("Erro na busca universal:", e);
        listElement.innerHTML = '<li>Erro ao carregar cita√ß√µes.</li>';
    }
}

window.renderCitationsPage = function(append = false) {
    const listElement = document.getElementById('references-list');
    if (!listElement) return;

    // 1. Se n√£o for um "Carregar Mais", limpa a lista e reseta o √≠ndice
    if (!append) {
        listElement.innerHTML = '';
        currentCitationsPageIndex = 0;
    }

    // 2. Remove o bot√£o "Mostrar mais" antigo se ele existir para n√£o ficar duplicado
    const oldBtn = document.getElementById('load-more-citations-btn');
    if (oldBtn) oldBtn.remove();

    // 3. Caso n√£o existam resultados
    if (allCitationsResults.length === 0) {
        listElement.innerHTML = '<li style="padding:40px; color:#888; text-align:center; font-style:italic;">Nenhuma cita√ß√£o encontrada neste contexto.</li>';
        return;
    }

    // 4. Configura√ß√£o de Pagina√ß√£o
    const perPage = 10; // Mostra 10 de cada vez
    const start = currentCitationsPageIndex * perPage;
    const end = start + perPage;
    const pageItems = allCitationsResults.slice(start, end);

    // 5. Gerar os itens no DOM
    pageItems.forEach(item => {
        const details = document.createElement('details');
        details.className = 'reference-item';
        
        // Prote√ß√£o contra caracteres especiais para os atributos de clique
        const safeName = encodeURIComponent(item.name);
        const safeSnippet = encodeURIComponent(item.snippet);

        // O cabe√ßalho (Summary) cont√©m os bot√µes e o t√≠tulo
        details.innerHTML = `
            <summary>
                <div class="ref-item-header">
                    <!-- BOT√ÉO + (Adicionar ao Puzzle) -->
                    <button class="add-to-puzzle-btn" title="Adicionar ao Quadro" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${item.id}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                    
                    <!-- T√çTULO DA NOTA -->
                    <span class="ref-item-title">${item.isProtected ? 'üîí' : 'üìÑ'} ${item.name}</span>
                    
                    <!-- BOT√ÉO ‚ûî (Ir para a Nota com Highlight) -->
                    <button class="go-to-note-btn" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.handleGoToNote('${item.id}')" 
                            title="Ir para esta nota">‚ûî</button>
                </div>
            </summary>
            <!-- CONTE√öDO (Texto ao redor da palavra encontrada) -->
            <div class="reference-context">${item.snippet}</div>
        `;
        listElement.appendChild(details);
    });

    // 6. Criar bot√£o "Mostrar mais" se ainda sobrarem resultados no array global
    if (end < allCitationsResults.length) {
        currentCitationsPageIndex++;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-citations-btn';
        loadMoreBtn.style.cssText = "width: 100%; margin: 15px 0; padding: 12px; border: 1px dashed var(--accent-color); color: var(--accent-color); background: none; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 0.9em;";
        loadMoreBtn.textContent = `+ ver mais (${allCitationsResults.length - end} restantes)`;
        
        loadMoreBtn.onclick = () => window.renderCitationsPage(true);
        listElement.appendChild(loadMoreBtn);
    }
};

// --- FUN√á√ÉO DE APOIO PARA O SALTO INTELIGENTE ---
 window.handleGoToNote = async function(noteId) {
    const searchTerm = activeReferenceEntity ? activeReferenceEntity.name : null;

    // 1. No Mobile, fecha o painel para focar no Editor
    if (window.innerWidth <= 768) {
        hideReferencesPanel();
    }

    // 2. Verifica√ß√£o de grava√ß√£o antes de navegar
    navigateWithUnsavedCheck(async () => {
        // Mostra uma mensagem discreta no status
        const statusEl = document.getElementById('save-status-indicator');
        if(statusEl) statusEl.textContent = "A preparar pastas...";

        try {
            // --- L√ìGICA DE RECONSTRU√á√ÉO DE CAMINHO (Background) ---
            let currentId = null;
            const path = [];
            let safety = 0;

            // Primeiro, pegamos no pai da nota alvo
            const noteSnap = await getDoc(doc(db, 'pastas', noteId));
            if (noteSnap.exists()) {
                currentId = noteSnap.data().parentId;
            }

            // Sobe na √°rvore de pastas para criar o "rasto" (breadcrumbs)
            while (currentId && safety < 20) {
                const docSnap = await getDoc(doc(db, 'pastas', currentId));
                if (!docSnap.exists()) break;
                const data = docSnap.data();
                path.unshift({ id: docSnap.id, name: data.nome });
                currentId = data.parentId;
                safety++;
            }

            // --- A M√ÅGICA DO SEGUNDO PLANO ---
            if (currentTab === 'note') {
                // Se j√° estamos na aba Note, atualiza a lista √† esquerda agora
                navigationStack = path;
                updateNavigationView(true, noteId);
            } else {
                // Se estivermos em "Lists", n√£o mexemos no que o user est√° a ver.
                // Atualizamos apenas a MEM√ìRIA da aba Note.
                noteStackMemory = path;
                console.log("üìÇ Pastas da aba Note organizadas em segundo plano.");
            }

            // 3. Independentemente da aba da esquerda, abre a nota no Editor (Painel Direito)
            displayNote(noteId, null, searchTerm);

        } catch (error) {
            console.error("Erro no salto inteligente:", error);
        }
    });
};

async function fetchBibleRangeText(fullRef) {
    // Regex para separar Livro Cap√≠tulo:Vers√≠culos
    const match = fullRef.match(/(.+)\s(\d+):(.+)/);
    if (!match) return await fetchBibleText(fullRef);

    const book = match[1];
    const chapter = match[2];
    const versePart = match[3];
    let allTexts = [];

    // Lida com m√∫ltiplos segmentos (ex: 1-3, 5)
    const segments = versePart.split(',');

    for (const segment of segments) {
        if (segment.includes('-')) {
            // √â um intervalo (ex: 1-5)
            const [start, end] = segment.split('-').map(Number);
            for (let v = start; v <= end; v++) {
                const text = await fetchBibleText(`${book} ${chapter}:${v}`);
                if (text) allTexts.push(text.trim());
            }
        } else {
            // √â um vers√≠culo √∫nico
            const text = await fetchBibleText(`${book} ${chapter}:${segment.trim()}`);
            if (text) allTexts.push(text.trim());
        }
    }

    return allTexts.length > 0 ? allTexts.join(' ') : null;
}

// --- L√ìGICA DE REORDENA√á√ÉO DO DOSSI√â ---
const dossieContainer = document.getElementById('dossie-list-container');



// --- L√ìGICA DE MOVIMENTO POR BOT√ïES NO DOSSI√â ---
window.moveMicaItem = async function(oldIdx, direction) {
    const newIdx = oldIdx + direction;
    
    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) return;

        let dossie = docSnap.data().dossie || [];
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica && mica.items) {
            // Verifica se o movimento √© v√°lido (dentro dos limites do array)
            if (newIdx < 0 || newIdx >= mica.items.length) return;

            // Troca os itens de lugar
            const item = mica.items[oldIdx];
            mica.items.splice(oldIdx, 1);
            mica.items.splice(newIdx, 0, item);

            // Grava no Firebase
            await updateDoc(docRef, { dossie: dossie });
            
            // Recarrega a vista imediatamente
            window.renderDossie();
        }
    } catch (e) {
        console.error("Erro ao mover item da mica:", e);
    }
};

// --- GATILHO DO BOT√ÉO EDITAR DO DOSSI√â ---
document.getElementById('toggle-dossie-edit-btn').addEventListener('click', () => {
    // 1. Inverte o valor (se era falso fica verdadeiro, e vice-versa)
    window.isDossieEditMode = !window.isDossieEditMode;
    
    // 2. Chama a fun√ß√£o de renderiza√ß√£o para mostrar as setas e o bot√£o "+ Micas"
    window.renderDossie();
});

// Vari√°vel para saber qual Mica estamos a pintar
let activeMicaIdForColor = null;

// 1. FUN√á√ÉO PARA ABRIR O POPUP DE CORES
window.changeMicaColor = function(event, micaId) {
    // 1. Para o evento aqui tamb√©m por seguran√ßa
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    activeMicaIdForColor = micaId;
    const popup = document.getElementById('mica-color-popup');
    if (!popup) return;

    // 2. Garante que o popup est√° no body para n√£o ser cortado pelo painel lateral
    document.body.appendChild(popup);

    // 3. Preenche as cores se estiver vazio
    if (popup.innerHTML === '') {
        popup.style.display = 'grid'; // Define como grid antes de calcular
        MICA_COLORS.forEach(color => {
            const dot = document.createElement('div');
            dot.className = 'mica-color-dot';
            dot.style.backgroundColor = color.hex;
            dot.title = color.name;
            dot.style.cursor = 'pointer';
            dot.onclick = (e) => {
                e.stopPropagation();
                window.applyColorToMica(color.hex);
            };
            popup.appendChild(dot);
        });
    }

    // 4. Posicionamento Inteligente (Fixed)
    const rect = event.target.getBoundingClientRect();
    popup.style.position = 'fixed';
    popup.style.display = 'grid';
    popup.style.zIndex = '10000000'; // Valor absurdo para ficar √† frente de tudo
    
    // Calcula a posi√ß√£o (ajusta se estiver muito perto do fundo da tela)
    let top = rect.bottom + 5;
    if (top + 150 > window.innerHeight) top = rect.top - 155;

    popup.style.top = top + 'px';
    popup.style.left = (rect.left - 60) + 'px';
};

// 2. FUN√á√ÉO PARA GRAVAR A COR NO FIREBASE
window.applyColorToMica = async function(hexColor) {
    if (!activeMicaIdForColor) return;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            let dossie = docSnap.data().dossie || [];
            const micaIndex = dossie.findIndex(m => m.id === activeMicaIdForColor);

            if (micaIndex > -1) {
                // Atualiza a cor no array
                dossie[micaIndex].color = hexColor;
                
                // Grava de volta no Firestore
                await updateDoc(docRef, { dossie: dossie });
                
                // Fecha o popup e atualiza a vista
                document.getElementById('mica-color-popup').style.display = 'none';
                window.renderDossie();
            }
        }
    } catch (e) {
        console.error("Erro ao mudar cor da mica:", e);
    }
};

// 3. FECHAR POPUP AO CLICAR FORA
document.addEventListener('click', (e) => {
    const popup = document.getElementById('mica-color-popup');
    if (popup && popup.style.display === 'grid' && !popup.contains(e.target) && !e.target.closest('button')) {
        popup.style.display = 'none';
    }
});


function loadPinsView() {
    // Limpeza de seguran√ßa para n√£o duplicar ouvintes
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }

    const listElement = document.getElementById('left-panel-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
    
    middlePanelTitle.textContent = "Selecione um Pin";
    middlePanelList.innerHTML = '<li style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Os detalhes aparecer√£o aqui ao clicar.</li>';

    const myUid = auth.currentUser.uid;
    
    const q = query(
        collection(db, 'pastas'), 
        where('userId', '==', myUid), 
        where('isPinned', '==', true),
        where('estado', '==', 'ativa'),
        orderBy('nome')
    );

    unsubscribeShared1 = onSnapshot(q, (snapshot) => {
        listElement.innerHTML = '';
        
        if (snapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Ainda n√£o tens Pins.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Atributos cruciais
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo); // O CSS usa isto para o √≠cone correto
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-pinned', 'true'); // O CSS usa isto para o Pin rosa
            
            // Adiciona a borda rosa lateral apenas nesta vista
            li.style.borderLeft = "4px solid #ff69b4";

            // REMOVIDO O ${icon} DAQUI PARA EVITAR DUPLICA√á√ÉO
            li.innerHTML = `<span>${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            // L√ìGICA DO SALTO
            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                middlePanelList.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

                navigateWithUnsavedCheck(async () => {
                    currentViewMode = 'local';
                    if (item.tipo === 'nota' || item.tipo === 'arquivo' || item.tipo === 'partilhado') {
                        await navigateToNoteSmart(item.id);
                    } else {
                        await reconstructFolderNavigation(item.id);
                    }

                    if (window.innerWidth <= 768) {
                        if (item.tipo === 'nota') document.body.classList.add('mobile-view-editor');
                        else document.body.classList.add('mobile-view-middle');
                    }
                });
            };

            listElement.appendChild(li);
        });
    });
}

// FUN√á√ÉO UNIVERSAL PARA RENOMEAR VIA POPUP
function openRenameModal(currentName, onConfirm) {
    const modal = document.getElementById('rename-modal');
    const input = document.getElementById('rename-input');
    const confirmBtn = document.getElementById('confirm-rename-btn');

    if (!modal) return;

    // Garante que o modal est√° na raiz do body para visibilidade total
    document.body.appendChild(modal);

    input.value = currentName;
    
    // For√ßa visibilidade e prioridade de camada
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.setProperty('z-index', '20000000', 'important');
    modal.style.setProperty('visibility', 'visible', 'important');
    modal.style.setProperty('opacity', '1', 'important');

    setTimeout(() => { 
        input.focus(); 
        input.select(); 
    }, 200);

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
            onConfirm(newName);
        }
        modal.style.display = 'none';
    };
    
    const cancelBtn = document.getElementById('cancel-rename-btn');
    if (cancelBtn) {
        cancelBtn.onclick = () => {
            modal.style.display = 'none';
        };
    }
}

// Fun√ß√£o para configurar e abrir o modal de cria√ß√£o de Temas/Subtemas
window.openCosmosCreator = function(targetType, parentId = null) {
    const modal = document.getElementById('cosmos-modal');
    if (!modal) return console.error("Modal #cosmos-modal n√£o encontrado!");

    // 1. MOVE PARA O BODY E DEFINE Z-INDEX ALTO
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 2. RESET DOS CAMPOS
    const nameInput = document.getElementById('cosmos-name-input');
    const descInput = document.getElementById('cosmos-desc-input');
    const title = document.getElementById('cosmos-modal-title');

    nameInput.value = "";
    descInput.value = "";
    selectedCosmosEmoji = targetType === 'cosmos' ? "üíº" : "üîπ"; 

    title.textContent = targetType === 'cosmos' ? "Novo Tema (Cosmos)" : "Novo Subtema";
    
    // Reset da sele√ß√£o de emojis visual
    document.querySelectorAll('#cosmos-emoji-grid .emoji-btn').forEach(b => b.classList.remove('selected'));

    setTimeout(() => nameInput.focus(), 100);

    // 3. RECONFIGURAR BOT√ÉO SALVAR (Clonar para limpar eventos)
    const saveBtn = document.getElementById('save-cosmos-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const nome = nameInput.value.trim();
        if (!nome) return alert("O nome √© obrigat√≥rio.");

        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A gravar...";

        try {
            const collectionName = targetType === 'cosmos' ? 'cosmos' : 'subcosmos';
            const data = {
                nome: nome,
                descricao: descInput.value.trim(),
                emoji: selectedCosmosEmoji,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            };

            if (targetType === 'subcosmos') data.cosmosId = parentId;

            await addDoc(collection(db, collectionName), data);

            modal.style.display = 'none';
            // Recarrega a lista lateral para o novo item aparecer
            if (typeof renderListCategoryItems === 'function') renderListCategoryItems('cosmos');
            
        } catch (e) {
            console.error("Erro ao criar item no Cosmos:", e);
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Criar";
        }
    };
};

function updateMobileFABVisibility() {
    // 1. Se n√£o for mobile (ecr√£ maior que 768px), n√£o faz nada
    if (window.innerWidth > 768) return;

    // 2. CONDI√á√ïES PARA MOSTRAR OS BOT√ïES:
    // - Tem de estar na aba 'Note'
    // - O modo tem de ser 'Local'
    // - N√£o pode estar dentro de nenhuma pasta (pilha de navega√ß√£o vazia)
    // - N√£o pode estar dentro de uma Superpasta (ID de isolamento nulo)
    const isLocalRoot = (currentTab === 'note') && 
                        (currentViewMode === 'local') && 
                        (navigationStack.length === 0) &&
                        (!SUPERFOLDER_ID);

    // 3. Aplica a classe ao body para o CSS mostrar/esconder
    if (isLocalRoot) {
        document.body.classList.add('show-fab');
    } else {
        document.body.classList.remove('show-fab');
    }
}

// Listener para sele√ß√£o de emojis no modal do Cosmos
document.getElementById('cosmos-emoji-grid').addEventListener('click', (e) => {
    const btn = e.target.closest('.emoji-btn');
    if (!btn || btn.id === 'custom-emoji-btn') return;

    const emoji = btn.dataset.emoji;
    if (emoji) {
        selectedCosmosEmoji = emoji;

        // 1. Remove a classe 'selected' de todos os bot√µes da grelha
        document.querySelectorAll('#cosmos-emoji-grid .emoji-btn').forEach(b => {
            b.classList.remove('selected');
        });

        // 2. Adiciona a classe ao bot√£o atual
        btn.classList.add('selected');
    }
});

// Fun√ß√£o auxiliar para quebrar a string de pesquisa em termos (considerando aspas ou espa√ßos)
function parseSearchQuery(query) {
    const terms = [];
    // Esta regex captura o que est√° entre aspas OU palavras soltas
    const regex = /"([^"]+)"|(\S+)/g;
    let match;

    while ((match = regex.exec(query)) !== null) {
        if (match[1]) {
            // Termo entre aspas (Exato)
            terms.push({ text: match[1], exact: true });
        } else if (match[2]) {
            // Termo solto (Abrangente)
            terms.push({ text: match[2], exact: false });
        }
    }
    return terms;
}

// ============================================================
// GEST√ÉO INTEGRAL DE GAVET√ïES (ARQUIVO) - VERS√ÉO CORRIGIDA
// ============================================================

// 1. FUN√á√ÉO MESTRE PARA ABRIR O MODAL DE CRIA√á√ÉO
function openCreateDrawerModal() {
    console.log("%c[GAVET√ÉO] üü¶ Iniciando Abertura Blindada...", "color: #3498db; font-weight: bold;");
    
    const modal = document.getElementById('create-drawer-modal');
    if (!modal) {
        console.error("ERRO: O elemento 'create-drawer-modal' n√£o existe no HTML!");
        return;
    }

    // --- TRUQUE MESTRE: MOVER O MODAL PARA O BODY ---
    // Isto retira o modal de dentro de qualquer div escondida e p√µe-no na raiz do site
    document.body.appendChild(modal);

    // Limpeza de campos
    document.getElementById('new-drawer-name').value = '';
    document.getElementById('new-drawer-desc').value = '';

    // --- FOR√áAR CSS ABSOLUTO VIA JS (Ignora o ficheiro CSS) ---
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.85) !important;
        z-index: 1000000 !important;
        align-items: center !important;
        justify-content: center !important;
    `;

    console.log("%c[GAVET√ÉO] Modal movido para o <body> e estilos for√ßados.", "color: #3498db;");

    setTimeout(() => {
        const input = document.getElementById('new-drawer-name');
        if(input) {
            input.focus();
            console.log("%c[GAVET√ÉO] Teclado/Foco acionado.", "color: #3498db;");
        }
    }, 200);
}

// 2. CONFIGURA√á√ÉO DOS TRIGGERS (BOT√ïES)
function setupDrawerEventListeners() {
    console.log("%c[SISTEMA] Configurando listeners dos Gavet√µes...", "color: #95a5a6;");

    // Bot√£o das Abas
    const mainBtn = document.getElementById('create-drawer-trigger-btn');
    if (mainBtn) {
        console.log("%c[OK] Bot√£o '+ Gavet√£o' encontrado.", "color: #2ecc71;");
        mainBtn.onclick = (e) => {
            console.log("%c[CLIQUE] Bot√£o '+ Gavet√£o' (Abas) clicado!", "background: #2ecc71; color: white; padding: 2px 5px;");
            e.preventDefault();
            window.postToAssignDrawer = null;
            openCreateDrawerModal();
        };
    } else {
        console.warn("%c[AVISO] Bot√£o 'create-drawer-trigger-btn' n√£o existe nesta vista ainda.", "color: #f39c12;");
    }

    // Bot√£o "+" dentro do seletor
    const popupBtn = document.getElementById('open-create-drawer-btn');
    if (popupBtn) {
        popupBtn.onclick = (e) => {
            console.log("%c[CLIQUE] Bot√£o '+' (Popup) clicado!", "background: #3498db; color: white; padding: 2px 5px;");
            e.preventDefault();
            e.stopPropagation();
            openCreateDrawerModal();
        };
    }
}

// Executa a configura√ß√£o inicial e tenta re-vincular quando muda de aba
setupDrawerEventListeners();

// 3. GRAVA√á√ÉO NO FIREBASE (Bot√£o "Criar")
const confirmCreateBtn = document.getElementById('confirm-create-drawer');
if (confirmCreateBtn) {
    confirmCreateBtn.onclick = async () => {
        console.log("%c[GAVET√ÉO] üíæ Tentando salvar novo Gavet√£o...", "color: #27ae60; font-weight: bold;");
        
        const name = document.getElementById('new-drawer-name').value.trim();
        const desc = document.getElementById('new-drawer-desc').value.trim();
        
        if(!name) {
            console.warn("%c[VALIDA√á√ÉO] Nome vazio. Abortando.", "color: #f39c12;");
            alert("O nome √© obrigat√≥rio.");
            return;
        }

        if (!currentArchiveId) {
            console.error("%c[ERRO] currentArchiveId est√° vazio!", "color: red;");
            alert("Erro: ID do Arquivo n√£o detetado.");
            return;
        }

        confirmCreateBtn.disabled = true;
        confirmCreateBtn.textContent = "A gravar...";

        try {
            const qDrawers = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId));
            const snap = await getDocs(qDrawers);
            
            await addDoc(collection(db, 'gavetoes'), {
                arquivoId: currentArchiveId,
                userId: auth.currentUser.uid,
                nome: name,
                descricao: desc,
                posts: [],
                ordem: snap.size,
                viewMode: 'full',
                createdAt: serverTimestamp()
            });

            console.log("%c[SUCESSO] Gavet√£o gravado no Firebase!", "color: #27ae60;");
            document.getElementById('create-drawer-modal').style.display = 'none';

            if (window.postToAssignDrawer) {
                window.openDrawerSelection(window.postToAssignDrawer);
            } else {
                renderArchiveFeed();
            }
        } catch (e) {
            console.error("Erro na grava√ß√£o:", e);
        } finally {
            confirmCreateBtn.disabled = false;
            confirmCreateBtn.textContent = "Criar";
        }
    };
}

// 4. SELECIONAR GAVET√ÉO (O resto da l√≥gica mant√©m-se est√°vel)
window.openDrawerSelection = async (postId) => {
    window.postToAssignDrawer = postId; 
    const modal = document.getElementById('drawer-selection-modal');
    const list = document.getElementById('drawer-list-select');
    list.innerHTML = '<li style="padding:10px; text-align:center;">A carregar...</li>';
    modal.style.display = 'flex';
    try {
        const q = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId), orderBy('ordem', 'asc'));
        const snap = await getDocs(q);
        list.innerHTML = '';
        if (snap.empty) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Sem gavet√µes.</li>';
            return;
        }
        snap.forEach(docSnap => {
            const drawer = { id: docSnap.id, ...docSnap.data() };
            const isInside = drawer.posts && drawer.posts.includes(postId);
            const li = document.createElement('li');
            li.className = 'list-item';
            if (isInside) { li.style.backgroundColor = 'rgba(46, 204, 113, 0.1)'; li.style.borderLeft = '4px solid #2ecc71'; }
            li.innerHTML = `<span>üìÇ ${drawer.nome}</span><span style="color:#2ecc71; font-weight:bold;">${isInside ? '‚úì' : ''}</span>`;
            li.onclick = () => togglePostInDrawer(drawer.id, isInside);
            list.appendChild(li);
        });
    } catch (e) { console.error(e); }
};



window.openGaveta = async (gavetaId) => {
    console.group(`üìÇ [SISTEMA] Abrindo Gaveta: ${gavetaId}`);
    
    // 1. AUTO-SAVE: Se houver algum post em edi√ß√£o (na Prateleira ou noutra Gaveta), 
    // guarda-o e liberta o cadeado antes de mudar de vista.
    const idToSave = activeEditingPostId || window.activeEditingPostId;
    if (idToSave) {
        console.log("üíæ [AUTO-SAVE] Gravando post ativo antes de entrar na gaveta...");
        await window.saveArchivePost(idToSave);
    }

    try {
        // 2. BUSCAR DADOS: Obt√©m os dados da gaveta diretamente do Firestore
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docSnap = await getDoc(doc(db, 'gavetas', gavetaId));
        
        if (docSnap.exists()) {
            const data = docSnap.data();

            // 3. DEFINIR ESTADO GLOBAL: Define o ID no window para que o bot√£o "Voltar"
            // e os scripts de movimento saibam onde estamos.
            window.activeGavetaId = gavetaId;
            
            // 4. PREPARAR DADOS DE VISTA: Carrega os posts e metadados
            window.activeGavetaData = { 
                id: docSnap.id, 
                ...data,
                // Define o modo 'titles' (acorde√£o) como padr√£o ao entrar
                viewMode: data.viewMode || 'titles' 
            };
            
            console.log("‚úÖ Gaveta carregada. Modo atual:", window.activeGavetaData.viewMode);

            // 5. RENDERIZAR: Chama a fun√ß√£o global que desenha o feed
            if (typeof window.renderArchiveFeed === 'function') {
                window.renderArchiveFeed();
            } else {
                console.error("‚ùå Erro: window.renderArchiveFeed n√£o encontrada no escopo global.");
            }

        } else {
            console.error("‚ùå Erro: O documento da gaveta n√£o existe no Firebase.");
        }
    } catch (e) {
        console.error("‚ùå Erro ao abrir gaveta:", e);
        alert("Erro ao aceder √† pasta. Verifique a sua liga√ß√£o.");
    }
    console.groupEnd();
};

function renderOpenedGavetaView(feed, allPosts) {
    if (!window.activeGavetaData) return;

    const viewMode = window.activeGavetaData.viewMode || 'titles';
    const orderArray = window.activeGavetaData.posts || [];
    const sepMetadata = window.activeGavetaData.separatorData || {};
    const isFullView = (viewMode === 'full'); // üëÅÔ∏è modo completo
    
    feed.innerHTML = '';

    // --- CABE√áALHO ---
    const header = document.createElement('div');
    header.style.cssText = "display: flex; align-items: center; padding: 15px; background: var(--panel-color); border-radius: 8px; border-left: 5px solid var(--accent-color); margin-bottom: 20px;";
    header.innerHTML = `
        <button class="mini-btn" onclick="window.activeGavetaId=null; window.renderArchiveFeed();" style="margin-right: 15px;"> ‚Üê Voltar </button>
        <strong style="color: white; font-size: 1.1em;">üìÅ ${window.activeGavetaData.nome}</strong>
        <button onclick="window.toggleGavetaViewMode()" title="Alternar visualiza√ß√£o" 
                style="margin-left: auto; background: none; border: none; font-size: 20px; cursor: pointer; opacity: ${isFullView ? '1' : '0.4'};">
            ${isFullView ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
        </button>
    `;
    feed.appendChild(header);

    if (orderArray.length === 0) {
        feed.innerHTML += `<div style="text-align:center; padding:50px; color:#888; font-style:italic;">Gaveta vazia.</div>`;
        return;
    }

    // --- LISTAGEM ---
    orderArray.forEach((id) => {
        if (id.startsWith('sep_')) {
            // --- RENDERIZAR SEPARADOR VERDE ---
            const info = sepMetadata[id] || { title: "Separador" };
            const sepDiv = document.createElement('div');
            sepDiv.className = 'archive-separator';
            
            // L√≥gica: S√≥ inclui a div 'drawer-controls' se for Full View (üëÅÔ∏è)
            const controlsHTML = isFullView ? `
                <div class="drawer-controls">
                    <button class="mini-btn" onclick="window.movePostInGaveta('${id}', -1)">‚Üë</button>
                    <button class="mini-btn" onclick="window.movePostInGaveta('${id}', 1)">‚Üì</button>
                    <button class="mini-btn" onclick="window.editSeparator('${id}', '${info.title}')">Editar</button>
                    <button class="mini-btn" style="color:#e74c3c" onclick="window.deleteSeparator('${id}')">√ó</button>
                </div>` : '';

            sepDiv.innerHTML = `
                <span class="separator-title"># ${info.title}</span>
                ${controlsHTML}
            `;
            feed.appendChild(sepDiv);

        } else {
            // --- RENDERIZAR POST ---
            const post = allPosts.find(p => p.id === id);
            if (post) {
                const postEl = createPostElement(post);
                const controls = postEl.querySelector('.post-controls');
                
                // Injetar controlos se for Full View, sen√£o limpa-os
                if (controls) {
                    if (isFullView) {
                        controls.innerHTML = `
                            <button class="mini-btn" onclick="window.movePostInGaveta('${post.id}', -1)">‚Üë</button>
                            <button class="mini-btn" onclick="window.movePostInGaveta('${post.id}', 1)">‚Üì</button>
                            <button class="mini-btn" onclick="window.editArchivePost('${post.id}')">Editar</button>
                            <button class="mini-btn" title="Remover da Gaveta" onclick="window.togglePostInGaveta('${window.activeGavetaId}', true, '${post.id}')">√ó</button>
                        `;
                        controls.style.display = 'flex';
                        controls.style.opacity = '1';
                    } else {
                        controls.style.display = 'none';
                    }
                }

                // Modo T√≠tulos (Acorde√£o)
                if (!isFullView) {
                    const content = postEl.querySelector('.post-view-content');
                    const footer = postEl.querySelector('.post-footer');
                    if (content) content.style.display = 'none';
                    if (footer) footer.style.display = 'none';
                    
                    postEl.style.cursor = "pointer";
                    postEl.onclick = (e) => {
                        if (e.target.closest('button')) return;
                        const isCollapsed = content.style.display === 'none';
                        content.style.display = isCollapsed ? 'block' : 'none';
                        footer.style.display = isCollapsed ? 'flex' : 'none';
                        postEl.style.backgroundColor = isCollapsed ? "rgba(255,255,255,0.03)" : "";
                    };
                }
                feed.appendChild(postEl);
            }
        }
    });
}

 





window.togglePostInGaveta = async (gavetaId, alreadyPresent) => {
    if (!window.postToAssignDrawer) return;
    
    try {
        const { arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', gavetaId);
        
        if (alreadyPresent) {
            await updateDoc(gavetaRef, { posts: arrayRemove(window.postToAssignDrawer) });
        } else {
            await updateDoc(gavetaRef, { posts: arrayUnion(window.postToAssignDrawer) });
        }
        
        // --- FEEDBACK IMEDIATO ---
        // Recarrega a lista do popup para o utilizador ver o "visto" (‚úì)
        window.openGavetaSelection(window.postToAssignDrawer);
        
        // Se estivermos a ver a gaveta aberta ao fundo, atualiza a vista para o post aparecer/sumir
        if (window.activeGavetaId) renderArchiveFeed();
        
    } catch (e) {
        console.error("Erro ao vincular post √† gaveta:", e);
    }
};

// --- FUN√á√ïES GLOBAIS PARA O ARQUIVO ---

// 1. Apagar Gavet√£o (O "x" pequeno no canto)
window.deleteGavetao = async (id) => {
    const confirmed = await showConfirmation("Eliminar Gavet√£o?", "Isto apagar√° o Gavet√£o e todas as Gavetas dentro dele.");
    if(confirmed) {
        try {
            // Apaga as gavetas ligadas a ele
            const q = query(collection(db, 'gavetas'), where('gavetaoId', '==', id));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            
            // Apaga o gavet√£o
            batch.delete(doc(db, 'gavetoes', id));
            await batch.commit();
            renderArchiveFeed();
        } catch (e) { console.error("Erro ao apagar:", e); }
    }
};


// 3. Abrir o Modal de Criar Gaveta (O bot√£o "+")
window.openCreateGavetaModal = (gavetaoId) => {
    console.log(`%c[GAVETA] ‚ûï Abrindo modal para o Gavet√£o: ${gavetaoId}`, "color: #3498db; font-weight: bold;");

    const modal = document.getElementById('create-gaveta-modal');
    
    if (!modal) {
        console.error("‚ùå ERRO: Elemento 'create-gaveta-modal' n√£o encontrado!");
        return;
    }

    // 1. Mover o modal para o body para evitar que fique preso em divs com scroll ou z-index baixo
    document.body.appendChild(modal);

    // 2. Limpar campos
    document.getElementById('new-gaveta-name').value = "";
    document.getElementById('new-gaveta-desc').value = "";

    // 3. For√ßar visibilidade m√°xima via JS (ignora conflitos de CSS)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.85) !important;
        z-index: 2000000 !important; 
        align-items: center !important;
        justify-content: center !important;
    `;

    // 4. Configurar o bot√£o de confirma√ß√£o
    const confirmBtn = document.getElementById('confirm-create-gaveta');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        const name = document.getElementById('new-gaveta-name').value.trim();
        const desc = document.getElementById('new-gaveta-desc').value.trim();

        if (!name) return alert("O nome da gaveta √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A criar...";

        try {
            // Conta quantas gavetas j√° existem para definir a ordem
            const q = query(collection(db, 'gavetas'), where('gavetaoId', '==', gavetaoId));
            const snap = await getDocs(q);

            await addDoc(collection(db, 'gavetas'), {
                gavetaoId: gavetaoId,
                nome: name,
                descricao: desc,
                posts: [],
                ordem: snap.size,
                 viewMode: 'titles', 
                viewMode: 'full',
                createdAt: Date.now()
            });

            console.log("‚úÖ Gaveta criada com sucesso!");
            modal.style.display = 'none';
            renderArchiveFeed(); // Recarrega a lista para mostrar a nova pasta
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar gaveta:", error);
            alert("Erro ao salvar no banco de dados.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Criar";
        }
    };
    
    // Focar no input ap√≥s abrir
    setTimeout(() => {
        const input = document.getElementById('new-gaveta-name');
        if(input) input.focus();
    }, 200);
};



// 5. Apagar Gaveta interna
window.deleteGaveta = async (id) => {
    if (confirm("Apagar esta gaveta?")) {
        await deleteDoc(doc(db, 'gavetas', id));
        renderArchiveFeed();
    }
};

window.moveGavetao = async (drawerId, direction) => {
    console.log("üì¶ Movendo Gavet√£o:", drawerId);
    try {
        const q = query(
            collection(db, 'gavetoes'), 
            where('arquivoId', '==', currentArchiveId), 
            orderBy('ordem', 'asc')
        );
        const snap = await getDocs(q);
        const drawers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const index = drawers.findIndex(d => d.id === drawerId);
        const targetIndex = index + direction;

        if (targetIndex >= 0 && targetIndex < drawers.length) {
            const batch = writeBatch(db);
            batch.update(doc(db, 'gavetoes', drawers[index].id), { ordem: targetIndex });
            batch.update(doc(db, 'gavetoes', drawers[targetIndex].id), { ordem: index });
            await batch.commit();
            renderArchiveFeed();
        }
    } catch (e) {
        console.error("Erro ao mover gavet√£o:", e);
    }
};



window.openGavetaSelection = async (postId) => {
    console.log("üìÇ [SISTEMA] Abrindo seletor para:", postId);
    
    const modal = document.getElementById('drawer-selection-modal');
    const list = document.getElementById('drawer-list-select');
    const modalTitle = modal.querySelector('h3');
    
    if (!modal || !list) return;

    window.postToAssignDrawer = postId; 
    modalTitle.textContent = "Guardar em qual Gaveta?";
    list.innerHTML = '<li style="padding:20px; text-align:center;"><div class="spinner"></div><p>A organizar...</p></li>';
    
    modal.style.display = 'flex';
    modal.style.zIndex = "1000000"; 
    document.body.appendChild(modal);

    try {
        const arcId = typeof currentArchiveId !== 'undefined' ? currentArchiveId : null;
        if (!arcId) return;

        const qGavetoes = query(
            collection(db, 'gavetoes'), 
            where('arquivoId', '==', arcId), 
            orderBy('ordem', 'asc')
        );
        const snapGavetoes = await getDocs(qGavetoes);
        
        list.innerHTML = '';

        if (snapGavetoes.empty) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Crie um Gavet√£o primeiro.</li>';
            return;
        }

        for (const gDoc of snapGavetoes.docs) {
            const gavetao = gDoc.data();
            
            const header = document.createElement('div');
            header.className = 'modal-gavetao-header';
            header.innerHTML = `üì¶ GAVET√ÉO: ${gavetao.nome}`;
            list.appendChild(header);

            const groupContainer = document.createElement('div');
            groupContainer.className = 'modal-gavetas-group';

            const qGavetas = query(
                collection(db, 'gavetas'), 
                where('gavetaoId', '==', gDoc.id), 
                orderBy('ordem', 'asc')
            );
            const snapGavetas = await getDocs(qGavetas);

            if (snapGavetas.empty) {
                groupContainer.innerHTML = '<small style="color:#555; padding:5px; font-style:italic;">(Vazio)</small>';
            } else {
                snapGavetas.forEach(gavDoc => {
                    const gaveta = { id: gavDoc.id, ...gavDoc.data() };
                    const isInside = (gaveta.posts || []).includes(postId);
                    
                    const li = document.createElement('li');
                    li.className = 'list-item gaveta-interna';
                    
                    // Reset de estilos para garantir alinhamento √† esquerda
                    li.style.display = "flex";
                    li.style.alignItems = "center";
                    li.style.justifyContent = "flex-start"; // For√ßa in√≠cio √† esquerda
                    li.style.textAlign = "left";
                    li.style.padding = "10px 12px";

                    if (isInside) {
                        li.style.borderLeft = '4px solid #2ecc71';
                        li.style.backgroundColor = 'rgba(46, 204, 113, 0.15)'; 
                    }

                    // Estrutura simplificada e colada √† esquerda
                    li.innerHTML = `
                        <span style="font-size:1.2em; margin-right:10px; flex-shrink:0;">üìÅ</span> 
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white; font-size:0.95em;">
                            ${gaveta.nome}
                        </span>
                    `;
                    
                    li.onclick = (e) => {
                        e.stopPropagation();
                        window.togglePostInGaveta(gaveta.id, isInside);
                    };
                    
                    groupContainer.appendChild(li);
                });
            }
            list.appendChild(groupContainer);
        }
    } catch (e) {
        console.error(e);
        list.innerHTML = '<li style="padding:10px; color:red;">Erro ao carregar dados.</li>';
    }
};

// Localiza o bot√£o + dentro do modal de sele√ß√£o
const manageBtn = document.getElementById('manage-topics-btn');

if (manageBtn) {
    // Clonamos para limpar qualquer listener antigo e garantir uma l√≥gica limpa
    const newManageBtn = manageBtn.cloneNode(true);
    manageBtn.parentNode.replaceChild(newManageBtn, manageBtn);

    newManageBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // 1. Descobrir qual a aba ativa neste momento
        const activeTabBtn = document.querySelector('#topics-modal-tabs button.active');
        const activeTab = activeTabBtn ? activeTabBtn.dataset.tab : 'topics';

        // --- CASO A: ABA √ÇNCORAS (‚öì) ---
        if (activeTab === 'anchors') {
            console.log("‚öì Bot√£o + clicado: Abrindo criador de √Çncoras...");
            
            // Simula o clique no bot√£o que j√° configur√°mos para abrir o modal de cria√ß√£o
            // (Ou pode chamar a l√≥gica de abrir o modal diretamente aqui)
            const createAnchorModal = document.getElementById('create-anchor-modal');
            const nameInput = document.getElementById('new-anchor-name');
            const descInput = document.getElementById('new-anchor-desc');

            if (createAnchorModal) {
                // Prepara o modal
                nameInput.value = '';
                descInput.value = '';
                
                document.body.appendChild(createAnchorModal);
                createAnchorModal.style.setProperty('display', 'flex', 'important');
                createAnchorModal.style.zIndex = "9000000"; // Acima do gestor
                createAnchorModal.style.visibility = "visible";
                createAnchorModal.style.opacity = "1";
                
                setTimeout(() => nameInput.focus(), 100);
            }
        } 
        
        // --- CASO B: ABA T√ìPICOS (üìë) ---
        else {
            console.log("üìë Bot√£o + clicado: Abrindo gest√£o de T√≥picos...");
            
            const manageModal = document.getElementById('manage-topics-modal');
            if (!manageModal) return;

            document.body.appendChild(manageModal);
            manageModal.style.setProperty('display', 'flex', 'important');
            manageModal.style.zIndex = "9000000"; 
            manageModal.style.visibility = "visible";
            manageModal.style.opacity = "1";

            // Reseta o estado
            activeTopicIdForManagement = null;
            if (typeof renderManageTopicsList === 'function') renderManageTopicsList();
            
            const subBtn = document.getElementById('create-new-subtopic-btn');
            if(subBtn) subBtn.style.display = 'none';
            
            const subList = document.getElementById('subtopics-list-manage');
            if(subList) subList.innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico para ver os subt√≥picos.</li>';
        }
    });
}

const closeManageBtn = document.getElementById('close-manage-topics-btn');
if (closeManageBtn) {
    closeManageBtn.onclick = () => {
        document.getElementById('manage-topics-modal').style.display = 'none';
        // Atualiza a lista do primeiro modal caso tenhamos criado algo novo
        renderTopicsSelectionList(); 
    };
}


// A. BOT√ÉO CRIAR NOVO T√ìPICO
const createTopicBtn = document.getElementById('create-new-topic-btn');
if (createTopicBtn) {
    const newBtn = createTopicBtn.cloneNode(true);
    createTopicBtn.parentNode.replaceChild(newBtn, createTopicBtn);

    newBtn.addEventListener('click', async () => {
        console.log("üÜï Solicitando input para novo T√≥pico...");
        const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina, Estudo Pessoal...");
        
        if (result && result.name) {
            try {
                await addDoc(collection(db, 'topicos'), {
                    nome: result.name,
                    descricao: result.description,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                renderManageTopicsList(); // Atualiza a lista
            } catch (e) {
                console.error("Erro ao salvar t√≥pico:", e);
            }
        }
    });
}

// B. BOT√ÉO CRIAR NOVO SUBT√ìPICO
const createSubtopicBtn = document.getElementById('create-new-subtopic-btn');
if (createSubtopicBtn) {
    const newSubBtn = createSubtopicBtn.cloneNode(true);
    createSubtopicBtn.parentNode.replaceChild(newSubBtn, createSubtopicBtn);

    newSubBtn.addEventListener('click', async () => {
        if (!activeTopicIdForManagement) return alert("Selecione um t√≥pico pai primeiro.");

        const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo, Ora√ß√£o...");
        
        if (result && result.name) {
            try {
                await addDoc(collection(db, 'subtopicos'), {
                    nome: result.name,
                    descricao: result.description,
                    topicId: activeTopicIdForManagement,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                renderManageSubtopicsList(activeTopicIdForManagement); // Atualiza a lista da direita
            } catch (e) {
                console.error("Erro ao salvar subt√≥pico:", e);
            }
        }
    });
}

// No ouvinte de cliques do editor:
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('button[data-action="highlight-color"]');
    
    if (colorBtn) {
        e.preventDefault(); 
        e.stopPropagation(); // Impede o editor de fechar o popup
        
        const wrapper = colorBtn.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
        if (wrapper) {
            openHighlightPopup(wrapper);
        }
        return; // Sai da fun√ß√£o para n√£o disparar outros cliques
    }
});

// No ouvinte de cliques do editor (ou arquivo):
noteContentEditor.addEventListener('click', (e) => {
    const appendBtn = e.target.closest('button[data-action="append-mini-note"]');
    
    if (appendBtn) {
        e.preventDefault(); 
        e.stopPropagation(); 
        
        // --- CORRE√á√ÉO AQUI ---
        // Agora procura por ambos os tipos de wrapper
        const wrapper = appendBtn.closest('.mini-note-wrapper, .redator-wrapper');
        
        if (wrapper) {
            // Captura o HTML da caixa
            htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
            openAppendModal();
        } else {
            console.error("‚ùå Erro: Wrapper n√£o encontrado (nem .mini-note-wrapper nem .redator-wrapper).");
        }
        return;
    }
});


const miniNoteShareToggle = document.getElementById('mini-note-share-toggle');
if (miniNoteShareToggle) {
    miniNoteShareToggle.onchange = () => {
        if (activeWrapperForSharing) {
            const newState = miniNoteShareToggle.checked;
            
            // 1. Atualiza o atributo no HTML da caixa
            activeWrapperForSharing.setAttribute('data-shared', newState);
            
            // 2. Atualiza o visual do bot√£o (mudar √≠cone ou cor)
            updateSharingButtonState(activeWrapperForSharing);
            
            console.log(`‚úÖ Partilha da caixa ${activeWrapperForSharing.id} definida como: ${newState}`);
            
            // 3. Grava a nota
            saveNote(true);
        }
    };
}

const customEmojiBtn = document.getElementById('custom-emoji-btn');
if (customEmojiBtn) {
    customEmojiBtn.onclick = () => {
        const modal = document.getElementById('custom-emoji-modal');
        if (!modal) return;

        // MOVE PARA O BODY E Z-INDEX M√ÅXIMO (Para ficar √† frente do modal anterior)
        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "9000000";

        const input = document.getElementById('custom-emoji-input');
        const confirmBtn = document.getElementById('confirm-custom-emoji-btn');

        input.value = "";
        setTimeout(() => input.focus(), 100);

        confirmBtn.onclick = () => {
            const val = input.value.trim();
            if (val) {
                selectedCosmosEmoji = val;
                // Atualiza visualmente o bot√£o do Cosmos para mostrar o emoji escolhido
                customEmojiBtn.textContent = val;
                customEmojiBtn.classList.add('selected');
            }
            modal.style.display = 'none';
        };
    };
}


function openCosmosEditPopup(id, currentName, currentEmoji, type) {
    const modal = document.getElementById('custom-emoji-modal');
    const nameInput = document.getElementById('custom-theme-name-input');
    const emojiInput = document.getElementById('custom-emoji-input');
    const confirmBtn = document.getElementById('confirm-custom-emoji-btn');

    if (!modal) {
        console.error("‚ùå Erro: Modal 'custom-emoji-modal' n√£o encontrado no HTML!");
        return;
    }

    nameInput.value = currentName;
    emojiInput.value = currentEmoji || "üíº";

    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";

    setTimeout(() => nameInput.focus(), 150);

    // 3. Grava√ß√£o
    confirmBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newEmoji = emojiInput.value.trim();

        if (!newName) return alert("Nome √© obrigat√≥rio.");

        confirmBtn.disabled = true;
        confirmBtn.textContent = "...";

        try {
            const collectionName = type === 'cosmos-parent' ? 'cosmos' : 'subcosmos';
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await updateDoc(doc(db, collectionName, id), {
                nome: newName,
                emoji: newEmoji
            });

            modal.style.display = 'none';
            renderListCategoryItems('cosmos'); // Atualiza a lista lateral
        } catch (e) {
            console.error(e);
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Confirmar";
        }
    };
}

async function checkItemProtection(itemId, itemName) {
    // Se o ID for nulo ou inv√°lido, n√£o faz nada
    if (!itemId) return true;
    if (sessionUnlockedFolders.has(itemId)) return true;

    try {
        const docRef = doc(db, 'pastas', itemId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.passe && data.passe.trim() !== "") {
                const authorized = await requestPassword('access', itemId);
                if (authorized === true) {
                    sessionUnlockedFolders.add(itemId);
                    return true;
                }
                return false;
            }
        }
    } catch (e) {
        console.error("Erro na verifica√ß√£o de senha:", e);
    }
    return true; 
}

window.addSeparatorToGaveta = async () => {
    if (!window.activeGavetaId) return;

    const result = await showCustomInput("Novo Separador", "Ex: Parte 1, Refer√™ncias Extras...");
    if (!result || !result.name) return;

    const sepId = 'sep_' + Date.now();
    
    try {
        const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);

        // Salvamos o ID no array de posts e o nome num mapa de metadados
        await updateDoc(gavetaRef, {
            posts: arrayUnion(sepId),
            [`separatorData.${sepId}`]: {
                title: result.name,
                createdAt: Date.now()
            }
        });

        // Atualiza a mem√≥ria local e renderiza
        if (!window.activeGavetaData.posts) window.activeGavetaData.posts = [];
        window.activeGavetaData.posts.push(sepId);
        if (!window.activeGavetaData.separatorData) window.activeGavetaData.separatorData = {};
        window.activeGavetaData.separatorData[sepId] = { title: result.name };

        renderArchiveFeed();
    } catch (e) {
        console.error("Erro ao criar separador:", e);
    }
};

// Ligar o clique do bot√£o
document.getElementById('create-separator-btn').onclick = window.addSeparatorToGaveta;


window.editSeparator = async (id, currentName) => {
    // Passamos 'currentName' como 3¬∫ argumento
    const result = await showCustomInput("Renomear Separador", "Novo nome...", currentName);
    
    if (!result || !result.name) return;

    try {
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
        
        await updateDoc(gavetaRef, {
            [`separatorData.${id}.title`]: result.name
        });
        
        // Atualiza mem√≥ria local
        if (window.activeGavetaData && window.activeGavetaData.separatorData && window.activeGavetaData.separatorData[id]) {
            window.activeGavetaData.separatorData[id].title = result.name;
        }
        
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

window.deleteSeparator = async (id) => {
    if (!confirm("Remover este separador?")) return;
    try {
        const { arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
        await updateDoc(gavetaRef, {
            posts: arrayRemove(id),
            [`separatorData.${id}`]: deleteField()
        });
        window.activeGavetaData.posts = window.activeGavetaData.posts.filter(item => item !== id);
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

// Fun√ß√£o de movimento unificada (funciona para posts e separadores)
window.movePostInGaveta = async (id, direction) => {
    const order = [...window.activeGavetaData.posts];
    const index = order.indexOf(id);
    const newIndex = index + direction;

    if (newIndex >= 0 && newIndex < order.length) {
        [order[index], order[newIndex]] = [order[newIndex], order[index]];
        try {
            const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
            await updateDoc(gavetaRef, { posts: order });
            window.activeGavetaData.posts = order;
            renderArchiveFeed();
        } catch (e) { console.error(e); }
    }
};

document.getElementById('create-separator-btn').onclick = async () => {
    const result = await showCustomInput("Novo Separador", "Ex: Parte 1, Fontes Extra...");
    if (!result || !result.name) return;

    const sepId = 'sep_' + Date.now();
    try {
        const { doc, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);

        await updateDoc(gavetaRef, {
            posts: arrayUnion(sepId),
            [`separatorData.${sepId}`]: { title: result.name }
        });

        // Atualiza cache local para refletir na UI sem refresh
        window.activeGavetaData.posts.push(sepId);
        if(!window.activeGavetaData.separatorData) window.activeGavetaData.separatorData = {};
        window.activeGavetaData.separatorData[sepId] = { title: result.name };
        
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

// 1. Definir a fun√ß√£o como global para evitar conflitos de nome
window.openShareModalForArchive = async function() {
    console.log("üöÄ [NUCLEAR-START] A abrir popup de partilha...");
    
    const modal = document.getElementById('note-share-popup');
    if (!modal) return console.error("‚ùå Erro: #note-share-popup n√£o encontrado.");

    // 1. Configura√ß√£o de IDs
    const id = selectedNoteId || currentArchiveId;
    if (!id) return;

    // 2. RECONSTRU√á√ÉO F√çSICA DO MODAL (For√ßa Bruta)
    document.body.appendChild(modal); 
    modal.style.cssText = `
        display: flex !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 9999999 !important;
        justify-content: center !important;
        align-items: center !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: all !important;
    `;

    const content = modal.querySelector('.modal-content');
    if (content) {
        content.style.cssText = `
            display: block !important;
            background-color: var(--sidebar-color, #252528) !important;
            padding: 30px !important;
            border-radius: 12px !important;
            width: 90% !important;
            max-width: 450px !important;
            position: relative !important;
            z-index: 10000000 !important;
            opacity: 1 !important;
            visibility: visible !important;
        `;
    }

    try {
        const docRef = doc(db, 'pastas', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();

            // üõ°Ô∏è BLOQUEIO DE SEGURAN√áA: Se n√£o for o dono, fecha e sai
            if (data.userId !== auth.currentUser.uid) {
                console.warn("üö´ Acesso negado: Apenas o dono pode gerir a partilha.");
                modal.style.display = 'none';
                return;
            }

            currentNoteShareData = data.shareSettings || { shared: false, shareId: null };

            // A. Configurar Link de Leitura
            const mainToggle = document.getElementById('note-share-toggle');
            if(mainToggle) mainToggle.checked = currentNoteShareData.shared || false;

            const linkContainer = document.getElementById('note-share-link-container');
            if (currentNoteShareData.shared) {
                if(linkContainer) linkContainer.style.display = 'block';
                const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                const shareId = currentNoteShareData.shareId || id;
                const urlInput = document.getElementById('note-share-url');
                if(urlInput) urlInput.value = `${baseUrl}/sharenote.html?id=${shareId}`;
            } else {
                if(linkContainer) linkContainer.style.display = 'none';
            }

            // B. Configurar Link de Colabora√ß√£o (Vis√≠vel apenas se estiver no modo partilha)
            const collabSection = document.getElementById('archive-collab-section');
            if (currentViewMode === 'shared') {
                if(collabSection) collabSection.style.display = 'block';
                const collabToggle = document.getElementById('collab-share-toggle');
                if(collabToggle) collabToggle.checked = (data.partilhado === "ativo");
                
                const collabLinkContainer = document.getElementById('collab-share-link-container');
                if (data.partilhado === "ativo") {
                    if(collabLinkContainer) collabLinkContainer.style.display = 'block';
                    const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                    const collabUrl = `${baseUrl}/note.html?openArchive=${id}&mode=collab`;
                    const collabInput = document.getElementById('collab-share-url');
                    if(collabInput) collabInput.value = collabUrl;
                } else {
                    if(collabLinkContainer) collabLinkContainer.style.display = 'none';
                }
            } else {
                if(collabSection) collabSection.style.display = 'none';
            }
            
            console.log("‚ú® [NUCLEAR-SUCCESS] Configura√ß√£o de partilha carregada.");
        }
    } catch (err) {
        console.error("üî• Erro ao carregar dados de partilha:", err);
    }
};

// Fun√ß√£o centralizada para abrir o criador de marcadores
function openCreateBookmarkPopup() {
    const modal = document.getElementById('create-bookmark-modal');
    if (!modal) return;

    // Garante que o modal est√° no topo do body
    document.body.appendChild(modal);

    // Limpa os campos
    document.getElementById('new-bookmark-title').value = '';
    document.getElementById('new-bookmark-desc').value = '';

    // For√ßa visibilidade absoluta
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "10000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Foco no input
    setTimeout(() => {
        const input = document.getElementById('new-bookmark-title');
        if (input) input.focus();
    }, 100);
}

// Detectar cliques nos links dentro do Quadro (Puzzle)
document.getElementById('puzzle-board-container').addEventListener('click', (e) => {
    const boardLink = e.target.closest('a.board-link');
    
    if (boardLink) {
        console.log("%cüìç [CLIQUE QUADRO] Detetado clique no texto azul!", "background: #3498db; color: white; padding: 2px 5px;");
        console.log("üìù Texto clicado:", boardLink.textContent);
        
        e.preventDefault();
        e.stopPropagation();
        
        if (typeof viewBoardLink === 'function') {
            console.log("üöÄ Chamando viewBoardLink...");
            viewBoardLink(boardLink);
        } else {
            console.error("‚ùå ERRO: A fun√ß√£o viewBoardLink n√£o est√° definida no c√≥digo!");
        }
    }
}, true);


// ============================================================
// GEST√ÉO DE CATEGORIAS ANEXADAS (FUN√á√ïES GLOBAIS)
// ============================================================

async function searchCategories(queryText) { // Mudamos 'query' para 'queryText' para evitar conflito
    const resultsContainer = document.getElementById('category-search-results');
    const isBibleSearch = document.getElementById('search-bible-toggle').checked;
    
    if (!resultsContainer) return;

    // Se o texto for pequeno, limpa e sai
    if (!queryText || queryText.length < 2) {
        resultsContainer.innerHTML = '';
        categoryFullResults = [];
        categoryDisplayCount = 0;
        return;
    }

    const term = queryText.toLowerCase();
    categoryFullResults = [];
    categoryDisplayCount = 0;

    if (isBibleSearch) {
        // --- MODO B√çBLIA: PESQUISA NO FIREBASE GLOBAL ---
        resultsContainer.innerHTML = '<div style="padding:20px; text-align:center;"><div class="spinner" style="width:20px; height:20px; border-width:2px; display:inline-block;"></div><p style="font-size:0.8em; margin-top:10px; color:var(--accent-color);">A consultar biblioteca b√≠blica...</p></div>';
        
        try {
            // Importante: Usamos o par√¢metro queryText aqui
            const q = query(
                collection(db, "bible_verses_public"), 
                where("nome", ">=", queryText), 
                where("nome", "<=", queryText + '\uf8ff'),
                limit(50)
            );
            
            const snap = await getDocs(q);
            snap.forEach(docSnap => {
                categoryFullResults.push({ 
                    id: docSnap.id, 
                    name: docSnap.data().nome, 
                    type: 'bible_public' 
                });
            });
            
            if (categoryFullResults.length === 0) {
                resultsContainer.innerHTML = '<div style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Nenhum vers√≠culo encontrado com este nome.</div>';
                return;
            }
        } catch (e) { 
            console.error("Erro busca b√≠blia:", e); 
            resultsContainer.innerHTML = '<div style="padding:20px; color:red; text-align:center;">Erro ao ligar √† biblioteca.</div>';
            return;
        }
    } else {
        // --- MODO NORMAL: PESQUISA LOCAL (SEM B√çBLIA) ---
        Object.keys(allEntities).forEach(type => {
            if (type === 'textobiblico') return; // Esconde B√≠blia se o toggle estiver desligado

            allEntities[type].forEach(ent => {
                if (ent.nome.toLowerCase().includes(term)) {
                    categoryFullResults.push({ id: ent.id, name: ent.nome, type: type });
                }
            });
        });

        allTags.forEach(tag => {
            if (tag.nome.toLowerCase().includes(term)) {
                categoryFullResults.push({ id: tag.id, name: tag.nome, type: 'tag' });
            }
        });
        
        // Pesquisa no Cosmos (Temas)
        if (allEntities['cosmos']) {
            allEntities['cosmos'].forEach(tema => {
                if (tema.nome.toLowerCase().includes(term)) {
                    categoryFullResults.push({ id: tema.id, name: tema.nome, type: 'cosmos' });
                }
            });
        }
    }

    // Ordenar resultados alfabeticamente
    categoryFullResults.sort((a, b) => a.name.localeCompare(b.name));

    resultsContainer.innerHTML = '';
    renderCategoryBatch(); // Desenha os primeiros 30
}

// FUN√á√ÉO PARA RENDERIZAR UM LOTE DE 30 ITENS
 async function renderCategoryBatch() {
    const resultsContainer = document.getElementById('category-search-results');
    const isBibleSearch = document.getElementById('search-bible-toggle').checked;
    
    // Remove o bot√£o "Ver mais" antigo se ele existir
    const oldBtn = document.getElementById('btn-categories-more');
    if (oldBtn) oldBtn.remove();

    const start = categoryDisplayCount;
    const end = start + 30;
    const batch = categoryFullResults.slice(start, end);

    for (const res of batch) {
        // VERIFICA√á√ÉO DE DUPLICADO: 
        // Se for B√≠blia Global, comparamos pelo NOME (j√° que o ID global √© diferente do ID privado)
        // Se for categoria normal, comparamos pelo ID.
        const isAlreadyAdded = selectedCategoriesForBox.some(c => 
            (res.type === 'bible_public' ? c.name === res.name : c.id === res.id)
        );
        
        const div = document.createElement('div');
        
        // Defini√ß√£o de √çcones e Labels
        let icon = "üîπ";
        let typeLabel = res.type;
        let color = "var(--accent-color)";

        switch (res.type) {
            case 'personagem': icon = "üë§"; typeLabel = "Personagem"; break;
            case 'local': icon = "üìç"; typeLabel = "Local"; break;
            case 'data': icon = "üìÖ"; typeLabel = "Data"; break;
            case 'tag': icon = "üè∑Ô∏è"; typeLabel = "Tag"; break;
            case 'textobiblico': icon = "üìñ"; typeLabel = "B√≠blia"; break;
            case 'bible_public': icon = "üìñ"; typeLabel = "B√≠blia (Global)"; color = "#e67e22"; break;
            case 'cosmos': icon = "ü™ê"; typeLabel = "Tema"; break;
            case 'subcosmos': icon = "üß¨"; typeLabel = "Subtema"; break;
        }

        div.style.cssText = `
            padding: 10px 15px;
            cursor: ${isAlreadyAdded ? 'default' : 'pointer'};
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 12px; transition: all 0.2s;
            opacity: ${isAlreadyAdded ? '0.4' : '1'};
            filter: ${isAlreadyAdded ? 'grayscale(1)' : 'none'};
        `;

        if (!isAlreadyAdded) {
            div.onmouseenter = () => { div.style.backgroundColor = "rgba(74, 144, 226, 0.1)"; div.style.paddingLeft = "20px"; };
            div.onmouseleave = () => { div.style.backgroundColor = "transparent"; div.style.paddingLeft = "15px"; };
        }

        div.innerHTML = `
            <span style="font-size: 1.4em; flex-shrink: 0;">${icon}</span>
            <div style="display: flex; flex-direction: column; overflow: hidden;">
                <span style="font-size: 0.65em; text-transform: uppercase; color: ${color}; font-weight: bold; letter-spacing: 0.5px;">${typeLabel}</span>
                <strong style="color: var(--text-color); font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${res.name}</strong>
            </div>
            <span style="margin-left: auto; color: ${isAlreadyAdded ? '#2ecc71' : 'var(--text-muted-color)'}; font-size: 0.9em; font-weight: bold;">
                ${isAlreadyAdded ? '‚úì' : '+'}
            </span>
        `;

        div.onclick = async () => {
            if (isAlreadyAdded) return;

            // --- L√ìGICA ESPECIAL: IMPORTAR B√çBLIA GLOBAL PARA PRIVADA ---
            if (res.type === 'bible_public') {
                div.style.pointerEvents = 'none';
                div.innerHTML = `<span style="font-size: 1.4em;">‚è≥</span><div style="display:flex; flex-direction:column;"><small style="color:orange; font-size:10px; font-weight:bold;">A IMPORTAR...</small><strong>${res.name}</strong></div>`;
                
                try {
                    // 1. Verificar se o utilizador j√° tem este vers√≠culo na sua lista privada
                    const qPrivate = query(collection(db, 'textosbiblicos'), 
                        where('nome', '==', res.name), 
                        where('userId', '==', auth.currentUser.uid)
                    );
                    const privateSnap = await getDocs(qPrivate);

                    let privateId;
                    if (privateSnap.empty) {
                        // 2. Criar o documento privado com o userId do utilizador atual
                        const newDoc = await addDoc(collection(db, 'textosbiblicos'), {
                            nome: res.name,
                            userId: auth.currentUser.uid,
                            createdAt: serverTimestamp(),
                            puzzleBoard: [], // Come√ßa com quadro vazio
                            marcadoresAssociados: {}
                        });
                        privateId = newDoc.id;
                        
                        // 3. Atualizar o cache local (allEntities) para que a 4¬™ coluna o encontre agora
                        if(!allEntities['textobiblico']) allEntities['textobiblico'] = [];
                        allEntities['textobiblico'].push({ id: privateId, nome: res.name, tipo: 'textobiblico' });
                        console.log(`‚úÖ Vers√≠culo ${res.name} migrado para cole√ß√£o privada.`);
                    } else {
                        privateId = privateSnap.docs[0].id;
                    }
                    
                    // Adicionar ao array do modal como tipo privado
                    selectedCategoriesForBox.push({ id: privateId, name: res.name, type: 'textobiblico' });

                } catch (err) {
                    console.error("Erro na migra√ß√£o b√≠blica:", err);
                    alert("Erro ao importar vers√≠culo.");
                    return;
                }
            } else {
                // Caso normal (Personagens, Locais, etc.)
                selectedCategoriesForBox.push(res);
            }

            // Finalizar adi√ß√£o
            renderAttachedCategories();
            document.getElementById('category-search-input').value = '';
            resultsContainer.innerHTML = '';
            document.getElementById('category-search-input').focus();
        };
        
        resultsContainer.appendChild(div);
    }

    categoryDisplayCount += batch.length;

    // Criar bot√£o "Ver mais" se ainda houver resultados no array full
    if (categoryDisplayCount < categoryFullResults.length) {
        const moreBtn = document.createElement('button');
        moreBtn.id = 'btn-categories-more';
        moreBtn.textContent = `Ver mais (${categoryFullResults.length - categoryDisplayCount} restantes)`;
        moreBtn.style.cssText = `
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
            border: none; color: var(--accent-color); cursor: pointer; 
            font-weight: bold; font-size: 0.85em; text-transform: uppercase;
        `;
        moreBtn.onclick = (e) => {
            e.preventDefault();
            renderCategoryBatch();
        };
        resultsContainer.appendChild(moreBtn);
    }
}

function renderAttachedCategories() {
    const list = document.getElementById('attached-categories-list');
    if (!list) return;
    list.innerHTML = '';
    selectedCategoriesForBox.forEach(cat => {
        const chip = document.createElement('div');
        chip.style.cssText = "background:var(--selected-color); color:white; padding:5px 12px; border-radius:20px; font-size:0.85em; display:flex; align-items:center; gap:8px; border: 1px solid rgba(255,255,255,0.1);";
        chip.innerHTML = `${cat.name} <span style="cursor:pointer; font-weight:bold; font-size:1.2em;">√ó</span>`;
        chip.querySelector('span').onclick = (e) => {
            e.stopPropagation();
            selectedCategoriesForBox = selectedCategoriesForBox.filter(c => c.id !== cat.id);
            renderAttachedCategories();
        };
        list.appendChild(chip);
    });
}

// ============================================================
// NOVO SISTEMA DE HIST√ìRICO: ABAS + TIMELINE + A√á√ïES
// ============================================================

// 1. Gestor de Troca de Abas
document.getElementById('history-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const target = btn.dataset.histTab;

    document.querySelectorAll('#history-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.hist-tab-div').forEach(div => div.style.display = 'none');
    document.getElementById(`hist-content-${target}`).style.display = 'block';

    if (target === 'timeline') renderNoteTimeline();
});

// 2. Abrir o Modal (Fun√ß√£o Global)
window.openHistoryModal = async function() {
    if (!selectedNoteId) return alert("Selecione uma nota primeiro.");

    const modal = document.getElementById('history-modal');
    const backupBtn = document.getElementById('backup-now-btn');

    if (!modal || !backupBtn) return;

    // 1. Mostrar o Modal
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    modal.style.zIndex = "8000000";

    // 2. Configurar o Bot√£o de Backup (Limpa e cria novo evento)
    backupBtn.onclick = async () => {
        const originalText = backupBtn.textContent;
        backupBtn.disabled = true;
        backupBtn.textContent = 'A guardar vers√£o...';

        try {
            const title = document.getElementById('note-title-input').value || "Sem T√≠tulo";
            // Sincroniza os t√≠tulos das caixas antes de extrair o HTML
            document.querySelectorAll('.mini-note-title-input').forEach(t => {
                if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                else t.setAttribute('value', t.value);
            });
            const content = document.getElementById('note-content-editor').innerHTML;

            const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
            await addDoc(backupsRef, {
                titulo: title,
                conteudo: content,
                timestamp: serverTimestamp(),
                isSafetyBackup: false
            });

            // Feedback de sucesso
            backupBtn.textContent = '‚úÖ Vers√£o Guardada!';
            backupBtn.style.backgroundColor = '#27ae60';

            // Recarregar a lista da aba Backup
            await loadHistoryData();

            setTimeout(() => {
                backupBtn.disabled = false;
                backupBtn.textContent = originalText;
                backupBtn.style.backgroundColor = '';
            }, 2000);

        } catch (error) {
            console.error("Erro ao criar backup:", error);
            alert("Erro ao criar backup.");
            backupBtn.disabled = false;
            backupBtn.textContent = originalText;
        }
    };

    // 3. Resetar para a aba Backup e carregar dados
    document.querySelector('[data-hist-tab="backup"]').click();
    await loadHistoryData();
};

// 3. Carregar Dados do Firebase (Backups e Reciclagem)
async function loadHistoryData() {
    const backupList = document.getElementById('history-list-backups');
    const recyclingList = document.getElementById('history-list-recycling');
    
    backupList.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    recyclingList.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    try {
        // A. BACKUPS (C√≥digo existente simplificado)
        const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
        const qB = query(backupsRef, orderBy('timestamp', 'desc'));
        const snapB = await getDocs(qB);
        backupList.innerHTML = snapB.empty ? '<li style="color:#888;">Sem backups.</li>' : '';
        snapB.forEach(doc => { /* ... c√≥digo de renderiza√ß√£o do backup ... */ });

        // B. RECICLAGEM
        const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        const hidden = noteSnap.exists() ? (noteSnap.data().subnotasocultas || {}) : {};
        
        recyclingList.innerHTML = Object.keys(hidden).length === 0 ? '<li style="color:#888;">Lixeira vazia.</li>' : '';
        
      Object.values(hidden).sort((a,b) => (b.deletedAt?.seconds || 0) - (a.deletedAt?.seconds || 0)).forEach(item => {
            const li = document.createElement('li');
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            
            // 1. DECLARA√á√ÉO INICIAL (Evita o ReferenceError)
            let typeIcon = "üì¶ "; 
            let displayTitle = item.titulo || 'Sem T√≠tulo';

            // 2. L√ìGICA DE √çCONES E T√çTULOS
            if (item.type === 'sign') typeIcon = "ü™ß "; 
            else if (item.type === 'redator') typeIcon = "üìì "; 
            else if (item.type === 'card') typeIcon = "ü™™ "; 
            else if (item.type === 'toggle') typeIcon = "‚òÇ ";
            else if (item.type === 'question') typeIcon = "üìó ";
            else if (item.type === 'free') typeIcon = "üìô ";
            
            // --- BLOCO FANTASMA (AQU√ÅRIO) ---
            else if (item.type === 'ghost') {
                typeIcon = "üê† "; 
                
                // Limpa o HTML para obter texto puro
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = item.conteudo || "";
                
                // Remove os bot√µes de a√ß√£o antes de ler o texto
                const actions = tempDiv.querySelector('.ghost-actions');
                if (actions) actions.remove();
                
                let cleanText = tempDiv.innerText.trim();
                
                // Remove quebras de linha extras
                cleanText = cleanText.replace(/\n/g, ' ');

                if (cleanText.length > 40) cleanText = cleanText.substring(0, 40) + "...";
                
                displayTitle = cleanText || "Texto Vazio";
            }
            // --------------------------------
            
            else if (item.type === 'default' || !item.type) typeIcon = "üìò ";
            
            const dateStr = item.deletedAt ? new Date(item.deletedAt.seconds * 1000).toLocaleDateString() : '';

            li.innerHTML = `
                <div style="display:flex; flex-direction:column; max-width: 250px;">
                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight:500;">
                        ${typeIcon}${displayTitle}
                    </span>
                    <small style="color:#666; font-size:0.75em;">Apagado em: ${dateStr}</small>
                </div>
                <button class="modal-btn primary" onclick="window.restoreHiddenMiniNote('${item.id}')" style="padding:4px 12px; font-size:12px;">Restaurar</button>
            `;
            recyclingList.appendChild(li);
        });

    } catch (e) { 
        console.error("Erro hist√≥rico:", e); 
    }
}

// 4. L√≥gica da Timeline (Hist√≥rico de Cria√ß√£o)
async function renderNoteTimeline() {
    const infoDiv = document.getElementById('note-creation-info');
    const timelineList = document.getElementById('history-list-timeline');
    timelineList.innerHTML = '<li style="padding:10px;">A analisar...</li>';

    try {
        const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        if (noteSnap.exists()) {
            const data = noteSnap.data();
            const noteDate = data.createdAt ? new Date(data.createdAt.seconds * 1000) : null;
            infoDiv.innerHTML = `
                <strong style="color:var(--accent-color);">Nota Criada em:</strong><br>
                <span style="font-size:1.1em;">üìÖ ${noteDate ? noteDate.toLocaleDateString('pt-PT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Data desconhecida'}</span>
            `;
        }

        const editor = document.getElementById('note-content-editor');
        const boxes = editor.querySelectorAll('.mini-note-wrapper, details.toggle-section, .jwn-table-wrapper, .jwn-timeline-wrapper');
        
        if (boxes.length === 0) {
            timelineList.innerHTML = '<li style="color:#888; padding:10px;">Nenhuma caixa ativa no momento.</li>';
            return;
        }

        const items = [];
        boxes.forEach(box => {
            const idParts = box.id.split('_');
            const timestamp = (idParts.length > 1 && !isNaN(idParts[1])) ? parseInt(idParts[1]) : null;
            let label = "Bloco"; let icon = "üì¶"; let title = "";

            if (box.classList.contains('question-mode')) { label = "Quest√£o"; icon = "üìó"; title = box.querySelector('textarea, input')?.value; }
            else if (box.classList.contains('free-mode')) { label = "Contentor"; icon = "üìô"; title = box.querySelector('.mini-note-content')?.innerText.substring(0, 30) + "..."; }
            else if (box.classList.contains('mini-note-wrapper')) { label = "SubNota"; icon = "üìò"; title = box.querySelector('textarea, input')?.value; }
            else if (box.tagName === 'DETAILS') { label = "Toggle"; icon = "‚òÇ"; title = box.querySelector('h2')?.textContent; }
            else if (box.classList.contains('jwn-table-wrapper')) { label = "Tabela"; icon = "üßÆ"; }
            else if (box.classList.contains('jwn-timeline-wrapper')) { label = "Linha Cronol√≥gica"; icon = "üå≥"; }

            items.push({ timestamp, icon, label, title: title || 'Sem T√≠tulo' });
        });

        timelineList.innerHTML = '';
        items.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(item => {
            const timeStr = item.timestamp ? new Date(item.timestamp).toLocaleString('pt-PT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}) : 'Data desconhecida';
            const li = document.createElement('li');
            li.style.cssText = "flex-direction:column; align-items:flex-start; padding:10px; border-bottom:1px solid var(--border-color);";
            li.innerHTML = `
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <strong>${item.icon} ${item.label}</strong>
                    <span style="font-size:0.8em; color:var(--text-muted-color);">${timeStr}</span>
                </div>
                <div style="font-size:0.9em; opacity:0.8; margin-top:4px;">${item.title}</div>
            `;
            timelineList.appendChild(li);
        });
    } catch (e) { console.error(e); }
}

// 5. FUN√á√ïES DE A√á√ÉO GLOBAIS (Ver e Restaurar)
window.viewBackup = async function(backupId) {
    const modal = document.getElementById('view-backup-modal');
    const contentEl = document.getElementById('view-backup-content');
    const titleEl = document.getElementById('view-backup-title');
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    modal.style.zIndex = "9999999";
    contentEl.innerHTML = '<p>A carregar...</p>';

    try {
        const backupSnap = await getDoc(doc(db, 'pastas', selectedNoteId, 'backups', backupId));
        if (backupSnap.exists()) {
            const data = backupSnap.data();
            titleEl.textContent = "Conte√∫do da Vers√£o";
            let cleanHTML = (data.conteudo || "").replace(/<div class="mini-note-toolbar".*?<\/div>/g, '');
            contentEl.innerHTML = cleanHTML;
        }
    } catch (e) { console.error(e); }
};

window.restoreBackup = async function(backupId) {
    const confirmed = await showConfirmation("Restaurar?", "Isto criar√° uma NOVA nota baseada nesta vers√£o.");
    if (!confirmed) return;
    try {
        const backupSnap = await getDoc(doc(db, 'pastas', selectedNoteId, 'backups', backupId));
        const data = backupSnap.data();
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const originalSnap = await getDoc(noteRef);
        const parentId = originalSnap.exists() ? originalSnap.data().parentId : null;

        const newDoc = await addDoc(collection(db, 'pastas'), {
            nome: `${data.titulo} (Restaurado)`,
            conteudo: data.conteudo,
            parentId: parentId,
            tipo: 'nota',
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ordem: 0,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        });

        document.getElementById('history-modal').style.display = 'none';
        displayNote(newDoc.id, null);
    } catch (e) { console.error(e); }
};

// ============================================================
// FUN√á√ÉO: RESTAURAR CAIXAS DA RECICLAGEM (CORRE√á√ÉO AT√ìMICA)
// ============================================================
window.restoreHiddenMiniNote = async function(miniNoteId) {
    if (!selectedNoteId) return;

    // 1. AJUSTE VISUAL (Z-Index para o popup de confirma√ß√£o ficar no topo)
    const historyModal = document.getElementById('history-modal');
    const confirmModal = document.getElementById('confirm-modal');
    if (confirmModal) confirmModal.style.setProperty('z-index', '2147483647', 'important');

    // 2. CONFIRMA√á√ÉO
    const confirmed = await showConfirmation(
        "Restaurar Item?", 
        "O item ser√° retirado da reciclagem e colocado de volta na nota."
    );
    
    // Reset do Z-Index
    if (confirmModal) confirmModal.style.zIndex = "";

    if (!confirmed) return;

    // 3. FEEDBACK VISUAL NO BOT√ÉO DA LISTA
    const restoreBtn = document.querySelector(`button[onclick*="${miniNoteId}"]`);
    if (restoreBtn) {
        restoreBtn.textContent = "A restaurar...";
        restoreBtn.disabled = true;
    }

    try {
        // 4. LIGAR AO FIREBASE
        const { doc, getDoc, updateDoc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (!noteSnap.exists()) return;
        
        const data = noteSnap.data();
        const hiddenItems = data.subnotasocultas || {};
        const item = hiddenItems[miniNoteId];

        if (!item) {
            alert("Erro: Item n√£o encontrado (pode j√° ter sido restaurado).");
            if(restoreBtn) restoreBtn.closest('li').remove();
            return;
        }

        // ============================================================
        // 5. RECONSTRU√á√ÉO DO HTML (BASEADO NO TIPO)
        // ============================================================
        let restoredHTML = "";
        
        // Toolbar Padr√£o (para subnotas normais)
        const commonToolbar = `
            <div class="mini-note-toolbar" contenteditable="false">
                <button type="button" data-action="sharing-settings" title="Partilha">üîê</button>
                <div class="toolbar-btn-group">
                    <button type="button" data-action="move-up">üî∫</button>
                    <button type="button" data-action="move-down">üîª</button>
                </div>
                <button type="button" data-action="manage-box-links">‚ö°</button>
                <button type="button" data-action="append-mini-note">üß¨</button>
                <button type="button" data-action="highlight-color">üé®</button>
                <button type="button" data-action="manage-mini-note-topics">üìã</button>
                <button type="button" data-action="delete-mini-note">üóëÔ∏è</button>
            </div>`;

        // Prepara atributos
        const safeTopics = (item.topicsJSON || "{}").replace(/'/g, "&apos;").replace(/"/g, "&quot;");
        const safeId = item.id || `restored_${Date.now()}`;
        const attrs = `id="${safeId}" data-topics='${safeTopics}' data-shared="false" data-box-links='{}'`;
        const contentVal = item.conteudo || "<p><br></p>";
        const titleVal = item.titulo || "";

        // --- SWITCH DE TIPOS ---

        // 1. RACIOC√çNIO (SIGN) - COM CORRE√á√ÉO DO √çCONE ‚è≥ -> üóëÔ∏è
        if (item.type === 'sign') {
            let cleanContent = contentVal;

            // Regex para encontrar o bot√£o velho (que tem o √≠cone ‚è≥ e estilos antigos)
            const btnRegex = /<button[^>]*class="sign-btn-del"[^>]*>.*?<\/button>/i;
            
            // O bot√£o novo e limpo
            const freshBtn = '<button class="sign-btn-del" onclick="window.confirmSignDelete(this)" title="Mover para a Reciclagem">üóëÔ∏è</button>';
            
            // Substitui o bot√£o velho pelo novo no HTML
            if (btnRegex.test(cleanContent)) {
                cleanContent = cleanContent.replace(btnRegex, freshBtn);
            } else {
                // Fallback de seguran√ßa: substitui apenas o emoji se a regex falhar
                cleanContent = cleanContent.replace('‚è≥', 'üóëÔ∏è');
            }

            restoredHTML = `<div class="journal-sign-wrapper" ${attrs} contenteditable="false">${cleanContent}</div><p><br></p>`;
        }
        
        // 2. CART√ÉO (CARD)
        else if (item.type === 'card') {
            restoredHTML = `<div class="journal-id-card" ${attrs} contenteditable="false">${contentVal}</div><p><br></p>`;
        }
        
        // 3. CUBO (CUBE)
        else if (item.type === 'cube') {
            restoredHTML = `<div class="journal-cube-wrapper" ${attrs} contenteditable="false">${contentVal}</div><p style="clear:both;"><br></p>`;
        }
        
        // 4. TOGGLE (T√çTULO EXPANS√çVEL)
        else if (item.type === 'toggle') {
            restoredHTML = `
            <details class="toggle-section" open ${attrs}>
                <summary>
                    <h2>${titleVal}</h2>
                    <button class="toggle-move-btn" data-action="move-up">üî∫</button>
                    <button class="toggle-move-btn" data-action="move-down">üîª</button>
                    <button class="toggle-color-btn" contenteditable="false">üñåÔ∏è</button>
                    <button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button>
                </summary>
                <div class="toggle-content" contenteditable="true">${contentVal}</div>
            </details><p><br></p>`;
        } 
        
        // 5. REDATOR
        else if (item.type === 'redator') {
            restoredHTML = `
            <div class="redator-wrapper" ${attrs} contenteditable="false">
                <button class="redator-reopen-btn" onclick="window.toggleRedatorHeader('${safeId}', true)">T</button>
                <div class="redator-header" id="header-${safeId}">
                    <input type="text" class="redator-input" value="${titleVal}" oninput="this.setAttribute('value', this.value)">
                    <div class="redator-top-tools">
                        <button class="redator-menu-trigger" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>
                         <div class="redator-slide-menu">
                            <button class="tool-icon-btn" data-action="move-up">üî∫</button>
                            <button class="tool-icon-btn" data-action="move-down">üîª</button>
                            <button class="tool-icon-btn" data-action="delete-mini-note" style="color:#e74c3c;">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="redator-content" contenteditable="true">${contentVal}</div>
                <div class="redator-dock">
                     <button class="dock-btn" onclick="event.preventDefault(); window.openRedatorFocus('${safeId}')"><svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg></button>
                </div>
            </div><p><br></p>`;
        }
        
        // 7. BLOCO FANTASMA (AQU√ÅRIO) - NOVO
        else if (item.type === 'ghost') {
            // Recria apenas a div simples, sem bordas nem toolbar
            restoredHTML = `<div class="ghost-block" id="${safeId}" contenteditable="true" data-placeholder="">${contentVal}</div>`;
            
            // Re-injeta os bot√µes flutuantes (Concha e Popup) para o bloco voltar a ser funcional
            // Nota: A fun√ß√£o ensureGhostActions ser√° chamada automaticamente quando o user clicar no bloco,
            // mas podemos for√ßar a estrutura inicial aqui se o conte√∫do vier limpo.
            if (!restoredHTML.includes('ghost-actions')) {
                const actionsDiv = `
                    <div class="ghost-actions" contenteditable="false">
                        <button class="ghost-action-btn" title="Armaz√©m (Notas Anexadas)" onclick="window.openGhostStore(this)">üêö</button>
                        <button class="ghost-action-btn" title="Abrir Popup" onclick="window.openGhostPopup(this)">‚á±</button>
                    </div>
                    <div class="ghost-add-between-btn" contenteditable="false" title="Inserir Par√°grafo Abaixo" onclick="event.preventDefault(); event.stopPropagation(); window.insertBlockBelow(this.parentElement)"></div>
                `;
                // Injeta os bot√µes dentro da div
                restoredHTML = restoredHTML.replace('>', '>' + actionsDiv);
            }
        }

        // 6. DEFAULT (SUBNOTAS / QUEST√ïES / CONTENTORES)
        else {
            let modeClass = "mini-note-wrapper";
            let titleHTML = `<textarea class="mini-note-title-input" rows="1">${titleVal}</textarea>`;
            
            if (item.type === 'question') modeClass += " question-mode";
            else if (item.type === 'free') {
                modeClass += " free-mode";
                titleHTML = ""; 
            }

            restoredHTML = `
            <div class="${modeClass}" ${attrs} contenteditable="false">
                ${titleHTML}
                ${commonToolbar}
                <div class="mini-note-content" contenteditable="true">${contentVal}</div>
            </div><p><br></p>`;
        }

        // ============================================================
        // 6. INSER√á√ÉO NO DOM
        // ============================================================
        let container = document.getElementById('note-content-editor');
        if (!container) throw new Error("Editor n√£o encontrado.");

        // Procura marcador de posi√ß√£o original
        const marker = document.getElementById(`marker_${miniNoteId}`);
        if (marker) {
            marker.outerHTML = restoredHTML;
        } else {
            // Se n√£o houver marcador, p√µe no fim
            container.insertAdjacentHTML('beforeend', restoredHTML);
        }
        
        // Sincroniza inputs (garante que o texto aparece nas caixas de t√≠tulo)
        container.querySelectorAll('.mini-note-title-input, .redator-input, .sign-title-input').forEach(t => {
            if (t.tagName === 'INPUT') t.setAttribute('value', t.value);
            else t.textContent = t.value;
        });

        // ============================================================
        // 7. GRAVA√á√ÉO AT√ìMICA
        // ============================================================
        // Captura o HTML final do editor (j√° com a caixa restaurada)
        const finalHTML = container.innerHTML;

        // Atualiza o Firebase: Grava o conte√∫do E apaga da lixeira ao mesmo tempo
        await updateDoc(noteRef, {
            conteudo: finalHTML,
            [`subnotasocultas.${miniNoteId}`]: deleteField(),
            ultimaedicao: serverTimestamp()
        });

        // 8. FINALIZA√á√ÉO
        if (historyModal) historyModal.style.display = 'none';

        // Scroll suave at√© ao item restaurado
        setTimeout(() => {
            const el = document.getElementById(safeId);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Efeito visual de destaque
            el.style.transition = "box-shadow 0.5s";
            el.style.boxShadow = "0 0 20px var(--accent-color)";
            setTimeout(() => el.style.boxShadow = "", 1500);
        }, 300);

    } catch (error) {
        console.error("‚ùå Erro ao restaurar:", error);
        alert("Erro ao restaurar item. Tente novamente.");
        if (restoreBtn) {
            restoreBtn.textContent = "Restaurar";
            restoreBtn.disabled = false;
        }
    }
};

// 1. FUN√á√ÉO PARA ATUALIZAR A HORA DE LEITURA (Firestore)
async function markArchiveAsRead(archiveId) {
    if (!auth.currentUser || !archiveId) return;
    
    let now = Date.now();

    // TRUQUE ANTI-PISCAR:
    // Se a √∫ltima edi√ß√£o do arquivo for "no futuro" (rel√≥gio do servidor vs PC),
    // definimos a nossa leitura para 1 segundo DEPOIS dessa edi√ß√£o.
    // Isto mata a notifica√ß√£o instantaneamente.
    if (currentArchiveData && currentArchiveData.ultimaedicao) {
        const serverTime = currentArchiveData.ultimaedicao.toMillis();
        if (serverTime > now) {
            now = serverTime + 1000; 
        }
    }

    try {
        const readRef = doc(db, 'users', auth.currentUser.uid, 'archive_reads', archiveId);
        await setDoc(readRef, { 
            lastSeen: now,
            archiveName: currentArchiveData?.nome || "Arquivo" 
        }, { merge: true });
        
        // Atualiza o cache local imediatamente
        userLastSeenArchives[archiveId] = now;
        
        // For√ßa rec√°lculo imediato para apagar a bola
        recalcGlobalNotification();
        
    } catch (e) { 
        console.warn("‚ö†Ô∏è Falha ao gravar leitura:", e); 
    }
}

// 2. FUN√á√ÉO DISPLAY ARCHIVE (ATUALIZADA)
window.displayArchive = async function(id, data, element = null) {
    console.group(`üìÇ ABERTURA: ${data.nome}`);
    
    // 1. CONGELAR O TEMPO DA √öLTIMA VISITA (Lock da sess√£o)
    // Buscamos o que estava guardado na lista lateral antes de abrirmos
    sessionStartTimeForArchive = userLastSeenArchives[id] || 0;
    console.log("üïí Tempo congelado para esta sess√£o:", sessionStartTimeForArchive);

    selectedNoteId = id; 
    window.nextSelectedId = null;
    currentArchiveId = id; 
    currentArchiveData = data;

    // 2. Marcar como lido no Firebase (isso vai atualizar o userLastSeenArchives[id] para o tempo de AGORA)
    // Mas como j√° congelamos o valor na vari√°vel 'sessionStartTimeForArchive', os pontos v√£o aparecer.
    markArchiveAsRead(id);

    // Visibilidade da UI
    const placeholder = document.getElementById('editor-placeholder');
    const editorArea = document.getElementById('editor-area');
    const archiveArea = document.getElementById('archive-area');
    if (placeholder) placeholder.style.setProperty('display', 'none', 'important');
    if (editorArea) editorArea.style.setProperty('display', 'none', 'important');
    if (archiveArea) archiveArea.style.display = 'flex';

    if (document.getElementById('archive-title-input')) {
        document.getElementById('archive-title-input').value = data.nome || "";
    }

    // Iniciar servi√ßos
    if (typeof leaveArchivePresence === 'function') leaveArchivePresence(); 
    initRealtimeCollab(id);
    initPresenceSystem(id);
    
    // Renderizar o feed usando o tempo congelado
    renderArchiveFeed();
    
    console.groupEnd();

    if (window.innerWidth <= 768) {
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
    }
};

// 3. RENDERIZAR POST VIEW MODE (COM PONTOS)
function renderPostViewMode(container, post) {
    const getMs = (val) => val && val.toMillis ? val.toMillis() : Number(val || 0);

    // Usa a hora congelada da entrada na sess√£o
    const lastSeen = Number(sessionStartTimeForArchive || 0);
    const postCreated = getMs(post.createdAt);
    const postUpdated = getMs(post.updatedAt);
    const myUid = auth.currentUser.uid;
    
    let statusDotHTML = "";
    
    // --- L√ìGICA DE NOTIFICA√á√ÉO ---

    // 1. √â NOVO? (Vermelho)
    // Condi√ß√£o: Criado depois da minha visita E n√£o fui eu que criei
    if (postCreated > lastSeen && post.userId !== myUid) {
        statusDotHTML = `<div class="post-status-dot dot-new" title="Novo Post de ${post.createdBy}"></div>`;
    } 
    
    // 2. FOI EDITADO? (Laranja)
    // Condi√ß√£o:
    // a) Atualizado depois da minha visita
    // b) N√£o √© um post acabado de criar (margem de 2s)
    // c) O √∫ltimo a editar N√ÉO FUI EU (lastEditorId !== myUid) -> AQUI ESTAVA O ERRO
    else if (postUpdated > lastSeen && postUpdated > (postCreated + 2000)) { 
        
        // Verifica quem foi o √∫ltimo a mexer (se n√£o existir lastEditorId, assume que foi outro)
        const lastEditor = post.lastEditorId || "unknown";
        
        if (lastEditor !== myUid) {
            statusDotHTML = `<div class="post-status-dot dot-edited" title="Editado recentemente"></div>`;
        }
    }

    const createdDate = postCreated ? new Date(postCreated).toLocaleString() : '---';
    const btnStyle = "position: static !important; background:var(--bg-color); border:1px solid var(--border-color); color:var(--text-muted-color); border-radius:4px; padding:0 10px; cursor:pointer; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px;";

    container.style.position = "relative";
    
    container.innerHTML = `
        ${statusDotHTML}
        
        <div class="post-controls" style="position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 5px; opacity: 0.6; z-index:10;">
            <button onclick="moveArchivePost('${post.id}', -1)" title="Subir" style="${btnStyle}">‚Üë</button>
            <button onclick="moveArchivePost('${post.id}', 1)" title="Descer" style="${btnStyle}">‚Üì</button>
            <button class="post-edit-btn" onclick="editArchivePost('${post.id}')" style="${btnStyle}">Editar</button>
        </div>

        <div class="post-view-title" style="padding-left: 25px; font-weight:bold; color:var(--accent-color); font-size:1.2em; margin-bottom:10px;">
            ${post.title || 'Sem T√≠tulo'}
        </div>
        
        <div class="post-view-content" style="padding-left: 5px;">${post.content}</div>
        
        <div class="post-footer">
            <span>Criado por: ${post.createdBy}</span>
            <span>${createdDate}</span>
        </div>
    `;

    // === ATIVA√á√ÉO DO OLHO DIGITAL ===
    // Se desenh√°mos uma bola, ligamos o observador para ela desaparecer ao ler
    if (statusDotHTML !== "") {
        postObserver.observe(container);
    }
}


// 4. ATUALIZAR LISTA LATERAL COM BADGE (Dentro de loadSharedFilesRoot)
// Substitua o loop .forEach de loadSharedFilesRoot por este:
async function updateSharedListWithNotifs(resultsMap) {
    const myUid = auth.currentUser.uid;
    
    // Carregar todos os "lastSeen" do user primeiro
    const readsSnap = await getDocs(collection(db, 'users', myUid, 'archive_reads'));
    readsSnap.forEach(d => userLastSeenArchives[d.id] = d.data().lastSeen);

    middlePanelList.innerHTML = '';
    
 resultsMap.forEach(item => {
    const li = document.createElement('li');
    li.className = 'list-item';
    li.setAttribute('data-id', item.id);
    
    // LOG DE CRIA√á√ÉO (Para saber se o item est√° na lista)
    console.log(`[LISTA] Gerando item: ${item.nome} (ID: ${item.id})`);

    li.innerHTML = `<span>${item.userId === myUid ? 'üëë' : 'ü§ù'} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

    li.onclick = (e) => {
        if (e.target.closest('.item-menu-btn')) return;
        
        // LOG DE CLIQUE
        console.log(`%cüñ±Ô∏è CLIQUE DETETADO: A tentar abrir o arquivo "${item.nome}"...`, "color: #3498db; font-weight: bold;");
        
        // Chama a abertura
        window.displayArchive(item.id, item, li);
    };
    
    middlePanelList.appendChild(li);
});
}



 async function loadSharedFilesRoot() {
    console.log("%c[SISTEMA] Iniciando renderiza√ß√£o da Partilha...", "color: #e74c3c;");
    
    // Limpeza de seguran√ßa inicial
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }
    if (unsubscribeShared2) { unsubscribeShared2(); unsubscribeShared2 = null; }

    // Define o visual inicial
    middlePanelTitle.textContent = "Arquivos Partilhados";
    middlePanelList.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A procurar arquivos...</span></div>';

    const myUid = auth.currentUser.uid;
    const foldersRef = collection(db, 'pastas');
    let resultsMap = new Map();

    try {
        // Carregar hist√≥rico de leitura
        const readsSnap = await getDocs(collection(db, 'users', myUid, 'archive_reads'));
        
        if (currentViewMode !== 'shared') return;

        readsSnap.forEach(d => userLastSeenArchives[d.id] = d.data().lastSeen || 0);
    } catch(e) { console.warn("Aviso: Hist√≥rico de leitura inacess√≠vel."); }

    // --- FUN√á√ÉO DE DESENHO INTELIGENTE ---
    const renderUnifiedList = () => {
        if (currentViewMode !== 'shared') return;

        middlePanelList.innerHTML = '';
        
        Array.from(resultsMap.values())
            .sort((a, b) => (a.nome || "").localeCompare(b.nome || ""))
            .forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                li.setAttribute('data-id', item.id);
                li.setAttribute('data-type', item.tipo || 'partilhado');
                li.setAttribute('data-name', item.nome);
                li.style.position = "relative"; 

                // Sele√ß√£o visual
                if (item.id === selectedNoteId) li.classList.add('selected-red');
                else li.style.borderLeft = "4px solid #e74c3c";

                // --- L√ìGICA DE DETE√á√ÉO DE NOTIFICA√á√ÉO (CR√çTICA) ---
                const lastSeen = userLastSeenArchives[item.id] || 0;
                const posts = item.posts || [];
                
                let hasNew = false;
                let hasEdit = false;

                // Percorre os posts para ver se h√° novidades
                for (const post of posts) {
                    const created = post.createdAt?.toMillis ? post.createdAt.toMillis() : (post.createdAt || 0);
                    const updated = post.updatedAt?.toMillis ? post.updatedAt.toMillis() : (post.updatedAt || 0);
                    
                    // 1. Verificar se √© NOVO (Criado por outro depois da visita)
                    if (created > lastSeen && post.userId !== myUid) {
                        hasNew = true;
                        break; // Se h√° novo, ganha prioridade m√°xima (Vermelho), paramos de procurar.
                    }

                    // 2. Verificar se foi EDITADO (Atualizado por outro depois da visita)
                    // Ignora se foi acabado de criar (margem 2s)
                    if (updated > lastSeen && updated > (created + 2000)) {
                        const lastEditor = post.lastEditorId || "unknown";
                        if (lastEditor !== myUid) {
                            hasEdit = true;
                        }
                    }
                }

                // Decide a cor da bola
                let notifHTML = "";
                if (hasNew) {
                    // Bola Vermelha com Anima√ß√£o
                    notifHTML = `<span class="notif-badge" style="background-color: #e74c3c; animation: pulse-dot 2s infinite;" title="Novos Posts">!</span>`;
                } else if (hasEdit) {
                    // Bola Laranja (Sem anima√ß√£o ou mais calma)
                    notifHTML = `<span class="notif-badge" style="background-color: #f39c12;" title="Edi√ß√µes Recentes">!</span>`;
                }

                const isOwner = item.userId === myUid;
                
                li.innerHTML = `
                    <span>${isOwner ? 'üëë' : 'ü§ù'} ${item.nome}</span>
                    ${notifHTML}
                    <button class="item-menu-btn">‚Ä¶</button>
                `;
                
                if (isOwner && item.partilhado !== "ativo") li.style.opacity = "0.7";
                
                middlePanelList.appendChild(li);
                
                // Configurar clique
                li.onclick = (e) => {
                    if (e.target.closest('.item-menu-btn')) return;
                    window.displayArchive(item.id, item, li);
                };
            });
            console.log("‚úÖ Lista de Partilha atualizada com estados precisos.");
    };

    // Queries (Mant√™m-se iguais)
    const q1 = query(foldersRef, where('userId', '==', myUid), where('tipo', '==', 'partilhado'), where('estado', '==', 'ativa'));
    const q2 = query(foldersRef, where(`colaboradores.${myUid}`, '==', true), where('partilhado', '==', 'ativo'), where('tipo', '==', 'partilhado'), where('estado', '==', 'ativa'));

    unsubscribeShared1 = onSnapshot(q1, (snap) => {
        if (currentViewMode !== 'shared') return;
        snap.docChanges().forEach(c => resultsMap.set(c.doc.id, { ...c.doc.data(), id: c.doc.id }));
        renderUnifiedList();
    });

    unsubscribeShared2 = onSnapshot(q2, (snap) => {
        if (currentViewMode !== 'shared') return;
        snap.docChanges().forEach(c => resultsMap.set(c.doc.id, { ...c.doc.data(), id: c.doc.id }));
        renderUnifiedList();
    });
}

// Fun√ß√£o para converter RGB para Hex (para comparar cores)
function rgbToHex(rgb) {
    if (!rgb || rgb === 'transparent' || rgb === 'rgba(0, 0, 0, 0)') return '#000000'; // Default preto
    // Se j√° vier em hex, devolve logo
    if (rgb.startsWith('#')) return rgb;
    
    const rgbValues = rgb.match(/\d+/g);
    if (!rgbValues) return '#000000';
    
    return "#" + 
        ("0" + parseInt(rgbValues[0], 10).toString(16)).slice(-2) +
        ("0" + parseInt(rgbValues[1], 10).toString(16)).slice(-2) +
        ("0" + parseInt(rgbValues[2], 10).toString(16)).slice(-2);
}


window.toggleJournalToolbar = function(isJournalMode) {
    const popup = document.getElementById('formatting-popup');
    if (!popup) return;

    // Seletores dos bot√µes que queremos mover
    const buttons = {
        toggle: document.querySelector('button[data-action="insert-toggle-h2"]'), // ‚òÇ
        drag:   document.querySelector('button[data-action="make-draggable"]'),   // ·Øì
        check:  document.querySelector('button[data-action="insert-checkbox"]'),  // ‚òëÔ∏è
        hr:     document.querySelector('button[data-cmd-sec="insertHorizontalRule"]'), // ‚Äï
        table:  document.querySelector('button[data-action="insert-table"]'),     // üßÆ
        date:   document.querySelector('button[data-action="insert-date"]'),      // üìÖ
        time:   document.querySelector('button[data-action="insert-timeline"]')   // üå≥
    };

    // Grupos da Toolbar
    const groupStyle   = document.getElementById('group-style');   // Onde est√° a Cor
    const groupSimple  = document.getElementById('group-simple');  // Onde estavam Check/Linha
    const groupComplex = document.getElementById('group-complex'); // Onde estavam Tabela/Data
    const groupJournal = document.getElementById('group-journal-extras'); // Onde est√£o üñºÔ∏è ü™ß ü™™ üßä
    
    // Todos os separadores padr√£o da barra
    const allSeparators = document.querySelectorAll('#secondary-toolbar > .toolbar-separator');

    // === L√ìGICA DO MODO JORNAL ===
    if (isJournalMode) {
        
        // 1. MOSTRAR o grupo do Jornal
        if (groupJournal) groupJournal.style.display = 'flex';

        // 2. ESCONDER os grupos que v√£o ficar vazios (para n√£o ocuparem espa√ßo)
        if (groupSimple)  groupSimple.style.display = 'none';
        if (groupComplex) groupComplex.style.display = 'none';

        // 3. ESCONDER todos os separadores antigos
        allSeparators.forEach(sep => sep.style.display = 'none');

        // 4. CRIAR um separador especial entre a Cor e o grupo Jornal
        if (groupStyle) {
            groupStyle.style.borderRight = "1px solid var(--border-color)";
            groupStyle.style.paddingRight = "6px";
            groupStyle.style.marginRight = "6px";
        }

        // 5. MOVER bot√µes para o Popup
        if (!popup.querySelector('#journal-tools-container')) {
            const topContainer = document.createElement('div');
            topContainer.id = 'journal-tools-container';
            
            let defaultRow = popup.querySelector('.default-tools-row');
            if (!defaultRow) {
                defaultRow = document.createElement('div');
                defaultRow.className = 'default-tools-row';
                while (popup.firstChild) defaultRow.appendChild(popup.firstChild);
                popup.appendChild(defaultRow);
            }
            popup.insertBefore(topContainer, popup.firstChild);
        }

        const container = document.getElementById('journal-tools-container');
        popup.classList.add('journal-mode');

        Object.values(buttons).forEach(btn => {
            if (btn && container && btn.parentElement !== container) {
                container.appendChild(btn);
            }
        });

    } else {
        // === MODO NORMAL (RESTAURAR) ===
        
        popup.classList.remove('journal-mode');
        
        // 1. ESCONDER o grupo do Jornal
        if (groupJournal) groupJournal.style.display = 'none';

        // 2. MOSTRAR os grupos normais
        if (groupSimple)  groupSimple.style.display = 'flex';
        if (groupComplex) groupComplex.style.display = 'flex';

        // 3. MOSTRAR os separadores padr√£o
        allSeparators.forEach(sep => sep.style.display = 'block');

        // 4. REMOVER o estilo de separador do group-style
        if (groupStyle) {
            groupStyle.style.borderRight = "none";
            groupStyle.style.paddingRight = "0";
            groupStyle.style.marginRight = "0";
        }

        // 5. DEVOLVER bot√µes √† barra
        const container = document.getElementById('journal-tools-container');
        
        if (groupStyle) {
            if (buttons.toggle) groupStyle.appendChild(buttons.toggle);
            if (buttons.drag)   groupStyle.appendChild(buttons.drag);
        }
        if (groupSimple) {
            if (buttons.check) groupSimple.appendChild(buttons.check);
            if (buttons.hr)    groupSimple.appendChild(buttons.hr);
        }
        if (groupComplex) {
            if (buttons.table) groupComplex.appendChild(buttons.table);
            if (buttons.date)  groupComplex.appendChild(buttons.date);
            if (buttons.time)  groupComplex.appendChild(buttons.time);
        }
    }
};


// Listener para o bot√£o "Tr√™s Pontos" (‚ãÆ)
const moreOptionsBtn = document.getElementById('more-formatting-btn');

if (moreOptionsBtn) {
    // 1. Limpar ouvintes antigos
    const newBtn = moreOptionsBtn.cloneNode(true);
    moreOptionsBtn.parentNode.replaceChild(newBtn, moreOptionsBtn);

    // 2. OUVINTE BLINDADO
    newBtn.addEventListener('mousedown', (e) => { 
        // A. IMPEDE O ROUBO DE FOCO
        e.preventDefault(); 
        e.stopPropagation();

        // B. GUARDA O CURSOR (Essencial para o Jornal)
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            
            // Verifica se o cursor est√° numa √°rea v√°lida (Editor ou T√≠tulos de Caixas)
            const editor = document.getElementById('note-content-editor');
            const isInEditor = editor && editor.contains(range.commonAncestorContainer);
            
            if (isInEditor) {
                journalCursorRange = range.cloneRange();
                console.log("üìç [JORNAL] Posi√ß√£o do cursor guardada.");
            }
        }
    });

    // Nota: O evento 'click' para abrir o menu continua a ser gerido 
    // pelo listener principal do 'editorToolbar', por isso n√£o precisamos de o adicionar aqui.
}


// ============================================================
// MOTOR DE WIDGETS DO JORNAL (IMAGENS E EXTRAS)
// ============================================================
noteContentEditor.addEventListener('click', (e) => {
    const target = e.target;

    // 1. CONVERTER URL EM IMAGEM (Bot√£o OK)
    if (target.classList.contains('cmd-convert-img')) {
        const wrapper = target.closest('.journal-img-wrapper');
        const input = wrapper.querySelector('input');
        const url = input.value.trim();

        if (!url) return alert("Insira um link de imagem.");

        // Substitui o placeholder pela imagem real + interface de edi√ß√£o
        wrapper.innerHTML = `
            <img src="${url}" onerror="this.src='https://via.placeholder.com/300?text=Erro+Imagem'">
            <button class="journal-img-edit-btn">Editar</button>
            <div class="journal-img-menu">
                <button data-act="change-link">üîó Mudar Link</button>
                <button data-act="resize-sm">‚ñ´Ô∏è Pequena</button>
                <button data-act="resize-md">‚óªÔ∏è M√©dia</button>
                <button data-act="resize-lg">‚¨ú Grande</button>
                <button data-act="resize-xl">‚¨õ Gigante</button>
                <hr style="width:100%; border:0; border-top:1px solid #444; margin:2px 0;">
                <button data-act="remove-img" style="color:#e74c3c;">üóëÔ∏è Remover</button>
            </div>
        `;
        saveNote();
    }

    // 2. ABRIR MENU EDITAR
    else if (target.classList.contains('journal-img-edit-btn')) {
        const wrapper = target.closest('.journal-img-wrapper');
        const menu = wrapper.querySelector('.journal-img-menu');
        
        // Fecha outros menus abertos
        document.querySelectorAll('.journal-img-menu').forEach(m => {
            if(m !== menu) m.classList.remove('visible');
        });

        menu.classList.toggle('visible');
    }

    // 3. A√á√ïES DO MENU
    else if (target.closest('.journal-img-menu')) {
        const btn = target.closest('button');
        if (!btn) return;
        
        const wrapper = btn.closest('.journal-img-wrapper');
        const action = btn.dataset.act;
        const menu = wrapper.querySelector('.journal-img-menu');

        // A. REMOVER
        if (action === 'remove-img') {
            if(confirm("Remover imagem?")) wrapper.remove();
        } 
        
        // B. MUDAR LINK (Volta ao estado input)
        else if (action === 'change-link') {
            const currentSrc = wrapper.querySelector('img').src;
            wrapper.innerHTML = `
                <div class="journal-img-placeholder">
                    <span>üñºÔ∏è</span>
                    <input type="text" value="${currentSrc}" class="img-url-input">
                    <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px;">OK</button>
                </div>`;
        }

        // C. REDIMENSIONAR
        else if (action.startsWith('resize-')) {
            const size = action.split('-')[1]; // sm, md, lg, xl
            // Remove classes antigas
            wrapper.classList.remove('img-size-sm', 'img-size-md', 'img-size-lg', 'img-size-xl');
            // Adiciona a nova
            wrapper.classList.add(`img-size-${size}`);
            menu.classList.remove('visible');
        }

        saveNote();
    }
    
    // Fechar menu se clicar fora (dentro do editor)
    else {
        document.querySelectorAll('.journal-img-menu').forEach(m => m.classList.remove('visible'));
    }
});

// ============================================================
// LISTENER ESPEC√çFICO PARA OS EXTRAS DO JORNAL (Barra Secund√°ria)
// ============================================================
 const secToolbar = document.getElementById('secondary-toolbar');

if (secToolbar) {
    // Removemos listener antigo para garantir que n√£o duplica
    const newSecToolbar = secToolbar.cloneNode(true);
    secToolbar.parentNode.replaceChild(newSecToolbar, secToolbar);

    newSecToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        // AQUI EST√Å A DEFINI√á√ÉO QUE FALTAVA
        const action = btn.dataset.action; 
        
        // Fun√ß√£o auxiliar de inser√ß√£o com Scroll Garantido
    const insertWidget = (html, id, focusSelector) => {
            const editor = document.getElementById('note-content-editor');
            
            // 1. Garante foco no editor antes de inserir
            if (document.activeElement !== editor && !editor.contains(document.activeElement)) {
                editor.focus();
            }
            
            // 2. Insere o HTML
            document.execCommand('insertHTML', false, html);
            
            if (typeof updateSaveStatus === 'function') updateSaveStatus('unsaved');
            
            // 3. Foco e Scroll Suave (Sequ√™ncia Invertida para Suavidade)
            setTimeout(() => {
                const element = document.getElementById(id);
                if (element) {
                    // A. FOCA PRIMEIRO (Permite que o browser calcule o teclado/posi√ß√£o bruta)
                    const inputToFocus = element.querySelector(focusSelector);
                    if (inputToFocus) {
                        inputToFocus.focus();
                        if (inputToFocus.tagName === 'INPUT') inputToFocus.select(); 
                        else {
                            const range = document.createRange();
                            range.selectNodeContents(inputToFocus);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }

                    // B. SCROLL SUAVE DEPOIS (Corrige a posi√ß√£o visualmente para o centro)
                    // Usamos requestAnimationFrame para garantir que ocorre no frame seguinte ao foco
                    requestAnimationFrame(() => {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                }
            }, 50); // Delay reduzido de 100 para 50 para parecer mais instant√¢neo

            if (typeof saveNote === 'function') saveNote(false);
        };

        // 1. INSERIR IMAGEM (üñºÔ∏è)
        if (action === 'insert-image') {
            e.preventDefault(); e.stopPropagation();
            const uniqueId = `img_${Date.now()}`;
            const widgetHTML = `
                <div class="journal-img-wrapper img-size-md" id="${uniqueId}" contenteditable="false">
                    <div class="journal-img-placeholder">
                        <span style="font-size: 24px;">üñºÔ∏è</span>
                        <input type="text" placeholder="Cole o link da imagem aqui..." class="img-url-input">
                        <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px; cursor:pointer;">OK</button>
                    </div>
                </div><p><br></p>`;
            insertWidget(widgetHTML, uniqueId, 'input');
        }

        // 2. INSERIR PLACA/RACIOC√çNIO (ü™ß)
        else if (action === 'insert-sign') {
            e.preventDefault();
            const uniqueId = `sign_${Date.now()}`;
            const signHTML = `
                <div class="journal-sign-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="sign-toolbar">
                        <span style="font-size: 1.2em; margin-right: auto;">ü™ß Racioc√≠nio<span class="sign-number-display"></span></span>
                        <button class="sign-move-btn" onclick="window.moveSign(this, -1)" title="Mover para Cima">‚ñ≤</button>
                        <button class="sign-move-btn" onclick="window.moveSign(this, 1)" title="Mover para Baixo">‚ñº</button>
                        <span style="border-left:1px solid rgba(0,0,0,0.2); height:15px; margin:0 5px;"></span>
                        <button class="sign-btn-del" onclick="window.confirmSignDelete(this)" title="Mover para a Reciclagem">üóëÔ∏è</button>
                    </div>
                    <div class="sign-header">
                        <input type="text" class="sign-title-input" placeholder="Linha de Racioc√≠nio..." value="">
                    </div>
                    <div class="sign-content" contenteditable="true" data-placeholder="Escreva a sua resposta ou racioc√≠nio aqui..."></div>
                    <div class="sign-attachments-area"></div>
                    <div class="sign-add-btn-area">
                        <button class="sign-add-btn" onclick="window.addAttachmentToSign(this)">+</button>
                    </div>
                </div><p><br></p>`;
            insertWidget(signHTML, uniqueId, '.sign-title-input');
        }

        // 3. INSERIR CART√ÉO TEM√ÅTICO (ü™™)
        else if (action === 'insert-card') {
            e.preventDefault();
            const uniqueId = `card_${Date.now()}`;
            const cardHTML = `
                <div class="journal-id-card" id="${uniqueId}" contenteditable="false">
                    <div class="card-toolbar">
                        <button onclick="window.moveSign(this, -1)" title="Mover Cima">‚ñ≤</button>
                        <button onclick="window.moveSign(this, 1)" title="Mover Baixo">‚ñº</button>
                        <button class="card-del-btn" onclick="window.deleteJournalWidget(this)">üóëÔ∏è</button>
                    </div>
                    <div class="card-body">
                        <div class="card-image-area">
                            <div class="card-img-placeholder" onclick="window.setCardImage(this)">
                                <span>üì∑</span><small>Add Foto</small>
                            </div>
                        </div>
                        <div class="card-text-area">
                            <input type="text" class="card-title-input" placeholder="Nome / T√≠tulo" value="">
                            <div class="card-desc-content" contenteditable="true" data-placeholder="Detalhes, biografia ou descri√ß√£o..."></div>
                        </div>
                    </div>
                </div><p><br></p>`;
            insertWidget(cardHTML, uniqueId, '.card-title-input');
        }

        // 4. INSERIR CUBO (üßä)
        else if (action === 'insert-cube') {
            e.preventDefault();
            const uniqueId = `cube_${Date.now()}`;
            const cubeHTML = `
                <div class="journal-cube-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cube-toolbar" contenteditable="false">
                        <span class="cube-drag-handle" title="Segure para arrastar" draggable="true">‚ú•</span>
                        <div style="width:1px; background:#555; margin:0 4px;"></div>
                        <button data-cmd="float-left" title="Esquerda">‚¨Ö</button>
                        <button data-cmd="float-none" title="Largura Total">‚¨õ</button>
                        <button data-cmd="float-right" title="Direita">‚û°</button>
                        <div style="width:1px; background:#555; margin:0 4px;"></div>
                        <button data-cmd="delete-cube" style="color:#e74c3c;">üóëÔ∏è</button>
                    </div>
                    <div class="cube-content" contenteditable="true">
                        <strong>üßä T√≠tulo do Bloco</strong>
                        <p>Escreva aqui o seu texto...</p>
                    </div>
                </div><p style="clear:both;"><br></p>`;
            insertWidget(cubeHTML, uniqueId, '.cube-content');
        }

        // 5. INSERIR DUAS COLUNAS (‚è∏Ô∏è)
        else if (action === 'insert-2-cols') {
            e.preventDefault(); e.stopPropagation();
            const uniqueId = `cols_${Date.now()}`;
            const colsHTML = `
                <div class="journal-cols-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cols-toolbar">
                        <span style="font-size:10px; color:#888; margin-right:5px;">COLUNAS</span>
                        <button class="cols-btn-del" onclick="window.deleteCols(this)" title="Apagar Colunas">üóëÔ∏è</button>
                    </div>
                    <div class="journal-cols-container">
                        <div class="journal-col" contenteditable="true" data-placeholder="Escreva na esquerda..."></div>
                        <div class="journal-col" contenteditable="true" data-placeholder="Escreva na direita..."></div>
                    </div>
                </div><p><br></p>`;
            insertWidget(colsHTML, uniqueId, '.journal-col');
        }
    });
}

 

// ============================================================
// MOTOR DE INTERA√á√ÉO DO CUBO (ALINHAMENTO E REMO√á√ÉO)
// ============================================================
noteContentEditor.addEventListener('click', async (e) => {
    // Procura por um bot√£o dentro do editor
    const btn = e.target.closest('button');
    const toggleColorBtn = e.target.closest('.toggle-color-btn');

    // Se n√£o clicou num bot√£o, sai (evita o erro)
    if (!btn && !toggleColorBtn) return;

    // --- CORRE√á√ÉO DO ERRO ---
    // Define 'action' com seguran√ßa. Se n√£o existir dataset, fica indefinido mas n√£o quebra.
    const action = btn ? btn.dataset.action : null;

    // --- 1. Bot√£o de Cor (üé®) ---
    if (action === 'highlight-color') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
        if (wrapper) openHighlightPopup(wrapper);
        return;
    }

    // --- 2. Bot√£o de T√≥picos (üìã) ---
    if (action === 'manage-mini-note-topics') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper');
        if (wrapper) openTopicsModalForMiniNote(wrapper);
        return;
    }

    // --- 3. Bot√£o de Links (‚ö°) ---
    if (action === 'manage-box-links') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
        if (wrapper) openBoxLinkManager(wrapper);
        return;
    }

    // --- 4. Bot√£o de Cor do Toggle (üñåÔ∏è) ---
    if (toggleColorBtn) {
        e.preventDefault(); e.stopPropagation();
        activeToggleForColor = toggleColorBtn.closest('details.toggle-section');
        const rect = toggleColorBtn.getBoundingClientRect();
        const popup = document.getElementById('toggle-color-popup');
        popup.style.display = 'block';
        popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        popup.style.left = `${(rect.left + window.scrollX) - 100}px`;
        return;
    }

    // --- 5. Bot√£o Enviar para Nota (üß¨) ---
    if (action === 'append-mini-note') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
        if (wrapper) {
            htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
            openAppendModal();
        }
        return;
    }
    
    // --- 6. ELIMINAR ENTIDADE (üóëÔ∏è) ---
    // Este listener global serve para apagar subnotas, redatores e cart√µes antigos.
    // A caixa ü™ß J√Å TEM O SEU PR√ìPRIO ONCLICK no HTML (confirmSignDelete), 
    // por isso este bloco n√£o interferir√°.
    if (action === 'delete-mini-note') {
        e.preventDefault(); 
        e.stopImmediatePropagation(); 
        
        if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);
        
        const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
        if (!wrapper) return;

        // Se for ü™ß (Sign), o onclick inline deve tratar disso, mas por seguran√ßa:
        if (wrapper.classList.contains('journal-sign-wrapper')) {
            window.confirmSignDelete(btn);
            return;
        }

        // L√≥gica para outros tipos
        const confirmed = await showConfirmation("Mover para a Lixeira?", "Deseja ocultar este item?");
        if (confirmed) {
            await archiveMiniNote(wrapper);
        }
    }
});


// ============================================================
// L√ìGICA DA CAIXA DE RACIOC√çNIO (PLACA ü™ß)
// ============================================================

// 1. Fun√ß√£o chamada pelo bot√£o "+"
window.addAttachmentToSign = function(btn) {
    activeSignBtn = btn; // Guarda a refer√™ncia do bot√£o clicado
    
    const modal = document.getElementById('attachment-modal');
    const input = document.getElementById('attachment-url-input');
    
    if (!modal) return;

    // Limpa e prepara o modal
    input.value = "";
    
    // Move para o body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.opacity = "1";
    modal.style.visibility = "visible";
    
    // Foca no input
    setTimeout(() => input.focus(), 100);
};

// 2. L√≥gica do Bot√£o "Adicionar" (Dentro do Modal)
document.getElementById('confirm-attachment-btn').addEventListener('click', () => {
    const input = document.getElementById('attachment-url-input');
    const url = input.value.trim();
    const modal = document.getElementById('attachment-modal');

    if (!url) {
        alert("Por favor, insira um link.");
        return;
    }

    if (activeSignBtn) {
        processAttachment(url, activeSignBtn);
    }

    modal.style.display = 'none';
    activeSignBtn = null; // Limpa a refer√™ncia
});

// 3. L√≥gica do Bot√£o "Cancelar"
document.getElementById('cancel-attachment-btn').addEventListener('click', () => {
    document.getElementById('attachment-modal').style.display = 'none';
    activeSignBtn = null;
});

// 4. Permitir "Enter" no input para confirmar
document.getElementById('attachment-url-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('confirm-attachment-btn').click();
    }
});

// 5. Fun√ß√£o que processa o URL e cria o HTML (Separada para organiza√ß√£o)
function processAttachment(url, btn) {
    const wrapper = btn.closest('.journal-sign-wrapper');
    const container = wrapper.querySelector('.sign-attachments-area');

    // Garante protocolo
    let finalUrl = url.trim();
    if (!finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;

    // Tenta obter um nome curto para mostrar (dom√≠nio ou nome do ficheiro)
    let displayName = finalUrl;
    try {
        const urlObj = new URL(finalUrl);
        displayName = urlObj.hostname.replace('www.', '') + (urlObj.pathname.length > 1 ? '/...' : '');
        // Se for imagem, mostra o nome do ficheiro
        if (/\.(jpeg|jpg|gif|png|webp)$/i.test(finalUrl)) {
            displayName = "üñºÔ∏è " + finalUrl.split('/').pop();
        } else {
            displayName = "üîó " + displayName;
        }
    } catch (e) { }

    const div = document.createElement('div');
    div.className = 'sign-attachment-row';
    
    // HTML da Linha: Texto (que √© o link) + Bot√µes de Editar e Apagar
    div.innerHTML = `
        <a href="${finalUrl}" target="_blank" class="sign-link-text" title="${finalUrl}">${displayName}</a>
        
        <button class="sign-row-btn" title="Editar Link" onclick="window.editSignAttachment(this)">‚úèÔ∏è</button>
        <button class="sign-row-btn delete" title="Remover" onclick="window.deleteSignAttachment(this)">üóëÔ∏è</button>
        
        <input type="hidden" class="real-url-val" value="${finalUrl}">
    `;

    container.appendChild(div);
    
    if (typeof saveNote === 'function') saveNote();
}

// ============================================================
// FUN√á√ÉO PARA MOVER CAIXAS DE RACIOC√çNIO
// ============================================================
window.moveSign = function(btn, direction) {
    // Procura o wrapper pai mais pr√≥ximo que corresponda a QUALQUER tipo de caixa
    const wrapper = btn.closest('.journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
    
    if (!wrapper) {
        console.error("Erro: Caixa n√£o encontrada para mover.");
        return;
    }

    const parent = wrapper.parentNode;
    
    // MOVER PARA CIMA
    if (direction === -1) {
        let prev = wrapper.previousElementSibling;
        
        // Salta elementos de espa√ßamento (br ou p vazios)
        while (prev && (prev.tagName === 'BR' || (prev.tagName === 'P' && prev.textContent.trim() === ''))) {
            prev = prev.previousElementSibling;
        }

        if (prev) {
            // Insere antes do elemento anterior
            parent.insertBefore(wrapper, prev);
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if (typeof saveNote === 'function') saveNote();
        }
    } 
    // MOVER PARA BAIXO
    else {
        let next = wrapper.nextElementSibling;
        
        // Salta elementos de espa√ßamento
        while (next && (next.tagName === 'BR' || (next.tagName === 'P' && next.textContent.trim() === ''))) {
            next = next.nextElementSibling;
        }

        if (next) {
            // Insere depois do pr√≥ximo elemento (usando nextSibling do pr√≥ximo)
            parent.insertBefore(wrapper, next.nextSibling);
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if (typeof saveNote === 'function') saveNote();
        }
    }
};


// Fun√ß√£o para Editar um anexo da lista
window.editSignAttachment = function(btn) {
    activeEditRow = btn.closest('.sign-attachment-row');
    const hiddenInput = activeEditRow.querySelector('.real-url-val');
    const modal = document.getElementById('edit-link-modal');
    const input = document.getElementById('edit-link-url-input');

    if (!modal || !hiddenInput) return;

    // Preenche o input com o valor atual
    input.value = hiddenInput.value;

    // Move para o body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';

    setTimeout(() => input.focus(), 100);
};

// Listener do Bot√£o Gravar (Fora da fun√ß√£o para n√£o duplicar eventos)
const confirmEditBtn = document.getElementById('confirm-edit-link-btn');
if (confirmEditBtn) {
    confirmEditBtn.addEventListener('click', () => {
        const input = document.getElementById('edit-link-url-input');
        const modal = document.getElementById('edit-link-modal');
        const newUrl = input.value.trim();

        if (newUrl && activeEditRow) {
            let finalUrl = newUrl;
            if (!finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;

            // Atualiza os elementos na linha
            const linkEl = activeEditRow.querySelector('a.sign-link-text');
            const hiddenInput = activeEditRow.querySelector('.real-url-val');
            const openBtn = activeEditRow.querySelector('button[title="Ir para p√°gina"]');

            linkEl.href = finalUrl;
            linkEl.title = finalUrl;
            hiddenInput.value = finalUrl;
            if(openBtn) openBtn.setAttribute('onclick', `window.open('${finalUrl}', '_blank')`);

            // Atualiza o nome de exibi√ß√£o
            try {
                const urlObj = new URL(finalUrl);
                let displayName = urlObj.hostname.replace('www.', '') + (urlObj.pathname.length > 1 ? '/...' : '');
                if (/\.(jpeg|jpg|gif|png|webp)$/i.test(finalUrl)) {
                    displayName = "üñºÔ∏è " + finalUrl.split('/').pop();
                } else {
                    displayName = "üîó " + displayName;
                }
                linkEl.textContent = displayName;
            } catch(e) { 
                linkEl.textContent = "üîó " + finalUrl; 
            }

            if (typeof saveNote === 'function') saveNote();
        }

        modal.style.display = 'none';
        activeEditRow = null;
    });
}

window.deleteSignAttachment = async function(btn) {
    // Usa o seu modal de confirma√ß√£o existente
    const confirmed = await showConfirmation(
        "Remover Link?", 
        "Deseja remover este anexo da lista?"
    );

    if (confirmed) {
        const row = btn.closest('.sign-attachment-row');
        if (row) row.remove();
        if (typeof saveNote === 'function') saveNote();
    }
};

// Fun√ß√£o para definir a imagem do Cart√£o Tem√°tico
window.setCardImage = function(element) {
    activeCardImageElement = element; // Guarda a refer√™ncia
    
    const modal = document.getElementById('card-image-modal');
    const input = document.getElementById('card-image-url-input');
    
    if (!modal) return;

    // Se j√° tiver imagem, preenche o input com o URL atual
    if (element.tagName === 'IMG') {
        input.value = element.src;
    } else {
        input.value = "";
    }

    // Move para o body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    
    setTimeout(() => input.focus(), 100);
};

// 2. L√≥gica do Bot√£o Confirmar
const confirmImgBtn = document.getElementById('confirm-card-image-btn');
if (confirmImgBtn) {
    confirmImgBtn.addEventListener('click', () => {
        const input = document.getElementById('card-image-url-input');
        const modal = document.getElementById('card-image-modal');
        const url = input.value.trim();

        if (url && activeCardImageElement) {
            // Cria a tag de imagem
            const imgHTML = `<img src="${url}" class="card-real-img" onclick="window.setCardImage(this)" title="Clique para alterar" onerror="this.src='https://via.placeholder.com/150?text=Erro'">`;
            
            // Substitui√ß√£o
            if (activeCardImageElement.classList.contains('card-img-placeholder')) {
                activeCardImageElement.outerHTML = imgHTML;
            } 
            else if (activeCardImageElement.tagName === 'IMG') {
                activeCardImageElement.src = url;
            }
            
            if (typeof saveNote === 'function') saveNote();
        }

        modal.style.display = 'none';
        activeCardImageElement = null;
    });
}

// 3. Permitir Enter para confirmar
document.getElementById('card-image-url-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('confirm-card-image-btn').click();
    }
});


// Fun√ß√£o para apagar o bloco de colunas
window.deleteCols = async function(btn) {
    // Usa o modal de confirma√ß√£o bonito
    const confirmed = await showConfirmation(
        "Apagar Colunas?", 
        "Todo o conte√∫do dentro das colunas ser√° perdido."
    );

    if (confirmed) {
        const wrapper = btn.closest('.journal-cols-wrapper');
        if (wrapper) {
            wrapper.remove();
            if (typeof saveNote === 'function') saveNote();
        }
    }
};

// --- FUN√á√ïES DO REDATOR ---

// 1. Adicionar Novo Redator Abaixo (+)
window.addRedatorBelow = function(currentId) {
    const currentWrapper = document.getElementById(currentId);
    if (!currentWrapper) return;

    // 1. Guardar posi√ß√£o atual do scroll para restaurar se necess√°rio
    const editor = document.getElementById('note-content-editor');
    const savedScroll = editor.scrollTop;

    // 2. Criar os elementos novos em mem√≥ria
    // Cria um par√°grafo de espa√ßamento
    const spacer = document.createElement('p');
    spacer.innerHTML = '<br>';

    // Gera o ID √∫nico para o novo redator
    const newId = `red_${Date.now()}`;
    const inputStyle = "user-select: text; -webkit-user-select: text; pointer-events: auto; touch-action: manipulation;";

    // Constr√≥i o HTML do novo Redator (usando a estrutura atualizada com o menu corrigido)
    const newRedatorHTML = `
        <div class="redator-wrapper" id="${newId}" contenteditable="false" data-shared="false" data-box-links='{}' data-paragraph="0">
            <button class="redator-reopen-btn" onclick="window.toggleRedatorHeader('${newId}', true)">T</button>
            <button class="redator-collapsed-menu-btn" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>

            <div class="redator-slide-menu">
                <button class="tool-icon-btn" data-action="sharing-settings" title="Partilha">üîê</button>
                <button class="tool-icon-btn" data-action="manage-box-links" title="Links/Codex">‚ö°</button>
                <button class="tool-icon-btn" data-action="move-up" title="Subir">üî∫</button>
                <button class="tool-icon-btn" data-action="move-down" title="Descer">üîª</button>
                <button class="tool-icon-btn" data-action="highlight-color" title="Cor">üé®</button>
                <button class="tool-icon-btn" data-action="manage-mini-note-topics" title="T√≥picos">üìã</button>
                <button class="tool-icon-btn" data-action="append-mini-note" title="Clonar">üß¨</button>
                <div style="width:1px; background:rgba(255,255,255,0.2); height:15px; margin:0 2px;"></div>
                <button class="tool-icon-btn" data-action="delete-mini-note" style="color:#e74c3c;">üóëÔ∏è</button>
            </div>

            <div class="redator-header" id="header-${newId}">
               <input type="text" class="redator-input" placeholder="T√≠tulo do Redator..." value="" 
                      oninput="this.setAttribute('value', this.value)" 
                      style="${inputStyle}">
                <div class="redator-top-tools">
                    <button class="redator-menu-trigger" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>
                </div>
            </div>
            
            <div class="redator-content" contenteditable="true" data-placeholder="" oninput="window.checkRedatorFocus(this, '${newId}')"><p><br></p></div>
            
            <div class="redator-dock">
                 <button class="dock-btn" onclick="event.preventDefault(); window.openRedatorFocus('${newId}')"><svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg></button>
                 <div class="dock-sep"></div>
                 <button class="dock-btn" onclick="event.preventDefault(); window.addRedatorBelow('${newId}')"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
            </div>
        </div>
        <p><br></p>`;

    // 3. Inser√ß√£o Cir√∫rgica (Sem reescrever o innerHTML todo)
    // Insere o par√°grafo de espa√ßamento
    currentWrapper.insertAdjacentElement('afterend', spacer);
    
    // Insere o novo redator DEPOIS do espa√ßamento
    spacer.insertAdjacentHTML('afterend', newRedatorHTML);

    // 4. Corre√ß√£o de Scroll IMEDIATA
    // Se o browser tentou saltar para o topo, for√ßamos de volta
    if (editor.scrollTop !== savedScroll) {
        editor.scrollTop = savedScroll;
    }

    // 5. Scroll Suave apenas para mostrar o novo elemento
    // Pequeno delay para garantir que o elemento j√° existe visualmente
 setTimeout(() => {
        const newEl = document.getElementById(newId);
        if (newEl) {
            // A. Focar primeiro (o browser tenta scrollar para o foco)
            const input = newEl.querySelector('.redator-input');
            if (input) input.focus();

            // B. For√ßar o scroll suave para o centro do ecr√£
            newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);

    // 6. Grava
    if (typeof updateRedatorParagraphs === 'function') updateRedatorParagraphs();
    saveNote();
};

// Vari√°vel para saber qual redator est√° no popup
let activeRedatorFocusId = null;

// 2. Abrir Modo Foco (Popup)
window.openRedatorFocus = function(id) {
    // 1. Verifica√ß√µes
    if (activeRedatorPopups.includes(id)) {
        alert("Este Redator j√° est√° aberto numa janela.");
        return;
    }
    
    if (activeRedatorPopups.length >= MAX_POPUPS) {
        alert("M√°ximo de 3 janelas abertas simultaneamente.");
        return;
    }

    const wrapper = document.getElementById(id);
    if (!wrapper) return;

    // 2. Bloquear o Original
    wrapper.classList.add('in-popup-mode');
    activeRedatorPopups.push(id);

    // 3. Capturar Dados Atuais
    const titleVal = wrapper.querySelector('.redator-input').value;
    const contentHTML = wrapper.querySelector('.redator-content').innerHTML;

    // 4. Criar a Janela Flutuante
    const popupId = `popup-${id}`;
    const popup = document.createElement('div');
    popup.className = 'redator-popup-window';
    popup.id = popupId;
    
    // Posi√ß√£o em cascata (para n√£o ficarem umas cima das outras)
    const offset = activeRedatorPopups.length * 30;
    popup.style.top = `${100 + offset}px`;
    popup.style.left = `${100 + offset}px`;
    popup.style.zIndex = ++highestZIndex;

    // HTML da Janela
    popup.innerHTML = `
        <div class="redator-popup-header">
            <span class="popup-title-label">üìì Redator Flutuante</span>
            <button class="btn-close-popup" title="Fechar e Salvar" onclick="window.closeRedatorPopup('${id}')">‚úï</button>
        </div>
        <div class="redator-popup-body">
            <input type="text" class="redator-input" placeholder="T√≠tulo..." value="${titleVal}">
            <div class="redator-content" contenteditable="true" spellcheck="false">${contentHTML}</div>
        </div>
    `;

    // 5. Injetar no Body e Ativar Arrasto
    document.body.appendChild(popup);
    makeElementDraggable(popup);

    // Focar ao abrir
    popup.onclick = () => { popup.style.zIndex = ++highestZIndex; };
};

// FECHAR POPUP E SINCRONIZAR
window.closeRedatorPopup = function(originalId) {
    const popup = document.getElementById(`popup-${originalId}`);
    const originalWrapper = document.getElementById(originalId);

    if (popup && originalWrapper) {
        // 1. Recuperar Dados
        const newTitle = popup.querySelector('.redator-input').value;
        const newContent = popup.querySelector('.redator-content').innerHTML;

        // 2. Injetar no Original
        originalWrapper.querySelector('.redator-input').value = newTitle;
        originalWrapper.querySelector('.redator-content').innerHTML = newContent;

        // 3. Restaurar Original
        originalWrapper.classList.remove('in-popup-mode');
        
        // 4. Gravar Nota
        saveNote(true);
    }

    // 5. Limpeza
    if (popup) popup.remove();
    activeRedatorPopups = activeRedatorPopups.filter(id => id !== originalId);
};

// 3. Fechar e Gravar Modo Foco
window.closeRedatorFocus = function() {
    const modal = document.getElementById('redator-focus-modal');
    const container = document.getElementById('redator-focus-container');
    const originalWrapper = document.getElementById(activeRedatorFocusId);

    if (originalWrapper && container.children.length > 0) {
        const clone = container.firstElementChild;
        
        // 1. Recuperar dados editados no modal
        const newTitle = clone.querySelector('.redator-input').value;
        const newContent = clone.querySelector('.redator-content').innerHTML;

        // 2. Injetar de volta na nota original
        originalWrapper.querySelector('.redator-input').value = newTitle;
        originalWrapper.querySelector('.redator-content').innerHTML = newContent;

        // 3. Gravar
        saveNote(true);
    }

    modal.style.display = 'none';
    activeRedatorFocusId = null;
};

// --- FUN√á√ÉO DE TOGGLE DO MENU REDATOR ---
window.toggleRedatorMenu = function(btn) {
    // 1. Encontra o wrapper pai (a caixa toda)
    const wrapper = btn.closest('.redator-wrapper');
    if (!wrapper) return;

    // 2. Encontra o menu dentro desse wrapper (agora funciona para os dois bot√µes)
    const menu = wrapper.querySelector('.redator-slide-menu');
    if (!menu) return;

    // 3. Fecha todos os outros menus abertos (para limpar a tela)
    document.querySelectorAll('.redator-slide-menu.visible').forEach(m => {
        if (m !== menu) m.classList.remove('visible');
    });

    // 4. Alterna o estado deste menu
    menu.classList.toggle('visible');
};



// --- L√ìGICA DE FOCO DO REDATOR ---

// 1. Verifica se deve esconder o t√≠tulo enquanto escreve
window.checkRedatorFocus = function(contentDiv, uniqueId) {
    const wrapper = document.getElementById(uniqueId);
    const titleInput = wrapper.querySelector('.redator-input');
    const header = document.getElementById(`header-${uniqueId}`);

    // Usa trim() para ignorar espa√ßos acidentais do teclado mobile
    const hasNoTitle = titleInput.value.trim() === "";
    const hasBodyContent = contentDiv.innerText.trim().length > 0;

    if (hasNoTitle && hasBodyContent) {
        if (!wrapper.classList.contains('header-hidden')) {
            wrapper.classList.add('header-hidden');
            header.classList.add('collapsed');
        }
    }
};

// 2. Reabre ou Fecha o t√≠tulo manualmente (Bot√£o T)
window.toggleRedatorHeader = function(uniqueId, forceShow = false) {
    const wrapper = document.getElementById(uniqueId);
    const header = document.getElementById(`header-${uniqueId}`);
    const input = wrapper.querySelector('.redator-input');

    if (forceShow) {
        // Mostrar
        wrapper.classList.remove('header-hidden');
        header.classList.remove('collapsed');
        // Foca no input para o user escrever o t√≠tulo logo
        setTimeout(() => input.focus(), 300);
    } else {
        // Esconder (opcional, se quiseres fechar manualmente noutro lugar)
        wrapper.classList.add('header-hidden');
        header.classList.add('collapsed');
    }
};

// --- FUN√á√ÉO: ATUALIZAR PAR√ÅGRAFOS DO REDATOR ---
function updateRedatorParagraphs() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    // Seleciona todos os redatores pela ordem em que aparecem no ecr√£
    const redators = editor.querySelectorAll('.redator-wrapper');

    redators.forEach((wrapper, index) => {
        // O √≠ndice come√ßa em 0, por isso somamos 1
        const novoParagrafo = index + 1;
        
        // Atualiza o atributo no HTML (que ser√° salvo no Firebase)
        wrapper.setAttribute('data-paragraph', novoParagrafo);
        
    });
}

// Fun√ß√£o de arrastar janelas (Gen√©rica)
function makeElementDraggable(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    // Tenta encontrar o cabe√ßalho (pode ter nomes diferentes dependendo da janela)
    const header = elmnt.querySelector(".aq-popup-header") || elmnt.querySelector(".redator-popup-header");
    
    if (header) {
        // Se o cabe√ßalho existir, √© por l√° que arrastamos
        header.onmousedown = dragMouseDown;
    } else {
        // Se n√£o tiver cabe√ßalho, arrasta-se pelo corpo (fallback)
        elmnt.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        
        // Traz a janela para a frente de todas as outras ao clicar
        // Usa a vari√°vel global highestZIndex se existir, sen√£o usa timestamp
        if (typeof highestZIndex !== 'undefined') {
            elmnt.style.zIndex = ++highestZIndex;
        } else {
            elmnt.style.zIndex = Date.now(); 
        }
        
        // Pega a posi√ß√£o inicial do rato
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        
        // Calcula a nova posi√ß√£o
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // Define a nova posi√ß√£o do elemento
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        // Para de mover quando larga o bot√£o do rato
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

// ============================================================
// GEST√ÉO DAS ABAS DO PAINEL DO MEIO
// ============================================================

// 1. Listener de clique nas abas do fundo
document.querySelector('.middle-bottom-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. ATUALIZA O VISUAL (Remove active de todos, adiciona no clicado)
    document.querySelectorAll('.middle-bottom-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 2. ESCONDE TODAS AS VISTAS
    document.querySelectorAll('.middle-view').forEach(v => v.style.display = 'none');

    // 3. IDENTIFICA A VISTA ALVO
    const viewId = btn.dataset.midTab;
    let targetView;

    if (viewId === 'files') targetView = document.getElementById('file-list');
    else if (viewId === 'index') targetView = document.getElementById('note-index-list');
    else if (viewId === 'texts') targetView = document.getElementById('note-texts-view');
    else if (viewId === 'sources') targetView = document.getElementById('note-sources-list');

    // 4. MOSTRA A VISTA E DISPARA A L√ìGICA
    if (targetView) {
        targetView.style.display = 'block';
        
        // --- A. √çNDICE ---
        if (viewId === 'index') {
            generateNoteIndex();
        }
        
        // --- B. FONTES ---
        else if (viewId === 'sources') {
            generateNoteSources();
        }
        
    // --- C. TEXTOS / NAVEGA (L√≥gica Tripla Corrigida) ---
        else if (viewId === 'texts') {
            
            // Verifica o modo definido no bot√£o (pela fun√ß√£o refreshMiddlePanelTabIcon)
            if (btn.dataset.mode === 'hybrid') {
                generateHybridView(); // <--- FALTAVA ESTA CHAMADA
            } 
            else if (btn.dataset.mode === 'navega') {
                generateAnchorNavigation(); 
            } 
            else {
                generateNoteTexts(); 
            }
        }
    }
});

// 2. FUN√á√ÉO: GERAR √çNDICE (VISTA 2)
 function generateNoteIndex() {
    const list = document.getElementById('note-index-list');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    list.innerHTML = '';
    let hasItems = false;

    // --- MUDAN√áA 1: Adicionei '.idea-span' √† lista de seletores ---
    const elements = editor.querySelectorAll('.mini-note-wrapper, .redator-wrapper, details.toggle-section, .jwn-table-wrapper, .jwn-timeline-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .post-it-note, .idea-span');

    elements.forEach(el => {
        // GARANTIA: Se o elemento n√£o tiver ID, cria um agora
        if (!el.id) el.id = 'idx_' + Math.random().toString(36).substr(2, 9);

        let title = "Sem T√≠tulo";
        let icon = "üü¶";
        let typeLabel = "Item";
        let borderColor = "var(--border-color)";

        // --- L√ìGICA DE IDENTIFICA√á√ÉO ---
        
        // >>> NOVA L√ìGICA PARA IDEIAS (üí°) <<<
        if (el.classList.contains('idea-span')) {
            icon = "üí°"; 
            typeLabel = "Ideia";
            borderColor = "#e74c3c"; // VERMELHO
            
            // L√≥gica das 15 palavras
            const fullText = el.textContent.trim();
            const words = fullText.split(/\s+/); // Divide por espa√ßos
            
            if (words.length > 15) {
                title = words.slice(0, 15).join(" ") + "...";
            } else {
                title = fullText;
            }
        }
        // >>> FIM DO BLOCO IDEIA <<<
        
        else if (el.classList.contains('mini-note-wrapper')) {
            const input = el.querySelector('.mini-note-title-input');
            const content = el.querySelector('.mini-note-content');
            
            if (el.classList.contains('question-mode')) {
                icon = "üìó"; typeLabel = "Quest√£o"; borderColor = "#2ecc71";
                title = input ? (input.value || input.textContent) : "Pergunta";
            } else if (el.classList.contains('free-mode')) {
                icon = "üìô"; typeLabel = "Contentor"; borderColor = "#e67e22";
                title = content ? content.innerText.split('\n')[0].substring(0, 30) : "Texto Livre";
            } else {
                icon = "üìò"; typeLabel = "SubNota"; borderColor = "#3498db";
                title = input ? (input.value || input.textContent) : "SubNota";
            }
        } 
        else if (el.classList.contains('redator-wrapper')) {
            icon = "üìì"; typeLabel = "Redator"; borderColor = "#555555";
            const input = el.querySelector('.redator-input');
            title = input ? input.value : "Redator";
            if(!title || !title.trim()) {
                const content = el.querySelector('.redator-content');
                title = content ? content.innerText.split('\n')[0].substring(0, 30) : "Redator";
            }
        }
        else if (el.tagName === 'DETAILS') {
            icon = "‚òÇ"; typeLabel = "Sec√ß√£o"; borderColor = "#c0392b";
            const h2 = el.querySelector('h2');
            title = h2 ? h2.textContent : "T√≠tulo";
        }
        else if (el.classList.contains('post-it-note')) {
            icon = "üìí"; typeLabel = "Post-it"; borderColor = "#f1c40f"; title = "Post-it";
        }
        else if (el.classList.contains('journal-sign-wrapper')) {
            icon = "ü™ß"; typeLabel = "Racioc√≠nio"; borderColor = "#f1c40f";
            title = el.querySelector('.sign-title-input')?.value || "Racioc√≠nio";
        }
        else if (el.classList.contains('journal-id-card')) {
            icon = "ü™™"; typeLabel = "Cart√£o"; borderColor = "#795548";
            title = el.querySelector('.card-title-input')?.value || "Cart√£o";
        }
        else if (el.classList.contains('jwn-timeline-wrapper')) {
            icon = "üå≥"; typeLabel = "Timeline"; borderColor = "var(--accent-color)"; title = "Linha do Tempo";
        }
        else if (el.classList.contains('jwn-table-wrapper')) {
            icon = "üßÆ"; typeLabel = "Tabela"; borderColor = "var(--text-muted-color)"; title = "Tabela";
        }
        else if (el.classList.contains('journal-cube-wrapper')) {
            icon = "üßä"; typeLabel = "Cubo"; borderColor = "#4a90e2"; title = "Bloco Flutuante";
        }

        hasItems = true;
        const li = document.createElement('li');
        li.className = `index-item`;
        
        li.style.borderLeft = `4px solid ${borderColor}`;
        li.setAttribute('data-target-id', el.id); 
        
        if (!title || title.trim() === "") title = `(${typeLabel} sem t√≠tulo)`;

        li.innerHTML = `
            <span class="index-icon">${icon}</span>
            <div style="display:flex; flex-direction:column; width: 100%;">
                <span style="white-space:normal; word-break:break-word; font-weight:500; line-height:1.3;">${title}</span>
                <small style="color:var(--text-muted-color); font-size:0.8em; margin-top:2px;">${typeLabel}</small>
            </div>
        `;

        li.onclick = () => {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.remove('flash-target'); void el.offsetWidth; el.classList.add('flash-target');
            currentActiveScrollId = el.id;
            updateIndexVisuals(); 
        };

        list.appendChild(li);
    });

    if (!hasItems) {
        list.innerHTML = '<li class="empty-msg">Esta nota n√£o tem caixas nem estrutura especial.</li>';
    }
}



// 4. ATUALIZADOR AUTOM√ÅTICO
// Chame esta fun√ß√£o sempre que gravar a nota ou abrir uma nova
function updateMiddlePanelViews() {
    console.log("4. üö¶ [ROUTER] Iniciado.");
    
    const activeTab = document.querySelector('.middle-bottom-tabs button.active');
    
    if (!activeTab) {
        console.warn("‚ö†Ô∏è [ROUTER] Nenhuma aba ativa encontrada. Abortando.");
        return;
    }

    const view = activeTab.dataset.midTab;
    console.log(`   -> Aba Ativa: ${view}`);

    if (view === 'texts') {
        console.log(`   -> Analisando L√≥gica: H√≠brido=${window.currentNoteHybridMode} | √Çncoras=${activeNoteAnchorsIds ? activeNoteAnchorsIds.length : 0}`);

        if (window.currentNoteHybridMode === true) {
            console.log("   -> ‚úÖ CONDI√á√ÉO 1 V√ÅLIDA: Modo Misto. Chamando generateHybridView().");
            activeTab.innerHTML = '<span>üõ≥Ô∏è</span> Misto';
            activeTab.dataset.mode = 'hybrid';
            generateHybridView();
        } 
        else if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
            console.log("   -> ‚úÖ CONDI√á√ÉO 2 V√ÅLIDA: Modo Navega√ß√£o.");
            activeTab.innerHTML = '<span>‚öì</span> Navega';
            activeTab.dataset.mode = 'navega';
            generateAnchorNavigation();
        } 
        else {
            console.log("   -> ‚¨áÔ∏è FALLBACK: Modo Padr√£o (B√≠blia).");
            activeTab.innerHTML = '<span>üìú</span> Textos';
            activeTab.dataset.mode = 'textos';
            generateNoteTexts();
        }
    } else {
    }
}





// --- FUN√á√ïES DE MOTOR B√çBLICO (ABA TEXTOS) ---

// 1. Expande uma refer√™ncia complexa (ex: "Jo√£o 3:1-3, 5") numa lista de vers√≠culos individuais
function expandVerseReference(fullRef) {
    // Regex para capturar: Livro, Cap√≠tulo, Vers√≠culos
    // Ex: "1 Jo√£o 3:1-5" -> Livro: "1 Jo√£o", Cap: "3", Vers: "1-5"
    const match = fullRef.match(/(.+)\s+(\d+):(.+)/);
    if (!match) return [fullRef]; // Se falhar, devolve como est√°

    const book = match[1].trim();
    const chapter = match[2];
    const versePart = match[3];
    
    let expandedVerses = [];

    // Separa por v√≠rgulas (ex: "1-3, 5" -> ["1-3", " 5"])
    const groups = versePart.split(',');

    groups.forEach(group => {
        const g = group.trim();
        if (g.includes('-')) {
            // √â um intervalo (ex: "1-3")
            const [start, end] = g.split('-').map(n => parseInt(n));
            if (!isNaN(start) && !isNaN(end)) {
                for (let v = start; v <= end; v++) {
                    expandedVerses.push(`${book} ${chapter}:${v}`);
                }
            }
        } else {
            // √â um n√∫mero simples
            expandedVerses.push(`${book} ${chapter}:${g}`);
        }
    });

    return expandedVerses;
}

// 2. Busca o texto na cole√ß√£o p√∫blica (Cache simples para evitar leituras repetidas na mesma sess√£o)
const bibleTextCache = {}; 

async function fetchPublicBibleText(verseName) {
    // 1. Verifica cache local
    if (bibleTextCache[verseName]) return bibleTextCache[verseName];


    try {
        const { collection, query, where, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // --- TENTATIVA A: Busca Exata pelo Nome ---
        const q = query(collection(db, 'bible_verses_public'), where('nome', '==', verseName));
        const snap = await getDocs(q);
        
        if (!snap.empty) {
            const text = snap.docs[0].data().texto;
            bibleTextCache[verseName] = text;
            return text;
        }

        // --- TENTATIVA B: Busca pelo ID Gerado (1_corintios_10_1) ---
        const generatedId = generateBibleId(verseName);
        console.log(`üîÑ Tentando pelo ID: "${generatedId}"`);
        
        const docRef = doc(db, 'bible_verses_public', generatedId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const text = docSnap.data().texto;
            console.log("‚úÖ Encontrado por ID!");
            bibleTextCache[verseName] = text;
            return text;
        }

        console.warn(`‚ùå Texto n√£o encontrado na base de dados: ${verseName} (ID: ${generatedId})`);

    } catch (e) {
        console.error("üî• Erro na busca b√≠blica:", e);
    }
    return null;
}

// 3. FUN√á√ÉO PRINCIPAL: GERAR ABA TEXTOS
async function generateNoteTexts() {
    const list = document.getElementById('note-texts-view');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    // 1. Obt√©m o texto do corpo e dos inputs (T√≠tulos) para analisar
    let textContent = editor.innerText;
    const titles = editor.querySelectorAll('.redator-input, .mini-note-title-input, .card-title-input, .sign-title-input');
    titles.forEach(input => {
        if (input.value) textContent += " " + input.value;
    });

    // 2. Prepara a Regex para encontrar livros da B√≠blia
    const sortedBooks = [...BIBLICAL_BOOKS].sort((a, b) => b.length - a.length);
    const booksPattern = sortedBooks.join('|');

    // === CORRE√á√ÉO AQUI ===
    // Explica√ß√£o: \d+:\d+ (Cap:Verso) ... seguido de (h√≠fen/v√≠rgula + digito) repetidas vezes
    const regex = new RegExp(`\\b((?:${booksPattern})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)`, 'gi');
    // =====================
    
    const rawMatches = textContent.match(regex) || [];
    const currentRefs = [...new Set(rawMatches.map(r => r.trim()))]; // .trim() limpa espa√ßos nas pontas

    // L√≥gica para detetar se apareceu uma refer√™ncia nova para fazer scroll autom√°tico
    const prevRefsJSON = list.getAttribute('data-prev-refs') || "[]";
    const prevRefs = JSON.parse(prevRefsJSON);
    const newRefFound = currentRefs.find(ref => !prevRefs.includes(ref));

    if (currentRefs.length === 0) {
        list.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#888; text-align:center; padding:20px;">
                <span style="font-size:30px;">üìñ</span>
                <p>Nenhum texto detetado.</p>
                <small style="opacity:0.5;">Escreva ex: "Jo√£o 3:16"</small>
            </div>`;
        list.setAttribute('data-prev-refs', "[]");
        return;
    }

    list.innerHTML = ''; 
    let elementToScrollTo = null;

    // 3. PROCESSAR CADA REFER√äNCIA ENCONTRADA
    for (const cleanRef of currentRefs) {
        
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = "padding: 0 15px 15px 15px; border-bottom: 1px solid var(--border-color); text-align: left; position: relative;";
        
        // Se este for o novo vers√≠culo, guarda a refer√™ncia para o scroll
        if (newRefFound && cleanRef === newRefFound) {
            elementToScrollTo = itemDiv;
        }

        const title = document.createElement('div');
        title.className = 'bible-ref-title';
        
        // Estilo Sticky: O t√≠tulo fica preso no topo enquanto se l√™ o texto
        title.style.cssText = `
            font-weight: bold; 
            color: var(--accent-color); 
            cursor: pointer; 
            font-size: 0.95em; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            position: sticky;
            top: 0;
            background-color: var(--panel-color); 
            z-index: 5;
            padding: 12px 0 8px 0;
            border-bottom: 1px solid transparent; 
        `;
        
        title.textContent = cleanRef;
        
        // Clique no t√≠tulo faz scroll no editor at√© √† refer√™ncia
        title.onclick = () => {
            if (typeof scrollToAndHighlightText === 'function') {
                scrollToAndHighlightText(cleanRef);
            }
        };

        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = "font-size: 0.95em; line-height: 1.5; color: var(--text-color); margin-top: 5px;";
        contentDiv.innerHTML = '<span style="opacity:0.5; font-size:0.8em;">A carregar...</span>';

        itemDiv.appendChild(title);
        itemDiv.appendChild(contentDiv);
        list.appendChild(itemDiv);

        // 4. Expandir e Buscar Texto na API/Firebase
        // (Lida com intervalos como "Jo√£o 3:1-5")
        const individualVerses = expandVerseReference(cleanRef);
        const textPromises = individualVerses.map(v => fetchPublicBibleText(v));
        const texts = await Promise.all(textPromises);
        
        const fullText = texts.filter(t => t).join(" ");
        if (fullText.trim()) {
            contentDiv.textContent = fullText;
        } else {
            contentDiv.innerHTML = '<span style="opacity:0.5; font-size:0.8em;">Texto n√£o dispon√≠vel.</span>';
        }
    }

    // 5. Scroll Autom√°tico se houver novidade
    if (elementToScrollTo) {
        setTimeout(() => {
            elementToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'start' });
            elementToScrollTo.style.transition = "background-color 0.5s";
            elementToScrollTo.style.backgroundColor = "rgba(46, 204, 113, 0.15)";
            setTimeout(() => elementToScrollTo.style.backgroundColor = "transparent", 1500);
        }, 150);
    }

    list.setAttribute('data-prev-refs', JSON.stringify(currentRefs));
}

// 3. FUN√á√ÉO: GERAR FONTES (VISTA 4)
function generateNoteSources() {
    const list = document.getElementById('note-sources-list');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    list.innerHTML = '';
    let hasSources = false;

    // Procura elementos que tenham o atributo data-box-links
    const elements = editor.querySelectorAll('[data-box-links]');

    elements.forEach(el => {
        const jsonStr = el.getAttribute('data-box-links');
        if (!jsonStr || jsonStr === '{}') return;

        try {
            const data = JSON.parse(jsonStr);
            
            // Verifica se tem URLs, Codex ou Categorias
            const hasUrls = data.urls && Object.keys(data.urls).length > 0;
            const hasCodex = data.codex && data.codex.length > 0;
            const hasCategories = data.categories && data.categories.length > 0;

            if (!hasUrls && !hasCodex && !hasCategories) return;

            hasSources = true;

            // Determina T√≠tulo da Caixa para o Cabe√ßalho
            let boxTitle = data.title; 
            if (!boxTitle) {
                const input = el.querySelector('.mini-note-title-input, .redator-input, .card-title-input, .sign-title-input');
                if (input) boxTitle = input.value || input.textContent;
                else {
                    const content = el.querySelector('.mini-note-content, .redator-content, .cube-content');
                    boxTitle = content ? content.innerText.split('\n')[0].substring(0, 30) : "Caixa Sem T√≠tulo";
                }
            }
            if(!boxTitle || boxTitle.trim() === "") boxTitle = "Caixa Sem T√≠tulo";

            const li = document.createElement('li');
            li.className = 'source-group';

            let itemsHTML = '';
            
            // 1. URLs
            if (hasUrls) {
                Object.values(data.urls).forEach(url => {
                    let linkName = url;
                    try { linkName = new URL(url).hostname.replace('www.',''); } catch(e){}
                    
                    itemsHTML += `
                        <div class="source-link-item" onclick="window.open('${url}', '_blank')">
                            <span>üîó</span> ${linkName} 
                            <span style="font-size:0.7em; color:var(--text-muted-color); margin-left:5px;">‚Üó</span>
                        </div>`;
                });
            }

            // 2. CODEX (AQUI EST√Å A CORRE√á√ÉO)
            if (hasCodex) {
                data.codex.forEach(c => {
                    // Se j√° tivermos o campo 'codiceshow' formatado (nome completo), usamos como tooltip.
                    // Para a lista curta, constru√≠mos a sigla t√©cnica.
                    
                    let shortLabel = c.serie || "Ref.";
                    
                    // Adiciona Cap√≠tulo
                    if (c.capitulo) shortLabel += `, cap ${c.capitulo}`;
                    
                    // Adiciona P√°ginas (pg)
                    if (c.paginas && c.paginas.length > 0) {
                        shortLabel += `, pg ${c.paginas.join(',')}`;
                    }
                    
                    // Adiciona Par√°grafos (pr)
                    if (c.paragrafos && c.paragrafos.length > 0) {
                        shortLabel += `, pr ${c.paragrafos.join(',')}`;
                    }

                    // Adiciona Tempo
                    if (c.tempo) shortLabel += ` [${c.tempo}]`;

                    itemsHTML += `
                        <div class="source-codex-item" title="${c.codiceshow || ''}">
                            <span>üìö</span> ${shortLabel}
                        </div>`;
                });
            }

            // 3. Categorias
            if (hasCategories) {
                data.categories.forEach(c => {
                    let icon = "üîπ";
                    if (c.type === 'personagem') icon = "üë§";
                    if (c.type === 'local') icon = "üìç";
                    if (c.type === 'textobiblico' || c.type === 'bible_public') icon = "üìñ";
                    
                    itemsHTML += `
                        <div class="source-link-item" style="cursor:default; color:var(--text-color);">
                            <span>${icon}</span> ${c.name}
                        </div>`;
                });
            }

            li.innerHTML = `
                <div class="source-header" onclick="document.getElementById('${el.id}').scrollIntoView({behavior:'smooth', block:'center'});">
                    <span style="color:var(--text-muted-color);">‚Ü≥</span> ${boxTitle}
                </div>
                <div class="source-links">${itemsHTML}</div>
            `;

            list.appendChild(li);

        } catch (e) { console.warn("Erro ao parsear links da caixa", e); }
    });

    if (!hasSources) {
        list.innerHTML = '<li class="empty-msg">Nenhuma hiperliga√ß√£o ou Codex encontrado nas caixas (‚ö°).</li>';
    }
}

// Fun√ß√£o auxiliar para criar o ID (ex: "1 Cor√≠ntios 10:1" -> "1_corintios_10_1")
function generateBibleId(name) {
    return name.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos (√≠ -> i)
        .trim()
        .replace(/:/g, '_')       // Substitui : por _
        .replace(/ /g, '_')       // Substitui espa√ßos por _
        .replace(/-/g, '_');      // Substitui tra√ßos por _
}

// ============================================================
// L√ìGICA DO MENU DE VISTAS MOBILE (‚õ∂)
// ============================================================

// 1. Abrir o Modal
document.getElementById('mobile-views-btn').addEventListener('click', (e) => {
    e.preventDefault();
    // Abre o modal
    const modal = document.getElementById('mobile-views-modal');
    modal.style.display = 'flex';
    
    // Abre por defeito na aba "√çndice" ou na √∫ltima usada
    const activeBtn = modal.querySelector('.middle-bottom-tabs button.active') || modal.querySelector('[data-mob-tab="index"]');
    if (activeBtn) activeBtn.click();
});

// 2. Gerir Cliques nas Abas do Modal Mobile
 document.querySelector('#mobile-views-modal .middle-bottom-tabs').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. GERAR SENHA √öNICA PARA ESTE CLIQUE
    const myRequestId = ++currentMobileRequestId;
    console.log(`üé´ Clique ID: ${myRequestId} (Aba: ${btn.dataset.mobTab})`);

    // Atualiza classes ativas
    e.currentTarget.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const viewType = btn.dataset.mobTab;
    const titleEl = document.getElementById('mobile-views-title');
    const contentEl = document.getElementById('mobile-views-content');
    
    // Limpa e p√µe o spinner IMEDIATAMENTE
    contentEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar...</span></div>';

    // --- FUN√á√ÉO DE SEGURAN√áA SUPREMA ---
    // Se o ID global mudou, significa que houve outro clique depois deste.
    const isObsolete = () => {
        return myRequestId !== currentMobileRequestId;
    };

    if (viewType === 'files') {
        titleEl.textContent = "Ficheiros na Pasta";
        const fileList = document.getElementById('file-list');
        
        // Verifica se ainda √© v√°lido antes de escrever
        if (!isObsolete() && fileList) contentEl.innerHTML = fileList.innerHTML;
    } 
    else if (viewType === 'index') {
        titleEl.textContent = "√çndice da Nota";
        
        // Processos s√≠ncronos
        detectActiveScrollElement();
        generateNoteIndex(); 
        
        setTimeout(() => {
            // SEGURAN√áA
            if (isObsolete()) return;

            const source = document.getElementById('note-index-list');
            if (source && source.innerHTML.trim()) {
                contentEl.innerHTML = source.innerHTML;

                // Scroll Matem√°tico
                if (currentActiveScrollId) {
                    const activeMobileItem = contentEl.querySelector(`.index-item[data-target-id="${currentActiveScrollId}"]`);
                    if (activeMobileItem) {
                        activeMobileItem.classList.add('active-scroll');
                        activeMobileItem.style.backgroundColor = "rgba(74, 144, 226, 0.3)";
                        activeMobileItem.style.borderLeft = "4px solid #4a90e2";
                        
                        setTimeout(() => {
                            if (!isObsolete()) activeMobileItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                        }, 50);
                    } 
                }
            } else {
                contentEl.innerHTML = "<p style='color:#888; text-align:center; padding:30px;'>Sem estrutura.</p>";
            }
        }, 100);
    } 
    else if (viewType === 'texts') {
        titleEl.textContent = "Textos B√≠blicos";
        
        // Esta fun√ß√£o demora tempo (await)
        await generateNoteTexts(); 
        
        // üõ°Ô∏è BLOQUEIO FINAL (O SEGREDO) üõ°Ô∏è
        if (isObsolete()) {
            console.log(`üõë Pedido ${myRequestId} (Textos) cancelado. O utilizador j√° est√° no pedido ${currentMobileRequestId}.`);
            return; // Sai da fun√ß√£o sem tocar no HTML
        }

        const source = document.getElementById('note-texts-view');
        contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
    } 
    else if (viewType === 'sources') {
        titleEl.textContent = "Fontes e Links";
        
        // Gera as fontes (pode ter micro-atraso)
        generateNoteSources(); 
        
        setTimeout(() => {
            // SEGURAN√áA
            if (isObsolete()) return;

            const source = document.getElementById('note-sources-list');
            contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
        }, 50);
    }
});


// 3. Delegar Cliques dentro do Conte√∫do Mobile (Para fechar o modal ao clicar)
document.getElementById('mobile-views-content').addEventListener('click', (e) => {
    // Verifica se clicou num item naveg√°vel (lista, indice, texto)
    const item = e.target.closest('.list-item, .index-item, .source-group, div[style*="cursor: pointer"]');
    
    if (item) {
        // Se for um item de lista de ficheiros, precisamos de garantir que o ID √© passado
        if (item.classList.contains('list-item')) {
            // A l√≥gica original de clique j√° est√° no elemento copiado (onclick="..."), 
            // mas precisamos de for√ßar o fecho do modal
            
            // Simula o clique no elemento original oculto para disparar a navega√ß√£o
            const originalId = item.dataset.id;
            const originalItem = document.querySelector(`#file-list .list-item[data-id="${originalId}"]`);
            if (originalItem) originalItem.click();
        } 
        else {
            // Se for √çndice ou Textos, o onclick inline copiado vai fazer o scroll no editor.
            // N√≥s s√≥ precisamos de fechar o modal para o utilizador ver o resultado.
        }

        // Fecha o modal ap√≥s a sele√ß√£o
        document.getElementById('mobile-views-modal').style.display = 'none';
    }
});

// ============================================================
// L√ìGICA DO MENU DE VISTAS MOBILE (‚õ∂)
// ============================================================

// 1. Abrir o Modal
const mobileViewsBtn = document.getElementById('mobile-views-btn');

if (mobileViewsBtn) {
    const newBtn = mobileViewsBtn.cloneNode(true);
    mobileViewsBtn.parentNode.replaceChild(newBtn, mobileViewsBtn);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // 1. For√ßa uma dete√ß√£o de scroll de √∫ltima hora para garantir que a vari√°vel est√° atualizada
        detectActiveScrollElement();

        const modal = document.getElementById('mobile-views-modal');
        if (modal) {
            // For√ßa visibilidade
            document.body.appendChild(modal);
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.85) !important;
                z-index: 2147483647 !important;
                align-items: center !important;
                justify-content: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;

            // 2. Simula o clique na aba "√çndice" para carregar o conte√∫do e ativar o scroll
            // (Se j√° estiver ativa, o listener da aba abaixo trata de recarregar)
            const indexBtn = modal.querySelector('[data-mob-tab="index"]');
            if (indexBtn) {
                indexBtn.click();
            }
        }
    });
}

// 2. Gerir Cliques nas Abas
const mobileTabsContainer = document.querySelector('#mobile-views-modal .middle-bottom-tabs');

if (mobileTabsContainer) {
    const newTabs = mobileTabsContainer.cloneNode(true);
    mobileTabsContainer.parentNode.replaceChild(newTabs, mobileTabsContainer);

    newTabs.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        // 1. GERAR SENHA √öNICA PARA ESTE CLIQUE (Evita conflitos de rapidez)
        const myRequestId = ++currentMobileRequestId;

        // Atualiza visual
        newTabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const viewType = btn.dataset.mobTab;
        const titleEl = document.getElementById('mobile-views-title');
        const contentEl = document.getElementById('mobile-views-content');
        
        // Limpa e p√µe o spinner
        contentEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar...</span></div>';

        // Fun√ß√£o de seguran√ßa
        const isObsolete = () => myRequestId !== currentMobileRequestId;

        // --- L√ìGICA DO √çNDICE ---
        if (viewType === 'index') {
            titleEl.textContent = "√çndice da Nota";
            detectActiveScrollElement();
            generateNoteIndex(); 
            
            setTimeout(() => {
                if (isObsolete()) return;
                const source = document.getElementById('note-index-list');
                
                if (source && source.innerHTML.trim()) {
                    contentEl.innerHTML = source.innerHTML;
                    // L√≥gica de Scroll (Scrollspy)
                    if (currentActiveScrollId) {
                        const activeItem = contentEl.querySelector(`.index-item[data-target-id="${currentActiveScrollId}"]`);
                        if (activeItem) {
                            activeItem.classList.add('active-scroll');
                            activeItem.style.backgroundColor = "rgba(74, 144, 226, 0.3)";
                            activeItem.style.borderLeft = "4px solid #4a90e2";
                            activeItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                        } 
                    }
                } else {
                    contentEl.innerHTML = "<p style='color:#888; text-align:center; padding:30px;'>Sem estrutura.</p>";
                }
            }, 50);
        }
        
        // --- L√ìGICA DE TEXTOS / NAVEGA (CORRIGIDA) ---
        else if (viewType === 'texts') {
            
            // Verifica se h√° √¢ncoras ativas na nota
            const hasAnchors = activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0;

            if (hasAnchors) {
                // MODO: NAVEGA√á√ÉO POR √ÇNCORAS
                titleEl.textContent = "Navega√ß√£o por √Çncoras";
                
                // Gera a lista de navega√ß√£o
                generateAnchorNavigation();
                
                // Copia do contentor PC para o Mobile
                setTimeout(() => {
                    if (isObsolete()) return;
                    const source = document.getElementById('note-texts-view');
                    contentEl.innerHTML = source ? source.innerHTML : '<div style="padding:20px;text-align:center;color:#888">Sem resultados.</div>';
                }, 50);

            } else {
                // MODO: TEXTOS B√çBLICOS
                titleEl.textContent = "Textos B√≠blicos";
                await generateNoteTexts(); // Esta fun√ß√£o √© lenta (async)
                
                if (isObsolete()) return;
                const source = document.getElementById('note-texts-view');
                contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
            }
        } 
        
        // --- OUTRAS ABAS ---
        else if (viewType === 'files') {
            titleEl.textContent = "Ficheiros";
            const fileList = document.getElementById('file-list');
            if (fileList) contentEl.innerHTML = fileList.innerHTML;
        }
        else if (viewType === 'sources') {
            titleEl.textContent = "Fontes";
            generateNoteSources();
            setTimeout(() => {
                if (isObsolete()) return;
                const source = document.getElementById('note-sources-list');
                contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
            }, 50);
        }
    });
}
  
// 3. Delegar Cliques dentro do Conte√∫do Mobile (Vers√£o Final Completa)
const mobileContentArea = document.getElementById('mobile-views-content');

if (mobileContentArea) {
    // 1. Removemos listener antigo clonando
    const newContentArea = mobileContentArea.cloneNode(true);
    mobileContentArea.parentNode.replaceChild(newContentArea, mobileContentArea);

    // 2. Adicionamos o novo evento √∫nico
    newContentArea.addEventListener('click', (e) => {
        
        // --- CASO A: CLIQUE NO √çNDICE (Scroll para a caixa) ---
        const indexItem = e.target.closest('.index-item');
        if (indexItem) {
            const targetId = indexItem.dataset.targetId;
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                document.getElementById('mobile-views-modal').style.display = 'none';
                
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Flash visual
                    const originalBoxShadow = targetElement.style.boxShadow;
                    targetElement.style.transition = "box-shadow 0.5s ease, outline 0.5s ease";
                    targetElement.style.boxShadow = "0 0 20px var(--accent-color)";
                    targetElement.style.outline = "2px solid var(--accent-color)";
                    setTimeout(() => { 
                        targetElement.style.boxShadow = originalBoxShadow || "none"; 
                        targetElement.style.outline = "none";
                    }, 1500);
                }, 150);
                return;
            }
        }

        // --- CASO B: CLIQUE NA LISTA DE FICHEIROS (Navegar) ---
        const listItem = e.target.closest('.list-item');
        if (listItem && listItem.dataset.id) {
            const originalItem = document.querySelector(`#file-list .list-item[data-id="${listItem.dataset.id}"]`);
            if (originalItem) originalItem.click();
            document.getElementById('mobile-views-modal').style.display = 'none';
            return;
        }

        // --- CASO C: OUTROS CLIQUES GERAIS ---
        const otherClickable = e.target.closest('.source-group, .source-link-item, div[onclick]');
        if (otherClickable && !e.target.classList.contains('bible-ref-title')) {
            document.getElementById('mobile-views-modal').style.display = 'none';
        }

        // --- CASO D: CLIQUE EM TEXTO B√çBLICO (SCROLL) ---
        // Este √© o bloco novo para fazer o que pediu
        const bibleTitle = e.target.closest('.bible-ref-title');
        if (bibleTitle) {
            const verseRef = bibleTitle.textContent.trim();
            
            // 1. Fecha o Modal
            document.getElementById('mobile-views-modal').style.display = 'none';
            
            // 2. Chama a fun√ß√£o de pesquisa e scroll que j√° existe
            if (typeof scrollToAndHighlightText === 'function') {
                // Pequeno delay para o modal sair da frente
                setTimeout(() => {
                    scrollToAndHighlightText(verseRef);
                }, 100);
            }
        }
    });
}

// 3. Fechar ao clicar num item
document.getElementById('mobile-views-content')?.addEventListener('click', (e) => {
    // Se clicar num item clic√°vel
    if (e.target.closest('.list-item, .index-item, .source-group, div[onclick]')) {
        
        // Se for um ficheiro da lista, precisamos de disparar o clique original
        const listItem = e.target.closest('.list-item');
        if (listItem && listItem.dataset.id) {
            const originalItem = document.querySelector(`#file-list .list-item[data-id="${listItem.dataset.id}"]`);
            if (originalItem) originalItem.click();
        }
        
        // Fecha o modal
        document.getElementById('mobile-views-modal').style.display = 'none';
    }
});

// ============================================================
// CORRE√á√ÉO DO FECHO DO MODAL MOBILE
// ============================================================

// 1. Configurar o bot√£o "X"
const mobileModal = document.getElementById('mobile-views-modal');
// Procura o bot√£o dentro do cabe√ßalho do modal
const closeMobBtn = mobileModal ? mobileModal.querySelector('button') : null;

if (closeMobBtn && mobileModal) {
    // Removemos o onclick antigo do HTML para evitar conflitos
    closeMobBtn.onclick = null; 

    // Adicionamos um novo evento poderoso
    closeMobBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
    
        
        // For√ßa o fecho sobrepondo qualquer !important anterior
        mobileModal.style.setProperty('display', 'none', 'important');
    });
}

// 2. Configurar fecho ao clicar no fundo escuro (fora da caixa branca)
if (mobileModal) {
    mobileModal.addEventListener('click', (e) => {
        // Se o alvo do clique for o pr√≥prio fundo escuro (id="mobile-views-modal")
        if (e.target === mobileModal) {
            console.log("üåë Clique no fundo detetado. A fechar.");
            mobileModal.style.setProperty('display', 'none', 'important');
        }
    });
}

// ============================================================
// L√ìGICA DE ARRASTO MOBILE PARA O CUBO (üßä)
// ============================================================

// 1. IN√çCIO DO TOQUE (TOUCHSTART)
noteContentEditor.addEventListener('touchstart', (e) => {
    // Verifica se tocou no puxador do cubo
    const handle = e.target.closest('.cube-drag-handle');
    if (!handle) return;

    const cube = handle.closest('.journal-cube-wrapper');
    if (!cube) return;

    // Impede o scroll da p√°gina enquanto arrasta
    e.preventDefault(); 
    e.stopPropagation();

    mDragCube = cube;
    const touch = e.touches[0];
    const rect = cube.getBoundingClientRect();

    // Calcular onde o dedo tocou dentro do cubo
    mTouchOffsetX = touch.clientX - rect.left;
    mTouchOffsetY = touch.clientY - rect.top;

    // Criar o Clone Visual (Fantasma)
    mDragClone = cube.cloneNode(true);
    mDragClone.style.position = 'fixed';
    mDragClone.style.width = `${rect.width}px`;
    mDragClone.style.height = `${rect.height}px`;
    mDragClone.style.zIndex = '999999';
    mDragClone.style.opacity = '0.8';
    mDragClone.style.boxShadow = '0 10px 20px rgba(0,0,0,0.5)';
    mDragClone.style.pointerEvents = 'none'; // Importante para o elementFromPoint funcionar
    mDragClone.style.transform = 'scale(1.05)'; // Efeito de levantamento
    
    // Posicionar inicialmente
    mDragClone.style.left = `${rect.left}px`;
    mDragClone.style.top = `${rect.top}px`;

    document.body.appendChild(mDragClone);

    // Esconde ligeiramente o original
    mDragCube.style.opacity = '0.3';
    
    // Vibra√ß√£o de feedback (se suportado pelo telem√≥vel)
    if (navigator.vibrate) navigator.vibrate(50);
}, { passive: false });

// 2. MOVER O DEDO (TOUCHMOVE)
document.addEventListener('touchmove', (e) => {
    if (!mDragCube || !mDragClone) return;

    e.preventDefault(); // Continua a impedir scroll

    const touch = e.touches[0];

    // Mover o clone
    const x = touch.clientX - mTouchOffsetX;
    const y = touch.clientY - mTouchOffsetY;
    
    mDragClone.style.left = `${x}px`;
    mDragClone.style.top = `${y}px`;

    // Identificar o alvo por baixo do dedo
    // Escondemos o clone momentaneamente para ver o que est√° por baixo
    mDragClone.style.display = 'none';
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    mDragClone.style.display = 'block';

    if (!elementBelow) return;

    // Procura um alvo v√°lido (Par√°grafo, Outro Cubo, Imagem)
    const target = elementBelow.closest('p, .journal-img-wrapper, .journal-cube-wrapper, .url-card-widget');

    // Limpa destaques antigos
    if (mDragTarget && mDragTarget !== target) {
        mDragTarget.style.borderTop = '';
        mDragTarget.style.borderBottom = '';
    }

    if (target && target !== mDragCube && noteContentEditor.contains(target)) {
        mDragTarget = target;
        
        // Calcular se estamos na metade de cima ou de baixo do alvo
        const rect = target.getBoundingClientRect();
        const midY = rect.top + (rect.height / 2);

        if (touch.clientY < midY) {
            target.style.borderTop = '3px solid var(--accent-color)';
            target.style.borderBottom = '';
            target.dataset.dropPos = 'before';
        } else {
            target.style.borderTop = '';
            target.style.borderBottom = '3px solid var(--accent-color)';
            target.dataset.dropPos = 'after';
        }
    } else {
        mDragTarget = null;
    }

}, { passive: false });

// 3. LARGAR (TOUCHEND)
document.addEventListener('touchend', (e) => {
    if (!mDragCube) return;

    // Remove o clone visual
    if (mDragClone) mDragClone.remove();
    mDragClone = null;

    // Restaura o original
    mDragCube.style.opacity = '1';

    // Se houver um alvo v√°lido, move o cubo
    if (mDragTarget) {
        // Limpa as linhas azuis
        mDragTarget.style.borderTop = '';
        mDragTarget.style.borderBottom = '';

        if (mDragTarget.dataset.dropPos === 'before') {
            mDragTarget.parentNode.insertBefore(mDragCube, mDragTarget);
        } else {
            mDragTarget.parentNode.insertBefore(mDragCube, mDragTarget.nextSibling);
        }
        
        // Limpa atributos tempor√°rios
        mDragTarget.removeAttribute('data-drop-pos');
        
        // Grava
        saveNote();
    }

    // Reset final
    mDragCube = null;
    mDragTarget = null;
});


// --- EFEITO DE BORDA AO DIGITAR NO REDATOR ---
const editorForGlow = document.getElementById('note-content-editor');

if (editorForGlow) {
    editorForGlow.addEventListener('input', (e) => {
        // S√≥ ativa se estiver a escrever no corpo do Redator
        if (e.target.classList.contains('redator-content')) {
            
            const wrapper = e.target.closest('.redator-wrapper');
            
            if (wrapper) {
                // Adiciona a classe que faz a borda brilhar
                wrapper.classList.add('typing-border-glow');
                
                // Limpa o temporizador anterior para a luz n√£o apagar enquanto escreve
                if (wrapper.typingTimeout) {
                    clearTimeout(wrapper.typingTimeout);
                }
                
                // Define para apagar a luz 500ms depois de parar de teclar
                wrapper.typingTimeout = setTimeout(() => {
                    wrapper.classList.remove('typing-border-glow');
                }, 500); 
            }
        }
    });
}



// ====================================================================
// L√ìGICA DO MENU MOBILE (BOT√ÉO ‚õ∂ E ABAS)
// ====================================================================

// 1. Configura√ß√£o do Bot√£o de Abrir
const btnOpenMobile = document.getElementById('mobile-views-btn');

if (btnOpenMobile) {
    // Clonamos para limpar eventos antigos
    const newBtn = btnOpenMobile.cloneNode(true);
    btnOpenMobile.parentNode.replaceChild(newBtn, btnOpenMobile);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // 1. Dete√ß√£o de posi√ß√£o de scroll (Scrollspy)
        detectActiveScrollElement();

        // ============================================================
        // 2. ATUALIZAR √çCONES (GARANTIA DE SYNC)
        // ============================================================
        // Garante que o bot√£o dentro do modal tem o √≠cone certo (üõ≥Ô∏è/‚öì/üìú) antes de aparecer
        refreshMiddlePanelTabIcon();
        // ============================================================

        const modal = document.getElementById('mobile-views-modal');
        if (modal) {
            // A. For√ßa visibilidade e move para o topo
            document.body.appendChild(modal);
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.85) !important;
                z-index: 2147483647 !important;
                align-items: center !important;
                justify-content: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;

            // B. Abre por defeito na aba "√çndice" (ou simula clique)
            setTimeout(() => {
                const indexTabBtn = modal.querySelector('[data-mob-tab="index"]');
                if (indexTabBtn) {
                    indexTabBtn.click();
                }
            }, 50);
        }
    });
}


// ============================================================
// GEST√ÉO DE √ÇNCORAS (‚öì)
// ============================================================

// 1. Abrir o Modal de Gest√£o
async function openAnchorManagerModal() {
    console.log("‚öì [GESTOR] Abrindo Gestor de √Çncoras...");
    
    const modal = document.getElementById('anchors-manager-modal');
    const list = document.getElementById('anchors-manager-list');
    
    if (!activeReferenceEntity || !activeReferenceEntity.id) return;
    if (!modal) return console.error("Modal #anchors-manager-modal n√£o encontrado.");

    // 1. FOR√áAR VISIBILIDADE M√ÅXIMA
    document.body.appendChild(modal); // Move para o topo da hierarquia
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        justify-content: center !important;
        align-items: center !important;
    `;

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar √¢ncoras...</span></div>';

    try {
        const myUid = auth.currentUser.uid;
        const { collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // A. Buscar a Entidade Atual
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const entityRef = doc(db, collectionName, activeReferenceEntity.id);
        const entitySnap = await getDoc(entityRef);
        
        let attachedAnchors = {};
        if (entitySnap.exists()) {
            attachedAnchors = entitySnap.data().ancorasAssociadas || {};
        }

        // B. Buscar todas as √Çncoras
        const qAnchors = query(
            collection(db, 'ancoras'),
            where('userId', '==', myUid),
            orderBy('nome')
        );
        const snapAnchors = await getDocs(qAnchors);

        list.innerHTML = '';

        if (snapAnchors.empty) {
            list.innerHTML = `
                <li style="padding: 20px; text-align: center; color: #888;">
                    Nenhuma √¢ncora criada.<br>Use o bot√£o "+" acima para criar.
                </li>`;
            return;
        }

        snapAnchors.forEach(docSnap => {
            const anchor = { id: docSnap.id, ...docSnap.data() };
            if (anchor.estado === 'desativa') return;

            const isSelected = !!attachedAnchors[anchor.id];

            const li = document.createElement('li');
            li.className = `anchor-item-row ${isSelected ? 'selected' : ''}`;
            
            li.innerHTML = `
                <div style="display:flex; flex-direction:column; flex-grow:1;">
                    <span class="anchor-name">${anchor.nome}</span>
                    ${anchor.descricao ? `<small style="color:var(--text-muted-color);">${anchor.descricao}</small>` : ''}
                </div>
                <button class="anchor-edit-btn" title="Editar √Çncora">‚úèÔ∏è</button>
                <div class="anchor-check-icon">‚úì</div>
            `;

            // Toggle
            li.onclick = (e) => {
                if (e.target.closest('.anchor-edit-btn')) return;
                toggleAnchorOnEntity(anchor.id, !li.classList.contains('selected'), li);
            };

            // Editar (Abre o sub-modal, que tamb√©m precisa de z-index alto)
            const editBtn = li.querySelector('.anchor-edit-btn');
            editBtn.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                openEditAnchorModal(anchor); // Esta fun√ß√£o tamb√©m foi corrigida abaixo
            };
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error("Erro ao carregar √¢ncoras:", e);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar dados.</li>';
    }
}

// 2. Alternar Estado (Gravar na Entidade)
async function toggleAnchorOnEntity(anchorId, shouldAdd, liElement) {
    if (!activeReferenceEntity.id) return;

    // 1. Atualiza√ß√£o Visual Imediata (No bot√£o do check)
    if (shouldAdd) liElement.classList.add('selected');
    else liElement.classList.remove('selected');

    // Atualiza listener para o pr√≥ximo clique
    liElement.onclick = () => toggleAnchorOnEntity(anchorId, !shouldAdd, liElement);

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const entityRef = doc(db, collectionName, activeReferenceEntity.id);
        const { updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // 2. Grava√ß√£o no Firebase
        if (shouldAdd) {
            await updateDoc(entityRef, { [`ancorasAssociadas.${anchorId}`]: true });
        } else {
            await updateDoc(entityRef, { [`ancorasAssociadas.${anchorId}`]: deleteField() });
        }

        // 3. ATUALIZAR CACHE LOCAL (Mem√≥ria)
        const type = activeReferenceEntity.type;
        const id = activeReferenceEntity.id;

        if (allEntities[type]) {
            const entityInCache = allEntities[type].find(e => e.id === id);
            if (entityInCache) {
                if (!entityInCache.ancorasAssociadas) entityInCache.ancorasAssociadas = {};
                if (shouldAdd) entityInCache.ancorasAssociadas[anchorId] = true;
                else delete entityInCache.ancorasAssociadas[anchorId];
            }
        }

        // ============================================================
        // 4. >>> CORRE√á√ÉO MOBILE E DESKTOP <<<
        // ============================================================
        
        // A. Gera a lista com os novos dados (Escreve no contentor do PC)
        generateAnchorNavigation(); 

        // B. Se o Modal Mobile estiver aberto na aba "Navega", copia o conte√∫do para l√°
        const mobileModal = document.getElementById('mobile-views-modal');
        if (mobileModal && mobileModal.style.display !== 'none') {
            const activeMobTab = mobileModal.querySelector('.middle-bottom-tabs button.active');
            
            // S√≥ atualiza se estivermos na aba de textos/navega
            if (activeMobTab && activeMobTab.dataset.mobTab === 'texts') {
                console.log("üì± [MOBILE] Sincronizando lista de navega√ß√£o...");
                const source = document.getElementById('note-texts-view');
                const destination = document.getElementById('mobile-views-content');
                if (source && destination) {
                    destination.innerHTML = source.innerHTML;
                }
            }
        }
        // ============================================================
        
    } catch (error) {
        console.error("Erro ao gravar √¢ncora:", error);
        if (shouldAdd) liElement.classList.remove('selected');
        else liElement.classList.add('selected');
        alert("Erro ao salvar altera√ß√£o.");
    }
}

// 3. Abrir Modal de Cria√ß√£o (+)
document.getElementById('open-create-anchor-btn').addEventListener('click', () => {
    const modal = document.getElementById('create-anchor-modal');
    const input = document.getElementById('new-anchor-name');
    const desc = document.getElementById('new-anchor-desc');
    
    // Limpa
    input.value = '';
    desc.value = '';
    
    // Move para body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "55000"; // Acima do gestor
    modal.style.opacity = "1";
    modal.style.visibility = "visible";
    
    setTimeout(() => input.focus(), 100);
});

// 4. Confirmar Cria√ß√£o da √Çncora
document.getElementById('confirm-create-anchor').addEventListener('click', async () => {
    const nameInput = document.getElementById('new-anchor-name');
    const descInput = document.getElementById('new-anchor-desc');
    const btn = document.getElementById('confirm-create-anchor');
    
    const nome = nameInput.value.trim();
    if (!nome) return alert("O nome √© obrigat√≥rio.");
    
    btn.disabled = true;
    btn.textContent = "A criar...";
    
    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        await addDoc(collection(db, 'ancoras'), {
            nome: nome,
            descricao: descInput.value.trim(),
            userId: auth.currentUser.uid,
            estado: 'ativa', // <--- ADICIONE ESTA LINHA
            timestamp: serverTimestamp()
        });
        
        // Fecha e recarrega a lista
        document.getElementById('create-anchor-modal').style.display = 'none';
        openAnchorManagerModal(); // Recarrega a lista anterior
        
    } catch (e) {
        console.error("Erro ao criar √¢ncora:", e);
        alert("Erro ao criar.");
    } finally {
        btn.disabled = false;
        btn.textContent = "Criar";
    }
});


// 1. Alternar Abas no Modal
document.getElementById('topics-modal-tabs').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. Atualiza visual dos bot√µes das abas
    document.querySelectorAll('#topics-modal-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const tab = btn.dataset.tab; // 'topics' ou 'anchors'
    
    // 2. Alternar Conte√∫do (Esconde um, mostra o outro)
    document.getElementById('tm-content-topics').style.display = 'none';
    document.getElementById('tm-content-anchors').style.display = 'none';
    
    const targetContent = document.getElementById(`tm-content-${tab}`);
    if (targetContent) targetContent.style.display = 'flex';

    // 3. Atualizar o Bot√£o "+" do Cabe√ßalho
    const plusBtn = document.getElementById('manage-topics-btn');
    if (plusBtn) {
        if (tab === 'anchors') {
            // MODO √ÇNCORA: Bot√£o Verde
            plusBtn.title = "Criar Nova √Çncora";
            plusBtn.style.color = "#2ecc71"; 
            plusBtn.style.borderColor = "#2ecc71";
        } else {
            // MODO T√ìPICOS: Bot√£o Azul
            plusBtn.title = "Criar/Gerir T√≥picos";
            plusBtn.style.color = "var(--accent-color)";
            plusBtn.style.borderColor = "var(--accent-color)";
        }
    }

    // ============================================================
    // 4. L√ìGICA DA ABA √ÇNCORAS (GRAVA√á√ÉO + CARREGAMENTO)
    // ============================================================
    if (tab === 'anchors') {
        
        // A. GRAVA√á√ÉO AUTOM√ÅTICA
        console.log("‚öì [SISTEMA] Mudan√ßa para aba √Çncoras. A gravar nota...");
        
        if (typeof updateSaveStatus === 'function') updateSaveStatus('saving'); // Muda para "A guardar..."
        
        if (typeof saveNote === 'function') {
            await saveNote(true); // Grava√ß√£o for√ßada e imediata
        }

        if (typeof updateSaveStatus === 'function') updateSaveStatus('saved'); // Muda para "Guardado"

        // B. CARREGAMENTO PREGUI√áOSO (Lazy Load)
        // S√≥ carrega a lista se ela ainda estiver vazia
        const list = document.getElementById('note-anchors-list');
        if (list && list.children.length === 0) {
            if (typeof loadAnchorsForSelection === 'function') {
                loadAnchorsForSelection(true); // true = reset/limpar
            }
        }
    }
});

// 2. Pesquisa de √Çncoras
document.getElementById('anchor-search-input').addEventListener('input', (e) => {
    currentAnchorSearch = e.target.value.trim();
    // Debounce simples (espera 500ms antes de pesquisar)
    clearTimeout(window.anchorSearchTimer);
    window.anchorSearchTimer = setTimeout(() => {
        loadAnchorsForSelection(true); // Recarrega com filtro
    }, 500);
});

// 3. Bot√£o Carregar Mais
document.getElementById('load-more-anchors-btn').addEventListener('click', () => {
    loadAnchorsForSelection(false); // false = append (n√£o limpa)
});

async function loadAnchorsForSelection(isReset = false) {
    const list = document.getElementById('note-anchors-list');
    const loadMoreBtn = document.getElementById('load-more-anchors-btn');
    const myUid = auth.currentUser.uid;

    if (isReset) {
        list.innerHTML = '<li style="padding:15px; text-align:center;"><div class="spinner"></div></li>';
        anchorLastDoc = null;
        loadMoreBtn.style.display = 'none';
    } else {
        loadMoreBtn.textContent = "A carregar...";
        loadMoreBtn.disabled = true;
    }

    try {
        // --- ALTERA√á√ÉO AQUI: Removemos o filtro 'estado' da query do Firebase ---
        // Isto garante que itens sem o campo 'estado' (como o da imagem) aparecem
        const constraints = [
            collection(db, 'ancoras'),
            where('userId', '==', myUid),
            orderBy('nome'), // Ordenamos apenas por nome
            limit(30)
        ];

        if (currentAnchorSearch) {
            constraints.push(where('nome', '>=', currentAnchorSearch));
            constraints.push(where('nome', '<=', currentAnchorSearch + '\uf8ff'));
        }

        if (!isReset && anchorLastDoc) {
            constraints.push(startAfter(anchorLastDoc));
        }

        const q = query(...constraints);
        const snapshot = await getDocs(q);

        if (isReset) list.innerHTML = '';

        if (snapshot.empty) {
            if (isReset) list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhuma √¢ncora encontrada.</li>';
            loadMoreBtn.style.display = 'none';
            return;
        }

        anchorLastDoc = snapshot.docs[snapshot.docs.length - 1];

        snapshot.forEach(docSnap => {
            const anchor = { id: docSnap.id, ...docSnap.data() };
            
            // --- FILTRO NO CLIENTE (JAVASCRIPT) ---
            // Se estiver explicitamente "desativa", ignoramos.
            // Se o campo n√£o existir, deixamos passar (assim o seu item "Guerra" vai aparecer).
            if (anchor.estado === 'desativa') return;

            const isSelected = !!currentNoteAnchors[anchor.id];

            const li = document.createElement('li');
            li.className = `anchor-select-item ${isSelected ? 'selected' : ''}`;
            li.dataset.id = anchor.id;
            
            li.innerHTML = `
                <div class="anchor-info-area">
                    <span style="font-size:1.1em;">‚öì ${anchor.nome}</span>
                    ${anchor.descricao ? `<small style="color:var(--text-muted-color);">${anchor.descricao}</small>` : ''}
                </div>
                <button class="anchor-item-edit-btn" title="Editar/Ocultar">‚úèÔ∏è</button>
                <div class="anchor-check">‚úì</div>
            `;

            li.onclick = (e) => {
                if (e.target.closest('.anchor-item-edit-btn')) return;
                const nowSelected = !li.classList.contains('selected');
                if (nowSelected) {
                    li.classList.add('selected');
                    currentNoteAnchors[anchor.id] = true;
                } else {
                    li.classList.remove('selected');
                    delete currentNoteAnchors[anchor.id];
                }
            };

            const editBtn = li.querySelector('.anchor-item-edit-btn');
            editBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                openEditAnchorModal(anchor);
            };

            list.appendChild(li);
        });

        if (snapshot.size === 30) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.textContent = "Carregar mais 30 itens";
            loadMoreBtn.disabled = false;
        } else {
            loadMoreBtn.style.display = 'none';
        }

    } catch (e) {
        console.error("Erro ao carregar √¢ncoras:", e);
        if (isReset) list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar.</li>';
    }
}

function generateAnchorNavigation() {
    const list = document.getElementById('note-texts-view');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    // 1. Limpeza Inicial
    list.innerHTML = '';
    
    // Verifica se existem √¢ncoras selecionadas na nota
    if (!activeNoteAnchorsIds || activeNoteAnchorsIds.length === 0) {
        list.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">Sem √¢ncoras definidas na nota.</div>';
        return;
    }

    const textContent = editor.innerText.toLowerCase();
    
    // 2. Juntar todas as entidades conhecidas (Personagens, Locais, Cosmos...)
    const allCandidates = [];
    Object.keys(allEntities).forEach(type => {
        allEntities[type].forEach(entity => {
            allCandidates.push(entity);
        });
    });

    let foundCount = 0;

    // 3. Loop de Cruzamento (Entidades vs √Çncoras vs Texto)
    allCandidates.forEach(entity => {
        
        // A. Verificar se a entidade tem a √Çncora certa
        const entityAnchors = entity.ancorasAssociadas || {};
        const hasMatchingAnchor = activeNoteAnchorsIds.some(noteAnchorId => entityAnchors[noteAnchorId]);

        if (!hasMatchingAnchor) return;

        // B. Verificar se o nome da entidade est√° escrito no Texto da nota
        if (textContent.includes(entity.nome.toLowerCase())) {
            foundCount++;
            
            // Criar o Contentor do Item
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = "padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px;";
            
            // --- L√ìGICA DE √çCONE ---
            let icon = entity.emoji || "üîπ"; 
            if (!entity.emoji) {
                if (entity.tipo === 'personagem') icon = "üë§";
                else if (entity.tipo === 'local') icon = "üìç";
                else if (entity.tipo === 'cosmos') icon = "ü™ê";
                else if (entity.tipo === 'subcosmos') icon = "üß¨";
            }
            
            // --- C. T√çTULO (Clique = Scroll no Editor) ---
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = "font-weight: bold; color: var(--accent-color); cursor: pointer; font-size: 0.95em; display: flex; align-items: center; gap: 6px; width: fit-content;";
            titleDiv.innerHTML = `${icon} ${entity.nome}`;
            titleDiv.title = "Ir para o texto na nota";
            
            titleDiv.onclick = (e) => {
                e.stopPropagation();
                if (typeof scrollToAndHighlightText === 'function') {
                    scrollToAndHighlightText(entity.nome);
                }
            };

            // --- D. DESCRI√á√ÉO (Clique = Abrir 4¬™ Coluna) ---
            const descDiv = document.createElement('div');
            descDiv.style.cssText = "font-size: 0.85em; color: var(--text-muted-color); line-height: 1.4; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;";
            
            const descText = entity.descricao || 'Sem descri√ß√£o (Clique para ver detalhes).';
            descDiv.textContent = descText;
            descDiv.title = "Abrir painel de refer√™ncias";

            descDiv.onmouseover = () => {
                descDiv.style.backgroundColor = "var(--hover-color)";
                descDiv.style.color = "var(--text-color)";
            };
            descDiv.onmouseout = () => {
                descDiv.style.backgroundColor = "transparent";
                descDiv.style.color = "var(--text-muted-color)";
            };

            descDiv.onclick = (e) => {
                e.stopPropagation();
                // Abre o painel lateral com os detalhes
                showReferencesPanel(entity.id, entity.nome, entity.tipo);
            };

            itemDiv.appendChild(titleDiv);
            itemDiv.appendChild(descDiv);
            list.appendChild(itemDiv);
        }
    });

    if (foundCount === 0) {
        list.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#888; text-align:center; padding:20px;">
                <span style="font-size:30px;">‚öì</span>
                <p>Modo Navega√ß√£o</p>
                <small style="opacity:0.6; line-height:1.5;">Nenhuma entidade encontrada no texto com estas √¢ncoras.</small>
            </div>`;
    }
}

function refreshMiddlePanelTabIcon() {
    // Seleciona os bot√µes do PC e do Mobile
    const allTabBtns = document.querySelectorAll('button[data-mid-tab="texts"], button[data-mob-tab="texts"]');

    allTabBtns.forEach(btn => {
        // Verifica a vari√°vel global diretamente
        if (window.currentNoteHybridMode === true) {
            btn.innerHTML = '<span>üõ≥Ô∏è</span> Misto';
            btn.dataset.mode = 'hybrid';
            btn.title = "Modo H√≠brido: Entidades + B√≠blia";
        } 
        else if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
            btn.innerHTML = '<span>‚öì</span> Navega';
            btn.dataset.mode = 'navega';
            btn.title = "Navega√ß√£o por √Çncoras";
        } 
        else {
            btn.innerHTML = '<span>üìú</span> Textos';
            btn.dataset.mode = 'textos';
            btn.title = "Textos B√≠blicos";
        }
    });
}

// 5. Abrir Modal de Edi√ß√£o de √Çncora
function openEditAnchorModal(anchor) {
    const modal = document.getElementById('edit-anchor-modal');
    const nameInput = document.getElementById('edit-anchor-name');
    const descInput = document.getElementById('edit-anchor-desc');
    const saveBtn = document.getElementById('confirm-edit-anchor');
    const deleteBtn = document.getElementById('delete-anchor-btn'); 

    if (!modal) return;

    // Preenche dados atuais
    nameInput.value = anchor.nome;
    descInput.value = anchor.descricao || '';

    // --- CONFIGURA√á√ÉO VISUAL ---
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.setProperty('z-index', '10000000', 'important'); // 10 Milh√µes
    modal.style.setProperty('visibility', 'visible', 'important');
    modal.style.setProperty('opacity', '1', 'important');

    setTimeout(() => nameInput.focus(), 100);

    // --- A√á√ÉO GRAVAR (Editar) ---
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newDesc = descInput.value.trim();

        if (!newName) return alert("O nome √© obrigat√≥rio.");

        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A gravar...";

        try {
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const anchorRef = doc(db, 'ancoras', anchor.id);

            await updateDoc(anchorRef, {
                nome: newName,
                descricao: newDesc,
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            loadAnchorsForSelection(true); 

        } catch (error) {
            console.error("Erro ao editar:", error);
            alert("Erro ao gravar.");
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
        }
    };

    // --- A√á√ÉO OCULTAR (COM POPUP PERSONALIZADO) ---
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

    newDeleteBtn.textContent = "Ocultar"; 
    newDeleteBtn.style.backgroundColor = "#e74c3c"; 

    newDeleteBtn.onclick = async () => {
        
        // 1. AJUSTE DE CAMADA (Z-INDEX)
        // Como o modal de edi√ß√£o est√° em 10.000.000, o de confirma√ß√£o tem de ser superior
        const confirmModalElement = document.getElementById('confirm-modal');
        if (confirmModalElement) {
            confirmModalElement.style.setProperty('z-index', '20000000', 'important');
        }

        // 2. CHAMAR O POPUP PERSONALIZADO
        const confirmed = await showConfirmation(
            "Ocultar √Çncora?",
            `Deseja ocultar a √¢ncora "${anchor.nome}"?\n\nEla desaparecer√° desta lista e ir√° para "Itens Ocultos".`
        );

        // 3. RESETAR O Z-INDEX (Limpeza)
        if (confirmModalElement) {
            confirmModalElement.style.zIndex = ''; 
        }

        // Se o utilizador clicar em "Cancelar", paramos aqui
        if (!confirmed) return;

        // Se confirmou, prossegue com a l√≥gica...
        newDeleteBtn.textContent = "A ocultar...";
        newDeleteBtn.disabled = true;

        try {
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const anchorRef = doc(db, 'ancoras', anchor.id);
            
            // Define estado como 'desativa'
            await updateDoc(anchorRef, {
                estado: 'desativa',
                ultimaedicao: serverTimestamp()
            });
            
            modal.style.display = 'none';
            
            // Recarrega a lista para o item desaparecer
            loadAnchorsForSelection(true);

        } catch (error) {
            console.error("Erro ao ocultar:", error);
            alert("Erro ao ocultar a √¢ncora.");
        } finally {
            newDeleteBtn.textContent = "Ocultar";
            newDeleteBtn.disabled = false;
        }
    };
}


// ============================================================
// L√ìGICA DO DEP√ìSITO DE REFER√äNCIAS (üèóÔ∏è)
// ============================================================

// 1. INSERIR O WIDGET
document.querySelector('button[data-action="insert-ref-depot"]').addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation();
    
    const uniqueId = `depot_${Date.now()}`;
    
    const widgetHTML = `
        <div class="ref-depot-wrapper" id="${uniqueId}" contenteditable="false">
            <div class="depot-header">
                <!-- √çcone fixo + T√≠tulo edit√°vel -->
                <div style="display:flex; align-items:center; flex-grow:1;">
                    <span style="font-size:1.4em; margin-right:8px;">üèóÔ∏è</span>
                    <input type="text" class="depot-title" value="GRUA DE REFER√äNCIAS" placeholder="T√çTULO DA GRUA..." oninput="this.setAttribute('value', this.value)">
                </div>
                
                <!-- NOVO BOT√ÉO: Expandir/Recolher Tudo -->
                <button class="depot-btn" title="Expandir/Recolher Tudo" onclick="window.toggleAllDepotNodes(this)">‚ÜïÔ∏è</button>
                
                <button class="depot-btn" onclick="window.addDepotCategory('${uniqueId}')">+ üìÇ Categoria</button>
                <button class="depot-btn btn-del-node" title="Apagar Grua" onclick="window.debugDeleteDepot(this)">üóëÔ∏è</button>
            </div>
            
            <div class="depot-content-area">
                <!-- As categorias ser√£o adicionadas aqui -->
            </div>
        </div>
        <p><br></p>
    `;

    document.execCommand('insertHTML', false, widgetHTML);
    
    document.getElementById('formatting-popup').style.display = 'none';
    document.getElementById('more-formatting-btn').classList.remove('active');
    
    setTimeout(() => window.addDepotCategory(uniqueId), 50);
    
    if (typeof saveNote === 'function') saveNote();
});

// 2. FUN√á√ïES GLOBAIS DE INTERA√á√ÉO

// A. Adicionar Categoria Principal (üìÇ)
window.addDepotCategory = function(depotId) {
    const wrapper = document.getElementById(depotId);
    if (!wrapper) return;
    const container = wrapper.querySelector('.depot-content-area');

    const catDiv = document.createElement('div');
    catDiv.className = 'depot-category';
    
    // MUDAN√áA: Removi o bot√£o "+ Link" do cabe√ßalho e adicionei-o dentro da 'depot-tree-line'
    catDiv.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span class="depot-toggle-icon" onclick="window.toggleDepotNode(this)" title="Clique para fechar/abrir" style="cursor:pointer; margin-right:5px; font-size:1.2em; user-select:none;">üìÇ</span>
            
            <input type="text" class="depot-input-title" placeholder="CATEGORIA..." 
                   oninput="this.setAttribute('value', this.value)">
            
            <button class="depot-btn btn-add-sub" title="Adicionar Subt√≠tulo" 
                    onclick="window.addDepotSubtitle(this.closest('.depot-category'))">+ Sub</button>
            
            <button class="depot-btn btn-del-node" title="Remover Categoria" 
                    onclick="window.deleteDepotNode(this)">√ó</button>
        </div>
        
        <div class="depot-tree-line">
            <!-- O bot√£o de adicionar link fica aqui em baixo -->
            <button class="depot-btn btn-add-link-bottom" style="width:100%; margin-top:5px; border-style:dashed; opacity:0.7;" 
                    title="Adicionar Link no fundo" 
                    onclick="window.addDepotLink(this.closest('.depot-category'))">+ Adicionar Link</button>
        </div>
    `;
    
    container.appendChild(catDiv);
    setTimeout(() => { const i = catDiv.querySelector('input'); if(i) i.focus(); }, 50);
};

// ATUALIZADA: ADICIONAR SUBT√çTULO (üîπ)
window.addDepotSubtitle = function(categoryEl) {
    if (!categoryEl) return;
    
    // Abre a pasta se estiver fechada
    if (categoryEl.classList.contains('is-collapsed')) {
        const toggle = categoryEl.querySelector('.depot-toggle-icon');
        if(toggle) window.toggleDepotNode(toggle);
    }

    // 1. Encontrar o contentor correto
    const container = categoryEl.querySelector('.depot-tree-line');
    if (!container) return;
    
    // 2. CORRE√á√ÉO DO ERRO: Encontrar o bot√£o que √© FILHO DIRETO
    // N√£o usamos querySelector aqui para evitar apanhar bot√µes de outros subt√≠tulos aninhados
    let parentAddBtn = null;
    for (let i = 0; i < container.children.length; i++) {
        if (container.children[i].classList.contains('btn-add-link-bottom')) {
            parentAddBtn = container.children[i];
            break; 
        }
    }

    // 3. Criar o HTML do Subt√≠tulo
    const div = document.createElement('div');
    div.className = 'depot-subtitle';
    
    div.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span class="depot-toggle-icon" onclick="window.toggleDepotNode(this)" style="cursor:pointer; margin-right:5px;">üîπ</span>
            <input type="text" class="depot-input-title" placeholder="Subt√≠tulo..." oninput="this.setAttribute('value', this.value)" style="font-size:0.95em; color: #aab7c4;">
            
            <button class="depot-btn btn-del-node" onclick="window.deleteDepotNode(this)">√ó</button>
        </div>
        
        <!-- O Subt√≠tulo tamb√©m precisa da sua pr√≥pria linha e bot√£o no fundo -->
        <div class="depot-tree-line" style="border-left: 2px solid rgba(52, 152, 219, 0.3);">
             <button class="depot-btn btn-add-link-bottom" style="width:100%; margin-top:5px; border-style:dashed; opacity:0.7;" 
                    onclick="window.addDepotLink(this.closest('.depot-subtitle'))">+ Adicionar Link</button>
        </div>
    `;
    
    // 4. Inser√ß√£o Segura
    if (parentAddBtn) {
        // Insere ANTES do bot√£o "+ Adicionar Link" desta categoria
        container.insertBefore(div, parentAddBtn);
    } else {
        // Se por algum motivo o bot√£o n√£o existir, adiciona no fim
        container.appendChild(div);
    }
    
    // Foca no input
    setTimeout(() => {
        const input = div.querySelector('input');
        if(input) {
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 50);
    
    if (typeof saveNote === 'function') saveNote();
};



// 3. NOVA FUN√á√ÉO: O MOTOR DO TOGGLE
window.toggleDepotNode = function(iconElement) {
    // Previne que o clique se propague e cause problemas de foco
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // Encontra o pai (Categoria ou Subt√≠tulo)
    const parentNode = iconElement.closest('.depot-category, .depot-subtitle');
    
    if (parentNode) {
        // Alterna a classe que o CSS usa para esconder
        parentNode.classList.toggle('is-collapsed');
        console.log("üìÇ Toggle acionado em:", parentNode); // Debug na consola
    }
};

// ============================================================
// FUN√á√ïES EM FALTA DO DEP√ìSITO (LINKS)
// ============================================================

// 1. ADICIONAR LINK (Chamado pelo bot√£o + Link)
 window.addDepotLink = function(containerElement) {
    if (!containerElement) return;

    if (containerElement.classList.contains('is-collapsed')) {
        const toggleIcon = containerElement.querySelector('.depot-toggle-icon');
        if (toggleIcon && typeof window.toggleDepotNode === 'function') {
            window.toggleDepotNode(toggleIcon);
        }
    }

    const treeLine = containerElement.querySelector('.depot-tree-line');
    if (!treeLine) return;

    // Encontra o bot√£o de adicionar que est√° no fundo desta lista
    // Usamos :scope > button para garantir que pegamos o bot√£o direto desta lista e n√£o de sublistas
    let addButton = treeLine.querySelector(':scope > .btn-add-link-bottom');

    // Fallback de seguran√ßa se a estrutura for antiga
    if (!addButton) {
        // Se n√£o encontrar o bot√£o (nota antiga), cria-o agora
        addButton = document.createElement('button');
        addButton.className = 'depot-btn btn-add-link-bottom';
        addButton.style.cssText = "width:100%; margin-top:5px; border-style:dashed; opacity:0.7;";
        addButton.textContent = "+ Adicionar Link";
        addButton.onclick = function() { window.addDepotLink(containerElement); };
        treeLine.appendChild(addButton);
    }

    const card = document.createElement('div');
    card.className = 'depot-link-card';
    
    card.innerHTML = `
        <button class="depot-del-card" onclick="window.deleteDepotLink(this)" title="Remover Link">√ó</button>
        <input type="text" class="depot-link-input depot-desc" placeholder="Descri√ß√£o..." value="" oninput="this.setAttribute('value', this.value)">
        <div class="depot-url-row">
            <input type="text" class="depot-link-input depot-url" placeholder="website.com" value="" oninput="this.setAttribute('value', this.value)">
            <button class="depot-visit-btn" onclick="window.visitDepotLink(this)">‚Üó</button>
        </div>
    `;

    // MUDAN√áA CR√çTICA: Insere o cart√£o ANTES do bot√£o de adicionar
    treeLine.insertBefore(card, addButton);

    setTimeout(() => { const i = card.querySelector('.depot-desc'); if(i) i.focus(); }, 50);
    if (typeof saveNote === 'function') saveNote();
};



  

// 2. VISITAR LINK (Atualizado para ler o campo certo)
window.visitDepotLink = function(btn) {
    // Sobe at√© ao cart√£o para encontrar o input correto
    const card = btn.closest('.depot-link-card');
    const inputUrl = card.querySelector('.depot-url');
    
    let url = inputUrl.value.trim();

    if (!url) {
        alert("Insira um URL primeiro.");
        inputUrl.focus();
        return;
    }

    // Adiciona protocolo se faltar
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }

    window.open(url, '_blank');
};



// ============================================================
// ADICIONAR CATEGORIA (üìÇ) - C√ìDIGO CORRIGIDO
// ============================================================
window.addDepotCategory = function(depotId) {
    const wrapper = document.getElementById(depotId);
    if (!wrapper) return;
    
    // Procura o contentor onde as categorias vivem
    const container = wrapper.querySelector('.depot-content-area');

    const catDiv = document.createElement('div');
    catDiv.className = 'depot-category';
    
    // AQUI EST√Å A CORRE√á√ÉO:
    // 1. Adicionei 'cursor:pointer' diretamente no style para garantir que parece clic√°vel.
    // 2. O 'onclick="window.toggleDepotNode(this)"' est√° aplicado no SPAN do √≠cone.
    catDiv.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span class="depot-toggle-icon" onclick="window.toggleDepotNode(this)" title="Clique para fechar/abrir" style="cursor:pointer; margin-right:5px; font-size:1.2em; user-select:none;">üìÇ</span>
            
            <input type="text" class="depot-input-title" placeholder="CATEGORIA..." 
                   oninput="this.setAttribute('value', this.value)">
            
            <button class="depot-btn btn-add-sub" title="Adicionar Subt√≠tulo" 
                    onclick="window.addDepotSubtitle(this.closest('.depot-category'))">+ Sub</button>
            
            <button class="depot-btn btn-add-link" title="Adicionar Link Direto" 
                    onclick="window.addDepotLink(this.closest('.depot-category'))">+ Link</button>
            
           <button class="depot-btn btn-del-node" title="Remover Subt√≠tulo" 
        onclick="window.deleteDepotNode(this)">√ó</button>
        </div>
        
        <!-- Esta √© a div que vai desaparecer quando fechado -->
        <div class="depot-tree-line"></div>
    `;
    
    container.appendChild(catDiv);
    
    // Foca no input
    setTimeout(() => {
        const input = catDiv.querySelector('input');
        if(input) input.focus();
    }, 50);
};

// ============================================================
// FUN√á√ÉO DE ELIMINAR COM CONFIRMA√á√ÉO (üìÇ e üîπ)
// ============================================================
window.deleteDepotNode = async function(btnElement) {
    // --- DEBUG IN√çCIO ---
    console.clear(); // Limpa a consola para ver melhor
    console.log("%c[DEBUG] Bot√£o X clicado!", "background: yellow; color: black; font-size: 14px;");
    console.log("Elemento clicado:", btnElement);
    // --------------------

    const node = btnElement.closest('.depot-category, .depot-subtitle');
    
    if (!node) {
        console.error("‚ùå ERRO: N√£o encontrei a div pai (.depot-category ou .depot-subtitle)");
        return;
    }

    console.log("‚úÖ Elemento Pai encontrado:", node);

    const isCategory = node.classList.contains('depot-category');
    const typeLabel = isCategory ? "Categoria" : "Subt√≠tulo";
    const nameInput = node.querySelector('input');
    const name = nameInput ? nameInput.value : "";
    
    console.log(`Tipo: ${typeLabel}, Nome: "${name}"`);

    // CHAMA O POPUP
    console.log("‚è≥ A chamar showConfirmation...");
    
    const confirmed = await showConfirmation(
        `Eliminar ${typeLabel}?`, 
        `Deseja eliminar "${name || typeLabel}"?\nIsto apagar√° tudo o que estiver dentro.`
    );

    console.log("Resposta do Popup:", confirmed);

    if (confirmed) {
        console.log("üóëÔ∏è A apagar...");
        node.remove();
        if (typeof saveNote === 'function') saveNote();
    } else {
        console.log("üö´ Cancelado.");
    }
};


window.debugDeleteDepot = async function(btnElement) {
    console.group("üóëÔ∏è [DEP√ìSITO] Iniciar Remo√ß√£o");
    
    // 1. Identificar o Wrapper do Dep√≥sito
    const wrapper = btnElement.closest('.ref-depot-wrapper');
    
    if (!wrapper) {
        console.error("‚ùå ERRO: Wrapper n√£o encontrado.");
        console.groupEnd();
        return;
    }

    // 2. Confirma√ß√£o Explicita (Garante que o utilizador quer mesmo apagar)
    const confirmed = await showConfirmation(
        "Apagar Dep√≥sito?", 
        "Deseja enviar esta Grua de Refer√™ncias para a reciclagem?"
    );

    if (!confirmed) {
        console.log("üö´ Cancelado pelo utilizador.");
        console.groupEnd();
        return;
    }

    // 3. REMO√á√ÉO VISUAL IMEDIATA (O Segredo para a rapidez)
    // Escondemos logo o elemento antes de falar com o servidor
    wrapper.style.display = 'none';

    // 4. Arquivar no Firebase (Modo Silencioso)
    // Passamos 'true' para n√£o pedir confirma√ß√£o de novo nem tentar remover visualmente dentro da fun√ß√£o
    const success = await window.archiveMiniNote(wrapper, true);

    if (success) {
        console.log("‚úÖ Arquivado com sucesso no Firebase. Limpando DOM.");
        
        // Substitui o elemento por um marcador invis√≠vel (para manter a posi√ß√£o no hist√≥rico)
        const marker = document.createElement('span');
        marker.id = `marker_${wrapper.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        
        wrapper.replaceWith(marker);
        
        // Grava a nota para oficializar a remo√ß√£o do HTML
        if (typeof saveNote === 'function') saveNote(true);
        
    } else {
        // 5. ERRO: Se falhar, mostra o dep√≥sito de volta
        console.error("‚ùå Falha ao arquivar. Restaurando visual.");
        wrapper.style.display = 'block';
        alert("N√£o foi poss√≠vel apagar (Erro de conex√£o ou permiss√£o).");
    }
    
    console.groupEnd();
};

// ============================================================
// FUN√á√ïES DE ELIMINA√á√ÉO COM CONFIRMA√á√ÉO (DEP√ìSITO)
// ============================================================

// 1. APAGAR CART√ÉO DE LINK (O "√ó" do cart√£o)
window.deleteDepotLink = async function(btn) {
    const card = btn.closest('.depot-link-card');
    if (!card) return;

    // Chama o popup personalizado
    const confirmed = await showConfirmation(
        "Remover Link?", 
        "Deseja apagar este cart√£o de refer√™ncia?"
    );

    if (confirmed) {
        // Efeito visual de sa√≠da
        card.style.transition = "opacity 0.2s, transform 0.2s";
        card.style.opacity = "0";
        card.style.transform = "scale(0.95)";
        
        setTimeout(() => {
            card.remove();
            if (typeof saveNote === 'function') saveNote(); // Grava
        }, 200);
    }
};

// 2. APAGAR N√ìS DA √ÅRVORE (Categorias üìÇ e Subt√≠tulos üîπ)
window.deleteDepotNode = async function(btn) {
    console.log("üî¥ [DEBUG] Bot√£o X clicado!", btn);

    const node = btn.closest('.depot-category, .depot-subtitle');
    if (!node) return console.error("Elemento pai n√£o encontrado");

    const isCategory = node.classList.contains('depot-category');
    const label = isCategory ? "Categoria" : "Subt√≠tulo";
    const nameInput = node.querySelector('input');
    const name = nameInput ? nameInput.value : "";

    // POPUP
    const confirmed = await showConfirmation(
        `Eliminar ${label}?`, 
        `Vai apagar "${name || label}" e todo o conte√∫do dentro.\nContinuar?`
    );

    if (confirmed) {
        console.log("‚úÖ Confirmado. Apagando...");
        
        // Efeito visual
        node.style.transition = "opacity 0.3s, transform 0.3s";
        node.style.opacity = "0";
        node.style.transform = "translateX(20px)";

        setTimeout(() => {
            node.remove();
            if (typeof saveNote === 'function') saveNote();
        }, 300);
    } else {
        console.log("‚ùå Cancelado.");
    }
};



async function handleAutoBackupLogic(noteId, noteData) {
    if (!auth.currentUser) return;

    // Prote√ß√£o Extra: Se a nota nunca foi editada, n√£o vale a pena contar views para backup
    // (Isto evita criar backups de notas vazias que s√≥ abriste por engano)
    if (!noteData.conteudo || noteData.conteudo === "<p><br></p>") return;

    const currentViews = noteData.viewCount || 0;
    const newViewCount = currentViews + 1;
    const noteRef = doc(db, 'pastas', noteId);

    // 1. Atualiza o contador
    updateDoc(noteRef, { viewCount: newViewCount }).catch(err => console.error(err));

    // 2. Verifica o intervalo (Agora a cada 50)
    if (newViewCount % AUTO_BACKUP_INTERVAL === 0) {
        console.log(`ü§ñ [AUTO-BACKUP] Atingiu ${newViewCount} visualiza√ß√µes. Gerando c√≥pia...`);
        
        try {
            const backupsRef = collection(db, 'pastas', noteId, 'backups');
            
            await addDoc(backupsRef, {
                titulo: noteData.nome || "Sem T√≠tulo",
                conteudo: noteData.conteudo || "",
                timestamp: serverTimestamp(),
                isAutoBackup: true,
                triggerReason: `Backup Auto (${newViewCount} views)`
            });
            
            // Feedback discreto
            const statusEl = document.getElementById('save-status-indicator');
            if(statusEl) {
                const originalText = statusEl.textContent;
                statusEl.textContent = "Backup Auto ü§ñ";
                setTimeout(() => statusEl.textContent = originalText, 3000);
            }

        } catch (e) {
            console.error("Erro backup auto:", e);
        }
    }
}

// NOVA FUN√á√ÉO: EXPANDIR/RECOLHER TUDO NA GRUA
window.toggleAllDepotNodes = function(btn) {
    // 1. Encontra a Grua (Wrapper)
    const wrapper = btn.closest('.ref-depot-wrapper');
    if (!wrapper) return;

    // 2. Encontra todas as pastas (Categorias e Subt√≠tulos)
    const allNodes = wrapper.querySelectorAll('.depot-category, .depot-subtitle');
    if (allNodes.length === 0) return;

    // 3. Decide a a√ß√£o: 
    // Se existir pelo menos UMA pasta fechada, vamos ABRIR tudo.
    // Se estiverem todas abertas, vamos FECHAR tudo.
    const shouldExpand = Array.from(allNodes).some(node => node.classList.contains('is-collapsed'));

    // 4. Aplica a todos os n√≥s
    allNodes.forEach(node => {
        if (shouldExpand) {
            node.classList.remove('is-collapsed'); // Abre
        } else {
            node.classList.add('is-collapsed'); // Fecha
        }
    });
};

// --- INJE√á√ÉO DO BOT√ÉO H√çBRIDO NO MODAL DE T√ìPICOS/√ÇNCORAS ---
(function setupHybridToggle() {
    const modalFooter = document.querySelector('#topics-modal .modal-actions');
    if (!modalFooter) return;

    // Cria o contentor do Toggle
    const hybridContainer = document.createElement('div');
    hybridContainer.id = 'hybrid-toggle-container';
    hybridContainer.style.cssText = "display: none; align-items: center; margin-right: auto;"; // Escondido por padr√£o (s√≥ aparece na aba √Çncoras)
    
    hybridContainer.innerHTML = `
        <label class="setting-switch" style="margin-right: 10px;">
            <input type="checkbox" id="hybrid-mode-toggle">
            <span class="slider round"></span>
        </label>
        <span style="font-weight:bold; color:var(--text-muted-color); font-size:0.9em;">‚öì + üìú</span>
    `;

    // Insere no in√≠cio do rodap√© (antes do Cancelar)
    modalFooter.insertBefore(hybridContainer, modalFooter.firstChild);

    // L√≥gica para mostrar/esconder dependendo da aba
    document.getElementById('topics-modal-tabs').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const tab = btn.dataset.tab;
        
        // S√≥ mostra o bot√£o se estiver na aba √Çncoras
        hybridContainer.style.display = (tab === 'anchors') ? 'flex' : 'none';
    });
})();


async function generateHybridView() {
    const list = document.getElementById('note-texts-view');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    // 1. Indicador de Carregamento
    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar Misto...</span></div>';

    // 2. PREPARA√á√ÉO DO TEXTO
    let textContent = editor.innerText;
    // Adiciona texto dos inputs (t√≠tulos)
    editor.querySelectorAll('input, textarea').forEach(el => {
        if (el.value) textContent += " " + el.value;
    });
    
    const textContentLower = textContent.toLowerCase();

    // ============================================================
    // FASE A: DETE√á√ÉO DE √ÇNCORAS (ENTIDADES)
    // ============================================================
    let anchorItems = [];
    
    // S√≥ procura √¢ncoras se houver algumas ativas na nota
    if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
        const allCandidates = Object.values(allEntities).flat();
        const addedNames = new Set(); // Evita duplicados
        
        allCandidates.forEach(entity => {
            // A. Verifica se a entidade tem uma das √¢ncoras ativas
            const entityAnchors = entity.ancorasAssociadas || {};
            const hasMatchingAnchor = activeNoteAnchorsIds.some(id => entityAnchors[id]);

            if (!hasMatchingAnchor) return;

            // B. Verifica se o nome est√° no texto
            if (textContentLower.includes(entity.nome.toLowerCase())) {
                if (addedNames.has(entity.nome)) return;
                addedNames.add(entity.nome);

                // Define √çcone
                let icon = entity.emoji || "üîπ"; 
                if (!entity.emoji) {
                    if (entity.tipo === 'personagem') icon = "üë§";
                    else if (entity.tipo === 'local') icon = "üìç";
                    else if (entity.tipo === 'cosmos') icon = "ü™ê";
                    else if (entity.tipo === 'subcosmos') icon = "üß¨";
                }

                anchorItems.push({
                    type: 'anchor',
                    name: entity.nome,
                    icon: icon,
                    desc: entity.descricao,
                    id: entity.id,
                    entityType: entity.tipo
                });
            }
        });
    }

    // ============================================================
    // FASE B: DETE√á√ÉO B√çBLICA (CORRIGIDA)
    // ============================================================
    let bibleItems = [];
    
    if (typeof BIBLICAL_BOOKS !== 'undefined' && BIBLICAL_BOOKS.length > 0) {
        // Ordena por comprimento para evitar que "Judeus" d√™ match em "Judas" antes do tempo
        const sortedBooks = [...BIBLICAL_BOOKS].sort((a, b) => b.length - a.length);
        const booksPattern = sortedBooks.join('|');
        
        // Regex robusta igual √† aba Textos
        const regex = new RegExp(`\\b((?:${booksPattern})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)`, 'gi');
        
        const rawMatches = textContent.match(regex) || [];
        const uniqueRefs = [...new Set(rawMatches.map(r => r.trim()))];

        uniqueRefs.forEach(ref => {
            bibleItems.push({ 
                type: 'bible', 
                name: ref, 
                icon: "üìú", 
                desc: "A carregar texto..." 
            });
        });
    }

    // ============================================================
    // FASE C: RENDERIZA√á√ÉO FINAL
    // ============================================================
    list.innerHTML = '';

    if (anchorItems.length === 0 && bibleItems.length === 0) {
        list.innerHTML = '<div style="padding:40px 20px; color:#888; text-align:center;">Nenhuma refer√™ncia (Tema ou B√≠blia) encontrada no texto.</div>';
        return;
    }

    // Fun√ß√£o para criar a linha visual
    const createRow = (item) => {
        const div = document.createElement('div');
        div.style.cssText = "padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px; position: relative;";
        
        // Borda: Azul para Temas, Laranja para B√≠blia
        const borderSide = item.type === 'anchor' ? '4px solid var(--accent-color)' : '4px solid #e67e22';
        div.style.borderLeft = borderSide;
        div.style.paddingLeft = "10px";

        // T√≠tulo (Clique = Scroll)
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = "font-weight: bold; color: var(--text-color); cursor: pointer; font-size: 0.95em;";
        titleDiv.innerHTML = `${item.icon} ${item.name}`;
        
        titleDiv.onclick = (e) => {
            e.stopPropagation();
            if (typeof scrollToAndHighlightText === 'function') scrollToAndHighlightText(item.name);
        };

        // Descri√ß√£o (Clique = Painel Refer√™ncias)
        const descDiv = document.createElement('div');
        descDiv.style.cssText = "font-size: 0.85em; color: var(--text-muted-color); cursor: pointer; line-height: 1.4;";
        
        // Se for B√≠blia, d√° um ID √∫nico para injetarmos o texto depois
        if (item.type === 'bible') {
            // Remove caracteres especiais para o ID do HTML
            const safeId = item.name.replace(/[^a-zA-Z0-9]/g, '');
            descDiv.id = `hybrid-preview-${safeId}`;
        }
        
        descDiv.innerHTML = item.desc || '<span style="opacity:0.5; font-style:italic;">Sem descri√ß√£o.</span>';

        descDiv.onclick = (e) => {
            e.stopPropagation();
            const targetType = item.type === 'bible' ? 'textobiblico' : item.entityType;
            // Se for b√≠blia, passamos null no ID para ele buscar pelo nome
            const targetId = item.type === 'bible' ? null : item.id;
            
            showReferencesPanel(targetId, item.name, targetType);
        };

        div.appendChild(titleDiv);
        div.appendChild(descDiv);
        return div;
    };

    // 1. Renderiza √Çncoras
    if (anchorItems.length > 0) {
        const header = document.createElement('div');
        header.innerHTML = "TEMAS";
        header.style.cssText = "font-size:0.7em; font-weight:bold; color:var(--text-muted-color); padding:5px 10px; background:rgba(0,0,0,0.2); letter-spacing:1px; margin-top:0;";
        list.appendChild(header);
        anchorItems.forEach(item => list.appendChild(createRow(item)));
    }

    // 2. Renderiza B√≠blia
    if (bibleItems.length > 0) {
        const header = document.createElement('div');
        header.innerHTML = "B√çBLIA";
        header.style.cssText = "font-size:0.7em; font-weight:bold; color:var(--text-muted-color); padding:5px 10px; background:rgba(0,0,0,0.2); margin-top:10px; letter-spacing:1px;";
        list.appendChild(header);
        
        bibleItems.forEach(item => list.appendChild(createRow(item)));

        // --- CARREGAMENTO DE TEXTOS EM BACKGROUND ---
        for (const item of bibleItems) {
            // Expande refer√™ncias (ex: Jo√£o 3:16-18)
            const verses = typeof expandVerseReference === 'function' ? expandVerseReference(item.name) : [item.name];
            
            // Busca textos
            const textPromises = verses.map(v => fetchPublicBibleText(v));
            
            Promise.all(textPromises).then(texts => {
                const fullText = texts.filter(t => t).join(" ");
                const safeId = item.name.replace(/[^a-zA-Z0-9]/g, '');
                const el = document.getElementById(`hybrid-preview-${safeId}`);
                
                if (el) {
                    if (fullText) {
                        el.textContent = fullText;
                    } else {
                        el.innerHTML = '<span style="opacity:0.5; font-style:italic;">Texto n√£o dispon√≠vel. Clique para adicionar.</span>';
                    }
                }
            }).catch(err => console.error("Erro ao carregar texto h√≠brido:", err));
        }
    }
}

// --- OBSERVADOR DE LEITURA (REMOVE PONTOS AO LER) ---
const postObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        // Se o post est√° mais de 60% vis√≠vel no ecr√£
        if (entry.isIntersecting) {
            const postDiv = entry.target;
            const dot = postDiv.querySelector('.post-status-dot');

            // Se tiver um ponto, agendamos o desaparecimento
            if (dot) {
                // Espera 1.5 segundos (Tempo de leitura)
                setTimeout(() => {
                    // Verifica se o ponto ainda l√° est√° e se o post ainda existe
                    if (dot && document.contains(dot)) {
                        // Adiciona classe CSS que faz desaparecer (opacity: 0)
                        dot.classList.add('dot-vanish');
                        
                        // Remove fisicamente do HTML depois da anima√ß√£o acabar
                        setTimeout(() => dot.remove(), 600);
                    }
                }, 1500); 
            }

            // Para de observar este post (j√° foi processado)
            postObserver.unobserve(postDiv);
        }
    });
}, {
    threshold: 0.6 // O post tem de estar 60% vis√≠vel para contar como "visto"
});

// ============================================================
// MOTOR DO AQU√ÅRIO ü™∏ (VERS√ÉO BLINDADA)
// ============================================================

// 1. Fun√ß√£o para Abrir o Ambiente
window.openAquariumEnvironment = async function(id, data) {
    console.group("ü™∏ [ABERTURA AQU√ÅRIO]");
    
    // 1. GRAVA√á√ÉO DE SEGURAN√áA DA NOTA ANTERIOR
    // Se est√°vamos numa nota normal e vamos para o Aqu√°rio (IDs diferentes)
    if (selectedNoteId && selectedNoteId !== id) {
        console.log("‚è≥ A guardar e fechar a nota anterior...");
        
        // A. Gravar nota anterior
        if (typeof saveNote === 'function') {
            await saveNote(true); 
        }

        // B. Desligar o "ouvido" do Firebase da nota anterior
        if (unsubscribeCurrentNote) {
            unsubscribeCurrentNote();
            unsubscribeCurrentNote = null;
            console.log("üîå Liga√ß√£o √† nota anterior cortada.");
        }

        // C. Limpar visualmente o Editor Normal
        const normalEditor = document.getElementById('note-content-editor');
        const normalTitle = document.getElementById('note-title-input');
        if (normalEditor) normalEditor.innerHTML = "";
        if (normalTitle) normalTitle.value = "";
    }

    // 2. LIMPEZA DO AMBIENTE AQU√ÅRIO
    if (typeof window.resetAquariumState === 'function') {
        window.resetAquariumState();
    }
    console.log("ID Novo:", id);

    // 3. MUDAN√áA DE ESTADO
    selectedNoteId = id;
    window.nextSelectedId = null;
    
    // --- 4. ATUALIZA√á√ÉO VISUAL (T√çTULO EDIT√ÅVEL) ---
    const titleGroup = document.querySelector('.aquarium-title-group');
    if (titleGroup) {
        titleGroup.innerHTML = ''; // Limpa o H2 antigo
        
        const titleInput = document.createElement('input');
        titleInput.type = 'text';
        titleInput.id = 'aquarium-title-input';
        titleInput.className = 'aquarium-header-input';
        titleInput.value = data.nome || "Sem T√≠tulo";
        titleInput.placeholder = "Nome do Aqu√°rio...";
        
        // Evento para gravar o nome automaticamente
        titleInput.addEventListener('input', (e) => {
            // Atualiza o t√≠tulo na lista lateral (visual imediato)
            const listItem = document.querySelector(`.list-item[data-id="${id}"] span`);
            if (listItem) {
                const icon = listItem.textContent.split(' ')[0]; 
                listItem.textContent = `${icon} ${e.target.value}`;
            }
            
            // Grava na base de dados (Debounce)
            clearTimeout(window.aqTitleTimer);
            window.aqTitleTimer = setTimeout(() => {
                if (typeof window.saveAquariumTitle === 'function') {
                    window.saveAquariumTitle(e.target.value);
                }
            }, 1000);
        });

        titleGroup.appendChild(titleInput);
    }
    
    // --- 5. CARREGAR CONTE√öDO E ZOOM ---
    const canvas = document.getElementById('aquarium-content-canvas');
    if (canvas) {
        // A. Injetar Conte√∫do
        if (data.conteudo && data.conteudo.trim() !== "") {
            // Sanitiza e carrega (se DOMPurify estiver dispon√≠vel)
            if (typeof DOMPurify !== 'undefined') {
                canvas.innerHTML = DOMPurify.sanitize(data.conteudo);
            } else {
                canvas.innerHTML = data.conteudo;
            }
        } else {
            // Se vazio, cria o primeiro bloco
            canvas.innerHTML = '<div class="ghost-block" contenteditable="true" data-placeholder=""></div>';
        }

        // ============================================================
        // B. APLICAR ZOOM GUARDADO (AQUI EST√Å A CORRE√á√ÉO)
        // ============================================================
        const savedZoom = data.zoomLevel || '100%';
        const aqZoomSelect = document.getElementById('aq-zoom');

        // Atualiza a dropdown visualmente
        if (aqZoomSelect) {
            aqZoomSelect.value = savedZoom;
        }

        // Aplica o estilo ao Canvas
        canvas.style.fontSize = savedZoom;
        
        // Ajuste de altura de linha
        if (!savedZoom.includes('%')) {
             const sizeNum = parseInt(savedZoom);
             if (!isNaN(sizeNum)) {
                 canvas.style.lineHeight = (sizeNum * 1.5) + 'px';
             }
        } else {
             canvas.style.lineHeight = '1.6';
        }
        // ============================================================
    }

    // --- AUTO-CURA E RECONSTRU√á√ÉO ---
    if (canvas) {
        // Remove popups √≥rf√£os
        canvas.querySelectorAll('.aq-popup-window').forEach(p => p.remove());

        const allGhosts = canvas.querySelectorAll('.ghost-block');
        allGhosts.forEach(g => {
            // Desbloqueia tudo e restaura bot√µes
            g.classList.remove('locked-popup', 'active-selection', 'active-store-target');
            g.style.cssText = ""; // Limpa estilos inline
            g.setAttribute('contenteditable', 'true');
            
            if (typeof ensureGhostActions === 'function') {
                ensureGhostActions(g);
            }
        });
    }

    // 6. VISIBILIDADE (O Grande Truque)
    // Esconde a App Normal
    const mainApp = document.querySelector('.notebook-container');
    if (mainApp) mainApp.style.setProperty('display', 'none', 'important');

    // Mostra o Aqu√°rio
    document.body.style.overflow = 'hidden';
    const env = document.getElementById('aquarium-environment');
    
    if (env) {
        document.body.appendChild(env);
        env.style.cssText = `
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 2000000000 !important;
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%) !important;
            opacity: 0;
            visibility: visible !important;
            transition: opacity 0.5s ease;
        `;
        requestAnimationFrame(() => { setTimeout(() => { env.style.opacity = '1'; }, 10); });
        
        // Efeito de bolhas
        if (typeof window.triggerAquariumBubbles === 'function') {
            window.triggerAquariumBubbles();
        }
    }

    // --- AJUSTE MOBILE: MOVER STATUS PARA O TOPO ---
    if (window.innerWidth <= 768) {
        const navGroup = document.querySelector('.aquarium-nav-group');
        const statusEl = document.getElementById('aq-save-status');
        
        if (navGroup && statusEl && !navGroup.contains(statusEl)) {
            if (statusEl.parentNode) statusEl.parentNode.removeChild(statusEl);

            const spacer = document.createElement('div');
            spacer.style.cssText = "width: 15px; height: 1px; display: inline-block; flex-shrink: 0;";
            
            const sep = document.createElement('div');
            sep.className = 'mobile-status-sep';
            sep.style.cssText = "width:1px; height:20px; background:rgba(255,255,255,0.2); margin-right: 5px; display:inline-block; flex-shrink: 0;";
            
            navGroup.appendChild(spacer);
            navGroup.appendChild(sep);
            navGroup.appendChild(statusEl);
            
            statusEl.style.fontSize = "0.75em";
            statusEl.style.whiteSpace = "nowrap";
            statusEl.style.position = "static"; 
            statusEl.style.display = "inline-block";
        }
    }

    console.groupEnd();
};

// ============================================================
// FUN√á√ÉO DE GRAVA√á√ÉO DO AQU√ÅRIO
// ============================================================
window.saveAquariumState = async function() {
    // 1. Limpa o temporizador (pois vamos gravar agora)
    clearTimeout(aqAutoSaveTimer);
    
    if (!selectedNoteId) return;
    
    // Atualiza visual para "A guardar..."
    updateAquariumStatus('saving');

    const canvas = document.getElementById('aquarium-content-canvas');
    if (!canvas) return;

    // --- LIMPEZA DE DADOS (CLONE) ---
    const cleanCanvas = canvas.cloneNode(true);
    cleanCanvas.querySelectorAll('.ghost-actions').forEach(el => el.remove());
    cleanCanvas.querySelectorAll('.aq-popup-window').forEach(el => el.remove());

    cleanCanvas.querySelectorAll('.ghost-block').forEach(block => {
        block.classList.remove('locked-popup', 'active-selection', 'active-store-target'); 
        block.style.cssText = ""; // Limpa estilos inline
        block.setAttribute('contenteditable', 'true');
        block.removeAttribute('data-temp-id');
    });

    const content = cleanCanvas.innerHTML;
    const titleInput = document.getElementById('aquarium-title-input');
    const currentTitle = titleInput ? titleInput.value : null;

 const aqZoom = document.getElementById('aq-zoom');
    const currentZoom = aqZoom ? aqZoom.value : '100%';


    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);

        const updatePayload = {
            conteudo: content,
             zoomLevel: currentZoom, 
            ultimaedicao: serverTimestamp()
        };

        if (currentTitle && currentTitle !== "Sem T√≠tulo") {
            updatePayload.nome = currentTitle;
        }

        await updateDoc(noteRef, updatePayload);
        
        // SUCESSO: Atualiza para "Guardado"
        updateAquariumStatus('saved');

    } catch (e) {
        console.error("‚ùå Erro ao gravar Aqu√°rio:", e);
        updateAquariumStatus('error');
    }
};

// ============================================================
// BOT√ÉO VOLTAR (SAIR DO AQU√ÅRIO E RESTAURAR APP)
// ============================================================
const aqBackBtn = document.getElementById('aquarium-back-btn');
if (aqBackBtn) {
    const newBtn = aqBackBtn.cloneNode(true);
    aqBackBtn.parentNode.replaceChild(newBtn, aqBackBtn);

    newBtn.addEventListener('click', async () => {
        // 1. Grava o estado atual (Seguran√ßa)
        if (typeof saveAquariumState === 'function') await saveAquariumState();
        
        // 2. Limpa o ambiente do Aqu√°rio
        window.resetAquariumState();
        
        // 3. Esconde o ambiente Aqu√°rio
        const env = document.getElementById('aquarium-environment');
        if (env) env.style.display = 'none';
        
        // 4. Restaura a App Principal (Notebook Container)
        const mainApp = document.querySelector('.notebook-container');
        if (mainApp) mainApp.style.setProperty('display', 'flex', 'important');
        document.body.style.overflow = ''; 

        // --- CORRE√á√ÉO MOBILE AQUI ---
        if (window.innerWidth <= 768) {
            // Em vez de resetar o editor, apenas mudamos a vista
            document.body.classList.remove('mobile-view-editor');
            document.body.classList.add('mobile-view-middle');
            
            // For√ßamos o contentor a n√£o estar colapsado
            if (mainApp) mainApp.classList.remove('middle-panel-collapsed');
        }

        // 5. ATUALIZA A NAVEGA√á√ÉO SEM APAGAR OS DADOS
        // Passamos 'true' para manter o editor em background, o que preserva 
        // a posi√ß√£o da pasta na pilha de navega√ß√£o (navigationStack).
        updateNavigationView(true); 
        
        console.log("üìÇ Retornando √† pasta de origem...");
    });
}

// ============================================================
// CORRE√á√ÉO: BOT√ïES DE TOPO DO AQU√ÅRIO (Z-INDEX FIX)
// ============================================================

// 1. BOT√ÉO SALTAR (íÜú)
const jumpBtnFix = document.getElementById('aquarium-jump-btn');

if (jumpBtnFix) {
    const newJumpBtn = jumpBtnFix.cloneNode(true);
    jumpBtnFix.parentNode.replaceChild(newJumpBtn, jumpBtnFix);

    newJumpBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const popup = document.getElementById('aquarium-jump-popup');
        
        if (popup) {
            if (popup.style.display === 'flex') {
                popup.style.display = 'none';
            } else {
          // FOR√áA BRUTA: Move para o body e aplica Z-Index M√°ximo
                document.body.appendChild(popup);
                popup.style.cssText = `
                    display: flex !important;
                    position: fixed !important;
                    z-index: 2147483647 !important;
                    top: 60px !important;
                    left: 80px !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    
                    /* CORRE√á√ÉO DO FUNDO: Cor s√≥lida (Hexadecimal) + Sombra Forte */
                    background-color: #252528 !important; 
                    box-shadow: 0 10px 50px rgba(0,0,0,1) !important;
                    
                    border: 1px solid var(--accent-color);
                    border-radius: 8px;
                    padding: 10px;
                    flex-direction: column;
                    width: 300px;
                `;
                
                const search = document.getElementById('aquarium-jump-search');
                if (search) {
                    search.value = ""; // Limpa pesquisa anterior
                    search.focus();
                    search.oninput = (ev) => loadAquariumNotesList(ev.target.value); // Liga a pesquisa
                }
                
                // Carrega a lista inicial (todas)
                loadAquariumNotesList();
            }
        }
    });
}

// 2. BOT√ïES DE FERRAMENTAS (üîê üìë üïí ‚Ü©Ô∏è ‚Ü™Ô∏è)
const toolsGroupFix = document.querySelector('.aquarium-tools-group');

if (toolsGroupFix) {
    // Limpeza de seguran√ßa (Clonagem)
    const newToolsGroup = toolsGroupFix.cloneNode(true);
    toolsGroupFix.parentNode.replaceChild(newToolsGroup, toolsGroupFix);

    newToolsGroup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const action = btn.dataset.action;
        let modalId = null;

        // --- A√á√ïES DO SISTEMA ---
        if (action === 'note-sharing-settings') {
            if (typeof window.openShareModalForArchive === 'function') {
                window.openShareModalForArchive();
                modalId = 'note-share-popup';
            }
        }
        else if (action === 'show-topics') {
            if (typeof openTopicsModal === 'function') {
                openTopicsModal(selectedNoteId, 'nota');
                modalId = 'topics-modal';
            }
        }
        else if (action === 'show-history') {
            if (typeof openHistoryModal === 'function') {
                openHistoryModal();
                modalId = 'history-modal';
            }
        }

        // --- NOVAS A√á√ïES: UNDO / REDO ---
        else if (action === 'undo') {
            document.execCommand('undo', false, null);
            // Opcional: Gravar o estado ap√≥s desfazer
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }
        else if (action === 'redo') {
            document.execCommand('redo', false, null);
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }

        // --- CORRE√á√ÉO DE VISIBILIDADE DE MODAIS ---
        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                document.body.appendChild(modal);
                modal.style.setProperty('z-index', '2147483647', 'important');
                modal.style.setProperty('display', 'flex', 'important');
                modal.style.setProperty('visibility', 'visible', 'important');
                modal.style.setProperty('opacity', '1', 'important');
            }
        }
    });
}

// ============================================================
// L√ìGICA DA BARRA DE FERRAMENTAS DE BAIXO (WIDGETS DIRECTOS)
// ============================================================

const aqToolbarFix = document.getElementById('aquarium-toolbar');

if (aqToolbarFix) {
    // 1. Remover ouvintes antigos
    const newToolbar = aqToolbarFix.cloneNode(true);
    aqToolbarFix.parentNode.replaceChild(newToolbar, aqToolbarFix);

    // 2. Novo Listener Unificado
    newToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        // --- A. MENU DE PONTOS (‚Ä¢‚Ä¢) ---
        if (e.target.classList.contains('dots')) {
            e.stopPropagation();
            const cmd = btn.dataset.cmd;
            const popupId = (cmd === 'boldBlue') ? 'bold-palette-popup' : 'italic-palette-popup';
            
            const popup = document.getElementById(popupId);
            if (popup) {
                document.body.appendChild(popup);
                const rect = btn.getBoundingClientRect();
                popup.style.display = 'block';
                popup.style.top = (rect.bottom + 5) + 'px';
                popup.style.left = rect.left + 'px';
                popup.style.setProperty('z-index', '2147483647', 'important');
            }
            return;
        }

        // --- B. COMANDOS DE TEXTO ---
        if (btn.dataset.cmd) {
            const cmd = btn.dataset.cmd;
            if (cmd === 'boldBlue') {
                document.execCommand('bold', false, null);
                document.execCommand('foreColor', false, '#4a90e2');
            } else {
                document.execCommand(cmd, false, null);
            }
        }

        // --- C. A√á√ïES DE WIDGETS E FERRAMENTAS ---
        else if (btn.dataset.action) {
            const action = btn.dataset.action;
            const uniqueId = `aq_${action}_${Date.now()}`;

            // >>> NOVA L√ìGICA: BURACO NEGRO (üï≥Ô∏è) <<<
            if (action === 'black-hole') {
                if (typeof openBlackHoleModal === 'function') {
                    openBlackHoleModal();
                    
                    // For√ßa o Z-Index para aparecer √† frente do Aqu√°rio
                    const bhModal = document.getElementById('black-hole-modal');
                    if(bhModal) {
                        document.body.appendChild(bhModal);
                        bhModal.style.setProperty('z-index', '2147483647', 'important');
                        bhModal.style.display = 'flex';
                    }
                }
                return;
            }
            // >>> FIM DO NOVO BLOCO <<<

            // ... (Resto das a√ß√µes: bible-scan, insert-toggle, etc. mant√™m-se iguais) ...
            if (action === 'bible-scan') {
                if (typeof openUniversalScanner === 'function') {
                    openUniversalScanner();
                    const scanModal = document.getElementById('universal-scan-modal');
                    if (scanModal) {
                        document.body.appendChild(scanModal);
                        scanModal.style.setProperty('z-index', '2147483647', 'important');
                        scanModal.style.setProperty('visibility', 'visible', 'important');
                    }
                }
            }
            else if (action === 'insert-toggle-h2') {
                document.execCommand('insertHTML', false, `<details class="toggle-section" open id="${uniqueId}"><summary><h2>T√≠tulo</h2><button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button></summary><div class="toggle-content" contenteditable="true"><p><br></p></div></details><p><br></p>`);
            }
            else if (action === 'insert-date') {
                const today = new Date();
                document.execCommand('insertHTML', false, `<div class="jwn-calendar-widget" contenteditable="false" id="${uniqueId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}"><div class="cal-header"><button class="cal-btn cal-prev">‚óÄ</button><span class="cal-title">Carregando...</span><div style="display:flex; gap:5px;"><button class="cal-btn cal-next">‚ñ∂</button><button class="cal-btn cal-settings">‚öôÔ∏è</button></div></div><div class="cal-settings-menu"><button class="cal-delete-btn">üóëÔ∏è Eliminar</button></div><div class="cal-grid"></div></div><p><br></p>`);
                setTimeout(() => { if (typeof renderCalendarUI === 'function') renderCalendarUI(document.getElementById(uniqueId)); }, 50);
            }
            else if (action === 'insert-table') {
                document.execCommand('insertHTML', false, `<div class="jwn-table-wrapper"><button class="table-settings-btn" contenteditable="false">üõ†Ô∏è</button><table class="jwn-table"><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td><br></td><td><br></td></tr></tbody></table></div><p><br></p>`);
            }
            else if (action === 'insert-timeline') {
                document.execCommand('insertHTML', false, `<div class="jwn-timeline-wrapper" contenteditable="false" id="${uniqueId}"><div class="timeline-track"></div><div class="timeline-container"><div class="timeline-entry"><div class="t-marker"></div><div class="t-date" contenteditable="true">Data</div><div class="t-text" contenteditable="true">Evento...</div><button class="t-btn-del">√ó</button></div></div><button class="t-btn-add">‚ûï Ponto</button></div><p><br></p>`);
            }
            else if (action === 'make-draggable') {
                const sel = window.getSelection().toString() || "Texto";
                document.execCommand('insertHTML', false, `<div class="draggable-line" draggable="true" id="${uniqueId}"><span class="drag-handle-icon" contenteditable="false">·Øì</span><div class="drag-content-area" contenteditable="true">${sel}</div></div>`);
            }
            else if (action === 'insert-checkbox') {
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.style.marginRight = '8px';
                if (typeof insertNodeAtCursor === 'function') insertNodeAtCursor(cb);
            }
            else if (action === 'insertHorizontalRule') {
                document.execCommand('insertHorizontalRule', false, null);
            }
        }
    });

    // Re-liga√ß√£o dos inputs (Zoom, Formato, Cor) - MANTENHA ESTA PARTE IGUAL AO SEU C√ìDIGO ORIGINAL
    const aqZoom = document.getElementById('aq-zoom');
    if (aqZoom) aqZoom.addEventListener('change', (e) => { const c = document.getElementById('aquarium-content-canvas'); if (c) c.style.zoom = e.target.value; });
    const aqFormat = document.getElementById('aq-format');
    if (aqFormat) aqFormat.addEventListener('change', (e) => { document.execCommand('formatBlock', false, e.target.value); });
    const aqColor = document.getElementById('aq-color');
    if (aqColor) aqColor.addEventListener('input', (e) => { document.execCommand('foreColor', false, e.target.value); });
}

// ============================================================
// L√ìGICA DOS FANTASMAS (CANVAS)
// ============================================================

// 1. Definir a vari√°vel globalmente para ser acess√≠vel pelos bot√µes
window.activeGhost = null;

// 2. Fun√ß√£o para ativar o bloco e mostrar a barra
window.setActiveGhost = function(ghost) {
    window.activeGhost = ghost;
    
    // --- LIMPEZA DE DESTAQUE DO ARMAZ√âM (Mant√©m a l√≥gica existente) ---
    if (window.activeStoreGhostId && ghost.id !== window.activeStoreGhostId) {
        const oldTarget = document.getElementById(window.activeStoreGhostId);
        if (oldTarget) {
            oldTarget.classList.remove('active-store-target');
            oldTarget.style.border = '';
            oldTarget.style.backgroundColor = '';
            oldTarget.style.boxShadow = '';
        }
    }

    const contextTools = document.getElementById('aq-context-tools');
    
    if (contextTools) {
        contextTools.style.setProperty('display', 'flex', 'important');
        
        // 1. Limpa classes de todos os blocos
        document.querySelectorAll('.ghost-block').forEach(g => {
            g.classList.remove('active-selection');
            g.classList.remove('has-next'); // Remove a permiss√£o do bot√£o +
            
            // Limpezas de estilo inline
            g.style.borderTop = '';
            g.style.border = '';
            g.style.outline = '';
        });
        
        // 2. Adiciona classe de sele√ß√£o ao atual
        ghost.classList.add('active-selection');
        
        // ============================================================
        // NOVA L√ìGICA DO BOT√ÉO "+"
        // ============================================================
        // Verifica se existe um elemento irm√£o seguinte E se √© um ghost-block
        const nextBlock = ghost.nextElementSibling;
        
        if (nextBlock && nextBlock.classList.contains('ghost-block')) {
            // Se houver um bloco a seguir, adiciona a classe que faz o CSS mostrar o bot√£o
            ghost.classList.add('has-next');
        }
        // ============================================================

        // 3. SEGURAN√áA M√ÅXIMA (Mant√©m l√≥gica existente)
        ghost.style.removeProperty('border-top');
        ghost.style.removeProperty('border');
        ghost.style.removeProperty('outline');
        
    } else {
        console.warn("‚ö†Ô∏è Barra de ferramentas #aq-context-tools n√£o encontrada.");
    }
};

// Fun√ß√£o auxiliar para injetar os bot√µes se n√£o existirem
function ensureGhostActions(ghost) {
    
    // 1. Bot√µes de Topo (Menu e Armaz√©m)
    if (!ghost.querySelector('.ghost-actions')) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'ghost-actions';
        actionsDiv.setAttribute('contenteditable', 'false'); // Atributo HTML expl√≠cito
        actionsDiv.innerHTML = `
            <button class="ghost-action-btn" title="Armaz√©m (Notas Anexadas)" onclick="window.openGhostStore(this)">üêö</button>
            <button class="ghost-action-btn" title="Abrir Popup" onclick="window.openGhostPopup(this)">‚á±</button>
        `;
        ghost.prepend(actionsDiv);
    }

    // 2. Limpeza de bot√µes antigos soltos
    const oldAddBtn = ghost.querySelector(':scope > .ghost-add-between-btn');
    if (oldAddBtn) oldAddBtn.remove();

    // 3. CONTROLOS LATERAIS (Setas + Bot√£o Adicionar)
    let sideControls = ghost.querySelector('.ghost-side-controls');
    
    if (!sideControls) {
        console.log("üõ†Ô∏è [DEBUG] Criando barra lateral (Secure Mode)...");
        
        sideControls = document.createElement('div');
        sideControls.className = 'ghost-side-controls';
        sideControls.setAttribute('contenteditable', 'false'); // BLINDAGEM 1

        // Bot√£o Subir (üî∫)
        const upBtn = document.createElement('button');
        upBtn.className = 'ghost-move-btn';
        upBtn.innerHTML = '‚ñ≤';
        upBtn.setAttribute('contenteditable', 'false'); // BLINDAGEM 2
        
        upBtn.onclick = (e) => {
            console.log("üî∫ [CLIQUE] Bot√£o SUBIR!");
            e.preventDefault(); e.stopPropagation(); 
            window.moveGhostBlock(ghost, -1);
        };
        // O mousedown previne que o foco mude para o texto
        upBtn.onmousedown = (e) => { e.preventDefault(); e.stopPropagation(); };

        // Bot√£o Descer (üîª)
        const downBtn = document.createElement('button');
        downBtn.className = 'ghost-move-btn';
        downBtn.innerHTML = '‚ñº';
        downBtn.setAttribute('contenteditable', 'false'); // BLINDAGEM 2
        
        downBtn.onclick = (e) => {
            console.log("üîª [CLIQUE] Bot√£o DESCER!");
            e.preventDefault(); e.stopPropagation();
            window.moveGhostBlock(ghost, 1);
        };
        downBtn.onmousedown = (e) => { e.preventDefault(); e.stopPropagation(); };

        // Bot√£o Adicionar (+)
        const addBtn = document.createElement('div');
        addBtn.className = 'ghost-add-between-btn';
        addBtn.setAttribute('contenteditable', 'false'); // BLINDAGEM 2
        
        addBtn.onclick = (e) => {
            console.log("‚ûï [CLIQUE] Bot√£o ADICIONAR!");
            e.preventDefault(); e.stopPropagation();
            window.insertBlockBelow(ghost);
        };
        addBtn.onmousedown = (e) => { e.preventDefault(); e.stopPropagation(); };

        sideControls.appendChild(upBtn);
        sideControls.appendChild(downBtn);
        sideControls.appendChild(addBtn);
        
        ghost.prepend(sideControls);
    }

    // 4. Garantia de Cursor
    let hasContent = false;
    ghost.childNodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') hasContent = true;
    });

    if (!hasContent && !ghost.querySelector('br')) {
        const br = document.createElement('br');
        ghost.appendChild(br);
    }
}

// Atualiza a cria√ß√£o de novos blocos
function createNewGhost() {
    const canvas = document.getElementById('aquarium-content-canvas');
    if (!canvas) return;
    
    const newGhost = document.createElement('div');
    newGhost.className = 'ghost-block';
    newGhost.setAttribute('contenteditable', 'true');
    newGhost.dataset.placeholder = ""; // Placeholder vazio para n√£o atrapalhar
    
    // Injeta os bot√µes de a√ß√£o imediatamente
    if (typeof ensureGhostActions === 'function') {
        ensureGhostActions(newGhost);
    }
    
    canvas.appendChild(newGhost);
    
    // --- MAGIA DO FOCO IMEDIATO ---
    // 1. Foca o elemento
    newGhost.focus();
    
    // 2. Cria um "Intervalo de Sele√ß√£o" (Range) dentro da caixa
    // Isto for√ßa o navegador a por o cursor a piscar l√° dentro
    const range = document.createRange();
    range.selectNodeContents(newGhost);
    range.collapse(false); // Colapsa para o fim (preparado para escrever)
    
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    
    // 3. Ativa a barra de ferramentas visual
    window.setActiveGhost(newGhost);
    
    // 4. Scroll suave para garantir que a nova caixa est√° vis√≠vel
    newGhost.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// 4. Configurar Listeners do Canvas (com atraso para garantir que o HTML existe)
 setTimeout(() => {
        const canvas = document.getElementById('aquarium-content-canvas');
        const scrollArea = document.getElementById('aquarium-scroll-area');

  if (canvas) {
            // A. DETETAR CLIQUE NO BLOCO
            canvas.addEventListener('click', (e) => {
                
                // >>> NOVA PROTE√á√ÉO: BLOCOS BLOQUEADOS <<<
                // Se clicou num bloco que est√° aberto em popup (.locked-popup), P√ÅRA TUDO.
                if (e.target.closest('.locked-popup')) {
                    console.log("üö´ Clique em bloco bloqueado ignorado.");
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                // >>> FIM DA PROTE√á√ÉO <<<

                const ghost = e.target.closest('.ghost-block');
                if (ghost) {
                    window.setActiveGhost(ghost);
                    e.stopPropagation();
                } 
            });

            // B. DETETAR CLIQUE NO VAZIO (Criar Novo) - >> CORRE√á√ÉO APLICADA AQUI <<
        if (scrollArea) {
                scrollArea.addEventListener('click', (e) => {
                    
                    // 1. Prote√ß√µes B√°sicas
                    const selection = window.getSelection();
                    if (selection && selection.toString().length > 0) return;
                    if (e.target.closest('.locked-popup')) return;

                    // 2. Verifica se clicou na estrutura base
                    if (e.target === scrollArea || e.target === canvas) {
                        
                        // --- NOVA L√ìGICA GEOM√âTRICA ---
                        const lastBlock = canvas.lastElementChild;

                        // Se o canvas tiver conte√∫do, verificamos a posi√ß√£o do clique
                        if (lastBlock) {
                            const rect = lastBlock.getBoundingClientRect();
                            const clickY = e.clientY;

                            // Se o clique foi ACIMA da linha inferior do √∫ltimo bloco,
                            // significa que foi numa margem lateral. IGNORAMOS.
                            if (clickY < rect.bottom) {
                                return; 
                            }
                        }
                        // -----------------------------

                        e.preventDefault(); 
                        
                        // Limpa sele√ß√£o visual
                        document.querySelectorAll('.ghost-block').forEach(g => {
                            g.classList.remove('active-selection');
                            g.style.outline = '';
                        });

                        // L√ìGICA DE CRIA√á√ÉO (Manteve-se igual)
                        if (lastBlock && lastBlock.classList.contains('ghost-block') && lastBlock.textContent.trim() === '') {
                            lastBlock.focus();
                            window.setActiveGhost(lastBlock);
                            
                            const range = document.createRange();
                            range.selectNodeContents(lastBlock);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        } 
                        else {
                            createNewGhost();
                        }
                    }
                });
            }

            // C. DETETAR FOCO (Tab ou Sele√ß√£o)
            canvas.addEventListener('focusin', (e) => {
                const ghost = e.target.closest('.ghost-block');
                if (ghost) window.setActiveGhost(ghost);
            });

      // D. DETETAR ESCRITA (L√≥gica de "Por Guardar")
            canvas.addEventListener('input', (e) => {
                const ghost = e.target.closest('.ghost-block');
                if (ghost) window.setActiveGhost(ghost);

                // 1. Muda status para "por guardar..."
                updateAquariumStatus('unsaved');

                // 2. Reinicia o temporizador (Debounce de 2 minutos)
                clearTimeout(aqAutoSaveTimer);
                aqAutoSaveTimer = setTimeout(() => {
                    window.saveAquariumState();
                }, 120000); // 2 minutos
            });

            // Listener para clicar no texto "por guardar..." para for√ßar grava√ß√£o
            const statusBtn = document.getElementById('aq-save-status');
            if (statusBtn) {
                statusBtn.addEventListener('click', () => {
                    if (statusBtn.textContent === 'por guardar...') {
                        window.saveAquariumState();
                    }
                });
            }

            // E. TECLADO (L√≥gica Sem√¢ntica de Enter)
            canvas.addEventListener('keydown', (e) => {
                const currentGhost = e.target.closest('.ghost-block');
                if (!currentGhost) return;

                // --- DETETOR DE ENTER ---
                if (e.key === 'Enter' && !e.shiftKey) {
                    
                    // 1. Verificar o tipo sem√¢ntico atual
                    // Se n√£o tiver atributo, assume 'p' (Par√°grafo Normal)
                    const type = currentGhost.dataset.semantic || 'p';

                    // --- COMPORTAMENTO A: MANTER NA MESMA CAIXA ---
                    // Aplica-se a: Par√°grafo (p) e Nota (note)
                    if (type === 'p' || type === 'note') {
                        // Previne a cria√ß√£o de div/bloco novo
                        e.preventDefault(); 
                        
                        // Insere uma quebra de linha manual (<br>)
                        document.execCommand('insertLineBreak');
                        return; // Fica aqui, n√£o cria novo fantasma
                    }

                    // --- COMPORTAMENTO B: CRIAR NOVA CAIXA EM BAIXO ---
                    // Aplica-se a: Subpar√°grafo (sub), H1 e H2
                    if (type === 'sub' || type === 'h1' || type === 'h2') {
                        e.preventDefault();
                        
                        const newGhost = document.createElement('div');
                        newGhost.className = 'ghost-block';
                        newGhost.setAttribute('contenteditable', 'true');
                        newGhost.dataset.placeholder = "";
                        
                        // Se o atual era um Subpar√°grafo, o pr√≥ximo tamb√©m ser√° por conveni√™ncia
                        if (type === 'sub') {
                            newGhost.setAttribute('data-semantic', 'sub');
                        }
                        // Se era H1 ou H2, o pr√≥ximo volta a ser Par√°grafo (padr√£o, sem atributo)

                        if (currentGhost.nextSibling) {
                            canvas.insertBefore(newGhost, currentGhost.nextSibling);
                        } else {
                            canvas.appendChild(newGhost);
                        }
                        
                        setTimeout(() => {
                            newGhost.focus();
                            window.setActiveGhost(newGhost);
                        }, 10);
                    }
                }
                
                // BACKSPACE: Apagar se vazio
                if (e.key === 'Backspace' && currentGhost.textContent === '') {
                    if (canvas.children.length > 1) {
                        e.preventDefault();
                        if (typeof sendToBlackHole === 'function') sendToBlackHole(currentGhost);
                        const prev = currentGhost.previousElementSibling;
                        currentGhost.remove();
                        
                        const tools = document.getElementById('aq-context-tools');
                        if(tools) tools.style.setProperty('display', 'none', 'important');

                        if (prev) {
                            prev.focus();
                            const range = document.createRange();
                            range.selectNodeContents(prev);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                            window.setActiveGhost(prev);
                        }
                    }
                }
                
                // SETAS
                if (e.key === 'ArrowUp') {
                    const prev = currentGhost.previousElementSibling;
                    if (prev) setTimeout(() => { prev.focus(); window.setActiveGhost(prev); }, 10);
                }
                if (e.key === 'ArrowDown') {
                    const next = currentGhost.nextElementSibling;
                    if (next) setTimeout(() => { next.focus(); window.setActiveGhost(next); }, 10);
                }
            });
        }
    }, 500);




function setActiveGhost(ghost) {
    activeGhost = ghost;
    if (contextToolbar) contextToolbar.style.display = 'flex';
}


// Fun√ß√£o para inserir um bloco novo entre A e B
window.insertBlockBelow = function(currentBlock) {
    console.log("üöÄ A criar novo bloco...");
    
    // 1. Criar
    const newGhost = document.createElement('div');
    newGhost.className = 'ghost-block';
    newGhost.id = 'ghost_' + Date.now();
    newGhost.setAttribute('contenteditable', 'true');
    newGhost.dataset.placeholder = "";
    
    // 2. Inserir
    currentBlock.insertAdjacentElement('afterend', newGhost);

    // 3. Adicionar bot√µes ao novo bloco
    ensureGhostActions(newGhost);

    // 4. Focar
    setTimeout(() => {
        newGhost.focus();
        // Ativa o novo bloco (isto vai mover o bot√£o + para o s√≠tio certo)
        if (typeof window.setActiveGhost === 'function') {
            window.setActiveGhost(newGhost);
        }
    }, 10);
    
    // 5. Gravar
    if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
};


// ============================================================
// L√ìGICA DA BARRA DE CONTEXTO DO FANTASMA (CORRE√á√ÉO DE TEMPO)
// ============================================================

setTimeout(() => {
    const contextToolbarElement = document.getElementById('aq-context-tools');

    if (contextToolbarElement) {
        console.log("üîß [INIT] Barra de ferramentas do Aqu√°rio encontrada e pronta.");

        // Clonamos para limpar ouvintes antigos e evitar duplicados
        const newContextToolbar = contextToolbarElement.cloneNode(true);
        contextToolbarElement.parentNode.replaceChild(newContextToolbar, contextToolbarElement);

        // --- FUN√á√ÉO NUCLEAR PARA FOR√áAR VISIBILIDADE ---
        const forceModalToTop = (modalId) => {
            console.log(`üöÄ [NUCLEAR] Tentando for√ßar o modal '${modalId}' para a frente...`);
            
            const modal = document.getElementById(modalId);
            if (modal) {
                // 1. Move para o fim do corpo (garante prioridade DOM)
                document.body.appendChild(modal); 
                
                // 2. Aplica estilos com prioridade m√°xima (!important) e SEM DELAY
                modal.style.cssText = `
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO DE 32-BIT */
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    justify-content: center !important;
                    align-items: center !important;
                    pointer-events: auto !important;
                `;

                console.log(`‚úÖ [NUCLEAR] Estilos aplicados ao modal '${modalId}'. Z-Index: 2147483647`);

                // Corre√ß√£o extra para o modal de Cores que tem CSS diferente
                if (modalId === 'highlight-modal') {
                    const content = modal.querySelector('.modal-content');
                    if (content) content.style.display = 'block';
                }
            } else {
                console.error(`‚ùå [ERRO] Modal com ID '${modalId}' n√£o foi encontrado no DOM!`);
            }
        };

        // --- LISTENER DOS BOT√ïES ---
        newContextToolbar.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation(); 

            const btn = e.target.closest('button');
            if (!btn) return;
            
            const action = btn.dataset.ctx;
            const ghost = window.activeGhost;

            console.group("üîò [CLIQUE DETETADO] Bot√£o da Barra de Contexto");
            console.log("A√ß√£o:", action);
            console.log("Bloco Fantasma Ativo:", ghost);

            if (!ghost) {
                console.warn("‚ö†Ô∏è Nenhum bloco fantasma selecionado na vari√°vel window.activeGhost");
                alert("Selecione um bloco primeiro.");
                console.groupEnd();
                return;
            }
            
            // "Engana" as fun√ß√µes antigas adicionando a classe necess√°ria ao bloco simples
            ghost.classList.add('mini-note-wrapper'); 
            
            // Garante atributos obrigat√≥rios para as fun√ß√µes n√£o falharem
            if (!ghost.hasAttribute('data-topics')) ghost.setAttribute('data-topics', '{}');
            if (!ghost.hasAttribute('data-shared')) ghost.setAttribute('data-shared', 'false');
            if (!ghost.hasAttribute('data-box-links')) ghost.setAttribute('data-box-links', '{}');

            // --- 1. LINKS (‚ö°) ---
            if (action === 'links') {
                console.log("‚ö° Iniciando processo de abertura de Links...");
                
                if (typeof window.openBoxLinkManager === 'function') {
                    console.log("‚ñ∂Ô∏è Chamando window.openBoxLinkManager()...");
                    try {
                        window.openBoxLinkManager(ghost);
                        console.log("‚úÖ openBoxLinkManager executado com sucesso.");
                    } catch (err) {
                        console.error("‚ùå ERRO ao executar openBoxLinkManager:", err);
                    }

                    console.log("‚ñ∂Ô∏è Chamando forceModalToTop('link-modal')...");
                    forceModalToTop('link-modal'); // For√ßa imediata
                } else {
                    console.error("‚ùå ERRO CR√çTICO: A fun√ß√£o 'window.openBoxLinkManager' n√£o existe!");
                }
            }
            
            // --- 2. CLONAR (üß¨) ---
            else if (action === 'clone') {
                if (typeof window.openAppendModal === 'function') {
                    window.htmlToAppend = ghost.outerHTML;
                    window.openAppendModal();
                    forceModalToTop('append-to-note-modal');
                }
            }
            
            // --- 3. COR (üé®) ---
            else if (action === 'color') {
                if (typeof window.openHighlightPopup === 'function') {
                    window.activeWrapperForColor = ghost; 
                    window.openHighlightPopup(ghost);
                    forceModalToTop('highlight-modal');
                }
            }
            
            // --- 4. T√ìPICOS (üìã) ---
            else if (action === 'topics') {
                if (typeof window.openTopicsModalForMiniNote === 'function') {
                    window.openTopicsModalForMiniNote(ghost);
                    forceModalToTop('topics-modal');
                }
            }

            // --- 5. PARTILHA (üîê) ---
            else if (action === 'sharing') {
                // Configura o toggle antes de mostrar
                const isShared = ghost.getAttribute('data-shared') === 'true';
                const toggle = document.getElementById('mini-note-share-toggle');
                if(toggle) toggle.checked = isShared;
                
                window.activeWrapperForSharing = ghost;
                
                // Abre e for√ßa o topo
                const shareModal = document.getElementById('share-settings-popup');
                if (shareModal) {
                    // O popup de partilha √© posicionado, por isso usamos l√≥gica diferente
                    document.body.appendChild(shareModal);
                    const rect = btn.getBoundingClientRect();
                    shareModal.style.cssText = `
                        display: flex !important;
                        position: fixed !important;
                        top: ${rect.bottom + 10}px !important;
                        left: ${rect.left}px !important;
                        z-index: 2147483647 !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        background: var(--sidebar-color);
                        padding: 15px;
                        border: 1px solid var(--accent-color);
                        box-shadow: 0 10px 40px rgba(0,0,0,1);
                    `;
                }
            }
            
            // --- 6. SEM√ÇNTICA (‚òÑÔ∏é) ---
          else if (action === 'semantic-type') {
                const semPopup = document.getElementById('semantic-type-popup');
                
                if (semPopup) {
                    // 1. Move e Posiciona (Igual a antes)
                    document.body.appendChild(semPopup);
                    const rect = btn.getBoundingClientRect();
                    
          semPopup.style.cssText = `
                        display: flex !important;
                        flex-direction: column !important;
                        position: fixed !important;
                        top: ${rect.bottom + 10}px !important;
                        left: ${rect.left}px !important;
                        z-index: 2147483647 !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        
                        /* FUNDO S√ìLIDO OBRIGAT√ìRIO */
                        background-color: #252528 !important; 
                        
                        border: 1px solid var(--accent-color);
                        width: 150px;
                        padding: 5px;
                        border-radius: 6px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.9) !important;
                    `;

                    // 2. DETETAR O TIPO ATUAL
                    // Se n√£o tiver atributo, assume 'p' (Par√°grafo Normal)
                    const currentType = ghost.getAttribute('data-semantic') || 'p';

                    // 3. ATUALIZAR VISUAL DOS BOT√ïES
                    const buttons = semPopup.querySelectorAll('button');
                    buttons.forEach(b => {
                        // Remove a classe de todos primeiro
                        b.classList.remove('active');
                        
                        // Se o data-sem deste bot√£o for igual ao tipo atual, ativa-o
                        if (b.dataset.sem === currentType) {
                            b.classList.add('active');
                        }
                    });
                }
            }
            
            // --- 7. APAGAR (üóëÔ∏è) ---
  else if (action === 'delete') {
                
                // 1. GARANTIA DE ID (Crucial para o erro do Firebase)
                if (!ghost.id) ghost.id = 'ghost_' + Date.now();

                // 2. Inicia a chamada
                const confirmationPromise = showConfirmation(
                    "Mover para o Buraco Negro?", 
                    "Este bloco ser√° removido. Pode recuper√°-lo no Hist√≥rico."
                );

                const confirmModal = document.getElementById('confirm-modal');
                if (confirmModal) confirmModal.style.setProperty('z-index', '2147483647', 'important');

                const confirmed = await confirmationPromise;

                if (confirmed) {
                    // 3. PREPARAR PARA ARQUIVO (Sem transformar em Subnota)
                    // Adicionamos classe tempor√°ria s√≥ para a fun√ß√£o de arquivo saber o que fazer,
                    // mas definimos o tipo manualmente abaixo.
                    
                    // --- CORRE√á√ÉO: Fun√ß√£o de Arquivo Adaptada ---
                    // Como a fun√ß√£o archiveMiniNote √© gen√©rica, vamos injetar o tipo 'ghost'
                    // manipulando o elemento antes de enviar.
                    ghost.setAttribute('data-archive-type', 'ghost'); 
                    
                    if (typeof window.archiveMiniNote === 'function') {
                        // Passamos 'true' para saltar confirma√ß√£o interna (j√° fizemos aqui)
                        await window.archiveMiniNote(ghost, true);
                    }

                    // 4. Remover visualmente e limpar
                    ghost.remove();
                    const tools = document.getElementById('aq-context-tools');
                    if (tools) tools.style.setProperty('display', 'none', 'important');
                    window.activeGhost = null;

                    if (typeof window.saveAquariumState === 'function') {
                        await window.saveAquariumState();
                    }
                }
                
                if (confirmModal) confirmModal.style.zIndex = ''; 
            }


             // --- 9. LINK DE TEXTO (üîó) ---
            else if (action === 'text-link') {
                // 1. Verifica se h√° sele√ß√£o ou se estamos num link
                const selection = window.getSelection();
                let anchorNode = selection.anchorNode;
                // Garante que pegamos o elemento HTML
                if (anchorNode && anchorNode.nodeType === 3) anchorNode = anchorNode.parentNode;
                
                const existingLink = anchorNode.closest('a.silent-link');

                if (existingLink) {
                    // MODO EDI√á√ÉO: J√° estamos num link
                    window.manageAquariumTextLink(existingLink);
                } else if (!selection.isCollapsed && selection.toString().trim().length > 0) {
                    // MODO CRIA√á√ÉO: Temos texto selecionado
                    window.manageAquariumTextLink(null);
                } else {
                    alert("Selecione o texto que quer transformar em link.");
                }
            }
            

            console.groupEnd(); // Fecha o grupo de logs
        });
    } else {
        console.error("‚ùå ERRO FATAL: Barra #aq-context-tools n√£o encontrada no HTML.");
    }
}, 500);
        
     

// --- POPUP SEM√ÇNTICO (COM SEGURAN√áA) ---
const semPopup = document.getElementById('semantic-type-popup');
if (semPopup) {
    const newSemPopup = semPopup.cloneNode(true);
    semPopup.parentNode.replaceChild(newSemPopup, semPopup);

    newSemPopup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !window.activeGhost) return;

        const type = btn.dataset.sem;
        
        // Aplica o tipo √† caixa ativa
        if (type === 'p') {
            // Par√°grafo √© o padr√£o (sem atributo)
            window.activeGhost.removeAttribute('data-semantic');
        } else {
            window.activeGhost.setAttribute('data-semantic', type);
        }

        console.log(`‚òÑÔ∏é Bloco definido como: ${type}`);
        
        // Esconde o popup
        newSemPopup.style.setProperty('display', 'none', 'important');
        
        // Grava o estado
        if (typeof saveAquariumState === 'function') saveAquariumState();
        
        // Refoca na caixa para o utilizador continuar a escrever
        window.activeGhost.focus();
    });
}

// Fecho de popups globais
document.addEventListener('click', (e) => {
    // 1. Popup Sem√¢ntico (‚òÑÔ∏é)
    const semPop = document.getElementById('semantic-type-popup');
    const semBtn = e.target.closest('button[data-ctx="semantic-type"]');
    
    // Se o popup estiver vis√≠vel E o clique N√ÉO for dentro dele E N√ÉO for no bot√£o que o abre
    if (semPop && semPop.style.display !== 'none' && !semPop.contains(e.target) && !semBtn) {
        semPop.style.setProperty('display', 'none', 'important');
    }
    
    // 2. Popup Salto (íÜú)
    const jumpPop = document.getElementById('aquarium-jump-popup');
    const jumpBtn = document.getElementById('aquarium-jump-btn');
    if (jumpPop && jumpPop.style.display !== 'none' && !jumpPop.contains(e.target) && e.target !== jumpBtn) {
        jumpPop.style.setProperty('display', 'none', 'important');
    }
    
    // 3. Popup de Partilha (üîê)
    const sharePop = document.getElementById('share-settings-popup');
    const shareBtn = e.target.closest('button[data-ctx="sharing"]');
    if (sharePop && sharePop.style.display !== 'none' && !sharePop.contains(e.target) && !shareBtn) {
        sharePop.style.setProperty('display', 'none', 'important');
    }
}, true); // Use 'true' (fase de captura) para garantir que apanha o clique antes de qualquer stopPropagation

// ============================================================
// CARREGAR LISTA DE AQU√ÅRIOS PARA SALTO R√ÅPIDO
// ============================================================
window.loadAquariumNotesList = async function(filterText = "") {
    const list = document.getElementById('aquarium-jump-list');
    if (!list) return;

    list.innerHTML = '<li style="padding:10px; color:#888;">A carregar aqu√°rios...</li>';

    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'aquario'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum outro aqu√°rio encontrado.</li>';
            return;
        }

        let count = 0;
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            // GARANTIA DE NOME: Se n√£o tiver nome, usa "Sem T√≠tulo"
            const nomeSeguro = data.nome || "Aqu√°rio Sem T√≠tulo"; 
            
            const item = { 
                id: docSnap.id, 
                nome: nomeSeguro, // For√ßa o uso do nome validado
                ...data 
            };
            
            if (item.id === selectedNoteId) return;

            if (filterText && !nomeSeguro.toLowerCase().includes(filterText.toLowerCase())) return;

            const li = document.createElement('li');
            li.style.cssText = "padding:10px; border-bottom:1px solid var(--border-color); cursor:pointer; display:flex; align-items:center; gap:8px;";
            li.innerHTML = `<span style="font-size:1.2em;">ü™∏</span> <span>${nomeSeguro}</span>`;
            
           li.onclick = async () => {
                // 1. Feedback visual
            li.style.backgroundColor = "var(--accent-color)";
    li.style.color = "white";
    li.textContent = "A trocar...";

    // 2. Grava o estado atual antes de sair (IMPORTANTE)
    if (typeof saveAquariumState === 'function') {
        await saveAquariumState();
    }

    // 3. Fecha o popup
    document.getElementById('aquarium-jump-popup').style.display = 'none';

    // 4. O reset ser√° chamado automaticamente dentro do openAquariumEnvironment
    await window.openAquariumEnvironment(item.id, item);
};

            list.appendChild(li);
            count++;
        });

        if (count === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum resultado.</li>';
        }

    } catch (e) {
        console.error("Erro ao carregar aqu√°rios:", e);
        list.innerHTML = '<li style="padding:10px; color:red;">Erro de liga√ß√£o.</li>';
    }
};

// ============================================================
// L√ìGICA DA SIDEBAR MEDUSA (ü™º)
// ============================================================

// 1. Toggle Sidebar (Abrir/Fechar)
const aqSidebarBtn = document.getElementById('aquarium-sidebar-toggle');
if (aqSidebarBtn) {
    const newBtn = aqSidebarBtn.cloneNode(true);
    aqSidebarBtn.parentNode.replaceChild(newBtn, aqSidebarBtn);

    newBtn.addEventListener('click', () => {
        const env = document.getElementById('aquarium-environment');
        
        // Alterna o estado do painel
        env.classList.toggle('sidebar-open');
        newBtn.classList.toggle('active');

        // --- NOVO: Adiciona a classe para empurrar o texto ---
        env.classList.toggle('left-open'); 
        // ---------------------------------------------------
        
        if (env.classList.contains('sidebar-open')) {
            const activeTab = document.querySelector('.aq-tab.active');
            if (activeTab) loadAquariumTab(activeTab.dataset.tab);
        } else {
            // Limpezas de fecho...
            window.activeStoreGhostId = null;
            document.querySelectorAll('.ghost-block.active-store-target').forEach(g => {
                g.classList.remove('active-store-target');
                g.style.cssText = "";
            });
        }
    });
}

// 2. Gest√£o de Abas
document.querySelector('.aq-tabs-header').addEventListener('click', (e) => {
    const btn = e.target.closest('.aq-tab');
    if (!btn) return;

    // UI Update
    document.querySelectorAll('.aq-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.aq-view').forEach(v => v.style.display = 'none');
    
    // Mostra conte√∫do e carrega
    const tabId = btn.dataset.tab;
    const view = document.getElementById(getAqViewId(tabId));
    if (view) {
        view.style.display = 'block';
        loadAquariumTab(tabId);
    }
});

function getAqViewId(tab) {
    const map = {
        'listas': 'aq-list-view',
        'indice': 'aq-index-view',
        'textos': 'aq-texts-view',
        'navega': 'aq-nav-view',
        'links': 'aq-links-view',
        'armazem': 'aq-store-view'
    };
    return map[tab];
}

// 3. Router de Carregamento
function loadAquariumTab(tab) {
    const canvas = document.getElementById('aquarium-content-canvas');
    
    // 1. Esconde rigorosamente todas as visualiza√ß√µes antes de mostrar a nova
    document.querySelectorAll('.aq-view').forEach(v => {
        v.style.display = 'none';
    });

    // 2. Localiza a vista alvo
    const viewId = getAqViewId(tab);
    const view = document.getElementById(viewId);
    
    if (view) {
        // O Armaz√©m precisa de flex-direction para o cabe√ßalho n√£o bugar
        if (tab === 'armazem') {
            view.style.display = 'flex';
            window.renderAquariumStore();
        } else {
            view.style.display = 'block';
            
            // Chama o renderizador correspondente
            if (tab === 'listas') renderAquariumLists();
            else if (tab === 'indice') renderAquariumIndex(canvas);
            else if (tab === 'textos') renderAquariumTexts();
            else if (tab === 'navega') renderAquariumNav(canvas);
            else if (tab === 'links') renderAquariumLinks(canvas);
        }
    }
}

// Ponto de entrada (Chamado quando clica na aba)
function renderAquariumLists() {
    // Se a stack estiver vazia, carrega a raiz
    if (aqListStack.length === 0) {
        renderAqListRoot();
    } else {
        // Se j√° tiver navega√ß√£o, re-renderiza o √∫ltimo n√≠vel (√∫til ao reabrir a sidebar)
        const current = aqListStack[aqListStack.length - 1];
        if (current.type === 'category') renderAqSubList(current.id, current.name);
        else if (current.type === 'bible-book') renderAqBibleChapters(current.data);
        else if (current.type === 'bible-chapter') renderAqBibleVerses(current.data);
    }
}

// N√çVEL 1: RA√çZ (Categorias)
function renderAqListRoot() {
    const list = document.getElementById('aq-list-view');
    if (!list) return;

    list.innerHTML = '';
    aqListStack = []; // Reset stack

    const categories = [
        { id: 'topico', icon: 'üìë', name: 'T√≥picos' },
        { id: 'destaque', icon: 'üé®', name: 'Destaques' },
        { separator: true },
        { id: 'biblia-root', icon: 'üìñ', name: 'B√≠blia' },
        { id: 'textobiblico', icon: 'üìú', name: 'Textos B√≠blicos' },
        { id: 'marcadores', icon: 'üîñ', name: 'Marcadores' },
        { separator: true },
        { id: 'personagem', icon: 'üë§', name: 'Personagens' },
        { id: 'local', icon: 'üìç', name: 'Locais' },
        { id: 'data', icon: 'üìÖ', name: 'Datas' },
        { id: 'cosmos', icon: 'ü™ê', name: 'Cosmos' },
        { id: 'tag', icon: 'üè∑Ô∏è', name: 'Tags' }
    ];

    categories.forEach(cat => {
        if (cat.separator) {
            const hr = document.createElement('hr');
            hr.style.cssText = "border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;";
            list.appendChild(hr);
        } else {
            const li = document.createElement('li');
            li.innerHTML = `${cat.icon} ${cat.name}`;
            
            // Atribui√ß√£o direta do evento de clique (Mais seguro)
            li.onclick = (e) => {
                e.stopPropagation(); // Evita conflitos
                console.log(`üß≠ Navegando para: ${cat.name}`);
                
                if (cat.id === 'biblia-root') {
                    if (typeof renderAqBibleBooks === 'function') renderAqBibleBooks();
                    else console.error("Fun√ß√£o renderAqBibleBooks n√£o encontrada!");
                } 
                else if (cat.id === 'destaque') {
                     // Destaques n√£o t√™m sublista, abrem modal de cores ou lista direta de cores?
                     // Assumindo lista de cores:
                     renderAqColorList(); // Vamos criar esta pequena fun√ß√£o abaixo
                }
                else {
                    if (typeof renderAqSubList === 'function') renderAqSubList(cat.id, cat.name);
                    else console.error("Fun√ß√£o renderAqSubList n√£o encontrada!");
                }
            };
            list.appendChild(li);
        }
    });
}

// N√çVEL 2: DESTAQUES (Lista de Cores)
function renderAqColorList() {
    const list = document.getElementById('aq-list-view');
    aqListStack.push({ type: 'category', id: 'destaque', name: 'Destaques' });

    list.innerHTML = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">Destaques (Cores)</span>
        </div>
        <ul id="aq-colors-content"></ul>
    `;
    
    const ul = document.getElementById('aq-colors-content');
    
    // Usa a constante global DEFAULT_HIGHLIGHTS que j√° existe no seu c√≥digo
    if (typeof DEFAULT_HIGHLIGHTS !== 'undefined') {
        DEFAULT_HIGHLIGHTS.forEach(color => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span style="display:inline-block; width:12px; height:12px; background:${color.code}; border-radius:50%; margin-right:8px; border:1px solid #555;"></span>
                ${color.name}
            `;
            li.onclick = () => {
                showHighlightReferencesPanel(color.code, color.name);
            };
            ul.appendChild(li);
        });
    } else {
        ul.innerHTML = '<li style="color:red">Erro: Cores n√£o definidas.</li>';
    }
}

// N√çVEL 2: SUBLISTA (Entidades: T√≥picos, Personagens, etc.)
async function renderAqSubList(type, name) {
    const list = document.getElementById('aq-list-view');
    
    // Atualiza Stack
    if (aqListStack.length === 0 || aqListStack[aqListStack.length - 1].id !== type) {
        aqListStack.push({ type: 'category', id: type, name: name });
    }

    // Header com Voltar
    list.innerHTML = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${name}</span>
        </div>
        <div id="aq-sublist-content"><div class="spinner-container"><div class="spinner"></div></div></div>
    `;

    const contentDiv = document.getElementById('aq-sublist-content');
    const myUid = auth.currentUser.uid;
    let items = [];

    try {
        // --- CASO ESPECIAL: T√ìPICOS (T√™m Subt√≥picos) ---
        if (type === 'topico') {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'topicos'), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, hasChildren: true });
            });
        }
        
        // --- CASO ESPECIAL: COSMOS (T√™m Subtemas) ---
        else if (type === 'cosmos') {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'cosmos'), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, hasChildren: true, emoji: d.emoji });
            });
        }

        // --- CASO ESPECIAL: TAGS (Extra√≠das das Notas) ---
        else if (type === 'tag') {
            const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'pastas'), where('tipo', '==', 'nota'), where('userId', '==', myUid));
            const snap = await getDocs(q);
            const tagSet = new Set();
            snap.forEach(doc => { if(doc.data().tags) doc.data().tags.forEach(t => tagSet.add(t)); });
            items = Array.from(tagSet).sort().map(t => ({ id: t, nome: t, isFinal: true }));
        } 
        
        // --- OUTROS (Personagens, Locais, Datas, Marcadores) ---
        // Estes s√£o finais, abrem logo a 4¬™ coluna
        else {
            const collectionName = getCollectionFromType(type);
            if (!collectionName) { contentDiv.innerHTML = '<p style="padding:10px;">Erro de tipo.</p>'; return; }
            
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, collectionName), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, isFinal: true });
            });
        }

        // RENDERIZA√á√ÉO
        contentDiv.innerHTML = '';
        if (items.length === 0) {
            contentDiv.innerHTML = '<p style="padding:20px; color:#888; text-align:center;">Vazio.</p>';
            return;
        }

        const ul = document.createElement('ul');
        items.forEach(item => {
            const li = document.createElement('li');
            const icon = item.emoji || (item.hasChildren ? "üìÇ" : "üîπ");
            li.textContent = `${icon} ${item.nome}`;
            
            li.onclick = () => {
                // SE TIVER FILHOS (T√≥picos/Cosmos), NAVEGA PARA DENTRO (N√≠vel 3)
                if (item.hasChildren) {
                    renderAqDeepLevel(type, item.id, item.nome);
                } 
                // SE FOR FINAL (Tags/Personagens), ABRE A 4¬™ COLUNA
                else {
                    showReferencesPanel(item.id, item.nome, type);
                }
            };
            ul.appendChild(li);
        });
        contentDiv.appendChild(ul);

    } catch (e) {
        console.error(e);
        contentDiv.innerHTML = '<p style="padding:10px; color:red;">Erro ao carregar.</p>';
    }
}

// N√çVEL 3: PROFUNDIDADE (Subt√≥picos e Sub-Cosmos)
async function renderAqDeepLevel(parentType, parentId, parentName) {
    const list = document.getElementById('aq-list-view');
    
    // Atualiza Stack
    aqListStack.push({ type: 'deep', id: parentId, name: parentName, parentType: parentType });

    list.innerHTML = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${parentName}</span>
        </div>
        <div id="aq-deep-content"><div class="spinner-container"><div class="spinner"></div></div></div>
    `;

    const contentDiv = document.getElementById('aq-deep-content');
    const myUid = auth.currentUser.uid;
    let items = [];

    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let targetCollection = '';
        let foreignKey = '';
        let finalType = ''; // O tipo que ser√° enviado para a 4¬™ coluna

        if (parentType === 'topico') {
            targetCollection = 'subtopicos';
            foreignKey = 'topicId';
            finalType = 'subtopico'; // Usa este tipo para a 4¬™ coluna saber o que procurar
        } else if (parentType === 'cosmos') {
            targetCollection = 'subcosmos';
            foreignKey = 'cosmosId';
            finalType = 'subcosmos';
        }

        const q = query(collection(db, targetCollection), where(foreignKey, '==', parentId), where('userId', '==', myUid), orderBy('nome'));
        const snap = await getDocs(q);

        snap.forEach(doc => {
            const d = doc.data();
            if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, emoji: d.emoji });
        });

        // RENDERIZA√á√ÉO
        contentDiv.innerHTML = '';
        if (items.length === 0) {
            contentDiv.innerHTML = '<p style="padding:20px; color:#888; text-align:center;">Vazio.</p>';
            return;
        }

        const ul = document.createElement('ul');
        items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.emoji || 'üîπ'} ${item.nome}`;
            
            li.onclick = () => {
                // AGORA SIM, ABRE A 4¬™ COLUNA
                // Passamos o ID do subt√≥pico/subtema e o tipo correto
                showReferencesPanel(item.id, item.nome, finalType);
            };
            ul.appendChild(li);
        });
        contentDiv.appendChild(ul);

    } catch (e) {
        console.error(e);
        contentDiv.innerHTML = '<p style="padding:10px; color:red;">Erro ao carregar.</p>';
    }
}

// B√çBLIA: NIVEL 2 - LIVROS
function renderAqBibleBooks() {
    const list = document.getElementById('aq-list-view');
    aqListStack.push({ type: 'bible-root', name: 'B√≠blia' });

    let html = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">Livros da B√≠blia</span>
        </div>
        <ul>`;

    BIBLE_DATA.forEach(book => {
        // Criamos um elemento tempor√°rio para ligar o onclick via JS (evita strings complexas)
        // Mas para simplificar a string HTML:
        html += `<li onclick="renderAqBibleChapters('${book.nome}', ${book.caps})">${book.nome}</li>`;
    });
    
    html += `</ul>`;
    list.innerHTML = html;
}

// B√çBLIA: NIVEL 3 - CAP√çTULOS
window.renderAqBibleChapters = function(bookName, totalCaps) {
    const list = document.getElementById('aq-list-view');
    aqListStack.push({ type: 'bible-book', name: bookName, data: {name: bookName, caps: totalCaps} });

    let html = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${bookName}</span>
        </div>
        <div class="aq-grid-container">`;

    for (let i = 1; i <= totalCaps; i++) {
        html += `<div class="aq-grid-btn" onclick="renderAqBibleVerses('${bookName}', ${i})">${i}</div>`;
    }

    html += `</div>`;
    list.innerHTML = html;
};

// B√çBLIA: NIVEL 4 - VERS√çCULOS
window.renderAqBibleVerses = function(bookName, chapter) {
    const list = document.getElementById('aq-list-view');
    
    // Obter total de versiculos
    const bookData = BIBLE_DATA.find(b => b.nome === bookName);
    const totalV = bookData ? (bookData.versiculos[chapter - 1] || 50) : 50;

    aqListStack.push({ type: 'bible-chapter', name: `${bookName} ${chapter}`, data: {book: bookName, cap: chapter} });

    let html = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${bookName} ${chapter}</span>
        </div>
        <div class="aq-grid-container"></div>`; // Container vazio para encher via JS

    list.innerHTML = html;
    const grid = list.querySelector('.aq-grid-container');

    for (let i = 1; i <= totalV; i++) {
        const fullName = `${bookName} ${chapter}:${i}`;
        
        const btn = document.createElement('div');
        btn.className = 'aq-grid-btn';
        btn.textContent = i;
        
        // --- AQUI EST√Å A LIGA√á√ÉO CR√çTICA ---
        btn.onclick = () => {
            console.log(`üìñ Abrindo vers√≠culo: ${fullName}`);
            
            // Chama a fun√ß√£o global que abre a 4¬™ Coluna
            if (typeof showReferencesPanel === 'function') {
                // Passamos null no ID porque vers√≠culos usam o nome como chave
                showReferencesPanel(null, fullName, 'textobiblico');
            } else {
                console.error("Fun√ß√£o showReferencesPanel n√£o encontrada!");
            }
        };

        grid.appendChild(btn);
    }
};

// FUN√á√ÉO DE VOLTAR
window.aqNavBack = function() {
    if (aqListStack.length > 0) {
        aqListStack.pop(); // Remove o n√≠vel atual
        
        if (aqListStack.length === 0) {
            renderAqListRoot();
        } else {
            // Renderiza o n√≠vel anterior
            const prev = aqListStack[aqListStack.length - 1];
            
            // Removemos temporariamente o item atual para o render n√£o o duplicar na stack
            aqListStack.pop(); 
            
            if (prev.type === 'category') renderAqSubList(prev.id, prev.name);
            else if (prev.type === 'deep') renderAqDeepLevel(prev.parentType, prev.id, prev.name);
            else if (prev.type === 'bible-root') renderAqBibleBooks();
            else if (prev.type === 'bible-book') renderAqBibleChapters(prev.data.name, prev.data.caps);
        }
    } else {
        renderAqListRoot();
    }
};

// --- ABA: √çNDICE (Cards dos Blocos Fantasma) ---
function renderAquariumIndex(canvas) {
    const container = document.getElementById('aq-index-view');
    container.innerHTML = '';
    
    const blocks = canvas.querySelectorAll('.ghost-block');
    let count = 0;

    blocks.forEach((block, index) => {
        // --- CORRE√á√ÉO: Limpeza dos Bot√µes ---
        // 1. Clona o bloco para n√£o afetar o original no ecr√£
        const clone = block.cloneNode(true);
        
        // 2. Remove a div dos bot√µes de a√ß√£o (onde est√£o o üêö e o ‚á±)
        const actionsDiv = clone.querySelector('.ghost-actions');
        if (actionsDiv) actionsDiv.remove();

        // 3. Remove o bot√£o de adicionar entre linhas (o + pequeno) se existir
        const addBtn = clone.querySelector('.ghost-add-between-btn');
        if (addBtn) addBtn.remove();

        // 4. L√™ o texto limpo
        const text = clone.innerText.trim();
        // -------------------------------------

        if (!text) return;

        // Tenta obter t√≠tulo: ou atributo sem√¢ntico ou primeira frase
        let title = "Bloco de Texto";
        let semantic = block.getAttribute('data-semantic');
        
        if (semantic) {
            title = semantic.toUpperCase();
        } else {
            // Pega a primeira frase at√© ponto ou quebra de linha
            const split = text.split(/[\.\n]/);
            title = split[0].substring(0, 30) + (split[0].length > 30 ? "..." : "");
        }

        const card = document.createElement('div');
        card.className = 'aq-index-card';
        card.innerHTML = `
            <span class="aq-card-title">${count + 1}. ${title}</span>
            <div class="aq-card-preview">${text.substring(0, 80)}...</div>
        `;

        card.onclick = () => {
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight tempor√°rio
            block.style.transition = "background 0.5s";
            block.style.background = "rgba(74, 144, 226, 0.2)";
            setTimeout(() => block.style.background = "transparent", 1000);
        };

        container.appendChild(card);
        count++;
    });

    if (count === 0) container.innerHTML = '<p style="padding:20px; color:#888; text-align:center;">Aqu√°rio vazio.</p>';
}

// --- ABA: TEXTOS (Motor B√≠blico Adaptado) ---
async function renderAquariumTexts() {
    const container = document.getElementById('aq-texts-view');
    const canvas = document.getElementById('aquarium-content-canvas'); 
    
    if (!container || !canvas) return;

    // Spinner
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar textos...</span></div>';

    // 1. Extrair texto todo do Aqu√°rio
    // O innerText apanha o conte√∫do vis√≠vel e o conte√∫do dos blocos bloqueados (popups)
    let fullText = canvas.innerText;
    
    // Varre inputs de t√≠tulos dentro do Aqu√°rio para apanhar refer√™ncias l√° tamb√©m
    canvas.querySelectorAll('input, textarea').forEach(el => {
        if (el.value) fullText += " " + el.value;
    });
    
    // 2. Regex B√≠blica
    const sortedBooks = (typeof BIBLICAL_BOOKS !== 'undefined') ? [...BIBLICAL_BOOKS].sort((a, b) => b.length - a.length) : [];
    
    if(sortedBooks.length === 0) {
         container.innerHTML = '<p style="padding:20px; color:red;">Erro: Dados b√≠blicos n√£o carregados.</p>';
         return;
    }

    // Regex para "Livro Cap:Vers" (ex: Jo√£o 3:16, Jo√£o 3:16-18)
    const regex = new RegExp(`\\b((?:${sortedBooks.join('|')})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)`, 'gi');
    
    // Encontra e remove duplicados
    const matches = [...new Set(fullText.match(regex) || [])];

    container.innerHTML = '';
    
    if (matches.length === 0) {
        container.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; color:#888; text-align:center;">
                <span style="font-size:30px; margin-bottom:10px;">üìñ</span>
                <p>Nenhum texto detetado.</p>
                <small style="opacity:0.5;">Escreva ex: "Jo√£o 3:16"</small>
            </div>`;
        return;
    }

    // 3. Renderiza cada texto encontrado
    for (const ref of matches) {
        const div = document.createElement('div');
        div.style.cssText = "padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); text-align: left;";
        
        // T√≠tulo clic√°vel
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = "font-weight:bold; color:var(--accent-color); cursor:pointer; margin-bottom:6px; display:flex; justify-content:space-between;";
        titleDiv.innerHTML = `<span>üìú ${ref}</span> <span style="opacity:0.5; font-size:0.8em;">‚ûî</span>`;
        
        // A√ß√£o: Abrir na 4¬™ Coluna ao clicar
        titleDiv.onclick = () => {
            // Expande refer√™ncias complexas (ex: 1-3) para abrir o primeiro vers√≠culo
            const firstVerse = ref.split(/[-‚Äì,]/)[0].trim(); 
            if (typeof showReferencesPanel === 'function') {
                showReferencesPanel(null, firstVerse, 'textobiblico');
            }
        };

        const contentDiv = document.createElement('div');
        contentDiv.className = 'aq-verse-text';
        contentDiv.style.cssText = "font-size:0.9em; line-height:1.5; color:#ccc; opacity:0.8;";
        contentDiv.innerHTML = '<em>A carregar...</em>';

        div.appendChild(titleDiv);
        div.appendChild(contentDiv);
        container.appendChild(div);

        // 4. Buscar Texto (Async)
        if (typeof expandVerseReference === 'function' && typeof fetchPublicBibleText === 'function') {
            const expanded = expandVerseReference(ref);
            const promises = expanded.map(v => fetchPublicBibleText(v));
            
            // Carrega em paralelo
            Promise.all(promises).then(texts => {
                const finalText = texts.filter(t => t).join(" ");
                contentDiv.textContent = finalText || "Texto n√£o dispon√≠vel na biblioteca.";
            });
        } else {
            contentDiv.textContent = "Fun√ß√µes de biblioteca indispon√≠veis.";
        }
    }
}

// --- ABA: NAVEGA (Entidades / David) ---
function renderAquariumNav(canvas) {
    const container = document.getElementById('aq-nav-view');
    // Se o canvas n√£o for passado, tenta apanhar do DOM
    const targetCanvas = canvas || document.getElementById('aquarium-content-canvas');
    
    if (!container || !targetCanvas) return;

    // 1. Limpeza
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar entidades...</span></div>';

    // 2. PREPARA√á√ÉO DO TEXTO
    // Junta texto do corpo + inputs para garantir que apanha tudo
    let textContent = targetCanvas.innerText;
    targetCanvas.querySelectorAll('input, textarea').forEach(el => {
        if (el.value) textContent += " " + el.value;
    });
    const textContentLower = textContent.toLowerCase();

    // 3. Juntar todas as entidades conhecidas
    if (typeof allEntities === 'undefined') {
         container.innerHTML = '<p style="padding:20px; color:#888;">Cache de entidades vazio.</p>';
         return;
    }

    const allCandidates = Object.values(allEntities).flat();
    
    // Array para guardar resultados
    const foundItems = [];
    // Set para evitar duplicados (ex: se "David" aparecer 3 vezes, mostra s√≥ uma)
    const seenNames = new Set();

    // 4. LOOP DE VERIFICA√á√ÉO
    allCandidates.forEach(entity => {
        // Verifica se o nome da entidade est√° escrito no texto
        if (textContentLower.includes(entity.nome.toLowerCase())) {
            
            // Evita duplicados na lista visual
            if (!seenNames.has(entity.nome)) {
                foundItems.push(entity);
                seenNames.add(entity.nome);
            }
        }
    });

    container.innerHTML = '';

    if (foundItems.length === 0) {
        container.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; color:#888; text-align:center;">
                <span style="font-size:30px; margin-bottom:10px;">‚öì</span>
                <p>Nenhuma entidade encontrada.</p>
                <small style="opacity:0.5;">Escreva ex: "David", "Jerusal√©m"</small>
            </div>`;
        return;
    }

    // 5. RENDERIZAR ITENS ENCONTRADOS
    // Ordena alfabeticamente para ficar organizado
    foundItems.sort((a, b) => a.nome.localeCompare(b.nome));

    foundItems.forEach(entity => {
        const div = document.createElement('div');
        div.style.cssText = "padding:12px 15px; border-bottom:1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 4px; transition: background 0.2s;";
        
        // --- √çCONE ---
        let icon = entity.emoji || "üîπ"; 
        if (!entity.emoji) {
            if (entity.tipo === 'personagem') icon = "üë§";
            else if (entity.tipo === 'local') icon = "üìç";
            else if (entity.tipo === 'cosmos') icon = "ü™ê";
            else if (entity.tipo === 'subcosmos') icon = "üß¨";
        }

        // --- T√çTULO ---
        const titleHtml = `<strong style="color:var(--text-color); cursor:pointer; font-size:0.95em;">${icon} ${entity.nome}</strong>`;
        
        // --- DESCRI√á√ÉO ---
        const descText = entity.descricao || 'Sem descri√ß√£o (Clique para ver detalhes).';
        const descHtml = `<div style="font-size:0.85em; color:#888; cursor:pointer; line-height:1.4;">${descText}</div>`;

        div.innerHTML = titleHtml + descHtml;

        // --- INTERA√á√ïES ---
        div.onmouseover = () => { div.style.backgroundColor = "rgba(255,255,255,0.05)"; };
        div.onmouseout = () => { div.style.backgroundColor = "transparent"; };

        // Clique no Card Inteiro: Abre a 4¬™ Coluna (Refer√™ncias)
        div.onclick = (e) => {
            e.stopPropagation();
            if (typeof showReferencesPanel === 'function') {
                showReferencesPanel(entity.id, entity.nome, entity.tipo);
            }
        };

        container.appendChild(div);
    });
}



// --- ABA: LINKS (Fontes das caixas) ---
window.currentLinkSubTab = 'boxes'; // 'boxes' (‚ö°) ou 'text' (üìé)

window.renderAquariumLinks = async function(canvas) {
    const list = document.getElementById('aq-links-view');
    // Se o canvas n√£o for passado, tenta apanhar
    const targetCanvas = canvas || document.getElementById('aquarium-content-canvas');
    
    if (!list) return;

    // 1. RENDERIZAR CABE√áALHO DAS SUB-ABAS
    list.innerHTML = `
        <div style="display:flex; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px; background:rgba(0,0,0,0.2);">
            <button onclick="window.switchLinkSubTab('boxes')" 
                    style="flex:1; padding:10px; background:none; border:none; border-bottom:2px solid ${window.currentLinkSubTab === 'boxes' ? 'var(--accent-color)' : 'transparent'}; color:${window.currentLinkSubTab === 'boxes' ? 'white' : '#888'}; cursor:pointer; font-size:1.2em;">
                ‚ö° Caixas
            </button>
            <button onclick="window.switchLinkSubTab('text')" 
                    style="flex:1; padding:10px; background:none; border:none; border-bottom:2px solid ${window.currentLinkSubTab === 'text' ? 'var(--accent-color)' : 'transparent'}; color:${window.currentLinkSubTab === 'text' ? 'white' : '#888'}; cursor:pointer; font-size:1.2em;">
                üìé Texto
            </button>
        </div>
        <div id="aq-links-content" style="padding:0 10px;">
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    `;

    const contentDiv = document.getElementById('aq-links-content');

    // ============================================================
    // ABA 1: CAIXAS (‚ö°) - L√≥gica Original
    // ============================================================
    if (window.currentLinkSubTab === 'boxes') {
        contentDiv.innerHTML = '';
        let hasSources = false;
        
        if (targetCanvas) {
            const boxes = targetCanvas.querySelectorAll('[data-box-links]');
            boxes.forEach(el => {
                const jsonStr = el.getAttribute('data-box-links');
                if (!jsonStr || jsonStr === '{}') return;

                try {
                    const data = JSON.parse(jsonStr);
                    const hasUrls = data.urls && Object.keys(data.urls).length > 0;
                    const hasCodex = data.codex && data.codex.length > 0;
                    const hasCategories = data.categories && data.categories.length > 0;

                    if (!hasUrls && !hasCodex && !hasCategories) return;
                    hasSources = true;

                    // Determina T√≠tulo
                    let boxTitle = data.title;
                    if (!boxTitle) {
                        const input = el.querySelector('.mini-note-title-input, .redator-input, .card-title-input, .sign-title-input');
                        if (input) boxTitle = input.value;
                        else boxTitle = "Caixa Sem T√≠tulo";
                    }

                    // Renderiza Grupo
                    let itemsHTML = '';
                    
                    if (hasUrls) {
                        Object.values(data.urls).forEach(url => {
                            let linkName = url;
                            try { linkName = new URL(url).hostname.replace('www.',''); } catch(e){}
                            itemsHTML += `<div onclick="window.open('${url}', '_blank')" style="cursor:pointer; color:var(--text-color); font-size:0.9em; padding:4px 0; display:flex; gap:6px;"><span>üîó</span> <span style="text-decoration:underline; color:var(--accent-color);">${linkName}</span></div>`;
                        });
                    }
                    if (hasCodex) {
                        data.codex.forEach(c => {
                             // --- AQUI APLICA A TUA CORRE√á√ÉO "de" SE AINDA N√ÉO ESTIVER FEITA ---
                             // (Assume-se que o codiceshow j√° vem correto da grava√ß√£o)
                             itemsHTML += `<div style="font-size:0.9em; padding:4px 0; color:#e67e22;"><span>üìö</span> ${c.codiceshow || c.serie}</div>`;
                        });
                    }
                    if (hasCategories) {
                        data.categories.forEach(c => {
                             itemsHTML += `<div style="font-size:0.9em; padding:4px 0; color:var(--text-color);"><span>üîπ</span> ${c.name}</div>`;
                        });
                    }

                    const li = document.createElement('div');
                    li.style.cssText = "margin-bottom:15px; border:1px solid rgba(255,255,255,0.05); border-radius:6px; overflow:hidden;";
                    li.innerHTML = `
                        <div style="padding:8px 10px; background:rgba(255,255,255,0.05); font-weight:bold; color:#ccc; font-size:0.9em; cursor:pointer;"
                             onclick="document.getElementById('${el.id}').scrollIntoView({behavior:'smooth', block:'center'});">
                            ${boxTitle}
                        </div>
                        <div style="padding:10px;">${itemsHTML}</div>
                    `;
                    contentDiv.appendChild(li);

                } catch (e) {}
            });
        }

        if (!hasSources) contentDiv.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Sem links em caixas.</p>';
    }

    // ============================================================
    // ABA 2: LINKS DE TEXTO (üìé) - Com Persist√™ncia
    // ============================================================
// ============================================================
    // ABA 2: LINKS DE TEXTO (üìé) - ORDENADOS POR POSI√á√ÉO NO TEXTO
    // ============================================================
    else if (window.currentLinkSubTab === 'text') {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        try {
            // 1. Ler Registo do Firebase
            const docRef = doc(db, 'pastas', selectedNoteId);
            const docSnap = await getDoc(docRef);
            const registry = docSnap.exists() ? (docSnap.data().textLinksRegistry || {}) : {};

            contentDiv.innerHTML = '';
            
            // Converter objeto em array
            let linkItems = Object.keys(registry).map(uid => ({ 
                uid, 
                ...registry[uid] 
            }));

            if (linkItems.length === 0) {
                contentDiv.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Sem links de texto.</p>';
                return;
            }

            // 2. ORDENAR PELA POSI√á√ÉO NO TEXTO (A M√ÅGICA EST√Å AQUI)
            // Para cada link, tentamos encontrar o elemento correspondente no DOM.
            // Se encontrar, calculamos a sua posi√ß√£o relativa.
            
            // Cria um mapa de posi√ß√µes
            const positions = new Map();
            
            if (targetCanvas) {
                // Encontra todos os links no texto DE UMA S√ì VEZ e na ordem correta
                const linksInDom = Array.from(targetCanvas.querySelectorAll('a.silent-link'));
                
                linksInDom.forEach((el, index) => {
                    const uid = el.dataset.uid;
                    if (uid) {
                        // O √≠ndice no array do querySelectorAll reflete a ordem no documento
                        positions.set(uid, index);
                    }
                });
            }

            linkItems.sort((a, b) => {
                const posA = positions.has(a.uid) ? positions.get(a.uid) : 999999; // √ìrf√£os v√£o para o fim
                const posB = positions.has(b.uid) ? positions.get(b.uid) : 999999;
                
                // Se ambos existem no texto, ordena pela posi√ß√£o
                if (posA !== posB) return posA - posB;
                
                // Se ambos s√£o √≥rf√£os (ou t√™m a mesma posi√ß√£o por erro), ordena por data (mais recente primeiro)
                return (b.timestamp || 0) - (a.timestamp || 0);
            });


            // 3. RENDERIZAR LISTA (Mant√©m-se igual)
            linkItems.forEach(data => {
                // Verificar se ainda existe no DOM (para pintar de vermelho)
                const isOrphan = !positions.has(data.uid);

                const card = document.createElement('div');
                card.style.cssText = `
                    margin-bottom: 15px; 
                    border-left: 3px solid ${isOrphan ? '#e74c3c' : 'var(--accent-color)'}; 
                    background: rgba(255,255,255,0.02);
                    padding: 10px;
                    border-radius: 0 6px 6px 0;
                `;

                // T√≠tulo + Bot√£o Editar
                const headerHtml = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong style="color:${isOrphan ? '#e74c3c' : 'var(--text-color)'}; font-size:1em;">
                            ${isOrphan ? '‚ö†Ô∏è ' : ''}${data.title}
                        </strong>
                        <button onclick='window.manageAquariumTextLink(null, ${JSON.stringify(data).replace(/'/g, "&apos;")})' 
                                title="Editar Lista de Links"
                                style="background:none; border:1px solid var(--border-color); color:var(--text-muted-color); border-radius:4px; cursor:pointer; padding:2px 6px;">
                            ‚úèÔ∏è
                        </button>
                    </div>
                `;

                // Lista Numerada de Links
                let linksHtml = '';
                if (data.urls && data.urls.length > 0) {
                    data.urls.forEach((url, idx) => {
                        let displayUrl = url;
                        try { displayUrl = new URL(url).hostname; } catch(e){}
                        
                        linksHtml += `
                            <div style="display:flex; gap:8px; margin-top:4px; font-size:0.9em;">
                                <span style="color:var(--text-muted-color); font-weight:bold;">${idx + 1}.</span>
                                <a href="${url}" target="_blank" style="color:var(--accent-color); text-decoration:none; word-break:break-all;">
                                    ${displayUrl}
                                </a>
                            </div>
                        `;
                    });
                } else {
                    linksHtml = '<small style="color:#666;">Sem URLs</small>';
                }

                card.innerHTML = headerHtml + linksHtml;
                
                // --- NOVO: Clique no t√≠tulo faz scroll para o texto ---
                if (!isOrphan) {
                    const titleEl = card.querySelector('strong');
                    titleEl.style.cursor = 'pointer';
                    titleEl.onclick = () => {
                        const targetEl = targetCanvas.querySelector(`a[data-uid="${data.uid}"]`);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Flash visual
                            targetEl.style.backgroundColor = "rgba(241, 196, 15, 0.5)";
                            setTimeout(() => targetEl.style.backgroundColor = "", 1000);
                        }
                    };
                }
                
                contentDiv.appendChild(card);
            });

        } catch (e) {
            console.error("Erro ao carregar links de texto:", e);
            contentDiv.innerHTML = '<p style="color:red;">Erro ao ler base de dados.</p>';
        }
    }
};

// Helper para trocar aba
window.switchLinkSubTab = function(tab) {
    window.currentLinkSubTab = tab;
    // O render chama a fun√ß√£o principal que j√° decide o que mostrar
    window.renderAquariumLinks(); 
};



if (aqCanvasListener) {
    aqCanvasListener.addEventListener('input', () => {
        
        // 1. Verifica qual a aba ativa
        const activeTabBtn = document.querySelector('.aq-tab.active');
        const tabType = activeTabBtn ? activeTabBtn.dataset.tab : null;
        
        // 2. Verifica se a sidebar est√° aberta
        const sidebar = document.getElementById('aquarium-sidebar');
        const isSidebarOpen = sidebar && sidebar.offsetWidth > 0;

        // Adicionado: verifica√ß√£o para 'links'
        if (isSidebarOpen && (tabType === 'textos' || tabType === 'navega' || tabType === 'links')) {
            
            clearTimeout(aqLiveTimer);
            
            aqLiveTimer = setTimeout(() => {
                const canvas = document.getElementById('aquarium-content-canvas');
                
                if (tabType === 'textos') {
                    console.log("üìú [LIVE] Atualizando textos b√≠blicos...");
                    renderAquariumTexts(); // J√° usa o canvas internamente
                } 
                else if (tabType === 'navega') {
                    console.log("‚öì [LIVE] Atualizando navega√ß√£o...");
                    renderAquariumNav(canvas);
                }
                else if (tabType === 'links') {
                    console.log("‚ö° [LIVE] Atualizando links e fontes...");
                    renderAquariumLinks(canvas);
                }
            }, 1000); 
        }
    });
}

function updateAquariumLinkButtonState(ghost) {
    // Seleciona o bot√£o ‚ö° na barra de ferramentas do Aqu√°rio
    const btn = document.querySelector('#aq-context-tools button[data-ctx="links"]');
    
    if (!btn || !ghost) return;

    const json = ghost.getAttribute('data-box-links');
    let hasLinks = false;

    if (json && json !== '{}') {
        try {
            const data = JSON.parse(json);
            if ((data.urls && Object.keys(data.urls).length > 0) ||
                (data.codex && data.codex.length > 0) ||
                (data.categories && data.categories.length > 0)) {
                hasLinks = true;
            }
        } catch (e) {}
    }

    if (hasLinks) {
        btn.classList.add('has-links-sparkle'); // Ativa a anima√ß√£o CSS
    } else {
        btn.classList.remove('has-links-sparkle');
    }
}

// 1. ABRIR POPUP
window.openGhostPopup = function(btn) {
    // --- SEGURAN√áA CONTRA ERROS ---
    if (!btn || typeof btn.closest !== 'function') {
        console.error("‚ùå ERRO CR√çTICO: 'btn' inv√°lido recebido em openGhostPopup:", btn);
        return; // Sai da fun√ß√£o sem quebrar o site
    }
    // -----------------------------

    console.log("üöÄ [POPUP] A processar abertura...");
    
    // 1. Encontra o bloco pai
    const ghost = btn.closest('.ghost-block');
    if (!ghost) return console.error("‚ùå Bloco fantasma n√£o encontrado.");

    // 2. Garante ID
    if (!ghost.id) ghost.id = 'ghost_' + Date.now();
    
    // 3. Verifica se J√Å est√° aberto (Foca nele)
    if (activeAquariumPopups.includes(ghost.id)) {
        const existing = document.getElementById(`popup_${ghost.id}`);
        if (existing) {
            // Traz para a frente e faz um efeito visual
            existing.style.zIndex = ++highestZIndex;
            existing.style.transform = "scale(1.05)";
            existing.style.boxShadow = "0 0 30px var(--accent-color)";
            setTimeout(() => {
                existing.style.transform = "scale(1)";
                existing.style.boxShadow = "0 20px 50px rgba(0, 0, 0, 0.9)";
            }, 200);
            return;
        }
    }

    // 4. VERIFICA√á√ÉO DO LIMITE DE 6
    if (activeAquariumPopups.length >= MAX_AQ_POPUPS) {
        alert(`‚ö†Ô∏è Limite de ${MAX_AQ_POPUPS} janelas atingido.\nPor favor, feche alguma janela antes de abrir outra.`);
        return;
    }

    // 5. BLOQUEAR O ORIGINAL
    ghost.classList.add('locked-popup'); // Aplica o CSS cinzento
    ghost.setAttribute('contenteditable', 'false'); // IMPEDE ESCREVER
    activeAquariumPopups.push(ghost.id);

    // 6. Criar a Janela
    const popupId = `popup_${ghost.id}`;
    const popup = document.createElement('div');
    popup.className = 'aq-popup-window';
    popup.id = popupId;
    
    // Cascata visual
    const offset = activeAquariumPopups.length * 30;
    popup.style.top = `${120 + offset}px`;
    popup.style.left = `${120 + offset}px`;
    popup.style.zIndex = ++highestZIndex;

    // Limpa o conte√∫do (remove os bot√µes para n√£o duplicar na janela)
    const cloneContent = ghost.innerHTML.replace(/<div class="ghost-actions".*?<\/div>/g, '');

    popup.innerHTML = `
        <div class="aq-popup-header">
            <span class="aq-popup-title">Janela ${activeAquariumPopups.length} / ${MAX_AQ_POPUPS}</span>
            <button class="aq-popup-close" onclick="window.closeGhostPopup('${ghost.id}')">‚úï</button>
        </div>
        <div class="aq-popup-content" contenteditable="true" spellcheck="false">
            ${cloneContent}
        </div>
    `;

    // 7. Inserir e Ativar
    document.body.appendChild(popup);
    
    // Ativa o arrasto da janela
    if (typeof makeElementDraggable === 'function') {
        // Pequeno hack para garantir que usamos o header certo
        const header = popup.querySelector('.aq-popup-header');
        // Reutiliza a l√≥gica de drag, adaptando o evento
        header.onmousedown = (e) => {
            popup.style.zIndex = ++highestZIndex; // Traz para frente ao clicar
            // Chama a l√≥gica de drag existente no seu c√≥digo (se tiver)
            // Se n√£o tiver, o c√≥digo abaixo trata disso:
            e.preventDefault();
            let pos3 = e.clientX;
            let pos4 = e.clientY;
            document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
            document.onmousemove = (ev) => {
                ev.preventDefault();
                let pos1 = pos3 - ev.clientX;
                let pos2 = pos4 - ev.clientY;
                pos3 = ev.clientX;
                pos4 = ev.clientY;
                popup.style.top = (popup.offsetTop - pos2) + "px";
                popup.style.left = (popup.offsetLeft - pos1) + "px";
            };
        };
    }

    // 8. Sincroniza√ß√£o (Janela -> Bloco Original)
    const editor = popup.querySelector('.aq-popup-content');
    editor.addEventListener('input', () => {
        const actionsHTML = ghost.querySelector('.ghost-actions')?.outerHTML || '';
        
        // Reconstr√≥i o HTML do original mantendo os bot√µes
        if (!ghost.querySelector('.ghost-actions')) {
            ghost.innerHTML = editor.innerHTML;
            if(typeof ensureGhostActions === 'function') ensureGhostActions(ghost);
        } else {
            ghost.innerHTML = editor.innerHTML + actionsHTML;
        }
        
        // Grava automaticamente
        if (typeof saveAquariumState === 'function') saveAquariumState();
        
        // Dispara evento para atualizar estat√≠sticas ou 4¬™ coluna
        const canvas = document.getElementById('aquarium-content-canvas');
        if (canvas) canvas.dispatchEvent(new Event('input', { bubbles: true }));
    });

    editor.focus();
};

// 2. FECHAR POPUP
window.closeGhostPopup = function(ghostId) {
    const popup = document.getElementById(`popup_${ghostId}`);
    const ghost = document.getElementById(ghostId);

    // 1. Remove a janela
    if (popup) popup.remove();

    // 2. DESBLOQUEIA O ORIGINAL
    if (ghost) {
        ghost.classList.remove('locked-popup');
        ghost.setAttribute('contenteditable', 'true'); // VOLTA A PERMITIR ESCRITA
        
        // Garante que os bot√µes de a√ß√£o (üêö ‚á±) est√£o l√°
        if (typeof ensureGhostActions === 'function') {
            ensureGhostActions(ghost);
        }
    }

    // 3. Remove da lista ativa
    activeAquariumPopups = activeAquariumPopups.filter(id => id !== ghostId);
};

// --- FUN√á√ÉO DE LIMPEZA PROFUNDA DO AQU√ÅRIO ---
window.resetAquariumState = function() {
    console.log("üßπ [RESET] A limpar estado do Aqu√°rio...");

    // 1. Fechar Sidebar e Resetar Margens do Texto
    const env = document.getElementById('aquarium-environment');
    if (env) {
        env.classList.remove('sidebar-open');
        
        // --- NOVO: Remove as classes que empurram o texto ---
        env.classList.remove('left-open');
        env.classList.remove('right-open');
    }
    
    // Reset do bot√£o da Medusa
    const sideBtn = document.getElementById('aquarium-sidebar-toggle');
    if (sideBtn) sideBtn.classList.remove('active');

    // Volta para a aba de listas por defeito na sidebar
    const listTab = document.querySelector('.aq-tab[data-tab="listas"]');
    if (listTab) listTab.click();

    // 2. DESTRUIR TODOS OS POPUPS FLUTUANTES
    document.querySelectorAll('.aq-popup-window').forEach(popup => popup.remove());
    
    // --- LIMPEZA TOTAL DOS EFEITOS VISUAIS AZUIS (Armaz√©m) ---
    document.querySelectorAll('.ghost-block.active-store-target').forEach(g => {
        g.classList.remove('active-store-target');
        // Remove estilos inline for√ßados para garantir limpeza absoluta
        g.style.border = '';
        g.style.backgroundColor = '';
        g.style.boxShadow = '';
    });
    // Zera a vari√°vel de controlo
    window.activeStoreGhostId = null;

    // 3. DESBLOQUEAR BLOCOS ORIGINAIS (Que estavam em janelas flutuantes)
    document.querySelectorAll('.ghost-block.locked-popup').forEach(block => {
        block.classList.remove('locked-popup');
        block.setAttribute('contenteditable', 'true'); // Devolve a capacidade de editar
    });

    // 4. RESETAR VARI√ÅVEIS GLOBAIS
    activeAquariumPopups = []; 
    aqListStack = [];          
    window.activeGhost = null; 

    // 5. Esconder Barras de Contexto e Modais de Sistema
    const contextTools = document.getElementById('aq-context-tools');
    if (contextTools) contextTools.style.setProperty('display', 'none', 'important');

    const systemModals = [
        'aquarium-jump-popup', 'share-settings-popup', 'link-modal', 
        'black-hole-modal', 'semantic-type-popup', 'universal-scan-modal'
    ];
    systemModals.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // 6. Fechar o Painel de Refer√™ncias (Direita) e devolv√™-lo √† app principal
    if (typeof hideReferencesPanel === 'function') {
        hideReferencesPanel();
    }
};

// Permite clicar noutros blocos mesmo com popups abertos
document.getElementById('aquarium-content-canvas').addEventListener('mousedown', (e) => {
    // Se o alvo for um bloco fantasma E N√ÉO estiver bloqueado
    const targetBlock = e.target.closest('.ghost-block');
    
    if (targetBlock && !targetBlock.classList.contains('locked-popup')) {
        // For√ßa a ativa√ß√£o desse bloco
        window.setActiveGhost(targetBlock);
    }
});

window.openGhostStore = async function(btn) {
    const ghost = btn.closest('.ghost-block');
    if (!ghost) return;
    
    if (!ghost.id) ghost.id = 'ghost_' + Date.now();
    window.activeStoreGhostId = ghost.id;
    
    // 1. Destaque visual no par√°grafo
    document.querySelectorAll('.ghost-block').forEach(g => g.classList.remove('active-store-target'));
    ghost.classList.add('active-store-target');
    
    // 2. Abrir Sidebar se estiver fechada
    const env = document.getElementById('aquarium-environment');
    if (env && !env.classList.contains('sidebar-open')) {
        env.classList.add('sidebar-open');
        document.getElementById('aquarium-sidebar-toggle')?.classList.add('active');
    }
    
    // 3. --- CORRE√á√ÉO DE NAVEGA√á√ÉO ---
    // Remove o estado ativo de todos os bot√µes de TOPO e coloca na Concha
    document.querySelectorAll('.aq-tab').forEach(b => b.classList.remove('active'));
    const storeTabBtn = document.querySelector('.aq-tab[data-tab="armazem"]');
    if (storeTabBtn) storeTabBtn.classList.add('active');

    // Esconde TODAS as vistas (incluindo a de Listas/T√≥picos que aparece na tua imagem)
    document.querySelectorAll('.aq-view').forEach(v => v.style.display = 'none');
    
    // Mostra apenas a do Armaz√©m
    const storeView = document.getElementById('aq-store-view');
    if (storeView) {
        storeView.style.display = 'flex'; // Flex para as sub-abas funcionarem
    }

    // 4. Define a sub-aba como Par√°grafos
    window.currentStoreTab = 'paragraphs';
    window.currentShellId = null;

    // 5. Cria o card autom√°tico
    await window.createStoreItem('note', { 
        title: "", 
        autoCreated: true 
    });
};


// Criar Nota Vinculada ao Bloco
window.createAttachedNote = async function() {
    if (!window.activeStoreGhostId) return alert("Erro: Nenhum bloco selecionado.");

    const title = prompt("Nome da nova nota anexa:");
    if (!title) return;

    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Cria nota vinculada ao ID do bloco (parentBlockId)
        await addDoc(collection(db, 'pastas'), {
            nome: title,
            tipo: 'nota',
            conteudo: '',
            userId: auth.currentUser.uid,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp(),
            estado: 'ativa',
            parentBlockId: window.activeStoreGhostId, // V√çNCULO
            originAquariumId: selectedNoteId
        });
        
        // Atualiza a lista
        if(typeof renderAquariumStore === 'function') renderAquariumStore();

    } catch (e) {
        console.error(e);
        alert("Erro ao criar nota.");
    }
};

// --- ABA: ARMAZ√âM (Notas Anexadas ao Bloco) ---
// --- VARI√ÅVEIS GLOBAIS DO ARMAZ√âM ---
window.currentStoreTab = 'notes'; // Abas: notes, shells, paragraphs, media
window.currentShellId = null; // null = Raiz, ID = Dentro da Concha

// 1. FUN√á√ÉO MESTRA: RENDERIZAR ARMAZ√âM
window.renderAquariumStore = async function() {
    const container = document.getElementById('aq-store-view');
    if (!container) return;

    container.style.cssText = "display: flex; flex-direction: column; height: 100%; overflow: hidden;";

    if (window.currentShellId) {
        await renderInsideShell(container);
        return;
    }

    // Gerar HTML das abas internas
    container.innerHTML = `
        <div class="store-tabs-header">
            <button class="store-tab-btn ${window.currentStoreTab === 'notes' ? 'active' : ''}" onclick="window.switchStoreTab('notes')">üóíÔ∏è</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'shells' ? 'active' : ''}" onclick="window.switchStoreTab('shells')">ü´ß</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'paragraphs' ? 'active' : ''}" onclick="window.switchStoreTab('paragraphs')">üéê</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'media' ? 'active' : ''}" onclick="window.switchStoreTab('media')">üì∑</button>
        </div>
        <div id="store-content-list" class="store-content-area" style="flex:1; overflow-y:auto;">
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    `;

    // Carregar os dados reais
    await loadStoreContent();
};
  

// 2. FUN√á√ÉO PARA MUDAR DE ABA
window.switchStoreTab = function(tab) {
    window.currentStoreTab = tab;
    // Re-renderiza para atualizar a classe .active no bot√£o e carregar o conte√∫do novo
    window.renderAquariumStore();
};

// 3. CARREGAR CONTE√öDO (CONSOANTE A ABA)
async function loadStoreContent() {
    const listDiv = document.getElementById('store-content-list');
    if (!listDiv) return console.error("‚ùå [ARMAZ√âM] Div 'store-content-list' n√£o encontrada.");

    console.log(`üìÇ [ARMAZ√âM] A preparar aba: ${window.currentStoreTab}`);

    // 1. Limpeza e Spinner
    listDiv.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

    // 2. IMPORTA√á√ÉO DOS M√ìDULOS
    const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    try {
        listDiv.innerHTML = ''; 
        const collRef = collection(db, 'aquarium_annotations');
        let q;

        // ============================================================
        // [ESTRAT√âGIA] DELEGA√á√ÉO DE CLIQUES (MAIS ROBUSTO)
        // ============================================================
        // Removemos o onclick do bot√£o e usamos este ouvinte no pai:
       listDiv.addEventListener('click', async (e) => {
            const btn = e.target.closest('.store-create-btn');
            if (!btn) return;

            // P√ÅRA TUDO O RESTO NO SITE
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            const action = btn.dataset.action;
            console.log("%cüéØ [CLIQUE] Capturado no Armaz√©m: " + action, "color: yellow; font-weight: bold;");

          if (action === 'add-global-note') {
                const res = await window.showCustomInput("Nova Anota√ß√£o Global", "T√≠tulo da nota...");
                if (res && res.name) window.createStoreItem('note', { title: res.name });
            } 
            else if (action === 'add-shell') {
                const res = await window.showCustomInput("Criar Concha", "Nome da concha...");
                if (res && res.name) window.createStoreItem('shell', { name: res.name });
            }
            else if (action === 'add-media-image') {
                const res = await window.showCustomInput("Inserir Imagem", "URL da imagem...");
                if (res && res.name) window.createStoreItem('media', { url: res.name, mediaType: 'image' });
            }
            else if (action === 'add-media-video') {
                const res = await window.showCustomInput("Inserir V√≠deo", "Link YouTube...");
                if (res && res.name) window.createStoreItem('media', { url: res.name, mediaType: 'video' });
            }
        }, true); // O 'true' aqui √© o segredo: ele captura o clique antes das outras camadas!

        // ============================================================
        // [PARTE 1] INSER√á√ÉO DOS BOT√ïES (Sem onclick direto)
        // ============================================================
        
        if (window.currentStoreTab === 'notes') {
            const btn = document.createElement('button');
            btn.className = 'store-create-btn';
            btn.dataset.action = 'add-global-note'; // Identificador para a delega√ß√£o
            btn.innerHTML = "<strong>+ Anota√ß√£o Global</strong>";
            listDiv.appendChild(btn);

            q = query(collRef, 
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_note'),
                where('blockId', '==', null),
                orderBy('createdAt', 'desc')
            );
        } 
        else if (window.currentStoreTab === 'shells') {
            const btn = document.createElement('button');
            btn.className = 'store-create-btn';
            btn.dataset.action = 'add-shell';
            btn.innerHTML = "<strong>+ Concha</strong>";
            btn.style.color = "#e67e22"; btn.style.borderColor = "#e67e22";
            listDiv.appendChild(btn);

            q = query(collRef, 
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_shell'),
                orderBy('createdAt', 'desc')
            );
        }
     else if (window.currentStoreTab === 'media') {
            const btnDiv = document.createElement('div');
            btnDiv.style.cssText = "display:flex; gap:10px; margin-bottom:15px;";
            
            const btnImg = document.createElement('button');
            btnImg.className = 'store-create-btn'; 
            btnImg.style.flex = "1";
            btnImg.dataset.action = 'add-media-image'; // <--- ESTA LINHA √â OBRIGAT√ìRIA
            btnImg.innerHTML = "<strong>+ Imagem</strong>";

            const btnVid = document.createElement('button');
            btnVid.className = 'store-create-btn'; 
            btnVid.style.flex = "1";
            btnVid.dataset.action = 'add-media-video'; // <--- ESTA LINHA √â OBRIGAT√ìRIA
            btnVid.innerHTML = "<strong>+ V√≠deo</strong>";

            btnDiv.append(btnImg, btnVid);
            listDiv.appendChild(btnDiv);

            q = query(collRef, 
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_media'),
                orderBy('createdAt', 'desc')
            );
        }
        else if (window.currentStoreTab === 'paragraphs') {
            q = query(collRef,
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_note'),
                orderBy('createdAt', 'desc')
            );
        }

        // ============================================================
        // [PARTE 2] BUSCA E RENDERIZA√á√ÉO DOS CARDS
        // ============================================================
        if (!q) return;

        const snap = await getDocs(q);
        let hasItems = false;

        snap.forEach(docSnap => {
            const data = docSnap.data();
            
            // Filtro de aba Par√°grafos
            if (window.currentStoreTab === 'paragraphs') {
                if (!data.blockId) return;
            } else if (window.currentStoreTab === 'notes') {
                if (data.blockId) return;
            }

            hasItems = true;

            if (data.type === 'store_shell') {
                listDiv.appendChild(createStoreShellCard(docSnap.id, data));
            } else if (data.type === 'store_media') {
                listDiv.appendChild(createStoreMediaCard(docSnap.id, data));
            } else {
                const card = createStoreNoteCard(docSnap.id, data);
                // Injeta alvo üéØ se tiver v√≠nculo com par√°grafo
                if (data.blockId) {
                    const h = card.querySelector('div');
                    const locateBtn = document.createElement('button');
                    locateBtn.className = 'store-link-indicator-btn';
                    locateBtn.innerHTML = 'üéØ';
                    locateBtn.onclick = (e) => {
                        e.stopPropagation();
                        const el = document.getElementById(data.blockId);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            el.style.outline = "2px solid var(--accent-color)";
                            setTimeout(() => el.style.outline = "none", 2000);
                        }
                    };
                    if(h) h.insertBefore(locateBtn, h.firstChild);
                }
                listDiv.appendChild(card);
            }
        });

        if (!hasItems) {
            listDiv.innerHTML += '<p style="text-align:center; color:#666; margin-top:40px; font-style:italic;">Vazio.</p>';
        }

    } catch (e) {
        console.error("‚ùå [ERRO CR√çTICO] Falha ao carregar Armaz√©m:", e);
        listDiv.innerHTML = `<p style="color:red; text-align:center; padding:20px;">Erro ao carregar dados.<br><small>${e.message}</small></p>`;
    }
}
    













// 4. CRIAR ITEM NO FIREBASE
window.createStoreItem = async function(type, extraData = {}) {
    const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // Mostra status visual de grava√ß√£o no Aqu√°rio
    if (typeof updateAquariumStatus === 'function') updateAquariumStatus('saving');

    const baseData = {
        noteId: selectedNoteId,     
        type: `store_${type}`, 
        createdAt: serverTimestamp(),
        parentId: window.currentShellId || null,
        userId: auth.currentUser.uid,
        // S√≥ vincula ao par√°grafo se estivermos explicitamente na aba par√°grafos ou se vier do clique na concha
        blockId: (window.currentStoreTab === 'paragraphs' || extraData.autoCreated) ? window.activeStoreGhostId : null
    };

    if (type === 'note') {
        baseData.title = extraData.title || ""; 
        baseData.content = "";
    } else if (type === 'shell') {
        baseData.name = extraData.name || "Nova Concha";
    } else if (type === 'media') {
        baseData.url = extraData.url || "";
        baseData.mediaType = extraData.mediaType || "image";
    }

    try {
        await addDoc(collection(db, 'aquarium_annotations'), baseData);
        if (typeof updateAquariumStatus === 'function') updateAquariumStatus('saved');
        window.renderAquariumStore(); // Atualiza a lista
    } catch (e) {
        console.error("Erro ao criar item no armaz√©m:", e);
        if (typeof updateAquariumStatus === 'function') updateAquariumStatus('error');
    }
};

// 5. RENDERIZAR CARD DE NOTA
function createStoreNoteCard(id, data) {
    const card = document.createElement('div');
    card.className = 'store-note-card';
    card.id = `store-note-${id}`;

    // --- VERIFICA√á√ÉO DE BLOQUEIO (NOVO) ---
    // Se este ID estiver na lista de popups abertos, bloqueia o card imediatamente
    const isLocked = window.activeStorePopups && window.activeStorePopups.includes(id);
    const lockedClass = isLocked ? 'locked-card' : '';
    const readOnlyAttr = isLocked ? 'readonly' : '';
    const contentEditableAttr = isLocked ? 'false' : 'true';

    if (isLocked) card.classList.add('locked-card');

    // T√≠tulo e Bot√µes de Topo
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.gap = '5px';
    header.innerHTML = `
        <input type="text" class="store-note-title" placeholder="T√≠tulo" value="${data.title || ''}" ${readOnlyAttr}>
        <button class="store-icon-btn" title="Abrir Popup" onclick="window.openStoreNotePopup('${id}')">‚á±</button>
        <button class="store-icon-btn" title="Apagar" style="color:#e74c3c" onclick="window.deleteStoreItem('${id}')">üóëÔ∏è</button>
    `;

    // Corpo
    const body = document.createElement('div');
    body.className = 'store-note-body';
    body.contentEditable = contentEditableAttr; // Usa a vari√°vel definida acima
    body.innerHTML = data.content || "";

    // Rodap√© (Links)
    const footer = document.createElement('div');
    footer.className = 'store-card-footer';
    
    const linksArea = document.createElement('div');
    linksArea.className = 'store-links-area';
    
    if (data.links) {
        data.links.forEach((link, idx) => {
            linksArea.appendChild(createLinkRow(id, idx, link.url));
        });
    }

    const addLinkBtn = document.createElement('button');
    addLinkBtn.className = 'store-icon-btn';
    addLinkBtn.textContent = "+ Link";
    addLinkBtn.onclick = () => {
        // Se estiver bloqueado, ignora clique
        if (card.classList.contains('locked-card')) return;
        
        const newLinks = data.links || [];
        newLinks.push({url: ""});
        window.updateStoreItem(id, { links: newLinks }).then(() => {
            if(window.currentShellId) renderInsideShell(document.getElementById('aq-store-view'));
            else loadStoreContent();
        });
    };

    footer.appendChild(linksArea);
    footer.appendChild(addLinkBtn);

    // Auto-Save Listeners
    const titleInput = header.querySelector('input');
    titleInput.addEventListener('input', () => {
        // Se estiver bloqueado, n√£o grava (seguran√ßa extra)
        if (card.classList.contains('locked-card')) return;
        
        clearTimeout(card.saveTimer);
        card.saveTimer = setTimeout(() => window.updateStoreItem(id, { title: titleInput.value }), 1000);
    });

    body.addEventListener('input', () => {
        if (card.classList.contains('locked-card')) return;

        clearTimeout(card.saveTimer);
        card.saveTimer = setTimeout(() => {
            window.updateStoreItem(id, { content: body.innerHTML });
            // Sincroniza se houver popup aberto (embora esteja bloqueado, √© boa pr√°tica)
            const popupBody = document.getElementById(`popup-body-${id}`);
            if(popupBody) popupBody.innerHTML = body.innerHTML;
        }, 1000);
    });

    card.appendChild(header);
    card.appendChild(body);
    card.appendChild(footer);

    return card;
}

function createLinkRow(noteId, idx, urlVal) {
    const div = document.createElement('div');
    div.className = 'store-link-row';
    div.innerHTML = `
        <input type="text" class="store-link-input" placeholder="URL..." value="${urlVal}">
        <button class="store-icon-btn" onclick="window.open('${urlVal}', '_blank')">‚Üó</button>
        <button class="store-icon-btn" style="color:#e74c3c" onclick="window.removeStoreLink('${noteId}', ${idx})">√ó</button>
    `;
    
    // Auto-save do link
    const input = div.querySelector('input');
    input.addEventListener('change', async () => {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const ref = doc(db, 'aquarium_annotations', noteId);
        const snap = await getDoc(ref);
        const links = snap.data().links;
        links[idx].url = input.value;
        await updateDoc(ref, { links });
    });

    return div;
}

// 6. RENDERIZAR CONCHA
function createStoreShellCard(id, data) {
    const div = document.createElement('div');
    div.className = 'store-shell-card';
    div.innerHTML = `
        <span class="shell-icon">üêö</span>
        <span class="shell-name">${data.name}</span>
        <div style="display:flex; gap:5px;">
            <button class="store-icon-btn" onclick="event.stopPropagation(); window.editShellName('${id}', '${data.name}')">‚úèÔ∏è</button>
            <button class="store-icon-btn" style="color:#e74c3c" onclick="event.stopPropagation(); window.deleteStoreItem('${id}')">üóëÔ∏è</button>
        </div>
    `;
    div.onclick = () => window.enterShell(id, data.name);
    return div;
}

// 7. RENDERIZAR MULTIM√âDIA
function createStoreMediaCard(id, data) {
    const div = document.createElement('div');
    div.className = 'store-media-card';
    
    // 1. Determina o conte√∫do visual
    let mediaContent = '';
    const url = data.url || '';
    const isVideo = data.mediaType === 'video';

    if (url) {
        if (isVideo) {
            // Tenta detetar YouTube para embutir
            // Suporta: , , 
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            
            if (ytMatch && ytMatch[1]) {
                // √â YouTube: Mostra Iframe
                mediaContent = `
                    <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:4px; margin-bottom:5px;">
                        <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                                src=" 
                                frameborder="0" allowfullscreen></iframe>
                    </div>`;
            } else {
                // Outro V√≠deo: Mostra Link Gen√©rico com √çcone
                mediaContent = `
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:4px; text-align:center; margin-bottom:5px;">
                        <span style="font-size:2em;">üé•</span>
                        <br>
                        <a href="${url}" target="_blank" style="color:var(--accent-color); word-break:break-all;">${url}</a>
                    </div>`;
            }
        } else {
            // Imagem
            mediaContent = `<img src="${url}" class="store-media-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                            <div style="display:none; color:red; font-size:0.8em;">Erro ao carregar imagem.</div>`;
        }
    }

    // 2. HTML do Card (Input + Bot√µes)
    const placeholderText = isVideo ? "Cole o link do v√≠deo (YouTube...)" : "URL da Imagem...";
    const icon = isVideo ? "üé•" : "üñºÔ∏è";

    div.innerHTML = `
        ${mediaContent}
        
        <div style="display:flex; gap:5px; align-items:center;">
            <span style="font-size:1.2em;">${icon}</span>
            <input type="text" class="store-media-input" placeholder="${placeholderText}" value="${url}">
            
            <!-- Bot√£o Ver (Abre link original) -->
            ${url ? `<button class="store-icon-btn" onclick="window.open('${url}', '_blank')" title="Abrir Link">‚Üó</button>` : ''}
            
            <button class="store-icon-btn" style="color:#e74c3c" onclick="window.deleteStoreItem('${id}')">üóëÔ∏è</button>
        </div>
    `;

    // 3. Listener para Gravar Altera√ß√µes
    const input = div.querySelector('input');
    input.addEventListener('change', () => {
        let newUrl = input.value.trim();
        // Adiciona https se faltar
        if (newUrl && !newUrl.startsWith('http')) newUrl = 'https://' + newUrl;
        
        window.updateStoreItem(id, { url: newUrl });
        
        // Recarrega a vista para processar o novo link (mostrar iframe ou imagem)
        if(window.currentShellId) {
            renderInsideShell(document.getElementById('aq-store-view'));
        } else {
            loadStoreContent();
        }
    });

    return div;
}

// 8. NAVEGA√á√ÉO NA CONCHA
window.enterShell = function(id, name) {
    window.currentShellId = id;
    window.currentShellName = name;
    window.renderAquariumStore();
};

async function renderInsideShell(container) {
    const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    container.innerHTML = `
        <div class="store-nav-header">
            <button class="store-icon-btn" style="font-size:18px; margin-right:10px;" onclick="window.backToStoreRoot()">‚¨Ö</button>
            <span style="font-weight:bold; color:#e67e22;">üêö ${window.currentShellName || 'Concha'}</span>
        </div>
        <div class="store-content-area" id="shell-content">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="store-create-btn" style="flex:1; margin:0;" onclick="window.createStoreItem('note')">+ Anota√ß√£o</button>
                
                <!-- NOVO BOT√ÉO DE V√çDEO -->
                <button class="store-create-btn" style="flex:1; margin:0;" onclick="window.createStoreItem('media', {mediaType: 'video'})">+ V√≠deo</button>
            </div>
            
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    `;

    const contentDiv = document.getElementById('shell-content');

    try {
        // --- QUERY ATUALIZADA: BUSCAR NOTAS E MEDIA ---
        const q = query(
            collection(db, 'aquarium_annotations'),
            where('noteId', '==', selectedNoteId),
            where('parentId', '==', window.currentShellId),
            // where('type', 'in', ['store_note', 'store_media']), // O Firebase pode reclamar de √≠ndices com 'in' e 'orderBy'
            // Se der erro de √≠ndice, removemos o 'orderBy' e ordenamos no JS
        );

        const snap = await getDocs(q);
        
        // Remove spinner
        const spinner = contentDiv.querySelector('.spinner-container');
        if(spinner) spinner.remove();

        if (snap.empty) {
            contentDiv.innerHTML += '<p style="text-align:center; color:#666; margin-top:20px; font-style:italic;">Concha vazia.</p>';
            return;
        }

        // Converter para array e ordenar manualmente (Mais seguro sem √≠ndices complexos)
        let items = [];
        snap.forEach(docSnap => {
            const data = docSnap.data();
            // Filtrar apenas o que queremos (caso existam outros tipos perdidos)
            if (data.type === 'store_note' || data.type === 'store_media') {
                items.push({ id: docSnap.id, ...data });
            }
        });

        // Ordenar do mais recente para o mais antigo
        items.sort((a, b) => {
            const timeA = a.createdAt?.seconds || 0;
            const timeB = b.createdAt?.seconds || 0;
            return timeB - timeA;
        });

        // Renderizar
        items.forEach(item => {
            if (item.type === 'store_note') {
                contentDiv.appendChild(createStoreNoteCard(item.id, item));
            } else if (item.type === 'store_media') {
                contentDiv.appendChild(createStoreMediaCard(item.id, item));
            }
        });

    } catch (e) {
        console.error("Erro ao ler concha:", e);
        contentDiv.innerHTML += `<p style="color:red; text-align:center;">Erro ao carregar dados: ${e.message}</p>`;
    }
}

window.backToStoreRoot = function() {
    window.currentShellId = null;
    window.renderAquariumStore();
};

// 9. POPUP FLUTUANTE DA NOTA
window.openStoreNotePopup = function(id) {
    // 1. Verificar se j√° existe
    if (document.getElementById(`store-popup-${id}`)) {
        alert("Esta nota j√° est√° aberta.");
        return;
    }

    const card = document.getElementById(`store-note-${id}`);
    if (!card) return;

    // 2. Bloquear o Card Original
    card.classList.add('locked-card');
    card.querySelector('.store-note-title').setAttribute('readonly', 'true');
    card.querySelector('.store-note-body').setAttribute('contenteditable', 'false');
    
    // Adicionar √† lista de ativos
    if (!window.activeStorePopups.includes(id)) {
        window.activeStorePopups.push(id);
    }

    // 3. Criar Popup
    const titleVal = card.querySelector('.store-note-title').value;
    const bodyVal = card.querySelector('.store-note-body').innerHTML;

    const popup = document.createElement('div');
    popup.className = 'aq-popup-window';
    popup.id = `store-popup-${id}`;
    
    // Posi√ß√£o em cascata para n√£o ficarem uns cima dos outros
    const offset = window.activeStorePopups.length * 20;
    popup.style.zIndex = '30000000';
    popup.style.position = 'fixed';
    popup.style.top = `${150 + offset}px`;
    popup.style.left = `${200 + offset}px`;

    // Bot√£o de fechar chama a nova fun√ß√£o closeStorePopup
    popup.innerHTML = `
        <div class="aq-popup-header" style="cursor: move;">
            <span class="aq-popup-title">üìù Anota√ß√£o</span>
            <button class="aq-popup-close" onclick="window.closeStorePopup('${id}')">‚úï</button>
        </div>
        <div style="padding:10px; flex-grow:1; display:flex; flex-direction:column; gap:10px; overflow:hidden;">
             <input type="text" class="store-note-title" value="${titleVal}" 
                    style="background:rgba(0,0,0,0.3); border:1px solid #444; color:white; padding:5px;"
                    oninput="window.syncPopupToCard('${id}', 'title', this.value)">
             
             <div class="store-note-body" id="popup-body-${id}" contenteditable="true" 
                  style="flex-grow:1; background:rgba(0,0,0,0.2); color:#ddd; padding:10px; overflow-y:auto;"
                  oninput="window.syncPopupToCard('${id}', 'content', this.innerHTML)">${bodyVal}</div>
        </div>
    `;

    document.body.appendChild(popup);

    if (typeof makeElementDraggable === 'function') {
        makeElementDraggable(popup);
    }
};

// Sincroniza Popup -> Card -> Firebase
window.syncPopupToCard = function(id, field, value) {
    // Atualiza o card visualmente (se estiver vis√≠vel)
    const card = document.getElementById(`store-note-${id}`);
    if (card) {
        if (field === 'title') card.querySelector('.store-note-title').value = value;
        if (field === 'content') card.querySelector('.store-note-body').innerHTML = value;
    }
    
    // Debounce para gravar no Firebase
    clearTimeout(window[`timer_${id}`]);
    window[`timer_${id}`] = setTimeout(() => {
        window.updateStoreItem(id, { [field]: value });
    }, 1000);
};

// 10. HELPER: ATUALIZAR/APAGAR
window.updateStoreItem = async function(id, data) {
    const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    const ref = doc(db, 'aquarium_annotations', id);
    await updateDoc(ref, data);
};

window.deleteStoreItem = async function(id) {
    // 1. Usa o teu modal personalizado
    const confirmed = await showConfirmation(
        "Apagar Item?", 
        "Tem a certeza que deseja eliminar este item do Armaz√©m?"
    );

    if (!confirmed) return; // Se cancelar, n√£o faz nada

    try {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // 2. Apaga no Firebase
        await deleteDoc(doc(db, 'aquarium_annotations', id));
        
        // 3. Remove visualmente (sem precisar de recarregar tudo)
        const el = document.getElementById(`store-note-${id}`) || 
                   document.querySelector(`.store-shell-card button[onclick*="${id}"]`)?.closest('.store-shell-card') ||
                   document.querySelector(`.store-media-card button[onclick*="${id}"]`)?.closest('.store-media-card');
        
        if (el) {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
        } else {
            // Fallback: recarrega a lista se n√£o encontrar o elemento
            if(window.currentShellId) renderInsideShell(document.getElementById('aq-store-view'));
            else loadStoreContent();
        }

    } catch (e) {
        console.error("Erro ao apagar:", e);
        alert("Erro ao apagar.");
    }
};

window.editShellName = async function(id, oldName) {
    // 1. Usa o teu modal de input personalizado
    // Par√¢metros: (T√≠tulo, Placeholder, Valor Inicial)
    const result = await showCustomInput("Renomear Concha", "Nome da concha...", oldName);
    
    if (result && result.name) {
        const newName = result.name.trim();
        if (newName === oldName) return;

        // 2. Atualiza no Firebase
        await window.updateStoreItem(id, { name: newName });
        
        // 3. Atualiza a lista
        loadStoreContent();
    }
};

window.removeStoreLink = async function(noteId, idx) {
    const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    const ref = doc(db, 'aquarium_annotations', noteId);
    const snap = await getDoc(ref);
    const links = snap.data().links;
    links.splice(idx, 1);
    await updateDoc(ref, { links });
    if(window.currentShellId) renderInsideShell(document.getElementById('aq-store-view'));
    else loadStoreContent();
};


// ============================================================
// CORRE√á√ÉO DE CLIQUE: FOR√áA O BOT√ÉO POPUP A FUNCIONAR
// ============================================================
setTimeout(() => {
    const canvas = document.getElementById('aquarium-content-canvas');
    if (canvas) {
        canvas.addEventListener('click', (e) => {
            
            // 1. Tenta encontrar o bot√£o pelo m√©todo padr√£o
            let popupBtn = e.target.closest('button[onclick*="openGhostPopup"]');
            
            // 2. CORRE√á√ÉO: Fallback expl√≠cito que retorna o ELEMENTO, n√£o "true"
            if (!popupBtn) {
                // Se clicou diretamente no bot√£o que tem a classe e o √≠cone
                if (e.target.classList.contains('ghost-action-btn') && e.target.innerHTML.includes('‚á±')) {
                    popupBtn = e.target;
                }
            }

            if (popupBtn) {
                console.log("üñ±Ô∏è Clique for√ßado no bot√£o Popup detetado!", popupBtn);
                
                // P√°ra tudo o resto
                e.preventDefault();
                e.stopPropagation(); 
                e.stopImmediatePropagation(); 

                // Chama a fun√ß√£o passando o ELEMENTO HTML (agora garantido)
                if (typeof window.openGhostPopup === 'function') {
                    window.openGhostPopup(popupBtn);
                } else {
                    console.error("‚ùå Erro: Fun√ß√£o window.openGhostPopup n√£o encontrada.");
                }
                return false;
            }
        }, true); // Fase de captura (prioridade m√°xima)
    }
}, 1000);


// Listener Espec√≠fico para o Aqu√°rio
const aquariumCanvas = document.getElementById('aquarium-content-canvas');
if (aquariumCanvas) {
    aquariumCanvas.addEventListener('paste', (e) => {
        // Verifica se o alvo √© um bloco fantasma
        if (e.target.classList.contains('ghost-block') || e.target.closest('.ghost-block')) {
            
            // 1. Tenta obter HTML do clipboard
            const htmlData = (e.clipboardData || window.clipboardData).getData('text/html');
            const textData = (e.clipboardData || window.clipboardData).getData('text/plain');

            // 2. Verifica se o HTML cont√©m os nossos links especiais
            if (htmlData && htmlData.includes('silent-link')) {
                // Se for um link interno nosso, deixa o navegador lidar com isso (preserva o HTML)
                // N√£o fazemos preventDefault aqui.
                return; 
            }

            // 3. Se for lixo externo ou texto normal, for√ßa Texto Limpo
            e.preventDefault();
            document.execCommand("insertText", false, textData);
            
            // For√ßa uma grava√ß√£o do estado
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
    });
}

// ============================================================
// MOTOR DE SCROLL INFINITO (AQU√ÅRIO)
// ============================================================

function checkAquariumScroll() {
    const scrollArea = document.getElementById('aquarium-scroll-area');
    const canvas = document.getElementById('aquarium-content-canvas');

    if (!scrollArea || !canvas) return;

    // --- 1. DADOS DE MEDI√á√ÉO ---
    const windowHeight = window.innerHeight;
    const scrollPos = scrollArea.scrollTop;
    const totalHeight = scrollArea.scrollHeight;
    const clientHeight = scrollArea.clientHeight;
    
    const distanceToBottom = totalHeight - (scrollPos + clientHeight);

    // --- 2. L√ìGICA DE EXPANS√ÉO (CRESCER) ---
    // Mantemos igual: se chegar perto do fundo, cria espa√ßo para n√£o travar
    if (distanceToBottom < 400) {
        const currentMin = parseFloat(window.getComputedStyle(canvas).minHeight) || 0;
        canvas.style.minHeight = (currentMin + (windowHeight * 0.6)) + 'px';
        return; 
    }

    // --- 3. L√ìGICA DE CONTRA√á√ÉO (LIMPEZA RIGOROSA) ---
    clearTimeout(scrollTimer);
    
    scrollTimer = setTimeout(() => {
        const lastBlock = canvas.lastElementChild;
        
        // Se n√£o houver nada, reseta para tamanho padr√£o
        if (!lastBlock) {
            canvas.style.minHeight = "80vh";
            return;
        }

        // Onde acaba o √∫ltimo texto
        const contentBottom = lastBlock.offsetTop + lastBlock.offsetHeight;
        const currentCanvasHeight = canvas.offsetHeight;
        const emptySpace = currentCanvasHeight - contentBottom;

        // CONFIGURA√á√ÉO PEDIDA:
        // Limite para limpar: 1 tela inteira (1.0)
        const maxAllowedEmpty = windowHeight * 1.0;
        
        // Quanto sobra depois de limpar: 60% de uma tela (0.6)
        // (D√° espa√ßo para continuar a escrever sem cortar a inspira√ß√£o)
        const bufferToKeep = windowHeight * 0.6; 
        
        // Se o espa√ßo vazio for maior que 1 tela...
        if (emptySpace > maxAllowedEmpty) {
            
            const newHeight = contentBottom + bufferToKeep;
            
            // Seguran√ßa: Nunca cortar o que est√° vis√≠vel no ecr√£ neste momento
            // (Posi√ß√£o atual + Altura da Janela + Margem de 100px)
            const visibleBottom = scrollPos + windowHeight + 100;

            if (newHeight > visibleBottom) {
                // console.log("‚úÇÔ∏è Ajustando altura: cortando excesso.");
                canvas.style.minHeight = newHeight + 'px';
            }
        }
    }, 200);
}

// Inicializa√ß√£o
setTimeout(() => {
    const scrollArea = document.getElementById('aquarium-scroll-area');
    
    if (scrollArea) {
        // Usamos 'mousedown' em vez de 'click' para ser mais r√°pido e impedir
        // que o evento se propague para l√≥gicas de cria√ß√£o de novos blocos
        scrollArea.addEventListener('mousedown', (e) => {
            
            // 1. VERIFICA√á√ÉO DE ALVO
            // Se clicou num bloco, num bot√£o ou numa popup, N√ÉO faz nada (deixa o clique funcionar)
            if (e.target.closest('.ghost-block') || 
                e.target.closest('button') || 
                e.target.closest('.aq-popup-window') ||
                e.target.closest('.ghost-actions') ||
                e.target.closest('.ghost-side-controls')) {
                return;
            }

            // 2. VERIFICA SE H√Å ALGO SELECIONADO
            const activeBlock = document.querySelector('.ghost-block.active-selection');
            const activeStore = document.querySelector('.ghost-block.active-store-target');

            if (activeBlock || activeStore) {
                console.log("üñ±Ô∏è Clique na margem detetado. A limpar sele√ß√£o...");

                // --- A. LIMPA SELE√á√ÉO VISUAL ---
                document.querySelectorAll('.ghost-block').forEach(g => {
                    g.classList.remove('active-selection');
                    g.classList.remove('has-next'); // Esconde o bot√£o (+)
                    g.classList.remove('active-store-target'); // Limpa sele√ß√£o do armaz√©m
                    
                    // Limpa estilos inline (bordas azuis)
                    g.style.borderTop = '';
                    g.style.border = '';
                    g.style.outline = '';
                    g.style.boxShadow = '';
                    g.style.backgroundColor = '';
                });

                // --- B. LIMPA ESTADO GLOBAL ---
                window.activeGhost = null;
                window.activeStoreGhostId = null;

                // --- C. ESCONDE BARRA DE FERRAMENTAS ---
                const contextTools = document.getElementById('aq-context-tools');
                if (contextTools) {
                    contextTools.style.setProperty('display', 'none', 'important');
                }
                
                // (Opcional) Remove foco do teclado para garantir que o cursor pisca desaparece
                if (document.activeElement) {
                    document.activeElement.blur();
                }
            }
            
        });
    }
}, 1000); // Delay de seguran√ßa para garantir que o HTML existe


// Fun√ß√£o para controlar o texto visual no Aqu√°rio
function updateAquariumStatus(status) {
    const el = document.getElementById('aq-save-status');
    if (!el) return;

    el.classList.remove('status-saved', 'status-error');
    
    switch (status) {
        case 'unsaved':
            el.textContent = 'por guardar...';
            el.style.color = '#text-muted-color'; // Cinza/Branco
            el.style.opacity = '0.7';
            break;
        case 'saving':
            el.textContent = 'A guardar...';
            el.style.color = 'var(--accent-color)'; // Azul
            el.style.opacity = '1';
            break;
        case 'saved':
            el.textContent = 'Guardado';
            el.classList.add('status-saved'); // Verde (via CSS existente)
            el.style.color = '#2ecc71'; 
            el.style.opacity = '1';
            break;
        case 'error':
            el.textContent = 'Erro ao guardar';
            el.classList.add('status-error'); // Vermelho
            break;
        default:
            el.textContent = '';
    }
}

// Fun√ß√£o para criar Backup de Seguran√ßa Autom√°tico
async function performSafetyBackup(noteId, content, title) {
    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const backupsRef = collection(db, 'pastas', noteId, 'backups');
        
        await addDoc(backupsRef, {
            titulo: title || "Sem T√≠tulo",
            conteudo: content,
            timestamp: serverTimestamp(),
            isSafetyBackup: true, // Marca como backup de emerg√™ncia
            triggerReason: 'Apagar Tudo (Seguran√ßa)' // Aparecer√° na lista
        });
        
        console.log("üö® [SAFETY] Backup de emerg√™ncia criado com sucesso.");
        return true;
    } catch (e) {
        console.error("Erro ao criar backup de seguran√ßa:", e);
        return false;
    }
}

// Fun√ß√£o para fechar popup e desbloquear o card
window.closeStorePopup = function(id) {
    // 1. Remover o popup do ecr√£
    const popup = document.getElementById(`store-popup-${id}`);
    if (popup) popup.remove();

    // 2. Remover da lista de ativos
    window.activeStorePopups = window.activeStorePopups.filter(pid => pid !== id);

    // 3. Desbloquear o Card Original (se ele estiver vis√≠vel no ecr√£)
    const card = document.getElementById(`store-note-${id}`);
    if (card) {
        card.classList.remove('locked-card');
        card.querySelector('.store-note-title').removeAttribute('readonly');
        card.querySelector('.store-note-body').setAttribute('contenteditable', 'true');
    }
};

window.saveAquariumTitle = async function(newName) {
    if (!selectedNoteId || !newName.trim()) return;

    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);

        await updateDoc(noteRef, { 
            nome: newName.trim(),
            ultimaedicao: serverTimestamp()
        });
        
        console.log("‚úèÔ∏è T√≠tulo do Aqu√°rio atualizado.");
        
        // Sincroniza com o input do editor principal (caso esteja escondido por tr√°s)
        const mainInput = document.getElementById('note-title-input');
        if (mainInput) mainInput.value = newName.trim();

    } catch (e) {
        console.error("Erro ao mudar t√≠tulo:", e);
    }
};

// Fun√ß√£o para disparar o efeito de bolhas
window.triggerAquariumBubbles = function() {
    const bubbleCount = 25; // Quantidade de bolhas
    
    for (let i = 0; i < bubbleCount; i++) {
        const bubble = document.createElement('div');
        bubble.className = 'aquarium-bubble';
        
        // Tamanho aleat√≥rio entre 10px e 60px
        const size = Math.random() * 50 + 10;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        
        // Posi√ß√£o horizontal aleat√≥ria (0% a 100%)
        bubble.style.left = `${Math.random() * 100}vw`;
        
        // Dura√ß√£o da anima√ß√£o (velocidade) entre 3s e 8s
        const duration = Math.random() * 5 + 3;
        bubble.style.animationDuration = `${duration}s`;
        
        // Atraso inicial para n√£o subirem todas ao mesmo tempo
        bubble.style.animationDelay = `${Math.random() * 2}s`;
        
        document.body.appendChild(bubble);
        
        // Remove do DOM quando a anima√ß√£o acabar para n√£o poluir a mem√≥ria
        setTimeout(() => {
            bubble.remove();
        }, duration * 1000 + 2000);
    }
};

// ============================================================
// CORRE√á√ÉO DE FOCO E TECLADO (MOBILE)
// ============================================================
const editorTouchHandler = document.getElementById('note-content-editor');

if (editorTouchHandler) {
    editorTouchHandler.addEventListener('touchstart', (e) => {
        const target = e.target;

        // 1. SE TOCOU NA √ÅREA DE TEXTO (Conte√∫do)
        if (target.classList.contains('mini-note-content') || 
            target.classList.contains('redator-content') ||
            target.classList.contains('toggle-content') ||
            target.closest('.mini-note-content') ||
            target.closest('.redator-content')) {
            
            // A. P√°ra a propaga√ß√£o.
            // Isto impede que a caixa pai (o wrapper) receba o toque e tente arrastar/selecionar tudo.
            e.stopPropagation(); 
            
            // B. Identifica o elemento exato
            const editableDiv = target.classList.contains('mini-note-content') || target.classList.contains('redator-content') 
                                ? target 
                                : target.closest('[contenteditable="true"]');

            if (editableDiv) {
                // C. For√ßa o foco imediatamente
                editableDiv.focus();
                
                // D. Truque para abrir o teclado em alguns Androids teimosos
                // Se o elemento estiver vazio, simulamos uma sele√ß√£o
                if (editableDiv.innerText.trim() === "") {
                    const range = document.createRange();
                    range.selectNodeContents(editableDiv);
                    range.collapse(false);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
            // NOTA: N√£o usamos e.preventDefault() aqui para permitir que o teclado nativo abra
            return;
        }

        // 2. SE TOCOU EM BOT√ïES (A√ß√£o sem teclado)
        if (target.closest('button')) {
            const btn = target.closest('button');
            // Se for bot√£o de ferramentas, a√≠ sim prevenimos o foco
            if (btn.closest('.mini-note-toolbar') || btn.closest('.redator-dock')) {
                e.preventDefault(); 
                e.stopPropagation(); 
                btn.click(); 
            }
        }
    }, { passive: false });
}

// ============================================================
// CORRE√á√ÉO SUPREMA DE FOCO E MENU NATIVO (MOBILE)
// ============================================================

// 1. Impedir que o "Long Press" (Menu de contexto) seja bloqueado em √°reas de texto
window.addEventListener('contextmenu', (e) => {
    const target = e.target;

    // Verifica se o alvo √© edit√°vel (Input, Textarea ou ContentEditable)
    const isEditable = target.tagName === 'INPUT' || 
                       target.tagName === 'TEXTAREA' || 
                       target.isContentEditable;

    if (isEditable) {
        // [CR√çTICO] Para o menu nativo (Copiar/Colar) aparecer no Mobile:
        // 1. N√ÉO chame e.preventDefault().
        // 2. N√ÉO chame e.stopPropagation() se quiser que o browser trate disto nativamente.
        // Apenas deixamos o evento passar.
        
        // No entanto, se tivermos um menu personalizado (como o dos 3 pontos da lista),
        // queremos garantir que ele N√ÉO abre aqui.
        // Como o seu menu personalizado est√° na lista (esquerda/meio) e n√£o no editor,
        // deixar o evento passar √© seguro.
        return true; 
    }
    
    // Se N√ÉO for edit√°vel (ex: clicar na borda da nota), pode bloquear se quiser prevenir o menu do browser
    // e.preventDefault(); 
}, false);

// 2. FOR√áAR O TECLADO NO TOQUE (TOUCHSTART)
// Isto mant√©m-se para garantir que o teclado abre logo ao clicar
document.addEventListener('touchstart', (e) => {
    const target = e.target;
    
    // Verifica se tocou num campo edit√°vel
    const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
    const isEditableDiv = target.isContentEditable;

    if (isInput || isEditableDiv) {
        // P√°ra a propaga√ß√£o para evitar que a l√≥gica de "arrastar caixas" (dragstart) do pai ative
        // Isto √© essencial: se o pai tentar arrastar, o telem√≥vel cancela a sele√ß√£o de texto.
        e.stopPropagation();
        
        // For√ßa o foco para abrir o teclado
        target.focus();
    }
}, { passive: false });

// 3. (Opcional) Corre√ß√£o espec√≠fica para os T√≠tulos (Inputs)
// Garante que clicar no input do t√≠tulo da caixa n√£o tenta arrastar a caixa
const editorContainer = document.getElementById('note-content-editor');
if (editorContainer) {
    editorContainer.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            e.stopPropagation(); // O input recebe o clique, a caixa pai n√£o sabe
        }
    });
}

// ============================================================
// SISTEMA DE GPS DE CURSOR (POSI√á√ÉO EM TEMPO REAL)
// ============================================================

// ============================================================
// SISTEMA DE GPS DE CURSOR (DOM PATH) - CORRE√á√ÉO PROFISSIONAL
// ============================================================

window.lastCursorGPS = {
    active: false,
    containerId: null,
    editableClass: null,
    path: [],
    offset: 0,
    timestamp: 0
};

function trackCursorPosition(e) {
    const eventType = e ? e.type : 'manual';
    if (eventType === 'mousemove') return;

    // 1. INPUTS (T√≠tulo)
    const activeEl = document.activeElement;
    if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
        const wrapper = activeEl.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card');
        if (wrapper && wrapper.id) {
            window.lastCursorGPS = {
                active: true,
                type: 'input',
                containerId: wrapper.id,
                path: [], 
                offset: 0,
                timestamp: Date.now()
            };
            return;
        }
    }

    // 2. CONTE√öDO (Divs)
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const anchorNode = selection.anchorNode;
    const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

    const contentDiv = element.closest('[contenteditable="true"]');
    const wrapper = element.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, details.toggle-section');

    if (contentDiv && wrapper && wrapper.id) {
        const path = [];
        let currentNode = anchorNode;
        while (currentNode && currentNode !== contentDiv) {
            const parent = currentNode.parentNode;
            if (!parent) break;
            const index = Array.prototype.indexOf.call(parent.childNodes, currentNode);
            path.unshift(index);
            currentNode = parent;
        }

        let targetClass = "";
        if (contentDiv.classList.contains('mini-note-content')) targetClass = '.mini-note-content';
        else if (contentDiv.classList.contains('redator-content')) targetClass = '.redator-content';
        else if (contentDiv.classList.contains('toggle-content')) targetClass = '.toggle-content';
        else if (contentDiv.classList.contains('sign-content')) targetClass = '.sign-content';
        else if (contentDiv.classList.contains('cube-content')) targetClass = '.cube-content';
        else if (contentDiv.classList.contains('card-desc-content')) targetClass = '.card-desc-content';

        window.lastCursorGPS = {
            active: true,
            type: 'content',
            containerId: wrapper.id,
            editableClass: targetClass,
            path: path,
            offset: selection.anchorOffset,
            timestamp: Date.now()
        };
        return;
    }

    // 3. ZONA SEGURA (Nota Principal) -> Desativa o GPS
    if (element.id === 'note-content-editor' || element.closest('#note-content-editor')) {
        window.lastCursorGPS.active = false; 
        window.lastCursorGPS.containerId = null;
    }
}



// 2. FUN√á√ÉO DE RESTAURO (Navega pelo HTML para achar o s√≠tio)
function restoreCursorFromGPS() {
    if (!window.lastCursorGPS.active) return;
    
    const gps = window.lastCursorGPS;
    const wrapper = document.getElementById(gps.containerId);

    if (!wrapper) return; 

    // --- RESTAURAR INPUT ---
    if (gps.type === 'input') {
        const input = wrapper.querySelector('input, textarea');
        if (input) {
            input.focus();
        }
    }

    // --- RESTAURAR CONTE√öDO ---
    else if (gps.type === 'content') {
        let contentDiv = null;
        if (gps.editableClass) contentDiv = wrapper.querySelector(gps.editableClass);
        if (!contentDiv) contentDiv = wrapper.querySelector('[contenteditable="true"]');

        if (contentDiv) {
            contentDiv.focus();

            let targetNode = contentDiv;
            let pathValid = true;

            for (const index of gps.path) {
                if (targetNode.childNodes && targetNode.childNodes[index]) {
                    targetNode = targetNode.childNodes[index];
                } else {
                    pathValid = false;
                    break;
                }
            }

            const sel = window.getSelection();
            const range = document.createRange();

            if (pathValid) {
                try {
                    const maxOffset = targetNode.length || targetNode.childNodes.length || 0;
                    const safeOffset = Math.min(gps.offset, maxOffset);
                    range.setStart(targetNode, safeOffset);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } catch (e) {
                    placeCaretAtEnd(contentDiv);
                }
            } else {
                placeCaretAtEnd(contentDiv);
            }
        }
    }
}

// Auxiliar para colocar cursor no fim
function placeCaretAtEnd(el) {
    el.focus();
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
}

// 3. LISTENERS CONSTANTES (Para manter o GPS atualizado)
const editorForGPS = document.getElementById('note-content-editor');

if (editorForGPS) {
    // Passamos a fun√ß√£o diretamente para receber o argumento 'e'
    editorForGPS.addEventListener('keyup', trackCursorPosition);
    editorForGPS.addEventListener('mouseup', trackCursorPosition);
    editorForGPS.addEventListener('input', trackCursorPosition);
    
    // O evento CR√çTICO para a sua corre√ß√£o
    editorForGPS.addEventListener('mousedown', trackCursorPosition);
    
    editorForGPS.addEventListener('touchend', (e) => setTimeout(() => trackCursorPosition(e), 100));
}

// 4. GATILHO DE REGRESSO (Quando volta √† aba)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        setTimeout(() => {
            console.log("üëÅÔ∏è Aba vis√≠vel. GPS restaurando posi√ß√£o exata...");
            restoreCursorFromGPS();
        }, 150);
    }
});

// Refor√ßo ao focar a janela
window.addEventListener('focus', () => {
    setTimeout(restoreCursorFromGPS, 150);
});
// ============================================================
// MOTOR DE SCROLLSPY (√çNDICE AUTOM√ÅTICO) - VERS√ÉO √öNICA
// ============================================================

// Vari√°vel de controlo (s√≥ pode haver uma destas no c√≥digo todo)
// Se j√° tiver "let currentActiveScrollId" l√° em cima nas vari√°veis globais, apague esta linha.
// Se n√£o tiver, deixe estar.
var currentActiveScrollId = null; 

// 1. OUVINTE DE SCROLL NO EDITOR
const spyEditor = document.getElementById('note-content-editor');

if (spyEditor) {
    // Removemos listener antigo para garantir que n√£o duplica
    spyEditor.onscroll = null; 
    
    spyEditor.addEventListener('scroll', () => {
        // Usa requestAnimationFrame para ser suave e n√£o travar o browser
        requestAnimationFrame(detectActiveScrollElement);
    });
}

// 2. FUN√á√ÉO DE C√ÅLCULO
function detectActiveScrollElement() {
    const editor = document.getElementById('note-content-editor');
    const list = document.getElementById('note-index-list');
    
    // S√≥ executa se a lista do √≠ndice estiver vis√≠vel no ecr√£
    // (Ou se estivermos no mobile com o modal aberto)
    const isMobileModalOpen = document.getElementById('mobile-views-modal')?.style.display === 'flex';
    if (!editor || (!isMobileModalOpen && (!list || list.style.display === 'none'))) return;

    // Seleciona todos os itens que aparecem no √≠ndice
    const targets = editor.querySelectorAll('.mini-note-wrapper, .redator-wrapper, details.toggle-section, .jwn-table-wrapper, .jwn-timeline-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .post-it-note');
    
    if (targets.length === 0) return;

    // Ponto de gatilho: 150px abaixo do topo do editor (zona de leitura)
    const triggerPoint = editor.scrollTop + 150; 
    
    let activeId = null;

    // A. Verifica se chegou ao fundo da p√°gina (Seleciona o √∫ltimo obrigatoriamente)
    // Margem de 50px para garantir
    if (Math.ceil(editor.scrollTop + editor.clientHeight) >= editor.scrollHeight - 50) {
        const lastItem = targets[targets.length - 1];
        activeId = lastItem.id;
    } 
    // B. C√°lculo normal
    else {
        for (let i = 0; i < targets.length; i++) {
            const el = targets[i];
            // Se a posi√ß√£o do elemento for menor que a linha de leitura, √© o candidato atual
            if (el.offsetTop < triggerPoint) {
                activeId = el.id; 
            } else {
                // Se j√° passou, paramos. O anterior era o correto.
                break; 
            }
        }
    }

    // Se estamos no topo e nada passou a linha, ativa o primeiro
    if (!activeId && targets.length > 0) {
        activeId = targets[0].id;
    }

    // S√≥ atualiza o visual se o ID mudou (Performance)
    if (activeId && currentActiveScrollId !== activeId) {
        currentActiveScrollId = activeId;
        updateIndexVisuals();
    }
}

// 3. ATUALIZA√á√ÉO VISUAL (Pinta de Azul e Mexe a Lista)
function updateIndexVisuals() {
    // Tenta atualizar a lista do PC
    const pcList = document.getElementById('note-index-list');
    applyVisualsToList(pcList);

    // Tenta atualizar a lista do Mobile (se o modal estiver aberto)
    const mobileList = document.getElementById('mobile-views-content');
    if (mobileList) {
        applyVisualsToList(mobileList);
    }
}

// Fun√ß√£o auxiliar para aplicar o estilo em qualquer lista
function applyVisualsToList(listContainer) {
    if (!listContainer || listContainer.style.display === 'none') return;

    // 1. Limpa apenas o ESTILO DE SELE√á√ÉO (Fundo), mantendo a borda original
    listContainer.querySelectorAll('.index-item').forEach(li => {
        li.classList.remove('active-scroll');
        li.style.backgroundColor = ""; 
        // NOTA: Removemos a linha que limpava o borderLeft
    });

    // 2. Aplica novo estilo de sele√ß√£o (Apenas Fundo)
    if (currentActiveScrollId) {
        const activeLi = listContainer.querySelector(`.index-item[data-target-id="${currentActiveScrollId}"]`);
        
        if (activeLi) {
            activeLi.classList.add('active-scroll');
            // Fundo azul suave para indicar onde estamos
            activeLi.style.backgroundColor = "rgba(74, 144, 226, 0.15)"; 
            
            // Opcional: Se quiseres que a borda fique "Brilhante" ou "Mais Grossa" ao selecionar:
            // activeLi.style.borderLeftWidth = "6px"; 
            
            // --- A M√ÅGICA: OBRIGA A LISTA A RODAR ---
            activeLi.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Fun√ß√£o para carregar itens da aba Flash
function loadFlashItems() {
    const listElement = document.getElementById('file-list');
    if (!auth.currentUser) return;

    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar Flash...</span></div>';

    // Query para buscar TUDO o que tem "oque == 'flash'", independentemente da pasta
    const q = query(
        collection(db, 'pastas'),
        where('userId', '==', auth.currentUser.uid),
        where('oque', '==', 'flash'), // FILTRO CR√çTICO
        where('estado', '==', 'ativa'),
        orderBy('ultimaedicao', 'desc') // Ordenar por mais recente primeiro
    );

    // Usa onSnapshot para atualiza√ß√£o em tempo real
    unsubscribeMiddlePanel = onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        
        if (querySnapshot.empty) {
            listElement.innerHTML = `
                <li style="padding:40px 20px; text-align:center; color:#e67e22; list-style:none;">
                    <div style="font-size:30px; margin-bottom:10px;">‚ö°</div>
                    <strong>Sem Itens Flash</strong><br>
                    <small style="color:var(--text-muted-color);">Tudo o que criar aqui aparecer√° nesta lista r√°pida.</small>
                </li>`;
            return;
        }

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Adiciona a classe para borda laranja se estiver selecionado
            if (item.id === selectedNoteId) li.classList.add('selected-orange'); // Vamos criar este estilo CSS
            
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo);
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-oque', item.oque || ""); 
            
            // √çcone baseado no tipo
            let icon = 'üìÑ';
            if (item.tipo === 'jornal') icon = 'üì∞';
            
            li.innerHTML = `<span>${icon} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            // L√≥gica de clique (igual √† normal)
            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                
                // Limpa sele√ß√µes
                listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red', 'selected-orange'));
                li.classList.add('selected-orange');
                
                if (window.innerWidth <= 768) {
                    document.body.classList.add('mobile-view-editor');
                }
                
                displayNote(item.id, li);
            };

            listElement.appendChild(li);
        });
    });
}

function loadFlashListLeftPanel() {
    const listElement = document.getElementById('left-panel-list');
    if (!auth.currentUser) return;

    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

    // Ordenamos pela √∫ltima edi√ß√£o para as mais recentes ficarem no topo
    const q = query(
        collection(db, 'pastas'),
        where('userId', '==', auth.currentUser.uid),
        where('oque', '==', 'flash'),
        where('estado', '==', 'ativa'),
        orderBy('ultimaedicao', 'desc')
    );

    unsubscribeLeftPanel = onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        
        if (querySnapshot.empty) {
            listElement.innerHTML = `
                <li style="padding:20px; text-align:center; color:#666; font-style:italic;">
                    Sem itens Flash.
                </li>`;
            return;
        }

        // Vari√°vel para controlar a mudan√ßa de m√™s
        let currentMonthYear = null;

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            
            // --- 1. L√ìGICA DE AGRUPAMENTO POR DATA ---
            // Usa a data de edi√ß√£o (para coincidir com a ordem da lista) ou cria√ß√£o como fallback
            const timestamp = item.ultimaedicao?.toMillis() || item.createdAt?.toMillis() || Date.now();
            const dateObj = new Date(timestamp);
            
            // Formata: "janeiro 2026"
            const monthYearString = dateObj.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
            
            // Se o m√™s mudou em rela√ß√£o ao item anterior, insere o cabe√ßalho
            if (monthYearString !== currentMonthYear) {
                currentMonthYear = monthYearString;
                
                const headerLi = document.createElement('li');
                // Estilo "Pequeno Visualmente": Cinzento, letras pequenas, espa√ßamento no topo
                headerLi.style.cssText = `
                    font-size: 10px; 
                    text-transform: uppercase; 
                    color: var(--text-muted-color); 
                    font-weight: bold; 
                    padding: 15px 10px 5px 10px; /* Mais espa√ßo em cima para separar grupos */
                    letter-spacing: 1px; 
                    cursor: default; 
                    pointer-events: none; /* N√£o clic√°vel */
                    opacity: 0.6;
                `;
                headerLi.textContent = monthYearString;
                listElement.appendChild(headerLi);
            }
            // -----------------------------------------

            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Borda Laranja Lateral
            li.style.borderLeft = "4px solid #e67e22"; 
            
            if (item.id === selectedNoteId) li.classList.add('selected-orange');
            
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo); 
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-oque', item.oque || "");

            // √çcone diferente para Jornais
            let icon = 'üìÑ';
            if (item.tipo === 'jornal') icon = 'üì∞';

            li.innerHTML = `<span>${icon} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                
                document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red', 'selected-orange'));
                li.classList.add('selected-orange');
                
                displayNote(item.id, li);
                
                if (window.innerWidth <= 768) {
                    document.body.classList.add('mobile-view-editor');
                }
            };

            listElement.appendChild(li);
        });
    });
}

function startGlobalNotificationListener() {
    if (!auth.currentUser) return;
    const myUid = auth.currentUser.uid;

    // 1. OUVINTE DE LEITURAS (O que eu j√° vi)
    onSnapshot(collection(db, 'users', myUid, 'archive_reads'), (readSnap) => {
        const lastSeenMap = {};
        readSnap.forEach(doc => {
            lastSeenMap[doc.id] = doc.data().lastSeen || 0;
        });
        
        // Atualiza a mem√≥ria
        userLastSeenArchives = lastSeenMap;
        
        // Recalcula a bola
        recalcGlobalNotification();
    });

    // 2. OUVINTE DE PASTAS (O que existe)
    const q1 = query(
        collection(db, 'pastas'), 
        where('tipo', 'in', ['partilhado', 'arquivo']), 
        where('estado', '==', 'ativa')
    );
    
    onSnapshot(q1, (folderSnap) => {
        const folders = [];
        folderSnap.forEach(doc => {
            folders.push({ id: doc.id, ...doc.data() });
        });

        // Atualiza a mem√≥ria
        globalFoldersCache = folders;

        // Recalcula a bola
        recalcGlobalNotification();
    });
}

// 3. FUN√á√ÉO DE C√ÅLCULO CENTRALIZADA
function recalcGlobalNotification() {
    const myUid = auth.currentUser.uid;
    let hasNew = false;
    
    // Margem de erro de 2 segundos
    const TIME_BUFFER = 2000; 

    console.groupCollapsed("üïµÔ∏è DEBUG: An√°lise da Bola Vermelha");

    globalFoldersCache.forEach(data => {
        // Filtro de Seguran√ßa
        const isOwner = data.userId === myUid;
        const isCollab = data.colaboradores && data.colaboradores[myUid];

        if (isOwner || isCollab) {
            const id = data.id;
            const lastSeen = userLastSeenArchives[id] || 0;
            const lastEdit = data.ultimaedicao?.toMillis() || 0;
            const lastEditor = data.lastEditorId; // Pode ser undefined em ficheiros antigos

            // Condi√ß√£o 1: Tem de ter sido editado DEPOIS de eu ver (+ buffer)
            if (lastEdit > (lastSeen + TIME_BUFFER)) {
                
                // --- NOVA L√ìGICA DE FILTRAGEM ---
                
                // CASO A: Sabemos quem editou (Sistema Novo)
                if (lastEditor) {
                    if (lastEditor !== myUid) {
                        hasNew = true;
                        console.log(`üî¥ Novo (Com Editor): ${data.nome}`);
                    }
                } 
                // CASO B: N√£o sabemos quem editou (Ficheiros Antigos / Legado)
                else {
                    // S√≥ notificamos se eu J√Å TIVER ABERTO o ficheiro antes (lastSeen > 0).
                    // Se lastSeen for 0, √© um ficheiro antigo que eu nunca abri neste sistema, 
                    // por isso ignoramos para n√£o causar spam de notifica√ß√£o.
                    if (lastSeen > 0 && !isOwner) {
                        hasNew = true;
                        console.log(`üî¥ Novo (Legado mas j√° visto): ${data.nome}`);
                    } else {
                        console.log(`‚ö™ Ignorado (Legado/Nunca visto): ${data.nome}`);
                    }
                }
            }
        }
    });

    console.log(`üèÅ Bola ligada? ${hasNew}`);
    console.groupEnd();

    // Atualiza a vari√°vel global e a UI
    hasGlobalShareNotification = hasNew;
    updateShareTabDot();
}

// Fun√ß√£o visual (Mant√©m-se igual, mas garante que existe)
function updateShareTabDot() {
    // Procura o elemento da aba Share
    const shareTab = Array.from(document.querySelectorAll('.folder-mode-item')).find(el => el.textContent.includes('Share'));
    
    if (shareTab) {
        let dot = shareTab.querySelector('.tab-notification-dot');
        if (!dot) {
            dot = document.createElement('div');
            dot.className = 'tab-notification-dot';
            shareTab.appendChild(dot);
        }

        if (hasGlobalShareNotification) {
            dot.classList.add('visible');
        } else {
            dot.classList.remove('visible');
        }
    }
}

// Fun√ß√£o para limpar refer√™ncias de uma nota inteira em todas as entidades conectadas
async function cleanUpHiddenNoteReferences(noteId) {
    if (!noteId) return;
    console.log(`üßπ [LIMPEZA GLOBAL] Removendo refer√™ncias da nota ${noteId} nos Puzzles...`);

    try {
        const { collection, query, where, getDocs, doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const myUid = auth.currentUser.uid;

        // Lista de cole√ß√µes que podem ter Puzzles
        const collectionsToCheck = ['textosbiblicos', 'topicos', 'personagens', 'locais', 'cosmos', 'subcosmos'];

        for (const colName of collectionsToCheck) {
            // Procura entidades que tenham esta nota referenciada
            const q = query(
                collection(db, colName),
                where(`referencias.${noteId}`, '==', true),
                where('userId', '==', myUid)
            );

            const snap = await getDocs(q);

            // Processa em paralelo
            const updatePromises = snap.docs.map(async (docSnap) => {
                const data = docSnap.data();
                let puzzleBoard = data.puzzleBoard || [];
                const initialLen = puzzleBoard.length;

                // Remove TODOS os cart√µes que venham desta nota
                puzzleBoard = puzzleBoard.filter(item => item.noteId !== noteId);

                if (puzzleBoard.length !== initialLen) {
                    console.log(`   - Atualizando entidade: ${data.nome} (${colName})`);
                    const docRef = doc(db, colName, docSnap.id);
                     // Atualiza
    await updateDoc(docRef, { puzzleBoard: puzzleBoard });

    // >>> LINHA NOVA: Verifica se ficou vazio <<<
    if (colName === 'textosbiblicos') {
        await checkAndCleanVerseState(docSnap.id);
    }
                    
                    return updateDoc(docRef, { puzzleBoard: puzzleBoard });
                }
            });

            await Promise.all(updatePromises);
        }
        console.log("‚úÖ Limpeza global conclu√≠da.");

    } catch (e) {
        console.error("‚ùå Erro na limpeza global:", e);
    }
}

// --- CONFIGURA√á√ÉO DA PESQUISA DE CATEGORIAS (ABRIR COM O ‚ö°) ---

// 1. Listener para quando se escreve na caixa de texto
const catSearchInput = document.getElementById('category-search-input');
if (catSearchInput) {
    // Removemos clones antigos para evitar duplicar pesquisas
    const newInput = catSearchInput.cloneNode(true);
    catSearchInput.parentNode.replaceChild(newInput, catSearchInput);

    newInput.addEventListener('input', (e) => {
        // Chama a fun√ß√£o de pesquisa com o que est√° escrito
        searchCategories(e.target.value);
    });
}

// 2. Listener para o Toggle (Interruptor) da B√≠blia
const bibleSearchToggle = document.getElementById('search-bible-toggle');
if (bibleSearchToggle) {
    bibleSearchToggle.addEventListener('change', () => {
        // Quando muda o interruptor, refaz a pesquisa com o texto que j√° l√° est√°
        const currentText = document.getElementById('category-search-input').value;
        searchCategories(currentText);
        
        // Foca novamente na caixa para continuar a escrever
        document.getElementById('category-search-input').focus();
    });
}

// ============================================================
// CORRE√á√ÉO: CLIQUES NOS DIAS DO CALEND√ÅRIO
// ============================================================
document.getElementById('note-content-editor').addEventListener('click', (e) => {
    // Verifica se clicou num dia (que n√£o esteja vazio)
    const dayBtn = e.target.closest('.cal-day');
    
    if (dayBtn && !dayBtn.classList.contains('empty')) {
        e.preventDefault();
        e.stopPropagation(); // Impede que o editor tente fazer outra coisa

        const widget = dayBtn.closest('.jwn-calendar-widget');
        if (!widget) return;

        // 1. Obter dados
        const day = parseInt(dayBtn.dataset.day);
        const month = parseInt(widget.dataset.month); // 0 a 11
        const year = parseInt(widget.dataset.year);

        // 2. Formatar data segura (YYYY-MM-DD)
        // Usamos String padStart para garantir "2024-05-01" e n√£o "2024-5-1"
        const dateISO = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        console.log("üìÖ Abrindo agenda para:", dateISO);

        // 3. Abrir o Modal
        if (typeof openCalendarModal === 'function') {
            openCalendarModal(dateISO, widget);
        } else {
            console.error("Erro: Fun√ß√£o openCalendarModal n√£o encontrada.");
        }
    }
});

// ============================================================
// L√ìGICA DO BOT√ÉO TR√äS PONTOS (‚ãÆ) - COM PROTE√á√ÉO DE CURSOR
// ============================================================
const moreFormattingBtn = document.getElementById('more-formatting-btn');

if (moreFormattingBtn) {
    // 1. Clonar para limpar ouvintes antigos e garantir exclusividade
    const newBtn = moreFormattingBtn.cloneNode(true);
    moreFormattingBtn.parentNode.replaceChild(newBtn, moreFormattingBtn);

    // 2. OUVINTE DE MOUSEDOWN (O Segredo para n√£o perder o cursor)
    newBtn.addEventListener('mousedown', (e) => {
        // A. Esta linha impede que o bot√£o roube o foco do editor
        e.preventDefault(); 
        // B. P√°ra a propaga√ß√£o para n√£o ativar outros listeners
        e.stopPropagation();

        // C. Guarda a posi√ß√£o exata do cursor numa vari√°vel global
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const editor = document.getElementById('note-content-editor');

            // S√≥ guarda se o cursor estiver realmente dentro do editor ou de um t√≠tulo
            if (editor && editor.contains(range.commonAncestorContainer)) {
                window.journalCursorRange = range.cloneRange();
                console.log("üìç Cursor guardado antes de abrir menu.");
            }
        }
    });

    // 3. OUVINTE DE CLIQUE (Abrir o Menu)
    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const popup = document.getElementById('formatting-popup');
        if (!popup) return;

        const isVisible = popup.style.display === 'block';

        if (isVisible) {
            popup.style.display = 'none';
            newBtn.classList.remove('active');
        } else {
            // FOR√áA O POPUP PARA O TOPO (Body) para evitar cortes
            document.body.appendChild(popup);

            const rect = newBtn.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed';
            popup.style.zIndex = "9999999";

            // Posicionamento inteligente (evita sair do ecr√£ √† direita)
            let leftPos = rect.left;
            if (leftPos + 250 > window.innerWidth) {
                leftPos = window.innerWidth - 260;
            }

            // Posiciona logo abaixo do bot√£o
            popup.style.top = `${rect.bottom + 8}px`;
            popup.style.left = `${leftPos}px`;

            newBtn.classList.add('active');
        }
    });
}

// ============================================================
// FUN√á√ÉO: CONFIRMAR E ARQUIVAR RACIOC√çNIO (ü™ß)
// ============================================================
window.confirmSignDelete = async function(btn) {
    const wrapper = btn.closest('.journal-sign-wrapper');
    if (!wrapper) return;

    // 1. AJUSTE DE Z-INDEX
    // Garante que o modal de confirma√ß√£o fica por cima de tudo
    const confirmModal = document.getElementById('confirm-modal');
    if (confirmModal) {
        confirmModal.style.setProperty('z-index', '2147483647', 'important');
    }

    // 2. MOSTRAR POPUP
    const confirmed = await showConfirmation(
        "Mover para a Reciclagem?", 
        "O Racioc√≠nio ser√° removido da nota e guardado no Hist√≥rico (Gest√£o da Nota). Deseja continuar?"
    );

    // 3. RESET DO Z-INDEX
    if (confirmModal) {
        confirmModal.style.zIndex = ""; 
    }

    // 4. SE CONFIRMADO, ARQUIVAR
    if (confirmed) {
        // Muda o √≠cone para feedback visual
        btn.textContent = "‚è≥";
        btn.style.opacity = "1";
        
        // Chama a fun√ß√£o de arquivo existente passando 'true' para saltar logs extras
        await window.archiveMiniNote(wrapper, true);
    }
};

// ============================================================
// FUN√á√ÉO EM FALTA: APAGAR CART√ÉO E CUBO (ü™™ üßä)
// ============================================================
window.deleteJournalWidget = async function(btn) {
    // 1. Procura o elemento pai (Cart√£o ou Cubo)
    const wrapper = btn.closest('.journal-id-card, .journal-cube-wrapper');

    if (!wrapper) {
        console.error("‚ùå Erro: Wrapper do widget n√£o encontrado.");
        return;
    }

    // 2. Ajuste de Z-Index para o popup aparecer por cima de tudo
    const confirmModal = document.getElementById('confirm-modal');
    if (confirmModal) {
        confirmModal.style.setProperty('z-index', '2147483647', 'important');
    }

    // 3. Define o nome do item para a mensagem
    let label = "Item";
    if (wrapper.classList.contains('journal-id-card')) label = "Cart√£o Tem√°tico";
    else if (wrapper.classList.contains('journal-cube-wrapper')) label = "Bloco Flutuante";

    // 4. Pede confirma√ß√£o
    const confirmed = await showConfirmation(
        "Mover para a Reciclagem?",
        `O ${label} ser√° removido e guardado no Hist√≥rico. Deseja continuar?`
    );

    // 5. Restaura o Z-Index
    if (confirmModal) {
        confirmModal.style.zIndex = "";
    }

    // 6. Executa o arquivo
    if (confirmed) {
        // Feedback visual tempor√°rio
        btn.textContent = "‚è≥";
        
        // Chama a fun√ß√£o principal de arquivo (que j√° atualiz√°mos para reconhecer 'card')
        await window.archiveMiniNote(wrapper, true);
    }
};

// ============================================================
// OBSERVADOR AUTOM√ÅTICO DO √çNDICE (ATUALIZA√á√ÉO EM TEMPO REAL)
// ============================================================

// 1. Configura√ß√£o do Observador
const indexObserver = new MutationObserver((mutations) => {
    const indexList = document.getElementById('note-index-list');
    
    if (!indexList || indexList.style.display === 'none') return;

    let shouldUpdate = false;

    for (const mutation of mutations) {
        if (mutation.type === 'childList') {
            if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
                
                const relevantChanges = Array.from(mutation.addedNodes).some(node => {
                    return node.nodeType === 1 && ( 
                        node.classList.contains('mini-note-wrapper') ||
                        node.classList.contains('redator-wrapper') ||
                        node.classList.contains('idea-span') || // <--- ADICIONADO AQUI
                        node.tagName === 'DETAILS' ||
                        node.classList.contains('journal-sign-wrapper') ||
                        node.classList.contains('journal-id-card') ||
                        node.classList.contains('jwn-timeline-wrapper') ||
                        node.classList.contains('jwn-table-wrapper') ||
                        node.classList.contains('post-it-note')
                    );
                });

                if (relevantChanges || mutation.removedNodes.length > 0) {
                    shouldUpdate = true;
                    break; 
                }
            }
        }
    }

    if (shouldUpdate) {
        setTimeout(() => {
            generateNoteIndex();
            if (typeof updateIndexVisuals === 'function') updateIndexVisuals();
        }, 100);
    }
});


// 4. Ligar o Observador ao Editor
const editorToObserve = document.getElementById('note-content-editor');

if (editorToObserve) {
    indexObserver.observe(editorToObserve, { 
        childList: true, // Vigia adi√ß√£o/remo√ß√£o de filhos diretos
        subtree: true    // Vigia tamb√©m dentro de divs (caso a estrutura seja complexa)
    });
}

window.manageAquariumTextLink = function(existingLinkElement, registryData = null) {
    const modal = document.getElementById('text-link-modal');
    const titleInput = document.getElementById('text-link-name');
    const listContainer = document.getElementById('text-link-list');
    const addBtn = document.getElementById('add-text-url-btn');
    const saveBtn = document.getElementById('save-text-link-btn');
    const actionsDiv = modal.querySelector('.modal-actions');

    if (!modal) return;

    // 1. Guardar sele√ß√£o
    const selection = window.getSelection();
    let savedRange = null;
    if (selection.rangeCount > 0) {
        savedRange = selection.getRangeAt(0).cloneRange();
    }

    // 2. Preparar Interface
    listContainer.innerHTML = ''; 
    
    const addRow = (value = "") => {
        const div = document.createElement('div');
        div.className = 'dynamic-url-row';
        const openBtn = value ? `<button class="btn-remove-url" style="border-color:#555; color:#888;" onclick="window.open('${value}', '_blank')" title="Testar Link">‚Üó</button>` : '';
        div.innerHTML = `
            <input type="text" placeholder="https://..." value="${value}">
            ${openBtn}
            <button class="btn-remove-url" onclick="this.parentElement.remove()" title="Remover Link">√ó</button>
        `;
        listContainer.appendChild(div);
        if (!value) setTimeout(() => div.querySelector('input').focus(), 50);
    };

    // 3. Preencher Dados
    let linkUID = null;
    let initialData = { title: "", urls: [] };

    if (existingLinkElement) {
        linkUID = existingLinkElement.dataset.uid || `lnk_${Date.now()}`;
        const rawJson = existingLinkElement.dataset.json;
        try {
            if (rawJson) initialData = JSON.parse(decodeURIComponent(rawJson));
            else initialData.urls = [existingLinkElement.href];
        } catch(e) {}
        
        // Usa o t√≠tulo guardado no JSON, ou o texto se n√£o houver t√≠tulo ainda
        initialData.title = initialData.title || existingLinkElement.textContent;
    } 
    else if (registryData) {
        linkUID = registryData.uid;
        initialData = registryData;
    }
    else {
        linkUID = `lnk_${Date.now()}`;
        initialData.title = selection.toString().trim();
    }

    titleInput.value = initialData.title;
    
    if (initialData.urls && initialData.urls.length > 0) {
        initialData.urls.forEach(url => addRow(url));
    } else {
        addRow();
    }

    // 4. Mostrar Modal
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "2147483647";
    modal.style.opacity = "1";
    modal.style.visibility = "visible";

    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.onclick = (e) => { e.preventDefault(); addRow(); };

    // 5. INJETAR BOT√ÉO DE ELIMINAR (Mant√©m a l√≥gica anterior)
    const oldDelBtn = actionsDiv.querySelector('.btn-delete-link-ref');
    if (oldDelBtn) oldDelBtn.remove();

    if (existingLinkElement || registryData) {
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete-link-ref';
        delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.title = "Apagar Refer√™ncia";
        actionsDiv.insertBefore(delBtn, actionsDiv.firstChild);

        delBtn.onclick = async () => {
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) confirmModal.style.zIndex = "2147483650";
            const confirmed = await showConfirmation("Apagar Refer√™ncia?", "Remover o link e o registo?");
            if (confirmModal) confirmModal.style.zIndex = "";

            if (confirmed) {
                const { doc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, { [`textLinksRegistry.${linkUID}`]: deleteField() });

                if (existingLinkElement) {
                    const textNode = document.createTextNode(existingLinkElement.textContent);
                    existingLinkElement.replaceWith(textNode);
                } else {
                    const orphan = document.querySelector(`a[data-uid="${linkUID}"]`);
                    if (orphan) {
                        const tNode = document.createTextNode(orphan.textContent);
                        orphan.replaceWith(tNode);
                    }
                }
                if (typeof saveAquariumState === 'function') await window.saveAquariumState();
                const linksTab = document.querySelector('.aq-tab[data-tab="links"]');
                if (linksTab && linksTab.classList.contains('active')) {
                     if (typeof window.renderAquariumLinks === 'function') window.renderAquariumLinks();
                }
                modal.style.display = 'none';
            }
        };
    }

    // 6. BOT√ÉO GRAVAR (CORRIGIDO)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const titleVal = titleInput.value.trim();
        const urls = [];
        listContainer.querySelectorAll('input').forEach(inp => {
            let u = inp.value.trim();
            if (u) {
                if (!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (savedRange) {
            selection.removeAllRanges();
            selection.addRange(savedRange);
        }

        const { doc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);

        if (urls.length === 0) {
            alert("A lista est√° vazia. Use o lixo para apagar.");
            return;
        } 

        const finalData = { uid: linkUID, title: titleVal, urls: urls, timestamp: Date.now() };
        const jsonString = encodeURIComponent(JSON.stringify(finalData));
        const primaryUrl = urls[0];

        // A. Atualizar Existente
        if (existingLinkElement) {
            existingLinkElement.href = primaryUrl;
            existingLinkElement.dataset.json = jsonString;
            existingLinkElement.dataset.uid = linkUID;
            existingLinkElement.className = 'silent-link';
            existingLinkElement.style.cursor = 'text';
            
            // --- CORRE√á√ÉO: N√ÉO ATUALIZA O TEXTCONTENT ---
            // existingLinkElement.textContent = titleVal; // <--- REMOVIDO
        } 
        // B. Criar Novo
        else if (!registryData) {
            const tempHref = "temp_id_" + Date.now();
            document.execCommand('createLink', false, tempHref);
            const createdAnchor = document.querySelector(`a[href="${tempHref}"]`);

            if (createdAnchor) {
                createdAnchor.href = primaryUrl;
                createdAnchor.className = 'silent-link';
                createdAnchor.dataset.uid = linkUID;
                createdAnchor.dataset.json = jsonString;
                createdAnchor.style.cursor = 'text';
                createdAnchor.target = "_blank";
                
                // --- CORRE√á√ÉO: N√ÉO FOR√áA O T√çTULO NA CRIA√á√ÉO ---
                // O texto selecionado mant√©m-se como est√°
            }
        }
        else {
             // Atualiza via Sidebar: Apenas atributos, n√£o texto visual
             const el = document.querySelector(`a[data-uid="${linkUID}"]`);
             if (el) {
                 el.dataset.json = jsonString;
                 el.href = primaryUrl;
                 // el.textContent = titleVal; // <--- REMOVIDO
             }
        }

        await updateDoc(noteRef, { [`textLinksRegistry.${linkUID}`]: finalData });

        if (typeof saveAquariumState === 'function') await window.saveAquariumState();
        
        const linksTab = document.querySelector('.aq-tab[data-tab="links"]');
        if (linksTab && linksTab.classList.contains('active')) {
             if (typeof window.renderAquariumLinks === 'function') window.renderAquariumLinks();
        }

        modal.style.display = 'none';
    };
    
    const cancelBtn = document.getElementById('cancel-text-link-btn') || modal.querySelector('.secondary');
    if(cancelBtn) cancelBtn.onclick = () => { modal.style.display = 'none'; };
};

// Listener de clique para links "Silent" no Aqu√°rio
const aqCanvasLinkHandler = document.getElementById('aquarium-content-canvas');
if (aqCanvasLinkHandler) {
    // Removemos qualquer listener antigo clonando o elemento (seguran√ßa)
    /* 
       Nota: Se j√° tiveres outros listeners importantes no canvas que n√£o queres perder, 
       n√£o fa√ßas o cloneNode. Apenas garante que apagas o c√≥digo antigo que fazia window.open.
    */
    
    aqCanvasLinkHandler.addEventListener('click', (e) => {
        const link = e.target.closest('a.silent-link');
        
        if (link) {
            // 1. IMPEDE A NAVEGA√á√ÉO (N√£o abre nova aba)
            e.preventDefault(); 
            
            // 2. O comportamento padr√£o do browser em contenteditable 
            // j√° √© colocar o cursor onde clicaste, por isso n√£o precisamos de fazer mais nada.
            // Agora podes editar o texto livremente.
        }
    });
}

// Fun√ß√£o para mover blocos no Aqu√°rio
window.moveGhostBlock = function(block, direction) {
    const parent = block.parentNode;
    
    // Mover para CIMA
    if (direction === -1) {
        const prev = block.previousElementSibling;
        if (prev && prev.classList.contains('ghost-block')) {
            // Insere o bloco atual ANTES do anterior
            parent.insertBefore(block, prev);
            
            // Scroll suave para acompanhar o movimento
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Grava
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }
    } 
    // Mover para BAIXO
    else if (direction === 1) {
        const next = block.nextElementSibling;
        if (next && next.classList.contains('ghost-block')) {
            // Insere o bloco atual DEPOIS do seguinte (ou seja, antes do "seguinte do seguinte")
            parent.insertBefore(block, next.nextSibling);
            
            // Scroll suave
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Grava
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }
    }
};

// ============================================================
// ESPI√ÉO DE CLIQUES (DIAGN√ìSTICO)
// ============================================================
document.addEventListener('click', (e) => {
    // S√≥ nos interessa cliques dentro do canvas do aqu√°rio
    if (e.target.closest('#aquarium-content-canvas')) {
        
        // Verifica se √© um dos nossos bot√µes
        if (e.target.classList.contains('ghost-move-btn')) {
        } else if (e.target.classList.contains('ghost-add-between-btn')) {
        } else {
        }
        console.groupEnd();
    }
}, true); // 'true' = Fase de captura (apanha o clique antes de qualquer outra coisa)

// ============================================================
// INTERCETOR DE CLIQUES DE CONTROLO (FOR√áA BRUTA)
// ============================================================
document.getElementById('aquarium-content-canvas').addEventListener('click', (e) => {
    // Verifica se clicou num dos nossos bot√µes rebeldes
    const target = e.target.closest('.ghost-move-btn, .ghost-add-between-btn');
    
    if (target) {

        
        // 1. P√°ra tudo o que o browser ia fazer (como p√¥r o cursor)
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // 2. Encontra o bloco pai
        const ghost = target.closest('.ghost-block');
        if (!ghost) return;

        // 3. Executa a a√ß√£o manualmente
        if (target.classList.contains('ghost-add-between-btn')) {
            window.insertBlockBelow(ghost);
        }
        else if (target.textContent === '‚ñ≤') {
            window.moveGhostBlock(ghost, -1);
        }
        else if (target.textContent === '‚ñº') {
            window.moveGhostBlock(ghost, 1);
        }
        
        return false; // Garante que morre aqui
    }
}, true); // 'true' ativa a fase de captura (acontece antes de tudo!)

const aqZoom = document.getElementById('aq-zoom');

if (aqZoom) {
    // 1. Removemos clones antigos para evitar duplica√ß√£o de eventos
    const newAqZoom = aqZoom.cloneNode(true);
    aqZoom.parentNode.replaceChild(newAqZoom, aqZoom);

    // 2. Adicionamos o novo Listener
    newAqZoom.addEventListener('change', (e) => { 
        const val = e.target.value; // Ex: '100%' ou '18px'
        const canvas = document.getElementById('aquarium-content-canvas'); 
        
        if (canvas) {
            // A. Aplica o tamanho da fonte ao contentor principal
            canvas.style.fontSize = val;
            
            // B. Ajuste de altura da linha para melhor leitura
            if (val.includes('%')) {
                 canvas.style.lineHeight = '1.6'; // Padr√£o percentual
            } else {
                 const sizeNum = parseInt(val);
                 // Se for pixels, a linha deve ser maior que a fonte (1.5x)
                 if (!isNaN(sizeNum)) {
                     canvas.style.lineHeight = (sizeNum * 1.5) + 'px';
                 }
            }
            
            // C. Grava imediatamente o estado do aqu√°rio para persistir a mudan√ßa
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
    });
}

    </script>
</body>
</html>
