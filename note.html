<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Notebook Moderno</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/3182/3182548.png">
   
  
<style>
/* ============================================================
   VARI√ÅVEIS E RESET
   ============================================================ */
:root {
    --bg-color: #1a1a1d;
    --sidebar-color: #252528;
    --panel-color: #1f1f22;
    --accent-color: #4a90e2;
    --text-color: #f0f0f0;
    --text-muted-color: #888;
    --border-color: #333;
    --hover-color: #2c2c30;
    --selected-color: #3a5370;
    
    /* Cores Espec√≠ficas para Modos */
    --question-color: #1e8449;
    --question-bg: rgba(20, 90, 50, 0.08);
    --container-color: #e67e22; /* Laranja */
    --container-bg: rgba(230, 126, 34, 0.08);
    
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-color); 
    overflow: hidden; 
    height: 100vh; 
}

/* Scrollbars Modernas */
* { scrollbar-width: thin; scrollbar-color: var(--text-muted-color) var(--panel-color); }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--panel-color); border-radius: 10px; }
::-webkit-scrollbar-thumb {
    background-color: var(--text-muted-color); border-radius: 10px;
    border: 2px solid var(--panel-color);
}
::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

/* ============================================================
   ESTRUTURA PRINCIPAL (LAYOUT)
   ============================================================ */
.notebook-container { display: flex; height: 100vh; width: 100vw; }
#left-panel, #middle-panel, #right-panel { height: 100%; display: flex; flex-direction: column; }

/* 1. PAINEL ESQUERDO (PASTAS) */
#left-panel { 
    flex: 0 0 240px; 
    background-color: var(--sidebar-color); 
    border-right: 1px solid var(--border-color); 
    padding: 15px; 
    justify-content: space-between; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden;
}

/* 2. PAINEL DO MEIO (LISTA DE NOTAS) */
#middle-panel { 
    /* IGUAL √Ä PRIMEIRA COLUNA (240px) */
    flex: 0 0 240px; 
    
    background-color: var(--panel-color); 
    border-right: 1px solid var(--border-color); 
    padding: 20px; 
    transition: all 0.3s ease; 
    overflow: hidden;
}

/* 3. PAINEL DIREITO (EDITOR - A NOTA) */
#right-panel { 
    flex: 1; /* Ocupa o espa√ßo que sobrar */
    min-width: 0; /* CR√çTICO: Permite que o editor encolha quando a 4¬™ coluna abre */
    background-color: var(--bg-color); 
    padding: 20px; 
    position: relative; 
    transition: all 0.3s ease;
}

/* ============================================================
   4. PAINEL DE REFER√äNCIAS (4¬™ COLUNA) - AJUSTE DE TAMANHO
   ============================================================ */
#references-panel {
    flex: 0 0 0; 
    width: 0; 
    background-color: var(--sidebar-color); 
    padding: 0; 
    height: 100%;
    display: flex; 
    flex-direction: column; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden; 
    opacity: 0;
    border-left: 1px solid var(--border-color);
}

/* QUANDO ABERTO: FOR√áA 50% DA LARGURA DO ECR√É */
.notebook-container.references-panel-visible #references-panel {
    /* Mude de 50vw para 400px (ou o tamanho que preferir) */
    flex: 0 0 400px !important; 
    width: 400px !important;
    
    padding: 20px;
    border-left: 1px solid var(--border-color);
    opacity: 1;
}




/* ============================================================
   CORRE√á√ÉO DO BOT√ÉO TOGGLE ‚Üñ (COLLAPSE DA ESQUERDA)
   ============================================================ */

/* 1. Quando ativo, ESCONDE o painel esquerdo (Pastas) */
.notebook-container.middle-panel-collapsed #left-panel {
    display: none !important;
    width: 0 !important;
    flex: 0 0 0 !important;
    padding: 0 !important;
    border: none !important;
}

/* 2. O painel do Meio (Lista) mant√©m o tamanho normal */
.notebook-container.middle-panel-collapsed #middle-panel {
    width: 240px !important; 
    flex: 0 0 240px !important;
}

/* 3. O painel da Direita (Editor) ocupa todo o espa√ßo restante */
.notebook-container.middle-panel-collapsed #right-panel {
    display: flex !important;
    flex: 1 !important;
    opacity: 1 !important;
}

/* 4. Ajustes do Cabe√ßalho para manter tudo bonito */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header {
    display: flex !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
}

/* Garante que os bot√µes do cabe√ßalho continuam vis√≠veis */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header > * {
    display: flex !important;
}

/* ============================================================
   ELEMENTOS INTERNOS (Listas, Bot√µes, etc)
   ============================================================ */
.panel-content { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
#left-panel-list, #file-list { list-style-type: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }

/* Cabe√ßalhos e Rodap√©s de Painel */
.panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.panel-header h2 { font-size: 18px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
.panel-footer { padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }

/* Bot√µes de Controlo de Painel */
#left-panel-toggle-btn { display: none; background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 32px; height: 32px; border-radius: 5px; font-size: 20px; cursor: pointer; margin: 15px auto; }
#left-panel-toggle-btn:hover { background-color: var(--accent-color); }

#middle-panel-toggle-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; line-height: 1; margin-right: 10px; }
#middle-panel-toggle-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

#back-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; margin-right: 10px; }
#back-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

/* Tabs */
.tabs-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
.tabs-container button { background: none; border: none; color: var(--text-muted-color); padding: 10px; flex-grow: 1; text-align: center; font-size: 15px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
.tabs-container button:hover { background-color: var(--hover-color); color: var(--text-color); }
.tabs-container button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
#left-panel hr { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0 15px 0; }

/* Listas (Esquerda e Meio) */
.list-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s ease; display: flex; align-items: center; user-select: none; position: relative; }
.list-item:before { font-size: 18px; margin-right: 10px; }
.list-item[data-type="pasta"]:before { content: 'üìÅ'; }
.list-item[data-type="nota"]:before { content: 'üìÑ'; }
.list-item[data-type="agregacao"]:before { content: 'üß¨'; } 
.list-item:hover { background-color: var(--hover-color); }
.list-item.selected { background-color: var(--selected-color); }

/* Menu de 3 pontos no item */
.item-menu-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 20px; padding: 0 8px; border-radius: 5px; cursor: pointer; display: none; }
.list-item:hover .item-menu-btn { display: block; }
.item-menu-btn:hover { background-color: var(--bg-color); color: var(--text-color); }

/* Bot√µes de A√ß√£o Rodap√©/Topo */
#add-item-btn { background: none; border: 2px solid var(--accent-color); color: var(--accent-color); width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
#add-item-btn:hover { background-color: var(--accent-color); color: white; }
#settings-btn, #account-btn { background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; flex-grow: 1; text-align: center; padding: 5px; border-radius: 5px; }
#settings-btn:hover, #account-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* ============================================================
   CORRE√á√ÉO DE TEXTO LONGO NAS LISTAS (QUEBRA DE LINHA)
   ============================================================ */

/* 1. Garante que a lista nunca tem scroll horizontal */
#left-panel-list, #file-list {
    overflow-x: hidden !important;
}

/* 2. Ajuste no contentor do item para permitir altura vari√°vel */
.list-item {
    height: auto !important; /* Permite crescer em altura */
    min-height: 44px; /* Altura m√≠nima para ser clic√°vel */
    align-items: center !important; /* Mant√©m √≠cone centrado verticalmente */
}

/* 3. A regra principal: For√ßa o texto (span) a quebrar linha */
.list-item span {
    white-space: normal !important;   /* Permite quebra de linha */
    word-break: break-word !important; /* Quebra palavras muito longas */
    overflow-wrap: break-word !important; /* Standard moderno */
    line-height: 1.4 !important;      /* Espa√ßamento para leitura f√°cil */
    flex: 1;                          /* Ocupa o espa√ßo dispon√≠vel */
    padding-right: 5px;               /* Espa√ßo para n√£o colar √† direita */
}

/* ============================================================
   PAINEL DIREITO: EDITOR
   ============================================================ */
#editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted-color); text-align: center; height: 100%;}
#editor-placeholder .placeholder-icon { font-size: 60px; margin-bottom: 20px; }
#note-title-input { background: none; border: none; color: var(--text-color); font-size: 2.5em; font-weight: bold; padding: 10px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); outline: none; width: 100%; }

/* Barra de Ferramentas Principal */
#editor-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 6px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
}
.toolbar-group { display: flex; align-items: center; gap: 5px; }
#editor-toolbar button, #secondary-toolbar button {
    background: var(--hover-color); border: none; color: var(--text-color); min-width: 32px; height: 32px;
    padding: 0 8px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#editor-toolbar button:hover, #secondary-toolbar button:hover { background-color: var(--accent-color); }
#editor-toolbar input[type="color"], #secondary-toolbar input[type="color"] {
    width: 32px; height: 32px; border: none; background: none; cursor: pointer; padding: 2px;
}
.toolbar-separator { width: 1px; height: 25px; background-color: var(--border-color); margin: 0 10px; }
.toolbar-history { margin-left: auto; display: flex; align-items: center; }

/* Barra de Ferramentas Secund√°ria */
#secondary-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 0 0 6px 6px; margin-top: -10px; margin-bottom: 15px; flex-wrap: wrap;
    gap: 10px; border-top: 1px solid var(--border-color); animation: slideDown 0.2s ease-out;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
#toggle-more-tools-btn.active { background-color: var(--selected-color); transform: rotate(180deg); }

/* Zoom Select */
#editor-zoom {
    background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color);
    border-radius: 5px; padding: 0 5px; height: 32px; cursor: pointer; outline: none; font-size: 14px; margin-right: 5px;
}
#editor-zoom:hover { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
#editor-zoom option { background-color: var(--sidebar-color); color: var(--text-color); }

/* Conte√∫do Edit√°vel */
#note-content-editor {
    position: relative; 
    background: none; 
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; 
    padding: 5px;
    
    /* --- CORRE√á√ÉO PARA MOBILE --- */
    -webkit-overflow-scrolling: touch; /* Ativa o scroll suave (in√©rcia) no iPhone/Android */
    overscroll-behavior-y: contain;    /* Impede que o scroll "puxe" a p√°gina toda */
    touch-action: pan-y;               /* Melhora a dete√ß√£o do dedo para scroll vertical */
}

/* Adicione isto em qualquer lugar no seu CSS principal */
#note-content-editor {
    position: relative; 
    background: none; 
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    
    /* --- CORRE√á√ÉO DE SCROLL --- */
    flex: 1;                 /* Ocupa todo o espa√ßo restante */
    overflow-y: auto;        /* Ativa o scroll vertical AQUI */
    overflow-x: hidden; 
    min-height: 0;           /* Refor√ßo para o Firefox/Safari mobile */
    padding: 5px 5px 50px 5px; /* Padding extra no fundo para o teclado n√£o tapar texto */
    
    /* --- MOTOR DE TOQUE NATIVO --- */
    -webkit-overflow-scrolling: touch; 
    touch-action: pan-y;
}

#note-content-editor h1 { font-size: 2em; font-weight: bold; border-bottom: 1px solid var(--border-color); color: var(--accent-color); margin: 0.6em 0; }
#note-content-editor h2 { font-size: 1.5em; font-weight: bold; color: var(--text-color); margin: 0.5em 0; }
#note-content-editor h3 { font-size: 1.17em; font-weight: bold; color: var(--text-muted-color); margin-bottom: 0.5em; }
#note-content-editor h4 { font-size: 1em; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5em; }
#note-content-editor p { margin: 0.5em 0; }


/* Tags e Entidades no Texto */
.tag { background-color: var(--selected-color); color: var(--accent-color); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
.entity-link { background-color: rgba(74, 144, 226, 0.2); border-bottom: 1px dashed var(--accent-color); cursor: pointer; }
.entity-link[data-entity-type="personagem"] { background-color: rgba(230, 126, 34, 0.2); border-bottom-color: #e67e22; }
.entity-link[data-entity-type="local"] { background-color: rgba(46, 204, 113, 0.2); border-bottom-color: #2ecc71; }
.entity-link[data-entity-type="data"] { background-color: rgba(155, 89, 182, 0.2); border-bottom-color: #9b59b2; }
a[data-anexo-id] { color: inherit; text-decoration: none; border-bottom: 1px dotted var(--accent-color); cursor: pointer; }
.idea-span { text-decoration: underline; text-decoration-color: #e74c3c; text-decoration-thickness: 3px; cursor: pointer; background-color: rgba(231, 76, 60, 0.1); }
.idea-span:hover { background-color: rgba(231, 76, 60, 0.2); }

/* ============================================================
   POST-IT FLUTUANTE (Amarelo, Arrast√°vel)
   ============================================================ */
.post-it-note {
    position: absolute; display: flex; flex-direction: column;
    background-color: #fff9c4; border: 1px solid #f1c40f;
    resize: both; overflow: hidden; min-width: 150px; min-height: 80px;
    box-shadow: 4px 4px 10px rgba(0,0,0,0.2); z-index: 20;
}
.post-it-note::-webkit-resizer { background-color: #f1c40f; }
.post-it-note.active-note { border-color: #f39c12; z-index: 50; }

.post-it-drag-handle {
    position: absolute; top: 0; right: 0; width: 25px; height: 25px;
    background-color: #f1c40f; color: #333; cursor: grab; z-index: 10;
    display: flex; align-items: center; justify-content: center;
    border-bottom-left-radius: 4px; user-select: none;
}
.post-it-drag-handle:active { cursor: grabbing; background-color: #d4ac0d; }
.post-it-drag-handle:hover { background-color: #d4ac0d; }

.post-it-cut-btn {
    position: absolute; top: 0; left: 0; width: 25px; height: 25px;
    background-color: transparent; cursor: pointer; z-index: 100;
    display: none; align-items: center; justify-content: center;
    font-size: 16px; user-select: none; border-bottom-right-radius: 4px;
}
.post-it-note.active-note .post-it-cut-btn { display: flex; }
.post-it-cut-btn:hover { background-color: rgba(0,0,0,0.1); }

.post-it-content {
    background-color: transparent; color: #333; padding: 10px;
    height: 100%; width: 100%; outline: none; overflow-y: auto; cursor: text; user-select: text;
}

/* ============================================================
   MINI-NOTAS & QUEST√ïES (Embutidas no texto)
   ============================================================ */
/* Estilo Base (SubNota Padr√£o) */
.mini-note-wrapper {
    display: block; position: relative; margin: 30px -25px; width: auto;
    background-color: rgba(255, 255, 255, 0.03);
    border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
    padding: 20px 25px; box-sizing: border-box;
}
.mini-note-wrapper::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
    background: var(--accent-color); opacity: 0.8;
}

/* Modo Quest√£o (Verde) */
.mini-note-wrapper.question-mode {
    background-color: var(--question-bg);
    border-color: var(--question-color);
}
.mini-note-wrapper.question-mode::before { background: var(--question-color); }

/* Componentes Internos */
.mini-note-title-input {
    background: none; border: none; color: var(--accent-color);
    font-size: 1.4em; font-weight: bold; padding: 5px 0; margin-bottom: 15px;
    border-bottom: 1px solid var(--border-color); outline: none; width: 100%; font-family: inherit;
}
.mini-note-wrapper.question-mode .mini-note-title-input { color: var(--question-color); }

.mini-note-content {
    outline: none; min-height: 60px; font-size: 1em; line-height: 1.6; color: var(--text-color); padding: 5px;
}

.mini-note-toolbar {
    display: flex; justify-content: flex-end; background: transparent;
    padding: 0; margin-bottom: 5px; border: none; height: 30px;
}
.mini-note-toolbar button[data-action="delete-mini-note"] {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); color: #e74c3c; border-color: #e74c3c;
}
.mini-note-wrapper.question-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(30, 132, 73, 0.15); color: var(--question-color); border-color: var(--question-color);
}
/* Esconde bot√µes desnecess√°rios dentro da mini-nota */
.mini-note-toolbar button:not([data-action="sharing-settings"]):not([data-action="delete-mini-note"]):not([data-action="manage-mini-note-topics"]):not([data-action="highlight-color"]):not([data-action="append-mini-note"]):not([data-action="move-up"]):not([data-action="move-down"]),
.mini-note-toolbar input[type="color"],
.mini-note-toolbar .toolbar-separator { 
    display: none !important; 
}

/* Atualiza√ß√£o na sec√ß√£o .mini-note-toolbar */
.mini-note-toolbar button {
    background: none; 
    border: 1px solid var(--border-color); 
    color: var(--text-muted-color);
    width: 30px; 
    height: 30px; 
    border-radius: 4px; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s;
    margin-left: 5px; /* Espa√ßo entre bot√µes */
}

/* Hover espec√≠fico para o bot√£o de T√≥picos */
.mini-note-toolbar button[data-action="manage-mini-note-topics"]:hover {
    background-color: rgba(74, 144, 226, 0.1); 
    color: var(--accent-color); 
    border-color: var(--accent-color);
}

/* Mant√©m o hover vermelho para o lixo */
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); 
    color: #e74c3c; 
    border-color: #e74c3c;
}

/* Modo Contentor Livre (Laranja) */
.mini-note-wrapper.free-mode {
    background-color: var(--container-bg);
    border-color: var(--container-color);
}
.mini-note-wrapper.free-mode::before { 
    background: var(--container-color); 
}

/* Ajuste da Toolbar no modo livre (j√° que n√£o tem t√≠tulo, garantimos que fica no topo) */
.mini-note-wrapper.free-mode .mini-note-toolbar {
    margin-bottom: 0;
    padding-bottom: 5px;
}

/* Hover dos bot√µes no modo laranja */
.mini-note-wrapper.free-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(230, 126, 34, 0.15); 
    color: var(--container-color); 
    border-color: var(--container-color);
}

/* ============================================================
   POPUPS E MODAIS
   ============================================================ */
/* Popups Flutuantes (Sele√ß√£o e Inser√ß√£o) */
#selection-popup, #insertion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 30px; padding: 5px 10px; display: flex; gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4); align-items: center; z-index: 1010;
}
#selection-popup button, #insertion-popup button {
    background: none; border: none; color: var(--text-color); padding: 6px;
    cursor: pointer; border-radius: 50%; font-size: 18px; line-height: 1;
    transition: transform 0.2s, background-color 0.2s; width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
}
#selection-popup button:hover, #insertion-popup button:hover {
    background-color: var(--hover-color); transform: scale(1.15);
}
.popup-separator { width: 1px; height: 20px; background-color: var(--text-muted-color); opacity: 0.4; margin: 0 4px; }

/* Popup de Sugest√£o (Tags/Entidades) */
.suggestion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-height: 250px; overflow-y: auto; width: 350px;
}
.suggestion-list { list-style: none; padding: 5px; }
.suggestion-list li {
    padding: 8px 12px; border-radius: 4px; cursor: pointer; color: var(--text-color);
    display: flex; align-items: center;
}
.suggestion-list li:hover, .suggestion-list li.selected { background-color: var(--accent-color); color: white; }
#entity-suggestion-popup .suggestion-list li span { margin-left: auto; padding-left: 1em; }
#entity-suggestion-popup .suggestion-list li:hover span, #entity-suggestion-popup .suggestion-list li.selected span { color: white !important; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="personagem"] span { color: #e67e22; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="local"] span { color: #2ecc71; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="data"] span { color: #9b59b2; font-weight: 500; }

/* Menu de Contexto (3 Pontos) */
.context-menu {
    position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001;
    display: flex; flex-direction: column; padding: 5px; width: 160px;
}
.context-menu button {
    background: none; border: none; color: var(--text-color); padding: 8px 15px;
    text-align: left; cursor: pointer; border-radius: 4px; width: 100%; white-space: nowrap;
}
.context-menu button:hover { background-color: var(--accent-color); color: white; }

/* Modais (Sobreposi√ß√£o) */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center;
    align-items: center; z-index: 1000;
}
.modal-content {
    background-color: var(--sidebar-color); padding: 30px; border-radius: 8px;
    width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-content h3 { margin-bottom: 20px; font-size: 22px; }
.modal-content p { margin-bottom: 20px; color: var(--text-muted-color); }
.modal-content input[type="text"], .modal-content input[type="password"], .modal-content textarea {
    width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color);
    border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;
}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
.modal-btn:hover { opacity: 0.9; }
.modal-btn.primary { background-color: var(--accent-color); color: white; }
.modal-btn.secondary { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos Espec√≠ficos de Modais */
#add-item-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
#add-item-options button {
    background-color: var(--panel-color); border: 1px solid var(--border-color);
    color: var(--text-color); padding: 15px; text-align: left; border-radius: 5px;
    cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#add-item-options button:hover { background-color: var(--hover-color); }

.move-list { list-style: none; max-height: 40vh; overflow-y: auto; }
.move-list li {
    background-color: var(--bg-color); padding: 10px; border-radius: 5px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
}
.move-list .order-controls button {
    background: none; border: 1px solid var(--border-color); color: var(--text-color);
    width: 28px; height: 28px; cursor: pointer; border-radius: 5px; margin-left: 5px;
}
.move-list .order-controls button:hover { background-color: var(--hover-color); }
.move-list .order-controls button:disabled { opacity: 0.3; cursor: not-allowed; }

#link-modal .url-field-wrapper { display: flex; gap: 8px; }
#link-modal .remove-url-btn {
    background-color: #c0392b; color: white; padding: 0; width: 38px; height: 38px;
    min-width: unset; flex-shrink: 0; font-size: 24px; display: flex;
    align-items: center; justify-content: center;
}
#generic-list-modal-content, #view-link-modal .modal-content { max-width: 700px; }
#view-link-urls-list li { padding: 12px; background-color: var(--bg-color); }
#view-link-urls-list li a {
    color: var(--accent-color); text-decoration: none; display: block;
    word-break: break-all; font-weight: 500;
}
#view-link-urls-list li a:hover { text-decoration: underline; }

/* ============================================================
   PAINEL DE REFER√äNCIAS (4¬™ COLUNA)
   ============================================================ */
#references-panel {
    flex: 0 0 0; width: 0; background-color: var(--sidebar-color); padding: 0; height: 100%;
    display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; opacity: 0;
    border-left: 1px solid var(--border-color);
}

#references-panel-close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 24px; cursor: pointer; }
#references-panel-description {
    font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 20px; padding: 0 5px;
    line-height: 1.5; font-style: italic; border-left: 3px solid var(--accent-color); padding-left: 10px;
}
.references-separator { border: none; height: 1px; background-color: var(--border-color); margin: 15px 0; }
#references-toolbar { display: flex; justify-content: space-around; align-items: center; padding: 0 10px; }
#references-toolbar button {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 20px;
    cursor: pointer; padding: 8px; border-radius: 5px; transition: all 0.2s ease; line-height: 1;
}
#references-toolbar button:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--border-color); }

#references-list { list-style-type: none; overflow-y: auto; flex-grow: 1; }
#references-list li {
    padding: 12px; border-radius: 5px; cursor: pointer; margin-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
}
#references-list li:hover { background-color: var(--hover-color); }
#references-list details.reference-item {
    padding: 12px; border-radius: 5px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color);
}
#references-list details.reference-item[open] { background-color: var(--hover-color); }
#references-list summary { cursor: pointer; font-weight: 500; list-style: none; display: flex; justify-content: space-between; align-items: center; }
#references-list summary::-webkit-details-marker { display: none; }
#references-list summary:hover { color: var(--accent-color); }
.reference-item.link-info summary { color: var(--accent-color); font-weight: bold; }
.reference-context {
    margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--accent-color);
    color: var(--text-muted-color); font-size: 0.9em; line-height: 1.5;
}
.reference-context mark { background-color: rgba(74, 144, 226, 0.4); color: var(--text-color); border-radius: 3px; padding: 1px 3px; }

/* Bot√£o "Ir para" nas refer√™ncias */
.go-to-note-btn {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 18px;
    cursor: pointer; padding: 4px 8px; border-radius: 5px; margin-left: 10px; line-height: 1;
    transition: all 0.2s ease; display: none;
}
.reference-item:hover .go-to-note-btn { display: block; }
.go-to-note-btn:hover { background-color: var(--hover-color); color: var(--accent-color); }

/* ============================================================
   OUTROS PAINEIS E UTILIT√ÅRIOS
   ============================================================ */
/* Modal de T√≥picos */
.topics-layout { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
.topics-column {
    flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border-color);
    border-radius: 5px; background-color: var(--bg-color); padding: 10px;
}
.topics-list li {
    padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;
    display: flex; align-items: center; transition: background 0.2s;
}
.topics-list li:hover { background-color: var(--hover-color); }
.topics-list li.active-topic { background-color: rgba(74, 144, 226, 0.2); border-left: 3px solid var(--accent-color); }
.topic-checkbox { margin-right: 10px; width: 16px; height: 16px; cursor: pointer; }
.create-btn { width: 100%; padding: 8px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
.topic-search-input { width: 100%; padding: 8px; margin-bottom: 10px; background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; }

/* Filtro e Pesquisa */
.filter-bar { display: flex; justify-content: flex-end; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); position: relative; }
.filter-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
.filter-btn:hover, .filter-btn.active { background-color: var(--hover-color); color: var(--text-color); border-color: var(--accent-color); }
.filter-popup { position: absolute; top: 35px; right: 0; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; width: 150px; display: none; flex-direction: column; }
.filter-popup button { background: none; border: none; color: var(--text-color); padding: 10px; text-align: left; cursor: pointer; font-size: 0.9em; }
.filter-popup button:hover { background-color: var(--hover-color); }
.filter-popup button.selected { color: var(--accent-color); font-weight: bold; }
.group-header { background-color: var(--hover-color); color: var(--accent-color); padding: 8px 10px; font-weight: bold; font-size: 0.85em; border-radius: 4px; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
.list-search-container { padding-bottom: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); cursor: default; }
.list-search-input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; outline: none; transition: border-color 0.2s; }
.list-search-input:focus { border-color: var(--accent-color); }

/* Configura√ß√µes (Switches) */
.setting-toggle-container { display: flex; align-items: center; margin-bottom: 15px; }
.setting-label { margin-left: 12px; font-size: 0.95em; color: var(--text-color); }
.setting-switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 20px; }
.slider.round:before { border-radius: 50%; }

/* Perfil */
.profile-info { text-align: center; margin-bottom: 20px; }
.profile-avatar { font-size: 50px; margin-bottom: 10px; display: block; }
.profile-name { font-size: 1.2em; font-weight: bold; color: var(--text-color); display: block; margin-bottom: 5px; }
.profile-email { color: var(--text-muted-color); font-size: 0.9em; }

/* Status de Grava√ß√£o */
.save-status { 
    font-size: 0.8em; 
    color: var(--text-muted-color); 
    margin-right: 15px; 
    transition: all 0.3s ease; 
    font-style: italic; 
    font-weight: 500;
    cursor: pointer;
}

.save-status:hover {
    text-decoration: underline;
    color: var(--accent-color);
}

.save-status.status-saved { color: #27ae60; cursor: default; }
.save-status.status-error { color: #c0392b; cursor: pointer; }
#connectivity-status { display: none; color: #e74c3c; font-weight: bold; margin-right: 15px; font-size: 0.8em; animation: blink 1.5s linear infinite; }
#connectivity-status.visible { display: inline; }
@keyframes blink { 50% { opacity: 0.5; } }

/* Spinner */
.spinner-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 0; color: var(--text-muted-color); font-size: 0.9em; font-style: italic; }
.spinner { width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1); border-left-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Marcadores (Bookmarks) */
.bookmark-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
.bookmark-item:hover { background-color: var(--hover-color); }
.bookmark-info { display: flex; flex-direction: column; }
.bookmark-title { font-weight: 500; color: var(--text-color); }
.bookmark-desc { font-size: 0.8em; color: var(--text-muted-color); }
.bookmark-check { width: 20px; height: 20px; border: 2px solid var(--text-muted-color); border-radius: 4px; margin-left: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.bookmark-item.active .bookmark-check { background-color: var(--accent-color); border-color: var(--accent-color); }
.bookmark-item.active .bookmark-check::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

/* √Çncoras e Tabs */
#anchors-content-container .tab-content { display: none; max-height: 50vh; overflow-y: auto; }
#anchors-content-container .tab-content.active { display: block; }
#anchors-content-container li { padding: 10px; border-radius: 5px; cursor: pointer; position: relative; }
#anchors-content-container li:hover { background-color: var(--hover-color); }
#anchors-content-container li.is-on-page { background-color: #27ae60; color: white; }
.entity-edit-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 22px; line-height: 1; padding: 5px; border-radius: 5px; cursor: pointer; display: none; }
#anchors-content-container li:hover .entity-edit-btn { display: block; }
.entity-edit-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos para a Aba de Pesquisa Global */
.search-container { padding: 10px; }
.global-search-input {
    width: 100%; padding: 12px; font-size: 16px;
    background-color: var(--bg-color); border: 2px solid var(--border-color);
    border-radius: 8px; color: var(--text-color); outline: none;
    transition: border-color 0.3s; margin-bottom: 20px;
}
.global-search-input:focus { border-color: var(--accent-color); }

.search-results-group { margin-bottom: 20px; }
.search-results-header {
    font-size: 0.9em; text-transform: uppercase; color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color); margin-bottom: 10px; padding-bottom: 5px;
}
.search-result-item {
    background-color: rgba(255, 255, 255, 0.03); border-radius: 6px;
    padding: 12px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
    border-left: 3px solid transparent;
}
.search-result-item:hover { background-color: var(--hover-color); border-left-color: var(--accent-color); }
.search-result-title { font-weight: bold; color: var(--accent-color); display: block; margin-bottom: 4px; }
.search-result-path { font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 6px; display: block; }
.search-match-context {
    font-size: 0.9em; color: var(--text-color); line-height: 1.5;
    background-color: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;
    font-family: monospace;
}
.search-match-context mark { background-color: rgba(241, 196, 15, 0.4); color: white; border-radius: 2px; padding: 0 2px; }
.search-badge {
    font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 8px;
    text-transform: uppercase; font-weight: bold;
}
.badge-pasta { background-color: rgba(52, 152, 219, 0.2); color: #3498db; }
.badge-nota { background-color: rgba(46, 204, 113, 0.2); color: #2ecc71; }
.badge-postit { background-color: rgba(241, 196, 15, 0.2); color: #f1c40f; }
.badge-question { background-color: rgba(39, 174, 96, 0.2); color: #27ae60; }

@keyframes flash-highlight {
    0% { background-color: rgba(241, 196, 15, 0.8); }
    100% { background-color: transparent; }
}

.temporary-highlight {
    animation: flash-highlight 2s ease-out;
}

/* --- ESTILOS DO MODAL DE DESTAQUES (NOVO) --- */
/* 1. For√ßar a largura do Modal Espec√≠fico */
#highlight-modal .modal-content {
    max-width: 500px !important; /* Mais largo para caberem as 3 colunas */
    width: 90%;
}

/* 2. O Contentor vira uma Grelha */
#highlight-options-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 Colunas iguais */
    gap: 12px; /* Um pouco mais de espa√ßo entre eles */
    max-height: 400px;
    overflow-y: auto;   /* Scroll vertical se necess√°rio */
    overflow-x: hidden; /* ESCONDE A BARRA HORIZONTAL */
    margin-top: 15px;
    padding: 4px; /* Espa√ßo para a sombra n√£o cortar */
}

/* 3. O Item individual (Quadrado) */
#highlight-options-container .highlight-option-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 0;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s;
    height: 95px; /* Ligeiramente mais alto */
    position: relative;
    text-align: center;
    box-sizing: border-box; /* Garante que padding n√£o aumenta largura */
}

#highlight-options-container .highlight-option-row:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* 4. A Bolinha de Cor */
#highlight-options-container .color-preview-box {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 0;
    margin-bottom: 8px;
    border: 1px solid rgba(0,0,0,0.2);
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 5. O Nome da Cor */
#highlight-options-container .highlight-name-label {
    font-size: 12px;
    font-weight: 500;
    line-height: 1.2;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* ... se o nome for grande */
    padding: 0 4px;
}

#highlight-options-container .highlight-option-row:hover .highlight-name-label {
    color: white;
}

/* 6. Bot√£o de Editar (L√°pis) */
#highlight-options-container .highlight-options-btn {
    position: absolute;
    top: 3px;
    right: 3px;
    background: none;
    border: none;
    color: var(--text-muted-color);
    font-size: 14px;
    cursor: pointer;
    padding: 4px;
    opacity: 0.6;
}

#highlight-options-container .highlight-options-btn:hover {
    color: white;
    opacity: 1;
    background-color: rgba(0,0,0,0.1);
    border-radius: 4px;
}

/* 7. Bot√£o "Remover Destaque" */
#highlight-options-container .remove-highlight-row {
    grid-column: 1 / -1;
    flex-direction: row;
    height: 45px;
    margin-bottom: 5px;
    border: 1px dashed #e74c3c;
    color: #e74c3c;
    justify-content: center;
    font-weight: bold;
    gap: 8px; /* Espa√ßo entre √≠cone e texto */
}

#highlight-options-container .remove-highlight-row:hover {
    background-color: #e74c3c;
    color: white;
    border-style: solid;
    transform: none;
}

/* 8. Estilo do Selecionado */
.highlight-option-row.selected-color-row {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,0.3);
}

.highlight-option-row.selected-color-row .highlight-options-btn {
    color: white !important;
    opacity: 1;
}

/* Check no canto */
.highlight-option-row.selected-color-row::after {
    content: '‚úì';
    position: absolute;
    top: 2px;
    left: 6px;
    font-weight: bold;
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ============================================================
   ESTILOS DE TABELA E MENU FLUTUANTE
   ============================================================ */
/* Estilo da Tabela no Editor */
.jwn-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 0.95em;
}
.jwn-table th, .jwn-table td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    min-width: 50px;
    position: relative;
}
.jwn-table th {
    background-color: var(--sidebar-color);
    font-weight: bold;
    text-align: left;
    color: var(--accent-color);
}
/* Efeito hover para saber onde estamos */
.jwn-table td:hover, .jwn-table th:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* Menu de Ferramentas de Tabela */
#table-tools-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2000;
    padding: 5px;
    gap: 5px;
    flex-wrap: wrap;
    max-width: 220px;
}
#table-tools-popup button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 14px;
    flex-grow: 1;
}
#table-tools-popup button:hover {
    background-color: var(--accent-color);
    color: white;
}
#table-tools-popup .sep {
    width: 100%;
    height: 1px;
    background: var(--border-color);
    margin: 3px 0;
}

/* Wrapper para posicionar o bot√£o relativo √† tabela */
.jwn-table-wrapper {
    position: relative;
    margin-top: 25px; /* Espa√ßo para o bot√£o */
    margin-bottom: 15px;
}

/* Bot√£o de Ferramentas da Tabela */
.table-settings-btn {
    position: absolute;
    top: -28px;
    right: 0;
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    border-radius: 4px 4px 0 0;
    padding: 2px 8px;
    font-size: 14px;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 5px;
}
.table-settings-btn:hover, .table-settings-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* ============================================================
   WIDGET DE CALEND√ÅRIO
   ============================================================ */
.jwn-calendar-widget {
    border: 1px solid var(--border-color);
    background-color: var(--sidebar-color);
    border-radius: 8px;
    padding: 10px;
    margin: 15px 0;
    width: 100%;
    max-width: 350px; /* Tamanho compacto */
    user-select: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Cabe√ßalho: M√™s + Bot√µes */
.cal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    color: var(--accent-color);
    font-weight: bold;
}
.cal-btn {
    background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text-muted-color); padding: 4px 8px; border-radius: 4px;
}
.cal-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Menu de Defini√ß√µes (Semana/M√™s/Ano) */
.cal-settings-menu {
    display: none;
    flex-direction: column; /* Organiza bot√µes verticalmente */
    gap: 8px;
    margin-bottom: 10px;
    background: var(--panel-color); /* Fundo um pouco mais claro que a base */
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
/* Bot√£o Eliminar Agenda */
.cal-delete-btn {
    width: 100%;
    background-color: rgba(231, 76, 60, 0.1); /* Fundo vermelho muito subtil */
    border: 1px solid #c0392b; /* Borda vermelha escura */
    color: #e74c3c; /* Texto vermelho vivo */
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}/* Efeito Hover (Ao passar o rato) */
.cal-delete-btn:hover {
    background-color: #c0392b; /* Fica vermelho s√≥lido */
    color: white; /* Texto passa a branco */
    border-color: #c0392b;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.cal-settings-menu.visible { display: flex; }
.cal-view-btn {
    font-size: 0.8em; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; background: var(--panel-color); color: var(--text-color);
}
.cal-view-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }

/* Grelha de Dias */
.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
}
.cal-day-header {
    font-size: 0.75em; color: var(--text-muted-color); padding-bottom: 5px;
}
.cal-day {
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    position: relative;
    border: 1px solid transparent;
}
.cal-day:hover { background-color: var(--hover-color); border-color: var(--border-color); }
.cal-day.empty { background: transparent; cursor: default; }
.cal-day.today { border: 1px solid var(--accent-color); font-weight: bold; color: var(--accent-color); }
.cal-day.has-task::after {
    content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
    width: 4px; height: 4px; background-color: #e74c3c; border-radius: 50%;
}

/* Estilos para o Seletor de Agrega√ß√£o */
.agreg-item {
    display: flex; 
    align-items: center; 
    padding: 10px; 
    border-bottom: 1px solid var(--border-color); 
    cursor: pointer;
}
.agreg-item:hover { background-color: var(--hover-color); }

/* Tipos de Item */
.agreg-type-folder { font-weight: bold; color: var(--text-color); }
.agreg-type-note { color: var(--text-muted-color); }

/* Caixas de Conte√∫do (Miniaturas) */
.agreg-box-item {
    background-color: rgba(255,255,255,0.03);
    margin: 5px 0;
    border-left: 4px solid transparent;
    padding: 10px;
    border-radius: 4px;
    display: flex;
    gap: 10px;
}
.agreg-box-item.selected {
    background-color: rgba(74, 144, 226, 0.15);
    border: 1px solid var(--accent-color);
}

/* Cores das Bordas das Caixas */
.agreg-box-question { border-left-color: #2ecc71; } /* Verde */
.agreg-box-subnote { border-left-color: #3498db; }  /* Azul */
.agreg-box-free { border-left-color: #e67e22; }     /* Laranja */

/* --- NOVO: POPUP DE DEFINI√á√ïES DE PARTILHA --- */
#share-settings-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2200;
    padding: 15px;
    width: 220px;
    flex-direction: column;
    gap: 10px;
}

#share-settings-popup h4 {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    text-transform: uppercase;
    color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
}

.share-toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95em;
    color: var(--text-color);
}

/* Estado visual do bot√£o na toolbar quando partilhado */
button.sharing-active {
    color: #2ecc71 !important; /* Verde */
    border-color: #2ecc71 !important;
    background-color: rgba(46, 204, 113, 0.1) !important;
}

/* ============================================================
   ESTILO T√çTULO TOGGLE (EXPANS√çVEL)
   ============================================================ */
details.toggle-section {
    margin: 15px 0;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.02);
    display: block; 
    height: auto; /* Garante que a altura √© autom√°tica */
}

details.toggle-section summary {
    padding: 10px;
    cursor: pointer;
    list-style: none; /* Remove a seta padr√£o feia */
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
    user-select: none;
}

/* Remove a seta padr√£o no Chrome/Safari */
details.toggle-section summary::-webkit-details-marker {
    display: none;
}

details.toggle-section summary:hover {
    background-color: var(--hover-color);
}

/* A nossa seta personalizada */
details.toggle-section summary::before {
    content: '‚òÇ';
    display: inline-block;
    width: 20px;
    font-size: 12px;
    color: var(--text-muted-color);
    transition: transform 0.2s ease;
    margin-right: 8px;
}

/* Quando aberto, roda a seta */
details.toggle-section[open] summary::before {
    transform: rotate(90deg);
}

/* O T√≠tulo H2 l√° dentro */
details.toggle-section summary h2 {
    margin: 0;
    display: inline;
    border: none;
    font-size: 1.5em; /* Tamanho A2 */
    font-weight: bold;
    color: var(--text-color); /* Herda cor ou usa padr√£o */
}

/* O conte√∫do oculto */
details.toggle-section .toggle-content {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: rgba(0, 0, 0, 0.1);
    
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* Usa normal em vez de pre-wrap para evitar conflito com <br> */
    display: block;
    height: auto !important; /* For√ßa altura autom√°tica */
}

/* Bot√£o de eliminar dentro do Toggle */
.toggle-delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-delete-btn:hover {
    opacity: 1;
    background-color: rgba(192, 57, 43, 0.1); /* Fundo vermelho suave */
}

/* Garante que o T√≠tulo ocupa o espa√ßo todo para empurrar o lixo para a direita */
details.toggle-section summary h2 {
    flex-grow: 1;
}

/* Bot√£o do Pincel (igual ao do lixo, mas margem ajustada) */
.toggle-color-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-color-btn:hover {
    opacity: 1;
    background-color: rgba(255, 255, 255, 0.1);
}

/* Estilo das bolas de cor no popup */
.color-choice {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}
.color-choice:hover {
    transform: scale(1.15);
    border-color: var(--text-color);
}

/* Bot√µes de Mover dentro do Toggle */
.toggle-move-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px; /* Um pouco menor que o t√≠tulo */
    margin-left: 5px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-move-btn:hover {
    opacity: 1;
    background-color: var(--hover-color);
}

/* ============================================================
   ESTILO DO AGRUPADOR DE SETAS (NOVO)
   ============================================================ */
.toolbar-btn-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color); /* A borda do ret√¢ngulo */
    border-radius: 4px;
    margin-left: 5px;
    height: 30px;
    overflow: hidden; /* Garante cantos arredondados */
    background-color: transparent;
}

/* Removemos o estilo padr√£o dos bot√µes APENAS quando est√£o dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button {
    border: none !important;       /* Sem borda individual */
    border-radius: 0 !important;   /* Sem cantos redondos individuais */
    margin-left: 0 !important;     /* Sem espa√ßo entre eles */
    width: 28px !important;        /* Largura fixa */
    height: 100% !important;
}

/* Adiciona a linha separadora no meio */
.mini-note-toolbar .toolbar-btn-group button:first-child {
    border-right: none !important; /* <--- MUDAR AQUI PARA "none" */
}

/* Efeito Hover dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button:hover {
    background-color: var(--hover-color);
}
/* ============================================================
   WIDGET DE LINHA CRONOL√ìGICA (TIMELINE)
   ============================================================ */
.jwn-timeline-wrapper {
    position: relative;
    padding: 20px 10px;
    margin: 15px 0;
    background-color: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* A Linha Vertical */
.timeline-track {
    position: absolute;
    left: 30px; /* Posi√ß√£o da linha */
    top: 20px;
    bottom: 50px; /* Espa√ßo para o bot√£o adicionar */
    width: 2px;
    background-color: var(--accent-color);
    opacity: 0.5;
}

/* O item individual */
.timeline-entry {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-left: 45px; /* Espa√ßo para a bolinha e linha */
}

/* A bolinha (marcador) */
.t-marker {
    position: absolute;
    left: 24px; /* Centrado na linha (30px - metade da bola) */
    top: 5px;
    width: 14px;
    height: 14px;
    background-color: var(--bg-color);
    border: 2px solid var(--accent-color);
    border-radius: 50%;
    z-index: 2;
    transition: background-color 0.2s;
}

.timeline-entry:hover .t-marker {
    background-color: var(--accent-color);
}

/* Campos de Texto */
.t-date {
    font-weight: bold;
    color: var(--accent-color);
    min-width: 80px;
    margin-right: 10px;
    font-size: 0.9em;
    border-bottom: 1px dashed transparent;
}

.t-text {
    flex-grow: 1;
    color: var(--text-color);
    line-height: 1.4;
}

.t-date:focus, .t-text:focus {
    outline: none;
    border-bottom-color: var(--accent-color);
}

/* Bot√µes de A√ß√£o */
.t-btn-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0;
    margin-left: 10px;
    transition: opacity 0.2s;
}

.timeline-entry:hover .t-btn-del {
    opacity: 1;
}

.t-btn-add {
    display: block;
    margin-left: 23px; /* Alinhado com a linha */
    background: none;
    border: 1px dashed var(--text-muted-color);
    color: var(--text-muted-color);
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    margin-top: 10px;
    transition: all 0.2s;
}

.t-btn-add:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

   /* --- ESTILOS DO SCANNER UNIVERSAL --- */
/* Estilo para os itens do scanner b√≠blico */
.bible-scan-item {
    display: flex;
    align-items: center;
    padding: 8px;
    background-color: var(--bg-color);
    border-radius: 4px;
    margin-bottom: 5px;
    cursor: pointer;
}
.bible-scan-item:hover {
    background-color: var(--hover-color);
}
.bible-scan-item input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.bible-scan-item label {
    flex-grow: 1;
    cursor: pointer;
    font-weight: 500;
}
.bible-scan-existing-item {
    padding: 8px;
    color: #2ecc71; /* Verde */
    font-weight: 500;
    display: flex;
    align-items: center;
}
.bible-scan-existing-item::before {
    content: '‚úì';
    margin-right: 10px;
    font-weight: bold;
}
/* Abas */
.scan-tabs {
    display: flex;
    gap: 10px;
}
.scan-tab-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: var(--text-muted-color);
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: all 0.2s;
}
.scan-tab-btn:hover {
    color: var(--text-color);
    background-color: var(--hover-color);
    border-radius: 4px 4px 0 0;
}
.scan-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

/* Itens da Lista */
.scan-item-row {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-color);
    margin-bottom: 5px;
    border-radius: 4px;
}
.scan-item-row:hover {
    background-color: var(--hover-color);
}
.scan-checkbox {
    width: 18px; height: 18px; margin-right: 10px; cursor: pointer;
}
.scan-info {
    flex-grow: 1; display: flex; flex-direction: column;
}
.scan-name {
    font-weight: bold; color: var(--text-color);
}
.scan-location {
    font-size: 0.8em; color: var(--text-muted-color);
}
.scan-preview-btn {
    background: none; border: 1px solid var(--border-color);
    color: var(--text-muted-color); border-radius: 50%;
    width: 30px; height: 30px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    margin-left: 10px; transition: all 0.2s;
}
.scan-preview-btn:hover {
    background-color: var(--accent-color); color: white; border-color: var(--accent-color);
}

/* Sec√ß√µes (Novos vs Existentes) */
.scan-section-title {
    font-size: 0.85em; text-transform: uppercase; 
    color: var(--text-muted-color); margin: 15px 0 10px 0;
    font-weight: bold; border-bottom: 1px solid var(--border-color);
}

/* Popup de Preview Flutuante */
#scan-preview-popup {
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80%; max-width: 350px;
    background-color: var(--panel-color);
    border: 1px solid var(--accent-color);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    border-radius: 8px;
    z-index: 10;
    overflow: hidden;
}
.preview-header {
    background-color: var(--sidebar-color);
    padding: 8px 12px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border-color);
}
.preview-header button {
    background: none; border: none; color: var(--text-color); font-size: 18px; cursor: pointer;
}
#scan-preview-content {
    padding: 15px;
    font-size: 0.9em;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
}
#scan-preview-content mark {
    background-color: rgba(241, 196, 15, 0.4);
    color: white; padding: 2px 4px; border-radius: 4px;
}

/* --- CSS PARA O BOT√ÉO "VOLTAR √Ä NOTA" --- */


/* Garante que o Painel do Meio ocupa 100% da tela no Mobile */
@media (max-width: 768px) {
    #middle-panel {
        width: 100% !important;
        right: 0 !important;
        max-width: none !important;
    }
}

/* --- ESTILOS DO PAINEL DE REFER√äNCIAS (ABAS E PUZZLE) --- */

/* Caixas de M√≥dulo de Texto (Puzzle) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: transform 0.2s;
}

.puzzle-module-card textarea {
    width: 100%;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    border-radius: 4px;
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
}

.puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
}

.puzzle-controls button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.puzzle-controls button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.puzzle-controls button.delete:hover {
    background-color: rgba(192, 57, 43, 0.2);
    color: #e74c3c;
    border-color: #e74c3c;
}

/* Item da Lista de Refer√™ncias Escolhidas */
#puzzle-chosen-list li {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background-color: rgba(255, 255, 255, 0.03);
    border-left: 3px solid var(--accent-color);
}

.chosen-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 0.9em;
}

.chosen-ref-snippet {
    font-size: 0.85em;
    color: var(--text-muted-color);
    font-style: italic;
    margin-top: 3px;
    padding: 5px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}

/* Bot√£o adicionar ao puzzle (na aba Refer√™ncias) */
.add-to-puzzle-btn {
    background-color: var(--hover-color);
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 14px;
    cursor: pointer;
    margin-right: 5px;
}
.add-to-puzzle-btn:hover {
    background-color: var(--accent-color);
    color: white;
}

/* --- ESTILOS DO PUZZLE (MODO LEITURA VS EDI√á√ÉO) --- */

/* Estilo do Card (Contentor) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: all 0.2s;
}

/* O Textarea por padr√£o (MODO LEITURA - "Bonito") */
.puzzle-module-card textarea {
    width: 100%;
    /* Remove as bordas e fundo para parecer texto limpo */
    background: transparent; 
    border: none; 
    color: var(--text-color);
    padding: 5px;
    resize: none; /* Impede redimensionar */
    min-height: auto;
    font-family: inherit;
    font-size: 0.95em;
    line-height: 1.5;
    outline: none;
    overflow: hidden; /* Esconde scrollbar */
}

/* Os bot√µes de controlo por padr√£o (ESCONDIDOS) */
.puzzle-module-card .puzzle-controls {
    display: none; 
}

/* --- CLASSE ATIVADORA: .edit-mode-active --- */
/* Quando o contentor pai tem esta classe, mudamos o visual */

/* 1. Mostra o bot√£o "+ Criar" */
#ref-content-puzzle.edit-mode-active #add-puzzle-module-btn {
    display: block !important;
}

/* 2. Muda o Textarea para parecer um campo de input */
#ref-content-puzzle.edit-mode-active .puzzle-module-card textarea {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    resize: vertical; /* Permite redimensionar */
    min-height: 60px;
}

/* 3. Mostra os bot√µes de controlo (Setas e Lixo) */
#ref-content-puzzle.edit-mode-active .puzzle-module-card .puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-top: 5px;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}


/* Bot√µes do Quadro */
.puzzle-edit-toggle {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    border-radius: 4px; padding: 4px 10px; cursor: pointer; transition: all 0.2s;
}
.puzzle-action-btn {
    border: none; color: white; border-radius: 4px; padding: 4px 10px; 
    cursor: pointer; font-weight: bold; font-size: 0.85em;
}
.btn-blue { background-color: #3498db; }
.btn-blue:hover { background-color: #2980b9; }
.btn-green { background-color: #2ecc71; }
.btn-green:hover { background-color: #27ae60; }

/* Estilo do Cart√£o no Quadro (Gen√©rico) */
.board-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Tipo TEXTO */
.board-card.type-text textarea {
    width: 100%; background: transparent; border: none; color: var(--text-color);
    resize: none; font-family: inherit; line-height: 1.5; outline: none;
}
/* No modo edi√ß√£o, o textarea parece um input */
.edit-mode-active .board-card.type-text textarea {
    background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; resize: vertical;
}

/* Tipo REFER√äNCIA */
.board-card.type-ref {
    border-left: 3px solid #2ecc71; /* Borda verde para identificar */
}
.ref-card-content {
    font-size: 0.9em; color: var(--text-color);
}
.ref-card-title {
    font-weight: bold; color: var(--accent-color); display: flex; align-items: center; gap: 5px;
}
.ref-card-snippet {
    background-color: transparent; /* Remove fundo amarelo se houver */
    padding: 5px 0; 
    margin: 5px 0; 
    color: var(--text-muted-color); 
    font-size: 0.9em; 
    line-height: 1.5;
    /* Adiciona a barra lateral de cita√ß√£o para ficar igual */
    border-left: 2px solid var(--accent-color);
    padding-left: 10px;
}

/* Garante que o <mark> dentro do snippet tem a cor correta */
.ref-card-snippet mark {
    background-color: rgba(74, 144, 226, 0.4); /* Azul suave */
    color: var(--text-color); 
    border-radius: 3px; 
    padding: 1px 3px;
}

/* Controlos (Lixo, Setas) */
.card-controls {
    display: none; /* Escondido por padr√£o */
    margin-top: 5px; 
    border-top: 1px solid var(--border-color); 
    padding-top: 5px; 
    justify-content: flex-end; 
    gap: 5px;
}
.edit-mode-active .card-controls { display: flex; } /* Mostra ao editar */

/* A MAGIA: S√≥ mostra quando o painel tem esta classe */
#ref-content-puzzle.edit-mode-active .card-controls {
    display: flex !important;
}

.card-controls button {
    background: none; border: 1px solid var(--border-color); cursor: pointer; padding: 2px 6px; border-radius: 4px;
}
.card-controls button:hover { background-color: var(--hover-color); }

/* Estilo Base (Modo Visualiza√ß√£o - Limpo) */
.board-text-content {
    width: 100%;
    min-height: 40px;
    outline: none;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-color);
    
    /* O SEGREDO: Bordas e fundo transparentes por defeito */
    border: 1px solid transparent; 
    background-color: transparent;
    padding: 2px 5px; /* Padding pequeno para leitura */
    transition: all 0.2s ease;
}

/* Estilo Modo Edi√ß√£o (Quando o pai tem a classe activa) */
.edit-mode-active .board-text-content {
    border: 1px solid var(--border-color);
    background-color: var(--bg-color); /* Fundo da caixa de input */
    border-radius: 4px;
    padding: 8px; /* Mais espa√ßo para escrever */
    cursor: text;
}

/* Efeito Hover opcional no modo edi√ß√£o para saber que pode clicar */
.edit-mode-active .board-text-content:hover {
    border-color: var(--accent-color);
}

/* ============================================================
   ESTILO PERSONALIZADO PARA LINKS DO QUADRO
   ============================================================ */
a.board-link {
    /* 1. Mant√©m a cor do texto original (branco/cinza) */
    color: inherit !important; 
    
    /* 2. Remove o sublinhado padr√£o */
    text-decoration: none !important; 
    
    /* 3. Cria a linha picotada azul por baixo */
    border-bottom: 1px dotted #4a90e2 !important; 
    
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Efeito ao passar o rato (Opcional: torna a linha s√≥lida) */
a.board-link:hover {
    border-bottom-style: solid !important;
    background-color: rgba(74, 144, 226, 0.1); /* Fundo azul muito suave */
}

/* --- ESTILO PARA O ITEM DO POPUP DE REFER√äNCIA --- */
.puzzle-ref-item {
    display: flex !important;        /* For√ßa layout flex√≠vel */
    flex-direction: column !important; /* Organiza em colunas (Cima/Baixo) */
    align-items: flex-start !important;
    justify-content: center !important;
    width: 100%;
    padding: 12px 15px !important;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    box-sizing: border-box; /* Garante que padding n√£o aumenta largura */
    overflow: hidden;       /* Impede barras de scroll */
}

.puzzle-ref-item:hover {
    background-color: var(--hover-color);
}

/* Linha de Cima (Tipo + Nome da Nota) */
.puzzle-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 6px;
}

/* O Tipo (Ex: Quest√£o) */
.puzzle-ref-type {
    font-weight: bold;
    color: var(--text-color);
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0; /* Impede de encolher */
}

/* O Nome da Nota (Direita) */
.puzzle-ref-note {
    font-size: 0.8em;
    color: var(--text-muted-color);
    text-align: right;
    
    /* Truncar texto longo com ... */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%; /* Ocupa no m√°ximo 60% da linha */
}

/* O Texto de Contexto (Baixo) */
.puzzle-ref-snippet {
    font-size: 0.9em;
    color: var(--text-muted-color);
    width: 100%;
    line-height: 1.4;
    
    /* Truncar texto longo com ... */
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================================
   WIDGET CARD DE LINK (üé¥)
   ============================================================ */
   .url-card-widget {
    display: inline-flex;
    flex-direction: column;
    width: 250px;             /* Tamanho m√©dio */
    height: 180px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin: 10px 5px;
    position: relative;
    vertical-align: top;
    background-color: var(--panel-color);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
    user-select: none;
    text-decoration: none; /* Remove sublinhado de link se houver */
    cursor: pointer;
}

.url-card-widget:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border-color: var(--accent-color);
}

/* √Årea da Imagem */
.url-card-image {
    width: 100%;
    height: 100px;
    background-color: #2c2c30;
    background-size: cover;
    background-position: center;
    position: relative;
}

/* T√≠tulo e Dom√≠nio */
.url-card-info {
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex-grow: 1;
}

.url-card-title {
    font-weight: bold;
    font-size: 0.9em;
    color: var(--text-color);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* M√°ximo 2 linhas */
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 5px;
}

.url-card-domain {
    font-size: 0.75em;
    color: var(--text-muted-color);
    text-transform: uppercase;
    font-weight: 600;
}

/* Bot√£o de Fechar (X) - S√≥ aparece no hover */
.url-card-close {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 50%;
    display: none; /* Escondido por defeito */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    transition: background 0.2s;
}

.url-card-close:hover {
    background-color: #e74c3c; /* Vermelho ao passar o rato */
}

.url-card-widget:hover .url-card-close {
    display: flex; /* Mostra ao passar o rato no card */
}

/* Loading State */
.url-card-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 0.8em;
    color: var(--text-muted-color);
    font-style: italic;
}

/* ============================================================
   RESPONSIVIDADE MOBILE (SISTEMA DE PILHA)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Reset do Contentor Principal */
    .notebook-container {
        display: block !important;
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* 2. Configura√ß√£o Base dos 3 Pain√©is (Ecr√£ Cheio) */
    #left-panel, #middle-panel, #right-panel {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        flex: none !important;
        z-index: 10;
        border: none !important;
        border-radius: 0 !important;
        /* Reset de estilos desktop que causam cortes */
        margin: 0 !important;
        max-width: none !important;
        min-width: 0 !important;
    }

    /* --- L√ìGICA DE VISIBILIDADE (Quem est√° no topo?) --- */

    /* ESTADO 1: Painel Esquerdo (Pastas + Abas) */
    body:not(.mobile-view-middle):not(.mobile-view-editor) #left-panel {
        display: flex !important;
        z-index: 50; /* No topo */
        background-color: var(--sidebar-color);
    }
    body:not(.mobile-view-middle):not(.mobile-view-editor) #middle-panel,
    body:not(.mobile-view-middle):not(.mobile-view-editor) #right-panel {
        display: none !important;
    }

    /* ESTADO 2: Painel do Meio (Lista de Notas) */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        flex-direction: column !important;
        z-index: 60; /* Acima da esquerda */
        background-color: var(--panel-color);
        padding: 15px !important; /* Espa√ßo para n√£o cortar o topo */
    }
    body.mobile-view-middle #left-panel {
        display: none !important; 
    }
    body.mobile-view-middle #right-panel {
        display: none !important;
    }

    /* ESTADO 3: Editor (Nota Aberta) */
    body.mobile-view-editor #right-panel {
        display: flex !important;
        z-index: 70; /* Acima de tudo */
        background-color: var(--bg-color);
    }
    body.mobile-view-editor #left-panel, 
    body.mobile-view-editor #middle-panel {
        display: none !important;
    }

    /* --- CORRE√á√ïES ESPEC√çFICAS --- */

    /* 1. For√ßar as ABAS (Note/Lists/Book) a aparecerem bem */
    #left-panel .panel-content {
        padding-top: 10px;
    }
    .tabs-container {
        display: flex !important;
        margin-bottom: 15px !important;
        flex-shrink: 0; /* Impede que encolham */
    }
    
    /* 2. Corrigir o Cabe√ßalho da Coluna 2 (Para n√£o cortar) */
    #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        height: auto !important;
        min-height: 50px;
        margin-bottom: 20px;
        width: 100%;
        flex-shrink: 0;
    }
    
    /* For√ßar a visibilidade dos elementos internos do header */
    #middle-panel .panel-header h2,
    #middle-panel .panel-header #back-btn,
    #middle-panel .panel-header #add-item-btn {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* 3. Bot√£o de Voltar no Editor (Topo) */
    #mobile-back-btn {
        display: flex !important;
        align-items: center;
        padding: 5px 12px;
        background: var(--panel-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-right: 10px;
    }

    /* 4. Esconder bot√µes desktop in√∫teis */
    #middle-panel-toggle-btn,
    #left-panel-toggle-btn {
        display: none !important;
    }
}
/* ==========================================================
       CORRE√á√ÉO IPHONE 13 E BOT√ïES SUMIDOS
       ========================================================== */

    /* 1. Ajuste do Painel para respeitar o "Notch" (C√¢mara) do iPhone */
    #middle-panel,
    .notebook-container.middle-panel-collapsed #middle-panel {
        /* Adiciona espa√ßo no topo seguro para o iPhone */
        padding-top: calc(15px + env(safe-area-inset-top)) !important;
    }

    /* 2. For√ßa o cabe√ßalho a ser vis√≠vel e Horizontal */
    #middle-panel .panel-header,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important; /* Linha horizontal */
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        min-height: 50px !important;
        margin-bottom: 20px !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* 3. O MAIS IMPORTANTE: For√ßa os bot√µes e t√≠tulo a aparecerem! 
       (Anula a regra que os escondia no modo colapsado) */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header > *,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #back-btn,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #add-item-btn {
        display: flex !important; /* Traz de volta os elementos! */
        visibility: visible !important;
        opacity: 1 !important;
        height: 32px !important;
        align-items: center;
    }

    /* Ajuste fino para o T√≠tulo (H2) ser bloco e n√£o flex */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2 {
        display: block !important;
        text-align: center;
        flex-grow: 1;
    }
</style>



</head>
<body>

    <div class="notebook-container">
        <!-- PAINEL DA ESQUERDA -->
        <aside id="left-panel">
            <button id="left-panel-toggle-btn" title="Mostrar Painel">‚ò∞</button>
            <div class="panel-content">
                <div class="tabs-container">
                    <button class="active" data-tab="note">Note</button>
                    <button data-tab="lists">Lists</button>
                    <button data-tab="book">Book</button>
                </div>
                <hr>
                <div class="panel-header">
                    <h2 id="left-panel-title">Pastas</h2>
                </div>
                <ul id="left-panel-list">
                    <!-- Itens da coluna esquerda -->
                </ul>
            </div>
            <div class="panel-footer">
                <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
                 <button id="account-btn" title="Minha Conta">üë§</button>
            </div>
        </aside>

      <!-- PAINEL DO MEIO -->
        <main id="middle-panel">
            <div class="panel-header">
                <button id="back-btn" title="Voltar">‚Üê</button>
            
                <button id="middle-panel-toggle-btn" title="Expandir/Recolher" style="margin-right: 10px;">‚Üñ</button>
                
                <h2 id="middle-panel-title">Selecione</h2>
                <button id="add-item-btn" title="Adicionar item">+</button>
            </div>
            <ul id="file-list">
                 <!-- Itens da coluna do meio -->
            </ul>
        </main>

        <!-- PAINEL DA DIREITA - EDITOR -->
        <section id="right-panel">
            <div id="editor-placeholder">
                <div class="placeholder-icon">üìñ</div>
                <h2>Selecione uma nota para come√ßar</h2>
                <p>Ou crie uma nova pasta e uma nota.</p>
            </div>
            
            <!-- √ÅREA DO EDITOR -->
            <div id="editor-area" style="display: none; flex-direction: column; height: 100%;">
                <input type="text" id="note-title-input" placeholder="T√≠tulo da nota...">
                
                <!-- 1. BARRA DE FERRAMENTAS PRINCIPAL -->
           <div id="editor-toolbar">
    <!-- GRUPO 1: Formata√ß√£o de Texto -->

    <!-- 1. Bot√£o de Voltar para Mobile (NOVO) -->
<button id="mobile-back-btn" title="Voltar √† Lista" style="display: none; margin-right: 10px; font-weight: bold;">‚¨Ö Voltar</button>

    <div class="toolbar-group">
        <button data-command="bold" title="Negrito"><b>B</b></button>
        <button data-command="boldBlue" title="Negrito Azul" style="color: #4a90e2; font-weight: bold;">B</button>
        <button data-command="italic" title="It√°lico"><i>I</i></button>
        <button data-command="underline" title="Sublinhado"><u>U</u></button>
        
        <!-- Bot√£o de Seta para a Barra Secund√°ria -->
        <button id="toggle-more-tools-btn" title="Mais Ferramentas" style="font-size: 12px;">‚ñº</button>
    </div>
    
    <div class="toolbar-separator"></div>
    
    <!-- GRUPO 2: Ferramentas e A√ß√µes -->
    <div class="toolbar-group">
        <button data-action="show-explorer" title="Explorador (Tags e Entidades)">üîç</button>
        <button data-action="show-attachments" title="Anexos">üìé</button>
        <!-- Undo e Redo (que pediu h√° pouco) -->
        <button data-command="undo" title="Retroceder">‚Ü©Ô∏è</button>
        <button data-command="redo" title="Refazer">‚Ü™Ô∏è</button>
    </div>
    
   <!-- GRUPO 3: Status e Hist√≥rico -->
<div class="toolbar-history">
    <span id="save-status-indicator" class="save-status"></span>
    
    <!-- NOVO BOT√ÉO DE PARTILHA DA NOTA -->
    <button data-action="note-sharing-settings" title="Partilha da Nota" style="margin-right: 5px;">üîê</button> 
    
    <button data-action="show-topics" title="Gerir T√≥picos" style="margin-right: 5px;">üìë</button> 
    <button data-action="show-history" title="Hist√≥rico de Vers√µes">üïí</button>
</div>
    
</div>

                <!-- 2. BARRA DE FERRAMENTAS SECUND√ÅRIA -->
           <div id="secondary-toolbar" style="display: none;">
    
    <!-- Grupo 1: Zoom, COR e T√≠tulos -->
    <div class="toolbar-group">
        <!-- Zoom -->
        <select id="editor-zoom" title="Zoom da Nota">
            <option value="12px">50%</option>
            <option value="14px">75%</option>
            <option value="100%" selected>100%</option>
            <option value="18px">110%</option>
            <option value="20px">125%</option>
            <option value="24px">150%</option>
            <option value="28px">180%</option>
            <option value="32px">200%</option>
        </select>

        <!-- COR (Movida para aqui, antes do A1) -->
        <input type="color" data-command="foreColor" title="Cor do Texto" style="margin: 0 5px;">

        <!-- T√≠tulos -->
        <button data-cmd-sec="formatBlock" data-val="H1" title="T√≠tulo 1 (A1)"><b>A1</b></button>
        <button data-cmd-sec="formatBlock" data-val="H2" title="T√≠tulo 2 (A2)"><b>A2</b></button>
        <button data-cmd-sec="formatBlock" data-val="H3" title="T√≠tulo 3 (A3)">A3</button>
        <button data-cmd-sec="formatBlock" data-val="H4" title="T√≠tulo 4 (A4)">A4</button>
        <button data-cmd-sec="formatBlock" data-val="P" title="Texto Normal">¬∂</button>
        <button data-action="insert-toggle-h2" title="T√≠tulo Expans√≠vel (A2 Toggle)">‚òÇ</button>
    </div>
    
    <div class="toolbar-separator"></div>

    <!-- Grupo 2: Checkbox e Linha -->
    <div class="toolbar-group">
        <button data-action="insert-checkbox" title="Inserir Caixa de Sele√ß√£o">‚òëÔ∏è</button>
        <button data-cmd-sec="insertHorizontalRule" title="Inserir Linha Separadora">‚Äï</button>
    </div>

    <div class="toolbar-separator"></div>

    <!-- Grupo 3: Widgets (Tabela, Data, Timeline) -->
    <div class="toolbar-group">
        <button data-action="insert-table" title="Inserir Tabela">üßÆ</button>
        <button data-action="insert-date" title="Inserir Data Atual">üìÖ</button>
        <button data-action="insert-timeline" title="Inserir Linha Cronol√≥gica">üå≥</button>
    </div>

    <div class="toolbar-separator"></div>

    <!-- Grupo 4: SCANNER (Movido para aqui, lugar antigo da cor) -->
    <div class="toolbar-group">
        <button data-action="bible-scan" title="Detetor Universal">üé∞</button>
    </div>
</div>

                <!-- 3. O EDITOR DE CONTE√öDO -->
                <div id="note-content-editor" contenteditable="true" spellcheck="true"></div>
            </div>
        </section>

        <!-- PAINEL DA DIREITA (QUARTA COLUNA) PARA REFER√äNCIAS -->
   <aside id="references-panel">
    <div class="panel-header">
        <h2 id="references-panel-title">Refer√™ncias</h2>
        <button id="references-panel-close-btn" title="Fechar">√ó</button>
    </div>
    
    <!-- Descri√ß√£o -->
    <p id="references-panel-description"></p>
    
    <!-- Barra de Ferramentas -->
    <hr class="references-separator">
    <div id="references-toolbar">
        <button id="references-refresh-btn" title="Atualizar">üîÑ</button>
        <button id="references-wol-btn" title="Ler na WOL" style="display: none;">üìñ</button>
        <button id="references-search-btn" title="Pesquisar na JW">üîç</button>
        <button id="references-edit-btn" title="Editar">‚úèÔ∏è</button>
        <button id="references-bookmark-btn" title="Marcadores" style="display: none;">üîñ</button> 
        <button id="references-toggle-btn" title="Expandir/Recolher">‚ÜïÔ∏è</button>
    </div>
    <hr class="references-separator">

    <!-- NOVAS ABAS: PUZZLE | REFER√äNCIAS -->
    <div class="tabs-container" id="ref-tabs">
        <button class="active" data-ref-tab="puzzle">üß© Puzzle</button>
        <button data-ref-tab="references">üìö Refer√™ncias</button>
    </div>

    <!-- CONTE√öDO DA ABA: PUZZLE -->
 <div id="ref-content-puzzle" class="ref-tab-content active" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 0 10px;">
    
    <!-- Cabe√ßalho do Quadro (CORRIGIDO) -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
        <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Quadro</h3>
        
        <!-- Grupo de Bot√µes de A√ß√£o -->
        <div id="puzzle-header-actions" style="display:flex; gap: 5px; align-items: center;">
            
            <!-- Bot√µes de Adicionar (S√≥ aparecem no modo edi√ß√£o) -->
            <div id="puzzle-add-buttons" style="display:none; gap:5px;">
                <!-- BOT√ÉO TELEPORTE -->
                <button id="teleport-puzzle-btn" title="Converter em Nota" style="background-color: #8e44ad; border: none; color: white; border-radius: 4px; padding: 4px 10px; cursor: pointer; font-size: 0.85em; line-height: 1;">üì°</button>    
                <button id="add-text-btn" title="Adicionar Texto" style="background-color: #3498db; border: none; color: white; border-radius: 4px; padding: 4px 10px; cursor: pointer; font-weight: bold; font-size: 0.85em;">+ Txt</button>
                <button id="add-ref-btn" title="Adicionar Refer√™ncia Existente" style="background-color: #2ecc71; border: none; color: white; border-radius: 4px; padding: 4px 10px; cursor: pointer; font-weight: bold; font-size: 0.85em;">+ Ref</button>
            </div>

            <!-- BOT√ÉO EDITAR/SALVAR (Estava a faltar ou mal posicionado no note.html) -->
            <button id="toggle-puzzle-edit-btn" style="background:none; border:1px solid var(--border-color); color:var(--text-muted-color); border-radius:4px; padding:4px 10px; cursor:pointer; transition: all 0.2s;">Editar</button>
        </div>
    </div>

    <!-- Contentor √önico (Quadro) -->
    <div id="puzzle-board-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;">
        <p id="puzzle-empty-msg" style="font-style:italic; color:var(--text-muted-color); font-size:0.9em; text-align:center;">
            O quadro est√° vazio. Clique em "Editar" para adicionar notas ou refer√™ncias.
        </p>
        <!-- Os cart√µes ser√£o inseridos aqui via JavaScript -->
    </div>
</div>

    <!-- CONTE√öDO DA ABA: REFER√äNCIAS (Original) -->
    <div id="ref-content-references" class="ref-tab-content" style="flex-grow: 1; overflow-y: auto; display: none;">
        <ul id="references-list">
            <!-- A lista original ser√° gerada aqui -->
        </ul>
    </div>
</aside>
    </div>

    <!-- NOVO MODAL: SELE√á√ÉO DE REFER√äNCIA PARA O QUADRO (Bot√£o Verde) -->
    <div id="puzzle-ref-selection-modal" class="modal-overlay" style="z-index: 2300;">
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3>Escolher Refer√™ncia</h3>
            <p style="font-size:0.9em; color:var(--text-muted-color); margin-bottom:10px;">
                Selecione uma ocorr√™ncia para adicionar ao Quadro:
            </p>
            
            <ul id="puzzle-ref-selection-list" class="move-list" style="flex-grow: 1; overflow-y: auto;">
                <!-- Lista gerada via JS -->
            </ul>

            <div class="modal-actions" style="margin-top: 15px;">
                <button class="modal-btn secondary" onclick="document.getElementById('puzzle-ref-selection-modal').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- PAINEL FLUTUANTE DE SELE√á√ÉO DE TEXTO (escondido) -->
<div id="selection-popup" style="display: none; position: absolute; z-index: 1010;">
    <button data-action="create-link" title="Criar Link / Anexo">üîó</button>
    <button data-action="break-link" title="Remover Link">‚õìÔ∏è‚Äçüí•</button> 
    <button data-action="create-entity" data-type="local" title="Local">üìç</button>
    <button data-action="create-entity" data-type="personagem" title="Personagem">üë§</button>
    <button data-action="create-entity" data-type="data" title="Data">üìÖ</button>
    <button data-action="create-entity" data-type="textobiblico" title="Texto B√≠blico">üìñ</button>
    <!-- Separador -->
    <div class="popup-separator"></div>
    <!-- Bot√£o de Post-it -->
    <button data-action="highlight" title="Criar Post-it">üìí</button>
    <button data-action="create-idea" title="Converter em Ideia">üí°</button>
    <button data-action="create-url-card" title="Criar Cart√£o Web">üé¥</button>

</div>


<!-- PAINEL DE INSER√á√ÉO R√ÅPIDA (Cursor parado) -->
<div id="insertion-popup" style="display: none; position: absolute; z-index: 1010;">
    <button data-action="quick-mini-note" title="Inserir Mini-Nota">üìò</button>
    <button data-action="insert-question" title="Inserir Quest√£o">üìó</button>
    <button data-action="insert-free-container" title="Inserir Contentor Livre">üìô</button>
    <div class="popup-separator"></div>
    <button data-action="quick-placeholder" title="Inserir Post-it">üìí</button>
</div>

    <!-- MODAL PARA ADICIONAR ITENS -->
    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Adicionar Item</h3>
            <div id="add-item-options">
                 <button data-type="pasta">üìÅ Criar Pasta</button>
                 <button data-type="nota">üìÑ Criar Nota</button>
                 <button data-type="agregacao">üß¨ Criar Agrega√ß√£o</button>
            </div>
            <input type="text" id="new-item-name" placeholder="Nome do item" style="display: none;">
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-item-addition" style="display: none;">Criar</button>
            </div>
        </div>
    </div>

    <!-- MENU DE CONTEXTO (3 PONTOS) - Fica escondido -->
  <div id="context-menu" class="context-menu" style="display: none;">
    <button data-action="rename">Mudar Nome</button>
    <button data-action="protect" style="display:none;">Proteger</button>
    <button data-action="unprotect" style="display:none;">Tirar Prote√ß√£o</button>
    <button data-action="move-position">Mover Posi√ß√£o</button>
    <button data-action="move-folder">Mover de Pasta</button> 
    <button data-action="manage-topics">Anexar T√≥pico</button>
    <button data-action="toggle-superfolder">Tornar Superpasta</button>
    <button data-action="hide">Ocultar</button>
</div>

<!-- NOVO MODAL PARA MOVER ITEM ENTRE PASTAS -->
<div id="move-to-folder-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Mover para a Pasta</h3>
        <p>Selecione a pasta de destino para "<span id="item-to-move-name"></span>".</p>
        <div id="move-modal-current-path"></div>
        <ul id="folder-selection-list" class="move-list" style="max-height: 50vh;">
            <!-- A lista de pastas ser√° preenchida via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="confirm-folder-move">Mover</button>
        </div>
    </div>
</div>

    <!-- MODAL PARA MOVER POSI√á√ÉO -->
    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover Item</h3>
            <ul id="move-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="save-order">Salvar Ordem</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO GEN√âRICO -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title">Voc√™ tem certeza?</h3>
            <p id="confirm-message">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="confirm">Confirmar</button>
            </div>
        </div>
    </div>
    
  <!-- MODAL DE CONFIGURA√á√ïES -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Configura√ß√µes</h3>
        
        <button class="modal-btn primary" data-action="show-hidden-items" style="width: 100%; margin-bottom: 20px;">
            Ver Pastas Ocultas
        </button>

        <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
        
        <h4 style="margin-bottom: 10px; color: var(--accent-color);">Privacidade & Pesquisa</h4>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
            Defina se os itens protegidos com palavra-passe devem aparecer no Painel de Refer√™ncias.
        </p>

        <div class="setting-toggle-container">
            <label class="setting-switch">
                <input type="checkbox" id="setting-search-tags">
                <span class="slider round"></span>
            </label>
            <span class="setting-label">Pesquisar <strong>Tags</strong> em Protegidos</span>
        </div>

        <div class="setting-toggle-container">
            <label class="setting-switch">
                <input type="checkbox" id="setting-search-topics">
                <span class="slider round"></span>
            </label>
            <span class="setting-label">Pesquisar <strong>T√≥picos</strong> em Protegidos</span>
        </div>

        <div class="setting-toggle-container">
            <label class="setting-switch">
                <input type="checkbox" id="setting-search-anchors">
                <span class="slider round"></span>
            </label>
            <span class="setting-label">Pesquisar <strong>√Çncoras</strong> em Protegidos</span>
        </div>

        <div class="setting-toggle-container">
            <label class="setting-switch">
                <input type="checkbox" id="setting-global-search-superfolder">
                <span class="slider round"></span>
            </label>
            <span class="setting-label">Pesquisar <strong>Globalmente</strong> dentro de Superpastas</span>
        </div>

        <div class="modal-actions" style="margin-top: 25px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

    <!-- MODAL MINHA CONTA -->
<div id="account-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Minha Conta</h3>
        
        <div class="profile-info">
            <span class="profile-avatar">üë§</span>
            <span id="profile-name-display" class="profile-name">Carregando...</span>
            <span id="profile-email-display" class="profile-email">...</span>
        </div>

        <button class="modal-btn secondary" id="logout-btn" style="width: 100%; background-color: #c0392b; color: white;">
            Sair da Conta (Logout)
        </button>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

    <!-- MODAL DE ITENS OCULTOS -->
    <div id="hidden-items-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Itens Ocultos</h3>
            <ul id="hidden-items-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR/EDITAR LINK (ANEXO) -->
   <div id="link-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="link-modal-title">Criar Anexo</h3>
            <input type="text" id="link-title-input" placeholder="T√≠tulo do anexo">
            <div id="link-urls-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; margin-top: 15px;">
            </div>
            <button id="add-url-btn" class="modal-btn" style="width: 100%; margin-bottom: 20px; background-color: var(--hover-color); text-align: center;">
                + Adicionar URL
            </button>
            <div class="modal-actions">
                <button class="modal-btn" id="link-remove-btn" style="background-color: #c0392b; color: white; display: none; margin-right: auto;">Remover Anexo</button>
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="link-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR ENTIDADE (Local, Personagem, Data) -->
    <div id="entity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="entity-modal-title">Criar Entidade</h3>
            <input type="text" id="entity-name-input" placeholder="Nome">
            <textarea id="entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 80px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
            <p id="entity-error-message" style="color: #e74c3c; display: none;">J√° existe uma entidade com este nome.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="entity-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA LISTAS (Tags, Anexos, etc.) -->
    <div id="generic-list-modal" class="modal-overlay">
    <div id="generic-list-modal-content" class="modal-content">
        <h3 id="generic-list-title">Lista</h3>
        <ul id="generic-list-content" class="move-list" style="max-height: 60vh;">
            <!-- O conte√∫do ser√° preenchido via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>
    <!-- MODAL DE √ÇNCORAS COM ABAS -->
    <div id="anchors-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Explorador de Entidades</h3>
            <div id="anchors-tabs-container" class="tabs-container" style="margin-bottom: 20px;">
                <!-- As abas ser√£o geradas via JS -->
            </div>
            <div id="anchors-content-container">
                <!-- O conte√∫do das abas ser√° gerado via JS -->
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA EDITAR ENTIDADE -->
<div id="edit-entity-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="edit-entity-title">Editar Entidade</h3>
        <input type="text" id="edit-entity-name-input" placeholder="Nome da entidade">
        <textarea id="edit-entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 120px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="edit-entity-save-btn">Gravar Altera√ß√µes</button>
        </div>
    </div>
</div>


    <!-- POPUP DE SUGEST√ÉO DE TAGS (escondido por padr√£o) -->
<div id="tag-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="tag-suggestion-list" class="suggestion-list"></ul>
</div>

<!-- POPUP DE SUGEST√ÉO DE ENTIDADES (escondido por padr√£o) -->
<div id="entity-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="entity-suggestion-list" class="suggestion-list"></ul>
</div>


<!-- MODAL DE HIST√ìRICO E BACKUP -->
<div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <h3 id="history-modal-title">Hist√≥rico da Nota</h3>
        <p>Crie um ponto de restauro ou restaure uma vers√£o anterior. A restaura√ß√£o cria uma <strong>nova nota</strong> com o conte√∫do do backup.</p>
        
        <button id="backup-now-btn" class="modal-btn primary" style="width: 100%; margin: 20px 0;">
            Fazer backup do estado atual
        </button>

        <h4>Backups existentes:</h4>
        <ul id="history-list-content" class="move-list" style="max-height: 40vh; margin-top: 10px;">
            <li>Nenhum backup encontrado.</li>
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER O CONTE√öDO DO BACKUP -->
<div id="view-backup-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 80vw; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="view-backup-title">Visualizando Backup</h3>
        <div id="view-backup-content" style="background-color: var(--bg-color); padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            <!-- Conte√∫do do backup aqui -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VISUALIZAR LINK -->
<div id="view-link-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="view-link-title">Visualizar Anexo</h3>
        <ul id="view-link-urls-list" class="move-list" style="margin-top: 20px; margin-bottom: 20px; max-height: 40vh;">
            <!-- URLs ser√£o preenchidas via JS -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn primary" id="view-link-edit-btn">Editar</button>
        </div>
    </div>
</div>

<!-- MODAL PRINCIPAL: SELE√á√ÉO DE T√ìPICOS -->
<div id="topics-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>T√≥picos da Nota</h3>
            <button id="manage-topics-btn" title="Criar/Gerir T√≥picos" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer;">+</button>
        </div>
        
        <div class="topics-layout">
            <!-- Coluna da Esquerda: Lista de T√≥picos -->
            <div class="topics-column">
                <h4>T√≥picos</h4>
                <ul id="topics-list-select" class="topics-list"></ul>
            </div>
            <!-- Coluna da Direita: Lista de Subt√≥picos -->
            <div class="topics-column">
                <h4 id="subtopics-title-select">Subt√≥picos</h4>
                <ul id="subtopics-list-select" class="topics-list">
                    <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="save-topics-btn">Gravar T√≥picos</button>
        </div>
    </div>
</div>

<!-- MODAL SECUND√ÅRIO: CRIA√á√ÉO DE T√ìPICOS (GEST√ÉO) -->
<div id="manage-topics-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
        <div style="margin-bottom: 15px;">
            <h3>Criar T√≥picos e Subt√≥picos</h3>
            <p style="font-size: 0.9em; color: var(--text-muted-color);">Adicione novos itens √† base de dados global.</p>
        </div>

        <div class="topics-layout">
            <!-- Coluna da Esquerda: Gerir T√≥picos -->
            <div class="topics-column">
                <button id="create-new-topic-btn" class="create-btn">+ Criar Novo T√≥pico</button>
                <input type="text" id="search-topic-input" placeholder="Filtrar t√≥picos..." class="topic-search-input">
                <ul id="topics-list-manage" class="topics-list"></ul>
            </div>
            <!-- Coluna da Direita: Gerir Subt√≥picos -->
            <div class="topics-column">
                <button id="create-new-subtopic-btn" class="create-btn" style="display: none;">+ Criar Novo Subt√≥pico</button>
                <ul id="subtopics-list-manage" class="topics-list">
                    <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico para adicionar subt√≥picos.</li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" id="close-manage-topics-btn">Voltar</button>
        </div>
    </div>
</div>

<!-- MODAL DE INPUT DUPLO (Nome + Descri√ß√£o) -->
<div id="custom-input-modal" class="modal-overlay" style="z-index: 1200;">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="custom-input-title">Novo Item</h3>
        
        <!-- Campo Nome -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Nome</label>
        <input type="text" id="custom-input-name" placeholder="Escreva o nome aqui..." 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <!-- Campo Descri√ß√£o (Novo) -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Descri√ß√£o <small>(Opcional)</small></label>
        <textarea id="custom-input-desc" placeholder="Detalhes adicionais..." 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none; font-family: inherit;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="custom-input-cancel">Cancelar</button>
            <button class="modal-btn primary" id="custom-input-confirm">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE PALAVRA-PASSE -->
<div id="password-modal" class="modal-overlay" style="z-index: 2000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3 id="password-modal-title">Proteger Item</h3>
        <p id="password-modal-desc" style="margin-bottom: 15px; font-size: 0.9em;">Defina uma palavra-passe.</p>
        
        <input type="password" id="password-input" placeholder="Palavra-passe" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <p id="password-error" style="color: #e74c3c; font-size: 0.9em; display: none; margin-bottom: 10px;">Palavra-passe incorreta.</p>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="password-confirm-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE GEST√ÉO DE MARCADORES (Lista) -->
<div id="bookmarks-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Marcadores</h3>
            <!-- Bot√£o '+' no canto superior direito -->
            <button id="open-create-bookmark-btn" title="Novo Marcador" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Selecione os marcadores para associar a este texto b√≠blico.
        </p>

        <ul id="bookmarks-list" class="move-list" style="max-height: 50vh;">
            <!-- A lista ser√° preenchida via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL DE CRIA√á√ÉO DE NOVO MARCADOR (Sub-popup) -->
<div id="create-bookmark-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Novo G√©nero de Marcador</h3>
        
        <input type="text" id="new-bookmark-title" placeholder="T√≠tulo (ex: Profecias)" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="new-bookmark-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-create-bookmark">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-bookmark">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE BLOQUEIO DE GRAVA√á√ÉO -->
<div id="forcing-save-modal" class="modal-overlay" style="z-index: 9999; background-color: rgba(0,0,0,0.8);">
    <div class="modal-content" style="text-align: center; max-width: 300px;">
        <div class="spinner" style="margin: 0 auto 15px auto; border-left-color: var(--accent-color);"></div>
        <h3 style="margin-bottom: 10px;">A Guardar...</h3>
        <p style="color: var(--text-muted-color);">Por favor, aguarde enquanto guardamos as suas altera√ß√µes.</p>
    </div>
</div>

<!-- POPUP DE ESCOLHA DE TAMANHO DO POST-IT -->
<div id="postit-size-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020; flex-direction: column; width: 180px; padding: 5px;">
    <button data-size="small" style="text-align:left; width:100%; border-radius:4px; padding:8px;">‚ñ´Ô∏è Pequeno</button>
    <button data-size="medium" style="text-align:left; width:100%; border-radius:4px; padding:8px;">‚óªÔ∏è M√©dio</button>
    <button data-size="large" style="text-align:left; width:100%; border-radius:4px; padding:8px;">‚¨ú Grande</button>
</div>

<!-- POPUP DE A√á√ïES DA IDEIA (‚úÇÔ∏è üß≤) -->
<div id="idea-actions-popup" style="display: none; position: absolute; background: var(--sidebar-color); border: 1px solid var(--border-color); padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; gap: 5px;">
    <button data-action="remove-idea" title="Remover Ideia" style="background:none; border:none; cursor:pointer; font-size:18px;">‚úÇÔ∏è</button>
    <button data-action="append-idea" title="Adicionar a outra nota" style="background:none; border:none; cursor:pointer; font-size:18px;">üß≤</button>
</div>

<!-- MODAL DE SELE√á√ÉO DE NOTA (Para transferir a ideia) -->
<div id="select-note-modal" class="modal-overlay" style="z-index: 2100;">
    <div class="modal-content">
        <h3>Adicionar Ideia a...</h3>
        <p style="font-size:0.9em; color:#888;">Selecione uma nota nesta pasta:</p>
        <ul id="select-note-list" class="move-list" style="max-height: 50vh;"></ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- NOVO MODAL DE DESTAQUES (POPUP CENTRAL) -->
<div id="highlight-modal" class="modal-overlay" style="z-index: 2200;">
    <div class="modal-content" style="max-width: 500px;">
        <h3>Escolher o Marcador</h3>
        <div id="highlight-options-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <!-- As cores ser√£o geradas aqui via JS -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- MENU FLUTUANTE PARA TABELAS -->
<div id="table-tools-popup">
    <div style="font-size:0.8em; color:#888; width:100%; text-align:center; padding-bottom:4px;">Tabela</div>
    <button data-action="add-row-above" title="Linha Acima">‚¨ÜÔ∏è Linha</button>
    <button data-action="add-row-below" title="Linha Abaixo">‚¨áÔ∏è Linha</button>
    <button data-action="add-col-left" title="Coluna Esquerda">‚¨ÖÔ∏è Coluna</button>
    <button data-action="add-col-right" title="Coluna Direita">‚û°Ô∏è Coluna</button>
    <div class="sep"></div>
    <button data-action="del-row" title="Apagar Linha" style="color:#e74c3c;">‚ùå Linha</button>
    <button data-action="del-col" title="Apagar Coluna" style="color:#e74c3c;">‚ùå Coluna</button>
    <button data-action="del-table" title="Apagar Tabela Inteira" style="width:100%; border-color:#e74c3c; color:#e74c3c; margin-top:3px;">üóëÔ∏è Apagar Tabela</button>
</div>


<!-- MODAL DE TAREFA DE CALEND√ÅRIO -->
<div id="calendar-task-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Agenda: <span id="cal-selected-date-display"></span></h3>
        <input type="hidden" id="cal-selected-date-iso"> <!-- Guarda YYYY-MM-DD -->
        
        <textarea id="cal-task-desc" placeholder="Descreva a tarefa ou evento..." 
                  style="width: 100%; height: 100px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); margin-bottom: 15px; resize: none;"></textarea>
        
        <!-- Lista de tarefas existentes neste dia -->
        <div id="cal-existing-tasks" style="margin-bottom: 15px; max-height: 100px; overflow-y: auto;"></div>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="cal-save-task-btn">Gravar Tarefa</button>
        </div>
    </div>
</div>

<!-- MODAL DE AGREGA√á√ÉO (SELETOR DE CONTE√öDO) -->
<div id="aggregation-modal" class="modal-overlay" style="z-index: 1500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        <h3>Criar Agrega√ß√£o: <span id="aggregation-new-name" style="color: var(--accent-color);"></span></h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue pelas pastas e notas. Selecione as caixas que deseja copiar para esta nova nota.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs e Bot√£o Voltar) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="agreg-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="agreg-current-path" style="font-weight: bold; color: var(--text-color);">Pasta Raiz</span>
        </div>

        <!-- Lista de Conte√∫do (Pastas, Notas ou Caixas) -->
        <ul id="aggregation-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px;">
            <!-- Preenchido via JS -->
        </ul>

        <!-- Rodap√© com Contador e Bot√£o Criar -->
        <div class="modal-actions" style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px; align-items: center;">
            <span id="agreg-count" style="margin-right: auto; font-weight: bold; color: var(--accent-color);">0 itens selecionados</span>
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="agreg-finish-btn">Criar Agrega√ß√£o</button>
        </div>
    </div>
</div>

<!-- MODAL DE CLONAR PARA NOTA (DESTINO) -->
<div id="append-to-note-modal" class="modal-overlay" style="z-index: 1600;">
    <div class="modal-content" style="max-width: 500px; height: 70vh; display: flex; flex-direction: column;">
        <h3>Enviar para...</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue e selecione a <strong>Nota</strong> onde deseja colar este conte√∫do.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="append-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="append-current-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        </div>

        <!-- Lista de Pastas e Notas -->
        <ul id="append-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px; overflow-y: auto;">
            <!-- Preenchido via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- POPUP DE DEFINI√á√ïES DE PARTILHA DA CAIXA -->
<div id="share-settings-popup">
    <h4>Seguran√ßa da Caixa</h4>
    <div class="share-toggle-row">
        <span>Permitir Partilha</span>
        <label class="setting-switch">
            <input type="checkbox" id="mini-note-share-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    <p style="font-size: 0.75em; color: var(--text-muted-color); margin-top: 10px; line-height: 1.3;">
        Se desativado, o conte√∫do n√£o aparecer√° em links p√∫blicos, mesmo que tenham sido gerados anteriormente.
    </p>
</div>

<!-- POPUP DE PARTILHA DA NOTA INTEIRA -->
<div id="note-share-popup" style="display: none; position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 2200; padding: 15px; width: 260px; flex-direction: column; gap: 10px;">
    <h4 style="margin: 0 0 10px 0; font-size: 0.9em; text-transform: uppercase; color: var(--text-muted-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">Partilha da Nota</h4>
    
    <div class="share-toggle-row" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; color: var(--text-color);">
        <span>Link P√∫blico</span>
        <label class="setting-switch">
            <input type="checkbox" id="note-share-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    
    <div id="note-share-link-container" style="display: none; margin-top: 10px;">
        <input type="text" id="note-share-url" readonly style="width: 100%; padding: 5px; font-size: 0.85em; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-muted-color); margin-bottom: 5px;">
        <button id="copy-note-link-btn" style="width: 100%; padding: 5px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Copiar Link</button>
    </div>

    <p style="font-size: 0.75em; color: var(--text-muted-color); margin-top: 5px; line-height: 1.3;">
        Ao ativar, qualquer pessoa com o link poder√° ler esta nota (mas n√£o editar).
    </p>
</div>

<!-- POPUP DE CORES DO TOGGLE -->
<div id="toggle-color-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 2500; width: 160px; padding: 10px;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        <!-- As cores ser√£o geradas aqui ou fixas -->
        <button class="color-choice" style="background-color: #ffcdd2;" data-color="#ffcdd2" title="Rosa Suave"></button>
        <button class="color-choice" style="background-color: #ffe0b2;" data-color="#ffe0b2" title="Laranja P√™ssego"></button>
        <button class="color-choice" style="background-color: #fff9c4;" data-color="#fff9c4" title="Amarelo Creme"></button>
        <button class="color-choice" style="background-color: #c8e6c9;" data-color="#c8e6c9" title="Verde Menta"></button>
        <button class="color-choice" style="background-color: #b3e5fc;" data-color="#b3e5fc" title="Azul C√©u"></button>
        <button class="color-choice" style="background-color: #e1bee7;" data-color="#e1bee7" title="Lil√°s"></button>
    </div>
    <div style="margin-top: 8px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 5px;">
        <button class="color-choice-reset" style="background: none; border: none; font-size: 0.8em; color: var(--text-muted-color); cursor: pointer;">Sem Cor</button>
    </div>
</div>

<!-- MODAL DE SCANNER UNIVERSAL (üé∞) -->
<div id="universal-scan-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column; padding: 0;">
        
        <!-- Cabe√ßalho com Abas -->
        <div class="scan-header" style="padding: 15px 15px 0 15px; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 15px;">Detetor de Entidades</h3>
            <div class="scan-tabs">
                <button class="scan-tab-btn active" data-target="textobiblico">üìñ B√≠blia</button>
                <button class="scan-tab-btn" data-target="personagem">üë§ Personagens</button>
                <button class="scan-tab-btn" data-target="local">üìç Locais</button>
                <button class="scan-tab-btn" data-target="data">üìÖ Datas</button>
            </div>
        </div>

        <!-- Corpo das Listas -->
        <div class="scan-body" style="flex-grow: 1; overflow-y: auto; padding: 15px; position: relative;">
            
            <!-- Contentor para as listas (Preenchido via JS) -->
            <div id="scan-lists-container">
                <!-- As listas <ul> ser√£o geradas aqui dinamicamente -->
            </div>

            <!-- POPUP DE PREVIEW (CONTEXTO) -->
            <div id="scan-preview-popup" style="display: none;">
                <div class="preview-header">
                    <strong>Contexto</strong>
                    <button onclick="document.getElementById('scan-preview-popup').style.display='none'">√ó</button>
                </div>
                <div id="scan-preview-content"></div>
            </div>

        </div>

        <!-- Rodap√© -->
        <div class="modal-actions" style="padding: 15px; border-top: 1px solid var(--border-color);">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn secondary" id="scan-toggle-all-btn" style="margin-right: auto;">Selecionar Todos</button>
            <button class="modal-btn primary" id="confirm-scan-btn">Converter Selecionados</button>
        </div>
    </div>
</div>


</body>


   <script type="module">
    
  // 1. Importa√ß√µes de Configura√ß√£o
    import { db, auth } from './js/firebase-config.js';
    
    // 2. Importa√ß√µes do Firestore
    import { 
    collection, query, where, addDoc, serverTimestamp, onSnapshot, 
    doc, getDoc, updateDoc, orderBy, getDocs, writeBatch, deleteField, deleteDoc,
    setDoc, limit, startAfter // <--- ADICIONE ESTES DOIS
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // 3. Importa√ß√µes de Autentica√ß√£o
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";






document.addEventListener('DOMContentLoaded', () => {
    checkInitialConnection(); // Verifica a conex√£o ao carregar

    // 1. Gravar ao mudar de aba ou minimizar (Muito fi√°vel em telem√≥veis e PC)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        // Se a aba ficou oculta, tenta gravar imediatamente
        if (currentSaveStatus === 'unsaved') {
            console.log("Aba oculta: A for√ßar grava√ß√£o...");
            executeSave(); 
        }
    }
});

// 2. Gravar ao perder o foco da janela (ex: clicar noutra janela do Windows)
window.addEventListener('blur', () => {
    if (currentSaveStatus === 'unsaved') {
        console.log("Janela perdeu foco: A for√ßar grava√ß√£o...");
        executeSave();
    }
});

    const modalObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const target = mutation.target;
                
                // Se o modal passou de 'none' para 'flex' (ou seja, abriu)
                if (target.style.display !== 'none' && target.style.display !== '') {
                    
                    // 1. Fecha a Barra de Ferramentas de Sele√ß√£o
                    if (selectionPopup) selectionPopup.style.display = 'none';

                    // 2. (Opcional) Fecha tamb√©m popups de sugest√£o (@ e #) se estiverem abertos
                    if (tagSuggestionPopup) tagSuggestionPopup.style.display = 'none';
                    if (entitySuggestionPopup) entitySuggestionPopup.style.display = 'none';
                    if (isTagPopupOpen) isTagPopupOpen = false;
                    if (isEntityPopupOpen) isEntityPopupOpen = false;
                }
            }
        });
    });

    // Ativa o observador em todos os elementos com a classe .modal-overlay
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modalObserver.observe(modal, { 
            attributes: true, 
            attributeFilter: ['style'] // S√≥ vigia altera√ß√µes no estilo (display block/none)
        });
    });
});

// --- REFER√äNCIAS AO DOM ---
const notebookContainer = document.querySelector('.notebook-container');
const leftPanelToggleBtn = document.getElementById('left-panel-toggle-btn');
const referencesPanel = document.getElementById('references-panel');
const referencesPanelTitle = document.getElementById('references-panel-title');
const referencesList = document.getElementById('references-list');
const referencesPanelCloseBtn = document.getElementById('references-panel-close-btn');
const leftPanelList = document.getElementById('left-panel-list');
const leftPanelTitle = document.getElementById('left-panel-title');
function setLeftPanelTitle(title) { if (leftPanelTitle) { leftPanelTitle.textContent = title; } }
const middlePanelList = document.getElementById('file-list');
const middlePanelTitle = document.getElementById('middle-panel-title');
const backBtn = document.getElementById('back-btn');
const addItemBtn = document.getElementById('add-item-btn');
const editorPlaceholder = document.getElementById('editor-placeholder');
const editorArea = document.getElementById('editor-area');
const noteTitleInput = document.getElementById('note-title-input');
const newItemNameInput = document.getElementById('new-item-name');
const editorToolbar = document.getElementById('editor-toolbar');
const noteContentEditor = document.getElementById('note-content-editor');
const selectionPopup = document.getElementById('selection-popup');
const tagSuggestionPopup = document.getElementById('tag-suggestion-popup');
const tagSuggestionList = document.getElementById('tag-suggestion-list');
const saveStatusIndicator = document.getElementById('save-status-indicator');
const connectivityStatus = document.getElementById('connectivity-status');
const entitySuggestionPopup = document.getElementById('entity-suggestion-popup');
const entitySuggestionList = document.getElementById('entity-suggestion-list');
const noteSharePopup = document.getElementById('note-share-popup');
const noteShareToggle = document.getElementById('note-share-toggle');
const noteShareLinkContainer = document.getElementById('note-share-link-container');
const noteShareUrlInput = document.getElementById('note-share-url');
const copyNoteLinkBtn = document.getElementById('copy-note-link-btn');
const mobileBackBtn = document.getElementById('mobile-back-btn');
const SUPERFOLDER_ID = null;
const debouncedScanAndLink = debounce(scanAndLinkEntities, 2000);
const ENTITY_CONFIG = {
    personagem: {
        collection: 'personagens',
        displayName: 'Personagens'
    },
    local: {
        collection: 'locais',
        displayName: 'Locais'
    },
    data: {
        collection: 'datas',
        displayName: 'Datas'
    },
    textobiblico: {
        collection: 'textosbiblicos',
        displayName: 'Textos B√≠blicos'
    }
};
const BIBLICAL_BOOKS = [
    'G√©nesis', '√äxodo', 'Lev√≠tico', 'N√∫meros', 'Deuteron√≥mio', 'Josu√©', 'Ju√≠zes', 'Rute', 
    '1 Samuel', '2 Samuel', '1 Reis', '2 Reis', '1 Cr√≥nicas', '2 Cr√≥nicas', 'Esdras', 'Neemias', 'Ester', 
    'J√≥', 'Salmos', 'Prov√©rbios', 'Eclesiastes', 'C√¢ntico de Salom√£o', 'Isa√≠as', 'Jeremias', 'Lamenta√ß√µes', 
    'Ezequiel', 'Daniel', 'Oseias', 'Joel', 'Am√≥s', 'Obadias', 'Jonas', 'Miqueias', 'Naum', 'Habacuque', 
    'Sofonias', 'Ageu', 'Zacarias', 'Malaquias', 'Mateus', 'Marcos', 'Lucas', 'Jo√£o', 'Atos', 'Romanos', 
    '1 Cor√≠ntios', '2 Cor√≠ntios', 'G√°latas', 'Ef√©sios', 'Filipenses', 'Colossenses', 
    '1 Tessalonicenses', '2 Tessalonicenses', '1 Tim√≥teo', '2 Tim√≥teo', 'Tito', 'Fil√©mom', 'Hebreus', 
    'Tiago', '1 Pedro', '2 Pedro', '1 Jo√£o', '2 Jo√£o', '3 Jo√£o', 'Judas', 'Apocalipse'
];
// 10 Cores diferentes das padr√£o (Azul/Verde/Laranja)
const DEFAULT_HIGHLIGHTS = [
    { code: "#FF8A80", name: "Vermelho Coral" },    // Vermelho avermelhado
    { code: "#FFD180", name: "Laranja Sol" },       // Laranja bem distinto
    { code: "#FFFF8D", name: "Amarelo Intenso" },   // Amarelo "Post-it" forte
    { code: "#CCFF90", name: "Verde Lima" },        // Verde amarelado
    { code: "#69F0AE", name: "Verde Esmeralda" },   // Verde menta forte
    { code: "#84FFFF", name: "Turquesa" },          // Ciano vibrante
    { code: "#EA80FC", name: "Roxo Lavanda" },      // Roxo el√©trico claro
    { code: "#FF80AB", name: "Rosa Choque" },       // Rosa forte
    { code: "#CFD8DC", name: "Cinza Met√°lico" }     // Neutro
];
const EXPLORER_RESULTS_PER_PAGE = 15;


// --- ESTADO DA APLICA√á√ÉO ---
  let currentUserData = null;
let allEntities = {};
let sessionUnlockedFolders = new Set(); 
let navigationStack = [];
let selectedNoteId = null;
let unsubscribeLeftPanel = null;
let unsubscribeMiddlePanel = null;
let saveTimeout = null;
let activeItemContext = null;
let currentSelectionRange = null;
let allTags = [];
let isTagPopupOpen = false;
let currentTagQueryRange = null;
let currentSaveStatus = 'hidden';
let isEntityPopupOpen = false;
let currentEntityQueryRange = null;
let activeReferenceEntity = { id: null, type: null, name: null };
let currentTab = 'note';
let currentNoteTopics = {}; // Estado local dos t√≥picos da nota: { topicId: [subId1, subId2] }
let activeTopicIdForSelection = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Sele√ß√£o)
let activeTopicIdForManagement = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Gest√£o)
let topicTargetId = null; 
let appSettings = {
    searchTagsInProtected: false,
    searchTopicsInProtected: false,
    searchAnchorsInProtected: false,
    searchGlobalInSuperfolder: false 
};
let currentBookmarkSort = 'texto'; // Op√ß√µes: 'texto', 'categoria', 'descricao'
let savedRange = null;
let activeMiniNoteElement = null;
let activeWrapperForColor = null; // Qual caixa estamos a editar
let userCustomHighlights = {}; // Cache dos nomes personalizados
let aggregationStack = []; // Para navegar nas pastas dentro do modal
let aggregationSelectedItems = []; // Guarda o HTML das caixas selecionadas
let aggregationTargetName = ""; // Nome da nova nota a criar
let aggregationParentId = null; // Onde a nova nota ser√° criada
let htmlToAppend = ""; // Guarda o conte√∫do da caixa que vamos copiar
let appendStack = [];  // Hist√≥rico de navega√ß√£o do modal
let currentNoteShareData = null;
let moveStack = []; // Hist√≥rico de navega√ß√£o (como no Append/Aggregation)
let itemToMoveRef = null; // Guarda o objeto do item que estamos a mover
let selectedDestFolderId = null; // Guarda o ID da pasta destino selecionada
let globalExplorerResults = []; // Guarda todos os resultados (Pastas + Notas)
let currentExplorerPage = 0;
let moveFolderLastDoc = null;


// --- PROTE√á√ÉO DE ROTA E CARREGAMENTO DE USU√ÅRIO ---
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "index.html";
    } else {
        console.log("Logado (Raiz):", user.email);

        // 1. Carregar Perfil
        try {
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
            } else {
                currentUserData = { nome: "Usu√°rio", email: user.email };
                await setDoc(userDocRef, { email: user.email }, { merge: true }); 
            }
        } catch (e) { console.error(e); }

        // 2. Carregar Configura√ß√µes
        try {
            const configRef = doc(db, "configuracoes", user.uid);
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) {
                const savedSettings = configSnap.data();
                appSettings = { ...appSettings, ...savedSettings };
                
                // Atualiza UI das configura√ß√µes
                if (document.getElementById('setting-search-tags')) {
                    document.getElementById('setting-search-tags').checked = appSettings.searchTagsInProtected;
                    document.getElementById('setting-search-topics').checked = appSettings.searchTopicsInProtected;
                    document.getElementById('setting-search-anchors').checked = appSettings.searchAnchorsInProtected;
                    const globalSearchToggle = document.getElementById('setting-global-search-superfolder');
                    if (globalSearchToggle) globalSearchToggle.checked = appSettings.searchGlobalInSuperfolder;
                }
            }
        } catch (e) { console.error(e); }

        // 3. DETETAR REDIRECIONAMENTO (Deep Linking)
        const params = new URLSearchParams(window.location.search);
        const redirectNoteId = params.get('noteId');
        const redirectFolderId = params.get('folderId'); // Opcional, ajuda a reconstruir breadcrumbs
        const redirectSearch = params.get('search');

        if (redirectNoteId) {
            console.log("üöÄ Redirecionamento detetado em note.html:", redirectNoteId);
            
            // A. Tenta reconstruir o caminho visual (Pastas da esquerda/meio)
            // Se tivermos a fun√ß√£o reconstructNavigationPath (que eu enviei antes), usamos ela.
            // Se n√£o, usamos a l√≥gica simples.
            if (typeof reconstructNavigationPath === 'function') {
                await reconstructNavigationPath(redirectNoteId);
            } else {
                // Fallback simples se a fun√ß√£o n√£o existir
                if (redirectFolderId) {
                    try {
                        const fSnap = await getDoc(doc(db, 'pastas', redirectFolderId));
                        if (fSnap.exists()) {
                            navigationStack = [{ id: redirectFolderId, name: fSnap.data().nome }];
                            updateNavigationView(true);
                        }
                    } catch(e) {}
                }
            }

            // B. Abre a nota
            setTimeout(() => {
                displayNote(redirectNoteId, null, redirectSearch);
            }, 500);
        } 
        else {
            // 4. ARRANQUE NORMAL (Sem redirecionamento)
            // Carrega a lista da raiz (Pastas)
            updateNavigationView();
        }

        // 5. Carregar Caches
        fetchAllEntities();
        fetchAllTags();
        loadUserHighlights();
    }
});

// --- FUN√á√ÉO PARA SALVAR CONFIGURA√á√ïES ---
async function saveUserSettings() {
    if (!auth.currentUser) return;
    
    // 1. Atualiza o objeto local com o estado atual dos checkboxes
    appSettings.searchTagsInProtected = document.getElementById('setting-search-tags').checked;
    appSettings.searchTopicsInProtected = document.getElementById('setting-search-topics').checked;
    appSettings.searchAnchorsInProtected = document.getElementById('setting-search-anchors').checked;

    const globalSearchToggle = document.getElementById('setting-global-search-superfolder');
    if (globalSearchToggle) {
        appSettings.searchGlobalInSuperfolder = globalSearchToggle.checked;
    }

    console.log("A tentar guardar configura√ß√µes:", appSettings);

    // 2. Grava na cole√ß√£o 'configuracoes' usando o ID do usu√°rio
    try {
        const configRef = doc(db, 'configuracoes', auth.currentUser.uid);
        
        // Usamos setDoc com merge para criar ou atualizar
        await setDoc(configRef, appSettings, { merge: true });
        
        console.log("Configura√ß√µes guardadas com sucesso em 'configuracoes/" + auth.currentUser.uid + "'");
        
        // Opcional: Feedback visual r√°pido
        const originalTitle = document.querySelector('#settings-modal h3').textContent;
        document.querySelector('#settings-modal h3').textContent = "Configura√ß√µes (Guardado!)";
        setTimeout(() => {
            document.querySelector('#settings-modal h3').textContent = originalTitle;
        }, 2000);

        // For√ßa uma atualiza√ß√£o da vista atual para aplicar as mudan√ßas imediatamente
        // (Se estiver com um painel de refer√™ncias aberto, por exemplo)
        if (activeReferenceEntity.id) {
             // Se tiver um painel aberto, atualiza-o
             if (activeReferenceEntity.type === 'topico' || activeReferenceEntity.type === 'subtopico') {
                 showTopicReferencesPanel(activeReferenceEntity.id, activeReferenceEntity.name, null, activeReferenceEntity.type);
             } else {
                 showReferencesPanel(activeReferenceEntity.id, activeReferenceEntity.name, activeReferenceEntity.type);
             }
        }

    } catch (e) {
        console.error("Erro ao guardar configura√ß√µes:", e);
        alert("Erro ao guardar as defini√ß√µes. Verifique a consola.");
    }
}

// Adicione os listeners aos checkboxes
document.getElementById('setting-search-tags').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-topics').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-anchors').addEventListener('change', saveUserSettings);

const globalSearchToggle = document.getElementById('setting-global-search-superfolder');
if (globalSearchToggle) {
    globalSearchToggle.addEventListener('change', saveUserSettings);
}



// --- GEST√ÉO DE ESTADO E CONECTIVIDADE ---

function updateSaveStatus(status) {
    currentSaveStatus = status;
    if (!saveStatusIndicator) return;

    saveStatusIndicator.classList.remove('status-saved', 'status-error');
    switch (status) {
        case 'unsaved':
            saveStatusIndicator.textContent = 'por guardar...';
            break;
        case 'saving':
            saveStatusIndicator.textContent = 'A guardar...';
            break;
        case 'saved':
            saveStatusIndicator.textContent = 'Guardado';
            saveStatusIndicator.classList.add('status-saved');
            break;
        case 'error':
            saveStatusIndicator.textContent = 'Erro ao guardar';
            saveStatusIndicator.classList.add('status-error');
            break;
        case 'hidden':
        default:
            saveStatusIndicator.textContent = '';
            break;
    }
}

function handleOffline() {
    connectivityStatus.textContent = 'Sem liga√ß√£o';
    connectivityStatus.classList.add('visible');
    updateSaveStatus('error'); 
    saveStatusIndicator.textContent = 'Offline - Altera√ß√µes n√£o guardadas';
}

function handleOnline() {
    connectivityStatus.classList.remove('visible');
    updateSaveStatus('saving');
    clearTimeout(saveTimeout);
    saveNote();
}

function checkInitialConnection() {
    if (!navigator.onLine) {
        handleOffline();
    }
}

/**
 * Verifica se existem altera√ß√µes n√£o guardadas antes de executar uma a√ß√£o de navega√ß√£o.
 * @param {function} navigationAction A fun√ß√£o a ser executada se a navega√ß√£o for confirmada.
 */
async function navigateWithUnsavedCheck(navigationAction) {
    // Se o estado for 'unsaved' (por guardar) ou 'saving' (a guardar)
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        
        const savingModal = document.getElementById('forcing-save-modal');
        
        try {
            // 1. Mostrar o painel de "A Guardar..."
            savingModal.style.display = 'flex';

            // 2. For√ßar a grava√ß√£o imediata e ESPERAR que termine (await)
            await saveNote(true);

            // 3. Esconder o painel
            savingModal.style.display = 'none';

            // 4. Executar a navega√ß√£o (mudar de p√°gina/nota)
            navigationAction();

        } catch (error) {
            // Se der erro ao gravar (ex: sem internet), remove o modal e avisa
            savingModal.style.display = 'none';
            alert("N√£o foi poss√≠vel guardar as altera√ß√µes. A navega√ß√£o foi cancelada para n√£o perder dados.");
        }
    } else {
        // Se j√° estava guardado, navega logo
        navigationAction();
    }
}

// --- 1. FUN√á√ïES DE ABERTURA E RENDERIZA√á√ÉO (MODAL SELE√á√ÉO) ---

async function openTopicsModal(targetId, type) {
    if (!targetId) return alert("Erro: Nenhum item selecionado.");

    topicTargetId = targetId; // Define quem estamos a editar
    
    // Atualiza o T√≠tulo do Modal dinamicamente
    const modalTitle = document.querySelector('#topics-modal h3');
    const typeName = type === 'pasta' ? 'Pasta' : 'Nota';
    modalTitle.textContent = `T√≥picos da ${typeName}`;

    // 1. Carregar estado atual do item alvo (Pasta ou Nota)
    const docSnap = await getDoc(doc(db, 'pastas', targetId)); // 'pastas' √© a cole√ß√£o, mesmo para pastas
    
    if (docSnap.exists()) {
        currentNoteTopics = docSnap.data().topicosSelecionados || {}; 
    } else {
        currentNoteTopics = {};
    }

    activeTopicIdForSelection = null;
    document.getElementById('topics-modal').style.display = 'flex';
    
    await renderTopicsSelectionList();
}

async function renderTopicsSelectionList() {
    const list = document.getElementById('topics-list-select');
    list.innerHTML = '<li>A carregar...</li>';

    
    const q = query(
    collection(db, 'topicos'), 
    where('userId', '==', auth.currentUser.uid), // <--- ADICIONAR
    orderBy('nome')
);
    const snapshot = await getDocs(q);
    
    list.innerHTML = '';
    
    if (snapshot.empty) {
        list.innerHTML = '<li>Nenhum t√≥pico criado.</li>';
        return;
    }

    snapshot.forEach(doc => {
        const topic = { id: doc.id, ...doc.data() };
        const isSelected = currentNoteTopics.hasOwnProperty(topic.id);
        
        const li = document.createElement('li');
        if (topic.id === activeTopicIdForSelection) li.classList.add('active-topic');

        // Checkbox: Seleciona/Desseleciona o t√≥pico para a nota
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'topic-checkbox';
        checkbox.checked = isSelected;
        checkbox.onclick = (e) => {
            e.stopPropagation(); // N√£o ativa o click do li
            toggleTopicSelection(topic.id, checkbox.checked);
        };

        const span = document.createElement('span');
        span.textContent = topic.nome;
        span.style.flexGrow = '1';

        li.appendChild(checkbox);
        li.appendChild(span);

        // Click no LI: Carrega os subt√≥picos na direita
        li.onclick = () => {
            // Remove classe active dos outros
            list.querySelectorAll('li').forEach(el => el.classList.remove('active-topic'));
            li.classList.add('active-topic');
            activeTopicIdForSelection = topic.id;
            renderSubtopicsSelectionList(topic.id, topic.nome);
        };

        list.appendChild(li);
    });
}

async function renderSubtopicsSelectionList(topicId, topicName) {
    const list = document.getElementById('subtopics-list-select');
    const title = document.getElementById('subtopics-title-select');
    
    title.textContent = `Subt√≥picos de "${topicName}"`;
    list.innerHTML = '<li>A carregar...</li>';

    const q = query( collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome') );
    const snapshot = await getDocs(q);

    list.innerHTML = '';

    if (snapshot.empty) {
        list.innerHTML = '<li style="font-style:italic; color: #888;">Nenhum subt√≥pico dispon√≠vel.</li>';
        return;
    }

    // Obt√©m os subt√≥picos j√° selecionados para este t√≥pico espec√≠fico
    const selectedSubtopics = currentNoteTopics[topicId] || [];

    snapshot.forEach(doc => {
        const sub = { id: doc.id, ...doc.data() };
        const isSelected = selectedSubtopics.includes(sub.id);

        const li = document.createElement('li');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'topic-checkbox';
        checkbox.checked = isSelected;
        
        checkbox.onclick = (e) => {
            e.stopPropagation();
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };
        
        // Clicar na linha tamb√©m seleciona
        li.onclick = () => {
            checkbox.checked = !checkbox.checked;
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };

        const span = document.createElement('span');
        span.textContent = sub.nome;

        li.appendChild(checkbox);
        li.appendChild(span);
        list.appendChild(li);
    });
}

// --- 2. L√ìGICA DE SELE√á√ÉO (ESTADO LOCAL) ---

function toggleTopicSelection(topicId, isChecked) {
    if (isChecked) {
        // Se n√£o existia, cria entrada (array vazio de subt√≥picos)
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
        }
    } else {
        // Se desmarcar o t√≥pico, removemos tudo (incluindo subt√≥picos)
        delete currentNoteTopics[topicId];
        // Se este era o t√≥pico ativo na direita, atualiza a UI da direita
        if (activeTopicIdForSelection === topicId) {
             const subInputs = document.querySelectorAll('#subtopics-list-select input');
             subInputs.forEach(input => input.checked = false);
        }
    }
}

function toggleSubtopicSelection(topicId, subtopicId, isChecked) {
    // Se selecionar um subt√≥pico, garantimos que o pai est√° selecionado
    if (isChecked) {
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
            // Atualiza visualmente o checkbox do pai na esquerda
            renderTopicsSelectionList(); // Re-renderiza para atualizar o check
        }
        if (!currentNoteTopics[topicId].includes(subtopicId)) {
            currentNoteTopics[topicId].push(subtopicId);
        }
    } else {
        // Remove o subt√≥pico do array
        if (currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = currentNoteTopics[topicId].filter(id => id !== subtopicId);
        }
    }
}

// 1. EVENTO MOUSEDOWN: Formata√ß√£o (Negrito, It√°lico, Tamanho, Cor Azul)
editorToolbar.addEventListener('mousedown', (e) => {
    const target = e.target.closest('button');
    
    // Se n√£o for bot√£o ou for o input de cor, ignoramos aqui (deixa o navegador tratar)
    if (!target || target.tagName === 'INPUT') return;

    // Se o bot√£o tiver um comando de formata√ß√£o (data-command)
    if (target.dataset.command) {
        // A. IMPORTANTE: Previne que o bot√£o roube o foco do editor
        e.preventDefault();

        const command = target.dataset.command;

        // B. Executa o comando
        if (command.includes('FontSize')) {
            // L√≥gica de Tamanho de Fonte
            const currentSize = window.getComputedStyle(noteContentEditor, null).getPropertyValue('font-size');
            let newSize = parseFloat(currentSize) + (command === 'increaseFontSize' ? 1 : -1);
            
            // Truque para mudar tamanho
            document.execCommand("fontSize", false, "7");
            const selection = window.getSelection();
            if (selection.anchorNode && selection.anchorNode.parentNode) {
                let fontElement = selection.anchorNode.parentNode;
                // Sobe at√© encontrar o elemento font, se necess√°rio
                if (fontElement.nodeType === 3) fontElement = fontElement.parentNode;
                
                if (fontElement.tagName === 'FONT') {
                    fontElement.removeAttribute('size');
                    fontElement.style.fontSize = newSize + "px";
                }
            }
        } 
        else if (command === 'boldBlue') {
            document.execCommand('bold', false, null);
            document.execCommand('foreColor', false, '#4a90e2');
        } 
        else {
            // Comandos Normais (Bold, Italic, Underline)
            document.execCommand(command, false, null);
        }

        // C. Gravar altera√ß√µes
        saveNote();
    }
});

// 2. EVENTO INPUT: Apenas para o Seletor de Cores (Color Picker)
editorToolbar.addEventListener('input', (e) => {
    const target = e.target;
    // Se for o input de cor
    if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
        // Tenta restaurar a sele√ß√£o se existir
        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);
        }
        document.execCommand('foreColor', false, target.value);
        saveNote(); 
    }
});



// ------------------------------------------------------------------
// L√ìGICA DE MARCADORES (BOOKMARKS)
// ------------------------------------------------------------------

// 1. Abrir o Modal Principal de Marcadores
async function openBookmarksModal() {
    if (!activeReferenceEntity || activeReferenceEntity.type !== 'textobiblico') return;

    const modal = document.getElementById('bookmarks-modal');
    const list = document.getElementById('bookmarks-list');
    
    modal.style.display = 'flex';
    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar marcadores...</span></div>';

    try {
        const marcadoresRef = collection(db, 'marcadores');
        const qMarcadores = query(marcadoresRef, where('userId', '==', auth.currentUser.uid), orderBy('nome'));
        const marcadoresSnap = await getDocs(qMarcadores);

        const textoRef = doc(db, 'textosbiblicos', activeReferenceEntity.id);
        const textoSnap = await getDoc(textoRef);
        
        const marcadoresAssociados = (textoSnap.exists() && textoSnap.data().marcadoresAssociados) 
                                     ? textoSnap.data().marcadoresAssociados 
                                     : {};

        list.innerHTML = '';

        if (marcadoresSnap.empty) {
            list.innerHTML = '<li style="padding: 15px; text-align: center; color: var(--text-muted-color);">Nenhum marcador criado.<br>Clique no "+" acima para criar.</li>';
            return;
        }

        marcadoresSnap.forEach(docSnap => {
            const marcador = { id: docSnap.id, ...docSnap.data() };
            const isChecked = !!marcadoresAssociados[marcador.id]; 

            const li = document.createElement('li');
            li.className = `bookmark-item ${isChecked ? 'active' : ''}`;
            li.onclick = () => toggleBookmark(marcador.id, !isChecked, li);

            li.innerHTML = `
                <div class="bookmark-info">
                    <span class="bookmark-title">${marcador.nome}</span>
                    <span class="bookmark-desc">${marcador.descricao || ''}</span>
                </div>
                <div class="bookmark-check"></div>
            `;

            list.appendChild(li);
        });

    } catch (error) {
        console.error("Erro ao carregar marcadores:", error);
        list.innerHTML = '<li>Erro ao carregar dados.</li>';
    }
}

async function toggleBookmark(marcadorId, shouldAdd, liElement) {
    if (!activeReferenceEntity.id) return;

    const textoRef = doc(db, 'textosbiblicos', activeReferenceEntity.id);

    if (shouldAdd) liElement.classList.add('active');
    else liElement.classList.remove('active');

    liElement.onclick = () => toggleBookmark(marcadorId, !shouldAdd, liElement);

    // Atualizar T√≠tulo em Tempo Real
    const activeCount = document.querySelectorAll('#bookmarks-list .bookmark-item.active').length;
    const titleElement = document.getElementById('references-panel-title');
    const entityName = activeReferenceEntity.name;

    if (activeCount > 0) {
        titleElement.textContent = `Refer√™ncias para üîñ"${entityName}"`;
    } else {
        titleElement.textContent = `Refer√™ncias para "${entityName}"`;
    }

    try {
        if (shouldAdd) {
            await updateDoc(textoRef, { [`marcadoresAssociados.${marcadorId}`]: true });
        } else {
            await updateDoc(textoRef, { [`marcadoresAssociados.${marcadorId}`]: deleteField() });
        }
    } catch (error) {
        console.error("Erro ao atualizar marcador:", error);
        alert("Erro ao guardar. A reverter...");
        if (shouldAdd) liElement.classList.remove('active');
        else liElement.classList.add('active');
    }
}

// --- FUN√á√ÉO UTILIT√ÅRIA PARA O PROMPT PERSONALIZADO ---
 function showCustomInput(title, namePlaceholder = "") {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-input-modal');
        const titleEl = document.getElementById('custom-input-title');
        const nameInput = document.getElementById('custom-input-name');
        const descInput = document.getElementById('custom-input-desc'); // Novo
        const confirmBtn = document.getElementById('custom-input-confirm');
        const cancelBtn = document.getElementById('custom-input-cancel');

        // Configura o UI
        titleEl.textContent = title;
        nameInput.value = '';
        nameInput.placeholder = namePlaceholder;
        descInput.value = ''; // Limpa a descri√ß√£o
        
        modal.style.display = 'flex';
        nameInput.focus();

        // Limpeza
        const cleanup = () => {
            modal.style.display = 'none';
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            nameInput.onkeydown = null;
            descInput.onkeydown = null; // Limpa listener do textarea tamb√©m
        };

        // Confirmar
        const onConfirm = () => {
            const nameVal = nameInput.value.trim();
            const descVal = descInput.value.trim();
            
            if (!nameVal) {
                alert("O nome √© obrigat√≥rio.");
                return;
            }
            
            cleanup();
            // Retorna um objeto com ambos os valores
            resolve({ name: nameVal, description: descVal }); 
        };

        // Cancelar
        const onCancel = () => {
            cleanup();
            resolve(null);
        };

        // Configura Eventos
        confirmBtn.onclick = onConfirm;
        cancelBtn.onclick = onCancel;

        // Enter no campo Nome submete (mas no textarea permite quebra de linha ou tab)
        nameInput.onkeydown = (e) => {
            if (e.key === 'Enter') onConfirm();
            if (e.key === 'Escape') onCancel();
        };
        
        // Escape no textarea cancela
        descInput.onkeydown = (e) => {
            if (e.key === 'Escape') onCancel();
        };
    });
}
// --- 3. GRAVA√á√ÉO NA NOTA ---

document.getElementById('save-topics-btn').addEventListener('click', async () => {
    
    // CASO 1: Estamos a gravar t√≥picos de uma CAIXA (SubNota/Quest√£o)
    if (activeMiniNoteElement) {
        // A. Prepara os dados
        const jsonTopics = JSON.stringify(currentNoteTopics);
        
        console.log("üìù [MODAL] A gravar na caixa:", jsonTopics);

        // B. Escreve no atributo invis√≠vel do HTML
        activeMiniNoteElement.setAttribute('data-topics', jsonTopics);
        
        // C. Atualiza visualmente o bot√£o da caixa (para ficar azul)
        updateMiniNoteButtonState(activeMiniNoteElement);

        // D. Fecha o modal
        document.getElementById('topics-modal').style.display = 'none';
        
        // E. Limpa a vari√°vel global
        activeMiniNoteElement = null;

        // F. FOR√áA A GRAVA√á√ÉO NA BASE DE DADOS IMEDIATAMENTE
        // Isto √© crucial! Chama o executeSave para enviar para o Firebase
        await saveNote(true); 
        return;
    }

    // CASO 2: Estamos a gravar t√≥picos da NOTA PRINCIPAL
    if (topicTargetId) {
        try {
            const itemRef = doc(db, 'pastas', topicTargetId);
            await updateDoc(itemRef, {
                topicosSelecionados: currentNoteTopics,
                ultimaedicao: serverTimestamp()
            });
            document.getElementById('topics-modal').style.display = 'none';
            if (topicTargetId === selectedNoteId) updateSaveStatus('saved');
        } catch (error) {
            console.error("Erro ao gravar t√≥picos:", error);
            alert("Erro ao gravar.");
        }
    }
});


// ============================================================
// L√ìGICA DO MODAL DE GEST√ÉO (CRIAR T√ìPICOS)
// ============================================================

// A. LISTENER DE CLIQUE NO BOT√ÉO üìã
noteContentEditor.addEventListener('click', (e) => {
    const topicBtn = e.target.closest('button[data-action="manage-mini-note-topics"]');
    if (topicBtn) {
        e.preventDefault(); e.stopPropagation(); // Impede foco indesejado
        const wrapper = topicBtn.closest('.mini-note-wrapper');
        openTopicsModalForMiniNote(wrapper);
    }
});

// B. FUN√á√ÉO PARA ABRIR O MODAL (Modo SubNota)
async function openTopicsModalForMiniNote(wrapperElement) {
    if (!wrapperElement) return;

    // 1. Configurar Estado Global
    activeMiniNoteElement = wrapperElement; // Dizemos ao sistema que estamos a editar ESTE elemento
    topicTargetId = null; // Anula o ID da nota principal para n√£o confundir
    
    // 2. Ler t√≥picos atuais do atributo HTML
    const topicsString = wrapperElement.dataset.topics || '{}';
    try {
        currentNoteTopics = JSON.parse(topicsString);
    } catch (e) {
        currentNoteTopics = {};
    }

    // 3. Configurar UI do Modal
    const modalTitle = document.querySelector('#topics-modal h3');
    const isQuestion = wrapperElement.classList.contains('question-mode');
    modalTitle.textContent = isQuestion ? "T√≥picos da Quest√£o" : "T√≥picos da SubNota";

    document.getElementById('topics-modal').style.display = 'flex';
    
    // 4. Renderizar a lista (Reutiliza a fun√ß√£o existente!)
    await renderTopicsSelectionList();
}

// C. ATUALIZAR O LISTENER DO BOT√ÉO "GRAVAR T√ìPICOS"
// Substitua o listener existente do 'save-topics-btn' por este:
document.getElementById('save-topics-btn').addEventListener('click', async () => {
    
    // CASO 1: Estamos a gravar t√≥picos de uma SUB-NOTA (Elemento DOM)
    if (activeMiniNoteElement) {
        // Converte o objeto de t√≥picos em string JSON
        const jsonTopics = JSON.stringify(currentNoteTopics);
        
        // Grava no atributo do HTML
        activeMiniNoteElement.setAttribute('data-topics', jsonTopics);
        
        // >>> NOVO: Chama a fun√ß√£o auxiliar para atualizar a cor imediatamente <<<
        updateMiniNoteButtonState(activeMiniNoteElement);

        document.getElementById('topics-modal').style.display = 'none';
        
        // Limpa a vari√°vel global e grava a Nota Principal
        activeMiniNoteElement = null;
        saveNote(); 
        return;
    }

    // CASO 2: Estamos a gravar t√≥picos da NOTA PRINCIPAL (Firebase)
    // (Este √© o c√≥digo original que j√° tinha)
    if (topicTargetId) {
        try {
            const itemRef = doc(db, 'pastas', topicTargetId);
            await updateDoc(itemRef, {
                topicosSelecionados: currentNoteTopics,
                ultimaedicao: serverTimestamp()
            });
            document.getElementById('topics-modal').style.display = 'none';
            if (topicTargetId === selectedNoteId) updateSaveStatus('saved');
        } catch (error) {
            console.error("Erro ao gravar t√≥picos:", error);
            alert("Erro ao gravar.");
        }
    }
});

document.getElementById('manage-topics-btn').addEventListener('click', () => {
    activeTopicIdForManagement = null;
    document.getElementById('manage-topics-modal').style.display = 'flex';
    renderManageTopicsList();
    document.getElementById('create-new-subtopic-btn').style.display = 'none';
    document.getElementById('subtopics-list-manage').innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico.</li>';
});

document.getElementById('close-manage-topics-btn').addEventListener('click', () => {
    document.getElementById('manage-topics-modal').style.display = 'none';
    // Recarrega a lista de sele√ß√£o principal para mostrar os novos itens
    renderTopicsSelectionList(); 
});

// --- Renderiza√ß√£o Gest√£o ---

async function renderManageTopicsList(filterText = '') {
    const list = document.getElementById('topics-list-manage');
    list.innerHTML = '<li>Carregando...</li>';

    const q = query(collection(db, 'topicos'), where('userId', '==', auth.currentUser.uid), orderBy('nome'));
    const snapshot = await getDocs(q);
    
    list.innerHTML = '';
    
    snapshot.forEach(doc => {
        const topic = { id: doc.id, ...doc.data() };
        
        // Filtro de pesquisa
        if (filterText && !topic.nome.toLowerCase().includes(filterText.toLowerCase())) {
            return;
        }

        const li = document.createElement('li');
        if (topic.id === activeTopicIdForManagement) li.classList.add('active-topic');
        
        li.textContent = topic.nome;
        
        li.onclick = () => {
            list.querySelectorAll('li').forEach(el => el.classList.remove('active-topic'));
            li.classList.add('active-topic');
            activeTopicIdForManagement = topic.id;
            
            // Mostra bot√£o de criar subt√≥pico
            const createSubBtn = document.getElementById('create-new-subtopic-btn');
            createSubBtn.style.display = 'block';
            createSubBtn.textContent = `+ Subt√≥pico em "${topic.nome}"`;
            
            renderManageSubtopicsList(topic.id);
        };

        list.appendChild(li);
    });
}

async function renderManageSubtopicsList(topicId) {
    const list = document.getElementById('subtopics-list-manage');
    list.innerHTML = '<li>Carregando...</li>';

    const q = query(collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome'));
    const snapshot = await getDocs(q);

    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
        return;
    }

    snapshot.forEach(doc => {
        const sub = doc.data();
        const li = document.createElement('li');
        li.textContent = sub.nome;
        li.style.cursor = 'default'; // Apenas visualiza√ß√£o na gest√£o
        list.appendChild(li);
    });
}

// --- Pesquisa ---
document.getElementById('search-topic-input').addEventListener('input', (e) => {
    renderManageTopicsList(e.target.value);
});

// --- Cria√ß√£o de Novos Itens ---

document.getElementById('create-new-topic-btn').addEventListener('click', async () => {
    const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina...");
    
    // Verifica se result existe e se tem nome (descri√ß√£o √© opcional)
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'topicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageTopicsList(document.getElementById('search-topic-input').value);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar t√≥pico."); 
        }
    }
});


 document.getElementById('create-new-subtopic-btn').addEventListener('click', async () => {
    if (!activeTopicIdForManagement) return;
    
    const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo...");
    
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'subtopicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                topicId: activeTopicIdForManagement,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageSubtopicsList(activeTopicIdForManagement);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar subt√≥pico."); 
        }
    }
});

// --- LIGAR O BOT√ÉO DA BARRA DE FERRAMENTAS ---


// 2. EVENTO INPUT: Exclusivo para o Seletor de Cores
// O seletor de cores precisa do evento 'input' para funcionar em tempo real
editorToolbar.addEventListener('input', (e) => {
    const target = e.target;
    // Verifica se √© o input de cor da barra
    if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
        document.execCommand('foreColor', false, target.value);
        saveNote(); 
    }
});




/**
 * Remove a refer√™ncia de uma nota a uma entidade de texto b√≠blico.
 * Se for a √∫ltima refer√™ncia, apaga a pr√≥pria entidade.
 * @param {string} entityName O nome da entidade de texto b√≠blico (ex: "Daniel 4:3")
 */
async function cleanupBiblicalEntityReference(entityName) {
    if (!selectedNoteId || !entityName) return;

    const collectionRef = collection(db, 'textosbiblicos');
    const q = query(collectionRef, where("nome", "==", entityName));
    
    try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            console.log(`Nenhuma entidade encontrada para "${entityName}". Nenhuma a√ß√£o necess√°ria.`);
            return;
        }

        const entityDoc = snapshot.docs[0];
        const entityRef = entityDoc.ref;
        const entityData = entityDoc.data();
        const references = entityData.referencias || {};
        
        // Verifica se a nota atual est√° nas refer√™ncias
        if (references[selectedNoteId]) {
            const numReferences = Object.keys(references).length;

            if (numReferences === 1) {
                // √â a √∫ltima refer√™ncia, apagar o documento inteiro
                console.log(`√öltima refer√™ncia para "${entityName}". A apagar o documento...`);
                await deleteDoc(entityRef);
            } else {
                // Existem outras refer√™ncias, remover apenas a atual
                console.log(`A remover refer√™ncia da nota atual para "${entityName}"...`);
                await updateDoc(entityRef, {
                    [`referencias.${selectedNoteId}`]: deleteField()
                });
            }
            
            // Atualiza o cache de entidades local
            await fetchAllEntities();
        }

    } catch (error) {
        console.error(`Erro ao limpar a refer√™ncia para "${entityName}":`, error);
    }
}

async function fetchAllEntities() {
    if (!auth.currentUser) return;
    allEntities = {}; 
    for (const type in ENTITY_CONFIG) {
        const config = ENTITY_CONFIG[type];
        const collectionName = config.collection;
        try {
            // FILTRO OBRIGAT√ìRIO
            const q = query(
                collection(db, collectionName), 
                where('userId', '==', auth.currentUser.uid)
            );
            
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                allEntities[type] = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    nome: doc.data().nome,
                    tipo: type,
                    descricao: doc.data().descricao // Importante carregar a descri√ß√£o para uso posterior
                }));
            }
        } catch (error) {
            console.error(`Erro ao carregar a cole√ß√£o ${collectionName}:`, error);
        }
    }
}

function resetEditor() {
    selectedNoteId = null;
    editorArea.style.display = 'none';
    editorPlaceholder.style.display = 'flex';
    document.querySelectorAll('#middle-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    updateSaveStatus('hidden');
}

function fetchAndDisplayItems(parentId, listElement, selectedId = null) {
   if (!auth.currentUser) return;

    const itemsRef = collection(db, 'pastas');
    
    const q = query(
        itemsRef, 
        where('parentId', '==', parentId), 
        where('estado', '==', 'ativa'), 
        where('userId', '==', auth.currentUser.uid), 
        orderBy('ordem')
    );

    return onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            li.dataset.id = item.id;
            li.dataset.type = item.tipo;
            li.dataset.name = item.nome;
            li.dataset.parentid = item.parentId || 'null';

            // 1. Verifica se √© Protegida
            if (item.passe && item.passe.trim() !== "") {
                li.setAttribute('data-protected', 'true'); 
            }

            // 2. Verifica se √© Superpasta (NOVO)
            if (item.superpasta === true) {
                li.dataset.superpasta = "true";
                // Destaque visual opcional via CSS inline ou classe
                li.style.borderLeft = "3px solid var(--accent-color)";
            }

            const nameSpan = document.createElement('span');
            
            // Define √≠cone de cadeado
            const lockIcon = (item.passe && item.passe.trim() !== "") ? "üîí " : "";
            
            // Define √≠cone de superpasta (üåü) ou usa o padr√£o do CSS para os outros
            // Nota: O CSS :before lida com os √≠cones padr√£o, adicionamos a estrela no texto se for superpasta
            const superIcon = (item.superpasta === true && item.tipo === 'pasta') ? "üåü " : "";

            nameSpan.textContent = `${lockIcon}${superIcon}${item.nome}`;
            
            const menuBtn = document.createElement('button');
            menuBtn.className = 'item-menu-btn';
            menuBtn.innerHTML = '‚Ä¶';
            
            li.appendChild(nameSpan);
            li.appendChild(menuBtn);

            if (item.id === selectedId) li.classList.add('selected');
            listElement.appendChild(li);
        });
    });
}

async function updateNavigationView(keepEditorOpen = false, targetSelectId = null) {
    notebookContainer.classList.remove('left-panel-collapsed');

    // Limpa os listeners anteriores para evitar fugas de mem√≥ria ou duplica√ß√µes
    if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    // Se n√£o for para manter aberto (ex: clicou em voltar), limpa o editor
    if (!keepEditorOpen) resetEditor();

    // Verifica se estamos dentro de uma Superpasta
    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // ============================================================
    // MODO: LISTS (Categorias Especiais)
    // ============================================================
  if (currentTab === 'lists') {
        setLeftPanelTitle('Categorias'); 
        
        // MENU ESQUERDO ORGANIZADO
        leftPanelList.innerHTML = `
            <!-- GRUPO 1: GEST√ÉO -->
            <li class="list-item" data-type="list-category" data-id="topico">üìë T√≥picos</li>
            <li class="list-item" data-type="list-category" data-id="destaque">üé® Destaques</li>
            
            <!-- Separador -->
            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 5px; opacity: 0.3;">

            <!-- GRUPO 2: ESTUDO -->
            <li class="list-item" data-type="list-bible-root" data-id="biblia">üìî B√≠blia</li>
            <li class="list-item" data-type="list-category" data-id="textobiblico">üìñ Textos B√≠blicos</li>
            <li class="list-item" data-type="list-category" data-id="marcadores">üîñ Marcadores</li>

            <!-- Separador -->
            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 5px; opacity: 0.3;">

            <!-- GRUPO 3: ENTIDADES -->
            <li class="list-item" data-type="list-category" data-id="personagem">üë§ Personagens</li>
            <li class="list-item" data-type="list-category" data-id="local">üìç Locais</li>
            <li class="list-item" data-type="list-category" data-id="data">üìÖ Datas</li>
            <li class="list-item" data-type="list-category" data-id="tag">üè∑Ô∏è Tags</li>
        `;

        const depth = navigationStack.length;

        if (depth === 0) {
            middlePanelTitle.textContent = 'Selecione uma categoria';
            middlePanelList.innerHTML = '';
            backBtn.style.display = 'none';
        } else {
            const currentContext = navigationStack[depth - 1];
            middlePanelTitle.textContent = currentContext.name;
            backBtn.style.display = 'flex';
            middlePanelList.innerHTML = '<li>A carregar...</li>'; 

            // Filtro de Superpasta (Opcional)
            let validNoteIds = null; 
            if (isSuperContext && !appSettings.searchGlobalInSuperfolder) {
                try {
                    validNoteIds = new Set();
                    validNoteIds.add(SUPERFOLDER_ID); 
                    const qDirect = query(collection(db, 'pastas'), where('parentId', '==', SUPERFOLDER_ID), where('estado', '==', 'ativa'));
                    const snapDirect = await getDocs(qDirect);
                    for (const docSnapshot of snapDirect.docs) {
                        const data = docSnapshot.data();
                        if (data.tipo === 'nota') validNoteIds.add(docSnapshot.id);
                        if (data.tipo === 'pasta') {
                             const qGrand = query(collection(db, 'pastas'), where('parentId', '==', docSnapshot.id), where('estado', '==', 'ativa'));
                             const snapGrand = await getDocs(qGrand);
                             snapGrand.forEach(gDoc => validNoteIds.add(gDoc.id));
                        }
                    }
                } catch (e) { console.error(e); }
            }

            if (currentContext.type === 'list-category') {
                const type = currentContext.id;

                // >>> 1. DESTAQUES <<<
                if (type === 'destaque') {
                    middlePanelList.innerHTML = '<li class="list-item">A carregar cores...</li>';
                    try {
                        const docRef = doc(db, 'destaques', auth.currentUser.uid);
                        const docSnap = await getDoc(docRef);
                        let colorsToRender = [];
                        if (docSnap.exists() && docSnap.data().colors) {
                            const userColors = docSnap.data().colors; 
                            colorsToRender = Object.entries(userColors).map(([hex, name]) => ({ code: hex, name: name }));
                        } else {
                            colorsToRender = [...DEFAULT_HIGHLIGHTS];
                        }
                        colorsToRender.sort((a, b) => a.name.localeCompare(b.name));
                        middlePanelList.innerHTML = '';
                        if (colorsToRender.length === 0) {
                            middlePanelList.innerHTML = '<li class="list-item">Nenhum destaque definido.</li>';
                        } else {
                            colorsToRender.forEach(color => {
                                const li = document.createElement('li');
                                li.className = 'list-item';
                                li.dataset.type = 'highlight-item';
                                li.dataset.hex = color.code;
                                li.dataset.name = color.name;
                                li.innerHTML = `<div style="display:flex; align-items:center;"><div style="width:20px; height:20px; border-radius:50%; background-color:${color.code}; margin-right:10px; border:1px solid rgba(0,0,0,0.2);"></div><span>${color.name}</span></div>`;
                                middlePanelList.appendChild(li);
                            });
                        }
                    } catch (error) { console.error(error); middlePanelList.innerHTML = '<li>Erro ao carregar.</li>'; }
                    return;
                }

                // >>> 2. MARCADORES <<<
                if (type === 'marcadores') {
                    middlePanelList.innerHTML = '<li class="list-item">A carregar marcadores...</li>';
                    const getBookIndex = (entityName) => {
                        const nameLower = entityName.toLowerCase();
                        const index = BIBLICAL_BOOKS.findIndex(book => nameLower.startsWith(book.toLowerCase()));
                        return index === -1 ? 999 : index;
                    };

                    try {
                        const [marcadoresSnap, textosSnap] = await Promise.all([
                            getDocs(query(collection(db, 'marcadores'), where('userId', '==', auth.currentUser.uid))),
                            getDocs(query(collection(db, 'textosbiblicos'), where('userId', '==', auth.currentUser.uid)))
                        ]);

                        const mapMarcadores = {};
                        marcadoresSnap.forEach(doc => { mapMarcadores[doc.id] = doc.data(); });

                        let textosMarcados = [];
                        textosSnap.forEach(doc => {
                            const data = doc.data();
                            if (data.marcadoresAssociados && Object.keys(data.marcadoresAssociados).length > 0) {
                                textosMarcados.push({ id: doc.id, ...data });
                            }
                        });

                        // Filtro Global
                        if (validNoteIds) {
                            textosMarcados = textosMarcados.filter(texto => {
                                if (!texto.referencias || Object.keys(texto.referencias).length === 0) return false;
                                const entityNoteIds = Object.keys(texto.referencias);
                                return entityNoteIds.some(noteId => validNoteIds.has(noteId));
                            });
                        }

                        middlePanelList.innerHTML = '';

                        // Cabe√ßalho de Filtro
                        const filterLi = document.createElement('li');
                        filterLi.style.cursor = 'default';
                        filterLi.innerHTML = `
                            <div class="filter-bar">
                                <button id="bookmark-filter-btn" class="filter-btn">
                                    <span>Ordenar por: <strong>${currentBookmarkSort.charAt(0).toUpperCase() + currentBookmarkSort.slice(1)}</strong></span>
                                    <span>‚ñº</span>
                                </button>
                                <div id="bookmark-filter-popup" class="filter-popup">
                                    <button data-sort="texto" class="${currentBookmarkSort === 'texto' ? 'selected' : ''}">Texto (A-Z)</button>
                                    <button data-sort="categoria" class="${currentBookmarkSort === 'categoria' ? 'selected' : ''}">Categoria (Nome)</button>
                                    <button data-sort="descricao" class="${currentBookmarkSort === 'descricao' ? 'selected' : ''}">Descri√ß√£o</button>
                                </div>
                            </div>`;
                        middlePanelList.appendChild(filterLi);

                        const filterBtn = filterLi.querySelector('#bookmark-filter-btn');
                        const filterPopup = filterLi.querySelector('#bookmark-filter-popup');
                        filterBtn.onclick = (e) => {
                            e.stopPropagation();
                            filterPopup.style.display = (filterPopup.style.display === 'flex') ? 'none' : 'flex';
                        };
                        
                        // Fecha popup ao clicar fora (hack simples)
                        setTimeout(() => {
                            document.addEventListener('click', function closePopup(e) {
                                if (!filterLi.contains(e.target)) {
                                    filterPopup.style.display = 'none';
                                    document.removeEventListener('click', closePopup);
                                }
                            });
                        }, 0);

                        filterPopup.querySelectorAll('button').forEach(btn => {
                            btn.onclick = (e) => {
                                e.stopPropagation();
                                currentBookmarkSort = btn.dataset.sort;
                                updateNavigationView(true);
                            };
                        });

                        if (textosMarcados.length === 0) {
                            const emptyLi = document.createElement('li');
                            emptyLi.className = 'list-item';
                            emptyLi.textContent = 'Nenhum texto marcado encontrado.';
                            middlePanelList.appendChild(emptyLi);
                            return;
                        }

                        // L√≥gica de Ordena√ß√£o e Renderiza√ß√£o dos Marcadores
                        if (currentBookmarkSort === 'texto') {
                            textosMarcados.sort((a, b) => {
                                const indexA = getBookIndex(a.nome);
                                const indexB = getBookIndex(b.nome);
                                if (indexA !== indexB) return indexA - indexB;
                                return a.nome.localeCompare(b.nome, undefined, { numeric: true, sensitivity: 'base' });
                            });
                            textosMarcados.forEach(texto => {
                                const li = document.createElement('li');
                                li.className = 'list-item';
                                li.dataset.type = 'entity-item';
                                li.dataset.entityId = texto.id;
                                li.dataset.entityName = texto.nome;
                                li.dataset.entityType = 'textobiblico';
                                const tags = Object.keys(texto.marcadoresAssociados || {}).map(mId => mapMarcadores[mId]?.nome).filter(Boolean).join(', ');
                                li.innerHTML = `<div style="display:flex; flex-direction:column;"><span style="font-weight:500;">üîñ ${texto.nome}</span><span style="font-size:0.8em; color:var(--text-muted-color);">üè∑Ô∏è ${tags}</span></div>`;
                                middlePanelList.appendChild(li);
                            });
                        } else if (currentBookmarkSort === 'categoria') {
                            const groups = {};
                            textosMarcados.forEach(texto => {
                                Object.keys(texto.marcadoresAssociados || {}).forEach(mId => {
                                    const markerData = mapMarcadores[mId];
                                    const markerName = markerData?.nome || 'Sem Categoria';
                                    if (!groups[markerName]) groups[markerName] = { items: [], info: markerData };
                                    groups[markerName].items.push(texto);
                                });
                            });
                            Object.keys(groups).sort().forEach(cat => {
                                const header = document.createElement('li');
                                header.className = 'group-header';
                                header.textContent = cat;
                                middlePanelList.appendChild(header);
                                const catDesc = groups[cat].info?.descricao || ''; 
                                groups[cat].items.sort((a, b) => {
                                    const indexA = getBookIndex(a.nome);
                                    const indexB = getBookIndex(b.nome);
                                    if (indexA !== indexB) return indexA - indexB;
                                    return a.nome.localeCompare(b.nome, undefined, { numeric: true, sensitivity: 'base' });
                                }).forEach(texto => {
                                    const li = document.createElement('li');
                                    li.className = 'list-item';
                                    li.dataset.type = 'entity-item';
                                    li.dataset.entityId = texto.id;
                                    li.dataset.entityName = texto.nome;
                                    li.dataset.entityType = 'textobiblico';
                                    li.style.paddingLeft = '20px';
                                    li.innerHTML = `<div style="display:flex; flex-direction:column;"><span style="font-weight:500;">üîñ ${texto.nome}</span>${catDesc ? `<span style="font-size:0.8em; color:var(--text-muted-color);">üìù ${catDesc}</span>` : ''}</div>`;
                                    middlePanelList.appendChild(li);
                                });
                            });
                        } else if (currentBookmarkSort === 'descricao') {
                            const groups = {};
                            textosMarcados.forEach(texto => {
                                Object.keys(texto.marcadoresAssociados || {}).forEach(mId => {
                                    const markerData = mapMarcadores[mId];
                                    const markerDesc = markerData?.descricao || 'Sem Descri√ß√£o';
                                    const markerName = markerData?.nome || 'Desconhecido';
                                    if (!groups[markerDesc]) groups[markerDesc] = [];
                                    groups[markerDesc].push({ texto: texto, categoria: markerName });
                                });
                            });
                            Object.keys(groups).sort().forEach(desc => {
                                const header = document.createElement('li');
                                header.className = 'group-header';
                                header.textContent = desc;
                                if (desc === 'Sem Descri√ß√£o') header.style.fontStyle = 'italic';
                                middlePanelList.appendChild(header);
                                groups[desc].sort((a, b) => {
                                    const indexA = getBookIndex(a.texto.nome);
                                    const indexB = getBookIndex(b.texto.nome);
                                    if (indexA !== indexB) return indexA - indexB;
                                    return a.texto.nome.localeCompare(b.texto.nome, undefined, { numeric: true, sensitivity: 'base' });
                                }).forEach(item => {
                                    const li = document.createElement('li');
                                    li.className = 'list-item';
                                    li.dataset.type = 'entity-item';
                                    li.dataset.entityId = item.texto.id;
                                    li.dataset.entityName = item.texto.nome;
                                    li.dataset.entityType = 'textobiblico';
                                    li.style.paddingLeft = '20px';
                                    li.innerHTML = `<div style="display:flex; flex-direction:column;"><span style="font-weight:500;">üîñ ${item.texto.nome}</span><span style="font-size:0.8em; color:var(--text-muted-color);">üè∑Ô∏è ${item.categoria}</span></div>`;
                                    middlePanelList.appendChild(li);
                                });
                            });
                        }
                    } catch (error) {
                        console.error("Erro ao carregar marcadores:", error);
                        middlePanelList.innerHTML = '<li>Erro ao carregar dados.</li>';
                    }
                    return; 
                }

                // >>> 3. T√ìPICOS <<<
                if (type === 'topico') {
                    try {
                        const topicsSnapshot = await getDocs(query(collection(db, 'topicos'), where('userId', '==', auth.currentUser.uid), orderBy('nome')));
                        const subtopicsSnapshot = await getDocs(query(collection(db, 'subtopicos'), where('userId', '==', auth.currentUser.uid), orderBy('nome')));
                        const subsByTopic = {};
                        subtopicsSnapshot.forEach(doc => {
                            const sub = { id: doc.id, ...doc.data() };
                            if (!subsByTopic[sub.topicId]) subsByTopic[sub.topicId] = [];
                            subsByTopic[sub.topicId].push(sub);
                        });
                        middlePanelList.innerHTML = ''; 
                        if (topicsSnapshot.empty) {
                            middlePanelList.innerHTML = '<li class="list-item" style="cursor: default;">Nenhum t√≥pico encontrado.</li>';
                        } else {
                            topicsSnapshot.forEach(doc => {
                                const topic = { id: doc.id, ...doc.data() };
                                const subtopics = subsByTopic[topic.id] || [];
                                const li = document.createElement('li');
                                li.className = 'list-item topic-tree-item';
                                li.style.flexWrap = 'wrap'; 
                                li.style.cursor = 'default'; 
                                const headerDiv = document.createElement('div');
                                headerDiv.style.display = 'flex';
                                headerDiv.style.alignItems = 'center';
                                headerDiv.style.width = '100%';
                                const toggleBtn = document.createElement('span');
                                toggleBtn.textContent = '‚ñ∂'; 
                                toggleBtn.style.marginRight = '10px';
                                toggleBtn.style.cursor = 'pointer';
                                toggleBtn.style.fontSize = '12px';
                                toggleBtn.style.color = 'var(--text-muted-color)';
                                toggleBtn.style.width = '15px';
                                toggleBtn.style.display = 'inline-block';
                                toggleBtn.style.textAlign = 'center';
                                if (subtopics.length === 0) { toggleBtn.style.opacity = '0.3'; toggleBtn.style.cursor = 'default'; }
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = topic.nome;
                                nameSpan.style.flexGrow = '1';
                                nameSpan.style.cursor = 'pointer';
                                nameSpan.dataset.type = 'topic-detail';
                                nameSpan.dataset.id = topic.id;
                                nameSpan.dataset.name = topic.nome;
                                nameSpan.dataset.desc = topic.descricao || '';
                                headerDiv.appendChild(toggleBtn);
                                headerDiv.appendChild(nameSpan);
                                li.appendChild(headerDiv);
                                const childrenUl = document.createElement('ul');
                                childrenUl.style.display = 'none';
                                childrenUl.style.width = '100%';
                                childrenUl.style.paddingLeft = '28px';
                                childrenUl.style.listStyle = 'none';
                                childrenUl.style.marginTop = '5px';
                                childrenUl.style.borderLeft = '1px solid var(--border-color)';
                                childrenUl.style.marginLeft = '7px';
                                subtopics.forEach(sub => {
                                    const subLi = document.createElement('li');
                                    subLi.textContent = sub.nome;
                                    subLi.style.padding = '4px 8px';
                                    subLi.style.cursor = 'pointer';
                                    subLi.style.color = 'var(--text-muted-color)';
                                    subLi.style.fontSize = '0.95em';
                                    subLi.style.marginBottom = '2px';
                                    subLi.style.borderRadius = '4px';
                                    subLi.dataset.type = 'subtopic-detail';
                                    subLi.dataset.id = sub.id;
                                    subLi.dataset.name = sub.nome;
                                    subLi.dataset.desc = sub.descricao || '';
                                    subLi.onmouseover = () => { subLi.style.color = 'var(--text-color)'; subLi.style.backgroundColor = 'var(--hover-color)'; };
                                    subLi.onmouseout = () => { subLi.style.color = 'var(--text-muted-color)'; subLi.style.backgroundColor = 'transparent'; };
                                    childrenUl.appendChild(subLi);
                                });
                                li.appendChild(childrenUl);
                                if (subtopics.length > 0) {
                                    toggleBtn.onclick = (e) => { e.stopPropagation(); const isHidden = childrenUl.style.display === 'none'; childrenUl.style.display = isHidden ? 'block' : 'none'; toggleBtn.textContent = isHidden ? '‚ñº' : '‚ñ∂'; };
                                }
                                middlePanelList.appendChild(li);
                            });
                        }
                    } catch (error) { console.error("Erro ao carregar t√≥picos:", error); middlePanelList.innerHTML = '<li>Erro ao carregar dados.</li>'; }
                    return;
                }

                // >>> 4. ENTIDADES (Personagem, Local, Data) <<<
                middlePanelList.innerHTML = ''; 
                let entities = allEntities[type] || [];
                
                if (validNoteIds) {
                    entities = entities.filter(entity => {
                        if (!entity.referencias || Object.keys(entity.referencias).length === 0) return false;
                        const entityNoteIds = Object.keys(entity.referencias);
                        return entityNoteIds.some(noteId => validNoteIds.has(noteId));
                    });
                }

                const sortedEntities = [...entities].sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Barra de pesquisa
                const searchLi = document.createElement('li');
                searchLi.className = 'list-search-container';
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.className = 'list-search-input';
                searchInput.placeholder = `Filtrar ${currentContext.name}...`;
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const items = middlePanelList.querySelectorAll('li[data-type="entity-item"]');
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(term) ? 'block' : 'none';
                    });
                });
                searchInput.addEventListener('click', (e) => e.stopPropagation());
                searchLi.appendChild(searchInput);
                middlePanelList.appendChild(searchLi);

                if (sortedEntities.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.style.cursor = 'default';
                    li.textContent = 'Nenhum item encontrado.';
                    middlePanelList.appendChild(li);
                } else {
                    sortedEntities.forEach(entity => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.dataset.type = 'entity-item';
                        li.dataset.entityId = entity.id;
                        li.dataset.entityName = entity.nome;
                        li.dataset.entityType = entity.tipo;
                        li.textContent = entity.nome;
                        middlePanelList.appendChild(li);
                    });
                }
            }


            // >>> 4.5. TAGS (Novo) <<<
            if (type === 'tag') {
                middlePanelList.innerHTML = '';
                // Ordena tags alfabeticamente
                const sortedTags = [...allTags].sort((a, b) => a.nome.localeCompare(b.nome));
                
                if (sortedTags.length === 0) {
                    middlePanelList.innerHTML = '<li class="list-item" style="cursor: default;">Nenhuma tag encontrada.</li>';
                } else {
                    sortedTags.forEach(tag => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        // Reutiliza a l√≥gica de "show-tag-references" que j√° cri√°mos para os modais
                        li.dataset.action = 'show-tag-references'; 
                        li.dataset.tagName = tag.nome;
                        li.innerHTML = `<span style="color:var(--accent-color);">#${tag.nome}</span>`;
                        
                        // Ao clicar, abre o painel de refer√™ncias da tag
                        li.onclick = () => {
                            // Se estivermos em mobile, fechamos o painel do meio
                            if (window.innerWidth <= 768) {
                                document.body.classList.remove('mobile-view-middle');
                            }
                            showTagReferencesPanel(tag.nome);
                        };
                        middlePanelList.appendChild(li);
                    });
                }
                return;
            }

            // >>> 5. B√çBLIA <<<
            else if (currentContext.type === 'list-bible-root') {
                middlePanelList.innerHTML = '';
                BIBLICAL_BOOKS.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.dataset.type = 'bible-book';
                    li.dataset.bookName = book;
                    li.textContent = book;
                    middlePanelList.appendChild(li);
                });
            }
            else if (currentContext.type === 'bible-book') {
                middlePanelList.innerHTML = '';
                const bookName = currentContext.id; 
                const bibleTexts = allEntities['textobiblico'] || [];
                let bookTexts = bibleTexts.filter(t => t.nome.toLowerCase().startsWith(bookName.toLowerCase()));
                
                if (validNoteIds) {
                    bookTexts = bookTexts.filter(entity => {
                        if (!entity.referencias || Object.keys(entity.referencias).length === 0) return false;
                        const entityNoteIds = Object.keys(entity.referencias);
                        return entityNoteIds.some(noteId => validNoteIds.has(noteId));
                    });
                }

                bookTexts.sort((a, b) => a.nome.localeCompare(b.nome, undefined, { numeric: true, sensitivity: 'base' }));

                if (bookTexts.length === 0) {
                    middlePanelList.innerHTML = '<li class="list-item" style="cursor: default;">Nenhum texto registado neste livro.</li>';
                } else {
                    bookTexts.forEach(textEntity => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.dataset.type = 'entity-item'; 
                        li.dataset.entityId = textEntity.id;
                        li.dataset.entityName = textEntity.nome;
                        li.dataset.entityType = 'textobiblico';
                        li.textContent = textEntity.nome;
                        middlePanelList.appendChild(li);
                    });
                }
            }
        }
    }
    // ============================================================
    // MODO: NOTE (Padr√£o - Pastas e Notas)
    // ============================================================
    else {
        const depth = navigationStack.length;
        let leftPanelParentId = null, middlePanelParentId = null, leftPanelSelectedId = null;

        if (depth === 0) {
            // Raiz
            if (isSuperContext) {
                leftPanelParentId = SUPERFOLDER_ID;
                setLeftPanelTitle(currentSuperfolderName);
            } else {
                leftPanelParentId = null;
                leftPanelTitle.textContent = 'Pastas';
            }
            
            middlePanelTitle.textContent = 'Selecione';
            backBtn.style.display = 'none';
            middlePanelList.innerHTML = '';
        } else {
            // Dentro de pastas
            const currentFolder = navigationStack[depth - 1];
            middlePanelParentId = currentFolder.id;
            middlePanelTitle.textContent = currentFolder.name;
            backBtn.style.display = 'flex';
            
            if (depth > 1) {
                const parentFolder = navigationStack[depth - 2];
                leftPanelParentId = parentFolder.id;
                setLeftPanelTitle(parentFolder.name);
                leftPanelSelectedId = currentFolder.id;
            } else {
                // N√≠vel 0 da Superpasta ou Raiz Global
                if (isSuperContext) {
                    leftPanelParentId = SUPERFOLDER_ID;
                    setLeftPanelTitle(currentSuperfolderName);
                } else {
                    leftPanelParentId = null;
                    leftPanelTitle.textContent = 'Pastas';
                }
                leftPanelSelectedId = currentFolder.id;
            }
        }
        
        // Renderiza Painel Esquerdo (com a pasta selecionada)
        unsubscribeLeftPanel = fetchAndDisplayItems(leftPanelParentId, leftPanelList, leftPanelSelectedId);
        
        // Renderiza Painel do Meio (com a NOTA selecionada, se houver targetSelectId)
        if (middlePanelParentId) {
            unsubscribeMiddlePanel = fetchAndDisplayItems(middlePanelParentId, middlePanelList, targetSelectId);
        }
    }
}




// 1. Remove acentos (ex: "Jo√£o" -> "joao")
function removeAccents(str) {
    if (!str) return "";
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

// 2. Cria Regex que entende acentos (ex: "joao" vira regex para encontrar "jo√£o", "Jo√£o", "J√íAO")
function getAccentInsensitiveRegex(term) {
    const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escapa caracteres especiais
    
    // Substitui vogais simples pelos seus grupos com acento
    let regexStr = escaped
        .replace(/a/gi, '[a√†√°√¢√£√§√•]')
        .replace(/e/gi, '[e√®√©√™√´]')
        .replace(/i/gi, '[i√¨√≠√Æ√Ø]')
        .replace(/o/gi, '[o√≤√≥√¥√µ√∂]')
        .replace(/u/gi, '[u√π√∫√ª√º]')
        .replace(/c/gi, '[c√ß]')
        .replace(/n/gi, '[n√±]');
        
    return new RegExp(`(${regexStr})`, 'gi');
}



// --- L√ìGICA DA BARRA SECUND√ÅRIA ---

setTimeout(() => {
    const toggleMoreBtn = document.getElementById('toggle-more-tools-btn');
    const secondaryToolbar = document.getElementById('secondary-toolbar');
    const safeNoteEditor = document.getElementById('note-content-editor'); 

    // 1. Abrir/Fechar Painel Secund√°rio
    if (toggleMoreBtn && secondaryToolbar) {
        toggleMoreBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            const isHidden = secondaryToolbar.style.display === 'none';
            
            if (isHidden) {
                secondaryToolbar.style.display = 'flex';
                toggleMoreBtn.classList.add('active');
                toggleMoreBtn.textContent = '‚ñ≤';
            } else {
                secondaryToolbar.style.display = 'none';
                toggleMoreBtn.classList.remove('active');
                toggleMoreBtn.textContent = '‚ñº';
            }
        });
    }

// 2. Funcionalidade dos Bot√µes da Barra Secund√°ria
    if (secondaryToolbar) {
        secondaryToolbar.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            e.preventDefault(); // Impede perda de foco

            // A. T√≠tulos e Texto Normal (A1, A2, P)
            if (btn.dataset.cmdSec === 'formatBlock') {
                const value = btn.dataset.val;
                
                // 1. Aplica o formato de bloco (H1, H2...)
                document.execCommand('formatBlock', false, value);

                // 2. LIMPEZA PROFUNDA
                const selection = window.getSelection();
                if (selection.anchorNode && safeNoteEditor) {
                    let block = selection.anchorNode;
                    if (block.nodeType === 3) block = block.parentNode; 
                    
                    while(block && block.id !== 'note-content-editor' && block.tagName !== value) {
                        block = block.parentNode;
                    }

                    if (block && block.tagName === value) {
                        block.removeAttribute('style'); 
                        const dirtyChildren = block.querySelectorAll('span, font, b, i, u');
                        dirtyChildren.forEach(child => {
                             child.style.fontSize = '';
                             child.style.fontWeight = '';
                             if (child.tagName === 'FONT') {
                                 child.removeAttribute('size');
                                 child.removeAttribute('face');
                             }
                        });
                    }
                }
                
                safeNoteEditor.focus(); 
                saveNote();
            }

            // B. Outros Comandos (Linha Horizontal)
            else if (btn.dataset.cmdSec) {
                const command = btn.dataset.cmdSec;
                document.execCommand(command, false, null);
                safeNoteEditor.focus();
                saveNote();
            }

            // C. Inserir Checkbox
            else if (btn.dataset.action === 'insert-checkbox') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.marginRight = '8px';
                checkbox.style.cursor = 'pointer';
                const space = document.createTextNode('\u00A0'); 

                insertNodeAtCursor(checkbox);
                insertNodeAtCursor(space);
                saveNote();
            }

            // D. Inserir Tabela (üßÆ) - NOVO
        else if (btn.dataset.action === 'insert-table') {
                const tableHTML = `
                    <div class="jwn-table-wrapper">
                        <button class="table-settings-btn" contenteditable="false">üõ†Ô∏è Op√ß√µes</button>
                        <table class="jwn-table">
                            <thead>
                                <tr>
                                    <th>T√≠tulo 1</th>
                                    <th>T√≠tulo 2</th>
                                    <th>T√≠tulo 3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td><br></td><td><br></td><td><br></td></tr>
                                <tr><td><br></td><td><br></td><td><br></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p><br></p>`;
                
                document.execCommand('insertHTML', false, tableHTML);
                saveNote();
            }

            // F. Inserir Linha Cronol√≥gica (NOVO)
else if (btn.dataset.action === 'insert-timeline') {
    const timelineId = `tl_${Date.now()}`;
    
    const timelineHTML = `
        <div class="jwn-timeline-wrapper" contenteditable="false" id="${timelineId}">
            <div class="timeline-track"></div>
            
            <div class="timeline-container">
                <!-- Ponto 1 -->
                <div class="timeline-entry">
                    <div class="t-marker"></div>
                    <div class="t-date" contenteditable="true">Data 1</div>
                    <div class="t-text" contenteditable="true">Descri√ß√£o do evento...</div>
                    <button class="t-btn-del" title="Remover Ponto">√ó</button>
                </div>
                <!-- Ponto 2 -->
                <div class="timeline-entry">
                    <div class="t-marker"></div>
                    <div class="t-date" contenteditable="true">Data 2</div>
                    <div class="t-text" contenteditable="true">Descri√ß√£o do evento...</div>
                    <button class="t-btn-del" title="Remover Ponto">√ó</button>
                </div>
            </div>

            <button class="t-btn-add" title="Adicionar Novo Ponto">‚ûï Adicionar Ponto</button>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, timelineHTML);
    saveNote();
}

   else if (btn.dataset.action === 'insert-toggle-h2') {
    const selection = window.getSelection();

    // =================================================================
    // 1. VERIFICA√á√ÉO DE ANINHAMENTO (IMPEDIR TOGGLE DENTRO DE TOGGLE)
    // =================================================================
    if (selection.rangeCount > 0) {
        const node = selection.anchorNode;
        // Garante que temos o elemento HTML
        const element = node.nodeType === 3 ? node.parentElement : node;
        
        // Verifica se o cursor j√° est√° dentro de um <details>
        if (element.closest('details.toggle-section')) {
            alert("N√£o √© permitido criar um Toggle dentro de outro.");
            return; // Cancela a a√ß√£o imediatamente
        }
    }
    // =================================================================

    let text = selection.toString();
    
    if (!text.trim()) {
        text = "T√≠tulo Expans√≠vel";
    }

    const uniqueId = 'toggle_' + Date.now();

 const toggleHTML = `
        <details class="toggle-section" open id="${uniqueId}">
            <summary>
                <h2>${text}</h2>
                
                <!-- NOVOS BOT√ïES DE MOVIMENTO -->
                <button class="toggle-move-btn" data-action="move-up" contenteditable="false" title="Mover para Cima">üî∫</button>
                <button class="toggle-move-btn" data-action="move-down" contenteditable="false" title="Mover para Baixo">üîª</button>
                
                <!-- BOT√ïES ANTIGOS -->
                <button class="toggle-color-btn" contenteditable="false" title="Mudar Cor">üñåÔ∏è</button>
                <button class="toggle-delete-btn" contenteditable="false" title="Ocultar Sec√ß√£o">üóëÔ∏è</button>
            </summary>
            <div class="toggle-content">
                <p><br></p>
            </div>
        </details>
        <p><br></p>`;

    document.execCommand('insertHTML', false, toggleHTML);
    saveNote();
}

           // E. Inserir Calend√°rio (üìÖ) - ATUALIZADO
     else if (btn.dataset.action === 'insert-date') {
    const calId = `cal_${Date.now()}`;
    const today = new Date();
    
    const widgetHTML = `
        <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
            <div class="cal-header">
                <button class="cal-btn cal-prev">‚óÄ</button>
                <span class="cal-title">Carregando...</span>
                <div style="display:flex; gap:5px;">
                    <button class="cal-btn cal-next">‚ñ∂</button>
                    <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                </div>
            </div>
            
            <!-- Menu de Defini√ß√µes -->
            <div class="cal-settings-menu">
                <!-- Bot√µes de Vista -->
                <div style="display:flex; gap:5px; justify-content:center; width:100%;">
                    <button class="cal-view-btn" data-view="week" style="flex:1;">Semana</button>
                    <button class="cal-view-btn active" data-view="month" style="flex:1;">M√™s</button>
                    <button class="cal-view-btn" data-view="year" style="flex:1;">Ano</button>
                </div>
                
                <!-- Separador -->
                <hr style="border:0; border-top:1px solid var(--border-color); opacity: 0.5;">
                
                <!-- Bot√£o Eliminar com classe CSS -->
                <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
            </div>
            
            <div class="cal-grid">
                <!-- Dias ser√£o gerados via JS -->
            </div>
        </div>
        <p><br></p>`;
    
    document.execCommand('insertHTML', false, widgetHTML);
    
    setTimeout(() => renderCalendarUI(document.getElementById(calId)), 50);
    saveNote();
}
        });

        // 3. Listener para Cor (Separado, mant√©m-se igual)
        secondaryToolbar.addEventListener('input', (e) => {
            const target = e.target;
            if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
                document.execCommand('foreColor', false, target.value);
                saveNote(); 
            }
        });
    }
}, 500);

// Fun√ß√£o Auxiliar (Mant√©m-se a mesma, mas garante que est√° presente)
function insertNodeAtCursor(node) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node);
        range.setEndAfter(node);
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante)
// ====================================================================
// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante Controlado)
// ====================================================================
let activeTableCell = null; // Memoriza a √∫ltima c√©lula clicada/focada
let activeTableWrapper = null; // Memoriza qual a tabela ativa
const tablePopup = document.getElementById('table-tools-popup');

// 1. Detetar cliques (Memorizar C√©lula OU Abrir Menu)
noteContentEditor.addEventListener('click', (e) => {
    
    // CASO A: Clicou numa c√©lula (Apenas memorizamos, N√ÉO abrimos menu)
    const cell = e.target.closest('td, th');
    if (cell) {
        activeTableCell = cell; // Guardamos a refer√™ncia para saber onde inserir linhas
        activeTableWrapper = cell.closest('.jwn-table-wrapper');
        
        // Se o menu estiver aberto noutra tabela, fecha-o
        if (tablePopup.style.display === 'flex' && !activeTableWrapper.contains(e.target)) {
            tablePopup.style.display = 'none';
        }
        return;
    }

    // CASO B: Clicou no bot√£o de Ferramentas (üõ†Ô∏è)
    const settingsBtn = e.target.closest('.table-settings-btn');
    if (settingsBtn) {
        // Encontra a tabela associada a este bot√£o
        activeTableWrapper = settingsBtn.closest('.jwn-table-wrapper');
        const table = activeTableWrapper.querySelector('table');
        
        // Se n√£o tivermos clicado numa c√©lula recentemente, assumimos a primeira c√©lula da tabela
        if (!activeTableCell || !table.contains(activeTableCell)) {
            activeTableCell = table.querySelector('td, th');
        }

        // Toggle do Menu
        if (tablePopup.style.display === 'flex') {
            tablePopup.style.display = 'none';
            settingsBtn.classList.remove('active');
        } else {
            // Posicionar Menu
            const rect = settingsBtn.getBoundingClientRect();
            tablePopup.style.display = 'flex';
            tablePopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            // Alinha √† direita do bot√£o
            tablePopup.style.left = `${(rect.right + window.scrollX) - tablePopup.offsetWidth}px`;
            
            settingsBtn.classList.add('active');
        }
        return;
    }

    // CASO C: Clicou fora (Fechar Menu)
    if (tablePopup.style.display === 'flex' && !tablePopup.contains(e.target)) {
        tablePopup.style.display = 'none';
        // Remove estado ativo de todos os bot√µes
        document.querySelectorAll('.table-settings-btn').forEach(b => b.classList.remove('active'));
    }
});

// 2. A√ß√µes dos bot√µes do menu (Adicionar/Remover)
if (tablePopup) {
    tablePopup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeTableCell) return;
        
        e.preventDefault(); e.stopPropagation();

        const action = btn.dataset.action;
        const cell = activeTableCell;
        const row = cell.parentElement;
        const table = row.closest('table');
        
        const rowIndex = row.rowIndex;
        const colIndex = cell.cellIndex;
        const currentCols = row.cells.length;
        const currentRows = table.rows.length;

        // --- ADICIONAR ---
        if (action === 'add-row-above' || action === 'add-row-below') {
            if (currentRows >= 50) return alert("Limite de linhas atingido.");
            const newRow = table.insertRow(action === 'add-row-above' ? rowIndex : rowIndex + 1);
            for (let i = 0; i < currentCols; i++) {
                newRow.insertCell(i).innerHTML = '<br>';
            }
        }
        else if (action === 'add-col-left' || action === 'add-col-right') {
            if (currentCols >= 15) return alert("Limite de colunas atingido.");
            for (let i = 0; i < table.rows.length; i++) {
                const tr = table.rows[i];
                const isHeadRow = tr.parentNode.tagName === 'THEAD';
                const refIndex = action === 'add-col-left' ? colIndex : colIndex + 1;
                const newCell = tr.insertCell(refIndex);
                if (isHeadRow) newCell.outerHTML = '<th>T√≠tulo</th>';
                else newCell.innerHTML = '<br>';
            }
        }

        // --- APAGAR ---
        else if (action === 'del-row') {
            table.deleteRow(rowIndex);
            if (table.rows.length === 0) activeTableWrapper.remove();
        }
        else if (action === 'del-col') {
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].deleteCell(colIndex);
            }
            if (table.rows[0] && table.rows[0].cells.length === 0) activeTableWrapper.remove();
        }
        else if (action === 'del-table') {
            if (confirm("Apagar toda a tabela?")) {
                activeTableWrapper.remove();
            }
        }

        saveNote();
        // N√£o fechamos o menu automaticamente para permitir m√∫ltiplas a√ß√µes r√°pidas
        // Se quiser fechar, descomente a linha abaixo:
        // tablePopup.style.display = 'none'; 
    });
}

// --- FUN√á√ÉO AUXILIAR: ATUALIZAR VISUAL DO BOT√ÉO DE T√ìPICOS ---
function updateMiniNoteButtonState(wrapperElement) {
    if (!wrapperElement) return;

    const btn = wrapperElement.querySelector('button[data-action="manage-mini-note-topics"]');
    if (!btn) return;

    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    let hasTopics = false;

    try {
        const topics = JSON.parse(topicsString);
        // Verifica se h√° chaves no objeto (t√≥picos selecionados)
        hasTopics = Object.keys(topics).length > 0;
    } catch (e) {
        hasTopics = false;
    }

    if (hasTopics) {
        // --- ESTILO DESTACADO (COM T√ìPICOS) ---
        btn.style.backgroundColor = "rgba(74, 144, 226, 0.3)"; // Fundo azulado semi-transparente
        btn.style.color = "var(--accent-color)";               // √çcone azul forte
        btn.style.borderColor = "var(--accent-color)";         // Borda azul forte
        btn.title = "Gerir T√≥picos (Ativos)";
    } else {
        // --- ESTILO PADR√ÉO (SEM T√ìPICOS) ---
        btn.style.backgroundColor = "";
        btn.style.color = "";
        btn.style.borderColor = "";
        btn.title = "Gerir T√≥picos";
    }
}

// --- FUN√á√ÉO PARA CORRIGIR SUBNOTAS ANTIGAS ---
function fixLegacyMiniNotes() {
    const wrappers = noteContentEditor.querySelectorAll('.mini-note-wrapper');
    
    wrappers.forEach(wrapper => {
        // 1. Garante atributo de t√≥picos
        if (!wrapper.hasAttribute('data-topics')) {
            wrapper.setAttribute('data-topics', '{}');
        }

        // 2. >>> NOVO: Garante atributo de partilha <<<
        if (!wrapper.hasAttribute('data-shared')) {
            wrapper.setAttribute('data-shared', 'false');
        }

        const toolbar = wrapper.querySelector('.mini-note-toolbar');
        if (toolbar) {
            
            // --- INJE√á√ÉO DO BOT√ÉO DE PARTILHA (O QUE FALTAVA) ---
            if (!toolbar.querySelector('button[data-action="sharing-settings"]')) {
                const btnShare = document.createElement('button');
                btnShare.type = 'button';
                btnShare.dataset.action = 'sharing-settings';
                btnShare.title = 'Defini√ß√µes de Partilha';
                btnShare.textContent = 'üîê';
                
                // Insere no IN√çCIO ABSOLUTO da toolbar (√† esquerda de tudo)
                if (toolbar.firstChild) {
                    toolbar.insertBefore(btnShare, toolbar.firstChild);
                } else {
                    toolbar.appendChild(btnShare);
                }
            }
            // -----------------------------------------------------

            // Verificar e adicionar bot√£o T√≥picos (üìã) se faltar
            if (!toolbar.querySelector('button[data-action="manage-mini-note-topics"]')) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.action = 'manage-mini-note-topics';
                btn.title = 'Gerir T√≥picos';
                btn.textContent = 'üìã';
                // Insere antes do lixo
                const trashBtn = toolbar.querySelector('button[data-action="delete-mini-note"]');
                if (trashBtn) toolbar.insertBefore(btn, trashBtn);
                else toolbar.appendChild(btn);
            }

            // Verificar e adicionar bot√£o Destaque (üé®) se faltar
            if (!toolbar.querySelector('button[data-action="highlight-color"]')) {
                const btnColor = document.createElement('button');
                btnColor.type = 'button';
                btnColor.dataset.action = 'highlight-color';
                btnColor.title = 'Destacar';
                btnColor.textContent = 'üé®';
                const topicsBtn = toolbar.querySelector('button[data-action="manage-mini-note-topics"]');
                toolbar.insertBefore(btnColor, topicsBtn);
            }

            // Verificar bot√£o Enviar (üß¨)
            if (!toolbar.querySelector('button[data-action="append-mini-note"]')) {
                const btnAppend = document.createElement('button');
                btnAppend.type = 'button';
                btnAppend.dataset.action = 'append-mini-note';
                btnAppend.title = 'Enviar para outra nota';
                btnAppend.textContent = 'üß¨';
                
                // Tenta inserir logo a seguir ao bot√£o de partilha, se existir, sen√£o no in√≠cio
                const shareBtn = toolbar.querySelector('button[data-action="sharing-settings"]');
                if (shareBtn && shareBtn.nextSibling) {
                    toolbar.insertBefore(btnAppend, shareBtn.nextSibling);
                } else if (toolbar.firstChild) {
                    toolbar.insertBefore(btnAppend, toolbar.firstChild);
                } else {
                    toolbar.appendChild(btnAppend);
                }
            }

           // Verificar Setas (üî∫ üîª) - CORRE√á√ÉO PARA AGRUPAR EXISTENTES
            const existingUp = toolbar.querySelector('button[data-action="move-up"]');
            const existingDown = toolbar.querySelector('button[data-action="move-down"]');
            const existingGroup = toolbar.querySelector('.toolbar-btn-group');

            // CEN√ÅRIO A: Os bot√µes j√° existem, mas est√£o soltos (sem grupo)
            if (existingUp && existingDown && !existingGroup) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'toolbar-btn-group';
                
                // Insere o grupo antes do bot√£o "Cima"
                toolbar.insertBefore(groupDiv, existingUp);
                
                // Move os bot√µes para dentro do grupo
                groupDiv.appendChild(existingUp);
                groupDiv.appendChild(existingDown);
            }
            
            // CEN√ÅRIO B: Os bot√µes n√£o existem de todo (cria de raiz)
            else if (!existingUp && !existingGroup) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'toolbar-btn-group';

                const btnUp = document.createElement('button');
                btnUp.type = 'button';
                btnUp.dataset.action = 'move-up';
                btnUp.title = 'Mover para cima';
                btnUp.textContent = 'üî∫';

                const btnDown = document.createElement('button');
                btnDown.type = 'button';
                btnDown.dataset.action = 'move-down';
                btnDown.title = 'Mover para baixo';
                btnDown.textContent = 'üîª';
                
                groupDiv.appendChild(btnUp);
                groupDiv.appendChild(btnDown);

                // Insere na toolbar (logo a seguir ao bot√£o de partilha, se existir)
                const shareBtn = toolbar.querySelector('button[data-action="sharing-settings"]');
                let referenceNode = shareBtn ? shareBtn.nextSibling : toolbar.firstChild;
                
                // Verifica se referenceNode √© v√°lido, sen√£o anexa ao fim
                if (referenceNode) {
                    toolbar.insertBefore(groupDiv, referenceNode);
                } else {
                    toolbar.appendChild(groupDiv);
                }
            }
        } // <--- Fecha o if (toolbar)

        // --- ATUALIZA√á√ÉO VISUAL DOS BOT√ïES (ISTO FOI APAGADO E √â PRECISO) ---
        updateMiniNoteButtonState(wrapper); 
        updateHighlightButtonState(wrapper); 
        
        if (typeof updateSharingButtonState === 'function') {
            updateSharingButtonState(wrapper); 
        }

    }); // <--- Fecha o wrappers.forEach
} // <--- Fecha a function fixLegacyMiniNotes






// 1. Carregar Destaques Personalizados do Firebase
async function loadUserHighlights() {
    if (!auth.currentUser) return;
    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            userCustomHighlights = docSnap.data().colors || {};
        }
    } catch (e) {
        console.error("Erro ao carregar destaques:", e);
    }
}

// 2. Abrir Popup de Cores
 function renderHighlightList() {
    const container = document.getElementById('highlight-options-container');
    container.innerHTML = '';

    // 1. Descobrir qual a cor ativa na caixa atual
    // Convertemos para min√∫sculas para garantir que a compara√ß√£o funciona
    const activeColor = activeWrapperForColor && activeWrapperForColor.dataset.highlight 
                      ? activeWrapperForColor.dataset.highlight.toLowerCase() 
                      : null;

    // Op√ß√£o de Remover
    const removeRow = document.createElement('div');
    removeRow.className = 'highlight-option-row remove-highlight-row';
    removeRow.innerHTML = '<span>üö´ Remover Destaque</span>';
    removeRow.onclick = () => applyHighlight(null);
    container.appendChild(removeRow);

    // Lista de Cores
    DEFAULT_HIGHLIGHTS.forEach(colorObj => {
        const hex = colorObj.code;
        const displayName = userCustomHighlights[hex] || colorObj.name;

        const row = document.createElement('div');
        row.className = 'highlight-option-row';

        // --- CORRE√á√ÉO AQUI: Comparar ambos em min√∫sculas ---
        if (hex.toLowerCase() === activeColor) {
            row.classList.add('selected-color-row');
        }
        // ---------------------------------------------------

        // Bola de Cor
        const colorBox = document.createElement('div');
        colorBox.className = 'color-preview-box';
        colorBox.style.backgroundColor = hex;

        // Nome
        const nameLabel = document.createElement('span');
        nameLabel.className = 'highlight-name-label';
        nameLabel.textContent = displayName;

        // L√°pis
        const editBtn = document.createElement('button');
        editBtn.className = 'highlight-options-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.title = "Mudar Nome";
        editBtn.onclick = (e) => {
            e.stopPropagation(); 
            renameHighlight(hex, displayName);
        };

        row.onclick = () => applyHighlight(hex);

        row.appendChild(colorBox);
        row.appendChild(nameLabel);
        row.appendChild(editBtn);
        container.appendChild(row);
    });
}

// 2. Abrir Modal de Cores (Agora muito mais simples)
async function openHighlightPopup(wrapper) {
    // IMPORTANTE: Definir o wrapper ativo ANTES de renderizar a lista
    activeWrapperForColor = wrapper; 
    
    const modal = document.getElementById('highlight-modal');
    
    await loadUserHighlights();
    
    // Agora o render vai conseguir ler activeWrapperForColor.dataset.highlight
    renderHighlightList(); 

    modal.style.display = 'flex';
}

// 3. Renomear Destaque
async function renameHighlight(hexCode, currentName) {
    const newName = prompt("Novo nome para esta cor:", currentName);
    
    if (newName && newName.trim() !== "" && newName !== currentName) {
        
        // 1. Atualiza a mem√≥ria local (Cache)
        userCustomHighlights[hexCode] = newName.trim();
        
        // 2. Grava no Firebase (Usa a l√≥gica Cria/Edita)
        await syncColorsToFirebase();

        // 3. Atualiza a lista visual
        renderHighlightList();
    }
}

function updateSharingButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="sharing-settings"]');
    if (!btn) return;

    const isShared = wrapper.getAttribute('data-shared') === 'true';

    if (isShared) {
        btn.textContent = 'üîì'; // Cadeado aberto
        btn.classList.add('sharing-active');
        btn.title = "Partilha Permitida (P√∫blico)";
    } else {
        btn.textContent = 'üîê'; // Cadeado fechado
        btn.classList.remove('sharing-active');
        btn.title = "Partilha Bloqueada (Privado)";
    }
}

// Atualiza o √≠cone na toolbar principal
function updateNoteSharingButtonUI(isShared) {
    const btn = document.querySelector('button[data-action="note-sharing-settings"]');
    if (!btn) return;

    if (isShared) {
        // ESTADO P√öBLICO
        btn.textContent = 'üîì'; // Cadeado Aberto
        btn.style.color = '#2ecc71'; // Verde
        btn.title = "Nota P√∫blica (Clique para gerir)";
    } else {
        // ESTADO PRIVADO
        btn.textContent = 'üîê'; // Cadeado Fechado
        btn.style.color = ''; // Cor padr√£o do tema
        btn.title = "Nota Privada (Clique para partilhar)";
    }
}

// Fun√ß√£o Central: Grava as cores e o UserID no Firebase
// (Cria se n√£o existir, Atualiza se j√° existir)
async function syncColorsToFirebase() {
    if (!auth.currentUser) return;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // Prepara os dados
        const dataToSave = {
            userId: auth.currentUser.uid, // Garante que o ID do user est√° gravado
            colors: userCustomHighlights    // Grava o mapa de cores (Hex -> Nome)
        };

        // O { merge: true } √© a chave aqui:
        // - Se o doc n√£o existir: CRIA com estes dados.
        // - Se o doc existir: ATUALIZA/JUNTA estes dados.
        await setDoc(docRef, dataToSave, { merge: true });
        
        console.log("Firebase sincronizado: Cores e UserID gravados.");

    } catch (e) {
        console.error("Erro ao sincronizar cores:", e);
    }
}

// 4. Aplicar Destaque √† Caixa
async function applyHighlight(colorCode) {
    if (!activeWrapperForColor) return;

    // 1. L√≥gica de Base de Dados (Gravar a cor no perfil se for nova)
    if (colorCode) {
        const colorObj = DEFAULT_HIGHLIGHTS.find(c => c.code === colorCode);
        const colorName = userCustomHighlights[colorCode] || (colorObj ? colorObj.name : "Cor Personalizada");
        await ensureColorExistsInFirebase(colorCode, colorName);
        
        // Define o atributo no HTML
        activeWrapperForColor.dataset.highlight = colorCode;
    } else {
        // Remove o atributo
        activeWrapperForColor.removeAttribute('data-highlight');
    }

    // 2. L√≥gica Visual (Chama a fun√ß√£o centralizada que acab√°mos de criar)
    updateHighlightButtonState(activeWrapperForColor);

    // 3. Fechar e Gravar
    document.getElementById('highlight-modal').style.display = 'none';
    activeWrapperForColor = null;
    saveNote();
}
// Fun√ß√£o Auxiliar: Garante que a cor existe na cole√ß√£o 'destaques'
async function ensureColorExistsInFirebase(hexCode, defaultName) {
    // Se j√° temos esta cor carregada localmente, n√£o precisamos de ir √† BD
    if (userCustomHighlights[hexCode]) return;

    const nameToSave = defaultName;
    
    // Atualiza cache local
    userCustomHighlights[hexCode] = nameToSave;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // --- ALTERA√á√ÉO AQUI ---
        // Adicionamos userId: auth.currentUser.uid ao objeto
        await setDoc(docRef, {
            userId: auth.currentUser.uid, // <--- CAMPO NOVO
            colors: {
                [hexCode]: nameToSave
            }
        }, { merge: true });
        
        console.log(`Cor ${nameToSave} (${hexCode}) registada no Firebase com UserID.`);
    } catch (e) {
        console.error("Erro ao registar cor:", e);
    }
}

// Listener para o bot√£o üé®
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="highlight-color"]');
    if (btn) {
        e.preventDefault(); 
        e.stopPropagation();
        
     const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
if (!wrapper) return;
        
        // Simplesmente abre o popup, sem c√°lculos de posi√ß√£o nem toggle complexo
        openHighlightPopup(wrapper);
        return;
    }
});

// Fechar popup ao clicar fora
document.addEventListener('click', (e) => {
    // Tenta encontrar o novo modal
    const modal = document.getElementById('highlight-modal');
    
    // PROTE√á√ÉO CR√çTICA: Se o modal n√£o existir no HTML, para aqui e n√£o d√° erro
    if (!modal) return; 

    // Verifica se est√° vis√≠vel ('flex') e se o clique foi fora dele
    // Nota: Ignora tamb√©m cliques no bot√£o que abre o modal para evitar conflitos
    if (modal.style.display === 'flex' && 
        !modal.contains(e.target) && 
        !e.target.closest('button[data-action="highlight-color"]')) {
        
        modal.style.display = 'none';
        activeWrapperForColor = null;
    }
});

// 5. Atualizar Estado Visual do Bot√£o (Ao carregar a nota)
 function updateHighlightButtonState(wrapper) {
    const color = wrapper.dataset.highlight;
    const btn = wrapper.querySelector('button[data-action="highlight-color"]');
    const contentDiv = wrapper.querySelector('.mini-note-content');

    if (!btn) return;

    if (color) {
        // --- ESTILO ATIVO (PREENCHIDO) ---
        // Fundo ligeiramente claro para destacar que est√° ativo
        btn.style.backgroundColor = "rgba(255, 255, 255, 0.15)"; 
        // Borda com a cor do destaque escolhido
        btn.style.borderColor = color; 
        // √çcone com a cor do destaque escolhido
        btn.style.color = color; 
        
        btn.classList.add('has-color');
        
        // Garante que a caixa de texto tem a cor correta
        if (contentDiv) {
            contentDiv.style.backgroundColor = color;
            contentDiv.style.color = "#222222"; // Texto escuro para contraste
        }
    } else {
        // --- ESTILO INATIVO (RESET) ---
        btn.style.backgroundColor = "";
        btn.style.borderColor = "";
        btn.style.color = "";
        btn.classList.remove('has-color');
        
        if (contentDiv) {
            contentDiv.style.backgroundColor = ""; // Remove fundo
            contentDiv.style.color = ""; // Volta √† cor do tema
        }
    }
}


function updateMiddlePanelForFolderSelection(folderId, folderName, selectedElement) {
    // 1. Atualiza o estado da sele√ß√£o visual no painel esquerdo
    document.querySelectorAll('#left-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    selectedElement.classList.add('selected');

    // 2. Atualiza o stack de navega√ß√£o para refletir a nova pasta
    if (navigationStack.length > 0) {
        // Se j√° est√°vamos numa pasta, substitu√≠mos o √∫ltimo item
        navigationStack[navigationStack.length - 1] = { id: folderId, name: folderName };
    } else {
        // Se est√°vamos na raiz, adicionamos a pasta ao stack
        navigationStack.push({ id: folderId, name: folderName });
    }
    
    // 3. Atualiza o t√≠tulo do painel do meio e o bot√£o "Voltar"
    middlePanelTitle.textContent = folderName;
    backBtn.style.display = 'flex';

    // 4. Limpa o listener antigo do painel do meio para evitar fugas de mem√≥ria
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();

    // 5. Busca e exibe os novos itens no painel do meio, sem tocar no editor
    unsubscribeMiddlePanel = fetchAndDisplayItems(folderId, middlePanelList, null);
}




async function displayNote(noteId, noteElement, searchTerm = null, keepReferencesOpen = false) {
    // 1. L√≥gica visual de sele√ß√£o na lista
    document.querySelectorAll('#middle-panel .list-item.selected').forEach(el => el.classList.remove('selected'));
    
    if (!noteElement) {
        noteElement = document.querySelector(`#middle-panel-list .list-item[data-id="${noteId}"]`) || 
                      document.querySelector(`#file-list .list-item[data-id="${noteId}"]`);
    }
    if (noteElement) noteElement.classList.add('selected');
    
    selectedNoteId = noteId;
    
    // 2. Alternar visualiza√ß√£o para o Editor
    editorPlaceholder.style.display = 'none';
    editorArea.style.display = 'flex';
    
    // 3. LIMPEZA DE CONTEXTO (L√≥gica Alterada)
    // S√≥ fecha o painel SE o par√¢metro keepReferencesOpen for FALSO.
    if (!keepReferencesOpen && notebookContainer.classList.contains('references-panel-visible')) {
        hideReferencesPanel();
    }
    
    // 4. Carregar dados
    try {
        const noteRef = doc(db, 'pastas', noteId);
        const noteSnap = await getDoc(noteRef);

        if (noteSnap.exists()) {
            const data = noteSnap.data();
            const { nome, conteudo, shareSettings } = data; 
            
            noteTitleInput.value = nome || '';
            noteContentEditor.innerHTML = conteudo || '';

            currentNoteShareData = shareSettings || { shared: false, shareId: null };
            updateNoteSharingButtonUI(currentNoteShareData.shared);

            fixLegacyMiniNotes(); 
            refreshAllCalendars();

            // Scroll para o termo pesquisado (Nome da entidade)
            if (searchTerm) {
                setTimeout(() => { scrollToAndHighlightText(searchTerm); }, 300);
            } else {
                noteContentEditor.scrollTop = 0;
            }

            setTimeout(() => { scanAndLinkEntities(); }, 1000); 
        }
    } catch (error) {
        console.error("Erro ao carregar nota:", error);
    }
    
    // 5. UI Mobile
    notebookContainer.classList.add('left-panel-collapsed');
    if (window.innerWidth <= 768) {
        notebookContainer.classList.add('middle-panel-collapsed');
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
        if (middlePanelToggleBtn) {
            middlePanelToggleBtn.textContent = '¬ª';
            middlePanelToggleBtn.title = "Expandir Painel";
        }
    }

    updateSaveStatus('saved');
}


function scrollToAndHighlightText(term) {
    if (!term) return;
    const lowerTerm = term.toLowerCase();

    // 1. Procura em Inputs (T√≠tulos de Subnotas/Quest√µes)
    const inputs = noteContentEditor.querySelectorAll('input');
    for (const input of inputs) {
        if (input.value.toLowerCase().includes(lowerTerm)) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            input.focus();
            // Adiciona efeito visual
            input.parentElement.classList.add('temporary-highlight');
            setTimeout(() => input.parentElement.classList.remove('temporary-highlight'), 2000);
            return; // Encontrou, para aqui.
        }
    }

    // 2. Procura no Texto (TreeWalker para encontrar n√≥s de texto)
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT, null, false);
    let node;
    while (node = walker.nextNode()) {
        const text = node.textContent;
        const index = text.toLowerCase().indexOf(lowerTerm);

        if (index >= 0) {
            // Encontrou o texto!
            
            // A. Tenta identificar se est√° dentro de um Post-it ou Subnota para destacar o contentor
            const container = node.parentElement.closest('.post-it-note, .mini-note-wrapper');
            if (container) {
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                container.classList.add('temporary-highlight');
                setTimeout(() => container.classList.remove('temporary-highlight'), 2000);
            } else {
                // Scroll no elemento pai direto
                node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // B. Selecionar o texto exato (Highlight nativo do browser)
            const range = document.createRange();
            range.setStart(node, index);
            range.setEnd(node, index + term.length);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            return; // Encontrou, para a pesquisa.
        }
    }
}

function saveNote(forceImmediate = false) {
    // 1. Cancela o temporizador anterior (se existir)
    clearTimeout(saveTimeout);

    // 2. Se for para gravar IMEDIATAMENTE (navega√ß√£o)
    if (forceImmediate) {
        return executeSave(); // Retorna a promessa da grava√ß√£o
    }

    // 3. Se for escrita normal (espera 2 minutos)
    updateSaveStatus('unsaved'); // Mostra "por guardar..."
    
    // 120000 ms = 2 minutos
    saveTimeout = setTimeout(async () => {
        await executeSave();
    }, 120000); 
}

// ============================================================
// FUN√á√ÉO AUXILIAR: Extrair todos os t√≥picos do HTML (Caixas)
// ============================================================
function extractTopicsFromEditorHTML() {
    // Encontra todas as caixas (Quest√µes, Subnotas, Contentores)
    const allWrappers = document.getElementById('note-content-editor').querySelectorAll('.mini-note-wrapper');
    const aggregatedTopics = {};

    allWrappers.forEach(wrapper => {
        try {
            // L√™ o atributo data-topics
            const jsonStr = wrapper.getAttribute('data-topics');
            
            // Ignora se estiver vazio
            if (!jsonStr || jsonStr === '{}') return;

            const topics = JSON.parse(jsonStr);

            // Junta tudo num √∫nico objeto grande
            for (const [topicId, subArray] of Object.entries(topics)) {
                
                // Se o t√≥pico ainda n√£o existe, cria array vazio
                if (!aggregatedTopics[topicId]) {
                    aggregatedTopics[topicId] = [];
                }

                // Adiciona subt√≥picos sem duplicar
                if (Array.isArray(subArray)) {
                    subArray.forEach(subId => {
                        if (!aggregatedTopics[topicId].includes(subId)) {
                            aggregatedTopics[topicId].push(subId);
                        }
                    });
                }
            }
        } catch (e) {
            console.warn("Erro ao ler t√≥picos de uma caixa:", e);
        }
    });

    return aggregatedTopics;
}

// Fun√ß√£o que faz a grava√ß√£o real no Firebase
async function executeSave() {
    if (!selectedNoteId) return;

    updateSaveStatus('saving');

    try {
        // Fixar valores dos inputs
        const miniNoteInputs = noteContentEditor.querySelectorAll('.mini-note-title-input');
        miniNoteInputs.forEach(input => input.setAttribute('value', input.value || ''));

        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        // --- AQUI EST√Å A MAGIA ---
        // 1. Extrai os t√≥picos de todas as caixas HTML
        const finalTopicsIndex = extractTopicsFromEditorHTML();
        
        console.log("üíæ [SAVE] A enviar para DB:", finalTopicsIndex);
        // -------------------------

        // L√≥gica de Tags e Cores (Mant√©m a tua existente ou usa este resumo)
        let finalTagNames = []; 
        try { finalTagNames = Array.from(noteContentEditor.querySelectorAll('span.tag')).map(s => s.textContent.substring(1)); } catch(e){}
        
        const coloredWrappers = noteContentEditor.querySelectorAll('.mini-note-wrapper[data-highlight]');
        const uniqueColorsUsed = [...new Set(Array.from(coloredWrappers).map(el => el.dataset.highlight))];

        // 2. Atualiza o documento
        await updateDoc(noteRef, { 
            nome: noteTitleInput.value, 
            conteudo: noteContentEditor.innerHTML,
            tags: finalTagNames,
            coresUsadas: uniqueColorsUsed,
            
            // CAMPO CR√çTICO PARA A PESQUISA:
            topicosSelecionados: finalTopicsIndex, 
            
            ultimaedicao: serverTimestamp()
        });

        // Atualiza UI
        const listItem = document.querySelector(`.list-item[data-id="${selectedNoteId}"] span`);
        if (listItem) listItem.textContent = noteTitleInput.value;
        
        updateSaveStatus('saved');
        console.log("‚úÖ Gravado com sucesso!");
        return true; 

    } catch (error) {
        console.error("ERRO AO GUARDAR:", error);
        updateSaveStatus('error');
        alert("Erro ao guardar!");
        throw error;
    }
}


// SINCRONIZA√á√ÉO P√öBLICA (Se a nota estiver partilhada)
    if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
        try {
            // Grava na cole√ß√£o 'shared_notes' sem bloquear a grava√ß√£o principal
            setDoc(doc(db, 'shared_notes', currentNoteShareData.shareId), {
                nome: noteTitleInput.value,
                conteudo: noteContentEditor.innerHTML,
                authorName: currentUserData?.nome || "An√≥nimo",
                updatedAt: serverTimestamp(),
                type: 'full_note' // Marca como nota completa
            }, { merge: true }).catch(err => console.error("Erro sync partilha:", err));
            
        } catch (e) {
            console.warn("Falha silenciosa ao sincronizar partilha p√∫blica.");
        }
    }

 function insertMiniNoteAtCursor(type = 'default') {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    if (!noteContentEditor.contains(selection.anchorNode)) return;

    // Verifica√ß√£o de aninhamento
    const currentNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
    if (currentNode.closest('.mini-note-wrapper')) return;

    const miniNoteId = `mn_${Date.now()}`;
    
    // Configura√ß√µes baseadas no tipo
    let wrapperClass = 'mini-note-wrapper';
    let titleHTML = ''; 
    
    if (type === 'question') {
        wrapperClass += ' question-mode';
        titleHTML = `<input type="text" class="mini-note-title-input" placeholder="T√≠tulo da Quest√£o..." value="">`;
    } else if (type === 'free') {
        wrapperClass += ' free-mode';
        titleHTML = ''; 
    } else {
        titleHTML = `<input type="text" class="mini-note-title-input" placeholder="T√≠tulo da Sub-Nota..." value="">`;
    }

    // HTML da Mini-Nota (COM O NOVO BOT√ÉO üé®)
  const miniNoteHTML = `
    <div contenteditable="false" style="height: 20px;"></div>
    <!-- ADICIONADO: data-shared="false" -->
    <div class="${wrapperClass}" contenteditable="false" id="${miniNoteId}" data-topics='{}' data-shared="false">
        ${titleHTML}
        <div class="mini-note-toolbar">
            <!-- NOVO BOT√ÉO DE PARTILHA (Cadeado) -->
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            
          <div class="toolbar-btn-group">
    <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
    <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
</div>
            
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Remover">üóëÔ∏è</button>
        </div>
        <div class="mini-note-content" contenteditable="true">
            <p><br></p>
        </div>
    </div>
    <div contenteditable="false" style="height: 20px;"></div>
    <p><br></p>
`;

    document.execCommand('insertHTML', false, miniNoteHTML);
    
    // Foco...
    setTimeout(() => {
        const insertedWrapper = document.getElementById(miniNoteId);
        if (insertedWrapper) {
            if (type === 'free') {
                const contentDiv = insertedWrapper.querySelector('.mini-note-content');
                if (contentDiv) contentDiv.focus();
            } else {
                const titleInput = insertedWrapper.querySelector('.mini-note-title-input');
                if (titleInput) titleInput.focus();
            }
        }
    }, 10);
    saveNote();
}


// ====================================================================
// L√ìGICA DE IDEIAS (üí°)
// ====================================================================

// 1. CRIAR IDEIA (No evento do Selection Popup)
// Adicione este bloco dentro do listener existente 'selectionPopup.addEventListener' 
// Pode copiar este bloco e colocar junto aos outros 'else if' desse listener, ou adicionar separado se preferir
selectionPopup.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // ------------------------------------------
    // A√á√ÉO 1: CRIAR CART√ÉO WEB (üé¥) - NOVO!
    // ------------------------------------------
    if (action === 'create-url-card') {
        // Chama a fun√ß√£o auxiliar que cri√°mos para lidar com a API e o HTML
        await convertSelectionToUrlCard();
        
        // Fecha o popup
        selectionPopup.style.display = 'none';
        window.getSelection().removeAllRanges();
        currentSelectionRange = null;
        return; 
    }

    // ------------------------------------------
    // A√á√ÉO 2: CRIAR IDEIA (üí°)
    // ------------------------------------------
    else if (action === 'create-idea') {
        // Tenta recuperar a sele√ß√£o global guardada
        if (!currentSelectionRange) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0).cloneRange();
        }

        if (!currentSelectionRange) return;

        const text = currentSelectionRange.toString();
        if (!text.trim()) return;

        try {
            // Gravar no Firebase
            const ideaRef = await addDoc(collection(db, 'ideias'), {
                texto: text,
                origemNoteId: selectedNoteId,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Criar o SPAN visual vermelho
            const span = document.createElement('span');
            span.className = 'idea-span';
            span.dataset.ideaId = ideaRef.id;
            span.setAttribute('spellcheck', 'false');
            span.textContent = text;

            // Substitui√ß√£o
            currentSelectionRange.deleteContents();
            currentSelectionRange.insertNode(span);

            // Inserir espa√ßo invis√≠vel depois para n√£o prender o cursor
            const space = document.createTextNode('\u00A0');
            if (span.nextSibling) {
                span.parentNode.insertBefore(space, span.nextSibling);
            } else {
                span.parentNode.appendChild(space);
            }

            // Move cursor para fora
            const newRange = document.createRange();
            newRange.setStartAfter(space);
            newRange.collapse(true);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(newRange);

            saveNote();

        } catch (error) {
            console.error("Erro ao criar ideia:", error);
            alert("Erro ao criar ideia.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 3: CRIAR LINK / EDITAR LINK (üîó)
    // ------------------------------------------
    else if (action === 'create-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        // Verifica se j√° estamos dentro de um link
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }

        if (linkElement) {
            // Modo Edi√ß√£o
            openLinkModal(true, { 
                id: linkElement.dataset.anexoId, 
                title: linkElement.textContent, 
                url: linkElement.href 
            });
        } else {
            // Modo Cria√ß√£o
            if (currentSelectionRange) {
                const selectedText = currentSelectionRange.toString().trim();
                openLinkModal(false, selectedText);
            } else {
                alert("Por favor, selecione o texto novamente.");
            }
        }
    }

    // ------------------------------------------
    // A√á√ÉO 4: REMOVER LINK (‚õìÔ∏è‚Äçüí•)
    // ------------------------------------------
    else if (action === 'break-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }
        
        if (linkElement) {
            // Abre modal em modo edi√ß√£o (que tem o bot√£o remover)
            openLinkModal(true, { id: linkElement.dataset.anexoId });
        } else {
            alert("O cursor n√£o est√° sobre um anexo.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 5: CRIAR ENTIDADE (üìç, üë§, üìÖ, üìñ)
    // ------------------------------------------
    else if (action === 'create-entity') {
        const type = btn.dataset.type; // ex: 'local', 'personagem'
        const selectedText = currentSelectionRange ? currentSelectionRange.toString().trim() : "";

        if(selectedText) {
            openEntityModal(type, selectedText);
        } else {
            alert("Selecione texto para criar uma entidade.");
        }
    }

    // ------------------------------------------
    // A√á√ÉO 6: CRIAR POST-IT (üìí)
    // ------------------------------------------
    else if (action === 'highlight') { 
        if (!currentSelectionRange) {
            // Tenta obter do window se a global falhar
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0);
        }

        const selectedText = currentSelectionRange ? currentSelectionRange.toString() : ""; 

        if (!selectedText.trim()) {
            alert("Selecione algum texto para criar um post-it.");
        } else {
            // Cria o Container
            const container = document.createElement('div');
            container.className = 'post-it-note active-note';
            container.contentEditable = "false";
            
            // Posi√ß√£o (perto do scroll atual)
            const scrollTop = noteContentEditor.scrollTop;
            container.style.top = (scrollTop + 50) + 'px'; 
            container.style.left = '50px';
            container.id = 'postit_' + Date.now();

            // Puxador
            const handle = document.createElement('div');
            handle.className = 'post-it-drag-handle';
            handle.innerHTML = '‚ú•';
            handle.contentEditable = "false"; 

            // Bot√£o Cortar (Tesoura)
            const cutBtn = document.createElement('div');
            cutBtn.className = 'post-it-cut-btn';
            cutBtn.title = "Reverter para texto normal";
            cutBtn.innerHTML = '‚úÇÔ∏è';
            cutBtn.contentEditable = "false";

            // Conte√∫do
            const content = document.createElement('div');
            content.className = 'post-it-content';
            content.contentEditable = "true"; 
            content.innerHTML = selectedText; // Usa innerHTML para manter formata√ß√£o b√°sica

            container.appendChild(handle);
            container.appendChild(cutBtn);
            container.appendChild(content);

            // Remove o texto original e insere o post-it
            currentSelectionRange.deleteContents();
            noteContentEditor.appendChild(container);
            
            saveNote(); 
        }
    }

    // ------------------------------------------
    // FINALIZA√á√ÉO (Limpeza Comum)
    // ------------------------------------------
    selectionPopup.style.display = 'none';
    window.getSelection().removeAllRanges();
    currentSelectionRange = null; 
});





function validateAndCleanBiblicalLinks() {
    console.log('%cFASE 0: Iniciando limpeza de links b√≠blicos...', 'color: #e67e22; font-weight: bold;');
    
    const biblicalBooksPattern = `${BIBLICAL_BOOKS.join('|')}`;

    // =======================================================
    // AQUI ESTAVA O ERRO PERSISTENTE - ESTA √â A REGEX CORRETA E RIGOROSA
    // =======================================================
    const validPattern = new RegExp(`^${biblicalBooksPattern}\\s+\\d+:\\d[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    
    console.log(`FASE 0: Encontrados ${links.length} links b√≠blicos para validar.`);

    let domChanged = false;

    links.forEach((link, index) => {
        const originalText = link.textContent;
        const trimmedText = originalText.trim();
        
        console.log(`FASE 0: Verificando Link #${index + 1}: "${originalText}" (limpo: "${trimmedText}")`);

        if (!validPattern.test(trimmedText)) {
            console.log(`%cFASE 0: INV√ÅLIDO! O texto "${trimmedText}" n√£o corresponde ao padr√£o. Revertendo para texto simples.`, 'color: #c0392b; font-weight: bold;');
            
            const textNode = document.createTextNode(originalText);
            link.parentNode.replaceChild(textNode, link);

            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(textNode, textNode.length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            domChanged = true;
        } else {
            console.log(`%cFASE 0: V√ÅLIDO. O link "${trimmedText}" ser√° mantido.`, 'color: #27ae60;');
        }
    });

    if (domChanged) {
        console.log('FASE 0: A limpeza alterou o DOM.');
    } else {
        console.log('FASE 0: Nenhum link inv√°lido encontrado. Nenhuma altera√ß√£o feita.');
    }
    
    return domChanged;
}



/**
 * Percorre o editor para remover caracteres invis√≠veis (como o Zero-Width Space)
 * que podem ter sido deixados por outras opera√ß√µes, garantindo que a l√≥gica de 
 * reconhecimento de entidades funcione em texto limpo.
 * A posi√ß√£o do cursor √© cuidadosamente preservada.
 */
function cleanupInvisibleCharacters() {
    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0) return;

    // Salva a posi√ß√£o original do cursor
    const originalRange = selection.getRangeAt(0);
    let originalContainer = originalRange.startContainer;
    let originalOffset = originalRange.startOffset;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        nodesToProcess.push(node);
    }
    
    const ZWSP = /\u200B/g; // Regex para o caractere invis√≠vel (Zero-Width Space)

    for (const textNode of nodesToProcess) {
        if (ZWSP.test(textNode.textContent)) {
            // Se o cursor estiver neste n√≥, ajustamos a sua posi√ß√£o futura
            if (textNode === originalContainer) {
                // Conta quantos caracteres invis√≠veis existem ANTES da posi√ß√£o do cursor
                const charsToRemoveBeforeCursor = (textNode.textContent.substring(0, originalOffset).match(ZWSP) || []).length;
                originalOffset -= charsToRemoveBeforeCursor;
            }
            // Remove todos os caracteres invis√≠veis do n√≥ de texto
            textNode.textContent = textNode.textContent.replace(ZWSP, '');
        }
    }

    // Normaliza o editor para juntar n√≥s de texto que possam ter sido separados
    noteContentEditor.normalize();

    // Restaura a posi√ß√£o do cursor, garantindo que o n√≥ ainda existe
    try {
        const newRange = document.createRange();
        // Verifica se o container original ainda faz parte do documento
        if (document.body.contains(originalContainer)) {
             // Garante que a posi√ß√£o n√£o exceda o novo comprimento do texto
            const newOffset = Math.min(originalOffset, originalContainer.textContent.length);
            newRange.setStart(originalContainer, newOffset);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
        }
    } catch (e) {
        console.error("Erro ao restaurar a posi√ß√£o do cursor ap√≥s a limpeza:", e);
    }
}




 // ===================================================================
// FUN√á√ÉO SCANANDLINKENTITIES - VERS√ÉO COM REGEX CORRIGIDA
// ===================================================================
 async function scanAndLinkEntities() {
    const logStyles = {
        header: 'color: white; background-color: #1abc9c; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;',
        automation: 'color: white; background-color: #8e44ad; font-weight: bold; padding: 2px 5px; border-radius: 3px;'
    };

    console.groupCollapsed('%c[Verifica√ß√£o] Iniciando verifica√ß√£o de entidades...', logStyles.header);

    noteContentEditor.normalize();
    
    // --- CORRE√á√ÉO AQUI ---
    const hasCleanedLinks = await validateAndCleanBiblicalLinks(); 
    // ---------------------

    if (hasCleanedLinks) {
        console.log('%c  - Links inv√°lidos foram removidos. A acionar grava√ß√£o e a terminar verifica√ß√£o.', logStyles.info);
        updateSaveStatus('unsaved');
        saveNote(); 
        console.groupEnd();
        return; 
    } else {
        console.log('%c  - Nenhum link b√≠blico inv√°lido para limpar.', logStyles.info);
    }

    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
        console.log('%c  - Verifica√ß√£o ignorada (texto selecionado ou nenhum cursor).', logStyles.info);
        console.groupEnd();
        return;
    }
    const originalRange = selection.getRangeAt(0).cloneRange();

    console.group('%cFASE 1: Liga√ß√£o de Formato Padr√£o (Livro C:V)', logStyles.phase);
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const standardBiblicalRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'giu');
    
    console.log('%c  - Regex utilizada:', logStyles.info, standardBiblicalRegex);

    let domModified = false;
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) {
            nodesToProcess.push(node);
        }
    }

    for (const textNode of nodesToProcess) {
        standardBiblicalRegex.lastIndex = 0;
        let match;
        if ((match = standardBiblicalRegex.exec(textNode.textContent)) !== null) {
            domModified = true;
            
            const matchedName = match[1].trim(); 
            const cleanedName = matchedName.replace(/[.,;]+$/, '');
            console.log(`%c  - Texto identificado: "${matchedName}". Texto a gravar: "${cleanedName}"`, logStyles.action);

            const matchStartIndex = match.index;
            
            textNode.splitText(matchStartIndex + matchedName.length);
            let matchNode = textNode.splitText(matchStartIndex);
            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = 'textobiblico';
            span.dataset.entityName = cleanedName;
            span.textContent = cleanedName;
            matchNode.parentNode.replaceChild(span, matchNode);
            
            const allExistingEntities = Object.values(allEntities).flat();
            let entity = allExistingEntities.find(e => e.tipo === 'textobiblico' && e.nome.toLowerCase() === cleanedName.toLowerCase());
            
            if (!entity) {
                console.group('%c[Automa√ß√£o] Nova Entidade B√≠blica Detetada', logStyles.automation);
                const collectionName = ENTITY_CONFIG['textobiblico'].collection;

                try {
                    console.log(`%c  - Passo 1: A criar ficha para "${cleanedName}"...`, logStyles.info);
                    await addDoc(collection(db, collectionName), { 
                        nome: cleanedName, 
                        descricao: "", 
                        userId: auth.currentUser.uid, 
                        createdAt: serverTimestamp(), 
                        referencias: { [selectedNoteId]: true } 
                    });

                } catch (error) {
                    console.error(`%c  - ERRO: Falha ao criar a entidade autom√°tica na base de dados.`, 'color: red; font-weight: bold;', error);
                } finally {
                    await fetchAllEntities(); 
                    console.groupEnd(); 
                }
            }
            break; 
        }
    }
    console.groupEnd(); 
    
    if (domModified) {
        selection.removeAllRanges();
        selection.addRange(originalRange);
        updateSaveStatus('unsaved');
        saveNote();
    }
}





function maintainEntityProtection() {
    const entityLinks = noteContentEditor.querySelectorAll('.entity-link');
    let domModified = false;

    entityLinks.forEach(link => {
        const parent = link.parentNode;
        let needsProtectionBefore = true;
        let needsProtectionAfter = true;

        // Verifica o que existe ANTES do link
        if (link.previousSibling && link.previousSibling.nodeType === Node.TEXT_NODE && link.previousSibling.textContent.endsWith('\u200B')) {
            needsProtectionBefore = false;
        }

        // Verifica o que existe DEPOIS do link
        if (link.nextSibling && link.nextSibling.nodeType === Node.TEXT_NODE && link.nextSibling.textContent.startsWith('\u200B')) {
            needsProtectionAfter = false;
        }

        // Se faltar prote√ß√£o antes, adiciona-a
        if (needsProtectionBefore) {
            console.log(`%cMANUTEN√á√ÉO: A proteger a entidade "${link.textContent}" (antes).`, 'color: #f39c12;');
            const zeroWidthSpace = document.createTextNode('\u200B');
            parent.insertBefore(zeroWidthSpace, link);
            domModified = true;
        }

        // Se faltar prote√ß√£o depois, adiciona-a
        if (needsProtectionAfter) {
            console.log(`%cMANUTEN√á√ÉO: A proteger a entidade "${link.textContent}" (depois).`, 'color: #f39c12;');
            const zeroWidthSpace = document.createTextNode('\u200B');
            // insertBefore √© usado para inserir depois, passando o "irm√£o" seguinte como refer√™ncia
            parent.insertBefore(zeroWidthSpace, link.nextSibling);
            domModified = true;
        }
    });

    if (domModified) {
        // A normaliza√ß√£o junta n√≥s de texto adjacentes, limpando o c√≥digo
        noteContentEditor.normalize();
    }
}


function escapeRegExp(string) {
  // $& significa a string inteira que foi encontrada
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
}

    async function validateAndReconcileAllEntities() {
    // Estilos para os logs na consola
    const logStyles = {
        header: 'color: white; background-color: #00a8ff; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;'
    };

    console.groupCollapsed('%c[Reconcilia√ß√£o] Iniciando verifica√ß√£o completa de entidades...', logStyles.header);

    // ETAPA 1: Preservar a posi√ß√£o do cursor
    console.log('%cFASE 1: Preservando a posi√ß√£o do cursor', logStyles.phase);
    const selection = window.getSelection();
    let cursorMarker = null;
    let originalRange = null;
    if (selection && selection.rangeCount > 0) {
        originalRange = selection.getRangeAt(0).cloneRange();
        if (selection.isCollapsed) {
            cursorMarker = document.createElement('span');
            cursorMarker.id = 'cursor-marker'; // A nossa "bandeira"
            try {
                originalRange.insertNode(cursorMarker);
                console.log('%c  - Inserido marcador de cursor no DOM.', logStyles.success);
            } catch (e) {
                console.warn('  - N√£o foi poss√≠vel inserir o marcador de cursor. A sele√ß√£o pode estar num local inv√°lido.', e);
                cursorMarker = null; // Garante que n√£o tentaremos encontr√°-lo mais tarde
            }
        } else {
            console.log('%c  - O utilizador tem texto selecionado. O range original ser√° restaurado.', logStyles.info);
        }
    } else {
        console.log('%c  - Nenhuma sele√ß√£o encontrada. Imposs√≠vel preservar o cursor.', logStyles.info);
    }
    
    // ETAPA 2: Varrer e corrigir
    console.log('%cFASE 2: Procurando por entidades n√£o formatadas', logStyles.phase);
    const allKnownEntities = Object.values(allEntities).flat();
    if (!allKnownEntities || allKnownEntities.length === 0) {
        console.log('%c  - Nenhuma entidade conhecida na base de dados. A abortar reconcilia√ß√£o.', logStyles.info);
        // Ainda assim, remove o marcador se ele foi inserido
        if (cursorMarker) cursorMarker.parentNode.removeChild(cursorMarker);
        console.groupEnd();
        return;
    }
    console.log(`%c  - A comparar o texto com ${allKnownEntities.length} entidades conhecidas.`, logStyles.info);


    let keepLooping = true;
    let pass = 0;
    while (keepLooping) {
        pass++;
        console.log(`%c  - INICIANDO PASSAGEM DE VERIFICA√á√ÉO N¬∫ ${pass}`, logStyles.action);
        keepLooping = false; // Assume que esta ser√° a √∫ltima passagem, a menos que uma altera√ß√£o seja feita
        
        const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
        const nodesToProcess = [];
        let n;
        while (n = walker.nextNode()) {
            nodesToProcess.push(n);
        }
        console.log(`%c    - Encontrados ${nodesToProcess.length} n√≥s de texto para analisar.`, logStyles.info);


        for (const node of nodesToProcess) {
            // Ignora n√≥s que j√° est√£o dentro de elementos especiais para evitar trabalho desnecess√°rio
            if (!node.parentElement || node.parentElement.closest('.entity-link, .tag, a, #cursor-marker')) {
                continue;
            }

            for (const entity of allKnownEntities) {
                // A l√≥gica de textos b√≠blicos √© tratada noutra fun√ß√£o, por isso ignoramo-la aqui.
                if (entity.tipo === 'textobiblico') continue;
                
                const entityName = entity.nome;
                // Usa uma RegEx com `\b` (word boundary) para encontrar a palavra exata
                const regex = new RegExp(`\\b(${escapeRegExp(entityName)})\\b`);
                
                if (regex.test(node.textContent)) {
                    console.log(`%c    - SUCESSO! Encontrado texto simples "${entityName}" no n√≥: "${node.textContent}"`, logStyles.success);
                    console.log('%c    - A recriar o link...', logStyles.action);

                    // Divide o n√≥ de texto em tr√™s partes: antes, durante e depois da correspond√™ncia
                    const matchIndex = node.textContent.search(regex);
                    node.splitText(matchIndex + entityName.length); // Divide depois
                    const matchNode = node.splitText(matchIndex); // Divide antes
                    
                    // Cria o novo elemento <span> para a entidade
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = entity.tipo;
                    span.dataset.entityName = entity.nome;
                    span.textContent = entity.nome;
                    
                    // Substitui o n√≥ de texto (que agora cont√©m apenas o nome da entidade) pelo <span> formatado
                    matchNode.parentNode.replaceChild(span, matchNode);
                    
                    console.log('%c    - Link recriado. A reiniciar a passagem de verifica√ß√£o para garantir consist√™ncia.', logStyles.info);
                    keepLooping = true; // For√ßa uma nova passagem porque o DOM foi alterado
                    break; // Sai do loop de entidades
                }
            }
            if (keepLooping) break; // Sai do loop de n√≥s para reiniciar a passagem
        }
        if (!keepLooping) {
             console.log(`%c  - FIM DA PASSAGEM N¬∫ ${pass}. Nenhuma altera√ß√£o foi feita.`, logStyles.info);
        }
    }
    
    // ETAPA 3: Restaurar a posi√ß√£o do cursor
    console.log('%cFASE 3: Restaurando a posi√ß√£o do cursor', logStyles.phase);
    const markerInDom = document.getElementById('cursor-marker');
    if (markerInDom) {
        const newRange = document.createRange();
        // Colocamos o cursor ANTES da √¢ncora para que ele fique na posi√ß√£o correta
        newRange.setStartBefore(markerInDom);
        newRange.collapse(true);
        selection.removeAllRanges();
        selection.addRange(newRange);
        // Removemos a √¢ncora depois de a usarmos
        markerInDom.parentNode.removeChild(markerInDom);
        console.log('%c  - Marcador encontrado. Posi√ß√£o do cursor restaurada.', logStyles.success);
    } else if (originalRange) {
        // Fallback: se n√£o t√≠nhamos uma √¢ncora (ex: sele√ß√£o de texto), restauramos o range original
        selection.removeAllRanges();
        selection.addRange(originalRange);
        console.log('%c  - Marcador n√£o encontrado, mas range original foi restaurado.', logStyles.info);
    } else {
        console.log('%c  - N√£o foi poss√≠vel restaurar o cursor.', logStyles.info);
    }
    
    console.groupEnd();
}

function requestPassword(mode, itemId) {
    return new Promise((resolve) => {
        const modal = document.getElementById('password-modal');
        const title = document.getElementById('password-modal-title');
        const desc = document.getElementById('password-modal-desc');
        const input = document.getElementById('password-input');
        const errorMsg = document.getElementById('password-error');
        const confirmBtn = document.getElementById('password-confirm-btn');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');

        // Configura√ß√£o baseada no modo
        input.value = '';
        errorMsg.style.display = 'none';
        modal.style.display = 'flex';
        input.focus();

        // Clona bot√µes para limpar listeners antigos
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const cleanup = () => {
            modal.style.display = 'none';
            cancelBtn.onclick = null;
        };

        if (mode === 'create') {
            title.textContent = 'Definir Prote√ß√£o';
            desc.textContent = 'Escolha uma palavra-passe para este item.';
            newConfirmBtn.textContent = 'Proteger';
            
            newConfirmBtn.onclick = async () => {
                const pass = input.value.trim();
                if (!pass) return alert("A palavra-passe n√£o pode ser vazia.");
                
                // Grava no Firebase
                try {
                    await updateDoc(doc(db, 'pastas', itemId), {
                        passe: pass,
                        ultimaedicao: serverTimestamp()
                    });
                    cleanup();
                    resolve(true);
                } catch (e) {
                    console.error(e);
                    alert("Erro ao proteger item.");
                    resolve(false);
                }
            };

        } else { 
            // Modos: 'access' (abrir) ou 'remove' (tirar prote√ß√£o)
            title.textContent = mode === 'remove' ? 'Remover Prote√ß√£o' : 'Item Protegido';
            desc.textContent = 'Insira a palavra-passe atual.';
            newConfirmBtn.textContent = mode === 'remove' ? 'Remover' : 'Aceder';

            newConfirmBtn.onclick = async () => {
                const pass = input.value.trim();
                
                // 1. Buscar a passe real no Firebase para comparar
                try {
                    const docSnap = await getDoc(doc(db, 'pastas', itemId));
                    if (docSnap.exists()) {
                        const realPass = docSnap.data().passe;
                        
                        if (pass === realPass) {
                            // Senha Correta
                            if (mode === 'remove') {
                                await updateDoc(doc(db, 'pastas', itemId), {
                                    passe: deleteField(), // Remove o campo
                                    ultimaedicao: serverTimestamp()
                                });
                            }
                            cleanup();
                            resolve(true);
                        } else {
                            // Senha Incorreta
                            errorMsg.style.display = 'block';
                            input.value = '';
                            input.focus();
                            // N√£o resolvemos a promise ainda, damos outra chance
                        }
                    } else {
                        alert("Item n√£o encontrado.");
                        cleanup();
                        resolve(false);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Erro ao verificar senha.");
                    cleanup();
                    resolve(false);
                }
            };
        }

        // Cancelar
        cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
        };
        
        // Enter no input
        input.onkeydown = (e) => {
            if (e.key === 'Enter') newConfirmBtn.click();
            if (e.key === 'Escape') { cleanup(); resolve(false); }
        };
    });
}

// --- FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS ---

function showContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    const menu = document.getElementById('context-menu');
    
    // Encontra o elemento da lista clicado
    const item = e.target.closest('.list-item');
    if (!item) return; // Seguran√ßa extra
    
    activeItemContext = {
        id: item.dataset.id,
        name: item.dataset.name,
        type: item.dataset.type,
        parentId: item.dataset.parentid === 'null' ? null : item.dataset.parentid,
        isProtected: item.hasAttribute('data-protected'),
        // IMPORTANTE: L√™ se o atributo data-superpasta √© "true"
        isSuperfolder: item.dataset.superpasta === "true" 
    };

    // 1. Gerir Bot√µes de Prote√ß√£o (Cadeado)
    const btnProtect = menu.querySelector('[data-action="protect"]');
    const btnUnprotect = menu.querySelector('[data-action="unprotect"]');

    if (activeItemContext.isProtected) {
        btnProtect.style.display = 'none';
        btnUnprotect.style.display = 'block';
    } else {
        btnProtect.style.display = 'block';
        btnUnprotect.style.display = 'none';
    }

    // 2. Gerir Bot√£o de Superpasta (CORRE√á√ÉO AQUI)
    const btnSuper = menu.querySelector('[data-action="toggle-superfolder"]');
    if (btnSuper) {
        if (activeItemContext.type === 'pasta') {
            btnSuper.style.display = 'block';
            
            // AQUI EST√Å A L√ìGICA QUE MUDA O TEXTO
            if (activeItemContext.isSuperfolder) {
                btnSuper.textContent = "Tornar Pasta"; // Se j√° √© super, volta a pasta normal
            } else {
                btnSuper.textContent = "Tornar Superpasta"; // Se √© normal, vira super
            }
            
        } else {
            btnSuper.style.display = 'none';
        }
    }

    menu.style.display = 'block';
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
}

function hideContextMenu() {
    document.getElementById('context-menu').style.display = 'none';
    activeItemContext = null;
}

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

 function showConfirmation(title, message) {
    const modal = document.getElementById('confirm-modal');
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    modal.style.display = 'flex';
    return new Promise(resolve => {
        const confirmBtn = modal.querySelector('[data-action="confirm"]');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');
        const onConfirm = () => { modal.style.display = 'none'; resolve(true); cleanup(); };
        const onCancel = () => { modal.style.display = 'none'; resolve(false); cleanup(); };
        const cleanup = () => {
            confirmBtn.removeEventListener('click', onConfirm);
            cancelBtn.removeEventListener('click', onCancel);
        };
        confirmBtn.addEventListener('click', onConfirm, { once: true });
        cancelBtn.addEventListener('click', onCancel, { once: true });
    });
}

async function updateTagLink(tagName, noteId, shouldExist) {
    const tag = allTags.find(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tag) {
        console.error(`Tag "${tagName}" n√£o encontrada no cache para atualiza√ß√£o.`);
        return;
    }
    const tagRef = doc(db, 'tags', tag.id);
    const updateData = {};
    if (shouldExist) {
        updateData[`notas.${noteId}`] = true;
    } else {
        updateData[`notas.${noteId}`] = deleteField();
    }
    try {
        await updateDoc(tagRef, updateData);
    } catch (error) {
        console.error(`Erro ao atualizar v√≠nculo da tag "${tagName}":`, error);
    }
}

// --- L√ìGICA DE MODAIS E PAIN√âIS ADICIONAIS ---

async function openMoveModal(itemContext) {
    if (!itemContext) {
        console.error("Erro: Contexto do item n√£o fornecido para openMoveModal");
        return;
    }

    const modal = document.getElementById('move-item-modal');
    const list = document.getElementById('move-list');
    list.innerHTML = 'Carregando...';
    modal.style.display = 'flex';
    
    // Agora usamos itemContext.parentId em vez de activeItemContext.parentId
    const q = query(
        collection(db, 'pastas'), 
        where('parentId', '==', itemContext.parentId), // <--- AQUI ESTAVA O ERRO
        where('estado', '==', 'ativa'), 
        where('userId', '==', auth.currentUser.uid), 
        orderBy('ordem')
    );
    
    const snapshot = await getDocs(q);
    let items = [];
    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
    renderMoveList(items);
}

// --- NOVA FUN√á√ÉO PARA GERIR O MODAL "MOVER DE PASTA" ---
 async function openMoveToFolderModal(itemContext) {
    if (!itemContext) return;

    itemToMoveRef = itemContext; // { id, name, parentId, type... }
    const modal = document.getElementById('move-to-folder-modal');
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const nameSpan = document.getElementById('item-to-move-name');
    
    // Atualiza o nome no t√≠tulo
    if(nameSpan) nameSpan.textContent = itemContext.name;

    // --- CONFIGURA√á√ÉO DA BARRA DE NAVEGA√á√ÉO (BREADCRUMBS) ---
    // Verifica se j√° cri√°mos a barra de navega√ß√£o personalizada. Se n√£o, cria agora.
    let navContainer = document.getElementById('move-folder-nav-container');
    
    if (!navContainer) {
        // Remove elementos antigos de descri√ß√£o para limpar a vista
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        // Cria a nova barra igual √† do bot√£o üß¨
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        `;
        
        // Insere antes da lista
        list.parentNode.insertBefore(navContainer, list);
        
        // Listener do bot√£o Voltar
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : rootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(rootId);
            }
        });
    }

    // Reset da navega√ß√£o
    moveStack = []; 
    selectedDestFolderId = null; // Reseta a sele√ß√£o
    
    modal.style.display = 'flex';

    // Determina o in√≠cio (Raiz Global ou Superpasta)
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    // Carrega a lista inicial
    loadMoveFolderList(startRootId);

    // --- RECONFIGURAR BOT√ÉO CONFIRMAR ---
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        // Se nada estiver selecionado (azul), assume que queremos mover para a PASTA ATUAL que estamos a ver
        let targetId = selectedDestFolderId;
        
        // L√≥gica de fallback: Se o user n√£o selecionou uma linha, mas navegou at√© uma pasta,
        // perguntamos se quer mover para a pasta aberta.
        if (targetId === null) {
            // Se estiver na raiz, target √© null (ou superpasta ID). Se estiver numa subpasta, √© o ID dela.
            const currentViewId = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : startRootId;
            
            // Confirma√ß√£o extra se n√£o houver sele√ß√£o visual
            if(!confirm(`Mover "${itemContext.name}" para a pasta que est√° a ver agora?`)) return;
            targetId = currentViewId;
        }

        // Evitar mover para dentro de si pr√≥prio (se for pasta)
        if (targetId === itemContext.id) {
            alert("N√£o pode mover uma pasta para dentro de si mesma.");
            return;
        }

        try {
            const itemRef = doc(db, 'pastas', itemContext.id);
            await updateDoc(itemRef, {
                parentId: targetId, // null se for raiz global
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            // Se tivermos a fun√ß√£o updateNavigationView dispon√≠vel, chamamos
            if (typeof updateNavigationView === 'function') updateNavigationView();
            
        } catch (error) {
            console.error("Erro ao mover:", error);
            alert("Erro ao mover o item.");
        }
    };
}

// ============================================================
// 2. CARREGAR LISTA (VISUAL IGUAL AO üß¨)
// ============================================================
async function loadMoveFolderList(parentId, isLoadMore = false) {
    const list = document.getElementById('folder-selection-list');
    const navContainer = document.getElementById('move-folder-nav-container');
    const backBtn = document.getElementById('move-folder-back-btn');
    const pathLabel = document.getElementById('move-folder-path');
    const LOAD_LIMIT = 15;

    // 1. MOSTRAR A BARRA DE NAVEGA√á√ÉO (Para saber onde estamos)
    if (navContainer) {
        navContainer.style.display = 'flex';
    }

    // Se N√ÉO for "Carregar Mais", √© uma navega√ß√£o nova (limpar tudo)
    if (!isLoadMore) {
        list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
        moveFolderLastDoc = null; // Reset do cursor
        
        // Atualiza o Texto do Topo (Breadcrumbs)
        if (moveStack.length > 0) {
            pathLabel.textContent = moveStack[moveStack.length - 1].name;
            backBtn.style.display = 'block';
        } else {
            pathLabel.textContent = parentId ? "Pasta Atual" : "Raiz (N√≠vel 1)";
            backBtn.style.display = 'none';
        }
    } else {
        const oldBtn = document.getElementById('move-folder-load-more');
        if (oldBtn) oldBtn.remove();
    }

    try {
        // --- QUERY HIER√ÅRQUICA (Filtra por Pasta Pai) ---
        let constraints = [
            collection(db, 'pastas'),
            where('parentId', '==', parentId), // O SEGREDO: S√≥ carrega filhos desta pasta
            where('tipo', '==', 'pasta'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome'),
            limit(LOAD_LIMIT)
        ];

        // Pagina√ß√£o
        if (isLoadMore && moveFolderLastDoc) {
            constraints.push(startAfter(moveFolderLastDoc));
        }

        const q = query(...constraints);
        const snapshot = await getDocs(q);

        // Se for o in√≠cio, limpa e adiciona a op√ß√£o "Ficar Aqui"
        if (!isLoadMore) {
            list.innerHTML = '';

            // --- OP√á√ÉO 1: SELECIONAR A PASTA ATUAL ONDE ESTAMOS ---
            const currentLi = document.createElement('li');
            currentLi.className = 'list-item';
            currentLi.style.fontWeight = 'bold';
            currentLi.style.borderBottom = '2px solid var(--border-color)';
            currentLi.style.color = 'var(--accent-color)';
            currentLi.style.padding = '12px';
            currentLi.style.cursor = 'pointer';
            
            // Texto din√¢mico: Se estamos na raiz diz "Raiz", se n√£o diz o nome da pasta
            const currentName = moveStack.length > 0 ? moveStack[moveStack.length - 1].name : "Raiz Principal";
            currentLi.innerHTML = `üì• Guardar nesta pasta: <u>${currentName}</u>`;
            
            currentLi.onclick = () => {
                handleMoveSelection(currentLi, parentId);
            };
            list.appendChild(currentLi);

            if (snapshot.empty) {
                const emptyLi = document.createElement('li');
                emptyLi.textContent = "Sem subpastas. (Pode guardar aqui)";
                emptyLi.style.padding = "10px";
                emptyLi.style.color = "var(--text-muted-color)";
                list.appendChild(emptyLi);
                return;
            }
        }

        // Atualiza o cursor
        const lastVisible = snapshot.docs[snapshot.docs.length - 1];
        if (lastVisible) {
            moveFolderLastDoc = lastVisible;
        }

        // --- RENDERIZA√á√ÉO DA LISTA ---
     snapshot.forEach(doc => {
            if (itemToMoveRef && doc.id === itemToMoveRef.id) return;

            const folder = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            
            li.className = 'list-item move-folder-item';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.padding = '12px';
            li.style.borderBottom = '1px solid var(--border-color)';
            li.style.cursor = 'pointer';

            // DIVIDIDO EM DUAS √ÅREAS:
            li.innerHTML = `
                <div class="move-select-area" style="flex-grow:1; display:flex; align-items:center;" title="Clique para selecionar esta pasta">
                    <!-- CORRE√á√ÉO AQUI: flex: none !important impede o √≠cone de esticar -->
                    <span style="font-size:1.2em; margin-right:10px; flex: none !important;">üìÅ</span>
                    <span>${folder.nome}</span>
                </div>
                <div class="move-nav-btn" style="padding: 5px 15px; border-left:1px solid var(--border-color); color:var(--text-muted-color); font-weight:bold;" title="Entrar na pasta">
                    ‚ûî
                </div>
            `;

            // ... resto dos listeners de clique (mant√™m-se iguais) ...
            const selectArea = li.querySelector('.move-select-area');
            selectArea.onclick = (e) => {
                e.stopPropagation();
                handleMoveSelection(li, folder.id);
            };

            const navBtn = li.querySelector('.move-nav-btn');
            navBtn.onclick = (e) => {
                e.stopPropagation();
                moveStack.push({ id: folder.id, name: folder.nome });
                loadMoveFolderList(folder.id, false);
            };
            
            navBtn.onmouseover = () => { navBtn.style.color = 'var(--accent-color)'; navBtn.style.backgroundColor = 'var(--hover-color)'; };
            navBtn.onmouseout = () => { navBtn.style.color = 'var(--text-muted-color)'; navBtn.style.backgroundColor = 'transparent'; };

            list.appendChild(li);
        });

        // --- BOT√ÉO CARREGAR MAIS ---
        if (snapshot.docs.length === LOAD_LIMIT) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'move-folder-load-more';
            loadMoreBtn.textContent = "Carregar mais subpastas...";
            loadMoreBtn.style.width = "100%";
            loadMoreBtn.style.padding = "10px";
            loadMoreBtn.style.marginTop = "5px";
            loadMoreBtn.style.background = "none";
            loadMoreBtn.style.border = "1px dashed var(--text-muted-color)";
            loadMoreBtn.style.color = "var(--text-muted-color)";
            loadMoreBtn.style.cursor = "pointer";
            
            loadMoreBtn.onclick = () => {
                loadMoreBtn.textContent = "A carregar...";
                loadMoveFolderList(parentId, true); // Mant√©m o mesmo n√≠vel, carrega mais
            };

            list.appendChild(loadMoreBtn);
        }

    } catch (e) {
        console.error(e);
        if (!isLoadMore) list.innerHTML = '<li>Erro ao carregar pastas.</li>';
    }
}


// --- FUN√á√ÉO AUXILIAR DE SELE√á√ÉO VISUAL ---
function handleMoveSelection(liElement, folderId) {
    // 1. Remove sele√ß√£o de todos
    const list = document.getElementById('folder-selection-list');
    list.querySelectorAll('li').forEach(el => {
        el.style.backgroundColor = 'transparent';
        el.classList.remove('selected');
    });

    // 2. Seleciona o atual
    liElement.classList.add('selected');
    liElement.style.backgroundColor = 'var(--selected-color)'; // Usa a cor do seu tema
    
    // 3. Atualiza vari√°vel de estado
    selectedDestFolderId = folderId;
}

function renderMoveList(items) {
    const list = document.getElementById('move-list');
    list.innerHTML = '';
    items.forEach((item, index) => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.innerHTML = `
            <span>${item.nome}</span>
            <div class="order-controls">
                <button data-action="up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button data-action="down" ${index === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
            </div>
        `;
        list.appendChild(li);
    });
    list.onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const currentLi = btn.closest('li');
        const currentIndex = Array.from(list.children).indexOf(currentLi);
        const action = btn.dataset.action;
        if (action === 'up' && currentIndex > 0) {
            [items[currentIndex], items[currentIndex - 1]] = [items[currentIndex - 1], items[currentIndex]];
        } else if (action === 'down' && currentIndex < items.length - 1) {
            [items[currentIndex], items[currentIndex + 1]] = [items[currentIndex + 1], items[currentIndex]];
        }
        renderMoveList(items);
    };
    document.querySelector('#move-item-modal [data-action="save-order"]').onclick = async () => {
        const batch = writeBatch(db);
        items.forEach((item, index) => {
            const docRef = doc(db, 'pastas', item.id);
            batch.update(docRef, { 
                ordem: index,
                ultimaedicao: serverTimestamp()
            });
        });
        await batch.commit();
        document.getElementById('move-item-modal').style.display = 'none';
    };
}

async function showHiddenItemsModal() {
    const modal = document.getElementById('hidden-items-modal');
    const list = document.getElementById('hidden-items-list');
    list.innerHTML = 'Carregando...';
    modal.style.display = 'flex';
    const q = query(collection(db, 'pastas'), where('estado', '==', 'desativa'), where('userId', '==', auth.currentUser.uid) 
);
    const snapshot = await getDocs(q);
    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li>Nenhum item oculto.</li>';
        return;
    }
    snapshot.forEach(doc => {
        const item = { id: doc.id, ...doc.data() };
        const li = document.createElement('li');
        li.innerHTML = `<span class="item-name">${item.nome}</span> <button data-id="${item.id}">Restaurar</button>`;
        list.appendChild(li);
    });
}

function addUrlField(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'url-field-wrapper';
    const urlInput = document.createElement('input');
    urlInput.type = 'text';
    urlInput.placeholder = 'URL da hiperliga√ß√£o';
    urlInput.value = urlValue;
    urlInput.style.flexGrow = '1';
    urlInput.style.padding = '12px';
    urlInput.style.backgroundColor = 'var(--bg-color)';
    urlInput.style.border = '1px solid var(--border-color)';
    urlInput.style.borderRadius = '5px';
    urlInput.style.color = 'var(--text-color)';
    urlInput.style.fontSize = '16px';
    const removeUrlBtn = document.createElement('button');
    removeUrlBtn.textContent = '‚Äì';
    removeUrlBtn.className = 'modal-btn remove-url-btn'; 
    removeUrlBtn.onclick = () => {
        if (container.childElementCount > 1) {
            fieldWrapper.remove();
        } else {
            alert('√â necess√°rio pelo menos um campo de URL.');
        }
    };
    fieldWrapper.appendChild(urlInput);
    fieldWrapper.appendChild(removeUrlBtn);
    container.appendChild(fieldWrapper);
}

// ============================================================
// L√ìGICA DO PAINEL PUZZLE (4¬™ Coluna)
// ============================================================

// 1. Alternar Abas (Puzzle vs Refer√™ncias)
document.getElementById('ref-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // Atualiza bot√µes
    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Atualiza conte√∫do
    const target = btn.dataset.refTab; // 'puzzle' ou 'references'
    
    document.getElementById('ref-content-puzzle').style.display = 'none';
    document.getElementById('ref-content-references').style.display = 'none';
    
    document.getElementById(`ref-content-${target}`).style.display = 'flex'; // ou block
});


// 3. Fun√ß√£o para Adicionar Item da Lista "Refer√™ncias" para "Escolhidas"
window.addItemToPuzzle = function(noteId, noteName, snippetHTML) {
    const list = document.getElementById('puzzle-chosen-list');
    const emptyMsg = document.getElementById('puzzle-empty-refs');
    if(emptyMsg) emptyMsg.style.display = 'none'; // Apenas esconde, n√£o remove, para ser mais f√°cil

    const li = document.createElement('li');
    
    // --- IMPORTANTE: Guardar dados para a grava√ß√£o ---
    li.dataset.noteId = noteId;
    li.dataset.noteName = noteName;
    // Guardamos o snippet codificado para evitar quebra de HTML
    li.dataset.snippet = encodeURIComponent(snippetHTML); 

    li.innerHTML = `
        <div class="chosen-ref-header">
            <span>üìÑ ${noteName}</span>
            <button class="delete-ref" style="background:none; border:none; color:#e74c3c; cursor:pointer;">√ó</button>
        </div>
        <div class="chosen-ref-snippet">${snippetHTML}</div>
        <button class="go-to-note-btn" 
                data-note-id="${noteId}" 
                title="Ir para nota" 
                style="align-self: flex-start; margin-top:5px; font-size:0.8em; border:1px solid #555;">
            ‚ûî Ver Contexto Original
        </button>
    `;

    li.querySelector('.delete-ref').onclick = () => {
        li.remove();
        // Se ficou vazio, volta a mostrar a mensagem
        if(list.children.length === 1) { // 1 porque o emptyMsg est√° l√° escondido
             if(emptyMsg) emptyMsg.style.display = 'block';
        }
    };
    
    // Feedback visual
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if(puzzleTabBtn) {
        puzzleTabBtn.style.color = "#2ecc71";
        setTimeout(() => puzzleTabBtn.style.color = "", 500);
    }

    list.appendChild(li);
};

// ====================================================================
// L√ìGICA DE TELEPORTE (CONVERTER QUADRO EM NOTA) üì°
// ====================================================================

// 1. Vari√°veis de Estado para o Teleporte
let teleportContentHTML = ""; // Guarda o conte√∫do compilado
let teleportNoteTitle = "";   // Guarda o t√≠tulo limpo

// 2. Listener do Bot√£o üì°
document.getElementById('teleport-puzzle-btn').addEventListener('click', async (e) => {
    e.preventDefault(); e.stopPropagation();

    // --- A. CONFIRMA√á√ÉO COM POPUP PERSONALIZADO ---
    // Usamos a fun√ß√£o 'showConfirmation' que j√° existe no seu c√≥digo
    const confirmed = await showConfirmation(
        "Converter em Nota", 
        "Deseja mesmo gerar uma nota atrav√©s desta refer√™ncia?"
    );

    if (!confirmed) return; // Se clicar em Cancelar, p√°ra aqui.

    // --- B. Preparar T√≠tulo ---
    const panelTitle = document.getElementById('references-panel-title').textContent.trim();
    // Regex para limpar o lixo √† volta
    teleportNoteTitle = panelTitle.replace(/^Refer√™ncias para [üîñ]*["‚Äú](.+)["‚Äù]$/i, '$1');

    // --- C. Compilar Conte√∫do do Quadro ---
    teleportContentHTML = "";
    const cards = document.querySelectorAll('#puzzle-board-container .board-card');

    if (cards.length === 0) {
        alert("O quadro est√° vazio. Adicione algo antes de converter.");
        return;
    }

    cards.forEach(card => {
        // TIPO 1: Texto Edit√°vel
        if (card.classList.contains('type-text')) {
            const textDiv = card.querySelector('.board-text-content');
            if (textDiv) {
                teleportContentHTML += `<p>${textDiv.innerHTML}</p>`; 
            }
        } 
        // TIPO 2: Refer√™ncia
        else if (card.classList.contains('type-ref')) {
            let snippet = decodeURIComponent(card.dataset.snippet || "");
            snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

            if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
                teleportContentHTML += snippet;
            } else {
                teleportContentHTML += `
                    <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                        ${snippet}
                        <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
                    </blockquote>
                `;
            }
        }
        teleportContentHTML += "<p><br></p>";
    });

    // --- D. Abrir o Seletor de Pastas ---
    openTeleportFolderSelector();
});

// 3. Abrir Modal de Sele√ß√£o de Pasta (Reutiliza o estilo do Append/Move)
function openTeleportFolderSelector() {
    const modal = document.getElementById('move-to-folder-modal'); 
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const titleEl = modal.querySelector('h3');
    const descEl = modal.querySelector('p');

    // 1. RESET DE VARI√ÅVEIS CR√çTICO
    selectedDestFolderId = null; // Garante que n√£o usa uma sele√ß√£o antiga
    moveStack = []; 

    // Configurar UI
    titleEl.textContent = "Guardar Nota em...";
    descEl.innerHTML = `A criar nota: <strong>${teleportNoteTitle}</strong>`;
    
    // Configura√ß√£o da Barra de Navega√ß√£o (Breadcrumbs)
    let navContainer = document.getElementById('move-folder-nav-container');
    if (!navContainer) {
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz Global</span>
        `;
        list.parentNode.insertBefore(navContainer, list);
        
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const globalRootId = null; 
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : globalRootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(globalRootId);
            }
        });
    }

    modal.style.display = 'flex';
    
    // Inicia na Raiz Global (null)
    loadMoveFolderList(null);

    // --- SUBSTITUIR A√á√ÉO DO BOT√ÉO CONFIRMAR ---
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = "Gerar Nota";
    
    newConfirmBtn.onclick = async () => {
        // L√≥gica de Destino: Se n√£o selecionou (azul), assume a pasta onde est√° a navegar
        let targetFolderId = selectedDestFolderId;
        if (targetFolderId === null && moveStack.length > 0) {
            targetFolderId = moveStack[moveStack.length - 1].id;
        }
        
        // Se targetFolderId continuar null, √© a Raiz Global.

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A processar...";

        try {
            // =================================================================
            // PASSO C: GERAR CONTE√öDO E ANEXOS
            // =================================================================
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = teleportContentHTML;
            const anexosMap = {}; 
            
            // 1. Processar Links de Texto (Criados via bot√£o Globo üåê)
            const textLinks = tempDiv.querySelectorAll('a.board-link');
            textLinks.forEach((link, index) => {
                const anexoId = `anexo_txt_${Date.now()}_${index}`;
                let urls = {};
                try {
                    const rawUrls = JSON.parse(decodeURIComponent(link.dataset.json));
                    rawUrls.forEach((u, i) => urls[`url_${i}`] = u);
                } catch(e) { if (link.href) urls['url_0'] = link.href; }

                if (Object.keys(urls).length > 0) {
                    anexosMap[anexoId] = { titulo: link.textContent, urls: urls, timestamp: Date.now() };
                    // Transformar em link de nota
                    link.classList.remove('board-link');
                    link.removeAttribute('data-json');
                    link.setAttribute('data-anexo-id', anexoId);
                    link.style.borderBottom = '1px dotted var(--accent-color)';
                    link.style.color = 'inherit';
                    link.style.textDecoration = 'none';
                }
            });

            // 2. Processar Refer√™ncias do Quadro (Cart√µes Verdes) - PARA CRIAR ANEXO
            // Se o cart√£o for uma refer√™ncia a outra nota, criamos um "Anexo" para ela tamb√©m
          const refCards = document.querySelectorAll('#puzzle-board-container .board-card.type-ref');
refCards.forEach((card, index) => {
    let snippet = decodeURIComponent(card.dataset.snippet || "");
    
    // Limpeza b√°sica
    snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

    // VERIFICA√á√ÉO DE CAIXAS ESPECIAIS (CLONAGEM PERFEITA)
    if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
        
        // Se for uma caixa, injetamos o HTML direto (Clone Perfeito)
        // Dica: Podemos gerar um novo ID para evitar duplicados no sistema
        snippet = snippet.replace(/id="[^"]*"/, `id="clone_${Date.now()}_${index}"`);
        
        teleportContentHTML += snippet;
    } 
    // TRATAMENTO ESPECIAL PARA POST-ITS (Para n√£o ficarem sobrepostos)
    else if (snippet.includes('post-it-note')) {
        // 1. For√ßa posi√ß√£o relativa (para entrar no fluxo do texto)
        // 2. Remove coordenadas top/left antigas
        // 3. Mant√©m a cor e o visual
        let safePostIt = snippet.replace(/position:\s*absolute/g, 'position: relative; margin: 15px 0');
        safePostIt = safePostIt.replace(/top:\s*[^;]+;/g, '').replace(/left:\s*[^;]+;/g, '');
        
        // Remove o puxador de arrasto (j√° que na nova nota ser√° texto fixo)
        // (Opcional, mas fica mais limpo)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = safePostIt;
        const dragHandle = tempDiv.querySelector('.post-it-drag-handle');
        if(dragHandle) dragHandle.remove();
        
        teleportContentHTML += tempDiv.innerHTML;
    }
    // TEXTO SIMPLES (Cita√ß√£o padr√£o)
    else {
        teleportContentHTML += `
            <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                ${snippet}
                <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
            </blockquote>
        `;
    }
    
    // Adiciona o anexo l√≥gico (para o clip)
    const noteId = card.dataset.noteId;
    const noteName = card.dataset.noteName;
    if (noteId) {
        const anexoId = `anexo_ref_${Date.now()}_${index}`;
        anexosMap[anexoId] = {
            titulo: `Ref: ${noteName}`,
            urls: { 'url_0': `internal://note/${noteId}` }, 
            timestamp: Date.now()
        };
    }
});

            const finalContentHTML = tempDiv.innerHTML;

            // =================================================================
            // PASSO D: CRIAR NOTA NO FIREBASE
            // =================================================================
            
            // Calcular Ordem Segura (Para evitar NaN)
            let newOrder = 0;
            try {
                const qOrder = query(
                    collection(db, 'pastas'), 
                    where('parentId', '==', targetFolderId), 
                    where('userId', '==', auth.currentUser.uid)
                );
                const snapOrder = await getDocs(qOrder);
                newOrder = snapOrder.size || 0;
            } catch(e) { console.log("Erro ordem, usando 0"); }

            // Criar Documento
            const docRef = await addDoc(collection(db, 'pastas'), {
                nome: teleportNoteTitle,
                parentId: targetFolderId, 
                tipo: 'nota',
                conteudo: finalContentHTML,
                anexos: anexosMap, // Agora inclui links de texto E refer√™ncias
                userId: auth.currentUser.uid,
                estado: 'ativa',
                ordem: Number(newOrder), // For√ßa n√∫mero
                tags: [], 
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            console.log(`Nota criada: ${docRef.id} em ${targetFolderId}`);
            modal.style.display = 'none';
            
            // =================================================================
            // PASSO E: FOR√áAR ATUALIZA√á√ÉO VISUAL (CORRE√á√ÉO DA LISTA)
            // =================================================================
            
            // Se a pasta onde guard√°mos √© a mesma que est√° aberta no painel do meio...
            const currentMiddleFolderId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
            
            if (targetFolderId === currentMiddleFolderId) {
                // ...Recarregamos a lista explicitamente para garantir que aparece
                console.log("A recarregar lista da pasta atual...");
                fetchAndDisplayItems(targetFolderId, middlePanelList, null);
            }

            // Popup de Sucesso
            const shouldOpen = await showConfirmation(
                "Sucesso!", 
                "Nota criada com sucesso.\nDeseja abrir a nota agora?"
            );
            
            if(shouldOpen) {
                displayNote(docRef.id, null);
            }

        } catch (error) {
            console.error("Erro ao criar nota:", error);
            alert("Erro ao gravar. Verifique a consola para detalhes de √≠ndices.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gerar Nota";
        }
    };
}

// ============================================================
// FUN√á√ÉO PARA EXIBIR DETALHES DO T√ìPICO (4¬™ COLUNA)
// ============================================================
async function showTopicReferencesPanel(id, name, description, type) {
    // 1. Gravar antes de mudar de vista
    await forceSaveAndClosePuzzleMode();

    // 2. Configurar UI da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'block';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // For√ßar aba "Refer√™ncias"
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click(); 

    activeReferenceEntity = { id: id, type: type, name: name }; 
    loadPuzzleData(id, type); // Carrega Puzzle em background
    
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `${type === 'topico' ? 'T√≥pico' : 'Subt√≥pico'}: ${name}`;
    document.getElementById('references-panel-description').textContent = description || 'Sem descri√ß√£o.';
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar contextos...</span></div>';

    try {
        // 3. Buscar todas as notas ativas
        const q = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        
        // Mapa para nomes de pastas (breadcrumbs)
        const foldersMap = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            foldersMap[doc.id] = { 
                nome: data.nome, 
                temSenha: (data.passe && data.passe.trim() !== "") 
            };
        });

        const results = [];
        const parser = new DOMParser(); // Ferramenta para ler HTML

        // 4. Filtragem e Extra√ß√£o de Contexto
        snapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            const docId = docSnapshot.id;
            
            // Verifica se a nota tem t√≥picos no √≠ndice
            if (!data.topicosSelecionados) return;

            // --- VERIFICA√á√ÉO 1: O T√ìPICO EXISTE NA NOTA? ---
            let match = false;
            if (type === 'topico') {
                if (data.topicosSelecionados.hasOwnProperty(id)) match = true;
            } else {
                const allSubtopics = Object.values(data.topicosSelecionados).flat();
                if (allSubtopics.map(String).includes(String(id))) match = true;
            }

            if (match) {
                // Seguran√ßa
                let isProtected = (data.passe && data.passe.trim() !== "");
                if (!isProtected && data.parentId && foldersMap[data.parentId]?.temSenha) isProtected = true;
                if (isProtected && !appSettings.searchTopicsInProtected) return;

                // --- VERIFICA√á√ÉO 2: ONDE EST√Å O T√ìPICO? (Contexto) ---
                // Vamos ler o HTML para saber se est√° numa Quest√£o, Subnota ou na Nota Geral
                
                let displayTitle = data.nome; // Padr√£o: Nome da Nota
                let displayIcon = isProtected ? "üîí" : "üìÑ";
                let contextType = "Nota";
                let snippet = "T√≥pico atribu√≠do √† nota geral.";
                let highlightColor = ""; // Cor da borda

                // Parse do HTML da nota
                const docHTML = parser.parseFromString(data.conteudo, 'text/html');
                const wrappers = docHTML.querySelectorAll('.mini-note-wrapper');
                
                let foundInBox = false;

                // Procura em cada caixa da nota
                for (const wrapper of wrappers) {
                    const jsonStr = wrapper.getAttribute('data-topics');
                    if (!jsonStr) continue;

                    // Verifica se o ID (T√≥pico ou Subt√≥pico) est√° dentro do JSON desta caixa
                    // Usamos includes string simples porque √© mais r√°pido e funciona para keys e values
                    if (jsonStr.includes(`"${id}"`)) {
                        
                        foundInBox = true;
                        
                        // Detetar Tipo de Caixa
                        const input = wrapper.querySelector('input'); // T√≠tulo
                        const contentDiv = wrapper.querySelector('.mini-note-content'); // Texto
                        
                        if (wrapper.classList.contains('question-mode')) {
                            // √â UMA QUEST√ÉO
                            displayIcon = "üìó";
                            contextType = "Quest√£o";
                            displayTitle = input ? input.value : "Quest√£o Sem T√≠tulo";
                            snippet = "Encontrado nesta quest√£o.";
                            highlightColor = "#2ecc71"; // Verde
                        } 
                        else if (wrapper.classList.contains('free-mode')) {
                            // √â UM CONTENTOR LIVRE
                            displayIcon = "üìô";
                            contextType = "Contentor";
                            // Tenta pegar a primeira frase do texto
                            const text = contentDiv ? contentDiv.textContent.trim() : "";
                            displayTitle = text.length > 40 ? text.substring(0, 40) + "..." : (text || "Contentor Vazio");
                            snippet = "Encontrado neste contentor de texto.";
                            highlightColor = "#e67e22"; // Laranja
                        } 
                        else {
                            // √â UMA SUBNOTA
                            displayIcon = "üìò";
                            contextType = "SubNota";
                            displayTitle = input ? input.value : "SubNota Sem T√≠tulo";
                            snippet = "Encontrado nesta subnota.";
                            highlightColor = "#3498db"; // Azul
                        }

                        // Se n√£o tiver t√≠tulo na caixa, usa o nome da nota como fallback
                        if (!displayTitle.trim()) displayTitle = `(Em) ${data.nome}`;
                        
                        // P√°ra na primeira caixa que encontrar (para n√£o duplicar na lista)
                        break; 
                    }
                }

                results.push({ 
                    id: docId, 
                    originalName: data.nome, // Nome da nota (para o breadcrumb ou detalhe)
                    displayTitle: displayTitle,
                    displayIcon: displayIcon,
                    contextType: contextType,
                    snippet: snippet,
                    highlightColor: highlightColor,
                    parentId: data.parentId,
                    parentName: data.parentId && foldersMap[data.parentId] ? foldersMap[data.parentId].nome : null
                });
            }
        });

        // 5. Renderizar
        listElement.innerHTML = '';
        if (results.length === 0) {
            listElement.innerHTML = '<li style="padding:15px; color:#888;">Nenhuma refer√™ncia encontrada.</li>';
            return;
        }

        // Ordenar: Agrupa por tipo (Quest√µes primeiro), depois alfab√©tico
        results.sort((a, b) => {
            if (a.contextType !== b.contextType) return a.contextType.localeCompare(b.contextType);
            return a.displayTitle.localeCompare(b.displayTitle);
        });

        results.forEach(item => {
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            // Se tiver cor de destaque (Quest√£o/Subnota), aplica borda lateral
            if (item.highlightColor) {
                details.style.borderLeft = `3px solid ${item.highlightColor}`;
            }

            const summary = document.createElement('summary');
            
            // Bot√£o "Ir para"
            const goToBtn = `<button class="go-to-note-btn" 
                    data-note-id="${item.id}" 
                    data-search-term="${item.displayTitle}" 
                    title="Ir para o local exato">‚ûî</button>`;

            // Visual: √çcone + T√≠tulo Espec√≠fico + (Nome da Nota Pequeno)
            summary.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:500;">${item.displayIcon} ${item.displayTitle}</span>
                        ${goToBtn}
                    </div>
                    ${item.contextType !== 'Nota' ? `<small style="color:var(--text-muted-color); margin-top:2px;">em üìÑ ${item.originalName}</small>` : ''}
                </div>
            `;
            
            // Remove o marcador padr√£o do summary (tri√¢ngulo) para usar o nosso layout flex
            summary.style.listStyle = "none"; 

            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            contextDiv.innerHTML = `<p>${item.snippet}</p>`;

            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao processar refer√™ncias:", error);
        listElement.innerHTML = '<li>Erro ao carregar dados.</li>';
    }
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function openLinkModal(isEditing, data) {
    // 1. CAPTURA ROBUSTA DA SELE√á√ÉO (CR√çTICO)
    // Tentamos garantir que temos o texto selecionado guardado antes de qualquer outra coisa.
    // Isto resolve o problema de perder a sele√ß√£o quando se clica nos inputs do modal.
    let savedRange = null;

    if (!isEditing) {
        if (currentSelectionRange) {
            // Tenta usar a vari√°vel global gerida pelo handleTextSelection
            savedRange = currentSelectionRange.cloneRange();
        } else {
            // Fallback: Tenta obter diretamente do navegador
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && !sel.isCollapsed) {
                savedRange = sel.getRangeAt(0).cloneRange();
            }
        }
    }

    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const addUrlBtn = document.getElementById('add-url-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // Reset UI
    urlsContainer.innerHTML = '';
    
    // Clonar bot√µes para limpar listeners antigos (Evita cliques duplicados)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);

    newAddUrlBtn.onclick = () => addUrlField();

    // --- MODO EDI√á√ÉO ---
    if (isEditing) {
        console.log('[openLinkModal] Modo EDI√á√ÉO para ID:', data.id);
        modalTitle.textContent = "Editar/Remover Anexo";
        newRemoveBtn.style.display = 'block';

        // Preenche os dados atuais
        (async () => {
            try {
                const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
                if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                    const anexoFromDb = noteSnap.data().anexos[data.id];
                    titleInput.value = anexoFromDb.titulo;
                    
                    if (anexoFromDb.urls && Object.keys(anexoFromDb.urls).length > 0) {
                        Object.values(anexoFromDb.urls).forEach(url => addUrlField(url));
                    } else if (anexoFromDb.hiperligacao) {
                         // Suporte legado
                         addUrlField(anexoFromDb.hiperligacao);
                    } else { 
                        addUrlField(); 
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar dados do anexo:", e);
            }
        })();

        // Gravar Edi√ß√£o
        newSaveBtn.onclick = async () => {
            const newTitle = titleInput.value.trim();
            if (!newTitle) return alert("O t√≠tulo √© obrigat√≥rio.");

            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;

            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });

            if (Object.keys(urlsToSave).length === 0) return alert('Preencha pelo menos uma URL.');

            try {
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, {
                    [`anexos.${data.id}.titulo`]: newTitle,
                    [`anexos.${data.id}.urls`]: urlsToSave,
                    [`anexos.${data.id}.hiperligacao`]: deleteField(), // Limpa campo antigo se existir
                    [`anexos.${data.id}.timestamp`]: serverTimestamp()
                });

                // Atualiza o href no editor visualmente
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) linkInEditor.href = firstUrl;

                modal.style.display = 'none';
                saveNote();
            } catch (e) {
                console.error("Erro ao editar anexo:", e);
                alert("Erro ao gravar altera√ß√µes.");
            }
        };

        // Remover Anexo
       newRemoveBtn.onclick = async () => {
            // 1. CORRE√á√ÉO: For√ßar o modal de confirma√ß√£o a ficar acima de tudo
            const confirmModal = document.getElementById('confirm-modal');
            confirmModal.style.zIndex = '2000'; 

            const confirmed = await showConfirmation('Remover Anexo?', `Tem certeza que deseja remover o anexo "${titleInput.value}"?`);
            
            // 2. CORRE√á√ÉO: Restaurar o z-index original para n√£o afetar usos futuros
            confirmModal.style.zIndex = ''; 

            if (!confirmed) return;

            try {
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, {
                    [`anexos.${data.id}`]: deleteField()
                });

                // Remove a tag <a> mas mant√©m o texto
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) {
                    const parent = linkInEditor.parentNode;
                    while (linkInEditor.firstChild) {
                        parent.insertBefore(linkInEditor.firstChild, linkInEditor);
                    }
                    parent.removeChild(linkInEditor);
                    noteContentEditor.normalize();
                }

                modal.style.display = 'none';
                saveNote();
            } catch (e) {
                console.error("Erro ao remover:", e);
                alert("Erro ao remover anexo.");
            }
        };

    } 
    // --- MODO CRIA√á√ÉO (COM A CORRE√á√ÉO DO "GRAVAR") ---
    else {
        modalTitle.textContent = "Criar Anexo";
        titleInput.value = (typeof data === 'string') ? data : ''; 
        newRemoveBtn.style.display = 'none';
        addUrlField();

        // L√≥gica do Bot√£o Gravar (Nova Vers√£o Robusta)
        newSaveBtn.onclick = async () => {
            try {
                // 1. Valida√ß√£o de Dados
                const titleForDb = titleInput.value.trim();
                if (!titleForDb) { alert('T√≠tulo obrigat√≥rio.'); return; }
                
                const urlInputs = urlsContainer.querySelectorAll('input');
                const urlsToSave = {};
                let firstUrl = null;
                
                urlInputs.forEach((input, index) => {
                    let url = input.value.trim();
                    if (url) {
                        if (!url.startsWith('http')) url = 'https://' + url;
                        if (!firstUrl) firstUrl = url;
                        urlsToSave[`url_${Date.now() + index}`] = url;
                    }
                });
                
                if (Object.keys(urlsToSave).length === 0) { alert('Preencha pelo menos uma URL.'); return; }

                // 2. Verifica√ß√µes de Seguran√ßa Cr√≠ticas
                if (!selectedNoteId) throw new Error("ID da nota n√£o encontrado.");
                if (!savedRange) throw new Error("A sele√ß√£o de texto foi perdida. Cancele e tente novamente.");

                // 3. Gravar na Base de Dados (Firebase)
                const anexoId = `anexo_${Date.now()}`;
                const noteRef = doc(db, 'pastas', selectedNoteId);
                
                await updateDoc(noteRef, { 
                    [`anexos.${anexoId}`]: { 
                        titulo: titleForDb, 
                        urls: urlsToSave, 
                        timestamp: serverTimestamp() 
                    } 
                }, { merge: true });

                console.log(`Anexo gravado na DB: ${anexoId}`);

                // 4. Prepara√ß√£o Visual (Preservar Entidades)
                const tempDiv = document.createElement('div');
                tempDiv.appendChild(savedRange.cloneContents()); 

                const anchorsInSelection = Array.from(tempDiv.querySelectorAll('.entity-link'));
                const preservedAnchors = anchorsInSelection.map(span => ({
                    name: span.dataset.entityName,
                    type: span.dataset.entityType
                }));
                
                // 5. Aplicar o Link no Editor
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange); // Restaura a sele√ß√£o guardada
                
                document.execCommand('createLink', false, firstUrl || '#');
                
                // Encontrar o link rec√©m-criado (onde est√° o cursor)
                const createdLink = selection.anchorNode.parentElement.closest('a');

                if (createdLink) {
                    createdLink.dataset.anexoId = anexoId;
                    
                    // Se havia entidades coloridas, restaura-as dentro do link
                    if (preservedAnchors.length > 0) {
                        let reconstructedHTML = createdLink.textContent;
                        
                        preservedAnchors.forEach(anchor => {
                            const anchorHTML = `<span class="entity-link" data-entity-type="${anchor.type}" data-entity-name="${anchor.name}">${anchor.name}</span>`;
                            const replaceRegex = new RegExp(escapeRegExp(anchor.name), 'g');
                            reconstructedHTML = reconstructedHTML.replace(replaceRegex, anchorHTML);
                        });

                        createdLink.innerHTML = reconstructedHTML;
                    }
                }
                
                // 6. Fechar e Gravar Nota
                modal.style.display = 'none';
                saveNote();

            } catch (error) {
                console.error("Erro ao criar link:", error);
                alert("Ocorreu um erro: " + error.message);
            }
        };
    }
    
    modal.style.display = 'flex';
}
// ====================================================================


async function openEntityModal(type, name) {
    // 1. CRUCIAL: Guardar uma c√≥pia local da sele√ß√£o IMEDIATAMENTE
    // Isto garante que, mesmo que clique fora ou escreva no input, sabemos onde inserir.
    if (!currentSelectionRange) {
        alert("Erro: A sele√ß√£o de texto foi perdida.");
        return;
    }
    const savedRange = currentSelectionRange.cloneRange(); 
    // -----------------------------------------------------------

    const modal = document.getElementById('entity-modal');
    const title = document.getElementById('entity-modal-title');
    const nameInput = document.getElementById('entity-name-input');
    const descriptionInput = document.getElementById('entity-description-input');
    const errorMsg = document.getElementById('entity-error-message');
    
    // Formata√ß√£o do nome para exibi√ß√£o
    const singularDisplayName = ENTITY_CONFIG[type]?.displayName.slice(0, -1) || (type.charAt(0).toUpperCase() + type.slice(1));
    title.textContent = `Criar ou Vincular ${singularDisplayName}`;
    
    nameInput.value = name;
    descriptionInput.value = '';
    errorMsg.style.display = 'none';
    modal.style.display = 'flex';
    
    // Foca no input para escreveres logo
    setTimeout(() => nameInput.focus(), 50);

    // Removemos listeners antigos clonando o bot√£o
    const saveBtn = document.getElementById('entity-save-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const entityName = nameInput.value.trim();
        const entityDescription = descriptionInput.value.trim();
        if (!entityName) return;

        const collectionName = ENTITY_CONFIG[type]?.collection;
        if (!collectionName) {
            console.error("Tipo de entidade desconhecido:", type);
            return;
        }

        const collectionRef = collection(db, collectionName);
        
        const q = query(
            collectionRef, 
            where("nome", "==", entityName),
            where("userId", "==", auth.currentUser.uid) 
        );
        
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            // Cria nova
            await addDoc(collectionRef, {
                nome: entityName,
                descricao: entityDescription,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                referencias: { [selectedNoteId]: true }
            });
            console.log(`Nova entidade criada: ${entityName}`);
        } else {
            // Atualiza existente
            const existingDoc = querySnapshot.docs[0];
            const entityRef = doc(db, collectionName, existingDoc.id);
            await updateDoc(entityRef, {
                [`referencias.${selectedNoteId}`]: true 
            });
            console.log(`Entidade vinculada: ${entityName}`);
        }

        // --- L√ìGICA VISUAL CORRIGIDA ---
        try {
            // Restaura a sele√ß√£o usando a COPIA LOCAL (savedRange)
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);

            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = type;
            span.dataset.entityName = entityName;
            span.textContent = entityName; // Usa o nome que escreveste no input
            
            // Envolve o texto selecionado com o span
            savedRange.deleteContents();
            savedRange.insertNode(span);
            
            // Limpa a sele√ß√£o para ficar bonito
            selection.removeAllRanges();
        } catch (e) {
            console.error("Erro ao inserir visualmente:", e);
        }
        
        modal.style.display = 'none';
        saveNote();
        fetchAllEntities(); 
    };
}

  async function openGenericListModal(title, dataPromise) {
    const modal = document.getElementById('generic-list-modal');
    const titleEl = document.getElementById('generic-list-title');
    const contentEl = document.getElementById('generic-list-content');
    
    titleEl.textContent = title;
    contentEl.innerHTML = '<li>Carregando...</li>';
    modal.style.display = 'flex';

    try {
        const items = await dataPromise;
        contentEl.innerHTML = ''; 
        if (!items || items.length === 0) {
            contentEl.innerHTML = '<li>Nenhum item encontrado.</li>';
            return;
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.style.alignItems = 'flex-start';
            
            // <<<<<<< ALTERA√á√ÉO IMPORTANTE >>>>>>>>>
            // Adiciona um data-attribute se o t√≠tulo for uma tag
            if (item.title.startsWith('#')) {
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = item.title.replace('#', '');
                li.style.cursor = 'pointer'; // Muda o cursor para indicar que √© clic√°vel
            }
            
            let contentHTML = '';

            if (Array.isArray(item.content) && item.content.length > 0) {
                const linksHTML = item.content.map((url, index) => {
                    if (!url) return '';
                    return `<div style="display: flex; align-items: baseline; margin-top: 5px; gap: 8px;"><span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span><a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; word-break: break-all;">${url}</a></div>`;
                }).join('');
                contentHTML = `<div style="margin-top: 4px;">${linksHTML}</div>`;
            } 
            else if (typeof item.content === 'string' && item.content) {
                contentHTML = `<small style="color: var(--text-muted-color); margin-top: 4px;">${item.content}</small>`;
            }

            let editButtonHTML = '';
            if (item.type === 'anexo' && item.id) {
                editButtonHTML = `<button data-action="edit-anexo" data-id="${item.id}" title="Editar Anexo" style="background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; margin-left: auto; padding: 5px;">‚úèÔ∏è</button>`;
            }

            li.innerHTML = `<div style="display: flex; flex-direction: column; flex-grow: 1;"><strong style="font-size: 1.1em;">${item.title}</strong>${contentHTML}</div>${editButtonHTML}`;
            contentEl.appendChild(li);
        });

    } catch (error) {
        console.error("Erro ao carregar dados para o modal:", error);
        contentEl.innerHTML = '<li>Ocorreu um erro ao carregar os itens.</li>';
    }
}

 function openAttachmentsModal() {
    if (!selectedNoteId) return;
    
    const fetchData = async () => {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (noteSnap.exists() && noteSnap.data().anexos) {
            const anexosMap = noteSnap.data().anexos;
            // A MUDAN√áA PRINCIPAL: Agora usamos Object.entries para ter acesso √† CHAVE (ID do anexo)
            return Object.entries(anexosMap).map(([anexoId, anexoData]) => {
                const urlsArray = anexoData.urls ? Object.values(anexoData.urls) : (anexoData.hiperligacao ? [anexoData.hiperligacao] : []);
                return { 
                    id: anexoId, // <<<<<<< IMPORTANTE: Passamos o ID do anexo
                    title: anexoData.titulo, 
                    content: urlsArray,
                    type: 'anexo' // <<<<<<< Adicionamos um tipo para identifica√ß√£o
                };
            });
        }
        return [];
    };

    openGenericListModal("Anexos na Nota", fetchData());
}

 




// --- FUN√á√ÉO UNIFICADA: EXPLORADOR (TAGS + ENTIDADES) ---
async function openExplorerModal() {
    const modal = document.getElementById('anchors-modal');
    const tabsContainer = document.getElementById('anchors-tabs-container');
    const contentContainer = document.getElementById('anchors-content-container');
    
    modal.style.display = 'flex';
    const modalTitle = modal.querySelector('h3');
    if(modalTitle) modalTitle.textContent = "Explorador Global";

    tabsContainer.innerHTML = ''; 
    contentContainer.innerHTML = '';

    // ============================================================
    // 1. ABA DE PESQUISA (PADR√ÉO)
    // ============================================================
    const searchTabBtn = document.createElement('button');
    searchTabBtn.dataset.tab = 'search';
    searchTabBtn.textContent = 'üîç Pesquisa';
    searchTabBtn.classList.add('active'); // Ativa por defeito
    tabsContainer.appendChild(searchTabBtn);

    const searchContent = document.createElement('div');
    searchContent.id = 'tab-search';
    searchContent.className = 'tab-content active';
    searchContent.innerHTML = `
        <div class="search-container">
            <input type="text" id="global-search-input" class="global-search-input" placeholder="Pesquisar em notas, pastas, post-its, ideias..." autofocus>
            <div id="global-search-results">
                <p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">Escreva para come√ßar a pesquisar...</p>
            </div>
        </div>
    `;
    contentContainer.appendChild(searchContent);

    // L√≥gica de Pesquisa
    const searchInput = searchContent.querySelector('#global-search-input');
    const resultsContainer = searchContent.querySelector('#global-search-results');

    // Fun√ß√£o de debounce para n√£o bloquear enquanto escreve
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        const queryTerm = e.target.value.trim().toLowerCase();
        clearTimeout(searchTimeout);
        
        if (queryTerm.length < 2) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">Escreva pelo menos 2 caracteres...</p>';
            return;
        }

        searchTimeout = setTimeout(() => executeGlobalSearch(queryTerm, resultsContainer), 600);
    });
    
    // Focar no input automaticamente
    setTimeout(() => searchInput.focus(), 100);

    // ============================================================
    // 2. ABA DE TAGS (Carregamento em background)
    // ============================================================
    const tagsTabBtn = document.createElement('button');
    tagsTabBtn.dataset.tab = 'tags';
    tagsTabBtn.textContent = '# Tags';
    tabsContainer.appendChild(tagsTabBtn);

    const tagsContent = document.createElement('div');
    tagsContent.id = 'tab-tags';
    tagsContent.className = 'tab-content';
    tagsContent.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar tags...</span></div>';
    contentContainer.appendChild(tagsContent);

    // Carrega tags (c√≥digo original mantido mas encapsulado)
    loadTagsForExplorer(tagsContent);

    // ============================================================
    // 3. ABAS DE ENTIDADES (Carregamento em background)
    // ============================================================
    // Carrega primeiro as entidades para poder criar as abas
    await fetchAllEntities();
    
    const onPageEntityNames = new Set(
        Array.from(noteContentEditor.querySelectorAll('.entity-link'))
             .map(link => link.dataset.entityName)
    );

    for (const type in ENTITY_CONFIG) {
        if (allEntities[type] && allEntities[type].length > 0) {
            const config = ENTITY_CONFIG[type];
            const tabButton = document.createElement('button');
            tabButton.dataset.tab = type;
            tabButton.textContent = config.displayName;
            tabsContainer.appendChild(tabButton);

            const tabContent = document.createElement('div');
            tabContent.id = `tab-${type}`;
            tabContent.className = 'tab-content';
            renderEntityTab(tabContent, type, onPageEntityNames);
            contentContainer.appendChild(tabContent);
        }
    }
}

// --- FUN√á√ÉO DE PESQUISA REAL ---
async function executeGlobalSearch(term, container) {
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A pesquisar...</span></div>';
    
    // 1. Dete√ß√£o de Pesquisa Exata (Aspas)
    let isExactMatch = false;
    let cleanTerm = term;

    if (term.length > 2 && term.startsWith('"') && term.endsWith('"')) {
        isExactMatch = true;
        cleanTerm = term.slice(1, -1);
    }

    const normalizedTerm = removeAccents(cleanTerm);

    const checkMatch = (text) => {
        if (!text) return false;
        const normText = removeAccents(text);
        
        if (isExactMatch) {
            const regex = new RegExp(`\\b${escapeRegExp(normalizedTerm)}\\b`, 'i');
            return regex.test(normText);
        } else {
            return normText.includes(normalizedTerm);
        }
    };

    try {
        const q = query(
            collection(db, 'pastas'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        
        const snapshot = await getDocs(q);
        
        const foundFolders = [];
        const foundNotes = [];

        const folderMap = {};
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.tipo === 'pasta') {
                folderMap[doc.id] = { id: doc.id, nome: d.nome, parentId: d.parentId, passe: d.passe };
            }
        });

        snapshot.forEach(doc => {
            const data = doc.data();
            const id = doc.id;
            
            const isProtected = (data.passe && data.passe.trim() !== "");
            const isLocked = isProtected && !sessionUnlockedFolders.has(id);
            
            if (isLocked && !appSettings.searchTagsInProtected) return; 
            const allowContentSearch = !isLocked;

            // --- A. PASTAS ---
            if (data.tipo === 'pasta') {
                if (checkMatch(data.nome)) {
                    const displayName = isLocked ? `üîí ${data.nome}` : data.nome;
                    foundFolders.push({ 
                        id, 
                        name: displayName, 
                        parentId: data.parentId, 
                        type: 'pasta' 
                    });
                }
            }

            // --- B. NOTAS ---
            else if (data.tipo === 'nota') {
                let matched = false;
                let context = '';
                let matchType = 'nota'; 

                // 1. Verifica T√≠tulo
                if (checkMatch(data.nome)) {
                    matched = true;
                    // Se encontrou no t√≠tulo, n√£o precisamos de procurar no corpo para "encontrar",
                    // MAS se quisermos mostrar o contexto do corpo, podemos continuar.
                    // Para performance, assumimos que t√≠tulo basta, a menos que queira procurar Toggles especificamente.
                }

                // 2. Verifica Conte√∫do (Se n√£o encontrou no t√≠tulo OU para enriquecer contexto)
                // CORRE√á√ÉO: Inicializamos docHTML apenas se formos analisar conte√∫do
                if (allowContentSearch && data.conteudo) {
                    // S√≥ fazemos parse se ainda n√£o encontr√°mos (para poupar CPU) 
                    // OU se quisermos for√ßar a procura de tipos espec√≠ficos como Toggles
                    
                    if (!matched) {
                        const parser = new DOMParser();
                        const docHTML = parser.parseFromString(data.conteudo, 'text/html');
                        
                        // a) Post-its
                        const postits = docHTML.querySelectorAll('.post-it-content');
                        for (const p of postits) {
                            if (checkMatch(p.textContent)) { matched = true; matchType = 'postit'; context = generateSearchContext(p.textContent, cleanTerm, isExactMatch); break; }
                        }
                        // b) Quest√µes
                        if (!matched) {
                            const questions = docHTML.querySelectorAll('.mini-note-wrapper.question-mode input, .mini-note-wrapper.question-mode .mini-note-content');
                            for (const q of questions) {
                                const txt = q.tagName==='INPUT'?q.value:q.textContent;
                                if (checkMatch(txt)) { matched = true; matchType = 'question'; context = generateSearchContext(txt, cleanTerm, isExactMatch); break; }
                            }
                        }
                        // c) Subnotas
                        if (!matched) {
                            const minis = docHTML.querySelectorAll('.mini-note-wrapper:not(.question-mode):not(.free-mode) input, .mini-note-wrapper:not(.question-mode):not(.free-mode) .mini-note-content');
                            for (const m of minis) {
                                const txt = m.tagName==='INPUT'?m.value:m.textContent;
                                if (checkMatch(txt)) { matched = true; matchType = 'subnota'; context = generateSearchContext(txt, cleanTerm, isExactMatch); break; }
                            }
                        }
                        // d) Contentores Livres
                        if (!matched) {
                            const frees = docHTML.querySelectorAll('.mini-note-wrapper.free-mode .mini-note-content');
                            for (const f of frees) {
                                if (checkMatch(f.textContent)) { matched = true; matchType = 'free'; context = generateSearchContext(f.textContent, cleanTerm, isExactMatch); break; }
                            }
                        }
                        // f) T√≠tulos Toggle (A PARTE QUE DEU ERRO AGORA EST√Å SEGURA)
                        if (!matched) {
                            const summaries = docHTML.querySelectorAll('summary h2');
                            for (const h2 of summaries) {
                                if (checkMatch(h2.textContent)) {
                                    matched = true;
                                    matchType = 'toggle';
                                    context = generateSearchContext(h2.textContent, cleanTerm, isExactMatch);
                                    break;
                                }
                            }
                        }
                        // e) Body Geral (√öltimo recurso)
                        if (!matched) {
                            const bodyText = docHTML.body.textContent || "";
                            if (checkMatch(bodyText)) { matched = true; context = generateSearchContext(bodyText, cleanTerm, isExactMatch); }
                        }
                    }
                } 

                if (matched) {
                    const finalName = isLocked ? `üîí ${data.nome}` : data.nome;
                    const finalContext = isLocked ? "<em>Conte√∫do protegido.</em>" : context;

                    foundNotes.push({ 
                        id, 
                        name: finalName, 
                        parentId: data.parentId,
                        context: finalContext,
                        matchType: matchType,
                        type: 'nota',
                        rawSearchTerm: cleanTerm 
                    });
                }
            }
        });

        globalExplorerResults = [...foundFolders, ...foundNotes];
        currentExplorerPage = 0;
        renderExplorerResultsPage(container, term, folderMap, true);

    } catch (error) {
        console.error("Erro na pesquisa:", error);
        container.innerHTML = '<p style="color: #e74c3c; text-align: center;">Erro ao realizar pesquisa.</p>';
    }
}


// --- GERAR CONTEXTO (TEXTO AO REDOR) ---
function generateSearchContext(fullText, term, isExact) {
    const normalizedText = removeAccents(fullText);
    const normalizedTerm = removeAccents(term);
    
    let index = -1;

    if (isExact) {
        // Usa Regex para encontrar a posi√ß√£o da palavra inteira
        const regex = new RegExp(`\\b${escapeRegExp(normalizedTerm)}\\b`, 'i');
        const match = normalizedText.match(regex);
        index = match ? match.index : -1;
    } else {
        index = normalizedText.indexOf(normalizedTerm);
    }

    if (index === -1) return "";

    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + term.length + 40);
    
    let snippet = fullText.substring(start, end);
    
    if (start > 0) snippet = "..." + snippet;
    if (end < fullText.length) snippet = snippet + "...";

    // Passamos o isExact para o highlightMatch tamb√©m
    return highlightMatch(snippet, term, isExact);
}


// --- RENDERIZAR RESULTADOS ---
function renderExplorerResultsPage(container, term, folderMap, reset = false) {
    // Se for reset, limpa o contentor
    if (reset) {
        container.innerHTML = '';
    }

    if (globalExplorerResults.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color);">Nenhum resultado encontrado.</p>';
        return;
    }

    // Calcular Pagina√ß√£o
    const start = currentExplorerPage * EXPLORER_RESULTS_PER_PAGE;
    const end = start + EXPLORER_RESULTS_PER_PAGE;
    const pageResults = globalExplorerResults.slice(start, end);

    // Remove bot√£o antigo se existir
    const oldBtn = document.getElementById('explorer-load-more-btn');
    if (oldBtn) oldBtn.remove();

    // Renderizar Itens
    pageResults.forEach(item => {
        const divItem = document.createElement('div');
        divItem.className = 'search-result-item';

        // --- A. RENDERIZAR PASTA ---
        if (item.type === 'pasta') {
            divItem.innerHTML = `
                <span class="search-result-title">üìÅ ${highlightMatch(item.name, term)} <span class="search-badge badge-pasta">Pasta</span></span>
            `;
            
            divItem.onclick = () => {
                document.getElementById('anchors-modal').style.display = 'none';
                
                if (currentTab !== 'note') {
                    currentTab = 'note';
                    updateTabsUI();
                }

                // Navega√ß√£o Inteligente Manual (Breadcrumbs) para Pastas
                navigationStack = []; 
                let curr = item.parentId;
                const path = [];
                // Nota: O folderMap aqui cont√©m apenas o snapshot da pesquisa, pode estar incompleto para subir tudo.
                // Mas serve para contexto visual local.
                while(curr && folderMap[curr]) {
                    path.unshift({ id: folderMap[curr].id, name: folderMap[curr].nome });
                    curr = folderMap[curr].parentId;
                }
                path.forEach(p => navigationStack.push(p));
                navigationStack.push({ id: item.id, name: item.name.replace('üîí ', '') });
                
                updateNavigationView(true);
            };
        } 
        
        // --- B. RENDERIZAR NOTA (ATUALIZADO) ---
        else if (item.type === 'nota') {
            
            // CORES E BADGES (Visual)
            let badgeText = "Nota";
            let badgeStyle = "background-color: rgba(128, 128, 128, 0.2); color: #95a5a6; border: 1px solid #95a5a6;";
            let borderLeftColor = "#95a5a6";

            if (item.matchType === 'subnota') {
                badgeText = "SubNota"; badgeStyle = "background-color: rgba(52, 152, 219, 0.2); color: #3498db; border: 1px solid #3498db;"; borderLeftColor = "#3498db";
            } 
            else if (item.matchType === 'question') {
                badgeText = "Quest√£o"; badgeStyle = "background-color: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71;"; borderLeftColor = "#2ecc71";
            }
            else if (item.matchType === 'free') {
                badgeText = "Contentor"; badgeStyle = "background-color: rgba(230, 126, 34, 0.2); color: #e67e22; border: 1px solid #e67e22;"; borderLeftColor = "#e67e22";
            }
            else if (item.matchType === 'postit') {
                badgeText = "Post-it"; badgeStyle = "background-color: rgba(121, 85, 72, 0.2); color: #a1887f; border: 1px solid #a1887f;"; borderLeftColor = "#a1887f";
            }
            else if (item.matchType === 'toggle') {
                badgeText = "T√≠tulo Toggle"; badgeStyle = "background-color: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c;"; borderLeftColor = "#e74c3c";
            }

            divItem.style.borderLeft = `4px solid ${borderLeftColor}`;
            divItem.style.paddingLeft = "12px";

            divItem.innerHTML = `
                <span class="search-result-title">
                    üìÑ ${highlightMatch(item.name, term)} 
                    <span class="search-badge" style="${badgeStyle} font-size:0.75em; padding:2px 6px; border-radius:4px; margin-left:8px; text-transform:uppercase; font-weight:bold;">
                        ${badgeText}
                    </span>
                </span>
                ${item.context ? `<div class="search-match-context">${item.context}</div>` : ''}
            `;
            
            // A√á√ÉO DE CLIQUE INTELIGENTE
           divItem.onclick = () => {
        document.getElementById('anchors-modal').style.display = 'none';
        
        // Garante que estamos na aba Note
        if (currentTab !== 'note') {
            currentTab = 'note';
            updateTabsUI();
        }

        // USA A NAVEGA√á√ÉO INTELIGENTE
        navigateWithUnsavedCheck(() => {
            navigateToNoteSmart(item.id, item.rawSearchTerm);
        });
    };
}
        container.appendChild(divItem);
    });

    // Adicionar Bot√£o "Carregar Mais"
    if (end < globalExplorerResults.length) {
        const remaining = globalExplorerResults.length - end;
        
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'explorer-load-more-btn';
        loadMoreBtn.textContent = `Carregar mais (${remaining} restantes)`;
        
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.style.width = '100%';
        loadMoreBtn.style.padding = '12px';
        loadMoreBtn.style.margin = '10px 0';
        loadMoreBtn.style.background = 'var(--panel-color)';
        loadMoreBtn.style.border = '1px solid var(--border-color)';
        loadMoreBtn.style.color = 'var(--accent-color)';
        loadMoreBtn.style.borderRadius = '5px';
        loadMoreBtn.style.cursor = 'pointer';
        loadMoreBtn.style.fontWeight = 'bold';
        
        loadMoreBtn.onclick = () => {
            currentExplorerPage++;
            renderExplorerResultsPage(container, term, folderMap, false);
        };
        container.appendChild(loadMoreBtn);
    }
}



// Fun√ß√£o auxiliar para atualizar as abas visualmente (se ainda n√£o existir)
function updateTabsUI() {
    document.querySelectorAll('.tabs-container button').forEach(btn => {
        if (btn.dataset.tab === 'note') btn.classList.add('active');
        else btn.classList.remove('active');
    });
}

// Auxiliar para destacar t√≠tulo
function highlightMatch(text, term, isExact) {
    let regex;
    
    if (isExact) {
        // Usa a fun√ß√£o de regex insens√≠vel a acentos, mas adiciona \b √† volta
        // 1. Escapa o termo
        const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // 2. Cria a string de regex complexa (a|√°|√†...)
        let regexStr = safeTerm
            .replace(/a/gi, '[a√†√°√¢√£√§√•]')
            .replace(/e/gi, '[e√®√©√™√´]')
            .replace(/i/gi, '[i√¨√≠√Æ√Ø]')
            .replace(/o/gi, '[o√≤√≥√¥√µ√∂]')
            .replace(/u/gi, '[u√π√∫√ª√º]')
            .replace(/c/gi, '[c√ß]')
            .replace(/n/gi, '[n√±]');
            
        // 3. Adiciona barreiras de palavra
        regex = new RegExp(`(\\b${regexStr}\\b)`, 'gi');
    } else {
        // Usa a fun√ß√£o antiga (getAccentInsensitiveRegex)
        regex = getAccentInsensitiveRegex(term);
    }

    return text.replace(regex, "<mark>$1</mark>");
}

// --- FUN√á√ïES AUXILIARES DE CARREGAMENTO (Refatoradas para limpar o c√≥digo principal) ---
async function loadTagsForExplorer(container) {
    try {
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const activeTagsSet = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach(t => activeTagsSet.add(t));
            }
        });
        const tagsArray = Array.from(activeTagsSet).sort((a, b) => a.localeCompare(b));

        container.innerHTML = ''; 
        if (tagsArray.length === 0) {
            container.innerHTML = '<p style="padding:15px; color:#888;">Nenhuma tag encontrada.</p>';
        } else {
            const ul = document.createElement('ul');
            tagsArray.forEach(tagName => {
                const li = document.createElement('li');
                li.textContent = `#${tagName}`;
                li.style.cursor = 'pointer';
                li.style.color = 'var(--accent-color)';
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = tagName;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }
    } catch (e) {
        container.innerHTML = '<p style="color:red;">Erro ao carregar tags.</p>';
    }
}

function renderEntityTab(container, type, onPageNames) {
    const sortedEntities = [...allEntities[type]].sort((a, b) => a.nome.localeCompare(b.nome));
    
    // (Pode reinserir aqui a l√≥gica de separa√ß√£o "Nesta Nota" vs "Banco de Dados" se desejar,
    //  o c√≥digo √© id√™ntico ao que tinha antes na fun√ß√£o gigante)
    
    const ul = document.createElement('ul');
    if (sortedEntities.length === 0) {
        container.innerHTML = '<p style="padding:15px; color:#888;">Sem registos.</p>';
        return;
    }

    sortedEntities.forEach(entity => {
        const li = document.createElement('li');
        li.textContent = entity.nome;
        li.dataset.entityId = entity.id;
        li.dataset.entityName = entity.nome;
        li.dataset.entityType = entity.tipo;
        li.dataset.action = 'show-entity-references';
        
        if (onPageNames.has(entity.nome)) li.classList.add('is-on-page');

        const editBtn = document.createElement('button');
        editBtn.className = 'entity-edit-btn';
        editBtn.innerHTML = '‚Ä¶';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditEntityModal(entity.id, entity.tipo); };
        
        li.appendChild(editBtn);
        ul.appendChild(li);
    });
    container.appendChild(ul);
}



async function openEditEntityModal(entityId, entityType) {
    const modal = document.getElementById('edit-entity-modal');
    const title = document.getElementById('edit-entity-title');
    const nameInput = document.getElementById('edit-entity-name-input');
    const descriptionInput = document.getElementById('edit-entity-description-input');
    const saveBtn = document.getElementById('edit-entity-save-btn');

    modal.style.display = 'flex';
    nameInput.value = 'A carregar...';
    descriptionInput.value = 'A carregar...';
    
    const collectionName = ENTITY_CONFIG[entityType]?.collection;
    if (!collectionName) {
        alert('Erro: Tipo de entidade desconhecido.');
        return;
    }

    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (!entitySnap.exists()) {
            alert('Erro: Entidade n√£o encontrada na base de dados.');
            modal.style.display = 'none';
            return;
        }

        const entityData = entitySnap.data();
        title.textContent = `Editar "${entityData.nome}"`;
        nameInput.value = entityData.nome;
        descriptionInput.value = entityData.descricao || '';

        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDescription = descriptionInput.value.trim();

            if (!newName) {
                alert('O nome n√£o pode estar vazio.');
                return;
            }

            await updateDoc(entityRef, {
                nome: newName,
                descricao: newDescription
            });

            modal.style.display = 'none';
            await fetchAllEntities();
            
            const liToUpdate = document.querySelector(`#anchors-content-container li[data-entity-id="${entityId}"] span`);
            if (liToUpdate) {
                liToUpdate.textContent = newName;
            }
        };

    } catch (error) {
        console.error("Erro ao abrir o modal de edi√ß√£o:", error);
        alert('Ocorreu um erro ao carregar os dados da entidade.');
        modal.style.display = 'none';
    }
}


// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function appendLinkInfoToPanel(anexoId) {
    console.groupCollapsed('%c[Painel de Refer√™ncias]', 'color: white; background-color: #8e44ad; padding: 2px 5px; border-radius: 3px;');
    console.log(`A procurar informa√ß√£o para o anexo com ID: ${anexoId}`);

    if (!selectedNoteId) {
        console.error('ID da nota n√£o encontrado. A abortar.');
        console.groupEnd();
        return;
    }

    const noteRef = doc(db, 'pastas', selectedNoteId);
    const noteSnap = await getDoc(noteRef);
    
    if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[anexoId]) {
        const anexo = noteSnap.data().anexos[anexoId];
        console.log('Anexo encontrado na base de dados:', anexo);
        const list = document.getElementById('references-list');

        const details = document.createElement('details');
        details.className = 'reference-item link-info';
        details.open = true;

        const summary = document.createElement('summary');
        summary.innerHTML = `üîó Anexo: ${anexo.titulo}`;
        
        const contextDiv = document.createElement('div');
        contextDiv.className = 'reference-context';
        
        const urls = anexo.urls ? Object.values(anexo.urls) : [anexo.hiperligacao];
        urls.forEach(url => {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.textContent = url;
                link.target = '_blank';
                link.style.display = 'block';
                link.style.marginBottom = '5px';
                contextDiv.appendChild(link);
            }
        });

        details.appendChild(summary);
        details.appendChild(contextDiv);
        
        const separator = document.createElement('hr');
        separator.style.borderColor = 'var(--border-color)';
        separator.style.margin = '15px 0';
        
        list.appendChild(separator);
        list.appendChild(details);
        console.log('%cSUCESSO: Informa√ß√£o do anexo adicionada ao painel.', 'color: #2ecc71;');
    } else {
        console.error(`Anexo com ID "${anexoId}" n√£o foi encontrado nos dados da nota.`);
    }
    console.groupEnd();
}
// ====================================================================


// --- LISTENERS DOS BOT√ïES DO CABE√áALHO ---
document.getElementById('add-text-btn').addEventListener('click', () => createBoardItem('text'));
document.getElementById('add-ref-btn').addEventListener('click', () => openReferenceSelectionPopup());

// Fun√ß√£o Unificada para Criar Cart√µes no Quadro
function createBoardItem(type, data = {}) {
    const container = document.getElementById('puzzle-board-container');
    const emptyMsg = document.getElementById('puzzle-empty-msg');
    if(emptyMsg) emptyMsg.style.display = 'none';

    const card = document.createElement('div');
    card.className = `board-card type-${type}`;
    
    // Verifica se estamos em modo de edi√ß√£o
    const puzzleContainer = document.getElementById('ref-content-puzzle');
    const isEditMode = puzzleContainer && puzzleContainer.classList.contains('edit-mode-active');
    let innerHTML = '';

    // --- TIPO 1: TEXTO (Criado no Quadro) ---
    if (type === 'text') {
        const contentHtml = data.content || ''; 
        const initialStyle = isEditMode 
            ? "width:100%; min-height:40px; outline:none; white-space: pre-wrap; word-break: break-word; color:var(--text-color); border:1px solid var(--border-color); padding:8px; border-radius:4px; background-color:var(--bg-color);" 
            : "width:100%; min-height:40px; outline:none; white-space: pre-wrap; word-break: break-word; color:var(--text-color); border:none; padding:0; background:transparent;";

        innerHTML = `<div class="board-text-content" style="${initialStyle}" ${isEditMode ? 'contenteditable="true"' : 'contenteditable="false"'}>${contentHtml}</div>`;
    } 
    
    // --- TIPO 2: REFER√äNCIA (Importado) ---
    else if (type === 'ref') {
        card.dataset.noteId = data.noteId;
        card.dataset.parentId = data.parentId || '';
        card.dataset.noteName = data.noteName || "Nota";
        
        let rawSnippet = data.snippet || '';
        try { 
            if (rawSnippet.includes('%3C')) rawSnippet = decodeURIComponent(rawSnippet); 
        } catch(e){}
        card.dataset.snippet = encodeURIComponent(rawSnippet);

        let displayHtml = "";
        let headerHtml = ""; 
        let footerHtml = "";
        let isComplexHTML = rawSnippet.includes('mini-note-wrapper') || rawSnippet.includes('toggle-section');

        // --- PREPARA√á√ÉO DO TERMO DE PESQUISA (HIGHLIGHT) ---
        // O activeReferenceEntity pode n√£o existir no momento da renderiza√ß√£o, 
        // ent√£o passamos o t√≠tulo da caixa explicitamente.
        let searchHighlightTerm = ""; 

        if (data.isClone || isComplexHTML) {
            // MODO CAIXA LIMPA (Clone Perfeito)
            let icon = "üì¶";
            let label = "Clone";
            let color = "#555";
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rawSnippet;

            // Extrair Corpo
            const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content');
            let fullText = contentDiv ? contentDiv.innerText.replace(/\s+/g, ' ').trim() : "";
            let bodyText = fullText;

            // Corta texto longo
            if (bodyText.length > 150) bodyText = bodyText.substring(0, 150) + "...";

            // Extrair T√≠tulo
            const inp = tempDiv.querySelector('input');
            const h2 = tempDiv.querySelector('h2');
            let titleText = "";

            if (rawSnippet.includes('question-mode')) { 
                icon = "üìó"; label = "Quest√£o"; color = "#2ecc71"; 
                titleText = inp ? inp.value : "";
            }
            else if (rawSnippet.includes('free-mode')) { 
                icon = "üìô"; label = "Contentor"; color = "#e67e22"; 
                if (fullText) {
                    const firstSentence = fullText.split(/[.!?]/)[0];
                    titleText = firstSentence.length > 50 ? firstSentence.substring(0, 50) + "..." : firstSentence;
                } else { titleText = "Contentor Vazio"; }
            }
            else if (rawSnippet.includes('toggle-section')) { 
                icon = "‚òÇ"; label = "Sec√ß√£o"; color = "#9b59b6"; 
                titleText = h2 ? h2.textContent : "";
            }
            else if (rawSnippet.includes('mini-note-wrapper')) { 
                icon = "üìò"; label = "SubNota"; color = "#3498db"; 
                titleText = inp ? inp.value : "";
            }

            if (!titleText) titleText = "Sem T√≠tulo";
            
            // Define o termo a pesquisar ao clicar (o t√≠tulo da caixa)
            searchHighlightTerm = titleText;

            // --- HTML DO CLICK ---
            // Usamos encodeURIComponent para evitar bugs com aspas
            let textHtml = `
                <div style="font-weight:bold; font-size:0.95em; margin-bottom:2px; cursor:pointer; color:var(--text-color); line-height:1.2;" 
                     title="Ir para a nota: ${data.noteName}"
                     onclick="openNoteFromBoard('${data.noteId}', '${encodeURIComponent(searchHighlightTerm)}')"
                     onmouseover="this.style.textDecoration='underline'" 
                     onmouseout="this.style.textDecoration='none'">
                    ${titleText}
                </div>
                <div style="font-size:0.9em; color:var(--text-muted-color); line-height:1.3;">
                    ${bodyText}
                </div>`;

            displayHtml = `
                <div style="border-left: 3px solid ${color}; padding-left: 10px; margin: 0; display:flex; flex-direction:column;">
                    <div style="font-size:0.7em; font-weight:bold; color:${color}; text-transform:uppercase; margin-bottom:4px; display:flex; align-items:center; gap:5px;">
                        <span style="font-size:1.1em;">${icon}</span> ${label}
                    </div>
                    ${textHtml}
                </div>
            `;

        } else {
            // MODO TEXTO NORMAL
            // Se for refer√™ncia normal, usamos o nome da entidade atual (se houver) ou vazio
            searchHighlightTerm = (typeof activeReferenceEntity !== 'undefined' && activeReferenceEntity) ? activeReferenceEntity.name : "";

            headerHtml = `
                <div class="ref-card-title" 
                     onclick="openNoteFromBoard('${data.noteId}', '${encodeURIComponent(searchHighlightTerm)}')" 
                     style="cursor: pointer; font-size:0.85em; opacity:0.8; display:flex; align-items:center; gap:5px; margin-bottom: 4px;">
                     üìÑ ${data.noteName}
                </div>`;
                
            displayHtml = `<div class="ref-card-snippet" style="border-left: 2px solid var(--accent-color); padding-left:10px; margin: 0; font-style:italic; font-size:0.9em; color:var(--text-muted-color);">${rawSnippet}</div>`;
            
            // Bot√£o Footer (Tamb√©m atualizado para usar a fun√ß√£o global)
            footerHtml = `
                <button onclick="openNoteFromBoard('${data.noteId}', '${encodeURIComponent(searchHighlightTerm)}')"
                        title="Ir para nota original" 
                        style="margin-top:8px; border:1px solid var(--border-color); width: 100%; font-size:0.8em; padding:4px; border-radius:4px; cursor:pointer; background:none; color:var(--text-muted-color);">
                    ‚ûî Ver Original
                </button>`;
        }

        innerHTML = `
            <div class="ref-card-content">
                ${headerHtml}
                ${displayHtml}
                ${footerHtml}
            </div>
        `;
    }

    // Adiciona controlos (Lixo, Setas)
    innerHTML += `
        <div class="card-controls"> 
            ${type === 'text' ? '<button class="add-board-link" title="Gerir Links" style="margin-right: auto;">üåê</button>' : ''}
            <button class="move-up" title="Mover para Cima">üî∫</button>
            <button class="move-down" title="Mover para Baixo">üîª</button>
            <button class="delete" title="Remover" style="color:#e74c3c; border-color:#e74c3c;">üóëÔ∏è</button>
        </div>
    `;

    card.innerHTML = innerHTML;

    // --- EVENTOS DOS CONTROLOS ---
    card.querySelector('.delete').onclick = () => {
        if(confirm("Remover este item do quadro?")) { 
            card.remove(); 
            if(container.querySelectorAll('.board-card').length === 0 && emptyMsg) emptyMsg.style.display = 'block';
            if(isEditMode) savePuzzleData(); 
        }
    };
    card.querySelector('.move-up').onclick = () => {
        const p = card.previousElementSibling; if(p && p.classList.contains('board-card')) container.insertBefore(card, p);
    };
    card.querySelector('.move-down').onclick = () => {
        const n = card.nextElementSibling; if(n && n.classList.contains('board-card')) container.insertBefore(n, card);
    };

    if (type === 'text') {
        const linkBtn = card.querySelector('.add-board-link');
        if(linkBtn) linkBtn.onclick = (e) => { e.stopPropagation(); openBoardLinkManager(card.querySelector('.board-text-content')); };
        
        const contentDiv = card.querySelector('.board-text-content');
        contentDiv.addEventListener('click', (e) => {
            if(!puzzleContainer.classList.contains('edit-mode-active')) {
                const link = e.target.closest('a.board-link');
                if(link) { e.preventDefault(); viewBoardLink(link); }
            }
        });
        
        let typingTimer;
        contentDiv.addEventListener('input', () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (puzzleContainer.classList.contains('edit-mode-active')) savePuzzleData();
            }, 2000);
        });
    }

    container.appendChild(card);
}




// Fun√ß√£o para abrir nota a partir do Quadro (Puzzle) - VERS√ÉO ATUALIZADA
window.openNoteFromBoard = function(noteId, encodedSearchTerm = null) {
    
    // 1. Descodifica o termo de pesquisa (t√≠tulo da caixa) se ele existir
    // Se n√£o existir, tenta usar o nome da entidade ativa como fallback (comportamento antigo)
    let term = encodedSearchTerm 
        ? decodeURIComponent(encodedSearchTerm) 
        : (typeof activeReferenceEntity !== 'undefined' && activeReferenceEntity ? activeReferenceEntity.name : null);

    console.log(`üß© [Puzzle] Clique no cart√£o. ID: ${noteId}, Termo: ${term}`);

    // 2. Usa a Navega√ß√£o Inteligente (que lida com Superpastas e Grava√ß√£o)
    // A fun√ß√£o navigateWithUnsavedCheck garante que gravamos o quadro antes de sair
    navigateWithUnsavedCheck(() => {
        if (typeof navigateToNoteSmart === 'function') {
            // Usa a fun√ß√£o moderna que sabe mudar de p√°gina
            navigateToNoteSmart(noteId, term);
        } else {
            // Fallback de seguran√ßa (caso a fun√ß√£o smart n√£o exista por algum motivo)
            displayNote(noteId, null, term);
        }
    });
};

// --- L√ìGICA DO POPUP DE SELE√á√ÉO DE REFER√äNCIAS ---
async function openReferenceSelectionPopup() {
    const modal = document.getElementById('puzzle-ref-selection-modal');
    const list = document.getElementById('puzzle-ref-selection-list');
    
    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        alert("Selecione um t√≥pico, tag ou entidade primeiro.");
        return;
    }

    modal.style.display = 'flex';
    list.innerHTML = '<li style="padding:10px;">A pesquisar refer√™ncias...</li>';

    const { id, type, name } = activeReferenceEntity;
    
    // Lista de IDs j√° no quadro (para marcar a verde)
    const existingRefIds = new Set();
    document.querySelectorAll('#puzzle-board-container .board-card.type-ref').forEach(card => {
        if (card.dataset.noteId) existingRefIds.add(card.dataset.noteId);
    });

    let notesFound = [];

    try {
        // --- 1. BUSCAR NOTAS NA BD ---
        if (type === 'topico' || type === 'subtopico') {
            // (O c√≥digo dos t√≥picos mant√©m-se igual...)
            const q = query(collection(db, 'pastas'), where('estado', '==', 'ativa'), where('userId', '==', auth.currentUser.uid));
            const snapshot = await getDocs(q);
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (!data.topicosSelecionados) return;
                let match = false;
                if (type === 'topico' && data.topicosSelecionados[id] !== undefined) match = true;
                else if (type === 'subtopico') match = Object.values(data.topicosSelecionados).some(arr => Array.isArray(arr) && arr.includes(id));
                
                if (match) {
                    let isProtected = (data.passe && data.passe.trim() !== "");
                    if (isProtected && !appSettings.searchTopicsInProtected) return;
                    notesFound.push({ id: docSnap.id, ...data });
                }
            });
        } 
        else if (type === 'tag') {
            // (O c√≥digo das tags mant√©m-se igual...)
            const q = query(collection(db, 'pastas'), where('tags', 'array-contains', name), where('estado', '==', 'ativa'), where('userId', '==', auth.currentUser.uid));
            const snapshot = await getDocs(q);
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                let isProtected = (data.passe && data.passe.trim() !== "");
                if (isProtected && !appSettings.searchTagsInProtected) return;
                notesFound.push({ id: docSnap.id, ...data });
            });
        }
        else { // >>> ENTIDADES (B√≠blia, Personagens, etc) - AQUI ESTAVA A FALHA <<<
            const collectionName = getCollectionFromType(type);
            const entityDoc = await getDoc(doc(db, collectionName, id));
            
            // 1. Obt√©m lista da BD
            let refsMap = {};
            if (entityDoc.exists()) {
                refsMap = entityDoc.data().referencias || {};
            }

            // 2. Converte as chaves (IDs das notas) num array
            let noteIdsToCheck = Object.keys(refsMap);

            // 3. CORRE√á√ÉO: For√ßa a nota atual a entrar na lista se n√£o estiver l√°
            // (Igual ao que fazes no showReferencesPanel)
            if (selectedNoteId && !noteIdsToCheck.includes(selectedNoteId)) {
                noteIdsToCheck.push(selectedNoteId);
            }

            // 4. Itera sobre a lista combinada
            for (const noteId of noteIdsToCheck) {
                // Se for a nota atual, usamos os dados do ecr√£ (mais recentes)
                if (selectedNoteId === noteId) {
                    notesFound.push({ 
                        id: noteId, 
                        nome: document.getElementById('note-title-input').value, 
                        conteudo: document.getElementById('note-content-editor').innerHTML 
                    });
                } else {
                    // Se for outra nota, vamos buscar √† BD
                    const noteSnap = await getDoc(doc(db, 'pastas', noteId));
                    if (noteSnap.exists()) {
                        const data = noteSnap.data();
                        let isProtected = (data.passe && data.passe.trim() !== "");
                        if (!isProtected || appSettings.searchAnchorsInProtected) {
                            notesFound.push({ id: noteSnap.id, ...data });
                        }
                    }
                }
            }
        }

        // --- 2. PROCESSAR CONTE√öDO (HTML vs Texto) ---
        // (O resto da fun√ß√£o mant√©m-se igual...)
        list.innerHTML = '';
        if (notesFound.length === 0) {
            list.innerHTML = '<li>Sem refer√™ncias encontradas.</li>';
            return;
        }

        const parser = new DOMParser();

        notesFound.forEach(note => {
            const docHTML = parser.parseFromString(note.conteudo, 'text/html');
            
            // Vari√°veis de visualiza√ß√£o
            let displayIcon = "üìÑ";
            let contextLabel = "Nota Geral";
            let visualSnippet = ""; // O que se v√™ na lista (texto curto)
            let dataSnippet = "";   // O que se guarda (HTML completo ou texto)
            let borderColor = "transparent";
            let isClonedBox = false;

            // Procura caixas especiais (Quest√µes, Subnotas, Toggles)
            const allWrappers = [
                ...Array.from(docHTML.querySelectorAll('.mini-note-wrapper')),
                ...Array.from(docHTML.querySelectorAll('details.toggle-section'))
            ];

            let targetWrapper = null;

            for (const w of allWrappers) {
                let match = false;
                // A. Match por T√≥pico
                if (type === 'topico' || type === 'subtopico') {
                    const tJson = w.getAttribute('data-topics');
                    if (tJson && (tJson.includes(`"${id}"`) || tJson.includes(`"${id}":`))) match = true;
                } 
                // B. Match por Texto (Tag/Entidade)
                else {
                    if (w.textContent.toLowerCase().includes(name.toLowerCase())) match = true;
                }

                if (match) {
                    targetWrapper = w;
                    break;
                }
            }

            if (targetWrapper) {
                // √â UMA CAIXA -> CLONAGEM PERFEITA
                isClonedBox = true;
                dataSnippet = targetWrapper.outerHTML; // Guarda o HTML todo!

                // Define o visual bonito
                if (targetWrapper.tagName === 'DETAILS') {
                    displayIcon = "‚òÇ"; contextLabel = "Sec√ß√£o"; borderColor = "#9b59b6";
                    const h2 = targetWrapper.querySelector('h2');
                    visualSnippet = h2 ? h2.textContent : "T√≠tulo Toggle";
                } 
                else if (targetWrapper.classList.contains('question-mode')) {
                    displayIcon = "üìó"; contextLabel = "Quest√£o"; borderColor = "#2ecc71";
                    const inp = targetWrapper.querySelector('input');
                    visualSnippet = inp ? inp.value : "Quest√£o";
                }
                else if (targetWrapper.classList.contains('free-mode')) {
                    displayIcon = "üìô"; contextLabel = "Contentor"; borderColor = "#e67e22";
                    const txt = targetWrapper.querySelector('.mini-note-content');
                    visualSnippet = txt ? txt.textContent.substring(0, 50) + "..." : "Conte√∫do";
                }
                else { 
                    displayIcon = "üìò"; contextLabel = "SubNota"; borderColor = "#3498db";
                    const inp = targetWrapper.querySelector('input');
                    visualSnippet = inp ? inp.value : "SubNota";
                }
            } 
            else {
                // √â TEXTO SOLTO -> CITA√á√ÉO SIMPLES
                isClonedBox = false;
                dataSnippet = generateReferenceContext(note.conteudo, name);
                visualSnippet = "Texto no corpo da nota";
                if (type === 'tag') visualSnippet = `Nota com a tag #${name}`;
            }

            // --- 3. CRIAR ITEM DA LISTA (CSS Class puzzle-ref-item) ---
            const li = document.createElement('li');
            li.className = 'puzzle-ref-item'; // Usa a classe CSS criada anteriormente
            
            if (borderColor !== 'transparent') li.style.borderLeft = `4px solid ${borderColor}`;
            if (existingRefIds.has(note.id)) li.style.backgroundColor = "rgba(46, 204, 113, 0.1)";

            li.innerHTML = `
                <div class="puzzle-ref-header">
                    <span class="puzzle-ref-type">${displayIcon} ${contextLabel}</span>
                    <span class="puzzle-ref-note">em üìÑ ${note.nome}</span>
                </div>
                <div class="puzzle-ref-snippet" style="font-size:0.85em; color:var(--text-muted-color);">
                    ${visualSnippet}
                </div>
            `;

            li.onclick = () => {
                createBoardItem('ref', {
                    noteId: note.id,
                    noteName: note.nome,
                    parentId: note.parentId,
                    snippet: dataSnippet,      // HTML PESADO (Para o Teleporte üì°)
                    displayTitle: visualSnippet, // TEXTO LEVE (Para o Visual do Quadro)
                    isClone: isClonedBox
                });
                modal.style.display = 'none';
                
                if (document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active')) {
                    savePuzzleData();
                }
            };

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar lista.</li>';
    }
}

// --- FUN√á√ÉO DE NAVEGA√á√ÉO INTELIGENTE ENTRE SUPERPASTAS ---

/**
 * Verifica a ancestralidade da nota e decide se abre diretamente
 * ou se redireciona para outra p√°gina (note.html vs superpasta.html)
 */
async function navigateToNoteSmart(targetNoteId, searchTerm = null) {
    if (!targetNoteId) return;

    // CORRE√á√ÉO: N√£o usamos updateSaveStatus('saving') aqui.
    // Apenas mudamos o texto visualmente para o utilizador saber que algo est√° a acontecer.
    const statusEl = document.getElementById('save-status-indicator');
    if(statusEl) {
        statusEl.textContent = "A localizar nota...";
        statusEl.style.opacity = "1";
    }

    console.group("üöÄ [Navega√ß√£o Inteligente]");
    console.log("üìç Destino:", targetNoteId);

    try {
        // 1. Buscar dados da nota
        const noteSnap = await getDoc(doc(db, 'pastas', targetNoteId));
        if (!noteSnap.exists()) {
            alert("Nota n√£o encontrada.");
            if(statusEl) statusEl.textContent = ""; // Limpa mensagem
            console.groupEnd();
            return;
        }
        const noteData = noteSnap.data();
        
        // 2. DETETIVE: Verificar Ancestrais (Procurar Superpasta)
        let currentParentId = noteData.parentId;
        let foundSuperfolderId = null;
        let safety = 0;

        while (currentParentId && safety < 50) {
            const parentSnap = await getDoc(doc(db, 'pastas', currentParentId));
            if (!parentSnap.exists()) break;
            
            const parentData = parentSnap.data();
            
            // Se encontrar uma superpasta
            if (parentData.superpasta === true) {
                foundSuperfolderId = currentParentId;
                console.log("üåü Superpasta detetada:", parentData.nome);
                break; 
            }
            currentParentId = parentData.parentId;
            safety++;
        }

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

        // 3. DECIS√ÉO FINAL
        if (foundSuperfolderId) {
            console.log(`%cüåç VIAGEM NECESS√ÅRIA! A sair para superpasta.html...`, 'color: #e67e22; font-weight: bold; font-size: 1.2em;');
            console.groupEnd();
            
            // Como n√£o alter√°mos o currentSaveStatus, o navegador vai deixar sair sem popup
            window.location.href = `superpasta.html?rootId=${foundSuperfolderId}&noteId=${targetNoteId}${searchParam}`;
        } 
        else {
            console.log("%cüè† NOTA LOCAL. A abrir no editor atual...", 'color: #2ecc71; font-weight: bold;');
            console.groupEnd();
            
            // Reconstr√≥i caminho e abre nota
            await reconstructNavigationPath(targetNoteId);
            displayNote(targetNoteId, null, searchTerm);
            
            // Restaura o texto de estado
            if(statusEl) updateSaveStatus('saved');
        }

    } catch (error) {
        console.error("Erro navega√ß√£o:", error);
        console.groupEnd();
        if(statusEl) statusEl.textContent = "Erro ao navegar";
    }
}

async function reconstructNavigationPath(noteId) {
    let currentId = noteId;
    const path = [];
    let safety = 0;
    while (currentId && safety < 20) {
        const docSnap = await getDoc(doc(db, 'pastas', currentId));
        if (!docSnap.exists()) break;
        const data = docSnap.data();
        if (!data.parentId) { // Raiz
            if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
            break;
        }
        if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
        currentId = data.parentId;
        safety++;
    }
    navigationStack = path;
    updateNavigationView(true, noteId); 
}

// ============================================================
// FUN√á√ïES AUXILIARES EM FALTA (COLE ISTO ANTES DO savePuzzleData)
// ============================================================

// 1. Mapear tipos para nomes de cole√ß√µes no Firebase
function getCollectionFromType(type) {
    if (ENTITY_CONFIG[type]) return ENTITY_CONFIG[type].collection;
    
    // Casos especiais
    if (type === 'topico') return 'topicos';
    if (type === 'subtopico') return 'subtopicos';
    if (type === 'tag') return 'tags';
    
    return null;
}

// 2. For√ßar a grava√ß√£o e sa√≠da do modo de edi√ß√£o (Crucial para a navega√ß√£o)
async function forceSaveAndClosePuzzleMode() {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // S√≥ faz algo se estivermos no modo "Conclu√≠do" (ativo)
    if (container && container.classList.contains('edit-mode-active')) {
        console.log("Sa√≠da for√ßada do Quadro: A gravar altera√ß√µes pendentes...");

        // 1. GRAVAR NO FIREBASE (Aguarda terminar antes de continuar)
        await savePuzzleData();

        // 2. DESLIGAR MODO DE EDI√á√ÉO (Visual)
        container.classList.remove('edit-mode-active');

        // Restaurar bot√£o principal
        if (btn) {
            btn.textContent = "Editar";
            btn.style.color = "";
            btn.style.borderColor = "";
            btn.style.backgroundColor = "";
        }

        // Esconder bot√µes de adicionar
        if (addButtons) {
            addButtons.style.display = 'none';
        }

        // 3. BLOQUEAR AS CAIXAS DE TEXTO
        // Transformar de edit√°veis para est√°ticas
        const editableDivs = container.querySelectorAll('.board-text-content');
        editableDivs.forEach(div => {
            div.setAttribute('contenteditable', 'false');
            // Remove estilo de input
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
}

// ============================================================

async function savePuzzleData() {
    console.log("üíæ [SAVE] A iniciar grava√ß√£o...");

    if (!activeReferenceEntity || !activeReferenceEntity.id) return;

    const { id, type } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    const saveBtn = document.getElementById('toggle-puzzle-edit-btn');
    if(saveBtn) saveBtn.textContent = "A gravar...";

    try {
        const itemsToSave = [];
        const cards = document.querySelectorAll('#puzzle-board-container .board-card');

        cards.forEach(card => {
            if (card.classList.contains('type-text')) {
                const contentDiv = card.querySelector('.board-text-content');
                const val = contentDiv ? contentDiv.innerHTML : ""; 
                // Verifica se tem texto ou html (imagens/links)
                if (contentDiv.textContent.trim().length > 0 || val.includes('<')) {
                    itemsToSave.push({ type: 'text', content: val });
                }
            } 
            else if (card.classList.contains('type-ref')) {
                // CORRE√á√ÉO: L√™ diretamente do dataset que garantimos na cria√ß√£o
                const noteName = card.dataset.noteName || "Sem Nome";
                
                console.log(`   üîπ A guardar Refer√™ncia: ${noteName}`);

                itemsToSave.push({ 
                    type: 'ref', 
                    noteId: card.dataset.noteId,
                    noteName: noteName,
                    parentId: card.dataset.parentId,
                    snippet: decodeURIComponent(card.dataset.snippet)
                });
            }
        });

        await updateDoc(doc(db, collectionName, id), {
            puzzleBoard: itemsToSave,
            updatedAt: serverTimestamp()
        });
        
        console.log("‚úÖ [SAVE] Gravado com sucesso.");

    } catch (e) {
        console.error("‚ùå [SAVE] Erro:", e);
        alert("Erro ao gravar o quadro.");
    } finally {
        if(saveBtn) {
            const isEdit = document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active');
            saveBtn.textContent = isEdit ? "Salvar" : "Editar";
        }
    }
}

// --- NOVO LOAD (Unificado) ---
 async function loadPuzzleData(entityId, entityType) {
    const container = document.getElementById('puzzle-board-container');
    const emptyMsg = document.getElementById('puzzle-empty-msg');
    
    container.querySelectorAll('.board-card').forEach(el => el.remove());
    if(emptyMsg) emptyMsg.style.display = 'block';

    const collectionName = getCollectionFromType(entityType);
    if (!collectionName) return;

    try {
        const entityDoc = await getDoc(doc(db, collectionName, entityId));
        if (!entityDoc.exists()) return;

        const data = entityDoc.data();
        let boardItems = data.puzzleBoard || [];

        if (boardItems.length === 0) return;
        if (emptyMsg) emptyMsg.style.display = 'none';

        const refItems = boardItems.filter(item => item.type === 'ref');
        
        if (refItems.length > 0) {
            const fetchPromises = refItems.map(async (item) => {
                
                // --- CORRE√á√ÉO DE SEGURAN√áA ---
                // Se o snippet guardado J√Å FOR UM CLONE (HTML), N√ÉO O ATUALIZES!
                // S√≥ atualizamos ao vivo se for texto simples.
                const currentSnippet = decodeURIComponent(item.snippet || "");
                if (currentSnippet.includes('mini-note-wrapper') || currentSnippet.includes('toggle-section')) {
                    // √â um clone HTML. Mant√©m como est√° para n√£o estragar.
                    return; 
                }
                
                // Se for texto normal, atualiza ao vivo (como antes)
                try {
                    let content = "";
                    let noteName = item.noteName;

                    if (selectedNoteId === item.noteId) {
                        content = document.getElementById('note-content-editor').innerHTML;
                        noteName = document.getElementById('note-title-input').value;
                    } else {
                        const noteSnap = await getDoc(doc(db, 'pastas', item.noteId));
                        if (noteSnap.exists()) {
                            content = noteSnap.data().conteudo;
                            noteName = noteSnap.data().nome;
                        } else {
                            item._deleted = true; return;
                        }
                    }
                    const freshSnippet = generateReferenceContext(content, activeReferenceEntity.name);
                    item.snippet = freshSnippet;
                    item.noteName = noteName;
                } catch (err) { }
            });

            await Promise.all(fetchPromises);
        }

        boardItems.forEach(item => {
            if (item._deleted) return;
            if (item.type === 'text') {
                createBoardItem('text', { content: item.content }); 
            } else if (item.type === 'ref') {
                createBoardItem('ref', {
                    noteId: item.noteId,
                    noteName: item.noteName,
                    parentId: item.parentId,
                    snippet: item.snippet // O snippet agora mant√©m-se HTML se for Clone
                });
            }
        });

    } catch (e) { console.error(e); }
}

// ====================================================================
// ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT JAVASCRIPT
// ====================================================================
async function showTagReferencesPanel(tagName) {
    // >>> LINHA NOVA: Grava o anterior antes de carregar o novo <<<
    await forceSaveAndClosePuzzleMode();
    // 1. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Refer√™ncias para a Tag "#${tagName}"`;

    // >>> NOVO: For√ßa a aba "Refer√™ncias" a abrir para ver a lista <<<
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) {
        refTabBtn.click(); // Simula o clique para alternar a visualiza√ß√£o
    }
    
    // Limpa e mostra spinner
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar notas com #${tagName}...</span>
        </div>`;

    try {
        // 2. Query ao Firebase
        const q = query(
            collection(db, 'pastas'), 
            where('tags', 'array-contains', tagName),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const querySnapshot = await getDocs(q);
        const validResults = [];

        // 3. Processamento e Filtros de Seguran√ßa
        for (const noteDoc of querySnapshot.docs) {
            const data = noteDoc.data();
            let parentSnap = null;
            let isItemProtected = false;

            // Verifica prote√ß√£o da pr√≥pria nota
            if (data.passe && data.passe.trim() !== "") {
                isItemProtected = true;
            }

            // Verifica prote√ß√£o da pasta pai (heran√ßa)
            if (data.parentId) {
                parentSnap = await getDoc(doc(db, 'pastas', data.parentId));
                if (parentSnap.exists()) {
                    const pData = parentSnap.data();
                    if (pData.passe && pData.passe.trim() !== "") {
                        isItemProtected = true;
                    }
                }
            }

            // Aplica a configura√ß√£o de privacidade
            if (isItemProtected && !appSettings.searchTagsInProtected) {
                continue; 
            }
            
            validResults.push({ noteSnap: noteDoc, parentSnap, _isProtected: isItemProtected });
        }

        // 4. Renderiza√ß√£o
        listElement.innerHTML = ''; 

        if (validResults.length === 0) {
            listElement.innerHTML = '<li style="padding:10px; color:#888;">Nenhuma refer√™ncia encontrada.</li>';
            return;
        }

        // Ordenar alfabeticamente
        validResults.sort((a, b) => a.noteSnap.data().nome.localeCompare(b.noteSnap.data().nome));

        validResults.forEach(result => {
            const { noteSnap, parentSnap, _isProtected } = result;
            const noteData = noteSnap.data();
            
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            const summary = document.createElement('summary');
            // Estilo Flex para alinhar: [Bot√£o+] [Texto] [Seta]
            summary.style.display = 'flex';
            summary.style.alignItems = 'center';
            summary.style.width = '100%';

            // --- A. BOT√ÉO ADICIONAR AO PUZZLE [+] ---
            const addToPuzzleBtn = document.createElement('button');
            addToPuzzleBtn.className = 'add-to-puzzle-btn';
            addToPuzzleBtn.textContent = '+';
            addToPuzzleBtn.title = "Adicionar ao Puzzle";
            addToPuzzleBtn.style.marginRight = "8px"; // Espa√ßo extra
            
            addToPuzzleBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Cria um snippet gen√©rico para a Tag
                const tagSnippet = `<p style="color:#2ecc71;">üè∑Ô∏è Cont√©m a tag <b>#${tagName}</b></p>`;
                
                // Chama a fun√ß√£o global criada anteriormente
                window.addItemToPuzzle(noteSnap.id, noteData.nome, tagSnippet);
            };

            // --- B. √çCONE E NOME DA NOTA ---
            const noteTitleSpan = document.createElement('span');
            const protectedIcon = _isProtected ? "üîí " : "üìÑ ";
            noteTitleSpan.textContent = protectedIcon + noteData.nome;
            noteTitleSpan.style.flexGrow = '1';
            noteTitleSpan.style.whiteSpace = 'nowrap';
            noteTitleSpan.style.overflow = 'hidden';
            noteTitleSpan.style.textOverflow = 'ellipsis';
            
            // --- C. BOT√ÉO IR PARA (Seta) ---
            const goToNoteBtn = document.createElement('button');
            goToNoteBtn.className = 'go-to-note-btn';
            goToNoteBtn.title = 'Ir para esta nota';
            goToNoteBtn.innerHTML = '‚ûî';
            
            // Configura os dados para o evento de clique global
            goToNoteBtn.dataset.noteId = noteSnap.id;
            if (parentSnap && parentSnap.exists()) {
                goToNoteBtn.dataset.parentId = parentSnap.id;
                goToNoteBtn.dataset.parentName = parentSnap.data().nome;
            }
            
            // Monta o cabe√ßalho (summary)
            summary.appendChild(addToPuzzleBtn);
            summary.appendChild(noteTitleSpan);
            summary.appendChild(goToNoteBtn);

            // Conte√∫do expandido (Contexto)
            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            contextDiv.innerHTML = `<p style="font-style: italic;">Nota classificada com #${tagName}.</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias da tag:", error);
        listElement.innerHTML = '<li>Ocorreu um erro ao buscar as refer√™ncias.</li>';
    }
}


  async function showReferencesPanel(entityId, entityName, entityType, anexoId = null) {
    // 1. Gravar e Preparar UI
    if (typeof forceSaveAndClosePuzzleMode === 'function') await forceSaveAndClosePuzzleMode();
    
    document.getElementById('references-panel-description').style.display = 'block';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');

    activeReferenceEntity = { id: entityId, type: entityType, name: entityName };
    if (typeof loadPuzzleData === 'function') loadPuzzleData(entityId, entityType);
    
    // Gest√£o de bot√µes (WOL / Marcadores)
    const wolBtn = document.getElementById('references-wol-btn');
    const bookmarkBtn = document.getElementById('references-bookmark-btn');
    if (entityType === 'textobiblico') {
        if (wolBtn) wolBtn.style.display = 'block';
        if (bookmarkBtn) bookmarkBtn.style.display = 'block';
    } else {
        if (wolBtn) wolBtn.style.display = 'none';
        if (bookmarkBtn) bookmarkBtn.style.display = 'none';
    }

    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Refer√™ncias para "${entityName}"`;
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `<div class="spinner-container"><div class="spinner"></div><span>A carregar...</span></div>`;
    
    const descriptionElement = document.getElementById('references-panel-description');
    descriptionElement.textContent = ''; 

    const collectionName = ENTITY_CONFIG[entityType]?.collection;
    if (!collectionName) {
        listElement.innerHTML = '<li>Erro: Tipo de entidade inv√°lido.</li>';
        return;
    }

    try {
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        // Objeto base para dados da entidade
        let entityData = entitySnap.exists() ? entitySnap.data() : { referencias: {} };
        
        if (entitySnap.exists()) {
            descriptionElement.textContent = entityData.descricao?.trim() || 'Nenhuma descri√ß√£o dispon√≠vel.';
            if (entityData.marcadoresAssociados && Object.keys(entityData.marcadoresAssociados).length > 0) {
                referencesPanelTitle.textContent = `Refer√™ncias para üîñ"${entityName}"`;
            }
        }

        // --- CORRE√á√ÉO PRINCIPAL AQUI ---
        // Obtemos as refer√™ncias da BD
        let noteIds = entityData.referencias ? Object.keys(entityData.referencias) : [];
        
        // FOR√áAMOS A NOTA ATUAL A ENTRAR NA LISTA
        // Mesmo que a BD ainda n√£o saiba, n√≥s sabemos que estamos a clicar nela!
        if (selectedNoteId && !noteIds.includes(selectedNoteId)) {
            noteIds.push(selectedNoteId);
        }
        // -------------------------------

        if (noteIds.length > 0) {
            const validResults = [];

            for (const id of noteIds) {
                let noteData = {};
                let isLiveNote = (selectedNoteId === id);
                
                // Vari√°veis para o resultado final
                let finalDisplayTitle = "";
                let finalIcon = "";
                let finalSnippet = "";
                let finalBorderColor = "";
                let foundInBox = false;
                let isProtected = false;

                // =========================================================
                // ESTRAT√âGIA A: NOTA AO VIVO (L√ä DO ECR√É)
                // =========================================================
                if (isLiveNote) {
                    const editor = document.getElementById('note-content-editor');
                    const noteTitleInput = document.getElementById('note-title-input');
                    
                    noteData = { nome: noteTitleInput.value, id: id };
                    finalDisplayTitle = noteData.nome;
                    finalIcon = "üìÑ";

                    // Normalizar nome para pesquisa (remove espa√ßos extras)
                    const searchName = entityName.trim();

                    // 1. Procura em todos os wrappers VIVOS no ecr√£
                    const liveWrappers = editor.querySelectorAll('.mini-note-wrapper, details.toggle-section, .post-it-note');
                    
                    for (const wrapper of liveWrappers) {
                        let boxTitle = "";
                        let boxContent = "";
                        let type = "unknown";

                        // Extra√ß√£o de conte√∫do dependendo do tipo
                        if (wrapper.classList.contains('post-it-note')) {
                            boxContent = wrapper.querySelector('.post-it-content')?.innerText || "";
                            type = "postit";
                        }
                        else if (wrapper.tagName === 'DETAILS') {
                            boxTitle = wrapper.querySelector('summary h2')?.textContent || "";
                            boxContent = wrapper.querySelector('.toggle-content')?.innerText || "";
                            type = "toggle";
                        }
                        else {
                            const inputEl = wrapper.querySelector('input.mini-note-title-input');
                            boxTitle = inputEl ? inputEl.value : "";
                            // Importante: innerText l√™ o texto vis√≠vel, innerHTML l√™ o c√≥digo
                            boxContent = wrapper.querySelector('.mini-note-content')?.innerText || "";
                            
                            if (wrapper.classList.contains('question-mode')) type = "question";
                            else if (wrapper.classList.contains('free-mode')) type = "free";
                            else type = "subnote";
                        }

                        // VERIFICA√á√ÉO (Includes simples pode falhar com &nbsp;, mas serve para a maioria)
                        if (boxTitle.includes(searchName) || boxContent.includes(searchName)) {
                            foundInBox = true;
                            
                            if (type === "question") {
                                finalIcon = "üìó"; finalDisplayTitle = boxTitle || "Quest√£o"; finalBorderColor = "border-left: 3px solid #2ecc71;";
                            } else if (type === "free") {
                                finalIcon = "üìô"; finalDisplayTitle = "Contentor"; finalBorderColor = "border-left: 3px solid #e67e22;";
                            } else if (type === "toggle") {
                                finalIcon = "‚òÇ"; finalDisplayTitle = boxTitle || "Sec√ß√£o"; finalBorderColor = "border-left: 3px solid #9b59b6;";
                            } else if (type === "postit") {
                                finalIcon = "üìí"; finalDisplayTitle = "Post-it"; finalBorderColor = "border-left: 3px solid #f1c40f;";
                            } else {
                                finalIcon = "üìò"; finalDisplayTitle = boxTitle || "SubNota"; finalBorderColor = "border-left: 3px solid #3498db;";
                            }

                            const sourceText = boxContent.includes(searchName) ? boxContent : boxTitle;
                            finalSnippet = generateReferenceContext(sourceText, searchName);
                            break; 
                        }
                    }

                    // Fallback se n√£o encontrou em caixas (est√° no texto solto)
                    if (!foundInBox) {
                        // Verifica se realmente existe no texto solto antes de adicionar
                        if (editor.innerText.includes(searchName)) {
                            finalSnippet = generateReferenceContext(editor.innerText, searchName);
                        } else if (!foundInBox) {
                            // Se n√£o encontrou em lado nenhum da nota atual, ignora esta itera√ß√£o
                            // (Isto acontece se clic√°mos num link antigo que j√° foi apagado do texto)
                            continue; 
                        }
                    }
                } 
                
                // =========================================================
                // ESTRAT√âGIA B: NOTA DA BASE DE DADOS (L√ä DO HTML)
                // =========================================================
                else {
                    const noteDoc = await getDoc(doc(db, 'pastas', id));
                    if (!noteDoc.exists()) continue;
                    const data = noteDoc.data();
                    if (data.estado !== 'ativa') continue;

                    noteData = { nome: data.nome, id: id };
                    isProtected = (data.passe && data.passe.trim() !== "");
                    if (isProtected && !appSettings.searchAnchorsInProtected) continue;

                    finalDisplayTitle = data.nome;
                    finalIcon = isProtected ? "üîí" : "üìÑ";

                    const parser = new DOMParser();
                    const docHTML = parser.parseFromString(data.conteudo, 'text/html');
                    
                    const wrappers = [
                        ...Array.from(docHTML.querySelectorAll('.mini-note-wrapper')),
                        ...Array.from(docHTML.querySelectorAll('details.toggle-section')),
                        ...Array.from(docHTML.querySelectorAll('.post-it-content'))
                    ];

                    for (const wrapper of wrappers) {
                        let boxTitle = "";
                        let boxContent = "";
                        let type = "unknown";

                        if (wrapper.tagName === 'DETAILS') {
                            boxTitle = wrapper.querySelector('summary h2')?.textContent || "";
                            boxContent = wrapper.querySelector('.toggle-content')?.textContent || "";
                            type = "toggle";
                        } 
                        else if (wrapper.classList.contains('mini-note-wrapper')) {
                            const input = wrapper.querySelector('input');
                            boxTitle = input ? input.getAttribute('value') : "";
                            boxContent = wrapper.querySelector('.mini-note-content')?.textContent || "";
                            
                            if (wrapper.classList.contains('question-mode')) type = "question";
                            else if (wrapper.classList.contains('free-mode')) type = "free";
                            else type = "subnote";
                        }
                        else if (wrapper.classList.contains('post-it-content')) {
                            boxContent = wrapper.textContent;
                            type = "postit";
                        }

                        if (boxTitle.includes(entityName) || boxContent.includes(entityName)) {
                            foundInBox = true;
                            if (type === "question") { finalIcon = "üìó"; finalDisplayTitle = boxTitle || "Quest√£o"; finalBorderColor = "border-left: 3px solid #2ecc71;"; }
                            else if (type === "free") { finalIcon = "üìô"; finalDisplayTitle = "Contentor"; finalBorderColor = "border-left: 3px solid #e67e22;"; }
                            else if (type === "toggle") { finalIcon = "‚òÇ"; finalDisplayTitle = boxTitle || "Sec√ß√£o"; finalBorderColor = "border-left: 3px solid #9b59b6;"; }
                            else if (type === "postit") { finalIcon = "üìí"; finalDisplayTitle = "Post-it"; finalBorderColor = "border-left: 3px solid #f1c40f;"; }
                            else { finalIcon = "üìò"; finalDisplayTitle = boxTitle || "SubNota"; finalBorderColor = "border-left: 3px solid #3498db;"; }
                            
                            const sourceText = boxContent.includes(entityName) ? boxContent : boxTitle;
                            finalSnippet = generateReferenceContext(sourceText, entityName);
                            break;
                        }
                    }

                    if (!foundInBox) {
                        finalSnippet = generateReferenceContext(data.conteudo, entityName);
                    }
                }

                validResults.push({ 
                    id: id, 
                    noteName: noteData.nome, 
                    displayTitle: finalDisplayTitle,
                    displayIcon: finalIcon,
                    snippet: finalSnippet,
                    borderColor: finalBorderColor,
                    isBox: foundInBox
                });
            }
            
            // RENDERIZAR RESULTADOS
            listElement.innerHTML = '';
            if (validResults.length === 0) {
                 listElement.innerHTML = '<li>Nenhuma nota acess√≠vel encontrada.</li>';
            } else {
                 validResults.sort((a, b) => {
                     if (a.isBox && !b.isBox) return -1;
                     if (!a.isBox && b.isBox) return 1;
                     return a.noteName.localeCompare(b.noteName);
                 });

                 validResults.forEach(result => {
                     const details = document.createElement('details');
                     details.className = 'reference-item';
                     if(result.borderColor) details.style = result.borderColor;
                     // Abrir automaticamente se for a nota atual
                     if (result.id === selectedNoteId) details.open = true;
                     
                     const summary = document.createElement('summary');
                     summary.style.listStyle = "none";

                     const goToBtn = `<button class="go-to-note-btn" 
                         data-note-id="${result.id}" 
                         data-search-term="${entityName}"
                         title="Ir para nota">‚ûî</button>`;

                     summary.innerHTML = `
                        <div style="display:flex; flex-direction:column; width:100%;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:500;">${result.displayIcon} ${result.displayTitle}</span>
                                ${goToBtn}
                            </div>
                            ${result.isBox ? `<small style="color:var(--text-muted-color); margin-top:2px;">em üìÑ ${result.noteName}</small>` : ''}
                        </div>
                     `;

                     const contextDiv = document.createElement('div');
                     contextDiv.className = 'reference-context';
                     contextDiv.innerHTML = result.snippet;
                     
                     details.appendChild(summary);
                     details.appendChild(contextDiv);
                     listElement.appendChild(details);
                 });
            }
        } else {
             listElement.innerHTML = '<li>Nenhuma refer√™ncia encontrada.</li>'; 
        }

        if (anexoId && typeof appendLinkInfoToPanel === 'function') appendLinkInfoToPanel(anexoId);

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias:", error);
        listElement.innerHTML = '<li>Erro ao carregar refer√™ncias.</li>';
    }
}



async function hideReferencesPanel() {
    // >>> LINHA NOVA: Grava o puzzle se estiver em edi√ß√£o antes de fechar <<<
    await forceSaveAndClosePuzzleMode();

    notebookContainer.classList.remove('references-panel-visible');
    const descriptionElement = document.getElementById('references-panel-description');
    if (descriptionElement) {
        descriptionElement.textContent = '';
    }
}

 function generateReferenceContext(noteContent, entityName) {
    // 1. Criar um contentor tempor√°rio
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = noteContent;

    // SEPARADOR M√ÅGICO
    const SEPARATOR = " ||| "; 

    // 2. ESTRAT√âGIA DE INJE√á√ÉO MELHORADA
    
    // A. Substituir quebras de linha manuais (<br>) pelo separador
    const brs = tempDiv.querySelectorAll('br');
    brs.forEach(br => {
        br.replaceWith(document.createTextNode(SEPARATOR));
    });

    // B. Injetar separador no IN√çCIO de cada bloco
    // Isto resolve o problema "fiel[NOVA LINHA]David". 
    // Ao p√¥r no in√≠cio da div do "David", garantimos "fiel ||| David".
    const blockTags = 'p, div, li, h1, h2, h3, h4, h5, h6, tr, td, th, blockquote, ul, ol, pre, section, article';
    const blocks = tempDiv.querySelectorAll(blockTags);
    
    blocks.forEach(el => {
        // Prepend (Inserir antes do primeiro filho)
        el.insertBefore(document.createTextNode(SEPARATOR), el.firstChild);
        
        // (Opcional) Tamb√©m adicionar ao fim para garantir isolamento total
        el.appendChild(document.createTextNode(SEPARATOR));
    });

    // 3. EXTRAIR TEXTO (Agora "David" est√° protegido por separadores)
    let plainText = tempDiv.textContent;
    
    // Normalizar espa√ßos
    plainText = plainText.replace(/\s+/g, ' ');

    // 4. ENCONTRAR A ENTIDADE
    const lowerText = plainText.toLowerCase();
    const lowerEntity = entityName.toLowerCase();
    const position = lowerText.indexOf(lowerEntity);

    if (position === -1) {
        return '<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>';
    }

    // 5. DELIMITAR IN√çCIO (Recuar at√© Pontua√ß√£o ou Separador)
    const textBefore = plainText.substring(0, position);
    const lastSeparatorIndex = textBefore.lastIndexOf(SEPARATOR);
    
    // Regex para √∫ltima pontua√ß√£o (., !, ?) seguida de espa√ßo
    const punctuationMatch = textBefore.match(/([.!?])\s+(?!.*[.!?])/); 
    const lastPunctuationIndex = punctuationMatch ? punctuationMatch.index + 1 : -1;

    let start = 0;
    // Quem estiver mais perto da palavra (maior √≠ndice) ganha
    if (lastSeparatorIndex > lastPunctuationIndex) {
        start = lastSeparatorIndex + SEPARATOR.length;
    } else if (lastPunctuationIndex > -1) {
        start = lastPunctuationIndex + 1;
    }

    // 6. DELIMITAR FIM (Avan√ßar at√© Pontua√ß√£o ou Separador)
    // AQUI √â QUE A M√ÅGICA ACONTECE PARA O SEU EXEMPLO
    
    // A. Separador depois da palavra
    let nextSeparatorIndex = plainText.indexOf(SEPARATOR, position + entityName.length);
    if (nextSeparatorIndex === -1) nextSeparatorIndex = plainText.length;

    // B. Pontua√ß√£o depois da palavra
    const textAfter = plainText.substring(position + entityName.length);
    const nextPunctuationMatch = textAfter.match(/[.!?]/);
    
    let nextPunctuationIndex = plainText.length;
    if (nextPunctuationMatch) {
        nextPunctuationIndex = position + entityName.length + nextPunctuationMatch.index + 1;
    }

    // Regra: O que aparecer PRIMEIRO corta a frase.
    // No seu exemplo: N√£o h√° pontua√ß√£o, mas h√° o SEPARATOR do "David". O SEPARATOR ganha.
    let end = Math.min(nextSeparatorIndex, nextPunctuationIndex);

    // 7. CORTE FINAL E LIMPEZA
    let snippet = plainText.substring(start, end).trim();

    // Remove qualquer lixo de separador que tenha sobrado
    snippet = snippet.split(SEPARATOR)[0].trim(); // Seguran√ßa extra
    snippet = snippet.replace(/\|\|\|/g, '').trim();

    // Corte de seguran√ßa para textos gigantes
    if (snippet.length > 250) {
        const localPos = snippet.toLowerCase().indexOf(lowerEntity);
        const cutStart = Math.max(0, localPos - 60);
        const cutEnd = Math.min(snippet.length, localPos + entityName.length + 100);
        snippet = (cutStart > 0 ? "..." : "") + snippet.substring(cutStart, cutEnd) + "...";
    }

    // 8. HIGHLIGHT
    const safeEntity = entityName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedText = snippet.replace(
        new RegExp(`(${safeEntity})`, 'gi'), 
        `<mark>$1</mark>`
    );

    return `<p>${highlightedText}</p>`;
}

// ====================================================================
// FUN√á√ÉO: CONVERTER SELE√á√ÉO EM CART√ÉO WEB (Com Timeout de 10s)
// ====================================================================
async function convertSelectionToUrlCard() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    // 1. Obter e Validar URL
    let url = selection.toString().trim();
    const anchorNode = selection.anchorNode.parentElement.closest('a');
    
    if (anchorNode) url = anchorNode.href;

    if (!url.startsWith('http')) {
        if (url.includes('.')) url = 'https://' + url;
        else { alert("Link inv√°lido."); return; }
    }

    // 2. Criar Placeholder (Loading) com ID √∫nico
    const cardId = `card_${Date.now()}`;
    const cardHtml = `
        <div class="url-card-widget" id="${cardId}" contenteditable="false" data-original-url="${url}">
            <div class="url-card-loading">
                <div class="spinner" style="width:20px; height:20px; border-width:2px; margin-right:10px;"></div>
                A gerar pr√©-visualiza√ß√£o...
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        </div>
        &nbsp;
    `;

    document.execCommand('insertHTML', false, cardHtml);
    document.getElementById('selection-popup').style.display = 'none';

    // --- FUN√á√ïES AUXILIARES ---
    
    const getRandomImage = () => {
        const images = [
            "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=400&q=80", // Abstrato Escuro
            "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=400&q=80", // Gradiente
            "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=400&q=80", // Natureza
            "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&q=80", // √ìleo
            "https://images.unsplash.com/photo-1506259091721-347f7d3bbcff?w=400&q=80"  // Textura
        ];
        return images[Math.floor(Math.random() * images.length)];
    };

    const formatFallbackTitle = (link) => {
        try {
            const urlObj = new URL(link);
            let title = urlObj.hostname.replace('www.', '');
            if (urlObj.pathname.length > 1) {
                const parts = urlObj.pathname.split('/').filter(p => p);
                if (parts.length > 0) return parts[parts.length - 1].replace(/[-_]/g, ' ');
            }
            return title.charAt(0).toUpperCase() + title.slice(1);
        } catch (e) { return "Liga√ß√£o Externa"; }
    };

    // Fun√ß√£o que aplica o visual "Bonito" (usada no sucesso e no erro)
    const updateCardUI = (title, image, logo, publisher) => {
        const cardEl = document.getElementById(cardId);
        if (!cardEl) return; // Se o utilizador j√° apagou o card, sai.

        cardEl.innerHTML = `
            <div class="url-card-image" style="background-image: url('${image}');"></div>
            <div class="url-card-info">
                <div class="url-card-title">${title}</div>
                <div class="url-card-domain">
                    <img src="${logo}" style="width:12px; height:12px; vertical-align:middle; margin-right:4px; border-radius:50%;">
                    ${publisher}
                </div>
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        `;
        saveNote();
    };

    // --- L√ìGICA DE CORRIDA (RACE) ---
    
    // Promessa de Timeout: Rejeita automaticamente ao fim de 10s
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error("Timeout de 10s atingido")), 10000)
    );

    // Promessa da API
    const fetchPromise = fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`)
        .then(res => res.json());

    try {
        // A magia acontece aqui: Quem terminar primeiro ganha.
        // Se o fetch demorar mais de 10s, o timeout ganha e lan√ßa um erro, ativando o catch.
        const data = await Promise.race([fetchPromise, timeoutPromise]);

        // SUCESSO DA API
        const meta = (data.status === 'success' && data.data) ? data.data : {};
        
        const finalTitle = meta.title || formatFallbackTitle(url);
        const finalImage = meta.image?.url || getRandomImage();
        const finalPublisher = meta.publisher || new URL(url).hostname;
        const finalLogo = meta.logo?.url || 'https://cdn-icons-png.flaticon.com/128/1006/1006771.png';

        updateCardUI(finalTitle, finalImage, finalLogo, finalPublisher);

    } catch (err) {
        // FALHA OU TIMEOUT
        console.warn("API demorou demasiado ou falhou. A aplicar fallback.", err);
        
        // Dados de recurso (Fallback)
        const fallbackTitle = formatFallbackTitle(url);
        const fallbackImg = getRandomImage();
        const domain = new URL(url).hostname;
        const fallbackLogo = 'https://cdn-icons-png.flaticon.com/128/1006/1006771.png';

        updateCardUI(fallbackTitle, fallbackImg, fallbackLogo, domain);
    }
}

// --- L√ìGICA DO EDITOR RICO E TAGS ---

function showTagPopup(query) {
    const filteredTags = allTags.filter(tag => tag.nome.toLowerCase().includes(query.toLowerCase()));
    tagSuggestionList.innerHTML = '';
    if (filteredTags.length > 0) {
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag.nome;
            li.dataset.tagNome = tag.nome;
            tagSuggestionList.appendChild(li);
        });
    } else if (query) {
        const li = document.createElement('li');
        li.innerHTML = `Criar nova tag: "<strong>${query}</strong>"`;
        li.dataset.tagNome = query;
        tagSuggestionList.appendChild(li);
    } else {
         hideTagPopup(); return;
    }
    const rect = currentTagQueryRange.getBoundingClientRect();
    tagSuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
    tagSuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
    tagSuggestionPopup.style.display = 'block';
    isTagPopupOpen = true;
    tagSuggestionList.firstChild.classList.add('selected');
}

 function hideTagPopup() {
    tagSuggestionPopup.style.display = 'none';
    isTagPopupOpen = false;
    currentTagQueryRange = null; // Importante: limpa o range para evitar reaberturas acidentais
}


function navigateTagSuggestions(key) {
    const items = Array.from(tagSuggestionList.children);
    if(items.length === 0) return;
    const selected = tagSuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

async function commitTagSelection() {
    const selectedLi = tagSuggestionList.querySelector('.selected');
    if (!selectedLi) {
        hideTagPopup();
        return;
    }

    const tagName = selectedLi.dataset.tagNome.trim();
    if (!tagName) { 
        hideTagPopup(); 
        return; 
    }

    // Verifica/Cria a tag no banco de dados
    let tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tagExists) await createNewTag(tagName);

    // Insere no editor
    insertTagIntoEditor(tagName);
    
    // FOR√áA O FECHO IMEDIATO
    hideTagPopup();
}

async function createNewTag(tagName) {
    try {
        // Verifica se a tag j√° existe na lista LOCAL (que j√° √© filtrada por user)
        // para evitar chamadas desnecess√°rias √† base de dados.
        const tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
        
        if (tagExists) {
            console.log("Tag j√° existe para este usu√°rio.");
            return;
        }

        const tagsCollection = collection(db, 'tags');
        const newTagRef = await addDoc(tagsCollection, { 
            nome: tagName, 
            userId: auth.currentUser.uid, // GRAVA√á√ÉO DO USER ID
            createdAt: serverTimestamp() 
        });
        
        // Atualiza o cache local imediatamente
        allTags.push({ id: newTagRef.id, nome: tagName });
        console.log("Nova tag criada:", tagName);

    } catch (error) { 
        console.error("Erro ao criar nova tag:", error); 
    }
}


async function fetchAllTags() {
    if (!auth.currentUser) return;
    try {
        const tagsCollection = collection(db, 'tags');
        // FILTRO OBRIGAT√ìRIO
        const q = query(tagsCollection, where('userId', '==', auth.currentUser.uid));
        
        const tagsSnapshot = await getDocs(q);
        
        // Limpa e reconstr√≥i o array global
        allTags = tagsSnapshot.docs.map(doc => ({
            id: doc.id,
            nome: doc.data().nome || doc.data().name 
        })).filter(tag => tag.nome); // Filtra tags sem nome
        
    } catch (error) {
        console.error("Erro ao carregar tags:", error);
    }
}


function insertTagIntoEditor(tagName) {
    if (!currentTagQueryRange) return;

    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = `#${tagName}`;
    tagSpan.setAttribute('contenteditable', 'false'); 
    const spaceNode = document.createTextNode('\u00A0');
    currentTagQueryRange.deleteContents();
    currentTagQueryRange.insertNode(spaceNode); 
    currentTagQueryRange.insertNode(tagSpan);  
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
    currentTagQueryRange = null;
}

// ============================================================
// L√ìGICA DE NAVEGA√á√ÉO MOBILE
// ============================================================

// 1. Ao clicar numa PASTA (Esquerda -> Meio)
// Adicione isto ao seu listener existente do 'leftPanelList' ou use este auxiliar:
const originalLeftClick = leftPanelList.onclick; // Preserva l√≥gica antiga se existir
leftPanelList.addEventListener('click', (e) => {
    const item = e.target.closest('.list-item');
    if (!item) return;
    
    // Se for clique em menu ou expandir, ignora
    if (e.target.closest('.item-menu-btn')) return;

    // Se a largura for mobile, avan√ßa para o painel do meio
    if (window.innerWidth <= 768) {
        document.body.classList.add('mobile-view-middle');
        document.body.classList.remove('mobile-view-editor');
    }
});

// 2. Ao clicar numa NOTA (Meio -> Direita/Editor)
middlePanelList.addEventListener('click', (e) => {
    const item = e.target.closest('.list-item');
    if (!item) return;
    if (e.target.closest('.item-menu-btn')) return;

    const type = item.dataset.type;

    if (window.innerWidth <= 768) {
        // Se for pasta, mantemos no meio (apenas recarrega lista)
        // Se for NOTA, vamos para o editor
        if (type === 'nota') {
            document.body.classList.add('mobile-view-editor');
        }
    }
});

// 3. Bot√£o VOLTAR (Corre√ß√£o: Refer√™ncia Global + Clique √önico)
// Certifique-se que n√£o apaga a linha 'const backBtn = ...' no in√≠cio do script

if (backBtn) {
    backBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation(); // Impede interfer√™ncias

        // 1. Remove a pasta atual do hist√≥rico
        if (navigationStack.length > 0) {
            navigationStack.pop();
        }

        // 2. Verifica se volt√°mos √† raiz (Hist√≥rico vazio)
        if (navigationStack.length === 0) {
            
            // Se estiver em Mobile
            if (window.innerWidth <= 768) {
                // Esconde o painel do meio
                document.body.classList.remove('mobile-view-middle');
                
                // >>> A CORRE√á√ÉO M√ÅGICA <<<
                // Remove as classes que for√ßam o painel esquerdo a desaparecer
                notebookContainer.classList.remove('middle-panel-collapsed');
                notebookContainer.classList.remove('left-panel-collapsed');
                
                // Limpa sele√ß√£o visual da esquerda
                document.querySelectorAll('#left-panel-list .selected').forEach(el => el.classList.remove('selected'));
            }
            
            // Atualiza para a Raiz
            updateNavigationView(true);
        } else {
            // 3. Se ainda h√° hist√≥rico, carrega a pasta anterior
            updateNavigationView(true);
        }
    };
}

// 4. Bot√£o VOLTAR do Editor (Direita -> Meio)
if (mobileBackBtn) {
    mobileBackBtn.addEventListener('click', (e) => {
        e.preventDefault(); // Previne comportamentos estranhos
        
        // 1. Gravar a nota atual antes de sair
        if (typeof saveNote === 'function') saveNote(true);
        
        // 2. Mudar o estado das classes no BODY
        // Remove a vista do editor (Painel 3)
        document.body.classList.remove('mobile-view-editor');
        
        // Adiciona FOR√áOSAMENTE a vista do meio (Painel 2)
        document.body.classList.add('mobile-view-middle');
    });
}


// ====================================================================
// MOTOR DO CALEND√ÅRIO (Agenda Firebase)
// ====================================================================

// 1. Delegar eventos globais no Editor (porque o HTML √© din√¢mico)
noteContentEditor.addEventListener('click', (e) => {
    // A. Clique no bot√£o de defini√ß√µes (‚öôÔ∏è)
    if (e.target.closest('.cal-settings')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const menu = widget.querySelector('.cal-settings-menu');
        menu.classList.toggle('visible');
    }
 // >>> NOVO BLOCO: ELIMINAR CALEND√ÅRIO <<<
    else if (e.target.classList.contains('cal-delete-btn')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        
        // Pede confirma√ß√£o (pode usar o seu showConfirmation ou o confirm nativo)
        if (confirm("Tem a certeza que deseja eliminar esta agenda?")) {
            widget.remove(); // Remove do DOM
            saveNote();      // Grava a nota sem o calend√°rio
        }
    }
    // >>> FIM DO NOVO BLOCO <<<
    
    // B. Mudar Visualiza√ß√£o (Semana/M√™s/Ano)
    else if (e.target.classList.contains('cal-view-btn')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        // Atualiza bot√µes
        widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        // Atualiza estado e re-renderiza
        widget.dataset.view = e.target.dataset.view;
        renderCalendarUI(widget);
        // Fecha o menu
        widget.querySelector('.cal-settings-menu').classList.remove('visible');
    }

    // C. Navega√ß√£o (‚óÄ / ‚ñ∂)
    else if (e.target.closest('.cal-prev') || e.target.closest('.cal-next')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const isNext = e.target.closest('.cal-next');
        changeCalendarDate(widget, isNext ? 1 : -1);
    }

    // D. Clique num Dia (Adicionar Tarefa)
    else if (e.target.classList.contains('cal-day') && !e.target.classList.contains('empty')) {
        const day = e.target.dataset.day;
        const widget = e.target.closest('.jwn-calendar-widget');
        const month = parseInt(widget.dataset.month); // 0-11
        const year = parseInt(widget.dataset.year);
        
        // Formata data ISO (YYYY-MM-DD)
        const dateObj = new Date(year, month, parseInt(day));
        // Ajuste fuso hor√°rio simples
        const dateISO = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

        openCalendarModal(dateISO, widget);
    }
});

// 2. Fun√ß√£o Principal de Renderiza√ß√£o
async function renderCalendarUI(widget) {
    if (!widget) return;

    const view = widget.dataset.view || 'month';
    const month = parseInt(widget.dataset.month);
    const year = parseInt(widget.dataset.year);
    const grid = widget.querySelector('.cal-grid');
    const title = widget.querySelector('.cal-title');

    grid.innerHTML = ''; // Limpa

    // Carregar tarefas do Firebase para este m√™s
    const tasksMap = await fetchTasksForMonth(year, month);

    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    // --- MODO M√äS (Padr√£o) ---
    if (view === 'month') {
        title.textContent = `${monthNames[month]} ${year}`;

        // Cabe√ßalhos (D S T Q Q S S)
        const days = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        days.forEach(d => grid.innerHTML += `<div class="cal-day-header">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay(); // 0 = Domingo
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // Espa√ßos vazios antes do dia 1
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div class="cal-day empty"></div>`;
        }

        // Dias
        for (let i = 1; i <= daysInMonth; i++) {
            const dateISO = new Date(year, month, i).toLocaleDateString('en-CA'); // YYYY-MM-DD local hack
            // Nota: constru√ß√£o de ISO manual √© mais segura:
            const realISO = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            
            const isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear());
            const hasTask = tasksMap[realISO]; // Verifica se h√° tarefa no map

            const div = document.createElement('div');
            div.className = `cal-day ${isToday ? 'today' : ''} ${hasTask ? 'has-task' : ''}`;
            div.textContent = i;
            div.dataset.day = i;
            if (hasTask) div.title = "Tem tarefas";
            grid.appendChild(div);
        }
    } 
    // --- MODO ANO (Simplificado) ---
    else if (view === 'year') {
        title.textContent = `${year}`;
        grid.style.gridTemplateColumns = "repeat(3, 1fr)"; // 3 colunas de meses
        grid.style.gap = "10px";
        
        monthNames.forEach((mName, idx) => {
            const btn = document.createElement('div');
            btn.className = 'cal-day'; // Reusa estilo
            btn.textContent = mName.substring(0, 3);
            btn.onclick = (e) => {
                e.stopPropagation();
                // Ao clicar no m√™s, entra no modo m√™s
                widget.dataset.month = idx;
                widget.dataset.view = 'month';
                // Atualiza bot√£o visual
                widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
                widget.querySelector('[data-view="month"]').classList.add('active');
                renderCalendarUI(widget);
            };
            grid.appendChild(btn);
        });
    }
    // --- MODO SEMANA (Placeholder funcional) ---
    else if (view === 'week') {
        title.textContent = `Semana (Demo) - ${monthNames[month]}`;
        grid.innerHTML = '<div style="grid-column: span 7; padding:10px; color:#888;">Modo semana simplificado para o dia 1 a 7.</div>';
        // (Pode expandir se quiser, mas m√™s √© o mais √∫til)
    }
}

// 3. Navega√ß√£o
function changeCalendarDate(widget, direction) {
    let m = parseInt(widget.dataset.month);
    let y = parseInt(widget.dataset.year);
    const view = widget.dataset.view;

    if (view === 'year') {
        y += direction;
    } else {
        m += direction;
        if (m > 11) { m = 0; y++; }
        if (m < 0) { m = 11; y--; }
    }

    widget.dataset.month = m;
    widget.dataset.year = y;
    renderCalendarUI(widget);
}

// 4. Integra√ß√£o Firebase (Buscar Tarefas)
async function fetchTasksForMonth(year, month) {
    if (!auth.currentUser) return {};

    // Define intervalo do m√™s para query
    // Constru√≠mos strings YYYY-MM para filtrar (simplificado: pegamos tudo e filtramos)
    // Para produ√ß√£o ideal: `where('data', '>=', startStr)`
    
    const startStr = `${year}-${String(month+1).padStart(2,'0')}-01`;
    const endStr = `${year}-${String(month+1).padStart(2,'0')}-31`;

    const q = query(
        collection(db, 'agenda'),
        where('userId', '==', auth.currentUser.uid),
        where('data', '>=', startStr),
        where('data', '<=', endStr)
    );

    const snapshot = await getDocs(q);
    const map = {};
    snapshot.forEach(doc => {
        const d = doc.data();
        map[d.data] = true; // Marca que este dia tem algo
    });
    return map;
}

// 5. Modal de Tarefas
let currentCalendarWidget = null; // Para saber qual atualizar ao fechar

async function openCalendarModal(dateISO, widget) {
    const modal = document.getElementById('calendar-task-modal');
    const displaySpan = document.getElementById('cal-selected-date-display');
    const isoInput = document.getElementById('cal-selected-date-iso');
    const descInput = document.getElementById('cal-task-desc');
    const existingList = document.getElementById('cal-existing-tasks');
    const saveBtn = document.getElementById('cal-save-task-btn');

    currentCalendarWidget = widget;
    displaySpan.textContent = dateISO; // Ex: 2024-05-25
    isoInput.value = dateISO;
    descInput.value = '';
    existingList.innerHTML = 'Carregando...';
    
    modal.style.display = 'flex';
    descInput.focus();

    // Carregar tarefas existentes desse dia
    const q = query(
        collection(db, 'agenda'),
        where('userId', '==', auth.currentUser.uid),
        where('data', '==', dateISO)
    );
    const snap = await getDocs(q);
    existingList.innerHTML = '';
    
    if (snap.empty) {
        existingList.innerHTML = '<small style="color:#888;">Sem tarefas.</small>';
    } else {
        snap.forEach(doc => {
            const task = doc.data();
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid var(--border-color)';
            div.style.padding = '5px';
            div.style.fontSize = '0.9em';
            div.innerHTML = `‚Ä¢ ${task.descricao}`;
            existingList.appendChild(div);
        });
    }

    // Gravar Nova Tarefa
    // (Removemos listeners antigos clonando)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const desc = descInput.value.trim();
        if (!desc) return;

        try {
            await addDoc(collection(db, 'agenda'), {
                data: dateISO,
                descricao: desc,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            
            modal.style.display = 'none';
            // Atualiza o widget para mostrar a bolinha vermelha
            renderCalendarUI(currentCalendarWidget); 
            
        } catch (e) {
            console.error(e);
            alert("Erro ao gravar tarefa.");
        }
    };
}

// 6. AUTO-INICIAR CALEND√ÅRIOS AO ABRIR NOTA
// Adicione esta chamada dentro da fun√ß√£o displayNote()
// Logo a seguir a noteContentEditor.innerHTML = conteudo...
function refreshAllCalendars() {
    const calendars = document.querySelectorAll('.jwn-calendar-widget');
    calendars.forEach(cal => renderCalendarUI(cal));
}

// --- NOVAS FUN√á√ïES PARA SUGEST√ÉO DE ENTIDADES ---

function showEntityPopup(query) {
    // Junta todas as entidades de todos os tipos num √∫nico array
    const flatEntities = Object.values(allEntities).flat();
    const filteredEntities = flatEntities.filter(entity => 
        entity.nome.toLowerCase().includes(query.toLowerCase())
    );

    entitySuggestionList.innerHTML = '';
    if (filteredEntities.length > 0) {
        filteredEntities.forEach(entity => {
            const li = document.createElement('li');
            // Guardamos os dados da entidade no elemento li
            li.dataset.entityName = entity.nome;
            li.dataset.entityType = entity.tipo;
            
            // Mostra o nome e o tipo para ser mais f√°cil de identificar
            li.innerHTML = `${entity.nome} <span style="font-size: 0.8em;">[${entity.tipo}]</span>`;
            
            entitySuggestionList.appendChild(li);
        });
        
        const rect = currentEntityQueryRange.getBoundingClientRect();
        entitySuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
        entitySuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
        entitySuggestionPopup.style.display = 'block';
        isEntityPopupOpen = true;
        entitySuggestionList.firstChild.classList.add('selected');
    } else {
        hideEntityPopup();
    }
}

function hideEntityPopup() {
    entitySuggestionPopup.style.display = 'none';
    isEntityPopupOpen = false;
    currentEntityQueryRange = null;
}

function navigateEntitySuggestions(key) {
    const items = Array.from(entitySuggestionList.children);
    if(items.length === 0) return;
    const selected = entitySuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

function insertEntityIntoEditor(entityName, entityType) {
    if (!currentEntityQueryRange) return;

    const entitySpan = document.createElement('span');
    entitySpan.className = 'entity-link';
    entitySpan.dataset.entityType = entityType;
    entitySpan.dataset.entityName = entityName;
    entitySpan.textContent = entityName;
    
    const spaceNode = document.createTextNode('\u00A0');

    // Substitui o texto que o utilizador digitou (ex: @Jeremias)
    currentEntityQueryRange.deleteContents();
    currentEntityQueryRange.insertNode(spaceNode);
    currentEntityQueryRange.insertNode(entitySpan);
    
    // P√µe o cursor a seguir ao espa√ßo, pronto para continuar a escrever
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}

async function commitEntitySelection() {
    const selectedLi = entitySuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    
    const entityName = selectedLi.dataset.entityName;
    const entityType = selectedLi.dataset.entityType;
    
    if (entityName && entityType) {
        // A L√ìGICA DE ATUALIZA√á√ÉO FOI ADICIONADA AQUI
        const collectionName = ENTITY_CONFIG[entityType]?.collection;
        if (collectionName) {
            const allKnownEntities = Object.values(allEntities).flat();
            const entity = allKnownEntities.find(e => e.tipo === entityType && e.nome === entityName);

            if (entity) {
                // Se a entidade foi encontrada no cache, atualiza as suas refer√™ncias no Firestore
                const entityRef = doc(db, collectionName, entity.id);
                try {
                    await updateDoc(entityRef, {
                        [`referencias.${selectedNoteId}`]: true
                    });
                    console.log(`Refer√™ncia para a nota ${selectedNoteId} adicionada √† entidade "${entityName}".`);
                } catch (error) {
                    console.error("Erro ao atualizar refer√™ncia da entidade:", error);
                }
            }
        }

        // Insere o <span> no editor (comportamento visual)
        insertEntityIntoEditor(entityName, entityType);
    }
    
    hideEntityPopup();
}



function escapeStyledElements(event) {
    const selection = window.getSelection();
    if (!selection.isCollapsed || selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    // Garante que pegamos o elemento HTML, n√£o o n√≥ de texto
    const parentElement = currentNode.nodeType === Node.TEXT_NODE ? currentNode.parentElement : currentNode;

    // 1. Identifica se estamos dentro de algo "especial"
    // Lista de classes que queremos "escapar"
    let styledContainer = parentElement.closest('.entity-link, .tag, a[data-anexo-id], .idea-span');

    // 2. L√ìGICA DE HIERARQUIA (CRUCIAL):
    // Se encontrarmos uma entidade ou tag, verificamos se ela est√° dentro de um link (Anexo).
    // Se estiver, o "contentor a escapar" deve ser o LINK, n√£o a entidade interna.
    if (styledContainer && (styledContainer.classList.contains('entity-link') || styledContainer.classList.contains('tag'))) {
        const parentLink = styledContainer.closest('a[data-anexo-id]');
        if (parentLink) {
            styledContainer = parentLink;
        }
    }

    if (styledContainer) {
        const isAtTheStart = range.startOffset === 0;
        // Verifica√ß√£o do final do n√≥ de texto atual
        const isAtTheEnd = range.startOffset === currentNode.textContent.length;
        
        const isPrintableChar = (event.key.length === 1 || event.key === 'Enter') && !event.ctrlKey && !event.metaKey && !event.altKey;

        // =========================================================================
        // CEN√ÅRIO 1: Escrever no IN√çCIO do elemento (|Link)
        // =========================================================================
        if (isAtTheStart && isPrintableChar && event.key !== 'Backspace') {
            console.log('[Prote√ß√£o] A escrever no in√≠cio de um contentor especial.');
            
            event.preventDefault(); // Impede o navegador de colocar a letra dentro do link

            // Cria o texto digitado e a barreira invis√≠vel
            const typedTextNode = document.createTextNode(event.key);
            const zeroWidthSpace = document.createTextNode('\u200B');
            const parent = styledContainer.parentNode;

            // Insere ANTES do contentor especial
            parent.insertBefore(typedTextNode, styledContainer);
            parent.insertBefore(zeroWidthSpace, styledContainer);

            // Coloca o cursor depois do texto novo (mas antes da barreira)
            // Assim, a pr√≥xima letra continuar√° "fora"
            const newRange = document.createRange();
            newRange.setStartAfter(typedTextNode);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            return;
        }

        // =========================================================================
        // CEN√ÅRIO 2: Escrever no FIM do elemento (Link|)
        // =========================================================================
        if (isAtTheEnd && isPrintableChar) {
            // Verifica se este n√≥ √© realmente o √∫ltimo n√≥ de texto dentro do contentor
            // (Para evitar sair do link se estivermos no meio de uma frase composta, ex: <b>Negrito</b>|Normal)
            const isReallyLastNode = (currentNode === styledContainer.lastChild) || 
                                     (styledContainer.lastChild && currentNode === styledContainer.lastChild.lastChild);
            
            if (isReallyLastNode) {
                console.log('[Prote√ß√£o] A escrever no fim de um contentor especial.');
                
                // Nota: N√£o usamos preventDefault aqui para deixar a letra ser processada,
                // mas movemos o cursor para garantir que ela cai "fora".
                
                const zeroWidthSpace = document.createTextNode('\u200B');
                const parent = styledContainer.parentNode;
                
                // Insere DEPOIS do contentor
                if (styledContainer.nextSibling) {
                    parent.insertBefore(zeroWidthSpace, styledContainer.nextSibling);
                } else {
                    parent.appendChild(zeroWidthSpace);
                }
                
                // Move o cursor para a barreira, FORA do link
                const newRange = document.createRange();
                newRange.setStartAfter(zeroWidthSpace); // P√µe depois da barreira
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
                
                // A letra digitada ser√° inserida na nova posi√ß√£o do cursor (fora)
            }
        }
    }
    
    // =========================================================================
    // CEN√ÅRIO 3: Prote√ß√£o contra DELETE (Forward Delete)
    // =========================================================================
    // Impede que, ao clicar "Delete" no fim de um texto normal, se apague a fronteira
    // e o link seguinte seja "sugado" para dentro do texto atual.
    else if (event.key === 'Delete') {
         if (range.startOffset === currentNode.textContent.length) {
            const elementAfter = parentElement.nextElementSibling;
            
            // Se o pr√≥ximo elemento for um dos nossos especiais
            if (elementAfter && elementAfter.matches('.entity-link, .tag, a[data-anexo-id], .idea-span')) {
                event.preventDefault(); // Impede apagar
                
                // Foca no in√≠cio do elemento seguinte em vez de o apagar
                const newRange = document.createRange();
                
                // Tenta encontrar o primeiro n√≥ de texto l√° dentro para p√¥r o cursor
                let targetNode = elementAfter.firstChild;
                while(targetNode && targetNode.firstChild) targetNode = targetNode.firstChild;
                
                if (targetNode) {
                    newRange.setStart(targetNode, 0);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            }
        }
    }
}
    

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
function handleTextSelection() {
    const selectionPopup = document.getElementById('selection-popup');
    const insertionPopup = document.getElementById('insertion-popup');
    
    // 1. VERIFICA√á√ÉO DE TEXTO NORMAL
    const selection = window.getSelection();
    let hasStandardSelection = false;
    
    if (selection && selection.rangeCount > 0 && !selection.isCollapsed) {
        const anchorNode = selection.anchorNode;
        // Garante que o elemento faz parte do editor
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const isInEditor = noteContentEditor.contains(safeNode);
        
        if (isInEditor && selection.toString().trim().length > 0) {
            hasStandardSelection = true;
        }
    }

    // 2. VERIFICA√á√ÉO DE INPUTS
    let hasInputSelection = false;
    const activeEl = document.activeElement;
    if (activeEl && activeEl.tagName === 'INPUT' && activeEl.classList.contains('mini-note-title-input') && noteContentEditor.contains(activeEl)) {
        if (activeEl.selectionStart !== activeEl.selectionEnd) {
            hasInputSelection = true;
        }
    }

    // =========================================================
    // L√ìGICA DE VISIBILIDADE
    // =========================================================

    // A. ESCONDER MENU DE INSER√á√ÉO (üìò) se houver sele√ß√£o
    if (hasStandardSelection || hasInputSelection) {
        if (insertionPopup) insertionPopup.style.display = 'none';
    }

    // B. MOSTRAR MENU DE FORMATA√á√ÉO (üîó üé¥)
    if (hasStandardSelection) {
        
        // --- L√ìGICA INTELIGENTE DO BOT√ÉO üé¥ (CART√ÉO WEB) ---
        const btnCard = selectionPopup.querySelector('button[data-action="create-url-card"]');
        if (btnCard) {
            const selectedText = selection.toString().trim();
            
            // 1. Verifica se o texto parece um URL (Regex)
            // Aceita: http://, https://, www. ou dom√≠nios comuns (ex: sicnoticias.pt)
            const urlRegex = /^(https?:\/\/|www\.)|[\w-]+\.[a-z]{2,}(\/.*)?$/i;
            const looksLikeUrl = urlRegex.test(selectedText);

            // 2. Verifica se a sele√ß√£o est√° DENTRO de um link <a> existente
            let isInsideLink = false;
            if (selection.anchorNode) {
                const anchorEl = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
                isInsideLink = !!anchorEl.closest('a');
            }

            // Decis√£o: Mostra ou Esconde o üé¥
            if (looksLikeUrl || isInsideLink) {
                btnCard.style.display = 'flex'; // Mostra
            } else {
                btnCard.style.display = 'none'; // Esconde
            }
        }
        // -----------------------------------------------------

        currentSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = currentSelectionRange.getBoundingClientRect();
        
        if (selectionPopup) {
            selectionPopup.style.display = 'flex';
            
            // Posicionamento
            const topPos = rect.bottom + window.scrollY + 8;
            const leftPos = rect.left + (rect.width / 2) - (selectionPopup.offsetWidth / 2) + window.scrollX;

            selectionPopup.style.top = `${topPos}px`;
            selectionPopup.style.left = `${leftPos}px`;
            selectionPopup.style.zIndex = '2000';
        }
    } 
    // C. NENHUMA SELE√á√ÉO
    else {
        if (selectionPopup && !selectionPopup.matches(':hover')) {
            selectionPopup.style.display = 'none';
        }
    }
}
// ====================================================================



// ====================================================================
// NAVEGA√á√ÉO MOBILE: FECHAR LISTA AO CLICAR NO VAZIO
// ====================================================================



function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.seconds) {
            return 'Data inv√°lida';
        }
        const date = new Date(timestamp.seconds * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    /**
     * Carrega e exibe a lista de backups para a nota atual.
     */
async function loadBackupsForNote() {
    if (!selectedNoteId) return;

    const listEl = document.getElementById('history-list-content');
    listEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar hist√≥rico...</span></div>';

    try {
        // 1. Carregar Backups Normais (Subcole√ß√£o)
        const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
        const qBackups = query(backupsRef, orderBy('timestamp', 'desc'));
        const backupsSnap = await getDocs(qBackups);

        // 2. Carregar Itens Ocultos (Campo no documento principal)
        const noteDocRef = doc(db, 'pastas', selectedNoteId);
        const noteDocSnap = await getDoc(noteDocRef);
        const hiddenNotes = (noteDocSnap.exists() && noteDocSnap.data().subnotasocultas) 
                            ? noteDocSnap.data().subnotasocultas 
                            : {};

        listEl.innerHTML = '';

        // --- RENDERIZAR ITENS OCULTOS (RECICLAGEM) ---
        if (Object.keys(hiddenNotes).length > 0) {
            const headerNotes = document.createElement('h4');
            headerNotes.textContent = "üóëÔ∏è Reciclagem (Itens Ocultos)";
            headerNotes.style.marginTop = "0";
            headerNotes.style.color = "var(--text-muted-color)";
            headerNotes.style.borderBottom = "1px solid var(--border-color)";
            headerNotes.style.paddingBottom = "5px";
            listEl.appendChild(headerNotes);

            const sortedHidden = Object.values(hiddenNotes).sort((a, b) => {
                const timeA = a.deletedAt?.seconds || 0;
                const timeB = b.deletedAt?.seconds || 0;
                return timeB - timeA;
            });

            sortedHidden.forEach(note => {
                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                li.style.marginBottom = '6px';
                li.style.backgroundColor = 'var(--bg-color)'; 
                li.style.padding = '8px';
                li.style.borderRadius = '4px';

                // --- 1. L√ìGICA DE CORES E √çCONES ---
                let borderColor, icon, label, labelColor, displayTitle;

                // >>> NOVO: SUPORTE A TOGGLE <<<
                if (note.tipo === 'toggle') {
                    // ROXO (Para distinguir)
                    borderColor = '#9b59b6'; 
                    icon = '‚òÇ';
                    label = 'Sec√ß√£o Expans√≠vel';
                    labelColor = '#9b59b6';
                    displayTitle = note.titulo || "Toggle Sem T√≠tulo";
                }
                else if (note.tipo === 'question') {
                    borderColor = '#2ecc71'; icon = 'üìó'; label = 'Quest√£o'; labelColor = '#2ecc71';
                    displayTitle = note.titulo || "Sem T√≠tulo";
                } 
                else if (note.tipo === 'free') {
                    borderColor = '#e67e22'; icon = 'üìô'; label = 'Contentor'; labelColor = '#e67e22';
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = note.conteudo || "";
                    const plainText = tempDiv.textContent || "";
                    const words = plainText.trim().split(/\s+/);
                    if (words.length > 0 && words[0] !== "") {
                        displayTitle = words.slice(0, 10).join(" ");
                        if (words.length > 10) displayTitle += "...";
                    } else {
                        displayTitle = "Contentor (Vazio)";
                    }
                } 
                else {
                    borderColor = '#3498db'; icon = 'üìò'; label = 'SubNota'; labelColor = '#3498db';
                    displayTitle = note.titulo || "Sem T√≠tulo";
                }

                // --- 2. DATA DE ELIMINA√á√ÉO ---
                let deletionDateStr = "Data desconhecida";
                if (note.deletedAt && note.deletedAt.seconds) {
                    const date = new Date(note.deletedAt.seconds * 1000);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    deletionDateStr = `${day}/${month} √†s ${hours}:${minutes}`;
                }

                // --- 3. HTML ---
                li.style.borderLeft = `4px solid ${borderColor}`;
                
                li.innerHTML = `
                    <div style="display:flex; flex-direction:column; padding-left: 8px; flex: 1; min-width: 0;">
                        <span style="font-weight:bold; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${displayTitle}
                        </span>
                        
                        <div style="display: flex; align-items: center; gap: 6px; margin-top: 3px;">
                            <span style="font-size: 0.75em; background-color: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; color: ${labelColor}; border: 1px solid ${labelColor};">
                                ${icon} ${label}
                            </span>
                            <small style="color:#666; font-size: 0.8em;">Apagado: ${deletionDateStr}</small>
                        </div>
                    </div>
                    
                    <button class="modal-btn primary" onclick="restoreHiddenMiniNote('${note.id}')" style="padding: 5px 12px; font-size: 0.8em; height: 32px; align-self: center; margin-left: 10px; flex-shrink: 0;">
                        Restaurar
                    </button>
                `;
                listEl.appendChild(li);
            });
            
            const hr = document.createElement('hr');
            hr.style.margin = "20px 0";
            hr.style.border = "0";
            hr.style.borderTop = "1px solid var(--border-color)";
            listEl.appendChild(hr);
        }

        // --- RENDERIZAR BACKUPS NORMAIS ---
        const headerBackups = document.createElement('h4');
        headerBackups.textContent = "üíæ Vers√µes Anteriores da Nota";
        listEl.appendChild(headerBackups);

        if (backupsSnap.empty) {
            const emptyLi = document.createElement('li');
            emptyLi.textContent = "Nenhum backup de vers√£o encontrado.";
            emptyLi.style.fontStyle = "italic";
            emptyLi.style.color = "var(--text-muted-color)";
            listEl.appendChild(emptyLi);
        } else {
            backupsSnap.forEach(doc => {
                const backup = { id: doc.id, ...doc.data() };
                const li = document.createElement('li');
                li.style.justifyContent = 'space-between';
                const backupDate = formatTimestamp(backup.timestamp);
                
                li.innerHTML = `
                    <span>Vers√£o de ${backupDate}</span>
                    <div style="display:flex; gap: 5px;">
                        <button class="modal-btn secondary" data-action="view" data-backup-id="${backup.id}" style="padding: 5px 10px;">Ver</button>
                        <button class="modal-btn primary" data-action="restore" data-backup-id="${backup.id}" style="padding: 5px 10px;">Restaurar</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }

    } catch (error) {
        console.error("Erro ao carregar hist√≥rico:", error);
        listEl.innerHTML = '<li>Ocorreu um erro ao carregar os dados.</li>';
    }
}
    

    /**
     * Abre o modal de hist√≥rico e configura os seus eventos.
     */
    async function openHistoryModal() {
        if (!selectedNoteId) {
            alert("Por favor, selecione uma nota primeiro.");
            return;
        }

        const modal = document.getElementById('history-modal');
        const titleEl = document.getElementById('history-modal-title');
        const backupBtn = document.getElementById('backup-now-btn');
        
        titleEl.textContent = `Hist√≥rico de "${noteTitleInput.value}"`;
        
        // Remove listener antigo para evitar duplicados e adiciona um novo
        const newBackupBtn = backupBtn.cloneNode(true);
        backupBtn.parentNode.replaceChild(newBackupBtn, backupBtn);
        newBackupBtn.onclick = async () => {
            newBackupBtn.disabled = true;
            newBackupBtn.textContent = 'A criar backup...';
            try {
                const backupsRef = collection(db, 'pastas', selectedNoteId, 'backups');
                await addDoc(backupsRef, {
                    titulo: noteTitleInput.value,
                    conteudo: noteContentEditor.innerHTML,
                    timestamp: serverTimestamp()
                });
                await loadBackupsForNote(); // Atualiza a lista
            } catch (error) {
                console.error("Erro ao criar backup:", error);
                alert("Ocorreu um erro ao criar o backup.");
            } finally {
                newBackupBtn.disabled = false;
                newBackupBtn.textContent = 'Fazer backup do estado atual';
            }
        };

        modal.style.display = 'flex';
        await loadBackupsForNote();
    }

    /**
     * Restaura um backup criando uma nova nota.
     * @param {string} backupId O ID do documento de backup.
     */
    async function restoreBackup(backupId) {
        if (!selectedNoteId) return;
        
        try {
            // 1. Obter os dados do backup
            const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
            const backupSnap = await getDoc(backupRef);
            if (!backupSnap.exists()) {
                throw new Error("Backup n√£o encontrado.");
            }
            const backupData = backupSnap.data();

            // 2. Obter o parentId da nota original
            const originalNoteRef = doc(db, 'pastas', selectedNoteId);
            const originalNoteSnap = await getDoc(originalNoteRef);
            if (!originalNoteSnap.exists()) {
                throw new Error("Nota original n√£o encontrada.");
            }
            const parentId = originalNoteSnap.data().parentId;
            
            // 3. Formatar o novo t√≠tulo
            const backupDate = formatTimestamp(backupData.timestamp);
            const newTitle = `${backupData.titulo} (Restaurado de ${backupDate})`;

            // 4. Determinar a ordem da nova nota
            const q = query(collection(db, 'pastas'), where('parentId', '==', parentId), where('estado', '==', 'ativa'));
            const siblingsSnap = await getDocs(q);
            const newOrder = siblingsSnap.size;

            // 5. Criar a nova nota
            await addDoc(collection(db, 'pastas'), {
                nome: newTitle,
                conteudo: backupData.conteudo,
                parentId: parentId,
                tipo: 'nota',
                userId: auth.currentUser.uid, 
                estado: 'ativa',
                ordem: newOrder,
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            alert(`Nota restaurada com sucesso como "${newTitle}".\nA lista de notas ser√° atualizada.`);
            document.getElementById('history-modal').style.display = 'none';

        } catch (error) {
            console.error("Erro ao restaurar backup:", error);
            alert("Ocorreu um erro ao restaurar o backup.");
        }
    }

    /**
     * Exibe o conte√∫do de um backup num modal de visualiza√ß√£o.
     * @param {string} backupId O ID do documento de backup.
     */
    async function viewBackup(backupId) {
        if (!selectedNoteId) return;

        try {
            const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
            const backupSnap = await getDoc(backupRef);
            if (!backupSnap.exists()) {
                throw new Error("Backup n√£o encontrado.");
            }
            const backupData = backupSnap.data();
            
            const modal = document.getElementById('view-backup-modal');
            const titleEl = document.getElementById('view-backup-title');
            const contentEl = document.getElementById('view-backup-content');

            const backupDate = formatTimestamp(backupData.timestamp);
            titleEl.textContent = `Visualizando Backup de ${backupDate}`;
            // Usar textContent para evitar renderiza√ß√£o de HTML malicioso
            contentEl.textContent = backupData.conteudo.replace(/<[^>]*>/g, ''); // Remove tags HTML para visualiza√ß√£o simples
            
            modal.style.display = 'flex';

        } catch (error) {
            console.error("Erro ao visualizar backup:", error);
            alert("Ocorreu um erro ao carregar o conte√∫do do backup.");
        }
    }
    


// ====================================================================
// L√ìGICA DE MOVIMENTO DAS CAIXAS (üî∫ üîª)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    // S√≥ nos interessa se for um dos bot√µes de movimento
    if (action !== 'move-up' && action !== 'move-down') return;

    e.preventDefault(); e.stopPropagation();

    // 1. Identificar a Caixa (Wrapper) e o Pai (Editor)
    const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
    
    if (!wrapper) return;
    const parent = wrapper.parentNode;

    // 2. A√ß√£o MOVER PARA CIMA
    if (action === 'move-up') {
        const prevElement = wrapper.previousElementSibling;
        
        if (prevElement) {
            // Verifica se o elemento anterior √© um "div de espa√ßamento" (aqueles com height: 20px)
            // Se for, queremos saltar por cima dele tamb√©m para chegar ao conte√∫do real
            let target = prevElement;
            if (target.style.height === '20px' && target.previousElementSibling) {
                target = target.previousElementSibling;
            }

            // Move o wrapper para antes do alvo
            parent.insertBefore(wrapper, target);
            
            // Scroll suave para acompanhar o movimento
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            saveNote();
        }
    }

    // 3. A√ß√£o MOVER PARA BAIXO
    else if (action === 'move-down') {
        const nextElement = wrapper.nextElementSibling;
        
        if (nextElement) {
            // Mesma l√≥gica: saltar espa√ßadores vazios se existirem
            let target = nextElement;
            if (target.style.height === '20px' && target.nextElementSibling) {
                target = target.nextElementSibling;
            }

            // Para mover para baixo, inserimos o elemento SEGUINTE antes do ATUAL
            // (Basicamente trocamos a ordem)
            // Ou inserimos o ATUAL depois do SEGUINTE (usando nextSibling do seguinte)
            parent.insertBefore(wrapper, target.nextSibling);

            // Scroll suave
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            saveNote();
        }
    }
});


// ====================================================================
// GESTOR DE LINHA CRONOL√ìGICA (TIMELINE)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    // 1. Adicionar Ponto
    if (e.target.classList.contains('t-btn-add')) {
        e.preventDefault(); e.stopPropagation();
        
        const wrapper = e.target.closest('.jwn-timeline-wrapper');
        const container = wrapper.querySelector('.timeline-container');
        
        const newEntry = document.createElement('div');
        newEntry.className = 'timeline-entry';
        newEntry.innerHTML = `
            <div class="t-marker"></div>
            <div class="t-date" contenteditable="true">Nova Data</div>
            <div class="t-text" contenteditable="true">Novo evento...</div>
            <button class="t-btn-del" title="Remover Ponto">√ó</button>
        `;
        
      container.appendChild(newEntry);

// --- SUBSTITUI ESTA PARTE DO SETTIMEOUT ---
setTimeout(() => {
    const dateField = newEntry.querySelector('.t-date');
    dateField.focus();

    // Cria uma sele√ß√£o precisa apenas no texto da data
    const range = document.createRange();
    range.selectNodeContents(dateField);
    
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
}, 10);
// ------------------------------------------

saveNote();
    }
    
    // 2. Remover Ponto
    else if (e.target.classList.contains('t-btn-del')) {
        e.preventDefault(); e.stopPropagation();
        
        const entry = e.target.closest('.timeline-entry');
        const container = entry.parentElement;
        
        // Se for o √∫ltimo ponto, pergunta se quer apagar a timeline toda
        if (container.children.length <= 1) {
            if (confirm("Apagar toda a Linha Cronol√≥gica?")) {
                entry.closest('.jwn-timeline-wrapper').remove();
            }
        } else {
            entry.remove();
        }
        
        saveNote();
    }
});



    // --- EVENT LISTENER MODIFICADO ---







    // --- NOVO LISTENER PARA O DROPDOWN DE ZOOM ---
    const zoomSelect = document.getElementById('editor-zoom');
    if (zoomSelect) {
        zoomSelect.addEventListener('change', () => {
            const selectedValue = zoomSelect.value;
            
            // 1. Aplica o tamanho ao contentor principal
            noteContentEditor.style.fontSize = selectedValue;
            
            // 2. LIMPEZA PROFUNDA: Remove tamanhos fixos antigos de todo o texto dentro da nota
            const elementsWithFixedSize = noteContentEditor.querySelectorAll('*');
            
            elementsWithFixedSize.forEach(el => {
                // Remove estilo inline de font-size (ex: style="font-size: 18px")
                if (el.style.fontSize) {
                    el.style.fontSize = ''; 
                }
                // Remove a tag antiga <font size="..."> se existir (usada por alguns browsers antigos)
                if (el.tagName === 'FONT') {
                    el.removeAttribute('size');
                }
            });

            // 3. Ajuste da altura da linha para ficar leg√≠vel
            if (selectedValue.includes('%')) {
                 noteContentEditor.style.lineHeight = '1.6';
            } else {
                 // C√°lculo para pixels (1.5x o tamanho da fonte)
                 const sizeNum = parseInt(selectedValue);
                 noteContentEditor.style.lineHeight = (sizeNum * 1.5) + 'px';
            }
        });
    }



    // --- NOVO EVENT LISTENER PARA O MODAL DE HIST√ìRICO ---
    
    document.getElementById('history-list-content').addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        
        const action = button.dataset.action;
        const backupId = button.dataset.backupId;

        if (action === 'restore') {
            restoreBackup(backupId);
        } else if (action === 'view') {
            viewBackup(backupId);
        }
    });


// --- EVENT LISTENERS ---

// Listeners de Conectividade e Sa√≠da
window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);
window.addEventListener('beforeunload', (event) => {
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        
        // TENTA disparar a grava√ß√£o no √∫ltimo milissegundo
        // (Nota: Sem 'await', √© um "tiro no escuro", mas ajuda se o user demorar a clicar em "Sair")
        executeSave(); 

        // O aviso √© NECESS√ÅRIO para dar tempo √† internet de processar o comando acima
        event.preventDefault();
        event.returnValue = ''; 
        return '';
    }
});

// Listeners de Navega√ß√£o (Protegidos pelo Gatekeeper)


 leftPanelList.addEventListener('click', async (e) => {
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) { showContextMenu(e); return; }
    
    const listItem = e.target.closest('.list-item');
    if (!listItem) return;

    // --- L√≥gica MODO LISTS (Categorias) ---
    if (currentTab === 'lists') {
        const type = listItem.dataset.type;
        const id = listItem.dataset.id;
        const name = listItem.textContent;

        if (type === 'list-category' || type === 'list-bible-root') {
            
            // 1. NOVA LINHA: For√ßa grava√ß√£o imediata
            if (currentSaveStatus === 'unsaved') {
                saveNote(true);
            }

            navigationStack = [{ type: type, id: id, name: name }];
            document.querySelectorAll('#left-panel-list .list-item').forEach(el => el.classList.remove('selected'));
            listItem.classList.add('selected');
            
            // 2. ALTERA√á√ÉO IMPORTANTE: Adicionado 'true' para N√ÉO fechar a nota
            updateNavigationView(true); 
        }
        return;
    }


    // --- MODO NOTE (Pastas e Notas) ---
    const { id, name, type } = listItem.dataset;

    // ============================================================
    // CASO 1: √â UMA PASTA
    // ============================================================
     if (type === 'pasta') {
        if (listItem.classList.contains('selected')) return;

        // A. L√≥gica de Superpasta
        const isSuperfolder = listItem.dataset.superpasta === "true";

        if (isSuperfolder) {
            // Verifica Prote√ß√£o antes de redirecionar
            if (listItem.hasAttribute('data-protected')) {
                if (!sessionUnlockedFolders.has(id)) {
                    const accessGranted = await requestPassword('access', id);
                    if (accessGranted) {
                        sessionUnlockedFolders.add(id);
                        // Remove cadeado visualmente
                        const textSpan = listItem.querySelector('span');
                        if(textSpan && textSpan.textContent.includes('üîí')) {
                            textSpan.textContent = textSpan.textContent.replace('üîí ', '');
                        }
                    } else {
                        return; // Senha errada
                    }
                }
            }
            
            // >>> ALTERA√á√ÉO AQUI: Envolver na verifica√ß√£o de grava√ß√£o <<<
            navigateWithUnsavedCheck(() => {
                window.location.href = `superpasta.html?rootId=${id}`;
            });
            return;
        }

        // B. Pasta Normal (Verifica Prote√ß√£o)
        if (listItem.hasAttribute('data-protected')) {
            if (!sessionUnlockedFolders.has(id)) {
                const accessGranted = await requestPassword('access', id);
                if (accessGranted) {
                    sessionUnlockedFolders.add(id);
                    const textSpan = listItem.querySelector('span');
                    if(textSpan && textSpan.textContent.includes('üîí')) {
                        textSpan.textContent = textSpan.textContent.replace('üîí ', '');
                    }
                } else {
                    return;
                }
            }
        }

        // C. Navega√ß√£o (Entrar na pasta)
        if (selectedNoteId) {
            // Se j√° temos uma nota aberta, atualiza apenas o meio
            updateMiddlePanelForFolderSelection(id, name, listItem);
        } else {
            // Navega√ß√£o padr√£o
            const action = () => {
                if (navigationStack.length > 0) navigationStack.pop();
                navigationStack.push({ id: id, name: name });
                updateNavigationView();
            };
            navigateWithUnsavedCheck(action);
        }
    }

    // ============================================================
    // CASO 2: √â UMA NOTA (NOVO!)
    // ============================================================
  else if (type === 'nota') {
        
        // LOG DE DEBUG PARA VERIFICAR O CLIQUE
        console.log("Tentativa de abrir nota:", id, "| Nota Atual:", selectedNoteId);

        // 1. VERIFICA SE √â A MESMA NOTA
        if (id === selectedNoteId) {
            console.log(">> √â A MESMA NOTA! A for√ßar abertura...");

            // Remove a vista da lista
            document.body.classList.remove('mobile-view-middle');
            // Adiciona a vista do editor
            document.body.classList.add('mobile-view-editor');
            
            return; // Sai da fun√ß√£o (sucesso)
        }

        // 2. SE FOR UMA NOTA DIFERENTE (Verifica senha)
        if (listItem.hasAttribute('data-protected')) {
            if (!sessionUnlockedFolders.has(id)) {
                const accessGranted = await requestPassword('access', id);
                if (accessGranted) {
                    sessionUnlockedFolders.add(id);
                    // Remove cadeado visualmente (opcional)
                    const textSpan = listItem.querySelector('span');
                    if(textSpan && textSpan.textContent.includes('üîí')) {
                        textSpan.textContent = textSpan.textContent.replace('üîí ', '');
                    }
                } else {
                    return; // Senha errada
                }
            }
        }
        
        // 3. CARREGA A NOVA NOTA DO FIREBASE
        const action = () => displayNote(id, listItem);
        navigateWithUnsavedCheck(action);
    }
});

// ====================================================================
// LISTENER UNIFICADO DO PAINEL DO MEIO (LISTA)
// ====================================================================
const middlePanel = document.getElementById('middle-panel');

if (middlePanel) {
    middlePanel.addEventListener('click', async (e) => {
        
        // 1. PRIORIDADE M√ÅXIMA: Bot√µes de sistema e Menu de Contexto
        const itemMenuBtn = e.target.closest('.item-menu-btn');
        if (itemMenuBtn) { showContextMenu(e); return; }

        if (e.target.closest('button')) return; // Deixa os bot√µes (Voltar, +, Toggle) funcionarem

        // 2. L√ìGICA MOBILE: VOLTAR √Ä NOTA (FECHAR A LISTA)
        // Funciona se clicar no vazio OU na nota que j√° est√° aberta
        if (window.innerWidth <= 768 && selectedNoteId) {
            
            const clickedItem = e.target.closest('.list-item');
            const clickedInput = e.target.closest('input');
            const clickedFilter = e.target.closest('.filter-bar');
            const clickedSearch = e.target.closest('.list-search-container');

            let shouldReturnToEditor = false;

            // CASO A: Clicou no vazio (n√£o acertou em nenhum item interativo)
            if (!clickedItem && !clickedInput && !clickedFilter && !clickedSearch) {
                shouldReturnToEditor = true;
            }
            
            // CASO B: Clicou na MESMA NOTA que j√° est√° aberta
            else if (clickedItem && clickedItem.dataset.type === 'nota' && clickedItem.dataset.id === selectedNoteId) {
                shouldReturnToEditor = true;
            }

            // A√á√ÉO: Esconde a lista e mostra o editor
            if (shouldReturnToEditor) {
                e.preventDefault();
                e.stopPropagation();
                console.log(">> Mobile: A regressar ao editor...");
                document.body.classList.remove('mobile-view-middle');
                document.body.classList.add('mobile-view-editor');
                return; // P√°ra aqui, n√£o carrega nada
            }
        }

        // 3. L√ìGICA DE NAVEGA√á√ÉO (Desktop ou Novos Itens no Mobile)
        const listItem = e.target.closest('.list-item');
        if (!listItem) return; // Se n√£o clicou num item da lista, n√£o faz mais nada

        // 3.1. T√≥picos (√Årvore)
        const topicTarget = e.target.closest('[data-type="topic-detail"], [data-type="subtopic-detail"]');
        if (topicTarget) {
            document.querySelectorAll('#file-list .selected-text').forEach(el => el.classList.remove('selected-text'));
            topicTarget.classList.add('selected-text'); 
            const { id, name, desc, type } = topicTarget.dataset;
            showTopicReferencesPanel(id, name, desc, type === 'topic-detail' ? 'topico' : 'subtopico');
            return;
        }

        // 3.2. Listas Especiais (Categorias)
        if (currentTab === 'lists') {
            const type = listItem.dataset.type;
            if (type === 'bible-book') {
                const bookName = listItem.dataset.bookName;
                navigationStack.push({ type: 'bible-book', id: bookName, name: bookName });
                updateNavigationView();
            } else if (type === 'entity-item') {
                document.querySelectorAll('#file-list .list-item.selected').forEach(el => el.classList.remove('selected'));
                listItem.classList.add('selected');
                const { entityId, entityName, entityType } = listItem.dataset;
                showReferencesPanel(entityId, entityName, entityType);
            } else if (listItem.dataset.type === 'highlight-item') {
                document.querySelectorAll('#file-list .list-item.selected').forEach(el => el.classList.remove('selected'));
                listItem.classList.add('selected');
                showHighlightReferencesPanel(listItem.dataset.hex, listItem.dataset.name);
            }
            return;
        }

        // 3.3. Pastas e Notas Normais
        const { id, type, name } = listItem.dataset;

        // SE FOR PASTA
        if (type === 'pasta' || type === 'agregacao') {
            const isSuperfolder = listItem.dataset.superpasta === "true";

            if (isSuperfolder) {
                if (listItem.hasAttribute('data-protected') && !sessionUnlockedFolders.has(id)) {
                    const access = await requestPassword('access', id);
                    if (access) sessionUnlockedFolders.add(id); else return;
                }
                navigateWithUnsavedCheck(() => { window.location.href = `superpasta.html?rootId=${id}`; });
                return;
            }

            if (listItem.hasAttribute('data-protected') && !sessionUnlockedFolders.has(id)) {
                const access = await requestPassword('access', id);
                if (access) sessionUnlockedFolders.add(id); else return;
            }

            const action = () => {
                navigationStack.push({ id, name });
                updateNavigationView();
            };
            navigateWithUnsavedCheck(action);
        } 
        
        // SE FOR UMA NOTA NOVA (A mesma nota j√° foi tratada no passo 2)
        else if (type === 'nota') {
            if (listItem.hasAttribute('data-protected') && !sessionUnlockedFolders.has(id)) {
                const access = await requestPassword('access', id);
                if (access) sessionUnlockedFolders.add(id); else return;
            }
            
            const action = () => {
                // Garante troca de ecr√£ no mobile para notas novas
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.add('mobile-view-editor');
                }
                displayNote(id, listItem);
            };
            navigateWithUnsavedCheck(action);
        }
    });
}

// ====================================================================
// FUN√á√ÉO: MOSTRAR REFER√äNCIAS DE DESTAQUE (4¬™ COLUNA)
// ====================================================================
async function showHighlightReferencesPanel(hexCode, colorName) {
    // 1. Gravar antes de mudar
    await forceSaveAndClosePuzzleMode();

    // 2. Configura√ß√£o Visual
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // For√ßar aba "Refer√™ncias"
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Esconder bot√µes irrelevantes
    document.getElementById('references-wol-btn').style.display = 'none';
    document.getElementById('references-bookmark-btn').style.display = 'none';

    notebookContainer.classList.add('references-panel-visible');
    
    // T√≠tulo com a bolinha da cor
    const titleEl = document.getElementById('references-panel-title');
    titleEl.innerHTML = `
        <span style="display:inline-block; width:15px; height:15px; background:${hexCode}; border-radius:50%; border:1px solid #ccc; margin-right:5px; vertical-align:middle;"></span>
        ${colorName}
    `;
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar destaques...</span>
        </div>`;

    try {
        // 3. Query Eficiente (Busca notas que usam esta cor)
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            where('coresUsadas', 'array-contains', hexCode)
        );

        const snapshot = await getDocs(q);
        const results = [];
        const parser = new DOMParser();

        // 4. Processar Resultados
        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            
            // Seguran√ßa
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            // (Verifica√ß√£o de pai simplificada, podes adicionar se quiseres)
            if (isItemProtected && !appSettings.searchTagsInProtected) continue;

            // 5. PARSE DO HTML
            const docHTML = parser.parseFromString(data.conteudo, 'text/html');
            
            // Procura QUALQUER elemento com esta cor (Caixas ou Toggles)
            const coloredElements = docHTML.querySelectorAll(`[data-highlight="${hexCode}"]`);
            
            coloredElements.forEach(el => {
                let displayTitle = "Sem T√≠tulo";
                let displayIcon = "üü¶"; // Padr√£o
                let snippet = "";
                let contextType = "Item";

                // --- CEN√ÅRIO A: √â um TOGGLE (T√≠tulo Expans√≠vel) ---
                if (el.tagName === 'DETAILS' && el.classList.contains('toggle-section')) {
                    displayIcon = "‚òÇ";
                    contextType = "Toggle";
                    const h2 = el.querySelector('h2');
                    displayTitle = h2 ? h2.textContent : "T√≠tulo Expans√≠vel";
                    // Tenta pegar um pouco do conte√∫do
                    const contentDiv = el.querySelector('.toggle-content');
                    snippet = contentDiv ? contentDiv.textContent.trim().substring(0, 60) + "..." : "";
                }
                // --- CEN√ÅRIO B: √â uma CAIXA (Quest√£o/Subnota) ---
                else if (el.classList.contains('mini-note-wrapper')) {
                    const titleInput = el.querySelector('.mini-note-title-input');
                    const contentDiv = el.querySelector('.mini-note-content');

                    if (el.classList.contains('question-mode')) {
                        displayIcon = "üìó";
                        contextType = "Quest√£o";
                        displayTitle = titleInput ? titleInput.value : "Quest√£o";
                    } else if (el.classList.contains('free-mode')) {
                        displayIcon = "üìô";
                        contextType = "Contentor";
                        const txt = contentDiv ? contentDiv.textContent.trim() : "";
                        displayTitle = txt.length > 40 ? txt.substring(0, 40) + "..." : (txt || "Contentor");
                    } else {
                        displayIcon = "üìò"; // Subnota normal
                        contextType = "SubNota";
                        displayTitle = titleInput ? titleInput.value : "SubNota";
                    }

                    if (!snippet && contentDiv) {
                        snippet = contentDiv.textContent.trim().substring(0, 80) + "...";
                    }
                }

                // Fallback se o t√≠tulo estiver vazio
                if (!displayTitle || displayTitle.trim() === "") displayTitle = `(Sem T√≠tulo)`;

                results.push({
                    noteId: docSnap.id,
                    noteName: data.nome,
                    displayTitle: displayTitle,
                    displayIcon: displayIcon,
                    contextType: contextType,
                    parentId: data.parentId,
                    isProtected: isItemProtected,
                    snippet: snippet
                });
            });
        }

        // 6. Renderizar
        listElement.innerHTML = '';
        
        if (results.length === 0) {
            listElement.innerHTML = '<li style="padding:15px; color:#888;">Nenhuma caixa encontrada com esta cor.</li>';
            return;
        }

        // Ordenar: Primeiro por Tipo, depois por T√≠tulo
        results.sort((a, b) => {
            if (a.contextType !== b.contextType) return a.contextType.localeCompare(b.contextType);
            return a.displayTitle.localeCompare(b.displayTitle);
        });

        results.forEach(item => {
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            // Borda com a cor do destaque para identifica√ß√£o r√°pida
            details.style.borderLeft = `3px solid ${hexCode}`;
            
            const summary = document.createElement('summary');
            // Estilo do summary para suportar o layout flex
            summary.style.listStyle = "none"; 
            
            const protectedIcon = item.isProtected ? "üîí " : "";
            
            // Bot√£o Ir Para
            const goToBtn = `<button class="go-to-note-btn" 
                data-note-id="${item.noteId}" 
                data-parent-id="${item.parentId || ''}" 
                data-search-term="${item.displayTitle}"
                title="Ir para nota">‚ûî</button>`;

            // Layout: T√≠tulo da Caixa em Cima, Nome da Nota em Baixo
            summary.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:500; color:var(--text-color);">${item.displayIcon} ${item.displayTitle}</span>
                        ${goToBtn}
                    </div>
                    <small style="color:var(--text-muted-color); margin-top:2px;">em üìÑ ${protectedIcon}${item.noteName}</small>
                </div>
            `;
            
            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            contextDiv.innerHTML = `<p>${item.snippet || "Sem conte√∫do de texto."}</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias de cor:", error);
        listElement.innerHTML = '<li>Erro ao processar dados.</li>';
    }
}

function checkToolbarStatus() {
    // 1. Pergunta ao browser o estado da formata√ß√£o atual
    const isBold = document.queryCommandState('bold');
    const isItalic = document.queryCommandState('italic');
    const isUnderline = document.queryCommandState('underline');

    // 2. Fun√ß√£o auxiliar para ligar/desligar a classe visual
    const toggleBtn = (selector, isActive) => {
        // Seleciona tanto os bot√µes da barra principal como das mini-notas
        const btns = document.querySelectorAll(selector);
        btns.forEach(btn => {
            if (isActive) btn.classList.add('active-tool');
            else btn.classList.remove('active-tool');
        });
    };

    // 3. Atualiza os bot√µes (considerando os dois tipos de data-attribute que usamos)
    // Para Negrito
    toggleBtn('button[data-command="bold"]', isBold);
    toggleBtn('button[data-cmd="bold"]', isBold);

    // Para It√°lico
    toggleBtn('button[data-command="italic"]', isItalic);
    toggleBtn('button[data-cmd="italic"]', isItalic);

    // Para Sublinhado
    toggleBtn('button[data-command="underline"]', isUnderline);
    toggleBtn('button[data-cmd="underline"]', isUnderline);
}

// --- LIGAR O DETETOR ---
// O evento 'selectionchange' dispara sempre que move o cursor ou clica no texto
document.addEventListener('selectionchange', checkToolbarStatus);


document.querySelector('.tabs-container').addEventListener('click', (e) => {
    const clickedTabBtn = e.target.closest('button');
    if (!clickedTabBtn) return;

    const newTab = clickedTabBtn.dataset.tab;
    
    if (newTab === 'book') {
        window.open('book.html', '_blank'); 
        return; 
    }

    if (currentSaveStatus === 'unsaved') {
        saveNote(true); // Grava imediatamente
    }

    // 1. Atualiza√ß√£o Visual dos Bot√µes
    document.querySelectorAll('.tabs-container button').forEach(btn => btn.classList.remove('active'));
    clickedTabBtn.classList.add('active');
    
    // 2. Atualiza o estado da aba atual
    currentTab = newTab;
    
    // 3. Limpa a pilha de navega√ß√£o
    navigationStack = []; 
    
    // 4. Atualiza a vista mantendo o editor aberto (true)
    updateNavigationView(true);
});


// Listeners do Editor
noteTitleInput.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
noteContentEditor.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
document.addEventListener('selectionchange', handleTextSelection);

  noteContentEditor.addEventListener('keydown', (event) => {
    escapeStyledElements(event); // Mant√©m a fun√ß√£o original

    if (isTagPopupOpen) {
        if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
            event.preventDefault();
            navigateTagSuggestions(event.key);
        } else if (['Enter', 'Tab'].includes(event.key)) { // Removi o ' ' e ','
            event.preventDefault();
            commitTagSelection();
        }
    } else if (isEntityPopupOpen) {
        if (['ArrowUp', 'ArrowDown'].includes(event.key)) {
            event.preventDefault();
            navigateEntitySuggestions(event.key);
        } else if (['Enter', 'Tab'].includes(event.key)) {
            event.preventDefault();
            commitEntitySelection();
        }
    }
});

// ====================================================================
// L√ìGICA DE CORES DO TOGGLE
// ====================================================================
let activeToggleForColor = null;
const toggleColorPopup = document.getElementById('toggle-color-popup');

// 1. Abrir o Popup ao clicar no Pincel
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('.toggle-color-btn');
    if (!colorBtn) return;

    e.preventDefault(); e.stopPropagation();

    // Identifica o Toggle
    activeToggleForColor = colorBtn.closest('details.toggle-section');
    
    // Posiciona o Popup
    const rect = colorBtn.getBoundingClientRect();
    toggleColorPopup.style.display = 'block';
    toggleColorPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
    // Alinha para n√£o sair do ecr√£ √† direita
    toggleColorPopup.style.left = `${(rect.left + window.scrollX) - 100}px`;
});

// 2. Escolher a Cor (Delegation no Popup)
toggleColorPopup.addEventListener('click', (e) => {
    e.stopPropagation(); // Impede fechar ao clicar dentro

    // Bot√£o de cor
    if (e.target.classList.contains('color-choice')) {
        if (activeToggleForColor) {
            const color = e.target.dataset.color;
            // Aplica a cor ao fundo do Toggle e do conte√∫do
            activeToggleForColor.style.backgroundColor = color;
            activeToggleForColor.style.borderColor = color;
            
            // Opcional: Ajustar a cor do texto para preto para garantir contraste
            activeToggleForColor.style.color = '#333333'; 
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '#000000';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
    
    // Bot√£o Reset (Sem Cor)
    else if (e.target.classList.contains('color-choice-reset')) {
        if (activeToggleForColor) {
            activeToggleForColor.style.backgroundColor = '';
            activeToggleForColor.style.borderColor = '';
            activeToggleForColor.style.color = ''; // Volta ao padr√£o
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
});

// 3. Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (toggleColorPopup.style.display !== 'none') {
        if (!toggleColorPopup.contains(e.target) && !e.target.closest('.toggle-color-btn')) {
            toggleColorPopup.style.display = 'none';
            activeToggleForColor = null;
        }
    }
});

// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
document.getElementById('generic-list-modal').addEventListener('click', (e) => {
    // Procura por um bot√£o de edi√ß√£o de anexo
    const editButton = e.target.closest('button[data-action="edit-anexo"]');
    if (editButton) {
        const anexoId = editButton.dataset.id;
        if (anexoId) {
            document.getElementById('generic-list-modal').style.display = 'none';
            openLinkModal(true, { id: anexoId });
        }
        return; // Termina a execu√ß√£o aqui
    }

    // <<<<<<< NOVO: Procura por um item de lista de tag clic√°vel >>>>>>>>>
    const tagListItem = e.target.closest('li[data-action="show-tag-references"]');
    if (tagListItem) {
        const tagName = tagListItem.dataset.tagName;
        if (tagName) {
            // 1. Fecha o modal de tags
            document.getElementById('generic-list-modal').style.display = 'none';
            // 2. Abre o painel de refer√™ncias para essa tag
            showTagReferencesPanel(tagName);
        }
    }
});


// ====================================================================
// 2. DETETAR CLIQUE NA IDEIA (Abrir Menu ‚úÇÔ∏è üß≤)
// ====================================================================
 let activeIdeaElement = null; 

noteContentEditor.addEventListener('click', (e) => {
    // Tenta encontrar o span da ideia onde clic√°mos
    const ideaSpan = e.target.closest('.idea-span');
    const ideaPopup = document.getElementById('idea-actions-popup');

    // Se clicou numa ideia
    if (ideaSpan) {
        // --- CORRE√á√ÉO DO ERRO ORTOGR√ÅFICO ---
        // For√ßa o navegador a ignorar erros ortogr√°ficos NESTE elemento espec√≠fico.
        // Isto remove o sublinhado vermelho e impede o menu nativo do browser de aparecer.
        if (ideaSpan.spellcheck !== false) {
            ideaSpan.spellcheck = false;
            // Opcional: for√ßa um "repaint" leve se o browser n√£o atualizar logo
            ideaSpan.setAttribute('spellcheck', 'false'); 
        }
        // -------------------------------------

        console.log("Ideia detetada:", ideaSpan.textContent); 

        // Guardamos a refer√™ncia globalmente
        activeIdeaElement = ideaSpan;

        // Calcula a posi√ß√£o para o menu aparecer logo abaixo do texto
        const rect = ideaSpan.getBoundingClientRect();
        
        ideaPopup.style.display = 'flex';
        ideaPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        ideaPopup.style.left = `${rect.left + window.scrollX}px`;
        
        // Impede que o clique se propague e ative outros listeners
        e.stopPropagation(); 
        e.preventDefault();
        return;
    } 
    
    // Se clicou fora, fecha o popup
    if (ideaPopup && ideaPopup.style.display === 'flex' && !e.target.closest('#idea-actions-popup')) {
        ideaPopup.style.display = 'none';
        activeIdeaElement = null;
    }
});

// ====================================================================
// 3. A√á√ïES DO MENU DA IDEIA (‚úÇÔ∏è e üß≤)
// ====================================================================
const ideaPopupElement = document.getElementById('idea-actions-popup');
if (ideaPopupElement) {
    ideaPopupElement.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeIdeaElement) return;

        e.stopPropagation(); // Impede fechar o menu ao clicar no bot√£o

        const action = btn.dataset.action;

        // --- A√á√ÉO ‚úÇÔ∏è: REMOVER IDEIA ---
        if (action === 'remove-idea') {
            const text = activeIdeaElement.textContent;
            const parent = activeIdeaElement.parentNode;
            
            // Substitui o span pelo texto simples
            const textNode = document.createTextNode(text);
            parent.replaceChild(textNode, activeIdeaElement);
            parent.normalize(); // Junta n√≥s de texto adjacentes

            saveNote();
            ideaPopupElement.style.display = 'none';
        }

        // --- A√á√ÉO üß≤: ADICIONAR A OUTRA NOTA ---
        else if (action === 'append-idea') {
            ideaPopupElement.style.display = 'none'; // Fecha o menu pequeno
            await openNoteSelectorForIdea();  // Abre o seletor de notas
        }
    });
}

// ====================================================================
// 4. FUN√á√ïES AUXILIARES PARA IDEIAS (Seletor e Transfer√™ncia)
// ====================================================================

// A. SELETOR DE NOTAS
async function openNoteSelectorForIdea() {
    if (!selectedNoteId) return;

    const modal = document.getElementById('select-note-modal');
    const list = document.getElementById('select-note-list');
    
    modal.style.display = 'flex';
    list.innerHTML = '<li>A carregar notas...</li>';

    try {
        // 1. Descobrir o parentId da nota atual
        const currentNoteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        const currentParentId = currentNoteSnap.exists() ? currentNoteSnap.data().parentId : null;

        // 2. Buscar todas as NOTAS (n√£o pastas) que est√£o na MESMA pasta
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', currentParentId),
            where('tipo', '==', 'nota'), // S√≥ queremos notas
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty || (snapshot.size === 1 && snapshot.docs[0].id === selectedNoteId)) {
            list.innerHTML = '<li>Nenhuma outra nota nesta pasta.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            // N√£o mostrar a pr√≥pria nota atual
            if (docSnap.id === selectedNoteId) return;

            const noteData = docSnap.data();
            const li = document.createElement('li');
            li.textContent = "üìÑ " + noteData.nome;
            li.style.cursor = 'pointer';
            li.style.padding = '10px';
            li.style.borderBottom = '1px solid var(--border-color)';
            
            // Ao clicar numa nota da lista
            li.onclick = () => transferIdeaToNote(docSnap.id, noteData);
            
            list.appendChild(li);
        });

    } catch (error) {
        console.error(error);
        list.innerHTML = '<li>Erro ao carregar notas.</li>';
    }
}

// B. TRANSFERIR O TEXTO
async function transferIdeaToNote(targetNoteId, targetNoteData) {
    if (!activeIdeaElement) return;

    const textToTransfer = activeIdeaElement.textContent;
    const modal = document.getElementById('select-note-modal');

    try {
        // Adiciona o texto ao final do conte√∫do existente da nota alvo
        const newContent = (targetNoteData.conteudo || "") + `<br><p>üí° ${textToTransfer}</p>`;

        const targetRef = doc(db, 'pastas', targetNoteId);
        await updateDoc(targetRef, {
            conteudo: newContent,
            ultimaedicao: serverTimestamp()
        });

        alert(`Ideia adicionada √† nota "${targetNoteData.nome}" com sucesso!`);
        modal.style.display = 'none';

    } catch (error) {
        console.error("Erro ao transferir:", error);
        alert("Erro ao adicionar ideia √† nota.");
    }
}


// 1. Abrir o Modal e Iniciar Navega√ß√£o
function openAggregationSelector() {
    const modal = document.getElementById('aggregation-modal');
    const nameSpan = document.getElementById('aggregation-new-name');
    
    // Reset das vari√°veis de navega√ß√£o do modal
    aggregationStack = []; 
    aggregationSelectedItems = [];
    updateAggregationCount();
    
    nameSpan.textContent = aggregationTargetName;
    modal.style.display = 'flex';
    
    // L√ìGICA ALTERADA:
    // Verifica se estamos numa Superpasta. Se sim, a "Raiz" √© a Superpasta.
    // Se n√£o, a "Raiz" √© null (In√≠cio absoluto).
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    // Carrega sempre a partir do in√≠cio, independentemente de onde vamos gravar a nota
    loadAggregationLevel(startRootId);
}

// 2. Carregar N√≠vel (Pastas e Notas)
async function loadAggregationLevel(parentId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    
    // Atualiza breadcrumbs
    if (aggregationStack.length > 0) {
        pathSpan.textContent = aggregationStack[aggregationStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathSpan.textContent = parentId ? "Pasta Atual" : "Pasta Raiz";
        backBtn.style.display = 'none'; // Se estamos na base, esconde voltar
    }

    try {
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', parentId),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('tipo'), // Pastas primeiro, depois notas (alfabeticamente depende do locale)
            orderBy('nome')
        );
        
        const snapshot = await getDocs(q);
        list.innerHTML = '';
        
        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Pasta vazia.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            
            const li = document.createElement('li');
            li.className = 'agreg-item';
            
            if (item.tipo === 'pasta') {
                li.classList.add('agreg-type-folder');
                li.innerHTML = `üìÅ ${item.nome}`;
                li.onclick = () => {
                    aggregationStack.push({ id: item.id, name: item.nome });
                    loadAggregationLevel(item.id);
                };
            } else if (item.tipo === 'nota') {
                li.classList.add('agreg-type-note');
                li.innerHTML = `üìÑ ${item.nome}`;
                li.onclick = () => {
                    // Ao clicar na nota, carregamos as caixas dentro dela
                    aggregationStack.push({ id: item.id, name: item.nome, type: 'nota' });
                    loadNoteBoxesForAggregation(item.id);
                };
            }
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar itens.</li>';
    }
}

// 3. Carregar Caixas dentro de uma Nota (Parsing HTML)
async function loadNoteBoxesForAggregation(noteId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');

    // Atualiza UI
    pathSpan.textContent = "üìÑ " + aggregationStack[aggregationStack.length - 1].name;
    backBtn.style.display = 'block';
    list.innerHTML = '<li style="padding:10px;">A analisar conte√∫do da nota...</li>';

    try {
        const noteDoc = await getDoc(doc(db, 'pastas', noteId));
        if (!noteDoc.exists()) return;

        const content = noteDoc.data().conteudo || "";
        
        // Parse do HTML da nota
        const parser = new DOMParser();
        const docHTML = parser.parseFromString(content, 'text/html');
        const wrappers = docHTML.querySelectorAll('.mini-note-wrapper');

        list.innerHTML = '';
        
        if (wrappers.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Esta nota n√£o tem Subnotas, Quest√µes ou Contentores.</li>';
            return;
        }

        wrappers.forEach((wrapper, index) => {
            // Extrair T√≠tulo
            let title = "Sem T√≠tulo";
            let typeClass = "";
            let typeLabel = "";

            // Detetar Tipo
            if (wrapper.classList.contains('question-mode')) {
                typeClass = "agreg-box-question";
                typeLabel = "Quest√£o";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "Quest√£o sem t√≠tulo";
            } else if (wrapper.classList.contains('free-mode')) {
                typeClass = "agreg-box-free";
                typeLabel = "Contentor";
                // L√≥gica de primeira frase para contentores livres
                const text = wrapper.querySelector('.mini-note-content').textContent.trim();
                if (text) {
                    const firstSentence = text.split(/[.!?]/)[0];
                    title = firstSentence.length > 50 ? firstSentence.substring(0, 50) + "..." : firstSentence;
                } else {
                    title = "Contentor Vazio";
                }
            } else {
                typeClass = "agreg-box-subnote";
                typeLabel = "SubNota";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "SubNota sem t√≠tulo";
            }

            // Criar ID √∫nico tempor√°rio para controlo de sele√ß√£o
            const uniqueId = `${noteId}_${index}`;
            const isSelected = aggregationSelectedItems.some(i => i.uniqueId === uniqueId);

            const li = document.createElement('li');
            li.className = `agreg-box-item ${typeClass} ${isSelected ? 'selected' : ''}`;
            
            // Checkbox visual
            const check = isSelected ? "‚òëÔ∏è" : "‚¨ú";

            li.innerHTML = `
                <div style="font-size:1.2em;">${check}</div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:0.9em; color:var(--text-muted-color); text-transform:uppercase;">${typeLabel}</span>
                    <span style="color:var(--text-color);">${title}</span>
                </div>
            `;

            li.onclick = () => {
                toggleAggregationItem(uniqueId, wrapper.outerHTML, li);
            };

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao ler nota.</li>';
    }
}

// 4. Selecionar/Desselecionar Item
function toggleAggregationItem(uniqueId, htmlContent, liElement) {
    const existingIndex = aggregationSelectedItems.findIndex(i => i.uniqueId === uniqueId);

    if (existingIndex > -1) {
        // Remover
        aggregationSelectedItems.splice(existingIndex, 1);
        liElement.classList.remove('selected');
        liElement.querySelector('div').textContent = "‚¨ú";
    } else {
        // Adicionar
        aggregationSelectedItems.push({ uniqueId, html: htmlContent });
        liElement.classList.add('selected');
        liElement.querySelector('div').textContent = "‚òëÔ∏è";
    }
    updateAggregationCount();
}

function updateAggregationCount() {
    document.getElementById('agreg-count').textContent = `${aggregationSelectedItems.length} itens selecionados`;
}

// 5. Navega√ß√£o "Voltar"
document.getElementById('agreg-back-btn').addEventListener('click', () => {
    
    // Determina qual √© a raiz l√≥gica (Superpasta ou Global)
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (aggregationStack.length > 0) {
        aggregationStack.pop(); // Remove n√≠vel atual
        
        if (aggregationStack.length > 0) {
            // Se ainda houver itens no hist√≥rico, carrega esse n√≠vel
            const parent = aggregationStack[aggregationStack.length - 1];
            if (parent.type === 'nota') {
                loadNoteBoxesForAggregation(parent.id);
            } else {
                loadAggregationLevel(parent.id);
            }
        } else {
            // Se o hist√≥rico ficou vazio, voltamos √† Raiz
            loadAggregationLevel(rootId);
        }
    } else {
        // Seguran√ßa: se clicar e j√° estiver vazio
        loadAggregationLevel(rootId);
    }
});

// 6. FINALIZAR: Criar a Nota com as Caixas
document.getElementById('agreg-finish-btn').addEventListener('click', async () => {
    if (aggregationSelectedItems.length === 0) {
        alert("Selecione pelo menos uma caixa.");
        return;
    }

    const btn = document.getElementById('agreg-finish-btn');
    btn.textContent = "A criar...";
    btn.disabled = true;

    try {
        // Constr√≥i o HTML final
        let finalHTML = "";
        aggregationSelectedItems.forEach(item => {
            finalHTML += item.html + "<p><br></p>"; 
        });

        // Determina a ordem
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', aggregationParentId), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const siblingsSnap = await getDocs(q);
        const newOrder = siblingsSnap.size;

        // --- ALTERA√á√ÉO AQUI: Guardamos a refer√™ncia do documento criado ---
        const docRef = await addDoc(collection(db, 'pastas'), {
            nome: aggregationTargetName, 
            parentId: aggregationParentId, 
            tipo: 'nota', 
            conteudo: finalHTML,
            userId: auth.currentUser.uid, 
            estado: 'ativa',
            ordem: newOrder, 
            createdAt: serverTimestamp(), 
            ultimaedicao: serverTimestamp()
        });

        // 1. Fechar o Modal
        document.getElementById('aggregation-modal').style.display = 'none';
        
        // 2. Abrir a Nota Imediatamente
        // Passamos 'null' no segundo argumento porque o elemento da lista 
        // ainda pode n√£o ter sido renderizado pelo onSnapshot, mas a fun√ß√£o abre pelo ID na mesma.
        displayNote(docRef.id, null); 
        
    } catch (e) {
        console.error("Erro ao criar agrega√ß√£o:", e);
        alert("Erro ao criar.");
    } finally {
        btn.textContent = "Criar Agrega√ß√£o";
        btn.disabled = false;
    }
});

// ====================================================================
// SCANNER UNIVERSAL (üé∞) - B√≠blia, Personagens, Locais, Datas
// ====================================================================

let universalScanResults = {
    textobiblico: { new: [], existing: [] },
    personagem: { new: [], existing: [] },
    local: { new: [], existing: [] },
    data: { new: [], existing: [] }
};
let currentScanTab = 'textobiblico';

// 1. LISTENERS DE ABERTURA
const scanBtns = document.querySelectorAll('button[data-action="bible-scan"]');
scanBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        openUniversalScanner();
    });
});

// 2. FUN√á√ÉO PRINCIPAL: ANALISAR TEXTO
async function openUniversalScanner() {
    const modal = document.getElementById('universal-scan-modal');
    
    // Reset total
    universalScanResults = {
        textobiblico: { new: [], existing: [] },
        personagem: { new: [], existing: [] },
        local: { new: [], existing: [] },
        data: { new: [], existing: [] }
    };

    // --- FASE 1: J√Å EXISTENTES (Guardar refer√™ncia do elemento) ---
    const existingLinks = noteContentEditor.querySelectorAll('.entity-link');
    existingLinks.forEach(link => {
        const type = link.dataset.entityType;
        if (universalScanResults[type]) {
            universalScanResults[type].existing.push({
                linkElement: link, // Guardamos o elemento DOM para poder remover
                text: link.textContent,
                line: getApproximateLineNumber(link),
                selected: true // J√° √© link, logo come√ßa "Ativo"
            });
        }
    });

    // --- FASE 2: NOVOS CANDIDATOS ---
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const bibleRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'gi');
    const dateRegex = /\b\d{1,2}[-\/]\d{1,2}[-\/]\d{4}\b/g;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    let node;

    while (node = walker.nextNode()) {
        if (node.parentElement.closest('.entity-link, a, .tag, script, style')) continue;

        const text = node.textContent;
        const lineNum = getApproximateLineNumber(node);

        // A. B√≠blia
        let match;
        while ((match = bibleRegex.exec(text)) !== null) {
            addCandidate('textobiblico', match[0], node, match.index, lineNum);
        }
        // B. Datas
        while ((match = dateRegex.exec(text)) !== null) {
            addCandidate('data', match[0], node, match.index, lineNum);
        }
        // C. Personagens/Locais (BD)
        checkDatabaseEntities(text, node, lineNum, 'personagem');
        checkDatabaseEntities(text, node, lineNum, 'local');
    }

    renderScanTab(currentScanTab);
    modal.style.display = 'flex';
}

function addCandidate(type, matchText, textNode, index, lineNum, cleanName = null) {
    const finalName = cleanName || matchText.trim().replace(/[.,;]+$/, '');
    
    const exists = universalScanResults[type].new.some(c => c.textNode === textNode && c.index === index);
    if (exists) return;

    universalScanResults[type].new.push({
        textNode: textNode,
        matchText: matchText,
        cleanName: finalName,
        index: index,
        line: lineNum,
        contextSnippet: getContextSnippet(textNode.textContent, index, matchText.length),
        selected: false // Novos come√ßam "Inativos" (Texto simples)
    });
}

function checkDatabaseEntities(text, node, lineNum, type) {
    if (!allEntities[type]) return;
    allEntities[type].forEach(entity => {
        const regex = new RegExp(`\\b${escapeRegExp(entity.nome)}\\b`, 'g');
        let match;
        while ((match = regex.exec(text)) !== null) {
            addCandidate(type, match[0], node, match.index, lineNum, entity.nome); 
        }
    });
}

// 3. RENDERIZA√á√ÉO DA ABA ATUAL
function renderScanTab(type) {
    const container = document.getElementById('scan-lists-container');
    container.innerHTML = '';
    const data = universalScanResults[type];
    
    // Atualiza o texto do bot√£o Select All
    updateSelectAllButtonState();

    // --- LISTA DE NOVOS (Check = Criar Link) ---
    if (data.new.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.textContent = `‚ö° Novos Detetados (${data.new.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.new.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'new');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    } else {
        container.innerHTML += '<div style="padding:10px; color:#888;">Nada novo aqui.</div>';
    }

    // --- LISTA DE EXISTENTES (Uncheck = Remover Link) ---
    if (data.existing.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.style.color = "#2ecc71";
        title.textContent = `‚úì J√° Identificados (${data.existing.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.existing.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'existing');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    }
}

// Fun√ß√£o auxiliar para criar o HTML da linha
function createScanListItem(item, idx, listType) {
    const li = document.createElement('li');
    li.className = 'scan-item-row';
    
    // Nome do item (cleanName para novos, text para existentes)
    const displayName = listType === 'new' ? item.cleanName : item.text;
    const isChecked = item.selected ? 'checked' : '';
    
    // Estilo visual: se for existente e estiver desmarcado, risca o texto
    const textStyle = (listType === 'existing' && !item.selected) ? 'text-decoration: line-through; opacity: 0.6;' : '';

    li.innerHTML = `
        <input type="checkbox" class="scan-checkbox" id="scan-${listType}-${idx}" ${isChecked}>
        <div class="scan-info" style="${textStyle}">
            <span class="scan-name">${displayName}</span>
            <span class="scan-location">Linha aprox. ${item.line}</span>
        </div>
        ${listType === 'new' ? '<button class="scan-preview-btn" title="Ver Contexto">üîç</button>' : ''}
    `;

    // Evento de Clique na Linha
    li.addEventListener('click', (e) => {
        if (e.target.closest('.scan-preview-btn')) return;
        
        const checkbox = li.querySelector('input');
        if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
        
        // Atualiza modelo
        item.selected = checkbox.checked;
        
        // Atualiza visual (riscar se for para remover)
        const infoDiv = li.querySelector('.scan-info');
        if (listType === 'existing') {
            infoDiv.style.textDecoration = item.selected ? 'none' : 'line-through';
            infoDiv.style.opacity = item.selected ? '1' : '0.6';
        }

        updateSelectAllButtonState();
    });

    // Lupa (apenas para novos)
    if (listType === 'new') {
        li.querySelector('.scan-preview-btn').onclick = (e) => {
            e.stopPropagation();
            showScanPreview(item.cleanName, item.contextSnippet);
        };
    }

    return li;
}

// 4. L√ìGICA DO BOT√ÉO "SELECIONAR TODOS / REMOVER TODOS"
const toggleAllBtn = document.getElementById('scan-toggle-all-btn');

function updateSelectAllButtonState() {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    
    if (totalItems === 0) {
        toggleAllBtn.style.display = 'none';
        return;
    }
    toggleAllBtn.style.display = 'block';
    
    // Verifica se TODOS (novos e existentes) est√£o marcados
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    
    // Se tudo estiver marcado, o bot√£o diz "Remover Todos". Sen√£o, "Selecionar Todos".
    const allSelected = allNewSelected && allExistSelected;
    toggleAllBtn.textContent = allSelected ? "Desmarcar Todos" : "Selecionar Todos";
}

toggleAllBtn.addEventListener('click', () => {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    if (totalItems === 0) return;

    // L√≥gica: Se tudo marcado -> desmarca tudo. Sen√£o -> marca tudo.
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    const newState = !(allNewSelected && allExistSelected);

    // 1. Atualiza Dados
    data.new.forEach(i => i.selected = newState);
    data.existing.forEach(i => i.selected = newState);

    // 2. Re-renderiza a lista para atualizar visuais (riscos e checkboxes)
    renderScanTab(currentScanTab);
});

// 5. GEST√ÉO DE ABAS
document.querySelector('.scan-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('scan-tab-btn')) {
        document.querySelectorAll('.scan-tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentScanTab = e.target.dataset.target;
        document.getElementById('scan-preview-popup').style.display = 'none';
        renderScanTab(currentScanTab);
    }
});

// 6. PREVIEW e CONTEXTO
function showScanPreview(name, snippet) {
    const popup = document.getElementById('scan-preview-popup');
    const content = document.getElementById('scan-preview-content');
    const safeName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedHTML = snippet.replace(new RegExp(`(${safeName})`, 'gi'), '<mark>$1</mark>');
    content.innerHTML = `... ${highlightedHTML} ...`;
    popup.style.display = 'block';
}

function getContextSnippet(fullText, index, length) {
    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + length + 40);
    return fullText.substring(start, end);
}

function getApproximateLineNumber(node) {
    const block = node.nodeType === 3 ? node.parentElement.closest('p, div, li, h1, h2') : node.closest('p, div, li, h1, h2');
    if (!block) return 1;
    let count = 1;
    let current = block;
    while (current = current.previousElementSibling) count++;
    return count;
}

// 7. APLICAR MUDAN√áAS (CONVERTER E REVERTER)
document.getElementById('confirm-scan-btn').addEventListener('click', async () => {
    
    // Altera o texto do bot√£o para feedback
    const confirmBtn = document.getElementById('confirm-scan-btn');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = "A processar...";
    confirmBtn.disabled = true;

    let changesMade = false;

    // Percorre TODAS as abas (tipos)
    for (const type in universalScanResults) {
        
        // --- A. CONVERTER NOVOS (Que est√£o selecionados) ---
        const newToConvert = universalScanResults[type].new.filter(i => i.selected);
        
        // Ordena inversamente (baixo para cima) para n√£o estragar √≠ndices
        newToConvert.sort((a, b) => {
            if (a.textNode === b.textNode) return b.index - a.index;
            return 0;
        });

        for (const item of newToConvert) {
            try {
                if (item.textNode.textContent.includes(item.matchText)) {
                    const textNode = item.textNode;
                    const splitTarget = textNode.splitText(item.index);
                    splitTarget.splitText(item.matchText.length); // Isola o texto
                    
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = type;
                    span.dataset.entityName = item.cleanName;
                    span.textContent = item.cleanName;

                    splitTarget.parentNode.replaceChild(span, splitTarget);
                    
                    // Atualiza BD
                    await ensureEntityReference(type, item.cleanName);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro convers√£o:", e); }
        }

        // --- B. REMOVER EXISTENTES (Que foram desmarcados) ---
        const existingToRemove = universalScanResults[type].existing.filter(i => !i.selected);
        
        for (const item of existingToRemove) {
            try {
                const linkEl = item.linkElement;
                if (linkEl && linkEl.parentNode) {
                    const textNode = document.createTextNode(linkEl.textContent);
                    linkEl.parentNode.replaceChild(textNode, linkEl);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro revers√£o:", e); }
        }
    }

    if (changesMade) {
        noteContentEditor.normalize(); // Limpa DOM
        updateSaveStatus('unsaved');
        saveNote();
        
        // Recarrega cache
        if(typeof fetchAllEntities === 'function') fetchAllEntities();
    }

    document.getElementById('universal-scan-modal').style.display = 'none';
    
    // Restaura bot√£o
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
});

// Auxiliar BD (Igual)
async function ensureEntityReference(type, name) {
    const flatEntities = Object.values(allEntities).flat();
    const existing = flatEntities.find(e => e.tipo === type && e.nome === name);
    const collectionName = ENTITY_CONFIG[type].collection;

    if (!existing) {
        try {
            await addDoc(collection(db, collectionName), {
                nome: name, descricao: "", userId: auth.currentUser.uid,
                createdAt: serverTimestamp(), referencias: { [selectedNoteId]: true }
            });
            if(!allEntities[type]) allEntities[type] = [];
            allEntities[type].push({ id: 'temp', nome: name, tipo: type });
        } catch(e) { console.error(e); }
    }
}

// ====================================================================
// L√ìGICA DE CRIA√á√ÉO DE NOVOS MARCADORES (+)
// ====================================================================

// 1. Abrir o popup de criar marcador ao clicar no "+"
const openCreateBookmarkBtn = document.getElementById('open-create-bookmark-btn');
if (openCreateBookmarkBtn) {
    openCreateBookmarkBtn.addEventListener('click', () => {
        // Limpa os campos
        document.getElementById('new-bookmark-title').value = '';
        document.getElementById('new-bookmark-desc').value = '';
        
        // Abre o modal secund√°rio
        document.getElementById('create-bookmark-modal').style.display = 'flex';
        
        // Foca no input
        setTimeout(() => document.getElementById('new-bookmark-title').focus(), 50);
    });
}

// 2. Bot√£o Cancelar (Fechar o popup)
const cancelCreateBookmarkBtn = document.getElementById('cancel-create-bookmark');
if (cancelCreateBookmarkBtn) {
    cancelCreateBookmarkBtn.addEventListener('click', () => {
        document.getElementById('create-bookmark-modal').style.display = 'none';
    });
}

// 3. Bot√£o Criar (Gravar na Base de Dados)
const confirmCreateBookmarkBtn = document.getElementById('confirm-create-bookmark');
if (confirmCreateBookmarkBtn) {
    confirmCreateBookmarkBtn.addEventListener('click', async () => {
        const titleInput = document.getElementById('new-bookmark-title');
        const descInput = document.getElementById('new-bookmark-desc');
        
        const nome = titleInput.value.trim();
        const descricao = descInput.value.trim();

        if (!nome) {
            alert("O t√≠tulo do marcador √© obrigat√≥rio.");
            return;
        }

        // Feedback visual
        const originalText = confirmCreateBookmarkBtn.textContent;
        confirmCreateBookmarkBtn.textContent = "A criar...";
        confirmCreateBookmarkBtn.disabled = true;

        try {
            // Importar fun√ß√µes do Firestore (j√° devem estar importadas no topo do seu ficheiro)
            // addDoc, collection, serverTimestamp, auth, db...

            await addDoc(collection(db, 'marcadores'), {
                nome: nome,
                descricao: descricao,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Sucesso: Fecha o modal e recarrega a lista
            document.getElementById('create-bookmark-modal').style.display = 'none';
            
            // Recarrega a lista do modal principal para mostrar o novo item
            await openBookmarksModal(); 

        } catch (error) {
            console.error("Erro ao criar marcador:", error);
            alert("Erro ao criar o marcador. Verifique a consola.");
        } finally {
            // Restaura o bot√£o
            confirmCreateBookmarkBtn.textContent = originalText;
            confirmCreateBookmarkBtn.disabled = false;
        }
    });
}

  noteContentEditor.addEventListener('keyup', (event) => {
    // Ignora teclas de navega√ß√£o
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(event.key)) {
        return;
    }
    
    if (isTagPopupOpen || isEntityPopupOpen) {
        if (['Enter', ' '].includes(event.key)) return;
    }

    if (event.key === 'Escape') { 
        hideTagPopup();
        hideEntityPopup();
        return; 
    }

    const selection = window.getSelection();
    if (!selection.rangeCount > 0) return;
    const range = selection.getRangeAt(0);
    const container = range.startContainer;
    const offset = range.startOffset;

    // Texto ANTES do cursor
    const textBeforeCursor = container.textContent.substring(0, offset);
    
    // Texto DEPOIS do cursor
    const textAfterCursor = container.textContent.substring(offset);

    const tagMatch = textBeforeCursor.match(/#(\w*)$/);
    const entityMatch = textBeforeCursor.match(/@([\w\s]*)$/);

    if (tagMatch) {
        hideEntityPopup();
        currentTagQueryRange = document.createRange();
        currentTagQueryRange.setStart(container, tagMatch.index);
        currentTagQueryRange.setEnd(container, offset);
        showTagPopup(tagMatch[1]);

    } else if (entityMatch) {
        hideTagPopup();
        currentEntityQueryRange = document.createRange();
        
        // Ponto de in√≠cio: onde est√° o @
        currentEntityQueryRange.setStart(container, entityMatch.index);

        // --- L√ìGICA DE "ETIQUETAGEM INTELIGENTE" ---
        
        // Verifica se o utilizador acabou de digitar o @ (query vazia)
        // E se existe uma palavra "colada" logo √† frente do cursor
        const isAtStartOfWord = entityMatch[1] === '' && /^\w/.test(textAfterCursor);

        if (isAtStartOfWord) {
            // Identifica a palavra que est√° √† frente (ex: "David" em "@|David")
            const wordAfterMatch = textAfterCursor.match(/^(\w+)/);
            
            if (wordAfterMatch) {
                const wordToConsume = wordAfterMatch[1];
                console.log(`[Smart Tagging] Detetada palavra √† frente: "${wordToConsume}"`);
                
                // Expande o range de substitui√ß√£o para incluir a palavra da frente
                currentEntityQueryRange.setEnd(container, offset + wordToConsume.length);
                
                // Usa a palavra da frente como pesquisa para o popup
                showEntityPopup(wordToConsume);
                return; // Sai para n√£o executar o showEntityPopup normal abaixo
            }
        }

        // Comportamento normal (escrevendo novo texto)
        currentEntityQueryRange.setEnd(container, offset);
        showEntityPopup(entityMatch[1]);

    } else {
        hideTagPopup();
        hideEntityPopup();
    }
    
});



// 1. ESCUTAR O CLIQUE NO BOT√ÉO üß¨
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="append-mini-note"]');
    if (!btn) return;

    e.preventDefault(); e.stopPropagation();

    // Captura o HTML da caixa inteira
    const wrapper = btn.closest('.mini-note-wrapper');
    if (wrapper) {
        // Clonamos para garantir que n√£o alteramos o original durante a c√≥pia
        htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
        openAppendModal();
    }
});

// 2. ABRIR O MODAL
function openAppendModal() {
    const modal = document.getElementById('append-to-note-modal');
    modal.style.display = 'flex';
    
    // Reset da navega√ß√£o
    appendStack = [];
    
    // Define a raiz (Superpasta ou Global)
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    loadAppendList(rootId);
}

// 3. CARREGAR LISTA (PASTAS E NOTAS)
async function loadAppendList(parentId) {
    const list = document.getElementById('append-list');
    const backBtn = document.getElementById('append-back-btn');
    const pathLabel = document.getElementById('append-current-path');
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    // Atualiza Breadcrumbs
    if (appendStack.length > 0) {
        pathLabel.textContent = appendStack[appendStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathLabel.textContent = parentId ? "Pasta Atual" : "Raiz";
        backBtn.style.display = 'none';
    }

    try {
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', parentId),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('tipo'), // Pastas primeiro
            orderBy('nome')
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Pasta vazia.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.padding = '12px';
            li.style.borderBottom = '1px solid var(--border-color)';
            li.style.cursor = 'pointer';

            if (item.tipo === 'pasta') {
                // √â PASTA: Clicar para entrar
                li.innerHTML = `<span style="font-weight:bold;">üìÅ ${item.nome}</span> <span>‚ûî</span>`;
                li.onclick = () => {
                    appendStack.push({ id: item.id, name: item.nome });
                    loadAppendList(item.id);
                };
            } else if (item.tipo === 'nota') {
                // √â NOTA: Clicar para ENVIAR
                // Se for a pr√≥pria nota aberta atualmente, avisamos visualmente (opcional)
                const isCurrent = (item.id === selectedNoteId);
                const colorStyle = isCurrent ? "color:var(--accent-color); font-style:italic;" : "";
                
                li.innerHTML = `<span style="${colorStyle}">üìÑ ${item.nome} ${isCurrent ? '(Atual)' : ''}</span> <span>üì•</span>`;
                
                li.onclick = () => confirmAppendToNote(item.id, item.nome);
            }

            // Ignorar agrega√ß√µes? N√£o, agrega√ß√µes s√£o notas, podem receber conte√∫do.
            
            // Hover effect manual
            li.onmouseover = () => li.style.backgroundColor = 'var(--hover-color)';
            li.onmouseout = () => li.style.backgroundColor = 'transparent';

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar lista.</li>';
    }
}

// 4. BOT√ÉO VOLTAR
document.getElementById('append-back-btn').addEventListener('click', () => {
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (appendStack.length > 0) {
        appendStack.pop();
        const parent = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : rootId;
        loadAppendList(parent);
    } else {
        loadAppendList(rootId);
    }
});

// 5. CONFIRMAR E GRAVAR
async function confirmAppendToNote(targetId, targetName) {
    
    // 1. Truque de UI: For√ßar o modal de confirma√ß√£o a ficar acima de tudo (z-index 2000)
    const confirmModal = document.getElementById('confirm-modal');
    confirmModal.style.zIndex = '2000';

    // 2. Usar a fun√ß√£o de confirma√ß√£o personalizada j√° existente no seu c√≥digo
    const confirmed = await showConfirmation(
        "Confirmar Envio", 
        `Deseja adicionar esta caixa √† nota "${targetName}"?`
    );

    if (!confirmed) {
        // Se cancelar, restaura o z-index original (opcional) e sai
        confirmModal.style.zIndex = ''; 
        return;
    }

    try {
        const targetRef = doc(db, 'pastas', targetId);
        const targetSnap = await getDoc(targetRef);

        if (targetSnap.exists()) {
            const currentContent = targetSnap.data().conteudo || "";
            
            // Adiciona ao final do conte√∫do existente
            const newContent = currentContent + htmlToAppend;

            await updateDoc(targetRef, {
                conteudo: newContent,
                ultimaedicao: serverTimestamp()
            });

            // Mostra aviso de sucesso tempor√°rio no bot√£o ou um pequeno alert
            // Como fechamos o modal logo a seguir, n√£o √© cr√≠tico
            document.getElementById('append-to-note-modal').style.display = 'none';
            
            // Restaura z-index para o futuro
            confirmModal.style.zIndex = ''; 

        } else {
            alert("Nota de destino n√£o encontrada.");
        }
    } catch (e) {
        console.error("Erro ao enviar:", e);
        alert("Erro ao gravar na nota de destino.");
    }
}



    // --- Listener para o Bot√£o de Colapsar/Expandir o Painel do Meio ---
const middlePanelToggleBtn = document.getElementById('middle-panel-toggle-btn');

if (middlePanelToggleBtn) { 
    middlePanelToggleBtn.addEventListener('click', () => {
        // Liga/Desliga a classe CSS
        const isCollapsed = notebookContainer.classList.toggle('middle-panel-collapsed');
        
        // Muda o √≠cone
        if (isCollapsed) {
            middlePanelToggleBtn.textContent = '¬ª'; 
            middlePanelToggleBtn.title = "Restaurar Painel";
        } else {
            middlePanelToggleBtn.textContent = '‚Üñ'; 
            middlePanelToggleBtn.title = "Expandir Lista";
        }
    });
}


window.restoreHiddenMiniNote = async function(miniNoteId) {
    if (!selectedNoteId) return;

    const confirmRestore = confirm("Restaurar para a posi√ß√£o original?");
    if (!confirmRestore) return;

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (!noteSnap.exists() || !noteSnap.data().subnotasocultas || !noteSnap.data().subnotasocultas[miniNoteId]) {
            alert("Erro: Dados n√£o encontrados.");
            return;
        }

        const noteData = noteSnap.data().subnotasocultas[miniNoteId];
        let restoredHTML = '';

        // --- CONSTRU√á√ÉO DO HTML ---

        if (noteData.tipo === 'toggle') {
            // RECONSTRU√á√ÉO DO TOGGLE
            restoredHTML = `
                <details class="toggle-section" open id="${noteData.id}">
                    <summary>
                        <h2>${noteData.titulo}</h2>
                        <button class="toggle-delete-btn" contenteditable="false" title="Ocultar Sec√ß√£o">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content">
                        ${noteData.conteudo}
                    </div>
                </details>
                <p><br></p>`;
        } 
        else {
            // RECONSTRU√á√ÉO DE SUBNOTAS (C√≥digo antigo)
            let wrapperClass = 'mini-note-wrapper';
            let titleHTML = '';

            if (noteData.tipo === 'question') {
                wrapperClass += ' question-mode';
                titleHTML = `<input type="text" class="mini-note-title-input" placeholder="T√≠tulo..." value="${noteData.titulo}">`;
            } else if (noteData.tipo === 'free') {
                wrapperClass += ' free-mode';
                titleHTML = '';
            } else {
                titleHTML = `<input type="text" class="mini-note-title-input" placeholder="T√≠tulo..." value="${noteData.titulo}">`;
            }

            restoredHTML = `
                <div contenteditable="false" style="height: 20px;"></div>
                <div class="${wrapperClass}" contenteditable="false" id="${noteData.id}" data-topics='${noteData.topicsJSON || '{}'}'>
                    ${titleHTML}
                    <div class="mini-note-toolbar">
                         <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
                         <button type="button" data-action="move-up">üî∫</button>
                         <button type="button" data-action="move-down">üîª</button>
                         <button type="button" data-action="append-mini-note">üß¨</button>
                         <button type="button" data-action="highlight-color">üé®</button>
                         <button type="button" data-action="manage-mini-note-topics">üìã</button>
                         <button type="button" data-action="delete-mini-note">üóëÔ∏è</button>
                    </div>
                    <div class="mini-note-content" contenteditable="true">
                        ${noteData.conteudo}
                    </div>
                </div>
                <div contenteditable="false" style="height: 20px;"></div>
                <p><br></p>`;
        }

        // --- INSER√á√ÉO NO DOM ---
        const marker = document.getElementById(`marker_${miniNoteId}`);
        let restoredElement = null;

        if (marker) {
            marker.outerHTML = restoredHTML;
            restoredElement = document.getElementById(noteData.id);
        } else {
            alert("A posi√ß√£o original foi perdida. A adicionar ao final.");
            noteContentEditor.insertAdjacentHTML('beforeend', restoredHTML);
            restoredElement = document.getElementById(noteData.id);
        }
        
        // Se for subnota, atualiza bot√µes
        if (restoredElement && noteData.tipo !== 'toggle') {
            updateMiniNoteButtonState(restoredElement);
            if(typeof updateHighlightButtonState === 'function') updateHighlightButtonState(restoredElement);
            if(typeof updateSharingButtonState === 'function') updateSharingButtonState(restoredElement);
        }

        // --- LIMPEZA ---
        await updateDoc(noteRef, {
            [`subnotasocultas.${miniNoteId}`]: deleteField(),
            conteudo: noteContentEditor.innerHTML,
            ultimaedicao: serverTimestamp()
        });

        document.getElementById('history-modal').style.display = 'none';
        saveNote();

    } catch (error) {
        console.error("Erro ao restaurar:", error);
        alert("Erro ao restaurar item.");
    }
};

// Outros Listeners
document.addEventListener('click', (e) => {
    if (!e.target.closest('.context-menu')) hideContextMenu();
    if (!noteContentEditor.contains(e.target) && !tagSuggestionPopup.contains(e.target)) hideTagPopup();
});

leftPanelToggleBtn.addEventListener('click', () => {
    notebookContainer.classList.toggle('left-panel-collapsed');
});



addItemBtn.addEventListener('click', () => {
    const addFolderBtn = document.querySelector('#add-item-options button[data-type="pasta"]');
    const addNoteBtn = document.querySelector('#add-item-options button[data-type="nota"]');
    const addAgregBtn = document.querySelector('#add-item-options button[data-type="agregacao"]');

    newItemNameInput.value = '';
    newItemNameInput.style.display = 'none';
    document.getElementById('confirm-item-addition').style.display = 'none';
    document.getElementById('add-item-options').style.display = 'flex';

    if (navigationStack.length === 0) {
        // Na Raiz: Apenas Pastas e Agrega√ß√µes
        addFolderBtn.style.display = 'block';
        addAgregBtn.style.display = 'block'; // Mostrar
        addNoteBtn.style.display = 'none';
    } else {
        // Dentro de pastas: Tudo permitido
        addFolderBtn.style.display = 'block';
        addAgregBtn.style.display = 'block'; // Mostrar
        addNoteBtn.style.display = 'block';
    }
    document.getElementById('add-item-modal').style.display = 'flex';
});


// ====================================================================
// FOR√áAR COLAGEM COMO TEXTO SIMPLES (PLAIN TEXT)
// ====================================================================
 document.addEventListener('paste', (e) => {
    // 1. Verifica se estamos num campo edit√°vel
    const target = e.target;
    const isEditable = target.isContentEditable || 
                       (target.tagName === 'INPUT' && target.type === 'text') ||
                       target.tagName === 'TEXTAREA';

    if (!isEditable) return;

    // 2. Impede o comportamento padr√£o
    e.preventDefault();

    // 3. Obt√©m apenas o texto limpo
    let text = (e.clipboardData || window.clipboardData).getData('text/plain');

    // >>> CORRE√á√ÉO AQUI: Remove espa√ßos vazios antes e depois <<<
    text = text.trim(); 

    // 4. Se estiver dentro de Toggle ou Mini-Nota, usa <br>
    if (target.closest('.toggle-content') || target.closest('.mini-note-content')) {
        // Substitui quebras de linha por <br>
        const htmlContent = text.replace(/\r\n|\r|\n/g, '<br>');
        document.execCommand('insertHTML', false, htmlContent);
    } else {
        // Nos outros s√≠tios, texto normal
        document.execCommand('insertText', false, text);
    }
    
    // 5. Grava
    if (typeof saveNote === 'function') {
        if (target.id === 'note-content-editor' || target.closest('#note-content-editor')) {
            saveNote(); 
        }
    }
});


let itemTypeToAdd = '';
document.getElementById('add-item-options').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    itemTypeToAdd = btn.dataset.type;
    document.getElementById('add-item-options').style.display = 'none';
    newItemNameInput.style.display = 'block';
    newItemNameInput.placeholder = `Nome d${itemTypeToAdd === 'pasta' ? 'a' : 'a'} ${itemTypeToAdd}...`;
    newItemNameInput.focus();
    document.getElementById('confirm-item-addition').style.display = 'block';
});

 document.getElementById('confirm-item-addition').addEventListener('click', async () => {
    const confirmBtn = document.getElementById('confirm-item-addition');
    if (confirmBtn.disabled) return;

    const itemName = newItemNameInput.value.trim();
    if (!itemName || !itemTypeToAdd) return;

    // >>> L√ìGICA DE AGREGA√á√ÉO (INTERCEPTA√á√ÉO) <<<
    if (itemTypeToAdd === 'agregacao') {
        // 1. Guarda os dados iniciais
        aggregationTargetName = itemName;
        aggregationParentId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
        
        // Se estivermos na raiz de uma Superpasta
        if (!aggregationParentId && typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) {
            aggregationParentId = SUPERFOLDER_ID;
        }
        
        // 2. Fecha o modal de nome
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';

        // 3. Abre o Seletor de Agrega√ß√£o
        openAggregationSelector();
        return; // P√°ra aqui, n√£o cria nada na BD ainda
    }

    // >>> L√ìGICA PARA CRIAR PASTA OU NOTA (O QUE FALTAVA) <<<
    try {
        confirmBtn.disabled = true;
        confirmBtn.textContent = "A criar...";

        // 1. Determinar onde vamos criar (Parent ID)
        let parentId = null;
        
        // Verifica se estamos a navegar dentro de pastas
        if (navigationStack.length > 0) {
            parentId = navigationStack[navigationStack.length - 1].id;
        } 
        // Verifica se estamos na raiz de uma Superpasta
        else if (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) {
            parentId = SUPERFOLDER_ID;
        }

        // 2. Calcular a ordem (para aparecer no fim da lista)
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', parentId), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const newOrder = snapshot.size;

        // 3. Preparar os dados do documento
        const docData = {
            nome: itemName,
            parentId: parentId,
            tipo: itemTypeToAdd, // 'pasta' ou 'nota'
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ordem: newOrder,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        };

        // Adiciona campos espec√≠ficos se for Nota
        if (itemTypeToAdd === 'nota') {
            docData.conteudo = '';
            docData.tags = [];
        }
        // Adiciona campos espec√≠ficos se for Pasta
        if (itemTypeToAdd === 'pasta') {
            docData.superpasta = false;
        }

        // 4. Enviar para a Base de Dados
        const docRef = await addDoc(collection(db, 'pastas'), docData);

        // 5. Limpar e Fechar Modal
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';

        // (Opcional) Se for nota, abre-a automaticamente
        if (itemTypeToAdd === 'nota') {
            setTimeout(() => {
                // Tenta encontrar o item na lista (o onSnapshot j√° deve ter atualizado)
                const newListItem = document.querySelector(`.list-item[data-id="${docRef.id}"]`);
                if (newListItem) displayNote(docRef.id, newListItem);
            }, 300);
        }

    } catch (error) {
        console.error("Erro ao criar item:", error);
        alert("Ocorreu um erro ao criar o item. Verifique a consola.");
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Criar";
    }
});

document.getElementById('context-menu').addEventListener('click', async (e) => {
    const action = e.target.dataset.action;
    if (!action || !activeItemContext) return;

    // Guardamos o contexto numa vari√°vel local antes que seja limpo pelo hideContextMenu
    const itemContext = { ...activeItemContext };
    hideContextMenu(); 

    // --- NOVA A√á√ÉO: TOGGLE SUPERPASTA ---
    if (action === 'toggle-superfolder') {
        if (itemContext.type !== 'pasta') {
            alert("Apenas pastas podem ser Superpastas.");
            return;
        }
        
        // Verifica o estado atual olhando para o elemento DOM
        const liElement = document.querySelector(`.list-item[data-id="${itemContext.id}"]`);
        const isCurrentlySuper = liElement && liElement.dataset.superpasta === "true";
        
        try {
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                superpasta: !isCurrentlySuper, // Inverte o valor (true <-> false)
                ultimaedicao: serverTimestamp()
            });
            window.location.reload();
        } catch (error) {
            console.error("Erro ao alterar superpasta:", error);
            alert("Erro ao atualizar o estado da pasta.");
        }
    }
    // --- L√ìGICA DE PROTE√á√ÉO ---
    else if (action === 'protect') {
        await requestPassword('create', itemContext.id);
    } 
    else if (action === 'unprotect') {
        const success = await requestPassword('remove', itemContext.id);
        if (success) {
            sessionUnlockedFolders.delete(itemContext.id);
            // Atualiza visualmente
            const li = document.querySelector(`.list-item[data-id="${itemContext.id}"]`);
            if(li) {
                li.removeAttribute('data-protected'); 
                const span = li.querySelector('span');
                if(span) span.textContent = span.textContent.replace('üîí ', '');
            }
        }
    }
    // --- OUTRAS A√á√ïES ---
    else if (action === 'manage-topics') {
        openTopicsModal(itemContext.id, itemContext.type);
    } 
    else if (action === 'hide') {
        const confirmed = await showConfirmation('Ocultar Item?', `Tem certeza que deseja ocultar "${itemContext.name}"?`);
        if (confirmed) {
            if (selectedNoteId && itemContext.id === selectedNoteId) {
                resetEditor();
            }
            await updateDoc(doc(db, 'pastas', itemContext.id), { 
                estado: 'desativa',
                ultimaedicao: serverTimestamp()
            });
        }
    } 
    else if (action === 'move-position') {
        await openMoveModal(itemContext); 
    } 
    else if (action === 'move-folder') { 
        await openMoveToFolderModal(itemContext); 
    } 
    else if (action === 'rename') {
        const currentName = itemContext.name;
        const newName = prompt("Mudar nome para:", currentName);
        if (newName && newName.trim() !== "" && newName !== currentName) {
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                nome: newName.trim(),
                ultimaedicao: serverTimestamp()
            });
            if (selectedNoteId && itemContext.id === selectedNoteId) {
                noteTitleInput.value = newName.trim();
            }
        }
    }
});


document.querySelectorAll('.modal-overlay [data-action="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal-overlay').style.display = 'none';
    });
});

document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-modal').style.display = 'flex';
});

document.getElementById('settings-modal').addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    if (action === 'show-hidden-items') {
        document.getElementById('settings-modal').style.display = 'none';
        showHiddenItemsModal();
    }
});

document.getElementById('hidden-items-list').addEventListener('click', async (e) => {
    if (e.target.tagName === 'BUTTON') {
        const id = e.target.dataset.id;
        await updateDoc(doc(db, 'pastas', id), { 
            estado: 'ativa',
            ultimaedicao: serverTimestamp()
        });
        e.target.closest('li').remove();
    }
});


// ====================================================================
// L√ìGICA DE PARTILHA DA CAIXA (CADEADO)
// ====================================================================
let activeWrapperForSharing = null;
const sharePopup = document.getElementById('share-settings-popup');
const shareToggle = document.getElementById('mini-note-share-toggle');

// 1. Abrir Popup ao clicar no cadeado
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="sharing-settings"]');
    if (!btn) return;

    e.preventDefault(); e.stopPropagation();

    const wrapper = btn.closest('.mini-note-wrapper');
    activeWrapperForSharing = wrapper;

    // Ler estado atual
    const currentState = wrapper.getAttribute('data-shared') === 'true';
    shareToggle.checked = currentState;

    // Posicionar Popup
    const rect = btn.getBoundingClientRect();
    sharePopup.style.display = 'flex';
    sharePopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
    sharePopup.style.left = `${rect.left + window.scrollX}px`;
});

// 2. Alterar o Toggle
shareToggle.addEventListener('change', () => {
    if (activeWrapperForSharing) {
        // Atualiza o atributo no HTML da nota
        activeWrapperForSharing.setAttribute('data-shared', shareToggle.checked);
        
        // Atualiza o visual do bot√£o imediatamente
        updateSharingButtonState(activeWrapperForSharing);
        
        // Grava a nota no Firebase
        saveNote();
    }
});

// 3. Fechar Popup ao clicar fora
document.addEventListener('click', (e) => {
    if (sharePopup.style.display !== 'none') {
        if (!sharePopup.contains(e.target) && !e.target.closest('button[data-action="sharing-settings"]')) {
            sharePopup.style.display = 'none';
            activeWrapperForSharing = null;
        }
    }
});

// --- EVENT LISTENER PARA O INDICADOR DE STATUS ---
if (saveStatusIndicator) {
    saveStatusIndicator.addEventListener('click', () => {
        // Se estiver "por guardar" ou deu "erro", o clique for√ßa a grava√ß√£o
        if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'error') {
            console.log("üëÜ Clique no status: A for√ßar grava√ß√£o imediata...");
            saveNote(true); // O par√¢metro 'true' ignora o temporizador e grava logo
        }
    });
}

 // --- EVENT LISTENER: BOT√ÉO DA TOOLBAR ---
editorToolbar.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // 1. A√á√ÉO: GERIR T√ìPICOS (üìë)
    if (action === 'show-topics') {
        if (selectedNoteId) {
            openTopicsModal(selectedNoteId, 'nota');
        } else {
            alert("Selecione uma nota primeiro.");
        }
    }

    // 2. A√á√ÉO: HIST√ìRICO E BACKUPS (üïí)
    else if (action === 'show-history') {
        if (selectedNoteId) {
            openHistoryModal();
        }
    }

    // 3. A√á√ÉO: DEFINI√á√ïES DE PARTILHA (üîê)
    else if (action === 'note-sharing-settings') {
        if (!selectedNoteId) return;

        // Carregar estado atual
        try {
            const docRef = doc(db, 'pastas', selectedNoteId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentNoteShareData = data.shareSettings || { shared: false, shareId: null };
                
                // Configura UI
                const toggle = document.getElementById('note-share-toggle');
                if (toggle) toggle.checked = currentNoteShareData.shared;
                toggleNoteLinkUI(currentNoteShareData.shared);

                if (currentNoteShareData.shareId) {
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                    const urlInput = document.getElementById('note-share-url');
                    if (urlInput) urlInput.value = `${baseUrl}/sharenote.html?id=${currentNoteShareData.shareId}`;
                }
            }
        } catch (err) {
            console.error("Erro partilha:", err);
        }

        // Abrir Popup
        const popup = document.getElementById('note-share-popup');
        const rect = btn.getBoundingClientRect();
        popup.style.display = 'flex';
        popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        popup.style.left = `${rect.right - 260}px`; 
    }
    
    // 4. A√á√ÉO: ANEXOS (üìé) - Caso clique no clip da barra principal
    else if (action === 'show-attachments') {
        openAttachmentsModal();
    }

    // 5. A√á√ÉO: EXPLORADOR (üîç) - Caso clique na lupa da barra principal
    else if (action === 'show-explorer') {
        openExplorerModal();
    }
});

// --- TOGGLE (LIGAR/DESLIGAR) ---
noteShareToggle.addEventListener('change', async () => {
    if (!selectedNoteId) return;

    const isShared = noteShareToggle.checked;
    
    // Feedback visual imediato
    toggleNoteLinkUI(isShared);
    updateNoteSharingButtonUI(isShared);

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        let shareId = currentNoteShareData?.shareId;

        // Se est√° a ligar e ainda n√£o tem ID de partilha, cria um novo
        // (Ou usa o pr√≥prio ID da nota se preferir, mas um ID separado √© mais seguro)
        if (isShared && !shareId) {
            // Vamos usar o pr√≥prio ID da nota para simplificar a sincroniza√ß√£o,
            // mas gravamos na cole√ß√£o 'shared_notes' separada.
            shareId = selectedNoteId; 
        }

        // 1. Atualizar metadados na Nota Original
        await updateDoc(noteRef, {
            shareSettings: {
                shared: isShared,
                shareId: shareId,
                updatedAt: serverTimestamp()
            }
        });

        // 2. Sincronizar com a cole√ß√£o p√∫blica 'shared_notes'
        if (isShared) {
            // Copia o conte√∫do atual para a √°rea p√∫blica
            const noteSnap = await getDoc(noteRef);
            const noteData = noteSnap.data();
            
            await setDoc(doc(db, 'shared_notes', shareId), {
                nome: noteData.nome,
                conteudo: noteData.conteudo,
                authorName: currentUserData.nome || "An√≥nimo", // Usa a vari√°vel global do user
                sharedAt: serverTimestamp(),
                type: 'full_note',
                originalNoteId: selectedNoteId
            });
            
            // Gera link para o input
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            noteShareUrlInput.value = `${baseUrl}/sharenote.html?id=${shareId}`;

        } else {
            // Se desligou, apagamos da cole√ß√£o p√∫blica para seguran√ßa total
            if (shareId) {
                await deleteDoc(doc(db, 'shared_notes', shareId));
            }
        }

        // Atualiza estado local
        currentNoteShareData = { shared: isShared, shareId: shareId };

    } catch (e) {
        console.error("Erro ao alterar partilha:", e);
        alert("Erro ao atualizar defini√ß√µes de partilha.");
        // Reverte visualmente em caso de erro
        noteShareToggle.checked = !isShared;
        toggleNoteLinkUI(!isShared);
    }
});

// Auxiliar para mostrar/esconder o input do link
function toggleNoteLinkUI(show) {
    if (show) {
        noteShareLinkContainer.style.display = 'block';
    } else {
        noteShareLinkContainer.style.display = 'none';
    }
}

// Bot√£o Copiar Link
copyNoteLinkBtn.addEventListener('click', () => {
    noteShareUrlInput.select();
    document.execCommand('copy');
    const originalText = copyNoteLinkBtn.textContent;
    copyNoteLinkBtn.textContent = "Copiado!";
    setTimeout(() => copyNoteLinkBtn.textContent = originalText, 2000);
});

// Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (noteSharePopup.style.display !== 'none') {
        if (!noteSharePopup.contains(e.target) && !e.target.closest('button[data-action="note-sharing-settings"]')) {
            noteSharePopup.style.display = 'none';
        }
    }
});

// ====================================================================
// NOVA FUN√á√ÉO PARA O POPUP DE VISUALIZA√á√ÉO
// ====================================================================
 async function openViewLinkModal(anexoId) {
    const modal = document.getElementById('view-link-modal');
    const titleEl = document.getElementById('view-link-title');
    const listEl = document.getElementById('view-link-urls-list');
    const editBtn = document.getElementById('view-link-edit-btn');

    titleEl.textContent = 'A carregar...';
    listEl.innerHTML = '';
    modal.style.display = 'flex';

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists() || !noteSnap.data().anexos?.[anexoId]) {
            throw new Error('Anexo n√£o encontrado na base de dados.');
        }

        const anexo = noteSnap.data().anexos[anexoId];
        titleEl.textContent = anexo.titulo;
        const urls = anexo.urls ? Object.values(anexo.urls) : [];

        if (urls.length > 0) {
            // A L√ìGICA DE RENDERIZA√á√ÉO √â AGORA ID√äNTICA √Ä DO OUTRO MODAL
            urls.forEach((url, index) => {
                const li = document.createElement('li');
                
                // Criamos a estrutura com n√∫mero (branco) e link (azul)
                const linkHTML = `
                    <div style="display: flex; align-items: baseline; gap: 8px;">
                        <span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span>
                        <a href="${url}" target="_blank" rel="noopener noreferrer" 
                           style="color: var(--accent-color); text-decoration: none; word-break: break-all;">
                            ${url}
                        </a>
                    </div>
                `;
                li.innerHTML = linkHTML;
                listEl.appendChild(li);
            });
        } else {
            listEl.innerHTML = '<li>Nenhuma URL associada a este anexo.</li>';
        }
        
        const newEditBtn = editBtn.cloneNode(true);
        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
        newEditBtn.onclick = () => {
            modal.style.display = 'none'; 
            openLinkModal(true, { id: anexoId });
        };

    } catch (error) {
        console.error("Erro ao abrir o modal de visualiza√ß√£o:", error);
        alert(error.message);
        modal.style.display = 'none';
    }
}


// ====================================================================
// CORRE√á√ÉO PARA O UNDO/REDO EM SUBNOTAS E QUEST√ïES
// ====================================================================

// Quando escrevemos no t√≠tulo, for√ßamos o atributo HTML 'value' a atualizar.
// Isto permite que o document.execCommand('undo') saiba que o texto mudou.
noteContentEditor.addEventListener('input', (e) => {
    if (e.target.classList.contains('mini-note-title-input')) {
        // "Cozinha" o valor atual dentro do HTML
        e.target.setAttribute('value', e.target.value);
    }
});

// ====================================================================
// GESTOR DE CLIQUES (√ÇNCORAS, LINKS E TAGS)
// ====================================================================
noteContentEditor.addEventListener('click', (event) => {
    // 1. Ignora se for um bot√£o de interface (ex: lixo, t√≥picos, tesoura)
    if (event.target.closest('button') || event.target.closest('.post-it-drag-handle')) return;

    console.groupCollapsed('%c[Gestor de Cliques]', 'color: white; background-color: #c0392b; padding: 2px 5px; border-radius: 3px;');
    
    const target = event.target;
    const anchorElement = target.closest('.entity-link');
    const linkElement = target.closest('a[data-anexo-id]');
    const tagElement = target.closest('.tag'); 

    console.log('Elemento detetado:', { anchorElement, linkElement, tagElement });

    // PRIORIDADE 1: √Çncora de Entidade
    if (anchorElement) {
        console.log('%cDECIS√ÉO: Prioridade 1 - Clique em √Çncora.', 'font-weight: bold; color: #e67e22;');
        event.preventDefault();
        const entityName = anchorElement.dataset.entityName;
        const entityType = anchorElement.dataset.entityType;
        
        // Verifica cache
        const entity = allEntities[entityType]?.find(e => e.nome === entityName);
        if (!entity) {
            console.error(`Entidade "${entityName}" n√£o encontrada no cache.`);
            console.groupEnd();
            return;
        }
        
        // Verifica se est√° dentro de um anexo
        const anexoId = linkElement ? linkElement.dataset.anexoId : null;
        
        showReferencesPanel(entity.id, entityName, entityType, anexoId);
        console.groupEnd();
        return; 
    }

    // PRIORIDADE 2: Link (Anexo) sem √¢ncora
    if (linkElement) {
        console.log('%cDECIS√ÉO: Prioridade 2 - Clique em Link.', 'font-weight: bold; color: #3498db;');
        event.preventDefault();
        const anexoId = linkElement.dataset.anexoId;
        openViewLinkModal(anexoId);
        console.groupEnd();
        return;
    }

    // PRIORIDADE 3: Tag
    if (tagElement) {
        console.log('%cDECIS√ÉO: Prioridade 3 - Clique em Tag.', 'font-weight: bold; color: #2ecc71;');
        event.preventDefault();
        
        // Extrai o nome da tag, removendo o '#' inicial
        const tagName = tagElement.textContent.replace('#', '').trim();
        
        if (tagName) {
              showTagReferencesPanel(tagName);
        }
        
        console.groupEnd();
        return;
    }

    console.log('%cDECIS√ÉO: Clique texto normal/irrelevante.', 'color: #95a5a6;');
    console.groupEnd();
});

// ====================================================================
// FUN√á√ÉO: ARQUIVAR MINI-NOTA (Mover para Reciclagem no Firebase)
// ====================================================================
async function archiveMiniNote(element, silentMode = false) {
    if (!element) return false;

    const itemId = element.id;
    let title = "Sem T√≠tulo";
    let content = "";
    let type = "default";
    let topicsJSON = '{}';

    // --- DETE√á√ÉO DO TIPO DE ELEMENTO ---
    
    // CASO 1: √â um TOGGLE (Details)
    if (element.tagName === 'DETAILS') {
        type = 'toggle';
        const h2 = element.querySelector('h2');
        title = h2 ? h2.textContent : "Toggle Sem T√≠tulo";
        
        // Guarda apenas o interior do content
        const innerContentDiv = element.querySelector('.toggle-content');
        content = innerContentDiv ? innerContentDiv.innerHTML : "";
        
        // Toggles por enquanto n√£o t√™m t√≥picos, mas mantemos o formato
        topicsJSON = '{}';
    } 
    // CASO 2: √â uma SUBNOTA/QUEST√ÉO (Wrapper normal)
    else {
        const titleInput = element.querySelector('.mini-note-title-input');
        const contentDiv = element.querySelector('.mini-note-content');
        
        if (element.classList.contains('question-mode')) type = 'question';
        else if (element.classList.contains('free-mode')) type = 'free';
        
        if (titleInput) title = titleInput.value;
        else if (type === 'free') {
            const text = contentDiv ? contentDiv.textContent.trim() : "";
            title = text.length > 30 ? text.substring(0, 30) + "..." : (text || "Contentor Livre");
        }
        
        content = contentDiv ? contentDiv.innerHTML : "";
        topicsJSON = element.getAttribute('data-topics') || '{}';
    }

    // Confirma√ß√£o
    if (!silentMode) {
        const label = type === 'toggle' ? "Sec√ß√£o Expans√≠vel" : (type === 'question' ? "Quest√£o" : "SubNota");
        const confirmed = await showConfirmation(
            "Mover para a Lixeira?", 
            `Deseja ocultar "${title}" (${label})?`
        );
        if (!confirmed) return false;
    }

    try {
        const noteRef = doc(db, 'pastas', selectedNoteId);
        await updateDoc(noteRef, {
            [`subnotasocultas.${itemId}`]: {
                id: itemId,
                titulo: title,
                conteudo: content, // HTML interior
                tipo: type,
                topicsJSON: topicsJSON,
                deletedAt: serverTimestamp()
            },
            ultimaedicao: serverTimestamp()
        });
        return true;
    } catch (error) {
        console.error("Erro ao arquivar:", error);
        return false;
    }
}

// ====================================================================

// ==========================================================
// GEST√ÉO DE LINKS DO QUADRO (PUZZLE)
// ==========================================================

let currentBoardRange = null; // Guarda a sele√ß√£o dentro do cart√£o

function openBoardLinkManager(contentDiv) {
    const selection = window.getSelection();
    
    // 1. Validar Sele√ß√£o
    if (selection.rangeCount === 0 || selection.isCollapsed) {
        // Se n√£o houver sele√ß√£o, ver se o cursor est√° dentro de um link existente
        const anchorNode = selection.anchorNode;
        const targetEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const existingLink = targetEl.closest('a.board-link');
        
        if (existingLink) {
            // Editar link existente
            openBoardLinkModal(true, existingLink);
            return;
        } else {
            alert("Selecione o texto que quer transformar em link.");
            return;
        }
    }

    // Verifica se a sele√ß√£o est√° DENTRO da caixa atual
    if (!contentDiv.contains(selection.anchorNode)) return;

    // Guarda a sele√ß√£o para usar depois de fechar o modal
    currentBoardRange = selection.getRangeAt(0).cloneRange();
    
    // Abrir Modal em modo Cria√ß√£o
    openBoardLinkModal(false, selection.toString());
}

function openBoardLinkModal(isEdit, data) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const saveBtn = document.getElementById('link-save-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // Reset UI
    urlsContainer.innerHTML = '';
    modal.style.display = 'flex';
    modal.style.zIndex = '3000'; // Acima de tudo

    // Preparar Bot√µes (Clones para limpar listeners antigos)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    // CONFIGURAR BOT√ÉO ADICIONAR URL
    const addUrlBtn = document.getElementById('add-url-btn');
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = () => addUrlField();

    let existingLinkElement = null;

    if (isEdit) {
        modalTitle.textContent = "Editar Link do Quadro";
        existingLinkElement = data; // O elemento <a>
        titleInput.value = existingLinkElement.textContent;
        newRemoveBtn.style.display = 'block';

        // Ler URLs do atributo data-json
        try {
            const urls = JSON.parse(decodeURIComponent(existingLinkElement.dataset.json));
            urls.forEach(u => addUrlField(u));
        } catch(e) {
            addUrlField(existingLinkElement.href); // Fallback
        }
    } else {
        modalTitle.textContent = "Novo Link no Quadro";
        titleInput.value = data; // O texto selecionado
        newRemoveBtn.style.display = 'none';
        addUrlField();
    }

    // --- A√á√ÉO: GRAVAR ---
    newSaveBtn.onclick = () => {
        const urls = [];
        urlsContainer.querySelectorAll('input').forEach(inp => {
            if(inp.value.trim()) {
                let u = inp.value.trim();
                if(!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (urls.length === 0) return alert("Insira pelo menos um link.");

        // Cria o elemento <a>
        const a = isEdit ? existingLinkElement : document.createElement('a');
        a.href = "#"; // Dummy href
        a.className = "board-link";
        a.style.cursor = "pointer";
        a.textContent = titleInput.value;
        
        // Guarda as URLs no dataset (codificado para seguran√ßa)
        a.dataset.json = encodeURIComponent(JSON.stringify(urls));

        if (!isEdit && currentBoardRange) {
            // Inserir novo
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(currentBoardRange);
            currentBoardRange.deleteContents();
            currentBoardRange.insertNode(a);
        }
        
        modal.style.display = 'none';
    };

    // --- A√á√ÉO: REMOVER ---
    newRemoveBtn.onclick = () => {
        if (existingLinkElement) {
            const text = document.createTextNode(existingLinkElement.textContent);
            existingLinkElement.parentNode.replaceChild(text, existingLinkElement);
        }
        modal.style.display = 'none';
    };
}

// 5. VISUALIZAR LINKS (Ao clicar no texto azul)
function viewBoardLink(linkElement) {
    const modal = document.getElementById('view-link-modal');
    const list = document.getElementById('view-link-urls-list');
    const editBtn = document.getElementById('view-link-edit-btn');
    
    document.getElementById('view-link-title').textContent = linkElement.textContent;
    list.innerHTML = '';
    
    try {
        const urls = JSON.parse(decodeURIComponent(linkElement.dataset.json));
        
        urls.forEach((url, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div style="display: flex; gap: 10px;">
                    <span style="font-weight:bold;">${idx+1}.</span>
                    <a href="${url}" target="_blank" style="color:var(--accent-color); word-break:break-all;">${url}</a>
                </div>
            `;
            list.appendChild(li);
        });

        // Configurar bot√£o de editar do visualizador
        const newEditBtn = editBtn.cloneNode(true);
        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
        
        // S√≥ permite editar se estivermos em modo de edi√ß√£o
        const isEditMode = document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active');
        
        if (isEditMode) {
            newEditBtn.style.display = 'block';
            newEditBtn.onclick = () => {
                modal.style.display = 'none';
                openBoardLinkModal(true, linkElement);
            };
        } else {
            newEditBtn.style.display = 'none';
        }

        modal.style.display = 'flex';
        modal.style.zIndex = '3000';

    } catch(e) {
        console.error("Erro ao ler links:", e);
    }
}


// ====================================================================

tagSuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const li = e.target.closest('li');
    if (li) {
        const selected = tagSuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitTagSelection();
    }
});

entitySuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Impede que o editor perca o foco
    const li = e.target.closest('li');
    if (li) {
        const selected = entitySuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitEntitySelection();
    }
});

// ====================================================================
// L√ìGICA DA TESOURA (Converter Post-it em Texto)
// ====================================================================
noteContentEditor.addEventListener('click', async (e) => {

// -----------------------------------------------------------
// 1. L√ìGICA DO POST-IT (‚úÇÔ∏è) - TESOURA
// -----------------------------------------------------------
if (e.target.classList.contains('post-it-cut-btn')) {
    e.preventDefault(); e.stopPropagation();
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    const contentDiv = postIt.querySelector('.post-it-content');
    const savedHTML = contentDiv.innerHTML;
    const postItRect = postIt.getBoundingClientRect();
    
    const newPara = document.createElement('p');
    newPara.innerHTML = savedHTML || "<br>";
    
    const children = Array.from(noteContentEditor.children);
    let inserted = false;
    for (const child of children) {
        if (child === postIt || child.classList.contains('post-it-note')) continue;
        if (child.getBoundingClientRect().top > postItRect.top) {
            noteContentEditor.insertBefore(newPara, child);
            inserted = true;
            break;
        }
    }
    if (!inserted) noteContentEditor.appendChild(newPara);

    postIt.remove();
    
    // Focar
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(newPara);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
    
    saveNote();
    return; 
}

// -----------------------------------------------------------
// 2. L√ìGICA DO CART√ÉO WEB (‚úï) - REVERTER PARA LINK
// -----------------------------------------------------------
if (e.target.classList.contains('url-card-close')) {
    e.preventDefault(); e.stopPropagation();

    const card = e.target.closest('.url-card-widget');
    if (!card) return;

    const originalUrl = card.dataset.originalUrl;

    // Criar o link de texto original
    const a = document.createElement('a');
    a.href = originalUrl;
    a.textContent = originalUrl;
    a.target = "_blank";
    a.style.color = "var(--accent-color)";
    a.style.textDecoration = "underline";

    card.replaceWith(a);
    
    const space = document.createTextNode('\u00A0');
    a.after(space);

    saveNote();
    return;
}

// -----------------------------------------------------------
// 3. NAVEGA√á√ÉO DO CART√ÉO WEB (Abrir Link) - NOVO!
// -----------------------------------------------------------
const cardWidget = e.target.closest('.url-card-widget');
// Se clicou num card, MAS N√ÉO no bot√£o de fechar
if (cardWidget && !e.target.classList.contains('url-card-close')) {
    e.preventDefault(); 
    e.stopPropagation();

    const url = cardWidget.dataset.originalUrl;
    
    if (url) {
        // Abre numa nova aba
        window.open(url, '_blank');
    }
    return;
}

// -----------------------------------------------------------
// 4. L√ìGICA DE APAGAR SEC√á√ÉO/TOGGLE (üóëÔ∏è)
// -----------------------------------------------------------
const toggleDelBtn = e.target.closest('.toggle-delete-btn');
if (toggleDelBtn) {
    e.preventDefault(); e.stopPropagation();
    const detailsElement = toggleDelBtn.closest('details');
    if (!detailsElement) return;

    const success = await archiveMiniNote(detailsElement); 
    if (success) {
        const marker = document.createElement('span');
        marker.id = `marker_${detailsElement.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        detailsElement.replaceWith(marker);
        saveNote();
    }
    return;
}

// -----------------------------------------------------------
// 5. L√ìGICA DE APAGAR SUBNOTA/QUEST√ÉO (üóëÔ∏è)
// -----------------------------------------------------------
const deleteBtn = e.target.closest('button[data-action="delete-mini-note"]');
if (deleteBtn) {
    e.preventDefault(); e.stopPropagation();
    const wrapper = deleteBtn.closest('.mini-note-wrapper');
    const isQuestion = wrapper.classList.contains('question-mode');
    const label = isQuestion ? "Quest√£o" : "SubNota";

    const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar esta ${label}?`);
    if (!confirmed) return;

    const success = await archiveMiniNote(wrapper, true);
    if (success) {
        const marker = document.createElement('span');
        marker.id = `marker_${wrapper.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        wrapper.replaceWith(marker);
        saveNote();
    }
    return;
}
});

// ====================================================================
// PROTE√á√ÉO: DETETAR DELETE EM MASSA DE MINI-NOTAS
// ====================================================================
noteContentEditor.addEventListener('keydown', async (event) => {
    if (event.key !== 'Delete' && event.key !== 'Backspace') return;

    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    
    // Obt√©m o elemento HTML atual
    const anchorNode = selection.anchorNode;
    const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

    // =================================================================
    // 1. TRATAMENTO ESPEC√çFICO PARA TOGGLES (BACKSPACE)
    // =================================================================
    if (event.key === 'Backspace' && selection.isCollapsed) {
        
        const toggleEl = currentEl.closest('details.toggle-section');

        if (toggleEl) {
            // 1.1: PROTE√á√ÉO DO T√çTULO (Apagar o Toggle inteiro)
            const summary = toggleEl.querySelector('summary');
            if (summary && summary.contains(currentEl)) {
                // Se estiver no in√≠cio do t√≠tulo (offset 0), pergunta se quer apagar
                if (range.startOffset === 0) {
                    event.preventDefault();
                    event.stopPropagation();
                    const success = await archiveMiniNote(toggleEl, false);
                    if (success) {
                        const marker = document.createElement('span');
                        marker.id = `marker_${toggleEl.id}`;
                        marker.className = 'hidden-note-marker';
                        marker.style.display = 'none';
                        toggleEl.replaceWith(marker);
                        saveNote();
                    }
                    return;
                }
            }

            // 1.2: PROTE√á√ÉO DO √çCONE (Ir do Conte√∫do para o T√≠tulo)
            // Se estamos na √°rea de conte√∫do...
            const contentDiv = toggleEl.querySelector('.toggle-content');
            if (contentDiv && contentDiv.contains(currentEl)) {
                
                // ...e estamos no in√≠cio absoluto dessa √°rea (offset 0)
                // (Verifica se √© o primeiro par√°grafo dentro do conte√∫do)
                const firstElement = contentDiv.firstElementChild; // Geralmente o <p>
                const isAtStart = (range.startOffset === 0) && (currentEl === firstElement || firstElement.contains(currentEl));

                if (isAtStart) {
                    // IMPEDE A FUS√ÉO (que apagaria o bot√£o)
                    event.preventDefault();

                    // Mover o cursor manualmente para o fim do H2
                    const h2 = toggleEl.querySelector('h2');
                    if (h2) {
                        const newRange = document.createRange();
                        newRange.selectNodeContents(h2);
                        newRange.collapse(false); // false = ir para o fim do texto
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                    return;
                }
            }
        }
    }

    // 1.3: PROTE√á√ÉO EXTERNA (Backspace de baixo para cima contra o Toggle)
   if (event.key === 'Backspace' && selection.isCollapsed && range.startOffset === 0) {
        
        // 1. Encontra o bloco atual onde estamos a escrever (ex: <p>)
        const currentBlock = currentEl.closest('p, div, h1, h2, h3, h4, h5, h6, li');
        
        if (currentBlock) {
            let prevEl = currentBlock.previousElementSibling;

            // 2. Loop para saltar "lixo" invis√≠vel (BRs, divs vazias de espa√ßamento, etc.)
            // Continua a procurar para tr√°s enquanto o elemento for "vazio" ou irrelevante
            while (prevEl && (
                prevEl.tagName === 'BR' || 
                (prevEl.tagName === 'DIV' && prevEl.style.height === '20px') ||
                (prevEl.textContent.trim() === '' && !prevEl.matches('.mini-note-wrapper, details'))
            )) {
                prevEl = prevEl.previousElementSibling;
            }

            // 3. SE O ELEMENTO REAL ANTERIOR FOR UM TOGGLE
            if (prevEl && prevEl.tagName === 'DETAILS' && prevEl.classList.contains('toggle-section')) {
                console.log("Prote√ß√£o Ativa: Backspace bloqueado contra Toggle.");
                event.preventDefault(); // P√ÅRA TUDO! N√£o deixa o navegador apagar nada.
                event.stopPropagation();

                // L√≥gica de Navega√ß√£o Manual (Foca sem destruir)
                if (prevEl.open) {
                    // Se aberto, tenta focar no √∫ltimo par√°grafo do conte√∫do
                    const contentDiv = prevEl.querySelector('.toggle-content');
                    if (contentDiv) {
                        // Tenta encontrar o √∫ltimo elemento edit√°vel l√° dentro
                        const lastEditable = contentDiv.lastElementChild; 
                        if (lastEditable) {
                            const newRange = document.createRange();
                            newRange.selectNodeContents(lastEditable);
                            newRange.collapse(false); // Cursor no fim
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                            return;
                        }
                    }
                }
                
                // Se fechado (ou falha acima), foca no fim do T√≠tulo H2
                const h2 = prevEl.querySelector('h2');
                if (h2) {
                    const newRange = document.createRange();
                    newRange.selectNodeContents(h2);
                    newRange.collapse(false); // Cursor no fim do t√≠tulo
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
                return;
            }
        }
    }
    // =================================================================

    // 2. SE N√ÉO HOUVER SELE√á√ÉO DE TEXTO, SAI AQUI
    if (selection.isCollapsed) return;

    // --- VERIFICA√á√ÉO DE SEGURAN√áA PARA EDI√á√ÉO INTERNA ---
    const focusNode = selection.focusNode;
    const endEl = focusNode.nodeType === 3 ? focusNode.parentElement : focusNode;

    const startWrapper = currentEl.closest('.mini-note-wrapper, details.toggle-section');
    const endWrapper = endEl.closest('.mini-note-wrapper, details.toggle-section');

    if (startWrapper && startWrapper === endWrapper) {
        return; 
    }

    // 3. PROCURAR SELE√á√ÉO EM MASSA
    const allWrappers = noteContentEditor.querySelectorAll('.mini-note-wrapper, details.toggle-section');
    const wrappersToDelete = [];

    allWrappers.forEach(wrapper => {
        if (selection.containsNode(wrapper, true)) {
            wrappersToDelete.push(wrapper);
        }
    });

    // 4. SE ENCONTRAR ITENS ESPECIAIS:
    if (wrappersToDelete.length > 0) {
        event.preventDefault();
        event.stopPropagation();

        const count = wrappersToDelete.length;
        
        const confirmDelete = await showConfirmation(
            "‚ö†Ô∏è Aten√ß√£o: Dados Importantes", 
            `A sua sele√ß√£o cont√©m ${count} item(s) complexos. \n\nSe continuar, o conte√∫do ser√° salvo no Hist√≥rico antes de apagar. Deseja continuar?`
        );

        if (!confirmDelete) return;

        const modalBtn = document.querySelector('#confirm-modal .modal-btn.primary');
        if(modalBtn) modalBtn.textContent = "A Arquivar...";

        const archivePromises = wrappersToDelete.map(wrapper => archiveMiniNote(wrapper, true)); 
        await Promise.all(archivePromises);

        range.deleteContents();
        saveNote();
    }
});


// --- L√ìGICA DA BARRA DE INSER√á√ÉO R√ÅPIDA (üìò üìí) ---

const insertionPopup = document.getElementById('insertion-popup');

 // 1. APARECER: Ao clicar no editor
noteContentEditor.addEventListener('click', (e) => {
    
    // A. Guardar a altura do clique IMEDIATAMENTE (Esta √© a fonte da verdade para a altura)
    const clickY = e.clientY;

    // PROTE√á√ÉO 1: Se clicou numa ideia, esconder e sair
    if (e.target.closest('.idea-span')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }

    // PROTE√á√ÉO 2: Se clicou DENTRO de um quadrado (Subnota, Quest√£o, etc), esconder e sair.
    // Usamos e.target diretamente, que √© mais fi√°vel que a sele√ß√£o neste momento.
    if (e.target.closest('.mini-note-wrapper')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }

     // >>>>> NOVA PROTE√á√ÉO 3: Se clicou DENTRO do Calend√°rio <<<<<
    if (e.target.closest('.jwn-calendar-widget')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
    // >>>>> FIM DA NOVA PROTE√á√ÉO <<<<<

    // >>>>> NOVA PROTE√á√ÉO 4: Se clicou DENTRO de uma Tabela <<<<<
    if (e.target.closest('table')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
    // >>>>> FIM DA NOVA PROTE√á√ÉO <<<<<

    // ==========================================================
    // >>> ADICIONE ESTE BLOCO NOVO AQUI <<<
    // PROTE√á√ÉO 6: Se clicou DENTRO da Linha Cronol√≥gica
    if (e.target.closest('.jwn-timeline-wrapper')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
     // >>> COLE O C√ìDIGO NOVO AQUI <<<
    // PROTE√á√ÉO 7: T√≠tulo Expans√≠vel (Toggle)
    // Impede o menu de aparecer na barra de t√≠tulo, mas permite no conte√∫do
    if (e.target.closest('summary')) {
        document.getElementById('insertion-popup').style.display = 'none';
        return; 
    }
    // >>> FIM DO C√ìDIGO NOVO <<<
    // ==========================================================
    // Timeout breve apenas para verificar se o utilizador n√£o selecionou texto
    setTimeout(() => {
        const selection = window.getSelection();
        
        // S√≥ mostramos se N√ÉO houver texto selecionado (isCollapsed = true)
        if (selection && selection.rangeCount > 0 && selection.isCollapsed) {
            
            // Fecha outros popups
            if(document.getElementById('selection-popup')) document.getElementById('selection-popup').style.display = 'none';
            if(document.getElementById('idea-actions-popup')) document.getElementById('idea-actions-popup').style.display = 'none';

            const popup = document.getElementById('insertion-popup');
            
            // --- POSICIONAMENTO DEFINITIVO ---

            // 1. Horizontal (X): Sempre alinhado √† margem esquerda do Editor
            const editorRect = noteContentEditor.getBoundingClientRect();
            const leftPos = editorRect.left;

            // 2. Vertical (Y): A altura onde o rato clicou
            const topPos = clickY;

            popup.style.display = 'flex';
            
            // Aplica as posi√ß√µes (com ajuste de scroll e offset de 45px para cima)
            popup.style.top = `${topPos + window.scrollY - 85}px`; 
            popup.style.left = `${leftPos + window.scrollX + 10}px`; // +10px de margem visual

        } else {
            // Se houver texto selecionado, esconde este popup
            document.getElementById('insertion-popup').style.display = 'none';
        }
    }, 10); 
});

// 2. DESAPARECER: Ao come√ßar a escrever
noteContentEditor.addEventListener('keydown', () => {
    insertionPopup.style.display = 'none';
});

// 3. A√á√ïES DOS BOT√ïES
insertionPopup.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    if (action === 'quick-mini-note') {
        insertMiniNoteAtCursor('default'); // Subnota normal
        saveNote();
        insertionPopup.style.display = 'none';
    } 
    else if (action === 'insert-free-container') {
    insertMiniNoteAtCursor('free'); // Contentor Laranja
    saveNote();
    insertionPopup.style.display = 'none';
}
    // NOVO BLOCO PARA QUEST√ÉO
    else if (action === 'insert-question') {
        insertMiniNoteAtCursor('question'); // Quest√£o Verde
        saveNote();
        insertionPopup.style.display = 'none';
    }
    else if (action === 'quick-placeholder') {
        // A√á√ÉO DO BOT√ÉO üìí: ABRE O MENU DE TAMANHOS
        const sizePopup = document.getElementById('postit-size-popup');
        
        // Posiciona ao lado do menu atual
        const rect = insertionPopup.getBoundingClientRect();
        sizePopup.style.top = rect.top + 'px';
        sizePopup.style.left = (rect.right + 5) + 'px';
        sizePopup.style.display = 'flex';
        
        // N√£o escondemos o insertionPopup ainda para n√£o perder contexto visual
    }
});

// Garante que esconde se fizermos scroll
document.addEventListener('scroll', () => {
    insertionPopup.style.display = 'none';
}, true);

// --- L√ìGICA INTELIGENTE DE ARRASTO ---
noteContentEditor.addEventListener('mouseover', (e) => {
    // Verifica se estamos a passar o rato por cima de um post-it
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    // Verifica se estamos EXATAMENTE em cima do puxador amarelo
    const isHandle = e.target.closest('.post-it-drag-handle');
    
    if (isHandle) {
        // RATO NO PUXADOR: Ativa o modo de arrastar
        postIt.setAttribute('draggable', 'true');
    } else {
        // RATO NO TEXTO: Desativa o modo de arrastar (para permitir selecionar texto)
        postIt.setAttribute('draggable', 'false');
    }
});


// ====================================================================
// L√ìGICA DO MENU DE TAMANHOS DE POST-IT
// ====================================================================
document.getElementById('postit-size-popup').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const size = btn.dataset.size;
    
    // Define dimens√µes baseadas na escolha
    let width, height;
    
    if (size === 'small') {
        width = '150px'; height = '100px';
    } else if (size === 'medium') {
        width = '250px'; height = '180px';
    } else if (size === 'large') {
        width = '400px'; height = '300px';
    }

    // Cria o post-it vazio
    createPostItElement("", width, height);

    // Fecha tudo
    document.getElementById('postit-size-popup').style.display = 'none';
    document.getElementById('insertion-popup').style.display = 'none';
});

// Fechar menu de tamanhos se clicar fora
document.addEventListener('click', (e) => {
    const sizePopup = document.getElementById('postit-size-popup');
    if (sizePopup.style.display !== 'none' && !sizePopup.contains(e.target)) {
        sizePopup.style.display = 'none';
    }
});

// ====================================================================
// FECHAR MENUS FLUTUANTES AO CLICAR NA 4¬™ COLUNA
// ====================================================================
document.getElementById('references-panel').addEventListener('click', () => {
    // 1. Esconde a barra de inser√ß√£o (üìò üìó üìô üìí)
    const insertionPopup = document.getElementById('insertion-popup');
    if (insertionPopup) {
        insertionPopup.style.display = 'none';
    }

    // 2. (Recomendado) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üìç) se estiver aberto
    const selectionPopup = document.getElementById('selection-popup');
    if (selectionPopup) {
        selectionPopup.style.display = 'none';
    }
    
    // 3. (Recomendado) Esconde o menu de a√ß√µes da Ideia (‚úÇÔ∏è)
    const ideaPopup = document.getElementById('idea-actions-popup');
    if (ideaPopup) {
        ideaPopup.style.display = 'none';
    }
});

// ====================================================================
// L√ìGICA DE MOVIMENTO LIVRE (ABSOLUTO) PARA POST-ITS
// ====================================================================

let activePostIt = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

// 1. Clicar no Puxador (Iniciar)
noteContentEditor.addEventListener('mousedown', (e) => {
    const handle = e.target.closest('.post-it-drag-handle');
    if (!handle) return;

    e.preventDefault(); // Impede sele√ß√£o de texto

    activePostIt = handle.closest('.post-it-note');
    
    // Calcula onde clic√°mos DENTRO do post-it (o "ponto de agarre")
    const rect = activePostIt.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    activePostIt.style.opacity = '0.8';
    activePostIt.style.zIndex = '100';
});

// 2. Mover o Rato (Arrastar)
document.addEventListener('mousemove', (e) => {
    if (!activePostIt) return;

    e.preventDefault();

    const container = document.getElementById('note-content-editor');
    
    // Obter as coordenadas do contentor (Editor)
    const containerRect = container.getBoundingClientRect();

    // Calcular a posi√ß√£o X/Y desejada relativa ao contentor
    // (Posi√ß√£oRato - Posi√ß√£oContainer + ScrollContainer - PontoDeAgarre)
    let newLeft = (e.clientX - containerRect.left + container.scrollLeft) - dragOffsetX;
    let newTop = (e.clientY - containerRect.top + container.scrollTop) - dragOffsetY;

    // --- APLICAR LIMITES (CLAMPING) ---
    
    // Limite Horizontal (0 at√© LarguraContainer - LarguraPostIt)
    // Subtra√≠mos 2px extra de seguran√ßa para bordas
    const maxLeft = container.clientWidth - activePostIt.offsetWidth;
    if (newLeft < 0) newLeft = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;

    // Limite Vertical (0 at√© AlturaTotalContainer - AlturaPostIt)
    // Usamos scrollHeight para permitir arrastar at√© ao fundo do texto longo
    const maxTop = container.scrollHeight - activePostIt.offsetHeight;
    if (newTop < 0) newTop = 0;
    if (newTop > maxTop) newTop = maxTop;

    // Aplicar
    activePostIt.style.left = newLeft + 'px';
    activePostIt.style.top = newTop + 'px';
});

// 3. Largar o Rato (Finalizar)
document.addEventListener('mouseup', () => {
    if (activePostIt) {
        activePostIt.style.opacity = '1';
        activePostIt.style.zIndex = '20';
        activePostIt = null;
        saveNote(); 
    }
});

// ====================================================================
// ADICIONE ESTE BLOCO DE EVENT LISTENERS NO FINAL DO SCRIPT
// ====================================================================
document.getElementById('references-toolbar').addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;

    const { id, type, name } = activeReferenceEntity;
    if (!id || !type || !name) {
        console.error("Nenhuma entidade de refer√™ncia ativa.");
        return;
    }

    switch (button.id) {
        case 'references-refresh-btn':
            console.log("A atualizar refer√™ncias...");
            showReferencesPanel(id, name, type);
            break;

            case 'references-bookmark-btn': // <--- NOVO CASO
            openBookmarksModal();
            break;
        // --- NOVO C√ìDIGO AQUI ---
        case 'references-wol-btn':
            // Codifica o nome (ex: "Malaquias 1:3-5") para formato URL e substitui espa√ßos por '+'
            // O encodeURIComponent transforma espa√ßos em %20, o replace muda para + para ficar igual ao seu exemplo
            const encodedQuery = encodeURIComponent(name).replace(/%20/g, '+');
            
            // Constr√≥i o URL espec√≠fico de "lookup" (/wol/l/)
            const wolUrl = `https://wol.jw.org/pt-PT/wol/l/r296/lp-tpo?q=${encodedQuery}`;
            
            window.open(wolUrl, '_blank');
            break;
        // ------------------------

        case 'references-search-btn':
            const query = encodeURIComponent(name);
            const searchUrl = `https://wol.jw.org/pt/wol/s/r5/lp-t?q=${query}`;
            window.open(searchUrl, '_blank');
            break;

        case 'references-edit-btn':
            openEditEntityModal(id, type);
            break;

        case 'references-toggle-btn':
            const allDetails = document.querySelectorAll('#references-list details');
            if (allDetails.length === 0) return;
            const openCount = document.querySelectorAll('#references-list details[open]').length;
            const shouldOpen = openCount <= allDetails.length / 2;
            allDetails.forEach(detail => {
                detail.open = shouldOpen;
            });
            break;
    }
});

document.getElementById('toggle-puzzle-edit-btn').addEventListener('click', async () => {
    console.log("üñ±Ô∏è [CLICK] Bot√£o Editar/Conclu√≠do clicado.");

    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

  // A. ENTRAR NO MODO EDI√á√ÉO
if (!container.classList.contains('edit-mode-active')) {
    console.log("‚úèÔ∏è [MODE] A entrar em modo EDI√á√ÉO.");
    container.classList.add('edit-mode-active');
    
    // LINHA ALTERADA:
    btn.textContent = "Salvar"; 
    
    btn.style.color = "var(--accent-color)";
    btn.style.borderColor = "var(--accent-color)";
    
    if(addButtons) addButtons.style.display = 'flex';

        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'true');
            div.style.border = "1px solid var(--border-color)";
            div.style.padding = "8px";
            div.style.borderRadius = "4px";
            div.style.backgroundColor = "var(--bg-color)";
        });
    } 
    // B. SAIR DO MODO EDI√á√ÉO (CLICOU EM CONCLU√çDO)
    else {
        console.log("üíæ [MODE] Clicou Conclu√≠do. A chamar savePuzzleData()...");
        
        // Gravar explicitamente
        await savePuzzleData();

        console.log("üîí [MODE] Voltando a modo LEITURA.");

        // Reverter UI
        container.classList.remove('edit-mode-active');
        btn.textContent = "Editar";
        btn.style.color = "";
        btn.style.borderColor = "";
        
        if(addButtons) addButtons.style.display = 'none';

        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'false');
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
});

// ====================================================================
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// ====================================================================
document.getElementById('references-list').addEventListener('click', async (e) => {
    
    // LOG DE DEBUG: Para confirmar que o clique no painel foi apanhado
    console.log("üñ±Ô∏è Clique no painel direito detetado em:", e.target);

    // Verifica se clicou na seta "Ir para"
    const goToButton = e.target.closest('.go-to-note-btn');
    if (!goToButton) return;

    e.preventDefault(); 
    e.stopPropagation();

    // Lemos os dados do bot√£o
    const { noteId, searchTerm } = goToButton.dataset;
    console.log(`üîπ Bot√£o seta clicado! ID: ${noteId}, Termo: ${searchTerm}`);
    
    if (!noteId) return;

    // --- 1. VERIFICA√á√ÉO DE SEGURAN√áA (SENHA) ---
    try {
        const noteSnap = await getDoc(doc(db, 'pastas', noteId));
        if (noteSnap.exists()) {
            const nData = noteSnap.data();
            // Se tiver senha e n√£o estiver desbloqueada
            if (nData.passe && nData.passe.trim() !== "" && !sessionUnlockedFolders.has(noteId)) {
                const access = await requestPassword('access', noteId);
                if (access) sessionUnlockedFolders.add(noteId);
                else return; // Senha errada, p√°ra tudo
            }
        }
    } catch(err) { 
        console.error("Erro seguran√ßa:", err); 
        return; 
    }

    // --- 2. CHAMAR A NAVEGA√á√ÉO INTELIGENTE ---
    console.log("üöÄ A chamar navigateToNoteSmart...");
    
    // Verifica altera√ß√µes n√£o guardadas antes de navegar
    navigateWithUnsavedCheck(() => {
        navigateToNoteSmart(noteId, searchTerm); 
    });
});



 document.getElementById('anchors-modal').addEventListener('click', (e) => {
    // 1. CLIQUE NAS ABAS
    const tabButton = e.target.closest('button[data-tab]');
    if (tabButton) {
        // Remove active de todos
        document.querySelectorAll('#anchors-tabs-container button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#anchors-content-container .tab-content').forEach(content => content.classList.remove('active'));
        
        // Ativa o selecionado
        tabButton.classList.add('active');
        const contentId = `tab-${tabButton.dataset.tab}`;
        const contentDiv = document.getElementById(contentId);
        if(contentDiv) contentDiv.classList.add('active');
        return;
    }

    // 2. CLIQUE NUM ITEM DA LISTA (Tag ou Entidade)
    const listItem = e.target.closest('li');
    if (listItem) {
        // A√ß√£o para TAGS
        if (listItem.dataset.action === 'show-tag-references') {
            const tagName = listItem.dataset.tagName;
            if (tagName) {
                document.getElementById('anchors-modal').style.display = 'none';
                showTagReferencesPanel(tagName);
            }
        }
        // A√ß√£o para ENTIDADES (Usa o dataset action ou verifica entityId como fallback)
        else if (listItem.dataset.entityId || listItem.dataset.action === 'show-entity-references') {
            const { entityId, entityName, entityType } = listItem.dataset;
            if (entityId) {
                document.getElementById('anchors-modal').style.display = 'none';
                showReferencesPanel(entityId, entityName, entityType);
            }
        }
    }
});

referencesPanelCloseBtn.addEventListener('click', hideReferencesPanel);


// 1. Abrir Modal de Conta
document.getElementById('account-btn').addEventListener('click', () => {
    const modal = document.getElementById('account-modal');
    const nameDisplay = document.getElementById('profile-name-display');
    const emailDisplay = document.getElementById('profile-email-display');

    // Preenche os dados
    if (currentUserData) {
        nameDisplay.textContent = currentUserData.nome || "Sem Nome";
        emailDisplay.textContent = currentUserData.email || auth.currentUser.email;
    } else if (auth.currentUser) {
        nameDisplay.textContent = "Usu√°rio";
        emailDisplay.textContent = auth.currentUser.email;
    }

    modal.style.display = 'flex';
});

// 2. Bot√£o de Logout (Dentro do Modal de Conta)
document.getElementById('logout-btn').addEventListener('click', async () => {
    const confirmLogout = confirm("Tem certeza que deseja sair?");
    if (confirmLogout) {
        try {
            await signOut(auth);
            // onAuthStateChanged vai redirecionar
        } catch (error) {
            console.error("Erro ao sair", error);
        }
    }
});

    </script>
</body>
</html>
