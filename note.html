<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaBook - Notes</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczNbOBxcAwWmdQfM23rP7EAZINaQRQFX53uMo14hPhWvC3lsPy1inv3b42P5T2iFJ8Ot-bsLFUcOb0G4tVevedv1jtFxTlzGHyc00ddx94QViaji6vp0KuRcw1eC_WbddVVCPidHPoCJLZuwNdbr02ZC=w192-h192-s-no-gm?authuser=4">

   
  
<style>
/* ============================================================
   VARI√ÅVEIS E RESET
   ============================================================ */
:root {
    --bg-color: #1a1a1d;
    --sidebar-color: #252528;
    --panel-color: #1f1f22;
    --accent-color: #4a90e2;
    --text-color: #f0f0f0;
    --text-muted-color: #888;
    --border-color: #333;
    --hover-color: #2c2c30;
    --selected-color: #3a5370;
    
    /* Cores Espec√≠ficas para Modos */
    --question-color: #1e8449;
    --question-bg: rgba(20, 90, 50, 0.08);
    --container-color: #e67e22; /* Laranja */
    --container-bg: rgba(230, 126, 34, 0.08);
    
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-color); 
    overflow: hidden; 
    height: 100vh; 
}

/* Scrollbars Modernas */
* { scrollbar-width: thin; scrollbar-color: var(--text-muted-color) var(--panel-color); }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: var(--panel-color); border-radius: 10px; }
::-webkit-scrollbar-thumb {
    background-color: var(--text-muted-color); border-radius: 10px;
    border: 2px solid var(--panel-color);
}
::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

/* ============================================================
   ESTRUTURA PRINCIPAL (LAYOUT)
   ============================================================ */
.notebook-container { display: flex; height: 100vh; width: 100vw; }
#left-panel, #middle-panel, #right-panel { height: 100%; display: flex; flex-direction: column; }

/* 1. PAINEL ESQUERDO (PASTAS) */
#left-panel { 
    flex: 0 0 240px; 
    background-color: var(--sidebar-color); 
    border-right: 1px solid var(--border-color); 
    padding: 15px; 
    justify-content: space-between; 
    transition: all 0.3s ease-in-out; 
    overflow: hidden;
}

/* 2. PAINEL DO MEIO (LISTA DE NOTAS) */
#middle-panel { 
    flex: 0 0 240px; 
    background-color: var(--panel-color); 
    border-right: 1px solid var(--border-color); 
    
    /* MANTENHA O RESTO, MAS ALTERE O PADDING: */
    padding: 20px 20px 0 20px !important; /* Topo, Dir, Fundo=0, Esq */
    
    transition: all 0.3s ease; 
    overflow: hidden;
    display: flex;       /* Garante que √© flex */
    flex-direction: column;
}

/* 3. PAINEL DIREITO (EDITOR - A NOTA) */
#right-panel { 
    flex: 1; /* Ocupa o espa√ßo que sobrar */
    min-width: 0; /* CR√çTICO: Permite que o editor encolha quando a 4¬™ coluna abre */
    background-color: var(--bg-color); 
    padding: 20px; 
    position: relative; 
    transition: all 0.3s ease;
}

/* ESTILOS DO SELETOR LOCAL | PARTILHA */
.folder-mode-container {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Espalha os itens uniformemente */
    gap: 2px; /* Reduz o espa√ßo entre itens para caber tudo */
    font-size: 13px; /* Reduzido de 18px para caber na linha */
    font-weight: 600; /* Um pouco mais de peso para compensar o tamanho */
    color: var(--text-muted-color);
    width: 100%;
    white-space: nowrap; /* Impede quebra de linha */
    padding: 0 2px; /* Pequena margem de seguran√ßa */
}

.folder-mode-item {
    cursor: pointer;
    transition: color 0.2s, text-shadow 0.2s;
    user-select: none;
    position: relative;
    padding: 4px 0; /* Aumenta √°rea de toque vertical */
}

.folder-mode-item:hover {
    color: var(--text-color);
}

.folder-mode-item.active {
    color: var(--text-color);
    font-weight: bold;
}

/* Pequeno ponto azul por baixo do ativo */
.folder-mode-item.active::after {
    content: '';
    position: absolute;
    bottom: 0px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--accent-color);
    border-radius: 2px;
}

/* Separador mais fino */
.folder-mode-separator {
    color: var(--border-color);
    font-weight: normal;
    font-size: 0.8em;
    opacity: 0.5;
}

/* Adicione tamb√©m o estilo para o modo Flash (Amarelo, por exemplo) */
.folder-mode-item.active.mode-flash {
    color: #f1c40f !important; /* Amarelo */
}
.folder-mode-item.active.mode-flash::after {
    background-color: #f1c40f !important;
}

/* ============================================================
   4. PAINEL DE REFER√äNCIAS (4¬™ COLUNA) - AJUSTE DE TAMANHO
   ============================================================ */

/* QUANDO ABERTO: FOR√áA 50% DA LARGURA DO ECR√É */
.notebook-container.references-panel-visible #references-panel {
    display: flex !important; /* Garante que n√£o est√° como none */
    flex: 0 0 400px !important; 
    width: 400px !important;
    min-width: 400px !important;
    opacity: 1 !important;
    visibility: visible !important;
    padding: 20px !important;
    border-left: 1px solid var(--border-color) !important;
}

/* No PC, o painel direito deve encolher para dar lugar √† 4¬™ coluna */
.notebook-container.references-panel-visible #right-panel {
    flex: 1 !important;
    min-width: 0 !important;
}


/* ============================================================
   CORRE√á√ÉO DO BOT√ÉO TOGGLE ‚Üñ (COLLAPSE DA ESQUERDA)
   ============================================================ */

/* 1. Quando ativo, ESCONDE o painel esquerdo (Pastas) */
.notebook-container.middle-panel-collapsed #left-panel {
    display: none !important;
    width: 0 !important;
    flex: 0 0 0 !important;
    padding: 0 !important;
    border: none !important;
}

/* 2. O painel do Meio (Lista) mant√©m o tamanho normal */
.notebook-container.middle-panel-collapsed #middle-panel {
    width: 240px !important; 
    flex: 0 0 240px !important;
}

/* 3. O painel da Direita (Editor) ocupa todo o espa√ßo restante */
.notebook-container.middle-panel-collapsed #right-panel {
    display: flex !important;
    flex: 1 !important;
    opacity: 1 !important;
}

/* 4. Ajustes do Cabe√ßalho para manter tudo bonito */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header {
    display: flex !important;
    flex-direction: row !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
}

/* Garante que os bot√µes do cabe√ßalho continuam vis√≠veis */
.notebook-container.middle-panel-collapsed #middle-panel .panel-header > * {
    display: flex !important;
}

/* --- ESTILO VERMELHO PARA O BOT√ÉO ADICIONAR (MODO PARTILHA) --- */
#add-item-btn.shared-mode {
    border-color: #e74c3c !important;
    color: #e74c3c !important;
}

#add-item-btn.shared-mode:hover {
    background-color: #e74c3c !important;
    color: white !important;
}

/* ============================================================
   ELEMENTOS INTERNOS (Listas, Bot√µes, etc)
   ============================================================ */
.panel-content { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
#left-panel-list, #file-list { list-style-type: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }

/* Cabe√ßalhos e Rodap√©s de Painel */
.panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.panel-header h2 { font-size: 18px; font-weight: 500; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
.panel-footer { height: 50px !important; /* Mesma altura da direita */ border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-around; /* Se o #left-panel tiver padding de 15px, usamos isto para colar √†s bordas: */ margin: 0 -15px -15px -15px !important; padding: 0 10px; flex-shrink: 0; background-color: var(--sidebar-color); /* Garante que o fundo tapa tudo */ z-index: 5; }

/* Bot√µes de Controlo de Painel */
#left-panel-toggle-btn { display: none; background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 32px; height: 32px; border-radius: 5px; font-size: 20px; cursor: pointer; margin: 15px auto; }
#left-panel-toggle-btn:hover { background-color: var(--accent-color); }

#middle-panel-toggle-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; line-height: 1; margin-right: 10px; }
#middle-panel-toggle-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

#back-btn { background: none; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; margin-right: 10px; }
#back-btn:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--text-color); }

/* Tabs */
.tabs-container { display: flex; justify-content: space-around; margin-bottom: 10px; }
.tabs-container button { background: none; border: none; color: var(--text-muted-color); padding: 10px; flex-grow: 1; text-align: center; font-size: 15px; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
.tabs-container button:hover { background-color: var(--hover-color); color: var(--text-color); }
.tabs-container button.active { background-color: var(--accent-color); color: white; font-weight: bold; }
#left-panel hr { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0 15px 0; }

/* Listas (Esquerda e Meio) */
.list-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s ease; display: flex; align-items: center; user-select: none; position: relative; }
.list-item:before { font-size: 18px; margin-right: 10px; }
.list-item[data-type="pasta"]:before { content: 'üìÅ'; }
.list-item[data-type="nota"]:before { content: 'üìÑ'; }
.list-item[data-type="agregacao"]:before { content: 'üß¨'; } 
.list-item[data-type="arquivo"]:before { content: 'üóÑÔ∏è'; }
.list-item[data-type="partilhado"]:before { content: 'üóÑÔ∏è'; }
.list-item[data-type="jornal"]:before { content: 'üì∞'; }
.list-item:hover { background-color: var(--hover-color); }
.list-item.selected { background-color: var(--selected-color); }

/* Menu de 3 pontos no item */
.item-menu-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 20px; padding: 0 8px; border-radius: 5px; cursor: pointer; display: none; }
.list-item:hover .item-menu-btn { display: block; }
.item-menu-btn:hover { background-color: var(--bg-color); color: var(--text-color); }

/* Bot√µes de A√ß√£o Rodap√©/Topo */
#add-item-btn { background: none; border: 2px solid var(--accent-color); color: var(--accent-color); width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
#add-item-btn:hover { background-color: var(--accent-color); color: white; }
#settings-btn, #account-btn, #global-search-btn { background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; flex-grow: 1; /* Isto faz com que dividam o espa√ßo igualmente */ text-align: center; padding: 5px; border-radius: 5px; }
#settings-btn:hover, #account-btn:hover, #global-search-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* ============================================================
   CORRE√á√ÉO DE TEXTO LONGO NAS LISTAS (QUEBRA DE LINHA)
   ============================================================ */

/* 1. Garante que a lista nunca tem scroll horizontal */
#left-panel-list, #file-list {
    overflow-x: hidden !important;
}

/* 2. Ajuste no contentor do item para permitir altura vari√°vel */
.list-item {
    height: auto !important; /* Permite crescer em altura */
    min-height: 44px; /* Altura m√≠nima para ser clic√°vel */
    align-items: center !important; /* Mant√©m √≠cone centrado verticalmente */
}

/* 3. A regra principal: For√ßa o texto (span) a quebrar linha */
.list-item span {
    white-space: normal !important;   /* Permite quebra de linha */
    word-break: break-word !important; /* Quebra palavras muito longas */
    overflow-wrap: break-word !important; /* Standard moderno */
    line-height: 1.4 !important;      /* Espa√ßamento para leitura f√°cil */
    flex: 1;                          /* Ocupa o espa√ßo dispon√≠vel */
    padding-right: 5px;               /* Espa√ßo para n√£o colar √† direita */
}

/* ============================================================
   PAINEL DIREITO: EDITOR
   ============================================================ */
#editor-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-muted-color); text-align: center; height: 100%;}
#editor-placeholder .placeholder-icon { font-size: 60px; margin-bottom: 20px; }
#note-title-input { background: none; border: none; color: var(--text-color); font-size: 2.5em; font-weight: bold; padding: 10px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); outline: none; width: 100%; }

/* Barra de Ferramentas Principal */
#editor-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 6px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
}
.toolbar-group { display: flex; align-items: center; gap: 5px; }
#editor-toolbar button, #secondary-toolbar button {
    background: var(--hover-color); border: none; color: var(--text-color); min-width: 32px; height: 32px;
    padding: 0 8px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#editor-toolbar button:hover, #secondary-toolbar button:hover { background-color: var(--accent-color); }
#editor-toolbar input[type="color"], #secondary-toolbar input[type="color"] {
    width: 32px; height: 32px; border: none; background: none; cursor: pointer; padding: 2px;
}
.toolbar-separator { width: 1px; height: 25px; background-color: var(--border-color); margin: 0 10px; }
.toolbar-history { margin-left: auto; display: flex; align-items: center; }

/* Barra de Ferramentas Secund√°ria */
#secondary-toolbar {
    display: flex; align-items: center; background-color: var(--panel-color); padding: 8px;
    border-radius: 0 0 6px 6px; margin-top: -10px; margin-bottom: 15px; flex-wrap: wrap;
    gap: 10px; border-top: 1px solid var(--border-color); animation: slideDown 0.2s ease-out;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
#toggle-more-tools-btn.active { background-color: var(--selected-color); transform: rotate(180deg); }

/* Zoom Select */
#editor-zoom {
    background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color);
    border-radius: 5px; padding: 0 5px; height: 32px; cursor: pointer; outline: none; font-size: 14px; margin-right: 5px;
}
#editor-zoom:hover { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
#editor-zoom option { background-color: var(--sidebar-color); color: var(--text-color); }


/* Adicione isto em qualquer lugar no seu CSS principal */
#note-content-editor {
    position: relative; 
    background: none; 
     overflow-anchor: none !important;  /* Impede o navegador de ajustar o scroll */
    overscroll-behavior-y: contain;    /* Evita o efeito el√°stico no topo/fundo */
    border: none; 
    color: var(--text-color); 
    font-size: 1.1em;
    line-height: 1.6; 
    outline: none; 
    width: 100%; 
    
    /* --- CORRE√á√ÉO DE SCROLL --- */
    flex: 1;                 /* Ocupa todo o espa√ßo restante */
    overflow-y: auto;        /* Ativa o scroll vertical AQUI */
    overflow-x: hidden; 
    min-height: 0;           /* Refor√ßo para o Firefox/Safari mobile */
    padding: 5px 5px 50px 5px; /* Padding extra no fundo para o teclado n√£o tapar texto */
    
    /* --- MOTOR DE TOQUE NATIVO --- */
    -webkit-overflow-scrolling: touch; 
    touch-action: pan-y;
}

#note-content-editor h1 { font-size: 2em; font-weight: bold; border-bottom: 1px solid var(--border-color); color: var(--accent-color); margin: 0.6em 0; }
#note-content-editor h2 { font-size: 1.5em; font-weight: bold; color: var(--text-color); margin: 0.5em 0; }
#note-content-editor h3 { font-size: 1.17em; font-weight: bold; color: var(--text-muted-color); margin-bottom: 0.5em; }
#note-content-editor h4 { font-size: 1em; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5em; }
#note-content-editor p { margin: 0.5em 0; }

/* For√ßa consist√™ncia de tamanho dentro do editor */
#note-content-editor p, 
#note-content-editor div, 
#note-content-editor li, 
#note-content-editor span {
    font-size: inherit; /* Herda o tamanho do pai (o editor) */
    line-height: inherit;
}

/* Tags e Entidades no Texto */
.tag { background-color: var(--selected-color); color: var(--accent-color); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
.entity-link { background-color: rgba(74, 144, 226, 0.2); border-bottom: 1px dashed var(--accent-color); cursor: pointer; }
.entity-link[data-entity-type="personagem"] { background-color: rgba(230, 126, 34, 0.2); border-bottom-color: #e67e22; }
.entity-link[data-entity-type="local"] { background-color: rgba(46, 204, 113, 0.2); border-bottom-color: #2ecc71; }
.entity-link[data-entity-type="data"] { background-color: rgba(155, 89, 182, 0.2); border-bottom-color: #9b59b2; }
a[data-anexo-id] { color: inherit; text-decoration: none; border-bottom: 1px dotted var(--accent-color); cursor: pointer; }
.idea-span { text-decoration: underline; text-decoration-color: #e74c3c; text-decoration-thickness: 3px; cursor: pointer; background-color: rgba(231, 76, 60, 0.1); }
.idea-span:hover { background-color: rgba(231, 76, 60, 0.2); }

/* ============================================================
   POST-IT FLUTUANTE (Amarelo, Arrast√°vel)
   ============================================================ */
.post-it-note {
    position: absolute; display: flex; flex-direction: column;
    background-color: #fff9c4; border: 1px solid #f1c40f;
    resize: both; overflow: hidden; min-width: 150px; min-height: 80px;
    box-shadow: 4px 4px 10px rgba(0,0,0,0.2); z-index: 20;
}
.post-it-note::-webkit-resizer { background-color: #f1c40f; }
.post-it-note.active-note { border-color: #f39c12; z-index: 50; }

.post-it-drag-handle {
    position: absolute; top: 0; right: 0; width: 25px; height: 25px;
    background-color: #f1c40f; color: #333; cursor: grab; z-index: 10;
    display: flex; align-items: center; justify-content: center;
    border-bottom-left-radius: 4px; user-select: none;
}
.post-it-drag-handle:active { cursor: grabbing; background-color: #d4ac0d; }
.post-it-drag-handle:hover { background-color: #d4ac0d; }

.post-it-cut-btn {
    position: absolute; top: 0; left: 0; width: 25px; height: 25px;
    background-color: transparent; cursor: pointer; z-index: 100;
    display: none; align-items: center; justify-content: center;
    font-size: 16px; user-select: none; border-bottom-right-radius: 4px;
}
.post-it-note.active-note .post-it-cut-btn { display: flex; }
.post-it-cut-btn:hover { background-color: rgba(0,0,0,0.1); }

.post-it-content {
    background-color: transparent; color: #333; padding: 10px;
    height: 100%; width: 100%; outline: none; overflow-y: auto; cursor: text; user-select: text;
}

/* ============================================================
   MINI-NOTAS & QUEST√ïES (Embutidas no texto)
   ============================================================ */
/* Estilo Base (SubNota Padr√£o) */
.mini-note-wrapper {
    display: block; 
    position: relative; 
    margin: 30px -25px; 
    width: auto;
    
    /* --- MUDAN√áA 1: Fundo Azul Suave (igual √† l√≥gica da Quest√£o) --- */
    background-color: rgba(74, 144, 226, 0.08); 
    
    /* --- MUDAN√áA 2: Bordas superior/inferior Azuis --- */
    border-top: 1px solid var(--accent-color); 
    border-bottom: 1px solid var(--accent-color);
    
    padding: 20px 25px; 
    box-sizing: border-box;
}

/* A barra grossa no topo (Mant√©m-se azul) */
.mini-note-wrapper::before {
    content: ''; 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 4px;
    background: var(--accent-color); 
    opacity: 0.8;
}

/* Modo Quest√£o (Verde) */
.mini-note-wrapper.question-mode {
    background-color: var(--question-bg);
    border-color: var(--question-color);
}
.mini-note-wrapper.question-mode::before { background: var(--question-color); }

/* Componentes Internos */
.mini-note-title-input {
    display: block;
    width: 100%;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid var(--border-color) !important;
    color: var(--accent-color) !important;
    
    /* FOR√áA A FONTE ORIGINAL DO TEU SITE */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 1.4em !important;
    font-weight: bold !important;
    
    padding: 0 !important;
    margin: 0 0 15px 0 !important;
    outline: none !important;
    resize: none !important;
    
    /* REMOVE BARRA DE SCROLL E SETA */
    overflow: hidden !important; 
    line-height: 1.2 !important;
}

/* QUANDO A OP√á√ÉO EST√Å DESLIGADA (Imita o input antigo) */
.mini-note-title-input:not(.wrap-enabled) {
    white-space: nowrap !important; /* Impede quebra de linha */
    height: 1.5em !important;       /* Altura exata de uma linha */
}

/* QUANDO A OP√á√ÉO EST√Å LIGADA */
.mini-note-title-input.wrap-enabled {
    white-space: pre-wrap !important; /* Permite quebra de linha */
    height: auto;
}

/* Garante que se for Quest√£o, mant√©m o Verde */
.mini-note-wrapper.question-mode .mini-note-title-input {
    color: var(--question-color) !important;
}

/* Quando a configura√ß√£o estiver ativa, o campo expande */
.mini-note-title-input.wrap-enabled {
    word-break: break-word;
}

.mini-note-wrapper.question-mode .mini-note-title-input { color: var(--question-color); }

.mini-note-content {
    outline: none; min-height: 60px; font-size: 1em; line-height: 1.6; color: var(--text-color); padding: 5px;
}

.mini-note-toolbar {
    display: flex; justify-content: flex-end; background: transparent;
    padding: 0; margin-bottom: 5px; border: none; height: 30px;
    font-size: 0 !important;
}
.mini-note-toolbar button[data-action="delete-mini-note"] {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    width: 30px; height: 30px; border-radius: 4px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); color: #e74c3c; border-color: #e74c3c;
}
.mini-note-wrapper.question-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(30, 132, 73, 0.15); color: var(--question-color); border-color: var(--question-color);
}
/* Esconde bot√µes desnecess√°rios dentro da mini-nota */
.mini-note-toolbar button:not([data-action="sharing-settings"]):not([data-action="delete-mini-note"]):not([data-action="manage-mini-note-topics"]):not([data-action="highlight-color"]):not([data-action="append-mini-note"]):not([data-action="move-up"]):not([data-action="move-down"]):not([data-action="manage-box-links"]),
.mini-note-toolbar input[type="color"],
.mini-note-toolbar .toolbar-separator { 
    display: none !important; 
}

/* Atualiza√ß√£o na sec√ß√£o .mini-note-toolbar */
.mini-note-toolbar button {
    background: none; 
    border: 1px solid var(--border-color); 
    color: var(--text-muted-color);
    width: 30px; 
    height: 30px; 
    border-radius: 4px; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: all 0.2s;
    margin-left: 5px; /* Espa√ßo entre bot√µes */
    font-size: 14px !important;
}

/* Hover espec√≠fico para o bot√£o de T√≥picos */
.mini-note-toolbar button[data-action="manage-mini-note-topics"]:hover {
    background-color: rgba(74, 144, 226, 0.1); 
    color: var(--accent-color); 
    border-color: var(--accent-color);
}

/* Mant√©m o hover vermelho para o lixo */
.mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(192, 57, 43, 0.1); 
    color: #e74c3c; 
    border-color: #e74c3c;
}

/* Modo Contentor Livre (Laranja) */
.mini-note-wrapper.free-mode {
    background-color: var(--container-bg);
    border-color: var(--container-color);
}
.mini-note-wrapper.free-mode::before { 
    background: var(--container-color); 
}

/* Ajuste da Toolbar no modo livre (j√° que n√£o tem t√≠tulo, garantimos que fica no topo) */
.mini-note-wrapper.free-mode .mini-note-toolbar {
    margin-bottom: 0;
    padding-bottom: 5px;
}

/* Hover dos bot√µes no modo laranja */
.mini-note-wrapper.free-mode .mini-note-toolbar button[data-action="delete-mini-note"]:hover {
    background-color: rgba(230, 126, 34, 0.15); 
    color: var(--container-color); 
    border-color: var(--container-color);
}

/* ============================================================
   POPUPS E MODAIS
   ============================================================ */
/* Popups Flutuantes (Sele√ß√£o e Inser√ß√£o) */
#selection-popup, #insertion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 30px; padding: 5px 10px; display: flex; gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4); align-items: center; z-index: 1010;
}
#selection-popup button, #insertion-popup button {
    background: none; border: none; color: var(--text-color); padding: 6px;
    cursor: pointer; border-radius: 50%; font-size: 18px; line-height: 1;
    transition: transform 0.2s, background-color 0.2s; width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
}
#selection-popup button:hover, #insertion-popup button:hover {
    background-color: var(--hover-color); transform: scale(1.15);
}


.popup-separator { width: 1px; height: 20px; background-color: var(--text-muted-color); opacity: 0.4; margin: 0 4px; }

/* Popup de Sugest√£o (Tags/Entidades) */
.suggestion-popup {
    background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-height: 250px; overflow-y: auto; width: 350px;
}
.suggestion-list { list-style: none; padding: 5px; }
.suggestion-list li {
    padding: 8px 12px; border-radius: 4px; cursor: pointer; color: var(--text-color);
    display: flex; align-items: center;
}
.suggestion-list li:hover, .suggestion-list li.selected { background-color: var(--accent-color); color: white; }
#entity-suggestion-popup .suggestion-list li span { margin-left: auto; padding-left: 1em; }
#entity-suggestion-popup .suggestion-list li:hover span, #entity-suggestion-popup .suggestion-list li.selected span { color: white !important; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="personagem"] span { color: #e67e22; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="local"] span { color: #2ecc71; font-weight: 500; }
#entity-suggestion-popup .suggestion-list li[data-entity-type="data"] span { color: #9b59b2; font-weight: 500; }

/* Menu de Contexto (3 Pontos) */
.context-menu {
    position: absolute; background-color: var(--sidebar-color); border: 1px solid var(--border-color);
    border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001;
    display: flex; flex-direction: column; padding: 5px; width: 160px;
}
.context-menu button {
    background: none; border: none; color: var(--text-color); padding: 8px 15px;
    text-align: left; cursor: pointer; border-radius: 4px; width: 100%; white-space: nowrap;
}
.context-menu button:hover { background-color: var(--accent-color); color: white; }

/* Modais (Sobreposi√ß√£o) */
.modal-overlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: none; /* O JS muda isto para flex */
    justify-content: center;
    align-items: center; 
    
    /* O JS vai sobrescrever isto para 2147483647 quando estiver no Aqu√°rio */
    z-index: 20000; 
}
.modal-content {
    background-color: var(--sidebar-color); padding: 30px; border-radius: 8px;
    width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-content h3 { margin-bottom: 20px; font-size: 22px; }
.modal-content p { margin-bottom: 20px; color: var(--text-muted-color); }
.modal-content input[type="text"], .modal-content input[type="password"], .modal-content textarea {
    width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color);
    border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;
}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
.modal-btn:hover { opacity: 0.9; }
.modal-btn.primary { background-color: var(--accent-color); color: white; }
.modal-btn.secondary { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos Espec√≠ficos de Modais */
#add-item-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
#add-item-options button {
    background-color: var(--panel-color); border: 1px solid var(--border-color);
    color: var(--text-color); padding: 15px; text-align: left; border-radius: 5px;
    cursor: pointer; font-size: 16px; transition: background-color 0.2s;
}
#add-item-options button:hover { background-color: var(--hover-color); }

.move-list { list-style: none; max-height: 40vh; overflow-y: auto; }
.move-list li {
    background-color: var(--bg-color); padding: 10px; border-radius: 5px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
}
.move-list .order-controls button {
    background: none; border: 1px solid var(--border-color); color: var(--text-color);
    width: 28px; height: 28px; cursor: pointer; border-radius: 5px; margin-left: 5px;
}
.move-list .order-controls button:hover { background-color: var(--hover-color); }
.move-list .order-controls button:disabled { opacity: 0.3; cursor: not-allowed; }

#link-modal .url-field-wrapper { display: flex; gap: 8px; }
#link-modal .remove-url-btn {
    background-color: #c0392b; color: white; padding: 0; width: 38px; height: 38px;
    min-width: unset; flex-shrink: 0; font-size: 24px; display: flex;
    align-items: center; justify-content: center;
}
#generic-list-modal-content, #view-link-modal .modal-content { max-width: 700px; }
#view-link-urls-list li { padding: 12px; background-color: var(--bg-color); }
#view-link-urls-list li a {
    color: var(--accent-color); text-decoration: none; display: block;
    word-break: break-all; font-weight: 500;
}
#view-link-urls-list li a:hover { text-decoration: underline; }



/* ============================================================
   CORRE√á√ÉO: TAMANHO FIXO DO MODAL DE LINKS (‚ö°)
   ============================================================ */

/* 1. Define uma altura fixa para a caixa branca/escura */
#link-modal .modal-content {
    height: 70vh !important;       /* Ocupa 70% da altura do ecr√£ (Tamanho generoso tipo Codex) */
    min-height: 550px !important;  /* Garante altura m√≠nima em ecr√£s pequenos */
    display: flex !important;      /* Ativa Flexbox */
    flex-direction: column !important;
    overflow: hidden !important;   /* Impede que o modal cres√ßa mais */
}

/* 2. √Årea de Conte√∫do das Abas (Onde est√£o os inputs) */
/* Isto faz com que o conte√∫do ocupe o espa√ßo dispon√≠vel e tenha scroll individual */
.box-tab-content {
    flex-grow: 1;              /* Estica para ocupar o espa√ßo vazio */
    overflow-y: auto;          /* Adiciona scroll vertical se necess√°rio */
    overflow-x: hidden;
    padding-right: 5px;        /* Espa√ßo para n√£o tapar o scroll */
    margin-bottom: 10px;
    
    /* Garante que o conte√∫do come√ßa no topo */
    display: block; 
}

/* 3. Ajuste do Cabe√ßalho e Rodap√© para n√£o mexerem */
#link-modal h3, 
#link-modal .tabs-container {
    flex-shrink: 0; /* Impede que encolham */
}

#link-modal .modal-actions {
    margin-top: auto;          /* Cola os bot√µes ao fundo da caixa */
    flex-shrink: 0;            /* Impede que encolham */
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    background-color: var(--sidebar-color); /* Garante que o fundo n√£o √© transparente */
}

/* 4. Ajuste Mobile para n√£o sair do ecr√£ */
@media (max-width: 768px) {
    #link-modal .modal-content {
        height: 85vh !important; /* Mais alto no telem√≥vel */
        min-height: 0 !important;
    }
}

/* ============================================================
   PAINEL DE REFER√äNCIAS (4¬™ COLUNA)
   ============================================================ */
#references-panel {
    flex: 0 0 0; width: 0; background-color: var(--sidebar-color); padding: 0; height: 100%;
    display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; opacity: 0;
    border-left: 1px solid var(--border-color);
}

#references-panel-close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 24px; cursor: pointer; }
#references-panel-description {
    font-size: 0.85em;
    color: var(--text-muted-color);
    margin-bottom: 8px; /* Reduzido de 20px para 8px */
    padding: 0 5px;
    line-height: 1.5;
    font-style: italic;
    border-left: 3px solid var(--accent-color);
    padding-left: 10px;
}
.references-separator { border: none; height: 1px; background-color: var(--border-color); margin: 5px 0; /* Reduzido de 15px para 5px */ }
#references-toolbar { display: flex; justify-content: space-around; align-items: center; padding: 0 10px; }
#references-toolbar button {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 20px;
    cursor: pointer; padding: 8px; border-radius: 5px; transition: all 0.2s ease; line-height: 1;
}
#references-toolbar button:hover { background-color: var(--hover-color); color: var(--text-color); border-color: var(--border-color); }

#references-list { list-style-type: none; overflow-y: auto; flex-grow: 1; }
#references-list li {
    padding: 12px; border-radius: 5px; cursor: pointer; margin-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
}
#references-list li:hover { background-color: var(--hover-color); }
#references-list details.reference-item {
    padding: 12px; border-radius: 5px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color);
}
#references-list details.reference-item[open] { background-color: var(--hover-color); }
#references-list summary { cursor: pointer; font-weight: 500; list-style: none; display: flex; justify-content: space-between; align-items: center; }
#references-list summary::-webkit-details-marker { display: none; }
#references-list summary:hover { color: var(--accent-color); }
.reference-item.link-info summary { color: var(--accent-color); font-weight: bold; }
.reference-context {
    margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--accent-color);
    color: var(--text-muted-color); font-size: 0.9em; line-height: 1.5;
}
.reference-context mark { background-color: rgba(74, 144, 226, 0.4); color: var(--text-color); border-radius: 3px; padding: 1px 3px; }

/* Bot√£o "Ir para" nas refer√™ncias */
.go-to-note-btn {
    background: none; border: 1px solid transparent; color: var(--text-muted-color); font-size: 18px;
    cursor: pointer; padding: 4px 8px; border-radius: 5px; margin-left: 10px; line-height: 1;
    transition: all 0.2s ease; display: none;
}
.reference-item:hover .go-to-note-btn { display: block; }
.go-to-note-btn:hover { background-color: var(--hover-color); color: var(--accent-color); }

/* ============================================================
   OUTROS PAINEIS E UTILIT√ÅRIOS
   ============================================================ */
/* Modal de T√≥picos */
.topics-layout { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
.topics-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background-color: var(--bg-color);
    padding: 10px;
    min-height: 0; /* IMPORTANTE: permite que o conte√∫do interno encolha e ative o scroll */
}


.topics-list li {
    padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;
    display: flex; align-items: center; transition: background 0.2s;
}
.topics-list {
    list-style: none;
    overflow-y: auto;   /* Ativa o scroll vertical */
    flex-grow: 1;       /* Faz a lista ocupar o espa√ßo todo da coluna */
    max-height: 100%;   /* Garante que n√£o ultrapassa o limite do pai */
    padding-right: 5px; /* Espa√ßo para a barra de scroll n√£o tapar o texto */
}

/* Mantenha o que j√° tem abaixo */
.topics-list li {
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background 0.2s;
}
.topics-list li:hover { background-color: var(--hover-color); }
.topics-list li.active-topic { background-color: rgba(74, 144, 226, 0.2); border-left: 3px solid var(--accent-color); }
.topic-checkbox { margin-right: 10px; width: 16px; height: 16px; cursor: pointer; }
.create-btn { width: 100%; padding: 8px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
.topic-search-input { width: 100%; padding: 8px; margin-bottom: 10px; background-color: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; }

/* Filtro e Pesquisa */
.filter-bar { display: flex; justify-content: flex-end; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); position: relative; }
.filter-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
.filter-btn:hover, .filter-btn.active { background-color: var(--hover-color); color: var(--text-color); border-color: var(--accent-color); }
.filter-popup { position: absolute; top: 35px; right: 0; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; width: 150px; display: none; flex-direction: column; }
.filter-popup button { background: none; border: none; color: var(--text-color); padding: 10px; text-align: left; cursor: pointer; font-size: 0.9em; }
.filter-popup button:hover { background-color: var(--hover-color); }
.filter-popup button.selected { color: var(--accent-color); font-weight: bold; }
.group-header { background-color: var(--hover-color); color: var(--accent-color); padding: 8px 10px; font-weight: bold; font-size: 0.85em; border-radius: 4px; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
.list-search-container { padding-bottom: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); cursor: default; }
.list-search-input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; outline: none; transition: border-color 0.2s; }
.list-search-input:focus { border-color: var(--accent-color); }

/* Configura√ß√µes (Switches) */
.setting-toggle-container { display: flex; align-items: center; margin-bottom: 15px; }
.setting-label { margin-left: 12px; font-size: 0.95em; color: var(--text-color); }
.setting-switch { position: relative; display: inline-block; width: 40px; height: 20px; flex-shrink: 0; }
.setting-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 20px; }
.slider.round:before { border-radius: 50%; }

/* Perfil */
.profile-info { text-align: center; margin-bottom: 20px; }
.profile-avatar { font-size: 50px; margin-bottom: 10px; display: block; }
.profile-name { font-size: 1.2em; font-weight: bold; color: var(--text-color); display: block; margin-bottom: 5px; }
.profile-email { color: var(--text-muted-color); font-size: 0.9em; }

/* Status de Grava√ß√£o */
.save-status { 
    font-size: 0.8em; 
    color: var(--text-muted-color); 
    margin-right: 15px; 
    transition: all 0.3s ease; 
    font-style: italic; 
    font-weight: 500;
    cursor: pointer;
}

.save-status:hover {
    text-decoration: underline;
    color: var(--accent-color);
}

.save-status.status-saved { color: #27ae60; cursor: default; }
.save-status.status-error { color: #c0392b; cursor: pointer; }
#connectivity-status { display: none; color: #e74c3c; font-weight: bold; margin-right: 15px; font-size: 0.8em; animation: blink 1.5s linear infinite; }
#connectivity-status.visible { display: inline; }
@keyframes blink { 50% { opacity: 0.5; } }

/* Spinner */
.spinner-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 0; color: var(--text-muted-color); font-size: 0.9em; font-style: italic; }
.spinner { width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.1); border-left-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Marcadores (Bookmarks) */
.bookmark-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
.bookmark-item:hover { background-color: var(--hover-color); }
.bookmark-info { display: flex; flex-direction: column; }
.bookmark-title { font-weight: 500; color: var(--text-color); }
.bookmark-desc { font-size: 0.8em; color: var(--text-muted-color); }
.bookmark-check { width: 20px; height: 20px; border: 2px solid var(--text-muted-color); border-radius: 4px; margin-left: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.bookmark-item.active .bookmark-check { background-color: var(--accent-color); border-color: var(--accent-color); }
.bookmark-item.active .bookmark-check::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

/* √Çncoras e Tabs */
#anchors-content-container .tab-content { display: none; max-height: 50vh; overflow-y: auto; }
#anchors-content-container .tab-content.active { display: block; }
#anchors-content-container li { padding: 10px; border-radius: 5px; cursor: pointer; position: relative; }
#anchors-content-container li:hover { background-color: var(--hover-color); }
#anchors-content-container li.is-on-page { background-color: #27ae60; color: white; }
.entity-edit-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted-color); font-size: 22px; line-height: 1; padding: 5px; border-radius: 5px; cursor: pointer; display: none; }
#anchors-content-container li:hover .entity-edit-btn { display: block; }
.entity-edit-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Estilos para a Aba de Pesquisa Global */
.search-container { padding: 10px; }
.global-search-input {
    width: 100%; padding: 12px; font-size: 16px;
    background-color: var(--bg-color); border: 2px solid var(--border-color);
    border-radius: 8px; color: var(--text-color); outline: none;
    transition: border-color 0.3s; margin-bottom: 20px;
}
.global-search-input:focus { border-color: var(--accent-color); }

.search-results-group { margin-bottom: 20px; }
.search-results-header {
    font-size: 0.9em; text-transform: uppercase; color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color); margin-bottom: 10px; padding-bottom: 5px;
}
.search-result-item {
    background-color: rgba(255, 255, 255, 0.03); border-radius: 6px;
    padding: 12px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
    border-left: 3px solid transparent;
}
.search-result-item:hover { background-color: var(--hover-color); border-left-color: var(--accent-color); }
.search-result-title { font-weight: bold; color: var(--accent-color); display: block; margin-bottom: 4px; }
.search-result-path { font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 6px; display: block; }
.search-match-context {
    font-size: 0.9em; color: var(--text-color); line-height: 1.5;
    background-color: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;
    font-family: monospace;
}
.search-match-context mark { background-color: rgba(241, 196, 15, 0.4); color: white; border-radius: 2px; padding: 0 2px; }
.search-badge {
    font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 8px;
    text-transform: uppercase; font-weight: bold;
}
.badge-pasta { background-color: rgba(52, 152, 219, 0.2); color: #3498db; }
.badge-nota { background-color: rgba(46, 204, 113, 0.2); color: #2ecc71; }
.badge-postit { background-color: rgba(241, 196, 15, 0.2); color: #f1c40f; }
.badge-question { background-color: rgba(39, 174, 96, 0.2); color: #27ae60; }

@keyframes flash-highlight {
    0% { background-color: rgba(241, 196, 15, 0.8); }
    100% { background-color: transparent; }
}

.temporary-highlight {
    animation: flash-highlight 2s ease-out;
}

/* --- ESTILOS DO MODAL DE DESTAQUES (NOVO) --- */
/* 1. Contentor do Modal */
/* 1. Contentor do Modal */
#highlight-modal .modal-content {
    max-width: 500px !important; 
    width: 95%;
    padding: 20px;
}

/* 2. Grelha das Op√ß√µes */
#highlight-options-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 colunas no PC */
    gap: 12px;
    max-height: 65vh; 
    overflow-y: auto;
    overflow-x: hidden;
    margin-top: 15px;
    padding: 5px;
}

/* 3. Item Individual (O Quadrado) */
#highlight-options-container .highlight-option-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 15px 5px 10px 5px; /* Espa√ßo no topo para o l√°pis n√£o bater */
    border-radius: 8px;
    cursor: pointer;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s;
    height: 100px; 
    position: relative; /* CR√çTICO: Base para o l√°pis no canto */
    text-align: center;
    box-sizing: border-box;
}

/* 4. A BOLA DA COR */
#highlight-options-container .color-preview-box {
    width: 28px !important;
    height: 28px !important;
    border-radius: 50%;
    margin-bottom: 8px;
    flex-shrink: 0;
    display: block !important;
    border: 1px solid rgba(255,255,255,0.2);
}

/* 5. O BOT√ÉO DO L√ÅPIS (REPOSICIONADO NO CANTO) */
#highlight-options-container .highlight-options-btn {
    position: absolute !important; /* Retira do fluxo vertical */
    top: 5px !important;           /* Cola no topo */
    right: 5px !important;         /* Cola na direita */
    width: 22px !important;        /* Tamanho pequeno */
    height: 22px !important;
    font-size: 12px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 0 !important;
    margin: 0 !important;
    opacity: 0.6;
    transition: opacity 0.2s, background 0.2s;
}

#highlight-options-container .highlight-options-btn:hover {
    opacity: 1;
    background: var(--accent-color) !important;
    color: white;
}

/* 6. Ajuste do Nome/Label */
#highlight-options-container .highlight-name-label {
    font-size: 11px;
    font-weight: 500;
    line-height: 1.2;
    color: var(--text-color);
    width: 90%;
    overflow: hidden;
}

/* 7. Media Query para Mobile (At√© 480px) */
@media (max-width: 480px) {
    #highlight-options-container {
        grid-template-columns: repeat(2, 1fr); /* 2 colunas no Mobile */
        gap: 10px;
    }
    #highlight-options-container .highlight-option-row {
        height: 110px;
    }
    #highlight-options-container .highlight-name-label {
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
}

/* 8. Bot√£o Remover Destaque */
#highlight-options-container .remove-highlight-row {
    grid-column: 1 / -1;
    flex-direction: row;
    height: 48px;
    gap: 10px;
    border: 1px dashed #e74c3c;
    color: #e74c3c;
    font-weight: bold;
}

/* 8. Estilo do Selecionado */
.highlight-option-row.selected-color-row {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,0.3);
}

.highlight-option-row.selected-color-row .highlight-options-btn {
    color: white !important;
    opacity: 1;
}

/* Check no canto */
.highlight-option-row.selected-color-row::after {
    content: '‚úì';
    position: absolute;
    top: 2px;
    left: 6px;
    font-weight: bold;
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ============================================================
   ESTILOS DE TABELA E MENU (SOLU√á√ÉO FLEXBOX - BLOCO S√ìLIDO)
   ============================================================ */

/* 1. O Contentor √© agora uma Pilha Vertical */
.jwn-table-wrapper {
    display: flex;
    flex-direction: column; /* Um item em cima do outro */
    align-items: flex-end;  /* Alinha tudo √† direita (onde queremos o bot√£o) */
    width: 100%;
    margin: 15px 0;
    z-index: 5;
    position: relative;
    
    /* Impede que o browser tente selecionar a caixa como texto */
    user-select: none; 
}

/* 2. O Bot√£o agora ocupa espa√ßo f√≠sico real */
.table-settings-btn {
    position: relative; /* Deixa de ser absolute */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    
    height: 30px;
    padding: 0 12px;
    
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-bottom: none; /* Remove a borda de baixo para fundir */
    border-radius: 6px 6px 0 0;
    
    color: var(--text-muted-color);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    pointer-events: auto;
    
    /* TRUQUE: Margem negativa para "comer" a borda da tabela e parecer uma pe√ßa √∫nica */
    margin-bottom: -1px; 
    z-index: 10; /* Fica por cima da borda da tabela */
}

.table-settings-btn:hover, .table-settings-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* 3. A Tabela ocupa a largura toda */
.jwn-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95em;
    
    /* Garante que a tabela tem uma borda superior onde o bot√£o vai encostar */
    border-top: 1px solid var(--border-color); 
    
    /* Como usamos flex-end no pai, a tabela ficaria encostada √† direita.
       Isto for√ßa-a a ocupar a largura toda: */
    align-self: stretch; 
}

.jwn-table th, .jwn-table td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    min-width: 50px;
    position: relative;
    
    /* Permite selecionar texto DENTRO das c√©lulas */
    user-select: text; 
}

.jwn-table th {
    background-color: var(--sidebar-color);
    font-weight: bold;
    text-align: left;
    color: var(--accent-color);
}

.jwn-table td:hover, .jwn-table th:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* ============================================================
   MENU DE TABELA (GRELHA - MANT√âM IGUAL)
   ============================================================ */
#table-tools-popup {
    display: none;
    position: absolute;
    background-color: rgba(35, 35, 40, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    z-index: 2000;
    padding: 10px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    width: 200px;
    animation: fadeIn 0.2s ease-out;
}

#table-tools-popup .menu-title {
    grid-column: span 2;
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-muted-color);
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 5px;
    margin-bottom: 5px;
    font-weight: bold;
    letter-spacing: 1px;
}

#table-tools-popup button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid transparent;
    color: var(--text-color);
    border-radius: 6px;
    padding: 8px 5px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

#table-tools-popup button:hover {
    background-color: var(--accent-color);
    color: white;
    transform: translateY(-2px);
}

#table-tools-popup button[data-action^="del-"] {
    background: rgba(231, 76, 60, 0.1);
    border-color: rgba(231, 76, 60, 0.3);
    color: #e74c3c;
}

#table-tools-popup button[data-action^="del-"]:hover {
    background-color: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

#table-tools-popup button[data-action="del-table"] {
    grid-column: span 2;
    margin-top: 5px;
    font-weight: bold;
}

/* ============================================================
   WIDGET DE CALEND√ÅRIO
   ============================================================ */
.jwn-calendar-widget {
    border: 1px solid var(--border-color);
    background-color: var(--sidebar-color);
    border-radius: 8px;
    padding: 10px;
    margin: 15px 0;
    width: 100%;
    max-width: 350px; /* Tamanho compacto */
    user-select: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
     position: relative;
    z-index: 1;
}

/* Cabe√ßalho: M√™s + Bot√µes */
.cal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    color: var(--accent-color);
    font-weight: bold;
}
.cal-btn {
    background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text-muted-color); padding: 4px 8px; border-radius: 4px;
}
.cal-btn:hover { background-color: var(--hover-color); color: var(--text-color); }

/* Menu de Defini√ß√µes (Semana/M√™s/Ano) */
.cal-settings-menu {
    display: none;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
    background: var(--panel-color);
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    animation: slideDown 0.2s ease-out;
}

/* CLASSE QUE O JS ATIVA (Isto √© o que faz aparecer) */
.cal-settings-menu.visible {
    display: flex !important;
}

/* Bot√µes de Visualiza√ß√£o */

.cal-view-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Bot√£o Eliminar */
.cal-delete-btn {
    width: 100%;
    background-color: rgba(231, 76, 60, 0.1);
    border: 1px solid #c0392b;
    color: #e74c3c;
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
}
.cal-delete-btn:hover {
    background-color: #c0392b;
    color: white;
}

.cal-settings-menu.visible { display: flex; }
.cal-view-btn {
    font-size: 0.8em; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; background: var(--panel-color); color: var(--text-color);
}
.cal-view-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }

/* Grelha de Dias */
.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
}
.cal-day-header {
    font-size: 0.75em; color: var(--text-muted-color); padding-bottom: 5px;
}
.cal-day {
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    position: relative;
    border: 1px solid transparent;
}
.cal-day:hover { background-color: var(--hover-color); border-color: var(--border-color); }
.cal-day.empty { background: transparent; cursor: default; }
.cal-day.today { border: 1px solid var(--accent-color); font-weight: bold; color: var(--accent-color); }

/* Ponto indicador de tarefa */
.cal-day.has-task {
    font-weight: bold; /* Opcional: p√µe o n√∫mero a negrito */
}


.cal-day.has-task::after { content: ''; position: absolute; bottom: 4px; /* Ajuste a altura */ left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #e74c3c; /* Vermelho */ border-radius: 50%; z-index: 2; }
/* Garante que o dia tem posi√ß√£o relativa para o ponto ficar dentro dele */
.cal-day {
    position: relative; 
}

/* Estilos para o Seletor de Agrega√ß√£o */
.agreg-item {
    display: flex; 
    align-items: center; 
    padding: 10px; 
    border-bottom: 1px solid var(--border-color); 
    cursor: pointer;
}
.agreg-item:hover { background-color: var(--hover-color); }

/* Tipos de Item */
.agreg-type-folder { font-weight: bold; color: var(--text-color); }
.agreg-type-note { color: var(--text-muted-color); }

/* Caixas de Conte√∫do (Miniaturas) */
.agreg-box-item {
    background-color: rgba(255,255,255,0.03);
    margin: 5px 0;
    border-left: 4px solid transparent;
    padding: 10px;
    border-radius: 4px;
    display: flex;
    gap: 10px;
}
.agreg-box-item.selected {
    background-color: rgba(74, 144, 226, 0.15);
    border: 1px solid var(--accent-color);
}

/* Cores das Bordas das Caixas */
.agreg-box-question { border-left-color: #2ecc71; } /* Verde */
.agreg-box-subnote { border-left-color: #3498db; }  /* Azul */
.agreg-box-free { border-left-color: #e67e22; }     /* Laranja */

/* --- NOVO: POPUP DE DEFINI√á√ïES DE PARTILHA --- */
#share-settings-popup {
    display: none;
    position: absolute;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    z-index: 2200;
    padding: 15px;
    width: 220px;
    flex-direction: column;
    gap: 10px;
}

#share-settings-popup h4 {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    text-transform: uppercase;
    color: var(--text-muted-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
}

.share-toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95em;
    color: var(--text-color);
}

/* Estado visual do bot√£o na toolbar quando partilhado */
button.sharing-active {
    color: #2ecc71 !important; /* Verde */
    border-color: #2ecc71 !important;
    background-color: rgba(46, 204, 113, 0.1) !important;
}

/* ============================================================
   ESTILO T√çTULO TOGGLE (EXPANS√çVEL)
   ============================================================ */
details.toggle-section {
    margin: 15px 0;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.02);
    display: block; 
    height: auto; /* Garante que a altura √© autom√°tica */
}

details.toggle-section summary {
    padding: 10px;
    cursor: pointer;
    list-style: none !important;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
    user-select: none;
}

/* Remove a seta padr√£o no Chrome/Safari */
details.toggle-section summary::-webkit-details-marker {
   display: none !important;
}

details.toggle-section summary:hover {
    background-color: var(--hover-color);
}

details.toggle-section summary::marker {
    display: none !important; /* Refor√ßo para navegadores modernos */
}

/* A nossa seta personalizada */
details.toggle-section summary::before {
    content: '‚òÇ';
    display: inline-block;
    width: 20px;
    font-size: 12px;
    color: var(--text-muted-color);
    transition: transform 0.2s ease;
    margin-right: 8px;
}

/* Quando aberto, roda a seta */
details.toggle-section[open] summary::before {
    transform: rotate(90deg);
}

/* O T√≠tulo H2 l√° dentro */
details.toggle-section summary h2 {
    margin: 0;
    display: inline;
    border: none;
    font-size: 1.5em; /* Tamanho A2 */
    font-weight: bold;
    color: var(--text-color); /* Herda cor ou usa padr√£o */
}

/* O conte√∫do oculto */
details.toggle-section .toggle-content {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: rgba(0, 0, 0, 0.1);
    
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* Usa normal em vez de pre-wrap para evitar conflito com <br> */
    display: block;
    height: auto !important; /* For√ßa altura autom√°tica */
}

/* Bot√£o de eliminar dentro do Toggle */
.toggle-delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-delete-btn:hover {
    opacity: 1;
    background-color: rgba(192, 57, 43, 0.1); /* Fundo vermelho suave */
}

/* Garante que o T√≠tulo ocupa o espa√ßo todo para empurrar o lixo para a direita */
details.toggle-section summary h2 {
    flex-grow: 1;
}

/* Bot√£o do Pincel (igual ao do lixo, mas margem ajustada) */
.toggle-color-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-color-btn:hover {
    opacity: 1;
    background-color: rgba(255, 255, 255, 0.1);
}

/* Estilo das bolas de cor no popup */
.color-choice {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}
.color-choice:hover {
    transform: scale(1.15);
    border-color: var(--text-color);
}

/* Bot√µes de Mover dentro do Toggle */
.toggle-move-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px; /* Um pouco menor que o t√≠tulo */
    margin-left: 5px;
    opacity: 0.4;
    transition: all 0.2s;
    padding: 5px;
    border-radius: 4px;
}

.toggle-move-btn:hover {
    opacity: 1;
    background-color: var(--hover-color);
}


/* Corre√ß√£o de tamanho de texto dentro dos Toggles */
details.toggle-section .toggle-content, 
details.toggle-section .toggle-content p, 
details.toggle-section .toggle-content div {
    font-size: 1em !important; /* 1em significa "igual ao tamanho atual" */
    line-height: inherit !important;
}

/* ============================================================
   ESTILO DO AGRUPADOR DE SETAS (NOVO)
   ============================================================ */
.toolbar-btn-group {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color); /* A borda do ret√¢ngulo */
    border-radius: 4px;
    margin-left: 5px;
    height: 30px;
    overflow: hidden; /* Garante cantos arredondados */
    background-color: transparent;
}

/* Removemos o estilo padr√£o dos bot√µes APENAS quando est√£o dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button {
    border: none !important;       /* Sem borda individual */
    border-radius: 0 !important;   /* Sem cantos redondos individuais */
    margin-left: 0 !important;     /* Sem espa√ßo entre eles */
    width: 28px !important;        /* Largura fixa */
    height: 100% !important;
}

/* Adiciona a linha separadora no meio */
.mini-note-toolbar .toolbar-btn-group button:first-child {
    border-right: none !important; /* <--- MUDAR AQUI PARA "none" */
}

/* Efeito Hover dentro do grupo */
.mini-note-toolbar .toolbar-btn-group button:hover {
    background-color: var(--hover-color);
}
/* ============================================================
   WIDGET DE LINHA CRONOL√ìGICA (TIMELINE)
   ============================================================ */
.jwn-timeline-wrapper {
    position: relative;
    padding: 20px 10px;
    margin: 15px 0;
    background-color: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* A Linha Vertical */
.timeline-track {
    position: absolute;
    left: 30px; /* Posi√ß√£o da linha */
    top: 20px;
    bottom: 50px; /* Espa√ßo para o bot√£o adicionar */
    width: 2px;
    background-color: var(--accent-color);
    opacity: 0.5;
}

/* O item individual */
.timeline-entry {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-left: 45px; /* Espa√ßo para a bolinha e linha */
}

/* A bolinha (marcador) */
.t-marker {
    position: absolute;
    left: 24px; /* Centrado na linha (30px - metade da bola) */
    top: 5px;
    width: 14px;
    height: 14px;
    background-color: var(--bg-color);
    border: 2px solid var(--accent-color);
    border-radius: 50%;
    z-index: 2;
    transition: background-color 0.2s;
}

.timeline-entry:hover .t-marker {
    background-color: var(--accent-color);
}

/* Campos de Texto */
.t-date {
    font-weight: bold;
    color: var(--accent-color);
    min-width: 80px;
    margin-right: 10px;
    font-size: 0.9em;
    border-bottom: 1px dashed transparent;
}

.t-text {
    flex-grow: 1;
    color: var(--text-color);
    line-height: 1.4;
}

.t-date:focus, .t-text:focus {
    outline: none;
    border-bottom-color: var(--accent-color);
}

/* Bot√µes de A√ß√£o */
.t-btn-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0;
    margin-left: 10px;
    transition: opacity 0.2s;
}

.timeline-entry:hover .t-btn-del {
    opacity: 1;
}

.t-btn-add {
    display: block;
    margin-left: 23px; /* Alinhado com a linha */
    background: none;
    border: 1px dashed var(--text-muted-color);
    color: var(--text-muted-color);
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    margin-top: 10px;
    transition: all 0.2s;
}

.t-btn-add:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

   /* --- ESTILOS DO SCANNER UNIVERSAL --- */
/* Estilo para os itens do scanner b√≠blico */
.bible-scan-item {
    display: flex;
    align-items: center;
    padding: 8px;
    background-color: var(--bg-color);
    border-radius: 4px;
    margin-bottom: 5px;
    cursor: pointer;
}
.bible-scan-item:hover {
    background-color: var(--hover-color);
}
.bible-scan-item input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.bible-scan-item label {
    flex-grow: 1;
    cursor: pointer;
    font-weight: 500;
}
.bible-scan-existing-item {
    padding: 8px;
    color: #2ecc71; /* Verde */
    font-weight: 500;
    display: flex;
    align-items: center;
}
.bible-scan-existing-item::before {
    content: '‚úì';
    margin-right: 10px;
    font-weight: bold;
}
/* Abas */
.scan-tabs {
    display: flex;
    gap: 10px;
}
.scan-tab-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: var(--text-muted-color);
    border-bottom: 3px solid transparent;
    font-weight: 500;
    transition: all 0.2s;
}
.scan-tab-btn:hover {
    color: var(--text-color);
    background-color: var(--hover-color);
    border-radius: 4px 4px 0 0;
}
.scan-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

/* Itens da Lista */
.scan-item-row {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-color);
    margin-bottom: 5px;
    border-radius: 4px;
}
.scan-item-row:hover {
    background-color: var(--hover-color);
}
.scan-checkbox {
    width: 18px; height: 18px; margin-right: 10px; cursor: pointer;
}
.scan-info {
    flex-grow: 1; display: flex; flex-direction: column;
}
.scan-name {
    font-weight: bold; color: var(--text-color);
}
.scan-location {
    font-size: 0.8em; color: var(--text-muted-color);
}
.scan-preview-btn {
    background: none; border: 1px solid var(--border-color);
    color: var(--text-muted-color); border-radius: 50%;
    width: 30px; height: 30px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    margin-left: 10px; transition: all 0.2s;
}
.scan-preview-btn:hover {
    background-color: var(--accent-color); color: white; border-color: var(--accent-color);
}

/* Sec√ß√µes (Novos vs Existentes) */
.scan-section-title {
    font-size: 0.85em; text-transform: uppercase; 
    color: var(--text-muted-color); margin: 15px 0 10px 0;
    font-weight: bold; border-bottom: 1px solid var(--border-color);
}

/* Popup de Preview Flutuante */
#scan-preview-popup {
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80%; max-width: 350px;
    background-color: var(--panel-color);
    border: 1px solid var(--accent-color);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    border-radius: 8px;
    z-index: 10;
    overflow: hidden;
}
.preview-header {
    background-color: var(--sidebar-color);
    padding: 8px 12px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border-color);
}
.preview-header button {
    background: none; border: none; color: var(--text-color); font-size: 18px; cursor: pointer;
}
#scan-preview-content {
    padding: 15px;
    font-size: 0.9em;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
}
#scan-preview-content mark {
    background-color: rgba(241, 196, 15, 0.4);
    color: white; padding: 2px 4px; border-radius: 4px;
}

/* --- CSS PARA O BOT√ÉO "VOLTAR √Ä NOTA" --- */


/* Garante que o Painel do Meio ocupa 100% da tela no Mobile */
@media (max-width: 768px) {
    #middle-panel {
        width: 100% !important;
        right: 0 !important;
        max-width: none !important;
    }
}

/* --- ESTILOS DO PAINEL DE REFER√äNCIAS (ABAS E PUZZLE) --- */

/* Caixas de M√≥dulo de Texto (Puzzle) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: transform 0.2s;
}

.puzzle-module-card textarea {
    width: 100%;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    border-radius: 4px;
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
}

.puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
}

.puzzle-controls button {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.puzzle-controls button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.puzzle-controls button.delete:hover {
    background-color: rgba(192, 57, 43, 0.2);
    color: #e74c3c;
    border-color: #e74c3c;
}

/* Item da Lista de Refer√™ncias Escolhidas */
#puzzle-chosen-list li {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background-color: rgba(255, 255, 255, 0.03);
    border-left: 3px solid var(--accent-color);
}

.chosen-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 0.9em;
}

.chosen-ref-snippet {
    font-size: 0.85em;
    color: var(--text-muted-color);
    font-style: italic;
    margin-top: 3px;
    padding: 5px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}

/* Bot√£o adicionar ao puzzle (na aba Refer√™ncias) */
.add-to-puzzle-btn {
    background-color: var(--hover-color);
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 14px;
    cursor: pointer;
    margin-right: 5px;
}
.add-to-puzzle-btn:hover {
    background-color: var(--accent-color);
    color: white;
}

/* --- ESTILOS DO PUZZLE (MODO LEITURA VS EDI√á√ÉO) --- */

/* Estilo do Card (Contentor) */
.puzzle-module-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    transition: all 0.2s;
}

/* O Textarea por padr√£o (MODO LEITURA - "Bonito") */
.puzzle-module-card textarea {
    width: 100%;
    /* Remove as bordas e fundo para parecer texto limpo */
    background: transparent; 
    border: none; 
    color: var(--text-color);
    padding: 5px;
    resize: none; /* Impede redimensionar */
    min-height: auto;
    font-family: inherit;
    font-size: 0.95em;
    line-height: 1.5;
    outline: none;
    overflow: hidden; /* Esconde scrollbar */
}

/* Os bot√µes de controlo por padr√£o (ESCONDIDOS) */
.puzzle-module-card .puzzle-controls {
    display: none; 
}

/* --- CLASSE ATIVADORA: .edit-mode-active --- */
/* Quando o contentor pai tem esta classe, mudamos o visual */

/* 1. Mostra o bot√£o "+ Criar" */
#ref-content-puzzle.edit-mode-active #add-puzzle-module-btn {
    display: block !important;
}

/* 2. Muda o Textarea para parecer um campo de input */
#ref-content-puzzle.edit-mode-active .puzzle-module-card textarea {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    resize: vertical; /* Permite redimensionar */
    min-height: 60px;
}

/* 3. Mostra os bot√µes de controlo (Setas e Lixo) */
#ref-content-puzzle.edit-mode-active .puzzle-module-card .puzzle-controls {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-top: 5px;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}


/* Bot√µes do Quadro */
.puzzle-edit-toggle {
    background: none; border: 1px solid var(--border-color); color: var(--text-muted-color);
    border-radius: 4px; padding: 4px 10px; cursor: pointer; transition: all 0.2s;
}
.puzzle-action-btn {
    border: none; color: white; border-radius: 4px; padding: 4px 10px; 
    cursor: pointer; font-weight: bold; font-size: 0.85em;
}
.btn-blue { background-color: #3498db; }
.btn-blue:hover { background-color: #2980b9; }
.btn-green { background-color: #2ecc71; }
.btn-green:hover { background-color: #27ae60; }

/* Estilo do Cart√£o no Quadro (Gen√©rico) */
.board-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Tipo TEXTO */
.board-card.type-text textarea {
    width: 100%; background: transparent; border: none; color: var(--text-color);
    resize: none; font-family: inherit; line-height: 1.5; outline: none;
}
/* No modo edi√ß√£o, o textarea parece um input */
.edit-mode-active .board-card.type-text textarea {
    background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; resize: vertical;
}

/* Tipo REFER√äNCIA */
.board-card.type-ref {
    border-left: 3px solid #2ecc71; /* Borda verde para identificar */
}
.ref-card-content {
    font-size: 0.9em; color: var(--text-color);
}
.ref-card-title {
    font-weight: bold; color: var(--accent-color); display: flex; align-items: center; gap: 5px;
}
.ref-card-snippet {
    background-color: transparent; /* Remove fundo amarelo se houver */
    padding: 5px 0; 
    margin: 5px 0; 
    color: var(--text-muted-color); 
    font-size: 0.9em; 
    line-height: 1.5;
    /* Adiciona a barra lateral de cita√ß√£o para ficar igual */
    border-left: 2px solid var(--accent-color);
    padding-left: 10px;
}

/* Garante que o <mark> dentro do snippet tem a cor correta */
.ref-card-snippet mark {
    background-color: rgba(74, 144, 226, 0.4); /* Azul suave */
    color: var(--text-color); 
    border-radius: 3px; 
    padding: 1px 3px;
}

/* Controlos (Lixo, Setas) */
.card-controls {
    display: none; /* Escondido por padr√£o */
    margin-top: 5px; 
    border-top: 1px solid var(--border-color); 
    padding-top: 5px; 
    justify-content: flex-end; 
    gap: 5px;
}
.edit-mode-active .card-controls { display: flex; } /* Mostra ao editar */

/* A MAGIA: S√≥ mostra quando o painel tem esta classe */
#ref-content-puzzle.edit-mode-active .card-controls {
    display: flex !important;
}

.card-controls button {
    background: none; border: 1px solid var(--border-color); cursor: pointer; padding: 2px 6px; border-radius: 4px;
}
.card-controls button:hover { background-color: var(--hover-color); }

/* Estilo Base (Modo Visualiza√ß√£o - Limpo) */
.board-text-content {
    width: 100%;
    min-height: 40px;
    outline: none;
    white-space: pre-wrap;
    word-break: break-word;
    color: var(--text-color);
    
    /* O SEGREDO: Bordas e fundo transparentes por defeito */
    border: 1px solid transparent; 
    background-color: transparent;
    padding: 2px 5px; /* Padding pequeno para leitura */
    transition: all 0.2s ease;
}

/* Estilo Modo Edi√ß√£o (Quando o pai tem a classe activa) */
.edit-mode-active .board-text-content {
    border: 1px solid var(--border-color);
    background-color: var(--bg-color); /* Fundo da caixa de input */
    border-radius: 4px;
    padding: 8px; /* Mais espa√ßo para escrever */
    cursor: text;
}

/* Efeito Hover opcional no modo edi√ß√£o para saber que pode clicar */
.edit-mode-active .board-text-content:hover {
    border-color: var(--accent-color);
}

/* ============================================================
   ESTILO PERSONALIZADO PARA LINKS DO QUADRO
   ============================================================ */
a.board-link {
    /* 1. Mant√©m a cor do texto original (branco/cinza) */
    color: inherit !important; 
    
    /* 2. Remove o sublinhado padr√£o */
    text-decoration: none !important; 
    
    /* 3. Cria a linha picotada azul por baixo */
    border-bottom: 1px dotted #4a90e2 !important; 
    
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Efeito ao passar o rato (Opcional: torna a linha s√≥lida) */
a.board-link:hover {
    border-bottom-style: solid !important;
    background-color: rgba(74, 144, 226, 0.1); /* Fundo azul muito suave */
}

/* --- ESTILO PARA O ITEM DO POPUP DE REFER√äNCIA --- */
.puzzle-ref-item {
    display: flex !important;        /* For√ßa layout flex√≠vel */
    flex-direction: column !important; /* Organiza em colunas (Cima/Baixo) */
    align-items: flex-start !important;
    justify-content: center !important;
    width: 100%;
    padding: 12px 15px !important;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    box-sizing: border-box; /* Garante que padding n√£o aumenta largura */
    overflow: hidden;       /* Impede barras de scroll */
}

.puzzle-ref-item:hover {
    background-color: var(--hover-color);
}

/* Linha de Cima (Tipo + Nome da Nota) */
.puzzle-ref-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 6px;
}

/* O Tipo (Ex: Quest√£o) */
.puzzle-ref-type {
    font-weight: bold;
    color: var(--text-color);
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0; /* Impede de encolher */
}

/* O Nome da Nota (Direita) */
.puzzle-ref-note {
    font-size: 0.8em;
    color: var(--text-muted-color);
    text-align: right;
    
    /* Truncar texto longo com ... */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%; /* Ocupa no m√°ximo 60% da linha */
}

/* O Texto de Contexto (Baixo) */
.puzzle-ref-snippet {
    font-size: 0.9em;
    color: var(--text-muted-color);
    width: 100%;
    line-height: 1.4;
    
    /* Truncar texto longo com ... */
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================================
   WIDGET CARD DE LINK (üé¥)
   ============================================================ */
  .url-card-widget {
    /* MUDAN√áA 1: inline-flex permite que fiquem lado a lado */
    display: inline-flex; 
    flex-direction: column;
    width: 240px;             
    height: 180px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin: 5px; 
    vertical-align: top; /* Alinha pelo topo quando h√° texto ao lado */
    position: relative;
    background-color: var(--panel-color);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    user-select: none;
    text-decoration: none;
    cursor: grab; /* M√£ozinha para indicar que pode arrastar */
}

.url-card-widget:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border-color: var(--accent-color);
}

/* Estado enquanto est√° a ser arrastado (Fica transparente) */
.url-card-widget.sortable-dragging {
    opacity: 0.4;
    border: 2px dashed var(--accent-color);
}

/* Indicadores de onde vai cair (Esquerda ou Direita) */
.url-card-widget.drop-target-left {
    border-left: 4px solid var(--accent-color) !important;
    transform: none !important;
}

.url-card-widget.drop-target-right {
    border-right: 4px solid var(--accent-color) !important;
    transform: none !important;
}

/* √Årea da Imagem */
.url-card-image {
    width: 100%;
    height: 100px;
    background-color: #2c2c30;
    background-size: cover;
    background-position: center;
    position: relative;
}

/* T√≠tulo e Dom√≠nio */
.url-card-info {
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex-grow: 1;
}

.url-card-title {
    font-weight: bold;
    font-size: 0.9em;
    color: var(--text-color);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* M√°ximo 2 linhas */
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 5px;
}

.url-card-domain {
    font-size: 0.75em;
    color: var(--text-muted-color);
    text-transform: uppercase;
    font-weight: 600;
}

/* Bot√£o de Fechar (X) - S√≥ aparece no hover */
.url-card-close {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 50%;
    display: none; /* Escondido por defeito */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    transition: background 0.2s;
}

.url-card-close:hover {
    background-color: #e74c3c; /* Vermelho ao passar o rato */
}

.url-card-widget:hover .url-card-close {
    display: flex; /* Mostra ao passar o rato no card */
}

/* Loading State */
.url-card-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 0.8em;
    color: var(--text-muted-color);
    font-style: italic;
}

/* Estilo para a nova Dropdown de Formata√ß√£o */
#editor-format {
    background-color: var(--hover-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    padding: 0 5px;
    height: 32px;
    cursor: pointer;
    outline: none;
    font-size: 14px;
    margin-right: 5px;
   width: 105px; /* Largura suficiente para o texto */
}

#editor-format:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

#editor-format option {
    background-color: var(--sidebar-color);
    color: var(--text-color);
}

/* Grelha de Vers√≠culos B√≠blicos */
.bible-verses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 8px;
    padding: 10px 0;
}

.verse-btn {
    aspect-ratio: 1; /* Quadrado */
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    background-color: var(--panel-color);
    color: var(--text-muted-color);
    transition: all 0.2s;
}

.verse-btn:hover {
    border-color: var(--accent-color);
    color: var(--text-color);
}

/* Vers√≠culo que j√° existe (Verde) */
.verse-btn.exists {
    background-color: rgba(46, 204, 113, 0.15);
    border-color: #2ecc71;
    color: #2ecc71;
    font-weight: bold;
}

.verse-btn.exists:hover {
    background-color: #2ecc71;
    color: white;
}

/* --- √çCONE DE SUPERPASTA (üóÉÔ∏è) --- */

/* Substitui o √≠cone padr√£o (üìÅ) pelo arquivo (üóÉÔ∏è) quando √© superpasta */
.list-item[data-superpasta="true"]::before {
    content: 'üóÉÔ∏è' !important; 
    font-size: 20px; /* Um pouco maior para destacar */
}

/* (Opcional) Mant√©m o estilo dourado que cri√°mos antes para o texto */
.list-item[data-superpasta="true"] {
    border-left: 3px solid #f1c40f !important;
}

/* Estilo dos bot√µes de Emoji */
.emoji-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    font-size: 24px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}
.emoji-btn:hover {
    background-color: var(--hover-color);
    transform: scale(1.1);
}

/* L√ìGICA M√ÅGICA PARA MOSTRAR O √çCONE PERSONALIZADO NA LISTA */
/* Se o item tiver a vari√°vel --custom-icon definida, usa isso em vez do padr√£o */
.list-item[style*="--custom-icon"]::before {
    content: var(--custom-icon) !important;
    font-size: 20px;
}

#context-menu {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 10000000 !important;
    
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    
    display: none; 
    flex-direction: column;
    padding: 15px; /* Reduzi o padding geral */
    width: 90%;
    max-width: 360px;
    
    /* L√ìGICA DE SCROLL */
    max-height: 85vh; /* O popup nunca ocupar√° mais de 85% da altura da tela */
    overflow-y: auto; /* Ativa scroll vertical se houver muitas op√ß√µes */
    scrollbar-width: thin; /* Scroll fino para Firefox */
    animation: popupScale 0.2s ease-out;
}

/* T√≠tulo fixo no topo do popup */
#context-menu::before {
    content: 'Op√ß√µes';
    display: block;
    text-align: center;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 12px;
    text-transform: uppercase;
    font-size: 0.75em;
    letter-spacing: 1px;
}

/* Grid de Bot√µes */
.context-menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px; /* Espa√ßo reduzido entre bot√µes */
    width: 100%;
}

#context-menu button {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px 10px; /* Padding reduzido para diminuir a altura */
    text-align: center;
    cursor: pointer;
    border-radius: 8px;
    font-size: 12px; /* Fonte ligeiramente menor */
    font-weight: 500;
    transition: all 0.2s;
    
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    height: 42px; /* ALTURA REDUZIDA (antes era 55px) */
}

#context-menu button:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Linha Separadora Compacta */
#context-menu hr.menu-sep {
    grid-column: span 2;
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 5px 0; /* Margem reduzida */
    opacity: 0.4;
}

/* Bot√£o Fechar */
.context-menu-close {
    grid-column: span 2;
    margin-top: 5px;
    background: none !important;
    border: none !important;
    color: var(--text-muted-color) !important;
    font-size: 11px !important;
    text-decoration: none !important;
    height: 30px !important; /* Altura menor para o cancelar */
}

/* Personaliza√ß√£o da Scrollbar interna do popup */
#context-menu::-webkit-scrollbar {
    width: 6px;
}
#context-menu::-webkit-scrollbar-track {
    background: var(--panel-color);
}
#context-menu::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

/* ============================================================
   LINHAS ARRAST√ÅVEIS (·Øì)
   ============================================================ */
.draggable-line {
    display: flex;
    align-items: baseline; /* Alinha o texto pela base da letra, n√£o pelo topo da caixa */
    margin: 2px 0;         /* Margem m√≠nima para n√£o criar buracos */
    padding: 2px 0;        /* Padding reduzido */
    width: 100%;           /* Garante que ocupa a largura toda */
    box-sizing: border-box;
}

.draggable-line:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

/* O √çcone/Puxador */
.drag-handle-icon {
    cursor: grab;
    margin-right: 8px;
    font-weight: normal; /* Remove negrito excessivo */
    color: var(--accent-color);
    user-select: none; 
    font-size: 1.1em;    /* Tamanho ajustado ao texto */
    line-height: 1.4;    /* Igual ao texto normal */
    flex-shrink: 0; 
    transform: translateY(2px); /* Pequeno ajuste fino vertical */
}

/* O Conte√∫do do Texto */
.drag-content-area {
    flex: 1;
    outline: none;
    min-width: 0; 
    line-height: 1.4; /* For√ßa a mesma altura de linha do editor */
    white-space: pre-wrap; /* Mant√©m quebras de linha se existirem */
}

/* Garante que os par√°grafos vizinhos n√£o empurram */
.toggle-content p, 
.mini-note-content p {
    margin: 4px 0 !important;
    line-height: 1.4 !important;
}




/* ============================================================
   ESTILOS H√çBRIDOS DE TOOLBAR (DESKTOP vs MOBILE)
   ============================================================ */

/* --- PADR√ÉO (DESKTOP) --- */
/* Faz com que os grupos novos (toolbar-nav-section, etc) sejam ignorados pelo layout flex pai */
.toolbar-nav-section, 
.toolbar-tools-section {
    display: contents; 
}

/* Oculta separadores exclusivos de mobile */
.mobile-only-sep {
    display: none;
}

/* --- VERS√ÉO MOBILE (LAYOUT DUAS LINHAS NO TOPO) --- */
@media (max-width: 768px) {

    /* 1. Mudar a ordem geral do Editor */
    #editor-area {
        display: flex;
        flex-direction: column;
    }

    /* 2. Mover a Toolbar para o TOPO (Acima do T√≠tulo) */
    #editor-toolbar {
        order: -1; /* Coloca antes do input de t√≠tulo */
        display: flex;
        flex-direction: column; /* Organiza as duas barras verticalmente */
        padding: 0;
        background-color: var(--panel-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
        width: 100%;
    }

    /* 3. DESATIVA O 'display: contents' para assumir controlo no Mobile */
    .toolbar-nav-section, 
    .toolbar-tools-section {
        display: flex; 
    }


    /* ==================================================
       LINHA 1: FERRAMENTAS (Scroll Horizontal)
       ================================================== */
    .toolbar-tools-section {
        order: 1; /* Primeira Linha */
        width: 100%;
        overflow-x: auto; /* Permite scroll lateral */
        white-space: nowrap;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        align-items: center;
        
        /* Esconde barra de scroll feia */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .toolbar-tools-section::-webkit-scrollbar { 
        display: none; 
    }

    /* For√ßa a Barra Secund√°ria a aparecer e integrar-se na linha */
    #secondary-toolbar {
        display: flex !important; /* For√ßa visibilidade */
        position: static !important; /* Remove posicionamento absoluto se houver */
        background: none !important;
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
        animation: none !important;
        flex-shrink: 0; /* Impede que encolha */
    }

    /* Ajustes nos bot√µes para mobile */
    #editor-toolbar button, 
    #secondary-toolbar button,
    #editor-toolbar select,
    #secondary-toolbar select,
    #editor-toolbar input[type="color"] {
        flex-shrink: 0; /* Garante que n√£o ficam esmagados */
        height: 34px; /* Altura de toque amig√°vel */
        min-width: 34px;
        margin: 0 1px;
    }

    /* Esconder a seta de "Mais Ferramentas" no mobile (j√° est√° tudo vis√≠vel) */
    #toggle-more-tools-btn {
        display: none !important;
    }

    /* Mostra separador extra */
    .mobile-only-sep {
        display: block;
        width: 1px;
        height: 20px;
        background-color: var(--border-color);
        margin: 0 8px;
        flex-shrink: 0;
    }

    /* ==================================================
       LINHA 2: NAVEGA√á√ÉO E STATUS (Fundo)
       ================================================== */
    .toolbar-nav-section {
        order: 2; /* Segunda Linha */
        width: 100%;
        padding: 5px 10px;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(0,0,0,0.1); /* Ligeiramente mais escuro */
        height: 40px;
    }

    /* Bot√£o Back */
    #mobile-back-btn {
        display: flex !important;
        background: none;
        border: none;
        color: var(--accent-color);
        font-size: 1.2em;
        padding: 5px;
        margin: 0 !important;
    }

    /* Status de Grava√ß√£o */
    .save-status {
        font-size: 0.75em;
        margin: 0;
        text-align: center;
        flex-grow: 1; /* Ocupa o centro */
    }

    /* Grupo da Direita (Share, History) */
    .toolbar-history {
        margin: 0 !important;
        gap: 8px;
    }

    .desktop-spacer {
        display: none;
    }
    
    /* Remover margem do input de t√≠tulo para colar √† barra */
    #note-title-input {
        margin-top: 5px;
    }
}

/* ============================================================
   CORRE√á√ÉO DE PISCAR NO MOBILE (FOR√áA BRUTA)
   ============================================================ */
@media (max-width: 768px) {

    /* 1. Garante que o Painel do Meio ocupa sempre o ecr√£ todo quando ativo */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        width: 100% !important;
        height: 100% !important;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 60;
    }

    /* 2. O MAIS IMPORTANTE: For√ßa o Cabe√ßalho a existir */
    /* Isto impede que regras de desktop escondam o header */
    #middle-panel .panel-header {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        height: auto !important;
        min-height: 50px; /* Garante altura m√≠nima */
        width: 100% !important;
        flex-shrink: 0 !important; /* Impede de encolher a zero */
    }

    /* 3. Garante que o conte√∫do do header (t√≠tulo e bot√µes) est√° vis√≠vel */
    #middle-panel .panel-header > * {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* 4. Corrige o bot√£o de voltar no header da lista */
    #middle-panel .panel-header #back-btn {
        display: flex !important; /* Garante que √© flex para centrar a seta */
    }
}



/* ============================================================
   RESPONSIVIDADE MOBILE (SISTEMA DE PILHA)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Reset do Contentor Principal */
    .notebook-container {
        display: block !important;
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* 2. Configura√ß√£o Base dos 3 Pain√©is (Ecr√£ Cheio) */
    #left-panel, #middle-panel, #right-panel {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        flex: none !important;
        z-index: 10;
        border: none !important;
        border-radius: 0 !important;
        /* Reset de estilos desktop que causam cortes */
        margin: 0 !important;
        max-width: none !important;
        min-width: 0 !important;
    }

    /* --- L√ìGICA DE VISIBILIDADE (Quem est√° no topo?) --- */

    /* ESTADO 1: Painel Esquerdo (Pastas + Abas) */
    body:not(.mobile-view-middle):not(.mobile-view-editor) #left-panel {
        display: flex !important;
        z-index: 50; /* No topo */
        background-color: var(--sidebar-color);
    }
    body:not(.mobile-view-middle):not(.mobile-view-editor) #middle-panel,
    body:not(.mobile-view-middle):not(.mobile-view-editor) #right-panel {
        display: none !important;
    }

    /* ESTADO 2: Painel do Meio (Lista de Notas) */
    body.mobile-view-middle #middle-panel {
        display: flex !important;
        flex-direction: column !important;
        z-index: 60; /* Acima da esquerda */
        background-color: var(--panel-color);
        padding: 15px !important; /* Espa√ßo para n√£o cortar o topo */
    }
    body.mobile-view-middle #left-panel {
        display: none !important; 
    }
    body.mobile-view-middle #right-panel {
        display: none !important;
    }

    /* ESTADO 3: Editor (Nota Aberta) */
    body.mobile-view-editor #right-panel {
        display: flex !important;
        z-index: 70; /* Acima de tudo */
        background-color: var(--bg-color);
    }
    body.mobile-view-editor #left-panel, 
    body.mobile-view-editor #middle-panel {
        display: none !important;
    }

    /* --- CORRE√á√ïES ESPEC√çFICAS --- */

    /* 1. For√ßar as ABAS (Note/Lists/Book) a aparecerem bem */
    #left-panel .panel-content {
        padding-top: 10px;
    }
    .tabs-container {
        display: flex !important;
        margin-bottom: 15px !important;
        flex-shrink: 0; /* Impede que encolham */
    }
    
    /* 2. Corrigir o Cabe√ßalho da Coluna 2 (Para n√£o cortar) */
    #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        height: auto !important;
        min-height: 50px;
        margin-bottom: 20px;
        width: 100%;
        flex-shrink: 0;
    }
    
    /* For√ßar a visibilidade dos elementos internos do header */
    #middle-panel .panel-header h2,
    #middle-panel .panel-header #back-btn,
    #middle-panel .panel-header #add-item-btn {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* 3. Bot√£o de Voltar no Editor (Topo) */
    #mobile-back-btn {
        display: flex !important;
        align-items: center;
        padding: 5px 12px;
        background: var(--panel-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-right: 10px;
    }

    /* 4. Esconder bot√µes desktop in√∫teis */
    #middle-panel-toggle-btn,
    #left-panel-toggle-btn {
        display: none !important;
    }
}
/* ==========================================================
       CORRE√á√ÉO IPHONE 13 E BOT√ïES SUMIDOS
       ========================================================== */

    /* 1. Ajuste do Painel para respeitar o "Notch" (C√¢mara) do iPhone */
    #middle-panel,
    .notebook-container.middle-panel-collapsed #middle-panel {
        /* Adiciona espa√ßo no topo seguro para o iPhone */
        padding-top: calc(15px + env(safe-area-inset-top)) !important;
    }

    /* 2. For√ßa o cabe√ßalho a ser vis√≠vel e Horizontal */
    #middle-panel .panel-header,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header {
        display: flex !important;
        flex-direction: row !important; /* Linha horizontal */
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        min-height: 50px !important;
        margin-bottom: 20px !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* 3. O MAIS IMPORTANTE: For√ßa os bot√µes e t√≠tulo a aparecerem! 
       (Anula a regra que os escondia no modo colapsado) */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header > *,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #back-btn,
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header #add-item-btn {
        display: flex !important; /* Traz de volta os elementos! */
        visibility: visible !important;
        opacity: 1 !important;
        height: 32px !important;
        align-items: center;
    }

    /* Ajuste fino para o T√≠tulo (H2) ser bloco e n√£o flex */
    .notebook-container.middle-panel-collapsed #middle-panel .panel-header h2 {
        display: block !important;
        text-align: center;
        flex-grow: 1;
    }

/* ============================================================
   CORRE√á√ÉO H√çBRIDA TOOLBAR (PC Fiel + Mobile 2 Linhas)
   ============================================================ */

/* --- PADR√ÉO (PC) - Mant√©m o visual original --- */
#editor-toolbar {
    display: flex;
    flex-wrap: wrap; /* Permite que a barra secund√°ria quebre linha se necess√°rio */
    align-items: center;
    position: relative;
}

.tools-wrapper {
    display: contents; /* No PC, ignora este wrapper e mostra os bot√µes diretamente */
}

/* Oculta separadores exclusivos de mobile */
.toolbar-separator.mobile-only { display: none; }

/* Barra Secund√°ria no PC (Comportamento de Dropdown) */
/* Quando vis√≠vel via JS, ela aparece como flex */
#secondary-toolbar {
    width: 100%; /* For√ßa nova linha no PC */
    flex-basis: 100%;
    order: 10; /* Garante que fica abaixo de tudo */
    padding-top: 10px;
    margin-top: 5px;
    border-top: 1px solid var(--border-color);
    /* Mant√©m o display: none inline do HTML at√© o JS ativar */
}

/* --- VERS√ÉO MOBILE (LAYOUT FOR√áADO) --- */
@media (max-width: 768px) {

    /* 1. Mover Toolbar para cima do T√≠tulo */
    #editor-area {
        display: flex;
        flex-direction: column;
    }
    #toolbar-container {
        order: -1; /* Sobe para o topo */
        width: 100%;
        background-color: var(--panel-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 10px;
    }

    #editor-toolbar {
        flex-direction: column; /* Organiza em 2 linhas verticais */
        padding: 0;
        gap: 0;
    }

    /* 2. LINHA 1: Ferramentas (Scroll Horizontal) */
    .tools-wrapper {
        display: flex !important; /* Ativa o wrapper */
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        align-items: center;
        scrollbar-width: none; /* Esconde scrollbar Firefox */
    }
    .tools-wrapper::-webkit-scrollbar { display: none; } /* Esconde scrollbar Chrome */

    /* For√ßa a barra secund√°ria a aparecer e integrar-se na linha */
    #secondary-toolbar {
        display: contents !important; /* O SEGREDO: Faz os bot√µes filhos subirem para a linha principal */
    }

    /* Ajustes dos bot√µes no scroll */
    .tools-wrapper button, 
    .tools-wrapper select, 
    .tools-wrapper input {
        flex-shrink: 0;
        margin: 0 2px;
        height: 36px;
    }

    /* Esconde elementos in√∫teis no mobile */
    #toggle-more-tools-btn { display: none !important; }
    .toolbar-separator.desktop-only { display: none; }
    .toolbar-separator.mobile-only { 
        display: block; width: 1px; height: 24px; background: var(--border-color); margin: 0 8px; flex-shrink: 0; 
    }

    /* 3. LINHA 2: Navega√ß√£o e Status (Fixo em baixo) */
    .toolbar-history {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 10px;
        background-color: rgba(0,0,0,0.1);
        height: 44px;
        margin: 0 !important;
    }

    /* Bot√£o Voltar (Aparece na esquerda da linha 2) */
    #mobile-back-btn {
        display: flex !important;
        background: none;
        border: none;
        font-size: 20px;
        margin-right: auto; /* Empurra o resto para a direita */
    }

    /* Status no meio */
    .save-status {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8em;
        white-space: nowrap;
    }
}

/* ============================================================
   ORDEM DA BARRA DE FERRAMENTAS (PC vs MOBILE)
   ============================================================ */

/* --- PADR√ÉO (PC): Barra ABAIXO do t√≠tulo --- */
#editor-area {
    display: flex;
    flex-direction: column;
}

/* O input do t√≠tulo fica em 1¬∫ lugar (order: 0 √© o padr√£o) */
#note-title-input {
    order: 0;
    margin-bottom: 20px; /* Espa√ßo entre t√≠tulo e barra */
}

/* A barra de ferramentas fica em 2¬∫ lugar */
#toolbar-container {
    order: 1;
    margin-bottom: 10px; /* Espa√ßo entre barra e editor */
}

/* O editor fica em 3¬∫ lugar */
#note-content-editor {
    order: 2;
}


/* --- VERS√ÉO MOBILE: Barra ACIMA do t√≠tulo --- */
@media (max-width: 768px) {
    
    /* Inverte a ordem visualmente */
    
    /* A barra sobe para o topo (order negativo) */
    #toolbar-container {
        order: -1; 
        margin-bottom: 10px;
        position: sticky; /* Opcional: Mant√©m a barra vis√≠vel no topo ao fazer scroll */
        top: 0;
        z-index: 100;
    }

    /* O t√≠tulo desce para depois da barra */
    #note-title-input {
        order: 0;
        margin-top: 5px;
        margin-bottom: 15px;
    }

    /* O editor mant√©m-se no fim */
    #note-content-editor {
        order: 1;
    }
}

/* ============================================================
   TOOLBAR PERSONALIZADA (PC vs MOBILE)
   ============================================================ */

/* --- CONFIGURA√á√ÉO PC (LAYOUT ORIGINAL) --- */
#editor-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    background-color: var(--panel-color);
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 15px;
    gap: 5px;
}

/* O "Truque": No PC, esta div √© invis√≠vel estruturalmente */
.tools-scroll-container {
    display: contents; 
}

/* Grupo da Direita (Status + √çcones) */
.toolbar-history-group {
    display: flex;
    align-items: center;
    margin-left: auto; /* Empurra para a direita no PC */
    gap: 15px;
}

/* Separadores Verticais */
.toolbar-separator {
    width: 1px;
    height: 24px;
    background-color: var(--border-color);
    margin: 0 5px;
    display: block; /* Vis√≠veis no PC */
}
.toolbar-separator.mobile-only { display: none; } /* Esconde extras no PC */

/* Barra Secund√°ria (PC) - Quebra para nova linha */
#secondary-toolbar {
    width: 100%;
    flex-basis: 100%;
    border-top: 1px solid var(--border-color);
    padding-top: 10px;
    margin-top: 5px;
    display: none; /* Controlado pelo JS */
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

/* Bot√£o Toggle (Seta) Ativo */
#toggle-more-tools-btn.active {
    background-color: var(--selected-color) !important;
}

/* ESTILO ESPEC√çFICO PARA O MODO PARTILHA (VERMELHO) */
.folder-mode-item.active.mode-shared {
    color: #e74c3c; /* Texto vermelho */
}

.folder-mode-item.active.mode-shared::after {
    background-color: #e74c3c !important; /* Linha vermelha for√ßada */
    height: 3px; /* Um pouco mais grossa para destaque */
}


/* --- ESTILOS DO ARQUIVO (FEED) --- */
.archive-post {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    position: relative;
    transition: box-shadow 0.2s;
}

.archive-post:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Modo Edi√ß√£o do Post */
.post-edit-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    animation: fadeIn 0.3s;
}

.post-title-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 8px;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 4px;
}

.post-editor-content {
    min-height: 100px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 4px;
    outline: none;
    color: var(--text-color);
}

/* Toolbar Espec√≠fica do Post */
.post-toolbar {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    background: rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 4px;
}

.post-toolbar button {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 3px;
}
.post-toolbar button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Modo Visualiza√ß√£o do Post */
.post-view-container {
    display: flex;
    flex-direction: column;
}

.post-view-title {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--accent-color);
    margin-bottom: 10px;
}

.post-view-content {
    line-height: 1.5;
    color: var(--text-color);
}

.post-edit-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.8em;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.archive-post:hover .post-edit-btn {
    opacity: 1;
}

.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    font-size: 0.75em;
    color: var(--text-muted-color);
    display: flex;
    justify-content: space-between;
}

/* ============================================================
   VISIBILIDADE DA TOOLBAR DAS ENTIDADES (ARQUIVO)
   ============================================================ */

/* 1. MODO VISUALIZA√á√ÉO: ESCONDER A BARRA */
/* Esconde a barra laranja/azul/verde com os √≠cones */
.post-view-content .mini-note-toolbar {
    display: none !important;
}

/* Esconde tamb√©m os bot√µes espec√≠ficos dos T√≠tulos Toggle (caso use) */
.post-view-content .toggle-color-btn,
.post-view-content .toggle-delete-btn,
.post-view-content .toggle-move-btn {
    display: none !important;
}

/* 2. MODO EDI√á√ÉO: GARANTIR VISIBILIDADE */
/* Quando clica em "Editar", a classe muda para .post-editor-content e a barra reaparece */
.post-editor-content .mini-note-toolbar {
    display: flex !important;
}

/* ============================================================
   CORRE√á√ÉO DE LAYOUT: ENTIDADES DENTRO DE POSTS
   ============================================================ */

/* 1. Remove margens negativas que causam transbordo */
/* O estilo original tem 'margin: 30px -25px', o que empurra para fora */
.post-editor-content .mini-note-wrapper,
.post-view-content .mini-note-wrapper {
    margin: 10px 0 !important; /* Margem vertical pequena, zero lateral */
    width: 100% !important;    /* For√ßa a caber no pai */
    box-sizing: border-box;    /* Garante que padding n√£o aumenta largura */
}

/* 2. Ajuste para Toggles (T√≠tulos Expans√≠veis) */
.post-editor-content details.toggle-section,
.post-view-content details.toggle-section {
    margin: 10px 0 !important;
    width: 100% !important;
}

/* 3. Ajuste fino do conte√∫do do post para evitar scroll horizontal desnecess√°rio */
.post-editor-content,
.post-view-content {
    overflow-x: hidden; /* Corta o que sobrar */
    width: 100%;        /* Garante largura total */
    word-wrap: break-word; /* Quebra palavras longas */
}

/* ============================================================
   PROTE√á√ÉO DA TOOLBAR INTERNA (ARQUIVO)
   ============================================================ */
.post-editor-content .mini-note-toolbar {
    user-select: none;          /* Impede selecionar os bot√µes com o rato */
    -webkit-user-select: none;  /* Safari/Chrome */
    -moz-user-select: none;     /* Firefox */
    cursor: default;
}

/* Garante que a barra √© considerada um bloco s√≥lido n√£o edit√°vel */
.post-editor-content .mini-note-toolbar[contenteditable="false"] {
    outline: none !important;
    border: none !important;
}

/* Garante espa√ßo para os bot√µes √† direita */
.post-view-title {
    padding-right: 120px; /* Espa√ßo para 3 bot√µes */
}

/* --- SELE√á√ÉO VERMELHA (MODO PARTILHA) --- */
.list-item.selected-red {
    background-color: rgba(231, 76, 60, 0.25) !important; /* Fundo vermelho suave */
    border-left: 4px solid #e74c3c !important; /* Borda vermelha forte */
    color: white !important;
}

/* Garante que o texto fica leg√≠vel */
.list-item.selected-red span {
    font-weight: bold;
}


/* --- BARRA DE COLABORA√á√ÉO --- */
#collab-bar {
    display: none; /* S√≥ aparece se houver colaboradores */
    align-items: center;
    padding: 0 20px;
    margin-bottom: 10px;
    gap: 5px;
}

.user-presence-bubble {
    width: 20px !important;
    height: 20px !important;
    min-width: 20px !important;
    max-width: 20px !important;
    border-radius: 50% !important;
    
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    font-weight: bold !important;
    font-size: 9px !important; /* Fonte ajustada para 20px */
    color: white !important;
    cursor: default !important;
    border: 1px solid var(--sidebar-color) !important;
    
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1 !important;
    flex-shrink: 0 !important;
}

/* Contentor das bolas */
#active-users-list {
    display: flex !important;
    align-items: center !important;
    gap: 2px !important; /* Espa√ßo m√≠nimo */
    height: 20px !important;
}

/* Garante que os bot√µes da direita n√£o mudam de tamanho */
#archive-toolbar button {
    width: 20px !important;
    height: 20px !important;
    font-size: 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
}

.user-presence-bubble:hover {
    transform: translateY(-2px);
    z-index: 10;
}

/* Tooltip do nome */
.user-presence-bubble::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.user-presence-bubble:hover::after { opacity: 1; }

/* --- POST BLOQUEADO (EDITADO POR OUTRO) --- */
.archive-post.is-locked {
    opacity: 0.7;
    border: 1px dashed #e74c3c !important;
    background: repeating-linear-gradient(
        45deg,
        rgba(231, 76, 60, 0.05),
        rgba(231, 76, 60, 0.05) 10px,
        rgba(231, 76, 60, 0.1) 10px,
        rgba(231, 76, 60, 0.1) 20px
    );
    pointer-events: none; /* Bloqueia cliques */
    position: relative;
}

.locked-badge {
    position: absolute;
    top: -10px;
    right: 10px;
    background-color: #e74c3c;
    color: white;
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
    z-index: 20;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 5px;
}

.list-item.selected, .list-item.selected-red {
    transition: background-color 0.1s ease-in-out, border-left 0.1s ease-in-out;
}


.archive-tab-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 10px 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 15px;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.archive-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.archive-tab-btn:hover {
    color: var(--text-color);
}
.drawer-toggle {
    margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px;
    background: rgba(255,255,255,0.02);
}
.drawer-toggle summary {
    padding: 15px; cursor: pointer; font-weight: bold; color: var(--accent-color);
    list-style: none; display: flex; justify-content: space-between;
}
.drawer-toggle[open] { border-color: var(--accent-color); }


.mini-btn {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}
.mini-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}
/* Estilo para que o cabe√ßalho n√£o abra o toggle ao clicar nos bot√µes */
.drawer-controls {
    pointer-events: auto;
}


/* Estilo do bot√£o Criar Post ao lado das abas */
.archive-inline-create-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 14px; /* Tamanho igual √†s abas */
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 5px; /* Alinhamento visual com a borda de baixo */
    transition: opacity 0.2s;
    white-space: nowrap;
}

.archive-inline-create-btn:hover {
    opacity: 0.8;
}

/* Ajuste na div pai para o bot√£o n√£o esticar */
.archive-tabs {
    display: flex;
    align-items: center;
}

/* Efeito Hover no Popup de Formata√ß√£o Extra */
#formatting-popup button {
    background: rgba(255,255,255,0.05);
    border: 1px solid #444;
    border-radius: 4px;
    padding: 6px 0;
    cursor: pointer;
    transition: all 0.2s ease;
}

#formatting-popup button:hover {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important; /* O texto fica branco para contrastar com o fundo azul */
}

/* Estado ativo do bot√£o de mais formata√ß√µes */
#more-formatting-btn.active {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
}

/* --- AJUSTE DE BOT√ïES DE A√á√ÉO DOS POSTS --- */

/* 1. Contentor dos bot√µes no modo edi√ß√£o */
.post-edit-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
    border-top: 1px solid var(--border-color);
    padding-top: 12px;
    margin-top: 10px;
}

.post-edit-actions .modal-btn {
    padding: 6px 12px !important;
    font-size: 13px !important;
    height: 32px !important;
    flex: 1 1 auto;
    min-width: fit-content;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}

/* --- L√ìGICA MOBILE (AT√â 480PX) --- */
@media (max-width: 480px) {
    .post-edit-actions {
        justify-content: center;
    }
    
    .post-edit-actions .modal-btn {
        font-size: 12px !important;
        padding: 6px 8px !important;
        flex: 1 1 45%; /* Garante 2 bot√µes por linha */
    }

    /* REORDENA√á√ÉO DOS BOT√ïES NO MOBILE */
    /* Ordem original no HTML: 1. Gavet√£o, 2. Eliminar, 3. Cancelar, 4. Salvar */
    
    .post-edit-actions .modal-btn:nth-child(1) { order: 1; } /* Gavet√£o continua em 1¬∫ */
    .post-edit-actions .modal-btn:nth-child(4) { order: 2; } /* SALVAR sobe para 2¬∫ (lugar do eliminar) */
    .post-edit-actions .modal-btn:nth-child(3) { order: 3; } /* Cancelar continua em 3¬∫ */
    .post-edit-actions .modal-btn:nth-child(2) { order: 4; } /* ELIMINAR desce para 4¬∫ (lugar do salvar) */
}


/* --- CONFIGURA√á√ÉO MOBILE (LAYOUT 2 LINHAS NO TOPO) --- */
@media (max-width: 768px) {

    /* 1. Mover Toolbar para cima do T√≠tulo */
    #editor-area { display: flex; flex-direction: column; }
    #toolbar-container {
        order: -1; 
        position: sticky; top: 0; z-index: 100;
        background-color: var(--panel-color);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    #note-title-input { order: 0; margin-top: 10px; }
    #note-content-editor { order: 1; }

    /* 2. Layout da Barra Principal */
    #editor-toolbar {
        flex-direction: column; /* Pilha vertical */
        padding: 0;
        gap: 0;
        border-radius: 0;
        margin-bottom: 0;
    }

    /* LINHA 1: Ferramentas com Scroll */
    .tools-scroll-container {
        display: flex; /* Ativa o flex para scroll */
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 5px;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        /* Esconde scrollbars */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    .tools-scroll-container::-webkit-scrollbar { display: none; }

    /* For√ßa a barra secund√°ria a aparecer e integrar-se na linha 1 */
    #secondary-toolbar {
        display: contents !important; /* Faz os bot√µes subirem para a linha principal */
    }

    /* Separadores no Mobile */
    .toolbar-separator { margin: 0 8px; flex-shrink: 0; height: 20px; }
    .toolbar-separator.mobile-only { display: block; }

    /* Esconde a seta de toggle no mobile (tudo vis√≠vel) */
    #toggle-more-tools-btn { display: none !important; }

    /* Ajuste de bot√µes para toque */
    #editor-toolbar button, #editor-toolbar select, #editor-toolbar input {
        flex-shrink: 0; height: 34px; margin: 0 1px;
    }

    /* LINHA 2: Navega√ß√£o e Hist√≥rico (Barra Inferior) */
    .toolbar-history-group {
        width: 100%;
        height: 45px;
        background-color: rgba(0,0,0,0.2);
        justify-content: space-between; /* Espalha: Back - Status - √çcones */
        padding: 0 10px;
        margin: 0;
    }

    /* Bot√£o Back vis√≠vel */
    #mobile-back-btn {
        display: flex !important;
        background: none; border: none; font-size: 22px; color: var(--accent-color);
        padding: 0; margin: 0;
    }

    /* Ajuste do Status */
    .save-status {
        position: absolute; left: 50%; transform: translateX(-50%);
        font-size: 0.75em; opacity: 0.8;
    }
}

/* ============================================================
   NOVA REGRA: BOT√ïES FLUTUANTES (MOBILE FAB)
   ============================================================ */
#mobile-fab-container {
    display: none; /* Escondido por padr√£o em Desktop */
}

@media (max-width: 768px) {
    /* Esconde o rodap√© original do painel esquerdo */
    #left-panel .panel-footer {
        display: none !important;
    }

    /* O contentor s√≥ aparece se o body tiver a classe 'show-fab' */
       #mobile-fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none; /* Escondido por padr√£o */
        flex-direction: column;
        gap: 12px;
        z-index: 900;
        align-items: center;
    }

    body.show-fab #mobile-fab-container {
        display: flex !important; /* Mostra apenas quando a classe existir */
    }

    /* Prote√ß√£o extra: se mudar de ecr√£, os bot√µes morrem sempre */
    body.mobile-view-middle #mobile-fab-container,
    body.mobile-view-editor #mobile-fab-container {
        display: none !important;
    }

    /* Estilo das Bolinhas */
    .fab-btn {
        width: 48px; height: 48px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        background-color: var(--panel-color);
        color: var(--text-color);
        font-size: 20px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        cursor: pointer;
    }

    #mobile-fab-add {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        font-size: 28px;
        width: 56px; height: 56px;
    }

    /* Bot√£o Flash (‚ö°) - Ligeiramente menor e Laranja */
    #mobile-fab-flash {
    background-color: #e67e22 !important;
    color: white !important;
    border-color: #e67e22 !important;
    
    font-size: 18px !important; /* √çcone mais pequeno */
    width: 38px !important;      /* Di√¢metro reduzido */
    height: 38px !important;
    
    margin-bottom: 2px !important; /* Mais perto do bot√£o azul */
    box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
}
}

/* ============================================================
   MODO "APP NATIVA" (SEM SALTOS DE TELA) - MOBILE
   ============================================================ */
@media (max-width: 768px) {

    /* 1. TRAVAR A P√ÅGINA INTEIRA (O Segredo) */
    /* Isto impede que o site "fuja" quando faz scroll agressivo ou abre o teclado */
    html, body {
        height: 100% !important;
        width: 100% !important;
        overflow: hidden !important;
        position: fixed !important; 
    }

    /* 2. Painel da Direita (Contentor Fixo) */
    #right-panel {
        position: fixed !important;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw !important;
        height: 100% !important;
        display: none !important; /* Escondido por padr√£o */
        flex-direction: column !important;
        z-index: 70;
        background-color: var(--bg-color);
    }
  /* Quando a nota est√° aberta, mostramos o painel */
    body.mobile-view-editor #right-panel {
        display: flex !important;
    }

    /* 3. √Årea do Editor (O Motor de Scroll) */
    /* √â AQUI e S√ì AQUI que o scroll acontece */
    #editor-area {
        display: none;
        flex-direction: column;
        width: 100% !important;
        height: 100% !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
          overflow-anchor: none !important;
    }

    /* 4. Barra de Ferramentas (STICKY) */
    /* Sticky dentro de um contentor fixo √© muito mais est√°vel que Fixed */
    #toolbar-container {
        position: -webkit-sticky !important; /* Safari */
        position: sticky !important;         /* Android/Modern */
        top: 0 !important;                   /* Cola no teto do #editor-area */
        z-index: 9999 !important;            /* Acima de tudo */
        
        width: 100% !important;
        background-color: var(--panel-color) !important;
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        
        /* Truques para evitar piscar */
        transform: translateZ(0);
        margin: 0 !important;
    }

    /* 5. Ajuste do T√≠tulo */
    /* Como usamos Sticky, a barra ocupa espa√ßo f√≠sico. N√£o precisamos de margem gigante */
    #note-title-input {
        display: block !important;
        margin-top: 20px !important; 
        margin-left: 15px !important;
        width: calc(100% - 30px) !important;
        position: relative;
        z-index: 1;
    }

    /* 6. Conte√∫do da Nota (Padding Gigante para o Teclado) */
    #note-content-editor {
        display: block !important;
        overflow: visible !important; /* O scroll √© gerido pelo pai (#editor-area) */
        height: auto !important;
        
        /* Espa√ßo enorme no fundo para conseguir fazer scroll 
           e ver o texto mesmo com o teclado aberto */
        padding: 10px 15px 400px 15px !important; 
    }
}

@media (max-width: 768px) {
    /* 1. Mostra a barra de voltar apenas no mobile */
    #archive-mobile-nav {
        display: flex !important;
    }

    /* 2. Remove o espa√ßo excessivo acima do t√≠tulo */
    #archive-area > div[style*="padding: 20px"] {
        padding-top: 10px !important;
    }

    /* 3. For√ßa o conte√∫do a colar ao topo (elimina o buraco negro) */
    #right-panel, #archive-area {
        justify-content: flex-start !important;
    }
}

/* ============================================================
   CORRE√á√ÉO FINAL DE ESPA√áAMENTO NO TOPO (MOBILE)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßa o painel da direita a alinhar tudo ao TOPO */
    #right-panel {
        display: block !important; /* Remove o Flexbox que centra as coisas */
        padding-top: 0 !important;
        justify-content: flex-start !important;
    }

    /* 2. Garante que o Arquivo ocupa a altura toda e cola ao topo */
    #archive-area {
        display: none;
        flex-direction: column !important;
        height: 100vh !important;
        justify-content: flex-start !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* 3. Se tiver a barra de navega√ß√£o que cri√°mos antes, garante que ela n√£o tem margem */
    #archive-mobile-nav {
        flex-shrink: 0; /* Impede que encolha */
        margin-top: 0 !important;
    }
    
    /* 4. Remove padding extra do t√≠tulo do arquivo */
    #archive-area > div:nth-child(2) { /* Seleciona a div do input de t√≠tulo */
        padding-top: 10px !important;
    }
}

/* ============================================================
   CORRE√á√ÉO FINAL DE ALINHAMENTO VERTICAL (MOBILE)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar o contentor principal a alinhar ao TOPO */
    #right-panel {
        display: block !important;       /* Desliga o Flexbox centrado */
        padding-top: 0 !important;       /* Remove padding do topo */
        justify-content: flex-start !important; /* Se ficar flex, cola ao topo */
        overflow-y: auto !important;     /* Permite scroll se necess√°rio */
    }

    /* 2. Garantir que o Arquivo ocupa o espa√ßo e n√£o tem margens estranhas */
    #archive-area {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;         /* Altura autom√°tica para n√£o esticar */
        min-height: 100vh !important;    /* M√≠nimo ecra todo */
        justify-content: flex-start !important; /* Cola conte√∫dos ao topo */
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* 3. Se tiver a barra de navega√ß√£o "Voltar", cola-a ao teto */
    #archive-mobile-nav {
        margin-top: 0 !important;
        flex-shrink: 0;
    }
}

/* ============================================================
   CORRE√á√ÉO DO √çCONE SOBREPOSTO (LIVRO)
   ============================================================ */
@media (max-width: 768px) {
    /* Quando o modo de edi√ß√£o/arquivo est√° ativo,
       DESTR√ìI o placeholder (livro) completamente */
    body.mobile-view-editor #editor-placeholder {
        display: none !important;
        height: 0 !important;
        overflow: hidden !important;
    }
}

/* Contentor da linha da refer√™ncia */
.reference-item {
    border-bottom: 1px solid var(--border-color);
    padding: 5px 0;
    transition: background 0.2s;
}

.reference-item summary {
    list-style: none;
    padding: 8px 10px;
    cursor: pointer;
}

/* Esconde a seta padr√£o do summary */
.reference-item summary::-webkit-details-marker { display: none; }

/* Alinhamento da linha: [+] [T√≠tulo] [Seta] */
.ref-item-header {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.ref-item-title {
    flex-grow: 1;
    font-size: 0.95em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-color);
}

/* O bot√£o "+" mais discreto */
.add-to-puzzle-btn {
    background: var(--hover-color);
    border: 1px solid var(--border-color);
    color: var(--accent-color);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    flex-shrink: 0;
    transition: all 0.2s;
}

.add-to-puzzle-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* O "Contexto" (Snippets) agora sem caixas azuis, apenas texto discreto */
.reference-context {
    padding: 0 10px 10px 44px; /* Alinhado com o texto acima */
    font-size: 0.85em;
    color: var(--text-muted-color);
    line-height: 1.4;
}

/* Remove qualquer background azul ou borda que tenhas nos snippets anteriores */
.reference-context p, .reference-context mark {
    background: transparent;
    border: none;
}

.reference-context mark {
    color: var(--accent-color);
    font-weight: bold;
    text-decoration: underline;
}

/* ============================================================
   DESIGN MODERNO DA GRELHA B√çBLICA
   ============================================================ */
.bible-grid {
    display: grid;
    /* FR divide o espa√ßo dispon√≠vel em partes iguais. 4 colunas = 25% cada. */
    grid-template-columns: repeat(4, 1fr); 
    gap: 8px; /* Espa√ßo fixo entre bot√µes */
    padding: 10px;
    width: 100%;
    box-sizing: border-box; /* Garante que o padding n√£o aumenta a largura */
}

.bible-grid-btn {
    /* Mant√©m o bot√£o quadrado independentemente da largura */
    aspect-ratio: 1 / 1; 
    display: flex;
    align-items: center;
    justify-content: center;
    
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    
    color: var(--text-color);
    /* Fonte ajustada para bot√µes de ~50px */
    font-size: 1.1rem; 
    font-weight: 700;
    
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Estilo de SELE√á√ÉO (Hover / Rato por cima) */
.bible-grid-btn:hover {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important;
    transform: translateY(-2px); /* Salta para cima */
    box-shadow: 0 4px 8px rgba(74, 144, 226, 0.4);
    z-index: 2;
}

/* Feedback ao carregar (Telem√≥vel) */
.bible-grid-btn:active {
    transform: scale(0.9);
}

/* Estilo para Vers√≠culo que J√Å EXISTE (VERDE) */
.bible-grid-btn.exists {
    background-color: rgba(46, 204, 113, 0.1);
    border: 1px solid #2ecc71;
    color: #2ecc71;
}

.bible-grid-btn.exists:hover {
    background-color: #2ecc71 !important;
    color: white !important;
}

/* Ajuste de scrollbar para a lista do meio n√£o bater nos bot√µes */
#file-list {
    padding-right: 5px;
    overflow-x: hidden;
}

/* Estilo Amarelo para o bot√£o Adicionar em Listas */
#add-item-btn.yellow-mode {
    border-color: #f1c40f !important;
    color: #f1c40f !important;
}

#add-item-btn.yellow-mode:hover {
    background-color: #f1c40f !important;
    color: white !important;
}

/* Estilos para o Layout do Codex */
.codex-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: flex-end;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid var(--accent-color);
    position: relative;
}

.codex-field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.codex-field-group label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-muted-color);
}

.codex-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 13px;
}

.multi-input-container {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-add-small {
    background: var(--hover-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.btn-toggle-codex {
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}

.btn-toggle-codex.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.remove-codex-row {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e74c3c;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    border: none;
}


.codex-row {
    background: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: border-color 0.2s;
}

.codex-row:hover {
    border-color: var(--accent-color);
}

/* Header da Linha (Serie + A/M + Lixo) */
.codex-header-grid {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.serie-wrapper { flex: 1; position: relative; }

.codex-label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted-color);
    margin-bottom: 6px;
    letter-spacing: 0.5px;
}

/* Inputs elegantes */
.codex-input-modern {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    outline: none;
    transition: all 0.2s;
}

.codex-input-modern:focus {
    border-color: var(--accent-color);
    background: var(--sidebar-color);
}

/* Bot√µes A e M */
.btn-control-small {
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    width: 34px;
    height: 34px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-control-small.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Bot√£o Lixo */
.btn-delete-row {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 18px;
    padding: 5px;
    transition: color 0.2s;
}
.btn-delete-row:hover { color: #e74c3c; }

/* Grid de Baixo (P√°ginas e Par√°grafos) */
.codex-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

/* Estilo das Unidades (Chips/P√≠lulas) */
.codex-unit-chip {
    display: inline-flex;
    align-items: center;
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-right: 6px;
    margin-bottom: 6px;
    overflow: hidden;
}

.codex-unit-chip input {
    background: transparent;
    border: none;
    color: var(--text-color);
    width: 40px;
    padding: 6px 4px 6px 8px;
    font-size: 13px;
    outline: none;
    text-align: center;
}

.btn-unit-del {
    background: rgba(231, 76, 60, 0.1);
    border: none;
    color: #e74c3c;
    padding: 0 8px;
    cursor: pointer;
    height: 28px;
    font-size: 12px;
}
.btn-unit-del:hover { background: #e74c3c; color: white; }

/* Bot√£o Adicionar Unidade (+) */
.btn-unit-add {
    background: var(--bg-color);
    border: 1px dashed var(--border-color);
    color: var(--accent-color);
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.btn-unit-add:hover { background: var(--accent-color); color: white; border-style: solid; }

.manual-inputs-area { display: flex; flex-wrap: wrap; /* Permite quebrar linha se n√£o houver espa√ßo */ gap: 8px; margin-bottom: 10px; margin-top: 10px; }

.manual-field-group {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid var(--border-color);
    padding: 5px 10px;
    border-radius: 6px;
    gap: 5px;
}

/* Inputs dentro das p√≠lulas manuais */
.codex-input-manual {
    background: transparent !important;
    border: none !important;
    color: var(--text-color) !important;
    font-size: 13px;
    padding: 0 !important;
    outline: none;
}

.btn-close-manual {
    background: none !important;
    border: none !important;
    color: #e74c3c !important;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    margin-left: 5px;
    display: flex;
    align-items: center;
}

.btn-close-manual:hover {
    color: #ff4d4d !important;
}

/* Garante que o modal de confirma√ß√£o fique sempre no topo absoluto */
#confirm-modal {
    z-index: 5000 !important;
}

/* O Link Modal (Gest√£o) fica numa camada alta */
#link-modal {
    z-index: 2000 !important;
}

/* O Confirm Modal (Eliminar) fica na camada m√°xima */
#confirm-modal {
    z-index: 10000000 !important;
}

/* Garante que o fundo escuro do confirm tamb√©m fique √† frente */
#confirm-modal, 
#confirm-modal.modal-overlay {
    z-index: 10000000 !important;
}

/* For√ßa a caixa de texto da confirma√ß√£o a acompanhar a camada */
#confirm-modal .modal-content {
    z-index: 10000001 !important;
}

/* Estilo espec√≠fico para as abas da 4¬™ Coluna */
#ref-tabs {
    border-bottom: 1px solid var(--border-color);
    gap: 15px;
    justify-content: flex-start;
    padding-left: 10px;
}

#ref-tabs button {
    background: none !important; /* Remove o fundo azul antigo */
    border-radius: 0;
    position: relative;
    padding: 10px 5px;
    flex-grow: 0; /* N√£o estica os bot√µes */
    color: var(--text-muted-color);
}

#ref-tabs button.active {
    color: var(--text-color) !important;
}

/* A linha azul ACIMA ou ABAIXO (como pediu 'acima', vou colocar no topo) */
#ref-tabs button.active::after {
    content: '';
    position: absolute;
    top: 0; /* Coloca a linha no topo do bot√£o */
    left: 0;
    width: 100%;
    height: 3px;
    background-color: var(--accent-color);
    border-radius: 0 0 2px 2px;
}

/* Cores para os bot√µes de a√ß√£o do painel lateral */
.btn-brown { background-color: #795548 !important; }
.btn-brown:hover { background-color: #5d4037 !important; }

.btn-orange-dark { background-color: #d35400 !important; }
.btn-orange-dark:hover { background-color: #a04000 !important; }

/* Classe base para garantir que o tamanho e fonte s√£o iguais aos do Puzzle */
.panel-action-btn-styled {
    border: none;
    color: white;
    border-radius: 4px;
    padding: 0 12px;
    height: 30px;
    cursor: pointer;
    font-weight: bold;
    font-size: 13px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

/* Estilo para o vers√≠culo que est√° aberto na 4¬™ coluna */
.bible-grid-btn.active-verse {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: white !important;
    transform: scale(1.1);
    z-index: 5;
    box-shadow: 0 0 12px rgba(74, 144, 226, 0.5);
}

/* Estilo dos Cards das Micas */
.mica-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    position: relative;
    transition: transform 0.2s;
    cursor: pointer;
}

.mica-card:hover { border-color: var(--accent-color); }

.mica-card.active-view {
    cursor: default;
    border-color: var(--accent-color);
    background-color: rgba(255,255,255,0.02);
}

/* Popup de Cores das Micas */
#mica-color-popup {
    display: none;
    position: fixed; /* Mudado de absolute para fixed para ignorar scroll do pai */
    z-index: 30000 !important; /* Muito acima dos 10000 da 4¬™ coluna */
    background: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    padding: 12px;
    border-radius: 12px;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    /* Garante que n√£o saia da tela no mobile */
    max-width: 160px;
}

.mica-color-dot {
    width: 35px; /* Ligeiramente maior para facilitar o toque */
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid rgba(255,255,255,0.1);
    transition: transform 0.1s;
}

.mica-color-dot:active {
    transform: scale(0.9);
}

/* Estilo Unificado para os bot√µes Editar das abas da 4¬™ Coluna */
.ref-panel-edit-btn {
    background: none !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-muted-color) !important;
    border-radius: 4px;
    padding: 4px 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
    height: 28px; /* Altura fixa para alinhar com o t√≠tulo */
    display: flex;
    align-items: center;
    justify-content: center;
}

.ref-panel-edit-btn:hover {
    background-color: var(--hover-color) !important;
    color: var(--text-color) !important;
}

/* Design azul quando est√° em modo "Salvar" */
.ref-panel-edit-btn.is-active {
    color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1) !important;
}

/* Classe unificada para os bot√µes Editar da 4¬™ coluna */
.btn-editar-custom {
    background: none !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-muted-color) !important;
    border-radius: 4px !important;
    padding: 4px 10px !important;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
}

.btn-editar-custom:hover {
    background-color: var(--hover-color) !important;
    color: var(--text-color) !important;
}

/* Estado quando est√° em modo "Salvar" (Azul) */
.btn-editar-custom.is-active {
    color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1) !important;
}




/* Estado visual do card sendo arrastado */
.board-card.dragging-mica {
    opacity: 0.4;
    border: 1px dashed var(--accent-color);
}

/* Estilo para o conte√∫do oculto da B√≠blia no Dossi√© */
.bible-collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.2s, margin-top 0.3s;
    opacity: 0;
    font-size: 0.92em;
    color: var(--text-color);
    padding-left: 8px;
    line-height: 1.5;
    font-style: italic;
    opacity: 0.9;
}

/* Quando o card est√° expandido */
.board-card.bible-open .bible-collapsible-content {
    max-height: 1000px; /* Valor alto para permitir qualquer tamanho de texto */
    opacity: 1;
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding-top: 10px;
}

/* Cursor e Seta no T√≠tulo da B√≠blia */
.bible-clickable-area {
    cursor: pointer;
}

.bible-clickable-area .ref-title-text::after {
    content: ' ‚ñæ';
    font-size: 0.8em;
    opacity: 0.5;
    display: inline-block;
    transition: transform 0.3s;
}

.board-card.bible-open .ref-title-text::after {
    transform: rotate(180deg);
}

/* Bot√µes de navega√ß√£o subir/descer no Dossi√© */
.mica-nav-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 4px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mica-nav-btn:hover {
    background-color: var(--hover-color);
    color: var(--accent-color);
    border-color: var(--border-color);
}

/* Garante que o texto dos cards seja selecion√°vel para c√≥pia */
.board-card.type-ref {
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: default !important;
}

/* Ajuste na √°rea clic√°vel da b√≠blia para n√£o interferir na sele√ß√£o */
.bible-clickable-area {
    user-select: text;
}

.mica-card {
    transition: transform 0.1s, background-color 0.2s;
    /* Impede que o texto seja selecionado enquanto tentas clicar r√°pido */
    user-select: none; 
}

.mica-card:active {
    transform: scale(0.98); /* Efeito de "apertar" o bot√£o ao clicar */
    background-color: var(--hover-color);
}

.bible-card-mica {
    border-left: 4px solid #5d4037 !important; /* Castanho em vez de Roxo */
    padding-left: 10px;
}

/* Estilo para o Modo Pins (Rosa) */
.folder-mode-item.active.mode-pins {
    color: #ff69b4 !important; /* Hot Pink */
}

.folder-mode-item.active.mode-pins::after {
    background-color: #ff69b4 !important;
    height: 3px;
}

/* √çcone de Pin na lista */
.list-item[data-pinned="true"]::after {
    content: 'üìå';
    font-size: 14px;            /* Tamanho do pin */
    position: absolute;
    left: 18px;                 /* Ajusta horizontalmente sobre o √≠cone */
    top: 8px;                   /* Ajusta verticalmente (sobe um pouco) */
    z-index: 10;                /* Garante que fica por cima do √≠cone */
    pointer-events: none;       /* O clique passa atrav√©s do pin para a pasta */
    
    /* Efeito de sombra para o pin destacar-se do √≠cone amarelo */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.6); 
    
    /* Leve inclina√ß√£o para parecer espetado na pasta */
    transform: rotate(-10deg); 
}

/* Garante que o √≠cone original n√£o seja empurrado */
.list-item {
    position: relative; 
}

/* Linha divis√≥ria dentro do menu de contexto */
.menu-sep {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 4px 5px;
    opacity: 0.4;
}

/* Ajuste da Grelha de Emojis do Cosmos */
#cosmos-emoji-grid {
    display: grid;
    /* auto-fill: preenche o espa√ßo dispon√≠vel / minmax: tamanho m√≠nimo de 45px por bot√£o */
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
    gap: 10px;
    width: 100%;
    max-width: 100%; /* Impede que a grelha saia para fora */
    box-sizing: border-box;
    margin-bottom: 20px;
    padding: 5px;
}

/* Ajuste dos bot√µes de Emoji */
.emoji-btn {
    aspect-ratio: 1 / 1; /* Mant√©m o bot√£o sempre quadrado */
    width: 100%;       /* Ocupa a largura da coluna da grelha */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    padding: 0;
}

/* Feedback visual de selecionado */
.emoji-btn.selected {
    border-color: var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.1);
    box-shadow: 0 0 5px var(--accent-color);
}

/* No mobile, o modal em si deve ter um limite de largura */
@media (max-width: 480px) {
    #cosmos-modal .modal-content {
        width: 90%;
        max-width: 320px;
        padding: 20px;
    }
    
    .emoji-btn {
        font-size: 18px; /* Reduz ligeiramente o emoji no telem√≥vel */
    }
}


/* Toggle de Escopo de Pesquisa */
#search-scope-container {
    display: none; /* Escondido por padr√£o, aparece via JS */
    align-items: center;
    gap: 8px;
    background: var(--panel-color);
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    margin-right: 10px;
}

.scope-label {
    font-size: 11px;
    font-weight: bold;
    color: var(--text-muted-color);
    text-transform: uppercase;
}

.scope-switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 18px;
}

.scope-switch input { opacity: 0; width: 0; height: 0; }

.scope-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--sidebar-color);
    transition: .4s;
    border-radius: 20px;
    border: 1px solid var(--border-color);
}

.scope-slider:before {
    position: absolute;
    content: "";
    height: 12px; width: 12px;
    left: 2px; bottom: 2px;
    background-color: var(--text-muted-color);
    transition: .4s;
    border-radius: 50%;
}

input:checked + .scope-slider { background-color: var(--accent-color); }
input:checked + .scope-slider:before { transform: translateX(16px); background-color: white; }

/* Bot√£o de Escopo de Pesquisa (Quadrado como o Filtros) */
#search-scope-btn {
    display: none; /* Escondido por padr√£o */
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    margin-left: 10px; /* Espa√ßo √† direita do Filtros */
    white-space: nowrap;
    align-items: center;
    gap: 8px;
}

#search-scope-btn:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Estado Ativo (Na P√°gina) */
#search-scope-btn.active {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}


/* Bot√£o X no canto superior direito */
.corner-close-btn {
    position: absolute;
    top: 5px;
    right: 8px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-muted-color);
    opacity: 0.5;
    transition: opacity 0.2s, color 0.2s;
    background: none;
    border: none;
    padding: 2px;
    z-index: 5;
}
.corner-close-btn:hover {
    opacity: 1;
    color: #e74c3c;
}

/* Estilo da Gaveta (Pasta) dentro do Gavet√£o */
.gaveta-folder {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px 15px;
    margin: 5px 0 5px 20px; /* Recuo para parecer interno */
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
}
.gaveta-folder:hover {
    background-color: var(--hover-color);
}

.gaveta-title-area {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-color);
    font-weight: 500;
}

/* Header da Gaveta Aberta */
.opened-gaveta-header {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: var(--panel-color);
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid var(--accent-color);
}


/* Garante que o fundo do modal seja vis√≠vel e cubra tudo */
#create-gaveta-modal.modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.85) !important; /* Fundo escuro */
    display: none; /* Controlado pelo JS */
    align-items: center !important;
    justify-content: center !important;
    z-index: 9999999 !important;
}

/* Garante que a caixa branca/escura apare√ßa no meio */
#create-gaveta-modal .modal-content {
    background-color: var(--sidebar-color) !important;
    border: 1px solid var(--accent-color) !important;
    padding: 30px !important;
    border-radius: 12px !important;
    width: 90% !important;
    max-width: 400px !important;
    box-shadow: 0 10px 50px rgba(0,0,0,1) !important;
    color: white !important;
}

#drawer-selection-modal.modal-overlay {
    z-index: 30000 !important;
}

/* Quando o post est√° em modo lista (t√≠tulos apenas) */
.archive-post {
    transition: all 0.2s ease;
}

.archive-post:hover {
    background-color: var(--hover-color);
}

/* Cabe√ßalho do Gavet√£o no Modal */
.modal-gavetao-header {
    background-color: rgba(74, 144, 226, 0.1);
    color: var(--accent-color);
    padding: 8px 12px;
    border-radius: 6px 6px 0 0;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 15px;
    border-left: 4px solid var(--accent-color);
}

/* Container que agrupa as gavetas de um gavet√£o */
.modal-gavetas-group {
    background-color: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 6px 6px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Ajuste do item da gaveta para parecer interno */
.list-item.gaveta-interna {
    margin: 0 !important;
    padding: 10px 15px !important;
    background-color: var(--panel-color);
    border: 1px solid transparent;
}

.list-item.gaveta-interna:hover {
    border-color: var(--accent-color);
}

/* Esconder o bot√£o em ecr√£s pequenos (Mobile) */
@media (max-width: 768px) {
    .pc-only { display: none !important; }
}

/* Regras para o Modo Criativo Ativo */
.notebook-container.creative-mode-active #left-panel,
.notebook-container.creative-mode-active #middle-panel {
    display: none !important;
}

/* Estilo para o bot√£o ü™Å quando est√° ativo no menu */
button[data-action="creative-mode"].active {
    background-color: var(--accent-color) !important;
    border-color: var(--accent-color) !important;
    color: white !important;
}

.archive-separator {
    background-color: rgba(46, 204, 113, 0.05); /* Fundo verde muito subtil */
    border: 1px dashed #2ecc71;
    border-left: 5px solid #2ecc71; /* Barra lateral s√≥lida verde */
    border-radius: 8px;
    padding: 10px 15px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 50px;
    position: relative;
}

.separator-title {
    font-weight: bold;
    color: #27ae60; /* Verde escuro para leitura */
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Cor vermelha para o toggle de colabora√ß√£o quando ativo */
#collab-share-toggle:checked + .slider {
    background-color: #e74c3c !important;
}

/* Opcional: Efeito visual para a bolinha branca quando est√° em modo vermelho */
#collab-share-toggle:checked + .slider:before {
    box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}

/* ============================================================
   ESTILO DO ESCUDO DE CARREGAMENTO (APP LOADER)
   ============================================================ */
#app-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: #1a1a1d; /* Mesma cor do seu --bg-color */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999999; /* Fica por cima de absolutamente tudo */
    transition: opacity 0.5s ease, visibility 0.5s;
}

.loader-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.loader-circle {
    width: 60px;
    height: 60px;
    border: 3px solid rgba(74, 144, 226, 0.1);
    border-top: 3px solid #4a90e2; /* Cor --accent-color */
    border-radius: 50%;
    animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

.loader-logo {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    font-size: 32px;
}

.logo-text {
    font-size: 24px;
    font-weight: bold;
    color: #f0f0f0;
    letter-spacing: 1px;
}

.loader-status {
    color: #888;
    font-size: 0.9em;
    font-style: italic;
    animation: pulse 1.5s infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Classe para esconder com suavidade */
#app-loader.fade-out {
    opacity: 0;
    visibility: hidden;
}


.notebook-container { 
    display: none !important; /* Adiciona isto: O site nasce escondido */
    height: 100vh; 
    width: 100vw; 
}



/* Garante que o visualizador de links fique acima da 4¬™ coluna (que tem 10000 no mobile) */
#view-link-modal.modal-overlay {
    z-index: 30000 !important;
}

#view-link-modal .modal-content {
    z-index: 30001 !important;
}

/* Ajuste para os itens da lista dentro do modal serem mais f√°ceis de clicar no telem√≥vel */
#view-link-urls-list li {
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}

#view-link-urls-list li:active {
    background-color: rgba(74, 144, 226, 0.2) !important;
}

#link-modal.modal-overlay {
    z-index: 30000 !important;
}


/* Remove o sublinhado vermelho de erro ortogr√°fico nos links do quadro */
.board-link, .board-text-content {
    spellcheck: false;
    -webkit-spellcheck: false;
}

/* Garante que o clique passe para o JS mesmo com o aviso de erro */
.board-link {
    pointer-events: auto !important;
}


/* ============================================================
   AJUSTE DO POPUP MUDAR ICON (SUPERPASTA)
   ============================================================ */

/* 1. Torna o conte√∫do do modal scrol√°vel e limita a altura */
#icon-picker-modal .modal-content {
    max-height: 80vh; /* Altura m√°xima de 80% do ecr√£ */
    overflow-y: auto; /* Ativa scroll vertical */
    padding: 20px;
    width: 90%;
    max-width: 380px;
    scrollbar-width: thin;
}

/* 2. Reduz drasticamente a zona do bot√£o "Padr√£o" */
#icon-picker-modal .emoji-btn[data-icon="üóÉÔ∏è"] {
    grid-column: span 4 !important; /* Continua a ocupar a largura toda */
    height: 50px !important;        /* Mas com altura reduzida */
    font-size: 16px !important;     /* Texto menor */
    display: flex !important;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;            /* Espa√ßo para os √≠cones de baixo */
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
}

/* 3. Garante que a grelha de emojis em baixo est√° correta */
#emoji-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    padding-bottom: 10px;
}

/* 4. Estilo individual dos bot√µes de emoji (mais compactos) */
#emoji-grid .emoji-btn {
    height: 60px; /* Altura fixa para os quadrados */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border-radius: 10px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s;
}

#emoji-grid .emoji-btn:hover {
    border-color: var(--accent-color);
    background-color: var(--hover-color);
    transform: scale(1.05);
}

/* Customiza√ß√£o da scrollbar para este modal */
#icon-picker-modal .modal-content::-webkit-scrollbar {
    width: 6px;
}
#icon-picker-modal .modal-content::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

/* Notifica√ß√£o na Lista Lateral */
.notif-badge {
    background-color: #e74c3c;
    color: white;
    font-size: 10px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
    position: absolute;
    right: 35px; /* Ajustado para n√£o bater no bot√£o de menu */
    top: 50%;
    transform: translateY(-50%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}


/* --- NOTIFICA√á√ïES NO POST (FEED) --- */
.post-status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    position: absolute;
    top: -5px; /* Sai um pouco para fora do card */
    left: -5px;
    z-index: 20;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    border: 2px solid var(--panel-color); /* Borda para separar visualmente */
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Novo Post (Vermelho) */
.dot-new {
    background-color: #e74c3c; 
    animation: pulse-red 2s infinite;
}

/* Post Editado (Laranja) */
.dot-edited {
    background-color: #f39c12; 
    animation: pulse-orange 2s infinite;
}

@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
    100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

@keyframes pulse-orange {
    0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(243, 156, 18, 0); }
    100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
}

/* --- CONTADOR NA LISTA LATERAL (COLUNA 2) --- */
.unread-count-badge {
    background-color: #e74c3c;
    color: white;
    font-size: 11px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: auto; /* Empurra para a direita */
    margin-right: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    min-width: 20px;
    text-align: center;
}

/* --- BOLINHA NA ABA PARTILHADO (COLUNA 1) --- */
.tab-notification-dot {
    position: absolute;
    top: 2px;
    right: -4px;
    width: 8px;
    height: 8px;
    background-color: #e74c3c;
    border-radius: 50%;
    border: 1px solid var(--sidebar-color);
    display: none; /* Escondido por defeito */
}

.tab-notification-dot.visible {
    display: block;
}

/* Indicador de menu no bot√£o B Azul */
/* Bot√£o B Azul com Pontos de Menu */
button[data-command="boldBlue"] {
    position: relative; 
}

button[data-command="boldBlue"]::after {
    display: none !important;
    content: '‚Ä¢‚Ä¢';
    position: absolute;
    top: -2px;       /* Ajuste fino para ficar bem no canto */
    right: 2px;
    font-size: 10px;
    line-height: 1;
    color: var(--text-muted-color);
    /* Removemos pointer-events: none para permitir detetar que o rato est√° ali */
    cursor: context-menu; /* Muda o cursor para indicar que √© um menu */
}

button[data-command="boldBlue"]:hover::after {
    color: white; /* Destaca os pontos ao passar o rato */
}

/* Novo Popup de Cores de Negrito */
#bold-palette-popup {
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    padding: 8px;
    display: none;
    position: absolute;
    z-index: 3000;
    width: auto;
}

/* Estilo para os dois pontos clic√°veis */
.dots-trigger {
    position: absolute;
    top: 0;
    right: 0;
    width: 15px;       /* √Årea de clique mais larga */
    height: 100%;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 2px;
    border-radius: 0 4px 4px 0;
    transition: background 0.2s, color 0.2s;
    pointer-events: auto; /* Garante que o span recebe o clique */
    z-index: 10;          /* Garante que est√° acima do bot√£o */
}

.dots-trigger:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: var(--text-color);
}


/* Quando o popup est√° em modo Jornal, ajustamos a largura e layout */
#formatting-popup.journal-mode {
    width: 240px !important; /* Mais largo para caberem os √≠cones */
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 5px !important;
}

/* Container para os √≠cones do Jornal dentro do popup */
#journal-tools-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color); /* A divis√£o visual leve */
    margin-bottom: 5px;
}

/* Garante que os bot√µes dentro do container novo mant√™m o estilo */
#journal-tools-container button {
    width: 32px !important;
    height: 32px !important;
    font-size: 16px !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* O container original dos bot√µes (ü§ñ üî¨ ü™Å) */
#formatting-popup .default-tools-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
}

/* --- WIDGET DE IMAGEM DO JORNAL --- */

/* Contentor Principal */
.journal-img-wrapper {
    position: relative;
    display: inline-block; /* Permite texto ao lado ou bloco */
    margin: 10px 0;
    max-width: 100%;
    transition: all 0.2s;
    user-select: none;
}

/* A Imagem em si */
.journal-img-wrapper img {
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    object-fit: cover;
    display: block;
    border: 2px solid transparent;
}

/* Estado de Edi√ß√£o (Input de URL) */
.journal-img-placeholder {
    display: flex;
    gap: 5px;
    background: var(--panel-color);
    padding: 10px;
    border: 1px dashed var(--accent-color);
    border-radius: 8px;
    align-items: center;
    width: 100%;
    max-width: 400px;
}

.journal-img-placeholder input {
    flex-grow: 1;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 5px 10px;
    border-radius: 4px;
}

/* Bot√£o de Editar (Canto Superior Direito) */
.journal-img-edit-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    display: none; /* S√≥ aparece no hover */
    z-index: 10;
}

.journal-img-wrapper:hover .journal-img-edit-btn {
    display: block;
}

/* Menu de Op√ß√µes de Edi√ß√£o */
.journal-img-menu {
    position: absolute;
    top: 35px;
    right: 5px;
    background: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 5px;
    display: none; /* Controlado via JS */
    flex-direction: column;
    gap: 5px;
    z-index: 20;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    min-width: 120px;
}

.journal-img-menu.visible { display: flex; }

.journal-img-menu button {
    background: none;
    border: none;
    color: var(--text-color);
    text-align: left;
    padding: 5px;
    cursor: pointer;
    font-size: 12px;
}
.journal-img-menu button:hover { background-color: var(--hover-color); }

/* Dimens√µes */
.img-size-sm img { max-width: 150px; max-height: 150px; }
.img-size-md img { max-width: 300px; max-height: 300px; }
.img-size-lg img { max-width: 500px; max-height: 500px; }
.img-size-xl img { max-width: 100%; height: auto; }



/* --- WIDGET CUBO (CAIXA DE TEXTO FLUTUANTE) --- */

.journal-cube-wrapper {
    /* Base */
    background-color: var(--panel-color); /* Fundo padr√£o */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin: 15px;
    
    /* Layout */
    width: 45%; /* Padr√£o */
    box-sizing: border-box;
    position: relative;
    
    /* Efeitos 3D e Transi√ß√£o */
    box-shadow: 4px 4px 0px rgba(0,0,0,0.2); /* Sombra dura estilo Pop-Art */
    transition: transform 0.2s, box-shadow 0.2s, width 0.2s;
    
    /* Importante para o texto fluir √† volta */
    float: left; 
}

/* --- MODOS DE ALINHAMENTO --- */
.journal-cube-wrapper.float-left {
    float: left;
    width: 45%;
    margin-right: 15px;
}

.journal-cube-wrapper.float-right {
    float: right;
    width: 45%;
    margin-left: 15px;
}

/* Hover: Mostra a toolbar e levanta o cubo */
.journal-cube-wrapper:hover {
    box-shadow: 6px 6px 10px rgba(0,0,0,0.3);
    z-index: 10;
}

.journal-cube-wrapper:hover .cube-toolbar {
    display: flex;
}

/* Toolbar Flutuante Melhorada */
.cube-toolbar {
    display: none;
    position: absolute;
    top: -40px;
    left: 0; /* Alinha √† esquerda do cubo */
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 4px;
    padding: 4px;
    gap: 5px;
    z-index: 50;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    align-items: center;
    white-space: nowrap;
}

.cube-toolbar input[type="color"] {
    width: 20px; height: 20px; border: none; padding: 0; cursor: pointer;
}


/* Mostra a toolbar quando passa o rato */
.journal-cube-wrapper:hover .cube-toolbar {
    display: flex;
}

/* Estilo do Puxador */
.cube-drag-handle {
    cursor: grab;
    font-size: 16px;
    padding: 2px 6px;
    color: var(--accent-color);
    display: flex;
    align-items: center;
}
.cube-drag-handle:hover { background-color: var(--hover-color); }

/* √Årea de Texto Edit√°vel */
.cube-content {
    padding: 15px;
    outline: none;
    min-height: 60px;
    color: var(--text-color);
    line-height: 1.5;
}

/* Corre√ß√£o para quando se arrasta */
.journal-cube-wrapper.sortable-dragging {
    opacity: 0.5;
    border: 2px dashed var(--accent-color);
}

/* Puxador de Arrasto do Cubo */
.cube-drag-handle {
    cursor: grab;
    font-size: 16px;
    padding: 2px 6px;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    border-radius: 3px;
}

.cube-drag-handle:hover {
    background-color: var(--hover-color);
}

.cube-drag-handle:active {
    cursor: grabbing;
}

/* Quando est√° a ser arrastado */
.journal-cube-wrapper.sortable-dragging {
    opacity: 0.4;
    border: 2px dashed var(--accent-color);
    transform: scale(0.98);
}

/* Indicadores de Drop Lateral */
.drop-target-left {
    border-left: 4px solid var(--accent-color) !important;
    padding-left: 10px;
}

.drop-target-right {
    border-right: 4px solid var(--accent-color) !important;
    padding-right: 10px;
}

/* --- CAIXA DE RACIOC√çNIO (PLACA ü™ß) --- */

.journal-sign-wrapper {
    background-color: var(--sidebar-color); /* Fundo escuro/neutro */
    border: 1px solid #f1c40f;            /* Borda Amarela */
    border-radius: 8px;
    margin: 15px 0;
    padding: 0;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Toolbar (Topo) */
.sign-toolbar {
    background-color: rgba(241, 196, 15, 0.1); /* Amarelo muito suave */
    border-bottom: 1px solid #f1c40f;
    padding: 5px 10px;
    display: flex;
    align-items: center;
    color: #f1c40f;
    font-weight: bold;
    font-size: 0.9em;
}

.sign-btn-del {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.sign-btn-del:hover { opacity: 1; }

/* Cabe√ßalho (T√≠tulo) */
.sign-header {
    padding: 10px;
    border-bottom: 1px dashed var(--border-color);
}

.sign-title-input {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--text-color);
    font-size: 1.1em;
    font-weight: bold;
    outline: none;
}

/* Conte√∫do (Resposta) */
.sign-content {
    padding: 10px;
    min-height: 60px;
    color: var(--text-color);
    line-height: 1.5;
    outline: none;
}

/* √Årea de Anexos */
.sign-attachments-area {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 0 10px;
}

/* Item de Anexo (Link ou Imagem) */
.sign-attachment-item {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
    max-width: 100%;
    font-size: 0.9em;
}

.sign-attachment-item img {
    max-height: 100px;
    border-radius: 4px;
}

.sign-attachment-item a {
    color: var(--accent-color);
    text-decoration: none;
    word-break: break-all;
}

.sign-attachment-del {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-weight: bold;
    margin-left: 5px;
}

/* Bot√£o Adicionar (+) */
.sign-add-btn-area {
    padding: 10px;
    text-align: center;
}

.sign-add-btn {
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border: 1px dashed var(--border-color);
    color: var(--text-muted-color);
    padding: 5px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1.2em;
}

.sign-add-btn:hover {
    background: var(--hover-color);
    color: var(--text-color);
    border-color: var(--accent-color);
}

/* Placeholder para div contenteditable */
.sign-content:empty:before {
    content: attr(data-placeholder);
    color: var(--text-muted-color);
    opacity: 0.6;
    pointer-events: none; /* Deixa clicar atrav√©s do texto */
    font-style: italic;
}

/* Garante que o cursor aparece mesmo quando est√° vazio */
.sign-content {
    min-height: 60px;
    padding: 10px;
    color: var(--text-color);
    line-height: 1.5;
    outline: none;
    /* Corre√ß√£o para Firefox/Chrome: evita colapso total */
    display: block; 
}

/* --- NUMERA√á√ÉO AUTOM√ÅTICA DE RACIOC√çNIOS --- */

/* 1. Iniciar o contador no editor */
#note-content-editor {
    counter-reset: raciocinio-counter;
}

/* 2. Incrementar o contador em cada caixa */
.journal-sign-wrapper {
    counter-increment: raciocinio-counter;
}

/* 3. Injetar o n√∫mero no t√≠tulo (Span espec√≠fico que vamos criar) */
.sign-number-display::after {
    content: " #" counter(raciocinio-counter);
}

/* --- ESTILO DOS NOVOS BOT√ïES --- */
.sign-move-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    opacity: 0.6;
    margin: 0 2px;
    color: #f1c40f; /* Amarelo para combinar */
}
.sign-move-btn:hover { opacity: 1; background-color: rgba(0,0,0,0.1); border-radius: 3px; }


/* --- ESTILO DA LISTA DE ANEXOS (LINHAS) --- */

/* Contentor da lista */
.sign-attachments-area {
    display: flex;
    flex-direction: column; /* For√ßa lista vertical */
    gap: 0; /* Sem espa√ßo extra entre linhas, usamos border */
    padding: 0;
    margin-top: 5px;
    border-top: 1px dashed var(--border-color); /* Linha separadora do conte√∫do */
}

/* Item Individual (Linha) */
.sign-attachment-row {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    background-color: transparent;
    font-size: 0.9em;
    transition: background 0.2s;
}

.sign-attachment-row:hover {
    background-color: var(--hover-color);
}

/* Texto do Link */
.sign-link-text {
    flex-grow: 1;
    color: var(--accent-color);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 10px;
}

.sign-link-text:hover { text-decoration: underline; }

/* Bot√µes de A√ß√£o (Ir e Editar) */
.sign-row-btn {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sign-row-btn:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.sign-row-btn.delete:hover {
    background-color: #e74c3c;
    border-color: #e74c3c;
}

/* --- CART√ÉO TEM√ÅTICO (ID CARD ü™™) --- */

.journal-id-card {
    background-color: #d7ccc8; /* Cor "Bege/Terra" da tua imagem */
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
    position: relative;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border: 1px solid #a1887f;
    overflow: hidden;
}

/* Toolbar Flutuante (Setas + Lixo) */
.card-toolbar {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 2px;
    z-index: 10;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    padding: 2px;
}

.card-toolbar button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 12px;
    color: #5d4037;
    opacity: 0.6;
}
.card-toolbar button:hover { opacity: 1; font-weight: bold; }
.card-del-btn:hover { color: #e74c3c !important; }

/* Layout Flex (Imagem | Texto) */
.card-body {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

/* Coluna da Imagem */
.card-image-area {
    flex: 0 0 100px; /* Largura fixa de 100px */
    width: 100px;
    height: 120px; /* Altura fixa para manter formato retrato */
}

/* Placeholder da Imagem (Quadrado com √≠cone) */
.card-img-placeholder {
    width: 100%;
    height: 100%;
    background-color: #f5f5f5;
    border: 2px dashed #a1887f;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #8d6e63;
    transition: background 0.2s;
}

.card-img-placeholder:hover {
    background-color: #ffffff;
    border-color: var(--accent-color);
}

/* A Imagem Real (quando inserida) */
.card-real-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Coluna de Texto */
.card-text-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* T√≠tulo */
.card-title-input {
    width: 100%;
    background: rgba(0,0,0,0.05);
    border: none;
    border-radius: 4px;
    padding: 8px;
    font-size: 1.2em;
    font-weight: bold;
    color: #3e2723;
    outline: none;
}

/* Descri√ß√£o */
.card-desc-content {
    min-height: 80px;
    color: #4e342e;
    line-height: 1.4;
    outline: none;
    font-size: 0.95em;
    background: rgba(255,255,255,0.3); /* Fundo subtil para √°rea de texto */
    padding: 8px;
    border-radius: 4px;
}

/* Placeholder CSS para a descri√ß√£o */
.card-desc-content:empty:before {
    content: attr(data-placeholder);
    color: #8d6e63;
    font-style: italic;
    opacity: 0.7;
}

/* --- WIDGET DUAS COLUNAS --- */

.journal-cols-container {
    display: flex;
    gap: 15px; /* Espa√ßo entre colunas */
    margin: 15px 0;
    width: 100%;
}

.journal-col {
    flex: 1; /* Divide o espa√ßo igualmente (50%) */
    min-height: 50px;
    padding: 10px;
    border: 1px dashed var(--border-color);
    border-radius: 6px;
    background-color: rgba(255, 255, 255, 0.02);
    outline: none;
}

/* No Telem√≥vel, empilha verticalmente */
@media (max-width: 768px) {
    .journal-cols-container {
        flex-direction: column;
    }
}

/* Placeholder para as Colunas */
.journal-col:empty::before {
    content: attr(data-placeholder);
    color: var(--text-muted-color);
    opacity: 0.5;
    font-style: italic;
    pointer-events: none; /* Permite clicar atrav√©s do texto */
}

/* Garante que a coluna tem altura mesmo vazia */
.journal-col {
    /* Mant√©m os teus estilos existentes e garante estes: */
    min-height: 60px; 
    display: block;
}


/* --- WRAPPER E TOOLBAR DAS COLUNAS --- */

.journal-cols-wrapper {
    position: relative;
    margin: 15px 0;
    transition: all 0.2s;
    border: 1px solid transparent; /* Para evitar saltos no hover */
}

/* Mostra uma borda suave ao passar o rato para identificar o bloco */
.journal-cols-wrapper:hover {
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    padding: 5px;
    margin: 10px -5px; /* Compensa o padding */
}

.cols-toolbar {
    position: absolute;
    /* 1. Aproxim√°mos a barra (estava -30px) */
    top: -25px; 
    right: 0;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    border-radius: 4px 4px 0 0; /* Cantos redondos s√≥ em cima */
    padding: 2px 8px;
    display: none; 
    z-index: 10;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    
    /* 2. Mant√©m a barra vis√≠vel se o rato estiver em cima dela */
    pointer-events: auto; 
}

/* 3. A PONTE M√ÅGICA: Cria uma √°rea invis√≠vel que liga a caixa √† barra */
.cols-toolbar::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 15px; /* Altura suficiente para preencher o espa√ßo */
    bottom: -10px; /* Estica para baixo em dire√ß√£o √† caixa */
    background: transparent; /* Invis√≠vel */
    z-index: -1;
}

/* Garante que a barra aparece no hover da caixa OU da pr√≥pria barra */
.journal-cols-wrapper:hover .cols-toolbar,
.cols-toolbar:hover {
    display: flex;
    align-items: center;
    gap: 5px;
}


/* ============================================================
   ESTILO: REDATOR (Glassmorphism & Dock)
   ============================================================ */
.redator-wrapper {
    position: relative;
    width: 100%; /* Adapta-se √† largura da nota */
    min-height: 150px;
    margin: 25px 0;
    
    /* Efeito de Vidro */
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    
    /* Bordas Finas */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    
    /* Sombra */
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.02);
    
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

.redator-wrapper:hover {
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 15px 50px -10px rgba(0,0,0,0.6), 0 0 15px rgba(255, 255, 255, 0.05);
    z-index: 10; /* Garante que a dock sobrep√µe o resto */
}

/* Cabe√ßalho */
.redator-header {
    padding: 12px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.redator-input {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.1em;
    font-weight: 500;
    width: 100%;
    outline: none;
    font-family: inherit;
}

.redator-input::placeholder {
    color: rgba(255, 255, 255, 0.2);
    font-style: italic;
}

/* Ferramentas de Topo (Discretas) */
.redator-top-tools {
    display: flex;
    gap: 10px;
    opacity: 0.3;
    transition: opacity 0.2s;
}
.redator-wrapper:hover .redator-top-tools { opacity: 1; }

.tool-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #fff;
    opacity: 0.7;
    padding: 2px;
    transition: transform 0.2s;
}
.tool-icon-btn:hover { opacity: 1; transform: scale(1.1); }

/* Conte√∫do */
.redator-content {
    padding: 20px;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.6;
    font-weight: 300;
    outline: none;
    min-height: 80px;
    white-space: pre-wrap;
}

/* --- DOCK INFERIOR (Bot√µes Especiais) --- */
.redator-dock {
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 5px;
    
    background: #1a1a1d; /* Cor do fundo do body para cortar a linha */
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 3px 6px;
    
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s;
    z-index: 20;
}

.redator-wrapper:hover .redator-dock {
    opacity: 1;
    pointer-events: auto;
    bottom: -22px;
}

.dock-btn {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.2s;
}

.dock-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

.dock-btn svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
}

.dock-sep {
    width: 1px;
    height: 16px;
    background: rgba(255, 255, 255, 0.1);
}

/* Tooltips */
.dock-btn::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    color: #000;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    border-radius: 4px;
    opacity: 0;
    pointer-events: none;
    white-space: nowrap;
    transition: opacity 0.2s;
}
.dock-btn:hover::after { opacity: 1; }

/* Contentor da Toolbar (Agora √© flex√≠vel para alinhar o bot√£o de menu √† direita) */
.redator-top-tools {
    display: flex;
    justify-content: flex-end; /* Encosta √† direita */
    align-items: center;
    position: relative; /* Necess√°rio para o menu absoluto funcionar */
    height: 30px;
}

/* O Bot√£o de Menu (Tr√™s Pontos) */
.redator-menu-trigger {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    font-size: 18px;
    cursor: pointer;
    padding: 0 5px;
    z-index: 20; /* Fica por cima do menu a deslizar */
    transition: color 0.2s;
}
.redator-menu-trigger:hover {
    color: #fff;
}

/* O Menu Deslizante (Escondido por defeito) */
.redator-slide-menu {
    position: absolute;
    top: 0;
    right: 30px; /* Come√ßa √† esquerda do bot√£o de menu */
    
    display: flex;
    gap: 5px;
    align-items: center;
    
    background: rgba(0, 0, 0, 0.6);
    border-radius: 20px; /* Forma de p√≠lula */
    padding: 4px 10px;
    
    /* Estado Inicial: Escondido e deslocado para a direita */
    opacity: 0;
    transform: translateX(20px);
    pointer-events: none; /* N√£o clic√°vel quando invis√≠vel */
    
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Estado Ativo: Vis√≠vel e na posi√ß√£o correta */
.redator-slide-menu.visible {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
}

/* Estilo dos bot√µes dentro do menu (pequenos e elegantes) */
.redator-slide-menu .tool-icon-btn {
    font-size: 14px;
    padding: 4px;
    color: rgba(255,255,255,0.8);
}
.redator-slide-menu .tool-icon-btn:hover {
    color: #fff;
    transform: scale(1.1);
}


/* --- ESTADO COLAPSADO DO CABE√áALHO --- */

/* Quando colapsado, o cabe√ßalho fica quase invis√≠vel (altura zero) */
.redator-header.collapsed {
    height: 0;
    padding: 0;
    border-bottom: none;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
}

/* O bot√£o de reabrir (pequeno √≠cone flutuante) */
.redator-reopen-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 14px;
    cursor: pointer;
    z-index: 15;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    opacity: 0;           /* Escondido por padr√£o */
    pointer-events: none; /* N√£o clic√°vel */
    transition: opacity 0.3s ease;
}

.redator-reopen-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

/* Mostra o bot√£o APENAS quando o cabe√ßalho est√° colapsado */
.redator-wrapper.header-hidden .redator-reopen-btn {
    opacity: 1;
    pointer-events: auto;
}

/* ============================================================
   JANELAS FLUTUANTES REDATOR (Multitarefa)
   ============================================================ */

/* A Janela Flutuante */
.redator-popup-window {
    position: fixed;
    top: 100px;
    left: 100px;
    width: 500px;
    height: 400px;
    
    /* Vidro Fosco Escuro */
    background: rgba(30, 30, 35, 0.95);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    border-radius: 12px;
    
    display: flex;
    flex-direction: column;
    z-index: 10000; /* Alto, mas permite sobreposi√ß√£o entre elas */
    transition: transform 0.1s, opacity 0.2s;
    resize: both; /* Permite redimensionar */
    overflow: hidden;
    min-width: 300px;
    min-height: 200px;
}

/* Cabe√ßalho de Arrasto */
.redator-popup-header {
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    cursor: grab; /* M√£ozinha */
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
}

.redator-popup-header:active {
    cursor: grabbing;
    background: rgba(255, 255, 255, 0.1);
}

.popup-title-label {
    font-size: 0.8em;
    font-weight: bold;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Bot√£o Fechar (Salvar) */
.btn-close-popup {
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 18px;
    padding: 0 5px;
}
.btn-close-popup:hover { color: #ff6b6b; }

/* Corpo da Janela */
.redator-popup-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 0;
    overflow: hidden;
}

/* Ajustes nos inputs clonados dentro da janela */
.redator-popup-window .redator-input {
    padding: 15px;
    font-size: 1.2em;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.redator-popup-window .redator-content {
    flex-grow: 1;
    overflow-y: auto; /* Scroll interno */
    padding: 15px;
}

/* --- ESTADO DO REDATOR ORIGINAL (Bloqueado) --- */
.redator-wrapper.in-popup-mode {
    opacity: 0.3;
    pointer-events: none; /* Impede cliques no original */
    filter: grayscale(1);
    border: 1px dashed rgba(255,255,255,0.3);
}

/* Aviso visual sobre o original */
.redator-wrapper.in-popup-mode::after {
    content: "Aberto em Janela ‚Üó";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    background: rgba(0,0,0,0.8);
    padding: 5px 10px;
    border-radius: 4px;
}

/* ============================================================
   ESTILOS DAS ABAS DO PAINEL DO MEIO (BOTTOM TABS)
   ============================================================ */

/* Garante que o painel do meio usa todo o espa√ßo vertical corretamente */
#middle-panel {
    display: flex;
    flex-direction: column;
    padding-bottom: 0 !important; /* Remove padding do fundo para a barra colar */
    overflow: hidden; /* Impede scroll no painel principal */
}

/* Contentor das Vistas (Onde as listas aparecem) */
#middle-views-container {
    flex: 1; /* Ocupa todo o espa√ßo dispon√≠vel */
    overflow-y: auto; /* Scroll acontece AQUI */
    position: relative;
    padding-bottom: 10px;
    /* Scrollbar fina */
    scrollbar-width: thin;
}

/* Esconde scrollbar horizontal */
#middle-views-container::-webkit-scrollbar { width: 6px; }
#middle-views-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

/* Barra de Abas no Fundo */
.middle-bottom-tabs {
    display: none; /* Controlado pelo JS */
    height: 50px !important; /* Altura fixa e igual √† esquerda */
    
    background-color: var(--sidebar-color);
    border-top: 1px solid var(--border-color);
    
    /* ALTERA√á√ÉO CR√çTICA AQUI: */
    /* Margem negativa apenas nos lados (-20px), zero em baixo */
    margin: 0 -20px 0 -20px !important; 
    
    padding: 0;
    flex-shrink: 0;
    z-index: 10;
    box-sizing: border-box;
}

/* Ajuste dos bot√µes para caberem na nova altura */
.middle-bottom-tabs button {
    flex: 1;
    height: 100%;
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 0;
    font-size: 10px;
    text-transform: uppercase;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px; /* Gap menor */
    border-top: 2px solid transparent; /* Linha de topo mais fina */
}

.middle-bottom-tabs button span {
    font-size: 16px;
    font-family: 'Material Icons', sans-serif; /* Se usar icons de fonte */
}

.middle-bottom-tabs button:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.middle-bottom-tabs button.active {
    color: var(--accent-color);
    border-top-color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.05);
}

/* --- ESTILOS DO √çNDICE E FONTES --- */

.middle-view {
    list-style: none;
    padding: 0;
    margin: 0;
}

.empty-msg {
    text-align: center;
    color: var(--text-muted-color);
    padding: 30px 10px;
    font-style: italic;
    font-size: 0.9em;
}

/* Item do √çndice */
.index-item {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}

.index-item:hover {
    background-color: var(--hover-color);
    padding-left: 15px; /* Efeito de movimento */
}

.index-icon {
    font-size: 1.2em;
    min-width: 20px;
    text-align: center;
}

/* Cores dos tipos no √≠ndice */
.idx-question .index-icon { color: #2ecc71; }
.idx-subnote .index-icon { color: #3498db; }
.idx-redator .index-icon { color: #9b59b6; }
.idx-free .index-icon { color: #e67e22; }
.idx-card .index-icon { color: #795548; }

/* Item das Fontes (Lista Hier√°rquica) */
.source-group {
    margin-bottom: 15px;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
}

.source-header {
    font-weight: bold;
    color: var(--text-color);
    padding: 5px 10px;
    background: rgba(255,255,255,0.03);
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}
.source-header:hover { background: var(--hover-color); }

.source-links {
    padding-left: 25px;
    margin-top: 5px;
}

.source-link-item {
    display: flex;
    gap: 6px;
    font-size: 0.8em;
    padding: 3px 0;
    color: var(--accent-color);
    cursor: pointer;
    word-break: break-all;
}
.source-link-item:hover { text-decoration: underline; }

.source-codex-item {
    display: block;
    font-size: 0.8em;
    padding: 3px 0;
    color: #e67e22; /* Laranja Codex */
}

/* Bot√£o de Vistas Mobile */
@media (max-width: 768px) {
    #mobile-views-btn {
        display: block !important;
    }
    
    /* Ajuste para as abas dentro do modal */
    #mobile-views-modal .middle-bottom-tabs button {
        font-size: 11px;
        padding: 8px 0;
    }
    
    /* Garante que o conte√∫do copiado (listas) fica bonito no modal */
    #mobile-views-content .list-item, 
    #mobile-views-content .index-item {
        background-color: var(--panel-color);
        margin-bottom: 5px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }
}

/* ============================================================
   CORRE√á√ÉO: ESCONDER ABAS DA LISTA NO MOBILE
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Esconde a barra de abas APENAS no painel do meio (lista) */
    #middle-panel .middle-bottom-tabs {
        display: none !important;
    }

    /* 2. Garante que dentro do Popup (‚õ∂) elas continuam vis√≠veis */
    #mobile-views-modal .middle-bottom-tabs {
        display: flex !important;
    }

    /* 3. Remove o padding extra que servia para dar espa√ßo √†s abas */
    #middle-views-container {
        padding-bottom: 0 !important;
    }
}

/* ============================================================
   CORRE√á√ÉO DE BARRAS DE FUNDO (TABLET/MOBILE HORIZONTAL)
   ============================================================ */

/* 1. Mudar a altura para Din√¢mica (dvh) */
/* Isto faz com que a app se ajuste automaticamente quando as barras do navegador aparecem/desaparecem */
body, .notebook-container {
    height: 100vh; /* Fallback para browsers antigos */
    height: 100dvh !important; /* O SEGREDO: Altura real vis√≠vel */
    overflow: hidden !important;
}

/* 2. For√ßar a estrutura Flex Vertical R√≠gida */
/* Garante que o painel √© uma coluna que ocupa 100% e n√£o deixa transbordar */
#left-panel, #middle-panel {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    max-height: 100dvh !important;
    overflow: hidden !important;
    justify-content: space-between !important;
    padding-bottom: 0 !important; /* Removemos padding do fundo para a barra colar */
}

/* 3. Conte√∫do com Scroll (Listas) */
/* As listas devem ocupar o espa√ßo que sobra (flex: 1) e encolher se necess√°rio (min-height: 0) */
.panel-content, 
#middle-views-container {
    flex: 1 !important;
    overflow-y: auto !important;
    min-height: 0 !important; /* CR√çTICO: Permite que a lista encolha para dar espa√ßo ao rodap√© */
}

/* 4. Fixar os Rodap√©s (Settings e Pastas/√çndice) */
/* flex-shrink: 0 impede que sejam esmagados */
.panel-footer,
.middle-bottom-tabs {
    flex-shrink: 0 !important;
    z-index: 50 !important;
    background-color: var(--sidebar-color); /* Garante que o fundo n√£o √© transparente */
    position: relative !important;
    bottom: 0 !important;
    margin-bottom: 0 !important;
}

/* Corre√ß√£o espec√≠fica para a margem negativa do painel do meio */
.middle-bottom-tabs {
    margin: 0 -20px 0 -20px !important; /* Mant√©m largura total, mas zera margem de baixo */
}

/* Corre√ß√£o espec√≠fica para o rodap√© da esquerda */
#left-panel .panel-footer {
    margin: 0 -15px 0 -15px !important; /* Mant√©m largura total, zera margem de baixo */
    padding-bottom: env(safe-area-inset-bottom, 10px) !important; /* Respeita a barra de gestos do tablet */
}


/* ============================================================
   ANIMA√á√ÉO "SOFT FLASH SNAP" (R√°pida, Impactante, Luz Suave)
   ============================================================ */

@keyframes redatorFlashSnap {
    0% {
        opacity: 0;
        transform: scale(0.92) translateY(10px);
        /* Brilho inicial concentrado (Branco Suave) */
        background-color: rgba(255, 255, 255, 0.4); 
        box-shadow: 0 0 0 rgba(255, 255, 255, 0);
    }
    40% {
        opacity: 1;
        /* Ligeiro exagero no tamanho para o impacto (Snap) */
        transform: scale(1.02) translateY(0);
        
        /* A "Onda de Luz": Brilho difuso e elegante */
        background-color: rgba(255, 255, 255, 0.15); 
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 50px rgba(200, 220, 255, 0.25), inset 0 0 20px rgba(255, 255, 255, 0.1);
    }
    100% {
        transform: scale(1);
        /* Estabiliza no Vidro Escuro Padr√£o */
        background-color: rgba(255, 255, 255, 0.02);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.02);
    }
}

.redator-spawn-effect {
    /* 0.4s √© muito r√°pido. O bezier faz o movimento "bater" e travar. */
    animation: redatorFlashSnap 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.2) forwards;
    will-change: transform, opacity, box-shadow, background-color;
}

/* ============================================================
   CORRE√á√ÉO REDATOR MOBILE (Auto-Collapse)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar o colapso agressivo no Mobile */
    /* Garante que o cabe√ßalho desaparece mesmo com outros estilos mobile */
    .redator-header.collapsed {
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        opacity: 0 !important;
        border: none !important;
        pointer-events: none !important;
    }

    /* 2. Bot√£o "T" Amig√°vel para o Dedo */
    /* Aumenta a √°rea de toque para ser f√°cil reabrir */
    .redator-reopen-btn {
        width: 36px !important;
        height: 36px !important;
        top: 8px !important;
        left: 8px !important;
        
        font-size: 16px !important;
        font-weight: bold !important;
        
        /* Fundo mais vis√≠vel para se destacar no ecr√£ pequeno */
        background-color: rgba(255, 255, 255, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        
        z-index: 50 !important; /* Garante que fica por cima de tudo */
    }
}

/* ============================================================
   CORRE√á√ÉO DA DOCK DO REDATOR (MOBILE/TABLET)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßar a Dock a estar SEMPRE VIS√çVEL no Mobile */
    /* No PC s√≥ aparece no hover, no mobile precisamos dela sempre */
    .redator-wrapper .redator-dock {
        opacity: 1 !important;
        pointer-events: auto !important;
        bottom: -22px !important; /* Posi√ß√£o fixa */
        
        /* Aumentar o fundo para ser mais f√°cil de ver/tocar */
        padding: 5px 10px !important;
        background-color: var(--panel-color) !important;
        border: 1px solid var(--accent-color) !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5) !important;
    }

    /* 2. Bot√µes Maiores (√Årea de Toque) */
    .dock-btn {
        width: 40px !important;  /* Aumentado de 32px */
        height: 40px !important;
    }
    
    /* √çcones maiores */
    .dock-btn svg {
        width: 20px !important;
        height: 20px !important;
    }

    /* 3. Separador Ajustado */
    .dock-sep {
        height: 20px !important;
        margin: 0 5px !important;
    }
    
    /* 4. Esconder Tooltips no Mobile (atrapalham) */
    .dock-btn::after {
        display: none !important;
    }
}

/* Transi√ß√£o mais lenta (0.6s) para um efeito de "respira√ß√£o" suave */
.redator-wrapper {
    transition: border-color 0.6s ease, box-shadow 0.6s ease;
}

/* O estado ativo enquanto escreve */
.redator-wrapper.typing-border-glow {
    /* A borda fica apenas um pouco mais clara, n√£o branca total */
    border-color: rgba(255, 255, 255, 0.35) !important;
    
    /* O brilho √© muito difuso e com pouca opacidade (apenas 10%) */
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.1) !important;
}

/* Destaque do item ativo no √çndice */
.index-item.active-scroll {
    background-color: rgba(74, 144, 226, 0.15) !important; /* Fundo azul suave */
    border-left: 4px solid var(--accent-color) !important; /* Borda azul forte */
    color: var(--text-color) !important;
    font-weight: bold;
    transition: all 0.2s ease;
}


/* Item da Lista de √Çncoras */
.anchor-item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s;
}

.anchor-item-row:hover {
    background-color: var(--hover-color);
}

/* Estado Selecionado (Visualmente Assinalado) */
.anchor-item-row.selected {
    background-color: rgba(74, 144, 226, 0.15); /* Fundo azul suave */
    border-left: 4px solid var(--accent-color);
}

.anchor-item-row.selected .anchor-name {
    color: var(--accent-color);
    font-weight: bold;
}

/* Check visual */
.anchor-check-icon {
    display: none;
    color: var(--accent-color);
    font-weight: bold;
}

.anchor-item-row.selected .anchor-check-icon {
    display: block;
}

/* Estilo para item da lista de √¢ncoras */
.anchor-select-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s;
}

.anchor-select-item:hover {
    background-color: var(--hover-color);
}

/* Estilo Selecionado (Verde) */
.anchor-select-item.selected {
    background-color: rgba(46, 204, 113, 0.15); /* Fundo verde suave */
    border-left: 4px solid #2ecc71;
    color: #2ecc71;
    font-weight: bold;
}

.anchor-check {
    display: none;
    font-size: 1.2em;
}

.anchor-select-item.selected .anchor-check {
    display: block;
}

/* Bot√£o Editar na lista de √Çncoras */
.anchor-edit-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 16px;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 5px;
    display: none; /* Escondido por padr√£o */
}

.anchor-edit-btn:hover {
    color: var(--text-color);
    background-color: rgba(255, 255, 255, 0.1);
}

/* Mostra o bot√£o apenas quando o rato passa por cima da linha */
.anchor-item-row:hover .anchor-edit-btn {
    display: block;
}

/* Item da Lista de √Çncoras */
.anchor-select-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s;
    position: relative; /* Necess√°rio para posicionamento */
}

.anchor-select-item:hover {
    background-color: var(--hover-color);
}

/* Bot√£o Editar (L√°pis) - S√≥ aparece ao passar o rato (no PC) ou sempre (no layout flex) */
.anchor-item-edit-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 16px;
    padding: 8px;
    margin-right: 5px;
    border-radius: 4px;
    transition: color 0.2s, background 0.2s;
    z-index: 10; /* Fica acima do clique da linha */
}

.anchor-item-edit-btn:hover {
    color: var(--text-color);
    background-color: rgba(255, 255, 255, 0.1);
}

/* √Årea de texto cresce para empurrar os bot√µes */
.anchor-info-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}


/* Painel de Sincroniza√ß√£o (Overlay sobre o Editor) */
#editor-sync-overlay {
    display: none; /* Escondido por defeito */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(26, 26, 29, 0.85); /* Fundo escuro semi-transparente */
    z-index: 5000; /* Acima do texto */
    justify-content: center;
    align-items: center;
    flex-direction: column;
    backdrop-filter: blur(2px);
    transition: opacity 0.3s ease;
}

#editor-sync-overlay.visible {
    display: flex;
}

.sync-message {
    background-color: var(--panel-color);
    padding: 15px 25px;
    border-radius: 8px;
    border: 1px solid var(--accent-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    gap: 15px;
    color: var(--text-color);
    font-weight: 500;
}

/* ============================================================
   ESTILOS DO DEP√ìSITO DE REFER√äNCIAS (DESIGN PREMIUM) üèóÔ∏è
   ============================================================ */

/* 1. O Contentor Principal */
.ref-depot-wrapper {
    background: linear-gradient(180deg, #202023 0%, #1a1a1d 100%);
    border: 1px solid #333;
    border-top: 4px solid #f39c12; /* Laranja Constru√ß√£o */
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* 2. Cabe√ßalho do Dep√≥sito */
.depot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(243, 156, 18, 0.2);
}

.depot-title {
    background: transparent;
    border: none;
    color: #f39c12;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 1.1em;
    letter-spacing: 1.5px;
    width: 100%;
    outline: none;
}
.depot-title::placeholder { opacity: 0.4; color: #f39c12; }

/* 3. Bot√µes de A√ß√£o (Estilo P√≠lula) */
.depot-btn {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-muted-color);
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    margin-left: 6px;
    transition: all 0.2s ease;
}
.depot-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
.btn-del-node:hover { color: #e74c3c; border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

/* ============================================================
   4. ESTILO ZEBRADO DAS PASTAS (CATEGORIAS)
   ============================================================ */

.depot-category {
    margin-bottom: 10px;
    border-radius: 6px;
    padding: 10px;
    transition: background-color 0.2s;
    border-left: 4px solid transparent;
}

/* --- PASTA √çMPAR (Laranja - Tema Constru√ß√£o) --- */
.depot-category:nth-of-type(odd) {
    background-color: rgba(243, 156, 18, 0.04); 
    border-left-color: #f39c12;
    border-top: 1px solid rgba(243, 156, 18, 0.05);
}
/* Linha da √°rvore √çmpar */
.depot-category:nth-of-type(odd) .depot-tree-line {
    border-left: 1px dashed rgba(243, 156, 18, 0.3) !important;
}

/* --- PASTA PAR (Azul - Tema Tecnologia) --- */
.depot-category:nth-of-type(even) {
    background-color: rgba(52, 152, 219, 0.04);
    border-left-color: #3498db;
    border-top: 1px solid rgba(52, 152, 219, 0.05);
}
/* Linha da √°rvore Par */
.depot-category:nth-of-type(even) .depot-tree-line {
    border-left: 1px dashed rgba(52, 152, 219, 0.3) !important;
}

/* Hover na Pasta */
.depot-category:hover {
    background-color: rgba(255, 255, 255, 0.06);
}

/* T√≠tulo da Categoria */
.depot-input-title {
    background: transparent;
    border: none;
    border-bottom: 1px dashed transparent;
    color: #e0e0e0;
    padding: 4px 0;
    width: 200px;
    flex-grow: 1;
    font-weight: 700;
    font-size: 1.05em;
    outline: none;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 10px;
}
.depot-input-title:focus { border-bottom-color: var(--accent-color); }

/* 5. Subt√≠tulos (Dentro das Pastas) */
.depot-subtitle {
    margin-top: 5px;
}
.depot-subtitle .depot-input-title {
    font-size: 0.9em;
    font-weight: 500;
    color: #aab7c4; /* Cinza azulado */
    text-transform: none;
}

/* Linha da √Årvore (Margens) */
.depot-tree-line {
    margin-left: 9px;
    padding-left: 15px;
    padding-top: 5px;
    padding-bottom: 5px;
}

/* √çcone de Expandir/Recolher */
.depot-toggle-icon {
    display: inline-block;
    cursor: pointer;
    transition: transform 0.2s;
    user-select: none;
    width: 20px; 
    text-align: center; 
    
    /* AQUI EST√Å A MUDAN√áA DO ESPA√áAMENTO: */
    margin-right: 15px !important; /* Aumentado para separar do texto */
    
    opacity: 0.8;
}

.is-collapsed > div > .depot-toggle-icon {
    transform: rotate(-90deg); opacity: 0.5;
}
.is-collapsed > .depot-tree-line { display: none !important; }

/* ============================================================
   6. CART√ÉO DE LINK (LAYOUT DE DUAS LINHAS)
   ============================================================ */

.depot-link-card {
    /* Estrutura Base */
    background-color: rgba(40, 40, 45, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 8px 10px;
    margin-bottom: 6px;
    position: relative;
    
    /* Layout Vertical (Empilhado) */
    display: flex;
    flex-direction: column;
    gap: 4px; /* Espa√ßo entre Descri√ß√£o e URL */
    
    transition: all 0.2s ease;
}

/* Cores Zebradas (Mant√™m-se para ajudar a distinguir) */
.depot-link-card:nth-of-type(odd) {
    border-left: 3px solid #3498db;
    background-color: rgba(52, 152, 219, 0.04);
}
.depot-link-card:nth-of-type(even) {
    border-left: 3px solid #f39c12;
    background-color: rgba(243, 156, 18, 0.04);
}

.depot-link-card:hover {
    background-color: rgba(60, 60, 65, 0.8) !important;
    border-left-width: 5px;
    transform: translateX(2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* --- LINHA 1: DESCRI√á√ÉO --- */
.depot-desc {
    background: transparent;
    border: none;
    color: var(--text-color); /* Texto normal */
    font-weight: 600;
    font-size: 0.9em;
    width: 90%; /* Deixa espa√ßo para o X */
    outline: none;
    padding: 0;
}
.depot-desc::placeholder { 
    font-weight: normal; 
    color: rgba(255,255,255,0.2); 
    font-style: italic;
}

/* --- LINHA 2: URL + BOT√ÉO --- */
.depot-url-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.depot-url {
    background: transparent;
    border: none;
    font-family: 'Consolas', monospace;
    font-size: 0.8em;
    color: var(--accent-color); /* Azul link */
    flex-grow: 1; /* Ocupa o espa√ßo todo */
    outline: none;
    padding: 0;
    opacity: 0.8;
}
.depot-url:focus { opacity: 1; color: #fff; }
.depot-url::placeholder { color: rgba(74, 144, 226, 0.3); }

/* Bot√£o Visitar [‚Üó] */
.depot-visit-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-muted-color);
    border-radius: 4px;
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}
.depot-visit-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Bot√£o Fechar (X) */
.depot-del-card {
    position: absolute;
    top: 6px; 
    right: 6px;
    
    background: none; border: none;
    color: #e74c3c;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    line-height: 1;
    opacity: 0; /* Invis√≠vel at√© passar o rato */
    transition: opacity 0.2s;
    padding: 2px;
}
.depot-link-card:hover .depot-del-card { opacity: 0.7; }
.depot-del-card:hover { opacity: 1 !important; transform: scale(1.2); }

/* ============================================================
   CABE√áALHOS FIXOS (STICKY HEADERS)
   ============================================================ */

/* Aplica √† barra de t√≠tulo da Categoria (üìÇ) e do Subt√≠tulo (üîπ) */
.depot-category > div:first-child,
.depot-subtitle > div:first-child {
    position: sticky;
    position: -webkit-sticky; /* Para Safari */
    top: 0;
    
    z-index: 10; /* Garante que fica por cima dos links */
    
    /* Fundo opaco para os links n√£o aparecerem por tr√°s do texto */
    background-color: #1a1a1d; /* Mesma cor de fundo do seu tema */
    
    /* Pequeno ajuste visual */
    padding: 8px 0;
    margin-bottom: 5px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* Linha subtil para separar */
}

/* Opcional: Faz o mesmo para o cabe√ßalho principal do Dep√≥sito (üèóÔ∏è) */
.depot-header {
    position: sticky;
    position: -webkit-sticky;
    top: 0;
    z-index: 20; /* Fica acima das categorias */
    background-color: #1a1a1d;
    padding-top: 10px; /* Compensar margem */
}


/* ============================================================
   ESTILOS DO AQU√ÅRIO (AMBIENTE ISOLADO)
   ============================================================ */
#aquarium-environment {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10000; /* Acima da interface normal, abaixo dos modais de sistema */
    background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%); /* Fundo "Fundo do Mar" */
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Barra de Topo (Estilo Windows/Mac) */
#aquarium-bar {
    height: 50px;
    background-color: rgba(0, 0, 0, 0.5);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    flex-shrink: 0;
    backdrop-filter: blur(5px);
}

#aquarium-title-display {
    color: white;
    font-size: 1.1em;
    font-weight: 500;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Bot√£o Sair */
#aquarium-exit-btn {
    background: rgba(231, 76, 60, 0.2);
    border: 1px solid #e74c3c;
    color: #e74c3c;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
#aquarium-exit-btn:hover {
    background: #e74c3c;
    color: white;
}

/* √Årea de Trabalho Infinita */
#aquarium-desktop {
    flex-grow: 1;
    position: relative;
    overflow: hidden; /* O conte√∫do ser√° arrast√°vel, n√£o scrol√°vel */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Atualiza√ß√£o da Barra */
#aquarium-bar {
    height: 60px;
    background-color: rgba(30, 30, 35, 0.95);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between; /* Espalha os grupos */
    padding: 0 20px;
    flex-shrink: 0;
    z-index: 20000;
}

/* Grupos */
.aquarium-nav-group, 
.aquarium-tools-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.aquarium-title-group {
    /* Mant√©m alinhado √† direita, mas for√ßa um espa√ßo de seguran√ßa */
    justify-content: flex-end !important;
    
    /* AQUI EST√Å A CORRE√á√ÉO: Afasta 60px da borda direita */
    padding-right: 60px !important; 
    
    /* Impede que o t√≠tulo empurre a barra para fora do ecr√£ */
    min-width: 0; 
    overflow: hidden;
}

/* 2. Texto do T√≠tulo */
#aquarium-title-display {
    /* Se o t√≠tulo for gigante, p√µe "..." em vez de cortar feio */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 100%;
    
    /* Alinha o texto √† direita dentro do seu espa√ßo */
    text-align: right;
}

/* 3. Caixa de Edi√ß√£o (Input) */
/* Garante que quando clica para editar, a caixa de texto tamb√©m respeita a margem */
.aquarium-header-input {
    margin-right: 60px !important;
}

/* Bot√µes do Aqu√°rio */
#aquarium-bar button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-color);
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

#aquarium-bar button:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* POPUP DE NAVEGA√á√ÉO R√ÅPIDA */
#aquarium-jump-popup {
    position: absolute;
    top: 65px; /* Logo abaixo da barra */
    left: 80px; /* Perto do bot√£o */
    width: 300px;
    background: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    padding: 10px;
    z-index: 30000;
}

#aquarium-jump-search {
    width: 100%;
    padding: 10px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: white;
    margin-bottom: 10px;
}

#aquarium-jump-list {
    list-style: none;
    max-height: 300px;
    overflow-y: auto;
}

#aquarium-jump-list li {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex; 
    align-items: center;
    gap: 8px;
}

#aquarium-jump-list li:hover {
    background-color: var(--hover-color);
    color: var(--accent-color);
}

/* Barra de Ferramentas (Secund√°ria) */
#aquarium-toolbar {
    height: 50px;
    background-color: rgba(40, 40, 45, 0.9); /* Um pouco mais clara que a de cima */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 15px;
    flex-shrink: 0;
    overflow-x: auto; /* Permite scroll se o ecr√£ for pequeno */
}

/* Grupos */
.aq-tool-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Bot√µes */
#aquarium-toolbar button {
    background: transparent;
    border: 1px solid transparent;
    color: #ccc;
    min-width: 32px;
    height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
}

#aquarium-toolbar button:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
}

/* Bot√µes Especiais (B Azul / I Dots) */
.btn-blue-b { color: #4a90e2 !important; font-weight: bold; position: relative; padding-right: 12px; }
.btn-italic { position: relative; padding-right: 12px; }
.dots { font-size: 10px; margin-left: 2px; opacity: 0.7; }

/* Separador Vertical */
.aq-sep {
    width: 1px;
    height: 25px;
    background: rgba(255, 255, 255, 0.1);
}

/* Inputs e Selects */
#aquarium-toolbar select {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    padding: 4px;
    border-radius: 4px;
    height: 30px;
    outline: none;
}

/* √Årea de Scroll */
#aquarium-scroll-area {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 40px;
    display: flex;
    justify-content: center;
}

/* O "Papel" Infinito (Canvas) */
#aquarium-content-canvas {
    width: 100%;
    max-width: 900px; 
    min-height: 80vh;
    padding-bottom: 50vh !important; 
    pointer-events: auto !important;
    
    /* ADICIONE ESTA LINHA PARA O CRESCIMENTO SER SUAVE */
    transition: min-height 0.3s ease-out; 
    
    cursor: text; 
}

/* O BLOCO FANTASMA üëª */
.ghost-block {
    position: relative;
    width: 100%;
  min-height: 44px;
    margin-bottom: 10px;
    padding: 10px 15px;
    
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.1em;
    line-height: 1.6;
    outline: none; /* Remove o contorno azul feio do browser */
    
    /* O Efeito Fantasma */
    background: transparent;
    border: 1px solid transparent; /* Invis√≠vel por padr√£o */
    border-radius: 8px;
    transition: all 0.2s ease;
}

/* Quando focado ou com o rato em cima */
.ghost-block:hover {
    background: rgba(255, 255, 255, 0.02); /* Sombra ultra leve */
}

.ghost-block:focus {
    background: rgba(255, 255, 255, 0.05); /* Fundo ligeiramente vis√≠vel */
    border-color: rgba(255, 255, 255, 0.1); /* Borda subtil */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Sombra para destacar */
}

/* Placeholder */
.ghost-block:empty::before,
.ghost-block:has(.ghost-actions:only-child)::before {
    content: attr(data-placeholder);
    color: rgba(255, 255, 255, 0.3);
    pointer-events: none; /* Deixa o clique passar para o texto */
    position: absolute;   /* Garante que fica no topo/esquerda */
    top: 10px;
    left: 15px;
}

#semantic-type-popup {
    position: fixed;
    z-index: 30000;
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 6px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    width: 150px;
}

.semantic-header {
    font-size: 0.75em;
    color: var(--text-muted-color);
    padding: 5px 10px;
    text-transform: uppercase;
    font-weight: bold;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 5px;
}

#semantic-type-popup button {
    background: none;
    border: none;
    color: var(--text-color);
    text-align: left;
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9em;
    transition: background 0.2s;
}

#semantic-type-popup button:hover {
    background-color: var(--hover-color);
}

/* Indica qual est√° ativo atualmente */
#semantic-type-popup button.active {
    background-color: rgba(74, 144, 226, 0.15) !important; /* Fundo azul suave */
    color: var(--accent-color) !important; /* Texto azul */
    font-weight: bold !important;
    border-left: 3px solid var(--accent-color) !important; /* Linha indicadora */
    padding-left: 8px !important; /* Ajuste para a borda */
}
#semantic-type-popup button.active::after {
    content: '‚úì';
    float: right;
}

/* √çcone espec√≠fico para o tipo Aqu√°rio */
.list-item[data-type="aquario"]:before { 
    content: 'ü™∏'; 
    font-size: 18px;
    margin-right: 10px;
}


/* ============================================================
   CORRE√á√ÉO VISUAL DO AQU√ÅRIO
   ============================================================ */

/* 1. BLINDAGEM CONTRA DESALINHAMENTO */
/* Quando um fantasma ganha a classe de wrapper, ignoramos as margens antigas */
.ghost-block.mini-note-wrapper {
    margin: 0 0 10px 0 !important;      /* Mant√©m a margem vertical simples */
    width: 100% !important;             /* Mant√©m a largura total */
    box-sizing: border-box !important;  /* Garante que o padding n√£o aumenta a largura */
    background-color: transparent;      /* Remove fundos indesejados */
    border: 1px solid transparent;      /* Prepara a borda para n√£o saltar */
}

/* 1. REGRA SUPREMA: MATA A BORDA DE CIMA EM TODAS AS SITUA√á√ïES */
/* Aplica-se ao estado normal, focado, selecionado ou quando a ferramenta √© clicada (.mini-note-wrapper) */
.ghost-block,
.ghost-block:focus,
.ghost-block.active-selection,
.ghost-block.mini-note-wrapper,
.ghost-block.mini-note-wrapper.active-selection {
    border-top: 0 !important;
    border-top-width: 0 !important;
    border-top-style: none !important;
    border-top-color: transparent !important;
    
    /* Remove outline padr√£o do browser */
    outline: none !important;
    box-shadow: none !important;
    
    /* Garante alinhamento */
    margin: 0 0 10px 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 2. ESTILO DE SELE√á√ÉO (Apenas linha Esquerda) */
.ghost-block:focus,
.ghost-block.active-selection {
    background-color: rgba(255, 255, 255, 0.04) !important;
    border-left: 3px solid var(--accent-color) !important;
    border-right: none !important;
    border-bottom: none !important;
}

/* 3. EXCE√á√ïES SEM√ÇNTICAS (S√ì ESTES PODEM TER LINHA NO TOPO) */
/* Usamos seletores fortes para vencer a Regra 1 apenas nestes casos */

/* T√≠tulo H1 (Verde) */
.ghost-block[data-semantic="h1"],
.ghost-block[data-semantic="h1"].active-selection,
.ghost-block[data-semantic="h1"].mini-note-wrapper {
    border-top: 3px solid #2ecc71 !important;
    padding-top: 15px !important;
    font-size: 1.6em;
    font-weight: bold;
}

/* T√≠tulo H2 (Laranja) */
.ghost-block[data-semantic="h2"],
.ghost-block[data-semantic="h2"].active-selection,
.ghost-block[data-semantic="h2"].mini-note-wrapper {
    border-top: 3px solid #e67e22 !important;
    padding-top: 15px !important;
    font-size: 1.3em;
    font-weight: bold;
}

/* Nota (Vermelho Tracejado) */
.ghost-block[data-semantic="note"],
.ghost-block[data-semantic="note"].active-selection,
.ghost-block[data-semantic="note"].mini-note-wrapper {
    border-top: 2px dashed #e74c3c !important;
    background-color: rgba(231, 76, 60, 0.05) !important;
    font-style: italic;
    color: #e6b0aa;
    font-size: 0.9em;
}

/* Subpar√°grafo (Apenas recuo, SEM borda) */
.ghost-block[data-semantic="sub"] {
    margin-left: 30px !important;
    border-top: none !important; /* Refor√ßo */
    font-size: 0.95em;
    opacity: 0.9;
}

/* 5. Par√°grafo Normal (P) - Limpo */
.ghost-block[data-semantic="p"] {
    border-top: none !important;
}


/* ============================================================
   CORRE√á√ÉO NUCLEAR DA BORDA AZUL (AQU√ÅRIO)
   ============================================================ */

/* Aplica-se a qualquer bloco fantasma, independentemente de outras classes */
div#aquarium-content-canvas .ghost-block {
    border-top-color: transparent !important;
    border-top-style: none !important;
    border-top-width: 0 !important;
    outline: none !important;
    box-shadow: none !important;
}

/* Restaura apenas as exce√ß√µes sem√¢nticas que queremos */
div#aquarium-content-canvas .ghost-block[data-semantic="h1"] {
    border-top: 3px solid #2ecc71 !important;
}
div#aquarium-content-canvas .ghost-block[data-semantic="h2"] {
    border-top: 3px solid #e67e22 !important;
}
div#aquarium-content-canvas .ghost-block[data-semantic="note"] {
    border-top: 2px dashed #e74c3c !important;
}

/* Garante que o Subpar√°grafo e Normal N√ÉO t√™m borda, mesmo selecionados */
div#aquarium-content-canvas .ghost-block[data-semantic="sub"],
div#aquarium-content-canvas .ghost-block[data-semantic="p"],
div#aquarium-content-canvas .ghost-block:not([data-semantic]) {
    border-top: none !important;
}

/* Se por acaso a classe .mini-note-wrapper estiver a adicionar pseudo-elementos (::before) */
.ghost-block.mini-note-wrapper::before {
    display: none !important;
    content: none !important;
    height: 0 !important;
    width: 0 !important;
    background: transparent !important;
}

/* ============================================================
   AQU√ÅRIO: SIDEBAR MEDUSA (ü™º)
   ============================================================ */
#aquarium-sidebar {
    position: absolute; 
    
    /* CORRE√á√ÉO AQUI: 60px (Barra Topo) + 50px (Toolbar B/I/U) = 110px */
    top: 110px !important;          
    
    left: 0;
    bottom: 0; /* Vai at√© ao fundo do ecr√£ */
    width: 0;
    
    /* Visual de Vidro Escuro */
    background-color: rgba(20, 20, 23, 0.95);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    
    /* Z-Index ajustado para n√£o tapar modais, mas ficar acima do texto */
    z-index: 500; 
    
    display: flex;
    flex-direction: column;
}

/* Quando aberto */
#aquarium-environment.sidebar-open #aquarium-sidebar {
    width: 360px !important; /* Aumentado de 300px para 360px */
}

/* 2. AJUSTAR OS BOT√ïES DAS ABAS */
.aq-tab {
    background: none;
    border: none;
    color: #888;
    
    /* MUDAN√áA: Padding menor nos lados, mas flex: 1 para ocupar espa√ßo igual */
    padding: 12px 0; 
    flex: 1;         /* Faz com que os 6 √≠cones dividam a largura exata */
    text-align: center;
    
    font-size: 18px;
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    line-height: 1;
}

/* Garante que o container n√£o tem scroll */
.aq-tabs-header {
    display: flex;
    width: 100%;       /* Garante largura total */
    overflow-x: hidden; /* Remove scroll horizontal */
    background: rgba(0,0,0,0.3);
    flex-shrink: 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.aq-tabs-header::-webkit-scrollbar { display: none; }

.aq-tab {
    background: none;
    border: none;
    color: #888;
    padding: 12px 15px; /* Espa√ßamento confort√°vel */
    cursor: pointer;
    
    /* AUMENTADO DE 13px PARA 18px PARA OS √çCONES FICAREM BONS */
    font-size: 18px; 
    
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    line-height: 1; /* Garante alinhamento vertical */
}

.aq-tab:hover { 
    color: #fff; 
    background: rgba(255,255,255,0.05); 
}

.aq-tab.active { 
    color: var(--accent-color); 
    border-bottom-color: var(--accent-color); 
}

#aq-sidebar-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0;
}

/* Listas internas */
#aq-sidebar-content ul { list-style: none; padding: 0; margin: 0; }
#aq-sidebar-content li {
    padding: 10px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    font-size: 0.9em;
    color: #e0e0e0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#aq-sidebar-content li:hover { background-color: rgba(255,255,255,0.05); }

/* Card do √çndice */
.aq-index-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 6px;
    margin: 8px 10px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.aq-index-card:hover {
    border-color: var(--accent-color);
    background: rgba(255,255,255,0.06);
}
.aq-card-title {
    font-weight: bold;
    color: var(--accent-color);
    font-size: 0.85em;
    display: block;
    margin-bottom: 3px;
}
.aq-card-preview {
    font-size: 0.8em;
    color: #888;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ============================================================
   AQU√ÅRIO: NAVEGA√á√ÉO DA ABA üß≠
   ============================================================ */
.aq-nav-header {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 5px;
}

.aq-nav-back-btn {
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 18px;
    cursor: pointer;
    margin-right: 10px;
    padding: 0;
}

.aq-nav-title {
    font-weight: bold;
    color: #fff;
    font-size: 0.95em;
}

/* Estilo para Grelhas (Cap√≠tulos/Vers√≠culos na B√≠blia) */
.aq-grid-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* 5 por linha */
    gap: 5px;
    padding: 10px;
}

.aq-grid-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: #e0e0e0;
    text-align: center;
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}
.aq-grid-btn:hover {
    background-color: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* ============================================================
   FOR√áAR 4¬™ COLUNA NO AQU√ÅRIO (DIREITA)
   ============================================================ */
/* Quando esta classe √© adicionada ao painel, ele flutua sobre o aqu√°rio */
#references-panel.aquarium-overlay-mode {
    display: flex !important;
    position: fixed !important;
    top: 110px !important; /* Abaixo das barras de topo */
    right: 0 !important;
    bottom: 0 !important;
    height: auto !important;
    width: 400px !important; /* Largura fixa */
    
    z-index: 600 !important; /* Acima da sidebar esquerda (500), abaixo de popups */
    
    background-color: rgba(20, 20, 23, 0.95) !important;
    border-left: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: -5px 0 20px rgba(0,0,0,0.5) !important;
    backdrop-filter: blur(10px);
    
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateX(0) !important;
    flex: none !important; /* Remove flexibilidade do layout principal */
}

/* Em mobile, ocupa largura total */
@media (max-width: 768px) {
    #references-panel.aquarium-overlay-mode {
        width: 100% !important;
        top: 60px !important; /* Mais espa√ßo em mobile */
        bottom: 0 !important;
    }
}

/* ============================================================
   ANIMA√á√ÉO DE FA√çSCA PARA O BOT√ÉO DE LINKS (‚ö°)
   ============================================================ */
@keyframes electricPulse {
    0% { 
        box-shadow: 0 0 0 rgba(241, 196, 15, 0); 
        color: #888;
        border-color: transparent;
    }
    50% { 
        box-shadow: 0 0 10px rgba(241, 196, 15, 0.4); 
        color: #f1c40f; 
        border-color: #f1c40f;
        background-color: rgba(241, 196, 15, 0.1);
    }
    100% { 
        box-shadow: 0 0 2px rgba(241, 196, 15, 0.2); 
        color: #f1c40f; /* Mant√©m amarelo no fim */
        border-color: rgba(241, 196, 15, 0.5);
    }
}

/* Classe aplicada via JS quando h√° links */
.aq-tool-group button[data-ctx="links"].has-links-sparkle {
    animation: electricPulse 1.5s infinite alternate ease-in-out;
    color: #f1c40f !important; /* For√ßa √≠cone amarelo */
    border: 1px solid #f1c40f !important; /* Borda amarela */
}

/* ============================================================
   AQU√ÅRIO: BOT√ïES DE CANTO (üêö ‚á±)
   ============================================================ */
/* Contentor dos bot√µes (canto superior direito do bloco) */
.ghost-actions {
    position: absolute;
    top: 5px;
    right: 5px;
    display: none; 
    gap: 5px;
    z-index: 50; 
    
    /* MUDAN√áA CR√çTICA AQUI: */
    pointer-events: none !important; /* O clique passa atrav√©s da caixa transparente */
}

/* Mostra os bot√µes no hover */
.ghost-block:hover .ghost-actions,
.ghost-block.active-selection .ghost-actions {
    display: flex;
}

.ghost-action-btn {
    background: rgba(0,0,0,0.5); /* Fundo escuro para ser clic√°vel */
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
     pointer-events: auto !important;
}

.ghost-action-btn:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
    transform: scale(1.1);
}

/* ============================================================
   AQU√ÅRIO: JANELA POPUP FLUTUANTE
   ============================================================ */
.aq-popup-window {
    position: fixed; /* Sempre relativo √† janela do browser */
    
    /* Z-Index superior ao Aqu√°rio (2000000000) e Modais (2147483647) */
    z-index: 2147483647 !important; 
    
    top: 150px;
    left: 150px;
    width: 400px;
    height: 300px;
    
    background-color: rgba(30, 30, 35, 0.98); /* Quase opaco para leitura */
    border: 1px solid var(--accent-color);    /* Borda azul para destaque */
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
    border-radius: 8px;
    
    display: flex;
    flex-direction: column;
    overflow: hidden;
    
    /* Anima√ß√£o de entrada */
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.aq-popup-header {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    cursor: grab; /* M√£ozinha para arrastar */
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
}
.aq-popup-header:active { cursor: grabbing; }

.aq-popup-title {
    font-size: 0.85em;
    font-weight: bold;
    color: #aaa;
    text-transform: uppercase;
}

.aq-popup-close {
    background: none;
    border: none;
    color: #e74c3c;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
}

.aq-popup-content {
    flex-grow: 1;
    padding: 15px;
    color: #e0e0e0;
    outline: none;
    overflow-y: auto;
    font-family: inherit;
    line-height: 1.5;
}

/* Estado bloqueado do bloco original */
.ghost-block.locked-popup {
    opacity: 0.4;
    background-color: rgba(0, 0, 0, 0.3) !important;
    border: 1px dashed rgba(255, 255, 255, 0.3) !important;
    
    /* A CORRE√á√ÉO EST√Å AQUI: */
    pointer-events: auto !important; /* Impede que o clique atravesse para o fundo */
    cursor: not-allowed;             /* Mostra o √≠cone de proibido */
    
    user-select: none;
}


/* Aviso visual */
.ghost-block.locked-popup::after {
    content: "Aberto em Janela ‚á±";
    position: absolute;
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: bold;
    pointer-events: none;
    white-space: nowrap;
    z-index: 5;
    border: 1px solid var(--accent-color);
}

/* Bloco que est√° a ser visualizado no Armaz√©m */
.ghost-block.active-store-target {
    border: 1px solid var(--accent-color) !important;
    background-color: rgba(74, 144, 226, 0.05) !important;
    box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);
}

/* --- ESTILOS DOS CARDS DE ANOTA√á√ÉO (ARMAZ√âM üêö) --- */
.store-annotation-card {
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-left: 3px solid #f39c12; /* Laranja para diferenciar das notas */
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: all 0.2s ease;
}

.store-annotation-card:hover {
    background-color: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2);
}

.store-card-header {
    display: flex;
    align-items: center;
    gap: 5px;
}

.store-card-title {
    background: transparent;
    border: none;
    color: var(--text-color);
    font-weight: bold;
    font-size: 0.95em;
    width: 100%;
    outline: none;
    padding-bottom: 2px;
    border-bottom: 1px dashed transparent;
}

.store-card-title:focus {
    border-bottom-color: var(--accent-color);
}

.store-card-body {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    padding: 8px;
    color: var(--text-muted-color);
    font-size: 0.9em;
    min-height: 40px;
    outline: none;
    white-space: pre-wrap;
    line-height: 1.4;
}

.store-card-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding-top: 5px;
}

.store-btn-action {
    background: none;
    border: 1px solid transparent;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
}

.store-btn-action:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-color);
}

.store-btn-action.active-link {
    color: var(--accent-color);
    border-color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

.store-btn-action.delete:hover {
    color: #e74c3c;
    border-color: #e74c3c;
    background-color: rgba(231, 76, 60, 0.1);
}

/* Link clic√°vel no t√≠tulo quando existe */
.store-link-indicator {
    cursor: pointer;
    text-decoration: underline;
    text-decoration-color: var(--accent-color);
}

/* ESTADO ATIVO DO BOT√ÉO MEDUSA */
#aquarium-sidebar-toggle.active {
    background-color: var(--accent-color) !important; /* Fica Azul */
    color: white !important;
    border-color: var(--accent-color) !important;
    box-shadow: 0 0 15px rgba(74, 144, 226, 0.3); /* Brilho suave */
    transform: scale(1.1); /* Ligeiro aumento */
}


/* Bot√£o de Inser√ß√£o R√°pida */
.ghost-add-between-btn {
    position: absolute;
    bottom: -12px;
    left: -24px;
    
    width: 20px;
    height: 20px;
    border-radius: 50%;
    
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    
    /* TRUQUE: Tamanho 0 esconde o texto antigo do HTML */
    font-size: 0 !important; 
    color: transparent; 
    
    display: none; 
    align-items: center;
    justify-content: center;
    
    cursor: pointer;
    z-index: 100;
    
    transition: all 0.2s ease;
    
    /* Garante que o bot√£o recebe cliques */
    pointer-events: auto !important; 
    user-select: none !important;
    -webkit-user-select: none !important;
}

/* O "+" visual (Pseudo-elemento) */
.ghost-add-between-btn::before {
    content: '+';
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Restaura o tamanho e cor para o √≠cone */
    font-size: 16px !important; 
    color: var(--text-muted-color);
    
    width: 100%;
    height: 100%;
    margin-top: -2px; /* Ajuste fino vertical */
}

/* Hover */
.ghost-add-between-btn:hover {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    transform: scale(1.2);
}

.ghost-add-between-btn:hover::before {
    color: white; /* Muda a cor do + para branco no hover */
}

/* Visibilidade controlada pelo JS */
.ghost-block.active-selection.has-next .ghost-add-between-btn {
    display: flex !important;
    animation: fadeIn 0.2s ease;
}


/* ============================================================
   ESTILOS DO ARMAZ√âM (STORE) - ABAS E CARDS
   ============================================================ */

/* Barra de Abas do Armaz√©m */
.store-tabs-header {
    display: flex;
    gap: 8px;
    padding: 10px 10px 0 10px; /* Padding no topo e lados, zero em baixo para colar √† borda */
    border-bottom: 1px solid var(--border-color);
    background-color: var(--sidebar-color); /* Garante fundo s√≥lido */
    overflow-x: auto;
    white-space: nowrap; /* Impede quebra de linha */
    
    /* Esconde barra de scroll feia mas permite scroll */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}

.store-tabs-header::-webkit-scrollbar { display: none; }

.store-tab-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px 6px 0 0; /* Cantos redondos s√≥ em cima */
    font-size: 0.9em;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
    
    /* Importante: Borda inferior transparente por defeito */
    border-bottom: 3px solid transparent;
    margin-bottom: -1px; /* Faz a borda ativa sobrepor a linha do header */
}

.store-tab-btn:hover {
    color: var(--text-color);
    background-color: var(--hover-color);
}

.store-tab-btn.active {
    color: var(--accent-color); /* Azul do texto */
    font-weight: bold;
    border-bottom-color: var(--accent-color); /* Linha azul por baixo */
    background-color: rgba(74, 144, 226, 0.1); /* Fundo azul muito suave */
}

/* √Årea de Conte√∫do */
.store-content-area {
    padding: 15px;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Bot√µes de A√ß√£o (+ Anota√ß√£o, + Concha, etc) */
.store-create-btn {
    width: 100%;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px dashed var(--border-color);
    color: var(--text-muted-color);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 15px;
}

.store-create-btn:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

/* --- CARD DE NOTA (Store Note) --- */
.store-note-card {
    background-color: var(--panel-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
    transition: border-color 0.2s;
}

.store-note-card:hover {
    border-color: var(--accent-color);
}

.store-note-title {
    background: transparent;
    border: none;
    color: var(--text-color);
    font-weight: bold;
    font-size: 1em;
    width: 100%;
    outline: none;
    border-bottom: 1px solid transparent;
}

.store-note-title:focus {
    border-bottom-color: var(--accent-color);
}

.store-note-body {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    color: var(--text-color);
    font-size: 0.9em;
    min-height: 60px;
    outline: none;
    white-space: pre-wrap;
}

/* Rodap√© do Card (Links e Bot√µes) */
.store-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding-top: 8px;
}

.store-links-area {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-grow: 1;
}

.store-link-row {
    display: flex;
    gap: 5px;
    align-items: center;
}

.store-link-input {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--accent-color);
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.8em;
    width: 80%;
}

.store-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.store-icon-btn:hover { opacity: 1; }

/* --- CARD DE CONCHA (Pasta) --- */
.store-shell-card {
    background-color: rgba(230, 126, 34, 0.1);
    border: 1px solid #e67e22;
    border-radius: 12px; /* Mais redondo como uma concha */
    padding: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s;
}

.store-shell-card:hover {
    background-color: rgba(230, 126, 34, 0.2);
    transform: translateX(5px);
}

.shell-icon { font-size: 1.5em; margin-right: 10px; }
.shell-name { font-weight: bold; color: #e67e22; flex-grow: 1; }

/* --- CARD DE MULTIM√âDIA (Imagem) --- */
.store-media-card {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    position: relative;
}

.store-media-img {
    width: 100%;
    border-radius: 4px;
    display: block;
    margin-bottom: 5px;
}

.store-media-input {
    width: 100%;
    background: var(--panel-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 5px;
    border-radius: 4px;
}

/* Header de Navega√ß√£o (Dentro da Concha) */
.store-nav-header {
    display: flex;
    align-items: center;
    padding: 10px;
    background-color: rgba(230, 126, 34, 0.15);
    border-bottom: 1px solid #e67e22;
    margin-bottom: 10px;
}

/* Bot√£o de Localiza√ß√£o no Card (Aba Par√°grafos) */
.btn-locate-block {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    margin-right: auto; /* Empurra os outros bot√µes para a direita */
}

.btn-locate-block:hover {
    background-color: var(--accent-color);
    color: white;
}

/* Bot√£o de V√≠nculo ao Par√°grafo (Dentro do Card) */
.store-link-indicator-btn {
    background: transparent;
    border: 1px solid var(--text-muted-color); /* Borda cinza subtil */
    color: var(--text-muted-color);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 14px; /* √çcone um pouco maior */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    transition: all 0.2s;
    opacity: 0.7;
}

.store-link-indicator-btn:hover {
    border-color: #2ecc71; /* Verde ao passar o rato */
    color: #2ecc71;
    background: rgba(46, 204, 113, 0.1);
    opacity: 1;
}

/* Input de T√≠tulo no Topo do Aqu√°rio */
.aquarium-header-input {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.2em;
    font-weight: bold;
    text-align: right;
    outline: none;
    width: 300px;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.aquarium-header-input:focus {
    border-bottom-color: var(--accent-color);
}

.aquarium-header-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
}

/* ============================================================
   EFEITO DE BOLHAS DO AQU√ÅRIO
   ============================================================ */
.aquarium-bubble {
    position: fixed;
    bottom: -100px; /* Come√ßa fora do ecr√£ */
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    pointer-events: none; /* N√£o interfere com cliques */
    z-index: 1999999999; /* Logo abaixo do painel do aqu√°rio (2bi) */
    animation: bubbleUp linear forwards;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2);
}

@keyframes bubbleUp {
    0% {
        transform: translateY(0) scale(1);
        opacity: 0;
    }
    10% {
        opacity: 0.6;
    }
    100% {
        transform: translateY(-120vh) scale(1.5);
        opacity: 0;
    }
}

/* Estado Ativo/Focado (Se existir, garantir que √© subtil ou igual ao normal) */
.store-note-card:focus, 
.store-note-card:active {
    border-color: var(--border-color); /* Mant√©m a cor original */
    background-color: var(--panel-color); /* Mant√©m o fundo original */
}

/* Remover sele√ß√£o azul padr√£o do browser */
*:focus {
    outline: none;
}

/* --- AJUSTES MOBILE DO AQU√ÅRIO --- */
@media (max-width: 768px) {
    
    /* 1. Barra de Topo com Scroll Horizontal */
    #aquarium-bar {
        overflow-x: auto;      /* Permite scroll lateral */
        white-space: nowrap;   /* Impede quebra de linha */
        justify-content: flex-start !important; /* Alinha tudo √† esquerda */
        gap: 15px;             /* Espa√ßo entre grupos */
        
        /* Esconde barra de scroll feia */
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    #aquarium-bar::-webkit-scrollbar { display: none; }

    /* Garante que os grupos n√£o encolhem */
    .aquarium-nav-group, 
    .aquarium-tools-group {
        flex-shrink: 0;
    }

    /* 2. Reordena√ß√£o do Status "Guardado" */
    /* No HTML original, o status est√° num div separado no fim. Vamos mov√™-lo visualmente. */
    /* Mas como pediu para ficar ao lado do bot√£o íÜú, vamos fazer isso via JS, 
       pois √© mais seguro mover o elemento no DOM do que tentar CSS order complexo */
}

/* Grupo de Navega√ß√£o do Topo (Esquerda) */
.aquarium-nav-group {
    display: flex;
    align-items: center;
    gap: 10px; /* Espa√ßo consistente entre bot√µes */
    flex-shrink: 0;
}

/* Ajuste espec√≠fico para o texto de status no topo */
#aq-save-status {
    white-space: nowrap;
    margin-left: 5px; /* Margem extra para n√£o colar */
    font-weight: 500;
}

/* --- CORRE√á√ÉO DA TOOLBAR JORNAL MOBILE --- */
@media (max-width: 768px) {
    
    /* Garante que o grupo de extras do jornal aparece em linha */
    #group-journal-extras {
        display: none; /* Controlado via JS (displayNote), passa a flex */
        align-items: center;
        flex-shrink: 0; /* Impede que seja esmagado */
    }

    /* Quando ativado pelo JS, for√ßa flex */
    #group-journal-extras[style*="display: flex"] {
        display: flex !important;
    }
    
    /* Ajuste dos bot√µes do jornal para terem tamanho de toque correto */
    #group-journal-extras button {
        min-width: 34px;
        height: 34px;
        margin: 0 2px;
        flex-shrink: 0;
    }

    /* O separador dentro do grupo jornal */
    #group-journal-extras div[style*="width:1px"] {
        height: 20px !important;
        background: rgba(255,255,255,0.2) !important;
        margin: 0 8px !important;
    }
    
    /* Garante que o bot√£o do Redator (no fundo) aparece */
    #btn-insert-redator {
        font-size: 20px !important; /* Um pouco maior no mobile */
        padding: 5px 10px;
    }
}

/* --- CORRE√á√ÉO DE SELE√á√ÉO DE TEXTO EM T√çTULOS (MOBILE) --- */
/* Adicione isto ao seu CSS */
@media (max-width: 768px) {
    
    /* Obriga todas as √°reas de conte√∫do a serem selecion√°veis */
    .mini-note-content,
    .redator-content,
    .cube-content,
    .sign-content,
    .card-desc-content,
    .toggle-content {
        user-select: text !important;
        -webkit-user-select: text !important; /* Essencial para iPhone */
        cursor: text !important;
        pointer-events: auto !important;
        
        /* Garante que o toque √© interpretado como intera√ß√£o e n√£o scroll */
        touch-action: pan-y !important; 
        
        /* Remove qualquer highlight de clique cinzento */
        -webkit-tap-highlight-color: transparent;
        
        /* Garante altura m√≠nima para o dedo acertar */
        min-height: 50px !important;
        
        /* Z-index ligeiramente maior para ficar "acima" do fundo da caixa */
        position: relative !important;
        z-index: 10 !important;
    }

    /* Garante que os inputs de t√≠tulo tamb√©m funcionam */
    .mini-note-title-input, 
    .redator-input {
        pointer-events: auto !important;
        z-index: 10 !important;
    }
}

/* ============================================================
   CORRE√á√ÉO CR√çTICA MOBILE: ESCRITA E MENU NATIVO
   ============================================================ */

/* 1. For√ßa a sele√ß√£o de texto em todos os inputs e √°reas edit√°veis */
.mini-note-title-input,
.mini-note-content,
.redator-input,
.redator-content,
.sign-title-input,
.sign-content,
.card-title-input,
.card-desc-content,
.cube-content,
.toggle-content,
#note-title-input,
.post-title-input,
.post-editor-content {
    /* Permite selecionar texto (iOS e Android) */
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
    
    /* Garante que o toque funciona */
    pointer-events: auto !important;
    cursor: text !important;
    
    /* Remove a cor de toque padr√£o cinzenta */
    -webkit-tap-highlight-color: transparent !important;
    
    /* Garante que o sistema sabe que √© para intera√ß√£o de toque */
    touch-action: manipulation !important;
    
    /* Corrige bug visual no iOS onde o cursor fica escondido */
    transform: translateZ(0); 
}

/* 2. Remove restri√ß√µes dos pais para n√£o bloquear os filhos */
.mini-note-wrapper,
.redator-wrapper,
.journal-sign-wrapper,
.journal-id-card,
.journal-cube-wrapper,
details.toggle-section {
    -webkit-user-select: none; /* O contentor n√£o se seleciona... */
    user-select: none;
}

/* ...Mas o conte√∫do dentro dele SIM: */
.mini-note-wrapper *,
.redator-wrapper *,
.journal-sign-wrapper *,
.journal-id-card *,
.journal-cube-wrapper *,
details.toggle-section * {
    -webkit-user-select: text;
    user-select: text;
}

/* 3. Garante que a Toolbar n√£o rouba o foco */
.mini-note-toolbar,
.redator-dock,
.sign-toolbar,
.card-toolbar,
.cube-toolbar {
    -webkit-user-select: none !important;
    user-select: none !important;
}

/* ============================================================
   CORRE√á√ÉO CR√çTICA MOBILE: MENU NATIVO (COPIAR/COLAR)
   ============================================================ */

/* Aplica-se a todos os inputs, textareas e divs edit√°veis dentro do editor */
#note-content-editor input,
#note-content-editor textarea,
#note-content-editor [contenteditable="true"],
.mini-note-title-input,
.mini-note-content,
.redator-input,
.redator-content,
.sign-title-input,
.sign-content,
.card-title-input,
.card-desc-content,
.cube-content,
.toggle-content,
.post-title-input,
.post-editor-content {
    /* 1. Permite sele√ß√£o de texto (Android/PC) */
    user-select: text !important;
    
    /* 2. Permite sele√ß√£o de texto (iOS Safari) */
    -webkit-user-select: text !important;
    
    /* 3. Permite o menu de contexto/lupa ao segurar (iOS) */
    -webkit-touch-callout: default !important;
    
    /* 4. Garante que o cursor √© de texto */
    cursor: text !important;
    
    /* 5. Garante que o elemento recebe eventos de ponteiro */
    pointer-events: auto !important;
    
    /* 6. Remove a cor de "tap" cinzenta padr√£o no mobile */
    -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
}

/* Garante que o container pai n√£o rouba o clique */
.mini-note-wrapper, 
.redator-wrapper, 
.journal-sign-wrapper, 
.journal-id-card, 
.journal-cube-wrapper {
    /* O pai n√£o √© selecion√°vel (para arrastar) */
    user-select: none;
    -webkit-user-select: none;
}

/* Garante que as vistas da Medusa ocupam o espa√ßo todo sem lixo visual */
.aq-view {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}

#aq-store-view {
    flex-direction: column; /* Necess√°rio para o cabe√ßalho das sub-abas ficar no topo */
}

#note-content-editor, .post-editor-content {
    overflow-anchor: none !important; /* Impede o "Scroll Anchoring" autom√°tico do browser */
}

/* ============================================================
   AJUSTE AUTOM√ÅTICO DO TEXTO NO AQU√ÅRIO (SQUEEZE)
   ============================================================ */

/* Define a transi√ß√£o suave para o texto n√£o saltar bruscamente */
#aquarium-scroll-area {
    transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%; /* Garante que ocupa o espa√ßo */
    box-sizing: border-box;
}

/* QUANDO A ESQUERDA (MEDUSA) EST√Å ABERTA */
#aquarium-environment.left-open #aquarium-scroll-area {
    margin-left: 360px !important; /* Mesma largura da sidebar esquerda */
}

/* QUANDO A DIREITA (REFER√äNCIAS) EST√Å ABERTA */
#aquarium-environment.right-open #aquarium-scroll-area {
    margin-right: 400px !important; /* Mesma largura do painel direito */
}

/* NO MOBILE: Ignora isto (continua a sobrepor para poupar espa√ßo) */
@media (max-width: 768px) {
    #aquarium-environment.left-open #aquarium-scroll-area,
    #aquarium-environment.right-open #aquarium-scroll-area {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Efeito de Flash ao clicar no √çndice */
@keyframes target-flash {
    0% { box-shadow: 0 0 0 rgba(74, 144, 226, 0); border-color: var(--border-color); }
    50% { box-shadow: 0 0 20px rgba(74, 144, 226, 0.6); border-color: var(--accent-color); }
    100% { box-shadow: 0 0 0 rgba(74, 144, 226, 0); border-color: var(--border-color); }
}

.flash-target {
    animation: target-flash 1.5s ease-out;
}

/* --- MODO FLASH (LARANJA) --- */
.folder-mode-item.active.mode-flash {
    color: #e67e22 !important; /* Laranja */
}

.folder-mode-item.active.mode-flash::after {
    background-color: #e67e22 !important;
    height: 3px;
}

/* Estilo Laranja para o bot√£o Adicionar (+) */
#add-item-btn.flash-mode {
    border-color: #e67e22 !important;
    color: #e67e22 !important;
}

#add-item-btn.flash-mode:hover {
    background-color: #e67e22 !important;
    color: white !important;
}

/* Sele√ß√£o Laranja (Modo Flash) */
.list-item.selected-orange {
    background-color: rgba(230, 126, 34, 0.15) !important;
    border-left: 4px solid #e67e22 !important;
    color: white !important;
}

/* Notifica√ß√£o na Aba Share */
.folder-mode-item {
    position: relative; /* Necess√°rio para posicionar a bola */
}

.tab-notification-dot {
    position: absolute;
    top: -2px;
    right: -6px;
    width: 8px;
    height: 8px;
    background-color: #e74c3c;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(231, 76, 60, 0.6);
    display: none; /* Escondido por defeito */
    pointer-events: none;
    animation: pulse-dot 2s infinite;
}

.tab-notification-dot.visible {
    display: block !important;
}

/* No seu <style> */
    #category-search-input {
    background-color: var(--bg-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    cursor: text; /* Garante cursor de texto */
}

#category-search-input:focus {
    border-color: var(--accent-color);
    outline: none;
}

/* Bot√£o de Menu Flutuante (Aparece s√≥ quando colapsado) */
.redator-collapsed-menu-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    cursor: pointer;
    z-index: 15;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.redator-collapsed-menu-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

/* A REGRA M√ÅGICA: Mostra o bot√£o APENAS quando o cabe√ßalho est√° escondido */
.redator-wrapper.header-hidden .redator-collapsed-menu-btn {
    opacity: 1;
    pointer-events: auto;
}

/* Ajuste do Menu Deslizante (Agora relativo ao Wrapper, n√£o ao Header) */
.redator-slide-menu {
    top: 5px !important;       
    right: 35px !important;    /* Fica √† esquerda dos 3 pontos */
    z-index: 50 !important;    
}

/* Bot√£o de Link Externo nas Listas */
.external-open-btn {
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 14px;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: auto; /* Empurra para a direita */
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.external-open-btn:hover {
    color: var(--accent-color);
    background-color: var(--hover-color);
    transform: scale(1.1);
}

/* Estilo para Links de Texto no Aqu√°rio (Subtil) */
 a.silent-link {
    color: inherit !important;
    text-decoration: none !important;
    cursor: text !important;
    
    /* Garante que o texto flui normalmente sem criar degraus */
    display: inline !important;
    line-height: inherit !important;
    vertical-align: baseline !important;

    /* Pequeno espa√ßo f√≠sico entre frases coladas */
    margin: 0 2px !important; 
    padding: 0 2px !important; 
    border-radius: 3px;

    /* Garante que a cor segue a frase se ela mudar de linha */
    -webkit-box-decoration-break: clone !important;
    box-decoration-break: clone !important;

    transition: all 0.2s;
}

/* 2. √çMPARES (1¬∫, 3¬∫...): LARANJA SUAVE */
a.silent-link:nth-of-type(odd) {
    background-color: rgba(230, 126, 34, 0.15) !important; /* Laranja */
    border-bottom: 1px dotted rgba(230, 126, 34, 0.6) !important;
}

/* 3. PARES (2¬∫, 4¬∫...): VERDE TURQUESA */
a.silent-link:nth-of-type(even) {
    background-color: rgba(26, 188, 156, 0.15) !important; /* Verde Transl√∫cido */
    border-bottom: 1px dotted rgba(26, 188, 156, 0.6) !important;
}

/* 4. HOVER (Ao passar o rato) */
a.silent-link:hover {
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    border-bottom-style: solid !important;
    box-shadow: 0 0 8px rgba(255,255,255,0.1);
    opacity: 1 !important;
    z-index: 10;
    position: relative;
}


.dynamic-url-row {
    display: flex;
    gap: 5px;
    align-items: center;
}

.dynamic-url-row input {
    flex-grow: 1;
    padding: 8px;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-color);
}

.btn-remove-url {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid #e74c3c;
    color: #e74c3c;
    width: 34px;
    height: 34px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.btn-remove-url:hover {
    background: #e74c3c;
    color: white;
}

/* Bot√£o de Lixo no Modal de Links */
.btn-delete-link-ref {
    background-color: transparent;
    border: 1px solid #c0392b;
    color: #c0392b;
    font-size: 18px;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-right: auto; /* Empurra os outros bot√µes para a direita */
    transition: all 0.2s;
}

.btn-delete-link-ref:hover {
    background-color: #c0392b;
    color: white;
}

/* Contentor Lateral (Agrupa Setas e +) */
.ghost-side-controls {
    position: absolute;
    left: -22px;
    top: 0;           /* Come√ßa no topo */
    bottom: 0;        /* Vai at√© ao fundo */
    height: 100%;     /* Garante altura total */
    
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* CENTRA AS SETAS VERTICALMENTE */
    gap: 4px;
    z-index: 100;
    
    user-select: none;
    -webkit-user-select: none;
    pointer-events: none; /* O contentor √© invis√≠vel ao clique */
}

/* Mostra quando ativo */
.ghost-block.active-selection .ghost-side-controls {
    display: flex !important;
    animation: fadeIn 0.2s ease;
}

/* Bot√µes de Seta */
.ghost-move-btn {
    pointer-events: auto; /* Reativa cliques nos bot√µes */
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    border-radius: 4px;
}
.ghost-move-btn:hover { color: var(--accent-color); background-color: rgba(255, 255, 255, 0.1); }

/* Bot√£o Adicionar (+) - POSICIONADO NO FUNDO */
.ghost-add-between-btn {
    position: absolute; /* Sai do fluxo flex */
    bottom: -12px;      /* Cola ao fundo (ajuste fino para alinhar com a borda) */
    left: 50%;
    transform: translateX(-50%); /* Centra horizontalmente */
    
    pointer-events: auto; /* Reativa cliques */
    
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--sidebar-color);
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.ghost-add-between-btn:hover {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
    transform: translateX(-50%) scale(1.1); /* Mant√©m centrado ao aumentar */
}

.ghost-add-between-btn::before {
    content: '+';
    font-size: 16px;
    line-height: 1;
    margin-top: -1px;
}

/* ============================================================
   EFEITO ONDA AZUL (PARTILHA ATIVA)
   ============================================================ */

/* A Anima√ß√£o da Onda */
@keyframes blueWaveSignal {
    0% {
        /* Estado calmo */
        box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.2);
        border-color: rgba(74, 144, 226, 0.5);
    }
    50% {
        /* Estado expandido (Onda) */
        box-shadow: 0 0 25px 5px rgba(74, 144, 226, 0.4), inset 0 0 15px rgba(74, 144, 226, 0.1);
        border-color: #4a90e2; /* Azul puro */
    }
    100% {
        /* Retorna ao calmo */
        box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.2);
        border-color: rgba(74, 144, 226, 0.5);
    }
}

/* A classe que ser√° ativada via JS */
.modal-content.share-active-wave {
    animation: blueWaveSignal 3s infinite ease-in-out; /* Movimento lento e suave (3s) */
    transition: all 0.5s ease; /* Transi√ß√£o suave ao ligar/desligar */
    border: 1px solid var(--accent-color) !important; /* Garante que a borda existe */
}

/* Bot√£o de Informa√ß√£o (i) no rodap√© do Post */
.post-info-btn {
    background: transparent;
    border: 1px solid var(--text-muted-color);
    color: var(--text-muted-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    font-family: serif; /* Estilo cl√°ssico para o 'i' */
    transition: all 0.2s ease;
}

.post-info-btn:hover {
    color: var(--accent-color);
    border-color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.1);
}

.info-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.95em;
    color: var(--text-color);
    padding: 8px;
    background-color: var(--bg-color);
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.info-icon {
    font-size: 1.2em;
    width: 24px;
    text-align: center;
}

.info-data {
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 0.75em;
    color: var(--text-muted-color);
    text-transform: uppercase;
    font-weight: bold;
}

/* Garante que o container do spinner ocupa o espa√ßo e centra o conte√∫do */
.panel-loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 150px; /* Altura suficiente para n√£o ficar colado ao topo */
    color: var(--text-muted-color);
    font-size: 0.9em;
    font-style: italic;
    width: 100%;
}

@keyframes pulse-badge {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 5px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

/* ============================================================
   CORRE√á√ÉO CR√çTICA MOBILE: MENU NATIVO E SELE√á√ÉO DE TEXTO
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. For√ßa a sele√ß√£o de texto em todos os inputs e √°reas edit√°veis */
    .mini-note-title-input,
    .mini-note-content,
    .redator-input,
    .redator-content,
    .sign-title-input,
    .sign-content,
    .card-title-input,
    .card-desc-content,
    .cube-content,
    .toggle-content,
    #note-title-input,
    .post-title-input,
    .post-editor-content {
        /* Permite selecionar texto (iOS e Android) */
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
        
        /* Garante que o toque funciona */
        pointer-events: auto !important;
        cursor: text !important;
        
        /* Remove a cor de toque padr√£o cinzenta */
        -webkit-tap-highlight-color: transparent !important;
        
        /* Garante que o sistema sabe que √© para intera√ß√£o de toque */
        touch-action: manipulation !important;
    }

    /* 2. Remove restri√ß√µes dos pais para n√£o bloquear os filhos */
    .mini-note-wrapper,
    .redator-wrapper,
    .journal-sign-wrapper,
    .journal-id-card,
    .journal-cube-wrapper,
    details.toggle-section {
        -webkit-user-select: none; /* O contentor n√£o se seleciona... */
        user-select: none;
    }

    /* ...Mas o conte√∫do dentro dele SIM: */
    .mini-note-wrapper *,
    .redator-wrapper *,
    .journal-sign-wrapper *,
    .journal-id-card *,
    .journal-cube-wrapper *,
    details.toggle-section * {
        -webkit-user-select: text;
        user-select: text;
    }
}

/* ============================================================
   CORRE√á√ÉO DE ESPA√áAMENTO E SELE√á√ÉO (MOBILE)
   ============================================================ */

/* 1. Garante que os espa√ßos entre caixas s√£o f√°ceis de tocar */
#note-content-editor p {
    min-height: 24px !important; /* Altura m√≠nima para o dedo acertar */
    padding: 2px 0;              /* Pequena margem de erro */
    
    /* For√ßa a permiss√£o de sele√ß√£o e menu nativo */
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: text !important;
    
    /* Remove cor de toque cinzenta */
    -webkit-tap-highlight-color: transparent;
}

/* 2. Garante que o pr√≥prio editor aceita o toque no fundo */
#note-content-editor {
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: text !important;
    
    /* Garante que o editor ocupa o ecr√£ para se poder clicar no fundo */
    min-height: 60vh; 
}

/* Garante que o scroll no telem√≥vel √© nativo e suave */
#note-content-editor {
    /* Permite scroll nativo r√°pido e suave */
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y; /* Permite scroll vertical, bloqueia gestos laterais acidentais */
    
    /* Garante que o toque n√£o fica com a cor cinzenta feia */
    -webkit-tap-highlight-color: transparent;
}
/* ============================================================
   CORRE√á√ÉO MOBILE: ENTIDADES (SUBNOTAS/QUEST√ïES)
   ============================================================ */
@media (max-width: 768px) {
    
    /* 1. Barra de Ferramentas Interna (Lixo, Setas, Cor) */
    /* No PC √© display: none e aparece com hover. No Mobile for√ßamos flex. */
    .mini-note-wrapper .mini-note-toolbar,
    .redator-wrapper .redator-dock,
    .journal-sign-wrapper .sign-toolbar {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
        
        /* Ajuste para n√£o ficar gigante */
        transform: scale(1); 
        margin-bottom: 5px;
    }

    /* 2. Garante que os bot√µes dentro da barra s√£o toc√°veis */
    .mini-note-toolbar button {
        padding: 8px 12px !important; /* Aumenta √°rea de toque */
        font-size: 16px !important;
    }

    /* 3. T√≠tulo da Entidade: Garante que o teclado abre */
    .mini-note-title-input {
        pointer-events: auto !important; /* Permite clique */
        user-select: text !important;    /* Permite sele√ß√£o */
    }
}

/* --- ESTADO ATIVO DOS BOT√ïES DE FORMATA√á√ÉO --- */
button.active-tool {
    background-color: var(--selected-color) !important; /* Fundo azulado */
    color: white !important;                            /* Texto branco */
    border: 1px solid var(--accent-color) !important;   /* Borda azul */
    transition: all 0.1s ease;
}

/* Ajuste espec√≠fico para o bot√£o B Azul quando est√° ativo */
button[data-command="boldBlue"].active-tool {
    background-color: rgba(74, 144, 226, 0.2) !important;
    border-color: #4a90e2 !important;
}

/* Estilo para o Contentor de Pesquisa Fixa na Lista */
.list-search-sticky-header {
    /* Ativa a fixa√ß√£o */
    position: -webkit-sticky !important; /* Para Safari */
    position: sticky !important;
    top: 0 !important;
    
    /* Garante que fica por cima dos outros itens */
    z-index: 50 !important; 
    
    /* Fundo S√≥lido (CR√çTICO: Sem isto o texto mistura-se) */
    background-color: var(--panel-color) !important;
    
    /* Est√©tica */
    padding: 10px 5px !important;
    margin-bottom: 5px !important;
    border-bottom: 1px solid var(--border-color) !important;
    box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.2) !important; /* Sombra para dar profundidade */
}

/* 2. O Input dentro da caixa */
.list-search-sticky-header input {
    width: 100% !important;
    padding: 10px 12px !important;
    border-radius: 6px !important;
    border: 1px solid var(--border-color) !important;
    background-color: var(--bg-color) !important;
    color: var(--text-color) !important;
    outline: none !important;
    font-size: 14px !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.2) !important;
}

.list-search-sticky-header input:focus {
    border-color: var(--accent-color) !important;
}

/* 3. CORRE√á√ÉO CR√çTICA DE SCROLL */
/* O #file-list n√£o pode ter overflow, quem faz scroll √© o #middle-views-container */
#file-list {
    overflow: visible !important; 
    height: auto !important;
}

#middle-views-container {
    overflow-y: auto !important;
    position: relative !important;
}

.post-like-btn.active-like {
    border-color: #e74c3c !important;
    background-color: rgba(231, 76, 60, 0.1) !important;
    color: #e74c3c !important;
}

.post-like-btn:hover {
    transform: scale(1.05);
    border-color: var(--accent-color);
}

/* Part√≠cula da Explos√£o */
.like-particle {
    position: fixed;
    width: 6px;
    height: 6px;
    background-color: #e74c3c; /* Vermelho cora√ß√£o */
    border-radius: 50%;
    pointer-events: none;
    z-index: 99999;
}

/* Transi√ß√£o suave de cor no bot√£o */
.post-like-btn {
    transition: background-color 0.2s, border-color 0.2s, color 0.2s, transform 0.1s !important;
}


/* --- POPUP DE PESQUISA LOCAL (Ctrl+F) --- */
#local-search-popup {
    display: none;
    position: absolute;
    top: 60px;
    right: 20px;
    background-color: var(--sidebar-color);
    border: 1px solid var(--accent-color);
    border-radius: 6px;
    padding: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    gap: 8px;
    animation: slideDown 0.2s ease-out;
}

#local-search-input {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 5px 8px;
    border-radius: 4px;
    font-size: 14px;
    width: 200px;
    outline: none;
}

#local-search-input:focus {
    border-color: var(--accent-color);
}

.local-search-btn {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted-color);
    cursor: pointer;
    border-radius: 4px;
    padding: 4px 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.local-search-btn:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

#local-search-count {
    font-size: 12px;
    color: var(--text-muted-color);
    min-width: 40px;
    text-align: center;
}

/* --- ESTILO DO TEXTO ENCONTRADO --- */
/* Amarelo suave para todos os encontrados */
.local-highlight {
    background-color: rgba(241, 196, 15, 0.4);
    border-radius: 2px;
    color: white;
}

/* Laranja forte para o foco atual (o que estamos a ver) */
.local-highlight.active {
    background-color: #e67e22;
    color: white;
    font-weight: bold;
    box-shadow: 0 0 10px #e67e22;
}

/* Lista de Resultados da Pesquisa Local */
#local-search-popup {
    flex-wrap: wrap; /* Permite que a lista quebre para a linha de baixo */
}

#local-search-results-list {
    display: none; /* Escondido por defeito */
    width: 100%;
    max-height: 250px; /* Altura m√°xima com scroll */
    overflow-y: auto;
    background-color: var(--panel-color);
    border-top: 1px solid var(--border-color);
    margin-top: 5px;
    padding: 0;
    list-style: none;
    flex-basis: 100%; /* For√ßa a ocupar a largura toda */
}

#local-search-results-list.visible {
    display: block;
}

.local-result-item {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    font-size: 0.9em;
    color: var(--text-muted-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background 0.1s;
}

.local-result-item:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

/* Item selecionado na lista (Sincronizado com as setas) */
.local-result-item.active-list-item {
    background-color: rgba(230, 126, 34, 0.2); /* Fundo Laranja suave */
    border-left: 3px solid #e67e22;
    color: var(--text-color);
}

/* Destaque do termo dentro da lista */
.local-result-item mark {
    background: transparent;
    color: #e67e22; /* Laranja */
    font-weight: bold;
}

/* --- NOVO: MODAL ANEXAR FONTES --- */
#attach-sources-modal .modal-content {
    width: 500px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    padding: 0; /* Padding gerido internamente */
    overflow: hidden;
}

/* Abas Superiores */
.attach-tabs {
    display: flex;
    background-color: var(--sidebar-color);
    border-bottom: 1px solid var(--border-color);
}

.attach-tab-btn {
    flex: 1;
    padding: 15px;
    background: none;
    border: none;
    color: var(--text-muted-color);
    cursor: pointer;
    font-weight: bold;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.attach-tab-btn:hover { background-color: var(--hover-color); color: var(--text-color); }
.attach-tab-btn.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
    background-color: rgba(74, 144, 226, 0.05);
}

/* √Åreas de Conte√∫do */
.attach-tab-content {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto;
    display: none; /* Escondido por defeito */
}
.attach-tab-content.active { display: block; }

/* Lista de Frases (SuperLink) */
#superlink-sentences-list {
    list-style: none;
    margin-top: 10px;
}

.superlink-sentence-item {
    padding: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex;
    align-items: flex-start;
    gap: 10px;
    cursor: pointer;
    font-size: 0.9em;
    color: var(--text-muted-color);
    transition: background 0.2s;
}

.superlink-sentence-item:hover {
    background-color: var(--hover-color);
    color: var(--text-color);
}

.superlink-sentence-item input {
    margin-top: 3px;
    cursor: pointer;
}

/* --- ESTILO VISUAL NO TEXTO (O PICOTADO) --- */
.superlink-anchor {
    border-bottom: 2px dotted var(--accent-color); /* Picotado Azul */
    color: var(--accent-color);
    cursor: pointer;
    position: relative;
}

.superlink-target {
    border-bottom: 2px dotted #e67e22; /* Picotado Laranja (Destino) */
    cursor: pointer;
    background-color: rgba(230, 126, 34, 0.1);
    transition: background 0.3s;
}

/* Efeito ao passar o rato ou clicar */
.superlink-anchor:hover, .superlink-target:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.superlink-flash {
    animation: flash-highlight 1.5s ease-out;
}

/* --- ESTILOS DO SUPERLINK üñáÔ∏è --- */

/* Estilo Picotado (Dashed) para a Origem e Destino */
.superlink-style {
    border-bottom: 2px dashed var(--accent-color) !important;
    text-decoration: none !important;
    cursor: pointer;
    color: inherit;
    transition: background 0.2s;
}

.superlink-style:hover {
    background-color: rgba(74, 144, 226, 0.2);
}

/* Quando o alvo √© focado (scroll) */
.superlink-target.active-flash {
    background-color: rgba(241, 196, 15, 0.4);
    transition: background-color 1s ease-out;
}

/* Lista de Frases no Modal */
.superlink-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 5px;
    background: rgba(0,0,0,0.1);
}

.superlink-item {
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 0.9em;
    line-height: 1.4;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.superlink-item:hover {
    background-color: var(--hover-color);
}

.superlink-item input {
    margin-top: 3px;
    cursor: pointer;
}


/* --- ESTILO DO SUPERLINK (PICOTADO) --- */

/* Diferen√ßa visual subtil para a Fonte (Origem) vs Alvo */
.superlink-dotted.source {
    border-bottom-color: #f1c40f; /* Laranja/Amarelo para a origem */
}

/* Efeito de Flash ao fazer scroll */
@keyframes flash-target {
    0% { background-color: rgba(255, 255, 255, 0.5); }
    100% { background-color: transparent; }
}

.superlink-flash {
    animation: flash-target 1.5s ease-out;
}

/* Ajustes do Modal de Fontes */
#source-manager-modal .modal-content {
    height: 70vh;
    display: flex;
    flex-direction: column;
}

#superlink-sentences-list {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-top: 10px;
    background: var(--bg-color);
}



/* 1. Garante que a √°rea de conte√∫do da aba ocupa o espa√ßo todo */
#source-content-superlink {
    display: flex;       /* Muda de block para flex */
    flex-direction: column;
    height: 100%;       /* Ocupa a altura dispon√≠vel no modal */
    min-height: 0;      /* Permite scroll interno */
}

/* 2. Estilo da Lista de Frases */
#superlink-sentences-list {
    flex-grow: 1;            /* Estica para ocupar o resto do espa√ßo */
    overflow-y: auto;        /* Scroll acontece aqui */
    
    background-color: rgba(0, 0, 0, 0.2); /* Fundo ligeiramente mais escuro */
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-top: 10px;
    padding: 5px;
}

/* 3. Estilo dos Itens (Frases) */


/* Hover e Sele√ß√£o */
.sentence-item:hover { 
    background-color: rgba(255, 255, 255, 0.08); 
}

.sentence-item.selected { 
    background-color: rgba(74, 144, 226, 0.2) !important; /* Fundo azulado */
    border-left: 4px solid var(--accent-color); /* Barra lateral azul */
    padding-left: 8px !important; /* Ajuste visual por causa da borda */
}

/* --- CORRE√á√ÉO DE VISIBILIDADE DO SUPERLINK --- */

#superlink-sentences-list {
    /* Garante que a caixa tem fundo e borda vis√≠veis */
    background-color: #222 !important; 
    border: 1px solid #444 !important;
    display: flex !important;
    flex-direction: column !important;
    padding: 5px !important;
    gap: 2px !important;
}

.sentence-item {
    /* Espa√ßamento interno generoso */
    padding: 15px 12px !important; 
    
    /* Linha divis√≥ria subtil */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    
    /* Cursor de clique */
    cursor: pointer;
    
    /* Tamanho e cor do texto */
    font-size: 0.95em !important;
    line-height: 1.6 !important; /* Altura de linha maior para leitura f√°cil */
    color: var(--text-color) !important;
    
    /* Transi√ß√£o suave */
    transition: background 0.2s;
    user-select: none;
    
    /* Garante que o texto quebra e ocupa o espa√ßo */
    white-space: normal !important;
    word-break: break-word !important;
    display: block !important;
    min-height: auto !important; /* Permite crescer */
}

.sentence-item:hover {
    background-color: rgba(255, 255, 255, 0.15) !important;
}

.sentence-item.selected {
    background-color: rgba(74, 144, 226, 0.3) !important; /* Azul forte */
    border-left: 4px solid #4a90e2 !important;
    font-weight: bold !important;
}

/* --- ESTILO 1: LINKS NORMAIS (üîó) - Suavemente Selecionado --- */
a[data-anexo-id] {
    background-color: transparent !important;
    color: inherit !important;        /* Mant√©m a cor do texto original (Branco/Cinza) */
    text-decoration: none !important; /* Remove o sublinhado padr√£o do browser */
    
    /* O Sublinhado Leve e Cinzento Claro */
    border-bottom: 1px solid rgba(200, 200, 200, 0.4) !important;
    
    cursor: pointer;
    transition: all 0.2s ease;
}



/* --- ESTILO 2: SUPERLINKS (üñáÔ∏è) - Levemente Picotado --- */
/* Aplica-se tanto √† Origem (.source) como aos Alvos (.target) */
.superlink-dotted {
    /* Define a linha por baixo */
    border-bottom: 2px dotted var(--accent-color);
    
    /* Configura√ß√µes b√°sicas */
    text-decoration: none !important;
    cursor: alias;
    background-color: transparent !important;
    transition: background-color 0.2s, box-shadow 0.2s;

    /* >>> A CORRE√á√ÉO EST√Å AQUI: <<< */
    display: inline !important;        /* For√ßa a comportar-se como texto, n√£o como caixa */
    width: auto !important;            /* Remove larguras de 100% */
    float: none !important;            /* Garante que n√£o flutua */
}

/* Cor Amarela para a Origem (Pai) */
.superlink-dotted.source {
    border-bottom-color: #f1c40f; 
}

/* Cor Laranja para o Alvo (Filho) */
.superlink-dotted.target {
    border-bottom-color: #e67e22; 
}

/* Hover: Apenas um brilho suave */
.superlink-dotted:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
    border-radius: 3px;
}

/* Estado "Feito" do Card de Anota√ß√£o */
.store-note-card.state-done {
    background-color: rgba(46, 204, 113, 0.15) !important; /* Verde Suave */
    border-color: #2ecc71 !important; /* Borda Verde */
}

/* Opcional: Riscar o t√≠tulo quando feito */
.store-note-card.state-done .store-note-title {
    text-decoration: line-through;
    opacity: 0.7;
}

/* --- SELETOR DE MODO DE CLONAGEM (ESPELHO vs EST√ÅTUA) --- */
.append-mode-selector {
    display: flex;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 2px;
    margin-right: 10px;
}

.append-mode-option {
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
    color: var(--text-muted-color);
    transition: all 0.2s;
    border: 1px solid transparent;
}

/* Estado Ativo */
.append-mode-option.active {
    background-color: var(--panel-color);
    color: var(--text-color);
    border-color: var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    font-weight: bold;
}

/* Estilo Espec√≠fico para Est√°tua (Ativo) */
.append-mode-option[data-value="statue"].active {
    color: #a569bd; /* Roxo M√≠stico */
    border-color: #a569bd;
}

/* --- CARD EST√ÅTUA (VISUAL) --- */
.statue-card-wrapper {
    position: relative;
    border: 1px solid rgba(165, 105, 189, 0.3); /* Borda Roxa Suave */
    background: linear-gradient(145deg, rgba(30, 30, 30, 1) 0%, rgba(40, 35, 45, 1) 100%);
    border-radius: 6px;
    margin: 15px 0;
    padding: 0; /* Padding gerido pelos filhos */
}

/* Indicador Visual de Est√°tua (Icone no canto) */
.statue-card-wrapper::after {
    content: 'üóø';
    position: absolute;
    bottom: 5px;
    right: 5px;
    font-size: 20px;
    opacity: 0.2;
    pointer-events: none;
    filter: grayscale(1);
}

/* Conte√∫do da Est√°tua (Bloqueado) */
.statue-content-lock {
    padding: 10px;
    opacity: 0.8; /* Ligeiramente desvanecido para indicar n√£o edit√°vel */
    user-select: text; /* Permite selecionar texto */
    cursor: default;
    pointer-events: none; /* Bloqueia cliques em links/inputs internos */
}

/* Permite scroll se for muito grande */
.statue-content-lock {
    max-height: 300px;
    overflow-y: auto;
}

/* ============================================================
   CORRE√á√ÉO DE POPUPS FLUTUANTES EM MOBILE (Centraliza√ß√£o For√ßada)
   ============================================================ */
/* ============================================================
   POPUPS FLUTUANTES EM MOBILE (Arrast√°veis + Seguros)
   ============================================================ */
@media (max-width: 768px) {

    /* 1. CONFIGURA√á√ÉO BASE DAS JANELAS */
    .aq-popup-window,
    .redator-popup-window,
    #sat-links-popup {
        /* Tamanho seguro */
        width: 90vw !important;
        max-width: 380px !important;
        height: auto !important;
        max-height: 75vh !important;
        
        /* Posi√ß√£o Inicial (Centrada) - Sem !important no top/left para permitir arrasto */
        position: fixed !important;
        margin: 0 !important;
        
        /* Garante que o conte√∫do n√£o sai para fora */
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important; 
    }

    /* 2. √ÅREA DE ARRASTO (CABE√áALHO) */
    .aq-popup-header,
    .redator-popup-header {
        padding: 15px !important; /* √Årea de toque maior */
        background-color: rgba(255, 255, 255, 0.1) !important; /* Destacar visualmente */
        cursor: move !important; /* Indica que √© arrast√°vel */
    }

    /* 3. CONTE√öDO COM SCROLL INTERNO */
    .aq-popup-content,
    .redator-popup-body {
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch; /* Scroll suave no iPhone */
        flex-grow: 1 !important;
    }

    /* 4. BOT√ÉO FECHAR GRANDE */
    .aq-popup-close,
    .btn-close-popup {
        width: 40px !important;
        height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 20px !important;
        background: rgba(0,0,0,0.2) !important;
        border-radius: 50% !important;
    }
}

/* --- POPUP DE PR√â-VISUALIZA√á√ÉO DE NOTA (OLHO üëÅ) --- */
.ref-preview-popup {
    position: fixed;
    /* Removemos top/left/transform daqui para o JS calcular o centro exato */
    
    width: 400px;
    height: auto;
    max-height: 60vh;
    max-width: 90vw;

    background-color: rgba(30, 30, 35, 0.98) !important; 
    border: 1px solid var(--accent-color) !important;     
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.95) !important; /* Sombra mais forte para destacar */
    border-radius: 8px;
    
    /* Z-Index Supremo Fixo */
    z-index: 2147483650 !important; 
    
    display: flex;
    flex-direction: column;
    overflow: hidden;
    
    /* Sem anima√ß√£o de transform para n√£o bugar a posi√ß√£o inicial */
}

/* Cabe√ßalho de Arrasto */
.ref-preview-header {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    cursor: move;
    user-select: none;
    flex-shrink: 0;
}

.ref-preview-title {
    font-weight: bold;
    color: var(--accent-color);
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Corpo */
.ref-preview-body {
    flex-grow: 1;
    padding: 10px 15px;
    overflow-y: auto;
    color: #e0e0e0;
    font-size: 0.95em;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
    margin: 0;
}

.preview-clean-title {
    font-size: 1.2em;
    font-weight: bold;
    color: #fff;
    margin: 0 0 8px 0;
    padding-bottom: 8px;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
    display: block;
    line-height: 1.2;
}

.preview-clean-text {
    color: #ccc;
    font-size: 0.9em;
}

/* --- AJUSTE MOBILE --- */
@media (max-width: 768px) {
    .ref-preview-popup {
        width: 90vw !important;
        max-width: 90vw !important;
        max-height: 60vh !important;
        /* No mobile for√ßamos o centro via CSS pq n√£o h√° arrasto de rato */
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
    }
}

/* ============================================================
   CORRE√á√ÉO VISUAL DA √ÅRVORE DE T√ìPICOS
   ============================================================ */

/* 1. Item Principal (T√≥pico Pai) */
.list-item.topic-parent-item {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-start !important; /* OBRIGA A FICAR √Ä ESQUERDA */
    text-align: left !important;
    
    /* Encosta √† borda esquerda do painel (apenas 2px de respiro) */
    padding: 8px 2px !important; 
    
    width: 100% !important;
    min-height: 36px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

/* 2. O Contentor Interno (Div que envolve Seta + Texto) */
/* ESTE ERA O PROBLEMA: Estava a centrar o conte√∫do */
.list-item.topic-parent-item > div {
    display: flex !important;
    align-items: center !important;
    
    /* CR√çTICO: Cola os filhos (seta e texto) ao in√≠cio da linha */
    justify-content: flex-start !important; 
    
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* 3. A Seta (√çcone) */
.tree-toggle-icon {
    /* Impede que o flexbox mexa no tamanho */
    flex: 0 0 auto !important; 
    
    /* Tamanho fixo e pequeno */
    width: 20px !important; 
    min-width: 20px !important;
    height: 20px !important;
    
    /* Alinhamento interno da seta */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    /* Margens */
    margin-left: 0 !important;   /* Cola √† esquerda absoluta */
    margin-right: 5px !important; /* Espa√ßo m√≠nimo entre seta e texto */
    
    font-size: 10px !important;
    color: var(--text-muted-color);
    transition: transform 0.2s ease;
}

/* 4. O Texto do T√≥pico */
.list-item.topic-parent-item span:not(.tree-toggle-icon) {
    text-align: left !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-weight: 600 !important;
    flex-grow: 1 !important; /* Ocupa o resto do espa√ßo */
}

/* ============================================================
   SUBT√ìPICOS (FILHOS) - ALINHAMENTO
   ============================================================ */

/* 5. Contentor da Lista de Filhos */
div[id^="subs-"] {
    background-color: rgba(0, 0, 0, 0.2) !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    width: 100% !important;
}

/* 6. Item Filho (Subt√≥pico) */
.list-item.subtopic-item {
    display: flex !important;
    justify-content: flex-start !important; /* Cola √† esquerda */
    align-items: center !important;
    
    /* Indenta√ß√£o: 20px (largura da seta) + 5px (margem) = 25px */
    padding: 6px 5px 6px 25px !important; 
    
    width: 100% !important;
    text-align: left !important;
    min-height: 30px;
    font-size: 13px !important;
    color: #cccccc;
    border-bottom: 1px solid rgba(255, 255, 255, 0.02);
}

/* 7. Texto "(Vazio)" */
div[id^="subs-"] div[style*="font-style:italic"] {
    text-align: left !important;
    padding-left: 25px !important; /* Mesma indenta√ß√£o dos filhos */
    padding-top: 8px !important;
    padding-bottom: 8px !important;
    color: #666 !important;
}


/* ============================================================
   4¬™ COLUNA MOBILE - "AGILE MODE" (Atualizado)
   ============================================================ */
@media (max-width: 768px) {
    
    #references-panel, 
    .notebook-container.references-panel-visible #references-panel,
    #references-panel.aquarium-overlay-mode {
        display: flex !important;
        position: fixed !important;
        
        /* Cola ao fundo e ocupa a largura toda */
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        top: auto !important; 
        
        /* REQUISITO 1: LARGURA TOTAL */
        width: 100% !important; 
        min-width: 100vw !important;
        
        /* REQUISITO 3: SUBIR MAIS (Altura M√°xima) */
        /* Usamos 100dvh para aproveitar o ecr√£ todo sem a barra do browser atrapalhar */
        max-height: 100dvh !important; 
        
        background-color: var(--sidebar-color) !important;
        
        /* Design da "Folha" */
        border: none !important;
        border-top: 1px solid var(--accent-color) !important; 
        border-radius: 20px 20px 0 0 !important;
        
        z-index: 10000 !important; 
        
        /* Anima√ß√£o suave para quando largas o dedo */
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1), height 0.3s cubic-bezier(0.2, 0.9, 0.2, 1);
        
        touch-action: none; 
        box-shadow: 0 -10px 50px rgba(0,0,0,0.8) !important;
    }

    /* Estado Aberto (Inicia nos 60% por padr√£o) */
    .notebook-container.references-panel-visible #references-panel,
    #references-panel.aquarium-overlay-mode {
        transform: translateY(0) !important;
        /* Se n√£o tiver altura definida inline pelo JS, usa esta */
        height: 60vh; 
    }

    /* Remove a anima√ß√£o enquanto arrastas para ser instant√¢neo */
    #references-panel.is-dragging {
        transition: none !important;
    }

    /* Aumenta a √°rea de toque do cabe√ßalho */
   #references-panel .panel-header {
        padding: 25px 20px 15px 20px !important; 
        cursor: grab;
        /* Garante que o header n√£o desaparece se o painel ficar pequeno */
        min-height: 60px; 
    }
    
    /* Indicador Visual de Pega (Tracinho) */
    #references-panel::after {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 5px;
        background-color: rgba(255,255,255,0.3);
        border-radius: 10px;
        pointer-events: none;
    }
}


</style>




</head>
<body>

    <!-- ESCUDO DE CARREGAMENTO INICIAL (√öNICO) -->
<div id="app-loader">
    <div class="loader-content">
        <div class="loader-circle"></div>
        <div class="loader-logo">
            <span class="logo-icon">üìñ</span>
            <span class="logo-text">NotaBook</span>
        </div>
        <p class="loader-status">A validar acesso...</p>
    </div>
</div>

    <div class="notebook-container">
        <!-- PAINEL DA ESQUERDA -->
    <aside id="left-panel">
    <button id="left-panel-toggle-btn" title="Mostrar Painel">‚ò∞</button>
    
    <!-- WRAPPER DE CONTE√öDO (Mant√©m tudo alinhado no topo) -->
    <div class="panel-content">
        
        <!-- 1. Tabs (Note, Lists, Book) -->
        <div class="tabs-container">
            <button class="active" data-tab="note">Note</button>
            <button data-tab="lists">Lists</button>
            <button data-tab="book">Book</button>
        </div>
        
        <hr>
        
        <!-- 2. O Cabe√ßalho com o Seletor (TEM DE ESTAR ANTES DA LISTA) -->
        <div class="panel-header">
            <div id="left-panel-title" class="folder-mode-container">
                <!-- O JavaScript vai preencher isto, mas deixamos o padr√£o aqui -->
                <span class="folder-mode-item active" onclick="window.switchFolderView('local')">Local</span>
                <span class="folder-mode-separator">|</span>
                <span class="folder-mode-item" onclick="window.switchFolderView('shared')">Partilha</span>
                <span class="folder-mode-separator">|</span>
    <span class="folder-mode-item" onclick="window.switchFolderView('pins')">Pins</span>
            </div>
        </div>
        
        <!-- 3. A Lista de Pastas (Ocupa o espa√ßo restante) -->
        <ul id="left-panel-list">
            <!-- Itens da coluna esquerda gerados via JS -->
        </ul>
    </div>

    <!-- 4. Rodap√© (Fixo em baixo) -->
    <div class="panel-footer">
        <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
        <button id="global-search-btn" title="Pesquisa Global">üîé</button>
        <button id="account-btn" title="Minha Conta">üë§</button>
    </div>
</aside>

      <!-- PAINEL DO MEIO -->
     <main id="middle-panel">
    <!-- Cabe√ßalho (Mant√©m-se igual) -->
    <div class="panel-header">
        <button id="back-btn" title="Voltar">‚Üê</button>
        <button id="middle-panel-toggle-btn" title="Expandir/Recolher" style="margin-right: 10px;">‚Üñ</button>
        <h2 id="middle-panel-title">Selecione</h2>
        <button id="add-item-btn" title="Adicionar item">+</button>
    </div>

    <!-- √ÅREA DE CONTE√öDO (VISTAS) -->
    <div id="middle-views-container">
        
        <!-- VISTA 1: PASTAS (Padr√£o) -->
        <ul id="file-list" class="middle-view active">
            <!-- Lista de ficheiros aparece aqui -->
        </ul>

        <!-- VISTA 2: √çNDICE (Estrutura da Nota) -->
        <ul id="note-index-list" class="middle-view" style="display: none;">
            <li class="empty-msg">Nenhuma estrutura detetada.</li>
        </ul>

      <!-- VISTA 3: TEXTOS -->
<div id="note-texts-view" class="middle-view" style="display: none;">
    <!-- O JavaScript vai preencher isto automaticamente -->
</div>

        <!-- VISTA 4: FONTES (Links/Codex das Caixas) -->
        <ul id="note-sources-list" class="middle-view" style="display: none;">
            <li class="empty-msg">Nenhuma fonte vinculada (‚ö°).</li>
        </ul>
    </div>

    <!-- BARRA DE ABAS DO FUNDO -->
    <div class="middle-bottom-tabs">
        <button class="active" data-mid-tab="files" title="Ficheiros">
            <span>üìÇ</span> Pastas
        </button>
        <button data-mid-tab="index" title="Estrutura da Nota">
            <span>‚âî</span> √çndice
        </button>
        <button data-mid-tab="texts" title="Textos B√≠blicos/Outros">
            <span>üìú</span> Textos
        </button>
        <button data-mid-tab="sources" title="Fontes e Refer√™ncias">
            <span>‚ö°</span> Fontes
        </button>
    </div>
</main>

 <!-- PAINEL DA DIREITA - EDITOR -->
      <!-- PAINEL DA DIREITA - EDITOR -->
<section id="right-panel">

    <!-- ECR√É DE BOAS-VINDAS (Placeholder) -->
    <div id="editor-placeholder">
        <div class="placeholder-icon">üìñ</div>
        <h2>Selecione uma nota para come√ßar</h2>
        <p>Ou crie uma nova pasta e uma nota.</p>
    </div>
    
    <!-- √ÅREA DO EDITOR (NOTA NORMAL) -->
    <div id="editor-area" style="display: none; flex-direction: column; height: 100%;">
        
        <!-- √ÅREA DE FERRAMENTAS -->
        <div id="toolbar-container">
            <div id="editor-toolbar">
                
                <!-- √ÅREA DE SCROLL (NO MOBILE) / CONTE√öDO NORMAL (NO PC) -->
                <div class="tools-scroll-container">
                    
                    <!-- GRUPO 1: Formata√ß√£o -->
               <div class="toolbar-group">
    <!-- REMOVIDO O BOT√ÉO B ANTIGO -->
    
    <!-- NOVO BOT√ÉO UNIFICADO (Cor Branca/Texto) -->
    <button data-command="boldBlue" title="Negrito (‚Ä¢‚Ä¢ para Cores)" 
            style="color: var(--text-color); font-weight: bold; position: relative; padding-right: 15px; display: flex; align-items: center; justify-content: center;"> 
        B <span class="dots-trigger">‚Ä¢‚Ä¢</span> 
    </button>
    
    <!-- It√°lico e Sublinhado mant√™m-se iguais -->
    <button data-command="italic" title="It√°lico" style="position: relative; padding-right: 15px; display: flex; align-items: center; justify-content: center;"> 
        <i>I</i> <span class="dots-trigger">‚Ä¢‚Ä¢</span> 
    </button>
    <button data-command="underline" title="Sublinhado"><u>U</u></button>
    <button id="toggle-more-tools-btn" title="Mais Ferramentas" style="font-size: 12px; background-color: rgba(255,255,255,0.1);">‚ñº</button>
</div>
                    
                    <div class="toolbar-separator"></div>
                    
                    <!-- GRUPO 2: A√ß√µes -->
                    <div class="toolbar-group">
                       <button data-action="local-search" title="Pesquisar na Nota (Ctrl+F)">üîç</button>
                        <button data-action="show-attachments" title="Anexos">üìé</button>
                        <button data-command="undo" title="Retroceder">‚Ü©Ô∏è</button>
                        <button data-command="redo" title="Refazer">‚Ü™Ô∏è</button>
                    </div>

                    <div class="toolbar-separator mobile-only"></div>

                    <!-- BARRA SECUND√ÅRIA -->
                    <div id="secondary-toolbar" style="display: none;">
                        
                        <!-- Grupo 3: Estilo e Cor -->
                        <div class="toolbar-group" id="group-style">
                        <select id="editor-zoom" title="Zoom">
    <option value="50%">50%</option>
    <option value="100%" selected>100%</option>
    <option value="110%">110%</option>
    <option value="120%">120%</option>
    <option value="130%">130%</option>
    <option value="140%">140%</option>
    <option value="150%">150%</option>
    <option value="160%">160%</option>
    <option value="180%">180%</option>
</select>
                            <select id="editor-format" title="Estilo" style="width: 90px;">
                                <option value="P" selected>¬∂ Normal</option>
                                <option value="H1">A1 T√≠tulo</option>
                                <option value="H2">A2 T√≠tulo</option>
                                <option value="H3">A3 T√≠tulo</option>
                            </select>
                            <input type="color" data-command="foreColor" title="Cor" style="margin: 0 5px;">
                            
                            <!-- √çcones que se movem no Jornal -->
                            <button data-action="insert-toggle-h2" title="Toggle">‚òÇ</button>
                            <button data-action="make-draggable" title="Arrastar">·Øì</button>
                        </div>
                        
                        <div class="toolbar-separator"></div>

                        <!-- Grupo 4: Widgets Simples -->
                        <div class="toolbar-group" id="group-simple">
                            <button data-action="insert-checkbox" title="Check">‚òëÔ∏è</button>
                            <button data-cmd-sec="insertHorizontalRule" title="Linha">‚Äï</button>
                        </div>

                        <div class="toolbar-separator"></div>

                        <!-- Grupo 4b: Widgets Complexos -->
                        <div class="toolbar-group" id="group-complex">
                            <button data-action="insert-table" title="Tabela">üßÆ</button>
                            <button data-action="insert-date" title="Data">üìÖ</button>
                            <button data-action="insert-timeline" title="Timeline">üå≥</button>
                        </div>

                        <div class="toolbar-separator"></div>

                        <!-- NOVO GRUPO JORNAL (Escondido por padr√£o) -->
                        <div class="toolbar-group" id="group-journal-extras" style="display: none; align-items: center;">
                            <button data-action="insert-2-cols" title="Duas Colunas">‚è∏Ô∏è</button>
                            <div style="width:1px; height:20px; background:var(--border-color); margin:0 6px;"></div>
                            <button data-action="insert-image" title="Imagem">üñºÔ∏è</button>
                            <button data-action="insert-sign" title="Bloco de Racioc√≠nio">ü™ß</button>
                            <button data-action="insert-card" title="Cart√£o Tem√°tico">ü™™</button>
                            <button data-action="insert-cube" title="Cubo">üßä</button>
                        </div>

                        <div class="toolbar-separator" id="sep-journal-extras" style="display: none;"></div>

                        <!-- Grupo 5: Avan√ßado (Fixo) -->
                        <div class="toolbar-group">
                            <button data-action="bible-scan" title="Scanner">üé∞</button>
                            <button id="more-formatting-btn" type="button" data-action="more-formatting" title="Mais Formata√ß√µes" style="font-weight: bold; font-size: 18px;">‚ãÆ</button>
                        </div>
                    </div>
                </div>

                <!-- GRUPO DE NAVEGA√á√ÉO E HIST√ìRICO -->
                <div class="toolbar-history-group">
                    <div style="display:flex; align-items:center; gap: 10px;">
                        <button id="mobile-back-btn" title="Voltar" style="display: none;">‚¨Ö</button>
                        <!-- BOT√ÉO DE VISTAS MOBILE -->
                        <button id="mobile-views-btn" title="Vistas" style="display:none; background:none; border:none; font-size:22px; color:var(--text-color); cursor:pointer;">‚õ∂</button>
                    </div>

                    <span id="save-status-indicator" class="save-status"></span>
                    
                    <div style="display: flex; gap: 5px;">
                        <!-- √çcone do Redator (oculto por padr√£o, aparece em Jornal) -->
                        <button id="btn-insert-redator" data-action="insert-redator" title="Inserir Redator" style="display: none; background:none; border:none; font-size:18px; cursor:pointer;">üìì</button>
                        
                        <button data-action="note-sharing-settings" title="Partilha">üîê</button> 
                        <button data-action="show-topics" title="T√≥picos">üìë</button> 
                        <button data-action="show-history" title="Hist√≥rico">üïí</button>
                    </div>
                </div>
            </div> <!-- FECHO EDITOR TOOLBAR -->
        </div> <!-- FECHO TOOLBAR CONTAINER -->

        <!-- INPUT T√çTULO -->
        <input type="text" id="note-title-input" placeholder="T√≠tulo da nota...">
        
        <!-- EDITOR DE CONTE√öDO -->
        <div id="note-content-editor" contenteditable="true" spellcheck="true"></div>

        <!-- >>> NOVO: PAINEL DE LOADING DE SINCRONIZA√á√ÉO <<< -->
        <div id="editor-sync-overlay">
            <div class="sync-message">
                <div class="spinner" style="width:20px; height:20px; border-width:2px; margin:0;"></div>
                <span>A atualizar conte√∫do...</span>
            </div>
        </div>

    </div>

    <!-- √ÅREA DE ARQUIVO (FEED) -->
  <div id="archive-area" style="display: none; flex-direction: column; height: 100%; position: relative;">
    
    <!-- Navega√ß√£o Mobile (Topo) -->
    <div id="archive-mobile-nav" style="display: none; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--panel-color);">
        <button id="archive-back-btn" style="background: none; border: none; font-size: 22px; color: var(--accent-color); cursor: pointer; padding: 0;">‚¨Ö</button>
        <span style="margin-left: 15px; font-weight: bold; color: var(--text-color);">Arquivo</span>
    </div>

    <!-- 1. T√çTULO DO ARQUIVO (PRIMEIRO ELEMENTO) -->
    <div style="padding: 20px 20px 0 20px;">
        <input type="text" id="archive-title-input" placeholder="T√≠tulo do Arquivo..." 
               style="width: 100%; background: none; border: none; border-bottom: 1px solid var(--border-color); color: var(--text-color); font-size: 2.5em; font-weight: bold; outline: none; padding-bottom: 5px;">
    </div>

    <!-- 2. BARRA DE FERRAMENTAS UNIFICADA (SEGUNDO ELEMENTO - BAIXO DO T√çTULO) -->
 <div id="archive-toolbar" style="position: relative; padding: 0 20px; display: flex; align-items: center; height: 44px; width: 100%; overflow: hidden;">
    
    <!-- 1. ESQUERDA (FLUTUANTE / ABSOLUTA) -->
    <!-- Este elemento est√° "fora" do fluxo. O seu carregamento n√£o afeta nada √† volta. -->
    <div id="collab-bar" style="display: none; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); align-items: center; gap: 8px; height: 20px; z-index: 10;">
        <span style="font-size: 0.65em; color: var(--text-muted-color); text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; white-space: nowrap; line-height: 20px;">ONLINE:</span>
        <div id="active-users-list"></div>
    </div>

    <!-- 2. DIREITA (FIXA) -->
    <!-- margin-left: auto empurra isto para a direita, ignorando a exist√™ncia da esquerda -->
    <div style="display: flex; align-items: center; gap: 12px; margin-left: auto; height: 100%; z-index: 20;">
        
        <span id="archive-save-status" class="save-status" style="margin: 0; font-size: 0.75em; font-style: italic; white-space: nowrap; line-height: 20px;">Guardado</span>
        
        <div style="display: flex; gap: 8px; align-items: center; height: 20px;">
            <button data-action="archive-share" title="Partilha" style="background:none; border:none; cursor:pointer; color:var(--text-muted-color);">üîì</button>
            <button data-action="archive-topics" title="T√≥picos" style="background:none; border:none; cursor:pointer; color:var(--text-muted-color);">üìë</button>
            <button data-action="archive-history" title="Hist√≥rico" style="background:none; border:none; cursor:pointer; color:var(--text-muted-color);">üïí</button>
        </div>
    </div>
</div>

    <!-- 3. ABAS (TERCEIRO ELEMENTO) -->
    <div class="archive-tabs" style="padding: 0 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border-color);">
        <button class="archive-tab-btn active" data-archive-tab="prateleira">Prateleira</button>
        <button class="archive-tab-btn" data-archive-tab="gavet√µes">Gavet√£o</button>
        <button class="archive-tab-btn" data-archive-tab="favoritos">Favoritos</button> 
        <button id="create-post-btn" class="archive-inline-create-btn">+ Post</button>
        <button id="create-drawer-trigger-btn" class="archive-inline-create-btn" style="display: none;">+ Gavet√£o</button>
        <button id="create-separator-btn" class="archive-inline-create-btn" style="display: none; background-color: #2ecc71;">+ Separador</button>
    </div>

    <!-- Feed de Conte√∫do -->
    <div id="archive-feed" style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; display: flex; flex-direction: column; gap: 20px;">
        <!-- Posts inseridos aqui -->
    </div>
</div>
</section>

        <!-- PAINEL DA DIREITA (QUARTA COLUNA) PARA REFER√äNCIAS -->
        <aside id="references-panel">
            <div class="panel-header">
                <h2 id="references-panel-title">Refer√™ncias</h2>
                <button id="references-panel-close-btn" title="Fechar">√ó</button>
            </div>
            
            <p id="references-panel-description"></p>
            
            <hr class="references-separator">
            <div id="references-toolbar">
                <button id="references-refresh-btn" title="Atualizar">üîÑ</button>
                <button id="references-wol-btn" title="Ler na WOL" style="display: none;">üìñ</button>
                <button id="references-search-btn" title="Pesquisar na JW">üîç</button>
                 <button id="references-anchor-btn" title="Anexar √Çncora" style="display: none;">‚öì</button>
                <button id="references-edit-btn" title="Editar">‚úèÔ∏è</button>
                <button id="references-bookmark-btn" title="Marcadores" style="display: none;">üîñ</button> 
                <button id="references-toggle-btn" title="Expandir/Recolher">‚ÜïÔ∏è</button>
            </div>
            <hr class="references-separator">

       <div class="tabs-container" id="ref-tabs">
                <button class="active" data-ref-tab="puzzle">üß© Puzzle</button>
                <button data-ref-tab="links">‚ö° Links</button>
                <button data-ref-tab="dossie">üìº Dossi√©</button>
                <button data-ref-tab="references">‚ùù Cita</button>
            </div>

            <!-- ABA 1: PUZZLE (QUADRO) -->
            <div id="ref-content-puzzle" class="ref-tab-content active" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 0 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Quadro</h3>
                    <div id="puzzle-header-actions" style="display:flex; gap: 5px; align-items: center;">
                        <div id="puzzle-add-buttons" style="display:none; gap:5px;">
                            <button id="teleport-puzzle-btn" title="Converter em Nota" style="background-color: #8e44ad; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">üì°</button>    
                            <button id="add-text-btn" title="Adicionar Texto" style="background-color: #3498db; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; display: flex; align-items: center;">+ Txt</button>
                            <button id="add-ref-btn" title="Adicionar Refer√™ncia Existente" style="background-color: #2ecc71; border: none; color: white; border-radius: 4px; padding: 0 10px; height: 30px; cursor: pointer; font-weight: bold; font-size: 13px; white-space: nowrap; display: flex; align-items: center;">+ Ref</button>
                        </div>
                        <button id="toggle-puzzle-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>

                <div id="puzzle-board-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;">
                    <p id="puzzle-empty-msg" style="font-style:italic; color:var(--text-muted-color); font-size:0.9em; text-align:center;">
                        O quadro est√° vazio. Clique em "Editar" para adicionar notas ou refer√™ncias.
                    </p>
                </div>
            </div>

            <!-- ABA 2: DOSSI√â (MICAS) -->
            <div id="ref-content-dossie" class="ref-tab-content" style="display: none; flex-direction: column; padding: 0 10px; flex-grow: 1; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 id="dossie-view-title" style="color:var(--text-color); margin:0; font-size: 1.1em;">Micas</h3>
                    <div style="display:flex; gap: 5px; align-items: center;">
                        <button id="mica-back-btn" class="panel-action-btn-styled" style="display:none; background-color: var(--hover-color); color: var(--text-color); border: 1px solid var(--border-color); height:30px;">Back</button>
                       <button id="mica-add-bible-btn" class="panel-action-btn-styled" style="display:none; background-color: #5d4037; color: white; height:30px;">+B√≠blia</button>
                        <button id="mica-add-content-btn" class="panel-action-btn-styled btn-green" style="display:none; height:30px;">+ Add</button>
                        <div id="dossie-edit-actions" style="display:none;">
                            <button id="add-mica-btn" class="panel-action-btn-styled btn-orange-dark" style="height:30px;">+ Micas</button>
                        </div>
                        <button id="toggle-dossie-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>
                <div id="dossie-list-container" style="display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;"></div>
            </div>

            <!-- ABA 3: CITA (REFER√äNCIAS) -->
            <div id="ref-content-references" class="ref-tab-content" style="flex-grow: 1; overflow-y: auto; display: none;">
                <ul id="references-list"></ul>
            </div>

            <!-- ABA 4: LINKS (DOC.) -->
            <div id="ref-content-links" class="ref-tab-content" style="display: none; flex-direction: column; padding: 0 10px; flex-grow: 1; overflow-y: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; margin-top: 10px;">
                    <h3 style="color:var(--text-color); margin:0; font-size: 1.1em;">Doc.</h3>
                    <div style="display:flex; gap: 5px; align-items: center;">
                        <div id="links-edit-actions" style="display:none; gap:5px;">
                            <button onclick="window.openPanelLinkCreator('link')" class="panel-action-btn-styled btn-brown">+ Link</button>
                            <button onclick="window.openPanelLinkCreator('codex')" class="panel-action-btn-styled btn-orange-dark">+ Codex</button>
                        </div>
                        <button id="toggle-links-edit-btn" class="ref-panel-edit-btn">Editar</button>
                    </div>
                </div>
                <div id="panel-links-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </aside>

    </div> 

    <!-- MODAIS E POPUPS GLOBAIS -->
    <div id="post-type-popup" class="modal-overlay" style="z-index: 2100;">
        <div class="modal-content" style="max-width: 300px; text-align: center;">
            <h3>Novo Post</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <button class="modal-btn" id="gen-text-btn" style="padding: 15px; text-align: left;">üìù Gerar Texto</button>
                <button class="modal-btn" id="gen-entity-btn" style="padding: 15px; text-align: left;">üõ∏ Gerar Entidade</button>
            </div>
            <button class="modal-btn secondary" onclick="document.getElementById('post-type-popup').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="entity-type-popup" class="modal-overlay" style="z-index: 2200;">
        <div class="modal-content" style="max-width: 300px;">
            <h3>Escolher Entidade</h3>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                <button class="modal-btn" onclick="createArchiveEntity('subnota')">üìò Subnota</button>
                <button class="modal-btn" onclick="createArchiveEntity('question')">üìó Quest√£o</button>
                <button class="modal-btn" onclick="createArchiveEntity('free')">üìô Contentor</button>
                <button class="modal-btn" onclick="createArchiveEntity('toggle')">‚òÇ T√≠tulo Toggle</button>
                <button class="modal-btn" onclick="createArchiveEntity('depot')">üèóÔ∏è Grua de Refer√™ncias</button>
            </div>
            <button class="modal-btn secondary" onclick="document.getElementById('entity-type-popup').style.display='none'">Cancelar</button>
        </div>
    </div>

 <div id="puzzle-ref-selection-modal" class="modal-overlay" style="z-index: 2300;">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3>Escolher Refer√™ncia</h3>
        <p style="font-size:0.9em; color:var(--text-muted-color); margin-bottom:10px;">Selecione uma ocorr√™ncia para adicionar ao Quadro:</p>
        <ul id="puzzle-ref-selection-list" class="move-list" style="flex-grow: 1; overflow-y: auto;"></ul>
        <div class="modal-actions" style="margin-top: 15px;">
            <!-- ATUALIZA√á√ÉO DO ONCLICK AQUI -->
            <button class="modal-btn secondary" onclick="
                document.getElementById('puzzle-ref-selection-modal').style.display='none'; 
                const preview = document.getElementById('ref-preview-popup'); 
                if(preview) preview.remove();
            ">Cancelar</button>
        </div>
    </div>
</div>

<div id="selection-popup" style="display: none; position: absolute; z-index: 1010;">
    <!-- Links -->
    <button data-action="create-link" title="Criar/Editar Link">üîó</button>
    <!-- REMOVIDO: <button data-action="break-link" title="Remover Link">‚õìÔ∏è‚Äçüí•</button> -->
    
    <!-- NOVOS BOT√ïES DE FORMATA√á√ÉO -->
    <button data-action="quick-bold" title="Negrito Branco" style="font-weight:bold;">B</button>
    <button data-action="quick-h1" title="T√≠tulo A1" style="font-weight:bold; font-size: 0.9em;">A1</button>
    <button data-action="quick-h2" title="T√≠tulo A2" style="font-weight:bold; font-size: 0.8em;">A2</button>
    
    <div class="popup-separator"></div>
    
    <!-- Ferramentas Especiais -->
    <button data-action="highlight" title="Criar Post-it">üìí</button>
    <button data-action="create-idea" title="Converter em Ideia">üí°</button>
    <button data-action="create-url-card" title="Criar Cart√£o Web">üé¥</button>
</div>

  <div id="insertion-popup" style="display: none; position: absolute; z-index: 1010;">
    <button data-action="quick-mini-note" title="Inserir Mini-Nota">üìò</button>
    <button data-action="insert-question" title="Inserir Quest√£o">üìó</button>
    <button data-action="insert-free-container" title="Inserir Contentor Livre">üìô</button>
    <button id="popup-btn-redator" data-action="insert-redator" title="Inserir Redator" style="display: none;">üìì</button>
    <div class="popup-separator"></div>
    <button data-action="quick-placeholder" title="Inserir Post-it">üìí</button>
    <button id="popup-btn-sign" data-action="insert-sign" title="Inserir Racioc√≠nio" style="display: none;">ü™ß</button>
</div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Adicionar Item</h3>
            <div id="add-item-options">
                 <button data-type="pasta">üìÅ Criar Pasta</button>
                 <button data-type="nota">üìÑ Criar Nota</button>
                 <button data-type="agregacao">üß¨ Criar Agrega√ß√£o</button>
                 <button data-type="arquivo">üóÑÔ∏è Criar Arquivo</button>
                 <button data-type="jornal">üì∞ Criar Jornal</button>
                  <button data-type="aquario">ü™∏ Criar Aqu√°rio</button>
            </div>
            <input type="text" id="new-item-name" placeholder="Nome do item" style="display: none;">
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-item-addition" style="display: none;">Criar</button>
            </div>
        </div>
    </div>

 <div id="context-menu" class="context-menu">
    <div class="context-menu-grid">
        <!-- GRUPO 1: Identidade -->
        <button data-action="rename">Mudar Nome</button>
        <button data-action="toggle-pin">Adicionar Pin</button>
        <button data-action="protect">Proteger</button>
        <button data-action="unprotect" style="display:none;">Tirar Prote√ß√£o</button>
        
        <hr class="menu-sep">
        
        <!-- GRUPO 2: Organiza√ß√£o -->
        <button data-action="move-position">Mover Posi√ß√£o</button>
        <button data-action="move-folder">Mover de Pasta</button>
        
        <hr class="menu-sep">
        
        <!-- GRUPO 3: Atribui√ß√µes -->
        <button data-action="manage-topics">Anexar T√≥pico</button>
        <button data-action="toggle-superfolder">Superpasta</button>
        <button data-action="change-icon" style="display: none;">Mudar Icon</button>
        
        <hr class="menu-sep">
        
        <!-- GRUPO 4: Perigo -->
        <button data-action="hide" style="color: #e74c3c;">Ocultar Item</button>
        <button class="context-menu-close" onclick="hideContextMenu()">Cancelar</button>
    </div>
</div>

    <div id="move-to-folder-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover para a Pasta</h3>
            <p>Selecione a pasta de destino para "<span id="item-to-move-name"></span>".</p>
            <div id="move-modal-current-path"></div>
            <ul id="folder-selection-list" class="move-list" style="max-height: 50vh;"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="confirm-folder-move">Mover</button>
            </div>
        </div>
    </div>

    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Mover Item</h3>
            <ul id="move-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="save-order">Salvar Ordem</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-title">Voc√™ tem certeza?</h3>
            <p id="confirm-message">Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" data-action="confirm">Confirmar</button>
            </div>
        </div>
    </div>




    <!-- MODAL DE CONFIGURA√á√ïES -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal-content settings-expanded">
        <!-- Cabe√ßalho com T√≠tulo e Bot√£o X -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
            <h3 style="margin: 0;">Configura√ß√µes</h3>
            <button data-action="cancel" style="background: none; border: none; color: var(--text-muted-color); font-size: 28px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- √Årea de Conte√∫do com Scroll -->
        <div class="modal-scroll-area">
            <button class="modal-btn primary" data-action="show-hidden-items" style="width: 100%; margin-bottom: 20px;">
                Ver Pastas Ocultas
            </button>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
            
            <h4 style="margin-bottom: 10px; color: var(--accent-color);">Privacidade & Pesquisa</h4>
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
                Defina se os itens protegidos com palavra-passe devem aparecer no Painel de Refer√™ncias.
            </p>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-tags">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>Tags</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-topics">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>T√≥picos</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-search-anchors">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>√Çncoras</strong> em Protegidos</span>
            </div>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-global-search-superfolder">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Pesquisar <strong>Globalmente</strong> dentro de Superpastas</span>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 15px;">
            <h4 style="margin-bottom: 10px; color: var(--accent-color);">T√≠tulos Entidades</h4>
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">
                Permite que os t√≠tulos de Quest√µes e Subnotas ocupem v√°rias linhas se o texto for grande.
            </p>

            <div class="setting-toggle-container">
                <label class="setting-switch">
                    <input type="checkbox" id="setting-full-titles">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label">Mostrar T√≠tulo Completo de Entidade</span>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel" style="width: 100%;">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL MINHA CONTA -->
<div id="account-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Minha Conta</h3>
        
        <div class="profile-info">
            <span class="profile-avatar">üë§</span>
            <span id="profile-name-display" class="profile-name">Carregando...</span>
            <span id="profile-email-display" class="profile-email">...</span>
        </div>

        <button class="modal-btn secondary" id="logout-btn" style="width: 100%; background-color: #c0392b; color: white;">
            Sair da Conta (Logout)
        </button>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

    <!-- MODAL DE ITENS OCULTOS -->
    <div id="hidden-items-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Itens Ocultos</h3>
            <ul id="hidden-items-list" class="move-list"></ul>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAR/EDITAR LINK (ANEXO) -->
<div id="link-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 650px; width: 95%;">
        <h3 id="link-modal-title">Gest√£o de Fontes</h3>
        
        <!-- ABAS ATUALIZADAS -->
        <div class="tabs-container" id="box-link-tabs" style="margin-top: 15px;">
            <button class="active" data-box-tab="refs">Refer√™ncias</button>
            <button data-box-tab="codex">Codex</button>
            <button data-box-tab="categories">Categorias</button> <!-- NOVA ABA -->
        </div>

        <!-- CONTE√öDO ABA REFER√äNCIAS -->
        <div id="box-content-refs" class="box-tab-content">
            <div style="margin-top: 15px;">
                <label style="font-size: 0.85em; color: var(--text-muted-color);">T√≠tulo do Grupo</label>
                <input type="text" id="link-title-input" placeholder="T√≠tulo do anexo">
                <div id="link-urls-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; mt: 10px;"></div>
                <button id="add-url-btn" class="modal-btn" style="width: 100%; background-color: var(--hover-color); text-align: center;">+ Adicionar URL</button>
            </div>
        </div>

        <!-- CONTE√öDO ABA CODEX -->
        <div id="box-content-codex" class="box-tab-content" style="display: none; margin-top: 15px;">
            <div id="codex-rows-container" style="display: flex; flex-direction: column; gap: 15px; max-height: 40vh; overflow-y: auto; padding-right: 5px;"></div>
            <button id="add-codex-row-btn" class="modal-btn" onclick="window.createCodexRow()" style="width: 100%; margin-top: 10px; border: 1px dashed var(--accent-color); color: var(--accent-color);">+ Adicionar Nova Linha Codex</button>
        </div>

        <!-- NOVA ABA: CONTE√öDO CATEGORIAS -->
    <div id="box-content-categories" class="box-tab-content" style="display: none; margin-top: 15px;">
    <input type="text" id="category-search-input" placeholder="Pesquisar categoria..." 
           style="width: 100%; padding: 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: white;">
    
    <!-- NOVO: Toggle Procurar na B√≠blia -->
    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 0 5px;">
        <label class="setting-switch">
            <input type="checkbox" id="search-bible-toggle">
            <span class="slider round"></span>
        </label>
        <span style="font-size: 0.85em; color: var(--text-muted-color);">Procurar na B√≠blia (Biblioteca Global)</span>
    </div>
    
    <div id="category-search-results" style="max-height: 200px; overflow-y: auto; margin-top: 10px; border-bottom: 1px solid var(--border-color);"></div>
            
            <div style="margin-top: 15px;">
                <label style="font-size: 0.85em; color: var(--text-muted-color); text-transform: uppercase; font-weight: bold;">Categorias Anexadas:</label>
                <div id="attached-categories-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; min-height: 40px;">
                    <!-- Chips das categorias aparecer√£o aqui -->
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="modal-btn" id="link-remove-btn" style="background-color: #c0392b; color: white; display: none;">Limpar Tudo</button>
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="link-save-btn">Gravar</button>
        </div>
    </div>
</div>

    <!-- MODAL PARA CRIAR ENTIDADE (Local, Personagem, Data) -->
    <div id="entity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="entity-modal-title">Criar Entidade</h3>
            <input type="text" id="entity-name-input" placeholder="Nome">
            <textarea id="entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 80px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
            <p id="entity-error-message" style="color: #e74c3c; display: none;">J√° existe uma entidade com este nome.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
                <button class="modal-btn primary" id="entity-save-btn">Gravar</button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA LISTAS (Tags, Anexos, etc.) -->
    <div id="generic-list-modal" class="modal-overlay">
    <div id="generic-list-modal-content" class="modal-content">
        <h3 id="generic-list-title">Lista</h3>
        <ul id="generic-list-content" class="move-list" style="max-height: 60vh;">
            <!-- O conte√∫do ser√° preenchido via JavaScript -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>
    <!-- MODAL DE √ÇNCORAS COM ABAS -->
   <div id="anchors-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; display: flex; flex-direction: column; max-height: 85vh;">
        <h3 id="explorer-title">Pesquisa Global</h3>
        
        <div id="anchors-content-container" style="flex-grow: 1; overflow-y: auto; margin-top: 15px;">
            <!-- Onde a pesquisa ou os filtros aparecer√£o -->
        </div>

  <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; align-items: center; justify-content: flex-end;">
    
    <!-- Bot√£o Filtros -->
    <button id="toggle-search-filters-btn" class="modal-btn secondary">‚öôÔ∏è Filtros</button>
    <!-- Bot√£o Escopo (Aparece via JS) -->
    <button id="search-scope-btn" title="Alternar escopo de pesquisa">
        <span>No Par√°grafo</span>
    </button>
    <div style="flex-grow: 1;"></div> <!-- Empurra o bot√£o Fechar para a direita -->
    <button class="modal-btn secondary" data-action="cancel">Fechar</button>
</div>



    <!-- MODAL PARA EDITAR ENTIDADE -->
<div id="edit-entity-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="edit-entity-title">Editar Entidade</h3>
        <input type="text" id="edit-entity-name-input" placeholder="Nome da entidade">
        
        <!-- NOVO: Sec√ß√£o de Emoji exclusiva para Subtemas -->
        <div id="edit-emoji-container" style="display: none; margin-bottom: 20px;">
    <label style="display:block; margin-bottom:10px; font-size: 0.85em; color: var(--text-muted-color);">Mudar Emoji:</label>
    <input type="text" id="edit-emoji-input" maxlength="5" 
           style="width: 70px; height: 70px; text-align: center; font-size: 35px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; color: white; outline: none; transition: border-color 0.2s;"
           onfocus="this.style.borderColor='var(--accent-color)'" 
           onblur="this.style.borderColor='var(--border-color)'">
</div>

        <textarea id="edit-entity-description-input" placeholder="Descri√ß√£o (opcional)" style="width: 100%; min-height: 120px; margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="edit-entity-save-btn">Gravar Altera√ß√µes</button>
        </div>
    </div>
</div>


    <!-- POPUP DE SUGEST√ÉO DE TAGS (escondido por padr√£o) -->
<div id="tag-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="tag-suggestion-list" class="suggestion-list"></ul>
</div>

<!-- POPUP DE SUGEST√ÉO DE ENTIDADES (escondido por padr√£o) -->
<div id="entity-suggestion-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020;">
    <ul id="entity-suggestion-list" class="suggestion-list"></ul>
</div>


<!-- NOVO MODAL DE HIST√ìRICO ORGANIZADO POR ABAS -->
<div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        <h3 id="history-modal-title">Gest√£o da Nota</h3>
        
        <!-- Sistema de Abas Interno -->
        <div class="tabs-container" id="history-tabs" style="margin-top: 15px;">
            <button class="active" data-hist-tab="backup">Backup</button>
            <button data-hist-tab="recycling">Reciclagem</button>
            <button data-hist-tab="timeline">Hist√≥rico</button>
        </div>

        <div id="history-tab-content" style="flex-grow: 1; overflow-y: auto; margin-top: 15px; padding-right: 5px;">
            
            <!-- ABA 1: BACKUP -->
            <div id="hist-content-backup" class="hist-tab-div">
                <button id="backup-now-btn" class="modal-btn primary" style="width: 100%; margin-bottom: 20px;">
                    Fazer backup do estado atual
                </button>
                <ul id="history-list-backups" class="move-list">
                    <!-- Backups Manuais e de Emerg√™ncia aqui -->
                </ul>
            </div>

            <!-- ABA 2: RECICLAGEM -->
            <div id="hist-content-recycling" class="hist-tab-div" style="display: none;">
                <h4 style="color: var(--text-muted-color); margin-bottom: 10px;">Itens Ocultos (Caixas Apagadas)</h4>
                <ul id="history-list-recycling" class="move-list">
                    <!-- Itens de subnotasocultas aqui -->
                </ul>
            </div>

            <!-- ABA 3: LINHA DO TEMPO (HIST√ìRICO) -->
            <div id="hist-content-timeline" class="hist-tab-div" style="display: none;">
                <div id="note-creation-info" style="margin-bottom: 20px; padding: 10px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                    <!-- Data de cria√ß√£o da nota principal -->
                </div>
                <h4 style="font-size: 0.9em; text-transform: uppercase; color: var(--accent-color); margin-bottom: 10px;">Cria√ß√£o de Blocos:</h4>
                <ul id="history-list-timeline" class="move-list">
                    <!-- Timeline das caixas extra√≠da do DOM -->
                </ul>
            </div>

        </div>

        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VER O CONTE√öDO DO BACKUP -->
<div id="view-backup-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 80vw; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 id="view-backup-title">Visualizando Backup</h3>
        <div id="view-backup-content" style="background-color: var(--bg-color); padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
            <!-- Conte√∫do do backup aqui -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA VISUALIZAR LINK -->
<div id="view-link-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="view-link-title">Visualizar Anexo</h3>
        <ul id="view-link-urls-list" class="move-list" style="margin-top: 20px; margin-bottom: 20px; max-height: 40vh;">
            <!-- URLs ser√£o preenchidas via JS -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn primary" id="view-link-edit-btn">Editar</button>
        </div>
    </div>
</div>

<!-- MODAL PRINCIPAL: SELE√á√ÉO DE T√ìPICOS -->
<div id="topics-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="topics-modal-title">Gest√£o da Nota</h3>
            <!-- Este bot√£o "+" adapta-se via JS (Azul para T√≥picos, Verde para √Çncoras, Amarelo para Tags) -->
            <button id="manage-topics-btn" title="Criar Item" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer;">+</button>
        </div>
        
        <!-- ABAS DE NAVEGA√á√ÉO -->
        <div class="tabs-container" id="topics-modal-tabs" style="margin-bottom: 15px;">
            <button class="active" data-tab="topics">üìë T√≥picos</button>
            <button data-tab="anchors">‚öì √Çncoras</button>
            <button data-tab="autolink">üè∑Ô∏è Tags</button>
        </div>

        <!-- CONTE√öDO 1: T√ìPICOS -->
        <div id="tm-content-topics" class="tm-tab-content" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;">
            <div class="topics-layout" style="flex-grow: 1; overflow: hidden;">
                <!-- Coluna da Esquerda: Lista de T√≥picos -->
                <div class="topics-column">
                    <h4>T√≥picos</h4>
                    <ul id="topics-list-select" class="topics-list"></ul>
                </div>
                <!-- Coluna da Direita: Lista de Subt√≥picos -->
                <div class="topics-column">
                    <h4 id="subtopics-title-select">Subt√≥picos</h4>
                    <ul id="subtopics-list-select" class="topics-list">
                        <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CONTE√öDO 2: √ÇNCORAS -->
        <div id="tm-content-anchors" class="tm-tab-content" style="display: none; flex-direction: column; flex-grow: 1; overflow: hidden;">
            
            <!-- Barra de Pesquisa -->
            <div style="margin-bottom: 10px;">
                <input type="text" id="anchor-search-input" placeholder="Pesquisar √¢ncoras..." 
                       style="width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px;">
            </div>

            <!-- Lista de √Çncoras -->
            <div class="topics-column" style="width: 100%; flex-grow: 1; display: flex; flex-direction: column;">
                <ul id="note-anchors-list" class="topics-list" style="flex-grow: 1; overflow-y: auto;">
                    <!-- Preenchido via JS -->
                </ul>
                <button id="load-more-anchors-btn" class="modal-btn secondary" style="width: 100%; margin-top: 10px; display: none;">Carregar mais 30 itens</button>
            </div>
        </div>

        <!-- CONTE√öDO 3: AUTO-LINKER (TAGS) - NOVO E LIMPO -->
        <div id="tm-content-autolink" class="tm-tab-content" style="display: none; flex-direction: column; flex-grow: 1; overflow: hidden;">
            
            <!-- Barra de A√ß√£o Minimalista -->
            <div style="padding: 5px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; background: rgba(255,255,255,0.02); margin-bottom: 10px; border-radius: 4px;">
                <button id="run-auto-linker-btn" class="modal-btn" style="background: transparent; border: 1px solid var(--text-muted-color); color: var(--text-muted-color); padding: 4px 15px; font-size: 0.85em; border-radius: 20px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-color)'; this.style.color='var(--accent-color)'" onmouseout="this.style.borderColor='var(--text-muted-color)'; this.style.color='var(--text-muted-color)'">
                    ‚ú® Verificar Texto
                </button>
            </div>

            <h4 style="margin: 0 0 5px 5px; font-size: 0.75em; color: var(--accent-color); text-transform: uppercase; letter-spacing: 0.5px;">Sugest√µes Encontradas</h4>
            
            <div class="topics-column" style="width: 100%; flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-color); border: 1px solid var(--border-color);">
                <ul id="auto-linker-results" class="topics-list" style="flex-grow: 1; overflow-y: auto;">
                    <li style="padding: 20px; text-align: center; color: var(--text-muted-color); font-style: italic; font-size: 0.9em;">
                        Clique em "Verificar" para analisar.
                    </li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="save-topics-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- MODAL SECUND√ÅRIO: CRIA√á√ÉO DE T√ìPICOS (GEST√ÉO) -->
<div id="manage-topics-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
        <div style="margin-bottom: 15px;">
            <h3>Criar T√≥picos e Subt√≥picos</h3>
            <p style="font-size: 0.9em; color: var(--text-muted-color);">Adicione novos itens √† base de dados global.</p>
        </div>

        <div class="topics-layout">
            <!-- Coluna da Esquerda: Gerir T√≥picos -->
            <div class="topics-column">
                <button id="create-new-topic-btn" class="create-btn">+ Criar Novo T√≥pico</button>
                <input type="text" id="search-topic-input" placeholder="Filtrar t√≥picos..." class="topic-search-input">
                <ul id="topics-list-manage" class="topics-list"></ul>
            </div>
            <!-- Coluna da Direita: Gerir Subt√≥picos -->
            <div class="topics-column">
                <button id="create-new-subtopic-btn" class="create-btn" style="display: none;">+ Criar Novo Subt√≥pico</button>
                <ul id="subtopics-list-manage" class="topics-list">
                    <li style="color: var(--text-muted-color); font-style: italic; padding: 10px;">Selecione um t√≥pico para adicionar subt√≥picos.</li>
                </ul>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" id="close-manage-topics-btn">Voltar</button>
        </div>
    </div>
</div>

<!-- MODAL DE INPUT DUPLO (Nome + Descri√ß√£o) -->
<div id="custom-input-modal" class="modal-overlay" style="z-index: 1200;">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="custom-input-title">Novo Item</h3>
        
        <!-- Campo Nome -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Nome</label>
        <input type="text" id="custom-input-name" placeholder="Escreva o nome aqui..." 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <!-- Campo Descri√ß√£o (Novo) -->
        <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--text-muted-color);">Descri√ß√£o <small>(Opcional)</small></label>
        <textarea id="custom-input-desc" placeholder="Detalhes adicionais..." 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none; font-family: inherit;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="custom-input-cancel">Cancelar</button>
            <button class="modal-btn primary" id="custom-input-confirm">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE PALAVRA-PASSE -->
<div id="password-modal" class="modal-overlay" style="z-index: 2000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3 id="password-modal-title">Proteger Item</h3>
        <p id="password-modal-desc" style="margin-bottom: 15px; font-size: 0.9em;">Defina uma palavra-passe.</p>
        
       <input type="password" id="password-input" placeholder="Palavra-passe" 
       autocomplete="new-password"
       style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <p id="password-error" style="color: #e74c3c; font-size: 0.9em; display: none; margin-bottom: 10px;">Palavra-passe incorreta.</p>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="password-confirm-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE GEST√ÉO DE MARCADORES (Lista) -->
<div id="bookmarks-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Marcadores</h3>
            <!-- Bot√£o '+' no canto superior direito -->
            <button id="open-create-bookmark-btn" title="Novo Marcador" style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Selecione os marcadores para associar a este texto b√≠blico.
        </p>

        <ul id="bookmarks-list" class="move-list" style="max-height: 50vh;">
            <!-- A lista ser√° preenchida via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL DE CRIA√á√ÉO DE NOVO MARCADOR (Sub-popup) -->
<div id="create-bookmark-modal" class="modal-overlay" style="z-index: 1100;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Novo G√©nero de Marcador</h3>
        
        <input type="text" id="new-bookmark-title" placeholder="T√≠tulo (ex: Profecias)" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="new-bookmark-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-create-bookmark">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-bookmark">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE BLOQUEIO DE GRAVA√á√ÉO -->
<div id="forcing-save-modal" class="modal-overlay" style="z-index: 9999; background-color: rgba(0,0,0,0.85);">
    <div class="modal-content" style="text-align: center; max-width: 300px; border: 1px solid var(--accent-color);">
        <div class="spinner" style="margin: 0 auto 15px auto; border-left-color: var(--accent-color);"></div>
        <h3 style="margin-bottom: 10px; color: white;">A Guardar...</h3>
        <p style="color: var(--text-muted-color); font-size: 0.9em;">Por favor, aguarde enquanto as suas altera√ß√µes s√£o enviadas.</p>
    </div>
</div>

<!-- POPUP DE ESCOLHA DE TAMANHO DO POST-IT -->
<div id="postit-size-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 1020; flex-direction: column; width: 180px; padding: 5px;">
    <button data-size="small" style="text-align:left; width:100%; border-radius:4px; padding:8px; background:none; border:none; color:var(--text-color); cursor:pointer;">‚ñ´Ô∏è Pequeno</button>
    <button data-size="medium" style="text-align:left; width:100%; border-radius:4px; padding:8px; background:none; border:none; color:var(--text-color); cursor:pointer;">‚óªÔ∏è M√©dio</button>
    <button data-size="large" style="text-align:left; width:100%; border-radius:4px; padding:8px; background:none; border:none; color:var(--text-color); cursor:pointer;">‚¨ú Grande</button>
</div>

<!-- POPUP DE A√á√ïES DA IDEIA (‚úÇÔ∏è üß≤) -->
<div id="idea-actions-popup" style="display: none; position: absolute; background: var(--sidebar-color); border: 1px solid var(--border-color); padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; gap: 5px;">
    <button data-action="remove-idea" title="Remover Ideia" style="background:none; border:none; cursor:pointer; font-size:18px;">‚úÇÔ∏è</button>
    <button data-action="append-idea" title="Adicionar a outra nota" style="background:none; border:none; cursor:pointer; font-size:18px;">üß≤</button>
</div>

<!-- MODAL DE SELE√á√ÉO DE NOTA (Para transferir a ideia) -->
<div id="select-note-modal" class="modal-overlay" style="z-index: 2100;">
    <div class="modal-content">
        <h3>Adicionar Ideia a...</h3>
        <p style="font-size:0.9em; color:#888;">Selecione uma nota nesta pasta:</p>
        <ul id="select-note-list" class="move-list" style="max-height: 50vh;"></ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- NOVO MODAL DE DESTAQUES (POPUP CENTRAL) -->
<div id="highlight-modal" class="modal-overlay" style="z-index: 2200;">
    <div class="modal-content" style="max-width: 500px;">
        <h3>Escolher o Marcador</h3>
        <div id="highlight-options-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <!-- As cores ser√£o geradas aqui via JS -->
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- MENU FLUTUANTE PARA TABELAS -->
<div id="table-tools-popup">
    <div style="font-size:0.8em; color:#888; width:100%; text-align:center; padding-bottom:4px;">Tabela</div>
    <button data-action="add-row-above" title="Linha Acima">‚¨ÜÔ∏è Linha</button>
    <button data-action="add-row-below" title="Linha Abaixo">‚¨áÔ∏è Linha</button>
    <button data-action="add-col-left" title="Coluna Esquerda">‚¨ÖÔ∏è Coluna</button>
    <button data-action="add-col-right" title="Coluna Direita">‚û°Ô∏è Coluna</button>
    <div class="sep"></div>
    <button data-action="del-row" title="Apagar Linha" style="color:#e74c3c;">‚ùå Linha</button>
    <button data-action="del-col" title="Apagar Coluna" style="color:#e74c3c;">‚ùå Coluna</button>
    <button data-action="del-table" title="Apagar Tabela Inteira" style="width:100%; border-color:#e74c3c; color:#e74c3c; margin-top:3px;">üóëÔ∏è Apagar Tabela</button>
</div>


<!-- MODAL DE TAREFA DE CALEND√ÅRIO -->
<div id="calendar-task-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Agenda: <span id="cal-selected-date-display"></span></h3>
        <input type="hidden" id="cal-selected-date-iso"> <!-- Guarda YYYY-MM-DD -->
        
        <textarea id="cal-task-desc" placeholder="Descreva a tarefa ou evento..." 
                  style="width: 100%; height: 100px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); margin-bottom: 15px; resize: none;"></textarea>
        
        <!-- Lista de tarefas existentes neste dia -->
        <div id="cal-existing-tasks" style="margin-bottom: 15px; max-height: 100px; overflow-y: auto;"></div>

        <div class="modal-actions">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="cal-save-task-btn">Gravar Tarefa</button>
        </div>
    </div>
</div>

<!-- MODAL DE AGREGA√á√ÉO (SELETOR DE CONTE√öDO) -->
<div id="aggregation-modal" class="modal-overlay" style="z-index: 1500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
        <h3>Criar Agrega√ß√£o: <span id="aggregation-new-name" style="color: var(--accent-color);"></span></h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue pelas pastas e notas. Selecione as caixas que deseja copiar para esta nova nota.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs e Bot√£o Voltar) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="agreg-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="agreg-current-path" style="font-weight: bold; color: var(--text-color);">Pasta Raiz</span>
        </div>

        <!-- Lista de Conte√∫do (Pastas, Notas ou Caixas) -->
        <ul id="aggregation-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px;">
            <!-- Preenchido via JS -->
        </ul>

        <!-- Rodap√© com Contador e Bot√£o Criar -->
        <div class="modal-actions" style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px; align-items: center;">
            <span id="agreg-count" style="margin-right: auto; font-weight: bold; color: var(--accent-color);">0 itens selecionados</span>
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
            <button class="modal-btn primary" id="agreg-finish-btn">Criar Agrega√ß√£o</button>
        </div>
    </div>
</div>

<!-- MODAL DE CLONAR PARA NOTA (DESTINO) -->
<div id="append-to-note-modal" class="modal-overlay" style="z-index: 1600;">
    <div class="modal-content" style="max-width: 500px; height: 70vh; display: flex; flex-direction: column;">
        <h3>Enviar para...</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">
            Navegue e selecione a <strong>Nota</strong> onde deseja colar este conte√∫do.
        </p>

        <!-- Navega√ß√£o (Breadcrumbs) -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <button id="append-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="append-current-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        </div>

        <!-- Lista de Pastas e Notas -->
        <ul id="append-list" class="move-list" style="flex-grow: 1; border: 1px solid var(--border-color); border-radius: 5px; overflow-y: auto;">
            <!-- Preenchido via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 15px;">
            <button class="modal-btn secondary" data-action="cancel">Cancelar</button>
        </div>
    </div>
</div>

<!-- POPUP DE DEFINI√á√ïES DE PARTILHA DA CAIXA -->
<div id="share-settings-popup">
    <h4>Seguran√ßa da Caixa</h4>
    <div class="share-toggle-row">
        <span>Permitir Partilha</span>
        <label class="setting-switch">
            <input type="checkbox" id="mini-note-share-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    <p style="font-size: 0.75em; color: var(--text-muted-color); margin-top: 10px; line-height: 1.3;">
        Se desativado, o conte√∫do n√£o aparecer√° em links p√∫blicos, mesmo que tenham sido gerados anteriormente.
    </p>
</div>

<!-- POPUP DE PARTILHA (AGORA √â UM MODAL CENTRAL) -->
<div id="note-share-popup" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 400px;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;">Partilha</h3>
            <button onclick="document.getElementById('note-share-popup').style.display='none'" style="background:none; border:none; color:var(--text-muted-color); font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <!-- 1. LINK DE LEITURA (Padr√£o) -->
        <div class="share-toggle-row" style="background-color: var(--bg-color); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <span style="font-weight:bold; color: var(--text-color); display:block;">Link de Leitura</span>
                <small style="color:var(--text-muted-color); font-size:0.75em;">P√∫blico (Apenas Ver)</small>
            </div>
            <label class="setting-switch">
                <input type="checkbox" id="note-share-toggle">
                <span class="slider round"></span>
            </label>
        </div>

        <div id="note-share-link-container" style="display: none; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid var(--accent-color);">
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="note-share-url" readonly 
                       style="flex-grow: 1; height: 36px; padding: 0 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); outline: none; font-size: 0.85em;">
                <button onclick="copyLink('note-share-url')" style="height: 36px; padding: 0 15px; background: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; cursor: pointer; font-size: 0.85em;">Copiar</button>
            </div>
        </div>

        <!-- 2. LINK DE COLABORA√á√ÉO (Apenas Arquivos Partilhados) -->
        <div id="archive-collab-section" style="display: none;">
            <div class="share-toggle-row" style="background-color: rgba(231, 76, 60, 0.1); padding: 12px; border-radius: 8px; border: 1px solid #c0392b; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <span style="font-weight:bold; color: #e74c3c; display:block;">Link de Colabora√ß√£o</span>
                    <small style="color:var(--text-muted-color); font-size:0.75em;">Permite Criar/Editar Posts</small>
                </div>
                <label class="setting-switch">
                    <input type="checkbox" id="collab-share-toggle">
                    <span class="slider round" style="background-color: #ccc;"></span>
                </label>
            </div>

            <div id="collab-share-link-container" style="display: none; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid #e74c3c;">
                <p style="font-size:0.8em; color:#e74c3c; margin-bottom:5px;">‚ö†Ô∏è Quem tiver este link poder√° editar o seu Arquivo.</p>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="collab-share-url" readonly 
                           style="flex-grow: 1; height: 36px; padding: 0 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); outline: none; font-size: 0.85em;">
                    <button onclick="copyLink('collab-share-url')" style="height: 36px; padding: 0 15px; background: var(--panel-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; cursor: pointer; font-size: 0.85em;">Copiar</button>
                </div>
            </div>
        </div>

    </div>
</div>




<!-- POPUP DE CORES DO TOGGLE -->
<div id="toggle-color-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 2500; width: 160px; padding: 10px;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
        <!-- As cores ser√£o geradas aqui ou fixas -->
        <button class="color-choice" style="background-color: #ffcdd2;" data-color="#ffcdd2" title="Rosa Suave"></button>
        <button class="color-choice" style="background-color: #ffe0b2;" data-color="#ffe0b2" title="Laranja P√™ssego"></button>
        <button class="color-choice" style="background-color: #fff9c4;" data-color="#fff9c4" title="Amarelo Creme"></button>
        <button class="color-choice" style="background-color: #c8e6c9;" data-color="#c8e6c9" title="Verde Menta"></button>
        <button class="color-choice" style="background-color: #b3e5fc;" data-color="#b3e5fc" title="Azul C√©u"></button>
        <button class="color-choice" style="background-color: #e1bee7;" data-color="#e1bee7" title="Lil√°s"></button>
    </div>
    <div style="margin-top: 8px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 5px;">
        <button class="color-choice-reset" style="background: none; border: none; font-size: 0.8em; color: var(--text-muted-color); cursor: pointer;">Sem Cor</button>
    </div>
</div>

<!-- MODAL DE SCANNER UNIVERSAL (üé∞) -->
<div id="universal-scan-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column; padding: 0;">
        
        <!-- Cabe√ßalho com Abas -->
        <div class="scan-header" style="padding: 15px 15px 0 15px; border-bottom: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 15px;">Detetor de Entidades</h3>
            <div class="scan-tabs">
                <button class="scan-tab-btn active" data-target="textobiblico">üìñ B√≠blia</button>
                <button class="scan-tab-btn" data-target="personagem">üë§ Personagens</button>
                <button class="scan-tab-btn" data-target="local">üìç Locais</button>
                <button class="scan-tab-btn" data-target="data">üìÖ Datas</button>
            </div>
        </div>

        <!-- Corpo das Listas -->
        <div class="scan-body" style="flex-grow: 1; overflow-y: auto; padding: 15px; position: relative;">
            
            <!-- Contentor para as listas (Preenchido via JS) -->
            <div id="scan-lists-container">
                <!-- As listas <ul> ser√£o geradas aqui dinamicamente -->
            </div>

            <!-- POPUP DE PREVIEW (CONTEXTO) -->
            <div id="scan-preview-popup" style="display: none;">
                <div class="preview-header">
                    <strong>Contexto</strong>
                    <button onclick="document.getElementById('scan-preview-popup').style.display='none'">√ó</button>
                </div>
                <div id="scan-preview-content"></div>
            </div>

        </div>

        <!-- Rodap√© -->
        <div class="modal-actions" style="padding: 15px; border-top: 1px solid var(--border-color);">
            <button class="modal-btn secondary" data-action="cancel">Fechar</button>
            <button class="modal-btn secondary" id="scan-toggle-all-btn" style="margin-right: auto;">Selecionar Todos</button>
            <button class="modal-btn primary" id="confirm-scan-btn">Converter Selecionados</button>
        </div>
    </div>
</div>

<!-- Modal de Escolha de √çcone -->
<div id="icon-picker-modal" class="modal-overlay" style="z-index: 2500;">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>Escolher √çcone</h3>
        <p style="color: var(--text-muted-color); margin-bottom: 15px;">Personalize a sua Superpasta.</p>
        
        <!-- Grelha de Emojis -->
        <div id="emoji-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
            <!-- Padr√£o -->
            <button class="emoji-btn" data-icon="üóÉÔ∏è" style="grid-column: span 4; background: var(--panel-color); border: 1px solid var(--accent-color);">üóÉÔ∏è Padr√£o</button>
            
            <!-- Paisagens -->
            <button class="emoji-btn" data-icon="üèûÔ∏è">üèûÔ∏è</button>
            <button class="emoji-btn" data-icon="üåÖ">üåÖ</button>
            <button class="emoji-btn" data-icon="üåÑ">üåÑ</button>
            <button class="emoji-btn" data-icon="üèúÔ∏è">üèúÔ∏è</button>
            
            <!-- Cidades -->
            <button class="emoji-btn" data-icon="üèôÔ∏è">üèôÔ∏è</button>
            <button class="emoji-btn" data-icon="üåá">üåá</button>
            <button class="emoji-btn" data-icon="üåÜ">üåÜ</button>
            <button class="emoji-btn" data-icon="üåÉ">üåÉ</button>
            
            <!-- Noite/C√©u -->
            <button class="emoji-btn" data-icon="üéë">üéë</button>
            <button class="emoji-btn" data-icon="üåå">üåå</button>
            <button class="emoji-btn" data-icon="üå†">üå†</button>
            <button class="emoji-btn" data-icon="üåâ">üåâ</button>
            
            <!-- Fogos/Estrada -->
            <button class="emoji-btn" data-icon="üéÜ">üéÜ</button>
            <button class="emoji-btn" data-icon="üéá">üéá</button>
            <button class="emoji-btn" data-icon="üõ£Ô∏è">üõ£Ô∏è</button>
            <button class="emoji-btn" data-icon="üõ§Ô∏è">üõ§Ô∏è</button>
        </div>

        <button class="modal-btn secondary" onclick="document.getElementById('icon-picker-modal').style.display='none'" style="width: 100%;">Cancelar</button>
    </div>
</div>

<!-- 2. Modal: Selecionar Gavet√£o (Adicione no final do body) -->
<div id="drawer-selection-modal" class="modal-overlay" style="z-index: 2300;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3>Gavet√£o</h3>
            <button id="open-create-drawer-btn" style="background:var(--accent-color); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer;">+</button>
        </div>
        <ul id="drawer-list-select" class="move-list" style="max-height: 300px; overflow-y: auto;">
            <!-- Gavet√µes aqui -->
        </ul>
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('drawer-selection-modal').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<!-- 3. Modal: Criar Gavet√£o (CORRIGIDO) -->
<div id="create-drawer-modal" class="modal-overlay" style="z-index: 99999;">
    <div class="modal-content" style="max-width: 350px;">
        <form onsubmit="return false;" autocomplete="off">
            <h3>Criar Gavet√£o</h3>
            
            <input type="text" id="new-drawer-name" placeholder="Nome do gavet√£o" autocomplete="off" 
                   style="width: 100%; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white;">
            
            <textarea id="new-drawer-desc" placeholder="Descri√ß√£o (opcional)" 
                      style="width:100%; height:80px; margin-top:10px; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; resize: none;"></textarea>
            
            <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="modal-btn secondary" onclick="document.getElementById('create-drawer-modal').style.display='none'">Voltar</button>
                <button type="button" class="modal-btn primary" id="confirm-create-drawer">Criar</button>
            </div>
        </form>
    </div>
</div>


<!-- POPUP DE FORMATA√á√ÉO COLORIDA (PC) -->
<!-- POPUP DE FORMATA√á√ÉO (3 PONTOS) - ATUALIZADO -->
<div id="formatting-popup" class="suggestion-popup" style="display: none; position: absolute; z-index: 3000; width: 180px; padding: 10px; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5);">
    <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
        <button data-action="open-robot" style="width: 40px; height: 40px; font-size: 20px;" title="Exportar Sentinela">ü§ñ</button>
        <button data-action="open-margin-editor" style="width: 40px; height: 40px; font-size: 20px;" title="Editor de Margem">üî¨</button>
        <button data-action="creative-mode" class="pc-only" style="width: 40px; height: 40px; font-size: 20px;" title="Modo Criativo">ü™Å</button>
          <button data-action="insert-ref-depot" style="width: 40px; height: 40px; font-size: 20px;" title="Grua de Refer√™ncias">üèóÔ∏è</button>
    </div>
</div>



<!-- NOVO POPUP PARA O BOT√ÉO B AZUL -->
<div id="bold-palette-popup">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
        <button onclick="applyColorStyle('bold', '#ffff00')" style="color: #ffff00; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#ff4d4d')" style="color: #ff4d4d; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#ffa500')" style="color: #ffa500; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#4dff4d')" style="color: #4dff4d; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#b366ff')" style="color: #b366ff; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
        <button onclick="applyColorStyle('bold', '#4a90e2')" style="color: #4a90e2; font-weight: bold; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px;">B</button>
    </div>
</div>


<!-- POPUP EXCLUSIVO DO BOT√ÉO I (IT√ÅLICO) -->
<div id="italic-palette-popup" style="display: none; position: absolute; z-index: 3000; background-color: var(--sidebar-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); padding: 8px; width: 140px;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
        <button onclick="applyColorStyle('italic', '#ffff00')" style="color: #ffff00; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#ff4d4d')" style="color: #ff4d4d; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#ffa500')" style="color: #ffa500; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#4dff4d')" style="color: #4dff4d; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#4da6ff')" style="color: #4da6ff; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
        <button onclick="applyColorStyle('italic', '#ffffff')" style="color: #ffffff; font-style: italic; background:rgba(255,255,255,0.05); border:1px solid #444; border-radius:4px; padding:6px; cursor:pointer;">I</button>
    </div>
</div>





<!-- MODAL DO ROB√î (CAIXA DE TEXTO) -->
<div id="robot-modal" class="modal-overlay" style="z-index: 3100;">
    <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">ü§ñ Exportar Sentinela</h3>
        
        <!-- √Årea de Colagem -->
        <div id="robot-input-container">
            <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 8px;">Cole aqui o texto do artigo (JW.ORG):</p>
            <textarea id="robot-input-text" placeholder="Cole o conte√∫do aqui..." 
                      style="width: 100%; height: 150px; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 10px; resize: none; outline: none;"></textarea>
            <button class="modal-btn primary" id="robot-generate-btn" style="width: 100%; margin-bottom: 15px;">Gerar Perguntas</button>
        </div>

        <!-- √Årea de Pr√©-visualiza√ß√£o (Escondida inicialmente) -->
        <div id="robot-preview-container" style="display: none; flex-grow: 1; overflow-y: auto; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <h4 id="preview-count" style="color: var(--accent-color); margin-bottom: 10px;">Encontradas 0 perguntas:</h4>
            <ul id="preview-list" style="list-style: none; padding: 0; font-size: 0.9em; color: var(--text-color); opacity: 0.8;">
                <!-- Lista gerada aqui -->
            </ul>
        </div>
        
        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" onclick="document.getElementById('robot-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="robot-insert-btn" style="display: none;">Inserir na Nota</button>
        </div>
    </div>
</div>

<!-- MODAL PARA RENOMEAR DESTAQUE -->
<div id="rename-highlight-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3>Renomear Marcador</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 10px;">Defina um nome personalizado para esta cor:</p>
        
        <input type="text" id="new-highlight-name-input" placeholder="Ex: Importante, Revisar..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-rename-highlight-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-rename-highlight-btn">Gravar</button>
        </div>
    </div>
</div>


<!-- MODAL CRIAR/EDITAR COSMOS -->
<div id="cosmos-modal" class="modal-overlay" style="z-index: 2600;">
    <div class="modal-content" style="max-width: 400px;">
        <h3 id="cosmos-modal-title">Novo Tema/Conceito</h3>
        
        <input type="text" id="cosmos-name-input" placeholder="Nome do Tema" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="cosmos-desc-input" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 15px; resize: none;"></textarea>
        
        <label style="display:block; margin-bottom:10px; font-size: 0.85em; color: var(--text-muted-color);">Escolher Emoji:</label>
        <div id="cosmos-emoji-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
            <button class="emoji-btn" data-emoji="ü¶ñ">ü¶ñ</button>
            <button class="emoji-btn" data-emoji="üå∫">üå∫</button>
            <button class="emoji-btn" data-emoji="üå±">üå±</button>
            <button class="emoji-btn" data-emoji="üß™">üß™</button>
            <button class="emoji-btn" data-emoji="üìú">üìú</button>
            <button class="emoji-btn" data-emoji="üèõÔ∏è">üèõÔ∏è</button>
            <button class="emoji-btn" data-emoji="üìê">üìê</button>
            <button class="emoji-btn" data-emoji="‚òÑÔ∏è">‚òÑÔ∏è</button>
            <button class="emoji-btn" data-emoji="‚öîÔ∏è">‚öîÔ∏è</button>
            <button class="emoji-btn" id="custom-emoji-btn" style="background: var(--panel-color); border: 1px dashed var(--accent-color);">+</button>
        </div>

        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('cosmos-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="save-cosmos-btn">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA EMOJI PERSONALIZADO -->
<div id="custom-emoji-modal" class="modal-overlay" style="z-index: 9000000;">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>Editar Tema</h3>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 15px;">Ajuste o nome e o √≠cone do tema:</p>
        
        <!-- Campo Nome -->
        <input type="text" id="custom-theme-name-input" placeholder="Nome do Tema" 
               style="width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: white; margin-bottom: 15px; outline: none;">

        <!-- Campo Emoji -->
        <label style="display:block; margin-bottom:8px; font-size: 0.75em; text-transform: uppercase; color: var(--text-muted-color);">Emoji / √çcone:</label>
        <input type="text" id="custom-emoji-input" maxlength="5" placeholder="üòä"
               style="width: 80px; height: 80px; text-align: center; font-size: 40px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; color: white; margin: 0 auto 20px auto; outline: none; display: block;">
        
        <div class="modal-actions" style="justify-content: center; gap: 10px;">
            <button class="modal-btn secondary" onclick="document.getElementById('custom-emoji-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-custom-emoji-btn">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL DE SELE√á√ÉO B√çBLICA PARA MICA -->
<div id="mica-bible-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 450px;">
        <h3>Adicionar Texto B√≠blico</h3>
        
        <label class="codex-label">T√≠tulo do Card (Opcional)</label>
        <input type="text" id="bible-card-title" placeholder="Ex: Base para a esperan√ßa" class="codex-input-modern" style="margin-bottom: 15px;">

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div>
                <label class="codex-label">Livro</label>
                <select id="bible-book-select" class="codex-input-modern"></select>
            </div>
            <div>
                <label class="codex-label">Cap√≠tulo</label>
                <select id="bible-chapter-select" class="codex-input-modern"></select>
            </div>
        </div>

        <label class="codex-label">Vers√≠culos</label>
        <div id="verse-inputs-container" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
            <!-- Linhas de vers√≠culos entrar√£o aqui -->
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="add-single-verse-btn" class="modal-btn" style="flex: 1; background: var(--panel-color); border: 1px solid var(--border-color);">+ Vers√≠culo</button>
            <button id="add-range-verse-btn" class="modal-btn" style="flex: 1; background: var(--panel-color); border: 1px solid var(--border-color);">- Intervalo</button>
        </div>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('mica-bible-modal').style.display='none'">Cancelar</button>
            <button id="confirm-mica-bible-save" class="modal-btn primary">Adicionar √† Mica</button>
        </div>
    </div>
</div>

<!-- Popup de Cores das Micas -->
<div id="mica-color-popup" style="display: none;"></div>

<!-- MODAL PARA RENOMEAR ITENS -->
<div id="rename-modal" class="modal-overlay" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3>Mudar Nome</h3>
        <p style="font-size: 0.85em; color: var(--text-muted-color); margin-bottom: 10px;">Insira o novo nome para o item:</p>
        <input type="text" id="rename-input" placeholder="Novo nome..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-rename-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-rename-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- Modal: Criar Gaveta (Interna) -->
<div id="create-gaveta-modal" class="modal-overlay" style="z-index: 9999999 !important;">
    <div class="modal-content" style="max-width: 350px; background-color: var(--sidebar-color); border: 1px solid var(--accent-color);">
        <h3>Nova Gaveta</h3>
        <p style="font-size: 0.8em; color: var(--text-muted-color); margin-bottom: 10px;">Crie uma pasta dentro deste gavet√£o.</p>
        
        <input type="text" id="new-gaveta-name" placeholder="Nome da gaveta" 
               style="width: 100%; padding: 10px; margin-top: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white;">
        
        <textarea id="new-gaveta-desc" placeholder="Descri√ß√£o (opcional)" 
                  style="width:100%; height:80px; margin-top:10px; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; resize: none;"></textarea>
        
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('create-gaveta-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-gaveta">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE ANEXAR LINK/IMAGEM (Para a Caixa de Racioc√≠nio) -->
<div id="attachment-modal" class="modal-overlay" style="z-index: 9999999;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Adicionar Anexo</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Cole o endere√ßo de uma imagem ou p√°gina web:
        </p>
        
        <input type="text" id="attachment-url-input" placeholder="https://..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" id="cancel-attachment-btn">Cancelar</button>
            <button class="modal-btn primary" id="confirm-attachment-btn">Adicionar</button>
        </div>
    </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE LINK (RACIOC√çNIO) -->
<div id="edit-link-modal" class="modal-overlay" style="z-index: 10000000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Editar Link</h3>
        <input type="text" id="edit-link-url-input" placeholder="https://..." 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('edit-link-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-edit-link-btn">Gravar</button>
        </div>
    </div>
</div>


<!-- MODAL DE IMAGEM DO CART√ÉO -->
<div id="card-image-modal" class="modal-overlay" style="z-index: 10000000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Definir Imagem</h3>
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Cole o link da imagem (URL):
        </p>
        
        <input type="text" id="card-image-url-input" placeholder="https://exemplo.com/foto.jpg" 
               style="width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 20px;">
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('card-image-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-card-image-btn">Confirmar</button>
        </div>
    </div>
</div>



<!-- MODAL DE FOCO DO REDATOR -->
<div id="redator-focus-modal" class="modal-overlay" style="z-index: 100000;">
    <div class="modal-content" style="max-width: 800px; width: 90%; height: 80vh; background: #1a1a1d; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;">
        
        <div style="display: flex; justify-content: flex-end; padding-bottom: 10px;">
            <button class="modal-btn secondary" onclick="closeRedatorFocus()">Fechar & Gravar</button>
        </div>

        <!-- Onde o Redator ser√° clonado -->
        <div id="redator-focus-container" style="flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <!-- O Redator aparecer√° aqui -->
        </div>
    </div>
</div>


<!-- MODAL DE VISTAS MOBILE (Pastas, √çndice, Textos, Fontes) -->
<div id="mobile-views-modal" class="modal-overlay" style="z-index: 20000;">
    <div class="modal-content" style="width: 95%; height: 80vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background-color: var(--panel-color);">
        
        <!-- Cabe√ßalho do Modal -->
        <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--sidebar-color);">
            <h3 id="mobile-views-title" style="margin: 0;">√çndice</h3>
            <button onclick="document.getElementById('mobile-views-modal').style.display='none'" style="background: none; border: none; font-size: 24px; color: var(--text-muted-color);">√ó</button>
        </div>

        <!-- √Årea de Conte√∫do -->
        <div id="mobile-views-content" style="flex-grow: 1; overflow-y: auto; padding: 10px; background-color: var(--bg-color);">
            <!-- O conte√∫do ser√° injetado aqui via JS -->
        </div>

        <!-- Barra de Abas (Igual √† do PC) -->
        <div class="middle-bottom-tabs" style="display: flex !important; position: relative; margin: 0 !important; border-top: 1px solid var(--border-color);">
            <button data-mob-tab="files"><span>üìÇ</span> Pastas</button>
            <button data-mob-tab="index" class="active"><span>üìë</span> √çndice</button>
            <button data-mob-tab="texts"><span>üìñ</span> Textos</button>
            <button data-mob-tab="sources"><span>‚ö°</span> Fontes</button>
        </div>
    </div>
</div>

<!-- MODAL DE GEST√ÉO DE √ÇNCORAS (LISTA) -->
<div id="anchors-manager-modal" class="modal-overlay" style="z-index: 50000;">
    <div class="modal-content" style="max-width: 450px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Anexar √Çncora</h3>
            <!-- Bot√£o '+' no canto superior direito -->
            <button id="open-create-anchor-btn" title="Criar Nova √Çncora" 
                    style="background: none; border: 1px solid var(--accent-color); color: var(--accent-color); width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
        </div>
        
        <p style="font-size: 0.9em; color: var(--text-muted-color); margin-bottom: 15px;">
            Selecione as √¢ncoras para associar a esta entidade.
        </p>

        <ul id="anchors-manager-list" class="move-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- A lista ser√° preenchida via JS -->
        </ul>

        <div class="modal-actions" style="margin-top: 20px;">
            <button class="modal-btn secondary" onclick="document.getElementById('anchors-manager-modal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>

<!-- MODAL DE CRIA√á√ÉO DE NOVA √ÇNCORA -->
<div id="create-anchor-modal" class="modal-overlay" style="z-index: 55000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Adicionar √Çncoras</h3>
        
        <input type="text" id="new-anchor-name" placeholder="Nome da √Çncora" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="new-anchor-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('create-anchor-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="confirm-create-anchor">Criar</button>
        </div>
    </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE √ÇNCORA -->
<div id="edit-anchor-modal" class="modal-overlay" style="z-index: 60000;">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Editar √Çncora</h3>
        
        <input type="text" id="edit-anchor-name" placeholder="Nome da √Çncora" 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">
        
        <textarea id="edit-anchor-desc" placeholder="Descri√ß√£o (Opcional)" 
                  style="width: 100%; height: 80px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>
        
        <div class="modal-actions" style="display: flex; justify-content: space-between;">
            <!-- Bot√£o Eliminar √† Esquerda -->
            <button class="modal-btn" id="delete-anchor-btn" style="background-color: #c0392b; color: white;">Eliminar</button>
            
            <div style="display: flex; gap: 10px;">
                <button class="modal-btn secondary" onclick="document.getElementById('edit-anchor-modal').style.display='none'">Cancelar</button>
                <button class="modal-btn primary" id="confirm-edit-anchor">Gravar</button>
            </div>
        </div>
    </div>
</div>

<!-- AMBIENTE AQU√ÅRIO (Fica por cima de tudo) -->
<div id="aquarium-environment" style="display: none;">
    
    <!-- Barra de Tarefas do Aqu√°rio -->
    <div id="aquarium-bar">
        <!-- ESQUERDA: NAVEGA√á√ÉO -->
        <div class="aquarium-nav-group">
            <button id="aquarium-back-btn" title="Sair e Gravar">‚¨Ö Voltar</button>
            
            <!-- NOVO √çCONE DA MEDUSA -->
            <button id="aquarium-sidebar-toggle" title="Menu Lateral" style="font-size: 18px;">ü™º</button>
            
            <button id="aquarium-jump-btn" title="Saltar para outra nota">íÜú</button>
        </div>

        <!-- CENTRO-ESQUERDA: FERRAMENTAS -->
          <div class="aquarium-tools-group">
            <button data-action="note-sharing-settings" title="Partilha">üîê</button>
            <button data-action="show-topics" title="T√≥picos">üìë</button>
            <button data-action="show-history" title="Hist√≥rico">üïí</button>
            
            <!-- SEPARADOR VISUAL -->
            <div style="width:1px; background:rgba(255,255,255,0.2); height:20px; margin:0 5px;"></div>
            
            <!-- NOVOS BOT√ïES -->
            <button data-action="undo" title="Desfazer (Ctrl+Z)">‚Ü©Ô∏è</button>
            <button data-action="redo" title="Refazer (Ctrl+Y)">‚Ü™Ô∏è</button>
        </div>

        <!-- DIREITA: T√çTULO -->
        <div class="aquarium-title-group">
            <h2 id="aquarium-title-display">Sem T√≠tulo</h2>
        </div>
    </div>

    <!-- NOVA SIDEBAR DO AQU√ÅRIO (MEDUSA) -->
    <aside id="aquarium-sidebar">
        <!-- Cabe√ßalho das Abas -->
        <div class="aq-tabs-header">
    <button class="aq-tab active" data-tab="listas" title="Listas">üß≠</button>
        <button class="aq-tab" data-tab="indice" title="√çndice">‚âî</button>
        <button class="aq-tab" data-tab="textos" title="Textos B√≠blicos">üìú</button>
        <button class="aq-tab" data-tab="navega" title="Navega√ß√£o">‚öì</button>
        <button class="aq-tab" data-tab="links" title="Links e Fontes">‚ö°</button>
        <button class="aq-tab" data-tab="armazem" title="Armaz√©m">üêö</button>
        </div>

        <!-- Conte√∫do das Vistas -->
        <div id="aq-sidebar-content">
            <ul id="aq-list-view" class="aq-view active">
                <!-- Preenchido via JS (Listas) -->
            </ul>
            <div id="aq-index-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Cards do √çndice) -->
            </div>
            <div id="aq-texts-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Textos B√≠blicos) -->
            </div>
            <div id="aq-nav-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Navega√ß√£o Entidades) -->
            </div>
            <ul id="aq-links-view" class="aq-view" style="display:none;">
                <!-- Preenchido via JS (Links das Caixas) -->
            </ul>
         <div id="aq-store-view" class="aq-view" style="display:none; height: 100%; flex-direction: column;">
    <!-- O conte√∫do ser√° injetado aqui -->
</div>
        </div>
    </aside>

    <!-- POPUP DE NAVEGA√á√ÉO R√ÅPIDA (Fica escondido) -->
    <div id="aquarium-jump-popup" style="display:none;">
        <input type="text" id="aquarium-jump-search" placeholder="Pesquisar nota...">
        <ul id="aquarium-jump-list"></ul>
    </div>

    <!-- Barra de Ferramentas Funcional -->
   

  <div id="aquarium-toolbar">
        
        <!-- GRUPO 1: Estilo e Tamanho (MOVIDO PARA O IN√çCIO) -->
        <div class="aq-tool-group">
            <select id="aq-zoom" title="Zoom">
                <option value="12px">50%</option>
                <option value="100%" selected>100%</option>
                <option value="18px">110%</option>
                <option value="24px">150%</option>
            </select>
            <select id="aq-format" title="Estilo" style="width: 100px;">
                <option value="P" selected>¬∂ Normal</option>
                <option value="H1">A1 T√≠tulo</option>
                <option value="H2">A2 T√≠tulo</option>
                <option value="H3">A3 T√≠tulo</option>
            </select>
            <input type="color" id="aq-color" title="Cor do Texto" style="width:30px; height:30px; border:none; background:none; cursor:pointer;">
        </div>

        <div class="aq-sep"></div>

        <!-- GRUPO 2: Formata√ß√£o B√°sica (MOVIDO PARA SEGUNDO) -->
        <div class="aq-tool-group">
            <button data-cmd="bold" title="Negrito"><b>B</b></button>
            <button data-cmd="boldBlue" title="Negrito Azul" class="btn-blue-b">B <span class="dots">‚Ä¢‚Ä¢</span></button>
            <button data-cmd="italic" title="It√°lico" class="btn-italic"><i>I</i> <span class="dots">‚Ä¢‚Ä¢</span></button>
            <button data-cmd="underline" title="Sublinhado"><u>U</u></button>
        </div>

        <div class="aq-sep"></div>

        <!-- GRUPO 3: Widgets Especiais (MANTEVE-SE) -->
        <div class="aq-tool-group">
            <button data-action="insert-toggle-h2" title="Sec√ß√£o Expans√≠vel (Toggle)">‚òÇ</button>
            <button data-action="make-draggable" title="Texto Arrast√°vel">·Øì</button>
            <button data-action="insert-checkbox" title="Checkbox">‚òëÔ∏è</button>
            <button data-action="insertHorizontalRule" title="Linha Horizontal">‚Äï</button>
            <button data-action="insert-table" title="Tabela">üßÆ</button>
            <button data-action="insert-date" title="Calend√°rio">üìÖ</button>
            <button data-action="insert-timeline" title="Linha Cronol√≥gica">üå≥</button>
            <button data-action="bible-scan" title="Scanner B√≠blico">üé∞</button>
        </div>

        <div class="aq-sep"></div>

        <!-- GRUPO 4: Contexto do Fantasma (MANTEVE-SE) -->
       <div id="aq-context-tools" class="aq-tool-group" style="display: none; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 10px;">
        <span style="font-size:10px; color:#888; margin-right:5px; text-transform:uppercase;">BLOCO</span>
        <button data-ctx="sharing" title="Partilha">üîê</button>
        <button data-ctx="links" title="Links/Codex">‚ö°</button>
        <button data-ctx="clone" title="Clonar">üß¨</button>
        <button data-ctx="color" title="Cor de Fundo">üé®</button>
        <button data-ctx="topics" title="T√≥picos">üìã</button>
        <button data-ctx="semantic-type" title="Definir Tipo Sem√¢ntico">‚òÑÔ∏é</button>
        <div style="width:1px; background:rgba(255,255,255,0.2); margin:0 5px; height:20px;"></div>
<button data-ctx="text-link" title="Anexar Link ao Texto" style="color:var(--accent-color);">üîó</button>
        <button data-ctx="delete" title="Apagar Bloco" style="color:#e74c3c;">üóëÔ∏è</button>
    </div>

      <!-- NOVO: STATUS DE GRAVA√á√ÉO (EMPUBRADO PARA A DIREITA) -->
       <div style="margin-left: auto; padding-right: 10px; display: flex; align-items: center;">
            <span id="aq-save-status" class="save-status" style="cursor: pointer; font-size: 0.8em; font-weight: 500;"></span>
       </div>

    </div>

    <!-- O "Desktop" do Aqu√°rio -->
    <div id="aquarium-desktop">
        <!-- √Årea de Scroll -->
        <div id="aquarium-scroll-area">
            <!-- Onde os Fantasmas vivem -->
            <div id="aquarium-content-canvas">
                <!-- Um Fantasma inicial para come√ßar -->
                <div class="ghost-block" contenteditable="true" data-placeholder=""></div>
            </div>
        </div>
    </div>
</div>

<!-- POPUP DE TIPO SEM√ÇNTICO (‚òÑÔ∏é) -->
<div id="semantic-type-popup" style="display: none;">
    <div class="semantic-header">Definir como:</div>
    <button data-sem="h1">T√≠tulo H1</button>
    <button data-sem="h2">T√≠tulo H2</button>
    <button data-sem="p">Par√°grafo (Normal)</button>
    <button data-sem="sub">Subpar√°grafo</button>
    <button data-sem="note">Nota / Obs</button>
</div>

<!-- POPUP DO BURACO NEGRO (üï≥Ô∏è) -->
<div id="black-hole-modal" class="modal-overlay" style="z-index: 40000;">
    <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 5px;">üï≥Ô∏è Itens Perdidos</h3>
        <p style="font-size:0.8em; color:var(--text-muted-color); margin-bottom:15px;">Recupere blocos que foram apagados nesta sess√£o.</p>
        
        <ul id="black-hole-list" class="move-list" style="flex-grow: 1; overflow-y: auto;">
            <li style="text-align:center; padding:20px; color:#888;">O buraco est√° vazio.</li>
        </ul>
        
        <div class="modal-actions" style="margin-top: 15px;">
            <button class="modal-btn secondary" onclick="document.getElementById('black-hole-modal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>


<!-- MODAL DE LIGA√á√ïES DE TEXTO (MULTIPLE LINKS) -->
<div id="text-link-modal" class="modal-overlay" style="z-index: 2147483647;">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="text-link-title">Refer√™ncia de Texto</h3>
        
        <!-- Campo de T√≠tulo (Preenchido com o texto selecionado) -->
        <label style="font-size:0.8em; color:var(--text-muted-color); margin-bottom:5px; display:block;">T√≠tulo da Refer√™ncia</label>
        <input type="text" id="text-link-name" placeholder="T√≠tulo..." 
               style="width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 16px; margin-bottom: 15px;">

        <!-- Contentor de URLs Din√¢micos -->
        <label style="font-size:0.8em; color:var(--text-muted-color); margin-bottom:5px; display:block;">Links / URLs</label>
        <div id="text-link-list" style="display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto; margin-bottom:10px;">
            <!-- Os inputs aparecem aqui -->
        </div>

        <!-- Bot√£o Adicionar Mais -->
        <button id="add-text-url-btn" style="background:none; border:1px dashed var(--accent-color); color:var(--accent-color); width:100%; padding:5px; border-radius:4px; cursor:pointer; margin-bottom:20px;">+ Adicionar Link</button>

        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="document.getElementById('text-link-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="save-text-link-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- MODAL DE DETALHES DO POST -->
<div id="post-info-modal" class="modal-overlay" style="z-index: 20000;">
    <div class="modal-content" style="max-width: 350px;">
        <h3 style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;">
            ‚ÑπÔ∏è Detalhes do Post
        </h3>
        
        <div id="p-info-grid" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            <!-- O conte√∫do ser√° injetado aqui via JS -->
        </div>

        <div class="modal-actions" style="justify-content: center;">
            <button class="modal-btn primary" onclick="document.getElementById('post-info-modal').style.display='none'" style="width: 100%;">OK</button>
        </div>
    </div>
</div>

<!-- POPUP DE PESQUISA LOCAL -->
<div id="local-search-popup">
  <input type="text" id="local-search-input" placeholder="Localizar...">
    <span id="local-search-count">0/0</span>
    <div style="width:1px; height:20px; background:var(--border-color); margin:0 5px;"></div>
    <button class="local-search-btn" id="local-search-prev" title="Anterior">‚ñ≤</button>
    <button class="local-search-btn" id="local-search-next" title="Pr√≥ximo">‚ñº</button>
    <button class="local-search-btn" id="local-search-close" title="Fechar" style="margin-left:5px; border-color:transparent; color:#e74c3c;">‚úï</button>
    <ul id="local-search-results-list"></ul>
</div>

<!-- MODAL ANEXAR FONTES (NOVO) -->
<div id="attach-sources-modal" class="modal-overlay" style="z-index: 20000;">
    <div class="modal-content">
        <!-- Cabe√ßalho Abas -->
        <div class="attach-tabs">
            <button class="attach-tab-btn active" onclick="window.switchAttachTab('links')">üîó Links Web</button>
            <button class="attach-tab-btn" onclick="window.switchAttachTab('superlink')">üñáÔ∏è SuperLink</button>
        </div>

        <!-- ABA 1: LINKS (L√≥gica Original) -->
        <div id="attach-content-links" class="attach-tab-content active">
            <label style="font-size:0.8em; color:var(--text-muted-color);">T√≠tulo do Link</label>
            <input type="text" id="as-link-title" class="redator-input" style="border:1px solid var(--border-color); padding:8px; margin-bottom:15px; width:100%;">
            
            <div id="as-urls-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            
            <button class="modal-btn" onclick="window.addAttachUrlField()" style="width:100%; margin-top:10px; border:1px dashed var(--text-muted-color); background:none; color:var(--text-muted-color);">+ Adicionar URL</button>
            
            <div class="modal-actions" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                <button class="modal-btn secondary" onclick="document.getElementById('attach-sources-modal').style.display='none'">Cancelar</button>
                <button class="modal-btn primary" id="as-save-links-btn">Gravar Links</button>
            </div>
        </div>

        <!-- ABA 2: SUPERLINK (Frases da P√°gina) -->
        <div id="attach-content-superlink" class="attach-tab-content">
            <p style="font-size:0.85em; color:var(--text-muted-color); margin-bottom:10px;">
                Selecione as frases desta nota para vincular ao texto original.
            </p>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px;">
                <ul id="superlink-sentences-list">
                    <!-- Frases geradas aqui -->
                </ul>
            </div>
            
            <div class="modal-actions" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                <button class="modal-btn secondary" onclick="document.getElementById('attach-sources-modal').style.display='none'">Cancelar</button>
                <button class="modal-btn primary" id="as-save-superlink-btn" style="background-color: #e67e22;">Criar V√≠nculo</button>
            </div>
        </div>
    </div>
</div>



<!-- MODAL ANEXAR FONTES (LINK & SUPERLINK) -->
<div id="source-manager-modal" class="modal-overlay" style="z-index: 2147483647;">
    <div class="modal-content" style="max-width: 600px; width: 95%;">
        <h3 id="source-modal-title">Anexar Fontes</h3>
        
        <!-- ABAS -->
        <div class="tabs-container" id="source-tabs" style="margin-bottom: 15px;">
            <button class="active" data-tab="links">üîó Links</button>
            <button data-tab="superlink">üñáÔ∏è SuperLink</button>
        </div>

        <!-- ABA 1: LINKS (Cl√°ssico) -->
        <div id="source-content-links" class="box-tab-content" style="display: block;">
            <div style="margin-top: 10px;">
                <label style="font-size:0.8em; color:var(--text-muted-color);">Nome do Link</label>
                <input type="text" id="source-link-name" placeholder="Texto do link..." 
                       style="width:100%; padding:10px; margin-bottom:15px; background:var(--bg-color); border:1px solid var(--border-color); color:var(--text-color);">
                
                <label style="font-size:0.8em; color:var(--text-muted-color);">URLs</label>
                <div id="source-urls-list" style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;"></div>
                
                <button id="source-add-url-btn" style="width:100%; padding:8px; background:var(--hover-color); border:1px dashed var(--text-muted-color); color:var(--text-muted-color); cursor:pointer;">+ Adicionar URL</button>
            </div>
        </div>

        <!-- ABA 2: SUPERLINK (Frases da P√°gina) -->
        <div id="source-content-superlink" class="box-tab-content" style="display: none;">
            <p style="font-size:0.9em; color:var(--text-muted-color);">
                Selecione as frases nesta nota para vincular ao texto selecionado.
            </p>
            <div id="superlink-sentences-list">
                <!-- Lista gerada via JS -->
            </div>
        </div>

        <!-- RODAP√â -->
        <div class="modal-actions" style="margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color);">
            <button class="modal-btn" id="source-remove-btn" style="background-color:#c0392b; color:white; display:none; margin-right:auto;">Remover</button>
            <button class="modal-btn secondary" onclick="document.getElementById('source-manager-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="source-save-btn">Gravar</button>
        </div>
    </div>
</div>

<!-- MODAL ESPEC√çFICO PARA REFER√äNCIAS DA 4¬™ COLUNA -->
<div id="ref-panel-creator-modal" class="modal-overlay" style="z-index: 20000000;">
    <div class="modal-content" style="max-width: 600px; width: 95%;">
        <h3 id="ref-creator-title">Adicionar Refer√™ncia</h3>
        
        <!-- Abas de Contexto -->
        <div class="tabs-container" id="ref-creator-tabs" style="margin-top: 15px;">
            <button class="active" data-type="codex">üìö Codex</button>
            <button data-type="link">üîó Link Web</button>
        </div>

        <!-- CONTE√öDO CODEX -->
      <div id="ref-creator-codex-area" style="display: block; margin-top: 15px; max-height: 50vh; overflow-y: auto;">
    <div id="ref-codex-rows-container" style="display: flex; flex-direction: column; gap: 15px;">
        <!-- As linhas do Codex ser√£o injetadas aqui -->
    </div>
    <!-- Bot√£o removido -->
</div>

        <!-- CONTE√öDO LINKS WEB -->
        <div id="ref-creator-link-area" style="display: none; margin-top: 15px;">
            <label style="font-size:0.8em; color:var(--text-muted-color);">T√≠tulo</label>
            <input type="text" id="ref-link-title" class="redator-input" style="border:1px solid var(--border-color); padding:8px; margin-bottom:10px; width:100%;">
            
            <div id="ref-link-urls-container" style="display: flex; flex-direction: column; gap: 8px;"></div>
            
            <button class="modal-btn" onclick="window.addRefUrlRow()" 
                    style="width: 100%; margin-top: 10px; border: 1px dashed var(--text-muted-color); background:none; color:var(--text-muted-color);">
                + URL
            </button>
        </div>

        <div class="modal-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <button class="modal-btn secondary" onclick="document.getElementById('ref-panel-creator-modal').style.display='none'">Cancelar</button>
            <button class="modal-btn primary" id="ref-creator-save-btn">Gravar</button>
        </div>
    </div>
</div>

</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
   <script type="module">
    
  // 1. Importa√ß√µes de Configura√ß√£o
    import { db, auth } from './js/firebase-config.js';
    import { BIBLE_DATA, BIBLICAL_BOOKS } from './js/bible-data.js';
    import { sanitizeHTML, debounce, removeAccents, escapeRegExp } from './js/utils.js';
    import { SIGLAS_PUBLICACOES } from './js/siglas-data.js';



    // 2. Importa√ß√µes do Firestore
    import { 
    collection, query, where, addDoc, serverTimestamp, onSnapshot, 
    doc, getDoc, updateDoc, orderBy, getDocs, writeBatch, deleteField, deleteDoc,
    setDoc, limit, startAfter, runTransaction 
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // 3. Importa√ß√µes de Autentica√ß√£o
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";



document.addEventListener('DOMContentLoaded', () => {
    checkInitialConnection(); // Verifica a conex√£o ao carregar

    // 1. Gravar ao mudar de aba ou minimizar (Muito fi√°vel em telem√≥veis e PC)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        
        // A. Se estiver no Aqu√°rio
        const aquariumEnv = document.getElementById('aquarium-environment');
        if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
            console.log("üåä [SA√çDA] Aqu√°rio escondido. A gravar...");
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
        
        // B. Se estiver num Post de Arquivo (Feed) em edi√ß√£o
        else if (activeEditingPostId) {
            console.log("üì± [SA√çDA MOBILE] Post de Arquivo detetado.");
            
            // --- [CR√çTICO] 1. SALVAMENTO LOCAL INSTANT√ÇNEO ---
            // Isto corre sincronamente. O sistema operativo n√£o consegue interromper isto.
            const postDiv = document.getElementById(`post-${activeEditingPostId}`);
            if (postDiv) {
                const titleInput = postDiv.querySelector('.post-title-input');
                const contentEditor = postDiv.querySelector('.post-editor-content');
                
                if (titleInput && contentEditor) {
                    // Sincroniza inputs internos antes de capturar HTML
                    contentEditor.querySelectorAll('.mini-note-title-input').forEach(t => {
                        if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                        else t.setAttribute('value', t.value);
                    });

                    const backupData = {
                        id: activeEditingPostId,
                        title: titleInput.value,
                        content: contentEditor.innerHTML,
                        timestamp: Date.now()
                    };
                    
                    // Grava no disco do telem√≥vel AGORA
                    localStorage.setItem(`draft_${activeEditingPostId}`, JSON.stringify(backupData));
                    console.log("üõ°Ô∏è Backup de emerg√™ncia gravado no LocalStorage.");
                }
            }
            // -------------------------------------------------

            // 2. Tenta enviar para a Cloud (Best Effort)
            // Se o browser congelar aqui, o passo 1 j√° salvou o dia.
            const tempId = activeEditingPostId;
            activeEditingPostId = null;
            window.activeEditingPostId = null;

            if (typeof window.saveArchivePost === 'function') {
                window.saveArchivePost(tempId);
            }
        }

        // C. Se estiver numa Nota Normal (e houver altera√ß√µes pendentes)
        else if (currentSaveStatus === 'unsaved') {
            console.log("üìÑ [SA√çDA] Nota normal n√£o guardada. A gravar...");
            executeSave();
        }
    }
});

// 2. Gravar ao perder o foco da janela (ex: clicar noutra janela do Windows)
window.addEventListener('blur', () => {
    if (currentSaveStatus === 'unsaved') {
        executeSave();
    }
});

    const modalObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const target = mutation.target;
                
                // Se o modal passou de 'none' para 'flex' (ou seja, abriu)
                if (target.style.display !== 'none' && target.style.display !== '') {
                    
                    // 1. Fecha a Barra de Ferramentas de Sele√ß√£o
                    if (selectionPopup) selectionPopup.style.display = 'none';

                     if (document.getElementById('insertion-popup')) document.getElementById('insertion-popup').style.display = 'none';

                    // 2. (Opcional) Fecha tamb√©m popups de sugest√£o (@ e #) se estiverem abertos
                    if (tagSuggestionPopup) tagSuggestionPopup.style.display = 'none';
                    if (entitySuggestionPopup) entitySuggestionPopup.style.display = 'none';
                    if (isTagPopupOpen) isTagPopupOpen = false;
                    if (isEntityPopupOpen) isEntityPopupOpen = false;
                }
            }
        });
    });

    // Ativa o observador em todos os elementos com a classe .modal-overlay
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modalObserver.observe(modal, { 
            attributes: true, 
            attributeFilter: ['style'] // S√≥ vigia altera√ß√µes no estilo (display block/none)
        });
    });
});


const editorElement = document.getElementById('note-content-editor');

if (editorElement) {
    editorElement.addEventListener('touchstart', (e) => {
        // Verifica se tocou num input de t√≠tulo ou textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.target.classList.contains('mini-note-title-input') || 
                e.target.classList.contains('redator-input') ||
                e.target.classList.contains('sign-title-input')) {
                
                // P√°ra a propaga√ß√£o. O evento fica "preso" no input.
                // Assim o pai (a caixa) n√£o sabe que houve toque e n√£o tenta mexer-se.
                e.stopPropagation(); 
            }
        }
    }, { passive: false }); // 'passive: false' permite que o input controle o evento
}

// --- REFER√äNCIAS AO DOM ---
const notebookContainer = document.querySelector('.notebook-container');
const leftPanelToggleBtn = document.getElementById('left-panel-toggle-btn');
const referencesPanel = document.getElementById('references-panel');
const referencesPanelTitle = document.getElementById('references-panel-title');
const referencesList = document.getElementById('references-list');
const referencesPanelCloseBtn = document.getElementById('references-panel-close-btn');
const leftPanelList = document.getElementById('left-panel-list');
const leftPanelTitle = document.getElementById('left-panel-title');
const middlePanelList = document.getElementById('file-list');
const middlePanelTitle = document.getElementById('middle-panel-title');
const backBtn = document.getElementById('back-btn');
const addItemBtn = document.getElementById('add-item-btn');
const editorPlaceholder = document.getElementById('editor-placeholder');
const editorArea = document.getElementById('editor-area');
const noteTitleInput = document.getElementById('note-title-input');
const newItemNameInput = document.getElementById('new-item-name');
const editorToolbar = document.getElementById('editor-toolbar');
const noteContentEditor = document.getElementById('note-content-editor');
const selectionPopup = document.getElementById('selection-popup');
const tagSuggestionPopup = document.getElementById('tag-suggestion-popup');
const tagSuggestionList = document.getElementById('tag-suggestion-list');
const saveStatusIndicator = document.getElementById('save-status-indicator');
const connectivityStatus = document.getElementById('connectivity-status');
const entitySuggestionPopup = document.getElementById('entity-suggestion-popup');
const entitySuggestionList = document.getElementById('entity-suggestion-list');
const noteSharePopup = document.getElementById('note-share-popup');
const noteShareToggle = document.getElementById('note-share-toggle');
const noteShareLinkContainer = document.getElementById('note-share-link-container');
const noteShareUrlInput = document.getElementById('note-share-url');
const copyNoteLinkBtn = document.getElementById('copy-note-link-btn');
const mobileBackBtn = document.getElementById('mobile-back-btn');
const debouncedScanAndLink = debounce(scanAndLinkEntities, 2000);
const MESES_LISTA = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
const ENTITY_CONFIG = {
    personagem: { collection: 'personagens', displayName: 'Personagens' },
    local: { collection: 'locais', displayName: 'Locais' },
    data: { collection: 'datas', displayName: 'Datas' },
    textobiblico: { collection: 'textosbiblicos', displayName: 'Textos B√≠blicos' },
    marcadores: { collection: 'marcadores', displayName: 'Marcadores' },
    cosmos: { collection: 'cosmos', displayName: 'Cosmos' },
    subcosmos: { collection: 'subcosmos', displayName: 'Sub-Cosmos' }
};

// 10 Cores diferentes das padr√£o (Azul/Verde/Laranja)
const DEFAULT_HIGHLIGHTS = [
    { code: "#B12823", name: "Vermelho Tijolo" },
    { code: "#AC4A0B", name: "Laranja Outono" },
    { code: "#D8B200", name: "Amarelo Dourado" }, // Escolhi a op√ß√£o mais viva
    { code: "#436C21", name: "Verde Lima/Oliva" },
    { code: "#006042", name: "Verde Esmeralda" },
    { code: "#1F7AC4", name: "Azul Oceano" },
    { code: "#B53E69", name: "Rosa Suave" },
    { code: "#8438D7", name: "Roxo Ametista" },  // Escolhi o roxo mais vivo
    { code: "#A08F8E", name: "Cinza Quente" }    // Escolhi o cinza mais claro
];

const EXPLORER_RESULTS_PER_PAGE = 15;
const MICA_COLORS = [
    { name: 'Laranja', hex: '#e67e22' }, { name: 'Amarelo', hex: '#f1c40f' },
    { name: 'Azul', hex: '#3498db' }, { name: 'Verde', hex: '#2ecc71' },
    { name: 'Roxo', hex: '#9b59b6' }, { name: 'Rosa', hex: '#e91e63' },
    { name: 'Vermelho', hex: '#e74c3c' }, { name: 'Castanho', hex: '#795548' },
    { name: 'Cinza', hex: '#95a5a6' }
];
const CITATIONS_PER_PAGE = 10; // Limite por p√°gina
const DEFAULT_FILTERS = {
    all: false,
    notes: true,
    superfolders: false,
    archives: false,
    subnote: true,
    question: true,
    free: true,
    postit: true,
    topics: false,
    subtopics: false,
    highlights: false,
    bookmarks: false,
    personagem: false,
    local: false,
    data: false,
    cosmos: false,
    subcosmos: false,
    tags: false,
    fourthColumn: false
};
const MAX_POPUPS = 3;
const AUTO_BACKUP_INTERVAL = 50; 
const aqCanvasListener = document.getElementById('aquarium-content-canvas');
const MAX_AQ_POPUPS = 6;
const GLOBAL_SQUID_ID = 'SHARED_GLOBAL_SQUID';



// --- ESTADO DA APLICA√á√ÉO ---
  let currentUserData = null;
let allEntities = {};
let sessionUnlockedFolders = new Set(); 
let navigationStack = [];
let selectedNoteId = null;
let unsubscribeLeftPanel = null;
let unsubscribeMiddlePanel = null;
let saveTimeout = null;
let activeItemContext = null;
let currentSelectionRange = null;
let allTags = [];
let isTagPopupOpen = false;
let currentTagQueryRange = null;
let currentSaveStatus = 'hidden';
let isEntityPopupOpen = false;
let currentEntityQueryRange = null;
let activeReferenceEntity = { id: null, type: null, name: null };
let currentTab = 'note';
let SUPERFOLDER_ID = null;
let currentSuperfolderParentId = null;
let currentSuperfolderParentName = "Raiz Global";
let currentNoteTopics = {}; // Estado local dos t√≥picos da nota: { topicId: [subId1, subId2] }
let activeTopicIdForSelection = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Sele√ß√£o)
let activeTopicIdForManagement = null; // Qual t√≥pico est√° selecionado na esquerda (Modal Gest√£o)
let currentViewMode = 'local'; // 'local' ou 'shared'
let systemSharedFolderId = null; // Vai guardar o ID da pasta "Partilhadas"
let isClosingNote = false;
let currentShortcutId = null;
window.topicTargetId = null;
let currentSuperfolderName = "";
let appSettings = {
    searchTagsInProtected: false,
    searchTopicsInProtected: false,
    searchAnchorsInProtected: false,
    searchGlobalInSuperfolder: false,
    showFullTitles: false // Nova defini√ß√£o
};
let currentBookmarkSort = 'texto'; // Op√ß√µes: 'texto', 'categoria', 'descricao'
let savedRange = null;
let userCustomHighlights = {}; // Cache dos nomes personalizados
let aggregationStack = []; // Para navegar nas pastas dentro do modal
let aggregationSelectedItems = []; // Guarda o HTML das caixas selecionadas
let aggregationTargetName = ""; // Nome da nova nota a criar
let aggregationParentId = null; // Onde a nova nota ser√° criada
let appendStack = [];  // Hist√≥rico de navega√ß√£o do modal
let currentNoteShareData = null;
let moveStack = []; // Hist√≥rico de navega√ß√£o (como no Append/Aggregation)
let itemToMoveRef = null; // Guarda o objeto do item que estamos a mover
let selectedDestFolderId = null; // Guarda o ID da pasta destino selecionada
let globalExplorerResults = []; // Guarda todos os resultados (Pastas + Notas)
let lastContentEditTime = 0;
let currentExplorerPage = 0;
let moveFolderLastDoc = null;
let currentArchiveId = null;
let currentArchiveData = null;
let activeEditingPostId = null; // ID do post que est√° aberto para edi√ß√£o
let archiveAutoSaveTimer = null;
let collabUnsubscribe = null; // Para parar de ouvir quando sair
let presenceInterval = null;  // Para o "heartbeat"
let currentLocks = {};        // Cache local dos bloqueios
let unsubscribeShared1 = null;
let unsubscribeShared2 = null;
let currentArchiveTab = 'prateleira';
let postToAssignDrawer = null; // Guarda o ID do post que vai para o gavet√£o
let colorHexBeingRenamed = null;
let isPanelEditMode = false;
let allFoundReferenceBoxes = [];
let currentReferencePageIndex = 0;
let noteStackMemory = [];
let listsStackMemory = [];
let currentlyOpenVerseName = null;
let isDossieEditMode = false;
let activeMicaId = null; 
let allCitationsResults = []; // Guarda todos os resultados encontrados
let currentCitationsPageIndex = 0; // Controla a p√°gina atual
let col1SelectedId = null;
let selectedCosmosEmoji = "üíº"; // Antes era ü™ê
let tempEditEmoji = "üíº";
let currentDossieVersion = 0;
let globalSearchScope = 'paragraph'; 
let activeGavetaId = null; // Controla se estamos visualizando uma gaveta espec√≠fica
let activeGavetaData = null;
let selectedCategoriesForBox = []; 
let categoryFullResults = []; // Armazena todos os matches encontrados
let categoryDisplayCount = 0; // Quantos itens est√£o vis√≠veis no momento
let userLastSeenArchives = {};
let sessionStartTimeForArchive = 0;
let journalCursorRange = null;
let activeSignBtn = null;
let activeEditRow = null;
let activeCardImageElement = null;
let currentNoteType = null;
let activeRedatorPopups = [];
let highestZIndex = 10000;
let mDragCube = null;        // O cubo original
let mDragClone = null;       // O fantasma visual que segue o dedo
let mDragTarget = null;      // Onde vamos largar
let mTouchOffsetX = 0;
let mTouchOffsetY = 0;
let currentMobileRequestId = 0;
let currentNoteAnchors = {}; // Guarda o estado: { anchorId: true }
let anchorLastDoc = null;    // Cursor para pagina√ß√£o
let currentAnchorSearch = ""; 
let activeNoteAnchorsIds = []; 
let unsubscribeCurrentNote = null;
let aqListStack = [];
let aqLiveTimer = null;
let activeAquariumPopups = []; 
let activeStoreGhostId = null;
let scrollTimer = null;
let aqAutoSaveTimer = null;
let hasGlobalShareNotification = false;
let globalFoldersCache = []; 
let presenceRef = null;
let presenceHeartbeat = null;
let lockHeartbeatInterval = null;
let lastRenderedLeftParentId = 'INIT';
let globalSearchResults = []; // Vari√°vel cr√≠tica para a pesquisa
let currentSearchPage = 0;    // Vari√°vel para a pagina√ß√£o da pesquisa
let listSearchTimer = null;
let localSearchResults = [];
let currentLocalMatchIndex = -1;
let currentSuperLinkRange = null;
let currentEditingSuperLinkId = null;
let selectedSentenceNodes = []; // Guarda os n√≥s de texto selecionados na lista
let currentNoteTags = [];
let editingLinkIndex = -1; 


window.currentNoteHybridMode = false;
window.activeStoreGhostId = null;
window.nextSelectedId = null;
window.activeMiniNoteElement = null;
window.activeWrapperForColor = null;
window.htmlToAppend = "";
window.activeStorePopups = window.activeStorePopups || [];
window.livePostDraft = null;
window.folderUnreadCounts = {}; 
window.isSwitchingNote = false;
window.currentNavRequest = 0;
window.lastBoxLinkManagerId = null;
window.lastBoxLinkManagerTab = 'refs'; // Padr√£o
window.shellStack = [];


// Fun√ß√£o: Grava√ß√£o Silenciosa (Mant√©m o editor aberto)
// Usada pelo temporizador de 3 minutos e pelo clique no status
async function saveCurrentPostInBackground() {
    if (!activeEditingPostId) return;

    const postDiv = document.getElementById(`post-${activeEditingPostId}`);
    if (!postDiv) return;

    const statusEl = document.getElementById('archive-save-status');
    statusEl.textContent = "A guardar auto...";

    // 1. Capturar Dados do DOM
    const titleInput = postDiv.querySelector('.post-title-input');
    const contentEditor = postDiv.querySelector('.post-editor-content');

    if (titleInput && contentEditor) {
        const postIndex = currentArchiveData.posts.findIndex(p => p.id === activeEditingPostId);
        if (postIndex > -1) {
            
            // L√≥gica de T√≠tulo (Igual ao Save normal)
            let finalTitle = titleInput.value.trim();
            if (!finalTitle) finalTitle = "Sem T√≠tulo";

            // Sincroniza HTML interno (Entidades)
            const internalInput = contentEditor.querySelector('.mini-note-title-input');
            if (internalInput) internalInput.setAttribute('value', finalTitle);
            
            const internalH2 = contentEditor.querySelector('summary h2');
            if (internalH2) internalH2.textContent = finalTitle;

            // Atualiza Mem√≥ria
            currentArchiveData.posts[postIndex].title = finalTitle;
            currentArchiveData.posts[postIndex].content = contentEditor.innerHTML;
            currentArchiveData.posts[postIndex].updatedAt = Date.now();
        }
    }

    // 2. Gravar na BD (Sem fechar o editor)
    await saveFullArchive();
    
    // Reset do Status Visual
    statusEl.textContent = "Guardado";
    setTimeout(() => {
        if(statusEl.textContent === "Guardado") statusEl.textContent = "Guardado";
    }, 2000);
}



// Carrega do localStorage ou usa o padr√£o
window.searchFilters = JSON.parse(localStorage.getItem('jwn_search_filters')) || DEFAULT_FILTERS;

window.updateSearchFilter = function(property, value) {
    window.searchFilters[property] = value;
    
    // Se desativar qualquer um, o "Todos" deixa de estar ativo
    if (!value) {
        window.searchFilters.all = false;
        const allCb = document.getElementById('f-all');
        if (allCb) allCb.checked = false;
    }
    
    // Grava no navegador para n√£o perder ao fechar
    localStorage.setItem('jwn_search_filters', JSON.stringify(window.searchFilters));
};

window.toggleAllFilters = function(checked) {
    window.searchFilters.all = checked;
    Object.keys(window.searchFilters).forEach(key => {
        window.searchFilters[key] = checked;
        const el = document.getElementById(`f-${key}`);
        if (el) el.checked = checked;
    });
    localStorage.setItem('jwn_search_filters', JSON.stringify(window.searchFilters));
};


// --- NOVA FUN√á√ÉO: Reconstruir caminho para uma Pasta ---
async function reconstructFolderNavigation(targetFolderId, targetNoteId = null) {
    if (!targetFolderId) return;

    console.log("üìÇ [NAVEGA√á√ÉO] A reconstruir caminho para a pasta:", targetFolderId);

    let currentId = targetFolderId;
    const path = [];
    let safety = 0;

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // Loop para subir at√© √† raiz (Parent -> Parent -> Root)
        while (currentId && safety < 20) {
            const docRef = doc(db, 'pastas', currentId);
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                console.warn("Pasta n√£o encontrada na cadeia:", currentId);
                break;
            }
            
            const data = docSnap.data();
            
            // Adiciona ao IN√çCIO do array (porque estamos a ir do filho para o pai)
            path.unshift({ id: docSnap.id, name: data.nome });
            
            // Define o pr√≥ximo ID a procurar (o pai desta pasta)
            currentId = data.parentId; 
            safety++;
        }

        // 1. Atualiza a vari√°vel global de navega√ß√£o
        navigationStack = path;
        
        console.log("üìç Caminho reconstru√≠do:", path);

        updateNavigationView(false, targetNoteId);

    } catch (e) {
        console.error("Erro ao reconstruir navega√ß√£o:", e);
    }
}

// --- PROTE√á√ÉO DE ROTA E CARREGAMENTO DE USU√ÅRIO ---
 onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('app-loader');
    const container = document.querySelector('.notebook-container');

    // 1. VERIFICA√á√ÉO: UTILIZADOR N√ÉO AUTENTICADO
    if (!user) {
        console.warn("‚õî Acesso n√£o autorizado. Redirecionando para 404...");
        window.location.href = "404.html";
        return; 
    } 
    
    // 2. VERIFICA√á√ÉO: UTILIZADOR AUTENTICADO
    else {
        try {
            // Consulta o perfil do utilizador na base de dados
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);

            // Se o documento n√£o existe ou o campo 'aceite' n√£o √© 'on'
            if (!userDoc.exists() || userDoc.data().aceite !== "on") {
                console.warn("‚è≥ Conta pendente ou inv√°lida. Redirecionando para espera...");
                window.location.href = "index.html"; // Volta para a tela de "Pendente"
                return;
            }

            // --- SUCESSO: CONTA APROVADA (aceite = "on") ---
            console.log("üîê Acesso Confirmado. A carregar aplica√ß√£o...");
            
            // Carrega dados globais do utilizador
            currentUserData = userDoc.data();

            // =========================================================
            // AQUI COME√áA O CARREGAMENTO NORMAL DA APP (O SEU C√ìDIGO ANTIGO)
            // =========================================================
            
            const params = new URLSearchParams(window.location.search);
            const openArchiveId = params.get('openArchive'); 
            const modeParam = params.get('mode');           
            const urlRootId = params.get('rootId');
            const openFolderId = params.get('openFolder'); 
            const targetNoteId = params.get('noteId');     
            const redirectSearch = params.get('search');
            const viewParam = params.get('view');

            SUPERFOLDER_ID = urlRootId || null; 

            // Carrega Configura√ß√µes
            const configRef = doc(db, "configuracoes", user.uid);
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) appSettings = { ...appSettings, ...configSnap.data() };

            // --- 1. L√ìGICA DE ABA INICIAL ---
            if (openArchiveId || viewParam === 'shared' || modeParam === 'collab') {
                currentViewMode = 'shared';
                if (typeof window.switchFolderView === 'function') {
                    window.switchFolderView('shared');
                }
            }

            // --- 2. PROCESSADOR DE CONVITES ---
            if (modeParam === 'collab' && openArchiveId) {
                const archiveRef = doc(db, 'pastas', openArchiveId);
                const archiveSnap = await getDoc(archiveRef);
                if (archiveSnap.exists()) {
                    const data = archiveSnap.data();
                    if (data.partilhado === 'ativo') {
                        const myUid = user.uid;
                        if (!data.colaboradores || !data.colaboradores[myUid]) {
                            await updateDoc(archiveRef, { [`colaboradores.${myUid}`]: true });
                        }
                    } else {
                        alert("Convite inv√°lido ou expirado.");
                        window.location.href = "note.html";
                        return;
                    }
                }
            }

            if (openArchiveId) {
                const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
            }

            if (typeof startGlobalNotificationListener === 'function') startGlobalNotificationListener();

            // --- 4. ABERTURA DE CONTE√öDO ---
            if (openArchiveId) {
                if (typeof loadSharedFilesRoot === 'function') loadSharedFilesRoot();
                
                const arcSnap = await getDoc(doc(db, 'pastas', openArchiveId));
                if (arcSnap.exists()) {
                    displayArchive(openArchiveId, { id: openArchiveId, ...arcSnap.data() });
                    // L√≥gica de retry para sele√ß√£o visual
                    let attempts = 0;
                    const trySelect = setInterval(() => {
                        attempts++;
                        const listItem = document.querySelector(`.list-item[data-id="${openArchiveId}"]`);
                        if (listItem) {
                            document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                            listItem.classList.add('selected-red');
                            listItem.scrollIntoView({ block: 'center' });
                            clearInterval(trySelect);
                        }
                        if (attempts > 50) clearInterval(trySelect);
                    }, 100);
                }
            }
            else if (openFolderId && targetNoteId) {
                await reconstructFolderNavigation(openFolderId, targetNoteId);
                displayNote(targetNoteId, null, redirectSearch);
            } 
            else if (targetNoteId) {
                await navigateToNoteSmart(targetNoteId, redirectSearch);
            }
            else if (openFolderId) {
                await reconstructFolderNavigation(openFolderId);
            } 
            else {
                if (currentViewMode === 'local') updateNavigationView(false);
            }

            fetchAllEntities();
            fetchAllTags();
            loadUserHighlights();

            // REMOVE O ECR√É DE CARREGAMENTO (Shield)
            setTimeout(() => {
                if (container) container.style.setProperty('display', 'flex', 'important');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            }, 800); 

        } catch (e) { 
            console.error("Erro cr√≠tico na inicializa√ß√£o:", e); 
            // Em caso de erro grave (ex: falha de rede ao verificar permiss√£o),
            // por seguran√ßa mandamos para o Index.
            window.location.href = "index.html";
        }
    }
});

     

// --- FUN√á√ÉO PARA SALVAR CONFIGURA√á√ïES ---
async function saveUserSettings() {
    if (!auth.currentUser) return;
    
    // 1. Atualiza a vari√°vel global de imediato
    appSettings.showFullTitles = document.getElementById('setting-full-titles').checked;
    appSettings.searchTagsInProtected = document.getElementById('setting-search-tags').checked;
    appSettings.searchTopicsInProtected = document.getElementById('setting-search-topics').checked;
    appSettings.searchAnchorsInProtected = document.getElementById('setting-search-anchors').checked;

    // 2. Tenta aplicar o efeito agora (se houver nota aberta)
    applyTitleWrappingEffect();

    // 3. Salva no Firebase para persist√™ncia
    try {
        const configRef = doc(db, 'configuracoes', auth.currentUser.uid);
        await setDoc(configRef, appSettings, { merge: true });
    } catch (e) {
        console.error("Erro ao salvar:", e);
    }
}

// Adicione os listeners aos checkboxes
document.getElementById('setting-search-tags').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-topics').addEventListener('change', saveUserSettings);
document.getElementById('setting-search-anchors').addEventListener('change', saveUserSettings);
document.getElementById('setting-full-titles').addEventListener('change', saveUserSettings);

const globalSearchToggle = document.getElementById('setting-global-search-superfolder');
if (globalSearchToggle) {
    globalSearchToggle.addEventListener('change', saveUserSettings);
}



// --- GEST√ÉO DE ESTADO E CONECTIVIDADE ---

function updateSaveStatus(status) {
    currentSaveStatus = status;
    if (!saveStatusIndicator) return;

    saveStatusIndicator.classList.remove('status-saved', 'status-error');
    switch (status) {
        case 'unsaved':
            saveStatusIndicator.textContent = 'por guardar...';
            break;
        case 'saving':
            saveStatusIndicator.textContent = 'A guardar...';
            break;
        case 'saved':
            saveStatusIndicator.textContent = 'Guardado';
            saveStatusIndicator.classList.add('status-saved');
            break;
        case 'error':
            saveStatusIndicator.textContent = 'Erro ao guardar';
            saveStatusIndicator.classList.add('status-error');
            break;
        case 'hidden':
        default:
            saveStatusIndicator.textContent = '';
            break;
    }
}

function handleOffline() {
    connectivityStatus.textContent = 'Sem liga√ß√£o';
    connectivityStatus.classList.add('visible');
    updateSaveStatus('error'); 
    saveStatusIndicator.textContent = 'Offline - Altera√ß√µes n√£o guardadas';
}

function handleOnline() {
    connectivityStatus.classList.remove('visible');
    updateSaveStatus('saving');
    clearTimeout(saveTimeout);
    saveNote();
}

function checkInitialConnection() {
    if (!navigator.onLine) {
        handleOffline();
         leaveArchivePresence();
    }
}

/**
 * Verifica se existem altera√ß√µes n√£o guardadas antes de executar uma a√ß√£o de navega√ß√£o.
 * @param {function} navigationAction A fun√ß√£o a ser executada se a navega√ß√£o for confirmada.
 */
async function navigateWithUnsavedCheck(navigationAction) {
    // Verifica se estamos a editar um Post de Arquivo (Feed)
    const editingId = activeEditingPostId || window.activeEditingPostId;

    // Se n√£o houver nada para gravar (nem post, nem nota normal), navega logo.
    if (!editingId && currentSaveStatus !== 'unsaved' && currentSaveStatus !== 'saving') {
        navigationAction();
        return;
    }

    // --- ATIVAR O ESCUDO (MODAL DE BLOQUEIO) ---
    const blockingModal = document.getElementById('forcing-save-modal');
    if (blockingModal) {
        // Garante que est√° no topo e vis√≠vel
        document.body.appendChild(blockingModal);
        blockingModal.style.setProperty('display', 'flex', 'important');
        blockingModal.style.setProperty('z-index', '2147483647', 'important'); // M√°ximo absoluto
        blockingModal.style.setProperty('opacity', '1', 'important');
        blockingModal.style.setProperty('visibility', 'visible', 'important');
    }

    try {
        // CEN√ÅRIO 1: A editar um Post de Arquivo
        if (editingId) {
            console.log("üõë [SEGURAN√áA] A gravar Post antes de sair...");
            
            // P√°ra o heartbeat para evitar conflitos
            if (typeof stopLockHeartbeat === 'function') stopLockHeartbeat();

            // Grava e espera
            await window.saveArchivePost(editingId);
            
            // Limpa vari√°veis globais
            activeEditingPostId = null;
            window.activeEditingPostId = null;
            window.livePostDraft = null;
        } 
        
        // CEN√ÅRIO 2: A editar uma Nota Normal
        else if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
            console.log("üõë [SEGURAN√áA] A gravar Nota antes de mudar...");
            
            // AQUI EST√Å O SEGREDO: o 'await' obriga o c√≥digo a parar aqui
            // at√© o executeSave() terminar e devolver true/false.
            await saveNote(true); 
        }

        // --- SUCESSO: PODE PASSAR ---
        console.log("‚úÖ Grava√ß√£o confirmada. Libertando navega√ß√£o.");
        
        // Esconde o modal
        if (blockingModal) blockingModal.style.display = 'none';
        
        // Executa a navega√ß√£o (abrir a nova nota)
        navigationAction();

    } catch (error) {
        console.error("‚ùå ERRO CR√çTICO AO GRAVAR NA SA√çDA:", error);
        
        if (blockingModal) blockingModal.style.display = 'none';
        
        // Pergunta de seguran√ßa em caso de falha de rede
        if (confirm("Houve um erro ao gravar a nota anterior (falha de rede?).\nSe continuar, pode perder as √∫ltimas altera√ß√µes.\n\nDeseja for√ßar a sa√≠da?")) {
            // Se for post, tenta desbloquear √† for√ßa para n√£o ficar preso
            if (editingId && typeof unlockPost === 'function') {
                unlockPost(editingId).catch(e => {}); 
                activeEditingPostId = null;
            }
            navigationAction();
        }
    }
}



// --- 1. FUN√á√ïES DE ABERTURA E RENDERIZA√á√ÉO (MODAL SELE√á√ÉO) ---

async function openTopicsModal(targetId, type) {
    if (!targetId) return alert("Erro: Nenhum item selecionado.");

    console.log(`üöÄ Abrindo painel de gest√£o para ${type}: ${targetId}`);
    
    // 1. CONFIGURA√á√ÉO DE ESTADO
    window.topicTargetId = targetId; 
    
    // Se n√£o veio de uma caixa, limpa a refer√™ncia ativa
    if (type !== 'box') window.activeMiniNoteElement = null; 

    // Reset das vari√°veis das √¢ncoras
    currentNoteAnchors = {};
    anchorLastDoc = null;
    currentAnchorSearch = "";
    if(document.getElementById('anchor-search-input')) 
        document.getElementById('anchor-search-input').value = "";

    const modal = document.getElementById('topics-modal');
    if (!modal) return;

    // 2. FOR√áAR VISIBILIDADE
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // ============================================================
    // 3. RESET DE ABAS (AQUI ESTAVA O ERRO)
    // ============================================================
    
    // A. Reset dos bot√µes
    document.querySelectorAll('#topics-modal-tabs button').forEach(b => b.classList.remove('active'));
    document.querySelector('#topics-modal-tabs button[data-tab="topics"]').classList.add('active');
    
    // B. Reset dos conte√∫dos (CORRIGIDO: Esconder a aba nova tamb√©m)
    document.getElementById('tm-content-topics').style.display = 'flex';      // Mostra T√≥picos
    document.getElementById('tm-content-anchors').style.display = 'none';     // Esconde √Çncoras
    document.getElementById('tm-content-autolink').style.display = 'none';    // Esconde Tags (NOVO)

    // C. Reset do Bot√£o "+" do Cabe√ßalho (Volta a Azul)
    const plusBtn = document.getElementById('manage-topics-btn');
    if (plusBtn) {
        plusBtn.style.display = 'block';
        plusBtn.title = "Criar/Gerir T√≥picos";
        plusBtn.style.color = "var(--accent-color)";
        plusBtn.style.borderColor = "var(--accent-color)";
    }

    // D. Reset do bot√£o H√≠brido (Esconde)
    const hybridContainer = document.getElementById('hybrid-toggle-container');
    if (hybridContainer) hybridContainer.style.display = 'none';

    // 4. CARREGAR DADOS ATUAIS
    try {
        let data = {};
        
        // Se for caixa (subnota)
       if (window.activeMiniNoteElement) {
             const topicsString = window.activeMiniNoteElement.getAttribute('data-topics') || '{}';
             // As caixas tamb√©m podem ter tags no atributo data-tags se quiseres, 
             // mas assumindo que estamos a falar da NOTA principal:
             try { data.topicosSelecionados = JSON.parse(topicsString); } catch(e) {}
             
             // Se as caixas tiverem tags, ler√≠amos aqui. 
             // Se o objetivo √© gerir tags da NOTA PRINCIPAL, lemos da BD:
             if (selectedNoteId) {
                 const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                 const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
                 if(noteSnap.exists()) {
                     data.tags = noteSnap.data().tags;
                 }
             }

        } else {
            // Nota ou Pasta (L√≥gica Principal)
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const docSnap = await getDoc(doc(db, 'pastas', targetId));
            if (docSnap.exists()) data = docSnap.data();
        }

        // --- CARREGAMENTOS ---
        currentNoteTopics = data.topicosSelecionados || {};
        currentNoteAnchors = data.ancorasSelecionadas || {};
        
        // >>> NOVA LINHA: CARREGAR TAGS <<<
        currentNoteTags = data.tags || []; 
        console.log("üè∑Ô∏è Tags carregadas:", currentNoteTags);

        // Carrega estado H√≠brido
        const isHybrid = data.isHybridMode || false;
        const hybridToggle = document.getElementById('hybrid-mode-toggle');
        if (hybridToggle) hybridToggle.checked = isHybrid;

        // 5. RENDERIZAR LISTAS
        activeTopicIdForSelection = null;
        document.getElementById('subtopics-list-select').innerHTML = '<li style="color: #888; font-style: italic; padding: 10px;">Selecione um t√≥pico √† esquerda.</li>';
        
        if (typeof renderTopicsSelectionList === 'function') {
            await renderTopicsSelectionList();
        }

        // Limpa lista de tags (ser√° gerada ao clicar no bot√£o Verificar ou na aba)
        const autoLinkList = document.getElementById('auto-linker-results');
        if (autoLinkList) {
             // Se j√° tivermos tags, mostramo-las logo
             if (currentNoteTags.length > 0) {
                 // Simula uma "verifica√ß√£o" para listar o que temos + o que est√° no texto
                 runAutoLinkerScanner(); 
             } else {
                 autoLinkList.innerHTML = '<li style="padding: 20px; text-align: center; color: var(--text-muted-color); font-style: italic; font-size: 0.9em;">Clique em "Verificar" para analisar.</li>';
             }
        }

    } catch (e) {
        console.error("Erro ao carregar dados da nota:", e);
    }
}

async function renderTopicsSelectionList() {
    const list = document.getElementById('topics-list-select');
    if (!list) return;

    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    try {
        console.log("üì° [FIREBASE] Buscando t√≥picos...");
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        if (snapshot.empty) {
            console.log("‚ÑπÔ∏è [FIREBASE] Nenhum t√≥pico encontrado.");
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum t√≥pico criado.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            const topic = { id: docSnap.id, ...docSnap.data() };
            const li = document.createElement('li');
            
            // Verifica se este t√≥pico (ou subt√≥picos dele) j√° est√£o no data-topics da caixa
            const isSelected = !!currentNoteTopics[topic.id];
            
            li.innerHTML = `
                <input type="checkbox" class="topic-checkbox" ${isSelected ? 'checked' : ''}>
                <span>${topic.nome}</span>
            `;

            li.onclick = () => {
                activeTopicIdForSelection = topic.id;
                document.querySelectorAll('#topics-list-select li').forEach(el => el.classList.remove('active-topic'));
                li.classList.add('active-topic');
                renderSubtopicsSelectionList(topic.id, topic.nome);
            };

            const cb = li.querySelector('.topic-checkbox');
            cb.onclick = (e) => {
                e.stopPropagation();
                toggleTopicSelection(topic.id, cb.checked);
            };

            list.appendChild(li);
        });
        console.log("üé® [UI] Lista de t√≥picos renderizada.");

    } catch (error) {
        console.error("‚ùå [ERRO] Falha ao renderizar lista de t√≥picos:", error);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar.</li>';
    }
}

async function renderSubtopicsSelectionList(topicId, topicName) {
    const list = document.getElementById('subtopics-list-select');
    const title = document.getElementById('subtopics-title-select');
    
    title.textContent = `Subt√≥picos de "${topicName}"`;
    list.innerHTML = '<li>A carregar...</li>';

    const q = query( collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome') );
    const snapshot = await getDocs(q);

    list.innerHTML = '';

    if (snapshot.empty) {
        list.innerHTML = '<li style="font-style:italic; color: #888;">Nenhum subt√≥pico dispon√≠vel.</li>';
        return;
    }

    // Obt√©m os subt√≥picos j√° selecionados para este t√≥pico espec√≠fico
    const selectedSubtopics = currentNoteTopics[topicId] || [];

    snapshot.forEach(doc => {
        const sub = { id: doc.id, ...doc.data() };
        const isSelected = selectedSubtopics.includes(sub.id);

        const li = document.createElement('li');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'topic-checkbox';
        checkbox.checked = isSelected;
        
        checkbox.onclick = (e) => {
            e.stopPropagation();
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };
        
        // Clicar na linha tamb√©m seleciona
        li.onclick = () => {
            checkbox.checked = !checkbox.checked;
            toggleSubtopicSelection(topicId, sub.id, checkbox.checked);
        };

        const span = document.createElement('span');
        span.textContent = sub.nome;

        li.appendChild(checkbox);
        li.appendChild(span);
        list.appendChild(li);
    });
}

// --- 2. L√ìGICA DE SELE√á√ÉO (ESTADO LOCAL) ---

function toggleTopicSelection(topicId, isChecked) {
    if (isChecked) {
        // Se n√£o existia, cria entrada (array vazio de subt√≥picos)
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
        }
    } else {
        // Se desmarcar o t√≥pico, removemos tudo (incluindo subt√≥picos)
        delete currentNoteTopics[topicId];
        // Se este era o t√≥pico ativo na direita, atualiza a UI da direita
        if (activeTopicIdForSelection === topicId) {
             const subInputs = document.querySelectorAll('#subtopics-list-select input');
             subInputs.forEach(input => input.checked = false);
        }
    }
}

function toggleSubtopicSelection(topicId, subtopicId, isChecked) {
    // Se selecionar um subt√≥pico, garantimos que o pai est√° selecionado
    if (isChecked) {
        if (!currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = [];
            // Atualiza visualmente o checkbox do pai na esquerda
            renderTopicsSelectionList(); // Re-renderiza para atualizar o check
        }
        if (!currentNoteTopics[topicId].includes(subtopicId)) {
            currentNoteTopics[topicId].push(subtopicId);
        }
    } else {
        // Remove o subt√≥pico do array
        if (currentNoteTopics[topicId]) {
            currentNoteTopics[topicId] = currentNoteTopics[topicId].filter(id => id !== subtopicId);
        }
    }
}

editorToolbar.addEventListener('mousedown', (e) => {
    
    // --- 1. VERIFICA√á√ÉO DE PONTOS (‚Ä¢‚Ä¢) ---
    if (e.target.classList.contains('dots-trigger')) {
        e.preventDefault();
        e.stopPropagation();

        // Identifica qual o bot√£o pai (B ou I)
        const parentBtn = e.target.closest('button');
        const command = parentBtn.dataset.command;
        
        let popupId = '';
        if (command === 'boldBlue') popupId = 'bold-palette-popup';
        if (command === 'italic')   popupId = 'italic-palette-popup'; // Novo ID

        const popup = document.getElementById(popupId);
        if (!popup) return;

        // Fecha outros popups para n√£o sobrepor
        document.querySelectorAll('#bold-palette-popup, #italic-palette-popup').forEach(p => {
            if(p.id !== popupId) p.style.display = 'none';
        });

        document.body.appendChild(popup);

        if (popup.style.display === 'block') {
            popup.style.display = 'none';
        } else {
            const rect = e.target.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed';
            popup.style.zIndex = "5000";
            popup.style.top = `${rect.bottom + 5}px`;
            popup.style.left = `${rect.left - 100}px`; 
        }
        return; 
    }

    // --- 2. VERIFICA√á√ÉO DE BOT√ÉO (Corpo) ---
    const target = e.target.closest('button');
    if (!target || target.tagName === 'INPUT') return;

    if (target.dataset.command) {
        e.preventDefault(); 
        const command = target.dataset.command;

        // A. Negrito Unificado (boldBlue agora age como bold normal)
        if (command === 'boldBlue' || command === 'bold') {
            // Apenas aplica/remove o negrito (sem for√ßar cor)
            document.execCommand('bold', false, null);
        } 
        // B. It√°lico
        else if (command === 'italic') {
            document.execCommand('italic', false, null);
        }
        // C. Tamanho Fonte
        else if (command.includes('FontSize')) {
            /* ... (c√≥digo existente de tamanho) ... */
             const currentSize = window.getComputedStyle(noteContentEditor, null).getPropertyValue('font-size');
            let newSize = parseFloat(currentSize) + (command === 'increaseFontSize' ? 1 : -1);
            document.execCommand("fontSize", false, "7");
            const selection = window.getSelection();
            if (selection.anchorNode && selection.anchorNode.parentNode) {
                let fontElement = selection.anchorNode.parentNode;
                if (fontElement.nodeType === 3) fontElement = fontElement.parentNode;
                if (fontElement.tagName === 'FONT') {
                    fontElement.removeAttribute('size');
                    fontElement.style.fontSize = newSize + "px";
                }
            }
        } 
        // D. Outros
        else {
            document.execCommand(command, false, null);
        }
        saveNote();
    }
});



// ------------------------------------------------------------------
// L√ìGICA DE MARCADORES (BOOKMARKS)
// ------------------------------------------------------------------

// 1. Abrir o Modal Principal de Marcadores
async function openBookmarksModal() {
    console.log("üöÄ [IN√çCIO] openBookmarksModal acionado.");
    
    const modal = document.getElementById('bookmarks-modal');
    const list = document.getElementById('bookmarks-list');
    
    if (!modal || !list) {
        console.error("‚ùå [ERRO] Elementos do modal n√£o encontrados no DOM.");
        return;
    }

    // 1. FOR√áAR EXIBI√á√ÉO IMEDIATA (Para sabermos que o JS chegou aqui)
    document.body.appendChild(modal); // Move para a raiz para evitar ser tapado
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
    modal.style.opacity = "1";
    modal.style.visibility = "visible";

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar marcadores...</span></div>';

    if (!activeReferenceEntity || activeReferenceEntity.type !== 'textobiblico') {
        console.warn("‚ö†Ô∏è Entidade ativa n√£o √© texto b√≠blico ou est√° vazia.", activeReferenceEntity);
        list.innerHTML = '<li style="padding:20px; color:orange;">Selecione um vers√≠culo b√≠blico primeiro.</li>';
        return;
    }

    try {
        const nameToFind = activeReferenceEntity.name;
        const myUid = auth.currentUser.uid;
        console.log("üì° [FIREBASE] Iniciando busca para:", nameToFind, "UID:", myUid);

        // A. Buscar se o texto j√° existe no DB do usu√°rio
        const qTexto = query(
            collection(db, 'textosbiblicos'), 
            where('nome', '==', nameToFind),
            where('userId', '==', myUid)
        );
        
        const textoSnap = await getDocs(qTexto);
        let marcadoresAssociados = {};
        
        if (!textoSnap.empty) {
            console.log("‚úÖ Texto b√≠blico encontrado no DB.");
            const data = textoSnap.docs[0].data();
            marcadoresAssociados = data.marcadoresAssociados || {};
            activeReferenceEntity.id = textoSnap.docs[0].id;
        } else {
            console.log("‚ÑπÔ∏è Texto b√≠blico novo (ainda n√£o est√° no DB).");
        }

        // B. Buscar lista global de Marcadores do usu√°rio
        console.log("üì° [FIREBASE] Buscando lista de g√™neros de marcadores...");
        const qMarcadores = query(
            collection(db, 'marcadores'), 
            where('userId', '==', myUid), 
            orderBy('nome')
        );
        
        const marcadoresSnap = await getDocs(qMarcadores);
        console.log("üìä Total de marcadores encontrados:", marcadoresSnap.size);

        list.innerHTML = '';

        if (marcadoresSnap.empty) {
            list.innerHTML = `
                <li style="padding: 20px; text-align: center; color: #888;">
                    Nenhum marcador criado.<br>
                    <button class="modal-btn primary" style="margin-top:10px;" onclick="document.getElementById('open-create-bookmark-btn').click()">+ Criar Novo Marcador</button>
                </li>`;
            return;
        }

        marcadoresSnap.forEach(docSnap => {
            const marcador = { id: docSnap.id, ...docSnap.data() };
            const isChecked = !!marcadoresAssociados[marcador.id]; 

            const li = document.createElement('li');
            li.className = `bookmark-item ${isChecked ? 'active' : ''}`;
            li.innerHTML = `
                <div class="bookmark-info">
                    <span class="bookmark-title">${marcador.nome}</span>
                    <span class="bookmark-desc">${marcador.descricao || ''}</span>
                </div>
                <div class="bookmark-check"></div>
            `;

            li.onclick = () => toggleBookmark(marcador.id, !li.classList.contains('active'), li);
            list.appendChild(li);
        });

    } catch (error) {
        console.error("‚ùå [ERRO CR√çTICO] Falha no openBookmarksModal:", error);
        list.innerHTML = `<li style="color:red; padding:20px;">
            <strong>Erro ao carregar:</strong><br>
            ${error.message}<br><br>
            <small>Verifique se os √≠ndices do Firestore foram criados.</small>
        </li>`;
    }
}

async function toggleBookmark(marcadorId, shouldAdd, liElement) {
    // Atualiza√ß√£o Visual Imediata (Feedback R√°pido)
    if (shouldAdd) liElement.classList.add('active');
    else liElement.classList.remove('active');

    // Atualiza o listener para o pr√≥ximo clique (toggle inverso)
    liElement.onclick = () => toggleBookmark(marcadorId, !shouldAdd, liElement);

    // Atualiza T√≠tulo em Tempo Real
    const activeCount = document.querySelectorAll('#bookmarks-list .bookmark-item.active').length;
    const titleElement = document.getElementById('references-panel-title');
    const entityName = activeReferenceEntity.name;

    if (titleElement) {
        titleElement.textContent = activeCount > 0 
            ? `Refer√™ncias para üîñ"${entityName}"` 
            : `Refer√™ncias para "${entityName}"`;
    }

    try {
        const { collection, query, where, getDocs, addDoc, updateDoc, doc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let targetId = activeReferenceEntity.id;
        let docRef;

        // 1. VERIFICA√á√ÉO DE EXIST√äNCIA (O Segredo da Corre√ß√£o)
        // Se o ID for igual ao Nome (indicando que ainda n√£o tem ID real) ou se sabemos que √© novo
        const q = query(
            collection(db, 'textosbiblicos'), 
            where('nome', '==', entityName),
            where('userId', '==', auth.currentUser.uid)
        );
        
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            // --- CEN√ÅRIO A: N√ÉO EXISTE -> CRIAR NOVO ---
            console.log("üÜï Criando registo para o vers√≠culo na BD...");
            
            const newDoc = await addDoc(collection(db, 'textosbiblicos'), {
                nome: entityName,
                descricao: "", // Descri√ß√£o vazia por defeito
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                // Se estamos a adicionar, j√° cria com o marcador. Se for remover (raro num novo), cria vazio.
                marcadoresAssociados: shouldAdd ? { [marcadorId]: true } : {},
                referencias: {} 
            });

            // Atualiza o ID globalmente para pr√≥ximos cliques n√£o criarem duplicados
            targetId = newDoc.id;
            activeReferenceEntity.id = newDoc.id;
            
            console.log("‚úÖ Vers√≠culo criado com ID:", targetId);
            return; // Sai, pois o addDoc j√° gravou o marcador
        } else {
            // --- CEN√ÅRIO B: J√Å EXISTE -> PEGAR ID REAL ---
            targetId = snapshot.docs[0].id;
            activeReferenceEntity.id = targetId; // Atualiza refer√™ncia para garantir
        }

        // 2. ATUALIZA√á√ÉO (UPDATE)
        docRef = doc(db, 'textosbiblicos', targetId);

        if (shouldAdd) {
            await updateDoc(docRef, { [`marcadoresAssociados.${marcadorId}`]: true });
        } else {
            await updateDoc(docRef, { [`marcadoresAssociados.${marcadorId}`]: deleteField() });
        }

    } catch (error) {
        console.error("‚ùå Erro ao atualizar marcador:", error);
        alert("Erro de conex√£o ao gravar marcador.");
        
        // Reverter visual em caso de erro
        if (shouldAdd) liElement.classList.remove('active');
        else liElement.classList.add('active');
    }
}

// --- FUN√á√ÉO UTILIT√ÅRIA PARA O PROMPT PERSONALIZADO ---
window.showCustomInput = function(title, namePlaceholder = "", initialValue = "") {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-input-modal');
        if (!modal) return resolve(null);

        const titleEl = document.getElementById('custom-input-title');
        const nameInput = document.getElementById('custom-input-name');
        const descInput = document.getElementById('custom-input-desc'); // √Årea da descri√ß√£o
        const confirmBtn = document.getElementById('custom-input-confirm');
        const cancelBtn = document.getElementById('custom-input-cancel');

        // --- O SEGREDO: ESCONDER A DESCRI√á√ÉO ---
        if (descInput) {
            descInput.style.display = 'none'; // Esconde a caixa de texto
            // Esconde tamb√©m a etiqueta (label) que est√° logo acima dela
            if (descInput.previousElementSibling) {
                descInput.previousElementSibling.style.display = 'none';
            }
        }

        document.body.appendChild(modal);

        modal.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            background-color: rgba(0, 0, 0, 0.9) !important;
            z-index: 2147483647 !important;
            justify-content: center !important;
            align-items: center !important;
            pointer-events: auto !important;
        `;

        titleEl.textContent = title;
        nameInput.value = initialValue;
        nameInput.placeholder = namePlaceholder;

        // Foco autom√°tico no Nome para abrir o teclado
        setTimeout(() => {
            nameInput.focus();
            const len = nameInput.value.length;
            nameInput.setSelectionRange(len, len);
        }, 300);

        const cleanup = () => { 
            modal.style.setProperty('display', 'none', 'important'); 
        };

        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        const newCancel = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        newConfirm.onclick = (e) => {
            e.preventDefault();
            const val = nameInput.value.trim();
            if (!val) return;
            cleanup();
            // Retorna apenas o nome, descri√ß√£o vai vazia
            resolve({ name: val, description: "" }); 
        };

        newCancel.onclick = () => {
            cleanup();
            resolve(null);
        };
    });
};



// ============================================================
// L√ìGICA DO MODAL DE GEST√ÉO (CRIAR T√ìPICOS)
// ============================================================

// A. LISTENER DE CLIQUE NO BOT√ÉO üìã
noteContentEditor.addEventListener('click', (e) => {

    const topicBtn = e.target.closest('button[data-action="manage-mini-note-topics"]');
    
    if (topicBtn) {
        console.log("‚úÖ Bot√£o üìã identificado com sucesso!");
        e.preventDefault(); 
        e.stopPropagation();
        
        const wrapper = topicBtn.closest('.mini-note-wrapper');
        if (wrapper) {
            console.log("üì¶ Pai .mini-note-wrapper encontrado (ID:", wrapper.id, ")");
            openTopicsModalForMiniNote(wrapper);
        } else {
            console.error("‚ùå ERRO: Clique no bot√£o üìã mas n√£o encontrei o pai .mini-note-wrapper.");
        }
    } else {
    }
});

// OUVINTE PARA O FEED DO ARQUIVO (Caso use t√≥picos l√° tamb√©m)
const archiveFeedEl = document.getElementById('archive-feed');
if (archiveFeedEl) {
    archiveFeedEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="manage-mini-note-topics"]');
        if (btn) {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openTopicsModalForMiniNote(wrapper);
        }
    });
}

// B. FUN√á√ÉO PARA ABRIR O MODAL (Modo SubNota)
window.openTopicsModalForMiniNote = async function(wrapperElement) {
    console.log("üöÄ [T√ìPICOS] Iniciando abertura para caixa...");

    if (!wrapperElement) return console.error("‚ùå [ERRO] wrapperElement nulo.");

    // 1. Configura√ß√£o de Estado Global
    window.activeMiniNoteElement = wrapperElement; 
    window.topicTargetId = null; 

    // 2. Leitura dos Dados
    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    try {
        currentNoteTopics = JSON.parse(topicsString);
    } catch (e) {
        console.warn("‚ö†Ô∏è JSON de t√≥picos inv√°lido, resetando.");
        currentNoteTopics = {};
    }

    // 3. CAPTURA E MOVIMENTA√á√ÉO DO MODAL
    const modal = document.getElementById('topics-modal');
    if (!modal) return console.error("‚ùå Modal #topics-modal n√£o encontrado!");

    // Move para o body (topo da hierarquia)
    document.body.appendChild(modal);

    // 4. FOR√áAR VISIBILIDADE SUPREMA (Z-Index: 2147483647)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.85) !important;
        justify-content: center !important;
        align-items: center !important;
    `;

    // 5. Configura√ß√£o Visual
    const modalTitle = modal.querySelector('h3');
    if (modalTitle) {
        const isQuestion = wrapperElement.classList.contains('question-mode');
        modalTitle.textContent = isQuestion ? "T√≥picos da Quest√£o" : "T√≥picos do Bloco";
    }

    // Reset de busca e sele√ß√£o anterior
    activeTopicIdForSelection = null;
    const subList = document.getElementById('subtopics-list-select');
    if(subList) subList.innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico √† esquerda.</li>';

    // 6. Carregar a Lista
    if (typeof renderTopicsSelectionList === 'function') {
        await renderTopicsSelectionList();
    } else {
        console.error("‚ùå Fun√ß√£o renderTopicsSelectionList n√£o encontrada!");
    }
};

// --- FUN√á√ÉO UNIFICADA E √öNICA PARA O BOT√ÉO GRAVAR T√ìPICOS ---
document.getElementById('save-topics-btn').onclick = async () => {
    const btn = document.getElementById('save-topics-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "A gravar...";

    try {
        // --- CEN√ÅRIO A: Caixa Individual (Aqu√°rio ou Subnota) ---
        if (window.activeMiniNoteElement) {
            console.log("üíæ Gravando t√≥picos na CAIXA...");
            
            // 1. Atualiza o atributo HTML
            window.activeMiniNoteElement.setAttribute('data-topics', JSON.stringify(currentNoteTopics));
            
            // 2. Atualiza visual do bot√£o na caixa (se existir)
            if (typeof updateMiniNoteButtonState === 'function') {
                updateMiniNoteButtonState(window.activeMiniNoteElement);
            }

            // 3. DECIS√ÉO DE GRAVA√á√ÉO (Aqu√°rio vs Nota)
            const isAquarium = document.getElementById('aquarium-environment').style.display !== 'none';
            
            if (isAquarium) {
                console.log("üåä [AQU√ÅRIO] Gravando estado global...");
                if (typeof window.saveAquariumState === 'function') await window.saveAquariumState();
            } else {
                console.log("üìÑ [NOTA] Gravando nota...");
                // Se for subnota normal, grava a nota inteira
                // (Se for caixa do Arquivo, a l√≥gica de arquivo trata disso)
                if (selectedNoteId && typeof saveNote === 'function') await saveNote(true);
            }
        } 
        
        // --- CEN√ÅRIO B: Nota ou Pasta Principal (Gest√£o Global) ---
        else if (window.topicTargetId) {
            console.log("üíæ Gravando T√≥picos na NOTA:", window.topicTargetId);
            
            // (C√≥digo de grava√ß√£o da nota mant√©m-se igual, pois o Aqu√°rio n√£o usa topicTargetId)
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const hybridToggle = document.getElementById('hybrid-mode-toggle');
            const isHybridActive = hybridToggle ? hybridToggle.checked : false;

            const updateData = {
                topicosSelecionados: currentNoteTopics,
                ancorasSelecionadas: currentNoteAnchors,
                isHybridMode: isHybridActive,
                ultimaedicao: serverTimestamp()
            };

            const itemRef = doc(db, 'pastas', window.topicTargetId);
            await updateDoc(itemRef, updateData);

            // Atualiza√ß√£o da Interface (Abas do meio)
            activeNoteAnchorsIds = Object.keys(currentNoteAnchors);
            window.currentNoteHybridMode = isHybridActive;
            if (typeof refreshMiddlePanelTabIcon === 'function') refreshMiddlePanelTabIcon();
            if (window.topicTargetId === selectedNoteId) updateSaveStatus('saved');
        }

        // FECHAR MODAL
        document.getElementById('topics-modal').style.display = 'none';

    } catch (error) {
        console.error("‚ùå Erro ao gravar t√≥picos:", error);
        alert("Erro ao gravar.");
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

document.getElementById('manage-topics-btn').addEventListener('click', () => {
    activeTopicIdForManagement = null;
    document.getElementById('manage-topics-modal').style.display = 'flex';
    renderManageTopicsList();
    document.getElementById('create-new-subtopic-btn').style.display = 'none';
    document.getElementById('subtopics-list-manage').innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico.</li>';
});

document.getElementById('close-manage-topics-btn').addEventListener('click', () => {
    document.getElementById('manage-topics-modal').style.display = 'none';
    // Recarrega a lista de sele√ß√£o principal para mostrar os novos itens
    renderTopicsSelectionList(); 
});

// --- Renderiza√ß√£o Gest√£o ---

async function renderManageTopicsList(filterText = '') {
    const list = document.getElementById('topics-list-manage');
    if (!list) return;

    list.innerHTML = '<li>Carregando...</li>';

    try {
        const q = query(
            collection(db, 'topicos'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('nome')
        );
        const snapshot = await getDocs(q);
        
        list.innerHTML = '';
        
        snapshot.forEach(docSnap => {
            const topic = { id: docSnap.id, ...docSnap.data() };
            if (filterText && !topic.nome.toLowerCase().includes(filterText.toLowerCase())) return;

            const li = document.createElement('li');
            li.textContent = topic.nome;
            if (topic.id === activeTopicIdForManagement) li.classList.add('active-topic');
            
            li.onclick = () => {
                document.querySelectorAll('#topics-list-manage li').forEach(el => el.classList.remove('active-topic'));
                li.classList.add('active-topic');
                activeTopicIdForManagement = topic.id;
                
                const createSubBtn = document.getElementById('create-new-subtopic-btn');
                if (createSubBtn) {
                    createSubBtn.style.display = 'block';
                    createSubBtn.textContent = `+ Subt√≥pico em "${topic.nome}"`;
                }
                
                renderManageSubtopicsList(topic.id);
            };
            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erro ao carregar gest√£o de t√≥picos:", e);
    }
}

async function renderManageSubtopicsList(topicId) {
    const list = document.getElementById('subtopics-list-manage');
    list.innerHTML = '<li>Carregando...</li>';

    const q = query(collection(db, 'subtopicos'), where('topicId', '==', topicId), where('userId', '==', auth.currentUser.uid), orderBy('nome'));
    const snapshot = await getDocs(q);

    list.innerHTML = '';
    if (snapshot.empty) {
        list.innerHTML = '<li style="color:#888; padding:10px;">Sem subt√≥picos.</li>';
        return;
    }

    snapshot.forEach(doc => {
        const sub = doc.data();
        const li = document.createElement('li');
        li.textContent = sub.nome;
        li.style.cursor = 'default'; // Apenas visualiza√ß√£o na gest√£o
        list.appendChild(li);
    });
}

// --- Pesquisa ---
document.getElementById('search-topic-input').addEventListener('input', (e) => {
    renderManageTopicsList(e.target.value);
});

// --- Cria√ß√£o de Novos Itens ---

document.getElementById('create-new-topic-btn').addEventListener('click', async () => {
    const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina...");
    
    // Verifica se result existe e se tem nome (descri√ß√£o √© opcional)
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'topicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageTopicsList(document.getElementById('search-topic-input').value);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar t√≥pico."); 
        }
    }
});


 document.getElementById('create-new-subtopic-btn').addEventListener('click', async () => {
    if (!activeTopicIdForManagement) return;
    
    const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo...");
    
    if (result && result.name) {
        try {
            await addDoc(collection(db, 'subtopicos'), {
                nome: result.name,
                descricao: result.description, // Grava a descri√ß√£o
                topicId: activeTopicIdForManagement,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            // Atualiza a lista na hora
            renderManageSubtopicsList(activeTopicIdForManagement);
        } catch (e) { 
            console.error(e); 
            alert("Erro ao criar subt√≥pico."); 
        }
    }
});

// --- LIGAR O BOT√ÉO DA BARRA DE FERRAMENTAS ---


// 2. EVENTO INPUT: Exclusivo para o Seletor de Cores
// O seletor de cores precisa do evento 'input' para funcionar em tempo real
editorToolbar.addEventListener('input', (e) => {
    const target = e.target;
    // Verifica se √© o input de cor da barra
    if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
        document.execCommand('foreColor', false, target.value);
        saveNote(); 
    }
});




/**
 * Remove a refer√™ncia de uma nota a uma entidade de texto b√≠blico.
 * Se for a √∫ltima refer√™ncia, apaga a pr√≥pria entidade.
 * @param {string} entityName O nome da entidade de texto b√≠blico (ex: "Daniel 4:3")
 */
async function cleanupBiblicalEntityReference(entityName) {
    if (!selectedNoteId || !entityName) return;

    const collectionRef = collection(db, 'textosbiblicos');
    const q = query(collectionRef, where("nome", "==", entityName));
    
    try {
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            return;
        }

        const entityDoc = snapshot.docs[0];
        const entityRef = entityDoc.ref;
        const entityData = entityDoc.data();
        const references = entityData.referencias || {};
        
        // Verifica se a nota atual est√° nas refer√™ncias
        if (references[selectedNoteId]) {
            const numReferences = Object.keys(references).length;

            if (numReferences === 1) {
                // √â a √∫ltima refer√™ncia, apagar o documento inteiro
                await deleteDoc(entityRef);
            } else {
                // Existem outras refer√™ncias, remover apenas a atual

                await updateDoc(entityRef, {
                    [`referencias.${selectedNoteId}`]: deleteField()
                });
            }
            
            // Atualiza o cache de entidades local
            await fetchAllEntities();
        }

    } catch (error) {
        console.error(`Erro ao limpar a refer√™ncia para "${entityName}":`, error);
    }
}

async function fetchAllEntities() {
    if (!auth.currentUser) return;
    allEntities = {}; 
    for (const type in ENTITY_CONFIG) {
        const config = ENTITY_CONFIG[type];
        const collectionName = config.collection;
        try {
            const q = query(
                collection(db, collectionName), 
                where('userId', '==', auth.currentUser.uid)
            );
            
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                allEntities[type] = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    nome: doc.data().nome,
                    tipo: type,
                    descricao: doc.data().descricao,
                    ancorasAssociadas: doc.data().ancorasAssociadas || {},
                    // --- NOVA LINHA: Carregar o Emoji do Cosmos/Subcosmos ---
                    emoji: doc.data().emoji 
                }));
            }
        } catch (error) {
            console.error(`Erro ao carregar a cole√ß√£o ${collectionName}:`, error);
        }
    }
}

function resetEditor() {
    // 1. LIMPEZA DE POPUPS
    window.closeAllFloatingPopups();

    // >>> REINICIAR MEM√ìRIA DA ABA MOBILE <<<
    window.lastActiveMobileTab = 'index'; 

    // 2. Desliga o ouvinte da nota em tempo real
    if (unsubscribeCurrentNote) {
        unsubscribeCurrentNote();
        unsubscribeCurrentNote = null;
    }

    if (typeof leaveArchivePresence === 'function') leaveArchivePresence(); 
    if (typeof toggleJournalToolbar === 'function') toggleJournalToolbar(false);
    
    selectedNoteId = null;
    currentArchiveId = null; 
    activeEditingPostId = null; 

    if (document.getElementById('insertion-popup')) document.getElementById('insertion-popup').style.display = 'none';

    const editorArea = document.getElementById('editor-area');
    const placeholder = document.getElementById('editor-placeholder');
    const archiveArea = document.getElementById('archive-area');

    if (editorArea) editorArea.style.setProperty('display', 'none', 'important');
    if (archiveArea) archiveArea.style.setProperty('display', 'none', 'important');
    if (placeholder) placeholder.style.display = 'flex';

    const tabsBar = document.querySelector('.middle-bottom-tabs');
    if (tabsBar) tabsBar.style.display = 'none';

    const filesTabBtn = document.querySelector('button[data-mid-tab="files"]');
    if (filesTabBtn) filesTabBtn.click();

    document.querySelectorAll('#middle-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('#file-list .list-item.selected').forEach(el => el.classList.remove('selected', 'selected-red'));
    
    updateSaveStatus('hidden');
}

function fetchAndDisplayItems(parentId, listElement, selectedId = null) {
    if (!auth.currentUser) return;

    // 1. Mostrar Roda
    listElement.innerHTML = `
        <div class="panel-loader">
            <div class="spinner"></div>
            <span>A carregar...</span>
        </div>`;

    let allowedTypes = currentViewMode === 'local' 
        ? ['pasta', 'nota', 'agregacao', 'arquivo', 'jornal', 'aquario'] 
        : ['pasta', 'nota', 'agregacao', 'arquivo', 'partilhado', 'jornal', 'aquario'];

    const itemsRef = collection(db, 'pastas');
    
    let constraints = [
        where('parentId', '==', parentId), 
        where('estado', '==', 'ativa'), 
        where('userId', '==', auth.currentUser.uid), 
        where('tipo', 'in', allowedTypes), 
        orderBy('ordem')
    ];

    const q = query(itemsRef, ...constraints);

    // Adicionamos { includeMetadataChanges: true } para saber se vem da cache ou servidor
    return onSnapshot(q, { includeMetadataChanges: true }, (querySnapshot) => {
        
        // ============================================================
        // L√ìGICA ANTI-PISCAR (CACHE DOS ARQUIVOS)
        // ============================================================
        const isCached = querySnapshot.metadata.fromCache;
        const isOnline = navigator.onLine;

        // Verifica se os itens que vieram s√£o EXCLUSIVAMENTE Arquivos ou Partilhados
        // (Porque esses s√£o os √∫nicos que est√£o sempre em cache devido ao sistema de notifica√ß√µes)
        let onlyArchivesFound = true;
        
        if (querySnapshot.empty) {
            onlyArchivesFound = false;
        } else {
            querySnapshot.forEach(doc => {
                const t = doc.data().tipo;
                // Se encontrar qualquer coisa que N√ÉO seja arquivo, ent√£o √© uma carga mista v√°lida
                if (t !== 'arquivo' && t !== 'partilhado') {
                    onlyArchivesFound = false;
                }
            });
        }

        // A REGRA DE OURO:
        // Se estamos Online + Os dados v√™m da Cache + E s√£o s√≥ Arquivos...
        // ...ENT√ÉO ignoramos esta carga e deixamos a roda a girar √† espera do Servidor.
        if (isOnline && isCached && !querySnapshot.empty && onlyArchivesFound) {
            console.log("‚è≥ [LOADER] Cache parcial de Arquivos detetada. A aguardar lista completa...");
            return; 
        }
        // ============================================================

        const fragment = document.createDocumentFragment();
        const isColumn1 = (listElement.id === 'left-panel-list');

        if (querySnapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; text-align:center; color:#888; font-style:italic;">Pasta vazia.</li>';
            return;
        }

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            
            if (currentViewMode === 'local' && item.oque === 'flash') return;

            const li = document.createElement('li');
            li.className = 'list-item';
            
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo);
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-userid', item.userId);
            li.setAttribute('data-partilhado', item.partilhado || 'inativo');
            li.setAttribute('data-parent-id', item.parentId || "null");
            li.setAttribute('data-protected', (item.passe && item.passe.trim() !== "") ? "true" : "false");
            li.setAttribute('data-pinned', item.isPinned ? "true" : "false");
            li.setAttribute('data-superpasta', item.superpasta || "false");
            
            if (item.customIcon) {
                li.style.setProperty('--custom-icon', `"${item.customIcon}"`);
            }

            let lockIcon = (item.passe && item.passe.trim() !== "") ? "üîí " : "";
            
            let badgeHTML = "";
            if (item.tipo === 'arquivo' || item.tipo === 'partilhado') {
                const unreadCount = window.folderUnreadCounts ? (window.folderUnreadCounts[item.id] || 0) : 0;
                if (unreadCount > 0) {
                    badgeHTML = `<span class="unread-count-badge" style="margin-left:auto; margin-right:5px;">${unreadCount > 9 ? '9+' : unreadCount}</span>`;
                }
            }
            
            li.innerHTML = `
                <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-grow:1;">${lockIcon}${item.nome}</span>
                ${badgeHTML}
                <button class="item-menu-btn">‚Ä¶</button>
            `;

            let active = false;
            if (selectedId && item.id === selectedId) {
                active = true;
            } else if (isColumn1) {
                if (item.id === col1SelectedId) active = true;
                else if (navigationStack.some(nav => nav.id === item.id)) active = true;
            } else {
                if (window.nextSelectedId) {
                    if (item.id === window.nextSelectedId) active = true;
                } else if (selectedNoteId && item.id === selectedNoteId) {
                    active = true;
                }
            }

            if (active) {
                if (isColumn1) li.classList.add('selected');
                else {
                    const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                    li.classList.add(selectionClass);
                    setTimeout(() => li.scrollIntoView({ block: 'nearest' }), 100);
                }
            }

            fragment.appendChild(li);
        });

        // Remove a roda e mostra tudo de uma vez
        listElement.innerHTML = '';
        listElement.appendChild(fragment);
        
    }, (error) => {
        console.error("Erro ao carregar itens:", error);
        listElement.innerHTML = '<li style="color:red; padding:20px;">Erro de liga√ß√£o.</li>';
    });
}


 async function updateNavigationView(keepEditorOpen = false, targetSelectId = null) {
    // 1. Atualiza√ß√µes Globais
    updateMobileFABVisibility();
    notebookContainer.classList.remove('left-panel-collapsed');

    // Limpeza de Ouvintes (Apenas do painel do MEIO sempre)
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    if (!keepEditorOpen) {
        resetEditor();
    }

    const depth = navigationStack.length;

    // ============================================================
    // CASO A: ABA "LISTS" (T√≥picos, B√≠blia, Personagens...)
    // ============================================================
    if (currentTab === 'lists') {
        // Marca o cache como 'LISTS' para for√ßar recarregamento se voltar √† aba 'note' depois
        lastRenderedLeftParentId = 'LISTS_MODE';

        const activeCategory = navigationStack.length > 0 ? navigationStack[0].id : null;

        // 1. Gerar categorias (Raiz da Aba Lists)
        // Nota: O HTML √© gerado manualmente aqui, n√£o vem do fetchAndDisplayItems
        const categories = [
            { id: 'topico', icon: 'üìë', name: 'T√≥picos' },
            { id: 'destaque', icon: 'üé®', name: 'Destaques' },
            { separator: true },
            { id: 'biblia-root', icon: 'üìñ', name: 'B√≠blia' }, 
            { id: 'textobiblico', icon: 'üìú', name: 'Textos B√≠blicos' },
            { id: 'marcadores', icon: 'üîñ', name: 'Marcadores' },
            { separator: true },
            { id: 'personagem', icon: 'üë§', name: 'Personagens' },
            { id: 'local', icon: 'üìç', name: 'Locais' },
            { id: 'data', icon: 'üìÖ', name: 'Datas' },
            { id: 'cosmos', icon: 'ü™ê', name: 'Cosmos' },
            { id: 'tag', icon: 'üè∑Ô∏è', name: 'Tags' }
        ];

        let categoriesHTML = '';
        categories.forEach(cat => {
            if (cat.separator) {
                categoriesHTML += `<hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 5px; opacity: 0.3;">`;
            } else {
                const isSelected = activeCategory === cat.id ? 'selected' : '';
                
                // Bot√£o extra para abrir B√≠blia em nova janela
                let extraAction = '';
                if (cat.id === 'biblia-root') {
                    extraAction = `<button class="external-open-btn" title="Abrir Leitura em Nova Janela" onclick="event.stopPropagation(); window.open('bible.html', '_blank');">‚ÜóÔ∏è</button>`;
                }
                
                categoriesHTML += `
                <li class="list-item ${isSelected}" data-type="list-category" data-id="${cat.id}">
                    <span style="flex-grow: 1;">${cat.icon} ${cat.name}</span>
                    ${extraAction}
                </li>`;
            }
        });

        // 2. Renderizar Coluna 1
        leftPanelList.innerHTML = categoriesHTML;

        // 3. Configurar T√≠tulos e Coluna 2
        if (depth === 0) {
            // Estarmos na Raiz das Listas
            addItemBtn.style.display = 'none';
            setLeftPanelTitle('Categorias'); 
            middlePanelTitle.textContent = 'Selecione uma categoria';
            middlePanelList.innerHTML = '';
            backBtn.style.display = 'none';
        } else {
            // Entr√°mos numa categoria (Ex: Clicou em "Personagens")
            const currentContext = navigationStack[depth - 1];
            setLeftPanelTitle('Categorias', true); 
            middlePanelTitle.textContent = currentContext.name;
            backBtn.style.display = 'flex';
            
            // L√≥gica do bot√£o "+" (Amarelo)
            const rootCategoryId = navigationStack[0].id;
            const validYellowCategories = ['topico', 'personagem', 'local', 'data', 'marcadores', 'cosmos']; 
            
            // S√≥ mostra o "+" se for uma categoria edit√°vel
            if (validYellowCategories.includes(rootCategoryId)) {
                updateAddButtonState(true, true);
            } else {
                updateAddButtonState(false);
            }

            // Carrega o conte√∫do da Coluna 2
            renderListCategoryItems(currentContext.id);
        }
        return; // SAI DA FUN√á√ÉO AQUI (N√£o executa l√≥gica de pastas)
    }

    // ============================================================
    // CASO B: ABA "NOTE" (Pastas, Arquivos, Notas)
    // ============================================================
    
    // --- MODO PINS (Opcional, se usar) ---
    if (currentViewMode === 'pins') {
        addItemBtn.style.display = 'none'; 
        backBtn.style.display = 'none';
        setLeftPanelTitle('Pins'); 
        loadPinsView(); 
        return; 
    }

    // --- MODO NORMAL (Local, Partilha, Flash) ---
    addItemBtn.style.display = 'flex';
    addItemBtn.classList.remove('yellow-mode');

    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // 1. T√≠tulos
    if (depth === 0) {
        setLeftPanelTitle(currentViewMode === 'local' ? 'Pastas' : 'Partilha'); 
    } else {
        const parentFolder = (depth > 1) ? navigationStack[depth - 2] : null;
        const parentName = parentFolder ? parentFolder.name : (currentViewMode === 'shared' ? 'Partilhadas' : 'Pastas');
        setLeftPanelTitle(parentName, true);
    }

    // 2. Determinar IDs para as Colunas
    let newLeftPanelParentId = null;
    let middlePanelParentId = null;

    if (depth === 0) {
        // RAIZ
        if (currentViewMode === 'shared') {
            newLeftPanelParentId = "EMPTY_SIDEBAR_FOR_SHARED";
        } else {
            newLeftPanelParentId = isSuperContext ? SUPERFOLDER_ID : null;
        }
        middlePanelTitle.textContent = 'Selecione';
        middlePanelList.innerHTML = '';
        backBtn.style.display = 'none';
        
        if (currentViewMode === 'shared') loadSharedFilesRoot();
    } else {
        // DENTRO DE PASTAS
        const currentFolder = navigationStack[depth - 1];
        middlePanelParentId = currentFolder.id;
        middlePanelTitle.textContent = currentFolder.name;
        backBtn.style.display = 'flex';
        
        if (depth === 1) {
            newLeftPanelParentId = (currentViewMode === 'local') ? (isSuperContext ? SUPERFOLDER_ID : null) : "EMPTY_SIDEBAR_FOR_SHARED";
        } else {
            newLeftPanelParentId = navigationStack[depth - 2].id;
        }
    }
    
    // ============================================================
    // APLICA√á√ÉO DA L√ìGICA DE CACHE (S√≥ para pastas)
    // ============================================================
    
    // COLUNA 1 (ESQUERDA) - Cache Inteligente
    if (newLeftPanelParentId !== lastRenderedLeftParentId) {
        console.log("üîÑ [COL 1] Contexto mudou. A carregar dados...");
        
        if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
        
        // Se for modo partilhado na raiz, n√£o carrega pastas normais na esquerda
        if (newLeftPanelParentId !== "EMPTY_SIDEBAR_FOR_SHARED") {
            unsubscribeLeftPanel = fetchAndDisplayItems(newLeftPanelParentId, leftPanelList, null);
        } else {
            leftPanelList.innerHTML = ''; // Limpa se for partilha raiz
        }
        
        lastRenderedLeftParentId = newLeftPanelParentId;
    } 
    else {
        console.log("‚ö° [COL 1] Contexto igual. Apenas atualizando sele√ß√£o visual.");
        // Apenas muda o destaque azul
        const activeId = (depth > 0) ? navigationStack[depth - 1].id : null;
        highlightLeftPanelItem(activeId);
    }

    // COLUNA 2 (MEIO) - Carrega Sempre
    if (middlePanelParentId) {
        unsubscribeMiddlePanel = fetchAndDisplayItems(middlePanelParentId, middlePanelList, targetSelectId);
    }
}



// 2. Cria Regex que entende acentos (ex: "joao" vira regex para encontrar "jo√£o", "Jo√£o", "J√íAO")
function getAccentInsensitiveRegex(term, isExact = false) {
    const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    let regexStr = escaped
        .replace(/a/gi, '[a√†√°√¢√£√§√•]')
        .replace(/e/gi, '[e√®√©√™√´]')
        .replace(/i/gi, '[i√¨√≠√Æ√Ø]')
        .replace(/o/gi, '[o√≤√≥√¥√µ√∂]')
        .replace(/u/gi, '[u√π√∫√ª√º]')
        .replace(/c/gi, '[c√ß]');
        
    // AQUI: Envolvemos o padr√£o em par√™nteses (Capturing Group) para o $1 funcionar
    return isExact ? new RegExp(`(\\b${regexStr}\\b)`, 'gi') : new RegExp(`(${regexStr})`, 'gi');
}



// --- L√ìGICA DA BARRA SECUND√ÅRIA ---

setTimeout(() => {
    const toggleMoreBtn = document.getElementById('toggle-more-tools-btn');
    const secondaryToolbar = document.getElementById('secondary-toolbar');
    
    // 1. Abrir/Fechar Painel Secund√°rio
    if (toggleMoreBtn && secondaryToolbar) {
        
        // A. REMOVER EVENTOS ANTIGOS (Clonagem)
        const newToggleBtn = toggleMoreBtn.cloneNode(true);
        toggleMoreBtn.parentNode.replaceChild(newToggleBtn, toggleMoreBtn);

        // B. PRESERVAR O CURSOR (O Segredo)
        newToggleBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();     // N√£o muda o foco
            e.stopPropagation();    // N√£o propaga para o editor
        });

        // C. A√á√ÉO DE ABRIR/FECHAR
        newToggleBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            
            const isHidden = secondaryToolbar.style.display === 'none';
            
            if (isHidden) {
                secondaryToolbar.style.display = 'flex';
                newToggleBtn.classList.add('active');
                newToggleBtn.textContent = '‚ñ≤';
                secondaryToolbar.style.animation = "slideDown 0.2s ease-out";
            } else {
                secondaryToolbar.style.display = 'none';
                newToggleBtn.classList.remove('active');
                newToggleBtn.textContent = '‚ñº';
            }
        });
    }
}, 500);

// Fun√ß√£o Auxiliar (Mant√©m-se a mesma, mas garante que est√° presente)
function insertNodeAtCursor(node) {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node);
        range.setEndAfter(node);
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante)
// ====================================================================

// --- NOVO C√ìDIGO PARA A DROPDOWN DE FORMATOS ---
    const formatSelect = document.getElementById('editor-format');
    if (formatSelect) {
        formatSelect.addEventListener('change', () => {
            const value = formatSelect.value; // Pega H1, H2, P, etc.
            
            // 1. Aplica o formato
            document.execCommand('formatBlock', false, value);

            // 2. LIMPEZA PROFUNDA (Mesma l√≥gica que tinhas nos bot√µes)
            const selection = window.getSelection();
            if (selection.anchorNode && safeNoteEditor) {
                let block = selection.anchorNode;
                if (block.nodeType === 3) block = block.parentNode; 
                
                // Sobe at√© encontrar o bloco alterado
                while(block && block.id !== 'note-content-editor' && block.tagName !== value) {
                    block = block.parentNode;
                }

                if (block && block.tagName === value) {
                    block.removeAttribute('style'); 
                    const dirtyChildren = block.querySelectorAll('span, font, b, i, u');
                    dirtyChildren.forEach(child => {
                            child.style.fontSize = '';
                            child.style.fontWeight = '';
                            if (child.tagName === 'FONT') {
                                child.removeAttribute('size');
                                child.removeAttribute('face');
                            }
                    });
                }
            }
            
            // 3. Foca de volta no editor e grava
            safeNoteEditor.focus();
            saveNote();
            
            // Opcional: Voltar visualmente para "Normal" para a pr√≥xima a√ß√£o
            // formatSelect.value = "P"; 
        });
    }

// ====================================================================
// GESTOR DE TABELAS (Menu Flutuante Controlado)
// ====================================================================
let activeTableCell = null; 
let activeTableWrapper = null; 
const tablePopup = document.getElementById('table-tools-popup');

// Injetar o t√≠tulo "TABELA" no menu se n√£o existir (para o novo design)
if (tablePopup && !tablePopup.querySelector('.menu-title')) {
    const titleDiv = document.createElement('div');
    titleDiv.className = 'menu-title';
    titleDiv.textContent = 'Editar Tabela';
    tablePopup.prepend(titleDiv);
}

noteContentEditor.addEventListener('mousedown', (e) => {
    
    // CASO A: Bot√£o de Ferramentas (üõ†Ô∏è)
    const settingsBtn = e.target.closest('.table-settings-btn');
    
    if (settingsBtn) {
        e.preventDefault(); e.stopPropagation();

        const clickedWrapper = settingsBtn.closest('.jwn-table-wrapper');
        const table = clickedWrapper.querySelector('table');
        
        // Define c√©lula ativa padr√£o
        if (!activeTableCell || !table.contains(activeTableCell)) {
            activeTableCell = table.querySelector('td, th');
        }

        // L√ìGICA DE TROCA INTELIGENTE
        const isMenuOpen = tablePopup.style.display === 'grid' || tablePopup.style.display === 'flex';
        const isSameTable = (activeTableWrapper === clickedWrapper);

        // 1. Se clicou no MESMO bot√£o e j√° estava aberto -> Fecha
        if (isMenuOpen && isSameTable) {
            tablePopup.style.display = 'none';
            settingsBtn.classList.remove('active');
            activeTableWrapper = null;
        } 
        // 2. Se estava fechado OU clicou numa tabela DIFERENTE -> Abre/Move
        else {
            // Remove classe ativa do bot√£o anterior (se houver)
            document.querySelectorAll('.table-settings-btn').forEach(b => b.classList.remove('active'));
            
            // Atualiza refer√™ncia
            activeTableWrapper = clickedWrapper;

            // Move o menu para o corpo e posiciona
            document.body.appendChild(tablePopup);
            const rect = settingsBtn.getBoundingClientRect();
            
            // Estilo GRID para o novo design
            tablePopup.style.display = 'grid'; 
            tablePopup.style.position = 'absolute';
            tablePopup.style.top = `${rect.bottom + window.scrollY + 5}px`; 
            // Alinha √† direita do bot√£o para n√£o sair da tela
            tablePopup.style.left = `${(rect.right + window.scrollX) - 200}px`; 
            tablePopup.style.zIndex = "2147483647"; 
            
            settingsBtn.classList.add('active');
        }
        return;
    }

    // CASO B: Clicou numa c√©lula (Apenas memoriza)
    const cell = e.target.closest('td, th');
    if (cell) {
        activeTableCell = cell; 
        // Se clicar na c√©lula de outra tabela, fecha o menu da anterior
        const parentWrapper = cell.closest('.jwn-table-wrapper');
        if (activeTableWrapper && activeTableWrapper !== parentWrapper) {
             tablePopup.style.display = 'none';
             document.querySelectorAll('.table-settings-btn').forEach(b => b.classList.remove('active'));
        }
        activeTableWrapper = parentWrapper;
        return;
    }

    // CASO C: Clicou fora (Fecha tudo)
    if (tablePopup && tablePopup.style.display !== 'none' && !tablePopup.contains(e.target)) {
        tablePopup.style.display = 'none';
        document.querySelectorAll('.table-settings-btn').forEach(b => b.classList.remove('active'));
    }
});

// 2. A√ß√µes dos bot√µes do menu (Adicionar/Remover)
if (tablePopup) {
    // Adicionamos 'async' aqui para poder esperar pela confirma√ß√£o e pelo arquivo
    tablePopup.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn || !activeTableCell) return;
        
        e.preventDefault(); e.stopPropagation();

        const action = btn.dataset.action;
        const cell = activeTableCell;
        const row = cell.parentElement;
        const table = row.closest('table');
        
        const rowIndex = row.rowIndex;
        const colIndex = cell.cellIndex;
        const currentCols = row.cells.length;
        const currentRows = table.rows.length;

        // --- ADICIONAR ---
        if (action === 'add-row-above' || action === 'add-row-below') {
            if (currentRows >= 50) return alert("Limite de linhas atingido.");
            const newRow = table.insertRow(action === 'add-row-above' ? rowIndex : rowIndex + 1);
            for (let i = 0; i < currentCols; i++) {
                newRow.insertCell(i).innerHTML = '<br>';
            }
            saveNote();
        }
        else if (action === 'add-col-left' || action === 'add-col-right') {
            if (currentCols >= 15) return alert("Limite de colunas atingido.");
            for (let i = 0; i < table.rows.length; i++) {
                const tr = table.rows[i];
                const isHeadRow = tr.parentNode.tagName === 'THEAD';
                const refIndex = action === 'add-col-left' ? colIndex : colIndex + 1;
                const newCell = tr.insertCell(refIndex);
                if (isHeadRow) newCell.outerHTML = '<th>T√≠tulo</th>';
                else newCell.innerHTML = '<br>';
            }
            saveNote();
        }

        // --- APAGAR LINHA/COLUNA ---
        else if (action === 'del-row') {
            table.deleteRow(rowIndex);
            if (table.rows.length === 0) activeTableWrapper.remove();
            saveNote();
        }
        else if (action === 'del-col') {
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].deleteCell(colIndex);
            }
            if (table.rows[0] && table.rows[0].cells.length === 0) activeTableWrapper.remove();
            saveNote();
        }

        // --- APAGAR TABELA INTEIRA (RECICLAGEM) ---
        else if (action === 'del-table') {
            
            // 1. Z-Index fix para o modal de confirma√ß√£o aparecer acima do menu da tabela
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) confirmModal.style.zIndex = "2147483647";

            // 2. Popup Bonito
            const confirmed = await showConfirmation(
                "Mover para a Reciclagem?", 
                "A tabela ser√° ocultada desta nota e guardada no Hist√≥rico."
            );
            
            // Restaura Z-Index
            if (confirmModal) confirmModal.style.zIndex = "";

            if (confirmed && activeTableWrapper) {
                // 3. Chama a fun√ß√£o de arquivo (que envia para o Firebase como 'hidden')
                // A fun√ß√£o archiveMiniNote j√° detecta que √© uma tabela pela classe .jwn-table-wrapper
                await window.archiveMiniNote(activeTableWrapper);
                
                // Fecha o menu de ferramentas
                tablePopup.style.display = 'none';
            }
        }
    });
}

// --- FUN√á√ÉO AUXILIAR: ATUALIZAR VISUAL DO BOT√ÉO DE T√ìPICOS ---
function updateMiniNoteButtonState(wrapperElement) {
    if (!wrapperElement) return;

    const btn = wrapperElement.querySelector('button[data-action="manage-mini-note-topics"]');
    if (!btn) return;

    const topicsString = wrapperElement.getAttribute('data-topics') || '{}';
    let hasTopics = false;

    try {
        const topics = JSON.parse(topicsString);
        // Verifica se h√° chaves no objeto (t√≥picos selecionados)
        hasTopics = Object.keys(topics).length > 0;
    } catch (e) {
        hasTopics = false;
    }

    if (hasTopics) {
        // --- ESTILO DESTACADO (COM T√ìPICOS) ---
        btn.style.backgroundColor = "rgba(74, 144, 226, 0.3)"; // Fundo azulado semi-transparente
        btn.style.color = "var(--accent-color)";               // √çcone azul forte
        btn.style.borderColor = "var(--accent-color)";         // Borda azul forte
        btn.title = "Gerir T√≥picos (Ativos)";
    } else {
        // --- ESTILO PADR√ÉO (SEM T√ìPICOS) ---
        btn.style.backgroundColor = "";
        btn.style.color = "";
        btn.style.borderColor = "";
        btn.title = "Gerir T√≥picos";
    }
}

// --- FUN√á√ÉO PARA CORRIGIR SUBNOTAS ANTIGAS ---
function fixLegacyMiniNotes() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    const ghostArrows = editor.querySelectorAll('.title-expand-arrow');
    ghostArrows.forEach(arrow => arrow.remove());

    const wrappers = editor.querySelectorAll('.mini-note-wrapper');
    
    wrappers.forEach(wrapper => {
        if (!wrapper.hasAttribute('data-topics')) wrapper.setAttribute('data-topics', '{}');
        if (!wrapper.hasAttribute('data-shared')) wrapper.setAttribute('data-shared', 'false');
        if (!wrapper.hasAttribute('data-box-links')) wrapper.setAttribute('data-box-links', '{}');

        let toolbar = wrapper.querySelector('.mini-note-toolbar');
        if (!toolbar) {
            toolbar = document.createElement('div');
            toolbar.className = 'mini-note-toolbar';
            toolbar.setAttribute('contenteditable', 'false');
            const content = wrapper.querySelector('.mini-note-content') || wrapper.querySelector('.statue-content-lock');
            if (content) wrapper.insertBefore(toolbar, content);
        }

        let arrowGroup = toolbar.querySelector('.toolbar-btn-group');
        if (!arrowGroup) {
            arrowGroup = document.createElement('div');
            arrowGroup.className = 'toolbar-btn-group';
            const shareBtn = toolbar.querySelector('button[data-action="sharing-settings"]');
            if (shareBtn) shareBtn.after(arrowGroup);
            else toolbar.prepend(arrowGroup);
        }

        let buttonsConfig = [
            { action: 'sharing-settings', icon: 'üîê', title: 'Partilha', parent: toolbar, pos: 'start' },
            { action: 'move-up', icon: 'üî∫', title: 'Subir', parent: arrowGroup },
            { action: 'move-down', icon: 'üîª', title: 'Descer', parent: arrowGroup },
            { action: 'highlight-color', icon: 'üé®', title: 'Destacar Cor', parent: toolbar },
            
            { action: 'manage-box-links', icon: '‚ö°', title: 'Links/Codex', parent: toolbar, type: 'interactive' },
            { action: 'append-mini-note', icon: 'üß¨', title: 'Clonar para Nota', parent: toolbar, type: 'interactive' },
            { action: 'manage-mini-note-topics', icon: 'üìã', title: 'Gerir T√≥picos', parent: toolbar, type: 'interactive' },

            { action: 'delete-mini-note', icon: 'üóëÔ∏è', title: 'Apagar', parent: toolbar }
        ];

        // --- L√ìGICA EST√ÅTUA ---
        if (wrapper.classList.contains('statue-card-wrapper')) {
            // Remove interativos
            buttonsConfig = buttonsConfig.filter(cfg => cfg.type !== 'interactive');
            
            // Obt√©m dados (mesmo que nulos, vamos tentar criar o bot√£o)
            const originNote = wrapper.getAttribute('data-origin-note');
            const originBox = wrapper.getAttribute('data-origin-box');
            
            // Adiciona Configura√ß√£o do Moai
            const moaiBtnConfig = {
                action: 'jump-to-origin',
                icon: 'üóø',
                title: 'Ir para Origem',
                parent: toolbar,
                customStyle: 'color: #a569bd; font-weight: bold; border-color: #a569bd; margin-right: 2px;',
                // Se n√£o houver dados, o clique n√£o far√° nada, mas o bot√£o aparece
                onclickCode: originNote ? `event.preventDefault(); window.handleGoToNote('${originNote}', '${originBox}')` : ''
            };

            // INSERIR ANTES DO LIXO
            const deleteIndex = buttonsConfig.findIndex(b => b.action === 'delete-mini-note');
            if (deleteIndex !== -1) buttonsConfig.splice(deleteIndex, 0, moaiBtnConfig);
            else buttonsConfig.push(moaiBtnConfig);
        }

        // --- INJE√á√ÉO NO DOM ---
        buttonsConfig.forEach(cfg => {
            let btn = toolbar.querySelector(`button[data-action="${cfg.action}"]`);
            
            if (!btn) {
                btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.action = cfg.action;
                btn.textContent = cfg.icon;
                btn.title = cfg.title;
                
                if (cfg.customStyle) btn.style.cssText = cfg.customStyle;
                if (cfg.onclickCode) btn.setAttribute('onclick', cfg.onclickCode);
                
                if (cfg.parent === arrowGroup) {
                    cfg.parent.appendChild(btn);
                } else if (cfg.pos === 'start') {
                    cfg.parent.prepend(btn);
                } else {
                    const delBtn = toolbar.querySelector('button[data-action="delete-mini-note"]');
                    if (delBtn && cfg.action !== 'delete-mini-note') {
                        toolbar.insertBefore(btn, delBtn);
                    } else {
                        cfg.parent.appendChild(btn);
                    }
                }
            }
        });

        // --- LIMPEZA DE PROIBIDOS (para est√°tuas existentes que tinham os bot√µes errados) ---
        if (wrapper.classList.contains('statue-card-wrapper')) {
            ['manage-box-links', 'append-mini-note', 'manage-mini-note-topics'].forEach(action => {
                const existingBtn = toolbar.querySelector(`button[data-action="${action}"]`);
                if (existingBtn) existingBtn.remove();
            });
        }

        // --- RESTO DO C√ìDIGO (T√≠tulos e Editabilidade) ---
        let titleArea = wrapper.querySelector('.mini-note-title-input');
        if (titleArea && titleArea.tagName === 'INPUT') {
            const textarea = document.createElement('textarea');
            textarea.className = titleArea.className;
            textarea.value = titleArea.getAttribute('value') || titleArea.value || "";
            textarea.placeholder = titleArea.placeholder;
            textarea.setAttribute('spellcheck', 'false');
            titleArea.parentNode.replaceChild(textarea, titleArea);
            titleArea = textarea;
        }

        if (titleArea && typeof appSettings !== 'undefined' && appSettings.showFullTitles) {
            titleArea.classList.add('wrap-enabled');
            titleArea.style.height = 'auto';
            titleArea.style.height = titleArea.scrollHeight + 'px';
        }

        toolbar.setAttribute('contenteditable', 'false');
        
        if (!wrapper.classList.contains('statue-card-wrapper')) {
            const contentDiv = wrapper.querySelector('.mini-note-content');
            if (contentDiv) contentDiv.setAttribute('contenteditable', 'true');
        }

        if (typeof updateMiniNoteButtonState === 'function') updateMiniNoteButtonState(wrapper); 
        if (typeof updateHighlightButtonState === 'function') updateHighlightButtonState(wrapper); 
        if (typeof updateSharingButtonState === 'function') updateSharingButtonState(wrapper); 
        if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(wrapper);
    });
}





// 1. Carregar Destaques Personalizados do Firebase
window.loadUserHighlights = async function() {
    if (!auth.currentUser) return;
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            userCustomHighlights = docSnap.data().colors || {};
        }
    } catch (e) {
        console.error("Erro ao carregar destaques:", e);
    }
};

// 2. Abrir Popup de Cores
window.renderHighlightList = function() {
    const container = document.getElementById('highlight-options-container');
    container.innerHTML = '';

    // 1. Descobrir qual a cor ativa na caixa atual
    const activeColor = window.activeWrapperForColor && window.activeWrapperForColor.dataset.highlight 
                      ? window.activeWrapperForColor.dataset.highlight.toLowerCase() 
                      : null;

    // Op√ß√£o de Remover
    const removeRow = document.createElement('div');
    removeRow.className = 'highlight-option-row remove-highlight-row';
    removeRow.innerHTML = '<span>üö´ Remover Destaque</span>';
    removeRow.onclick = () => window.applyHighlight(null);
    container.appendChild(removeRow);

    // Lista de Cores
    DEFAULT_HIGHLIGHTS.forEach(colorObj => {
        const hex = colorObj.code;
        const displayName = userCustomHighlights[hex] || colorObj.name;

        const row = document.createElement('div');
        row.className = 'highlight-option-row';

        if (hex.toLowerCase() === activeColor) {
            row.classList.add('selected-color-row');
        }

        // Bola de Cor
        const colorBox = document.createElement('div');
        colorBox.className = 'color-preview-box';
        colorBox.style.backgroundColor = hex;

        // Nome
        const nameLabel = document.createElement('span');
        nameLabel.className = 'highlight-name-label';
        nameLabel.textContent = displayName;

        // L√°pis (Renomear)
        const editBtn = document.createElement('button');
        editBtn.className = 'highlight-options-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.title = "Mudar Nome";
        editBtn.onclick = (e) => {
            e.stopPropagation(); 
            // Assume que renameHighlight tamb√©m ser√° convertida ou est√° acess√≠vel
            if(typeof renameHighlight === 'function') renameHighlight(hex, displayName);
        };

        // AQUI: Chama a fun√ß√£o global window.applyHighlight
        row.onclick = () => window.applyHighlight(hex);

        row.appendChild(colorBox);
        row.appendChild(nameLabel);
        row.appendChild(editBtn);
        container.appendChild(row);
    });
};

// 2. Abrir Modal de Cores (Agora muito mais simples)
window.openHighlightPopup = async function(wrapper) {
    console.log("üé® [CORES] Abrindo seletor...");
    window.activeWrapperForColor = wrapper; 

    const modal = document.getElementById('highlight-modal');
    if (!modal) return console.error("Modal #highlight-modal n√£o encontrado!");

    // 1. MOVE PARA O TOPO (Body)
    document.body.appendChild(modal);

    // 2. FOR√áA VISIBILIDADE M√ÅXIMA (Z-Index Supremo)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        z-index: 2147483647 !important; /* Max Int 32-bit */
        top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.7) !important;
        justify-content: center !important;
        align-items: center !important;
    `;

    // 3. CARREGA DADOS
    await window.loadUserHighlights();
    window.renderHighlightList(); 
};

// 3. Renomear Destaque
async function renameHighlight(hexCode, currentName) {
    const modal = document.getElementById('rename-highlight-modal');
    if (!modal) return;

    // 1. Move para o body (Garante que √© o √∫ltimo elemento do DOM)
    document.body.appendChild(modal);
    
    // 2. FOR√áA VISUALIZA√á√ÉO NO TOPO ABSOLUTO
    modal.style.setProperty('display', 'flex', 'important');
    
    // --- CORRE√á√ÉO AQUI ---
    // Usamos o mesmo valor m√°ximo que o modal anterior (2147483647).
    // Como fizemos o appendChild acima, este ficar√° por cima por ser o √∫ltimo.
    modal.style.setProperty('z-index', '2147483647', 'important'); 

    const input = document.getElementById('new-highlight-name-input');
    colorHexBeingRenamed = hexCode;
    input.value = currentName;
    
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);

    // L√≥gica dos bot√µes Cancelar/Gravar
    document.getElementById('confirm-rename-highlight-btn').onclick = async () => {
        const newName = input.value.trim();
        if (newName) {
            userCustomHighlights[hexCode] = newName;
            await syncColorsToFirebase();
            renderHighlightList(); // Atualiza a lista atr√°s
        }
        modal.style.display = 'none';
    };

    document.getElementById('cancel-rename-highlight-btn').onclick = () => {
        modal.style.display = 'none';
    };
}

function updateSharingButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="sharing-settings"]');
    if (!btn) return;

    const isShared = wrapper.getAttribute('data-shared') === 'true';

    if (isShared) {
        btn.textContent = 'üîì'; // Cadeado aberto
        btn.classList.add('sharing-active');
        btn.title = "Partilha Permitida (P√∫blico)";
    } else {
        btn.textContent = 'üîê'; // Cadeado fechado
        btn.classList.remove('sharing-active');
        btn.title = "Partilha Bloqueada (Privado)";
    }
}

// Atualiza o √≠cone na toolbar principal
function updateNoteSharingButtonUI(isShared, ownerId = null) {
    const btn = document.querySelector('button[data-action="note-sharing-settings"]');
    if (!btn) return;
    
    // VERIFICA√á√ÉO DE PROPRIEDADE
    const myUid = auth.currentUser ? auth.currentUser.uid : null;
    
    // Se ownerId for fornecido e for diferente do meu, esconde o bot√£o
    if (ownerId && ownerId !== myUid) {
        btn.style.setProperty('display', 'none', 'important');
        return;
    }

    // Se sou o dono, mostra o bot√£o e define o √≠cone
    btn.style.display = 'flex'; // ou 'block' dependendo do teu CSS

    if (isShared) {
        // ESTADO P√öBLICO
        btn.textContent = 'üîì'; // Cadeado Aberto
        btn.title = "Nota P√∫blica (Clique para gerir)";
    } else {
        // ESTADO PRIVADO
        btn.textContent = 'üîê'; // Cadeado Fechado
        btn.style.color = ''; // Cor padr√£o
        btn.title = "Nota Privada (Clique para partilhar)";
    }
}

// Fun√ß√£o Central: Grava as cores e o UserID no Firebase
// (Cria se n√£o existir, Atualiza se j√° existir)
async function syncColorsToFirebase() {
    if (!auth.currentUser) return;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // Prepara os dados
        const dataToSave = {
            userId: auth.currentUser.uid, // Garante que o ID do user est√° gravado
            colors: userCustomHighlights    // Grava o mapa de cores (Hex -> Nome)
        };

        // O { merge: true } √© a chave aqui:
        // - Se o doc n√£o existir: CRIA com estes dados.
        // - Se o doc existir: ATUALIZA/JUNTA estes dados.
        await setDoc(docRef, dataToSave, { merge: true });
        

    } catch (e) {
        console.error("Erro ao sincronizar cores:", e);
    }
}

// 4. Aplicar Destaque √† Caixa
window.applyHighlight = async function(colorCode) {
    if (!window.activeWrapperForColor) return;

    // 1. Aplica a cor no HTML (Visual)
    if (colorCode) {
        window.activeWrapperForColor.setAttribute('data-highlight', colorCode);
        window.activeWrapperForColor.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; // Feedback visual no bloco
        window.activeWrapperForColor.style.borderColor = colorCode;
    } else {
        window.activeWrapperForColor.removeAttribute('data-highlight');
        window.activeWrapperForColor.style.backgroundColor = '';
        window.activeWrapperForColor.style.borderColor = '';
    }

    // Atualiza bot√£o da toolbar se existir (apenas para notas normais)
    if (typeof updateHighlightButtonState === 'function') {
        updateHighlightButtonState(window.activeWrapperForColor);
    }
    
    // 2. FECHA O MODAL
    document.getElementById('highlight-modal').style.display = 'none';
    
    // 3. GRAVA√á√ÉO INTELIGENTE (Aqu√°rio vs Nota)
    const isAquarium = document.getElementById('aquarium-environment').style.display !== 'none';
    
    if (isAquarium) {
        console.log("üíæ [AQU√ÅRIO] Gravando cor...");
        if (typeof window.saveAquariumState === 'function') await window.saveAquariumState();
    } else {
        if (typeof saveNote === 'function') saveNote(true);
    }

    window.activeWrapperForColor = null;
};


// Fun√ß√£o Auxiliar: Garante que a cor existe na cole√ß√£o 'destaques'
async function ensureColorExistsInFirebase(hexCode, defaultName) {
    // Se j√° temos esta cor carregada localmente, n√£o precisamos de ir √† BD
    if (userCustomHighlights[hexCode]) return;

    const nameToSave = defaultName;
    
    // Atualiza cache local
    userCustomHighlights[hexCode] = nameToSave;

    try {
        const docRef = doc(db, 'destaques', auth.currentUser.uid);
        
        // --- ALTERA√á√ÉO AQUI ---
        // Adicionamos userId: auth.currentUser.uid ao objeto
        await setDoc(docRef, {
            userId: auth.currentUser.uid, // <--- CAMPO NOVO
            colors: {
                [hexCode]: nameToSave
            }
        }, { merge: true });
        
    } catch (e) {
        console.error("Erro ao registar cor:", e);
    }
}

// Listener para o bot√£o üé®
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="highlight-color"]');
    if (btn) {
        e.preventDefault(); 
        e.stopPropagation();
        
     const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
if (!wrapper) return;
        
        // Simplesmente abre o popup, sem c√°lculos de posi√ß√£o nem toggle complexo
        openHighlightPopup(wrapper);
        return;
    }
});

// Fechar popup ao clicar fora
document.addEventListener('click', (e) => {
    
    // 1. Popup de Partilha (O Problem√°tico)
    const sharePop = document.getElementById('note-share-popup');
    // Verifica se clicou no bot√£o de partilha do Arquivo OU da Nota
    const isShareBtn = e.target.closest('button[data-action="archive-share"]') || 
                       e.target.closest('button[data-action="note-sharing-settings"]');

    if (sharePop && sharePop.style.display !== 'none') {
        // S√≥ fecha se: O clique N√ÉO foi dentro do popup E N√ÉO foi num dos bot√µes de abrir
        if (!sharePop.contains(e.target) && !isShareBtn) {
            sharePop.style.display = 'none';
        }
    }

    // 2. Fechar Context Menu (3 pontos)
    if (!e.target.closest('.context-menu')) {
        if (typeof hideContextMenu === 'function') hideContextMenu();
    }
    
    // 3. Fechar Tag Popup (@ e #)
    const tagPop = document.getElementById('tag-suggestion-popup');
    if (tagPop && tagPop.style.display !== 'none' && 
        !document.getElementById('note-content-editor').contains(e.target) && 
        !tagPop.contains(e.target)) {
        if (typeof hideTagPopup === 'function') hideTagPopup();
    }

    // 4. Fechar Formatting Popup
    const fPopup = document.getElementById('formatting-popup');
    const fBtn = document.getElementById('more-formatting-btn');
    if (fPopup && fPopup.style.display === 'block') {
        if (!fPopup.contains(e.target) && e.target !== fBtn) {
            fPopup.style.display = 'none';
            if (fBtn) fBtn.classList.remove('active');
        }
    }
    
    // 5. Fechar Popup do B Azul
    const bPopup = document.getElementById('bold-palette-popup');
    if (bPopup && bPopup.style.display === 'block') {
        if (!bPopup.contains(e.target) && !e.target.classList.contains('dots-trigger')) {
            bPopup.style.display = 'none';
        }
    }
    
    // 6. Fechar Popup do I It√°lico
    const iPopup = document.getElementById('italic-palette-popup');
    if (iPopup && iPopup.style.display === 'block') {
        if (!iPopup.contains(e.target) && !e.target.closest('button[data-command="italic"]')) {
            iPopup.style.display = 'none';
        }
    }
});

// 5. Atualizar Estado Visual do Bot√£o (Ao carregar a nota)
 function updateHighlightButtonState(wrapper) {
    const color = wrapper.dataset.highlight;
    const btn = wrapper.querySelector('button[data-action="highlight-color"]');
    const contentDiv = wrapper.querySelector('.mini-note-content');

    if (!btn) return;

    if (color) {
        // --- ESTILO ATIVO (PREENCHIDO) ---
        // Fundo ligeiramente claro para destacar que est√° ativo
        btn.style.backgroundColor = "rgba(255, 255, 255, 0.15)"; 
        // Borda com a cor do destaque escolhido
        btn.style.borderColor = color; 
        // √çcone com a cor do destaque escolhido
        btn.style.color = color; 
        
        btn.classList.add('has-color');
        
        // Garante que a caixa de texto tem a cor correta
        if (contentDiv) {
            contentDiv.style.backgroundColor = color;
            contentDiv.style.color = "#222222"; // Texto escuro para contraste
        }
    } else {
        // --- ESTILO INATIVO (RESET) ---
        btn.style.backgroundColor = "";
        btn.style.borderColor = "";
        btn.style.color = "";
        btn.classList.remove('has-color');
        
        if (contentDiv) {
            contentDiv.style.backgroundColor = ""; // Remove fundo
            contentDiv.style.color = ""; // Volta √† cor do tema
        }
    }
}


function updateMiddlePanelForFolderSelection(folderId, folderName, selectedElement) {
    // 1. Atualiza o estado da sele√ß√£o visual no painel esquerdo
    document.querySelectorAll('#left-panel-list .list-item.selected').forEach(el => el.classList.remove('selected'));
    selectedElement.classList.add('selected');

    // 2. Atualiza o stack de navega√ß√£o para refletir a nova pasta
    if (navigationStack.length > 0) {
        // Se j√° est√°vamos numa pasta, substitu√≠mos o √∫ltimo item
        navigationStack[navigationStack.length - 1] = { id: folderId, name: folderName };
    } else {
        // Se est√°vamos na raiz, adicionamos a pasta ao stack
        navigationStack.push({ id: folderId, name: folderName });
    }
    
    // 3. Atualiza o t√≠tulo do painel do meio e o bot√£o "Voltar"
    middlePanelTitle.textContent = folderName;
    backBtn.style.display = 'flex';

    // 4. Limpa o listener antigo do painel do meio para evitar fugas de mem√≥ria
    if (unsubscribeMiddlePanel) unsubscribeMiddlePanel();

    // 5. Busca e exibe os novos itens no painel do meio, sem tocar no editor
    unsubscribeMiddlePanel = fetchAndDisplayItems(folderId, middlePanelList, null);
}


// Adiciona/Atualiza isto dentro da displayNote e displayArchive:
function syncVisualSelection(selectedId) {
    // 1. Remove destaques antigos apenas da segunda coluna (para n√£o matar a Coluna 1)
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });

    // 2. Aplica o destaque ao item clicado na Coluna 2
    const target = document.querySelector(`#file-list .list-item[data-id="${selectedId}"]`);
    if (target) {
        const isShared = (currentViewMode === 'shared');
        target.classList.add(isShared ? 'selected-red' : 'selected');
    }
}



async function displayNote(noteId, noteElement, searchTerm = null) {
    // 1. GERAR NOVO ID DE PEDIDO (Concurrency Control)
    const thisRequestId = ++window.currentNavRequest;
    console.log(`üöÄ [NAV #${thisRequestId}] A iniciar abertura da nota: ${noteId}`);

    // 2. LIMPEZA DE POPUPS
    window.closeAllFloatingPopups();

    // 3. ATIVAR ESCUDO DE GRAVA√á√ÉO
    // Isto diz ao `executeSave`: "N√£o graves nada agora, estou a mudar de nota!"
    window.isSwitchingNote = true; 

    // Reset de Estados Globais
    window.nextSelectedId = null; 
    document.body.classList.remove('show-fab');
    let isStatueSynced = false;

    // Desliga ouvinte anterior para parar de receber updates da nota velha
    if (unsubscribeCurrentNote) { 
        unsubscribeCurrentNote(); 
        unsubscribeCurrentNote = null; 
    }
    
    // Reset de Vari√°veis
    window.currentNoteHybridMode = false;
    activeNoteAnchorsIds = [];
    selectedNoteId = noteId;
    isClosingNote = false;
    
    // 4. LIMPEZA VISUAL IMEDIATA (Evita ver a nota velha por breves instantes)
    const noteTitleInput = document.getElementById('note-title-input');
    const noteContentEditor = document.getElementById('note-content-editor');
    const editorArea = document.getElementById('editor-area');
    const zoomSelect = document.getElementById('editor-zoom'); 
    
    if (noteTitleInput) noteTitleInput.value = "A carregar..."; 
    if (noteContentEditor) {
        noteContentEditor.innerHTML = ""; // Limpa conte√∫do
        noteContentEditor.setAttribute('data-real-id', noteId); // Marca o ID no HTML por seguran√ßa
    }

    // Gest√£o de Paineis
    document.getElementById('editor-placeholder').style.setProperty('display', 'none', 'important');
    document.getElementById('archive-area').style.setProperty('display', 'none', 'important');
    if (editorArea) editorArea.style.setProperty('display', 'flex', 'important');

    try {
        const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', noteId);

        // --- LISTENER EM TEMPO REAL ---
        unsubscribeCurrentNote = onSnapshot(noteRef, (noteSnap) => {
            
            // CHECKPOINT DE SEGURAN√áA:
            // Se o utilizador clicou noutra nota entretanto, este pedido √© velho. Aborta.
            if (window.currentNavRequest !== thisRequestId) {
                console.warn(`üõë [NAV #${thisRequestId}] Cancelado. O utilizador mudou de nota.`);
                return;
            }

            // Nota carregada, pode voltar a permitir grava√ß√µes
            window.isSwitchingNote = false; 
            
            if (!noteSnap.exists()) return;
            const data = noteSnap.data();

            window.currentNoteType = data.tipo; 
            if (typeof toggleJournalToolbar === 'function') {
                toggleJournalToolbar(window.currentNoteType === 'jornal');
            }
            
            window.currentNoteHybridMode = (data.isHybridMode === true);
            activeNoteAnchorsIds = Object.keys(data.ancorasSelecionadas || {});
            currentNoteShareData = data.shareSettings || { shared: false, shareId: null };
            
            if (typeof updateNoteSharingButtonUI === 'function') {
                updateNoteSharingButtonUI(currentNoteShareData.shared, data.userId);
            }

            // Atualizar HTML
            const serverTitle = data.nome || '';
            const serverContent = data.conteudo || '';
            
            if (window.currentNavRequest === thisRequestId) {
                if (document.activeElement !== noteTitleInput) noteTitleInput.value = serverTitle;
                
                // S√≥ substitui o HTML se n√£o estivermos a escrever (para n√£o perder o cursor)
                // OU se o editor estiver vazio (primeira carga)
                if (document.activeElement !== noteContentEditor || noteContentEditor.innerHTML === "") {
                     noteContentEditor.innerHTML = serverContent;
                }
                
                const savedZoom = data.zoomLevel || '100%'; 
                if (zoomSelect) zoomSelect.value = savedZoom;
                if (noteContentEditor) {
                    noteContentEditor.style.fontSize = savedZoom;
                    noteContentEditor.style.lineHeight = savedZoom.includes('%') ? '1.6' : (parseInt(savedZoom) * 1.5) + 'px';
                }
            }

            // SCRIPTS P√ìS-CARREGAMENTO
           setTimeout(async () => {
                if (window.currentNavRequest !== thisRequestId) return;

                if (typeof refreshAllCalendars === 'function') refreshAllCalendars();

             if (!isStatueSynced && typeof syncStatueCardsInCurrentNote === 'function') {
                    await syncStatueCardsInCurrentNote(); // Espera acabar
                    isStatueSynced = true;
                }

                if (typeof fixLegacyMiniNotes === 'function') fixLegacyMiniNotes(); 
                if (typeof updateRedatorParagraphs === 'function') updateRedatorParagraphs();
                if (typeof refreshMiddlePanelTabIcon === 'function') refreshMiddlePanelTabIcon();
                if (typeof initToolbarDropdowns === 'function') initToolbarDropdowns();

                const tabsBar = document.querySelector('.middle-bottom-tabs');
                if (tabsBar) tabsBar.style.display = 'flex';

                if (typeof updateMiddlePanelViews === 'function') updateMiddlePanelViews(); 
                
                if (searchTerm && typeof scrollToAndHighlightText === 'function') {
                    scrollToAndHighlightText(searchTerm);
                }

                updateSaveStatus('saved');
            }, 100);
        });
    } catch (error) { 
        console.error("Erro ao carregar nota:", error);
        window.isSwitchingNote = false; 
    }
    
    if (window.innerWidth <= 768) {
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
    }
}


function scrollToAndHighlightText(term) {
    if (!term) return;
    const lowerTerm = term.toLowerCase();

    // 1. Procura em Inputs (T√≠tulos de Subnotas/Quest√µes)
    const inputs = noteContentEditor.querySelectorAll('input');
    for (const input of inputs) {
        if (input.value.toLowerCase().includes(lowerTerm)) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            input.focus();
            // Adiciona efeito visual
            input.parentElement.classList.add('temporary-highlight');
            setTimeout(() => input.parentElement.classList.remove('temporary-highlight'), 2000);
            return; // Encontrou, para aqui.
        }
    }

    // 2. Procura no Texto (TreeWalker para encontrar n√≥s de texto)
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT, null, false);
    let node;
    while (node = walker.nextNode()) {
        const text = node.textContent;
        const index = text.toLowerCase().indexOf(lowerTerm);

        if (index >= 0) {
            // Encontrou o texto!
            
            // A. Tenta identificar se est√° dentro de um Post-it ou Subnota para destacar o contentor
            const container = node.parentElement.closest('.post-it-note, .mini-note-wrapper');
            if (container) {
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                container.classList.add('temporary-highlight');
                setTimeout(() => container.classList.remove('temporary-highlight'), 2000);
            } else {
                // Scroll no elemento pai direto
                node.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // B. Selecionar o texto exato (Highlight nativo do browser)
            const range = document.createRange();
            range.setStart(node, index);
            range.setEnd(node, index + term.length);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            return; // Encontrou, para a pesquisa.
        }
    }
}

function saveNote(forceImmediate = false) {
    clearTimeout(saveTimeout);

    if (forceImmediate) {
        // Retorna a promessa da grava√ß√£o real
        return executeSave(); 
    }

    // Grava√ß√£o autom√°tica normal (espera 2 minutos)
    updateSaveStatus('unsaved');
    saveTimeout = setTimeout(async () => {
        await executeSave();
    }, 120000); 
}

// ============================================================
// FUN√á√ÉO AUXILIAR: Extrair todos os t√≥picos do HTML (Caixas)
// ============================================================
function extractTopicsFromEditorHTML() {
    // Encontra todas as caixas (Quest√µes, Subnotas, Contentores)
    const allWrappers = document.getElementById('note-content-editor').querySelectorAll('.mini-note-wrapper');
    const aggregatedTopics = {};

    allWrappers.forEach(wrapper => {
        try {
            // L√™ o atributo data-topics
            const jsonStr = wrapper.getAttribute('data-topics');
            
            // Ignora se estiver vazio
            if (!jsonStr || jsonStr === '{}') return;

            const topics = JSON.parse(jsonStr);

            // Junta tudo num √∫nico objeto grande
            for (const [topicId, subArray] of Object.entries(topics)) {
                
                // Se o t√≥pico ainda n√£o existe, cria array vazio
                if (!aggregatedTopics[topicId]) {
                    aggregatedTopics[topicId] = [];
                }

                // Adiciona subt√≥picos sem duplicar
                if (Array.isArray(subArray)) {
                    subArray.forEach(subId => {
                        if (!aggregatedTopics[topicId].includes(subId)) {
                            aggregatedTopics[topicId].push(subId);
                        }
                    });
                }
            }
        } catch (e) {
            console.warn("Erro ao ler t√≥picos de uma caixa:", e);
        }
    });

    return aggregatedTopics;
}

// --- FUN√á√ÉO AUXILIAR: EXTRAIR GPS (IDs PARA INDEXA√á√ÉO) ---
function extractBoxIdsFromHTML(htmlContent) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    
    // Seleciona todos os tipos de caixas que queremos encontrar rapidamente
    const elements = doc.querySelectorAll('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, details.toggle-section, .jwn-timeline-wrapper, .jwn-table-wrapper');
    
    const ids = [];
    elements.forEach(el => {
        // Guarda apenas IDs v√°lidos e n√£o vazios
        if (el.id && el.id.trim() !== "") {
            ids.push(el.id);
        }
    });
    
    return ids; // Retorna array ex: ['mn_123', 'red_456', 'card_789']
}

// ============================================================
// FUN√á√ÉO PRINCIPAL: GRAVAR NOTA (COM GPS E SYNC)
// ============================================================
async function executeSave() {
    // 1. BLOQUEIO DE SEGURAN√áA
    // Se o sistema j√° estiver a mudar de nota, aborta a grava√ß√£o
    if (window.isSwitchingNote) {
        console.warn("üõë [SEGURAN√áA] Grava√ß√£o bloqueada: Navega√ß√£o em curso.");
        return false;
    }

    // Se n√£o h√° nota nem post selecionado, sai.
    if (!selectedNoteId && !activeEditingPostId) return false;
    
    // Se a nota estiver num processo de fecho, evita grava√ß√µes fantasma
    if (isClosingNote) return false;

    // 2. MODO ARQUIVO (FEED)
    // Se estivermos a editar um post do arquivo, delegamos para a fun√ß√£o espec√≠fica
    const archiveArea = document.getElementById('archive-area');
    if (archiveArea && archiveArea.style.display !== 'none') {
        if (activeEditingPostId) {
            // Nota: certifique-se que adiciona a l√≥gica de 'boxIds' tamb√©m no saveArchivePost
            await saveArchivePost(activeEditingPostId);
            updateSaveStatus('saved');
            return true;
        }
        return true; 
    }

    // 3. PREPARA√á√ÉO DO EDITOR (NOTA NORMAL)
    const editor = document.getElementById('note-content-editor');
    if (!editor) return false;
    
    // Preservar scroll atual
    let currentScrollPos = editor.scrollTop;
    
    // Ler Zoom atual
    const zoomSelect = document.getElementById('editor-zoom');
    const currentZoomVal = zoomSelect ? zoomSelect.value : '100%';

    // --- CR√çTICO: SINCRONIZA√á√ÉO DE INPUTS ---
    // Passa o valor escrito para o atributo HTML 'value' para ficar persistente
    const allInputs = editor.querySelectorAll('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
    allInputs.forEach(t => {
        if (t.tagName === 'TEXTAREA') {
            // Textarea usa textContent
            if (t.textContent !== t.value) t.textContent = t.value; 
        } else {
            // Inputs normais usam atributo value
            if (t.getAttribute('value') !== t.value) t.setAttribute('value', t.value);
        }
    });

    updateSaveStatus('saving');

    // Identifica o ID correto
    let targetId = selectedNoteId;
    const realId = editor.getAttribute('data-real-id'); // Fallback de seguran√ßa
    if (realId) targetId = realId;

    try {
        const { doc, updateDoc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', targetId);

        const titleInput = document.getElementById('note-title-input');
        const finalTitle = titleInput ? titleInput.value : "Sem T√≠tulo";
        const finalContent = editor.innerHTML;
        
        // Coletar metadados extra
        const usedColors = typeof extractUsedColorsFromEditor === 'function' ? extractUsedColorsFromEditor() : [];
        
        // --- EXTRAIR GPS (Novo C√≥digo) ---
        const boxIdsList = extractBoxIdsFromHTML(finalContent);

        // --- GRAVA√á√ÉO NO FIREBASE ---
        await updateDoc(noteRef, { 
            nome: finalTitle, 
            conteudo: finalContent,
            
            // Novos Campos
            boxIds: boxIdsList,      // O √çndice para a pesquisa r√°pida
            coresUsadas: usedColors, // Para o filtro de cores
            
            zoomLevel: currentZoomVal, 
            ultimaedicao: serverTimestamp()
        });

        // 4. PROPAGA√á√ïES EM SEGUNDO PLANO (N√£o bloqueantes)
        // Atualiza as Micas (Dossi√™) se houver altera√ß√µes
        if (typeof propagateUpdatesToMicas === 'function') {
            propagateUpdatesToMicas(targetId, finalContent);
        }
        
        // Atualiza a B√≠blia se houver refer√™ncias
        if (typeof propagateUpdatesToBible === 'function') {
            propagateUpdatesToBible(targetId, finalContent, finalTitle);
        }

        // Atualiza a Partilha P√∫blica (se ativa)
        if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
             try {
                const shareId = currentNoteShareData.shareId;
                const publicNoteRef = doc(db, 'shared_notes', shareId);
                setDoc(publicNoteRef, {
                    nome: finalTitle,
                    conteudo: finalContent,
                    authorName: currentUserData?.nome || "An√≥nimo",
                    updatedAt: serverTimestamp(),
                    type: 'full_note' 
                }, { merge: true }).catch(e => console.warn("Erro sync public:", e));
            } catch (e) {}
        }
        
        // 5. ATUALIZAR CACHE LOCAL DA PESQUISA
        // Se a vari√°vel de cache existir, atualizamos logo para a pesquisa funcionar sem refresh
        if (window.dbContentCache && window.dbContentCache.isLoaded) {
            const existingIndex = window.dbContentCache.data.findIndex(d => d.id === targetId);
            const newItem = {
                id: targetId,
                name: finalTitle,
                content: finalContent,
                type: 'note'
            };
            if (existingIndex > -1) window.dbContentCache.data[existingIndex] = newItem;
            else window.dbContentCache.data.push(newItem);
        }

        // Restaura Scroll
        if (editor.scrollTop !== currentScrollPos) {
            editor.scrollTop = currentScrollPos;
        }

        updateSaveStatus('saved');
        return true; // Sucesso

    } catch (error) {
        console.error("‚ùå ERRO AO GUARDAR:", error);
        updateSaveStatus('error');
        
        // Se a nota n√£o existir (foi apagada noutra sess√£o), avisa o user
        if (error.code === 'not-found') {
            alert("Erro: Esta nota j√° n√£o existe no servidor.");
        }
        
        throw error; // Lan√ßa erro para controladores superiores saberem que falhou
    }
}


// SINCRONIZA√á√ÉO P√öBLICA (Se a nota estiver partilhada)
    if (currentNoteShareData && currentNoteShareData.shared && currentNoteShareData.shareId) {
        try {
            // Grava na cole√ß√£o 'shared_notes' sem bloquear a grava√ß√£o principal
            setDoc(doc(db, 'shared_notes', currentNoteShareData.shareId), {
                nome: noteTitleInput.value,
                conteudo: noteContentEditor.innerHTML,
                authorName: currentUserData?.nome || "An√≥nimo",
                updatedAt: serverTimestamp(),
                type: 'full_note' // Marca como nota completa
            }, { merge: true }).catch(err => console.error("Erro sync partilha:", err));
            
        } catch (e) {
            console.warn("Falha silenciosa ao sincronizar partilha p√∫blica.");
        }
    }

function insertMiniNoteAtCursor(type = 'default') {
    const editor = document.getElementById('note-content-editor');
    
    // 1. RECUPERA√á√ÉO DE SELE√á√ÉO
    editor.focus();
    let selection = window.getSelection();
    let range;

    if (selection.rangeCount > 0) {
        const anchorNode = selection.anchorNode;
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        
        if (safeNode.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper')) {
            alert("‚ö†Ô∏è N√£o pode inserir uma caixa dentro de outra. Clique numa linha vazia primeiro.");
            return;
        }
        range = selection.getRangeAt(0);
    } else {
        range = document.createRange();
        range.selectNodeContents(editor);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
    }

    // 2. CONFIGURA√á√ÉO DE HTML
    const uniqueId = type === 'redator' ? `red_${Date.now()}` : `mn_${Date.now()}`;
    const inputStyle = "user-select: text; -webkit-user-select: text; pointer-events: auto; touch-action: manipulation;";
    const isWrapEnabled = (typeof appSettings !== 'undefined' && appSettings.showFullTitles);
    const wrapClass = isWrapEnabled ? ' wrap-enabled' : '';
    const heightStyle = isWrapEnabled ? 'height: auto;' : ''; 

    const commonToolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Subir">üî∫</button>
                <button type="button" data-action="move-down" title="Descer">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Links/Codex">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Clonar">üß¨</button>
            <button type="button" data-action="highlight-color" title="Cor">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Apagar">üóëÔ∏è</button>
        </div>`;

    let finalHTML = '';

if (type === 'redator') {
    finalHTML = `
    <div class="redator-wrapper" id="${uniqueId}" contenteditable="false" data-shared="false" data-box-links='{}' data-paragraph="0">
        
        <!-- 1. BOT√ïES FLUTUANTES (Vis√≠veis s√≥ quando colapsado) -->
        <button class="redator-reopen-btn" onclick="window.toggleRedatorHeader('${uniqueId}', true)">T</button>
        <button class="redator-collapsed-menu-btn" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>

        <!-- 2. O MENU (Fora do header para n√£o ser cortado) -->
        <div class="redator-slide-menu">
            <button class="tool-icon-btn" data-action="sharing-settings" title="Partilha">üîê</button>
            <button class="tool-icon-btn" data-action="manage-box-links" title="Links/Codex">‚ö°</button>
            <button class="tool-icon-btn" data-action="move-up" title="Subir">üî∫</button>
            <button class="tool-icon-btn" data-action="move-down" title="Descer">üîª</button>
            <button class="tool-icon-btn" data-action="highlight-color" title="Cor">üé®</button>
            <button class="tool-icon-btn" data-action="manage-mini-note-topics" title="T√≥picos">üìã</button>
            <button class="tool-icon-btn" data-action="append-mini-note" title="Clonar">üß¨</button>
            <div style="width:1px; background:rgba(255,255,255,0.2); height:15px; margin:0 2px;"></div>
            <button class="tool-icon-btn" data-action="delete-mini-note" style="color:#e74c3c;">üóëÔ∏è</button>
        </div>

        <!-- 3. CABE√áALHO (Vis√≠vel s√≥ quando expandido) -->
        <div class="redator-header" id="header-${uniqueId}">
           <input type="text" class="redator-input" placeholder="T√≠tulo do Redator..." value="" 
                  oninput="this.setAttribute('value', this.value)" 
                  style="${inputStyle}">
            <div class="redator-top-tools">
                <!-- Bot√£o normal (desaparece quando o header fecha) -->
                <button class="redator-menu-trigger" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>
            </div>
        </div>
        
        <div class="redator-content" contenteditable="true" data-placeholder="" oninput="window.checkRedatorFocus(this, '${uniqueId}')"><p><br></p></div>
        
        <div class="redator-dock">
             <button class="dock-btn" onclick="event.preventDefault(); window.openRedatorFocus('${uniqueId}')">‚á±</button>
             <div class="dock-sep"></div>
             <button class="dock-btn" onclick="event.preventDefault(); window.addRedatorBelow('${uniqueId}')">+</button>
        </div>
    </div>
    <p><br></p>`;
}
    else {
        let wrapperClass = 'mini-note-wrapper';
        let titleHTML = `<textarea class="mini-note-title-input${wrapClass}" placeholder="T√≠tulo..." rows="1" style="${inputStyle} ${heightStyle}"></textarea>`;

        if (type === 'question') {
            wrapperClass += ' question-mode';
            titleHTML = `<textarea class="mini-note-title-input${wrapClass}" placeholder="Pergunta?" rows="1" style="${inputStyle} ${heightStyle}"></textarea>`;
        } else if (type === 'free') {
            wrapperClass += ' free-mode';
            titleHTML = '';
        }

        finalHTML = `
            <div class="${wrapperClass}" id="${uniqueId}" contenteditable="false" data-topics='{}' data-shared="false" data-box-links='{}'>
                ${titleHTML}
                ${commonToolbarHTML}
                <div class="mini-note-content" contenteditable="true">
                    <p><br></p>
                </div>
            </div>
            <p><br></p>`;
    }

    // 3. INSERIR
    document.execCommand('insertHTML', false, finalHTML);
    
    if (typeof updateSaveStatus === 'function') updateSaveStatus('unsaved');
    if (typeof saveNote === 'function') saveNote(false);

    // ============================================================
    // 4. L√ìGICA DE SCROLL E FOCO (ATUALIZADA)
    // ============================================================
    setTimeout(() => {
        const newBox = document.getElementById(uniqueId);
        
        if (newBox) {
            // A. Definir o alvo do foco
            let targetToFocus = null;

            if (type === 'redator') {
                targetToFocus = newBox.querySelector('.redator-content');
            } else if (type === 'free') {
                targetToFocus = newBox.querySelector('.mini-note-content');
            } else {
                targetToFocus = newBox.querySelector('.mini-note-title-input');
            }

            // B. Focar PRIMEIRO (Isto faz o browser saltar)
            if (targetToFocus) {
                targetToFocus.focus();
                if (targetToFocus.tagName === 'INPUT' || targetToFocus.tagName === 'TEXTAREA') {
                    targetToFocus.click(); // Ajuda no mobile
                }
            }

            // C. Scroll DEPOIS (Corrige o salto e centra)
            // Usamos requestAnimationFrame para garantir que corre no pr√≥ximo frame de pintura
            window.requestAnimationFrame(() => {
                newBox.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
                
                // Flash Visual para confirmar a cria√ß√£o
                newBox.style.transition = "box-shadow 0.5s, border-color 0.5s";
                const originalBorder = newBox.style.borderColor;
                
                newBox.style.boxShadow = "0 0 25px var(--accent-color)";
                newBox.style.borderColor = "var(--accent-color)";
                
                setTimeout(() => { 
                    newBox.style.boxShadow = ""; 
                    newBox.style.borderColor = originalBorder;
                }, 1000);
            });
        }
    }, 50); // Delay curto para o DOM processar
}

// Fun√ß√£o auxiliar para aplicar o foco (Reutiliz√°vel)
function applyFocusLogic(uniqueId, type, editor) {
    const insertedEl = document.getElementById(uniqueId);
    if (!insertedEl) return;

    // A. Scroll para ver o elemento
    insertedEl.scrollIntoView({ behavior: 'auto', block: 'center' });

    // B. Decidir o Alvo
    let targetToFocus = null;

    if (type === 'redator') {
        targetToFocus = insertedEl.querySelector('.redator-content');
    } 
    else if (type === 'free') {
        targetToFocus = insertedEl.querySelector('.mini-note-content');
    } 
    else {
        // SubNota e Quest√£o -> T√çTULO
        targetToFocus = insertedEl.querySelector('.mini-note-title-input');
    }

    // C. Executar Foco
    if (targetToFocus) {
        editor.blur(); 
        
        targetToFocus.focus();
        targetToFocus.click(); 

        if (targetToFocus.tagName === 'TEXTAREA' || targetToFocus.tagName === 'INPUT') {
            const val = targetToFocus.value;
            targetToFocus.value = '';
            targetToFocus.value = val;
        }
        else if (targetToFocus.getAttribute('contenteditable') === 'true') {
            const range = document.createRange();
            range.selectNodeContents(targetToFocus);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // >>> CORRE√á√ÉO FUNDAMENTAL AQUI TAMB√âM <<<
        // Atualiza o GPS manualmente
        if (typeof trackCursorPosition === 'function') {
            trackCursorPosition();
        }
    }
}
                
       

// ====================================================================
// LISTENER DO POPUP DE SELE√á√ÉO (A√ß√µes da Barra Flutuante)
// ====================================================================
selectionPopup.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // ------------------------------------------
    // 1. NEGRITO BRANCO INTELIGENTE (B)
    // ------------------------------------------
    if (action === 'quick-bold') {
        // ... (c√≥digo do negrito mant√©m-se igual)
        const isBold = document.queryCommandState('bold');
        if (!isBold) document.execCommand('foreColor', false, '#f0f0f0');
        document.execCommand('bold', false, null);
        saveNote();
    }

    // ------------------------------------------
    // 2. T√çTULOS R√ÅPIDOS (A1 e A2)
    // ------------------------------------------
    else if (action === 'quick-h1') {
        document.execCommand('formatBlock', false, 'H1');
        
        // Limpa estilos residuais para garantir que o H1 fica limpo
        const selection = window.getSelection();
        if (selection.anchorNode) {
            let block = selection.anchorNode.parentNode;
            if (block.tagName === 'H1') {
                block.removeAttribute('style'); // Remove cores/tamanhos antigos
            }
        }
        saveNote();
    }

    else if (action === 'quick-h2') {
        document.execCommand('formatBlock', false, 'H2');
        
        const selection = window.getSelection();
        if (selection.anchorNode) {
            let block = selection.anchorNode.parentNode;
            if (block.tagName === 'H2') {
                block.removeAttribute('style');
            }
        }
        saveNote();
    }

    // ------------------------------------------
    // 3. CRIAR CART√ÉO WEB (üé¥)
    // ------------------------------------------
    else if (action === 'create-url-card') {
        await convertSelectionToUrlCard();
        // N√£o precisa de saveNote() aqui, a fun√ß√£o j√° o faz
    }

    // ------------------------------------------
    // 4. CRIAR IDEIA (üí°)
    // ------------------------------------------
    else if (action === 'create-idea') {
        if (!currentSelectionRange) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0).cloneRange();
        }

        if (currentSelectionRange) {
            const text = currentSelectionRange.toString();
            if (text.trim()) {
                try {
                    // 1. FOR√áAR PONTO DE HIST√ìRICO (O SEGREDO)
                    // Executamos um comando "falso" que n√£o faz nada visualmente,
                    // mas obriga o navegador a guardar o estado atual no hist√≥rico de Undo.
                    // 'insertText' √© perfeito para isto porque agrupa a a√ß√£o.
                    document.execCommand('insertText', false, text);
                    
                    // Como o insertText substituiu a sele√ß√£o pelo pr√≥prio texto (sem mudar nada),
                    // precisamos de re-selecionar o texto para aplicar a transforma√ß√£o
                    // (O browser pode ter perdido a sele√ß√£o exata)
                    
                    // --- RECUPERAR SELE√á√ÉO ---
                    // O cursor agora est√° no fim do texto inserido.
                    // Vamos selecionar para tr√°s o tamanho do texto.
                    const sel = window.getSelection();
                    const range = document.createRange();
                    range.setStart(sel.anchorNode, sel.anchorOffset - text.length);
                    range.setEnd(sel.anchorNode, sel.anchorOffset);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    currentSelectionRange = range; // Atualiza a refer√™ncia global
                    
                    // 2. GRAVAR NO FIREBASE (Background)
                    // N√£o esperamos pelo await aqui para n√£o bloquear a UI
                    addDoc(collection(db, 'ideias'), {
                        texto: text,
                        origemNoteId: selectedNoteId,
                        userId: auth.currentUser.uid,
                        createdAt: serverTimestamp()
                    }).then(docRef => {
                        // Se precisares do ID depois, podes atualizar o atributo aqui,
                        // mas para o Undo funcionar, a estrutura HTML tem de ser criada J√Å.
                        const span = document.querySelector('.idea-span-temp');
                        if(span) {
                            span.dataset.ideaId = docRef.id;
                            span.classList.remove('idea-span-temp');
                        }
                    });

                    // 3. APLICA√á√ÉO HTML (Que ser√° revertida pelo Undo)
                    // Usamos 'insertHTML' em vez de manipula√ß√£o direta de n√≥s (appendChild)
                    // porque o 'insertHTML' √© nativamente suportado pelo Undo do browser.
                    
                    const ideaHTML = `<span class="idea-span idea-span-temp" spellcheck="false">${text}</span>&nbsp;`;
                    document.execCommand('insertHTML', false, ideaHTML);

                    saveNote();

                } catch (error) {
                    console.error("Erro ideia:", error);
                }
            }
        }
    }

    // ------------------------------------------
    // 5. CRIAR LINK / EDITAR LINK (üîó)
    // ------------------------------------------
   else if (action === 'create-link') {
        const selection = window.getSelection();
        let existingLink = null;
        let existingSuperLink = null;

        if (selection.rangeCount > 0 && selection.anchorNode) {
            const node = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            
            // Verifica se a sele√ß√£o est√° DENTRO de um link ou superlink
            existingLink = node.closest('a[data-anexo-id]');
            existingSuperLink = node.closest('.superlink-dotted');
        }

        // Fecha menus
        if(document.getElementById('link-modal')) document.getElementById('link-modal').style.display = 'none';
        selectionPopup.style.display = 'none';

        // Abre o gestor correto
        if (typeof window.openSourceManager === 'function') {
            // A fun√ß√£o openSourceManager j√° est√° preparada para detetar se h√° sele√ß√£o
            // e se essa sele√ß√£o corresponde a um link existente, abrindo em modo edi√ß√£o.
            window.openSourceManager();
        }
    }

    // ------------------------------------------
    // 6. REMOVER LINK (‚õìÔ∏è‚Äçüí•)
    // ------------------------------------------
    else if (action === 'break-link') {
        const selection = window.getSelection();
        let linkElement = null;
        
        if (selection.rangeCount > 0 && selection.anchorNode) {
            const safeNode = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
            linkElement = safeNode.closest('a[data-anexo-id]');
        }
        
        if (linkElement) {
            openLinkModal(true, { id: linkElement.dataset.anexoId });
        }
    }

    // ------------------------------------------
    // 7. CRIAR POST-IT (üìí)
    // ------------------------------------------
    else if (action === 'highlight') { 
        if (!currentSelectionRange) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) currentSelectionRange = sel.getRangeAt(0);
        }

        const selectedText = currentSelectionRange ? currentSelectionRange.toString() : ""; 

        if (selectedText.trim()) {
            const container = document.createElement('div');
            container.className = 'post-it-note active-note';
            container.contentEditable = "false";
            
            const scrollTop = noteContentEditor.scrollTop;
            container.style.top = (scrollTop + 50) + 'px'; 
            container.style.left = '50px';
            container.id = 'postit_' + Date.now();

            container.innerHTML = `
                <div class="post-it-drag-handle" contenteditable="false">‚ú•</div>
                <div class="post-it-cut-btn" contenteditable="false" title="Cortar">‚úÇÔ∏è</div>
                <div class="post-it-content" contenteditable="true">${selectedText}</div>
            `;

            currentSelectionRange.deleteContents();
            noteContentEditor.appendChild(container);
            saveNote(); 
        }
    }

    // ------------------------------------------
    // FINALIZA√á√ÉO (Limpeza Comum)
    // ------------------------------------------
    selectionPopup.style.display = 'none';
    window.getSelection().removeAllRanges();
    currentSelectionRange = null; 
});





function validateAndCleanBiblicalLinks() {
    
    const biblicalBooksPattern = `${BIBLICAL_BOOKS.join('|')}`;

    // =======================================================
    // AQUI ESTAVA O ERRO PERSISTENTE - ESTA √â A REGEX CORRETA E RIGOROSA
    // =======================================================
    const validPattern = new RegExp(`^${biblicalBooksPattern}\\s+\\d+:\\d[\\d,;\\- ]*$`, 'i');

    const links = noteContentEditor.querySelectorAll('.entity-link[data-entity-type="textobiblico"]');
    


    let domChanged = false;

    links.forEach((link, index) => {
        const originalText = link.textContent;
        const trimmedText = originalText.trim();
        

        if (!validPattern.test(trimmedText)) {
            
            const textNode = document.createTextNode(originalText);
            link.parentNode.replaceChild(textNode, link);

            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(textNode, textNode.length);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            domChanged = true;
        } else {
        }
    });

    if (domChanged) {
    } else {
    }
    
    return domChanged;
}




 // ===================================================================
// FUN√á√ÉO SCANANDLINKENTITIES - VERS√ÉO COM REGEX CORRIGIDA
// ===================================================================
 async function scanAndLinkEntities() {
    const logStyles = {
        header: 'color: white; background-color: #1abc9c; font-weight: bold; padding: 2px 5px; border-radius: 3px;',
        phase: 'color: #f39c12; font-weight: bold;',
        success: 'color: #2ecc71;',
        info: 'color: #95a5a6; font-style: italic;',
        action: 'color: #3498db;',
        automation: 'color: white; background-color: #8e44ad; font-weight: bold; padding: 2px 5px; border-radius: 3px;'
    };


    noteContentEditor.normalize();
    
    // --- CORRE√á√ÉO AQUI ---
    const hasCleanedLinks = await validateAndCleanBiblicalLinks(); 
    // ---------------------

    if (hasCleanedLinks) {
        updateSaveStatus('unsaved');
        saveNote(); 
        console.groupEnd();
        return; 
    } else {
    }

    const selection = window.getSelection();
    if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
        console.groupEnd();
        return;
    }
    const originalRange = selection.getRangeAt(0).cloneRange();

    console.group('%cFASE 1: Liga√ß√£o de Formato Padr√£o (Livro C:V)', logStyles.phase);
    
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const standardBiblicalRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)\\b`, 'giu');
    

    let domModified = false;
    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    const nodesToProcess = [];
    let node;
    while (node = walker.nextNode()) {
        if (!node.parentElement.closest('a, .entity-link, .tag')) {
            nodesToProcess.push(node);
        }
    }

    for (const textNode of nodesToProcess) {
        standardBiblicalRegex.lastIndex = 0;
        let match;
        if ((match = standardBiblicalRegex.exec(textNode.textContent)) !== null) {
            domModified = true;
            
            const matchedName = match[1].trim(); 
            const cleanedName = matchedName.replace(/[.,;]+$/, '');

            const matchStartIndex = match.index;
            
            textNode.splitText(matchStartIndex + matchedName.length);
            let matchNode = textNode.splitText(matchStartIndex);
            const span = document.createElement('span');
            span.className = 'entity-link';
            span.dataset.entityType = 'textobiblico';
            span.dataset.entityName = cleanedName;
            span.textContent = cleanedName;
            matchNode.parentNode.replaceChild(span, matchNode);
            
            const allExistingEntities = Object.values(allEntities).flat();
            let entity = allExistingEntities.find(e => e.tipo === 'textobiblico' && e.nome.toLowerCase() === cleanedName.toLowerCase());
            
            if (!entity) {
                console.group('%c[Automa√ß√£o] Nova Entidade B√≠blica Detetada', logStyles.automation);
                const collectionName = ENTITY_CONFIG['textobiblico'].collection;

                try {
                    await addDoc(collection(db, collectionName), { 
                        nome: cleanedName, 
                        descricao: "", 
                        userId: auth.currentUser.uid, 
                        createdAt: serverTimestamp(), 
                        referencias: { [selectedNoteId]: true } 
                    });

                } catch (error) {
                    console.error(`%c  - ERRO: Falha ao criar a entidade autom√°tica na base de dados.`, 'color: red; font-weight: bold;', error);
                } finally {
                    await fetchAllEntities(); 
                    console.groupEnd(); 
                }
            }
            break; 
        }
    }
    console.groupEnd(); 
    
    if (domModified) {
        selection.removeAllRanges();
        selection.addRange(originalRange);
        updateSaveStatus('unsaved');
        saveNote();
    }
}


function requestPassword(mode, itemId) {
    return new Promise((resolve) => {
        const modal = document.getElementById('password-modal');
        const input = document.getElementById('password-input');
        const confirmBtn = document.getElementById('password-confirm-btn');
        const cancelBtn = document.querySelector('#password-modal [data-action="cancel"]');
        const errorMsg = document.getElementById('password-error');

        if (!modal) return resolve(null);

        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "10000000";

        input.value = '';
        if (errorMsg) errorMsg.style.display = 'none';

        const title = document.getElementById('password-modal-title');
        const desc = document.getElementById('password-modal-desc');

        if (mode === 'create') {
            title.textContent = 'Definir Prote√ß√£o';
            desc.textContent = 'Escolha uma palavra-passe para este item.';
        } else {
            title.textContent = 'Item Protegido';
            desc.textContent = 'Insira a palavra-passe para aceder.';
        }

        setTimeout(() => input.focus(), 200);

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const cleanup = (value) => {
            modal.style.display = 'none';
            resolve(value);
        };

    newConfirmBtn.onclick = async (e) => {
    e.preventDefault();
    const pass = input.value.trim();
    if (!pass) return;

    if (mode === 'create') {
        cleanup(pass);
    } else {
        // MODO ACESSO ou REMOVE
        try {
            const docRef = doc(db, 'pastas', itemId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists() && docSnap.data().passe === pass) {
                if (mode === 'remove') {
                    // SE FOR PARA REMOVER, APAGA O CAMPO NO FIREBASE
                    await updateDoc(docRef, {
                        passe: deleteField() 
                    });
                }
                cleanup(true);
            } else {
                if (errorMsg) errorMsg.style.display = 'block';
                input.value = '';
                input.focus();
            }
        } catch (err) {
            console.error(err);
            cleanup(false);
        }
    }
};

        if (cancelBtn) cancelBtn.onclick = () => cleanup(null);
    });
}

// --- FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS ---

function showContextMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const item = e.target.closest('.list-item');
    if (!item) return;

    const menu = document.getElementById('context-menu');
    
    // Captura os dados do item
    activeItemContext = {
        id: item.dataset.id,
        name: item.dataset.name,
        type: item.dataset.type, // Aqui sabemos se √© 'nota' ou 'pasta'
        emoji: item.dataset.emoji,
        parentId: item.dataset.parentId === "null" ? null : item.dataset.parentId,
        isSuperfolder: item.dataset.superpasta === "true",
        isPinned: item.dataset.pinned === "true",
        isProtected: item.dataset.protected === "true",
        oque: item.dataset.oque,
        userId: item.dataset.userid 
    };

    // --- CABE√áALHO DIN√ÇMICO ---
    if (!document.getElementById('hide-ctx-title-style')) {
        const style = document.createElement('style');
        style.id = 'hide-ctx-title-style';
        style.innerHTML = '#context-menu::before { display: none !important; }';
        document.head.appendChild(style);
    }

    let header = document.getElementById('ctx-menu-header');
    if (!header) {
        header = document.createElement('div');
        header.id = 'ctx-menu-header';
        header.style.cssText = "text-align: center; font-weight: bold; color: var(--accent-color); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block;";
        menu.insertBefore(header, menu.firstChild);
    }
    header.textContent = `OP√á√ïES: ${activeItemContext.name}`;
    header.title = activeItemContext.name;

    // --- LIMPEZA DE SEGURAN√áA ---
    // 1. Esconde TODOS os bot√µes por defeito
    menu.querySelectorAll('button').forEach(b => {
        if(!b.classList.contains('context-menu-close')) b.style.display = 'none';
    });
    // 2. Esconde todos os separadores
    menu.querySelectorAll('.menu-sep').forEach(sep => sep.style.display = 'none');

    // --- REGRAS DE EXIBI√á√ÉO ---
    
    // SEMPRE VIS√çVEIS
    menu.querySelector('[data-action="rename"]').style.display = 'flex';
    menu.querySelector('[data-action="hide"]').style.display = 'flex';

    if (currentViewMode === 'local' || currentViewMode === 'pins' || currentViewMode === 'flash') {
        
        // PROTE√á√ÉO
        if (activeItemContext.isProtected) {
            menu.querySelector('[data-action="unprotect"]').style.display = 'flex';
        } else {
            menu.querySelector('[data-action="protect"]').style.display = 'flex';
        }

        // MOVIMENTO
        if (currentViewMode === 'local') {
            menu.querySelector('[data-action="move-position"]').style.display = 'flex';
        }
        menu.querySelector('[data-action="move-folder"]').style.display = 'flex';
        
        // T√ìPICOS
        menu.querySelector('[data-action="manage-topics"]').style.display = 'flex';
        
        // PIN
        menu.querySelector('[data-action="toggle-pin"]').style.display = 'flex';
        menu.querySelector('[data-action="toggle-pin"]').textContent = activeItemContext.isPinned ? "Remover Pin" : "Adicionar Pin";

        // >>> GARANTIA ABSOLUTA: S√ì MOSTRA SE FOR PASTA <<<
        if (activeItemContext.type === 'pasta') {
            const superBtn = menu.querySelector('[data-action="toggle-superfolder"]');
            superBtn.style.display = 'flex';
            
            if (activeItemContext.isSuperfolder) {
                superBtn.textContent = "Retornar a Pasta";
                menu.querySelector('[data-action="change-icon"]').style.display = 'flex';
            } else {
                superBtn.textContent = "Tornar Superpasta";
            }
        }
    }

    // 3. Gest√£o Inteligente de Separadores
    const separators = menu.querySelectorAll('.menu-sep');
    separators.forEach(sep => {
        let hasVisibleBefore = false;
        let prev = sep.previousElementSibling;
        while(prev && !prev.classList.contains('menu-sep') && prev.id !== 'ctx-menu-header') {
            if(prev.style.display === 'flex') { hasVisibleBefore = true; break; }
            prev = prev.previousElementSibling;
        }
        if(hasVisibleBefore) sep.style.display = 'block';
    });

    // 4. Mostrar
    menu.style.display = 'flex';
    let overlay = document.getElementById('context-menu-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'context-menu-overlay';
        overlay.style.cssText = "position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999999; display:none;";
        overlay.onclick = window.hideContextMenu;
        document.body.appendChild(overlay);
    }
    overlay.style.display = 'block';
}



// Atualizar a fun√ß√£o de fechar para esconder o overlay tamb√©m
// Define a fun√ß√£o globalmente para que o bot√£o "Cancelar" no HTML a consiga encontrar
window.hideContextMenu = function() {
    
    const menu = document.getElementById('context-menu');
    if (menu) menu.style.display = 'none';
    
    // Esconde tamb√©m o fundo escuro (overlay) se ele existir
    const overlay = document.getElementById('context-menu-overlay');
    if (overlay) overlay.style.display = 'none';
    
    activeItemContext = null;
};



function showConfirmation(title, message) {
    const modal = document.getElementById('confirm-modal');
    if (!modal) return Promise.resolve(false);

    const titleEl = document.getElementById('confirm-title');
    const messageEl = document.getElementById('confirm-message');
    const confirmBtn = modal.querySelector('[data-action="confirm"]');
    const cancelBtn = modal.querySelector('[data-action="cancel"]');

    // 1. Atualiza Texto
    titleEl.textContent = title;
    messageEl.textContent = message;

    // 2. FOR√áA BRUTA DE VISIBILIDADE (CORRE√á√ÉO)
    document.body.appendChild(modal); // Move para o topo da hierarquia
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO 32-BIT INT */
        justify-content: center !important;
        align-items: center !important;
    `;

    // 3. Reset do Bot√£o
    if (confirmBtn) {
        confirmBtn.textContent = "Confirmar";
        confirmBtn.disabled = false;
        
        // Remove ouvintes antigos clonando
        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        
        const newCancel = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

        return new Promise(resolve => {
            newConfirm.onclick = () => {
                modal.style.display = 'none';
                resolve(true);
            };
            newCancel.onclick = () => {
                modal.style.display = 'none';
                resolve(false);
            };
        });
    }
    return Promise.resolve(false);
}


// --- L√ìGICA DE MODAIS E PAIN√âIS ADICIONAIS ---

async function openMoveModal(itemContext) {
    if (!itemContext) return;

    const modal = document.getElementById('move-item-modal');
    const list = document.getElementById('move-list');
    
    list.innerHTML = '<li style="padding:10px;">Carregando...</li>';
    modal.style.display = 'flex';
    
    try {
        let pId = itemContext.parentId;

        // SEURAN√áA PARA SUPERPASTAS: 
        // Se pId for null mas o itemContext n√£o tiver essa info, vamos validar no Firebase
        if (pId === undefined) {
            const docSnap = await getDoc(doc(db, 'pastas', itemContext.id));
            if (docSnap.exists()) {
                pId = docSnap.data().parentId;
            }
        }

        // Query: Busca todos os itens que t√™m o MESMO pai que o item clicado
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', pId), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid), 
            orderBy('ordem')
        );
        
        const snapshot = await getDocs(q);
        let items = [];
        snapshot.forEach(doc => {
            items.push({ id: doc.id, ...doc.data() });
        });

        if (items.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum item encontrado nesta localiza√ß√£o.</li>';
        } else {
            renderMoveList(items, itemContext.id); 
        }

    } catch (error) {
        console.error("Erro ao carregar itens para mover:", error);
        list.innerHTML = '<li style="padding:10px; color:#e74c3c;">Erro ao carregar dados.</li>';
    }
}

// --- NOVA FUN√á√ÉO PARA GERIR O MODAL "MOVER DE PASTA" ---
 async function openMoveToFolderModal(itemContext) {
    if (!itemContext) return;

    itemToMoveRef = itemContext; 
    const modal = document.getElementById('move-to-folder-modal');
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const nameSpan = document.getElementById('item-to-move-name');
    
    if (!modal) return;

    // --- APLICA√á√ÉO DA BLINDAGEM (IGUAL AO RENAME) ---
    document.body.appendChild(modal); 
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.setProperty('z-index', '20000000', 'important');
    modal.style.setProperty('visibility', 'visible', 'important');
    modal.style.setProperty('opacity', '1', 'important');

    if(nameSpan) nameSpan.textContent = itemContext.name;

    // --- RECONFIGURA√á√ÉO DA NAVEGA√á√ÉO (Mant√©m o resto do teu c√≥digo) ---
    let navContainer = document.getElementById('move-folder-nav-container');
    if (!navContainer) {
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz</span>
        `;
        list.parentNode.insertBefore(navContainer, list);
        
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : rootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(rootId);
            }
        });
    }

    moveStack = []; 
    selectedDestFolderId = null; 
    
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    loadMoveFolderList(startRootId);

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

  newConfirmBtn.onclick = async () => {
        let targetId = selectedDestFolderId;
        
        // Se n√£o selecionou nada (apenas navegou), assume a pasta atual da navega√ß√£o do modal
        if (targetId === null) {
            const currentViewId = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : startRootId;
            
            // 1. Z-Index fix para o modal de confirma√ß√£o
            const confirmModalElement = document.getElementById('confirm-modal');
            if (confirmModalElement) {
                confirmModalElement.style.setProperty('z-index', '2147483647', 'important');
            }

            const confirmed = await showConfirmation(
                "Confirmar Movimento", 
                `Mover "${itemContext.name}" para a pasta que est√° a ver agora?`
            );
            
            if (confirmModalElement) confirmModalElement.style.zIndex = "";

            if (!confirmed) return;
            
            targetId = currentViewId;
        }

        if (targetId === itemContext.id) {
            alert("N√£o pode mover uma pasta para dentro de si mesma.");
            return;
        }

        try {
            const { doc, updateDoc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const itemRef = doc(db, 'pastas', itemContext.id);
            
            const updateData = {
                parentId: targetId, 
                ultimaedicao: serverTimestamp()
            };

            // L√≥gica Flash (mant√©m-se igual)
            if (currentViewMode === 'flash' || itemContext.oque === 'flash') {
                updateData.oque = deleteField();
            }

            // GRAVAR NO FIREBASE
            await updateDoc(itemRef, updateData);
            
            modal.style.display = 'none';
            
            // ============================================================
            // CORRE√á√ÉO: NAVEGAR PARA O DESTINO
            // ============================================================
            if (currentViewMode === 'flash') {
                 loadFlashListLeftPanel();
            } else {
                 // Feedback visual enquanto carrega
                 const middleList = document.getElementById('file-list');
                 if(middleList) middleList.innerHTML = '<div class="panel-loader"><div class="spinner"></div><span>A ir para a pasta...</span></div>';

                 if (targetId) {
                     // Reconstr√≥i o caminho (breadcrumbs) at√© √† pasta de destino
                     // e abre essa pasta no painel
                     await reconstructFolderNavigation(targetId);
                 } else {
                     // Se moveu para a Raiz, limpa a navega√ß√£o e atualiza
                     navigationStack = [];
                     updateNavigationView(true);
                 }
            }
            // ============================================================
            
        } catch (error) {
            console.error("Erro ao mover:", error);
            alert("Erro ao mover item.");
        }
    };
}

// ============================================================
// 2. CARREGAR LISTA (VISUAL IGUAL AO üß¨)
// ============================================================
async function loadMoveFolderList(parentId, isLoadMore = false) {
    const list = document.getElementById('folder-selection-list');
    const navContainer = document.getElementById('move-folder-nav-container');
    const backBtn = document.getElementById('move-folder-back-btn');
    const pathLabel = document.getElementById('move-folder-path');
    const LOAD_LIMIT = 15;

    // 1. MOSTRAR A BARRA DE NAVEGA√á√ÉO (Para saber onde estamos)
    if (navContainer) {
        navContainer.style.display = 'flex';
    }

    // Se N√ÉO for "Carregar Mais", √© uma navega√ß√£o nova (limpar tudo)
    if (!isLoadMore) {
        list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
        moveFolderLastDoc = null; // Reset do cursor
        
        // Atualiza o Texto do Topo (Breadcrumbs)
        if (moveStack.length > 0) {
            pathLabel.textContent = moveStack[moveStack.length - 1].name;
            backBtn.style.display = 'block';
        } else {
            pathLabel.textContent = parentId ? "Pasta Atual" : "Raiz (N√≠vel 1)";
            backBtn.style.display = 'none';
        }
    } else {
        const oldBtn = document.getElementById('move-folder-load-more');
        if (oldBtn) oldBtn.remove();
    }

    try {
        // --- QUERY HIER√ÅRQUICA (Filtra por Pasta Pai) ---
        let constraints = [
            collection(db, 'pastas'),
            where('parentId', '==', parentId), // O SEGREDO: S√≥ carrega filhos desta pasta
            where('tipo', '==', 'pasta'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome'),
            limit(LOAD_LIMIT)
        ];

        // Pagina√ß√£o
        if (isLoadMore && moveFolderLastDoc) {
            constraints.push(startAfter(moveFolderLastDoc));
        }

        const q = query(...constraints);
        const snapshot = await getDocs(q);

        // Se for o in√≠cio, limpa e adiciona a op√ß√£o "Ficar Aqui"
        if (!isLoadMore) {
            list.innerHTML = '';

            // --- OP√á√ÉO 1: SELECIONAR A PASTA ATUAL ONDE ESTAMOS ---
            const currentLi = document.createElement('li');
            currentLi.className = 'list-item';
            currentLi.style.fontWeight = 'bold';
            currentLi.style.borderBottom = '2px solid var(--border-color)';
            currentLi.style.color = 'var(--accent-color)';
            currentLi.style.padding = '12px';
            currentLi.style.cursor = 'pointer';
            
            // Texto din√¢mico: Se estamos na raiz diz "Raiz", se n√£o diz o nome da pasta
            const currentName = moveStack.length > 0 ? moveStack[moveStack.length - 1].name : "Raiz Principal";
            currentLi.innerHTML = `üì• Guardar nesta pasta: <u>${currentName}</u>`;
            
            currentLi.onclick = () => {
                handleMoveSelection(currentLi, parentId);
            };
            list.appendChild(currentLi);

            if (snapshot.empty) {
                const emptyLi = document.createElement('li');
                emptyLi.textContent = "Sem subpastas. (Pode guardar aqui)";
                emptyLi.style.padding = "10px";
                emptyLi.style.color = "var(--text-muted-color)";
                list.appendChild(emptyLi);
                return;
            }
        }

        // Atualiza o cursor
        const lastVisible = snapshot.docs[snapshot.docs.length - 1];
        if (lastVisible) {
            moveFolderLastDoc = lastVisible;
        }

        // --- RENDERIZA√á√ÉO DA LISTA ---
     snapshot.forEach(doc => {
            if (itemToMoveRef && doc.id === itemToMoveRef.id) return;

            const folder = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            
            li.className = 'list-item move-folder-item';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.padding = '12px';
            li.style.borderBottom = '1px solid var(--border-color)';
            li.style.cursor = 'pointer';

            // DIVIDIDO EM DUAS √ÅREAS:
            li.innerHTML = `
                <div class="move-select-area" style="flex-grow:1; display:flex; align-items:center;" title="Clique para selecionar esta pasta">
                    <!-- CORRE√á√ÉO AQUI: flex: none !important impede o √≠cone de esticar -->
                    <span style="font-size:1.2em; margin-right:10px; flex: none !important;">üìÅ</span>
                    <span>${folder.nome}</span>
                </div>
                <div class="move-nav-btn" style="padding: 5px 15px; border-left:1px solid var(--border-color); color:var(--text-muted-color); font-weight:bold;" title="Entrar na pasta">
                    ‚ûî
                </div>
            `;

            // ... resto dos listeners de clique (mant√™m-se iguais) ...
            const selectArea = li.querySelector('.move-select-area');
            selectArea.onclick = (e) => {
                e.stopPropagation();
                handleMoveSelection(li, folder.id);
            };

            const navBtn = li.querySelector('.move-nav-btn');
            navBtn.onclick = (e) => {
                e.stopPropagation();
                moveStack.push({ id: folder.id, name: folder.nome });
                loadMoveFolderList(folder.id, false);
            };
            
            navBtn.onmouseover = () => { navBtn.style.color = 'var(--accent-color)'; navBtn.style.backgroundColor = 'var(--hover-color)'; };
            navBtn.onmouseout = () => { navBtn.style.color = 'var(--text-muted-color)'; navBtn.style.backgroundColor = 'transparent'; };

            list.appendChild(li);
        });

        // --- BOT√ÉO CARREGAR MAIS ---
        if (snapshot.docs.length === LOAD_LIMIT) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'move-folder-load-more';
            loadMoreBtn.textContent = "Carregar mais subpastas...";
            loadMoreBtn.style.width = "100%";
            loadMoreBtn.style.padding = "10px";
            loadMoreBtn.style.marginTop = "5px";
            loadMoreBtn.style.background = "none";
            loadMoreBtn.style.border = "1px dashed var(--text-muted-color)";
            loadMoreBtn.style.color = "var(--text-muted-color)";
            loadMoreBtn.style.cursor = "pointer";
            
            loadMoreBtn.onclick = () => {
                loadMoreBtn.textContent = "A carregar...";
                loadMoveFolderList(parentId, true); // Mant√©m o mesmo n√≠vel, carrega mais
            };

            list.appendChild(loadMoreBtn);
        }

    } catch (e) {
        console.error(e);
        if (!isLoadMore) list.innerHTML = '<li>Erro ao carregar pastas.</li>';
    }
}


// --- FUN√á√ÉO AUXILIAR DE SELE√á√ÉO VISUAL ---
function handleMoveSelection(liElement, folderId) {
    // 1. Remove sele√ß√£o de todos
    const list = document.getElementById('folder-selection-list');
    list.querySelectorAll('li').forEach(el => {
        el.style.backgroundColor = 'transparent';
        el.classList.remove('selected');
    });

    // 2. Seleciona o atual
    liElement.classList.add('selected');
    liElement.style.backgroundColor = 'var(--selected-color)'; // Usa a cor do seu tema
    
    // 3. Atualiza vari√°vel de estado
    selectedDestFolderId = folderId;
}

function renderMoveList(items, activeItemId = null) {
    const list = document.getElementById('move-list');
    list.innerHTML = '';

    items.forEach((item, index) => {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        
        // Determina o √≠cone
        const icon = item.tipo === 'pasta' ? 'üìÅ' : 'üìÑ';

        li.innerHTML = `
            <span>${icon} ${item.nome}</span>
            <div class="order-controls">
                <button data-action="up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button data-action="down" ${index === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
            </div>
        `;

        // === NOVO: Se este √© o item que clicou ===
        if (activeItemId && item.id === activeItemId) {
            // 1. Destaca visualmente (fundo azulado e borda)
            li.style.backgroundColor = "var(--selected-color)";
            li.style.border = "1px solid var(--accent-color)";
            li.classList.add('active-move-target'); // Classe para encontrar depois
        }

        list.appendChild(li);
    });

    // Delegar cliques nas setas (L√≥gica original)
    list.onclick = (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const currentLi = btn.closest('li');
        const currentIndex = Array.from(list.children).indexOf(currentLi);
        const action = btn.dataset.action;

        // Precisamos manter o ID do item que est√° a ser movido para o re-focar
        const movingItemId = items[currentIndex].id;

        if (action === 'up' && currentIndex > 0) {
            [items[currentIndex], items[currentIndex - 1]] = [items[currentIndex - 1], items[currentIndex]];
        } else if (action === 'down' && currentIndex < items.length - 1) {
            [items[currentIndex], items[currentIndex + 1]] = [items[currentIndex + 1], items[currentIndex]];
        }
        
        // Re-renderiza mantendo o foco no item que estamos a mover
        renderMoveList(items, movingItemId);
    };

    // === NOVO: SCROLL AUTOM√ÅTICO ===
    setTimeout(() => {
        const activeItem = list.querySelector('.active-move-target');
        if (activeItem) {
            // center = coloca o item no meio do modal
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100); // Pequeno delay para garantir que o modal j√° abriu visualmente

    // Configurar o bot√£o "Salvar Ordem" (Mant√©m a l√≥gica original)
    const saveBtn = document.querySelector('#move-item-modal [data-action="save-order"]');
    // Removemos ouvintes antigos para evitar duplica√ß√£o (boa pr√°tica)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A guardar...";

        const { writeBatch, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const batch = writeBatch(db);
        
        items.forEach((item, index) => {
            const docRef = doc(db, 'pastas', item.id);
            batch.update(docRef, { 
                ordem: index,
                ultimaedicao: serverTimestamp()
            });
        });

        try {
            await batch.commit();
            document.getElementById('move-item-modal').style.display = 'none';
        } catch (err) {
            console.error("Erro ao salvar ordem:", err);
            alert("Erro ao salvar nova ordem.");
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Salvar Ordem";
        }
    };
}

async function showHiddenItemsModal() {
    const modal = document.getElementById('hidden-items-modal');
    const list = document.getElementById('hidden-items-list');
    
    // Mostra o modal com loading
    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar itens ocultos...</span></div>';
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9000000";

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const myUid = auth.currentUser.uid;
        let allHiddenItems = [];

        // 1. BUSCAR PASTAS E NOTAS (Inclui Arquivos, Jornais, Aqu√°rios)
        const qPastas = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'desativa'), 
            where('userId', '==', myUid) 
        );
        const snapPastas = await getDocs(qPastas);
        snapPastas.forEach(doc => {
            allHiddenItems.push({ id: doc.id, ...doc.data(), collectionName: 'pastas', isEntity: false });
        });

        // 2. BUSCAR ENTIDADES (Personagens, Locais, etc.)
        for (const key in ENTITY_CONFIG) {
            const config = ENTITY_CONFIG[key];
            const qEnt = query(
                collection(db, config.collection),
                where('estado', '==', 'desativa'),
                where('userId', '==', myUid)
            );
            const snapEnt = await getDocs(qEnt);
            snapEnt.forEach(doc => {
                allHiddenItems.push({ 
                    id: doc.id, 
                    ...doc.data(), 
                    collectionName: config.collection, 
                    tipo: key, 
                    isEntity: true 
                });
            });
        }

        // 3. BUSCAR √ÇNCORAS
        const qAncoras = query(
            collection(db, 'ancoras'),
            where('estado', '==', 'desativa'),
            where('userId', '==', myUid)
        );
        const snapAncoras = await getDocs(qAncoras);
        snapAncoras.forEach(doc => {
            allHiddenItems.push({
                id: doc.id,
                ...doc.data(),
                collectionName: 'ancoras',
                tipo: 'ancora',
                isEntity: true
            });
        });

        // --- ORGANIZA√á√ÉO POR SEC√á√ïES ---
        const groups = {
            'pastas': { title: 'üìÅ Pastas', items: [] },
            'notas': { title: 'üìÑ Notas', items: [] },
            'jornais': { title: 'üì∞ Jornais', items: [] },
            'aquarios': { title: 'ü™∏ Aqu√°rios', items: [] },
            'arquivos': { title: 'üóÑÔ∏è Arquivos Pessoais', items: [] },
            'partilhados': { title: 'ü§ù Arquivos Partilhados', items: [] },
            'entidades': { title: 'üîπ Entidades & Outros', items: [] }
        };

        // Distribui os itens pelos grupos corretos
        allHiddenItems.forEach(item => {
            if (item.isEntity) {
                groups['entidades'].items.push(item);
            } else {
                switch (item.tipo) {
                    case 'pasta': groups['pastas'].items.push(item); break;
                    case 'nota': groups['notas'].items.push(item); break;
                    case 'jornal': groups['jornais'].items.push(item); break;
                    case 'aquario': groups['aquarios'].items.push(item); break;
                    case 'arquivo': groups['arquivos'].items.push(item); break;
                    case 'partilhado': groups['partilhados'].items.push(item); break;
                    default: groups['notas'].items.push(item); break; // Fallback para notas antigas
                }
            }
        });

        // RENDERIZA√á√ÉO NA TELA
        list.innerHTML = '';
        let hasContent = false;

        // Fun√ß√£o auxiliar interna para desenhar uma sec√ß√£o
        const renderSection = (key) => {
            const group = groups[key];
            if (group.items.length === 0) return;

            hasContent = true;

            // Cabe√ßalho da Sec√ß√£o
            const header = document.createElement('div');
            header.style.cssText = "background: rgba(255,255,255,0.05); color: var(--accent-color); font-weight: bold; padding: 8px 10px; font-size: 0.85em; text-transform: uppercase; border-bottom: 1px solid var(--border-color); margin-top: 15px; border-radius: 4px;";
            header.textContent = `${group.title} (${group.items.length})`;
            list.appendChild(header);

            // Itens da Sec√ß√£o
            group.items.forEach(item => {
                const li = document.createElement('li');
                li.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid var(--border-color);';

                // Define o √≠cone correto para a lista
                let icon = '';
                if (item.isEntity) {
                    if (item.tipo === 'personagem') icon = 'üë§';
                    else if (item.tipo === 'local') icon = 'üìç';
                    else if (item.tipo === 'data') icon = 'üìÖ';
                    else if (item.tipo === 'ancora') icon = '‚öì';
                    else icon = 'üîπ';
                } else {
                    // √çcones para tipos principais j√° est√£o no cabe√ßalho, mas pomos aqui tamb√©m
                    if (item.tipo === 'aquario') icon = 'ü™∏';
                    else if (item.tipo === 'jornal') icon = 'üì∞';
                    else if (item.tipo === 'arquivo' || item.tipo === 'partilhado') icon = 'üóÑÔ∏è';
                    else if (item.tipo === 'pasta') icon = 'üìÅ';
                    else icon = 'üìÑ';
                }

                li.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:500;">${icon} ${item.nome}</span>
                        ${item.ultimaedicao ? `<small style="color:#666; font-size:0.7em;">Removido recentemente</small>` : ''}
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="modal-btn primary" 
                                data-action="restore-universal" 
                                data-id="${item.id}" 
                                data-collection="${item.collectionName}"
                                style="font-size:0.8em; padding:5px 10px;">Restaurar</button>
                        
                        <button class="modal-btn" 
                                data-action="delete-universal" 
                                data-id="${item.id}" 
                                data-collection="${item.collectionName}"
                                style="background-color:#c0392b; color:white; font-size:0.8em; padding:5px 10px; border:none; border-radius:5px; cursor:pointer;">Eliminar</button>
                    </div>
                `;
                list.appendChild(li);
            });
        };

        // Renderiza na ordem espec√≠fica que pediu
        renderSection('pastas');
        renderSection('notas');
        renderSection('jornais');
        renderSection('aquarios');
        renderSection('arquivos');
        renderSection('partilhados');
        renderSection('entidades');

        if (!hasContent) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">A reciclagem est√° vazia.</li>';
        }

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar itens.</li>';
    }
}

function addUrlField(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'url-field-wrapper';
    const urlInput = document.createElement('input');
    urlInput.type = 'text';
    urlInput.placeholder = 'URL da hiperliga√ß√£o';
    urlInput.value = urlValue;
    urlInput.style.flexGrow = '1';
    urlInput.style.padding = '12px';
    urlInput.style.backgroundColor = 'var(--bg-color)';
    urlInput.style.border = '1px solid var(--border-color)';
    urlInput.style.borderRadius = '5px';
    urlInput.style.color = 'var(--text-color)';
    urlInput.style.fontSize = '16px';
    const removeUrlBtn = document.createElement('button');
    removeUrlBtn.textContent = '‚Äì';
    removeUrlBtn.className = 'modal-btn remove-url-btn'; 
    removeUrlBtn.onclick = () => {
        if (container.childElementCount > 1) {
            fieldWrapper.remove();
        } else {
            alert('√â necess√°rio pelo menos um campo de URL.');
        }
    };
    fieldWrapper.appendChild(urlInput);
    fieldWrapper.appendChild(removeUrlBtn);
    container.appendChild(fieldWrapper);
}


// --- FUN√á√ÉO PARA ABRIR/CRIAR VERS√çCULO AUTOMATICAMENTE ---
async function createOrOpenVerse(book, chapter, verse) {
    const fullName = `${book} ${chapter}:${verse}`;
    
    // 1. Verifica se j√° existe no cache local
    const allBibleEntities = allEntities['textobiblico'] || [];
    const existing = allBibleEntities.find(e => e.nome === fullName);

    if (existing) {
        // Se existe, abre o painel
        showReferencesPanel(existing.id, existing.nome, 'textobiblico');
    } else {
        // --- ALTERA√á√ÉO AQUI: Usa o Popup Personalizado em vez do confirm() ---
        const confirmCreate = await showConfirmation(
            "Criar Novo Registo", 
            `O texto "${fullName}" ainda n√£o existe na base de dados.\nDeseja criar agora?`
        );
        
        if (!confirmCreate) return;

        try {
            // Cria no Firebase
            const docRef = await addDoc(collection(db, 'textosbiblicos'), {
                nome: fullName,
                descricao: "",
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                referencias: {} // Come√ßa vazio
            });

            // Adiciona ao cache local para n√£o ter de recarregar a p√°gina
            if (!allEntities['textobiblico']) allEntities['textobiblico'] = [];
            allEntities['textobiblico'].push({
                id: docRef.id,
                nome: fullName,
                tipo: 'textobiblico'
            });

            // Abre o painel
            showReferencesPanel(docRef.id, fullName, 'textobiblico');
            
            // Opcional: Recarregar a lista do meio para o bot√£o ficar verde
            updateNavigationView(true);

        } catch (error) {
            console.error("Erro ao criar vers√≠culo:", error);
            alert("Erro ao criar o registo.");
        }
    }
}

// ============================================================
// L√ìGICA DO PAINEL PUZZLE (4¬™ Coluna)
// ============================================================

// 1. Alternar Abas (Puzzle vs Refer√™ncias)
document.getElementById('ref-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const target = btn.dataset.refTab;
    
    e.currentTarget.querySelectorAll('button').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.ref-tab-content').forEach(el => el.style.display = 'none');
    
    // Mostra o container correto
    const contentEl = document.getElementById(`ref-content-${target}`);
    if (contentEl) {
        contentEl.style.display = (target === 'links' || target === 'puzzle' || target === 'dossie') ? 'flex' : 'block';
    }

    if (target === 'links') renderPanelLinks();
    if (target === 'dossie') {
        activeMicaId = null; // Sempre volta para a lista ao trocar de aba
        isDossieEditMode = false;
        renderDossie();
    }
});

// 2. Bot√£o Editar do Painel
document.getElementById('toggle-links-edit-btn').addEventListener('click', (e) => {
    isPanelEditMode = !isPanelEditMode;
    const btn = e.target;
    const actions = document.getElementById('links-edit-actions');

    if (isPanelEditMode) {
        btn.textContent = "Salvar";
        btn.classList.add('is-active');
        actions.style.display = 'flex';
    } else {
        btn.textContent = "Editar";
        btn.classList.remove('is-active');
        actions.style.display = 'none';
    }
    renderPanelLinks();
});

// 3. Abrir Criadores (Reaproveita os modais existentes com contextos diferentes)
// ABRIR O GESTOR (Modo Seguro)
window.openPanelLinkCreator = async function(type, index = -1) {
    const modal = document.getElementById('ref-panel-creator-modal');
    const titleEl = document.getElementById('ref-creator-title');
    const saveBtn = document.getElementById('ref-creator-save-btn');
    
    // Elementos das Abas
    const tabCodexBtn = document.querySelector('#ref-creator-tabs button[data-type="codex"]');
    const tabLinkBtn = document.querySelector('#ref-creator-tabs button[data-type="link"]');

    // Inputs e Containers
    const linkTitleInput = document.getElementById('ref-link-title');
    const urlsContainer = document.getElementById('ref-link-urls-container');
    const codexContainer = document.getElementById('ref-codex-rows-container');

    // 1. PREPARA√á√ÉO VISUAL
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    // Limpeza
    linkTitleInput.value = "";
    urlsContainer.innerHTML = "";
    codexContainer.innerHTML = "";
    editingLinkIndex = index;

    // Configura√ß√£o de T√≠tulo
    titleEl.textContent = (index > -1 ? "Editar " : "Novo ") + (type === 'codex' ? "Codex" : "Link");
    
    // --- CORRE√á√ÉO 1: EXCLUSIVIDADE DAS ABAS ---
    if (type === 'codex') {
        // Mostra Aba Codex, Esconde Aba Link
        tabCodexBtn.style.display = 'block';
        tabLinkBtn.style.display = 'none';
        switchRefCreatorTab('codex');
        
        // Se for cria√ß√£o nova, adiciona logo uma linha
        if (index === -1) window.addRefCodexRow();
    } else {
        // Mostra Aba Link, Esconde Aba Codex
        tabCodexBtn.style.display = 'none';
        tabLinkBtn.style.display = 'block';
        switchRefCreatorTab('link');
        
        // Se for cria√ß√£o nova, adiciona logo um campo URL
        if (index === -1) window.addRefUrlRow();
    }

    // 2. CARREGAR DADOS (SE FOR EDI√á√ÉO)
    if (index > -1) {
        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const collectionName = window.getCollectionFromType(activeReferenceEntity.type);
            const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));
            
            if (docSnap.exists()) {
                const links = docSnap.data().panelLinks || [];
                const item = links[index];

                if (type === 'link') {
                    linkTitleInput.value = item.title || "";
                    if (item.urls) Object.values(item.urls).forEach(u => window.addRefUrlRow(u));
                    else if (item.url) window.addRefUrlRow(item.url);
                } 
                else if (type === 'codex') {
                    // Preenche a linha do Codex
                    window.addRefCodexRow(item); 
                }
            }
        } catch (e) { console.error("Erro ao carregar dados:", e); }
    }

    // 3. CONFIGURAR BOT√ÉO GRAVAR
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        newSaveBtn.textContent = "A gravar...";
        newSaveBtn.disabled = true;

        try {
            let dataToSave = null;

            if (type === 'link') {
                const urlsMap = {};
                urlsContainer.querySelectorAll('input').forEach((inp, i) => {
                    if (inp.value.trim()) urlsMap[`url_${i}`] = inp.value.trim();
                });
                
                if (Object.keys(urlsMap).length === 0) throw new Error("Insira pelo menos um URL.");
                
                dataToSave = { 
                    type: 'link', 
                    title: linkTitleInput.value.trim() || "Link Web", 
                    urls: urlsMap 
                };
            } 
            else {
                // Captura dados do Codex (Apenas a primeira linha para simplificar a estrutura de dados)
                const row = codexContainer.querySelector('.codex-row');
                if (!row) throw new Error("Erro na estrutura do formul√°rio.");
                
                const rowData = window.getCodexDataFromRow(row);
                if (!rowData.serie) throw new Error("A S√©rie/Publica√ß√£o √© obrigat√≥ria.");

                // Gera o texto de exibi√ß√£o
                let displayTxt = `${rowData.serie}`;
                if (rowData.capitulo) displayTxt += ` cap.${rowData.capitulo}`;
                if (rowData.paginas.length) displayTxt += `, pg ${rowData.paginas.join(',')}`;
                if (rowData.tempo) displayTxt += ` [${rowData.tempo}]`; // Adiciona tempo se existir

                dataToSave = { 
                    type: 'codex', 
                    ...rowData, 
                    codiceshow: displayTxt
                };
            }

            // Grava no Firebase
            await savePanelLinkToFirebase(dataToSave, editingLinkIndex);
            
            modal.style.display = 'none';
            window.renderPanelLinks(); // Atualiza a lista na 4¬™ coluna

        } catch (err) {
            alert(err.message);
        } finally {
            newSaveBtn.textContent = "Gravar";
            newSaveBtn.disabled = false;
        }
    };
};

// --- HELPERS EXCLUSIVOS DESTE MODAL (Para n√£o misturar com o editor) ---

// 1. Alternar Abas (Visual)
window.switchRefCreatorTab = function(type) {
    const btns = document.querySelectorAll('#ref-creator-tabs button');
    btns.forEach(b => {
        if (b.dataset.type === type) b.classList.add('active');
        else b.classList.remove('active');
    });

    document.getElementById('ref-creator-codex-area').style.display = (type === 'codex') ? 'block' : 'none';
    document.getElementById('ref-creator-link-area').style.display = (type === 'link') ? 'block' : 'none';
};

// 2. Adicionar Linha URL
window.addRefUrlRow = function(val = "") {
    const container = document.getElementById('ref-link-urls-container');
    const div = document.createElement('div');
    div.style.cssText = "display:flex; gap:5px;";
    div.innerHTML = `
        <input type="text" class="redator-input" value="${val}" placeholder="https://..." style="flex:1; border:1px solid var(--border-color); padding:8px; background:var(--bg-color);">
        <button onclick="this.parentElement.remove()" style="border:1px solid #e74c3c; color:#e74c3c; background:transparent; padding:0 10px; border-radius:4px; cursor:pointer;">√ó</button>
    `;
    container.appendChild(div);
};

// 3. Adicionar Linha Codex (Reutiliza a estrutura HTML mas num container isolado)
window.addRefCodexRow = function(data = null) {
    const container = document.getElementById('ref-codex-rows-container');
    if (!container) return; // Seguran√ßa

    // Se estivermos a editar ou a criar, limpamos o container primeiro para garantir
    // que s√≥ h√° uma linha principal (a estrutura de dados atual suporta 1 objeto por item).
    // Se quiser suportar m√∫ltiplas linhas num s√≥ item, remova esta linha:
    container.innerHTML = ""; 

    const row = document.createElement('div');
    row.className = 'codex-row';
    
    // --- CORRE√á√ÉO 2: HTML COM BOT√ÉO 'T' (TEMPO) ---
    row.innerHTML = `
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
            </div>
            <div class="manual-controls">
                <label class="codex-label">OP√á√ïES</label>
                <div style="display:flex; gap:4px;">
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'A')" title="Ano">A</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'M')" title="M√™s">M</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'C')" title="Cap√≠tulo">C</button>
                    <!-- BOT√ÉO T ADICIONADO -->
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'T')" title="Tempo (H:M:S)">T</button>
                </div>
            </div>
        </div>
        <div class="manual-inputs-area"></div> 
        <div class="codex-content-grid">
            <div class="unit-section">
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div class="unit-section">
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;

    container.appendChild(row);

    // Restaurar dados se existirem
    if (data) {
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addCodexUnit(pgContainer, 'Par', p));
        
        // Restaurar campos manuais
        setTimeout(() => {
            if(data.manualYear) restoreManualField(row, 'A', '.manual-year', data.manualYear);
            if(data.manualMonth) restoreManualField(row, 'M', '.manual-month', data.manualMonth);
            if(data.capitulo) restoreManualField(row, 'C', '.manual-chapter', data.capitulo);
            
            // RESTAURAR TEMPO
            if(data.tempo) {
                const btn = row.querySelector("button[onclick*=\"'T'\"]");
                if(btn) { 
                    window.toggleManual(btn, 'T', data.tempo);
                }
            }
        }, 50);
    }
};

// Helper para restaurar campos simples
function restoreManualField(row, type, selector, value) {
    const btn = row.querySelector(`button[onclick*="'${type}'"]`);
    if(btn) { 
        window.toggleManual(btn, type);
        const input = row.querySelector(selector);
        if(input) input.value = value;
    }
}

// 4. FUN√á√ÉO GLOBAL PARA LER DADOS DA LINHA (Atualizada com Tempo)
window.getCodexDataFromRow = function(row) {
    const serieInput = row.querySelector('.serie-main');
    const serieVal = serieInput ? serieInput.value.trim() : "";
    
    const paginas = Array.from(row.querySelectorAll('.pages-container input')).map(i => i.value.trim()).filter(v => v !== "");
    const paragrafos = Array.from(row.querySelectorAll('.paragraphs-container input')).map(i => i.value.trim()).filter(v => v !== "");

    const yearInput = row.querySelector('.manual-year');
    const monthInput = row.querySelector('.manual-month');
    const chapInput = row.querySelector('.manual-chapter');
    
    // Captura Tempo
    const hInput = row.querySelector('.h-input');
    const mInput = row.querySelector('.m-input');
    const sInput = row.querySelector('.s-input');
    
    let tempoStr = "";
    if (hInput || mInput || sInput) {
        const h = (hInput && hInput.value) ? hInput.value.padStart(2, '0') : "00";
        const m = (mInput && mInput.value) ? mInput.value.padStart(2, '0') : "00";
        const s = (sInput && sInput.value) ? sInput.value.padStart(2, '0') : "00";
        // S√≥ guarda se houver algum valor diferente de zero
        if (h !== "00" || m !== "00" || s !== "00") {
            tempoStr = `${h}:${m}:${s}`;
        }
    }

    return {
        serie: serieVal,
        paginas: paginas,
        paragrafos: paragrafos,
        manualYear: yearInput ? yearInput.value : null,
        manualMonth: monthInput ? monthInput.value : null,
        capitulo: chapInput ? chapInput.value : null,
        tempo: tempoStr
    };
};

// 5. FUN√á√ÉO PARA CRIAR INPUTS MANUAIS (Atualizada para Tempo)
window.toggleManual = function(btn, type, val = '') {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    
    // Se j√° estiver ativo, removemos
    if (btn.classList.contains('active')) {
        // Se a chamada vier com valor (restauro), ignoramos o toggle off
        if (val === '') {
            const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));
            const el = area.querySelector(selector)?.closest('.manual-field-group');
            if (el) el.remove();
            btn.classList.remove('active');
            return;
        }
    } else {
        btn.classList.add('active');
    }

    // Se estamos a restaurar e j√° existe, n√£o cria duplicado
    if (type === 'T' && area.querySelector('.manual-time-group')) return;

    const group = document.createElement('div');
    group.className = 'manual-field-group';

    if (type === 'A') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-year" placeholder="Ano" value="${val}" style="width: 45px;">`;
    } 
    else if (type === 'M') {
        // (L√≥gica de M√™s mant√©m-se igual...)
        const MESES = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        group.innerHTML = `
            <select class="codex-input-manual manual-month" style="cursor:pointer;">
                <option value="">M√™s...</option>
                ${MESES.map(m => `<option value="${m}" ${val===m?'selected':''}>${m}</option>`).join('')}
            </select>`;
    } 
    else if (type === 'C') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-chapter" placeholder="Cap." value="${val}" style="width: 45px;">`;
    }
    // --- L√ìGICA DO TEMPO (T) ---
    else if (type === 'T') {
        const t = val ? val.split(':') : ['', '', ''];
        group.classList.add('manual-time-group');
        group.innerHTML = `
            <input type="text" class="codex-input-manual h-input" placeholder="00" maxlength="2" value="${t[0]}" style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual m-input" placeholder="00" maxlength="2" value="${t[1]}" style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual s-input" placeholder="00" maxlength="2" value="${t[2]}" style="width:20px; text-align:center;">
        `;
    }

    // Bot√£o Fechar
    group.innerHTML += `<button class="btn-close-manual" onclick="window.removeManualField(this, '${type}')">√ó</button>`;
    area.appendChild(group);
};

// Fun√ß√µes de suporte
window.switchRefCreatorTab = function(type) {
    const btns = document.querySelectorAll('#ref-creator-tabs button');
    btns.forEach(b => {
        if (b.dataset.type === type) b.classList.add('active');
        else b.classList.remove('active');
    });

    document.getElementById('ref-creator-codex-area').style.display = (type === 'codex') ? 'block' : 'none';
    document.getElementById('ref-creator-link-area').style.display = (type === 'link') ? 'block' : 'none';
};

window.addRefUrlRow = function(val = "") {
    const container = document.getElementById('ref-link-urls-container');
    const div = document.createElement('div');
    div.style.cssText = "display:flex; gap:5px;";
    div.innerHTML = `
        <input type="text" class="redator-input" value="${val}" placeholder="https://..." style="flex:1; border:1px solid var(--border-color); padding:8px; background:var(--bg-color);">
        <button onclick="this.parentElement.remove()" style="border:1px solid #e74c3c; color:#e74c3c; background:transparent; padding:0 10px; border-radius:4px; cursor:pointer;">√ó</button>
    `;
    container.appendChild(div);
};
// ============================================================
// FUN√á√ÉO EM FALTA: RENDERIZAR LISTA DA 4¬™ COLUNA
// ============================================================

// 1. Fun√ß√£o Auxiliar para saber qual a cole√ß√£o (caso n√£o tenha)
window.getCollectionFromType = function(type) {
    if (type === 'personagem') return 'personagens';
    if (type === 'local') return 'locais';
    if (type === 'data') return 'datas';
    if (type === 'cosmos') return 'cosmos';
    if (type === 'subcosmos') return 'subcosmos';
    if (type === 'textobiblico' || type === 'bible_public') return 'textosbiblicos';
    if (type === 'topico') return 'topicos';
    if (type === 'tag') return 'tags';
    if (type === 'marcadores') return 'marcadores';
    return 'pastas'; // Fallback
};

// 2. A Fun√ß√£o Principal que estava a faltar
window.renderPanelLinks = async function() {
    const container = document.getElementById('panel-links-list');
    if (!container) return;

    // 1. Loading
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A carregar documenta√ß√£o...</span>
        </div>`;

    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        container.innerHTML = ''; 
        return;
    }

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const collectionName = window.getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);

        container.innerHTML = ''; 

        if (!docSnap.exists()) {
             container.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Entidade n√£o encontrada.</p>';
             return;
        }

        const links = docSnap.data().panelLinks || [];

        if (links.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; font-size:0.9em; margin-top:20px; font-style: italic;">Nenhuma documenta√ß√£o associada.</p>';
            return;
        }

        // 2. Renderizar Itens
        links.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'board-card'; // Reutiliza estilo dos cart√µes
            
            // Cor da borda baseada no tipo
            div.style.borderLeft = item.type === 'codex' ? '3px solid #d35400' : '3px solid #795548';
            div.style.marginBottom = "8px";
            div.style.padding = "10px";
            div.style.backgroundColor = "var(--panel-color)";
            div.style.borderRadius = "6px";
            
            let contentHTML = "";
            
            // --- RENDERIZAR CODEX ---
            if (item.type === 'codex') {
                // Tenta usar o campo pr√©-formatado 'codiceshow' ou monta na hora
                const displayInfo = item.codiceshow || `${item.serie}${item.capitulo ? ' cap.'+item.capitulo : ''}${item.paginas && item.paginas.length ? ', pg '+item.paginas : ''}`;
                
                contentHTML = `
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:1.2em;">üìö</span>
                        <div>
                            <strong style="color:var(--text-color);">${item.serie}</strong>
                            <div style="font-size:0.85em; color:var(--text-muted-color);">${displayInfo}</div>
                        </div>
                    </div>`;
            } 
            // --- RENDERIZAR LINK WEB ---
            else {
                // Suporta formato novo (urls map) e antigo (single url)
                const urls = item.urls ? Object.values(item.urls) : (item.url ? [item.url] : []);
                
                let linksListHTML = "";
                urls.forEach(u => {
                    linksListHTML += `
                        <a href="${u}" target="_blank" style="display:block; color:var(--accent-color); text-decoration:none; font-size:0.85em; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            üîó ${u}
                        </a>`;
                });

                contentHTML = `
                    <div style="margin-bottom:4px;">
                        <strong style="color:var(--text-color);">${item.title || "Link"}</strong>
                    </div>
                    ${linksListHTML}
                `;
            }

            // HTML Final do Cart√£o
            div.innerHTML = `
                <div style="font-size:0.9em;">${contentHTML}</div>
                
                <!-- BOT√ïES DE EDI√á√ÉO (S√≥ aparecem se o modo de edi√ß√£o estiver ativo) -->
                ${isPanelEditMode ? `
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; border-top:1px solid var(--border-color); padding-top:6px;">
                        <button onclick="window.movePanelLink(${index}, -1)" ${index === 0 ? 'disabled style="opacity:0.3"' : ''} style="background:none; border:none; cursor:pointer;">‚¨ÜÔ∏è</button>
                        <button onclick="window.movePanelLink(${index}, 1)" ${index === links.length - 1 ? 'disabled style="opacity:0.3"' : ''} style="background:none; border:none; cursor:pointer;">‚¨áÔ∏è</button>
                        <div style="width:1px; background:var(--border-color); margin:0 5px;"></div>
                        <button onclick="window.openPanelLinkCreator('${item.type}', ${index})" style="background:none; border:none; color:var(--accent-color); font-weight:bold; cursor:pointer; font-size:0.8em;">EDITAR</button>
                        <button onclick="window.deletePanelLink(${index})" style="background:none; border:none; color:#e74c3c; font-weight:bold; cursor:pointer; font-size:0.8em;">APAGAR</button>
                    </div>
                ` : ''}
            `;
            container.appendChild(div);
        });

    } catch (e) {
        console.error("Erro ao carregar links:", e);
        container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar documenta√ß√£o.</p>';
    }
};

// 3. Fun√ß√£o de Apagar (Se ainda n√£o existir)
window.deletePanelLink = async function(index) {
    if (!confirm("Apagar este item?")) return;

    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const collectionName = window.getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const links = docSnap.data().panelLinks || [];
            links.splice(index, 1); // Remove o item
            
            await updateDoc(docRef, { panelLinks: links });
            window.renderPanelLinks(); // Recarrega a lista
        }
    } catch(e) {
        console.error(e);
        alert("Erro ao apagar.");
    }
};

// 4. FUN√á√ÉO DE GRAVA√á√ÉO (FIREBASE)
async function savePanelLinkToFirebase(newLinkObj, indexToUpdate) {
    const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    const collectionName = getCollectionFromType(activeReferenceEntity.type);
    const docRef = doc(db, collectionName, activeReferenceEntity.id);
    
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) throw new Error("Entidade n√£o encontrada.");

    let links = docSnap.data().panelLinks || [];

    if (indexToUpdate > -1) {
        // Atualizar existente
        links[indexToUpdate] = newLinkObj;
    } else {
        // Criar novo
        links.push(newLinkObj);
    }

    await updateDoc(docRef, { panelLinks: links });
}


async function saveLinkToEntity(linkObj) {
    const { id, type } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    const docRef = doc(db, collectionName, id);
    
    const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    await updateDoc(docRef, {
        panelLinks: arrayUnion(linkObj)
    });
    
    renderPanelLinks();
}

window.deletePanelLink = async function(index) {
    // --- 1. POPUP PERSONALIZADO ---
    const confirmed = await showConfirmation(
        "Remover Link?", 
        "Tem a certeza que deseja remover este item da lista?"
    );

    if (!confirmed) return; // Se cancelar, sai da fun√ß√£o

    try {
        const { doc, getDoc, updateDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const { id, type } = activeReferenceEntity;
        const collectionName = getCollectionFromType(type);
        const docRef = doc(db, collectionName, id);
        
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return;

        const links = docSnap.data().panelLinks || [];
        
        const itemToRemove = links[index];
        
        // Se for do tipo 'codex', apaga tamb√©m da cole√ß√£o 'codex' para n√£o deixar lixo
        if (itemToRemove && itemToRemove.type === 'codex' && itemToRemove.id) {
            await deleteDoc(doc(db, 'codex', itemToRemove.id));
        }

        // Remove do array
        links.splice(index, 1);
        
        // Grava no Firebase
        await updateDoc(docRef, { panelLinks: links });
        
        // Atualiza a vista
        renderPanelLinks();
        
        // Limpeza opcional de vers√≠culos vazios
        if (typeof checkAndCleanVerseState === 'function') {
            await checkAndCleanVerseState(activeReferenceEntity.id);
        }

    } catch (e) {
        console.error("Erro ao apagar link:", e);
        // Fallback apenas se der erro t√©cnico
        alert("Erro de conex√£o ao apagar.");
    }
};


// 3. Fun√ß√£o para Adicionar Item da Lista "Refer√™ncias" para "Escolhidas"
window.addItemToPuzzle = function(noteId, noteName, snippetHTML) {

    // 1. Verificar se a fun√ß√£o createBoardItem existe
    if (typeof createBoardItem === 'function') {
        
        // 2. Mudar automaticamente para a aba "Puzzle" para o utilizador ver o item a chegar
        const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
        if (puzzleTabBtn) puzzleTabBtn.click();

        // 3. Chamar a fun√ß√£o do Quadro para criar o cart√£o
        createBoardItem('ref', {
            noteId: noteId,
            noteName: noteName,
            snippet: snippetHTML,
            isClone: false // √â uma refer√™ncia de texto, n√£o uma caixa completa
        }, true); // O 'true' faz scroll autom√°tico at√© ao novo cart√£o

        // 4. Se o modo de edi√ß√£o estiver ativo, grava logo na BD
        if (document.getElementById('ref-content-puzzle').classList.contains('edit-mode-active')) {
            savePuzzleData();
        }
        
    } else {
        console.error("‚ùå Erro: Fun√ß√£o createBoardItem n√£o encontrada.");
    }
};

// ====================================================================
// L√ìGICA DE TELEPORTE (CONVERTER QUADRO EM NOTA) üì°
// ====================================================================

// 1. Vari√°veis de Estado para o Teleporte
let teleportContentHTML = ""; // Guarda o conte√∫do compilado
let teleportNoteTitle = "";   // Guarda o t√≠tulo limpo

// 2. Listener do Bot√£o üì°
document.getElementById('teleport-puzzle-btn').addEventListener('click', async (e) => {
    e.preventDefault(); e.stopPropagation();

    // --- A. CONFIRMA√á√ÉO COM POPUP PERSONALIZADO ---
    // Usamos a fun√ß√£o 'showConfirmation' que j√° existe no seu c√≥digo
    const confirmed = await showConfirmation(
        "Converter em Nota", 
        "Deseja mesmo gerar uma nota atrav√©s desta refer√™ncia?"
    );

    if (!confirmed) return; // Se clicar em Cancelar, p√°ra aqui.

    // --- B. Preparar T√≠tulo ---
    const panelTitle = document.getElementById('references-panel-title').textContent.trim();
    // Regex para limpar o lixo √† volta
    teleportNoteTitle = panelTitle.replace(/^Refer√™ncias para [üîñ]*["‚Äú](.+)["‚Äù]$/i, '$1');

    // --- C. Compilar Conte√∫do do Quadro ---
    teleportContentHTML = "";
    const cards = document.querySelectorAll('#puzzle-board-container .board-card');

    if (cards.length === 0) {
        alert("O quadro est√° vazio. Adicione algo antes de converter.");
        return;
    }

    cards.forEach(card => {
        // TIPO 1: Texto Edit√°vel
        if (card.classList.contains('type-text')) {
            const textDiv = card.querySelector('.board-text-content');
            if (textDiv) {
                teleportContentHTML += `<p>${textDiv.innerHTML}</p>`; 
            }
        } 
        // TIPO 2: Refer√™ncia
        else if (card.classList.contains('type-ref')) {
            let snippet = decodeURIComponent(card.dataset.snippet || "");
            snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

            if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
                teleportContentHTML += snippet;
            } else {
                teleportContentHTML += `
                    <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                        ${snippet}
                        <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
                    </blockquote>
                `;
            }
        }
        teleportContentHTML += "<p><br></p>";
    });

    // --- D. Abrir o Seletor de Pastas ---
    openTeleportFolderSelector();
});

// 3. Abrir Modal de Sele√ß√£o de Pasta (Reutiliza o estilo do Append/Move)
function openTeleportFolderSelector() {
    const modal = document.getElementById('move-to-folder-modal'); 
    const list = document.getElementById('folder-selection-list');
    const confirmBtn = document.getElementById('confirm-folder-move');
    const titleEl = modal.querySelector('h3');
    const descEl = modal.querySelector('p');

    // 1. RESET DE VARI√ÅVEIS CR√çTICO
    selectedDestFolderId = null; // Garante que n√£o usa uma sele√ß√£o antiga
    moveStack = []; 

    // Configurar UI
    titleEl.textContent = "Guardar Nota em...";
    descEl.innerHTML = `A criar nota: <strong>${teleportNoteTitle}</strong>`;
    
    // Configura√ß√£o da Barra de Navega√ß√£o (Breadcrumbs)
    let navContainer = document.getElementById('move-folder-nav-container');
    if (!navContainer) {
        const oldPath = document.getElementById('move-modal-current-path');
        if(oldPath) oldPath.style.display = 'none';
        
        navContainer = document.createElement('div');
        navContainer.id = 'move-folder-nav-container';
        navContainer.style.display = 'flex';
        navContainer.style.gap = '10px';
        navContainer.style.marginBottom = '15px';
        navContainer.style.alignItems = 'center';
        navContainer.innerHTML = `
            <button id="move-folder-back-btn" class="modal-btn secondary" style="padding: 5px 10px; display: none;">‚¨Ö Voltar</button>
            <span id="move-folder-path" style="font-weight: bold; color: var(--text-color);">Raiz Global</span>
        `;
        list.parentNode.insertBefore(navContainer, list);
        
        document.getElementById('move-folder-back-btn').addEventListener('click', () => {
            const globalRootId = null; 
            if (moveStack.length > 0) {
                moveStack.pop();
                const parent = moveStack.length > 0 ? moveStack[moveStack.length - 1].id : globalRootId;
                loadMoveFolderList(parent);
            } else {
                loadMoveFolderList(globalRootId);
            }
        });
    }

    modal.style.display = 'flex';
    
    // Inicia na Raiz Global (null)
    loadMoveFolderList(null);

    // --- SUBSTITUIR A√á√ÉO DO BOT√ÉO CONFIRMAR ---
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = "Gerar Nota";
    
    newConfirmBtn.onclick = async () => {
        // L√≥gica de Destino: Se n√£o selecionou (azul), assume a pasta onde est√° a navegar
        let targetFolderId = selectedDestFolderId;
        if (targetFolderId === null && moveStack.length > 0) {
            targetFolderId = moveStack[moveStack.length - 1].id;
        }
        
        // Se targetFolderId continuar null, √© a Raiz Global.

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A processar...";

        try {
            // =================================================================
            // PASSO C: GERAR CONTE√öDO E ANEXOS
            // =================================================================
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = teleportContentHTML;
            const anexosMap = {}; 
            
            // 1. Processar Links de Texto (Criados via bot√£o Globo üåê)
            const textLinks = tempDiv.querySelectorAll('a.board-link');
            textLinks.forEach((link, index) => {
                const anexoId = `anexo_txt_${Date.now()}_${index}`;
                let urls = {};
                try {
                    const rawUrls = JSON.parse(decodeURIComponent(link.dataset.json));
                    rawUrls.forEach((u, i) => urls[`url_${i}`] = u);
                } catch(e) { if (link.href) urls['url_0'] = link.href; }

                if (Object.keys(urls).length > 0) {
                    anexosMap[anexoId] = { titulo: link.textContent, urls: urls, timestamp: Date.now() };
                    // Transformar em link de nota
                    link.classList.remove('board-link');
                    link.removeAttribute('data-json');
                    link.setAttribute('data-anexo-id', anexoId);
                    link.style.borderBottom = '1px dotted var(--accent-color)';
                    link.style.color = 'inherit';
                    link.style.textDecoration = 'none';
                }
            });

            // 2. Processar Refer√™ncias do Quadro (Cart√µes Verdes) - PARA CRIAR ANEXO
            // Se o cart√£o for uma refer√™ncia a outra nota, criamos um "Anexo" para ela tamb√©m
          const refCards = document.querySelectorAll('#puzzle-board-container .board-card.type-ref');
refCards.forEach((card, index) => {
    let snippet = decodeURIComponent(card.dataset.snippet || "");
    
    // Limpeza b√°sica
    snippet = snippet.replace(/<mark>/g, "").replace(/<\/mark>/g, "");

    // VERIFICA√á√ÉO DE CAIXAS ESPECIAIS (CLONAGEM PERFEITA)
    if (snippet.includes('mini-note-wrapper') || snippet.includes('toggle-section')) {
        
        // Se for uma caixa, injetamos o HTML direto (Clone Perfeito)
        // Dica: Podemos gerar um novo ID para evitar duplicados no sistema
        snippet = snippet.replace(/id="[^"]*"/, `id="clone_${Date.now()}_${index}"`);
        
        teleportContentHTML += snippet;
    } 
    // TRATAMENTO ESPECIAL PARA POST-ITS (Para n√£o ficarem sobrepostos)
    else if (snippet.includes('post-it-note')) {
        // 1. For√ßa posi√ß√£o relativa (para entrar no fluxo do texto)
        // 2. Remove coordenadas top/left antigas
        // 3. Mant√©m a cor e o visual
        let safePostIt = snippet.replace(/position:\s*absolute/g, 'position: relative; margin: 15px 0');
        safePostIt = safePostIt.replace(/top:\s*[^;]+;/g, '').replace(/left:\s*[^;]+;/g, '');
        
        // Remove o puxador de arrasto (j√° que na nova nota ser√° texto fixo)
        // (Opcional, mas fica mais limpo)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = safePostIt;
        const dragHandle = tempDiv.querySelector('.post-it-drag-handle');
        if(dragHandle) dragHandle.remove();
        
        teleportContentHTML += tempDiv.innerHTML;
    }
    // TEXTO SIMPLES (Cita√ß√£o padr√£o)
    else {
        teleportContentHTML += `
            <blockquote style="border-left: 3px solid var(--accent-color); padding-left: 10px; margin: 10px 0; color: var(--text-muted-color);">
                ${snippet}
                <br><small>‚Äî De: üìÑ ${card.dataset.noteName}</small>
            </blockquote>
        `;
    }
    
    // Adiciona o anexo l√≥gico (para o clip)
    const noteId = card.dataset.noteId;
    const noteName = card.dataset.noteName;
    if (noteId) {
        const anexoId = `anexo_ref_${Date.now()}_${index}`;
        anexosMap[anexoId] = {
            titulo: `Ref: ${noteName}`,
            urls: { 'url_0': `internal://note/${noteId}` }, 
            timestamp: Date.now()
        };
    }
});

            const finalContentHTML = tempDiv.innerHTML;

            // =================================================================
            // PASSO D: CRIAR NOTA NO FIREBASE
            // =================================================================
            
            // Calcular Ordem Segura (Para evitar NaN)
            let newOrder = 0;
            try {
                const qOrder = query(
                    collection(db, 'pastas'), 
                    where('parentId', '==', targetFolderId), 
                    where('userId', '==', auth.currentUser.uid)
                );
                const snapOrder = await getDocs(qOrder);
                newOrder = snapOrder.size || 0;
            } catch(e) { console.log("Erro ordem, usando 0"); }

            // Criar Documento
            const docRef = await addDoc(collection(db, 'pastas'), {
                nome: teleportNoteTitle,
                parentId: targetFolderId, 
                tipo: 'nota',
                conteudo: finalContentHTML,
                anexos: anexosMap, // Agora inclui links de texto E refer√™ncias
                userId: auth.currentUser.uid,
                estado: 'ativa',
                ordem: Number(newOrder), // For√ßa n√∫mero
                tags: [], 
                createdAt: serverTimestamp(),
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            
            // =================================================================
            // PASSO E: FOR√áAR ATUALIZA√á√ÉO VISUAL (CORRE√á√ÉO DA LISTA)
            // =================================================================
            
            // Se a pasta onde guard√°mos √© a mesma que est√° aberta no painel do meio...
            const currentMiddleFolderId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
            
            if (targetFolderId === currentMiddleFolderId) {
                // ...Recarregamos a lista explicitamente para garantir que aparece
                fetchAndDisplayItems(targetFolderId, middlePanelList, null);
            }

            // Popup de Sucesso
            const shouldOpen = await showConfirmation(
                "Sucesso!", 
                "Nota criada com sucesso.\nDeseja abrir a nota agora?"
            );
            
            if(shouldOpen) {
                displayNote(docRef.id, null);
            }

        } catch (error) {
            console.error("Erro ao criar nota:", error);
            alert("Erro ao gravar. Verifique a consola para detalhes de √≠ndices.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gerar Nota";
        }
    };
}

// ============================================================
// FUN√á√ÉO PARA EXIBIR DETALHES DO T√ìPICO (4¬™ COLUNA)
// ============================================================
async function showTopicReferencesPanel(id, name, description, type) {

    
    // 1. Gravar o puzzle/quadro anterior antes de mudar o contexto
    // Isto evita que percas altera√ß√µes se estivesses a editar outro t√≥pico
    await forceSaveAndClosePuzzleMode();
  resetReferencesPanelUI();
    // 2. DEFINIR ENTIDADE ATIVA (CR√çTICO para o +Ref funcionar)
    // Se o 'type' vier vazio, assume 'topico' por padr√£o
    activeReferenceEntity = { 
        id: id, 
        type: type || 'topico', 
        name: name 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'block';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel lateral
    notebookContainer.classList.add('references-panel-visible');
    
    // Define o T√≠tulo do painel (ex: T√≥pico: Santifica√ß√£o)
referencesPanelTitle.textContent = `Cita√ß√µes: ${name}`;
    document.getElementById('references-panel-description').textContent = description || 'Sem descri√ß√£o definida.';

    // 4. Sincronizar Abas: Abre sempre na aba "Puzzle" (Quadro)
    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTabBtn) puzzleTabBtn.classList.add('active');

    document.getElementById('ref-content-puzzle').style.display = 'flex';
    document.getElementById('ref-content-references').style.display = 'none';

    // 5. Carregar os dados do Quadro (Puzzle) salvos para este t√≥pico
    loadPuzzleData(id, type || 'topico');
    
    // 6. Pesquisar e listar as notas que usam este t√≥pico (para a aba Refer√™ncias)
    // Esta fun√ß√£o analisa o campo 'topicosSelecionados' de todas as notas
    renderTopicResultsList(id, type || 'topico'); 
}

// Fun√ß√£o Auxiliar para preencher a lista de refer√™ncias (Aba 2)
async function renderTopicResultsList(id, type) {
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar contextos...</span></div>';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        
        // Reset da lista global de resultados
        allCitationsResults = []; 

        snapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            if (!data.topicosSelecionados) return;

            let match = false;
            // Se for T√≥pico Pai
            if (type === 'topico') {
                if (data.topicosSelecionados.hasOwnProperty(id)) match = true;
            } 
            // Se for Subt√≥pico
            else {
                const allSubtopics = Object.values(data.topicosSelecionados).flat();
                if (allSubtopics.map(String).includes(String(id))) match = true;
            }

            if (match) {
                // Filtro de privacidade
                let isProtected = (data.passe && data.passe.trim() !== "");
                if (isProtected && !appSettings.searchTopicsInProtected) return;

                allCitationsResults.push({ 
                    id: docSnapshot.id, 
                    name: data.nome,
                    isProtected: isProtected,
                    snippet: "T√≥pico atribu√≠do a esta nota.",
                    ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
                });
            }
        });

        // ORDENAR: Mais recente primeiro
        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);

        // Renderiza a lista paginada
        window.renderCitationsPage(false);

    } catch (e) {
        console.error("Erro ao listar refer√™ncias do t√≥pico:", e);
        listElement.innerHTML = '<li>Erro ao carregar lista.</li>';
    }
}

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function openLinkModal(isEditing, data) {
    // 1. CAPTURA ROBUSTA DA SELE√á√ÉO (CR√çTICO)
    // Tentamos garantir que temos o texto selecionado guardado antes de qualquer outra coisa.
    // Isto resolve o problema de perder a sele√ß√£o quando se clica nos inputs do modal.
    let savedRange = null;

    if (!isEditing) {
        if (currentSelectionRange) {
            // Tenta usar a vari√°vel global gerida pelo handleTextSelection
            savedRange = currentSelectionRange.cloneRange();
        } else {
            // Fallback: Tenta obter diretamente do navegador
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && !sel.isCollapsed) {
                savedRange = sel.getRangeAt(0).cloneRange();
            }
        }
    }

    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const addUrlBtn = document.getElementById('add-url-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const saveBtn = document.getElementById('link-save-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // Reset UI
    urlsContainer.innerHTML = '';
    
    // Clonar bot√µes para limpar listeners antigos (Evita cliques duplicados)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);

    newAddUrlBtn.onclick = () => addUrlField();

    // --- MODO EDI√á√ÉO ---
    if (isEditing) {
        modalTitle.textContent = "Editar/Remover Anexo";
        newRemoveBtn.style.display = 'block';

        // Preenche os dados atuais
        (async () => {
            try {
                const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
                if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[data.id]) {
                    const anexoFromDb = noteSnap.data().anexos[data.id];
                    titleInput.value = anexoFromDb.titulo;
                    
                    if (anexoFromDb.urls && Object.keys(anexoFromDb.urls).length > 0) {
                        Object.values(anexoFromDb.urls).forEach(url => addUrlField(url));
                    } else if (anexoFromDb.hiperligacao) {
                         // Suporte legado
                         addUrlField(anexoFromDb.hiperligacao);
                    } else { 
                        addUrlField(); 
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar dados do anexo:", e);
            }
        })();

        // Gravar Edi√ß√£o
        newSaveBtn.onclick = async () => {
            const newTitle = titleInput.value.trim();
            if (!newTitle) return alert("O t√≠tulo √© obrigat√≥rio.");

            const urlInputs = urlsContainer.querySelectorAll('input');
            const urlsToSave = {};
            let firstUrl = null;

            urlInputs.forEach((input, index) => {
                let url = input.value.trim();
                if (url) {
                    if (!url.startsWith('http')) url = 'https://' + url;
                    if (!firstUrl) firstUrl = url;
                    urlsToSave[`url_${Date.now() + index}`] = url;
                }
            });

            if (Object.keys(urlsToSave).length === 0) return alert('Preencha pelo menos uma URL.');

            try {
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, {
                    [`anexos.${data.id}.titulo`]: newTitle,
                    [`anexos.${data.id}.urls`]: urlsToSave,
                    [`anexos.${data.id}.hiperligacao`]: deleteField(), // Limpa campo antigo se existir
                    [`anexos.${data.id}.timestamp`]: serverTimestamp()
                });

                // Atualiza o href no editor visualmente
                const linkInEditor = noteContentEditor.querySelector(`a[data-anexo-id="${data.id}"]`);
                if (linkInEditor) linkInEditor.href = firstUrl;

                modal.style.display = 'none';
                saveNote();
            } catch (e) {
                console.error("Erro ao editar anexo:", e);
                alert("Erro ao gravar altera√ß√µes.");
            }
        };

        // Remover Anexo
    newRemoveBtn.onclick = async () => {
        
        // 1. Truque de UI: For√ßar o modal de confirma√ß√£o a ficar acima do modal de links
        const confirmModal = document.getElementById('confirm-modal');
        confirmModal.style.zIndex = '3200'; // Valor alto para garantir topo absoluto

        // 2. Chama o seu popup personalizado
        const confirmed = await showConfirmation(
            "Limpar Links", 
            "Tem a certeza que deseja remover todos os links desta caixa?"
        );

        // 3. Restaura o z-index para n√£o afetar outros usos futuros
        confirmModal.style.zIndex = ''; 

        // 4. Se confirmou, executa a limpeza
        if (confirmed) {
            wrapper.setAttribute('data-box-links', '{}');
            updateBoxLinkButtonState(wrapper);
            modal.style.display = 'none';
            saveNote(true);
        }
    };
    } 


    // --- MODO CRIA√á√ÉO (COM A CORRE√á√ÉO DO "GRAVAR") ---
    else {
        modalTitle.textContent = "Criar Anexo";
        titleInput.value = (typeof data === 'string') ? data : ''; 
        newRemoveBtn.style.display = 'none';
        addUrlField();

        // L√≥gica do Bot√£o Gravar (Nova Vers√£o Robusta)
        newSaveBtn.onclick = async () => {
            try {
                // 1. Valida√ß√£o de Dados
                const titleForDb = titleInput.value.trim();
                if (!titleForDb) { alert('T√≠tulo obrigat√≥rio.'); return; }
                
                const urlInputs = urlsContainer.querySelectorAll('input');
                const urlsToSave = {};
                let firstUrl = null;
                
                urlInputs.forEach((input, index) => {
                    let url = input.value.trim();
                    if (url) {
                        if (!url.startsWith('http')) url = 'https://' + url;
                        if (!firstUrl) firstUrl = url;
                        urlsToSave[`url_${Date.now() + index}`] = url;
                    }
                });
                
                if (Object.keys(urlsToSave).length === 0) { alert('Preencha pelo menos uma URL.'); return; }

                // 2. Verifica√ß√µes de Seguran√ßa Cr√≠ticas
                if (!selectedNoteId) throw new Error("ID da nota n√£o encontrado.");
                if (!savedRange) throw new Error("A sele√ß√£o de texto foi perdida. Cancele e tente novamente.");

                // 3. Gravar na Base de Dados (Firebase)
                const anexoId = `anexo_${Date.now()}`;
                const noteRef = doc(db, 'pastas', selectedNoteId);
                
                await updateDoc(noteRef, { 
                    [`anexos.${anexoId}`]: { 
                        titulo: titleForDb, 
                        urls: urlsToSave, 
                        timestamp: serverTimestamp() 
                    } 
                }, { merge: true });

                // 4. Prepara√ß√£o Visual (Preservar Entidades)
                const tempDiv = document.createElement('div');
                tempDiv.appendChild(savedRange.cloneContents()); 

                const anchorsInSelection = Array.from(tempDiv.querySelectorAll('.entity-link'));
                const preservedAnchors = anchorsInSelection.map(span => ({
                    name: span.dataset.entityName,
                    type: span.dataset.entityType
                }));
                
                // 5. Aplicar o Link no Editor
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange); // Restaura a sele√ß√£o guardada
                
                document.execCommand('createLink', false, firstUrl || '#');
                
                // Encontrar o link rec√©m-criado (onde est√° o cursor)
                const createdLink = selection.anchorNode.parentElement.closest('a');

                if (createdLink) {
                    createdLink.dataset.anexoId = anexoId;
                    
                    // Se havia entidades coloridas, restaura-as dentro do link
                    if (preservedAnchors.length > 0) {
                        let reconstructedHTML = createdLink.textContent;
                        
                        preservedAnchors.forEach(anchor => {
                            const anchorHTML = `<span class="entity-link" data-entity-type="${anchor.type}" data-entity-name="${anchor.name}">${anchor.name}</span>`;
                            const replaceRegex = new RegExp(escapeRegExp(anchor.name), 'g');
                            reconstructedHTML = reconstructedHTML.replace(replaceRegex, anchorHTML);
                        });

                        createdLink.innerHTML = reconstructedHTML;
                    }
                }
                
                // 6. Fechar e Gravar Nota
                modal.style.display = 'none';
                saveNote();

            } catch (error) {
                console.error("Erro ao criar link:", error);
                alert("Ocorreu um erro: " + error.message);
            }
        };
    }
    
    modal.style.display = 'flex';
}
// ====================================================================


async function openEntityModal(type, name) {
    // 1. Prepara√ß√£o dos Elementos do Modal
    const modal = document.getElementById('entity-modal');
    const title = document.getElementById('entity-modal-title');
    const nameInput = document.getElementById('entity-name-input');
    const descriptionInput = document.getElementById('entity-description-input');
    const errorMsg = document.getElementById('entity-error-message');
    
    // Configura o t√≠tulo do popup
    const singularNames = {
        personagem: "Personagem",
        local: "Local",
        data: "Data",
        cosmos: "Tema",
        subcosmos: "Subtema"
    };
    title.textContent = `Criar ${singularNames[type] || type}`;
    
    // Limpa e Preenche campos
    nameInput.value = name;
    descriptionInput.value = '';
    errorMsg.style.display = 'none';
    
    // Move o modal para o topo para garantir que √© vis√≠vel
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "10000000"; 
    
    setTimeout(() => nameInput.focus(), 50);

    const saveBtn = document.getElementById('entity-save-btn');
    // Clona o bot√£o para limpar eventos antigos
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    // --- A√á√ÉO DE GRAVAR ---
    newSaveBtn.onclick = async () => {
        const entityName = nameInput.value.trim();
        const entityDescription = descriptionInput.value.trim();
        
        if (!entityName) {
            alert("O nome √© obrigat√≥rio.");
            return;
        }
        
        // Desativa bot√£o para evitar duplo clique
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A criar...";

        const collectionName = ENTITY_CONFIG[type]?.collection;
        if (!collectionName) {
            newSaveBtn.disabled = false;
            return;
        }

        try {
            // Importa√ß√µes necess√°rias
            const { collection, query, where, getDocs, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const collectionRef = collection(db, collectionName);
            const q = query(collectionRef, where("nome", "==", entityName), where("userId", "==", auth.currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                // CRIAR NOVO REGISTO NA BASE DE DADOS
                await addDoc(collectionRef, {
                    nome: entityName,
                    descricao: entityDescription,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp(),
                    referencias: {} // Cria vazio, sem ligar √† nota atual
                });
                
                console.log(`‚úÖ ${type} criado: ${entityName}`);
            } else {
                alert("Este item j√° existe na base de dados.");
            }

            // --- CORRE√á√ÉO: REMOVIDA A PARTE QUE INSERIA TEXTO NO EDITOR ---
            // O c√≥digo que escrevia na nota foi apagado aqui.
            // Agora ele apenas cria na base de dados.

            // Fechar Modal
            modal.style.display = 'none';
            
            // Atualizar a lista lateral se estivermos na aba "Lists"
            if (currentTab === 'lists') {
                // Verifica se a fun√ß√£o existe antes de chamar
                if (typeof renderListCategoryItems === 'function') {
                    // Se estivermos dentro da categoria certa, atualiza a lista
                    const lastNav = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1] : null;
                    if (lastNav && lastNav.id === type) {
                        renderListCategoryItems(type);
                    }
                }
            }
            
            // Atualizar cache global de entidades
            if (typeof fetchAllEntities === 'function') {
                fetchAllEntities(); 
            }

        } catch (e) {
            console.error("Erro ao guardar entidade:", e);
            alert("Erro ao guardar.");
        } finally {
            // Restaura o bot√£o
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
        }
    };
}

  async function openGenericListModal(title, dataPromise) {
    const modal = document.getElementById('generic-list-modal');
    const titleEl = document.getElementById('generic-list-title');
    const contentEl = document.getElementById('generic-list-content');
    
    titleEl.textContent = title;
    contentEl.innerHTML = '<li>Carregando...</li>';
    modal.style.display = 'flex';

    try {
        const items = await dataPromise;
        contentEl.innerHTML = ''; 
        if (!items || items.length === 0) {
            contentEl.innerHTML = '<li>Nenhum item encontrado.</li>';
            return;
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.style.alignItems = 'flex-start';
            
            // <<<<<<< ALTERA√á√ÉO IMPORTANTE >>>>>>>>>
            // Adiciona um data-attribute se o t√≠tulo for uma tag
            if (item.title.startsWith('#')) {
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = item.title.replace('#', '');
                li.style.cursor = 'pointer'; // Muda o cursor para indicar que √© clic√°vel
            }
            
            let contentHTML = '';

            if (Array.isArray(item.content) && item.content.length > 0) {
                const linksHTML = item.content.map((url, index) => {
                    if (!url) return '';
                    return `<div style="display: flex; align-items: baseline; margin-top: 5px; gap: 8px;"><span style="color: var(--text-color); font-weight: bold;">${index + 1}.</span><a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; word-break: break-all;">${url}</a></div>`;
                }).join('');
                contentHTML = `<div style="margin-top: 4px;">${linksHTML}</div>`;
            } 
            else if (typeof item.content === 'string' && item.content) {
                contentHTML = `<small style="color: var(--text-muted-color); margin-top: 4px;">${item.content}</small>`;
            }

            let editButtonHTML = '';
            if (item.type === 'anexo' && item.id) {
                editButtonHTML = `<button data-action="edit-anexo" data-id="${item.id}" title="Editar Anexo" style="background: none; border: none; color: var(--text-muted-color); font-size: 20px; cursor: pointer; margin-left: auto; padding: 5px;">‚úèÔ∏è</button>`;
            }

            li.innerHTML = `<div style="display: flex; flex-direction: column; flex-grow: 1;"><strong style="font-size: 1.1em;">${item.title}</strong>${contentHTML}</div>${editButtonHTML}`;
            contentEl.appendChild(li);
        });

    } catch (error) {
        console.error("Erro ao carregar dados para o modal:", error);
        contentEl.innerHTML = '<li>Ocorreu um erro ao carregar os itens.</li>';
    }
}

 window.openAttachmentsModal = function() {
    if (!selectedNoteId) return;

    const fetchData = async () => {
        const editor = document.getElementById('note-content-editor');
        if (!editor) return [];

        // 1. Encontrar todos os links no texto
        const activeLinks = Array.from(editor.querySelectorAll('a[data-anexo-id]'));
        const validAnexos = [];

        // 2. Tentar construir a lista DIRETAMENTE do HTML (Mais r√°pido e seguro)
        activeLinks.forEach(link => {
            const anexoId = link.dataset.anexoId;
            const title = link.textContent.trim() || "Link Sem T√≠tulo";
            let content = [];

            // Tenta ler os URLs do atributo data-json
            try {
                if (link.dataset.json) {
                    const parsed = JSON.parse(decodeURIComponent(link.dataset.json));
                    if (Array.isArray(parsed)) content = parsed;
                    else if (parsed.urls) content = Object.values(parsed.urls);
                }
            } catch (e) {
                // Fallback: Usa o href do link
                if (link.href) content = [link.href];
            }

            // Se encontrou URLs v√°lidos, adiciona √† lista
            if (content.length > 0) {
                validAnexos.push({
                    id: anexoId,
                    title: title,
                    content: content,
                    type: 'anexo'
                });
            }
        });

        // 3. Se a lista HTML estiver vazia (fallback antigo), tenta ir ao Firebase
        if (validAnexos.length === 0) {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const noteRef = doc(db, 'pastas', selectedNoteId);
            const noteSnap = await getDoc(noteRef);
            
            if (noteSnap.exists() && noteSnap.data().anexos) {
                 const allAnexos = noteSnap.data().anexos;
                 // (L√≥gica antiga de filtragem, se necess√°rio)
            }
        }

        console.log("‚úÖ Anexos recuperados do HTML:", validAnexos.length);
        return validAnexos;
    };

    openGenericListModal("Anexos Ativos na Nota", fetchData());
};

 




// --- FUN√á√ÉO UNIFICADA: EXPLORADOR (TAGS + ENTIDADES) ---
async function openExplorerModal() {
    const modal = document.getElementById('anchors-modal');
    const filterBtn = document.getElementById('toggle-search-filters-btn');
    const container = document.getElementById('anchors-content-container');
    
    if (!modal || !container) return;

    modal.style.display = 'flex';
    
    // Reset do visual do bot√£o e abertura da aba padr√£o (Pesquisa)
    filterBtn.textContent = "‚öôÔ∏è Filtros";
    renderSearchTab(); 

    // Alternar entre Pesquisa e Filtros
    filterBtn.onclick = (e) => {
        e.preventDefault();
        // Verificamos se o que est√° l√° dentro √© a pesquisa ou filtros
        const isShowingSearch = !!document.getElementById('global-search-input');
        
        if (isShowingSearch) {
            renderFiltersTab();
            filterBtn.textContent = "üîç Pesquisa";
        } else {
            renderSearchTab();
            filterBtn.textContent = "‚öôÔ∏è Filtros";
        }
    };
}

// Renderiza a aba de Pesquisa
function renderSearchTab() {
    const container = document.getElementById('anchors-content-container');
    const scopeContainer = document.getElementById('search-scope-container');
    const scopeToggle = document.getElementById('search-scope-toggle');
    const scopeText = document.getElementById('scope-text');

    container.innerHTML = `
        <div class="search-container">
            <input type="text" id="global-search-input" class="global-search-input" 
                   placeholder='Ex: eva "ad√£o"'>
            <div id="global-search-results">
                <p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">
                    Pesquise por termos soltos ou use "aspas" para palavras exatas.
                </p>
            </div>
        </div>
    `;

    const searchInput = document.getElementById('global-search-input');
    const resultsContainer = document.getElementById('global-search-results');
 const scopeBtn = document.getElementById('search-scope-btn');

   scopeBtn.onclick = (e) => {
        e.preventDefault();
        if (globalSearchScope === 'paragraph') {
            globalSearchScope = 'page';
            scopeBtn.classList.add('active');
            scopeBtn.querySelector('span').textContent = 'Na P√°gina';
        } else {
            globalSearchScope = 'paragraph';
            scopeBtn.classList.remove('active');
            scopeBtn.querySelector('span').textContent = 'No Par√°grafo';
        }
        // Refaz a pesquisa com o novo escopo
        if (searchInput.value.trim().length >= 2) executeGlobalSearch(searchInput.value.trim(), resultsContainer);
    };

      let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const terms = parseSearchQuery(val);
        
        // MOSTRAR/ESCONDER: S√≥ aparece se houver 2 ou mais termos
        scopeBtn.style.display = (terms.length >= 2) ? 'flex' : 'none';

        clearTimeout(searchTimeout);
        if (val.length < 2) {
            resultsContainer.innerHTML = '<p style="text-align:center; color:var(--text-muted-color); margin-top:20px;">Escreva para pesquisar...</p>';
            return;
        }
        searchTimeout = setTimeout(() => { executeGlobalSearch(val, resultsContainer); }, 600);
    });

    setTimeout(() => searchInput.focus(), 200);
}


    // Renderiza a aba de Filtros com Toggles
function renderFiltersTab() {
    const container = document.getElementById('anchors-content-container');
    if (!container) return;
    
    const f = window.searchFilters;

    container.innerHTML = `
        <div class="filters-container" style="padding: 10px;">
            <div class="setting-toggle-container" style="background: rgba(74, 144, 226, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--accent-color);">
                <label class="setting-switch">
                    <input type="checkbox" id="f-all" ${f.all ? 'checked' : ''} onchange="window.toggleAllFilters(this.checked)">
                    <span class="slider round"></span>
                </label>
                <span class="setting-label"><strong>Pesquisar em Tudo</strong></span>
            </div>

            <h4 style="color: var(--accent-color); margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">1. Localiza√ß√£o</h4>
            ${createFilterToggle('f-notes', 'Notas', 'notes')}
            ${createFilterToggle('f-superfolders', 'SuperPastas', 'superfolders')}
            ${createFilterToggle('f-archives', 'Arquivo', 'archives')}

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">2. Contexto Visual</h4>
            ${createFilterToggle('f-subnote', 'SubNotas', 'subnote')}
            ${createFilterToggle('f-question', 'Quest√µes', 'question')}
            ${createFilterToggle('f-free', 'Contentores', 'free')}
            ${createFilterToggle('f-postit', 'Post-its', 'postit')}

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">3. Metadados e Entidades</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                ${createFilterToggle('f-topics', 'T√≥picos', 'topics')}
                ${createFilterToggle('f-subtopics', 'SubT√≥picos', 'subtopics')}
                ${createFilterToggle('f-highlights', 'Destaques', 'highlights')}
                ${createFilterToggle('f-bookmarks', 'Marcadores', 'bookmarks')}
                ${createFilterToggle('f-personagem', 'Personagens', 'personagem')}
                ${createFilterToggle('f-local', 'Locais', 'local')}
                ${createFilterToggle('f-data', 'Datas', 'data')}
                ${createFilterToggle('f-cosmos', 'Temas (Cosmos)', 'cosmos')}
                ${createFilterToggle('f-subcosmos', 'SubTemas', 'subcosmos')}
                ${createFilterToggle('f-tags', 'Tags', 'tags')}
            </div>

            <h4 style="color: var(--accent-color); margin: 20px 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">4. Conte√∫do Extra</h4>
            ${createFilterToggle('f-fourthColumn', 'Texto 4¬™ Coluna (Puzzle)', 'fourthColumn')}
        </div>
    `;
}

function createFilterToggle(id, label, property) {
    // Busca o estado atual com fallback para evitar erros
    const isChecked = (window.searchFilters && window.searchFilters[property]) ? 'checked' : '';
    
    return `
        <div class="setting-toggle-container" style="margin-bottom: 10px;">
            <label class="setting-switch">
                <input type="checkbox" id="${id}" ${isChecked} 
                       onchange="window.updateSearchFilter('${property}', this.checked)">
                <span class="slider round"></span>
            </label>
            <span class="setting-label" style="font-size: 0.9em;">${label}</span>
        </div>
    `;
}

// --- FUN√á√ÉO DE PESQUISA REAL ---
// --- CONFIGURA√á√ÉO ALGOLIA (ADICIONE ISTO NO IN√çCIO DO SCRIPT, AP√ìS OS IMPORTS) ---
// Estas chaves s√£o p√∫blicas e seguras
const algoliaClient = algoliasearch('3YJNDB26WJ', '3f5dbb5aac3026a94525c61092ddff90');
const algoliaIndex = algoliaClient.initIndex('notas');

// --- NOVA FUN√á√ÉO DE PESQUISA R√ÅPIDA ---
async function executeGlobalSearch(queryText, container) {
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A procurar (Algolia)...</span></div>';
    
    // Se o texto for muito curto, n√£o pesquisa
    if (!queryText || queryText.trim().length < 2) {
        container.innerHTML = '';
        return;
    }

    try {
        // 1. Pedir ao Algolia
        const result = await algoliaIndex.search(queryText, {
            filters: `userId:${auth.currentUser.uid} AND estado:ativa`, 
            hitsPerPage: 20,
            attributesToSnippet: ["conteudo:80", "nome"] 
        });

        // 2. Limpar contentor
        container.innerHTML = '';
        
        // >>> AQUI EST√Å A CORRE√á√ÉO: Usar a vari√°vel global agora declarada <<<
        globalSearchResults = []; 

        if (result.hits.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">Nenhum resultado encontrado.</p>';
            return;
        }

        // 3. Renderizar Resultados
        result.hits.forEach(hit => {
            if (hit.tipo !== 'nota' && hit.tipo !== 'jornal' && hit.tipo !== 'aquario' && hit.tipo !== 'arquivo' && hit.tipo !== 'partilhado') return;

            const divItem = document.createElement('div');
            divItem.className = 'search-result-item';
            
            let borderColor = "var(--accent-color)";
            if (hit.tipo === 'arquivo' || hit.tipo === 'partilhado') borderColor = "#e74c3c";
            if (hit.tipo === 'aquario') borderColor = "#2ecc71";
            
            divItem.style.borderLeft = `4px solid ${borderColor}`;

            let snippet = hit._snippetResult && hit._snippetResult.conteudo ? hit._snippetResult.conteudo.value : "";
            snippet = snippet.replace(/<em>/g, "<mark>").replace(/<\/em>/g, "</mark>");
            
            let titleHtml = hit._highlightResult && hit._highlightResult.nome ? hit._highlightResult.nome.value : hit.nome;
            titleHtml = titleHtml.replace(/<em>/g, "<mark>").replace(/<\/em>/g, "</mark>");

            let icon = "üìÑ";
            if (hit.tipo === 'arquivo' || hit.tipo === 'partilhado') icon = "üóÑÔ∏è";
            if (hit.tipo === 'aquario') icon = "ü™∏";

            divItem.innerHTML = `
                <div class="search-result-title">
                    ${icon} ${titleHtml}
                </div>
                <div class="search-match-context" style="margin-top: 5px; font-size: 0.85em; opacity: 0.8;">
                    ${snippet}
                </div>
            `;

            divItem.onclick = () => {
                document.getElementById('anchors-modal').style.display = 'none';
                if (typeof navigateToNoteSmart === 'function') {
                    navigateToNoteSmart(hit.objectID, queryText);
                } else {
                    displayNote(hit.objectID, null, queryText);
                }
            };

            container.appendChild(divItem);
        });

    } catch (error) {
        console.error("Erro Algolia:", error);
        container.innerHTML = '<p style="color:red; text-align:center;">Erro na pesquisa. Verifique a consola.</p>';
    }
}


(async () => {
    console.log("üöÄ A iniciar re-indexa√ß√£o total para o Algolia...");
    const { collection, getDocs, updateDoc, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // Usa as vari√°veis globais 'db' e 'auth' do seu c√≥digo
    // Se der erro, certifique-se que o site carregou completamente

    if (!auth.currentUser) return console.error("‚ùå ERRO: Aguarde o login terminar!");

    const notesRef = collection(db, 'pastas');
    const snapshot = await getDocs(notesRef);
    
    console.log(`üìÇ A processar ${snapshot.size} documentos...`);

    let count = 0;
    for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        if (['nota', 'jornal', 'arquivo', 'aquario'].includes(data.tipo)) {
            await updateDoc(doc(db, 'pastas', docSnap.id), { algoliaSync: serverTimestamp() });
            count++;
            if (count % 10 === 0) console.log(`‚úÖ Processados: ${count}`);
        }
    }
    console.log("üèÅ PROCESSO CONCLU√çDO! O Algolia vai indexar em breve.");
})();



// --- GERAR CONTEXTO (TEXTO AO REDOR) ---
function generateSearchContext(fullText, term, isExact) {
    const normalizedText = removeAccents(fullText);
    const normalizedTerm = removeAccents(term);
    
    let index = -1;

    if (isExact) {
        // Usa Regex para encontrar a posi√ß√£o da palavra inteira
        const regex = new RegExp(`\\b${escapeRegExp(normalizedTerm)}\\b`, 'i');
        const match = normalizedText.match(regex);
        index = match ? match.index : -1;
    } else {
        index = normalizedText.indexOf(normalizedTerm);
    }

    if (index === -1) return "";

    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + term.length + 40);
    
    let snippet = fullText.substring(start, end);
    
    if (start > 0) snippet = "..." + snippet;
    if (end < fullText.length) snippet = snippet + "...";

    // Passamos o isExact para o highlightMatch tamb√©m
    return highlightMatch(snippet, term, isExact);
}


// --- RENDERIZAR RESULTADOS ---
function renderExplorerResultsPage(container, term, folderMap, reset = false) {
    // 1. Se for um reset (nova pesquisa), limpa o contentor
    if (reset) {
        container.innerHTML = '';
    }

    if (globalExplorerResults.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted-color); margin-top: 20px;">Nenhum resultado encontrado.</p>';
        return;
    }

    // 2. C√°lculo de Pagina√ß√£o
    const start = currentExplorerPage * EXPLORER_RESULTS_PER_PAGE;
    const end = start + EXPLORER_RESULTS_PER_PAGE;
    const pageResults = globalExplorerResults.slice(start, end);

    // Remove o bot√£o "Carregar mais" antigo se existir
    const oldBtn = document.getElementById('explorer-load-more-btn');
    if (oldBtn) oldBtn.remove();

    // 3. Loop de Renderiza√ß√£o dos Itens
    pageResults.forEach(item => {
        const divItem = document.createElement('div');
        divItem.className = 'search-result-item';

        // Definir cores e √≠cones baseados no Badge (Etiqueta)
        let borderLeftColor = "var(--border-color)";
        let icon = "üìÑ";
        let badgeStyle = "background: rgba(255,255,255,0.1); color: var(--text-muted-color);";

        switch (item.badge) {
            case 'Puzzle':
                borderLeftColor = "#2ecc71"; // Verde
                icon = "üß©";
                badgeStyle = "background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71;";
                break;
            case 'Arquivo':
                borderLeftColor = "#e74c3c"; // Vermelho
                icon = "üóÑÔ∏è";
                badgeStyle = "background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c;";
                break;
            case 'SuperPasta':
                borderLeftColor = "#f1c40f"; // Dourado
                icon = "üóÉÔ∏è";
                badgeStyle = "background: rgba(241, 196, 15, 0.2); color: #f1c40f; border: 1px solid #f1c40f;";
                break;
            case 'Quest√£o':
                borderLeftColor = "#1e8449"; // Verde escuro
                icon = "üìó";
                badgeStyle = "background: rgba(30, 132, 73, 0.2); color: #2ecc71;";
                break;
        }

        divItem.style.borderLeft = `4px solid ${borderLeftColor}`;

        // Construir HTML do item
        divItem.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span class="search-result-title">
                    ${icon} ${highlightMatch(item.name, term)} 
                </span>
                <span class="search-badge" style="${badgeStyle} font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase;">
                    ${item.badge}
                </span>
            </div>
            ${item.context ? `<div class="search-match-context" style="margin-top: 5px; font-size: 0.85em; opacity: 0.8;">${item.context}</div>` : ''}
        `;

        // 4. L√ìGICA DE CLIQUE INTELIGENTE
        divItem.onclick = () => {
            // Fecha o modal de pesquisa
            document.getElementById('anchors-modal').style.display = 'none';

            if (item.clickAction === 'entity') {
                // SE FOR PUZZLE: Abre o painel de Refer√™ncias da 4¬™ Coluna
                // Nota: Mapeamos o nome da cole√ß√£o para o tipo singular esperado pelo painel
                const typeMap = {
                    'personagens': 'personagem',
                    'locais': 'local',
                    'topicos': 'topico',
                    'textosbiblicos': 'textobiblico',
                    'marcadores': 'marcadores',
                    'cosmos': 'cosmos',
                    'subcosmos': 'subcosmos'
                };
                const singularType = typeMap[item.type] || item.type;
                showReferencesPanel(item.id, item.name, singularType);
            } else {
                // SE FOR NOTA: Abre a nota no editor principal
                navigateWithUnsavedCheck(() => {
                    navigateToNoteSmart(item.id, item.rawSearchTerm);
                });
            }
        };

        container.appendChild(divItem);
    });

    // 5. Adicionar Bot√£o "Carregar Mais" se houver mais resultados
    if (end < globalExplorerResults.length) {
        const remaining = globalExplorerResults.length - end;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'explorer-load-more-btn';
        loadMoreBtn.className = 'modal-btn secondary';
        loadMoreBtn.style.width = "100%";
        loadMoreBtn.style.marginTop = "15px";
        loadMoreBtn.textContent = `Mostrar mais ${remaining} resultados`;
        
        loadMoreBtn.onclick = (e) => {
            e.preventDefault();
            currentExplorerPage++;
            renderExplorerResultsPage(container, term, folderMap, false);
        };
        
        container.appendChild(loadMoreBtn);
    }
}



// Fun√ß√£o auxiliar para atualizar as abas visualmente (se ainda n√£o existir)
function updateTabsUI() {
    document.querySelectorAll('.tabs-container button').forEach(btn => {
        if (btn.dataset.tab === 'note') btn.classList.add('active');
        else btn.classList.remove('active');
    });
}

// Auxiliar para destacar t√≠tulo
function highlightMatch(text, term, isExact) {
    if (!text) return "";
    // Usamos a fun√ß√£o acima que j√° devolve a Regex com par√™nteses
    const regex = getAccentInsensitiveRegex(term, isExact);
    
    // Agora o $1 vai representar exatamente o que a Regex encontrou (ex: "Eva", "eva" ou "√âva")
    return text.replace(regex, "<mark>$1</mark>");
}

// --- FUN√á√ïES AUXILIARES DE CARREGAMENTO (Refatoradas para limpar o c√≥digo principal) ---
async function loadTagsForExplorer(container) {
    try {
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const activeTagsSet = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach(t => activeTagsSet.add(t));
            }
        });
        const tagsArray = Array.from(activeTagsSet).sort((a, b) => a.localeCompare(b));

        container.innerHTML = ''; 
        if (tagsArray.length === 0) {
            container.innerHTML = '<p style="padding:15px; color:#888;">Nenhuma tag encontrada.</p>';
        } else {
            const ul = document.createElement('ul');
            tagsArray.forEach(tagName => {
                const li = document.createElement('li');
                li.textContent = `#${tagName}`;
                li.style.cursor = 'pointer';
                li.style.color = 'var(--accent-color)';
                li.dataset.action = 'show-tag-references';
                li.dataset.tagName = tagName;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }
    } catch (e) {
        container.innerHTML = '<p style="color:red;">Erro ao carregar tags.</p>';
    }
}

function renderEntityTab(container, type, onPageNames) {
    const sortedEntities = [...allEntities[type]].sort((a, b) => a.nome.localeCompare(b.nome));
    
    // (Pode reinserir aqui a l√≥gica de separa√ß√£o "Nesta Nota" vs "Banco de Dados" se desejar,
    //  o c√≥digo √© id√™ntico ao que tinha antes na fun√ß√£o gigante)
    
    const ul = document.createElement('ul');
    if (sortedEntities.length === 0) {
        container.innerHTML = '<p style="padding:15px; color:#888;">Sem registos.</p>';
        return;
    }

    sortedEntities.forEach(entity => {
        const li = document.createElement('li');
        li.textContent = entity.nome;
        li.dataset.entityId = entity.id;
        li.dataset.entityName = entity.nome;
        li.dataset.entityType = entity.tipo;
        li.dataset.action = 'show-entity-references';
        
        if (onPageNames.has(entity.nome)) li.classList.add('is-on-page');

        const editBtn = document.createElement('button');
        editBtn.className = 'entity-edit-btn';
        editBtn.innerHTML = '‚Ä¶';
        editBtn.onclick = (e) => { e.stopPropagation(); openEditEntityModal(entity.id, entity.tipo); };
        
        li.appendChild(editBtn);
        ul.appendChild(li);
    });
    container.appendChild(ul);
}



window.openEditEntityModal = async function(entityId, entityType) {
    const modal = document.getElementById('edit-entity-modal');
    const modalContent = modal.querySelector('.modal-content'); 
    const title = document.getElementById('edit-entity-title');
    const nameInput = document.getElementById('edit-entity-name-input');
    const descriptionInput = document.getElementById('edit-entity-description-input');
    const saveBtn = document.getElementById('edit-entity-save-btn');
    const emojiContainer = document.getElementById('edit-emoji-container');
    const emojiInput = document.getElementById('edit-emoji-input');

    if (!modal) return;

    // 1. FOR√áAR VISIBILIDADE M√ÅXIMA
    document.body.appendChild(modal); // Move para o topo
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        justify-content: center !important;
        align-items: center !important;
    `;
    
    if (modalContent) modalContent.style.position = 'relative';

    nameInput.value = 'A carregar...';
    descriptionInput.value = 'A carregar...';
    
    // Mostra o campo de Emoji apenas se for Subcosmos
    if (entityType === 'subcosmos') {
        emojiContainer.style.display = 'block';
    } else {
        emojiContainer.style.display = 'none';
    }

    // --- BOT√ÉO OCULTAR (CANTO SUPERIOR DIREITO) ---
    const oldBtn = document.getElementById('btn-hide-entity-corner');
    if (oldBtn) oldBtn.remove();

    const hideBtn = document.createElement('button');
    hideBtn.id = 'btn-hide-entity-corner';
    hideBtn.textContent = "üëÅÔ∏è Ocultar";
    
    hideBtn.style.cssText = `
        position: absolute; top: 15px; right: 15px;
        background: none; border: 1px solid transparent;
        color: var(--text-muted-color); font-size: 0.75em;
        cursor: pointer; padding: 4px 8px; border-radius: 4px;
        transition: all 0.2s; opacity: 0.7;
    `;
    
    hideBtn.onmouseover = () => { hideBtn.style.color = "#e74c3c"; hideBtn.style.opacity = "1"; hideBtn.style.backgroundColor = "rgba(231, 76, 60, 0.1)"; };
    hideBtn.onmouseout = () => { hideBtn.style.color = "var(--text-muted-color)"; hideBtn.style.opacity = "0.7"; hideBtn.style.backgroundColor = "transparent"; };

    modalContent.appendChild(hideBtn);

    const collectionName = getCollectionFromType(entityType);
    
    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const entityRef = doc(db, collectionName, entityId);
        const entitySnap = await getDoc(entityRef);

        if (!entitySnap.exists()) {
            modal.style.display = 'none';
            alert("Erro: Item n√£o encontrado.");
            return;
        }

        const entityData = entitySnap.data();
        title.textContent = `Editar "${entityData.nome}"`;
        nameInput.value = entityData.nome;
        descriptionInput.value = entityData.descricao || '';
        
        if (entityType === 'subcosmos') emojiInput.value = entityData.emoji || "üíº";

        // --- L√ìGICA DO BOT√ÉO OCULTAR ---
        hideBtn.onclick = async () => {
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) {
                document.body.appendChild(confirmModal); 
                confirmModal.style.setProperty('z-index', '2147483647', 'important'); 
            }

            const confirmed = await showConfirmation(
                "Ocultar Item?",
                `Deseja ocultar "${entityData.nome}"?\n\nEle sair√° das listas mas pode ser recuperado em Configura√ß√µes > Itens Ocultos.`
            );

            if (confirmed) {
                modal.style.display = 'none';
                await updateDoc(entityRef, { estado: 'desativa' });
                
                if (typeof hideReferencesPanel === 'function') hideReferencesPanel();
                if (typeof fetchAllEntities === 'function') fetchAllEntities();
                
                // Atualiza a lista atual
                const lastNav = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1] : null;
                if (lastNav) {
                    renderListCategoryItems(lastNav.id); // Refresh da lista
                }
            }
        };

        // --- L√ìGICA DO BOT√ÉO GRAVAR ---
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

        newSaveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newDescription = descriptionInput.value.trim();
            const newEmoji = emojiInput.value.trim();

            if (!newName) return alert('O nome √© obrigat√≥rio.');

            const updateData = { nome: newName, descricao: newDescription };
            if (entityType === 'subcosmos') updateData.emoji = newEmoji || "üíº"; 

            await updateDoc(entityRef, updateData);

            // Atualiza Cache
            if (allEntities[entityType]) {
                const cached = allEntities[entityType].find(e => e.id === entityId);
                if (cached) {
                    cached.nome = newName;
                    cached.descricao = newDescription;
                    cached.emoji = newEmoji;
                }
            }

            modal.style.display = 'none';
            
            // Recarrega a lista do painel do meio
            if (navigationStack.length > 0) {
                renderListCategoryItems(navigationStack[navigationStack.length - 1].id);
            }
        };

    } catch (error) {
        console.error("Erro ao editar:", error);
        modal.style.display = 'none';
    }
};

// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
 async function appendLinkInfoToPanel(anexoId) {
    if (!selectedNoteId) {
        console.error('ID da nota n√£o encontrado. A abortar.');
        console.groupEnd();
        return;
    }

    const noteRef = doc(db, 'pastas', selectedNoteId);
    const noteSnap = await getDoc(noteRef);
    
    if (noteSnap.exists() && noteSnap.data().anexos && noteSnap.data().anexos[anexoId]) {
        const anexo = noteSnap.data().anexos[anexoId];
        const list = document.getElementById('references-list');

        const details = document.createElement('details');
        details.className = 'reference-item link-info';
        details.open = true;

        const summary = document.createElement('summary');
        summary.innerHTML = `üîó Anexo: ${anexo.titulo}`;
        
        const contextDiv = document.createElement('div');
        contextDiv.className = 'reference-context';
        
        const urls = anexo.urls ? Object.values(anexo.urls) : [anexo.hiperligacao];
        urls.forEach(url => {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.textContent = url;
                link.target = '_blank';
                link.style.display = 'block';
                link.style.marginBottom = '5px';
                contextDiv.appendChild(link);
            }
        });

        details.appendChild(summary);
        details.appendChild(contextDiv);
        
        const separator = document.createElement('hr');
        separator.style.borderColor = 'var(--border-color)';
        separator.style.margin = '15px 0';
        
        list.appendChild(separator);
        list.appendChild(details);
    } else {
        console.error(`Anexo com ID "${anexoId}" n√£o foi encontrado nos dados da nota.`);
    }
    console.groupEnd();
}
// ====================================================================


// --- LISTENERS DOS BOT√ïES DO CABE√áALHO ---
document.getElementById('add-text-btn').addEventListener('click', () => createBoardItem('text', {}, true));
document.getElementById('add-ref-btn').addEventListener('click', () => openReferenceSelectionPopup());

// Fun√ß√£o Unificada para Criar Cart√µes no Quadro
function createBoardItem(type, data = {}, shouldScroll = false) {
    const container = document.getElementById('puzzle-board-container');
    const emptyMsg = document.getElementById('puzzle-empty-msg');
    
    if (emptyMsg) emptyMsg.style.display = 'none';

    const card = document.createElement('div');
    card.className = `board-card type-${type}`;
    // Necess√°rio para posicionamento absoluto do bot√£o
    card.style.position = 'relative'; 

    const puzzleContainer = document.getElementById('ref-content-puzzle');
    const isEditMode = puzzleContainer && puzzleContainer.classList.contains('edit-mode-active');
    let innerHTML = '';
    let headerHtml = "";
    let displayHtml = "";

    // 1. TEXTO MANUAL
    if (type === 'text') {
        const contentHtml = data.content || '';
        const initialStyle = "width:100%; min-height:40px; outline:none; white-space:pre-wrap; word-break:break-word; color:var(--text-color); border:1px solid transparent; background-color:transparent; padding:2px 5px; transition:all 0.2s ease;";
        innerHTML = `<div class="board-text-content" spellcheck="false" style="${initialStyle}" ${isEditMode ? 'contenteditable="true"' : 'contenteditable="false"'}>${contentHtml}</div>`;
        card.style.borderLeft = "3px solid var(--accent-color)"; 
        
        // Guardamos o snippet tamb√©m no texto manual para o popup funcionar
        card.dataset.snippet = encodeURIComponent(contentHtml);
        card.dataset.noteName = "Texto Manual";
    }

    // 2. REFER√äNCIA
    else if (type === 'ref') {
        card.dataset.noteId = data.noteId;
        card.dataset.noteName = data.noteName || "Nota";

        let rawSnippet = data.snippet || '';
        try {
            if (rawSnippet.includes('%3C') || rawSnippet.includes('%20')) {
                rawSnippet = decodeURIComponent(rawSnippet);
            }
        } catch (e) { }
        
        card.dataset.snippet = encodeURIComponent(rawSnippet);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawSnippet;

        // T√≠tulo
        const titleEl = tempDiv.querySelector('.mini-note-title-input') || tempDiv.querySelector('h2') || tempDiv.querySelector('.idea-span');
        let extractedTitle = titleEl ? (titleEl.textContent || titleEl.value || "") : "";
        let finalDisplayTitle = extractedTitle.trim() || data.noteName || "Sem T√≠tulo";

        // √çcone/Cor
        let icon = "üìÑ"; let color = "#95a5a6"; 
        if (rawSnippet.includes('question-mode')) { icon = "üìó"; color = "#2ecc71"; }
        else if (rawSnippet.includes('free-mode')) { icon = "üìô"; color = "#e67e22"; }
        else if (rawSnippet.includes('toggle-section')) { icon = "‚òÇ"; color = "#9b59b6"; }
        else if (rawSnippet.includes('mini-note-wrapper')) { icon = "üìò"; color = "#3498db"; }

        card.style.borderLeft = `4px solid ${color}`;

        // Corpo
        const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content') || tempDiv;
        let bodyText = contentDiv.innerText.replace(/\s+/g, ' ').trim().replace(/üîê|üî∫|üîª|‚ö°|üß¨|üé®|üìã|üóëÔ∏è/g, '');
        if (bodyText.length > 250) bodyText = bodyText.substring(0, 250) + "...";

        headerHtml = `
            <div style="padding-left: 5px; margin-bottom: 5px; padding-right: 20px;">
                <div style="font-weight:bold; font-size:1em; cursor:pointer; color:var(--text-color); display: flex; align-items: center; gap: 8px;" 
                     onclick="window.openNoteFromBoard('${data.noteId}', '${encodeURIComponent(finalDisplayTitle)}')"
                     onmouseover="this.style.textDecoration='underline'" 
                     onmouseout="this.style.textDecoration='none'">
                    <span style="font-size: 1.2em;">${icon}</span> ${finalDisplayTitle}
                </div>
            </div>`;
        displayHtml = `<div style="font-size:0.9em; color:var(--text-muted-color); padding-left: 8px; line-height:1.4;">${bodyText}</div>`;
        innerHTML = `<div class="ref-card-content">${headerHtml}${displayHtml}</div>`;
    }

    // --- AQUI EST√Å O BOT√ÉO NOVO (Canto Superior Direito) ---
    const popupIconHTML = `
        <button class="card-popup-btn" 
                onclick="event.preventDefault(); event.stopPropagation(); window.openCardPopup(this)"
                title="Abrir em Janela"
                style="position: absolute; top: 4px; right: 4px; background: none; border: none; color: var(--text-muted-color); cursor: pointer; font-size: 11px; opacity: 0.6; padding: 2px; z-index: 15; transition: opacity 0.2s;">
            ‚á±
        </button>
    `;

    innerHTML += popupIconHTML;

    // Controlos de edi√ß√£o (Fundo)
    innerHTML += `
        <div class="card-controls"> 
            ${type === 'text' ? '<button class="add-board-link" title="Gerir Links" style="margin-right: auto;">üåê</button>' : ''}
            <button class="move-up" title="Mover para Cima">üî∫</button>
            <button class="move-down" title="Mover para Baixo">üîª</button>
            <button class="delete" title="Remover" style="color:#e74c3c; border-color:#e74c3c;">üóëÔ∏è</button>
        </div>
    `;

    card.innerHTML = innerHTML;

    // (O resto dos listeners mant√©m-se igual...)
    const linkBtn = card.querySelector('.add-board-link');
    if (linkBtn) {
        linkBtn.onclick = (e) => {
            e.preventDefault(); e.stopPropagation();
            const contentDiv = card.querySelector('.board-text-content');
            if (typeof openBoardLinkManager === 'function') openBoardLinkManager(contentDiv);
        };
    }

    // Hover effect para o bot√£o popup
    const popBtn = card.querySelector('.card-popup-btn');
    if(popBtn) {
        popBtn.onmouseover = () => { popBtn.style.opacity = '1'; popBtn.style.color = 'var(--accent-color)'; };
        popBtn.onmouseout = () => { popBtn.style.opacity = '0.6'; popBtn.style.color = 'var(--text-muted-color)'; };
    }

    card.querySelector('.delete').onclick = async () => {
        const confirmModal = document.getElementById('confirm-modal');
        if (confirmModal) confirmModal.style.zIndex = "30000";
        const confirmed = await showConfirmation("Remover Item", "Deseja remover este item do quadro?");
        if (confirmed) { 
            card.remove(); 
            if(container.querySelectorAll('.board-card').length === 0 && emptyMsg) emptyMsg.style.display = 'block';
            if(isEditMode) savePuzzleData(); 
        }
    };

    card.querySelector('.move-up').onclick = () => {
        const p = card.previousElementSibling; 
        if (p && p.classList.contains('board-card')) container.insertBefore(card, p);
    };
    card.querySelector('.move-down').onclick = () => {
        const n = card.nextElementSibling; 
        if (n && n.classList.contains('board-card')) container.insertBefore(n, card);
    };

    if (shouldScroll) {
        container.prepend(card);
        setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    } else {
        container.appendChild(card);
    }
}




// Fun√ß√£o para abrir nota a partir do Quadro (Puzzle) - VERS√ÉO ATUALIZADA
window.openNoteFromBoard = function(noteId, encodedSearchTerm = null) {
    
    // 1. Descodifica o termo de pesquisa (t√≠tulo da caixa) se ele existir
    // Se n√£o existir, tenta usar o nome da entidade ativa como fallback (comportamento antigo)
    let term = encodedSearchTerm 
        ? decodeURIComponent(encodedSearchTerm) 
        : (typeof activeReferenceEntity !== 'undefined' && activeReferenceEntity ? activeReferenceEntity.name : null);

    // 2. Usa a Navega√ß√£o Inteligente (que lida com Superpastas e Grava√ß√£o)
    // A fun√ß√£o navigateWithUnsavedCheck garante que gravamos o quadro antes de sair
    navigateWithUnsavedCheck(() => {
        if (typeof navigateToNoteSmart === 'function') {
            // Usa a fun√ß√£o moderna que sabe mudar de p√°gina
            navigateToNoteSmart(noteId, term);
        } else {
            // Fallback de seguran√ßa (caso a fun√ß√£o smart n√£o exista por algum motivo)
            displayNote(noteId, null, term);
        }
    });
};

// --- L√ìGICA DO POPUP DE SELE√á√ÉO DE REFER√äNCIAS ---
async function openReferenceSelectionPopup() {
    console.group("üîç [DEBUG REF] Iniciando Pesquisa de Refer√™ncias");
    
    const modal = document.getElementById('puzzle-ref-selection-modal');
    const list = document.getElementById('puzzle-ref-selection-list');
    
    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        console.error("‚ùå Nenhuma entidade ativa encontrada.");
        console.groupEnd();
        alert("Selecione um t√≥pico, tag ou entidade primeiro.");
        return;
    }

    document.body.appendChild(modal);
    modal.style.cssText = `
        display: flex !important;
        position: fixed !important;
        top: 0 !important; left: 0 !important; width: 100vw; height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important;
        justify-content: center !important; align-items: center !important;
        visibility: visible !important; opacity: 1 !important;
    `;

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar dados...</span></div>';

    allFoundReferenceBoxes = [];
    currentReferencePageIndex = 0;

    const { id, type, name } = activeReferenceEntity;
    const isHighlightSearch = (type === 'destaque');
    const searchTerm = name.toLowerCase().trim();
    const hexToFind = isHighlightSearch ? id.toUpperCase() : null;

    try {
        // 1. CARREGAR QUADRO ATUAL
        const activeTabBtn = document.querySelector('#ref-tabs button.active');
        const activeTab = activeTabBtn ? activeTabBtn.dataset.refTab : 'puzzle';
        
        let currentBoardItems = []; 
        const col = getCollectionFromType(type);
        const { doc, getDoc, collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const docRef = doc(db, col, id);
        const docSnap = await getDoc(docRef);

        if (activeTab === 'dossie' && window.activeMicaId) {
            if(docSnap.exists()) {
                const dossie = docSnap.data().dossie || [];
                const mica = dossie.find(m => m.id === window.activeMicaId);
                if(mica && mica.items) currentBoardItems = mica.items;
            }
        } else {
            if(docSnap.exists()) {
                currentBoardItems = docSnap.data().puzzleBoard || [];
            }
        }

        const existingIDs = new Set();
        currentBoardItems.forEach(item => {
            if(item.snippet) {
                const match = decodeURIComponent(item.snippet).match(/id="([^"]+)"/);
                if(match) existingIDs.add(match[1]);
            }
        });

        // 2. PESQUISA GLOBAL
        let q = query(collection(db, 'pastas'), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid),
            where('tipo', 'in', ['nota', 'arquivo', 'partilhado', 'jornal', 'aquario'])
        );
        
        const snapshot = await getDocs(q);
        const parser = new DOMParser();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const noteTitle = data.nome || "Sem T√≠tulo";
            const updatedTime = data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0;

            if (data.passe && data.passe.trim() !== "" && !appSettings.searchAnchorsInProtected) return;

            let contentsToScan = [];
            if (data.tipo === 'nota' || data.tipo === 'jornal' || data.tipo === 'aquario') {
                contentsToScan.push({ html: data.conteudo || "", originName: noteTitle });
            } else {
                const posts = data.posts || [];
                posts.forEach(post => {
                    contentsToScan.push({ html: post.content || "", originName: `${noteTitle} (Post: ${post.title || 'S/T'})` });
                });
            }

            contentsToScan.forEach(item => {
                const docHTML = parser.parseFromString(item.html, 'text/html');
                const allWrappers = docHTML.querySelectorAll('.mini-note-wrapper, .redator-wrapper, details.toggle-section, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
                
                allWrappers.forEach((w) => {
                    let match = false;
                    let matchSource = "text"; 

                    // A. MATCH POR COR
                    if (isHighlightSearch) {
                        const elColor = w.getAttribute('data-highlight');
                        if (elColor && elColor.toUpperCase() === hexToFind) {
                            match = true;
                            matchSource = "color";
                        }
                    } 
                    
                    // B. MATCH POR TEXTO
                    let boxTitle = "";
                    let boxContentOnly = "";
                    
                    if (w.tagName === 'DETAILS') {
                        const h2 = w.querySelector('h2');
                        boxTitle = h2 ? h2.textContent : "";
                        const contentDiv = w.querySelector('.toggle-content');
                        boxContentOnly = contentDiv ? contentDiv.textContent : "";
                    } else {
                        const titleInput = w.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
                        boxTitle = titleInput ? (titleInput.value || titleInput.getAttribute('value') || "") : "";
                        const contentDiv = w.querySelector('.mini-note-content, .redator-content, .sign-content, .cube-content, .card-desc-content');
                        boxContentOnly = contentDiv ? contentDiv.textContent : "";
                    }
                    
                    const boxFullText = (boxTitle + " " + boxContentOnly).toLowerCase();

                    if (!match && boxFullText.includes(searchTerm)) {
                        match = true;
                        matchSource = "text";
                    }

                    // C. MATCH POR CATEGORIA
                    const boxLinksRaw = w.getAttribute('data-box-links');
                    if (!match && boxLinksRaw && boxLinksRaw !== '{}') {
                        try {
                            const boxData = JSON.parse(boxLinksRaw);
                            if (boxData.categories && Array.isArray(boxData.categories)) {
                                const catMatch = boxData.categories.some(cat => {
                                    const idMatch = (cat.id && String(cat.id) === String(id));
                                    const nameMatch = (cat.name && cat.name.toLowerCase().trim() === searchTerm);
                                    return idMatch || nameMatch;
                                });
                                if (catMatch) {
                                    match = true;
                                    matchSource = "category";
                                }
                            }
                        } catch (e) {}
                    }

                    if (match) {
                        const currentId = w.id;
                        const originId = w.getAttribute('data-origin-id');
                        const isClone = !!originId; 
                        const originalIsPresent = isClone && existingIDs.has(originId);
                        const selfIsPresent = existingIDs.has(currentId);

                        // Identifica o Tipo
                        let boxType = "Bloco"; let boxIcon = "üì¶";
                        if (w.tagName === 'DETAILS') { boxType = "Sec√ß√£o"; boxIcon = "‚òÇÔ∏è"; }
                        else if (w.classList.contains('question-mode')) { boxType = "Quest√£o"; boxIcon = "üìó"; }
                        else if (w.classList.contains('free-mode')) { boxType = "Contentor"; boxIcon = "üìô"; }
                        else if (w.classList.contains('redator-wrapper')) { boxType = "Redator"; boxIcon = "üìì"; }
                        else if (w.classList.contains('journal-sign-wrapper')) { boxType = "Racioc√≠nio"; boxIcon = "ü™ß"; }
                        else if (w.classList.contains('journal-id-card')) { boxType = "Cart√£o"; boxIcon = "ü™™"; }
                        else { boxType = "SubNota"; boxIcon = "üìò"; }

                        // ============================================================
                        // >>> L√ìGICA DE TEXTO DO SNIPPET (ATUALIZADA) <<<
                        // ============================================================
                        
                        let displaySnippet = "";
                        const cleanTitle = boxTitle.trim();
                        const cleanBody = boxContentOnly.trim().replace(/\s+/g, ' ');

                        // 1. √â Contentor Livre ou Redator? (Estes podem n√£o ter t√≠tulo)
                        const isFreeOrRedator = (w.classList.contains('free-mode') || w.classList.contains('redator-wrapper'));

                        if (isFreeOrRedator) {
                            if (cleanTitle) {
                                // Tem t√≠tulo -> Mostra T√≠tulo
                                displaySnippet = cleanTitle;
                            } else {
                                // N√£o tem t√≠tulo -> Mostra primeiras 12 palavras do texto como "T√≠tulo Falso"
                                if (cleanBody) {
                                    const words = cleanBody.split(' ').slice(0, 12).join(' ');
                                    displaySnippet = `<em>${words}...</em>`;
                                } else {
                                    displaySnippet = `<em>${boxType} vazio</em>`;
                                }
                            }
                        } 
                        else {
                            // 2. Outros (Quest√µes, Subnotas, etc) -> Mostra SEMPRE o T√≠tulo
                            displaySnippet = cleanTitle || "Sem T√≠tulo";
                        }
                        
                        // Formata√ß√£o final (Negrito e tamanho)
                        displaySnippet = `<span style="font-weight:600; color:var(--text-color); font-size:1em;">${displaySnippet}</span>`;

                        // ============================================================

                        allFoundReferenceBoxes.push({
                            id: docSnap.id, 
                            name: item.originName, 
                            snippet: w.outerHTML, 
                            displaySnippet: displaySnippet, 
                            typeName: boxType, 
                            typeIcon: boxIcon, 
                            updatedTime: updatedTime,
                            isClone: isClone,
                            originalIsPresent: originalIsPresent,
                            selfIsPresent: selfIsPresent,
                            originId: originId 
                        });
                    }
                });
            });
        });

        console.log(`üèÅ Fim da pesquisa. Total: ${allFoundReferenceBoxes.length}`);
        console.groupEnd();
        
        allFoundReferenceBoxes.sort((a, b) => b.updatedTime - a.updatedTime);
        list.innerHTML = '';
        renderReferenceBoxesPage(); 

    } catch (e) {
        console.error("‚ùå Erro na pesquisa de refer√™ncias:", e);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar resultados.</li>';
    }
}

function renderReferenceBoxesPage() {
    const list = document.getElementById('puzzle-ref-selection-list');
    const ITEMS_PER_PAGE = 15;
    
    const oldBtn = document.getElementById('load-more-refs-btn');
    if (oldBtn) oldBtn.remove();

    if (allFoundReferenceBoxes.length === 0) {
        list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhuma refer√™ncia encontrada.</li>';
        return;
    }

    const start = currentReferencePageIndex * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = allFoundReferenceBoxes.slice(start, end);

    pageItems.forEach(item => {
        const li = document.createElement('li');
        li.className = 'puzzle-ref-item';
        
        let cloneBadge = "";
        let warningText = "";
        
        if (item.isClone) {
            cloneBadge = `<span title="Esta caixa √© uma c√≥pia (Clone)" style="margin-left:5px; font-size:1.1em;">‚öóÔ∏è</span>`;
            if (item.originalIsPresent) {
                warningText = `<div style="color:#e74c3c; font-size:0.75em; font-weight:bold; margin-top:2px;">‚ö†Ô∏è O original j√° est√° neste quadro!</div>`;
            }
        }
        
        if (item.selfIsPresent) {
             warningText += `<div style="color:#f39c12; font-size:0.75em; font-weight:bold; margin-top:2px;">‚ö†Ô∏è Este item j√° foi adicionado.</div>`;
        }

        const safeSnippet = encodeURIComponent(item.snippet);

        // --- ATUALIZA√á√ÉO DO HTML DO ITEM ---
        // O bot√£o do olho agora usa a classe sem bordas e est√° alinhado
        li.innerHTML = `
            <div class="puzzle-ref-header">
                <span class="puzzle-ref-type" style="color: var(--accent-color)">
                    ${item.typeIcon} ${item.typeName} ${cloneBadge}
                </span>
                
                <div style="text-align:right; display:flex; align-items:center; justify-content:flex-end;">
                    <span class="puzzle-ref-note" style="max-width: 140px;">em ${item.name}</span>
                    
                    <!-- BOT√ÉO OLHO LIMPO -->
                    <button class="btn-preview-eye-minimal" title="Pr√©-visualizar" 
                            onclick="event.stopPropagation(); window.previewReferenceBox('${safeSnippet}', '${item.typeName}')">
                        üëÅ
                    </button>
                </div>
            </div>
            
            ${warningText}
            
            <div class="puzzle-ref-snippet">
                ${item.displaySnippet}
            </div>
        `;

        li.onclick = async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const previewPop = document.getElementById('ref-preview-popup');
            if(previewPop) previewPop.remove();

            if (item.originalIsPresent) {
                if (!confirm("O original desta c√≥pia j√° est√° no quadro. Deseja adicionar o clone na mesma?")) return;
            }

            const activeTabBtn = document.querySelector('#ref-tabs button.active');
            const activeTab = activeTabBtn ? activeTabBtn.dataset.refTab : 'puzzle';

            if (activeTab === 'dossie' && window.activeMicaId) {
                try {
                    const collectionName = getCollectionFromType(activeReferenceEntity.type);
                    const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    const docRef = doc(db, collectionName, activeReferenceEntity.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        let dossie = docSnap.data().dossie || [];
                        const mica = dossie.find(m => m.id === window.activeMicaId);
                        
                        if (mica) {
                            if (!mica.items) mica.items = [];
                            mica.items.unshift({
                                noteId: item.id,
                                noteName: item.name,
                                snippet: encodeURIComponent(item.snippet)
                            });
                            await updateDoc(docRef, { dossie: dossie });
                            window.renderDossie(); 
                            const listContainer = document.getElementById('dossie-list-container');
                            if(listContainer) listContainer.scrollTop = 0;
                        }
                    }
                } catch (err) { console.error("Erro Mica:", err); }
            } 
            else {
                if (typeof createBoardItem === 'function') {
                    createBoardItem('ref', {
                        noteId: item.id,
                        noteName: item.name,
                        snippet: item.snippet,
                        isClone: true
                    }, true);

                    const puzzleContainer = document.getElementById('ref-content-puzzle');
                    if (puzzleContainer && puzzleContainer.classList.contains('edit-mode-active')) {
                        savePuzzleData();
                    }
                }
            }
            document.getElementById('puzzle-ref-selection-modal').style.display = 'none';
        };
        list.appendChild(li);
    });

    if (end < allFoundReferenceBoxes.length) {
        currentReferencePageIndex++;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-refs-btn';
        loadMoreBtn.className = 'modal-btn secondary';
        loadMoreBtn.style.width = "100%";
        loadMoreBtn.style.marginTop = "10px";
        loadMoreBtn.textContent = `+ ${allFoundReferenceBoxes.length - end} resultados`;
        loadMoreBtn.onclick = () => renderReferenceBoxesPage();
        list.appendChild(loadMoreBtn);
    }
}

// 4. Adicionar ao Dossi√© (+Add)
document.getElementById('mica-add-content-btn').onclick = async () => {
    // Apenas abre o modal. O clique no item agora √© gerido pela fun√ß√£o de renderiza√ß√£o abaixo.
    await openReferenceSelectionPopup();
};
// --- FUN√á√ÉO DE NAVEGA√á√ÉO INTELIGENTE ENTRE SUPERPASTAS ---

/**
 * Verifica a ancestralidade da nota e decide se abre diretamente
 * ou se redireciona para outra p√°gina (note.html vs superpasta.html)
 */
async function navigateToNoteSmart(targetNoteId, searchTerm = null) {
    if (!targetNoteId) return;

    // CORRE√á√ÉO: N√£o usamos updateSaveStatus('saving') aqui.
    // Apenas mudamos o texto visualmente para o utilizador saber que algo est√° a acontecer.
    const statusEl = document.getElementById('save-status-indicator');
    if(statusEl) {
        statusEl.textContent = "A localizar nota...";
        statusEl.style.opacity = "1";
    }


    try {
        // 1. Buscar dados da nota
        const noteSnap = await getDoc(doc(db, 'pastas', targetNoteId));
        if (!noteSnap.exists()) {
            alert("Nota n√£o encontrada.");
            if(statusEl) statusEl.textContent = ""; // Limpa mensagem
            console.groupEnd();
            return;
        }
        const noteData = noteSnap.data();
        
        // 2. DETETIVE: Verificar Ancestrais (Procurar Superpasta)
        let currentParentId = noteData.parentId;
        let foundSuperfolderId = null;
        let safety = 0;

        while (currentParentId && safety < 50) {
            const parentSnap = await getDoc(doc(db, 'pastas', currentParentId));
            if (!parentSnap.exists()) break;
            
            const parentData = parentSnap.data();
            
            // Se encontrar uma superpasta
            if (parentData.superpasta === true) {
                foundSuperfolderId = currentParentId;
                break; 
            }
            currentParentId = parentData.parentId;
            safety++;
        }

        const searchParam = searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : '';

       // 3. DECIS√ÉO FINAL (Unificada)
        console.groupEnd();
        
        // Reconstr√≥i caminho e abre nota
        await reconstructNavigationPath(targetNoteId);
        displayNote(targetNoteId, null, searchTerm);
        
        // Restaura o texto de estado
        if(statusEl) updateSaveStatus('saved');

    } catch (error) {
        console.error("Erro navega√ß√£o:", error);
        console.groupEnd();
        if(statusEl) statusEl.textContent = "Erro ao navegar";
    }
}

async function reconstructNavigationPath(noteId) {
    let currentId = noteId;
    const path = [];
    let safety = 0;
    while (currentId && safety < 20) {
        const docSnap = await getDoc(doc(db, 'pastas', currentId));
        if (!docSnap.exists()) break;
        const data = docSnap.data();
        if (!data.parentId) { // Raiz
            if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
            break;
        }
        if (data.tipo === 'pasta') path.unshift({ id: docSnap.id, name: data.nome });
        currentId = data.parentId;
        safety++;
    }
    navigationStack = path;
    updateNavigationView(true, noteId); 
}

// ============================================================
// FUN√á√ïES AUXILIARES EM FALTA (COLE ISTO ANTES DO savePuzzleData)
// ============================================================

// 1. Mapear tipos para nomes de cole√ß√µes no Firebase
function getCollectionFromType(type) {
    if (ENTITY_CONFIG[type]) return ENTITY_CONFIG[type].collection;
    
    // Casos especiais
    if (type === 'topico') return 'topicos';
    if (type === 'subtopico') return 'subtopicos';
    if (type === 'tag') return 'tags';
     if (type === 'marcadores') return 'marcadores';
    
    return null;
}

// 2. For√ßar a grava√ß√£o e sa√≠da do modo de edi√ß√£o (Crucial para a navega√ß√£o)
async function forceSaveAndClosePuzzleMode() {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // S√≥ faz algo se estivermos no modo "Conclu√≠do" (ativo)
    if (container && container.classList.contains('edit-mode-active')) {

        // 1. GRAVAR NO FIREBASE (Aguarda terminar antes de continuar)
        await savePuzzleData();

        // 2. DESLIGAR MODO DE EDI√á√ÉO (Visual)
        container.classList.remove('edit-mode-active');

        // Restaurar bot√£o principal
        if (btn) {
            btn.textContent = "Editar";
            btn.style.color = "";
            btn.style.borderColor = "";
            btn.style.backgroundColor = "";
        }

        // Esconder bot√µes de adicionar
        if (addButtons) {
            addButtons.style.display = 'none';
        }

        // 3. BLOQUEAR AS CAIXAS DE TEXTO
        // Transformar de edit√°veis para est√°ticas
        const editableDivs = container.querySelectorAll('.board-text-content');
        editableDivs.forEach(div => {
            div.setAttribute('contenteditable', 'false');
            // Remove estilo de input
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
}

// ============================================================

async function savePuzzleData() {
    if (!activeReferenceEntity || !activeReferenceEntity.name) return;

    const { id, type, name } = activeReferenceEntity;
    const collectionName = getCollectionFromType(type);
    
    const saveBtn = document.getElementById('toggle-puzzle-edit-btn');
    if(saveBtn) saveBtn.textContent = "A gravar...";

    try {
        const itemsToSave = [];
        const cards = document.querySelectorAll('#puzzle-board-container .board-card');

        cards.forEach(card => {
            if (card.classList.contains('type-text')) {
                const contentDiv = card.querySelector('.board-text-content');
                if (contentDiv) itemsToSave.push({ type: 'text', content: contentDiv.innerHTML });
            } 
            else if (card.classList.contains('type-ref')) {
                itemsToSave.push({ 
                    type: 'ref', 
                    noteId: card.dataset.noteId,
                    noteName: card.dataset.noteName,
                    snippet: decodeURIComponent(card.dataset.snippet)
                });
            }
        });

        // --- CORRE√á√ÉO DE SEGURAN√áA ---
        let docRef;
        
        // Se o ID atual parece um nome de vers√≠culo (tem espa√ßos ou :), ou se √© null
        // vamos procurar se o user j√° tem um doc real para isto
        if (!id || id.includes(' ') || id.includes(':')) {
            const q = query(
                collection(db, collectionName), 
                where("nome", "==", name),
                where("userId", "==", auth.currentUser.uid)
            );
            const snap = await getDocs(q);
            
            if (!snap.empty) {
                // J√° existe um documento real, usamos o ID dele
                docRef = doc(db, collectionName, snap.docs[0].id);
                activeReferenceEntity.id = snap.docs[0].id; 
            } else {
                // N√£o existe? Criamos um NOVO documento com ID aleat√≥rio (addDoc)
                const newDoc = await addDoc(collection(db, collectionName), {
                    nome: name,
                    userId: auth.currentUser.uid,
                    puzzleBoard: itemsToSave,
                    updatedAt: serverTimestamp(),
                    createdAt: serverTimestamp()
                });
                activeReferenceEntity.id = newDoc.id; // Atualiza para o ID novo
                return; // J√° gravou, podemos sair
            }
        } else {
            // Se j√° temos um ID hexadecimal (aleat√≥rio), gravamos direto
            docRef = doc(db, collectionName, id);
        }

        // Grava√ß√£o final (Update ou Set)
        await setDoc(docRef, {
            nome: name,
            userId: auth.currentUser.uid,
            puzzleBoard: itemsToSave,
            updatedAt: serverTimestamp()
        }, { merge: true });

    } catch (e) {
        console.error("‚ùå Erro ao gravar:", e);
        alert("Erro de permiss√£o: Este vers√≠culo pode estar mal configurado no banco de dados.");
    } finally {
        if(saveBtn) saveBtn.textContent = "Editar";
    }
}

// --- NOVO LOAD (Unificado) ---
async function loadPuzzleData(entityId, entityType) {
    const container = document.getElementById('puzzle-board-container');
    if (!container) return;

    // 1. MOSTRAR LOADING
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A carregar Quadro...</span>
        </div>`;

    const collectionName = getCollectionFromType(entityType);
    if (!collectionName) {
        container.innerHTML = '';
        return;
    }

    try {
        let foundData = null;

        // 2. TENTATIVA A: Busca direta pelo ID (se for ID v√°lido)
        if (entityId && entityId.length > 5 && !entityId.includes(' ')) {
            const docRef = doc(db, collectionName, entityId);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                foundData = snap.data();
            }
        }

        // 3. TENTATIVA B: Busca pelo Nome (CR√çTICO PARA VERS√çCULOS)
        // Se a busca por ID falhou, procura pelo nome exato (ex: "G√©nesis 1:1")
        if (!foundData) {
            const nameToFind = (typeof entityId === 'string' && entityId.includes(' ')) ? entityId : activeReferenceEntity.name;
            
            const q = query(
                collection(db, collectionName), 
                where("nome", "==", nameToFind), 
                where("userId", "==", auth.currentUser.uid)
            );
            
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                foundData = querySnapshot.docs[0].data();
                // Atualiza o ID da entidade ativa para o correto
                activeReferenceEntity.id = querySnapshot.docs[0].id;
            }
        }

        // 4. LIMPAR O LOADING
        container.innerHTML = '';

        // 5. VERIFICA√á√ÉO DE DADOS
        const boardItems = foundData ? (foundData.puzzleBoard || []) : [];

        if (boardItems.length === 0) {
            container.innerHTML = `
                <p id="puzzle-empty-msg" style="text-align:center; color:var(--text-muted-color); font-size:0.9em; margin-top:40px; font-style: italic;">
                    O quadro est√° vazio.<br>Clique em "Editar" para adicionar notas ou refer√™ncias.
                </p>`;
            return;
        }

        // 6. RENDERIZAR CART√ïES
        boardItems.forEach(item => {
            createBoardItem(item.type, {
                content: item.content,
                noteId: item.noteId,
                noteName: item.noteName,
                snippet: item.snippet
            });
        });

    } catch (e) { 
        console.error("Erro no Puzzle:", e); 
        container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar o Quadro.</p>';
    }
}

// ====================================================================
// ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT JAVASCRIPT
// ====================================================================
async function showTagReferencesPanel(tagName) {
    
    // 1. Gravar o puzzle anterior se estivesse em modo edi√ß√£o
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI();

    // 2. DEFINIR ENTIDADE ATIVA (Essencial para o +Ref do Quadro)
    activeReferenceEntity = { 
        id: tagName, 
        type: 'tag', 
        name: tagName 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Cita√ß√µes de #${tagName}`;

    // For√ßar a aba "Cita√ß√µes" a abrir para listar as notas
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Carregar os dados do Quadro (Puzzle) salvos para esta Tag
    loadPuzzleData(tagName, 'tag');
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar notas com #${tagName}...</span>
        </div>`;

    try {
        // 4. Pesquisa no Firestore: Notas ativas com a tag espec√≠fica
        const q = query(
            collection(db, 'pastas'), 
            where('tags', 'array-contains', tagName),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const querySnapshot = await getDocs(q);
        
        // 5. Reset da lista global de resultados
        allCitationsResults = []; 

        querySnapshot.forEach(noteDoc => {
            const data = noteDoc.data();
            
            // Filtro de Privacidade
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            if (isItemProtected && !appSettings.searchTagsInProtected) {
                return; 
            }
            
            // Preparar o Snippet visual para quando for adicionado ao quadro
            const tagSnippet = `<p style="color:#3498db; font-weight:bold;">üè∑Ô∏è Nota com tag #${tagName}</p>`;

            // Alimenta o array global para pagina√ß√£o
            allCitationsResults.push({ 
                id: noteDoc.id, 
                name: data.nome, 
                isProtected: isItemProtected,
                snippet: tagSnippet,
                ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
            });
        });

        // 6. ORDENAR: Mais recente primeiro
        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);

        // 7. Renderizar a primeira p√°gina (false = resetar lista visual)
        window.renderCitationsPage(false);

    } catch (error) {
        console.error("Erro ao carregar cita√ß√µes da tag:", error);
        listElement.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao processar as notas no banco de dados.</li>';
    }
}


// ============================================================
// MOTOR DA 4¬™ COLUNA - B√çBLIA P√öBLICA + PUZZLE PRIVADO (FIXED)
// ============================================================

function resetReferencesPanelUI() {
    // 1. Esconder todos os conte√∫dos de abas
    document.querySelectorAll('.ref-tab-content').forEach(el => {
        el.style.display = 'none';
    });

    // 2. Mostrar apenas o conte√∫do do Puzzle (padr√£o de abertura)
    const puzzleContent = document.getElementById('ref-content-puzzle');
    if (puzzleContent) puzzleContent.style.display = 'flex';

    // 3. Resetar visual dos bot√µes das abas
    document.querySelectorAll('#ref-tabs button').forEach(btn => {
        btn.classList.remove('active');
    });
    const puzzleTabBtn = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTabBtn) puzzleTabBtn.classList.add('active');

    // 4. Limpar a lista de Links (Doc.)
    const linksList = document.getElementById('panel-links-list');
    if (linksList) linksList.innerHTML = '';

    // 5. RESET DO MODO EDI√á√ÉO (Links/Doc)
    isPanelEditMode = false;
 isPanelEditMode = false;
    const editLinksBtn = document.getElementById('toggle-links-edit-btn');
    const linksActions = document.getElementById('links-edit-actions');
    if (editLinksBtn) {
        editLinksBtn.textContent = "Editar";
        editLinksBtn.style.color = "";
        editLinksBtn.style.borderColor = "";
        editLinksBtn.style.backgroundColor = "";
    }
    if (linksActions) linksActions.style.display = 'none';

    // ============================================================
    // üöÄ LIMPEZA AGRESSIVA DO DOSSI√â (IMPEDE O BOT√ÉO DE PISCAR)
    // ============================================================
    window.isDossieEditMode = false; 
    window.activeMicaId = null;

    // A. Esconder IMEDIATAMENTE o contentor de bot√µes de edi√ß√£o (+ Micas)
    const dossieEditActions = document.getElementById('dossie-edit-actions');
    if (dossieEditActions) {
        dossieEditActions.style.display = 'none';
    }

    // B. Resetar o bot√£o de altern√¢ncia "Editar"
    const dossieEditBtn = document.getElementById('toggle-dossie-edit-btn');
    if (dossieEditBtn) {
        dossieEditBtn.textContent = "Editar";
        dossieEditBtn.style.display = 'block';
        dossieEditBtn.style.color = "";
        dossieEditBtn.style.borderColor = "";
        dossieEditBtn.style.backgroundColor = "";
    }
    
    // C. Esconder bot√µes de navega√ß√£o interna
    const micaBackBtn = document.getElementById('mica-back-btn');
    const micaAddBtn = document.getElementById('mica-add-content-btn');
    if (micaBackBtn) micaBackBtn.style.display = 'none';
    if (micaAddBtn) micaAddBtn.style.display = 'none';

    // D. Limpar o t√≠tulo visual
    const dossieTitle = document.getElementById('dossie-view-title');
    if (dossieTitle) dossieTitle.textContent = "Micas";

    // E. Limpar a lista visual para n√£o mostrar as micas da nota anterior
    const dossieContainer = document.getElementById('dossie-list-container');
    if (dossieContainer) dossieContainer.innerHTML = '';
}




async function showReferencesPanel(entityId, entityName, entityType, anexoId = null) {
    // --- CORRE√á√ÉO: For√ßar altura e reset no Mobile ao abrir ---
    if (window.innerWidth <= 768) {
        const p = document.getElementById('references-panel');
        if (p) {
            // Remove qualquer estilo de arrasto anterior
            p.classList.remove('is-dragging');
            p.style.transition = "transform 0.3s ease, height 0.3s ease";
            
            // Define a altura padr√£o se estiver muito pequena ou fechada
            if (!p.style.height || parseInt(p.style.height) < 100) {
                p.style.height = "60vh"; 
            }
            // For√ßa o transform para garantir que sobe
            p.style.transform = "translateY(0)";
        }
        
        // Fecha o teclado se estiver aberto
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
            document.activeElement.blur();
        }
    }
    // 2. Gravar estado anterior e limpar UI
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI(); 

    // --- MODO AQU√ÅRIO ---
    const aquariumEnv = document.getElementById('aquarium-environment');
    const refPanel = document.getElementById('references-panel');

    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        refPanel.classList.add('aquarium-overlay-mode');
        aquariumEnv.appendChild(refPanel);

        aquariumEnv.classList.add('right-open');


    } else {
        refPanel.classList.remove('aquarium-overlay-mode');
        const mainContainer = document.querySelector('.notebook-container');
        if (mainContainer && refPanel.parentElement !== mainContainer) {
            mainContainer.appendChild(refPanel);
        }
    }

    // 3. Definir Entidade Ativa
    activeReferenceEntity = { 
        id: entityId || entityName, 
        type: entityType, 
        name: entityName 
    };

    // 4. Mostrar Painel
    notebookContainer.classList.add('references-panel-visible');

    // 5. Reset de Abas (Abre sempre no Puzzle)
    document.querySelectorAll('#ref-tabs button').forEach(b => b.classList.remove('active'));
    const puzzleTab = document.querySelector('[data-ref-tab="puzzle"]');
    if (puzzleTab) puzzleTab.classList.add('active');

    const contentPuzzle = document.getElementById('ref-content-puzzle');
    const contentRefs = document.getElementById('ref-content-references');
    
    if (contentPuzzle) contentPuzzle.style.display = 'flex';
    if (contentRefs) contentRefs.style.display = 'none';

    // 6. CONFIGURAR T√çTULO E DESCRI√á√ÉO
    const titleEl = document.getElementById('references-panel-title');
    const descElement = document.getElementById('references-panel-description');
    
    // Define t√≠tulo inicial padr√£o
    if (titleEl) titleEl.textContent = `Refer√™ncias: ${entityName}`;
    
    // --- L√ìGICA DO √çCONE DE MARCADOR (üîñ) ---
    // Se for texto b√≠blico, verifica se tem marcadores para adicionar o √≠cone
    if (entityType === 'textobiblico') {
        // Tenta obter ID real se n√£o tiver
        let realId = entityId;
        if (!realId) {
            // Se veio sem ID (ex: clique no texto da nota), tenta encontrar no cache ou BD
            const cached = allEntities['textobiblico']?.find(e => e.nome === entityName);
            realId = cached ? cached.id : null;
        }

        if (realId) {
            // Importa√ß√£o din√¢mica para garantir acesso
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            // Busca o documento para ver os marcadores
            try {
                const docRef = doc(db, 'textosbiblicos', realId);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    const marcadores = data.marcadoresAssociados || {};
                    const hasBookmarks = Object.keys(marcadores).length > 0;
                    
                    if (hasBookmarks) {
                        titleEl.textContent = `Refer√™ncias: üîñ ${entityName}`;
                    }
                    
                    // Atualiza o ID global caso estivesse em falta
                    activeReferenceEntity.id = realId;
                }
            } catch (e) {
                console.warn("Erro ao verificar marcadores:", e);
            }
        }
    }

    // 7. CONFIGURAR BOT√ïES
    const editBtn = document.getElementById('references-edit-btn');
    const anchorBtn = document.getElementById('references-anchor-btn'); 
    const wolBtn = document.getElementById('references-wol-btn');
    const bookmarkBtn = document.getElementById('references-bookmark-btn');
    
    if (editBtn) editBtn.style.display = 'block';
    if (wolBtn) wolBtn.style.display = 'none';
    if (bookmarkBtn) bookmarkBtn.style.display = 'none';

    const noAnchorTypes = ['textobiblico', 'topico', 'destaque', 'marcadores', 'tag'];

    if (anchorBtn) {
        if (noAnchorTypes.includes(entityType)) {
            anchorBtn.style.display = 'none'; 
        } else {
            anchorBtn.style.display = 'block'; 
        }
    }

    // 8. ROTEAMENTO DE CONTE√öDO
    if (entityType === 'topico' || entityType === 'textobiblico') {
        if (entityType === 'textobiblico') {
            if (editBtn) editBtn.style.display = 'none'; 
            if (wolBtn) wolBtn.style.display = 'block';
            if (bookmarkBtn) bookmarkBtn.style.display = 'block';
            
            if (descElement) {
                descElement.innerHTML = `<em>A consultar biblioteca...</em>`;
                const texto = await fetchBibleText(entityName);
                descElement.innerHTML = texto ? `<div style="color:var(--text-color); font-size:0.95em;">"${texto}"</div>` : `<em>Texto n√£o dispon√≠vel.</em>`;
            }
        }
        renderTopicResultsList(entityId, entityType); 
    } 
    else {
        if (entityType === 'tag') {
            showTagReferencesPanel(entityName); 
            return;
        }

        renderUniversalTextSearch(entityName);
        
        if (descElement) {
            try {
                const coll = getCollectionFromType(entityType);
                if (coll && entityId) {
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    const docSnap = await getDoc(doc(db, coll, entityId));
                    if (docSnap.exists()) {
                        descElement.textContent = docSnap.data().descricao || 'Sem descri√ß√£o definida.';
                    } else {
                        descElement.textContent = 'Sem descri√ß√£o.';
                    }
                }
            } catch(e) { 
                descElement.textContent = 'Sem descri√ß√£o.'; 
            }
        }
    }

    loadPuzzleData(entityId, entityType);
}



// 2. BUSCAR TEXTO NA BIBLIOTECA P√öBLICA (COMUM)
async function fetchBibleText(fullReference) {
    try {
        const q = query(collection(db, 'bible_verses_public'), where('nome', '==', fullReference));
        const snap = await getDocs(q);
        if (!snap.empty) {
            return snap.docs[0].data().texto;
        }
    } catch (e) { console.error("Erro na bibl. p√∫blica:", e); }
    return null;
}

// 3. GRAVA√á√ÉO P√öBLICA + PRIVADA
async function saveTextToFirestore(name, text) {
    try {
        // Grava no P√∫blico (Texto para todos)
        const publicRef = collection(db, 'bible_verses_public');
        const qPub = query(publicRef, where('nome', '==', name));
        const snapPub = await getDocs(qPub);
        if (snapPub.empty) {
            await addDoc(publicRef, { nome: name, texto: text, contribuidoPor: auth.currentUser.uid, createdAt: serverTimestamp() });
        }

        // Grava no Privado (Cria entrada para o utilizador ter o seu pr√≥prio Puzzle)
        const userColl = collection(db, 'textosbiblicos');
        const qUser = query(userColl, where('nome', '==', name), where('userId', '==', auth.currentUser.uid));
        const snapUser = await getDocs(qUser);
        if (snapUser.empty) {
            await addDoc(userColl, { nome: name, descricao: text, userId: auth.currentUser.uid, createdAt: serverTimestamp(), referencias: {} });
        }
        
        if (typeof fetchAllEntities === 'function') fetchAllEntities();
    } catch (e) { console.error("Erro ao salvar:", e); }
}



window.manualInsertBibleText = async function(name) {
    const text = prompt(`Copie o texto da B√≠blia Online e cole aqui (${name}):`);
    if (text && text.trim().length > 0) {
        await saveTextToFirestore(name, text.trim());
        showReferencesPanel(null, name, 'textobiblico');
    }
};


async function hideReferencesPanel() {
    const refPanel = document.getElementById('references-panel');
    const mainContainer = document.querySelector('.notebook-container');
    
    // --- CORRE√á√ÉO AQUI: Definir a vari√°vel que faltava ---
    const aquariumEnv = document.getElementById('aquarium-environment'); 
    // ----------------------------------------------------

    // 1. Grava o puzzle anterior se estivesse em modo edi√ß√£o
    if (typeof forceSaveAndClosePuzzleMode === 'function') {
        await forceSaveAndClosePuzzleMode();
    }

    // 2. RESET DO DOSSI√â
    window.isDossieEditMode = false;
    window.activeMicaId = null; 
    if (typeof window.renderDossie === 'function') {
        window.renderDossie();
    }

    // --- CORRE√á√ÉO DO AQU√ÅRIO ---
    // Verifica se estava em modo Overlay (Aqu√°rio)
    if (refPanel.classList.contains('aquarium-overlay-mode')) {
        // Remove a classe que for√ßa a posi√ß√£o fixa na direita
        refPanel.classList.remove('aquarium-overlay-mode');
        
        // --- AGORA J√Å FUNCIONA: Remove a margem do texto ---
        if (aquariumEnv) {
            aquariumEnv.classList.remove('right-open');
        }
        
        // Devolve o painel √† estrutura principal do site (sai do #aquarium-environment)
        if (mainContainer && !mainContainer.contains(refPanel)) {
            mainContainer.appendChild(refPanel);
        }
    }
    // ---------------------------

    // 3. L√≥gica padr√£o de fecho (CSS)
    notebookContainer.classList.remove('references-panel-visible');
    
    // Limpar Vers√≠culo Selecionado
    currentlyOpenVerseName = null;
    document.querySelectorAll('.bible-grid-btn.active-verse').forEach(btn => {
        btn.classList.remove('active-verse');
    });

    const descriptionElement = document.getElementById('references-panel-description');
    if (descriptionElement) {
        descriptionElement.textContent = '';
    }

    // Ajuste de altura para Mobile (Reset do arraste)
    if (window.innerWidth <= 768 && refPanel) {
        setTimeout(() => {
            refPanel.style.height = "60vh"; 
        }, 400);
    }
}

 function generateReferenceContext(noteContent, entityName) {
    // 1. Criar um contentor tempor√°rio
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = noteContent;

    // SEPARADOR M√ÅGICO
    const SEPARATOR = " ||| "; 

    // 2. ESTRAT√âGIA DE INJE√á√ÉO MELHORADA
    
    // A. Substituir quebras de linha manuais (<br>) pelo separador
    const brs = tempDiv.querySelectorAll('br');
    brs.forEach(br => {
        br.replaceWith(document.createTextNode(SEPARATOR));
    });

    // B. Injetar separador no IN√çCIO de cada bloco
    // Isto resolve o problema "fiel[NOVA LINHA]David". 
    // Ao p√¥r no in√≠cio da div do "David", garantimos "fiel ||| David".
    const blockTags = 'p, div, li, h1, h2, h3, h4, h5, h6, tr, td, th, blockquote, ul, ol, pre, section, article';
    const blocks = tempDiv.querySelectorAll(blockTags);
    
    blocks.forEach(el => {
        // Prepend (Inserir antes do primeiro filho)
        el.insertBefore(document.createTextNode(SEPARATOR), el.firstChild);
        
        // (Opcional) Tamb√©m adicionar ao fim para garantir isolamento total
        el.appendChild(document.createTextNode(SEPARATOR));
    });

    // 3. EXTRAIR TEXTO (Agora "David" est√° protegido por separadores)
    let plainText = tempDiv.textContent;
    
    // Normalizar espa√ßos
    plainText = plainText.replace(/\s+/g, ' ');

    // 4. ENCONTRAR A ENTIDADE
    const lowerText = plainText.toLowerCase();
    const lowerEntity = entityName.toLowerCase();
    const position = lowerText.indexOf(lowerEntity);

    if (position === -1) {
        return '<p style="font-style: italic; opacity: 0.7;">Contexto n√£o encontrado.</p>';
    }

    // 5. DELIMITAR IN√çCIO (Recuar at√© Pontua√ß√£o ou Separador)
    const textBefore = plainText.substring(0, position);
    const lastSeparatorIndex = textBefore.lastIndexOf(SEPARATOR);
    
    // Regex para √∫ltima pontua√ß√£o (., !, ?) seguida de espa√ßo
    const punctuationMatch = textBefore.match(/([.!?])\s+(?!.*[.!?])/); 
    const lastPunctuationIndex = punctuationMatch ? punctuationMatch.index + 1 : -1;

    let start = 0;
    // Quem estiver mais perto da palavra (maior √≠ndice) ganha
    if (lastSeparatorIndex > lastPunctuationIndex) {
        start = lastSeparatorIndex + SEPARATOR.length;
    } else if (lastPunctuationIndex > -1) {
        start = lastPunctuationIndex + 1;
    }

    // 6. DELIMITAR FIM (Avan√ßar at√© Pontua√ß√£o ou Separador)
    // AQUI √â QUE A M√ÅGICA ACONTECE PARA O SEU EXEMPLO
    
    // A. Separador depois da palavra
    let nextSeparatorIndex = plainText.indexOf(SEPARATOR, position + entityName.length);
    if (nextSeparatorIndex === -1) nextSeparatorIndex = plainText.length;

    // B. Pontua√ß√£o depois da palavra
    const textAfter = plainText.substring(position + entityName.length);
    const nextPunctuationMatch = textAfter.match(/[.!?]/);
    
    let nextPunctuationIndex = plainText.length;
    if (nextPunctuationMatch) {
        nextPunctuationIndex = position + entityName.length + nextPunctuationMatch.index + 1;
    }

    // Regra: O que aparecer PRIMEIRO corta a frase.
    // No seu exemplo: N√£o h√° pontua√ß√£o, mas h√° o SEPARATOR do "David". O SEPARATOR ganha.
    let end = Math.min(nextSeparatorIndex, nextPunctuationIndex);

    // 7. CORTE FINAL E LIMPEZA
    let snippet = plainText.substring(start, end).trim();

    // Remove qualquer lixo de separador que tenha sobrado
    snippet = snippet.split(SEPARATOR)[0].trim(); // Seguran√ßa extra
    snippet = snippet.replace(/\|\|\|/g, '').trim();

    // Corte de seguran√ßa para textos gigantes
    if (snippet.length > 250) {
        const localPos = snippet.toLowerCase().indexOf(lowerEntity);
        const cutStart = Math.max(0, localPos - 60);
        const cutEnd = Math.min(snippet.length, localPos + entityName.length + 100);
        snippet = (cutStart > 0 ? "..." : "") + snippet.substring(cutStart, cutEnd) + "...";
    }

    // 8. HIGHLIGHT
    const safeEntity = entityName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedText = snippet.replace(
        new RegExp(`(${safeEntity})`, 'gi'), 
        `<mark>$1</mark>`
    );

    return `<p>${highlightedText}</p>`;
}

// ====================================================================
// FUN√á√ÉO: CONVERTER SELE√á√ÉO EM CART√ÉO WEB (Com Timeout de 10s)
// ====================================================================
async function convertSelectionToUrlCard() {
    let selection = window.getSelection();
    
    // --- 1. SMART SELECT (Corre√ß√£o para o seu problema) ---
    // Se n√£o houver nada selecionado (cursor apenas a piscar),
    // ou se estivermos dentro de um link, vamos tentar selecionar o elemento todo.
    
    const anchorNode = selection.anchorNode ? (selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode) : null;
    const linkElement = anchorNode ? anchorNode.closest('a') : null;

    if (linkElement) {
        // Se o cursor estiver dentro de um <a>, seleciona o <a> inteiro
        const range = document.createRange();
        range.selectNode(linkElement);
        selection.removeAllRanges();
        selection.addRange(range);
    } 
    else if (selection.isCollapsed && anchorNode) {
        // Se for texto solto (n√£o link) e n√£o houver sele√ß√£o,
        // tenta selecionar a "palavra" inteira onde o cursor est√° (o URL gigante)
        if (selection.modify) {
            selection.modify('move', 'backward', 'word');
            selection.modify('extend', 'forward', 'word');
        }
    }
    // -----------------------------------------------------

    if (!selection.rangeCount) return;

    // Guardar o texto para usar como t√≠tulo se necess√°rio
    const userSelectedText = selection.toString().trim();

    // 2. Obter URL
    let url = userSelectedText;
    
    // Se acab√°mos de selecionar um elemento <a>, usamos o href real
    if (selection.anchorNode) {
        const parentA = selection.anchorNode.parentElement.closest('a');
        if (parentA) url = parentA.href;
    }

    if (!url || !url.includes('.')) { 
        alert("Selecione um link v√°lido primeiro."); 
        return; 
    }

    if (!url.startsWith('http')) url = 'https://' + url;

    // 3. Criar Placeholder
    const cardId = `card_${Date.now()}`;
    
    // NOTA: Adicionamos um espa√ßo &nbsp; no fim para o cursor poder sair do card
    const cardHtml = `
        <div class="url-card-widget" id="${cardId}" draggable="true" contenteditable="false" data-original-url="${url}">
            <div class="url-card-loading">
                <div class="spinner" style="width:20px; height:20px; border-width:2px; margin-right:10px;"></div>
                A gerar...
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        </div><span>&nbsp;</span>
    `;

    // 4. SUBSTITUI√á√ÉO TOTAL
    // Como garantimos a sele√ß√£o no passo 1, este comando vai apagar o texto do link
    // e colocar o card no lugar dele.
    document.execCommand('insertHTML', false, cardHtml);
    
    // Esconder popup se estiver aberto
    if(document.getElementById('selection-popup')) 
        document.getElementById('selection-popup').style.display = 'none';

    // --- FUN√á√ïES AUXILIARES (Mant√™m-se iguais) ---
    const getRandomImage = () => {
        const images = [
            "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=400&q=80",
            "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=400&q=80",
            "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=400&q=80",
            "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&q=80",
            "https://images.unsplash.com/photo-1506259091721-347f7d3bbcff?w=400&q=80"
        ];
        return images[Math.floor(Math.random() * images.length)];
    };

    const formatFallbackTitle = (link) => {
        if (userSelectedText && userSelectedText !== link && !userSelectedText.startsWith('http')) {
            return userSelectedText;
        }
        try {
            const urlObj = new URL(link);
            if (urlObj.hostname.includes('jw.org') || urlObj.hostname.includes('wol.jw')) {
                return "Publica√ß√£o JW";
            }
            return urlObj.hostname.replace('www.', '');
        } catch (e) { return "Liga√ß√£o Externa"; }
    };

    const updateCardUI = (title, image, logo, publisher) => {
        const cardEl = document.getElementById(cardId);
        if (!cardEl) return;

        let displayTitle = title;
        if (!displayTitle || displayTitle.toLowerCase() === 'finder' || displayTitle.toLowerCase() === 'watchtower online library') {
            displayTitle = null;
        }
        if (!displayTitle && userSelectedText && !userSelectedText.startsWith('http')) {
            displayTitle = userSelectedText;
        }
        if (!displayTitle) {
            displayTitle = formatFallbackTitle(url);
        }

        cardEl.innerHTML = `
            <div class="url-card-image" style="background-image: url('${image}');"></div>
            <div class="url-card-info">
                <div class="url-card-title">${displayTitle}</div>
                <div class="url-card-domain">
                    <img src="${logo}" style="width:12px; height:12px; vertical-align:middle; margin-right:4px; border-radius:50%;">
                    ${publisher}
                </div>
            </div>
            <div class="url-card-close" title="Reverter para texto">‚úï</div>
        `;
        saveNote();
    };

    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
    const fetchPromise = fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`).then(res => res.json());

    try {
        const data = await Promise.race([fetchPromise, timeoutPromise]);
        const meta = (data.status === 'success' && data.data) ? data.data : {};
        
        const finalTitle = meta.title;
        const finalImage = meta.image?.url || getRandomImage();
        const finalPublisher = meta.publisher || new URL(url).hostname;
        const finalLogo = meta.logo?.url || 'https://cdn-icons-png.flaticon.com/128/1006/1006771.png';

        updateCardUI(finalTitle, finalImage, finalLogo, finalPublisher);
    } catch (err) {
        const fallbackTitle = formatFallbackTitle(url);
        const fallbackImg = getRandomImage();
        const domain = new URL(url).hostname;
        const fallbackLogo = 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
        updateCardUI(fallbackTitle, fallbackImg, fallbackLogo, domain);
    }
}

// --- L√ìGICA DO EDITOR RICO E TAGS ---

function showTagPopup(query) {
    const filteredTags = allTags.filter(tag => tag.nome.toLowerCase().includes(query.toLowerCase()));
    tagSuggestionList.innerHTML = '';
    if (filteredTags.length > 0) {
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag.nome;
            li.dataset.tagNome = tag.nome;
            tagSuggestionList.appendChild(li);
        });
    } else if (query) {
        const li = document.createElement('li');
        li.innerHTML = `Criar nova tag: "<strong>${query}</strong>"`;
        li.dataset.tagNome = query;
        tagSuggestionList.appendChild(li);
    } else {
         hideTagPopup(); return;
    }
    const rect = currentTagQueryRange.getBoundingClientRect();
    tagSuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
    tagSuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
    tagSuggestionPopup.style.display = 'block';
    isTagPopupOpen = true;
    tagSuggestionList.firstChild.classList.add('selected');
}

 function hideTagPopup() {
    tagSuggestionPopup.style.display = 'none';
    isTagPopupOpen = false;
    currentTagQueryRange = null; // Importante: limpa o range para evitar reaberturas acidentais
}


function navigateTagSuggestions(key) {
    const items = Array.from(tagSuggestionList.children);
    if(items.length === 0) return;
    const selected = tagSuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

async function commitTagSelection() {
    const selectedLi = tagSuggestionList.querySelector('.selected');
    if (!selectedLi) {
        hideTagPopup();
        return;
    }

    const tagName = selectedLi.dataset.tagNome.trim();
    if (!tagName) { 
        hideTagPopup(); 
        return; 
    }

    // Verifica/Cria a tag no banco de dados
    let tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
    if (!tagExists) await createNewTag(tagName);

    // Insere no editor
    insertTagIntoEditor(tagName);
    
    // FOR√áA O FECHO IMEDIATO
    hideTagPopup();
}

async function createNewTag(tagName) {
    try {
        // Verifica se a tag j√° existe na lista LOCAL (que j√° √© filtrada por user)
        // para evitar chamadas desnecess√°rias √† base de dados.
        const tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
        
        if (tagExists) {
            return;
        }

        const tagsCollection = collection(db, 'tags');
        const newTagRef = await addDoc(tagsCollection, { 
            nome: tagName, 
            userId: auth.currentUser.uid, // GRAVA√á√ÉO DO USER ID
            createdAt: serverTimestamp() 
        });
        
        // Atualiza o cache local imediatamente
        allTags.push({ id: newTagRef.id, nome: tagName });

    } catch (error) { 
        console.error("Erro ao criar nova tag:", error); 
    }
}


async function fetchAllTags() {
    if (!auth.currentUser) return;
    try {
        const tagsCollection = collection(db, 'tags');
        // FILTRO OBRIGAT√ìRIO
        const q = query(tagsCollection, where('userId', '==', auth.currentUser.uid));
        
        const tagsSnapshot = await getDocs(q);
        
        // Limpa e reconstr√≥i o array global
        allTags = tagsSnapshot.docs.map(doc => ({
            id: doc.id,
            nome: doc.data().nome || doc.data().name 
        })).filter(tag => tag.nome); // Filtra tags sem nome
        
    } catch (error) {
        console.error("Erro ao carregar tags:", error);
    }
}


function insertTagIntoEditor(tagName) {
    if (!currentTagQueryRange) return;

    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = `#${tagName}`;
    tagSpan.setAttribute('contenteditable', 'false'); 
    const spaceNode = document.createTextNode('\u00A0');
    currentTagQueryRange.deleteContents();
    currentTagQueryRange.insertNode(spaceNode); 
    currentTagQueryRange.insertNode(tagSpan);  
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
    currentTagQueryRange = null;
}



// ============================================================
// L√ìGICA DE NAVEGA√á√ÉO MOBILE
// ============================================================

// ============================================================
// 3. BOT√ÉO VOLTAR (CORRIGIDO: SEM CLONAR ELEMENTO)
// ============================================================
const activeBackBtn = document.getElementById('back-btn');

if (activeBackBtn) {
    // Em vez de substituir o bot√£o (o que quebrava a refer√™ncia), 
    // atribu√≠mos diretamente o novo comportamento ao onclick.
    activeBackBtn.onclick = (e) => {
        if (e) e.preventDefault();

        // A√ß√£o a executar DEPOIS de gravar (Navegar para tr√°s)
        const goBackAction = () => {
            
            // CASO 1: Navega√ß√£o Profunda (Pastas ou Listas/B√≠blia)
            if (navigationStack.length > 0) {
                // Remove o √∫ltimo n√≠vel da pilha
                navigationStack.pop();
                
                // Se estivermos na aba 'note' (Pastas), sair da pasta fecha a nota.
                // Na aba 'lists' (B√≠blia), a nota pode ficar aberta.
                if (currentTab === 'note') {
                    selectedNoteId = null;
                }
                
                // Mobile: Se a pilha ficar vazia, voltamos ao Painel Esquerdo
                if (navigationStack.length === 0 && window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.remove('mobile-view-editor');
                }
                
                // Atualiza a vista mantendo o editor aberto ('true')
                updateNavigationView(true);
            } 
            
            // CASO 2: Sair do modo "Partilha" para o modo "Local"
            else if (currentViewMode === 'shared') {
                if (typeof window.switchFolderView === 'function') {
                    window.switchFolderView('local');
                }
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                }
            }
        };

        // --- O GUARDI√ÉO ---
        // Verifica se h√° algo por gravar. Se houver, grava e depois executa o goBackAction.
        if (typeof navigateWithUnsavedCheck === 'function') {
            navigateWithUnsavedCheck(goBackAction);
        } else {
            // Fallback se a fun√ß√£o de seguran√ßa n√£o existir
            goBackAction();
        }
    };
}

// 4. Bot√£o VOLTAR do Editor (Direita -> Meio)
 if (mobileBackBtn) {
    // Removemos ouvintes antigos para evitar duplica√ß√£o
    const newMobileBtn = mobileBackBtn.cloneNode(true);
    mobileBackBtn.parentNode.replaceChild(newMobileBtn, mobileBackBtn);

    newMobileBtn.addEventListener('click', async (e) => {
        e.preventDefault(); 
        
        // 1. Grava o estado atual da nota antes de sair
        if (typeof saveNote === 'function' && selectedNoteId) {
            await saveNote(true); 
        }

        // 2. Ativa o escudo para impedir grava√ß√µes acidentais durante o fecho
        isClosingNote = true; 

        // 3. Limpa timers pendentes
        if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);

        const idToScroll = selectedNoteId;
        selectedNoteId = null;

        // 4. Limpa o visual do editor
        const titleInput = document.getElementById('note-title-input');
        const contentEditor = document.getElementById('note-content-editor');
        if (titleInput) titleInput.value = "";
        if (contentEditor) contentEditor.innerHTML = "";

        // 5. TROCA DE VISTAS (CORRIGIDA PARA FLASH)
        const container = document.querySelector('.notebook-container');
        if (container) container.classList.remove('middle-panel-collapsed');
        
        // Sai sempre do editor
        document.body.classList.remove('mobile-view-editor');

        if (currentViewMode === 'flash') {
            // --- MODO FLASH: VAI PARA A COLUNA 1 ---
            // Remover a classe 'mobile-view-middle' faz o CSS mostrar o #left-panel
            document.body.classList.remove('mobile-view-middle');
            
            // Scroll na lista da ESQUERDA
            if (idToScroll) {
                setTimeout(() => {
                    const noteItem = document.querySelector(`#left-panel-list .list-item[data-id="${idToScroll}"]`);
                    if (noteItem) noteItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 150);
            }
        } else {
            // --- MODO NORMAL: VAI PARA A COLUNA 2 ---
            document.body.classList.add('mobile-view-middle');

            // Scroll na lista do MEIO
            if (idToScroll) {
                setTimeout(() => {
                    const noteItem = document.querySelector(`#file-list .list-item[data-id="${idToScroll}"]`);
                    if (noteItem) noteItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 150);
            }
        }

        // 6. ATUALIZA OS BOT√ïES FLUTUANTES
        updateMobileFABVisibility();
    });
}


// ====================================================================
// MOTOR DO CALEND√ÅRIO (Agenda Firebase)
// ====================================================================

// 1. Delegar eventos globais no Editor (porque o HTML √© din√¢mico)
noteContentEditor.addEventListener('click', (e) => {

    // A. Clique no bot√£o de defini√ß√µes (‚öôÔ∏è)
    if (e.target.closest('.cal-settings')) {
        e.preventDefault(); e.stopPropagation(); // Importante para n√£o fechar logo
        
        const widget = e.target.closest('.jwn-calendar-widget');
        const menu = widget.querySelector('.cal-settings-menu');
        
        // Alterna a classe que mostra/esconde
        menu.classList.toggle('visible');
        return;
    }

    // B. Mudar Visualiza√ß√£o (Semana/M√™s/Ano)
    if (e.target.classList.contains('cal-view-btn')) {
        e.preventDefault(); e.stopPropagation();
        
        const widget = e.target.closest('.jwn-calendar-widget');
        
        // Atualiza visual dos bot√µes
        widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        // Atualiza estado e re-renderiza
        widget.dataset.view = e.target.dataset.view;
        renderCalendarUI(widget);
        
        // Fecha o menu depois de escolher
        widget.querySelector('.cal-settings-menu').classList.remove('visible');
        
        // Grava a prefer√™ncia de vista na nota
        saveNote();
        return;
    }

    // C. Navega√ß√£o (‚óÄ / ‚ñ∂)
    else if (e.target.closest('.cal-prev') || e.target.closest('.cal-next')) {
        const widget = e.target.closest('.jwn-calendar-widget');
        const isNext = e.target.closest('.cal-next');
        changeCalendarDate(widget, isNext ? 1 : -1);
    }

    // D. Clique num Dia (Adicionar Tarefa)
    else if (e.target.classList.contains('cal-day') && !e.target.classList.contains('empty')) {
        const day = e.target.dataset.day;
        const widget = e.target.closest('.jwn-calendar-widget');
        const month = parseInt(widget.dataset.month); // 0-11
        const year = parseInt(widget.dataset.year);
        
        // Formata data ISO (YYYY-MM-DD)
        const dateObj = new Date(year, month, parseInt(day));
        // Ajuste fuso hor√°rio simples
        const dateISO = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

        openCalendarModal(dateISO, widget);
    }
});

// 2. Fun√ß√£o Principal de Renderiza√ß√£o
async function renderCalendarUI(widget) {
    if (!widget) return;

    const view = widget.dataset.view || 'month';
    const month = parseInt(widget.dataset.month);
    const year = parseInt(widget.dataset.year);
    const grid = widget.querySelector('.cal-grid');
    const title = widget.querySelector('.cal-title');

    // Limpa a grelha visualmente
    grid.innerHTML = ''; 

    const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    // --------------------------------------------------------
    // VISTA: M√äS (Padr√£o)
    // --------------------------------------------------------
    if (view === 'month') {
        title.textContent = `${monthNames[month]} ${year}`;
        
        // Reset do CSS da grelha para 7 colunas
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(7, 1fr)";
        grid.style.gap = "2px";

        // 1. Carregar tarefas do Firebase
        const tasksMap = await fetchTasksForMonth(year, month);

        // Cabe√ßalhos
        const days = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        days.forEach(d => grid.innerHTML += `<div class="cal-day-header">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // Espa√ßos vazios
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div class="cal-day empty"></div>`;
        }

        // Dias
        for (let i = 1; i <= daysInMonth; i++) {
            // FORMATA√á√ÉO CR√çTICA (YYYY-MM-DD)
            const dayStr = String(i).padStart(2, '0');
            const monthStr = String(month + 1).padStart(2, '0');
            const dateKey = `${year}-${monthStr}-${dayStr}`; 
            
            const isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear());
            const hasTask = tasksMap[dateKey] === true;

            const div = document.createElement('div');
            div.className = `cal-day ${isToday ? 'today' : ''} ${hasTask ? 'has-task' : ''}`;
            div.textContent = i;
            div.dataset.day = i;
            
            if (hasTask) {
                div.title = "Ver tarefas";
            }
            
            grid.appendChild(div);
        }
    } 
    
    // --------------------------------------------------------
    // VISTA: ANO (Sele√ß√£o de Meses)
    // --------------------------------------------------------
    else if (view === 'year') {
        title.textContent = `${year}`;
        
        // Ajusta grelha para 3 colunas (4 linhas de meses)
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(3, 1fr)";
        grid.style.gap = "10px";
        
        monthNames.forEach((mName, idx) => {
            const btn = document.createElement('div');
            btn.className = 'cal-day'; 
            btn.style.padding = "15px 0"; // Bot√µes maiores
            btn.textContent = mName.substring(0, 3); // Jan, Fev...
            
            // Marca o m√™s atual se estivermos no ano corrente
            const now = new Date();
            if (now.getFullYear() === year && now.getMonth() === idx) {
                btn.classList.add('today');
            }

            btn.onclick = (e) => {
                e.stopPropagation();
                // Muda para a vista do m√™s selecionado
                widget.dataset.month = idx;
                widget.dataset.view = 'month';
                
                // Atualiza visual dos bot√µes de topo
                widget.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
                widget.querySelector('[data-view="month"]').classList.add('active');
                
                renderCalendarUI(widget);
            };
            grid.appendChild(btn);
        });
    }

    // --------------------------------------------------------
    // VISTA: SEMANA (Simplificada)
    // --------------------------------------------------------
    else if (view === 'week') {
        title.textContent = `Semana em ${monthNames[month]}`;
        
        grid.style.display = "flex";
        grid.style.flexDirection = "column";
        grid.style.gap = "5px";

        // Carrega tarefas para mostrar resumo
        const tasksMap = await fetchTasksForMonth(year, month);

        // L√≥gica: Mostra a semana atual (se for o m√™s corrente) ou a primeira semana
        let startDay = 1;
        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth()) {
            // Se for hoje, tenta come√ßar a semana no Domingo anterior
            startDay = today.getDate() - today.getDay(); 
            if (startDay < 1) startDay = 1;
        }

        const endDay = Math.min(startDay + 6, new Date(year, month + 1, 0).getDate());

        for (let i = startDay; i <= endDay; i++) {
            const dayStr = String(i).padStart(2, '0');
            const monthStr = String(month + 1).padStart(2, '0');
            const dateKey = `${year}-${monthStr}-${dayStr}`;
            const hasTask = tasksMap[dateKey] === true;
            
            // Cria uma linha por dia
            const row = document.createElement('div');
            row.className = 'cal-day'; // Reusa estilo base
            row.style.width = "100%";
            row.style.textAlign = "left";
            row.style.padding = "8px 15px";
            row.style.display = "flex";
            row.style.justifyContent = "space-between";
            
            // Conte√∫do
            let taskIndicator = hasTask ? '<span style="color:#e74c3c;">‚Ä¢ Tarefas</span>' : '<span style="color:#666; font-size:0.8em;">Vazio</span>';
            
            row.innerHTML = `<span>Dia ${i}</span> ${taskIndicator}`;
            row.dataset.day = i; // Permite clicar para abrir modal

            grid.appendChild(row);
        }
    }
}


// 3. Navega√ß√£o
function changeCalendarDate(widget, direction) {
    let m = parseInt(widget.dataset.month);
    let y = parseInt(widget.dataset.year);
    const view = widget.dataset.view;

    if (view === 'year') {
        y += direction;
    } else {
        m += direction;
        if (m > 11) { m = 0; y++; }
        if (m < 0) { m = 11; y--; }
    }

    widget.dataset.month = m;
    widget.dataset.year = y;
    renderCalendarUI(widget);
}

// 4. Integra√ß√£o Firebase (Buscar Tarefas)
async function fetchTasksForMonth(year, month) {
    if (!auth.currentUser) return {};

    // Formata o in√≠cio e fim do m√™s garantindo os zeros (01, 05, etc.)
    // M√™s em JS √© 0-11, por isso somamos 1
    const mStr = String(month + 1).padStart(2, '0');
    const startStr = `${year}-${mStr}-01`;
    const endStr = `${year}-${mStr}-31`;

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'agenda'),
            where('userId', '==', auth.currentUser.uid),
            where('data', '>=', startStr),
            where('data', '<=', endStr)
        );

        const snapshot = await getDocs(q);
        const map = {};
        
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.data) {
                map[d.data] = true; // Ex: map['2026-01-12'] = true
            }
        });
        
        return map;
    } catch (e) {
        console.error("Erro ao buscar tarefas:", e);
        return {};
    }
}

// 5. Modal de Tarefas
let currentCalendarWidget = null; 

async function openCalendarModal(dateISO, widget) {
    const modal = document.getElementById('calendar-task-modal');
    const displaySpan = document.getElementById('cal-selected-date-display');
    const isoInput = document.getElementById('cal-selected-date-iso');
    const descInput = document.getElementById('cal-task-desc');
    const existingList = document.getElementById('cal-existing-tasks');
    const saveBtn = document.getElementById('cal-save-task-btn');

    // Seguran√ßa: Se n√£o encontrar os elementos, sai sem erro
    if (!modal || !saveBtn) return;

    // 1. Garante que o modal est√° no DOM (Body) e vis√≠vel
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "10000000"; // Garante que fica no topo

    currentCalendarWidget = widget;
    displaySpan.textContent = dateISO; 
    isoInput.value = dateISO;
    descInput.value = '';
    existingList.innerHTML = 'Carregando...';
    
    descInput.focus();

    // 2. Carregar tarefas existentes desse dia
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'agenda'),
            where('userId', '==', auth.currentUser.uid),
            where('data', '==', dateISO)
        );
        const snap = await getDocs(q);
        
        existingList.innerHTML = '';
        if (snap.empty) {
            existingList.innerHTML = '<small style="color:#888;">Sem tarefas.</small>';
        } else {
            snap.forEach(doc => {
                const task = doc.data();
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid var(--border-color)';
                div.style.padding = '5px';
                div.style.fontSize = '0.9em';
                
                // Bot√£o de apagar tarefa individual
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>‚Ä¢ ${task.descricao}</span>
                        <button onclick="window.deleteCalendarTask('${doc.id}', '${dateISO}')" style="color:#e74c3c; background:none; border:none; cursor:pointer;">√ó</button>
                    </div>`;
                existingList.appendChild(div);
            });
        }
    } catch (e) {
        console.error(e);
        existingList.innerHTML = '<small style="color:red;">Erro ao carregar.</small>';
    }

    // 3. GRAVAR NOVA TAREFA (A CORRE√á√ÉO EST√Å AQUI)
    // Em vez de replaceChild, usamos onclick direto. √â mais seguro.
    saveBtn.onclick = async () => {
        const desc = descInput.value.trim();
        if (!desc) return;

        // Feedback visual
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "A gravar...";
        saveBtn.disabled = true;

        try {
            const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await addDoc(collection(db, 'agenda'), {
                data: dateISO,
                descricao: desc,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            
            modal.style.display = 'none';
            
            // Atualiza o widget para mostrar a bolinha vermelha
            if (currentCalendarWidget && typeof renderCalendarUI === 'function') {
                renderCalendarUI(currentCalendarWidget);
            }
            
        } catch (e) {
            console.error(e);
            alert("Erro ao gravar tarefa.");
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        }
    };
}

// Fun√ß√£o auxiliar para apagar tarefa (j√° inclu√≠da na l√≥gica acima)
window.deleteCalendarTask = async function(taskId, dateISO) {
    if(!confirm("Apagar esta tarefa?")) return;
    try {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        await deleteDoc(doc(db, 'agenda', taskId));
        
        // Recarrega o modal para atualizar a lista
        if (currentCalendarWidget) openCalendarModal(dateISO, currentCalendarWidget);
        
        // Atualiza o calend√°rio atr√°s
        renderCalendarUI(currentCalendarWidget);
    } catch(e) {
        console.error(e);
    }
};

// 6. AUTO-INICIAR CALEND√ÅRIOS AO ABRIR NOTA
// Adicione esta chamada dentro da fun√ß√£o displayNote()
// Logo a seguir a noteContentEditor.innerHTML = conteudo...
function refreshAllCalendars() {
    const calendars = document.querySelectorAll('.jwn-calendar-widget');
    calendars.forEach(cal => renderCalendarUI(cal));
}

// --- NOVAS FUN√á√ïES PARA SUGEST√ÉO DE ENTIDADES ---

function showEntityPopup(query) {
    // Junta todas as entidades de todos os tipos num √∫nico array
    const flatEntities = Object.values(allEntities).flat();
    const filteredEntities = flatEntities.filter(entity => 
        entity.nome.toLowerCase().includes(query.toLowerCase())
    );

    entitySuggestionList.innerHTML = '';
    if (filteredEntities.length > 0) {
        filteredEntities.forEach(entity => {
            const li = document.createElement('li');
            // Guardamos os dados da entidade no elemento li
            li.dataset.entityName = entity.nome;
            li.dataset.entityType = entity.tipo;
            
            // Mostra o nome e o tipo para ser mais f√°cil de identificar
            li.innerHTML = `${entity.nome} <span style="font-size: 0.8em;">[${entity.tipo}]</span>`;
            
            entitySuggestionList.appendChild(li);
        });
        
        const rect = currentEntityQueryRange.getBoundingClientRect();
        entitySuggestionPopup.style.top = `${rect.bottom + window.scrollY}px`;
        entitySuggestionPopup.style.left = `${rect.left + window.scrollX}px`;
        entitySuggestionPopup.style.display = 'block';
        isEntityPopupOpen = true;
        entitySuggestionList.firstChild.classList.add('selected');
    } else {
        hideEntityPopup();
    }
}

function hideEntityPopup() {
    entitySuggestionPopup.style.display = 'none';
    isEntityPopupOpen = false;
    currentEntityQueryRange = null;
}

function navigateEntitySuggestions(key) {
    const items = Array.from(entitySuggestionList.children);
    if(items.length === 0) return;
    const selected = entitySuggestionList.querySelector('.selected');
    let currentIndex = items.indexOf(selected);
    if (selected) selected.classList.remove('selected');
    if (key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
    else if (key === 'ArrowUp') currentIndex = (currentIndex - 1 + items.length) % items.length;
    items[currentIndex].classList.add('selected');
}

function insertEntityIntoEditor(entityName, entityType) {
    if (!currentEntityQueryRange) return;

    const entitySpan = document.createElement('span');
    entitySpan.className = 'entity-link';
    entitySpan.dataset.entityType = entityType;
    entitySpan.dataset.entityName = entityName;
    entitySpan.textContent = entityName;
    
    const spaceNode = document.createTextNode('\u00A0');

    // Substitui o texto que o utilizador digitou (ex: @Jeremias)
    currentEntityQueryRange.deleteContents();
    currentEntityQueryRange.insertNode(spaceNode);
    currentEntityQueryRange.insertNode(entitySpan);
    
    // P√µe o cursor a seguir ao espa√ßo, pronto para continuar a escrever
    const selection = window.getSelection();
    const newRange = document.createRange();
    newRange.setStartAfter(spaceNode);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    saveNote();
}

async function commitEntitySelection() {
    const selectedLi = entitySuggestionList.querySelector('.selected');
    if (!selectedLi) return;
    
    const entityName = selectedLi.dataset.entityName;
    const entityType = selectedLi.dataset.entityType;
    
    if (entityName && entityType) {
        // A L√ìGICA DE ATUALIZA√á√ÉO FOI ADICIONADA AQUI
        const collectionName = ENTITY_CONFIG[entityType]?.collection;
        if (collectionName) {
            const allKnownEntities = Object.values(allEntities).flat();
            const entity = allKnownEntities.find(e => e.tipo === entityType && e.nome === entityName);

            if (entity) {
                // Se a entidade foi encontrada no cache, atualiza as suas refer√™ncias no Firestore
                const entityRef = doc(db, collectionName, entity.id);
                try {
                    await updateDoc(entityRef, {
                        [`referencias.${selectedNoteId}`]: true
                    });

                } catch (error) {
                    console.error("Erro ao atualizar refer√™ncia da entidade:", error);
                }
            }
        }

        // Insere o <span> no editor (comportamento visual)
        insertEntityIntoEditor(entityName, entityType);
    }
    
    hideEntityPopup();
}


// ====================================================================
// C√ìDIGO ATUALIZADO COM LOGS
// ====================================================================
function handleTextSelection() {
    const selectionPopup = document.getElementById('selection-popup');
    const insertionPopup = document.getElementById('insertion-popup');
    
    // 1. VERIFICA√á√ÉO DE TEXTO NORMAL
    const selection = window.getSelection();
    let hasStandardSelection = false;
    
    if (selection && selection.rangeCount > 0 && !selection.isCollapsed) {
        const anchorNode = selection.anchorNode;
        // Garante que o elemento faz parte do editor
        const safeNode = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        const isInEditor = noteContentEditor.contains(safeNode);
        
        if (isInEditor && selection.toString().trim().length > 0) {
            hasStandardSelection = true;
        }
    }

    // 2. VERIFICA√á√ÉO DE INPUTS
    let hasInputSelection = false;
    const activeEl = document.activeElement;
    if (activeEl && activeEl.tagName === 'INPUT' && activeEl.classList.contains('mini-note-title-input') && noteContentEditor.contains(activeEl)) {
        if (activeEl.selectionStart !== activeEl.selectionEnd) {
            hasInputSelection = true;
        }
    }

    // =========================================================
    // L√ìGICA DE VISIBILIDADE
    // =========================================================

    // A. ESCONDER MENU DE INSER√á√ÉO (üìò) se houver sele√ß√£o
    if (hasStandardSelection || hasInputSelection) {
        if (insertionPopup) insertionPopup.style.display = 'none';
    }

    // B. MOSTRAR/ESCONDER MENU DE FORMATA√á√ÉO (üîó üé¥)
    if (hasStandardSelection) {
        
        // --- L√ìGICA INTELIGENTE DO BOT√ÉO üé¥ (CART√ÉO WEB) ---
        const btnCard = selectionPopup.querySelector('button[data-action="create-url-card"]');
        if (btnCard) {
            const selectedText = selection.toString().trim();
            
            // 1. Verifica se o texto parece um URL (Regex)
            const urlRegex = /^(https?:\/\/|www\.)|[\w-]+\.[a-z]{2,}(\/.*)?$/i;
            const looksLikeUrl = urlRegex.test(selectedText);

            // 2. Verifica se a sele√ß√£o est√° DENTRO de um link <a> existente
            let isInsideLink = false;
            if (selection.anchorNode) {
                const anchorEl = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
                isInsideLink = !!anchorEl.closest('a');
            }

            // Decis√£o: Mostra ou Esconde o üé¥
            if (looksLikeUrl || isInsideLink) {
                btnCard.style.display = 'flex'; // Mostra
            } else {
                btnCard.style.display = 'none'; // Esconde
            }
        }
        // -----------------------------------------------------

       currentSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = currentSelectionRange.getBoundingClientRect();
        
        if (selectionPopup) {
            selectionPopup.style.display = 'flex'; // Mostra primeiro para calcular a largura
            
            // --- C√ÅLCULO DE POSI√á√ÉO INTELIGENTE ---
            const popupWidth = selectionPopup.offsetWidth;
            const windowWidth = window.innerWidth;
            const scrollX = window.scrollX;
            const padding = 10; 

            // 1. Centralizar
            let leftPos = rect.left + (rect.width / 2) - (popupWidth / 2);

            // 2. Limites Ecr√£
            if (leftPos < padding) {
                leftPos = padding;
            } else if (leftPos + popupWidth > windowWidth - padding) {
                leftPos = windowWidth - popupWidth - padding;
            }
            leftPos += scrollX;

            // 3. Vertical (Y)
            const popupHeight = selectionPopup.offsetHeight || 50; 
            const gap = 10; 

            let topPos = (rect.top + window.scrollY) - popupHeight - gap;
            
            // Prote√ß√£o de Topo (se n√£o couber em cima, p√µe em baixo)
            if (rect.top < (popupHeight + gap + 50)) { 
               topPos = rect.bottom + window.scrollY + gap;
            }

            // APLICA AS POSI√á√ïES FINAIS
            selectionPopup.style.top = `${topPos}px`;
            selectionPopup.style.left = `${leftPos}px`;
            selectionPopup.style.zIndex = '2000';
        }
    } 
    // >>> O C√ìDIGO NOVO EST√Å AQUI (O ELSE) <<<
    else {
        // Se N√ÉO houver sele√ß√£o, esconde o popup imediatamente
        if (selectionPopup) {
            selectionPopup.style.display = 'none';
        }
    }
}
// ====================================================================



// ====================================================================
// NAVEGA√á√ÉO MOBILE: FECHAR LISTA AO CLICAR NO VAZIO
// ====================================================================



function formatTimestamp(timestamp) {
        if (!timestamp || !timestamp.seconds) {
            return 'Data inv√°lida';
        }
        const date = new Date(timestamp.seconds * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }


  


    /**
     * Exibe o conte√∫do de um backup num modal de visualiza√ß√£o.
     * @param {string} backupId O ID do documento de backup.
     */
 // Torna a fun√ß√£o global para que o HTML (onclick) a encontre
// Torna a fun√ß√£o global para que o atributo onclick do HTML a encontre
window.restoreBackup = async function(backupId) {
    if (!selectedNoteId) return;

    // 1. Pedir confirma√ß√£o ao utilizador
    // Nota: A fun√ß√£o showConfirmation deve estar definida no seu c√≥digo
    const confirmed = await showConfirmation(
        "Restaurar Vers√£o?", 
        "Esta a√ß√£o criar√° uma NOVA nota com o conte√∫do desta vers√£o. A nota que tem aberta agora n√£o ser√° alterada."
    );

    if (!confirmed) return;

    // Feedback visual de processamento
    const historyModal = document.getElementById('history-modal');
    if (historyModal) historyModal.style.opacity = '0.7';

    try {
        // 2. Buscar os dados do backup espec√≠fico
        const backupRef = doc(db, 'pastas', selectedNoteId, 'backups', backupId);
        const backupSnap = await getDoc(backupRef);
        
        if (!backupSnap.exists()) {
            alert("Erro: O backup selecionado j√° n√£o existe.");
            return;
        }
        
        const backupData = backupSnap.data();

        // 3. Descobrir a pasta pai (parentId) da nota original para colocar a nova nota no mesmo s√≠tio
        const originalNoteRef = doc(db, 'pastas', selectedNoteId);
        const originalSnap = await getDoc(originalNoteRef);
        const parentId = originalSnap.exists() ? originalSnap.data().parentId : null;

        // 4. Preparar o novo t√≠tulo com a data da restaura√ß√£o
        const backupDate = backupData.timestamp 
            ? new Date(backupData.timestamp.seconds * 1000).toLocaleDateString('pt-PT') 
            : '';
        const newTitle = `${backupData.titulo} (Restaurado ${backupDate})`;

        // 5. Criar a NOVA nota no Firestore
        const newDocRef = await addDoc(collection(db, 'pastas'), {
            nome: newTitle,
            conteudo: backupData.conteudo,
            parentId: parentId,
            tipo: 'nota',
            userId: auth.currentUser.uid, // Atribui ao utilizador atual
            estado: 'ativa',
            ordem: 0, // Coloca no topo da lista
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp(),
            tags: []
        });

        // 6. Finaliza√ß√£o e Limpeza
        if (historyModal) {
            historyModal.style.display = 'none';
            historyModal.style.opacity = '1';
        }

        // 7. Feedback e Sugest√£o de abertura
        const shouldOpen = await showConfirmation(
            "C√≥pia Criada!", 
            `Foi gerada uma nova nota chamada "${newTitle}". Deseja abrir esta nota agora?`
        );

        if (shouldOpen) {
            // Se voc√™ tiver a fun√ß√£o de navega√ß√£o inteligente, use-a. 
            // Caso contr√°rio, use o displayNote direto.
            if (typeof navigateToNoteSmart === 'function') {
                await navigateToNoteSmart(newDocRef.id);
            } else {
                displayNote(newDocRef.id, null);
            }
        } else {
            // Apenas atualiza a lista lateral para mostrar a nota nova
            updateNavigationView(true, selectedNoteId);
        }

    } catch (error) {
        console.error("Erro cr√≠tico no processo de restauro:", error);
        alert("Ocorreu um erro ao restaurar a nota. Verifique a sua liga√ß√£o.");
        if (historyModal) historyModal.style.opacity = '1';
    }
};

    

    // --- LISTENER DO PAINEL ESQUERDO COM LOGS DE DEPURA√á√ÉO ---
leftPanelList.addEventListener('click', async (e) => {
    // 1. Identifica o que foi clicado
    const listItem = e.target.closest('.list-item');
    if (!listItem) return;

    // --- A. BOT√ÉO DE MENU (Tr√™s Pontos) ---
    const itemMenuBtn = e.target.closest('.item-menu-btn');
    if (itemMenuBtn) {
        showContextMenu(e); 
        return; 
    }

    // ============================================================
    // CORRE√á√ÉO DE SELE√á√ÉO VISUAL (A SOLU√á√ÉO PARA O SEU PROBLEMA)
    // ============================================================
    
    // 1. Limpa TODOS os destaques da Coluna 2 (Nota Z deixa de estar azul)
    const middleItems = document.getElementById('file-list').querySelectorAll('.list-item');
    middleItems.forEach(el => {
        el.classList.remove('selected', 'selected-red');
        el.style.backgroundColor = ""; // Remove estilos inline residuais
    });

    // 2. Limpa TODOS os destaques da Coluna 1 (Pasta C deixa de estar azul)
    const leftItems = document.getElementById('left-panel-list').querySelectorAll('.list-item');
    leftItems.forEach(el => {
        el.classList.remove('selected');
    });

    // 3. Aplica destaque APENAS no item clicado agora (Nota Y fica azul)
    listItem.classList.add('selected');

    // 4. Limpa vari√°veis de transi√ß√£o para evitar re-sele√ß√£o autom√°tica
    window.nextSelectedId = null; 
    // ============================================================


    // --- B. CAPTURA DE DADOS ---
    const id = listItem.dataset.id;
    const name = listItem.dataset.name;
    const type = listItem.dataset.type;
    const emoji = listItem.dataset.emoji;

    // --- C. VERIFICA√á√ÉO DE PROTE√á√ÉO ---
    if (currentTab === 'note') {
        const canAccess = await checkItemProtection(id, name);
        if (!canAccess) {
            listItem.classList.remove('selected'); // Remove destaque se falhar a senha
            return; 
        }
    }

    // --- D. L√ìGICA DE NAVEGA√á√ÉO: ABA "LISTS" ---
   if (currentTab === 'lists') {
        const listNavigationAction = async () => {
            // 1. FOR√áAR A MUDAN√áA DE ECR√É NO MOBILE (A CORRE√á√ÉO)
            if (window.innerWidth <= 768) {
                document.body.classList.remove('mobile-view-editor'); // Garante que n√£o est√° no editor
                document.body.classList.add('mobile-view-middle');    // Mostra a lista do meio
            }

            // 2. L√≥gica de Navega√ß√£o
            if (type === 'list-category' || type === 'bible-book') {
                if (type === 'list-category') {
                    navigationStack = [{ id, name, type }];
                } else {
                    navigationStack.push({ id, name, type });
                }
                updateNavigationView(true);
            } 
            else if (type === 'cosmos-parent') {
                navigationStack.push({ id, name, type, emoji });
                updateNavigationView(true);
            }
            else if (type === 'subcosmos') {
                // Subcosmos abre a 4¬™ coluna diretamente, n√£o muda de painel
                showReferencesPanel(id, name, 'subcosmos');
            }
        };
        navigateWithUnsavedCheck(listNavigationAction);
        return;
    }

    // --- E. L√ìGICA DE NAVEGA√á√ÉO: ABA "NOTE" ---
    if (currentTab === 'note') {
        
        // Caso 1: PASTA ou AGREGA√á√ÉO -> Entra nela
        if (type === 'pasta' || type === 'agregacao') {
            if (listItem.dataset.superpasta === "true") {
                navigateWithUnsavedCheck(() => { 
                    window.location.href = `note.html?rootId=${id}`; 
                });
            } else {
                const folderAction = () => {
                    if (window.innerWidth <= 768) {
                        document.body.classList.add('mobile-view-middle');
                    }
                    // Define a navega√ß√£o para entrar nesta pasta
                    if (navigationStack.length === 0) navigationStack.push({ id, name });
                    else navigationStack[navigationStack.length - 1] = { id, name };
                    
                    updateNavigationView(true);
                };
                navigateWithUnsavedCheck(folderAction);
            }
        }

        // Caso 2: NOTA -> Abre no Editor (Mas mant√©m-se na Coluna 1 visualmente)
        else if (type === 'nota') {
            const noteAction = () => {
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-view-middle');
                    document.body.classList.add('mobile-view-editor');
                }
                // Abre a nota Y
                displayNote(id, listItem);
            };
            navigateWithUnsavedCheck(noteAction);
        }
    }
});


// ====================================================================
// L√ìGICA DE MOVIMENTO DAS CAIXAS (üî∫ üîª)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    // S√≥ nos interessa se for um dos bot√µes de movimento
    if (action !== 'move-up' && action !== 'move-down') return;

    e.preventDefault(); e.stopPropagation();

    // 1. Identificar a Caixa (Wrapper) e o Pai (Editor)
    const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
    
    if (!wrapper) return;
    const parent = wrapper.parentNode;

    // 2. A√ß√£o MOVER PARA CIMA
    if (action === 'move-up') {
        const prevElement = wrapper.previousElementSibling;
        
        if (prevElement) {
            // Verifica se o elemento anterior √© um "div de espa√ßamento" (aqueles com height: 20px)
            // Se for, queremos saltar por cima dele tamb√©m para chegar ao conte√∫do real
            let target = prevElement;
            if (target.style.height === '20px' && target.previousElementSibling) {
                target = target.previousElementSibling;
            }

            // Move o wrapper para antes do alvo
            parent.insertBefore(wrapper, target);
            
            // Scroll suave para acompanhar o movimento
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
              updateRedatorParagraphs(); // Recalcula posi√ß√µes
            saveNote();
        }
    }

    // 3. A√ß√£o MOVER PARA BAIXO
    else if (action === 'move-down') {
        const nextElement = wrapper.nextElementSibling;
        
        if (nextElement) {
            // Mesma l√≥gica: saltar espa√ßadores vazios se existirem
            let target = nextElement;
            if (target.style.height === '20px' && target.nextElementSibling) {
                target = target.nextElementSibling;
            }

            // Para mover para baixo, inserimos o elemento SEGUINTE antes do ATUAL
            // (Basicamente trocamos a ordem)
            // Ou inserimos o ATUAL depois do SEGUINTE (usando nextSibling do seguinte)
            parent.insertBefore(wrapper, target.nextSibling);

            // Scroll suave
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateRedatorParagraphs(); // Recalcula posi√ß√µes
            saveNote();
        }
    }
});


// ====================================================================
// GESTOR DE LINHA CRONOL√ìGICA (TIMELINE)
// ====================================================================
noteContentEditor.addEventListener('click', (e) => {
    // 1. Adicionar Ponto
    if (e.target.classList.contains('t-btn-add')) {
        e.preventDefault(); e.stopPropagation();
        
        const wrapper = e.target.closest('.jwn-timeline-wrapper');
        const container = wrapper.querySelector('.timeline-container');
        
        const newEntry = document.createElement('div');
        newEntry.className = 'timeline-entry';
        newEntry.innerHTML = `
            <div class="t-marker"></div>
            <div class="t-date" contenteditable="true">Nova Data</div>
            <div class="t-text" contenteditable="true">Novo evento...</div>
            <button class="t-btn-del" title="Remover Ponto">√ó</button>
        `;
        
      container.appendChild(newEntry);

// --- SUBSTITUI ESTA PARTE DO SETTIMEOUT ---
setTimeout(() => {
    const dateField = newEntry.querySelector('.t-date');
    dateField.focus();

    // Cria uma sele√ß√£o precisa apenas no texto da data
    const range = document.createRange();
    range.selectNodeContents(dateField);
    
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
}, 10);
// ------------------------------------------

saveNote();
    }
    
    // 2. Remover Ponto
    else if (e.target.classList.contains('t-btn-del')) {
        e.preventDefault(); e.stopPropagation();
        
        const entry = e.target.closest('.timeline-entry');
        const container = entry.parentElement;
        
        // Se for o √∫ltimo ponto, pergunta se quer apagar a timeline toda
        if (container.children.length <= 1) {
            if (confirm("Apagar toda a Linha Cronol√≥gica?")) {
                entry.closest('.jwn-timeline-wrapper').remove();
            }
        } else {
            entry.remove();
        }
        
        saveNote();
    }
});


    // --- NOVO LISTENER PARA O DROPDOWN DE ZOOM ---
const zoomSelect = document.getElementById('editor-zoom');
if (zoomSelect) {
    // Removemos clones antigos para evitar bugs
    const newZoomSelect = zoomSelect.cloneNode(true);
    zoomSelect.parentNode.replaceChild(newZoomSelect, zoomSelect);

    newZoomSelect.addEventListener('change', () => {
        const selectedValue = newZoomSelect.value;
        const editor = document.getElementById('note-content-editor');
        
        if (editor) {
            // 1. Aplica o tamanho
            editor.style.fontSize = selectedValue;
            
            // 2. Ajuste de altura da linha (UX)
            if (selectedValue.includes('%')) {
                 editor.style.lineHeight = '1.6';
            } else {
                 const sizeNum = parseInt(selectedValue);
                 editor.style.lineHeight = (sizeNum * 1.5) + 'px';
            }
            
            // 3. Grava imediatamente para persistir
            saveNote(true);
        }
    });
}





// --- EVENT LISTENERS ---

// ============================================================
// LISTENERS GLOBAIS DE CONECTIVIDADE E SA√çDA (FINAL)
// ============================================================

window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);

// 1. Gravar ao mudar de aba ou minimizar (Mobile & Desktop)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        
        // A. Se estiver no Aqu√°rio
        const aquariumEnv = document.getElementById('aquarium-environment');
        // Verifica se existe, se est√° vis√≠vel e se temos uma nota aberta
        if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
            console.log("üåä [SA√çDA] Aqu√°rio escondido. A gravar...");
            // Chama a fun√ß√£o de grava√ß√£o do aqu√°rio (que limpa o HTML)
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
        
        // B. Se estiver num Post de Arquivo (Feed) em edi√ß√£o
        else if (activeEditingPostId) {
            console.log("üì± [SA√çDA] Post de Arquivo aberto. A gravar e desbloquear...");
            const tempId = activeEditingPostId;
            // Limpa vari√°veis globais para evitar conflitos
            activeEditingPostId = null;
            window.activeEditingPostId = null;
            // Grava e liberta o cadeado
            if (typeof window.saveArchivePost === 'function') {
                window.saveArchivePost(tempId);
            }
        }

        // C. Se estiver numa Nota Normal (e houver altera√ß√µes pendentes)
        else if (currentSaveStatus === 'unsaved') {
            console.log("üìÑ [SA√çDA] Nota normal n√£o guardada. A gravar...");
            executeSave();
        }
    }
});

// 2. Gravar ao perder o foco da janela (ex: clicar no Desktop ou noutra app)
window.addEventListener('blur', () => {
    // Aplica a mesma l√≥gica de verifica√ß√£o
    const aquariumEnv = document.getElementById('aquarium-environment');
    
    if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
        // Verifica se h√° algo por guardar no Aqu√°rio
        const aqStatus = document.getElementById('aq-save-status');
        if (aqStatus && aqStatus.textContent === 'por guardar...') {
            window.saveAquariumState();
        }
    } 
    else if (currentSaveStatus === 'unsaved') {
        executeSave();
    }
});

// 3. Gravar ao Fechar Aba ou Fazer Refresh (Aviso de Seguran√ßa)
window.addEventListener('beforeunload', (event) => {
    let isPending = false;
    
    // A. Aqu√°rio Aberto
    const aquariumEnv = document.getElementById('aquarium-environment');
    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        // Verifica o texto do status espec√≠fico do aqu√°rio
        const aqStatus = document.getElementById('aq-save-status');
        
        if (aqStatus && (aqStatus.textContent === 'por guardar...' || aqStatus.textContent === 'A guardar...')) {
            console.log("üåä [REFRESH] Aqu√°rio por guardar. For√ßando...");
            // Dispara grava√ß√£o
            window.saveAquariumState();
            isPending = true;
        }
    }

    // B. Nota Normal ou Arquivo
    else {
        // Nota normal por guardar
        if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
            console.log("üìÑ [REFRESH] Nota por guardar. For√ßando...");
            executeSave();
            isPending = true;
        }

        // Post de Arquivo aberto
        if (activeEditingPostId) {
            console.log("üì± [REFRESH] Post aberto. For√ßando...");
            window.saveArchivePost(activeEditingPostId);
            isPending = true;
        }
    }

    // Se houver algo pendente, pede ao browser para esperar
    if (isPending) {
        event.preventDefault();
        event.returnValue = ''; // Standard para Chrome
        return ''; // Standard para outros browsers
    }
});

// Listeners de Navega√ß√£o (Protegidos pelo Gatekeeper)


// LISTENER √öNICO DA COLUNA 2 (Unifica Logs, Navega√ß√£o e Mobile)
middlePanelList.addEventListener('click', async (e) => {
    // 1. Identifica o item clicado
    const item = e.target.closest('.list-item');
    if (!item) return;

    // 2. Se clicou nos "tr√™s pontos", abre o menu e p√°ra
    if (e.target.closest('.item-menu-btn')) {
        showContextMenu(e);
        return;
    }

    // 3. Captura TODOS os dados (AQUI ESTAVA A FALHA)
    const id = item.getAttribute('data-id');
    const type = item.getAttribute('data-type');
    const name = item.getAttribute('data-name');
    
    // >>> ESTAS DUAS LINHAS S√ÉO OBRIGAT√ìRIAS PARA O ERRO DESAPARECER <<<
    const userId = item.getAttribute('data-userid'); 
    const partilhadoState = item.getAttribute('data-partilhado');
    // ------------------------------------------------------------------

    // Defini√ß√£o da A√ß√£o de Navega√ß√£o
    const proceedWithNavigation = async () => {
        
        // 4. Limpeza Visual
        const allItems = middlePanelList.querySelectorAll('.list-item');
        allItems.forEach(el => {
            el.classList.remove('selected', 'selected-red');
            el.style.backgroundColor = ""; 
        });

        // 5. Aplica Destaque
        const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
        item.classList.add(selectionClass);
        window.nextSelectedId = id; 

        // 6. Verifica√ß√£o de Prote√ß√£o
        const canAccess = await checkItemProtection(id, name);
        if (!canAccess) {
            window.nextSelectedId = null; 
            item.classList.remove(selectionClass); 
            return;
        }

        // 7. EXECU√á√ÉO DA ABERTURA
        
        // --- CASO A: NAVEGAR (PASTAS) ---
        if (type === 'pasta' || type === 'agregacao') {
            if (item.dataset.superpasta === "true") {
                window.location.href = `note.html?rootId=${id}`;
                return;
            }
            navigationStack.push({ id, name });
            updateNavigationView(true);
            
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view-middle');
            }
        }

        // --- CASO B: ABRIR CONTE√öDO ---
        else if (['nota', 'arquivo', 'partilhado', 'jornal', 'aquario'].includes(type)) {

            // Mobile: Salta para o editor
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-view-editor');
            }

            // Aqu√°rio
            if (type === 'aquario') {
                try {
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    const docRef = doc(db, 'pastas', id);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        window.openAquariumEnvironment(id, { id: snap.id, ...snap.data() });
                    }
                } catch (err) { console.error(err); }
            }
            
            // Notas e Jornais
            else if (type === 'nota' || type === 'jornal') {
                displayNote(id, item);
            }
            
            // Arquivos e Partilhas
            else {
                // Prepara a √°rea da direita
                const archiveArea = document.getElementById('archive-area');
                const editorArea = document.getElementById('editor-area');
                const placeholder = document.getElementById('editor-placeholder');
                
                if(editorArea) editorArea.style.setProperty('display', 'none', 'important');
                if(placeholder) placeholder.style.setProperty('display', 'none', 'important');
                
                if(archiveArea) {
                    archiveArea.style.display = 'flex';
                    Array.from(archiveArea.children).forEach(child => {
                        if (child.id !== 'archive-loader-overlay') child.style.display = 'none';
                    });
                    
                    let loader = document.getElementById('archive-loader-overlay');
                    if (!loader) {
                        loader = document.createElement('div');
                        loader.id = 'archive-loader-overlay';
                        loader.style.cssText = "flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%;";
                        loader.innerHTML = `<div class="spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>`;
                        archiveArea.appendChild(loader);
                    }
                    loader.style.display = 'flex';
                }

                // 3. CARREGA OS DADOS (Agora as vari√°veis userId e partilhadoState existem!)
                setTimeout(() => {
                    displayArchive(id, { 
                        id: id, 
                        nome: name, 
                        tipo: type,
                        userId: userId,           // <--- Corre√ß√£o aplicada
                        partilhado: partilhadoState // <--- Corre√ß√£o aplicada
                    }, item);
                }, 50);
            }
        }
    };

    navigateWithUnsavedCheck(proceedWithNavigation);
});





function setLeftPanelTitle(text, isBackAction = false) {
    const titleEl = document.getElementById('left-panel-title');
    if (!titleEl) return;

    // Verifica se estamos dentro de uma Superpasta
    const isSuperContext = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID);

    // REGRA 1: MODO SUPERPASTA
    if (isSuperContext) {
        titleEl.className = ''; 
        titleEl.style.display = 'block';
        titleEl.onclick = null;
        titleEl.innerHTML = `
            <h2 style="font-size:18px; cursor:pointer; display: flex; align-items: center;" title="Sair desta Superpasta">
                <span style="font-size: 0.8em; opacity: 0.7; margin-right: 8px;">üîô</span> 
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${text}</span>
            </h2>`;
        
        titleEl.onclick = () => {
            navigateWithUnsavedCheck(() => {
                if (isBackAction && navigationStack.length > 0) {
                    navigationStack.pop();
                    selectedNoteId = null; 
                    updateNavigationView();
                } else {
                    window.location.href = "note.html"; 
                }
            });
        };
        return;
    }

    // REGRA 2: ABA NOTE (SELETOR SEMPRE VIS√çVEL)
    if (currentTab === 'note') {
        titleEl.className = 'folder-mode-container';
        titleEl.style.display = 'flex';
        titleEl.onclick = null;

        const localActive = currentViewMode === 'local' ? 'active' : '';
        const sharedActive = currentViewMode === 'shared' ? 'active mode-shared' : '';
        const pinsActive = currentViewMode === 'pins' ? 'active mode-pins' : '';
        const flashActive = currentViewMode === 'flash' ? 'active mode-flash' : '';

        // >>> ALTERA√á√ÉO AQUI: "Partilha" mudou para "Share" <<<
        titleEl.innerHTML = `
            <span class="folder-mode-item ${localActive}" onclick="window.switchFolderView('local')">Local</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${sharedActive}" onclick="window.switchFolderView('shared')">Share</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${pinsActive}" onclick="window.switchFolderView('pins')">Pins</span>
            <span class="folder-mode-separator">|</span>
            <span class="folder-mode-item ${flashActive}" onclick="window.switchFolderView('flash')">Flash</span>
        `;

        // Atualiza√ß√£o da notifica√ß√£o
        setTimeout(() => {
            if (typeof updateShareTabDot === 'function') updateShareTabDot();
        }, 50);
    }
    // REGRA 3: OUTRAS ABAS
    else if (isBackAction) {
        titleEl.className = ''; 
        titleEl.style.display = 'block';
        titleEl.innerHTML = `<h2 style="font-size:18px; cursor:pointer;"><span style="font-size: 0.8em; opacity: 0.7; margin-right: 8px;">üîô</span> ${text}</h2>`;
        titleEl.onclick = () => {
            navigateWithUnsavedCheck(() => {
                if (navigationStack.length > 0) {
                    navigationStack.pop();
                    selectedNoteId = null; 
                    updateNavigationView();
                }
            });
        };
    } 
    else {
        titleEl.className = '';
        titleEl.style.display = 'block';
        titleEl.innerHTML = `<h2 style="font-size:18px; margin:0;">${text}</h2>`;
        titleEl.onclick = null;
    }
}


// ====================================================================
// FUN√á√ÉO: MOSTRAR REFER√äNCIAS DE DESTAQUE (4¬™ COLUNA)
// ====================================================================
async function showHighlightReferencesPanel(hexCode, colorName) {
    // 1. Gravar antes de mudar
    await forceSaveAndClosePuzzleMode();
    resetReferencesPanelUI();

    // --- DETE√á√ÉO DO MODO AQU√ÅRIO (IMPORTANTE) ---
    const aquariumEnv = document.getElementById('aquarium-environment');
    const refPanel = document.getElementById('references-panel');

    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        // Se o Aqu√°rio est√° aberto, for√ßamos o painel a flutuar sobre ele
        refPanel.classList.add('aquarium-overlay-mode');
        
        // Movemos o painel para dentro do ambiente do Aqu√°rio para garantir que fica vis√≠vel
        if (refPanel.parentElement !== aquariumEnv) {
            aquariumEnv.appendChild(refPanel);
        }

        // Adiciona classe para empurrar o texto do Aqu√°rio (Squeeze)
        aquariumEnv.classList.add('right-open');
    } else {
        // Modo Normal: Devolve √† estrutura principal
        refPanel.classList.remove('aquarium-overlay-mode');
        const mainContainer = document.querySelector('.notebook-container');
        if (mainContainer && refPanel.parentElement !== mainContainer) {
            mainContainer.appendChild(refPanel);
        }
    }
    // ---------------------------------------------

    // 2. Configura√ß√£o Visual
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // For√ßar aba "Refer√™ncias" (Cita)
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Esconder bot√µes irrelevantes
    document.getElementById('references-wol-btn').style.display = 'none';
    document.getElementById('references-bookmark-btn').style.display = 'none';

    // 3. Mostrar o Painel
    notebookContainer.classList.add('references-panel-visible');
    
    // 4. Configurar T√≠tulo e Cabe√ßalho
    const titleEl = document.getElementById('references-panel-title');
    titleEl.innerHTML = `
        <span style="display:inline-block; width:15px; height:15px; background:${hexCode}; border-radius:50%; border:1px solid #ccc; margin-right:5px; vertical-align:middle;"></span>
        ${colorName}
    `;
    
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar destaques...</span>
        </div>`;

    // 5. Definir a Entidade Ativa (Para o +Ref funcionar)
    // Usamos o c√≥digo Hex como ID e 'destaque' como tipo
    activeReferenceEntity = {
        id: hexCode,
        type: 'destaque',
        name: colorName
    };

    // Carregar dados do Quadro (Puzzle) para esta cor
    loadPuzzleData(hexCode, 'destaque');

    try {
        // 6. Pesquisa no Firestore (Notas com esta cor)
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            where('coresUsadas', 'array-contains', hexCode.toUpperCase())
        );

        const snapshot = await getDocs(q);
        const results = [];
        const parser = new DOMParser();

        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            let isItemProtected = (data.passe && data.passe.trim() !== "");
            if (isItemProtected && !appSettings.searchTagsInProtected) continue;

            const docHTML = parser.parseFromString(data.conteudo, 'text/html');
            const coloredElements = docHTML.querySelectorAll(`[data-highlight="${hexCode}"]`);
            
            coloredElements.forEach(el => {
                let displayTitle = "Sem T√≠tulo";
                let displayIcon = "üü¶"; 
                let snippet = "";
                let contextType = "Item";

                if (el.tagName === 'DETAILS' && el.classList.contains('toggle-section')) {
                    displayIcon = "‚òÇ";
                    contextType = "Toggle";
                    const h2 = el.querySelector('h2');
                    displayTitle = h2 ? h2.textContent : "T√≠tulo Expans√≠vel";
                    const contentDiv = el.querySelector('.toggle-content');
                    snippet = contentDiv ? contentDiv.textContent.trim().substring(0, 100) + "..." : "";
                }
                else if (el.classList.contains('mini-note-wrapper')) {
                    const titleInput = el.querySelector('.mini-note-title-input');
                    const contentDiv = el.querySelector('.mini-note-content');

                    if (el.classList.contains('question-mode')) {
                        displayIcon = "üìó";
                        contextType = "Quest√£o";
                        displayTitle = titleInput ? (titleInput.value || titleInput.textContent) : "Quest√£o";
                    } else if (el.classList.contains('free-mode')) {
                        displayIcon = "üìô";
                        contextType = "Contentor";
                        const txt = contentDiv ? contentDiv.textContent.trim() : "";
                        displayTitle = txt.length > 40 ? txt.substring(0, 40) + "..." : (txt || "Contentor");
                    } else {
                        displayIcon = "üìò"; 
                        contextType = "SubNota";
                        displayTitle = titleInput ? (titleInput.value || titleInput.textContent) : "SubNota";
                    }
                    snippet = contentDiv ? contentDiv.innerHTML : "";
                }

                results.push({
                    noteId: docSnap.id,
                    noteName: data.nome,
                    displayTitle: displayTitle,
                    displayIcon: displayIcon,
                    contextType: contextType,
                    snippet: snippet || el.outerHTML // Usa o snippet se houver, ou o HTML todo
                });
            });
        }

        listElement.innerHTML = '';
        if (results.length === 0) {
            listElement.innerHTML = '<li style="padding:15px; color:#888;">Nenhuma caixa encontrada com esta cor.</li>';
            return;
        }

        results.forEach(item => {
            const details = document.createElement('details');
            details.className = 'reference-item';
            details.style.borderLeft = `3px solid ${hexCode}`;
            
            const safeName = encodeURIComponent(item.noteName);
            const safeSnippet = encodeURIComponent(item.snippet);

            const summary = document.createElement('summary');
            summary.style.listStyle = "none"; 

            const goToBtn = `<button class="go-to-note-btn" 
                onclick="window.handleGoToNote('${item.noteId}')" 
                title="Ir para nota">‚ûî</button>`;

            summary.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="add-to-puzzle-btn" 
                                    onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${item.noteId}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                            <span style="font-weight:500; color:var(--text-color);">${item.displayIcon} ${item.displayTitle}</span>
                        </div>
                        ${goToBtn}
                    </div>
                    <small style="color:var(--text-muted-color); margin-top:2px;">em üìÑ ${item.noteName}</small>
                </div>
            `;
            
            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Limpa HTML para mostrar preview de texto
            const previewText = item.snippet.replace(/<[^>]*>/g, '').substring(0, 150);
            contextDiv.innerHTML = `<p>${previewText}...</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao buscar refer√™ncias de cor:", error);
        listElement.innerHTML = '<li>Erro ao processar dados.</li>';
    }
}

function checkToolbarStatus() {
    // 1. Pergunta ao browser o estado da formata√ß√£o onde est√° o cursor
    // O 'queryCommandState' devolve true/false se o cursor estiver em texto Bold/Italic/etc.
    const isBold = document.queryCommandState('bold');
    const isItalic = document.queryCommandState('italic');
    const isUnderline = document.queryCommandState('underline');

    // 2. Fun√ß√£o auxiliar para ligar/desligar a classe visual nos bot√µes
    const toggleBtn = (selector, isActive) => {
        const btns = document.querySelectorAll(selector);
        btns.forEach(btn => {
            if (isActive) {
                btn.classList.add('active-tool');
            } else {
                btn.classList.remove('active-tool');
            }
        });
    };

    // 3. Atualiza os bot√µes da Toolbar Principal e do Aqu√°rio
    // Negrito (Apanha o B normal e o B Azul)
    toggleBtn('button[data-command="bold"]', isBold);
    toggleBtn('button[data-command="boldBlue"]', isBold); // O B Azul tamb√©m acende se for bold
    toggleBtn('button[data-cmd="bold"]', isBold);         // Aqu√°rio

    // It√°lico
    toggleBtn('button[data-command="italic"]', isItalic);
    toggleBtn('button[data-cmd="italic"]', isItalic);     // Aqu√°rio

    // Sublinhado
    toggleBtn('button[data-command="underline"]', isUnderline);
    toggleBtn('button[data-cmd="underline"]', isUnderline); // Aqu√°rio
}

// ============================================================
// LIGAR OS GATILHOS (O QUE FAZ FUNCIONAR)
// ============================================================

const editorsToWatch = [
    document.getElementById('note-content-editor'),       // Editor Normal
    document.getElementById('aquarium-content-canvas')    // Aqu√°rio
];

editorsToWatch.forEach(editor => {
    if (editor) {
        // Verifica o estado sempre que:
        // 1. Clicas com o rato (mouseup)
        // 2. Usas as setas do teclado (keyup)
        // 3. Tocas no ecr√£ (touchend)
        ['mouseup', 'keyup', 'touchend', 'click', 'input'].forEach(evt => {
            editor.addEventListener(evt, () => {
                // Pequeno delay para garantir que o cursor j√° mudou de s√≠tio
                setTimeout(checkToolbarStatus, 10); 
            });
        });
    }
});



// Gera uma cor consistente baseada no ID do utilizador
function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return '#' + "00000".substring(0, 6 - c.length) + c;
}

// --- LIGAR O DETETOR ---



document.querySelector('.tabs-container').addEventListener('click', (e) => {
    leaveArchivePresence(); 
    const clickedTabBtn = e.target.closest('button');
    if (!clickedTabBtn) return;

    const newTab = clickedTabBtn.dataset.tab;
    if (newTab === 'book') {
        window.open('book.html', '_blank'); 
        return; 
    }

    if (currentSaveStatus === 'unsaved') {
        saveNote(true); // Grava imediatamente se houver altera√ß√µes
    }

    // --- SISTEMA DE MEM√ìRIA ---
    // 1. Antes de mudar, guarda a navega√ß√£o da aba ATUAL na mem√≥ria dela
    if (currentTab === 'note') noteStackMemory = [...navigationStack];
    if (currentTab === 'lists') listsStackMemory = [...navigationStack];

    // 2. Atualiza visual das abas
    e.currentTarget.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
    clickedTabBtn.classList.add('active');

    // 3. Muda a aba ativa
    currentTab = newTab;

    // 4. Carrega a navega√ß√£o da NOVA aba a partir da mem√≥ria dela
    if (currentTab === 'note') navigationStack = [...noteStackMemory];
    if (currentTab === 'lists') navigationStack = [...listsStackMemory];
    
     // Adiciona esta linha aqui por seguran√ßa extra:
    updateMobileFABVisibility(); 
    // 5. Atualiza a vista (mantendo o editor aberto se houver uma nota ativa)
    updateNavigationView(true);
});


// Listeners do Editor
noteTitleInput.addEventListener('input', () => {
    updateSaveStatus('unsaved');
    saveNote();
});
noteContentEditor.addEventListener('input', () => {
    // 1. Marca como n√£o guardado e guarda data
    lastContentEditTime = Date.now(); 
    updateSaveStatus('unsaved');
    saveNote();

    // 2. ATUALIZA√á√ÉO DA 3¬™ ABA EM TEMPO REAL
    const activeTab = document.querySelector('.middle-bottom-tabs button.active');
    
    // S√≥ faz o scan se estivermos na aba de textos/navega/h√≠brido
    if (activeTab && activeTab.dataset.midTab === 'texts') {
        clearTimeout(window.textScanTimeout);
        
        window.textScanTimeout = setTimeout(() => {
            // --- CORRE√á√ÉO AQUI: Respeitar a hierarquia de modos ---
            if (window.currentNoteHybridMode) {
                 console.log("üõ≥Ô∏è [INPUT] Atualizando Modo H√≠brido...");
                 generateHybridView();
            } else if (activeTab.dataset.mode === 'navega') {
                 console.log("‚öì [INPUT] Atualizando Navega√ß√£o...");
                 generateAnchorNavigation();
            } else {
                 console.log("üìú [INPUT] Atualizando Textos B√≠blicos...");
                 generateNoteTexts();
            }
        }, 1000); // Espera 1 segundo ap√≥s parar de escrever
    }
});

document.addEventListener('selectionchange', handleTextSelection);

noteContentEditor.addEventListener('keydown', (e) => {
    // 1. Se estivermos a escrever DENTRO de um input do dep√≥sito, permite apagar texto normalmente
    if (e.target.tagName === 'INPUT' && e.target.closest('.ref-depot-wrapper')) {
        return; 
    }

    if (e.key === 'Backspace' || e.key === 'Delete') {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        const range = selection.getRangeAt(0);

        // --- CEN√ÅRIO A: UTILIZADOR SELECIONOU O BLOCO (HIGHLIGHT) ---
        if (!selection.isCollapsed) {
            // Verifica se a sele√ß√£o cont√©m um Dep√≥sito
            const commonAncestor = range.commonAncestorContainer;
            const element = commonAncestor.nodeType === 3 ? commonAncestor.parentElement : commonAncestor;
            
            // Se a sele√ß√£o engloba o dep√≥sito ou cruza por ele
            if (element.querySelector('.ref-depot-wrapper') || 
                (element.classList.contains('ref-depot-wrapper')) ||
                range.intersectsNode(document.querySelector('.ref-depot-wrapper') || document.body)) {
                
                // Verifica√ß√£o precisa: iterar pelos dep√≥sitos para ver se algum est√° na sele√ß√£o
                const depots = noteContentEditor.querySelectorAll('.ref-depot-wrapper');
                let isProtected = false;
                
                depots.forEach(depot => {
                    if (selection.containsNode(depot, true)) {
                        isProtected = true;
                    }
                });

                if (isProtected) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert("‚ö†Ô∏è Prote√ß√£o Ativa: Utilize o bot√£o de lixo (üóëÔ∏è) no canto do Dep√≥sito para o apagar.");
                    return;
                }
            }
        }

        // --- CEN√ÅRIO B: CURSOR ENCOSTADO AO BLOCO (BACKSPACE) ---
        if (e.key === 'Backspace' && selection.isCollapsed) {
            const anchorNode = selection.anchorNode;
            
            // Se estamos no in√≠cio de um bloco de texto (offset 0)
            if (range.startOffset === 0) {
                // Descobre o elemento HTML atual
                const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
                
                // V√™ quem √© o vizinho de cima
                let prevSibling = currentEl.previousElementSibling;
                
                // Se o vizinho de cima for um Dep√≥sito, BLOQUEIA
                if (prevSibling && prevSibling.classList.contains('ref-depot-wrapper')) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Opcional: Faz um pequeno flash visual para mostrar que bateu na parede
                    prevSibling.style.borderColor = "red";
                    setTimeout(() => prevSibling.style.borderColor = "", 300);
                    return;
                }
            }
        }

        // --- CEN√ÅRIO C: CURSOR ANTES DO BLOCO (DELETE) ---
        if (e.key === 'Delete' && selection.isCollapsed) {
            const anchorNode = selection.anchorNode;
            const textLength = anchorNode.textContent.length;

            // Se estamos no fim de um bloco de texto
            if (range.startOffset === textLength) {
                const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
                
                // V√™ quem √© o vizinho de baixo
                let nextSibling = currentEl.nextElementSibling;
                
                // Se o vizinho de baixo for um Dep√≥sito, BLOQUEIA
                if (nextSibling && nextSibling.classList.contains('ref-depot-wrapper')) {
                    e.preventDefault();
                    e.stopPropagation();
                    nextSibling.style.borderColor = "red";
                    setTimeout(() => nextSibling.style.borderColor = "", 300);
                    return;
                }
            }
        }
    }
});

// ADICIONA ESTA LINHA AQUI:
noteContentEditor.addEventListener('keydown', handleBoundaryProtection);

// E ADICIONA TAMB√âM ESTA PARA O ARQUIVO:
document.getElementById('archive-feed').addEventListener('keydown', (e) => {
    if (e.target.classList.contains('post-editor-content')) {
        handleBoundaryProtection(e);
    }
});

// ====================================================================
// L√ìGICA DE CORES DO TOGGLE
// ====================================================================
let activeToggleForColor = null;
const toggleColorPopup = document.getElementById('toggle-color-popup');

// 1. Abrir o Popup ao clicar no Pincel
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('.toggle-color-btn');
    if (!colorBtn) return;

    e.preventDefault(); e.stopPropagation();

    // Identifica o Toggle
    activeToggleForColor = colorBtn.closest('details.toggle-section');
    
    // Posiciona o Popup
    const rect = colorBtn.getBoundingClientRect();
    toggleColorPopup.style.display = 'block';
    toggleColorPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
    // Alinha para n√£o sair do ecr√£ √† direita
    toggleColorPopup.style.left = `${(rect.left + window.scrollX) - 100}px`;
});

// 2. Escolher a Cor (Delegation no Popup)
toggleColorPopup.addEventListener('click', (e) => {
    e.stopPropagation(); // Impede fechar ao clicar dentro

    // Bot√£o de cor
    if (e.target.classList.contains('color-choice')) {
        if (activeToggleForColor) {
            const color = e.target.dataset.color;
            // Aplica a cor ao fundo do Toggle e do conte√∫do
            activeToggleForColor.style.backgroundColor = color;
            activeToggleForColor.style.borderColor = color;
            
            // Opcional: Ajustar a cor do texto para preto para garantir contraste
            activeToggleForColor.style.color = '#333333'; 
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '#000000';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
    
    // Bot√£o Reset (Sem Cor)
    else if (e.target.classList.contains('color-choice-reset')) {
        if (activeToggleForColor) {
            activeToggleForColor.style.backgroundColor = '';
            activeToggleForColor.style.borderColor = '';
            activeToggleForColor.style.color = ''; // Volta ao padr√£o
            const h2 = activeToggleForColor.querySelector('h2');
            if(h2) h2.style.color = '';
            
            saveNote();
        }
        toggleColorPopup.style.display = 'none';
    }
});

// 3. Fechar ao clicar fora
document.addEventListener('click', (e) => {
    if (toggleColorPopup.style.display !== 'none') {
        if (!toggleColorPopup.contains(e.target) && !e.target.closest('.toggle-color-btn')) {
            toggleColorPopup.style.display = 'none';
            activeToggleForColor = null;
        }
    }
});

// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
// ADICIONE ESTE NOVO EVENT LISTENER NO FINAL DO SEU SCRIPT
// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
document.getElementById('generic-list-modal').addEventListener('click', (e) => {
    // Procura por um bot√£o de edi√ß√£o de anexo
    const editButton = e.target.closest('button[data-action="edit-anexo"]');
    if (editButton) {
        const anexoId = editButton.dataset.id;
        if (anexoId) {
            document.getElementById('generic-list-modal').style.display = 'none';
            openLinkModal(true, { id: anexoId });
        }
        return; // Termina a execu√ß√£o aqui
    }

    // <<<<<<< NOVO: Procura por um item de lista de tag clic√°vel >>>>>>>>>
    const tagListItem = e.target.closest('li[data-action="show-tag-references"]');
    if (tagListItem) {
        const tagName = tagListItem.dataset.tagName;
        if (tagName) {
            // 1. Fecha o modal de tags
            document.getElementById('generic-list-modal').style.display = 'none';
            // 2. Abre o painel de refer√™ncias para essa tag
            showTagReferencesPanel(tagName);
        }
    }
});


// ====================================================================
// 2. DETETAR CLIQUE NA IDEIA (Abrir Menu ‚úÇÔ∏è üß≤)
// ====================================================================
 window.activeIdeaElement = null; 

noteContentEditor.addEventListener('mousedown', (e) => {
    // Tenta encontrar o span da ideia onde clic√°mos
    const ideaSpan = e.target.closest('.idea-span');
    const ideaPopup = document.getElementById('idea-actions-popup');

    // Se clicou numa ideia
    if (ideaSpan) {
        console.log("üí° [IDEIA] Clique detetado. Guardando refer√™ncia...");
        
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // --- CORRE√á√ÉO DO ERRO ORTOGR√ÅFICO ---
        if (ideaSpan.spellcheck !== false) {
            ideaSpan.spellcheck = false;
            ideaSpan.setAttribute('spellcheck', 'false'); 
        }

        // >>> A CORRE√á√ÉO EST√Å AQUI: USAR window. <<<
        window.activeIdeaElement = ideaSpan;
        console.log("‚úÖ Refer√™ncia guardada em window.activeIdeaElement:", window.activeIdeaElement);

        // Movemos o popup para o body
        document.body.appendChild(ideaPopup);

        const rect = ideaSpan.getBoundingClientRect();
        
        ideaPopup.style.cssText = `
            display: flex !important;
            position: fixed !important;
            z-index: 2147483647 !important;
            top: ${rect.bottom + 5}px;
            left: ${rect.left}px;
            background: var(--sidebar-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            gap: 5px;
        `;
        
        return false;
    } 
    
    // Se clicou fora (em qualquer outro lugar do editor), fecha o menu
    if (ideaPopup && ideaPopup.style.display !== 'none') {
        if (!e.target.closest('#idea-actions-popup')) {
            ideaPopup.style.display = 'none';
            window.activeIdeaElement = null; // Limpa a refer√™ncia
        }
    }
});

// Listener extra global para fechar ao clicar fora do editor
document.addEventListener('mousedown', (e) => {
    const ideaPopup = document.getElementById('idea-actions-popup');
    if (ideaPopup && ideaPopup.style.display !== 'none') {
        // Se N√ÉO clicou na ideia E N√ÉO clicou no menu
        if (!e.target.closest('.idea-span') && !e.target.closest('#idea-actions-popup')) {
            ideaPopup.style.display = 'none';
            window.activeIdeaElement = null; // Limpa a refer√™ncia
        }
    }
});


// ====================================================================
// 3. A√á√ïES DO MENU DA IDEIA (‚úÇÔ∏è e üß≤)
// ====================================================================
const ideaPopupElement = document.getElementById('idea-actions-popup');

if (ideaPopupElement) {
    // Removemos ouvintes antigos clonando o elemento
    const newPopup = ideaPopupElement.cloneNode(true);
    ideaPopupElement.parentNode.replaceChild(newPopup, ideaPopupElement);

    newPopup.addEventListener('click', async (e) => {
        // 1. Identificar o bot√£o
        const btn = e.target.closest('button');
        if (!btn || !window.activeIdeaElement) return;

        // 2. Parar propaga√ß√£o
        e.preventDefault();
        e.stopPropagation(); 

        const action = btn.dataset.action;

        // --- A√á√ÉO ‚úÇÔ∏è: REMOVER IDEIA ---
        if (action === 'remove-idea') {
            const text = window.activeIdeaElement.textContent;
            const parent = window.activeIdeaElement.parentNode;
            
            const textNode = document.createTextNode(text);
            parent.replaceChild(textNode, window.activeIdeaElement);
            parent.normalize(); 

            if (typeof saveNote === 'function') saveNote();
            newPopup.style.display = 'none';
        }

        // --- A√á√ÉO üß≤: ADICIONAR A OUTRA NOTA ---
        else if (action === 'append-idea') {
            newPopup.style.display = 'none'; // Fecha o menu pequeno
            
            // Chama a fun√ß√£o corrigida abaixo
            if (typeof window.openNoteSelectorForIdea === 'function') {
                await window.openNoteSelectorForIdea();  
            } else {
                alert("Erro: Fun√ß√£o de transfer√™ncia n√£o encontrada.");
            }
        }
    });
}

// ====================================================================
// 4. FUN√á√ïES AUXILIARES PARA IDEIAS (Seletor e Transfer√™ncia)
// ====================================================================

window.openNoteSelectorForIdea = async function() {
    if (!selectedNoteId) return console.warn("Sem ID de nota selecionado.");

    const modal = document.getElementById('select-note-modal');
    const list = document.getElementById('select-note-list');
    
    if (!modal) return;

    // 1. BLINDAGEM VISUAL (Z-INDEX M√ÅXIMO)
    document.body.appendChild(modal); // Move para o topo do HTML
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* Fica acima de tudo */
        justify-content: center !important;
        align-items: center !important;
    `;

    list.innerHTML = '<li style="padding:15px; text-align:center;">A carregar notas...</li>';

    try {
        // Importa√ß√£o din√¢mica para garantir acesso ao DB
        const { collection, query, where, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // 2. Descobrir a pasta onde estamos
        const currentNoteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        if (!currentNoteSnap.exists()) return;
        
        const currentParentId = currentNoteSnap.data().parentId;

        // 3. Buscar vizinhos
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', currentParentId),
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty || (snapshot.size === 1 && snapshot.docs[0].id === selectedNoteId)) {
            list.innerHTML = '<li style="padding:15px; color:#888;">Nenhuma outra nota nesta pasta.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            // Ignora a pr√≥pria nota
            if (docSnap.id === selectedNoteId) return;

            const noteData = docSnap.data();
            const li = document.createElement('li');
            li.style.cssText = "padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center;";
            li.innerHTML = `<span style="margin-right: 10px;">üìÑ</span> <strong>${noteData.nome}</strong>`;
            
            // Clique para transferir
            li.onclick = () => window.transferIdeaToNote(docSnap.id, noteData);
            
            list.appendChild(li);
        });

    } catch (error) {
        console.error("Erro no √≠man:", error);
        list.innerHTML = '<li style="color:red; padding:15px;">Erro ao carregar lista.</li>';
    }
};

// Fun√ß√£o de Transfer√™ncia (Mant√©m-se, mas exposta globalmente)
window.transferIdeaToNote = async function(targetNoteId, targetNoteData) {
    if (!window.activeIdeaElement) return;

    const textToTransfer = window.activeIdeaElement.textContent;
    const modal = document.getElementById('select-note-modal');

    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Adiciona o texto ao final do conte√∫do existente
        const newContent = (targetNoteData.conteudo || "") + `<br><p>üí° ${textToTransfer}</p>`;

        const targetRef = doc(db, 'pastas', targetNoteId);
        await updateDoc(targetRef, {
            conteudo: newContent,
            ultimaedicao: serverTimestamp()
        });

        modal.style.display = 'none';
        
        // Feedback visual (Alerta simples)
        // Se tiver a fun√ß√£o showConfirmation ou alert
        alert(`‚úÖ Ideia enviada para "${targetNoteData.nome}"!`);

    } catch (error) {
        console.error("Erro ao transferir:", error);
        alert("Erro ao enviar ideia.");
    }
};


// 1. Abrir o Modal e Iniciar Navega√ß√£o
window.openAggregationSelector = function() {
    console.log("üß¨ [AGREGA√á√ÉO] Iniciando abertura do seletor...");

    const modal = document.getElementById('aggregation-modal');
    const nameSpan = document.getElementById('aggregation-new-name');
    
    if (!modal) {
        console.error("‚ùå Erro: Modal #aggregation-modal n√£o encontrado no HTML!");
        alert("Erro interno: Modal de agrega√ß√£o em falta.");
        return;
    }

    // 1. FOR√áA BRUTA VISUAL: Move para o Body e aplica Z-Index M√°ximo
    document.body.appendChild(modal);
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 20000000 !important; /* Acima de tudo */
        justify-content: center !important;
        align-items: center !important;
    `;
    
    // 2. CONFIGURA√á√ÉO DE DADOS
    // Reset das vari√°veis de navega√ß√£o
    aggregationStack = []; 
    aggregationSelectedItems = [];
    
    // Atualiza o contador visual (come√ßa a 0)
    if (typeof updateAggregationCount === 'function') {
        updateAggregationCount();
    }
    
    // Define o t√≠tulo
    if (nameSpan) nameSpan.textContent = aggregationTargetName || "Nova Agrega√ß√£o";
    
    // 3. CARREGAMENTO
    // Verifica a raiz (Superpasta ou Global)
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    
    console.log("üìÇ Carregando n√≠vel raiz:", startRootId);
    
    // Inicia o carregamento da lista
    if (typeof loadAggregationLevel === 'function') {
        loadAggregationLevel(startRootId);
    } else {
        console.error("‚ùå Erro: Fun√ß√£o loadAggregationLevel n√£o encontrada.");
        const list = document.getElementById('aggregation-list');
        if(list) list.innerHTML = "<li>Erro interno. Fun√ß√£o de carga em falta.</li>";
    }
};

// 2. Carregar N√≠vel (Pastas e Notas)
async function loadAggregationLevel(parentId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    
    // Atualiza breadcrumbs
    if (aggregationStack.length > 0) {
        pathSpan.textContent = aggregationStack[aggregationStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathSpan.textContent = parentId ? "Pasta Atual" : "Pasta Raiz";
        backBtn.style.display = 'none'; // Se estamos na base, esconde voltar
    }

    try {
        const q = query(
            collection(db, 'pastas'),
            where('parentId', '==', parentId),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('tipo'), // Pastas primeiro, depois notas (alfabeticamente depende do locale)
            orderBy('nome')
        );
        
        const snapshot = await getDocs(q);
        list.innerHTML = '';
        
        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Pasta vazia.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            
            const li = document.createElement('li');
            li.className = 'agreg-item';
            
            if (item.tipo === 'pasta') {
                li.classList.add('agreg-type-folder');
                li.innerHTML = `üìÅ ${item.nome}`;
                li.onclick = () => {
                    aggregationStack.push({ id: item.id, name: item.nome });
                    loadAggregationLevel(item.id);
                };
            } else if (item.tipo === 'nota') {
                li.classList.add('agreg-type-note');
                li.innerHTML = `üìÑ ${item.nome}`;
                li.onclick = () => {
                    // Ao clicar na nota, carregamos as caixas dentro dela
                    aggregationStack.push({ id: item.id, name: item.nome, type: 'nota' });
                    loadNoteBoxesForAggregation(item.id);
                };
            }
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao carregar itens.</li>';
    }
}

// 3. Carregar Caixas dentro de uma Nota (Parsing HTML)
async function loadNoteBoxesForAggregation(noteId) {
    const list = document.getElementById('aggregation-list');
    const backBtn = document.getElementById('agreg-back-btn');
    const pathSpan = document.getElementById('agreg-current-path');

    // Atualiza UI
    pathSpan.textContent = "üìÑ " + aggregationStack[aggregationStack.length - 1].name;
    backBtn.style.display = 'block';
    list.innerHTML = '<li style="padding:10px;">A analisar conte√∫do da nota...</li>';

    try {
        const noteDoc = await getDoc(doc(db, 'pastas', noteId));
        if (!noteDoc.exists()) return;

        const content = noteDoc.data().conteudo || "";
        
        // Parse do HTML da nota
        const parser = new DOMParser();
        const docHTML = parser.parseFromString(content, 'text/html');
        const wrappers = docHTML.querySelectorAll('.mini-note-wrapper');

        list.innerHTML = '';
        
        if (wrappers.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Esta nota n√£o tem Subnotas, Quest√µes ou Contentores.</li>';
            return;
        }

        wrappers.forEach((wrapper, index) => {
            // Extrair T√≠tulo
            let title = "Sem T√≠tulo";
            let typeClass = "";
            let typeLabel = "";

            // Detetar Tipo
            if (wrapper.classList.contains('question-mode')) {
                typeClass = "agreg-box-question";
                typeLabel = "Quest√£o";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "Quest√£o sem t√≠tulo";
            } else if (wrapper.classList.contains('free-mode')) {
                typeClass = "agreg-box-free";
                typeLabel = "Contentor";
                // L√≥gica de primeira frase para contentores livres
                const text = wrapper.querySelector('.mini-note-content').textContent.trim();
                if (text) {
                    const firstSentence = text.split(/[.!?]/)[0];
                    title = firstSentence.length > 50 ? firstSentence.substring(0, 50) + "..." : firstSentence;
                } else {
                    title = "Contentor Vazio";
                }
            } else {
                typeClass = "agreg-box-subnote";
                typeLabel = "SubNota";
                const input = wrapper.querySelector('input');
                title = input ? input.value : "SubNota sem t√≠tulo";
            }

            // Criar ID √∫nico tempor√°rio para controlo de sele√ß√£o
            const uniqueId = `${noteId}_${index}`;
            const isSelected = aggregationSelectedItems.some(i => i.uniqueId === uniqueId);

            const li = document.createElement('li');
            li.className = `agreg-box-item ${typeClass} ${isSelected ? 'selected' : ''}`;
            
            // Checkbox visual
            const check = isSelected ? "‚òëÔ∏è" : "‚¨ú";

            li.innerHTML = `
                <div style="font-size:1.2em;">${check}</div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:0.9em; color:var(--text-muted-color); text-transform:uppercase;">${typeLabel}</span>
                    <span style="color:var(--text-color);">${title}</span>
                </div>
            `;

            li.onclick = () => {
                toggleAggregationItem(uniqueId, wrapper.outerHTML, li);
            };

            list.appendChild(li);
        });

    } catch (e) {
        console.error(e);
        list.innerHTML = '<li>Erro ao ler nota.</li>';
    }
}

// 4. Selecionar/Desselecionar Item
function toggleAggregationItem(uniqueId, htmlContent, liElement) {
    const existingIndex = aggregationSelectedItems.findIndex(i => i.uniqueId === uniqueId);

    if (existingIndex > -1) {
        // Remover
        aggregationSelectedItems.splice(existingIndex, 1);
        liElement.classList.remove('selected');
        liElement.querySelector('div').textContent = "‚¨ú";
    } else {
        // Adicionar
        aggregationSelectedItems.push({ uniqueId, html: htmlContent });
        liElement.classList.add('selected');
        liElement.querySelector('div').textContent = "‚òëÔ∏è";
    }
    updateAggregationCount();
}

function updateAggregationCount() {
    document.getElementById('agreg-count').textContent = `${aggregationSelectedItems.length} itens selecionados`;
}

// 5. Navega√ß√£o "Voltar"
document.getElementById('agreg-back-btn').addEventListener('click', () => {
    
    // Determina qual √© a raiz l√≥gica (Superpasta ou Global)
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (aggregationStack.length > 0) {
        aggregationStack.pop(); // Remove n√≠vel atual
        
        if (aggregationStack.length > 0) {
            // Se ainda houver itens no hist√≥rico, carrega esse n√≠vel
            const parent = aggregationStack[aggregationStack.length - 1];
            if (parent.type === 'nota') {
                loadNoteBoxesForAggregation(parent.id);
            } else {
                loadAggregationLevel(parent.id);
            }
        } else {
            // Se o hist√≥rico ficou vazio, voltamos √† Raiz
            loadAggregationLevel(rootId);
        }
    } else {
        // Seguran√ßa: se clicar e j√° estiver vazio
        loadAggregationLevel(rootId);
    }
});

// 6. FINALIZAR: Criar a Nota com as Caixas
document.getElementById('agreg-finish-btn').addEventListener('click', async () => {
    if (aggregationSelectedItems.length === 0) {
        alert("Selecione pelo menos uma caixa.");
        return;
    }

    const btn = document.getElementById('agreg-finish-btn');
    btn.textContent = "A criar...";
    btn.disabled = true;

    try {
        // Constr√≥i o HTML final
        let finalHTML = "";
        aggregationSelectedItems.forEach(item => {
            finalHTML += item.html + "<p><br></p>"; 
        });

        // Determina a ordem
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', aggregationParentId), 
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const siblingsSnap = await getDocs(q);
        const newOrder = siblingsSnap.size;

        // --- ALTERA√á√ÉO AQUI: Guardamos a refer√™ncia do documento criado ---
        const docRef = await addDoc(collection(db, 'pastas'), {
            nome: aggregationTargetName, 
            parentId: aggregationParentId, 
            tipo: 'nota', 
            conteudo: finalHTML,
            userId: auth.currentUser.uid, 
            estado: 'ativa',
            ordem: newOrder, 
            createdAt: serverTimestamp(), 
            ultimaedicao: serverTimestamp()
        });

        // 1. Fechar o Modal
        document.getElementById('aggregation-modal').style.display = 'none';
        
        // 2. Abrir a Nota Imediatamente
        // Passamos 'null' no segundo argumento porque o elemento da lista 
        // ainda pode n√£o ter sido renderizado pelo onSnapshot, mas a fun√ß√£o abre pelo ID na mesma.
        displayNote(docRef.id, null); 
        
    } catch (e) {
        console.error("Erro ao criar agrega√ß√£o:", e);
        alert("Erro ao criar.");
    } finally {
        btn.textContent = "Criar Agrega√ß√£o";
        btn.disabled = false;
    }
});

// ====================================================================
// SCANNER UNIVERSAL (üé∞) - B√≠blia, Personagens, Locais, Datas
// ====================================================================

let universalScanResults = {
    textobiblico: { new: [], existing: [] },
    personagem: { new: [], existing: [] },
    local: { new: [], existing: [] },
    data: { new: [], existing: [] }
};
let currentScanTab = 'textobiblico';


// 2. FUN√á√ÉO PRINCIPAL: ANALISAR TEXTO
async function openUniversalScanner() {
    const modal = document.getElementById('universal-scan-modal');
    if (!modal) return;

    // --- FOR√áA BRUTA DE VISIBILIDADE ---
    document.body.appendChild(modal); // Move para a raiz do body
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9000000"; // Acima de quase tudo
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Reset total de resultados
    universalScanResults = {
        textobiblico: { new: [], existing: [] },
        personagem: { new: [], existing: [] },
        local: { new: [], existing: [] },
        data: { new: [], existing: [] }
    };
    

    // --- FASE 1: J√Å EXISTENTES (Guardar refer√™ncia do elemento) ---
    const existingLinks = noteContentEditor.querySelectorAll('.entity-link');
    existingLinks.forEach(link => {
        const type = link.dataset.entityType;
        if (universalScanResults[type]) {
            universalScanResults[type].existing.push({
                linkElement: link, // Guardamos o elemento DOM para poder remover
                text: link.textContent,
                line: getApproximateLineNumber(link),
                selected: true // J√° √© link, logo come√ßa "Ativo"
            });
        }
    });

    // --- FASE 2: NOVOS CANDIDATOS ---
    const biblicalBooksPattern = BIBLICAL_BOOKS.join('|');
    const bibleRegex = new RegExp(`\\b((?:${biblicalBooksPattern})\\s+\\d+:\\d[\\d,;\\- ]*)\\b`, 'gi');
    const dateRegex = /\b\d{1,2}[-\/]\d{1,2}[-\/]\d{4}\b/g;

    const walker = document.createTreeWalker(noteContentEditor, NodeFilter.SHOW_TEXT);
    let node;

    while (node = walker.nextNode()) {
        if (node.parentElement.closest('.entity-link, a, .tag, script, style')) continue;

        const text = node.textContent;
        const lineNum = getApproximateLineNumber(node);

        // A. B√≠blia
        let match;
        while ((match = bibleRegex.exec(text)) !== null) {
            addCandidate('textobiblico', match[0], node, match.index, lineNum);
        }
        // B. Datas
        while ((match = dateRegex.exec(text)) !== null) {
            addCandidate('data', match[0], node, match.index, lineNum);
        }
        // C. Personagens/Locais (BD)
        checkDatabaseEntities(text, node, lineNum, 'personagem');
        checkDatabaseEntities(text, node, lineNum, 'local');
    }

    renderScanTab(currentScanTab);
    modal.style.display = 'flex';
}

function addCandidate(type, matchText, textNode, index, lineNum, cleanName = null) {
    const finalName = cleanName || matchText.trim().replace(/[.,;]+$/, '');
    
    const exists = universalScanResults[type].new.some(c => c.textNode === textNode && c.index === index);
    if (exists) return;

    universalScanResults[type].new.push({
        textNode: textNode,
        matchText: matchText,
        cleanName: finalName,
        index: index,
        line: lineNum,
        contextSnippet: getContextSnippet(textNode.textContent, index, matchText.length),
        selected: false // Novos come√ßam "Inativos" (Texto simples)
    });
}

function checkDatabaseEntities(text, node, lineNum, type) {
    if (!allEntities[type]) return;
    allEntities[type].forEach(entity => {
        const regex = new RegExp(`\\b${escapeRegExp(entity.nome)}\\b`, 'g');
        let match;
        while ((match = regex.exec(text)) !== null) {
            addCandidate(type, match[0], node, match.index, lineNum, entity.nome); 
        }
    });
}

// 3. RENDERIZA√á√ÉO DA ABA ATUAL
function renderScanTab(type) {
    const container = document.getElementById('scan-lists-container');
    container.innerHTML = '';
    const data = universalScanResults[type];
    
    // Atualiza o texto do bot√£o Select All
    updateSelectAllButtonState();

    // --- LISTA DE NOVOS (Check = Criar Link) ---
    if (data.new.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.textContent = `‚ö° Novos Detetados (${data.new.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.new.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'new');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    } else {
        container.innerHTML += '<div style="padding:10px; color:#888;">Nada novo aqui.</div>';
    }

    // --- LISTA DE EXISTENTES (Uncheck = Remover Link) ---
    if (data.existing.length > 0) {
        const title = document.createElement('div');
        title.className = 'scan-section-title';
        title.style.color = "#2ecc71";
        title.textContent = `‚úì J√° Identificados (${data.existing.length})`;
        container.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'move-list';
        
        data.existing.forEach((item, idx) => {
            const li = createScanListItem(item, idx, 'existing');
            ul.appendChild(li);
        });
        container.appendChild(ul);
    }
}

// Fun√ß√£o auxiliar para criar o HTML da linha
function createScanListItem(item, idx, listType) {
    const li = document.createElement('li');
    li.className = 'scan-item-row';
    
    // Nome do item (cleanName para novos, text para existentes)
    const displayName = listType === 'new' ? item.cleanName : item.text;
    const isChecked = item.selected ? 'checked' : '';
    
    // Estilo visual: se for existente e estiver desmarcado, risca o texto
    const textStyle = (listType === 'existing' && !item.selected) ? 'text-decoration: line-through; opacity: 0.6;' : '';

    li.innerHTML = `
        <input type="checkbox" class="scan-checkbox" id="scan-${listType}-${idx}" ${isChecked}>
        <div class="scan-info" style="${textStyle}">
            <span class="scan-name">${displayName}</span>
            <span class="scan-location">Linha aprox. ${item.line}</span>
        </div>
        ${listType === 'new' ? '<button class="scan-preview-btn" title="Ver Contexto">üîç</button>' : ''}
    `;

    // Evento de Clique na Linha
    li.addEventListener('click', (e) => {
        if (e.target.closest('.scan-preview-btn')) return;
        
        const checkbox = li.querySelector('input');
        if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
        
        // Atualiza modelo
        item.selected = checkbox.checked;
        
        // Atualiza visual (riscar se for para remover)
        const infoDiv = li.querySelector('.scan-info');
        if (listType === 'existing') {
            infoDiv.style.textDecoration = item.selected ? 'none' : 'line-through';
            infoDiv.style.opacity = item.selected ? '1' : '0.6';
        }

        updateSelectAllButtonState();
    });

    // Lupa (apenas para novos)
    if (listType === 'new') {
        li.querySelector('.scan-preview-btn').onclick = (e) => {
            e.stopPropagation();
            showScanPreview(item.cleanName, item.contextSnippet);
        };
    }

    return li;
}

// 4. L√ìGICA DO BOT√ÉO "SELECIONAR TODOS / REMOVER TODOS"
const toggleAllBtn = document.getElementById('scan-toggle-all-btn');

function updateSelectAllButtonState() {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    
    if (totalItems === 0) {
        toggleAllBtn.style.display = 'none';
        return;
    }
    toggleAllBtn.style.display = 'block';
    
    // Verifica se TODOS (novos e existentes) est√£o marcados
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    
    // Se tudo estiver marcado, o bot√£o diz "Remover Todos". Sen√£o, "Selecionar Todos".
    const allSelected = allNewSelected && allExistSelected;
    toggleAllBtn.textContent = allSelected ? "Desmarcar Todos" : "Selecionar Todos";
}

toggleAllBtn.addEventListener('click', () => {
    const data = universalScanResults[currentScanTab];
    const totalItems = data.new.length + data.existing.length;
    if (totalItems === 0) return;

    // L√≥gica: Se tudo marcado -> desmarca tudo. Sen√£o -> marca tudo.
    const allNewSelected = data.new.every(i => i.selected);
    const allExistSelected = data.existing.every(i => i.selected);
    const newState = !(allNewSelected && allExistSelected);

    // 1. Atualiza Dados
    data.new.forEach(i => i.selected = newState);
    data.existing.forEach(i => i.selected = newState);

    // 2. Re-renderiza a lista para atualizar visuais (riscos e checkboxes)
    renderScanTab(currentScanTab);
});

// 5. GEST√ÉO DE ABAS
document.querySelector('.scan-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('scan-tab-btn')) {
        document.querySelectorAll('.scan-tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentScanTab = e.target.dataset.target;
        document.getElementById('scan-preview-popup').style.display = 'none';
        renderScanTab(currentScanTab);
    }
});

// 6. PREVIEW e CONTEXTO
function showScanPreview(name, snippet) {
    const popup = document.getElementById('scan-preview-popup');
    const content = document.getElementById('scan-preview-content');
    const safeName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const highlightedHTML = snippet.replace(new RegExp(`(${safeName})`, 'gi'), '<mark>$1</mark>');
    content.innerHTML = `... ${highlightedHTML} ...`;
    popup.style.display = 'block';
}

function getContextSnippet(fullText, index, length) {
    const start = Math.max(0, index - 40);
    const end = Math.min(fullText.length, index + length + 40);
    return fullText.substring(start, end);
}

function getApproximateLineNumber(node) {
    const block = node.nodeType === 3 ? node.parentElement.closest('p, div, li, h1, h2') : node.closest('p, div, li, h1, h2');
    if (!block) return 1;
    let count = 1;
    let current = block;
    while (current = current.previousElementSibling) count++;
    return count;
}

// 7. APLICAR MUDAN√áAS (CONVERTER E REVERTER)
document.getElementById('confirm-scan-btn').addEventListener('click', async () => {
    
    // Altera o texto do bot√£o para feedback
    const confirmBtn = document.getElementById('confirm-scan-btn');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = "A processar...";
    confirmBtn.disabled = true;

    let changesMade = false;

    // Percorre TODAS as abas (tipos)
    for (const type in universalScanResults) {
        
        // --- A. CONVERTER NOVOS (Que est√£o selecionados) ---
        const newToConvert = universalScanResults[type].new.filter(i => i.selected);
        
        // Ordena inversamente (baixo para cima) para n√£o estragar √≠ndices
        newToConvert.sort((a, b) => {
            if (a.textNode === b.textNode) return b.index - a.index;
            return 0;
        });

        for (const item of newToConvert) {
            try {
                if (item.textNode.textContent.includes(item.matchText)) {
                    const textNode = item.textNode;
                    const splitTarget = textNode.splitText(item.index);
                    splitTarget.splitText(item.matchText.length); // Isola o texto
                    
                    const span = document.createElement('span');
                    span.className = 'entity-link';
                    span.dataset.entityType = type;
                    span.dataset.entityName = item.cleanName;
                    span.textContent = item.cleanName;

                    splitTarget.parentNode.replaceChild(span, splitTarget);
                    
                    // Atualiza BD
                    await ensureEntityReference(type, item.cleanName);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro convers√£o:", e); }
        }

        // --- B. REMOVER EXISTENTES (Que foram desmarcados) ---
        const existingToRemove = universalScanResults[type].existing.filter(i => !i.selected);
        
        for (const item of existingToRemove) {
            try {
                const linkEl = item.linkElement;
                if (linkEl && linkEl.parentNode) {
                    const textNode = document.createTextNode(linkEl.textContent);
                    linkEl.parentNode.replaceChild(textNode, linkEl);
                    changesMade = true;
                }
            } catch (e) { console.error("Erro revers√£o:", e); }
        }
    }

    if (changesMade) {
        noteContentEditor.normalize(); // Limpa DOM
        updateSaveStatus('unsaved');
        saveNote();
        
        // Recarrega cache
        if(typeof fetchAllEntities === 'function') fetchAllEntities();
    }

    document.getElementById('universal-scan-modal').style.display = 'none';
    
    // Restaura bot√£o
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
});

// Auxiliar BD (Igual)
async function ensureEntityReference(type, name) {
    const flatEntities = Object.values(allEntities).flat();
    const existing = flatEntities.find(e => e.tipo === type && e.nome === name);
    const collectionName = ENTITY_CONFIG[type].collection;

    if (!existing) {
        try {
            await addDoc(collection(db, collectionName), {
                nome: name, descricao: "", userId: auth.currentUser.uid,
                createdAt: serverTimestamp(), referencias: { [selectedNoteId]: true }
            });
            if(!allEntities[type]) allEntities[type] = [];
            allEntities[type].push({ id: 'temp', nome: name, tipo: type });
        } catch(e) { console.error(e); }
    }
}

// ====================================================================
// L√ìGICA DE CRIA√á√ÉO DE NOVOS MARCADORES (+)
// ====================================================================

// 1. Abrir o popup de criar marcador ao clicar no "+"
const openCreateBookmarkBtn = document.getElementById('open-create-bookmark-btn');
if (openCreateBookmarkBtn) {
    // Removemos o listener antigo para evitar conflitos e criamos um novo
    const newBtn = openCreateBookmarkBtn.cloneNode(true);
    openCreateBookmarkBtn.parentNode.replaceChild(newBtn, openCreateBookmarkBtn);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const modal = document.getElementById('create-bookmark-modal');
        if (!modal) return;

        // --- CORRE√á√ÉO DE HIERARQUIA ---
        // Move o modal para o final do body para n√£o ficar preso atr√°s de outros modais
        document.body.appendChild(modal);
        
        // Limpa os campos
        document.getElementById('new-bookmark-title').value = '';
        document.getElementById('new-bookmark-desc').value = '';
        
        // For√ßa a visibilidade no topo absoluto
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "10000000"; // Um n√≠vel acima do modal anterior
        modal.style.visibility = "visible";
        modal.style.opacity = "1";
        
        // Foca no input
        setTimeout(() => {
            const input = document.getElementById('new-bookmark-title');
            if(input) input.focus();
        }, 100);
    });
}

// 2. Bot√£o Cancelar (Fechar o popup)
const cancelCreateBookmarkBtn = document.getElementById('cancel-create-bookmark');
if (cancelCreateBookmarkBtn) {
    cancelCreateBookmarkBtn.addEventListener('click', () => {
        document.getElementById('create-bookmark-modal').style.display = 'none';
    });
}

// 3. Bot√£o Criar (Gravar na Base de Dados)
const confirmCreateBookmarkBtn = document.getElementById('confirm-create-bookmark');
if (confirmCreateBookmarkBtn) {
    confirmCreateBookmarkBtn.addEventListener('click', async () => {
        const titleInput = document.getElementById('new-bookmark-title');
        const descInput = document.getElementById('new-bookmark-desc');
        
        const nome = titleInput.value.trim();
        const descricao = descInput.value.trim();

        if (!nome) {
            alert("O t√≠tulo do marcador √© obrigat√≥rio.");
            return;
        }

        // Feedback visual
        const originalText = confirmCreateBookmarkBtn.textContent;
        confirmCreateBookmarkBtn.textContent = "A criar...";
        confirmCreateBookmarkBtn.disabled = true;

        try {
            // Importar fun√ß√µes do Firestore (j√° devem estar importadas no topo do seu ficheiro)
            // addDoc, collection, serverTimestamp, auth, db...

            await addDoc(collection(db, 'marcadores'), {
                nome: nome,
                descricao: descricao,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Sucesso: Fecha o modal e recarrega a lista
            document.getElementById('create-bookmark-modal').style.display = 'none';
            
            // Recarrega a lista do modal principal para mostrar o novo item
            await openBookmarksModal(); 

        } catch (error) {
            console.error("Erro ao criar marcador:", error);
            alert("Erro ao criar o marcador. Verifique a consola.");
        } finally {
            // Restaura o bot√£o
            confirmCreateBookmarkBtn.textContent = originalText;
            confirmCreateBookmarkBtn.disabled = false;
        }
    });
}

  noteContentEditor.addEventListener('keyup', (event) => {
    // Ignora teclas de navega√ß√£o
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab'].includes(event.key)) {
        return;
    }
    
    if (isTagPopupOpen || isEntityPopupOpen) {
        if (['Enter', ' '].includes(event.key)) return;
    }

    if (event.key === 'Escape') { 
        hideTagPopup();
        hideEntityPopup();
        return; 
    }

    const selection = window.getSelection();
    if (!selection.rangeCount > 0) return;
    const range = selection.getRangeAt(0);
    const container = range.startContainer;
    const offset = range.startOffset;

    // Texto ANTES do cursor
    const textBeforeCursor = container.textContent.substring(0, offset);
    
    // Texto DEPOIS do cursor
    const textAfterCursor = container.textContent.substring(offset);

    const tagMatch = textBeforeCursor.match(/#(\w*)$/);
    const entityMatch = textBeforeCursor.match(/@([\w\s]*)$/);

    if (tagMatch) {
        hideEntityPopup();
        currentTagQueryRange = document.createRange();
        currentTagQueryRange.setStart(container, tagMatch.index);
        currentTagQueryRange.setEnd(container, offset);
        showTagPopup(tagMatch[1]);

    } else if (entityMatch) {
        hideTagPopup();
        currentEntityQueryRange = document.createRange();
        
        // Ponto de in√≠cio: onde est√° o @
        currentEntityQueryRange.setStart(container, entityMatch.index);

        // --- L√ìGICA DE "ETIQUETAGEM INTELIGENTE" ---
        
        // Verifica se o utilizador acabou de digitar o @ (query vazia)
        // E se existe uma palavra "colada" logo √† frente do cursor
        const isAtStartOfWord = entityMatch[1] === '' && /^\w/.test(textAfterCursor);

        if (isAtStartOfWord) {
            // Identifica a palavra que est√° √† frente (ex: "David" em "@|David")
            const wordAfterMatch = textAfterCursor.match(/^(\w+)/);
            
            if (wordAfterMatch) {
                const wordToConsume = wordAfterMatch[1];
                
                // Expande o range de substitui√ß√£o para incluir a palavra da frente
                currentEntityQueryRange.setEnd(container, offset + wordToConsume.length);
                
                // Usa a palavra da frente como pesquisa para o popup
                showEntityPopup(wordToConsume);
                return; // Sai para n√£o executar o showEntityPopup normal abaixo
            }
        }

        // Comportamento normal (escrevendo novo texto)
        currentEntityQueryRange.setEnd(container, offset);
        showEntityPopup(entityMatch[1]);

    } else {
        hideTagPopup();
        hideEntityPopup();
    }
    
});



// 1. ESCUTAR O CLIQUE NO BOT√ÉO üß¨
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="append-mini-note"]');
    if (!btn) return;

    e.preventDefault(); e.stopPropagation();

    // Captura o HTML da caixa inteira
    const wrapper = btn.closest('.mini-note-wrapper');
    if (wrapper) {
        // Clonamos para garantir que n√£o alteramos o original durante a c√≥pia
        htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
        openAppendModal();
    }
});

// 2. ABRIR O MODAL
 window.openAppendModal = function() {
    console.log("üöÄ [CLONAR] Abertura iniciada...");
    
    const modal = document.getElementById('append-to-note-modal');
    if (!modal) return console.error("Modal #append-to-note-modal n√£o encontrado!");

    // --- INJE√á√ÉO DO SELETOR DE MODO ---
    const actionsDiv = modal.querySelector('.modal-actions');
    
    // Verifica se j√° existe para n√£o duplicar
    if (!actionsDiv.querySelector('.append-mode-selector')) {
        const selectorHTML = `
            <div class="append-mode-selector" style="margin-right: auto;">
                <div class="append-mode-option active" data-value="copy" onclick="window.setAppendMode('copy', this)">ü™û C√≥pia</div>
                <div class="append-mode-option" data-value="statue" onclick="window.setAppendMode('statue', this)">üóø Card</div>
            </div>
        `;
        // Insere no in√≠cio da div de a√ß√µes (√† esquerda do Cancelar)
        actionsDiv.insertAdjacentHTML('afterbegin', selectorHTML);
    } else {
        // Reset para "C√≥pia" ao abrir
        window.setAppendMode('copy', actionsDiv.querySelector('[data-value="copy"]'));
    }
    // -----------------------------------

    document.body.appendChild(modal);
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important; left: 0 !important; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important;
        justify-content: center !important;
        align-items: center !important;
    `;

    appendStack = [];
    const rootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;
    loadAppendList(rootId);
};

// Fun√ß√£o auxiliar para trocar o modo
window.appendMode = 'copy'; // Vari√°vel global de estado

window.setAppendMode = function(mode, btnElement) {
    window.appendMode = mode;
    
    // Atualiza visual
    const parent = btnElement.parentElement;
    parent.querySelectorAll('.append-mode-option').forEach(el => el.classList.remove('active'));
    btnElement.classList.add('active');
};

// 3. CARREGAR LISTA (PASTAS E NOTAS)
async function loadAppendList(parentId) {
    const list = document.getElementById('append-list');
    const backBtn = document.getElementById('append-back-btn');
    const pathLabel = document.getElementById('append-current-path');
    const myUid = auth.currentUser.uid;
    
    list.innerHTML = '<li style="padding:10px;">A carregar...</li>';

    // Identifica o ponto de partida
    const startRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    // Gest√£o de T√≠tulos e Bot√£o Voltar
    if (parentId === "VIRTUAL_SHARED_ROOT") {
        pathLabel.textContent = "ü§ù Partilha";
        backBtn.style.display = 'block';
    } else if (appendStack.length > 0) {
        pathLabel.textContent = appendStack[appendStack.length - 1].name;
        backBtn.style.display = 'block';
    } else {
        pathLabel.textContent = (startRootId) ? "üè† Superpasta" : "üåç Raiz Global";
        backBtn.style.display = 'none';
    }

    try {
        const foldersRef = collection(db, 'pastas');
        let unifiedDocs = new Map();

        // --- BLOCO A: BUSCAR ARQUIVOS PARTILHADOS ---
        if (parentId === "VIRTUAL_SHARED_ROOT") {
            const qOwner = query(foldersRef, 
                where('tipo', '==', 'partilhado'), 
                where('estado', '==', 'ativa'),
                where('userId', '==', myUid)
            );
            const qCollab = query(foldersRef, 
                where('tipo', '==', 'partilhado'), 
                where('estado', '==', 'ativa'),
                where(`colaboradores.${myUid}`, '==', true)
            );

            const [snapOwner, snapCollab] = await Promise.all([getDocs(qOwner), getDocs(qCollab)]);
            snapOwner.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
            snapCollab.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
        } 
        // --- BLOCO B: BUSCAR NORMAL (ORDENADO POR 'ORDEM') ---
        else {
            const qNormal = query(foldersRef,
                where('parentId', '==', parentId),
                where('estado', '==', 'ativa'),
                where('userId', '==', myUid),
                orderBy('ordem') // <--- AQUI EST√Å O SEGREDO: Pede j√° ordenado ao Firebase
            );
            const snapNormal = await getDocs(qNormal);
            snapNormal.forEach(doc => unifiedDocs.set(doc.id, {id: doc.id, ...doc.data()}));
        }

        // LIMPAR LISTA E RENDERIZAR
        list.innerHTML = '';

        // 1. Link para Partilha (se na raiz)
        if (parentId === startRootId) {
            const sharedLink = document.createElement('li');
            sharedLink.style.cssText = "display:flex; justify-content:space-between; padding:12px; border-bottom:2px solid var(--border-color); background: rgba(231, 76, 60, 0.05); cursor:pointer; color: #e74c3c; font-weight: bold;";
            sharedLink.innerHTML = `<span>ü§ù Partilha (Arquivos)</span> <span>‚ûî</span>`;
            sharedLink.onclick = () => loadAppendList("VIRTUAL_SHARED_ROOT");
            list.appendChild(sharedLink);
        }

        // 2. Renderizar Itens
        if (unifiedDocs.size === 0 && parentId !== startRootId && parentId !== null) {
            list.innerHTML += '<li style="padding:20px; color:#888; text-align:center;">Vazio.</li>';
        }

        // Converte para array e garante a ordena√ß√£o JS (caso o Firebase falhe ou misture tipos)
        Array.from(unifiedDocs.values())
        .sort((a, b) => {
            // Se ambos tiverem o campo ordem, usa-o.
            // Se um n√£o tiver (notas antigas), assume 0 ou ordem alfab√©tica como fallback
            const ordemA = (a.ordem !== undefined) ? a.ordem : 9999;
            const ordemB = (b.ordem !== undefined) ? b.ordem : 9999;
            return ordemA - ordemB;
        })
        .forEach(item => {
            const li = document.createElement('li');
            li.className = "list-item";
            li.style.cssText = "display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border-color); cursor:pointer;";
            
            if (item.tipo === 'pasta' || item.tipo === 'agregacao') {
                li.innerHTML = `<span>üìÅ ${item.nome}</span> <span>‚ûî</span>`;
                li.onclick = () => {
                    appendStack.push({ id: item.id, name: item.nome });
                    loadAppendList(item.id);
                };
            } else {
                // Notas, Arquivos, Jornais, Aqu√°rios
                const isOwner = item.userId === myUid;
                let icon = 'üìÑ';
                if (item.tipo === 'partilhado' || item.tipo === 'arquivo') icon = 'üóÑÔ∏è';
                if (item.tipo === 'jornal') icon = 'üì∞';
                if (item.tipo === 'aquario') icon = 'ü™∏';
                
                const collabIcon = (parentId === "VIRTUAL_SHARED_ROOT") ? (isOwner ? 'üëë' : 'ü§ù') : '';
                
                li.innerHTML = `
                    <span>${icon} ${collabIcon} ${item.nome}</span> 
                    <span title="Enviar para o Topo">üì•</span>
                `;
                li.onclick = () => confirmAppendToNote(item.id, item.nome, item.tipo);
            }
            list.appendChild(li);
        });

    } catch (e) {
        console.error("Erro no modal:", e);
        list.innerHTML = '<li>Erro de liga√ß√£o.</li>';
    }
}

// 4. BOT√ÉO VOLTAR (L√≥gica de "Escape" da Superpasta)
// Remova o listener antigo e coloque este:
const appendBackBtn = document.getElementById('append-back-btn');
// Clonamos para remover listeners antigos e evitar duplica√ß√£o
const newAppendBackBtn = appendBackBtn.cloneNode(true);
appendBackBtn.parentNode.replaceChild(newAppendBackBtn, appendBackBtn);

newAppendBackBtn.addEventListener('click', () => {
    // Verifica se estamos numa Superpasta
    const superRootId = (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) ? SUPERFOLDER_ID : null;

    if (appendStack.length > 0) {
        // Comportamento normal: remove o √∫ltimo passo
        appendStack.pop();
        
        // Se a pilha ainda tiver itens, carrega o anterior.
        // Se ficou vazia, carrega o ponto de partida (que √© o superRootId)
        const parent = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : superRootId;
        
        loadAppendList(parent);
    } else {
        // A pilha est√° vazia, mas clic√°mos em "Voltar".
        // Isso significa que estamos na raiz da Superpasta e queremos ir para a GLOBAL.
        loadAppendList(null);
    }
});

// 5. CONFIRMAR E GRAVAR
window.confirmAppendToNote = async function(targetId, targetName, targetType) {
    console.log(`üì• [CLONAR] Modo: ${window.appendMode} -> Destino: ${targetName}`);

    const confirmModal = document.getElementById('confirm-modal');
    const appendModal = document.getElementById('append-to-note-modal');

    if (appendModal) appendModal.style.zIndex = '2147483640'; 
    if (confirmModal) confirmModal.style.setProperty('z-index', '2147483647', 'important');

    const actionText = window.appendMode === 'statue' ? "criar um Card Est√°tua" : "clonar este bloco";
    const confirmed = await showConfirmation("Confirmar Envio", `Deseja ${actionText} em "${targetName}"?`);

    if (!confirmed) {
        if (appendModal) appendModal.style.zIndex = '2147483647';
        if (confirmModal) confirmModal.style.display = 'none';
        return;
    }

    try {
        const { doc, getDoc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', targetId);
        
        let finalContentToAppend = "";

        // --- MODO EST√ÅTUA üóø ---
if (window.appendMode === 'statue') {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = window.htmlToAppend;
            const originalWrapper = tempDiv.firstElementChild;
            
            if (!originalWrapper) throw new Error("Conte√∫do inv√°lido.");
            
            const originBoxId = originalWrapper.id || `box_${Date.now()}`;
            const titleInput = originalWrapper.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
            let titleVal = titleInput ? (titleInput.value || titleInput.textContent) : "";
            const bodyDiv = originalWrapper.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content, .cube-content');
            let bodyVal = bodyDiv ? bodyDiv.innerHTML : "";

            const statueId = `statue_${Date.now()}`;
            
            // AQUI: Inserimos o bot√£o DIRETAMENTE no HTML com o data-action correto
            const jumpAction = `event.preventDefault(); window.handleGoToNote('${selectedNoteId}', '${originBoxId}')`;

            // >>> CORRE√á√ÉO APLICADA ABAIXO NA VARI√ÅVEL finalContentToAppend <<<
            finalContentToAppend = `
                <div class="mini-note-wrapper statue-card-wrapper" id="${statueId}" 
                     data-origin-note="${selectedNoteId}" 
                     data-origin-box="${originBoxId}" 
                     data-shared="false" 
                     contenteditable="false">
                    
                    <div class="mini-note-toolbar" contenteditable="false">
                        <button type="button" data-action="sharing-settings" title="Partilha (Independente)">üîê</button>
                        <div class="toolbar-btn-group">
                            <button type="button" data-action="move-up" title="Subir">üî∫</button>
                            <button type="button" data-action="move-down" title="Descer">üîª</button>
                        </div>
                        <button type="button" data-action="highlight-color" title="Cor (Independente)">üé®</button>
                        
                        <button type="button" data-action="jump-to-origin" onclick="${jumpAction}" title="Ir para Origem" 
                                style="color: #a569bd; font-weight: bold; border-color: #a569bd; margin-right:2px;">üóø</button>

                        <button type="button" data-action="delete-mini-note" title="Apagar Est√°tua">üóëÔ∏è</button>
                    </div>

                    <div class="statue-content-lock">
                        ${titleVal ? `<strong style="display:block; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:3px;">${titleVal}</strong>` : ''}
                        <div>${bodyVal}</div>
                    </div>
                </div>
                <p><br></p>
            `;
            
        } else {
            // --- MODO C√ìPIA ü™û ---
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = window.htmlToAppend;
            const wrapper = tempDiv.firstElementChild;
            if (wrapper) {
                const oldId = wrapper.id;
                const prefix = oldId.split('_')[0] || 'mn';
                const newId = `${prefix}_${Date.now()}_clone`;
                wrapper.id = newId;
                wrapper.setAttribute('data-origin-id', oldId);
                wrapper.classList.remove('active-selection', 'active-store-target', 'locked-popup');
                wrapper.style.border = "";
                wrapper.style.boxShadow = "";
                wrapper.style.backgroundColor = "";

                if (wrapper.classList.contains('redator-wrapper')) {
                    const header = wrapper.querySelector('.redator-header');
                    if(header) header.id = `header-${newId}`;
                    const btn = wrapper.querySelector('.redator-reopen-btn');
                    if (btn) btn.setAttribute('onclick', `window.toggleRedatorHeader('${newId}', true)`);
                    const content = wrapper.querySelector('.redator-content');
                    if (content) content.setAttribute('oninput', `window.checkRedatorFocus(this, '${newId}')`);
                }
                finalContentToAppend = tempDiv.innerHTML;
            }
        }

        // --- GRAVA√á√ÉO ---
        const docSnap = await getDoc(noteRef);
        const data = docSnap.data();

        if (targetType === 'partilhado' || targetType === 'arquivo') {
             const authorName = currentUserData?.nome || "Eu";
             const newPostData = {
                id: `post_${Date.now()}`,
                type: 'entity',
                title: window.appendMode === 'statue' ? 'üóø Est√°tua Recebida' : 'ü™û C√≥pia Recebida',
                content: finalContentToAppend,
                userId: auth.currentUser.uid,
                createdBy: authorName,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                ordem: -Date.now()
            };
            const subCollectionRef = doc(db, 'pastas', targetId, 'posts', newPostData.id);
            await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js").then(mod => mod.setDoc(subCollectionRef, newPostData));
            await updateDoc(noteRef, { ultimaedicao: serverTimestamp(), lastEditorId: auth.currentUser.uid });

        } else {
            const currentContent = data.conteudo || "";
            const newContent = currentContent + finalContentToAppend;
            await updateDoc(noteRef, { conteudo: newContent, ultimaedicao: serverTimestamp() });
        }

        if (confirmModal) confirmModal.style.display = 'none';
        if (appendModal) appendModal.style.display = 'none';
        await window.showSuccessAlert("Sucesso! ‚úÖ", `Enviado para "${targetName}".`);

    } catch (e) {
        console.error("Erro ao enviar:", e);
        alert("Erro no envio.");
    }
};



// --- FUN√á√ÉO UNIFICADA DE PARTILHA E CO-EDI√á√ÉO ---
async function updateSharingSettings() {
    if (!selectedNoteId || !auth.currentUser) return;

    try {
        // 1. Obter Estados Atuais
        const isShared = document.getElementById('note-share-toggle').checked;
        
        // NOVO: Captura o estado do All Unlock
        const allUnlockCheckbox = document.getElementById('share-allunlock-toggle');
        const isAllUnlock = allUnlockCheckbox ? allUnlockCheckbox.checked : true;

        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        // Refer√™ncias Visuais
        const urlInput = document.getElementById('note-share-url');
        const toolbarLockBtn = document.querySelector('button[data-action="note-sharing-settings"]');

        let shareId = currentNoteShareData?.shareId || selectedNoteId;

        // 2. Atualizar Nota Privada (Base de Dados)
        const newSettings = {
            ...currentNoteShareData, 
            shared: isShared,
            allunlock: isAllUnlock, // <--- GRAVA AQUI
            shareId: shareId,
            updatedAt: serverTimestamp()
        };

        await updateDoc(noteRef, { shareSettings: newSettings });
        currentNoteShareData = newSettings;

        // 3. Gerir Documento P√∫blico
        if (isShared) {
            
            // Visual
            if (urlInput) {
                urlInput.style.color = "#4a90e2";
                urlInput.style.borderColor = "#4a90e2";
                urlInput.style.fontWeight = "bold";
            }
            if (toolbarLockBtn) toolbarLockBtn.textContent = 'üîì';

            // Dados P√∫blicos
            const currentTitle = document.getElementById('archive-title-input')?.value || 
                               document.getElementById('note-title-input')?.value || 
                               "Sem T√≠tulo";

            let finalAuthorName = "An√≥nimo";
            if (currentUserData && currentUserData.nome) finalAuthorName = currentUserData.nome;
            else if (auth.currentUser.email) finalAuthorName = auth.currentUser.email.split('@')[0];

            const isArchive = document.getElementById('archive-area').style.display !== 'none';
            const docType = isArchive ? 'arquivo' : 'full_note';
            
            const publicData = {
                nome: currentTitle,
                authorName: finalAuthorName,
                authorId: auth.currentUser.uid,
                isPublic: true,
                allunlock: isAllUnlock, // <--- ENVIA PARA O P√öBLICO TAMB√âM
                sharedAt: serverTimestamp(),
                type: docType,
                originalNoteId: selectedNoteId
            };

            if (isArchive) {
                publicData.posts = currentArchiveData.posts || [];
            } else {
                publicData.conteudo = document.getElementById('note-content-editor').innerHTML;
            }
            
            await setDoc(doc(db, 'shared_notes', shareId), publicData, { merge: true });
            
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            if (urlInput) urlInput.value = `${baseUrl}/sharenote.html?id=${shareId}`;

        } else {
            // Reset Visual
            if (urlInput) {
                urlInput.style.color = "";
                urlInput.style.borderColor = "";
                urlInput.style.fontWeight = "";
                urlInput.value = "";
            }
            if (toolbarLockBtn) toolbarLockBtn.textContent = 'üîê';

            await deleteDoc(doc(db, 'shared_notes', shareId));
        }

    } catch (e) {
        console.error("Erro partilha:", e);
    }
}

// Fun√ß√£o auxiliar para copiar
window.copyLink = function(elementId) {
    const input = document.getElementById(elementId);
    input.select();
    document.execCommand('copy');
    // Feedback visual breve
    const originalBg = input.style.backgroundColor;
    input.style.backgroundColor = "rgba(46, 204, 113, 0.2)";
    setTimeout(() => input.style.backgroundColor = originalBg, 500);
}



    // --- Listener para o Bot√£o de Colapsar/Expandir o Painel do Meio ---
const middlePanelToggleBtn = document.getElementById('middle-panel-toggle-btn');

if (middlePanelToggleBtn) { 
    middlePanelToggleBtn.addEventListener('click', () => {
        // Liga/Desliga a classe CSS
        const isCollapsed = notebookContainer.classList.toggle('middle-panel-collapsed');
        
        // Muda o √≠cone
        if (isCollapsed) {
            middlePanelToggleBtn.textContent = '¬ª'; 
            middlePanelToggleBtn.title = "Restaurar Painel";
        } else {
            middlePanelToggleBtn.textContent = '‚Üñ'; 
            middlePanelToggleBtn.title = "Expandir Lista";
        }
    });
}



// --- EVENTO PARA FECHAR O MENU AO CLICAR NOS PAIN√âIS LATERAIS ---
// Isto garante que o menu üìòüìóüìôüìí desapare√ßa ao navegar pelas pastas ou notas
document.getElementById('left-panel').addEventListener('click', () => {
    const insPopup = document.getElementById('insertion-popup');
    if (insPopup) insPopup.style.display = 'none';
});

document.getElementById('middle-panel').addEventListener('click', () => {
    const insPopup = document.getElementById('insertion-popup');
    if (insPopup) insPopup.style.display = 'none';
});

// Outros Listeners
document.addEventListener('click', (e) => {
    // 1. Fechar Context Menu
    if (!e.target.closest('.context-menu')) hideContextMenu();
    
    // 2. Fechar Tag Popup
    const tagPop = document.getElementById('tag-suggestion-popup');
    if (tagPop && !noteContentEditor.contains(e.target) && !tagPop.contains(e.target)) hideTagPopup();

    // 3. Fechar Formatting Popup (Aqui estava o erro)
    const fPopup = document.getElementById('formatting-popup');
    const fBtn = document.getElementById('more-formatting-btn');
    if (fPopup && fPopup.style.display === 'block') {
        if (!fPopup.contains(e.target) && e.target !== fBtn) {
            fPopup.style.display = 'none';
            if (fBtn) fBtn.classList.remove('active');
        }
    }
});

leftPanelToggleBtn.addEventListener('click', () => {
    notebookContainer.classList.toggle('left-panel-collapsed');
});


// Listener do bot√£o "+" (Adicionar Item)
addItemBtn.addEventListener('click', async () => {
    
    // 1. GRAVA√á√ÉO DE SEGURAN√áA
    if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'saving') {
        console.log("üíæ Gravando altera√ß√µes antes de abrir criador...");
        await saveNote(true); 
    }

    // --- C√ìDIGO DA ABA LISTS (CORRIGIDO) ---
    if (currentTab === 'lists') {
        const rootCategoryId = navigationStack[0]?.id;

        // 1. MARCADORES
        if (rootCategoryId === 'marcadores') { 
            openCreateBookmarkPopup(); 
            return; 
        }

        // 2. T√ìPICOS (A CORRE√á√ÉO EST√Å AQUI)
  if (rootCategoryId === 'topico') { 
    
    // Verifica o que est√° selecionado na lista do meio
    const selectedItem = document.querySelector('#file-list .list-item.selected');
    
    let mode = 'new-topic'; // Padr√£o: Criar T√≥pico Raiz
    let parentId = null;
    let parentName = "";

    if (selectedItem) {
        const type = selectedItem.getAttribute('data-type');
        
        // Se selecionou um T√≥pico Pai -> Cria Subt√≥pico nele
        if (type === 'topico') {
            mode = 'new-subtopic';
            parentId = selectedItem.getAttribute('data-id');
            parentName = selectedItem.getAttribute('data-name');
        } 
        // Se selecionou um Subt√≥pico -> Cria Subt√≥pico no MESMO pai (irm√£o)
        else if (type === 'subtopico') {
            mode = 'new-subtopic';
            parentId = selectedItem.getAttribute('data-parent-id');
            parentName = selectedItem.getAttribute('data-parent-name');
        }
    }

    // EXECU√á√ÉO
    if (mode === 'new-subtopic' && parentId) {
        // CRIAR SUBT√ìPICO
        const result = await showCustomInput("Novo Subt√≥pico", `Adicionar em "${parentName}"...`);
        if (result && result.name) {
            try {
                const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await addDoc(collection(db, 'subtopicos'), {
                    nome: result.name,
                    descricao: result.description || "",
                    topicId: parentId,
                    userId: auth.currentUser.uid,
                    estado: 'ativa',
                    createdAt: serverTimestamp()
                });
                
                // For√ßa a reabertura da √°rvore para mostrar o novo item
                const parentLi = document.querySelector(`.list-item[data-id="${parentId}"]`);
                if (parentLi) {
                    const container = document.getElementById(`subs-${parentId}`);
                    const icon = parentLi.querySelector('.tree-toggle-icon');
                    // Fecha e abre para recarregar
                    container.style.display = 'none'; 
                    container.innerHTML = ''; 
                    toggleTopicTree(parentId, parentName, container, icon);
                }

            } catch (e) { console.error(e); alert("Erro ao criar subt√≥pico."); }
        }
    } else {
        // CRIAR T√ìPICO
        const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina, Estudo Pessoal...");
        if (result && result.name) {
            try {
                const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await addDoc(collection(db, 'topicos'), {
                    nome: result.name,
                    descricao: result.description || "",
                    userId: auth.currentUser.uid,
                    estado: 'ativa',
                    createdAt: serverTimestamp()
                });
                // Recarrega a lista principal
                renderListCategoryItems('topico');
            } catch (e) { console.error(e); alert("Erro ao criar t√≥pico."); }
        }
    }
    return; 
}

        return; // Sai se n√£o for nenhuma das categorias acima
    }

    // ============================================================
    // CASO B: ABA NOTE (Configura√ß√£o do Modal) - Mant√©m-se igual
    // ============================================================
    const modal = document.getElementById('add-item-modal');
    if (!modal) return;

    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";

    const modalTitle = modal.querySelector('h3');
    
    const addFolderBtn = modal.querySelector('button[data-type="pasta"]');
    const addNoteBtn = modal.querySelector('button[data-type="nota"]');
    const addAgregBtn = modal.querySelector('button[data-type="agregacao"]');
    const addArchiveBtn = modal.querySelector('button[data-type="arquivo"]');
    const addJornalBtn = modal.querySelector('button[data-type="jornal"]');
    const addAquarioBtn = modal.querySelector('button[data-type="aquario"]'); 

    newItemNameInput.value = '';
    newItemNameInput.style.display = 'none';
    document.getElementById('confirm-item-addition').style.display = 'none';
    document.getElementById('add-item-options').style.display = 'flex';

    if (currentViewMode === 'flash') {
        modalTitle.textContent = "‚ö° Cria√ß√£o R√°pida";
        modalTitle.style.color = "#e67e22"; 
        if(addNoteBtn) addNoteBtn.style.display = 'block';     
        if(addJornalBtn) addJornalBtn.style.display = 'block'; 
        if(addFolderBtn) addFolderBtn.style.display = 'none';
        if(addAgregBtn) addAgregBtn.style.display = 'none';
        if(addArchiveBtn) addArchiveBtn.style.display = 'none';
        if(addAquarioBtn) addAquarioBtn.style.display = 'none';
        return; 
    } 
    else if (currentViewMode === 'shared') {
        modalTitle.textContent = "Adicionar Item Partilhado";
        modalTitle.style.color = ""; 
        if(addFolderBtn) addFolderBtn.style.display = 'none';
        if(addNoteBtn) addNoteBtn.style.display = 'none';
        if(addAgregBtn) addAgregBtn.style.display = 'none';
        if(addArchiveBtn) addArchiveBtn.style.display = 'block'; 
        if(addJornalBtn) addJornalBtn.style.display = 'none';
        if(addAquarioBtn) addAquarioBtn.style.display = 'none';
    } 
    else {
        modalTitle.textContent = "Adicionar Item";
        modalTitle.style.color = ""; 
        
        let isInSharedFolder = false;
        if (navigationStack.length > 0) {
            const currentFolder = navigationStack[navigationStack.length - 1];
            if (currentFolder.name === 'Partilhadas') isInSharedFolder = true;
        }

        if (isInSharedFolder) {
            if(addFolderBtn) addFolderBtn.style.display = 'none';
            if(addAgregBtn) addAgregBtn.style.display = 'none';
            if(addNoteBtn) addNoteBtn.style.display = 'block';
            if(addArchiveBtn) addArchiveBtn.style.display = 'block';
            if(addJornalBtn) addJornalBtn.style.display = 'block';
            if(addAquarioBtn) addAquarioBtn.style.display = 'block';
        } 
        else if (navigationStack.length === 0) {
            if(addFolderBtn) addFolderBtn.style.display = 'block';
            if(addAgregBtn) addAgregBtn.style.display = 'block'; 
            if(addNoteBtn) addNoteBtn.style.display = 'none'; 
            if(addArchiveBtn) addArchiveBtn.style.display = 'block';
            if(addJornalBtn) addJornalBtn.style.display = 'block';
            if(addAquarioBtn) addAquarioBtn.style.display = 'block';
        } 
        else {
            if(addFolderBtn) addFolderBtn.style.display = 'block';
            if(addAgregBtn) addAgregBtn.style.display = 'block'; 
            if(addNoteBtn) addNoteBtn.style.display = 'block';
            if(addArchiveBtn) addArchiveBtn.style.display = 'block';
            if(addJornalBtn) addJornalBtn.style.display = 'block';
            if(addAquarioBtn) addAquarioBtn.style.display = 'block';
        }
    }
});


// ====================================================================
// FOR√áAR COLAGEM COMO TEXTO SIMPLES (PLAIN TEXT)
// ====================================================================
 document.addEventListener('paste', (e) => {
    // 1. Verifica se estamos num campo edit√°vel
    const target = e.target;
    const isEditable = target.isContentEditable || 
                       (target.tagName === 'INPUT' && target.type === 'text') ||
                       target.tagName === 'TEXTAREA';

    if (!isEditable) return;

    // 2. Impede o comportamento padr√£o (colar com formata√ß√£o HTML)
    e.preventDefault();

    // 3. Obt√©m apenas o texto limpo da √°rea de transfer√™ncia
    let text = (e.clipboardData || window.clipboardData).getData('text/plain');

    // Remove espa√ßos vazios antes e depois
    text = text.trim(); 

    // 4. Se estiver dentro de Toggle ou Mini-Nota (Corpo), usa <br> para quebras de linha
    if (target.closest('.toggle-content') || target.closest('.mini-note-content')) {
        // Substitui quebras de linha por <br> para manter paragrafos visuais
        const htmlContent = text.replace(/\r\n|\r|\n/g, '<br>');
        document.execCommand('insertHTML', false, htmlContent);
    } else {
        // Nos outros s√≠tios (incluindo t√≠tulos), insere texto normal
        document.execCommand('insertText', false, text);
    }

    // >>> CORRE√á√ÉO PARA T√çTULOS LONGOS <<<
    // Se colou num t√≠tulo de entidade, for√ßa o ajuste de altura imediato
    if (target.classList.contains('mini-note-title-input') && typeof autoResizeTitle === 'function') {
        setTimeout(() => autoResizeTitle(target), 10);
    }
    
    // 5. Grava a nota
    if (typeof saveNote === 'function') {
        // Verifica se o alvo faz parte do editor principal
        if (target.id === 'note-content-editor' || target.closest('#note-content-editor')) {
            saveNote(); 
        }
    }
});


let itemTypeToAdd = '';
document.getElementById('add-item-options').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    
    itemTypeToAdd = btn.dataset.type;

    // --- NOVA L√ìGICA: CRIA√á√ÉO IMEDIATA NO MODO FLASH ---
    if (currentViewMode === 'flash') {
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        const defaultName = (itemTypeToAdd === 'jornal') ? `Jornal Flash ${timeString}` : `Nota Flash ${timeString}`;
        
        newItemNameInput.value = defaultName;
        document.getElementById('confirm-item-addition').click();
        return; 
    }
    // ---------------------------------------------------

    // --- ATUALIZA√á√ÉO DO T√çTULO DO MODAL ---
    const modal = document.getElementById('add-item-modal');
    const modalTitle = modal.querySelector('h3');
    
    // Mapa de nomes para ficar bonito (Capitalizado)
    const typeLabels = {
        'pasta': 'Pasta',
        'nota': 'Nota',
        'agregacao': 'Agrega√ß√£o',
        'arquivo': 'Arquivo',
        'jornal': 'Jornal',
        'aquario': 'Aqu√°rio',
        'partilhado': 'Arquivo'
    };

    if (modalTitle) {
        const label = typeLabels[itemTypeToAdd] || 'Item';
        modalTitle.textContent = `Adicionar Item: ${label}`;
    }
    // --------------------------------------

    // Comportamento normal (pede t√≠tulo)
    document.getElementById('add-item-options').style.display = 'none';
    newItemNameInput.style.display = 'block';
    
    // Ajusta o placeholder tamb√©m para ficar coerente
    const placeholderLabel = typeLabels[itemTypeToAdd] ? typeLabels[itemTypeToAdd].toLowerCase() : itemTypeToAdd;
    newItemNameInput.placeholder = `Nome d${itemTypeToAdd === 'pasta' || itemTypeToAdd === 'nota' || itemTypeToAdd === 'agregacao' ? 'a' : 'o'} ${placeholderLabel}...`;
    
    newItemNameInput.focus();
    document.getElementById('confirm-item-addition').style.display = 'block';
});


document.getElementById('confirm-item-addition').addEventListener('click', async () => {
    const confirmBtn = document.getElementById('confirm-item-addition');
    if (confirmBtn.disabled) return;

    const itemName = newItemNameInput.value.trim();
    if (!itemName || !itemTypeToAdd) return;

    // --- L√ìGICA DE AGREGA√á√ÉO (Mant√©m-se √† parte) ---
   if (itemTypeToAdd === 'agregacao') {
        aggregationTargetName = itemName; // Guarda o nome que escreveu
        
        // Define o Pai (Onde a nota final vai ficar)
        aggregationParentId = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1].id : null;
        if (!aggregationParentId && typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) {
            aggregationParentId = SUPERFOLDER_ID;
        }

        // Esconde o modal pequeno "Adicionar Item"
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';

        // CHAMA A FUN√á√ÉO NOVA
        window.openAggregationSelector();
        
        // Restaura o bot√£o "Criar" para o estado normal (para a pr√≥xima vez)
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Criar";
        }
        return; 
    }

    try {
        confirmBtn.disabled = true;
        confirmBtn.textContent = "A criar...";

        // Determina o Parent ID
        let parentId = null;
        if (navigationStack.length > 0) {
            parentId = navigationStack[navigationStack.length - 1].id;
        } else if (currentViewMode === 'shared') {
            parentId = null; 
        } else if (typeof SUPERFOLDER_ID !== 'undefined' && SUPERFOLDER_ID) {
            parentId = SUPERFOLDER_ID;
        }

        // Calcula Ordem
        const q = query(
            collection(db, 'pastas'), 
            where('parentId', '==', parentId), 
            where('estado', '==', 'ativa'), 
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
           const newOrder = 0 - Date.now();

        // Dados Base
        const docData = {
            nome: itemName,
            parentId: parentId, // Ser√° null na raiz, ou o ID da pasta se estiver dentro de uma
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ordem: newOrder,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        };

        // --- NOVA L√ìGICA: MARCAR COMO FLASH ---
        if (currentViewMode === 'flash') {
            docData.oque = 'flash'; // Marca o item como pertencente √† aba Flash
            // No modo Flash, for√ßamos o parentId a null para n√£o ficar preso numa pasta visualmente,
            // ou mantemos se quiser que ele exista "fisicamente" numa pasta mas apare√ßa na aba Flash.
            // Para "aparecer apenas na aba Flash" e ser partilh√°vel, geralmente o parentId √© indiferente
            // desde que a query da aba Flash ignore o parentId.
        }

        

        // =========================================================
        // L√ìGICA DE TIPOS
        // =========================================================
        
        // 1. ARQUIVO / PARTILHADO
        if (itemTypeToAdd === 'arquivo') {
            if (currentViewMode === 'shared') {
                docData.tipo = 'partilhado';
                docData.partilhado = "inativo";
            } else {
                docData.tipo = 'arquivo';
                docData.partilhado = "pessoal";
            }
            docData.posts = [];
            docData.deletedPosts = [];
            docData.colaboradores = { [auth.currentUser.uid]: true };
        }
        
        // 2. JORNAL
        else if (itemTypeToAdd === 'jornal') {
            docData.tipo = 'jornal'; 
            docData.conteudo = '';
            docData.tags = [];
        }
        
        // 3. AQU√ÅRIO (NOVO) ü™∏
         else if (itemTypeToAdd === 'aquario') {
            docData.tipo = 'aquario';
            docData.conteudo = ''; 
            docData.customData = {}; 
        }
        
        // 4. PADR√ÉO (NOTA OU PASTA)
        else {
            docData.tipo = itemTypeToAdd;
            if (itemTypeToAdd === 'nota') {
                docData.conteudo = '';
                docData.tags = [];
            }
        }

        // CRIA√á√ÉO NO FIREBASE
        const docRef = await addDoc(collection(db, 'pastas'), docData);

        // FECHO DO MODAL
        document.getElementById('add-item-modal').style.display = 'none';
        newItemNameInput.value = '';

        // =========================================================
        // L√ìGICA DE ABERTURA AP√ìS CRIAR
        // =========================================================
        
        // A. Abrir Aqu√°rio (NOVO)
        if (docData.tipo === 'aquario') {
            // Prepara os dados locais para n√£o precisar de ler do firebase de novo
            const localData = { id: docRef.id, ...docData };
            // Abre o ambiente
            window.openAquariumEnvironment(docRef.id, localData);
        } 
        
        // B. Abrir Nota ou Jornal
          else if (docData.tipo === 'nota' || docData.tipo === 'jornal') {
            displayNote(docRef.id, null);
        }
        
        // C. Abrir Arquivo
        else if (docData.tipo === 'arquivo' || docData.tipo === 'partilhado') {
            displayArchive(docRef.id, { ...docData, id: docRef.id });
        } 
        
        // D. Entrar na Pasta
        else if (docData.tipo === 'pasta') {
            navigationStack.push({ id: docRef.id, name: itemName });
            updateNavigationView();
            resetEditor();
        }

    } catch (error) {
        console.error("Erro ao criar item:", error);
        alert("Erro ao criar o item.");
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Criar";
    }
});


 document.getElementById('context-menu').addEventListener('click', async (e) => {
    // 1. Identifica o bot√£o clicado na grelha
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    if (!action) return;

    // 2. Captura os dados do item (pasta/nota) e fecha o menu de op√ß√µes imediatamente
    const itemContext = { ...activeItemContext };
    hideContextMenu(); 

    try {
        // --- A√á√ÉO: RENOMEAR (‚úèÔ∏è) ---
        if (action === 'rename') {
            openRenameModal(itemContext.name, async (newName) => {
                const collectionName = (itemContext.type === 'cosmos-parent') ? 'cosmos' : 'pastas';
                const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                
                await updateDoc(doc(db, collectionName, itemContext.id), {
                    nome: newName,
                    ultimaedicao: serverTimestamp()
                });
                
                // Atualiza o t√≠tulo no editor se a nota renomeada for a que est√° aberta
                if (selectedNoteId && itemContext.id === selectedNoteId) {
                    const titleInput = document.getElementById('note-title-input');
                    if(titleInput) titleInput.value = newName;
                }
            });
        }

        // --- A√á√ÉO: MOVER DE PASTA (üìÇ) ---
        else if (action === 'move-folder') {
            await openMoveToFolderModal(itemContext);
        }

        // --- A√á√ÉO: MOVER POSI√á√ÉO/ORDEM (‚ÜïÔ∏è) ---
        else if (action === 'move-position') {
            await openMoveModal(itemContext);
        }

        // --- A√á√ÉO: ALTERNAR PIN (üìå) ---
        else if (action === 'toggle-pin') {
            const newState = !itemContext.isPinned;
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                isPinned: newState,
                ultimaedicao: serverTimestamp()
            });
        }

        // --- A√á√ÉO: PROTEGER COM SENHA (üîí) ---
        else if (action === 'protect') {
            const newPass = await requestPassword('create', itemContext.id);
            if (newPass) {
                const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                
                await updateDoc(doc(db, 'pastas', itemContext.id), {
                    passe: newPass,
                    ultimaedicao: serverTimestamp()
                });
            }
        }

        // --- A√á√ÉO: REMOVER PROTE√á√ÉO (üîì) ---
        else if (action === 'unprotect') {
            const authorized = await requestPassword('remove', itemContext.id);
            if (authorized === true) {
                sessionUnlockedFolders.delete(itemContext.id);
                // A fun√ß√£o requestPassword('remove') j√° trata a exclus√£o no Firebase
            }
        }

        // --- A√á√ÉO: ANEXAR T√ìPICOS (üè∑Ô∏è) ---
        else if (action === 'manage-topics') {
            openTopicsModal(itemContext.id, itemContext.type);
        }

        // --- A√á√ÉO: TORNAR SUPERPASTA (üóÉÔ∏è) ---
        else if (action === 'toggle-superfolder') {
            const newState = !itemContext.isSuperfolder;
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await updateDoc(doc(db, 'pastas', itemContext.id), {
                superpasta: newState,
                ultimaedicao: serverTimestamp()
            });
            window.location.reload(); // Recarrega para aplicar isolamento de raiz
        }

        // --- A√á√ÉO: MUDAR √çCONE (SUPERPASTA) ---
        else if (action === 'change-icon') {
            const modal = document.getElementById('icon-picker-modal');
            if (modal) {
                modal.dataset.targetFolderId = itemContext.id;
                modal.style.display = 'flex';
                document.body.appendChild(modal); // Garante visibilidade
            }
        }

        // --- A√á√ÉO: OCULTAR/MOVER PARA LIXEIRA (üóëÔ∏è) ---
        else if (action === 'hide') {
            const myUid = auth.currentUser.uid;
            // Verifica se o ID do utilizador atual √© igual ao userId do documento (Dono)
            const isOwner = (itemContext.userId === myUid);
            const isSharedFile = (itemContext.type === 'partilhado' || itemContext.type === 'arquivo');
            
            let confirmTitle = 'Ocultar Item?';
            let confirmMsg = `Deseja mover "${itemContext.name}" para a lixeira?`;

            // Mensagens personalizadas para clareza
            if (isSharedFile) {
                if (isOwner) {
                    confirmMsg = `Como √© o Dono, ao ocultar este Arquivo:\n\n1. O arquivo ir√° para os seus "Itens Ocultos".\n2. A lista de colaboradores ser√° apagada (todos perdem acesso).\n\nDeseja continuar?`;
                } else {
                    confirmTitle = 'Sair da Partilha?';
                    confirmMsg = `Deseja deixar de colaborar em "${itemContext.name}"?\n\nO seu acesso ser√° removido e o arquivo sair√° da sua lista. (O dono continuar√° a ver o arquivo)`;
                }
            }

            const confirmed = await showConfirmation(confirmTitle, confirmMsg);
            
            if (confirmed) {
                const collectionName = (itemContext.type === 'cosmos-parent') ? 'cosmos' : 'pastas';
                const { doc, updateDoc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                const docRef = doc(db, collectionName, itemContext.id);

                try {
                    // --- CEN√ÅRIO A: SOU O DONO ---
                    // Apaga para todos e move para a reciclagem do dono
                    if (isOwner) {
                        const updateData = { 
                            estado: 'desativa', // Isto move para Itens Ocultos
                            ultimaedicao: serverTimestamp()
                        };

                        // Se for partilhado, expulsa todos os colaboradores e desativa a partilha
                        if (isSharedFile) {
                            updateData.colaboradores = deleteField(); // Apaga o mapa inteiro
                            updateData.partilhado = "inativo"; // Marca como inativo
                        }

                        await updateDoc(docRef, updateData);
                        console.log("üëë Dono ocultou o item e limpou colaboradores.");
                    } 
                    
                    // --- CEN√ÅRIO B: SOU COLABORADOR ---
                    // N√ÉO muda o estado (o dono continua a ver). Apenas sai da lista.
                    else {
                        console.log("üëã [COLABORADOR] A sair da partilha...");
                        
                        // FOR√áA BRUTA: Atualiza APENAS o campo colaboradores.
                        // N√£o enviamos 'estado' nem 'ultimaedicao' para evitar que o Firebase
                        // interprete como uma atualiza√ß√£o do documento inteiro que possa afetar o dono.
                        await updateDoc(docRef, {
                            [`colaboradores.${myUid}`]: deleteField()
                        });
                        
                        console.log("‚úÖ Removido da lista de colaboradores.");
                    }

                    // --------------------------------------------------------
                    // ATUALIZA√á√ÉO VISUAL (Igual para ambos os casos)
                    // --------------------------------------------------------

                    // 1. Remove o item da lista visualmente
                    const domItem = document.querySelector(`.list-item[data-id="${itemContext.id}"]`);
                    if (domItem) {
                        domItem.style.transition = "opacity 0.3s, transform 0.3s";
                        domItem.style.opacity = "0";
                        domItem.style.transform = "translateX(-20px)";
                        setTimeout(() => domItem.remove(), 300);
                    }

                    // 2. Limpeza de refer√™ncias (Apenas se for Dono, para n√£o estragar o puzzle do dono)
                    if (isOwner && collectionName === 'pastas') {
                        if(typeof cleanUpHiddenNoteReferences === 'function') {
                            cleanUpHiddenNoteReferences(itemContext.id);
                        }
                    }

                    // 3. Recarrega a lista correta para garantir sincronia
                    // Pequeno delay para garantir que a escrita no Firebase terminou
                    setTimeout(() => {
                        if (currentViewMode === 'flash') {
                             if(typeof loadFlashListLeftPanel === 'function') loadFlashListLeftPanel();
                        } else if (currentViewMode === 'shared') {
                             if(typeof loadSharedFilesRoot === 'function') loadSharedFilesRoot(); 
                        } else {
                             updateNavigationView(true);
                        }
                    }, 500);

                    // 4. Se o ficheiro removido estava aberto, fecha o editor
                    if (selectedNoteId === itemContext.id) {
                        console.log("üôà A fechar editor pois o item foi removido.");
                        resetEditor();
                    }

                } catch (error) {
                    console.error("‚ùå Erro ao ocultar/sair:", error);
                    alert("Ocorreu um erro ao processar o pedido. Tente novamente.");
                    // Se falhar, restaura o visual
                    if (domItem) {
                        domItem.style.opacity = "1";
                        domItem.style.transform = "none";
                    }
                }
            }
        }

    } catch (error) {
        console.error(`Erro ao executar a a√ß√£o ${action}:`, error);
        alert("Ocorreu um erro ao processar o seu pedido.");
    }
});



document.querySelectorAll('.modal-overlay [data-action="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal-overlay').style.display = 'none';
    });
});

// Listener para abrir o Modal de Configura√ß√µes
document.getElementById('settings-btn').addEventListener('click', () => {
    
    // --- CORRE√á√ÉO: Sincronizar interruptores com as vari√°veis guardadas ---
    // Isto garante que, se estiver True na mem√≥ria, o bot√£o aparece Ligado
    if (document.getElementById('setting-search-tags')) 
        document.getElementById('setting-search-tags').checked = appSettings.searchTagsInProtected;
    
    if (document.getElementById('setting-search-topics')) 
        document.getElementById('setting-search-topics').checked = appSettings.searchTopicsInProtected;
    
    if (document.getElementById('setting-search-anchors')) 
        document.getElementById('setting-search-anchors').checked = appSettings.searchAnchorsInProtected;
    
    if (document.getElementById('setting-global-search-superfolder')) 
        document.getElementById('setting-global-search-superfolder').checked = appSettings.searchGlobalInSuperfolder;

    // >>> A CORRE√á√ÉO PRINCIPAL PARA O SEU PROBLEMA <<<
    if (document.getElementById('setting-full-titles')) 
        document.getElementById('setting-full-titles').checked = appSettings.showFullTitles;

    // Mostrar o modal
    document.getElementById('settings-modal').style.display = 'flex';
});

document.getElementById('settings-modal').addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    if (action === 'show-hidden-items') {
        document.getElementById('settings-modal').style.display = 'none';
        showHiddenItemsModal();
    }
});

document.getElementById('hidden-items-list').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const collectionName = btn.dataset.collection; // Novo atributo que diz qual a tabela (pastas, personagens, etc)
    const listItem = btn.closest('li');

    // --- RESTAURAR ---
    if (action === 'restore-universal') {
        if (!confirm("Restaurar este item e ir para l√°?")) return;

        // Feedback visual
        btn.textContent = "A restaurar...";
        btn.disabled = true;

        try {
            // 1. Atualizar no Firebase (Tirar do estado 'desativa')
            // Se for da blackbox, ter√≠amos de mover de volta, mas assumindo 'Ocultos' (estado=desativa):
            const updatePayload = collectionName === 'pastas' 
                ? { estado: 'ativa', ultimaedicao: serverTimestamp() } 
                : { estado: deleteField() }; 

            await updateDoc(doc(db, collectionName, id), updatePayload);
            
            // 2. FECHAR MODAIS
            document.getElementById('hidden-items-modal').style.display = 'none';
            document.getElementById('settings-modal').style.display = 'none';

            // 3. NAVEGAR PARA O CONTE√öDO
            console.log(`üöÄ Restaurado! A navegar para: ${id} (${collectionName})`);

            if (collectionName === 'pastas') {
                // Precisamos saber se √© Nota ou Pasta para decidir como abrir
                const docSnap = await getDoc(doc(db, 'pastas', id));
                const data = docSnap.data();

                if (data.tipo === 'nota' || data.tipo === 'jornal' || data.tipo === 'aquario' || data.tipo === 'arquivo' || data.tipo === 'partilhado') {
                    
                    // Se for NOTA/ARQUIVO/AQU√ÅRIO: Abre diretamente
                    // Se tiver a fun√ß√£o de navega√ß√£o inteligente, usa-a para reconstruir o caminho das pastas
                    if (typeof navigateToNoteSmart === 'function') {
                        await navigateToNoteSmart(id);
                    } else {
                        // Fallback
                        displayNote(id, null);
                    }

                } else if (data.tipo === 'pasta' || data.tipo === 'agregacao') {
                    
                    // Se for PASTA: Entra nela
                    // Usa a fun√ß√£o de reconstruir navega√ß√£o para o breadcrumbs ficar correto
                    if (typeof reconstructFolderNavigation === 'function') {
                        await reconstructFolderNavigation(id);
                    } else {
                        // Fallback simples
                        navigationStack.push({ id: id, name: data.nome });
                        updateNavigationView(true);
                    }
                }
            } 
            else {
                // Se for ENTIDADE (Personagem, Local, etc): Abre a 4¬™ Coluna
                // Precisamos do nome para o t√≠tulo do painel. O listItem tem o nome visualmente.
                // Mas vamos buscar o documento atualizado para garantir.
                const docSnap = await getDoc(doc(db, collectionName, id));
                const data = docSnap.data();
                
                // Determina o tipo singular para a fun√ß√£o (ex: 'personagens' -> 'personagem')
                // Uma forma simples √© usar o 'tipo' que grav√°mos no bot√£o ou inferir
                let singularType = 'topico'; // Default
                // Procura na config global qual a chave que tem esta cole√ß√£o
                for (const [key, val] of Object.entries(ENTITY_CONFIG)) {
                    if (val.collection === collectionName) {
                        singularType = key;
                        break;
                    }
                }
                
                showReferencesPanel(id, data.nome, singularType);
            }

        } catch (err) {
            console.error(err);
            alert("Erro ao restaurar.");
            btn.textContent = "Restaurar";
            btn.disabled = false;
        }
    }

 // --- ELIMINAR PERMANENTE (AGORA: MOVER PARA BLACKBOX ü™¶) ---
    else if (action === 'delete-universal') {
        // Mantemos o aviso original como pediu
        if (!confirm("Eliminar permanentemente? Esta a√ß√£o √© irrevers√≠vel.")) return;

        // Feedback visual para o utilizador saber que algo est√° a acontecer
        const originalText = btn.textContent;
        btn.textContent = "A arquivar...";
        btn.disabled = true;

   try {
            // Importar writeBatch tamb√©m
            const { doc, getDoc, writeBatch, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const sourceRef = doc(db, collectionName, id);
            const targetRef = doc(db, 'blackbox', id);

            // 1. Ler o documento original
            const docSnap = await getDoc(sourceRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                // 2. Preparar dados para o "cemit√©rio"
                const blackboxData = {
                    ...data,
                    originalCollection: collectionName,
                    deletedAt: serverTimestamp(),
                    deletedBy: auth.currentUser.uid,
                    status: 'dead'
                };

                // 3. Executar Transa√ß√£o At√≥mica (Tudo ou Nada)
                const batch = writeBatch(db);
                batch.set(targetRef, blackboxData); // Cria na Blackbox
                batch.delete(sourceRef);            // Apaga da Origem
                
                await batch.commit(); // Executa as duas a√ß√µes ao mesmo tempo

                // 4. Remover da lista visual
                listItem.remove();
                
                if (document.getElementById('hidden-items-list').children.length === 0) {
                    document.getElementById('hidden-items-list').innerHTML = '<li style="padding:15px; color:#888;">Reciclagem vazia.</li>';
                }
                
                console.log(`ü™¶ Item ${id} movido para a Blackbox com sucesso.`);
            } else {
                alert("Erro: O item j√° n√£o existe na base de dados.");
                listItem.remove();
            }

        } catch (err) {
            console.error("Erro ao mover para blackbox:", err);
            alert("Ocorreu um erro ao arquivar o item (Verifique as Permiss√µes).");
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
});


// ====================================================================
// L√ìGICA DE PARTILHA DA CAIXA (CADEADO) - CORRIGIDA (COMPUTED STYLE)
// ====================================================================
let activeWrapperForSharing = null;
const sharePopup = document.getElementById('share-settings-popup');
const shareToggle = document.getElementById('mini-note-share-toggle');

// 1. Abrir/Fechar Popup ao clicar no cadeado
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="sharing-settings"]');
    if (!btn) return;

    e.preventDefault(); 
    e.stopPropagation(); 
    e.stopImmediatePropagation();

    const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
    if (!wrapper) return;
    
    // Garante que a caixa tem ID
    if (!wrapper.id) wrapper.id = 'box_' + Date.now();

    const popup = document.getElementById('share-settings-popup');
    if (!popup) return;

    // --- CORRE√á√ÉO: COMPARA√á√ÉO POR ID ---
    // Comparamos o texto do ID, que sobrevive a atualiza√ß√µes do DOM
    const isSameBox = (window.activeShareWrapperId === wrapper.id);
    const isVisible = popup.style.display !== 'none';

    console.log(`üîê CADEADO: ID Atual [${wrapper.id}] vs Guardado [${window.activeShareWrapperId}] -> Mesma? ${isSameBox}`);

    // --- DECIS√ÉO: FECHAR ---
    if (isSameBox && isVisible) {
        popup.style.setProperty('display', 'none', 'important');
        window.activeShareWrapperId = null; // Limpa o ID
        return; 
    }
    
    // --- DECIS√ÉO: ABRIR ---
    window.activeShareWrapperId = wrapper.id; // Guarda o ID

    // Move e Mostra
    document.body.appendChild(popup);

    // Sincroniza o Toggle
    const isShared = wrapper.getAttribute('data-shared') === 'true';
    const shareToggle = document.getElementById('mini-note-share-toggle');
    if (shareToggle) shareToggle.checked = isShared;

    const rect = btn.getBoundingClientRect();
    
    popup.style.cssText = `
        display: flex !important;
        position: fixed !important;
        z-index: 2147483647 !important;
        top: ${rect.bottom + 5}px;
        left: ${Math.max(10, rect.left - 100)}px;
        background-color: var(--sidebar-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    `;
}, true);

// 2. Alterar o Toggle (BUSCA PELO ID)
if (shareToggle) {
    // Remove listeners antigos para evitar duplica√ß√£o (boa pr√°tica)
    const newToggle = shareToggle.cloneNode(true);
    shareToggle.parentNode.replaceChild(newToggle, shareToggle);

    newToggle.addEventListener('change', () => {
        // Se tivermos um ID guardado, procuramos o elemento "vivo" no documento
        if (window.activeShareWrapperId) {
            const currentWrapper = document.getElementById(window.activeShareWrapperId);
            
            if (currentWrapper) {
                const newState = newToggle.checked;
                currentWrapper.setAttribute('data-shared', newState);
                
                // Atualiza bot√£o visualmente
                updateSharingButtonState(currentWrapper);
                
                // Grava
                saveNote(true);
            } else {
                console.warn("‚ö†Ô∏è Caixa n√£o encontrada (pode ter sido apagada ou redesenhada sem ID).");
            }
        }
    });
}

// 3. Fechar Popup ao clicar fora
document.addEventListener('click', (e) => {
    const popup = document.getElementById('share-settings-popup');
    if (popup && popup.style.display !== 'none') {
        // Se o clique n√£o foi no popup E n√£o foi num bot√£o de cadeado
        if (!popup.contains(e.target) && !e.target.closest('button[data-action="sharing-settings"]')) {
            popup.style.setProperty('display', 'none', 'important');
            window.activeShareWrapperId = null; // Limpa o ID global
        }
    }
});

// --- EVENT LISTENER PARA O INDICADOR DE STATUS ---
if (saveStatusIndicator) {
    saveStatusIndicator.addEventListener('click', () => {
        // Se estiver "por guardar" ou deu "erro", o clique for√ßa a grava√ß√£o
        if (currentSaveStatus === 'unsaved' || currentSaveStatus === 'error') {
            saveNote(true); // O par√¢metro 'true' ignora o temporizador e grava logo
        }
    });
}

 // --- EVENT LISTENER: BOT√ÉO DA TOOLBAR ---
editorToolbar.addEventListener('click', async (e) => {
    // 1. Identifica o bot√£o
    const btn = e.target.closest('button');
    if (!btn) return;

    // 2. DECLARA√á√ÉO DE VARI√ÅVEIS (A CORRE√á√ÉO EST√Å AQUI)
    const action = btn.dataset.action;
    const command = btn.dataset.command; // <--- Faltava definir isto!
    
    console.log("üîò [DEBUG] Bot√£o clicado. Action:", action, "| Command:", command);

    // ============================================================
    // 0. PESQUISA LOCAL (Ctrl+F)
    // ============================================================
    if (action === 'local-search') {
        e.preventDefault(); e.stopPropagation();
        if (typeof openLocalSearch === 'function') openLocalSearch();
        return;
    }

    // 1. GERIR T√ìPICOS (üìë)
    if (action === 'show-topics') {
        if (selectedNoteId) openTopicsModal(selectedNoteId, 'nota');
        else alert("Selecione uma nota primeiro.");
    }
    
    // 2. HIST√ìRICO E BACKUPS (üïí)
    else if (action === 'show-history') {
        if (selectedNoteId) openHistoryModal();
    }
    
    // 3. DEFINI√á√ïES DE PARTILHA (üîê)
    else if (action === 'note-sharing-settings') {
        if (selectedNoteId) openShareModalForArchive();
    }
    
    // 4. ANEXOS (üìé)
    else if (action === 'show-attachments') {
        openAttachmentsModal();
    }
    
    // 5. PESQUISA GLOBAL (üîé)
    else if (action === 'show-explorer') {
        openExplorerModal();
    }

    // 6. SCANNER UNIVERSAL (üé∞)
    else if (action === 'bible-scan') {
        if (typeof openUniversalScanner === 'function') openUniversalScanner();
    }

    // 7. EDITOR DE MARGEM (üî¨)
    else if (action === 'open-margin-editor') {
        if (!selectedNoteId) return alert("Selecione uma nota primeiro.");
        const btnText = btn.textContent;
        btn.textContent = "üíæ";
        await saveNote(true);
        window.location.href = `editnote.html?noteId=${selectedNoteId}`;
    }

    // 8. MAIS FORMATA√á√ïES / DROPDOWN (‚ãÆ)
    else if (action === 'more-formatting' || btn.id === 'more-formatting-btn') {
        const popup = document.getElementById('formatting-popup');
        if (!popup) return;

        const isVisible = popup.style.display === 'block';

        if (isVisible) {
            popup.style.display = 'none';
            btn.classList.remove('active');
        } else {
            document.body.appendChild(popup);
            const rect = btn.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed'; 
            popup.style.zIndex = "9999999"; 
            
            let leftPos = rect.left;
            if (leftPos + 250 > window.innerWidth) leftPos = window.innerWidth - 260;

            popup.style.top = `${rect.bottom + 8}px`;
            popup.style.left = `${leftPos}px`;
            btn.classList.add('active');
        }
    }

    // 9. UNDO / REDO (CORRIGIDO: Agora 'command' existe)
    else if (command === 'undo') {
        document.execCommand('undo', false, null);
    }
    else if (command === 'redo') {
        document.execCommand('redo', false, null);
    }
});



// 2. FUN√á√ÉO DE ABERTURA
function openLocalSearch() {
    console.group("üîç [DEBUG] Dentro de openLocalSearch");
    
 const popup = document.getElementById('local-search-popup');
    const input = document.getElementById('local-search-input');
    
    if (!popup) return console.error("‚ùå [ERRO] Popup n√£o encontrado!");

    // 1. TRUQUE DE MESTRE: Move o popup para o fim do <body>
    // Isto garante que ele n√£o fica preso dentro de divs com scroll escondido
    document.body.appendChild(popup);

    // 2. FOR√áA BRUTA VISUAL
    // Usamos 'fixed' em vez de 'absolute' para ele flutuar no ecr√£ mesmo com scroll
    popup.style.cssText = `
        display: flex !important;
        position: fixed !important;
        top: 80px !important;       /* Ajuste para n√£o tapar a toolbar */
        right: 30px !important;
        z-index: 2147483647 !important; /* M√°ximo poss√≠vel para ficar √† frente de tudo */
        background-color: var(--sidebar-color);
        border: 1px solid var(--accent-color);
        padding: 8px;
        border-radius: 6px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.8);
    `;
    

    if (input) {
        input.value = '';
        input.focus();
        input.onkeydown = handleLocalSearchKeys;
        input.oninput = (e) => executeLocalSearch(e.target.value);
    }
}

function executeLocalSearch(term) {
    clearLocalHighlights(); // Limpa marcas anteriores
    
    const countEl = document.getElementById('local-search-count');
    const listEl = document.getElementById('local-search-results-list');
    
    localSearchResults = [];
    currentLocalMatchIndex = -1;

    if (!term || term.length < 2) {
        countEl.textContent = "0/0";
        if(listEl) listEl.classList.remove('visible');
        return;
    }

    // --- DETE√á√ÉO INTELIGENTE DO ALVO ---
    let editor;
    const aqEnv = document.getElementById('aquarium-environment');
    
    if (aqEnv && aqEnv.style.display !== 'none') {
        // Estamos no Aqu√°rio -> Procura no Canvas
        editor = document.getElementById('aquarium-content-canvas');
        console.log("üîç Pesquisando no Aqu√°rio...");
    } else {
        // Estamos na Nota -> Procura no Editor
        editor = document.getElementById('note-content-editor');
        console.log("üîç Pesquisando na Nota...");
    }

    if (!editor) return; // Seguran√ßa
    // -----------------------------------
    
    // 1. Procura e Destaca (Highlight)
    // O resto da l√≥gica mant√©m-se igual, mas agora usa a vari√°vel 'editor' correta
    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
    const nodesToReplace = [];
    
    let node;
    while (node = walker.nextNode()) {
        // Ignora scripts, estilos e inputs para n√£o quebrar o HTML
        if (['SCRIPT', 'STYLE', 'TEXTAREA', 'INPUT', 'SELECT'].includes(node.parentNode.tagName)) continue;

        const text = node.textContent;
        // Regex para encontrar o termo (insens√≠vel a mai√∫sculas)
        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
        
        if (regex.test(text)) {
            nodesToReplace.push({ node, text, regex });
        }
    }

    // Aplica o destaque amarelo (<mark>)
    nodesToReplace.forEach(item => {
        const span = document.createElement('span');
        span.innerHTML = item.text.replace(item.regex, '<mark class="local-highlight">$1</mark>');
        item.node.parentNode.replaceChild(span, item.node);
        
        // Limpeza do HTML para evitar spans aninhados
        const parent = span.parentNode;
        while (span.firstChild) {
            parent.insertBefore(span.firstChild, span);
        }
        parent.removeChild(span);
    });

    // 2. Coletar resultados
    localSearchResults = Array.from(editor.querySelectorAll('.local-highlight'));
    
    if (localSearchResults.length > 0) {
        currentLocalMatchIndex = 0;
        focusLocalMatch(0);
        
        if (typeof renderLocalResultsList === 'function') {
            renderLocalResultsList(term);
        }
    } else {
        if(listEl) listEl.classList.remove('visible');
    }
    
    countEl.textContent = localSearchResults.length > 0 
        ? `1/${localSearchResults.length}` 
        : "0/0";
}

// --- NOVA FUN√á√ÉO: RENDERIZAR LISTA ---
function renderLocalResultsList(term) {
    const list = document.getElementById('local-search-results-list');
    list.innerHTML = '';
    
    localSearchResults.forEach((mark, index) => {
        const li = document.createElement('li');
        li.className = 'local-result-item';
        li.dataset.index = index;
        
        // Pega no texto √† volta (Contexto)
        // Sobe ao pai (ex: par√°grafo) e pega o texto todo
        let fullText = mark.parentElement.textContent;
        
        // Corta um excerto √† volta da palavra
        const termIndex = fullText.toLowerCase().indexOf(term.toLowerCase());
        const start = Math.max(0, termIndex - 20);
        const end = Math.min(fullText.length, termIndex + term.length + 40);
        
        let snippet = fullText.substring(start, end);
        if(start > 0) snippet = "..." + snippet;
        
        // Destaca a palavra na lista tamb√©m
        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
        snippet = snippet.replace(regex, '<mark>$1</mark>');

        li.innerHTML = snippet;
        
        // Clique na lista = Scroll no editor
        li.onclick = () => {
            currentLocalMatchIndex = index;
            focusLocalMatch(index);
        };
        
        list.appendChild(li);
    });
    
    list.classList.add('visible');
    highlightActiveListItem(0); // Seleciona o primeiro
}

// --- ATUALIZA√á√ÉO: FOCAR E SINCRONIZAR LISTA ---
function focusLocalMatch(index) {
    if (localSearchResults.length === 0) return;

    // 1. Destaque no Editor (Amarelo/Laranja)
    localSearchResults.forEach(el => el.classList.remove('active'));
    const target = localSearchResults[index];
    target.classList.add('active');
    
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // 2. Atualiza contador
    document.getElementById('local-search-count').textContent = `${index + 1}/${localSearchResults.length}`;
    
    // 3. NOVO: Sincroniza a Lista (Pinta a linha de laranja)
    highlightActiveListItem(index);
}

function highlightActiveListItem(index) {
    const list = document.getElementById('local-search-results-list');
    
    // Remove classe antiga
    const oldActive = list.querySelector('.active-list-item');
    if (oldActive) oldActive.classList.remove('active-list-item');
    
    // Adiciona classe nova
    const newActive = list.children[index];
    if (newActive) {
        newActive.classList.add('active-list-item');
        // Faz a lista scrollar sozinha para mostrar o item selecionado
        newActive.scrollIntoView({ behavior: 'auto', block: 'nearest' });
    }
}


function navigateMatches(direction) {
    if (localSearchResults.length === 0) return;
    currentLocalMatchIndex += direction;
    if (currentLocalMatchIndex >= localSearchResults.length) currentLocalMatchIndex = 0;
    if (currentLocalMatchIndex < 0) currentLocalMatchIndex = localSearchResults.length - 1;
    focusLocalMatch(currentLocalMatchIndex);
}

function clearLocalHighlights() {
    // --- DETE√á√ÉO INTELIGENTE DO ALVO (IGUAL AO EXECUTE) ---
    let editor;
    const aqEnv = document.getElementById('aquarium-environment');
    
    if (aqEnv && aqEnv.style.display !== 'none') {
        editor = document.getElementById('aquarium-content-canvas');
    } else {
        editor = document.getElementById('note-content-editor');
    }

    if (!editor) return;
    // ------------------------------------------------------

    const highlights = editor.querySelectorAll('.local-highlight');
    
    highlights.forEach(mark => {
        const parent = mark.parentNode;
        // Substitui o <mark>amarelo</mark> apenas pelo texto "amarelo"
        parent.replaceChild(document.createTextNode(mark.textContent), mark);
        parent.normalize(); // Funde os n√≥s de texto vizinhos
    });
    
    localSearchResults = [];
}

// Controlos
const btnPrev = document.getElementById('local-search-prev');
const btnNext = document.getElementById('local-search-next');
const btnClose = document.getElementById('local-search-close');

if(btnPrev) btnPrev.onclick = () => navigateMatches(-1);
if(btnNext) btnNext.onclick = () => navigateMatches(1);
if(btnClose) btnClose.onclick = closeLocalSearch;

function closeLocalSearch() {
    document.getElementById('local-search-popup').style.display = 'none';
    document.getElementById('local-search-input').value = '';
    clearLocalHighlights();
}

function handleLocalSearchKeys(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        navigateMatches(1);
    } else if (e.key === 'Escape') {
        e.preventDefault();
        closeLocalSearch();
    }
}


// SEGURAN√áA: Limpar ao escrever para n√£o gravar HTML sujo
const safeEditor = document.getElementById('note-content-editor');
if(safeEditor) {
    safeEditor.addEventListener('input', () => {
        if (document.getElementById('local-search-popup').style.display === 'flex') {
            clearLocalHighlights();
        }
    });
}

// Interceptar o saveNote para limpar antes de enviar
const originalSaveNoteBeforeSearch = window.saveNote;
window.saveNote = async function(force) {
    // Limpa destaques antes de gravar
    if (document.querySelectorAll('.local-highlight').length > 0) {
        clearLocalHighlights();
        document.getElementById('local-search-popup').style.display = 'none';
    }
    return await originalSaveNoteBeforeSearch(force);
};


// 8. ATALHO DE TECLADO (Ctrl+F) - UNIFICADO E CORRIGIDO
document.addEventListener('keydown', (e) => {
    // Verifica se carregou em Ctrl+F (Windows) ou Cmd+F (Mac)
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        
        const aqEnv = document.getElementById('aquarium-environment');
        const editorArea = document.getElementById('editor-area');

        // A. Se o Aqu√°rio estiver aberto, ativa a pesquisa l√°
        if (aqEnv && aqEnv.style.display !== 'none') {
            e.preventDefault(); // Impede o browser de abrir a pesquisa dele
            openLocalSearch();
        }
        // B. Se o Editor Normal estiver aberto, ativa a pesquisa l√°
        else if (editorArea && editorArea.style.display !== 'none') {
            e.preventDefault();
            openLocalSearch();
        }
        // Se nenhum estiver aberto, deixa o browser fazer o Ctrl+F normal
    }
});

    
// Listener espec√≠fico para cliques dentro do Popup de Formata√ß√£o
// Listener espec√≠fico para cliques dentro do Popup de Formata√ß√£o
document.getElementById('formatting-popup').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. DECLARA√á√ÉO GLOBAL DAS VARI√ÅVEIS (AQUI EST√Å A CORRE√á√ÉO)
    const action = btn.dataset.action;
    const cmdSec = btn.dataset.cmdSec;

    // --- A. A√á√ïES DO SISTEMA ---

    if (action === 'open-robot') {
        e.preventDefault(); e.stopPropagation();
        document.getElementById('formatting-popup').style.display = 'none';
        document.getElementById('more-formatting-btn').classList.remove('active');
        if (typeof openRobotModal === 'function') openRobotModal();
        return;
    }
    
    else if (action === 'open-margin-editor') {
        e.preventDefault(); e.stopPropagation();
        if (!selectedNoteId) return alert("Selecione uma nota primeiro.");
        document.getElementById('formatting-popup').style.display = 'none';
        await saveNote(true);
        window.location.href = `editnote.html?noteId=${selectedNoteId}`;
        return;
    }

    else if (action === 'creative-mode') {
        e.preventDefault(); e.stopPropagation();
        document.querySelector('.notebook-container').classList.toggle('creative-mode-active');
        btn.classList.toggle('active');
        document.getElementById('formatting-popup').style.display = 'none';
        return;
    }

    else if (action === 'insert-ref-depot') {
        // A l√≥gica do dep√≥sito j√° √© capturada pelo listener espec√≠fico do bot√£o, 
        // mas fechamos o menu aqui por seguran√ßa e consist√™ncia
        document.getElementById('formatting-popup').style.display = 'none';
        return;
    }

    // --- B. A√á√ïES DE WIDGETS E JORNAL ---
    // S√≥ executa se houver uma a√ß√£o v√°lida
    if (action || cmdSec) {
        e.preventDefault(); e.stopPropagation();

        const editor = document.getElementById('note-content-editor');
        editor.focus(); 
        
        // Restaura a posi√ß√£o do cursor guardada (se existir)
        if (typeof journalCursorRange !== 'undefined' && journalCursorRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(journalCursorRange);
        }

        // 1. DATA (üìÖ)
        if (action === 'insert-date') {
            const calId = `cal_${Date.now()}`;
            const today = new Date();
            const widgetHTML = `
                <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
                    <div class="cal-header">
                        <button class="cal-btn cal-prev">‚óÄ</button>
                        <span class="cal-title">Carregando...</span>
                        <div style="display:flex; gap:5px;">
                            <button class="cal-btn cal-next">‚ñ∂</button>
                            <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="cal-settings-menu">
                        <div style="display:flex; gap:5px; justify-content:center; width:100%;">
                            <button class="cal-view-btn" data-view="week" style="flex:1;">Semana</button>
                            <button class="cal-view-btn active" data-view="month" style="flex:1;">M√™s</button>
                            <button class="cal-view-btn" data-view="year" style="flex:1;">Ano</button>
                        </div>
                        <hr style="border:0; border-top:1px solid var(--border-color); opacity: 0.5;">
                        <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
                    </div>
                    <div class="cal-grid"></div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, widgetHTML);
            setTimeout(() => { if(typeof renderCalendarUI === 'function') renderCalendarUI(document.getElementById(calId)); }, 50);
        }

        // 2. TIMELINE (üå≥)
        else if (action === 'insert-timeline') {
            const timelineId = `tl_${Date.now()}`;
            const timelineHTML = `
                <div class="jwn-timeline-wrapper" contenteditable="false" id="${timelineId}">
                    <div class="timeline-track"></div>
                    <div class="timeline-container">
                        <div class="timeline-entry">
                            <div class="t-marker"></div>
                            <div class="t-date" contenteditable="true">Data 1</div>
                            <div class="t-text" contenteditable="true">Descri√ß√£o...</div>
                            <button class="t-btn-del">√ó</button>
                        </div>
                    </div>
                    <button class="t-btn-add">‚ûï Adicionar Ponto</button>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, timelineHTML);
        }

        // 3. TABELA (üßÆ)
        else if (action === 'insert-table') {
            const tableHTML = `
                <div class="jwn-table-wrapper">
                    <button class="table-settings-btn" contenteditable="false">üõ†Ô∏è Op√ß√µes</button>
                    <table class="jwn-table">
                        <thead><tr><th>T1</th><th>T2</th></tr></thead>
                        <tbody><tr><td><br></td><td><br></td></tr></tbody>
                    </table>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, tableHTML);
        }

        // 4. TOGGLE (‚òÇ)
        else if (action === 'insert-toggle-h2') {
            const uniqueId = 'toggle_' + Date.now();
            const toggleHTML = `
                <details class="toggle-section" open id="${uniqueId}">
                    <summary>
                        <h2>T√≠tulo</h2>
                        <button class="toggle-move-btn" data-action="move-up">üî∫</button>
                        <button class="toggle-move-btn" data-action="move-down">üîª</button>
                        <button class="toggle-color-btn" contenteditable="false">üñåÔ∏è</button>
                        <button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content" contenteditable="true"><p><br></p></div>
                </details><p><br></p>`;
            document.execCommand('insertHTML', false, toggleHTML);
        }

        // 5. CHECKBOX (‚òëÔ∏è)
        else if (action === 'insert-checkbox') {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.style.marginRight = '8px';
            if (typeof insertNodeAtCursor === 'function') insertNodeAtCursor(checkbox);
        }

        // 6. LINHA (‚Äï)
        else if (cmdSec === 'insertHorizontalRule') {
            document.execCommand('insertHorizontalRule', false, null);
        }

        // 7. ARRASTAR (·Øì)
        else if (action === 'make-draggable') {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
               const uniqueId = `drag_${Date.now()}`;
               const text = selection.toString() || "Texto";
               const draggableHTML = `
                <div class="draggable-line" draggable="true" id="${uniqueId}">
                    <span class="drag-handle-icon" contenteditable="false">·Øì</span>
                    <div class="drag-content-area" contenteditable="true">${text}</div>
                </div>`;
               document.execCommand('insertHTML', false, draggableHTML);
            }
        }
        
        // 8. DUAS COLUNAS (‚è∏Ô∏è)
        else if (action === 'insert-2-cols') {
            const uniqueId = `cols_${Date.now()}`;
            const colsHTML = `
                <div class="journal-cols-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cols-toolbar">
                        <span style="font-size:10px; color:#888; margin-right:5px;">COLUNAS</span>
                        <button class="cols-btn-del" onclick="window.deleteCols(this)" title="Apagar Colunas">üóëÔ∏è</button>
                    </div>
                    <div class="journal-cols-container">
                        <div class="journal-col" contenteditable="true" data-placeholder="Escreva na esquerda..."></div>
                        <div class="journal-col" contenteditable="true" data-placeholder="Escreva na direita..."></div>
                    </div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, colsHTML);
            
            setTimeout(() => {
                const container = document.getElementById(uniqueId);
                if (container) {
                    const firstCol = container.querySelector('.journal-col');
                    if (firstCol) firstCol.focus();
                }
            }, 50);
        }

        // 9. IMAGEM (üñºÔ∏è)
        else if (action === 'insert-image') {
            const uniqueId = `img_${Date.now()}`;
            const widgetHTML = `
                <div class="journal-img-wrapper img-size-md" id="${uniqueId}" contenteditable="false">
                    <div class="journal-img-placeholder">
                        <span style="font-size: 24px;">üñºÔ∏è</span>
                        <input type="text" placeholder="Cole o link da imagem aqui..." class="img-url-input">
                        <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px; cursor:pointer;">OK</button>
                    </div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, widgetHTML);
        }

        // 10. RACIOC√çNIO (ü™ß)
 else if (action === 'insert-sign') {
    e.preventDefault();
    const uniqueId = `sign_${Date.now()}`;
    
    const signHTML = `
        <div class="journal-sign-wrapper" id="${uniqueId}" contenteditable="false">
            <div class="sign-toolbar">
                <span style="font-size: 1.2em; margin-right: auto;">ü™ß Racioc√≠nio<span class="sign-number-display"></span></span>
                <button class="sign-move-btn" onclick="window.moveSign(this, -1)" title="Mover para Cima">‚ñ≤</button>
                <button class="sign-move-btn" onclick="window.moveSign(this, 1)" title="Mover para Baixo">‚ñº</button>
                <span style="border-left:1px solid rgba(0,0,0,0.2); height:15px; margin:0 5px;"></span>
                
                <!-- AQUI EST√Å A MUDAN√áA: USAR A NOVA FUN√á√ÉO -->
                <button class="sign-btn-del" onclick="window.confirmSignDelete(this)" title="Mover para a Reciclagem">üóëÔ∏è</button>
                
            </div>
            <div class="sign-header">
                <input type="text" class="sign-title-input" placeholder="Linha de Racioc√≠nio..." value="">
            </div>
            <div class="sign-content" contenteditable="true" data-placeholder="Escreva a sua resposta ou racioc√≠nio aqui..."></div>
            <div class="sign-attachments-area"></div>
            <div class="sign-add-btn-area">
                <button class="sign-add-btn" onclick="window.addAttachmentToSign(this)">+</button>
            </div>
        </div><p><br></p>`;
    
    // Se estiver a usar a fun√ß√£o auxiliar insertWidget (que existe no seu c√≥digo):
    if (typeof insertWidget === 'function') {
        insertWidget(signHTML, uniqueId, '.sign-title-input');
    } else {
        document.execCommand('insertHTML', false, signHTML);
    }
}

        // 11. CART√ÉO (ü™™)
        else if (action === 'insert-card') {
            const uniqueId = `card_${Date.now()}`;
            const cardHTML = `
                <div class="journal-id-card" id="${uniqueId}" contenteditable="false">
                    <div class="card-toolbar">
                        <button onclick="window.moveSign(this, -1)" title="Mover Cima">‚ñ≤</button>
                        <button onclick="window.moveSign(this, 1)" title="Mover Baixo">‚ñº</button>
                        <button class="card-del-btn" onclick="window.archiveMiniNote(this.closest('.journal-id-card'), false)">üóëÔ∏è</button>
                    </div>
                    <div class="card-body">
                        <div class="card-image-area">
                            <div class="card-img-placeholder" onclick="window.setCardImage(this)">
                                <span>üì∑</span><small>Add Foto</small>
                            </div>
                        </div>
                        <div class="card-text-area">
                            <input type="text" class="card-title-input" placeholder="Nome / T√≠tulo" value="">
                            <div class="card-desc-content" contenteditable="true" data-placeholder="Detalhes, biografia ou descri√ß√£o..."></div>
                        </div>
                    </div>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, cardHTML);
        }

        // 12. CUBO (üßä)
        else if (action === 'insert-cube') {
            const uniqueId = `cube_${Date.now()}`;
            const cubeHTML = `
                <div class="journal-cube-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cube-toolbar" contenteditable="false">
                        <span class="cube-drag-handle" title="Segure para arrastar" draggable="true">‚ú•</span>
                        <div style="width:1px; background:#555; margin:0 4px;"></div>
                        <button data-cmd="float-left" title="Esquerda">‚¨Ö</button>
                        <button data-cmd="float-none" title="Largura Total">‚¨õ</button>
                        <button data-cmd="float-right" title="Direita">‚û°</button>
                        <div style="width:1px; background:#555; margin:0 4px;"></div>
                        <button data-cmd="delete-cube" style="color:#e74c3c;">üóëÔ∏è</button>
                    </div>
                    <div class="cube-content" contenteditable="true">
                        <strong>üßä T√≠tulo do Bloco</strong>
                        <p>Escreva aqui o seu texto...</p>
                    </div>
                </div><p style="clear:both;"><br></p>`;
            document.execCommand('insertHTML', false, cubeHTML);
        }

        // FECHAR O POPUP E GRAVAR
        document.getElementById('formatting-popup').style.display = 'none';
        document.getElementById('more-formatting-btn').classList.remove('active');
        saveNote();
    }
});


// ====================================================================
// CORRE√á√ÉO PARA O UNDO/REDO EM SUBNOTAS E QUEST√ïES
// ====================================================================

// Quando escrevemos no t√≠tulo, for√ßamos o atributo HTML 'value' a atualizar.
// Isto permite que o document.execCommand('undo') saiba que o texto mudou.
noteContentEditor.addEventListener('input', (e) => {
    // Se o utilizador estiver a escrever no t√≠tulo da Entidade (Quest√£o/Subnota)
    if (e.target.classList.contains('mini-note-title-input')) {
        
        // SINCRONIZA√á√ÉO CR√çTICA:
        // Atualiza o conte√∫do interno (para o innerHTML apanhar o texto novo)
        if (e.target.tagName === 'TEXTAREA') {
            e.target.textContent = e.target.value;
        } else {
            // Mant√©m suporte para inputs antigos
            e.target.setAttribute('value', e.target.value);
        }

        // Se a op√ß√£o de t√≠tulo completo estiver ligada, ajusta a altura enquanto escreves
        if (appSettings.showFullTitles) {
            autoResizeTitle(e.target);
        }

        // Dispara a grava√ß√£o autom√°tica
        updateSaveStatus('unsaved');
        saveNote();
    }
});

// ====================================================================
// GESTOR DE CLIQUES (√ÇNCORAS, LINKS E TAGS)
// ====================================================================
document.getElementById('right-panel').addEventListener('click', (event) => {
    const target = event.target;
    
    // LOG 1: O clique chegou ao painel?

    // 1. Verificar se √© um bot√£o (para ignorar)
    if (target.closest('button')) {
        return;
    }

    // 2. Tentar encontrar as nossas refer√™ncias
    const anchor = target.closest('.entity-link');
    const link = target.closest('a[data-anexo-id]');
    const tag = target.closest('.tag');


    if (anchor || link || tag) {
        // Bloquear comportamento de edi√ß√£o para o clique funcionar
        event.preventDefault();
        event.stopPropagation();
        

        if (anchor) {
            const name = anchor.dataset.entityName;
            const type = anchor.dataset.entityType;
            
            // LOG 3: Verificar se o cache de entidades est√° vazio
            const all = Object.values(allEntities).flat();
            
            const entity = all.find(e => e.nome === name);
            if (entity) {
                showReferencesPanel(entity.id, name, type);
            } else {
                console.error("ERRO: Entidade n√£o encontrada no cache local!");
                // Tentativa de emerg√™ncia se o cache falhar
                showReferencesPanel(null, name, type);
            }
        } 
        else if (link) {
            const id = link.dataset.anexoId;
            openViewLinkModal(id);
        } 
        else if (tag) {
            const tagName = tag.textContent.replace('#', '').trim();
            showTagReferencesPanel(tagName);
        }
        
        // LOG 4: Verificar se a classe de visibilidade foi adicionada
        setTimeout(() => {
            const visible = notebookContainer.classList.contains('references-panel-visible');
        }, 100);
    } else {
    }
}, true);

// ====================================================================
// FUN√á√ÉO: ARQUIVAR MINI-NOTA (Mover para Reciclagem no Firebase)
// ====================================================================
 window.archiveMiniNote = async function(element, skipConfirmation = false) {
    if (!element) return false;

    // --- 1. SAFEGUARD ID (A CORRE√á√ÉO DO ERRO) ---
    // Se o elemento n√£o tiver ID, geramos um agora para o Firebase n√£o falhar
    if (!element.id || element.id.trim() === "") {
        const prefix = element.classList.contains('redator-wrapper') ? 'red' : 'mn';
        element.id = `${prefix}_${Date.now()}_recovered`;
        console.log("‚ö†Ô∏è ID em falta detetado. Gerado novo ID tempor√°rio:", element.id);
    }
    const itemId = element.id; 
    // -----------------------------------------------------------

    // 2. Identificar onde estamos
    let targetId = selectedNoteId;
    if (!targetId) {
        const urlParams = new URLSearchParams(window.location.search);
        targetId = urlParams.get('rootId') || urlParams.get('noteId');
    }
    
    if (!targetId) return false;

    if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);

    let associationsToClean = [];
    
    // --- CAPTURA DE METADADOS ---
    const boxLinks = element.getAttribute('data-box-links') || '{}';
    const topics = element.getAttribute('data-topics') || '{}';
    const shared = element.getAttribute('data-shared') || 'false';
    const highlight = element.getAttribute('data-highlight') || ''; 
    const paragraphId = element.getAttribute('data-paragraph') || ''; 
    
    try {
        const linksData = JSON.parse(boxLinks);
        if (linksData.associations) {
            associationsToClean = linksData.associations;
        }
    } catch(e) {}

    let originalIndex = 0; 
    if (element.parentNode) {
        originalIndex = Array.from(element.parentNode.children).indexOf(element);
    }

    let title = "Sem T√≠tulo"; 
    let content = element.innerHTML; 
    let type = "default";
    
    // Dados para Est√°tua
    let originNoteId = null;
    let originBoxId = null;

    const inp = element.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input');
    if (inp) title = inp.value;
    else {
        const strong = element.querySelector('strong');
        if (strong) title = strong.textContent;
    }
    
    // Dete√ß√£o de Tipo
    if (element.classList.contains('redator-wrapper')) { type = 'redator'; }
    else if (element.classList.contains('question-mode')) { type = 'question'; }
    else if (element.classList.contains('free-mode')) { type = 'free'; }
    else if (element.classList.contains('journal-sign-wrapper')) { type = 'sign'; }
    else if (element.classList.contains('journal-id-card')) { type = 'card'; }
    else if (element.classList.contains('journal-cube-wrapper')) { type = 'cube'; }
    else if (element.tagName === 'DETAILS') { type = 'toggle'; }
     else if (element.classList.contains('jwn-table-wrapper')) { type = 'table'; } 
    else if (element.classList.contains('statue-card-wrapper')) {
        type = 'statue';
        title = "Est√°tua: " + (element.querySelector('.statue-content-lock strong')?.textContent || "Sem t√≠tulo");
        originNoteId = element.dataset.originNote;
        originBoxId = element.dataset.originBox;
    }
    else { type = "default"; }

    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', targetId);
        
        const trashItem = {
            id: itemId, 
            titulo: title, 
            conteudo: content,
            type: type,
            originalIndex: originalIndex, 
            deletedAt: serverTimestamp(),
            
            // --- DADOS GUARDADOS ---
            topicsJSON: topics,      
            boxLinksJSON: boxLinks,  
            sharedState: shared,     
            highlightColor: highlight, 
            paragraphId: paragraphId,  
            
            originNoteId: originNoteId,
            originBoxId: originBoxId
        };

        const editor = document.getElementById('note-content-editor');
        
        // Sincroniza inputs
        if (editor) {
             editor.querySelectorAll('.mini-note-title-input, .redator-input').forEach(t => {
                if (t.tagName === 'INPUT') t.setAttribute('value', t.value);
                else t.textContent = t.value;
            });
        }

        const marker = document.createElement('span');
        marker.id = `marker_${itemId}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        if (element.parentNode) element.replaceWith(marker);

        const finalHTML = editor ? editor.innerHTML : "";

        // GRAVA√á√ÉO NO FIREBASE (Agora segura porque itemId nunca √© vazio)
        await updateDoc(noteRef, {
            conteudo: finalHTML, 
            [`subnotasocultas.${itemId}`]: trashItem, 
            ultimaedicao: serverTimestamp()
        });
        
        if (associationsToClean.length > 0) {
            window.cleanDeadAssociations(itemId, associationsToClean);
        }

        if (typeof updateSaveStatus === 'function') updateSaveStatus('saved');
        return true;

    } catch (error) {
        console.error("Erro ao arquivar:", error);
        // Se falhar, mostra o elemento de volta
        element.style.display = 'block';
        alert("Erro ao mover para a lixeira: " + error.message);
        return false;
    }
};
  

 

// ====================================================================

// ==========================================================
// GEST√ÉO DE LINKS DO QUADRO (PUZZLE)
// ==========================================================

let currentBoardRange = null; // Guarda a sele√ß√£o dentro do cart√£o

window.openBoardLinkManager = function(contentDiv) {
    const selection = window.getSelection();
    let existingLink = null;

    // 1. Tentar detetar se o cursor ou a sele√ß√£o est√£o dentro de um link .board-link
    if (selection.rangeCount > 0) {
        const anchorNode = selection.anchorNode;
        // Obt√©m o elemento HTML pai do n√≥ onde est√° o cursor (se for n√≥ de texto, pega o pai)
        const targetEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        // Procura para cima na √°rvore se existe um link do quadro
        existingLink = targetEl.closest('a.board-link');
    }

    // --- CASO A: EDITAR LINK EXISTENTE ---
    if (existingLink) {
        console.log("‚úèÔ∏è Link detetado sob o cursor no Quadro. Abrindo edi√ß√£o...");
        openBoardLinkModal(true, existingLink);
        return;
    }

    // --- CASO B: CRIAR NOVO LINK ---
    // Se n√£o h√° link, mas tamb√©m n√£o h√° texto selecionado, avisa o utilizador
    if (selection.isCollapsed || selection.toString().trim() === "") {
        alert("Clique num link azul para o editar ou selecione um texto para criar um novo link.");
        return;
    }

    // Verifica se a sele√ß√£o est√° realmente dentro da caixa de texto do cart√£o para seguran√ßa
    if (!contentDiv.contains(selection.anchorNode)) {
        alert("Por favor, selecione o texto dentro do cart√£o.");
        return;
    }

    // Guarda a sele√ß√£o para inserir o link ap√≥s fechar o modal
    currentBoardRange = selection.getRangeAt(0).cloneRange();
    
    // Abre o modal em modo cria√ß√£o, passando o texto selecionado como t√≠tulo
    openBoardLinkModal(false, selection.toString());
};

window.openBoardLinkModal = function(isEdit, data) {
    const modal = document.getElementById('link-modal');
    const titleInput = document.getElementById('link-title-input');
    const urlsContainer = document.getElementById('link-urls-container');
    const saveBtn = document.getElementById('link-save-btn');
    const removeBtn = document.getElementById('link-remove-btn');
    const modalTitle = document.getElementById('link-modal-title');

    // 1. RESET E PREPARA√á√ÉO DA INTERFACE
    urlsContainer.innerHTML = '';
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = '30000'; // Garante que fica acima da 4¬™ coluna
    document.body.appendChild(modal); // Move para o body para evitar cortes de layout

    // Clonar bot√µes para limpar eventos antigos de cliques anteriores
  const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    // Configurar o bot√£o de adicionar URLs extra
    const addUrlBtn = document.getElementById('add-url-btn');
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = (e) => { e.preventDefault(); window.addUrlField(); };

    // --- ADICIONE ESTE BLOCO AQUI ---
    // Configurar o bot√£o de adicionar Linha Codex
    const addCodexBtn = document.getElementById('add-codex-row-btn');
    if (addCodexBtn) {
        const newAddCodexBtn = addCodexBtn.cloneNode(true);
        addCodexBtn.parentNode.replaceChild(newAddCodexBtn, addCodexBtn);
        newAddCodexBtn.onclick = (e) => { 
            e.preventDefault(); 
            window.createCodexRow(); // Chama a fun√ß√£o que cria a linha
        };
    }
    // ---------------------------------

    let existingLinkElement = null;

    // 2. CARREGAR DADOS (EDI√á√ÉO vs CRIA√á√ÉO)
    if (isEdit) {
        modalTitle.textContent = "Editar Link do Quadro";
        existingLinkElement = data; // O elemento <a> recebido
        titleInput.value = existingLinkElement.textContent;
        newRemoveBtn.style.display = 'block';
        newRemoveBtn.textContent = "Remover Link";

        // Tentar ler os URLs guardados no atributo data-json
        try {
            const rawJson = existingLinkElement.dataset.json;
            if (rawJson) {
                const urls = JSON.parse(decodeURIComponent(rawJson));
                urls.forEach(u => addUrlField(u));
            } else {
                addUrlField(existingLinkElement.href); // Fallback link simples
            }
        } catch(e) {
            console.warn("Erro ao ler JSON, usando href.");
            addUrlField(existingLinkElement.href);
        }
    } else {
        modalTitle.textContent = "Novo Link no Quadro";
        titleInput.value = data; // O texto que foi selecionado
        newRemoveBtn.style.display = 'none';
        addUrlField(); // Come√ßa com um campo vazio
    }

    // 3. A√á√ÉO: GRAVAR (Salvar Altera√ß√µes ou Criar Novo)
    newSaveBtn.onclick = (e) => {
        e.preventDefault();
        const urls = [];
        urlsContainer.querySelectorAll('input').forEach(inp => {
            if(inp.value.trim()) {
                let u = inp.value.trim();
                if(!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (urls.length === 0) {
            alert("Insira pelo menos um endere√ßo (URL).");
            return;
        }

        // Criar ou Atualizar o elemento <a>
        const a = isEdit ? existingLinkElement : document.createElement('a');
        a.href = "#"; // Href fict√≠cio pois usamos o data-json para abrir
        a.className = "board-link";
        a.style.cursor = "pointer";
        a.setAttribute('spellcheck', 'false');
        a.textContent = titleInput.value.trim() || "Link";
        
        // Guarda o array de URLs codificado no dataset
        a.dataset.json = encodeURIComponent(JSON.stringify(urls));

        // Se for cria√ß√£o, insere o elemento no local da sele√ß√£o guardada
        if (!isEdit && currentBoardRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(currentBoardRange);
            currentBoardRange.deleteContents();
            currentBoardRange.insertNode(a);
            
            // Adiciona um espa√ßo ap√≥s o link para facilitar continuar a escrever
            const space = document.createTextNode('\u00A0');
            a.parentNode.insertBefore(space, a.nextSibling);
        }
        
        modal.style.display = 'none';
        // Se estiveres no modo edi√ß√£o do Puzzle, a grava√ß√£o autom√°tica tratar√° do resto
    };

    // 4. A√á√ÉO: REMOVER (Transformar link em texto simples)
    newRemoveBtn.onclick = (e) => {
        e.preventDefault();
        if (existingLinkElement) {
            const textNode = document.createTextNode(existingLinkElement.textContent);
            existingLinkElement.parentNode.replaceChild(textNode, existingLinkElement);
        }
        modal.style.display = 'none';
    };
};

// 5. VISUALIZAR LINKS (Ao clicar no texto azul)
window.viewBoardLink = function(linkElement) {
    console.group("%cüîç [DEBUG] Visualizador de Links do Quadro", "color: #4a90e2; font-weight: bold;");
    
    const modal = document.getElementById('view-link-modal');
    const list = document.getElementById('view-link-urls-list');
    const titleEl = document.getElementById('view-link-title');
    
    if (!modal || !list) {
        console.error("‚ùå Elementos do modal n√£o encontrados!");
        console.groupEnd();
        return;
    }

    try {
        const rawJson = linkElement.dataset.json;
        const urls = JSON.parse(decodeURIComponent(rawJson));
        
        titleEl.textContent = linkElement.textContent;
        list.innerHTML = '';
        
        urls.forEach((url, idx) => {
            const li = document.createElement('li');
            li.style.cssText = `
                padding: 15px; 
                margin-bottom: 10px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: rgba(255,255,255,0.05);
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;

            li.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: baseline; pointer-events: none;">
                    <span style="font-weight:bold; color: var(--text-muted-color);">${idx + 1}.</span>
                    <span style="color: var(--accent-color); text-decoration: underline; word-break: break-all;">
                        ${url}
                    </span>
                </div>
                <span style="color: var(--text-muted-color);">‚ÜóÔ∏è</span>
            `;

            // Clique no item da lista abre o link
            li.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                window.open(url, '_blank');
            });

            list.appendChild(li);
        });

        // For√ßa o modal a ir para o body (topo da hierarquia) e aparecer
        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.opacity = "1";
        modal.style.visibility = "visible";
        
        console.log("‚úÖ Modal exibido no topo absoluto.");

    } catch(e) {
        console.error("‚ùå Erro ao processar links:", e);
    }
    console.groupEnd();
};


// ====================================================================

tagSuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const li = e.target.closest('li');
    if (li) {
        const selected = tagSuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitTagSelection();
    }
});

entitySuggestionList.addEventListener('mousedown', (e) => {
    e.preventDefault(); // Impede que o editor perca o foco
    const li = e.target.closest('li');
    if (li) {
        const selected = entitySuggestionList.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        li.classList.add('selected');
        commitEntitySelection();
    }
});

// ====================================================================
// L√ìGICA DA TESOURA (Converter Post-it em Texto)
// ====================================================================
noteContentEditor.addEventListener('click', async (e) => {

// -----------------------------------------------------------
// 1. L√ìGICA DO POST-IT (‚úÇÔ∏è) - TESOURA
// -----------------------------------------------------------
if (e.target.classList.contains('post-it-cut-btn')) {
    e.preventDefault(); e.stopPropagation();
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    const contentDiv = postIt.querySelector('.post-it-content');
    const savedHTML = contentDiv.innerHTML;
    const postItRect = postIt.getBoundingClientRect();
    
    const newPara = document.createElement('p');
    newPara.innerHTML = savedHTML || "<br>";
    
    const children = Array.from(noteContentEditor.children);
    let inserted = false;
    for (const child of children) {
        if (child === postIt || child.classList.contains('post-it-note')) continue;
        if (child.getBoundingClientRect().top > postItRect.top) {
            noteContentEditor.insertBefore(newPara, child);
            inserted = true;
            break;
        }
    }
    if (!inserted) noteContentEditor.appendChild(newPara);

    postIt.remove();
    
    // Focar
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(newPara);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
    
    saveNote();
    return; 
}

// -----------------------------------------------------------
// 2. L√ìGICA DO CART√ÉO WEB (‚úï) - REVERTER PARA LINK
// -----------------------------------------------------------
if (e.target.classList.contains('url-card-close')) {
    e.preventDefault(); e.stopPropagation();

    const card = e.target.closest('.url-card-widget');
    if (!card) return;

    const originalUrl = card.dataset.originalUrl;

    // Criar o link de texto original
    const a = document.createElement('a');
    a.href = originalUrl;
    a.textContent = originalUrl;
    a.target = "_blank";
    a.style.color = "var(--accent-color)";
    a.style.textDecoration = "underline";

    card.replaceWith(a);
    
    const space = document.createTextNode('\u00A0');
    a.after(space);

    saveNote();
    return;
}

// -----------------------------------------------------------
// 3. NAVEGA√á√ÉO DO CART√ÉO WEB (Abrir Link) - NOVO!
// -----------------------------------------------------------
const cardWidget = e.target.closest('.url-card-widget');
// Se clicou num card, MAS N√ÉO no bot√£o de fechar
if (cardWidget && !e.target.classList.contains('url-card-close')) {
    e.preventDefault(); 
    e.stopPropagation();

    const url = cardWidget.dataset.originalUrl;
    
    if (url) {
        // Abre numa nova aba
        window.open(url, '_blank');
    }
    return;
}

// -----------------------------------------------------------
// 4. L√ìGICA DE APAGAR SEC√á√ÉO/TOGGLE (üóëÔ∏è)
// -----------------------------------------------------------
const toggleDelBtn = e.target.closest('.toggle-delete-btn');
if (toggleDelBtn) {
    e.preventDefault(); e.stopPropagation();
    const detailsElement = toggleDelBtn.closest('details');
    if (!detailsElement) return;

    const success = await archiveMiniNote(detailsElement); 
    if (success) {
        const marker = document.createElement('span');
        marker.id = `marker_${detailsElement.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        detailsElement.replaceWith(marker);
        saveNote();
    }
    return;
}

// -----------------------------------------------------------
// 5. L√ìGICA DE APAGAR SUBNOTA/QUEST√ÉO (üóëÔ∏è)
// -----------------------------------------------------------
const deleteBtn = e.target.closest('button[data-action="delete-mini-note"]');
if (deleteBtn) {
    console.group("üóëÔ∏è [DEBUG] Processo de Elimina√ß√£o Iniciado");
    console.log("1. Bot√£o clicado:", deleteBtn);

    // 1. Verifica√ß√µes de seguran√ßa
    if (noteContentEditor.contentEditable === "false") {
        console.warn("üö´ Tentativa de apagar em modo leitura.");
        alert("N√£o tem permiss√£o para editar esta nota partilhada.");
        console.groupEnd();
        return;
    }
    
    e.preventDefault(); 
    e.stopPropagation();

    // 2. Identificar a caixa (AQUI √â CR√çTICO: TEM DE TER .redator-wrapper)
    const wrapper = deleteBtn.closest('.mini-note-wrapper, .redator-wrapper');
    
    if (!wrapper) {
        console.error("‚ùå ERRO: N√£o encontrei o wrapper pai (.mini-note-wrapper ou .redator-wrapper)!");
        console.groupEnd();
        return; 
    }

    console.log("2. Wrapper Pai encontrado:", wrapper);
    console.log("   - Classes:", wrapper.className);
    console.log("   - ID:", wrapper.id);

    const wrapperId = wrapper.id; 
    
    // Identificar tipo para a mensagem
    let label = "Item";
    if (wrapper.classList.contains('redator-wrapper')) label = "Redator"; // <--- LOGICA NOVA
    else if (wrapper.classList.contains('question-mode')) label = "Quest√£o";
    else label = "SubNota";

    console.log("3. Tipo identificado para o popup:", label);

    // 3. Confirma√ß√£o
    const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar este ${label}?`);
    
    if (!confirmed) {
        console.log("üö´ Utilizador cancelou a a√ß√£o.");
        console.groupEnd();
        return;
    }

    console.log("‚úÖ Utilizador confirmou. Iniciando arquivo...");

    // Esconde logo visualmente
    wrapper.style.display = 'none';

    try {
        // 4. Arquivar na Base de Dados
        const success = await archiveMiniNote(wrapper, true);
        
        console.log("4. Resultado do archiveMiniNote:", success);

        if (success) {
            console.log("5. Sucesso! Removendo do DOM e criando marcador.");
            
            const marker = document.createElement('span');
            marker.id = `marker_${wrapperId}`;
            marker.className = 'hidden-note-marker';
            marker.style.display = 'none';
            
            // Substitui√ß√£o segura
            const elementToRemove = document.getElementById(wrapperId) || wrapper;
            if (elementToRemove && elementToRemove.parentNode) {
                elementToRemove.replaceWith(marker);
            }
            
            await saveNote(true);
            console.log("üíæ Nota guardada.");
        } else {
            console.error("‚ùå archiveMiniNote retornou false.");
            wrapper.style.display = 'block';
            alert("N√£o foi poss√≠vel arquivar. A caixa foi restaurada.");
        }
    } catch (err) {
        console.error("üî• Erro Cr√≠tico:", err);
        wrapper.style.display = 'block'; 
    }
    
    console.groupEnd();
    return;
}
});

// ====================================================================
// PROTE√á√ÉO: DETETAR DELETE EM MASSA DE MINI-NOTAS
// ====================================================================
noteContentEditor.addEventListener('keydown', async (event) => {
    // Apenas nos interessa Backspace ou Delete
    if (event.key !== 'Delete' && event.key !== 'Backspace') return;

    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const anchorNode = selection.anchorNode;
    // Garante que temos o elemento HTML
    const currentEl = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

    // --- [MANT√âM-SE A PROTE√á√ÉO DE TOGGLES/BACKSPACE ANTERIOR AQUI] ---
    // (Pode manter o c√≥digo do bloco 1.1, 1.2 e 1.3 que j√° tinha para prote√ß√£o de Toggles, 
    //  pois ele lida com cursor colapsado. O foco agora √© a sele√ß√£o expandida.)
    
    // SE N√ÉO HOUVER SELE√á√ÉO DE TEXTO (CURSOR APENAS A PISCAR), SAI
    if (selection.isCollapsed) return;

    // --- VERIFICA√á√ÉO DE SEGURAN√áA PARA EDI√á√ÉO INTERNA ---
    const focusNode = selection.focusNode;
    const endEl = focusNode.nodeType === 3 ? focusNode.parentElement : focusNode;

    const startWrapper = currentEl.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
    const endWrapper = endEl.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');

    // Se a sele√ß√£o come√ßa e acaba DENTRO da mesma caixa, √© edi√ß√£o de texto normal. Permitir.
    if (startWrapper && startWrapper === endWrapper) {
        return; 
    }

    // 3. PROCURAR SELE√á√ÉO EM MASSA
    const allWrappers = noteContentEditor.querySelectorAll('.mini-note-wrapper, details.toggle-section, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .ref-depot-wrapper, .jwn-timeline-wrapper, .jwn-table-wrapper');
    
    const wrappersToDelete = [];
    allWrappers.forEach(wrapper => {
        if (selection.containsNode(wrapper, true)) {
            wrappersToDelete.push(wrapper);
        }
    });

    // 4. SE A SELE√á√ÉO CONT√âM ITENS COMPLEXOS:
    if (wrappersToDelete.length > 0) {
        event.preventDefault();
        event.stopPropagation();

        const count = wrappersToDelete.length;
        const totalInEditor = allWrappers.length;
        
        // DETE√á√ÉO DE "SELECIONAR TUDO" (Ou quase tudo)
        // Se a quantidade de itens a apagar for igual ao total, ou se for uma quantidade grande (> 2)
        const isMassiveDelete = (count === totalInEditor) || (count >= 3);

        if (isMassiveDelete) {
            // --- CEN√ÅRIO A: APAGAR TUDO (BACKUP DE SEGURAN√áA) ---
            const confirmed = await showConfirmation(
                "‚ö†Ô∏è Aten√ß√£o: Dados Importantes", 
                `Est√° prestes a apagar ${count} blocos de conte√∫do complexo.\n\nPara seguran√ßa, ser√° criado um Backup Autom√°tico antes de limpar a nota. Deseja continuar?`
            );

            if (!confirmed) return;

            // Feedback visual no bot√£o do modal (caso ainda estivesse vis√≠vel)
            const modalBtn = document.querySelector('#confirm-modal .modal-btn.primary');
            if(modalBtn) modalBtn.textContent = "A Criar Backup...";

            // 1. Criar o Backup Completo
            const currentHTML = noteContentEditor.innerHTML;
            const currentTitle = document.getElementById('note-title-input').value;
            
            await performSafetyBackup(selectedNoteId, currentHTML, currentTitle);

            // 2. Limpar o Editor
            // Se for "Selecionar Tudo", limpa tudo. Se for parcial, apaga s√≥ a sele√ß√£o.
            if (count === totalInEditor) {
                noteContentEditor.innerHTML = '<p><br></p>';
            } else {
                range.deleteContents();
            }

            // 3. Gravar o estado "Vazio"
            saveNote(true);

            // Feedback visual
            const statusEl = document.getElementById('save-status-indicator');
            if(statusEl) {
                statusEl.textContent = "Backup Criado & Nota Limpa";
                setTimeout(() => statusEl.textContent = "Guardado", 3000);
            }

        } else {
            // --- CEN√ÅRIO B: APAGAR 1 OU 2 ITENS (L√ìGICA ORIGINAL DE RECICLAGEM) ---
            // Mant√©m a l√≥gica de enviar para a lixeira individualmente
            const confirmDelete = await showConfirmation(
                "Mover para a Lixeira?", 
                `A sele√ß√£o cont√©m ${count} item(s). Eles ser√£o movidos para o Hist√≥rico/Reciclagem.`
            );

            if (!confirmDelete) return;

            const modalBtn = document.querySelector('#confirm-modal .modal-btn.primary');
            if(modalBtn) modalBtn.textContent = "A Arquivar...";

            const archivePromises = wrappersToDelete.map(wrapper => archiveMiniNote(wrapper, true)); 
            await Promise.all(archivePromises);

            range.deleteContents();
            saveNote();
        }
    }
});


// --- L√ìGICA DA BARRA DE INSER√á√ÉO R√ÅPIDA (üìò üìí) ---

const insertionPopup = document.getElementById('insertion-popup');

// 1. APARECER: Ao clicar no editor
noteContentEditor.addEventListener('click', (e) => {
    
    // A. Guardar a altura do clique IMEDIATAMENTE
    const clickY = e.clientY;

    // --- PROTE√á√ïES: Se clicar nestes elementos, o menu N√ÉO abre ---
    if (e.target.closest('.idea-span')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.mini-note-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.ref-depot-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.journal-sign-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.journal-id-card')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    
    const redator = e.target.closest('.redator-wrapper');
    if (redator) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    
    if (e.target.closest('.jwn-calendar-widget')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('table')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    if (e.target.closest('.jwn-timeline-wrapper')) { document.getElementById('insertion-popup').style.display = 'none'; return; }
    
    // PROTE√á√ÉO 10: T√≠tulo Expans√≠vel / Toggle (‚òÇ)
    if (e.target.closest('summary')) { document.getElementById('insertion-popup').style.display = 'none'; return; }

    // --- C√ÅLCULO E EXIBI√á√ÉO DO POPUP ---
    setTimeout(() => {
        const selection = window.getSelection();
        
        // S√≥ mostramos se N√ÉO houver texto selecionado (cursor a piscar)
        if (selection && selection.rangeCount > 0 && selection.isCollapsed) {
            
            // Fecha outros popups que possam estar abertos
            if(document.getElementById('selection-popup')) document.getElementById('selection-popup').style.display = 'none';
            if(document.getElementById('idea-actions-popup')) document.getElementById('idea-actions-popup').style.display = 'none';

            const popup = document.getElementById('insertion-popup');
            const editor = document.getElementById('note-content-editor');
            
            // --- L√ìGICA DO √çCONE REDATOR (üìì) ---
            const redatorBtn = document.getElementById('popup-btn-redator');
            if (redatorBtn) {
                // Verifica a vari√°vel global definida no displayNote
                if (window.currentNoteType === 'jornal') {
                    redatorBtn.style.display = 'flex'; // Mostra no Jornal
                } else {
                    redatorBtn.style.display = 'none'; // Esconde nas Notas normais
                }
            }
            
            // ============================================================
            // >>> NOVA L√ìGICA INTELIGENTE DO √çCONE RACIOC√çNIO (ü™ß) <<<
            // ============================================================
            const signBtn = document.getElementById('popup-btn-sign');
            if (signBtn) {
                // Verifica se existe ALGUMA caixa de racioc√≠nio no editor
                const hasSignBox = editor.querySelector('.journal-sign-wrapper');
                
                if (hasSignBox) {
                    signBtn.style.display = 'flex'; // Mostra se j√° existir pelo menos uma
                } else {
                    signBtn.style.display = 'none'; // Esconde se n√£o houver nenhuma
                }
            }
            // ============================================================

            // --- POSICIONAMENTO DEFINITIVO ---
            const editorRect = noteContentEditor.getBoundingClientRect();
            const leftPos = editorRect.left;
            const topPos = clickY; // Usa a coordenada Y capturada no clique

            popup.style.display = 'flex';
            
            // Aplica as posi√ß√µes (com ajuste de scroll e offset de 85px para cima para n√£o tapar o texto)
            popup.style.top = `${topPos + window.scrollY - 85}px`; 
            popup.style.left = `${leftPos + window.scrollX + 10}px`; 

        } else {
            // Se houver texto selecionado, esconde este popup (para aparecer o de sele√ß√£o)
            document.getElementById('insertion-popup').style.display = 'none';
        }
    }, 10); 
});



// 2. DESAPARECER: Ao come√ßar a escrever
noteContentEditor.addEventListener('keydown', () => {
    insertionPopup.style.display = 'none';
});

// 3. A√á√ïES DOS BOT√ïES
insertionPopup.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation(); 

    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;

    // 1. SUBNOTA AZUL (üìò)
    if (action === 'quick-mini-note') {
        insertMiniNoteAtCursor('default'); 
        saveNote();
        insertionPopup.style.display = 'none';
    } 
    
    // 2. QUEST√ÉO VERDE (üìó)
    else if (action === 'insert-question') {
        insertMiniNoteAtCursor('question'); 
        saveNote();
        insertionPopup.style.display = 'none';
    }

    // 3. CONTENTOR LARANJA (üìô)
    else if (action === 'insert-free-container') {
        insertMiniNoteAtCursor('free'); 
        saveNote();
        insertionPopup.style.display = 'none';
    }

    // 4. REDATOR PRETO (üìì)
    else if (action === 'insert-redator') {
        insertMiniNoteAtCursor('redator');
        saveNote();
        insertionPopup.style.display = 'none';
    }

    // 5. POST-IT AMARELO (üìí)
    else if (action === 'quick-placeholder') {
        // ... (seu c√≥digo existente do post-it) ...
        const sizePopup = document.getElementById('postit-size-popup');
        if (sizePopup) {
            const rect = insertionPopup.getBoundingClientRect();
            sizePopup.style.top = rect.top + 'px';
            sizePopup.style.left = (rect.right + 5) + 'px';
            sizePopup.style.setProperty('display', 'flex', 'important');
        }
    }

    // ============================================================
    // 6. RACIOC√çNIO (ü™ß) - NOVO
    // ============================================================
    else if (action === 'insert-sign') {
        const uniqueId = `sign_${Date.now()}`;
        
        // Usa o HTML correto com a fun√ß√£o de confirma√ß√£o de delete
        const signHTML = `
            <div class="journal-sign-wrapper" id="${uniqueId}" contenteditable="false">
                <div class="sign-toolbar">
                    <span style="font-size: 1.2em; margin-right: auto;">ü™ß Racioc√≠nio<span class="sign-number-display"></span></span>
                    <button class="sign-move-btn" onclick="window.moveSign(this, -1)" title="Mover para Cima">‚ñ≤</button>
                    <button class="sign-move-btn" onclick="window.moveSign(this, 1)" title="Mover para Baixo">‚ñº</button>
                    <span style="border-left:1px solid rgba(0,0,0,0.2); height:15px; margin:0 5px;"></span>
                    <button class="sign-btn-del" onclick="window.confirmSignDelete(this)" title="Mover para a Reciclagem">üóëÔ∏è</button>
                </div>
                <div class="sign-header">
                    <input type="text" class="sign-title-input" placeholder="Linha de Racioc√≠nio..." value="">
                </div>
                <div class="sign-content" contenteditable="true" data-placeholder="Escreva a sua resposta ou racioc√≠nio aqui..."></div>
                <div class="sign-attachments-area"></div>
                <div class="sign-add-btn-area">
                    <button class="sign-add-btn" onclick="window.addAttachmentToSign(this)">+</button>
                </div>
            </div><p><br></p>`;
        
        // Insere onde estava o cursor
     document.execCommand('insertHTML', false, signHTML);
    
    // Foca no t√≠tulo com anima√ß√£o suave
    setTimeout(() => {
        const el = document.getElementById(uniqueId);
        if (el) {
            // 1. FOCA PRIMEIRO
            const input = el.querySelector('.sign-title-input');
            if (input) input.focus();

            // 2. SCROLL DEPOIS (Anima√ß√£o sobrep√µe o salto do foco)
            requestAnimationFrame(() => {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }
    }, 50); // Delay curto

    saveNote();
    insertionPopup.style.display = 'none';
}
});

// Garante que esconde se fizermos scroll
document.addEventListener('scroll', () => {
    insertionPopup.style.display = 'none';
}, true);

// --- L√ìGICA INTELIGENTE DE ARRASTO ---
noteContentEditor.addEventListener('mouseover', (e) => {
    // Verifica se estamos a passar o rato por cima de um post-it
    const postIt = e.target.closest('.post-it-note');
    if (!postIt) return;

    // Verifica se estamos EXATAMENTE em cima do puxador amarelo
    const isHandle = e.target.closest('.post-it-drag-handle');
    
    if (isHandle) {
        // RATO NO PUXADOR: Ativa o modo de arrastar
        postIt.setAttribute('draggable', 'true');
    } else {
        // RATO NO TEXTO: Desativa o modo de arrastar (para permitir selecionar texto)
        postIt.setAttribute('draggable', 'false');
    }
});


// ====================================================================
// L√ìGICA DO MENU DE TAMANHOS DE POST-IT
// ====================================================================
document.getElementById('postit-size-popup').addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.target.closest('button');
    if (!btn) return;

    const size = btn.dataset.size;
    let width = '250px', height = '180px'; // Padr√£o M√©dio
    
    if (size === 'small') { width = '150px'; height = '100px'; }
    if (size === 'large') { width = '400px'; height = '300px'; }

    // Fun√ß√£o que cria o HTML do post-it (deve existir no seu c√≥digo)
    // Se n√£o tiver a fun√ß√£o 'createPostItElement' separada, use a l√≥gica direta aqui:
    const container = document.createElement('div');
    container.className = 'post-it-note active-note';
    container.setAttribute('draggable', 'false'); // O drag √© ativado no hover
    container.style.width = width;
    container.style.height = height;
    // Posi√ß√£o aproximada (centro do ecr√£ ou perto do scroll)
    container.style.top = (window.scrollY + 150) + 'px';
    container.style.left = '50px';
    
    container.innerHTML = `
        <div class="post-it-drag-handle" contenteditable="false">‚ú•</div>
        <div class="post-it-cut-btn" contenteditable="false" title="Cortar">‚úÇÔ∏è</div>
        <div class="post-it-content" contenteditable="true"></div>
    `;
    
    document.getElementById('note-content-editor').appendChild(container);
    
    // Fecha os menus
    document.getElementById('postit-size-popup').style.display = 'none';
    document.getElementById('insertion-popup').style.display = 'none';
    
    saveNote();
});

// Fechar menu de tamanhos se clicar fora
document.addEventListener('click', (e) => {
    const sizePopup = document.getElementById('postit-size-popup');
    if (sizePopup.style.display !== 'none' && !sizePopup.contains(e.target)) {
        sizePopup.style.display = 'none';
    }
});

// ====================================================================
// FECHAR MENUS FLUTUANTES AO CLICAR NA 4¬™ COLUNA
// ====================================================================
document.getElementById('references-panel').addEventListener('click', () => {
    // 1. Esconde a barra de inser√ß√£o (üìò üìó üìô üìí)
    const insertionPopup = document.getElementById('insertion-popup');
    if (insertionPopup) {
        insertionPopup.style.display = 'none';
    }

    // 2. (Recomendado) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üìç) se estiver aberto
    const selectionPopup = document.getElementById('selection-popup');
    if (selectionPopup) {
        selectionPopup.style.display = 'none';
    }
    
    // 3. (Recomendado) Esconde o menu de a√ß√µes da Ideia (‚úÇÔ∏è)
    const ideaPopup = document.getElementById('idea-actions-popup');
    if (ideaPopup) {
        ideaPopup.style.display = 'none';
    }
});

// ====================================================================
// L√ìGICA DE MOVIMENTO LIVRE (ABSOLUTO) PARA POST-ITS
// ====================================================================

let activePostIt = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

// 1. Clicar no Puxador (Iniciar)
noteContentEditor.addEventListener('mousedown', (e) => {
    const handle = e.target.closest('.post-it-drag-handle');
    if (!handle) return;

    e.preventDefault(); // Impede sele√ß√£o de texto

    activePostIt = handle.closest('.post-it-note');
    
    // Calcula onde clic√°mos DENTRO do post-it (o "ponto de agarre")
    const rect = activePostIt.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    activePostIt.style.opacity = '0.8';
    activePostIt.style.zIndex = '100';
});

// 2. Mover o Rato (Arrastar)
document.addEventListener('mousemove', (e) => {
    if (!activePostIt) return;

    e.preventDefault();

    const container = document.getElementById('note-content-editor');
    
    // Obter as coordenadas do contentor (Editor)
    const containerRect = container.getBoundingClientRect();

    // Calcular a posi√ß√£o X/Y desejada relativa ao contentor
    // (Posi√ß√£oRato - Posi√ß√£oContainer + ScrollContainer - PontoDeAgarre)
    let newLeft = (e.clientX - containerRect.left + container.scrollLeft) - dragOffsetX;
    let newTop = (e.clientY - containerRect.top + container.scrollTop) - dragOffsetY;

    // --- APLICAR LIMITES (CLAMPING) ---
    
    // Limite Horizontal (0 at√© LarguraContainer - LarguraPostIt)
    // Subtra√≠mos 2px extra de seguran√ßa para bordas
    const maxLeft = container.clientWidth - activePostIt.offsetWidth;
    if (newLeft < 0) newLeft = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;

    // Limite Vertical (0 at√© AlturaTotalContainer - AlturaPostIt)
    // Usamos scrollHeight para permitir arrastar at√© ao fundo do texto longo
    const maxTop = container.scrollHeight - activePostIt.offsetHeight;
    if (newTop < 0) newTop = 0;
    if (newTop > maxTop) newTop = maxTop;

    // Aplicar
    activePostIt.style.left = newLeft + 'px';
    activePostIt.style.top = newTop + 'px';
});

// 3. Largar o Rato (Finalizar)
document.addEventListener('mouseup', () => {
    if (activePostIt) {
        activePostIt.style.opacity = '1';
        activePostIt.style.zIndex = '20';
        activePostIt = null;
        saveNote(); 
    }
});

// ====================================================================
// ADICIONE ESTE BLOCO DE EVENT LISTENERS NO FINAL DO SCRIPT
// ====================================================================
document.getElementById('references-toolbar').addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;

    console.log("üõ†Ô∏è Clique na Toolbar da 4¬™ Coluna:", button.id);

    const { id, type, name } = activeReferenceEntity;
    if (!name) {
        console.warn("‚ö†Ô∏è Nenhuma entidade ativa no painel.");
        return;
    }

    switch (button.id) {
        case 'references-refresh-btn':
            showReferencesPanel(id, name, type);
            break;

        case 'references-bookmark-btn':
            console.log("üîñ Solicitando abertura de Marcadores para:", name);
            // LOG DE VERIFICA√á√ÉO DE TIPO
            console.log("üîç Tipo da entidade ativa:", type);
            if (type === 'textobiblico') {
                openBookmarksModal();
            } else {
                console.warn("üö´ Marcadores s√≥ funcionam em Textos B√≠blicos.");
                alert("Marcadores s√£o exclusivos para Textos B√≠blicos.");
            }
            break;

        // --- NOVO: BOT√ÉO √ÇNCORA (‚öì) ---
        case 'references-anchor-btn':
            openAnchorManagerModal();
            break;
        // -----------------------------

        case 'references-wol-btn':
            const encodedQuery = encodeURIComponent(name).replace(/%20/g, '+');
            const wolUrl = `https://wol.jw.org/pt-PT/wol/l/r296/lp-tpo?q=${encodedQuery}`;
            window.open(wolUrl, '_blank');
            break;

        case 'references-search-btn':
            window.open(`https://wol.jw.org/pt/wol/s/r5/lp-t?q=${encodeURIComponent(name)}`, '_blank');
            break;

        case 'references-edit-btn':
            if (id) openEditEntityModal(id, type);
            break;

        case 'references-toggle-btn':
            const allDetails = document.querySelectorAll('#references-list details');
            const openCount = document.querySelectorAll('#references-list details[open]').length;
            const shouldOpen = openCount <= allDetails.length / 2;
            allDetails.forEach(detail => detail.open = shouldOpen);
            break;
    }
});

document.getElementById('toggle-puzzle-edit-btn').addEventListener('click', async () => {
    const container = document.getElementById('ref-content-puzzle');
    const btn = document.getElementById('toggle-puzzle-edit-btn');
    const addButtons = document.getElementById('puzzle-add-buttons');

    // MODO: ENTRAR EM EDI√á√ÉO (Atualmente est√° em modo visualiza√ß√£o)
    if (!container.classList.contains('edit-mode-active')) {
        container.classList.add('edit-mode-active');
        
        // 1. Ajuste Visual do Bot√£o (Usa a classe is-active para ficar azul)
        btn.textContent = "Salvar";
        btn.classList.add('is-active'); 
        
        // 2. Mostrar os bot√µes de adicionar (+ Txt, + Ref, üì°)
        if(addButtons) addButtons.style.display = 'flex';

        // 3. Ativar a edi√ß√£o nos blocos de texto do quadro
        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'true');
            div.style.border = "1px solid var(--border-color)";
            div.style.padding = "8px";
            div.style.borderRadius = "4px";
            div.style.backgroundColor = "var(--bg-color)";
        });
    } 
    // MODO: SALVAR E SAIR (Atualmente est√° em modo edi√ß√£o)
    else {
        // 1. Feedback de grava√ß√£o e execu√ß√£o do Save no Firebase
        btn.textContent = "A gravar...";
        btn.disabled = true;
        await savePuzzleData();
        btn.disabled = false;

        // 2. Reverter Visual do Bot√£o (Volta ao cinza normal)
        container.classList.remove('edit-mode-active');
        btn.textContent = "Editar";
        btn.classList.remove('is-active'); 
        
        // 3. Esconder os bot√µes de adicionar
        if(addButtons) addButtons.style.display = 'none';

        // 4. Bloquear a edi√ß√£o visualmente (Limpa bordas e fundos de input)
        document.querySelectorAll('.board-card.type-text .board-text-content').forEach(div => {
            div.setAttribute('contenteditable', 'false');
            div.style.border = "none";
            div.style.padding = "0";
            div.style.backgroundColor = "transparent";
        });
    }
});



 document.getElementById('anchors-modal').addEventListener('click', (e) => {
    // 1. CLIQUE NAS ABAS
    const tabButton = e.target.closest('button[data-tab]');
    if (tabButton) {
        // Remove active de todos
        document.querySelectorAll('#anchors-tabs-container button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#anchors-content-container .tab-content').forEach(content => content.classList.remove('active'));
        
        // Ativa o selecionado
        tabButton.classList.add('active');
        const contentId = `tab-${tabButton.dataset.tab}`;
        const contentDiv = document.getElementById(contentId);
        if(contentDiv) contentDiv.classList.add('active');
        return;
    }

    // 2. CLIQUE NUM ITEM DA LISTA (Tag ou Entidade)
    const listItem = e.target.closest('li');
    if (listItem) {
        // A√ß√£o para TAGS
        if (listItem.dataset.action === 'show-tag-references') {
            const tagName = listItem.dataset.tagName;
            if (tagName) {
                document.getElementById('anchors-modal').style.display = 'none';
                showTagReferencesPanel(tagName);
            }
        }
        // A√ß√£o para ENTIDADES (Usa o dataset action ou verifica entityId como fallback)
        else if (listItem.dataset.entityId || listItem.dataset.action === 'show-entity-references') {
            const { entityId, entityName, entityType } = listItem.dataset;
            if (entityId) {
                document.getElementById('anchors-modal').style.display = 'none';
                showReferencesPanel(entityId, entityName, entityType);
            }
        }
    }
});

referencesPanelCloseBtn.addEventListener('click', hideReferencesPanel);


// 1. Abrir Modal de Conta
document.getElementById('account-btn').addEventListener('click', () => {
    const modal = document.getElementById('account-modal');
    const nameDisplay = document.getElementById('profile-name-display');
    const emailDisplay = document.getElementById('profile-email-display');

    // Preenche os dados
    if (currentUserData) {
        nameDisplay.textContent = currentUserData.nome || "Sem Nome";
        emailDisplay.textContent = currentUserData.email || auth.currentUser.email;
    } else if (auth.currentUser) {
        nameDisplay.textContent = "Usu√°rio";
        emailDisplay.textContent = auth.currentUser.email;
    }

    modal.style.display = 'flex';
});

// 2. Bot√£o de Logout (Dentro do Modal de Conta)
document.getElementById('logout-btn').addEventListener('click', async () => {
    const confirmLogout = confirm("Tem certeza que deseja sair?");
    if (confirmLogout) {
        try {
            await signOut(auth);
            // onAuthStateChanged vai redirecionar
        } catch (error) {
            console.error("Erro ao sair", error);
        }
    }
});

document.execCommand('defaultParagraphSeparator', false, 'p');


// 1. Listener para abrir o modal a partir do menu
document.getElementById('context-menu').addEventListener('click', (e) => {
    if (e.target.dataset.action === 'change-icon') {
        // Esconde o menu
        document.getElementById('context-menu').style.display = 'none';
        
        // Abre o modal de √≠cones
        document.getElementById('icon-picker-modal').style.display = 'flex';
    }
});

// 2. Listener para quando escolhe um Emoji
document.getElementById('emoji-grid').addEventListener('click', async (e) => {
    const btn = e.target.closest('.emoji-btn');
    
    // CORRE√á√ÉO: Ler o ID que guard√°mos no modal
    const modal = document.getElementById('icon-picker-modal');
    const targetId = modal.dataset.targetFolderId;

    // Se n√£o houver bot√£o ou ID, sai
    if (!btn || !targetId) return;

    const selectedIcon = btn.dataset.icon;
    const isDefault = selectedIcon === 'üóÉÔ∏è';

    try {
        // Usa targetId em vez de activeItemContext.id
        const docRef = doc(db, 'pastas', targetId);
        
        if (isDefault) {
            await updateDoc(docRef, {
                customIcon: deleteField(),
                ultimaedicao: serverTimestamp()
            });
        } else {
            await updateDoc(docRef, {
                customIcon: selectedIcon,
                ultimaedicao: serverTimestamp()
            });
        }

        modal.style.display = 'none';
        // Limpa o dataset por seguran√ßa
        modal.removeAttribute('data-target-folder-id');

    } catch (error) {
        console.error("Erro ao mudar √≠cone:", error);
        alert("Erro ao atualizar √≠cone.");
    }
});


// --- L√ìGICA DO EDITOR DE MARGEM (BOT√ÉO üî¨) ---
document.querySelector('button[data-action="open-margin-editor"]').addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (!selectedNoteId) {
        alert("Selecione uma nota primeiro.");
        return;
    }

    // 1. Feedback Visual
    const btn = e.target;
    const originalText = btn.textContent;
    btn.textContent = "üíæ"; // √çcone de disquete tempor√°rio
    
    // 2. Gravar a nota atual (For√ßa grava√ß√£o imediata)
    // A fun√ß√£o saveNote(true) devolve uma Promise, por isso usamos await
    await saveNote(true);

    // 3. Redirecionar para a nova p√°gina enviando o ID da nota
    window.location.href = `editnote.html?noteId=${selectedNoteId}`;
});


// ====================================================================
// FECHAR POPUPS AO CLICAR NAS BARRAS DE FERRAMENTAS
// ====================================================================
const toolbars = [
    document.getElementById('editor-toolbar'),    // Barra Principal (onde est√£o üîì, üìë, üïí)
    document.getElementById('secondary-toolbar')  // Barra Secund√°ria (onde est√£o H1, H2, Cor)
];

toolbars.forEach(toolbar => {
    if (toolbar) {
        toolbar.addEventListener('click', () => {
            // 1. Esconde o menu de inser√ß√£o r√°pida (üìò üìó üìô üìí)
            const insertPopup = document.getElementById('insertion-popup');
            if (insertPopup) insertPopup.style.display = 'none';

            // 2. (Opcional) Esconde tamb√©m o menu de sele√ß√£o de texto (üîó üé¥) se estiver aberto
            const selectPopup = document.getElementById('selection-popup');
            if (selectPopup) selectPopup.style.display = 'none';
        });
    }
});

// --- BOT√ÉO DE PESQUISA GLOBAL (RODAP√â ESQUERDO) ---
const globalSearchBtn = document.getElementById('global-search-btn');
if (globalSearchBtn) {
    globalSearchBtn.addEventListener('click', () => {
        // Usa a mesma fun√ß√£o que a lupa da barra de ferramentas
        openExplorerModal();
    });
}


// ====================================================================
// L√ìGICA DO ENTER EM LINHAS MOV√çVEIS (SAIR PARA LINHA NORMAL)
// ====================================================================
noteContentEditor.addEventListener('keydown', (e) => {
    // 1. DETETOR B√ÅSICO
    if (e.key === 'Enter') {

        
        if (e.shiftKey) {
            console.log("   (Shift+Enter detetado -> Ignorando l√≥gica customizada)");
            return;
        }

        const selection = window.getSelection();
        if (!selection.rangeCount) {
            console.log("‚ùå Sem sele√ß√£o de cursor ativa.");
            return;
        }

        const anchorNode = selection.anchorNode;
        console.log("üìç N√≥ do cursor:", anchorNode);

        // Garante que pegamos o elemento HTML da linha
        const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
        console.log("   Elemento HTML:", element);

        const draggableLine = element.closest('.draggable-line');
        console.log("üîç √â linha arrast√°vel?", draggableLine ? "SIM" : "N√ÉO");

        if (draggableLine) {
            console.group("üöÄ A INICIAR L√ìGICA DE INSER√á√ÉO");
            e.preventDefault(); 
            e.stopPropagation();

            // 1. AN√ÅLISE DO PAI ORIGINAL
            const currentParent = draggableLine.parentElement;
            console.log("1. Pai da linha atual:", currentParent);
            console.log("   Classes:", currentParent.className);

            const contentArea = draggableLine.querySelector('.drag-content-area');
            const newParagraph = document.createElement('p');
            newParagraph.style.margin = "4px 0";
            newParagraph.setAttribute('data-debug', 'nova-linha-' + Date.now()); // Marca para identificar

            // Corte de texto
            const range = selection.getRangeAt(0);
            const rangeToEnd = document.createRange();
            rangeToEnd.selectNodeContents(contentArea);
            rangeToEnd.setStart(range.endContainer, range.endOffset);
            
            const fragment = rangeToEnd.extractContents();
            newParagraph.appendChild(fragment);

            if (newParagraph.innerHTML.trim() === '') newParagraph.innerHTML = '<br>';

            // 2. INSER√á√ÉO (M√âTODO AFTEREND)
            console.log("2. A executar: draggableLine.insertAdjacentElement('afterend', newParagraph)");
            draggableLine.insertAdjacentElement('afterend', newParagraph);

            // 3. VERIFICA√á√ÉO P√ìS-INSER√á√ÉO
            const newParent = newParagraph.parentElement;
            console.log("3. Pai da NOVA linha:", newParent);

            if (currentParent !== newParent) {
                console.error("üö® ERRO CR√çTICO: O pai mudou! A linha fugiu.");
                console.warn("   Esperado:", currentParent);
                console.warn("   Obtido:", newParent);
                
                // CORRE√á√ÉO FOR√áADA
                console.log("üõ†Ô∏è APLICANDO CORRE√á√ÉO FOR√áADA: currentParent.appendChild");
                currentParent.appendChild(newParagraph);
            } else {
                console.log("‚úÖ SUCESSO: A linha ficou no mesmo pai.");
            }

            console.groupEnd();

            // Foco
            const newRange = document.createRange();
            if (newParagraph.firstChild && newParagraph.firstChild.nodeType === 3) {
                newRange.setStart(newParagraph.firstChild, 0);
            } else {
                newRange.selectNodeContents(newParagraph);
            }
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);

            saveNote();
        } else {
            console.log("‚ÑπÔ∏è Enter normal (fora de linha mov√≠vel).");
        }
    }
});


// --- FUN√á√ÉO PARA CRIAR UMA LINHA DE CODEX (FIX) ---
window.createCodexRow = function(data = null) {
    const container = document.getElementById('codex-rows-container');
    const row = document.createElement('div');
    row.className = 'codex-row';
    
    // Se estiver editando um item existente, guardamos o ID do Firestore
    if (data && data.id) row.setAttribute('data-firestore-id', data.id);

    row.innerHTML = `
        <button class="remove-codex-row" onclick="window.removeCodexRow(this)">√ó</button>
        <div class="codex-header-grid">
            <div class="serie-wrapper">
                <label class="codex-label">S√âRIE / PUBLICA√á√ÉO</label>
                <input type="text" class="codex-input-modern serie-main" placeholder="Ex: w24 05" value="${data ? data.serie : ''}">
                <!-- Onde aparecer√° o nome completo da publica√ß√£o -->
                <div class="serie-fullname" style="font-size: 11px; color: var(--accent-color); margin-top: 4px; height: 14px; font-weight: 500; font-style: italic;"></div>
            </div>
            <div class="manual-controls">
                <label class="codex-label">OP√á√ïES</label>
                <div style="display:flex; gap:4px;">
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'A')" title="Ano Manual">A</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'M')" title="M√™s Manual">M</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'T')" title="Tempo (H:M:S)">T</button>
                    <button class="btn-control-small" onclick="window.toggleManual(this, 'C')" title="Cap√≠tulo Manual">C</button>
                </div>
            </div>
        </div>
        <div class="manual-inputs-area"></div> 
        <div class="codex-content-grid">
            <div class="unit-section">
                <label class="codex-label">P√ÅGINAS</label>
                <div class="pages-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'P√°g')">+</button>
                </div>
            </div>
            <div class="unit-section">
                <label class="codex-label">PAR√ÅGRAFOS</label>
                <div class="paragraphs-container">
                    <button class="btn-unit-add" onclick="window.addCodexUnit(this.parentElement, 'Par')">+</button>
                </div>
            </div>
        </div>
    `;

    // --- L√ìGICA DE IDENTIFICA√á√ÉO DA SIGLA ---
    const inputSerie = row.querySelector('.serie-main');
    const displayFullName = row.querySelector('.serie-fullname');

    const updateFullName = (val) => {
        if (!val) {
            displayFullName.textContent = "";
            return;
        }
        const valorBaixo = val.toLowerCase().trim();
        let sigla = "";
        const match = valorBaixo.match(/^[a-z]+(?:-[0-9])?/);
        if (match) sigla = match[0];

        const nomeCompleto = (typeof SIGLAS_PUBLICACOES !== 'undefined') ? SIGLAS_PUBLICACOES[sigla] : null;

        if (nomeCompleto) {
            displayFullName.textContent = `üìö ${nomeCompleto}`;
        } else {
            displayFullName.textContent = "";
        }
    };

    inputSerie.addEventListener('input', (e) => updateFullName(e.target.value));
    container.appendChild(row);

    // ============================================================
    // AQUI EST√Å A CORRE√á√ÉO: RESTAURAR DADOS AO ABRIR
    // ============================================================
    if (data) {
        // 1. Atualiza nome da sigla
        updateFullName(data.serie);
        
        // 2. Restaura P√°ginas e Par√°grafos
        const pContainer = row.querySelector('.pages-container');
        const pgContainer = row.querySelector('.paragraphs-container');
        if (data.paginas) data.paginas.forEach(p => window.addCodexUnit(pContainer, 'P√°g', p));
        if (data.paragrafos) data.paragrafos.forEach(p => window.addCodexUnit(pgContainer, 'Par', p));

        // 3. >>> CORRE√á√ÉO CR√çTICA <<< Restaura os Campos Manuais (A, M, T, C)
        // Usamos setTimeout pequeno para garantir que o DOM est√° pronto antes de simular o clique
        setTimeout(() => {
            if (data.manualYear) window.toggleManual(row.querySelector("button[onclick*=\"'A'\"]"), 'A', data.manualYear);
            if (data.manualMonth) window.toggleManual(row.querySelector("button[onclick*=\"'M'\"]"), 'M', data.manualMonth);
            if (data.tempo) window.toggleManual(row.querySelector("button[onclick*=\"'T'\"]"), 'T', data.tempo);
            
            // RESTAURA O CAP√çTULO (C)
            if (data.capitulo) window.toggleManual(row.querySelector("button[onclick*=\"'C'\"]"), 'C', data.capitulo);
        }, 10);

    } else {
        // Se for novo, adiciona chips vazios por conveni√™ncia
        window.addCodexUnit(row.querySelector('.pages-container'), 'P√°g');
        window.addCodexUnit(row.querySelector('.paragraphs-container'), 'Par');
    }
};

// 1. Fun√ß√£o Auxiliar: Atualizar Estado Visual do Bot√£o
function updateBoxLinkButtonState(wrapper) {
    const btn = wrapper.querySelector('button[data-action="manage-box-links"]');
    if (!btn) return;

    const linksJson = wrapper.getAttribute('data-box-links') || '{}';
    
    let hasNormalContent = false;
    let hasAssociations = false;

    try {
        const data = JSON.parse(linksJson);
        
        // 1. Verifica conte√∫do normal (Links, Codex, Categorias)
        const hasUrls = data.urls && Object.keys(data.urls).length > 0;
        const hasCodex = data.codex && data.codex.length > 0;
        const hasCategories = data.categories && data.categories.length > 0;

        if (hasUrls || hasCodex || hasCategories) {
            hasNormalContent = true;
        }

        // 2. Verifica Associa√ß√µes (Prioridade M√°xima)
        if (data.associations && data.associations.length > 0) {
            hasAssociations = true;
        }

    } catch (e) { 
        hasNormalContent = false;
        hasAssociations = false;
    }

    // --- APLICA√á√ÉO VISUAL ---

    // Remove classes e estilos antigos
    btn.classList.remove('has-links', 'has-associations');
    btn.style.borderColor = "";
    btn.style.color = "";
    btn.style.backgroundColor = "";
    btn.title = "Adicionar Hiperliga√ß√µes, Codex ou Associa√ß√µes";

    // CASO 1: TEM ASSOCIA√á√ïES (Vermelho - Prioridade)
    if (hasAssociations) {
        btn.classList.add('has-associations');
        btn.title = "üîó Esta caixa tem Associa√ß√µes ativas";
        btn.style.borderColor = "#e74c3c"; // Borda Vermelha
        btn.style.color = "#e74c3c";       // Raio Vermelho
        // Opcional: Fundo vermelho muito suave para destacar
        btn.style.backgroundColor = "rgba(231, 76, 60, 0.1)";
    } 
    // CASO 2: TEM APENAS CONTE√öDO NORMAL (Amarelo)
    else if (hasNormalContent) {
        btn.classList.add('has-links');
        btn.title = "Conte√∫do Anexado (Links/Codex)";
        btn.style.borderColor = "#f1c40f"; // Borda Amarela
        btn.style.color = "#f1c40f";       // Raio Amarelo
    }
}

// 2. Fun√ß√µes Globais para o Codex (Escopo Window)
 window.addCodexUnit = function(container, placeholder, value = '') {
    const unit = document.createElement('div');
    unit.className = 'codex-unit-chip';
    unit.innerHTML = `
        <input type="text" placeholder="${placeholder}" value="${value}">
        <button class="btn-unit-del" onclick="this.parentElement.remove()">√ó</button>
    `;
    // Insere antes do bot√£o "+"
    container.insertBefore(unit, container.lastChild);
};

// Gerencia os bot√µes A e M (Ano e M√™s manuais)
window.toggleManual = function(btn, type) {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    btn.classList.toggle('active');
    
    if (btn.classList.contains('active')) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = `codex-input-manual manual-${type === 'A' ? 'year' : 'month'}`;
        input.placeholder = type === 'A' ? "Ano" : "M√™s";
        area.appendChild(input);
    } else {
        const target = area.querySelector(`.manual-${type === 'A' ? 'year' : 'month'}`);
        if (target) target.remove();
    }
};

// Remove a linha inteira do Codex
window.removeCodexRow = function(btn) {
    if (document.querySelectorAll('.codex-row').length > 1) {
        btn.closest('.codex-row').remove();
    } else {
        alert("√â necess√°rio pelo menos uma linha.");
    }
};

window.removeManualField = function(btn, type) {
    const row = btn.closest('.codex-row');
    const fieldGroup = btn.closest('.manual-field-group');
    
    // 1. Encontra o bot√£o A ou M correspondente e desativa-o
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if (toggleBtn) toggleBtn.classList.remove('active');
    
    // 2. Remove o campo do ecr√£
    fieldGroup.remove();
};




// 3. Fun√ß√µes de Suporte para Processamento
function parseSerieInfo(serie, manualYear, manualMonth) {
    let ano = manualYear || "";
    let mes = manualMonth || "";
    const s = serie.toLowerCase();
    const yearMatch = s.match(/[wg](\d{2})/);
    if (yearMatch && !ano) {
        const yy = parseInt(yearMatch[1]);
        ano = yy > 35 ? (1900 + yy).toString() : (2000 + yy).toString();
    }
    const monthMatch = s.match(/\d{1,2}\/(\d{1,2})/);
    if (monthMatch && !mes) {
        const mIdx = parseInt(monthMatch[1]) - 1;
        if (mIdx >= 0 && mIdx < 12) mes = MESES_LISTA[mIdx];
    }
    if (!mes) MESES_LISTA.forEach(m => { if (s.includes(m.toLowerCase())) mes = m; });
    return { ano, mes };
}

function getCodexDataFromRow(row) {
    // Tenta apanhar valores, garantindo que n√£o falha se o elemento n√£o existir
    const serieInput = row.querySelector('.serie-main');
    const serieVal = serieInput ? serieInput.value.trim() : "";
    
    // Recolhe p√°ginas e par√°grafos
    const paginas = Array.from(row.querySelectorAll('.pages-container input'))
                         .map(i => i.value.trim()).filter(v => v !== "");
    const paragrafos = Array.from(row.querySelectorAll('.paragraphs-container input'))
                          .map(i => i.value.trim()).filter(v => v !== "");

    // Recolhe campos manuais (se existirem na linha)
    const yearInput = row.querySelector('.manual-year');
    const monthInput = row.querySelector('.manual-month');
    const chapInput = row.querySelector('.manual-chapter');
    
    // Novos campos de tempo (H:M:S) se existirem
    const hInput = row.querySelector('.h-input');
    const mInput = row.querySelector('.m-input');
    const sInput = row.querySelector('.s-input');
    
    let tempoStr = "";
    if (hInput || mInput || sInput) {
        const h = hInput ? hInput.value : "00";
        const m = mInput ? mInput.value : "00";
        const s = sInput ? sInput.value : "00";
        if (h!=="00" || m!=="00" || s!=="00") tempoStr = `${h}:${m}:${s}`;
    }

    return {
        serie: serieVal,
        paginas: paginas,
        paragrafos: paragrafos,
        manualYear: yearInput ? yearInput.value : null,
        manualMonth: monthInput ? monthInput.value : null,
        capitulo: chapInput ? chapInput.value : null,
        tempo: tempoStr
    };
}


// --- FUN√á√ÉO DE VERIFICA√á√ÉO 4¬™ COLUNA (SAT√âLITE) ---
async function checkIfBoxIsLinked(boxId, modalElement) {
    if (!auth.currentUser) return;
    
    const content = modalElement.querySelector('.modal-content');
    if (!content) return;
    content.style.position = 'relative';

    // 1. GARANTIR QUE O CSS DA ANIMA√á√ÉO EXISTE
    if (!document.getElementById('sat-style')) {
        const style = document.createElement('style');
        style.id = 'sat-style';
        style.innerHTML = `
            @keyframes satelliteFloat {
                0% { transform: translateY(0) rotate(0deg); text-shadow: 0 0 5px rgba(74, 144, 226, 0.5); }
                50% { transform: translateY(-3px) rotate(10deg); text-shadow: 0 0 15px rgba(74, 144, 226, 1); }
                100% { transform: translateY(0) rotate(0deg); text-shadow: 0 0 5px rgba(74, 144, 226, 0.5); }
            }
            /* Classe da Onda Azul */
            .electromagnetic-wave {
                box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.7);
                animation: wavePulse 2s infinite;
                border: 2px solid #4a90e2 !important; /* Borda azul pulsante */
            }
            @keyframes wavePulse {
                0% { box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.4); }
                70% { box-shadow: 0 0 0 20px rgba(74, 144, 226, 0); }
                100% { box-shadow: 0 0 0 0 rgba(74, 144, 226, 0); }
            }
            @keyframes spin { to { transform: rotate(360deg); } }
        `;
        document.head.appendChild(style);
    }

    // 2. RESET VISUAL (LIMPEZA TOTAL)
    const oldIcons = content.querySelectorAll('#satellite-indicator, #clone-indicator, .sat-loader');
    oldIcons.forEach(el => el.remove());
    
    content.classList.remove('electromagnetic-wave'); // Remove a classe da onda
    content.style.boxShadow = '';
    content.style.borderColor = '';

    const liveBox = document.getElementById(boxId);
    let originId = liveBox ? liveBox.getAttribute('data-origin-id') : null;
    if (originId === boxId) originId = null; 

    // SPINNER
    const loaderId = 'sat-loader-' + Date.now();
    const loader = document.createElement('div');
    loader.id = loaderId;
    loader.className = 'sat-loader';
    loader.style.cssText = `
        position: absolute; top: 20px; right: 60px;
        width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.1);
        border-top: 2px solid var(--accent-color); border-radius: 50%; 
        animation: spin 0.8s linear infinite; z-index: 100;
    `;
    content.appendChild(loader);

    const myUid = auth.currentUser.uid;

    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let directLinks = [];
        const collectionsToCheck = ['textosbiblicos', 'topicos', 'personagens', 'locais', 'cosmos', 'subcosmos'];
        
        const promises = collectionsToCheck.map(async (colName) => {
            const q = query(collection(db, colName), where('userId', '==', myUid));
            const snap = await getDocs(q);
            snap.forEach(doc => {
                const data = doc.data();
                if (data.puzzleBoard && Array.isArray(data.puzzleBoard)) {
                    const hasRef = data.puzzleBoard.some(item => item.snippet && decodeURIComponent(item.snippet).includes(`id="${boxId}"`));
                    if (hasRef) {
                        directLinks.push({ id: doc.id, name: data.nome, type: colName, icon: getIconForCollection(colName) });
                    }
                }
            });
        });

        let originalLocationItem = null;
        if (originId) {
            originalLocationItem = await findOriginalNoteLocation(originId);
        }

        await Promise.all(promises);

        if (document.getElementById(loaderId)) document.getElementById(loaderId).remove();

        // 3. APLICA√á√ÉO FINAL
        const isSatellite = directLinks.length > 0;
        const isClone = !!originId;

        // A. SAT√âLITE üõ∞Ô∏è
        if (isSatellite) {
            // APLICA√á√ÉO FOR√áADA DA CLASSE
            content.classList.add('electromagnetic-wave'); 
            
            const satBtn = createStatusIcon('üõ∞Ô∏è', 60, "Liga√ß√µes diretas.");
            satBtn.id = "satellite-indicator";
            satBtn.onclick = (e) => { 
                e.stopPropagation(); 
                showSatelliteLinksPopup(directLinks, satBtn, "LIGA√á√ïES DIRETAS"); 
            };
            content.appendChild(satBtn);
        }

        // B. CLONE ‚öóÔ∏è
        if (isClone) {
            const rightPos = isSatellite ? 100 : 60;
            
            if (!isSatellite) {
                content.style.boxShadow = "0 0 0 2px #9b59b6"; 
            }

            if (originalLocationItem) {
                const cloneBtn = createStatusIcon('‚öóÔ∏è', rightPos, "Ver nota original.");
                cloneBtn.id = "clone-indicator";
                cloneBtn.style.textShadow = "0 0 10px #9b59b6";
                cloneBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    showSatelliteLinksPopup([originalLocationItem], cloneBtn, "LOCALIZA√á√ÉO DO ORIGINAL"); 
                };
                content.appendChild(cloneBtn);
            } else {
                const cloneBtn = createStatusIcon('‚öóÔ∏è', rightPos, "Original n√£o encontrado.");
                cloneBtn.id = "clone-indicator";
                cloneBtn.style.opacity = "0.3";
                cloneBtn.style.cursor = "default";
                content.appendChild(cloneBtn);
            }
        }

    } catch (e) {
        console.error("Erro checks:", e);
        if(document.getElementById(loaderId)) document.getElementById(loaderId).remove();
    }
}

// Fun√ß√£o Auxiliar para Criar os √çcones
function createStatusIcon(emoji, rightPos, title) {
    const btn = document.createElement('div');
    btn.textContent = emoji;
    btn.title = title;
    btn.style.cssText = `
        position: absolute; top: 15px; right: ${rightPos}px;
        font-size: 24px; cursor: pointer; z-index: 100;
        animation: satelliteFloat 3s infinite ease-in-out;
        transition: transform 0.2s;
    `;
    btn.onmouseover = () => btn.style.transform = "scale(1.2)";
    btn.onmouseout = () => btn.style.transform = "scale(1)";
    return btn;
}


// Helper para √çcones
function getIconForCollection(col) {
    if (col === 'personagens') return 'üë§';
    if (col === 'locais') return 'üìç';
    if (col === 'textosbiblicos') return 'üìñ';
    if (col === 'topicos') return 'üìë';
    if (col === 'cosmos') return 'ü™ê';
    if (col === 'subcosmos') return 'üß¨';
    return 'üîπ';
}

// 3. MOSTRAR LISTA DE LIGA√á√ïES (POPUP SECUND√ÅRIO)
function showSatelliteLinksPopup(links, targetElement, titleText = "A TRANSMITIR PARA:") {
    const oldPop = document.getElementById('sat-links-popup');
    if (oldPop) oldPop.remove();

    const popup = document.createElement('div');
    popup.id = 'sat-links-popup';
    popup.style.cssText = `
        position: absolute; background: var(--sidebar-color); border: 1px solid var(--accent-color);
        padding: 10px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.9);
        z-index: 2147483650; width: 260px; animation: fadeIn 0.2s;
    `;

    const rect = targetElement.getBoundingClientRect();
    popup.style.top = (rect.bottom + 10) + 'px';
    popup.style.right = (window.innerWidth - rect.right) + 'px';

    let html = `<div style="font-size:0.75em; color:#ccc; margin-bottom:8px; border-bottom:1px solid #444; padding-bottom:5px; font-weight:bold; letter-spacing:0.5px;">${titleText}</div>`;
    
    // Remove duplicados
    const uniqueLinks = links.filter((v,i,a) => a.findIndex(t => (t.id === v.id)) === i);

    uniqueLinks.forEach(link => {
        
        // --- DECIS√ÉO DE A√á√ÉO ---
        let onclickAction = "";
        
        if (link.type === 'source') {
            // √â o ORIGINAL: Navega para a nota e faz scroll para a caixa (boxId)
            // Fecha o modal de links primeiro para limpar o ecr√£
            onclickAction = `document.getElementById('link-modal').style.display='none'; this.parentElement.remove(); window.handleGoToNote('${link.id}', '${link.boxId}');`;
        } else {
            // √â UMA ENTIDADE: Abre a 4¬™ Coluna
            onclickAction = `window.goToEntityFromSat('${link.id}', '${link.name}', '${link.type}')`;
        }

        html += `
            <div style="padding:8px; border-radius:4px; margin-bottom:4px; cursor:pointer; background:rgba(255,255,255,0.05); display:flex; align-items:center; gap:8px;"
                 onmouseover="this.style.background='var(--hover-color)'"
                 onmouseout="this.style.background='rgba(255,255,255,0.05)'"
                 onclick="${onclickAction}">
                <span>${link.icon}</span>
                <span style="font-weight:bold; color:var(--text-color); font-size:0.9em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;">${link.name}</span>
            </div>
        `;
    });

    html += `<button style="width:100%; margin-top:5px; background:none; border:none; color:#e74c3c; cursor:pointer; font-size:0.8em;" onclick="this.parentElement.remove()">Fechar</button>`;

    popup.innerHTML = html;
    document.body.appendChild(popup);
    
    // Fechar ao clicar fora
    setTimeout(() => {
        document.addEventListener('click', function closeSat(e) {
            if (!popup.contains(e.target) && e.target !== targetElement) {
                popup.remove();
                document.removeEventListener('click', closeSat);
            }
        });
    }, 100);
}

// 4. NAVEGAR PARA A ENTIDADE (ABRIR 4¬™ COLUNA)
window.goToEntityFromSat = function(id, name, typeCollection) {
    // Mapeamento de cole√ß√£o para tipo singular (ex: personagens -> personagem)
    const typeMap = {
        'personagens': 'personagem',
        'locais': 'local',
        'textosbiblicos': 'textobiblico',
        'topicos': 'topico',
        'cosmos': 'cosmos',
        'subcosmos': 'subcosmos'
    };
    
    const singularType = typeMap[typeCollection] || 'topico';

    // Fecha os modais
    document.getElementById('sat-links-popup').remove();
    document.getElementById('link-modal').style.display = 'none';

    // Abre o painel
    showReferencesPanel(id, name, singularType);
};

// 5. Listener para o bot√£o ‚ö° no editor (CORRIGIDO PARA REDATOR)
noteContentEditor.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="manage-box-links"]');
    if (!btn) return;
    
    e.preventDefault(); 
    e.stopPropagation();
    
    // Procura por Subnota OU Redator
    const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
    
    if (wrapper) {
        openBoxLinkManager(wrapper);
    } else {
        console.error("‚ùå Erro: Wrapper n√£o encontrado para o bot√£o de links.");
    }
});



// --- CRIA√á√ÉO DOS BOT√ïES FLUTUANTES (MOBILE) ---
// Injetamos o HTML via JS para n√£o poluir a estrutura original
(function createMobileFABs() {
    const existingContainer = document.getElementById('mobile-fab-container');
    if (existingContainer) existingContainer.remove();

    const fabContainer = document.createElement('div');
    fabContainer.id = 'mobile-fab-container';
    
    fabContainer.innerHTML = `
        <!-- BOT√ÉO FLASH (Laranja e Menor) -->
        <button id="mobile-fab-flash" class="fab-btn" title="Cria√ß√£o R√°pida Flash" 
                style="background-color: #e67e22; color: white; border-color: #e67e22; font-size: 18px; width: 38px; height: 38px; margin-bottom: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">‚ö°</button>
        
        <!-- BOT√ÉO ADICIONAR (Azul e Maior) -->
        <button id="mobile-fab-add" class="fab-btn" title="Adicionar Item"
                style="background-color: var(--accent-color); color: white; border-color: var(--accent-color); font-size: 28px; width: 56px; height: 56px;">+</button>
        
        <!-- OUTROS BOT√ïES -->
        <button id="mobile-fab-account" class="fab-btn" title="Minha Conta">üë§</button>
        <button id="mobile-fab-search" class="fab-btn" title="Pesquisa Global">üîé</button>
        <button id="mobile-fab-settings" class="fab-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
    `;
    
    document.body.appendChild(fabContainer);

    // --- LOGICA DO BOT√ÉO FLASH (CRUCIAL) ---
    document.getElementById('mobile-fab-flash').addEventListener('click', () => {
        // 1. Muda explicitamente para a aba Flash
        // Isto garante que currentViewMode = 'flash' e que a lista da esquerda carrega os itens flash
        window.switchFolderView('flash');

        // 2. Pequeno delay para a vari√°vel global atualizar antes de abrir o modal
        setTimeout(() => {
            const originalAddBtn = document.getElementById('add-item-btn');
            if(originalAddBtn) {
                // Simula o clique no bot√£o "+" normal.
                // Como j√° estamos em modo 'flash', ele abrir√° o menu restrito (Nota/Jornal)
                // e a cria√ß√£o ter√° o campo oque='flash' automaticamente.
                originalAddBtn.click();
            }
        }, 50);
    });

    // --- Outros Listeners ---
    document.getElementById('mobile-fab-add').addEventListener('click', () => {
        // Se estiver em modo Flash e clicar no bot√£o azul grande, 
        // talvez queira voltar ao modo Local?
        // Se sim, descomente a linha abaixo. Caso contr√°rio, mant√©m o modo atual.
        // if (currentViewMode === 'flash') window.switchFolderView('local');

        const btn = document.getElementById('add-item-btn');
        if(btn) btn.click();
    });

    document.getElementById('mobile-fab-account').addEventListener('click', () => {
        const btn = document.getElementById('account-btn');
        if(btn) btn.click();
    });

    document.getElementById('mobile-fab-search').addEventListener('click', () => {
        const btn = document.getElementById('global-search-btn');
        if(btn) btn.click();
    });

    document.getElementById('mobile-fab-settings').addEventListener('click', () => {
        const btn = document.getElementById('settings-btn');
        if(btn) btn.click();
    });

})();

// ====================================================================
// MOTOR DE ARRASTO UNIFICADO (LINHAS ·Øì + CART√ïES üé¥)
// ====================================================================
let dragSrcEl = null;   // Para Linhas
let draggedCard = null; // Para Cart√µes

// 1. INICIAR ARRASTO (DRAGSTART)
noteContentEditor.addEventListener('dragstart', (e) => {
    
    // --- 1. VERIFICA√á√ÉO DE CUBO (üßä) ---
    // S√≥ permite arrastar se clicou no puxador OU na borda
    const cubeHandle = e.target.closest('.cube-drag-handle');
    const cube = e.target.closest('.journal-cube-wrapper');

    if (cube && cubeHandle) {
        draggedCard = cube; // Reutilizamos a vari√°vel de cart√µes
        dragSrcEl = null;   // Garante que n√£o mistura com linhas

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', cube.id); // Necess√°rio para Firefox
        e.dataTransfer.setDragImage(cube, 0, 0);

        setTimeout(() => cube.classList.add('sortable-dragging'), 0);
        return; 
    }

    // --- 2. VERIFICA√á√ÉO DE CART√ÉO URL (üé¥) ---
    const card = e.target.closest('.url-card-widget');
    if (card && !e.target.classList.contains('url-card-close')) {
        draggedCard = card;
        dragSrcEl = null;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', card.id);
        e.dataTransfer.setDragImage(card, 0, 0);

        setTimeout(() => card.classList.add('sortable-dragging'), 0);
        return;
    }

    // --- 3. VERIFICA√á√ÉO DE LINHAS DE TEXTO (·Øì) ---
    const line = e.target.closest('.draggable-line');
    if (line) {
        dragSrcEl = line;
        draggedCard = null;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', line.outerHTML);
        
        line.classList.add('dragging');
        setTimeout(() => line.style.opacity = '0.4', 0);
    }
});

// 1. DRAG OVER (Calcular o lado: Esquerda vs Direita)
noteContentEditor.addEventListener('dragover', (e) => {
    e.preventDefault(); // Permite o drop

    // Se n√£o estivermos a arrastar um Cubo ou Cart√£o, sai
    if (!draggedCard) return;

    // Identifica o alvo (Imagem, Outro Cubo, Cart√£o)
    const target = e.target.closest('.journal-img-wrapper, .journal-cube-wrapper, .url-card-widget');
    
    // Se encontrou um alvo v√°lido e n√£o √© o pr√≥prio item que estamos a arrastar
    if (target && target !== draggedCard) {
        const rect = target.getBoundingClientRect();
        const midPoint = rect.left + (rect.width / 2);
        
        // Limpa classes antigas
        target.classList.remove('drop-target-left', 'drop-target-right');

        // Decide o lado baseado na posi√ß√£o do rato
        if (e.clientX < midPoint) {
            target.classList.add('drop-target-left');
        } else {
            target.classList.add('drop-target-right');
        }
    }
});

// 2. DRAG LEAVE (Limpeza visual ao sair de cima de um item)
noteContentEditor.addEventListener('dragleave', (e) => {
    const target = e.target.closest('.journal-img-wrapper, .journal-cube-wrapper, .url-card-widget');
    if (target) {
        target.classList.remove('drop-target-left', 'drop-target-right');
    }
});

// 3. DROP (Aplicar a L√≥gica de Flutua√ß√£o)
noteContentEditor.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();

    // Se estivermos a arrastar um Cubo ou Cart√£o
    if (draggedCard) {
        // Encontra o alvo
        const target = e.target.closest('.journal-img-wrapper, .journal-cube-wrapper, .url-card-widget, p');
        
        if (target && target !== draggedCard) {
            const rect = target.getBoundingClientRect();
            const midX = rect.left + (rect.width / 2);
            
            // Verifica se √© um widget (Imagem/Cubo) para aplicar l√≥gica lateral
            const isWidget = target.classList.contains('journal-img-wrapper') || 
                             target.classList.contains('journal-cube-wrapper') ||
                             target.classList.contains('url-card-widget');

            // --- L√ìGICA DE ENCAIXE LATERAL ---
            if (isWidget) {
                // Se largar na ESQUERDA
                if (e.clientX < midX) {
                    target.parentNode.insertBefore(draggedCard, target);
                    
                    // Se for um Cubo, for√ßa flutua√ß√£o √† esquerda para alinhar
                    if (draggedCard.classList.contains('journal-cube-wrapper')) {
                        draggedCard.classList.remove('float-right', 'float-none');
                        draggedCard.classList.add('float-left');
                    }
                } 
                // Se largar na DIREITA
                else {
                    target.parentNode.insertBefore(draggedCard, target.nextSibling);
                    
                    // Se for um Cubo, for√ßa flutua√ß√£o √† direita
                    if (draggedCard.classList.contains('journal-cube-wrapper')) {
                        draggedCard.classList.remove('float-left', 'float-none');
                        draggedCard.classList.add('float-right');
                    }
                }
            } 
            // --- L√ìGICA DE PAR√ÅGRAFOS (Cima/Baixo normal) ---
            else {
                const midY = rect.top + (rect.height / 2);
                if (e.clientY < midY) target.parentNode.insertBefore(draggedCard, target);
                else target.parentNode.insertBefore(draggedCard, target.nextSibling);
                
                // Se largar num par√°grafo vazio, remove flutua√ß√£o para ocupar largura total
                if (draggedCard.classList.contains('journal-cube-wrapper')) {
                    draggedCard.classList.remove('float-left', 'float-right');
                }
            }
            
            saveNote();
        }
        
        // Limpeza final
        if (target) target.classList.remove('drop-target-left', 'drop-target-right');
        draggedCard.classList.remove('sortable-dragging');
        draggedCard = null;
        return; // Sai para n√£o executar a l√≥gica de linhas
    }
    
    // --- L√ìGICA DE LINHAS (·Øì) ---
    if (dragSrcEl) {
        const target = e.target.closest('.draggable-line, .mini-note-wrapper, details.toggle-section, p');
        
        if (target && target !== dragSrcEl) {
            const rect = target.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
            
            target.classList.remove('drop-target-top', 'drop-target-bottom');

            if (next) target.parentNode.insertBefore(dragSrcEl, target.nextSibling);
            else target.parentNode.insertBefore(dragSrcEl, target);
            
            saveNote();
        }
        
        if (dragSrcEl) {
            dragSrcEl.style.opacity = '1';
            dragSrcEl.classList.remove('dragging');
        }
    }
});

// --- NOVA FUN√á√ÉO: MUDAR ENTRE LOCAL E PARTILHA ---
async function switchFolderView(mode) {
    // --- CORRE√á√ÉO AQUI: Limpeza de sa√≠da ---
    // Se est√°vamos num arquivo antes de mudar de aba, marca como lido
    if (currentArchiveId) {
        markArchiveAsRead(currentArchiveId); // N√£o usamos await para n√£o bloquear a transi√ß√£o UI
    }
    // ---------------------------------------

    document.body.classList.remove('show-fab');

    if (mode === currentViewMode && navigationStack.length === 0) return;

    // 3. GRAVA√á√ÉO AUTOM√ÅTICA DE SEGURAN√áA (Antes de mudar a vista)
    const idToSave = activeEditingPostId || window.activeEditingPostId;
    
    if (currentSaveStatus === 'unsaved' || idToSave) {
        console.log("üíæ [SISTEMA] Gravando altera√ß√µes pendentes antes de mudar de modo...");
        try {
            if (idToSave) {
                // Se for um post de Arquivo, grava e remove o cadeado
                const tempId = idToSave;
                activeEditingPostId = null;
                window.activeEditingPostId = null;
                await window.saveArchivePost(tempId);
            } else if (selectedNoteId) {
                // Se for uma nota normal, for√ßa a grava√ß√£o imediata
                await saveNote(true);
            }
        } catch (e) {
            console.error("Erro ao gravar durante mudan√ßa de modo:", e);
        }
    }

    // 4. LIMPEZA TOTAL DE ESTADO E OUVINTES
    col1SelectedId = null;
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }
    if (unsubscribeShared2) { unsubscribeShared2(); unsubscribeShared2 = null; }
    if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
    if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }
    
    // Reseta o editor e limpa sele√ß√£o visual da Coluna 2
    resetEditor();             

    // >>> CR√çTICO: FOR√áA O RESET DO CACHE VISUAL DA COLUNA 1 <<<
    // Isto garante que o updateNavigationView vai mostrar a roda de carregamento
    // porque o contexto mudou completamente (ex: de Local para Partilha).
    lastRenderedLeftParentId = 'FORCE_RESET';

    // 5. ATUALIZA O MODO E ESTADO DE NAVEGA√á√ÉO
    currentViewMode = mode;    
    navigationStack = [];      

    // 6. RECONSTR√ìI A INTERFACE (Cabe√ßalhos e Abas da Esquerda)
    updateNavigationView(true);

    // Refer√™ncia ao bot√£o "+"
    const addItemBtn = document.getElementById('add-item-btn');

    // 7. CARREGAMENTO ESPEC√çFICO DE DADOS
    
    // --- MODO PINS ---
    if (mode === 'pins') {
        console.log("üìå [SISTEMA] Modo Pins Ativado.");
        loadPinsView(); 
        
        // No modo Pins, geralmente escondemos o bot√£o de adicionar na lista
        if (addItemBtn) addItemBtn.style.display = 'none';
    } 
    
    // --- MODO FLASH (LARANJA) ---
    else if (mode === 'flash') {
        console.log("‚ö° [SISTEMA] Modo Flash Ativado.");
        
        // 1. Configura bot√£o "+"
        if (addItemBtn) {
            addItemBtn.style.display = 'flex';
            addItemBtn.className = ''; 
            addItemBtn.classList.add('flash-mode');
        }

        // 2. Limpa ouvintes antigos
        if (unsubscribeLeftPanel) { unsubscribeLeftPanel(); unsubscribeLeftPanel = null; }
        if (unsubscribeMiddlePanel) { unsubscribeMiddlePanel(); unsubscribeMiddlePanel = null; }

        // 3. COLUNA 1 (ESQUERDA): Lista de Itens Flash
        loadFlashListLeftPanel(); 

        // 4. COLUNA 2 (MEIO): Limpa para n√£o confundir
        const midList = document.getElementById('file-list');
        midList.innerHTML = '<li style="padding:40px; text-align:center; color:#e67e22; opacity:0.5;">‚ö°<br>Selecione um item Flash<br>ou crie um novo.</li>';
        
        // No mobile, garante que a esquerda est√° vis√≠vel
        if (window.innerWidth <= 768) {
            document.body.classList.remove('mobile-view-editor');
            document.body.classList.remove('mobile-view-middle'); 
        }
    }

    // --- MODO PARTILHA (VERMELHO) ---
    else if (mode === 'shared') {
        console.log("ü§ù [SISTEMA] Modo Partilha Ativado.");
        loadSharedFilesRoot(); // Carrega arquivos na Coluna 2

        if (addItemBtn) {
            addItemBtn.style.display = 'flex';
            addItemBtn.classList.remove('flash-mode', 'yellow-mode');
            addItemBtn.classList.add('shared-mode');
        }

        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-view-middle');
            document.body.classList.remove('mobile-view-editor');
        }
    }
    
    // --- MODO LOCAL (AZUL/PADR√ÉO) ---
    else if (mode === 'local') {
        console.log("üè† [SISTEMA] Modo Local Ativado.");
        
        if (addItemBtn) {
            addItemBtn.style.display = 'flex';
            // Remove estilos especiais para voltar ao azul padr√£o
            addItemBtn.classList.remove('shared-mode', 'yellow-mode', 'flash-mode');
        }
        // A lista local √© carregada automaticamente pelo updateNavigationView()
    }

    // 8. ATUALIZA BOT√ïES FLUTUANTES (Se aplic√°vel)
    updateMobileFABVisibility();
}

// Exp√µe a fun√ß√£o globalmente para os bot√µes HTML
window.switchFolderView = switchFolderView;




9999
// ============================================================
// L√ìGICA DO MODO ARQUIVO (FEED DE POSTS)
// ============================================================




// 2. Renderizar o Feed
window.renderArchiveFeed = async function() {
    const feed = document.getElementById('archive-feed');
    const postBtn = document.getElementById('create-post-btn');
    const drawerBtn = document.getElementById('create-drawer-trigger-btn');
    const separatorBtn = document.getElementById('create-separator-btn');

    if (!feed) return;

    // --- RESET: Esconde todos os bot√µes de a√ß√£o ---
    if (postBtn) postBtn.style.display = 'none';
    if (drawerBtn) drawerBtn.style.display = 'none';
    if (separatorBtn) separatorBtn.style.display = 'none';

    // --- CASO 1: DENTRO DE UMA GAVETA ---
    if (window.activeGavetaId) {
        // Mostra o bot√£o verde de Separador. Post e Gavet√£o somem.
        if (separatorBtn) separatorBtn.style.display = 'block';
        
        renderOpenedGavetaView(feed, currentArchiveData.posts || []);
        return; 
    }

    // --- CASO 2: ABA PRATELEIRA (TODOS OS POSTS) ---
    if (currentArchiveTab === 'prateleira') {
        if (postBtn) postBtn.style.display = 'block';

        feed.innerHTML = '';
        const posts = currentArchiveData?.posts || [];
        
        if (posts.length === 0) {
            feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Nenhum post criado.</div>';
            return;
        }
        posts.forEach(post => feed.appendChild(createPostElement(post)));
    } 
    
    // --- CASO 3: ABA FAVORITOS (NOVO) ---
    else if (currentArchiveTab === 'favoritos') {
        feed.innerHTML = '';
        const myUid = auth.currentUser.uid;
        const allPosts = currentArchiveData?.posts || [];
        
        // Filtra: S√≥ posts onde o meu ID est√° no array 'likes'
        const likedPosts = allPosts.filter(p => p.likes && p.likes.includes(myUid));

        if (likedPosts.length === 0) {
            feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Ainda n√£o deu like em nenhum post.<br><span style="font-size:20px;">ü§ç</span></div>';
            return;
        }
        
        // Renderiza os posts filtrados
        likedPosts.forEach(post => feed.appendChild(createPostElement(post)));
    }

    // --- CASO 4: ABA GAVET√ÉO ---
    else if (currentArchiveTab === 'gavet√µes') {
        if (drawerBtn) drawerBtn.style.display = 'block';

        feed.innerHTML = '<div style="text-align:center; padding:20px;">A carregar gavet√µes...</div>';
        try {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId), orderBy('ordem', 'asc'));
            const drawerSnap = await getDocs(q);
            feed.innerHTML = '';
            if (drawerSnap.empty) {
                feed.innerHTML = '<div style="text-align:center; color:#888; padding:40px;">Nenhum gavet√£o criado.</div>';
            } else {
                for (const docSnap of drawerSnap.docs) {
                    const drawer = { id: docSnap.id, ...docSnap.data() };
                    feed.appendChild(await createGavetaoUI(drawer));
                }
            }
        } catch (e) { console.error(e); }
    }
};


window.toggleGavetaViewMode = async () => {
    if (!window.activeGavetaId || !window.activeGavetaData) return;

    // Alterna entre 'full' e 'titles' (se n√£o existir, o padr√£o √© 'titles')
    const currentMode = window.activeGavetaData.viewMode || 'titles';
    const newMode = currentMode === 'titles' ? 'full' : 'titles';
    
    try {
        // 1. Atualiza no Firebase para ficar guardado permanentemente
        await updateDoc(doc(db, 'gavetas', window.activeGavetaId), {
            viewMode: newMode
        });
        
        // 2. Atualiza os dados na mem√≥ria e redesenha a vista
        window.activeGavetaData.viewMode = newMode;
        renderArchiveFeed();
    } catch (e) {
        console.error("Erro ao mudar modo de vista:", e);
    }
};

// Fun√ß√£o para criar o elemento visual do Gavet√£o
async function createGavetaoUI(drawer) {
    const div = document.createElement('div');
    div.style.position = 'relative';
    div.style.marginBottom = '15px';

    // Geramos um ID limpo para o container
    const containerId = `gavetas-of-${drawer.id}`;

    div.innerHTML = `
        <button class="corner-close-btn" onclick="window.deleteGavetao('${drawer.id}')">x</button>
        <details class="drawer-toggle" open>
            <summary>
                <span>üìÇ ${drawer.nome}</span>
                <div class="drawer-controls" onclick="event.stopPropagation();">
                    <button class="mini-btn" onclick="window.moveGavetao('${drawer.id}', -1)">‚Üë</button>
                    <button class="mini-btn" onclick="window.moveGavetao('${drawer.id}', 1)">‚Üì</button>
                    <button class="mini-btn" onclick="window.openEditDrawerModal('${drawer.id}', '${drawer.nome}', '${drawer.descricao}')">‚úèÔ∏è</button>
                    <button class="mini-btn" onclick="event.preventDefault(); event.stopPropagation(); window.openCreateGavetaModal('${drawer.id}')"> + </button>
                </div>
            </summary>
            <div class="gavetas-container" id="${containerId}" style="padding: 10px 0; min-height:30px;">
                <div style="text-align:center; padding:20px; color:#888; font-size:0.9em;">
                   <div class="spinner" style="width:15px; height:15px; border-width:2px; display:inline-block; margin-right:10px;"></div>
                   A carregar pastas...
                </div>
            </div>
        </details>
    `;
    
    // O TRUQUE: Esperar um folego para o DOM processar o ID novo
    setTimeout(() => {
        window.loadGavetasInternas(drawer.id);
    }, 50);
    
    return div;
}

// Fun√ß√£o para carregar as pastas (gavetas) dentro do gavet√£o
window.loadGavetasInternas = async function(gavetaoId) {
    const container = document.getElementById(`gavetas-of-${gavetaoId}`);
    if (!container) {
        console.warn("‚ö†Ô∏è Container ainda n√£o encontrado para o Gavet√£o:", gavetaoId);
        return;
    }

    try {
        const q = query(
            collection(db, 'gavetas'), 
            where('gavetaoId', '==', gavetaoId), 
            orderBy('ordem', 'asc')
        );
        
        const snap = await getDocs(q);
        
        // S√≥ limpa o "A carregar" se a resposta do Firebase chegar
        container.innerHTML = ''; 

        if (snap.empty) {
            container.innerHTML = '<div style="text-align:center; color:#555; font-size:0.8em; padding:10px; font-style:italic;">Gavet√£o vazio.</div>';
            return;
        }

        snap.forEach(docSnap => {
            const gaveta = { id: docSnap.id, ...docSnap.data() };
            const gDiv = document.createElement('div');
            gDiv.className = 'gaveta-folder';
            
            gDiv.innerHTML = `
                <div class="gaveta-title-area" style="flex-grow:1; cursor:pointer;" onclick="window.openGaveta('${gaveta.id}')">
                    <span>üìÅ</span>
                    <span style="margin-left:8px;">${gaveta.nome}</span>
                </div>
                <div class="drawer-controls">
                    <button class="mini-btn" onclick="window.moveGaveta('${gaveta.id}', '${gavetaoId}', -1); event.stopPropagation();">‚Üë</button>
                    <button class="mini-btn" onclick="window.moveGaveta('${gaveta.id}', '${gavetaoId}', 1); event.stopPropagation();">‚Üì</button>
                    <button class="corner-close-btn" style="position:static; opacity:1; margin-left:10px;" onclick="window.deleteGaveta('${gaveta.id}'); event.stopPropagation();">x</button>
                </div>
            `;
            container.appendChild(gDiv);
        });
    } catch (e) {
        console.error("‚ùå Erro ao carregar gavetas:", e);
        container.innerHTML = '<div style="text-align:center; color:#e74c3c; font-size:0.8em;">Erro ao carregar dados.</div>';
    }
};

// 3. Criar Elemento HTML do Post
function createPostElement(post) {
    const div = document.createElement('div');
    div.className = 'archive-post';
    div.id = `post-${post.id}`;
    div.dataset.id = post.id;

    // Verifica se este post deve renderizar em modo edi√ß√£o ou visualiza√ß√£o
    // (Por defeito renderiza view, a menos que tenhamos acabado de criar)
    if (activeEditingPostId === post.id) {
        renderPostEditMode(div, post);
    } else {
        renderPostViewMode(div, post);
    }

    return div;
}



// 5. Renderizar Modo Edi√ß√£o
function renderPostEditMode(container, post) {
    console.group(`‚úèÔ∏è [EDI√á√ÉO] Iniciando modo edi√ß√£o para Post: ${post.id}`);

    // --- [NOVO] 1. RECUPERA√á√ÉO DE RASCUNHO (Safety Net) ---
    // Verifica se existe um rascunho local mais recente que nunca chegou ao servidor
    const localDraft = localStorage.getItem(`draft_${post.id}`);
    let initialTitle = post.title || '';
    let initialContent = post.content;
    let recoveredMsg = '';

    if (localDraft) {
        try {
            const draft = JSON.parse(localDraft);
            // S√≥ recupera se o rascunho for diferente do que veio da BD
            if (draft.content !== initialContent || draft.title !== initialTitle) {
                console.log("‚ôªÔ∏è Rascunho local recuperado!");
                initialTitle = draft.title;
                initialContent = draft.content;
                recoveredMsg = `<div style="background:#e67e22; color:white; padding:5px; font-size:12px; text-align:center; border-radius:4px; margin-bottom:5px;">‚ö†Ô∏è Rascunho n√£o guardado recuperado do telem√≥vel.</div>`;
            }
        } catch (e) { console.error("Erro ao ler draft", e); }
    }
    // -------------------------------------------------------
    
    const textToolbarHTML = `
        <div class="post-toolbar" style="margin-bottom:5px;">
            <button onclick="execCmdOnPost('bold')"><b>B</b></button>
            <button onclick="execCmdOnPost('italic')"><i>I</i></button>
            <button onclick="execCmdOnPost('underline')"><u>U</u></button>
        </div>
    `;

    const genericTitleInput = `<input type="text" class="post-title-input" value="${initialTitle}" placeholder="T√≠tulo do Post..." style="margin-bottom:10px;">`;

    const isEntity = post.type === 'entity' && post.subType !== 'idea';
    const isContainerEditable = isEntity ? "false" : "true";
    const editorStyle = isEntity ? "border:none; background:transparent; padding:0;" : "";

    container.innerHTML = `
    <div class="post-edit-container">
        ${recoveredMsg} <!-- Mensagem de aviso se recuperou algo -->
        ${genericTitleInput}
        ${!isEntity ? textToolbarHTML : ''} 
        <div class="post-editor-content" contenteditable="${isContainerEditable}" id="editor-${post.id}" style="${editorStyle}">
            ${initialContent}
        </div>
        <div class="post-edit-actions">
           <button class="modal-btn" style="background-color: var(--sidebar-color); color: var(--text-color);" onclick="window.openGavetaSelection('${post.id}'); event.stopPropagation();">üìÅ Gaveta</button>
            <button class="modal-btn" style="background-color:#c0392b; color:white;" onclick="deleteArchivePost('${post.id}')">Eliminar</button>
            <button class="modal-btn secondary" onclick="cancelArchiveEdit('${post.id}')">Cancelar</button>
            <button class="modal-btn primary" onclick="saveArchivePost('${post.id}')">Salvar</button>
        </div>
    </div>`;
    
    setTimeout(() => {
        const editorDiv = container.querySelector('.post-editor-content');
        const titleInput = container.querySelector('.post-title-input');

        window.livePostDraft = {
            id: post.id,
            title: titleInput.value,
            content: editorDiv.innerHTML
        };

        // --- [NOVO] 2. GRAVA√á√ÉO LOCAL INSTANT√ÇNEA ---
        const updateLiveDraft = () => {
            // Sincroniza inputs internos (para Entidades)
            if (isEntity) {
                 editorDiv.querySelectorAll('.mini-note-title-input').forEach(t => {
                    if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                    else t.setAttribute('value', t.value);
                });
            }

            const currentData = {
                id: post.id,
                title: titleInput.value,
                content: editorDiv.innerHTML,
                timestamp: Date.now()
            };

            window.livePostDraft = currentData;

            // GRAVA√á√ÉO S√çNCRONA NO DISPOSITIVO (O SEGREDO ANTI-PERDA)
            // Isto acontece a cada letra digitada. Se a bateria acabar 1ms depois, o dado est√° salvo.
            localStorage.setItem(`draft_${post.id}`, JSON.stringify(currentData));

            const statusEl = document.getElementById('archive-save-status');
            if(statusEl) {
                statusEl.textContent = "a escrever...";
                statusEl.style.opacity = "0.7";
            }
            currentSaveStatus = 'unsaved'; 
        };

        if (editorDiv) editorDiv.addEventListener('input', updateLiveDraft);
        if (titleInput) titleInput.addEventListener('input', updateLiveDraft);

        // Foco e Configura√ß√£o
        if (isEntity) {
       const toolbar = editorDiv.querySelector('.mini-note-toolbar');
            if (toolbar) toolbar.setAttribute('contenteditable', 'false');
            const innerContent = editorDiv.querySelector('.mini-note-content, .toggle-content');
            if (innerContent) {
                innerContent.setAttribute('contenteditable', 'true');
                
                // Foca no conte√∫do interno da entidade
                innerContent.focus();
                const range = document.createRange();
                range.selectNodeContents(innerContent);
                range.collapse(false); // Fim
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        } else {
            // Se recuperou mensagem, n√£o foca para o user ver o aviso
            if (!recoveredMsg) {
                // Se o t√≠tulo estiver vazio, foca no t√≠tulo
                if (!post.title && titleInput) {
                    titleInput.focus();
                } 
                // Se tiver t√≠tulo, foca no editor NO FINAL DO TEXTO
                else if (editorDiv) {
                    editorDiv.focus(); // Foca na div

                    // --- CORRE√á√ÉO DO CURSOR ---
                    const range = document.createRange();
                    
                    // Seleciona todo o conte√∫do da div
                    range.selectNodeContents(editorDiv);
                    
                    // Colapsa o range para o fim (false = end, true = start)
                    range.collapse(false); 
                    
                    // Aplica a sele√ß√£o
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    
                    // Scroll para garantir que o fim do texto est√° vis√≠vel
                    editorDiv.scrollTop = editorDiv.scrollHeight;
                }
            }
        }
        console.groupEnd();
    }, 50); // Fim do setTimeout
}

// --- A√á√ïES DO ARQUIVO ---

// A. Bot√£o "Criar Post" Principal
document.getElementById('create-post-btn').addEventListener('click', async () => {
    if (activeEditingPostId) {
        await saveArchivePost(activeEditingPostId);
    }
    document.getElementById('post-type-popup').style.display = 'flex';
});

// B. Escolha: Gerar Texto
document.getElementById('gen-text-btn').addEventListener('click', () => {
    document.getElementById('post-type-popup').style.display = 'none';
    createNewPost('text');
});

// C. Escolha: Gerar Entidade (Abre submenu)
document.getElementById('gen-entity-btn').addEventListener('click', () => {
    document.getElementById('post-type-popup').style.display = 'none';
    document.getElementById('entity-type-popup').style.display = 'flex';
});

// D. Criar a Entidade Espec√≠fica
window.createArchiveEntity = (subType) => {
    document.getElementById('entity-type-popup').style.display = 'none';
    createNewPost('entity', subType);
};

// L√≥gica de Cria√ß√£o de Post Novo
async function createNewPost(type, subType = null) {
    // Garante que temos um arquivo aberto e utilizador logado
    if (!currentArchiveId || !auth.currentUser) return;
    
    // Inicializa o array local se n√£o existir (para a UI otimista funcionar)
    if (!currentArchiveData) return;
    if (!currentArchiveData.posts) currentArchiveData.posts = [];

    const newId = 'post_' + Date.now();
    const authorName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
    const myUid = auth.currentUser.uid;
    
    let initialContent = '';
    let initialTitle = '';

    // --- Defini√ß√£o de HTML Inicial (Estruturas ricas) ---
    const commonToolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up">üî∫</button>
                <button type="button" data-action="move-down">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links">‚ö°</button>
            <button type="button" data-action="append-mini-note">üß¨</button>
            <button type="button" data-action="highlight-color">üé®</button>
            <button type="button" data-action="manage-mini-note-topics">üìã</button>
            <button type="button" data-action="delete-mini-note">üóëÔ∏è</button>
        </div>`;

    if (type === 'text') {
        initialTitle = ''; 
        initialContent = '<p><br></p>';
    } 
    else if (type === 'entity') {
        if (subType === 'question') {
            initialContent = `<div class="mini-note-wrapper question-mode" data-topics="{}" data-shared="false" data-box-links="{}" contenteditable="false"><textarea class="mini-note-title-input" placeholder="Pergunta?" rows="1"></textarea>${commonToolbarHTML}<div class="mini-note-content" contenteditable="true"><p><br></p></div></div><p><br></p>`;
            initialTitle = 'Nova Quest√£o';
        } else if (subType === 'toggle') {
            initialContent = `<details class="toggle-section" open><summary><h2>T√≠tulo Expans√≠vel</h2><button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button></summary><div class="toggle-content" contenteditable="true"><p><br></p></div></details><p><br></p>`;
            initialTitle = 'Novo T√≠tulo Toggle';
        } else if (subType === 'depot') {
            const uId = `depot_${Date.now()}`;
            initialContent = `<div class="ref-depot-wrapper" id="${uId}" contenteditable="false"><div class="depot-header"><div style="display:flex; align-items:center; flex-grow:1;"><span style="font-size:1.4em; margin-right:8px;">üèóÔ∏è</span><input type="text" class="depot-title" value="GRUA DE REFER√äNCIAS" placeholder="T√çTULO DA GRUA..." oninput="this.setAttribute('value', this.value)"></div><button class="depot-btn" onclick="window.toggleAllDepotNodes(this)">‚ÜïÔ∏è</button><button class="depot-btn" onclick="window.addDepotCategory('${uId}')">+ üìÇ Categoria</button><button class="depot-btn btn-del-node" onclick="window.debugDeleteDepot(this)">üóëÔ∏è</button></div><div class="depot-content-area"></div></div><p><br></p>`;
            initialTitle = 'Nova Grua';
        } else {
            const isFree = subType === 'free';
            const cls = isFree ? 'mini-note-wrapper free-mode' : 'mini-note-wrapper';
            const tHTML = isFree ? '' : `<textarea class="mini-note-title-input" placeholder="T√≠tulo..." rows="1"></textarea>`;
            initialContent = `<div class="${cls}" data-topics="{}" data-shared="false" data-box-links="{}" contenteditable="false">${tHTML}${commonToolbarHTML}<div class="mini-note-content" contenteditable="true"><p><br></p></div></div><p><br></p>`;
            initialTitle = isFree ? 'Novo Contentor' : 'Nova Subnota';
        }
    }

    // --- C√ÅLCULO DA ORDEM (PARA FICAR NO TOPO) ---
    // A l√≥gica √©: Novo Post = (Ordem do Topo Atual) - 1000
    // Como a lista √© ordenada ASC (menor para maior), n√∫meros negativos ficam em cima.
    let newOrder = 0;
    
    if (currentArchiveData.posts.length > 0) {
        // Pega o primeiro item (que est√° no topo visualmente)
        const topItem = currentArchiveData.posts[0];
        
        // Se tiver ordem v√°lida, subtrai 1000
        if (topItem.ordem !== undefined && typeof topItem.ordem === 'number') {
            newOrder = topItem.ordem - 1000;
        } else {
            // Se for sistema antigo, usa timestamp negativo como fallback
            newOrder = -Date.now();
        }
    } else {
        // Se a lista estiver vazia
        newOrder = 0;
    }

    const newPostData = {
        id: newId,
        type: type,
        subType: subType, 
        title: initialTitle,
        content: initialContent,
        userId: myUid,
        createdBy: authorName,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        ordem: newOrder // <--- Campo Cr√≠tico
    };

    // 1. UI Otimista: Adiciona localmente e mostra logo
    // unshift coloca no in√≠cio do array (Topo)
    currentArchiveData.posts.unshift(newPostData);
    
    // Define como ativo para edi√ß√£o imediata
    activeEditingPostId = newId;
    renderArchiveFeed();
    
    // Scroll para o topo
    const feedContainer = document.getElementById('archive-feed');
    if (feedContainer) feedContainer.scrollTop = 0;

    // 2. Grava√ß√£o no Firebase (Sub-cole√ß√£o)
    try {
        const { doc, setDoc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // A. Grava o post individual na sub-cole√ß√£o 'posts'
        // Isto evita o erro de limite de 1MB no documento pai
        const postRef = doc(db, 'pastas', currentArchiveId, 'posts', newId);
        await setDoc(postRef, newPostData);
        
        // B. Atualiza apenas a data no pai (para a lista lateral subir)
        const parentRef = doc(db, 'pastas', currentArchiveId);
        updateDoc(parentRef, { 
            ultimaedicao: serverTimestamp(),
            lastEditorId: myUid
        }).catch(err => console.warn("Aviso ao atualizar pai:", err));

    } catch (e) {
        console.error("Erro ao criar post:", e);
        alert("Erro de conex√£o. O post pode n√£o ter sido salvo no servidor.");
    }
}

// E. Editar Post
window.editArchivePost = async (postId) => {
    // 1. AUTO-SAVE: Se j√° estava a editar outro, guarda-o e fecha-o
    if (activeEditingPostId && activeEditingPostId !== postId) {
        console.log("üîÑ A trocar de post. Gravando o anterior...");
        // Usa a fun√ß√£o normal de save que l√™ do DOM
        await window.saveArchivePost(activeEditingPostId);
    }

    // (O resto da tua fun√ß√£o de bloqueio/lock mant√©m-se igual aqui...)
    const postDiv = document.getElementById(`post-${postId}`);
    const originalOpacity = postDiv ? postDiv.style.opacity : "1";
    if (postDiv) postDiv.style.opacity = "0.5";

    const acquiredLock = await lockPost(postId);
    
    if (!acquiredLock) {
        if (postDiv) postDiv.style.opacity = originalOpacity;
        applyVisualLocks();
        alert("‚ö†Ô∏è Conflito: Este post est√° a ser editado por outra pessoa.");
        return;
    }

    activeEditingPostId = postId;
    window.activeEditingPostId = postId;

    if (postDiv) {
        postDiv.style.opacity = "1";
        const postData = currentArchiveData.posts.find(p => p.id === postId);
        if (postData) {
            renderPostEditMode(postDiv, postData);
            if (typeof startLockHeartbeat === 'function') startLockHeartbeat(postId);
        }
    }
};



// F. Salvar Post (Fecha edi√ß√£o)
window.saveArchivePost = async (postId, contentOverride = null, titleOverride = null) => {
    console.group(`üíæ [GRAVADOR] A processar ID: ${postId}`);

    const hasOverride = (contentOverride !== null);
    const postDiv = document.getElementById(`post-${postId}`);
    let titleToSave = "";
    let contentToSave = "";

    // 1. LER DADOS DO ECR√É OU DO OVERRIDE
    if (!hasOverride && postDiv) {
        console.log("üñ±Ô∏è [MODO MANUAL] Lendo dados do DOM...");
        const titleInputGeneric = postDiv.querySelector('.post-title-input');
        const contentEditor = postDiv.querySelector('.post-editor-content');

        if (contentEditor && titleInputGeneric) {
            // Sincroniza inputs internos
            contentEditor.querySelectorAll('.mini-note-title-input').forEach(t => {
                if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                else t.setAttribute('value', t.value);
            });
            titleToSave = titleInputGeneric.value.trim() || "Sem T√≠tulo";
            contentToSave = contentEditor.innerHTML;
        }
    } 
    else if (hasOverride) {
        console.log("ü§ñ [MODO AUTO] Dados injetados pelo Porteiro.");
        titleToSave = titleOverride;
        contentToSave = contentOverride;
    }

    if (!titleToSave && !contentToSave) {
        console.warn("‚ö†Ô∏è Dados n√£o encontrados para gravar.");
        console.groupEnd();
        return;
    }

    // Atualiza mem√≥ria local
    const postIndex = currentArchiveData.posts.findIndex(p => p.id === postId);
    if (postIndex > -1) {
        currentArchiveData.posts[postIndex].title = titleToSave;
        currentArchiveData.posts[postIndex].content = contentToSave;
        currentArchiveData.posts[postIndex].updatedAt = Date.now();
        currentArchiveData.posts[postIndex].lastEditorId = auth.currentUser.uid;
    }

    // Limpa estado global de edi√ß√£o
    if (activeEditingPostId === postId) {
        activeEditingPostId = null;
        window.activeEditingPostId = null;
        window.livePostDraft = null; 
    }

    // 2. GRAVA√á√ÉO NO FIREBASE (SUB-COLE√á√ÉO)
    console.log("‚òÅÔ∏è Enviando para o Firebase...");
    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Refer√™ncia direta ao documento do Post
        const postRef = doc(db, 'pastas', currentArchiveId, 'posts', postId);
        
        await updateDoc(postRef, {
            title: titleToSave,
            content: contentToSave,
            updatedAt: Date.now(),
            lastEditorId: auth.currentUser.uid
        });

        // Atualiza a pasta pai para todos saberem que houve mudan√ßa
        const parentRef = doc(db, 'pastas', currentArchiveId);
        updateDoc(parentRef, { 
            ultimaedicao: serverTimestamp(),
            lastEditorId: auth.currentUser.uid 
        });

        // Limpeza de seguran√ßa (Locks e Drafts)
        await unlockPost(postId);
        localStorage.removeItem(`draft_${postId}`);

        console.log("‚úÖ Post atualizado com sucesso.");
        
        // Restauro Visual
        if (postDiv) {
            const postData = currentArchiveData.posts.find(p => p.id === postId);
            if (postData) renderPostViewMode(postDiv, postData);
        }

    } catch (e) {
        console.error("‚ùå Erro cr√≠tico ao gravar:", e);
        alert("Erro de conex√£o! O seu texto ficou guardado no telem√≥vel.");
        // Mantemos o draft no localStorage por seguran√ßa
    }
    console.groupEnd();
};



// G. Apagar Post
window.deleteArchivePost = async (postId) => {
    
    // 1. CHAMAR O POPUP PERSONALIZADO
    const confirmed = await showConfirmation(
        "Eliminar Post?", 
        "Tem a certeza que deseja apagar este post? (Ficar√° no Hist√≥rico)"
    );

    if (!confirmed) return;

    // 2. EFEITO VISUAL DE SA√çDA (Imediato)
    // Removemos do ecr√£ antes de falar com o servidor para parecer instant√¢neo
    const div = document.getElementById(`post-${postId}`);
    if(div) {
        div.style.transition = "all 0.3s ease";
        div.style.opacity = "0";
        div.style.transform = "scale(0.95)";
        setTimeout(() => div.remove(), 300);
    }
    
    // Remove da mem√≥ria local tamb√©m (para o renderArchiveFeed n√£o o redesenhar se for chamado)
    if (currentArchiveData && currentArchiveData.posts) {
        currentArchiveData.posts = currentArchiveData.posts.filter(p => p.id !== postId);
    }

    // 3. MOVIMENTO NO FIREBASE (Copiar para Lixo -> Apagar do Ativo)
    try {
        const { doc, getDoc, setDoc, deleteDoc, serverTimestamp, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Refer√™ncias
        const originalRef = doc(db, 'pastas', currentArchiveId, 'posts', postId);
        const trashRef = doc(db, 'pastas', currentArchiveId, 'deleted_posts', postId);
        const parentRef = doc(db, 'pastas', currentArchiveId);

        // Ler dados atuais
        const snapshot = await getDoc(originalRef);
        
        if (snapshot.exists()) {
            const data = snapshot.data();
            
            // A. Copiar para a sub-cole√ß√£o de lixo
            await setDoc(trashRef, {
                ...data,
                deletedAt: serverTimestamp(),
                deletedBy: auth.currentUser.uid,
                originalCollection: 'posts' // √ötil para restauro futuro
            });
            
            // B. Apagar da sub-cole√ß√£o ativa
            await deleteDoc(originalRef);
            
            // C. Atualizar timestamp do pai para for√ßar refresh nos outros clientes
            await updateDoc(parentRef, {
                ultimaedicao: serverTimestamp(),
                lastEditorId: auth.currentUser.uid
            });
            
            console.log(`üóëÔ∏è Post ${postId} movido para a reciclagem.`);
        }
    } catch (e) {
        console.error("Erro ao apagar post:", e);
        alert("Erro ao eliminar. Tente novamente.");
        // Se falhar, restaura o visual (recarrega o arquivo)
        if (typeof displayArchive === 'function') {
            displayArchive(currentArchiveId, currentArchiveData);
        }
    }
};

// H. Cancelar Edi√ß√£o (Reverter)
window.cancelArchiveEdit = async (postId) => {
    const postDiv = document.getElementById(`post-${postId}`);
    if (!postDiv) return;

    // 1. Para o temporizador de grava√ß√£o autom√°tica
    clearTimeout(archiveAutoSaveTimer);

    // 2. Reseta o estado global de edi√ß√£o
    activeEditingPostId = null;
    currentSaveStatus = 'saved'; 
    
    // 3. Atualiza o status visual no topo
    const statusEl = document.getElementById('archive-save-status');
    if(statusEl) {
        statusEl.textContent = "Edi√ß√£o cancelada";
        setTimeout(() => { 
            if(statusEl.textContent === "Edi√ß√£o cancelada") statusEl.textContent = "Guardado"; 
        }, 2000);
    }

    // 4. Restaura o visual do post
    const originalPost = currentArchiveData.posts.find(p => p.id === postId);
    
    if (originalPost) {
        // Se o post j√° existia, volta a mostrar a vers√£o que est√° na mem√≥ria
        renderPostViewMode(postDiv, originalPost);
    } else {
        // Se era um post NOVO (que nunca foi salvo), removemos o elemento do ecr√£
        postDiv.remove();
        currentArchiveData.posts = currentArchiveData.posts.filter(p => p.id !== postId);
    }

    // 5. O PASSO MAIS IMPORTANTE: Remover o bloqueio no Firebase
    await unlockPost(postId);
    
    console.log(`üîì [SISTEMA] Post ${postId} foi desbloqueado (Cancelado).`);
};

// I. Fun√ß√£o Auxiliar de Comandos (Executa no editor ativo)
window.execCmdOnPost = (command) => {
    if(command === 'boldBlue') {
        document.execCommand('bold', false, null);
        document.execCommand('foreColor', false, '#4a90e2');
    } else {
        document.execCommand(command, false, null);
    }
};

// J. Grava√ß√£o Geral no Firestore
async function saveFullArchive() {
    const statusEl = document.getElementById('archive-save-status');
    if (statusEl) statusEl.textContent = "A guardar...";
    
    try {
        const { doc, updateDoc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'pastas', currentArchiveId);
        
        const updateData = {
            // CORRE√á√ÉO CR√çTICA: Removemos 'posts' e 'deletedPosts' daqui.
            // Eles agora vivem apenas nas sub-cole√ß√µes, poupando espa√ßo e evitando erros.
            
            // Se existiam campos antigos, usamos deleteField() para limpar o lixo na pr√≥xima grava√ß√£o
            posts: deleteField(), 
            deletedPosts: deleteField(),
            
            ultimaedicao: serverTimestamp(),
            lastEditorId: auth.currentUser.uid 
        };

        await updateDoc(docRef, updateData);
        
        // A mem√≥ria local (currentArchiveData) continua a ser usada para a UI,
        // mas n√£o √© enviada de volta para o documento pai.
        if (currentArchiveData) {
            currentArchiveData.lastEditorId = auth.currentUser.uid;
        }

        if (statusEl) {
            statusEl.textContent = "Guardado";
            statusEl.classList.add('status-saved');
            setTimeout(() => statusEl.classList.remove('status-saved'), 2000);
        }
    } catch (e) {
        console.error("Erro ao gravar metadados do arquivo:", e);
        if (statusEl) {
            statusEl.textContent = "Erro ao guardar";
            statusEl.classList.add('status-error');
        }
    }
};

// K. Mover Post (Cima/Baixo)
window.moveArchivePost = async (postId, direction) => {
    // direction: -1 (Cima/Recente), 1 (Baixo/Antigo)
    
    // Encontrar o post atual e o vizinho na mem√≥ria local (que est√° sincronizada)
    const index = currentArchiveData.posts.findIndex(p => p.id === postId);
    if (index === -1) return;

    // Verifica limites
    if (direction === -1 && index === 0) return; // J√° est√° no topo
    if (direction === 1 && index === currentArchiveData.posts.length - 1) return; // J√° est√° no fundo

    const targetIndex = index + direction;
    const postA = currentArchiveData.posts[index];     // O que estamos a mover
    const postB = currentArchiveData.posts[targetIndex]; // O vizinho

    // 1. ATUALIZA√á√ÉO VISUAL IMEDIATA (Optimistic UI)
    // Troca no array local
    currentArchiveData.posts[index] = postB;
    currentArchiveData.posts[targetIndex] = postA;
    renderArchiveFeed(); // Redesenha
    
    // Scroll para acompanhar
    const movedElement = document.getElementById(`post-${postId}`);
    if (movedElement) {
        movedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        movedElement.style.borderColor = 'var(--accent-color)';
        setTimeout(() => movedElement.style.borderColor = 'var(--border-color)', 500);
    }

    // 2. GRAVA√á√ÉO AT√ìMICA NO FIREBASE (Batch Write)
    try {
        const { writeBatch, doc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const batch = writeBatch(db);
        
        const refA = doc(db, 'pastas', currentArchiveId, 'posts', postA.id);
        const refB = doc(db, 'pastas', currentArchiveId, 'posts', postB.id);
        
        // Troca os valores da ordem
        // Nota: Se os posts n√£o tiverem ordem (antigos), usamos o timestamp ou √≠ndice como fallback
        const ordemA = postA.ordem !== undefined ? postA.ordem : index;
        const ordemB = postB.ordem !== undefined ? postB.ordem : targetIndex;

        batch.update(refA, { ordem: ordemB, updatedAt: serverTimestamp() });
        batch.update(refB, { ordem: ordemA }); // N√£o mudamos o updatedAt do vizinho para n√£o disparar notifica√ß√£o de "editado"
        
        // Atualiza o pai para notificar a mudan√ßa
        const parentRef = doc(db, 'pastas', currentArchiveId);
        batch.update(parentRef, { ultimaedicao: serverTimestamp() });

        await batch.commit();
        console.log("‚úÖ Ordem trocada com sucesso no servidor.");
        
    } catch (e) {
        console.error("Erro ao mover post:", e);
        alert("Erro de sincroniza√ß√£o ao mover. A p√°gina ser√° recarregada.");
        // Reverte localmente recarregando a lista real
        loadSharedFilesRoot(); 
    }
};


// Adiciona esta fun√ß√£o ao teu c√≥digo
async function migrateLegacyArchive(archiveId, archiveData) {
    // Se n√£o tiver posts em array, j√° est√° migrado ou √© novo.
    if (!archiveData.posts || !Array.isArray(archiveData.posts) || archiveData.posts.length === 0) {
        return;
    }

    console.group("üèóÔ∏è [MIGRA√á√ÉO] Convertendo Arquivo para Sub-cole√ß√µes...");
    const { writeBatch, doc, collection } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // Processar em lotes de 500 (limite do Firestore)
    const batch = writeBatch(db);
    const postsArray = archiveData.posts; // Do mais recente para o mais antigo

    // Inverter para garantir ordem cronol√≥gica nos √≠ndices se necess√°rio, 
    // mas aqui mantemos a ordem visual: index 0 √© o topo (mais recente).
    
    postsArray.forEach((post, index) => {
        // Cria uma refer√™ncia na sub-cole√ß√£o 'posts'
        // Usamos o ID do post se existir, sen√£o geramos um
        const postId = post.id || `post_${Date.now()}_${index}`;
        const postRef = doc(db, 'pastas', archiveId, 'posts', postId);
        
        // Adiciona campo de ordem (importante para manter a posi√ß√£o)
        // Usamos timestamp inverso ou um √≠ndice simples. 
        // Para manter a ordem atual: ordem = index
        const postData = {
            ...post,
            id: postId,
            ordem: index // 0 √© o primeiro (topo)
        };

        batch.set(postRef, postData);
    });

    // Remove o array antigo do documento pai para libertar espa√ßo
    const parentRef = doc(db, 'pastas', archiveId);
    batch.update(parentRef, { 
        posts: deleteField() // Requer import { deleteField }
    });

    try {
        await batch.commit();
        console.log("‚úÖ Migra√ß√£o conclu√≠da com sucesso.");
        // Recarrega a p√°gina para limpar a mem√≥ria
        window.location.reload();
    } catch (e) {
        console.error("‚ùå Erro na migra√ß√£o:", e);
        alert("Erro ao migrar estrutura do arquivo. Consulte a consola.");
    }
    console.groupEnd();
}




// ============================================================
// LISTENER DA TOOLBAR DO ARQUIVO (üîì üìë üïí)
// ============================================================
document.getElementById('archive-toolbar').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.dataset.action;
    
    if (action === 'archive-share') {
        e.stopPropagation(); // ‚úã PARA TUDO! N√£o deixa o clique sair daqui
        window.openShareModalForArchive();
    }
    else if (action === 'archive-topics') {
        e.stopPropagation(); 
        openTopicsModal(selectedNoteId, 'arquivo');
    }
    else if (action === 'archive-history') {
        e.stopPropagation(); 
        openArchiveRecycleBin();
    }
});



// --- ADICIONE ESTE LISTENER NO FINAL DO SCRIPT (Para o novo Toggle de Colabora√ß√£o) ---

const collabShareToggle = document.getElementById('collab-share-toggle');
if (collabShareToggle) {
    collabShareToggle.addEventListener('change', async () => {
        if (!selectedNoteId || !auth.currentUser) return;

        const isCollabActive = collabShareToggle.checked;
        const noteRef = doc(db, 'pastas', selectedNoteId);
        
        try {
            const updateData = {
                "partilhado": isCollabActive ? "ativo" : "inativo",
                "ultimaedicao": serverTimestamp()
            };

            await updateDoc(noteRef, updateData);

            // Atualiza a interface
            const collabLinkContainer = document.getElementById('collab-share-link-container');
            collabLinkContainer.style.display = isCollabActive ? 'block' : 'none';
            
            if (isCollabActive) {
                const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                document.getElementById('collab-share-url').value = `${baseUrl}/note.html?openArchive=${selectedNoteId}&mode=collab`;
            }
        } catch (e) {
            console.error("‚ùå Erro ao atualizar colabora√ß√£o:", e);
        }
    });
}

// ============================================================
// DELEGA√á√ÉO DE EVENTOS PARA O ARQUIVO (Para bot√µes funcionarem)
// ============================================================
const archiveFeed = document.getElementById('archive-feed');

if (archiveFeed) {
    archiveFeed.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        const toggleColorBtn = e.target.closest('.toggle-color-btn');

        // --- 1. Bot√£o de Cor (üé®) ---
        if (btn && btn.dataset.action === 'highlight-color') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section');
            if (wrapper) openHighlightPopup(wrapper);
            return;
        }

        // --- 2. Bot√£o de T√≥picos (üìã) ---
        if (btn && btn.dataset.action === 'manage-mini-note-topics') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper');
            if (wrapper) openTopicsModalForMiniNote(wrapper);
            return;
        }

        // --- 3. Bot√£o de Links (‚ö°) ---
        if (btn && btn.dataset.action === 'manage-box-links') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
            if (wrapper) openBoxLinkManager(wrapper);
            return;
        }

        // --- 4. Bot√£o de Cor do Toggle (üñåÔ∏è) ---
        if (toggleColorBtn) {
            e.preventDefault(); e.stopPropagation();
            activeToggleForColor = toggleColorBtn.closest('details.toggle-section');
            const rect = toggleColorBtn.getBoundingClientRect();
            const popup = document.getElementById('toggle-color-popup');
            popup.style.display = 'block';
            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popup.style.left = `${(rect.left + window.scrollX) - 100}px`;
            return;
        }

        // --- 5. Bot√£o Enviar para Nota (üß¨) ---
        if (btn && btn.dataset.action === 'append-mini-note') {
            e.preventDefault(); e.stopPropagation();
            const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
            if (wrapper) {
                htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
                openAppendModal();
            }
            return;
        }
        
        // --- 6. ELIMINAR ENTIDADE (üóëÔ∏è) -> IGUAL A ELIMINAR POST ---
        if (btn && btn.dataset.action === 'delete-mini-note') {
            e.preventDefault(); 
            e.stopImmediatePropagation(); 
            
            // 1. LIMPEZA DE CONFLITOS (CR√çTICO)
            // Cancela imediatamente qualquer temporizador de grava√ß√£o pendente.
            // Isto impede que uma grava√ß√£o autom√°tica atropele a elimina√ß√£o.
            if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);
            if (typeof archiveAutoSaveTimer !== 'undefined') clearTimeout(archiveAutoSaveTimer);
            
            const selection = window.getSelection();
            if (selection) selection.removeAllRanges();

            const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
            if (!wrapper) return;

            if (noteContentEditor.contentEditable === "false" || wrapper.classList.contains('locked-card')) {
                alert("N√£o tem permiss√£o para apagar este item.");
                return;
            }

            let label = "Item";
            if (wrapper.classList.contains('redator-wrapper')) label = "Redator";
            else if (wrapper.classList.contains('question-mode')) label = "Quest√£o";
            else label = "SubNota";

            // 2. FEEDBACK VISUAL IMEDIATO (Sem chamar o save real)
            // Dizemos ao utilizador "A guardar..." para ele saber que o processo come√ßou,
            // mas a grava√ß√£o real s√≥ acontece DENTRO do archiveMiniNote, atomicamente.
            if (typeof updateSaveStatus === 'function') updateSaveStatus('saving');
            const statusEl = document.getElementById('save-status-indicator');
            if (statusEl) {
                statusEl.textContent = "A processar...";
                statusEl.classList.remove('status-saved', 'status-error');
            }

            // 3. POPUP DE CONFIRMA√á√ÉO
            const confirmModal = document.getElementById('confirm-modal');
            if(confirmModal) confirmModal.style.zIndex = "9999999";

            const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar este ${label}?`);
            
            if(confirmModal) confirmModal.style.zIndex = ""; 

            if (!confirmed) {
                // Se cancelou, volta a agendar a grava√ß√£o normal para n√£o perder dados pendentes
                if (typeof saveNote === 'function') saveNote();
                return;
            }

            // 4. EXECU√á√ÉO SEGURA
            // Esta fun√ß√£o j√° trata de gravar a nota ATUALIZADA e o backup ao mesmo tempo.
            await archiveMiniNote(wrapper);
            return;
        }
    });
}

// ============================================================
// GEST√ÉO DA RECICLAGEM DO ARQUIVO
// ============================================================

window.openArchiveRecycleBin = function() {
    console.log("üïí [SISTEMA] A abrir Painel Hist√≥rico do Arquivo...");
    
    const modal = document.getElementById('history-modal');
    const titleEl = document.getElementById('history-modal-title');
    const recycleList = document.getElementById('history-list-recycling');
    
    // Elementos das abas (se existirem)
    const backupDiv = document.getElementById('hist-content-backup');
    const recycleDiv = document.getElementById('hist-content-recycling');
    const timelineDiv = document.getElementById('hist-content-timeline');

    if (!modal) return;

    // 1. VISUALIZA√á√ÉO
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999"; 
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    if (titleEl) titleEl.textContent = "Arquivo: Reciclagem";

    // 2. CONFIGURAR ABAS (For√ßa a aba Reciclagem)
    if (recycleDiv) {
        if(backupDiv) backupDiv.style.display = 'none';
        if(timelineDiv) timelineDiv.style.display = 'none';
        recycleDiv.style.display = 'block';
        
        const tabRecycle = document.querySelector('button[data-hist-tab="recycling"]');
        if(tabRecycle) tabRecycle.click();
    }

    // 3. CARREGAR DADOS DA SUB-COLE√á√ÉO
    recycleList.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar itens apagados...</span></div>';
    
    (async () => {
        try {
            const { collection, getDocs, query, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const trashRef = collection(db, 'pastas', currentArchiveId, 'deleted_posts');
            const q = query(trashRef, orderBy('deletedAt', 'desc')); 
            
            const snapshot = await getDocs(q);
            
            recycleList.innerHTML = '';
            
            if (snapshot.empty) {
                recycleList.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">A reciclagem est√° vazia.</li>';
                return;
            }

            snapshot.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                const dateStr = item.deletedAt ? new Date(item.deletedAt.seconds * 1000).toLocaleString() : '---';
                
                recycleList.innerHTML += `
                    <li class="list-item" style="flex-direction:column; align-items:flex-start; border-bottom:1px solid #333; padding:10px;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <strong>üóëÔ∏è ${item.title || 'Post Sem T√≠tulo'}</strong>
                            <button class="modal-btn primary" onclick="window.restoreArchiveItem('${item.id}')" style="padding:2px 8px; font-size:0.8em;">Restaurar</button>
                        </div>
                        <div style="width:100%; margin-top:5px;">
                            <small style="color:#888;">Apagado em: ${dateStr}</small>
                        </div>
                    </li>`;
            });

        } catch(e) {
            console.error("Erro ao ler reciclagem:", e);
            recycleList.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar dados.</li>';
        }
    })();
};


// Listener para Grava√ß√£o Manual no Status do Arquivo
const archiveStatus = document.getElementById('archive-save-status');
if (archiveStatus) {
    archiveStatus.addEventListener('click', () => {
        if (activeEditingPostId) {
            saveCurrentPostInBackground();
        }
    });
}


// Listener para Gravar T√≠tulo do Arquivo (Renomear)
const archiveTitleInput = document.getElementById('archive-title-input');
if (archiveTitleInput) {
    let titleTimer = null;
    
    archiveTitleInput.addEventListener('input', () => {
        // Mostra estado visual
        const statusEl = document.getElementById('archive-save-status');
        if(statusEl) statusEl.textContent = "por guardar...";
        currentSaveStatus = 'unsaved';

        // Debounce para n√£o gravar a cada tecla
        clearTimeout(titleTimer);
        titleTimer = setTimeout(async () => {
            const newName = archiveTitleInput.value.trim();
            if (newName && currentArchiveId) {
                try {
                    const docRef = doc(db, 'pastas', currentArchiveId);
                    await updateDoc(docRef, { 
                        nome: newName,
                        ultimaedicao: serverTimestamp()
                    });
                    
                    // Atualiza visualmente na lista lateral se poss√≠vel
                    const listItem = document.querySelector(`.list-item[data-id="${currentArchiveId}"] span`);
                    if (listItem) {
                        // Mant√©m o √≠cone e atualiza o texto
                        const icon = listItem.textContent.split(' ')[0]; 
                        listItem.textContent = `${icon} ${newName}`;
                    }

                    if(statusEl) {
                        statusEl.textContent = "Guardado";
                        statusEl.classList.add('status-saved');
                        setTimeout(() => statusEl.classList.remove('status-saved'), 2000);
                    }
                    currentSaveStatus = 'saved';
                } catch (e) {
                    console.error("Erro ao renomear arquivo:", e);
                }
            }
        }, 1000); // Grava 1 segundo depois de parar de escrever
    });
}

// ============================================================
// MOTOR DE COLABORA√á√ÉO REAL-TIME
// ============================================================

// 1. Ouvir mudan√ßas no documento (Locks e Conte√∫do) - VERS√ÉO CORRIGIDA E BLINDADA
function initRealtimeCollab(docId) {
    console.log("üéß [LISTENER] Iniciando escuta de colabora√ß√£o (Locks) no arquivo:", docId);
    
    // Importa doc se necess√°rio
    // const { doc, onSnapshot } = ... (j√° tens no topo)
    const docRef = doc(db, 'pastas', docId);

    // Limpa ouvinte anterior se existir
    if (collabUnsubscribe) collabUnsubscribe();

    collabUnsubscribe = onSnapshot(docRef, (docSnap) => {
        if (!docSnap.exists()) return;

        const newData = docSnap.data();
        
        // --- A. GEST√ÉO DE CADEADOS (LOCKS) ---
        // Recupera o mapa de bloqueios do documento pai
        const incomingLocks = newData.locks || {};
        
        // Atualiza vari√°vel global (CR√çTICO para a fun√ß√£o editArchivePost verificar antes de ir ao servidor)
        window.currentLocks = incomingLocks;
        
        // Injeta no DOM por seguran√ßa (Fonte de Verdade extra)
        const feed = document.getElementById('archive-feed');
        if (feed) {
            feed.dataset.activeLocks = JSON.stringify(incomingLocks);
        }

        // CHAMA A FUN√á√ÉO VISUAL (Pinta de vermelho os posts bloqueados)
        if (typeof applyVisualLocks === 'function') {
            applyVisualLocks();
        }

        // --- B. GEST√ÉO DE PERMISS√ïES (Bot√£o de Partilha) ---
        // Apenas o dono do arquivo pode ver o bot√£o de gerir partilhas
        const shareBtn = document.querySelector('#archive-toolbar button[data-action="archive-share"]');
        if (shareBtn && auth.currentUser) {
            const isOwner = newData.userId === auth.currentUser.uid;
            
            if (!isOwner) {
                shareBtn.style.setProperty('display', 'none', 'important');
            } else {
                shareBtn.style.display = 'flex'; // ou block/inline-flex
            }
        }
        
        // --- C. ATUALIZA√á√ÉO DE METADADOS ---
        // Se houver altera√ß√µes no nome do arquivo feitas por outro user, atualiza o input
        const titleInput = document.getElementById('archive-title-input');
        if (titleInput && document.activeElement !== titleInput) {
            if (newData.nome && titleInput.value !== newData.nome) {
                titleInput.value = newData.nome;
            }
        }

        console.log("üì° [SYNC] Metadados e Locks atualizados.");

    }, (error) => {
        console.error("‚ùå Erro no listener de colabora√ß√£o:", error);
    });
}

// 2. Sistema de Presen√ßa (Heartbeat)
async function initPresenceSystem(docId) {
    if (!auth.currentUser || !docId) return;

    const userId = auth.currentUser.uid;
    const userName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
    
    const { doc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // Define a refer√™ncia global para podermos apagar noutras fun√ß√µes
    presenceRef = doc(db, 'pastas', docId, 'collaborators', userId);

    // A. FUN√á√ÉO: ENTRAR (Sou vis√≠vel)
    const setOnline = async () => {
        if (document.visibilityState === 'visible') {
            try {
                await setDoc(presenceRef, {
                    name: userName,
                    lastSeen: serverTimestamp(),
                    status: 'online'
                }, { merge: true });
            } catch (e) { console.warn("Erro presen√ßa online:", e); }
        }
    };

    // Define estado inicial
    await setOnline();

    // B. HEARTBEAT: Atualiza "lastSeen" a cada 30s para n√£o expirar
    if (presenceHeartbeat) clearInterval(presenceHeartbeat);
    presenceHeartbeat = setInterval(() => {
        if (document.visibilityState === 'visible') setOnline();
    }, 30000);

    // C. OUVINTE (Quem est√° c√°?)
    const colRef = collection(db, 'pastas', docId, 'collaborators');
    
    // NOTA: N√£o limpamos o collabUnsubscribe aqui porque ele √© usado pelo initRealtimeCollab.
    // Usamos uma vari√°vel diferente se quisermos controlar este listener separadamente.
    
    onSnapshot(colRef, (snapshot) => {
        const listDiv = document.getElementById('active-users-list');
        const barDiv = document.getElementById('collab-bar');
        
        if (!listDiv || !barDiv) return;
        
        listDiv.innerHTML = '';
        
        const now = Date.now();
        const activeDocs = [];

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const lastSeen = data.lastSeen ? data.lastSeen.toMillis() : 0;
            
            // S√≥ considera online se foi visto nos √∫ltimos 60 segundos
            if (now - lastSeen < 60000) {
                activeDocs.push({ id: docSnap.id, ...data });
            }
        });

        // S√≥ mostra se houver mais de 1 pessoa (ou seja, n√£o estou sozinho)
        if (activeDocs.length > 1) {
            barDiv.style.display = 'flex';
            
            activeDocs.forEach(user => {
                const bubble = document.createElement('div');
                bubble.className = 'user-presence-bubble';
                bubble.textContent = user.name.charAt(0).toUpperCase();
                bubble.title = user.name;
                
                if (user.id === userId) {
                    bubble.style.backgroundColor = "var(--sidebar-color)";
                    bubble.style.border = "1px solid var(--accent-color)";
                    bubble.style.color = "var(--accent-color)";
                } else {
                    bubble.style.backgroundColor = stringToColor(user.name);
                }
                
                listDiv.appendChild(bubble);
            });
        } else {
            barDiv.style.display = 'none';
        }
    }, (error) => console.error("Erro presen√ßa:", error));
}

// 3. Aplicar Bloqueios Visuais (PINTOR CORRIGIDO)
function applyVisualLocks() {
    // Se n√£o houver utilizador ou arquivo ativo, sai
    if (!auth.currentUser || !currentArchiveId) return;

    const myUserId = auth.currentUser.uid;
    const LOCK_TIMEOUT = 15 * 60 * 1000; // 15 Minutos
    const now = Date.now();

    console.groupCollapsed("üñåÔ∏è [LOCKS-UI] Atualizando bloqueios visuais...");

    // 1. Ler os dados mais recentes da mem√≥ria global (mantida pelo listener)
    const locksMap = window.currentLocks || {};

    // 2. LIMPEZA TOTAL (Reset preventivo de todos os posts)
    document.querySelectorAll('.archive-post').forEach(postDiv => {
        // Se sou EU a editar este post neste momento, n√£o mexo no visual
        // (preciso de ver o editor limpo e funcional)
        if (activeEditingPostId && (postDiv.id === `post-${activeEditingPostId}` || postDiv.dataset.id === activeEditingPostId)) {
            return;
        }

        // Reseta estilos para o estado "normal"
        postDiv.classList.remove('is-locked');
        
        // Remove estilos inline for√ßados anteriormente
        postDiv.style.removeProperty('opacity');
        postDiv.style.removeProperty('pointer-events');
        postDiv.style.removeProperty('border');
        postDiv.style.removeProperty('background');
        
        // Remove badge antigo se existir
        const badge = postDiv.querySelector('.locked-badge');
        if (badge) badge.remove();
        
        // Restaura o bot√£o editar
        const editBtn = postDiv.querySelector('.post-edit-btn');
        if (editBtn) {
            editBtn.style.display = ''; // Volta ao padr√£o do CSS
            editBtn.disabled = false;
            editBtn.textContent = "Editar";
            editBtn.style.opacity = '';
            editBtn.style.cursor = 'pointer';
        }
    });

    // Se n√£o houver bloqueios ativos no mapa, terminamos aqui
    if (Object.keys(locksMap).length === 0) {
        console.log("   - Nenhum post bloqueado.");
        console.groupEnd();
        return;
    }

    // 3. APLICA√á√ÉO DOS BLOQUEIOS ATIVOS
    Object.entries(locksMap).forEach(([postId, lockData]) => {
        
        // A. Se for o meu pr√≥prio lock, ignora (j√° estou no editor)
        if (lockData.userId === myUserId) return; 

        // B. Se o lock expirou (timeout), ignora (ser√° limpo no pr√≥ximo acesso)
        if ((now - lockData.timestamp) > LOCK_TIMEOUT) return; 

        // C. Tenta encontrar o elemento no ecr√£
        // Tenta pelo ID HTML ou pelo dataset
        let postDiv = document.getElementById(`post-${postId}`) || 
                      document.querySelector(`.archive-post[data-id="${postId}"]`);
        
        if (postDiv) {
            console.log(`üîí Bloqueando post ${postId} (User: ${lockData.userName})`);
            
            // --- EFEITO VISUAL DE BLOQUEIO ---
            postDiv.classList.add('is-locked');
            
            // 1. Desvanece ligeiramente
            postDiv.style.setProperty('opacity', '0.75', 'important');
            
            // 2. Bloqueia cliques em tudo (links, bot√µes)
            postDiv.style.setProperty('pointer-events', 'none', 'important');
            
            // 3. Borda Vermelha Tracejada
            postDiv.style.setProperty('border', '2px dashed #e74c3c', 'important');
            
            // 4. Fundo de "Obra" (Listras)
            postDiv.style.setProperty('background', 'repeating-linear-gradient(45deg, rgba(231, 76, 60, 0.05), rgba(231, 76, 60, 0.05) 10px, rgba(231, 76, 60, 0.1) 10px, rgba(231, 76, 60, 0.1) 20px)', 'important');

            // 5. Cria o Badge de Aviso (Etiqueta no topo)
            let badge = postDiv.querySelector('.locked-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'locked-badge';
                // Adiciona o badge como primeiro filho
                postDiv.insertBefore(badge, postDiv.firstChild);
            }
            
            badge.innerHTML = `
                <span style="font-size:14px;">üîí</span> 
                <span style="font-size:0.9em; text-transform:uppercase; margin-right:4px;">EM EDI√á√ÉO:</span> 
                <strong style="color:#fff; border-bottom:1px dotted white;">${lockData.userName}</strong>
            `;
            
            // Estilo inline para garantir que sobrep√µe qualquer CSS
            badge.style.cssText = `
                position: absolute; 
                top: -10px; 
                right: 10px; 
                background: #e74c3c; 
                color: white; 
                padding: 4px 10px; 
                border-radius: 4px; 
                font-size: 11px; 
                font-weight: bold; 
                z-index: 100; 
                box-shadow: 0 4px 10px rgba(0,0,0,0.4); 
                display: flex !important; 
                align-items: center; 
                gap: 5px;
                animation: pulse-badge 2s infinite;
                pointer-events: auto !important; /* Permite ver tooltip se houver */
            `;

            // 6. Esconde o bot√£o Editar
            const editBtn = postDiv.querySelector('.post-edit-btn');
            if (editBtn) {
                editBtn.style.setProperty('display', 'none', 'important');
                editBtn.disabled = true;
            }
        }
    });
    
    console.groupEnd();
}

// 4. Bloquear Post (Chamar ao clicar em Editar)
async function lockPost(postId) {
    if (!currentArchiveId || !auth.currentUser) return false;

    console.group(`üîí [LOCK-TRANSACTION] Tentando bloquear atomicamente: ${postId}`);
    
    try {
        const { doc, runTransaction } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'pastas', currentArchiveId);
        const myUid = auth.currentUser.uid;
        const myName = currentUserData?.nome || auth.currentUser.email.split('@')[0];
        const LOCK_TIMEOUT = 15 * 60 * 1000; // 15 minutos

        // A transa√ß√£o garante que a leitura e a escrita s√£o uma opera√ß√£o √∫nica
        await runTransaction(db, async (transaction) => {
            // 1. Ler o estado mais recente do servidor
            const docSnap = await transaction.get(docRef);
            if (!docSnap.exists()) throw "Arquivo n√£o existe";

            const data = docSnap.data();
            const locks = data.locks || {};
            const existingLock = locks[postId];
            const now = Date.now();

            // 2. Verificar se j√° existe um cadeado V√ÅLIDO de OUTRA pessoa
            if (existingLock) {
                const isOtherUser = existingLock.userId !== myUid;
                const isNotExpired = (now - existingLock.timestamp) < LOCK_TIMEOUT;

                if (isOtherUser && isNotExpired) {
                    // Se estiver ocupado, lan√ßamos erro para abortar a transa√ß√£o
                    throw `Ocupado por ${existingLock.userName}`;
                }
            }

            // 3. Se passou a verifica√ß√£o, ESCREVE o nosso cadeado
            // Nota: Usamos nota√ß√£o de ponto para atualizar apenas este campo do mapa
            transaction.update(docRef, {
                [`locks.${postId}`]: {
                    userId: myUid,
                    userName: myName,
                    timestamp: now // Usamos Date.now() para facilitar compara√ß√µes num√©ricas
                }
            });
        });

        console.log("‚úÖ [LOCK] Sucesso! Cadeado garantido pela transa√ß√£o.");
        console.groupEnd();
        return true; // Conseguiu bloquear

    } catch (e) {
        console.warn("‚ö†Ô∏è [LOCK-FAIL] Transa√ß√£o abortada:", e);
        console.groupEnd();
        return false; // Falhou (estava ocupado)
    }
}

// 5. Desbloquear Post (Chamar ao sair/salvar)
async function unlockPost(postId) {
    if (!currentArchiveId) return;
    
    const docRef = doc(db, 'pastas', currentArchiveId);
    const { deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    try {
        await updateDoc(docRef, {
            [`locks.${postId}`]: deleteField()
        });
        console.log(`üîì [SISTEMA] Cadeado removido de: ${postId}`);
    } catch (e) {
        console.error("‚ùå [ERRO] Falha ao remover cadeado na sa√≠da:", e);
    }
}

// --- L√ìGICA DO BOT√ÉO VOLTAR NO ARQUIVO (MOBILE) ---
 const archiveBackBtn = document.getElementById('archive-back-btn');
if (archiveBackBtn) {
    const newBtn = archiveBackBtn.cloneNode(true);
    archiveBackBtn.parentNode.replaceChild(newBtn, archiveBackBtn);

    newBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        
        // --- CORRE√á√ÉO AQUI ---
        // Se t√≠nhamos um arquivo aberto, marcamos como lido no momento da sa√≠da
        if (currentArchiveId) {
            console.log("üö™ A sair do arquivo. Marcando como lido.");
            await markArchiveAsRead(currentArchiveId);
        }
        // ---------------------

        await forceUnlockAndSaveOnExit();
        await leaveArchivePresence();

        const container = document.querySelector('.notebook-container');
        if (container) container.classList.remove('middle-panel-collapsed');
        
        document.body.classList.remove('mobile-view-editor');
        document.body.classList.add('mobile-view-middle');

        selectedNoteId = null;
        updateMobileFABVisibility();
        
        // Refresca a lista lateral para garantir que o badge do n√∫mero desaparece
        if (currentViewMode === 'shared') {
            loadSharedFilesRoot();
        }
    });
}

// --- DIAGN√ìSTICO DE LAYOUT (DEBUG) ---
window.debugMobileLayout = function() {
    console.group("üïµÔ∏è DEBUG VISUAL MOBILE");
    const rightPanel = document.getElementById('right-panel');
    Array.from(rightPanel.children).forEach(child => {
        const style = window.getComputedStyle(child);
        if (style.display !== 'none') {
             console.log(`‚úÖ VIS√çVEL: ${child.id || child.tagName}`);
        }
    });
    console.groupEnd();
};

setInterval(() => {
    if (document.getElementById('archive-area').style.display !== 'none' && window.innerWidth < 768) {
        // window.debugMobileLayout(); // Descomente para debug
    }
}, 5000);

// Fun√ß√£o para sair formalmente da presen√ßa do Arquivo
async function leaveArchivePresence() {
    if (presenceHeartbeat) {
        clearInterval(presenceHeartbeat);
        presenceHeartbeat = null;
    }
    if (collabUnsubscribe) {
        collabUnsubscribe();
        collabUnsubscribe = null;
    }
    if (presenceRef) {
        try {
            const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            await deleteDoc(presenceRef);
            presenceRef = null; 
        } catch (e) { console.warn("Erro ao limpar presen√ßa:", e); }
    }
    const barDiv = document.getElementById('collab-bar');
    const listDiv = document.getElementById('active-users-list');
    if (barDiv) barDiv.style.display = 'none';
    if (listDiv) listDiv.innerHTML = '';
}

function clearAllListSelections() {
    document.querySelectorAll('#file-list .list-item').forEach(el => {
        el.classList.remove('selected', 'selected-red');
    });
    console.log("üßπ [SISTEMA] Sele√ß√£o visual da Coluna 2 limpa.");
}



// === GEST√ÉO DE GAVETAS (ADICIONAR NO FIM DO SCRIPT) ===


// 1. Alternar entre Prateleira e Gavet√£o
document.querySelectorAll('.archive-tab-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const targetTab = btn.dataset.archiveTab;
        
        // 1. AUTO-SAVE IMEDIATO
        await forceUnlockAndSaveOnExit();

        // 2. L√≥gica de Navega√ß√£o
        // Se sair de uma gaveta aberta, limpa a sele√ß√£o
        if (targetTab === 'prateleira' || targetTab === 'favoritos') {
            window.activeGavetaId = null;
            window.activeGavetaData = null;
        }

        // Atualiza UI
        document.querySelectorAll('.archive-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentArchiveTab = targetTab;
        
        // Gere bot√µes de cria√ß√£o (Esconde tudo nos Favoritos e Gavet√µes)
        const postBtn = document.getElementById('create-post-btn');
        const drawerBtn = document.getElementById('create-drawer-trigger-btn');
        const separatorBtn = document.getElementById('create-separator-btn');
        
        // Reset inicial
        if(postBtn) postBtn.style.display = 'none';
        if(drawerBtn) drawerBtn.style.display = 'none';
        if(separatorBtn) separatorBtn.style.display = 'none';

        if (currentArchiveTab === 'prateleira') {
            if(postBtn) postBtn.style.display = 'block';
        } else if (currentArchiveTab === 'gavet√µes') {
            if(drawerBtn) drawerBtn.style.display = 'block';
        }
        // Na aba 'favoritos', n√£o mostramos bot√µes de criar

        renderArchiveFeed();
    });
});






// 3. Editar Gavet√£o
window.openEditDrawerModal = (id, nome, desc) => {
    const modal = document.getElementById('create-drawer-modal');
    const titleEl = modal.querySelector('h3');
    const nameInput = document.getElementById('new-drawer-name');
    const descInput = document.getElementById('new-drawer-desc');
    const confirmBtn = document.getElementById('confirm-create-drawer');

    if (!modal) return;

    // 1. CONFIGURA√á√ÉO VISUAL DO MODAL PARA EDI√á√ÉO
    titleEl.textContent = "Editar Gavet√£o";
    nameInput.value = nome;
    descInput.value = desc === 'undefined' ? "" : desc; // Limpa se vier como string 'undefined'
    confirmBtn.textContent = "Gravar Altera√ß√µes";

    // 2. LIMPEZA DE LISTENERS ANTIGOS (Muito importante!)
    // Clonamos o bot√£o para garantir que a fun√ß√£o de "Criar" n√£o seja disparada por engano
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    // 3. L√ìGICA DE ATUALIZA√á√ÉO NO FIREBASE
    newConfirmBtn.onclick = async (e) => {
        e.preventDefault();
        
        const novoNome = nameInput.value.trim();
        if (!novoNome) return alert("O nome do gavet√£o √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A guardar...";

        try {
            // Importa√ß√£o din√¢mica por seguran√ßa
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const drawerRef = doc(db, 'gavetoes', id);
            
            await updateDoc(drawerRef, {
                nome: novoNome,
                descricao: descInput.value.trim(),
                ultimaEdicao: Date.now()
            });

            // 4. SUCESSO: FECHAR E RESETAR
            modal.style.display = 'none';
            
            // Restaura o t√≠tulo padr√£o do modal para a pr√≥xima vez que for usado para criar
            titleEl.textContent = "Criar Gavet√£o";
            
            if (typeof renderArchiveFeed === 'function') {
                renderArchiveFeed();
            }

        } catch (error) {
            console.error("‚ùå [ERRO] Falha ao editar gavet√£o:", error);
            alert("Ocorreu um erro ao gravar as altera√ß√µes.");
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Gravar Altera√ß√µes";
        }
    };

    // 5. MOSTRAR O MODAL (Com refor√ßo de Z-Index)
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "99999";
    
    setTimeout(() => nameInput.focus(), 150);
};






// 2. Aplicar o Estilo e Fechar
window.applyColorStyle = function(command, color) {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    if (typeof currentSelectionRange !== 'undefined' && currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    }

    // --- L√ìGICA INTELIGENTE (B e I) ---
    if (command === 'bold' || command === 'italic') {
        
        // Verifica o estado atual (dependendo do comando)
        const isStateActive = document.queryCommandState(command);
        const currentColorRGB = document.queryCommandValue('foreColor');
        const currentColorHex = rgbToHex(currentColorRGB);
        
        const targetColor = color.toLowerCase();
        const activeColor = currentColorHex.toLowerCase();

        if (!isStateActive) {
            // Se N√ÉO est√° ativo -> Ativa Formato + Cor
            document.execCommand(command, false, null);
            document.execCommand('foreColor', false, color);
        } 
        else {
            // Se J√Å EST√Å ativo:
            const colorsAreSame = (activeColor === targetColor);

            if (colorsAreSame) {
                // Mesma cor -> Remove Formato (Toggle Off)
                document.execCommand(command, false, null);
            } else {
                // Cor diferente -> Mant√©m Formato, Muda Cor
                document.execCommand('foreColor', false, color);
            }
        }

    } else {
        // Fallback
        document.execCommand(command, false, null);
        document.execCommand('foreColor', false, color);
    }
    
    // Foco e Sele√ß√£o
    editor.focus();
    if (currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    }

    if (typeof saveNote === 'function') saveNote();

    // Fecha todos os menus
    const fPopup = document.getElementById('formatting-popup');
    const bPopup = document.getElementById('bold-palette-popup');
    const iPopup = document.getElementById('italic-palette-popup'); // NOVO
    const fBtn = document.getElementById('more-formatting-btn');

    if (fPopup) fPopup.style.display = 'none';
    if (bPopup) bPopup.style.display = 'none';
    if (iPopup) iPopup.style.display = 'none';
    if (fBtn) fBtn.classList.remove('active'); 
};


// --- L√ìGICA EXPORTAR SENTINELA ü§ñ ---

let detectedQuestions = [];

window.openRobotModal = function() {
    const modal = document.getElementById('robot-modal');
    if (!modal) return console.error("Modal do Rob√¥ n√£o encontrado!");

    // 1. Esconde menus
    const fPopup = document.getElementById('formatting-popup');
    if(fPopup) fPopup.style.display = 'none';

    // 2. Limpa campos
    document.getElementById('robot-input-text').value = '';
    document.getElementById('robot-preview-container').style.display = 'none';
    document.getElementById('robot-insert-btn').style.display = 'none';
    document.getElementById('robot-input-container').style.display = 'block';
    
    // 3. Mostra Modal
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";
};

// Fun√ß√£o para Gerar/Detetar Perguntas
document.getElementById('robot-generate-btn').addEventListener('click', () => {
    const rawText = document.getElementById('robot-input-text').value;
    if (!rawText.trim()) return alert("Cole o texto primeiro.");

    detectedQuestions = []; // Array de objetos { type: 'header' | 'question', text: '...' }
    
    // 1. IDENTIFICAR SE√á√ÉO DE RECAPITULA√á√ÉO (QUAL √â A SUA RESPOSTA?)
    const recapMarkers = ["QUAL √â A SUA RESPOSTA?", "COMO RESPONDERIA?"];
    let mainBody = rawText;
    let recapBody = "";

    recapMarkers.forEach(marker => {
        if (rawText.toUpperCase().includes(marker)) {
            const index = rawText.toUpperCase().indexOf(marker);
            mainBody = rawText.substring(0, index);
            recapBody = rawText.substring(index);
        }
    });

    // 2. FASE 1: PROCESSAR CORPO PRINCIPAL (Perguntas numeradas)
    const mainParts = mainBody.split(/(?:(?:As|A)\s+)?(?:vossas?|suas?)\s+respostas?/i);
    for (let i = 0; i < mainParts.length - 1; i++) {
        let block = mainParts[i].trim();
        const lastNumberMatch = block.match(/\d+(?:-\d+)?\.\s+/g);
        if (lastNumberMatch) {
            const lastMatch = lastNumberMatch[lastNumberMatch.length - 1];
            const startIndex = block.lastIndexOf(lastMatch);
            let questionLine = block.substring(startIndex).trim();

            if (questionLine.includes('(a)') && questionLine.includes('(b)')) {
                const subParts = questionLine.split(/(?=\([b-z]\))/);
                subParts.forEach(sp => {
                    if (sp.trim()) detectedQuestions.push({ type: 'question', text: sp.trim() });
                });
            } else {
                detectedQuestions.push({ type: 'question', text: questionLine });
            }
        }
    }

    // 3. FASE 2: PROCESSAR RECAPITULA√á√ÉO
    if (recapBody) {
        // Extrair o t√≠tulo (ex: QUAL √â A SUA RESPOSTA?)
        const titleMatch = recapBody.match(/(QUAL √â A SUA RESPOSTA\?|COMO RESPONDERIA\?)/i);
        if (titleMatch) {
            detectedQuestions.push({ type: 'header', text: titleMatch[0] });
        }

        // Isolar apenas at√© chegar ao C√ÇNTICO ou notas finais
        const recapLimit = recapBody.split(/C√ÇNTICO|Veja o quadro|Por exemplo, veja/i)[0];
        
        // Procurar frases que terminam em "?" seguidas por "A sua resposta"
        const recapParts = recapLimit.split(/(?:As|A) (?:vossas?|suas?) respostas?/i);
        recapParts.forEach(part => {
            const lines = part.trim().split('\n');
            const lastLine = lines[lines.length - 1].trim();
            if (lastLine.endsWith('?')) {
                detectedQuestions.push({ type: 'question', text: lastLine });
            }
        });
    }

    // 4. RENDERIZAR PR√â-VISUALIZA√á√ÉO
    const list = document.getElementById('preview-list');
    list.innerHTML = '';
    
    if (detectedQuestions.length > 0) {
        detectedQuestions.forEach((item, index) => {
            const li = document.createElement('li');
            if (item.type === 'header') {
                li.style.cssText = "margin: 15px 0 5px 0; padding: 5px; color: #4a90e2; font-weight: bold; border-bottom: 1px solid #333; list-style: none;";
                li.innerHTML = `üìå ${item.text}`;
            } else {
                li.style.cssText = "margin-bottom: 8px; padding: 10px; background: rgba(46, 204, 113, 0.1); border-left: 4px solid #2ecc71; border-radius: 4px; color: #f0f0f0; font-size: 13px;";
                li.innerHTML = item.text;
            }
            list.appendChild(li);
        });

        document.getElementById('preview-count').textContent = `Detetados ${detectedQuestions.filter(i => i.type==='question').length} itens:`;
        document.getElementById('robot-preview-container').style.display = 'block';
        document.getElementById('robot-insert-btn').style.display = 'block';
    } else {
        alert("Nenhuma pergunta encontrada.");
    }
});



// Fun√ß√£o para Inserir as Perguntas no Editor
document.getElementById('robot-insert-btn').addEventListener('click', () => {
    const editor = document.getElementById('note-content-editor');
    
    const toolbarHTML = `
        <div class="mini-note-toolbar" contenteditable="false">
            <button type="button" data-action="sharing-settings" title="Defini√ß√µes de Partilha">üîê</button>
            <div class="toolbar-btn-group">
                <button type="button" data-action="move-up" title="Mover para cima">üî∫</button>
                <button type="button" data-action="move-down" title="Mover para baixo">üîª</button>
            </div>
            <button type="button" data-action="manage-box-links" title="Hiperliga√ß√µes da Caixa">‚ö°</button>
            <button type="button" data-action="append-mini-note" title="Enviar para outra nota">üß¨</button>
            <button type="button" data-action="highlight-color" title="Destacar">üé®</button>
            <button type="button" data-action="manage-mini-note-topics" title="Gerir T√≥picos">üìã</button>
            <button type="button" data-action="delete-mini-note" title="Remover">üóëÔ∏è</button>
        </div>`;

    let fullHTML = "";
    let firstItemId = null; // Guardar√° o ID do primeiro item para o scroll

    detectedQuestions.forEach((item, index) => {
        // Criamos um ID √∫nico para este item
        const uniqueId = `sentinela_${Date.now()}_${index}`;
        
        // Se for o primeiro item da lista (header ou quest√£o), guardamos o ID
        if (index === 0) firstItemId = uniqueId;

        if (item.type === 'header') {
            // T√≠tulo de se√ß√£o
            fullHTML += `<p id="${uniqueId}"><br></p><p><strong>${item.text}</strong></p>`;
        } else {
            // Caixa de Quest√£o
    fullHTML += `
    <div class="mini-note-wrapper question-mode" id="${uniqueId}">
        <textarea class="mini-note-title-input" rows="1">${item.text}</textarea>
        ${toolbarHTML}
        <div class="mini-note-content" contenteditable="true">
            <p><br></p>
        </div>
    </div><p><br></p>`;
        }
    });

    // 1. Inser√ß√£o no Editor
    if (typeof currentSelectionRange !== 'undefined' && currentSelectionRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(currentSelectionRange);
    } else {
        editor.focus();
    }

    document.execCommand('insertHTML', false, fullHTML);
    
    // 2. L√≥gica de Scroll para o Topo (com um pequeno delay para o browser renderizar o HTML)
    setTimeout(() => {
        if (firstItemId) {
            const firstEl = document.getElementById(firstItemId);
            if (firstEl) {
                // Scroll suave para o primeiro item inserido
                firstEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }, 150);

    // 3. Finaliza√ß√£o
    document.getElementById('robot-modal').style.display = 'none';
    if (typeof saveNote === 'function') saveNote();
    if (typeof fixLegacyMiniNotes === 'function') fixLegacyMiniNotes();
});




document.getElementById('append-back-btn').onclick = () => {
    const pathLabel = document.getElementById('append-current-path').textContent;
    
    if (pathLabel === "ü§ù Partilha") {
        // Se estiver na raiz da partilha, volta para a Raiz Global
        loadAppendList(null);
    } else if (appendStack.length > 0) {
        appendStack.pop();
        const prevId = appendStack.length > 0 ? appendStack[appendStack.length - 1].id : null;
        loadAppendList(prevId);
    } else {
        loadAppendList(null);
    }
};

function applyTitleWrappingEffect() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    const allTitles = editor.querySelectorAll('.mini-note-title-input');
    
    allTitles.forEach(t => {
        // Se ainda for um INPUT, converte para TEXTAREA (necess√°rio para quebra de linha)
        if (t.tagName === 'INPUT') {
            const textarea = document.createElement('textarea');
            textarea.className = t.className;
            // Pega o valor do atributo value ou do valor atual
            textarea.value = t.getAttribute('value') || t.value || ""; 
            textarea.placeholder = t.placeholder || "";
            textarea.setAttribute('spellcheck', 'false');
            if (t.readOnly) textarea.readOnly = true;
            t.parentNode.replaceChild(textarea, t);
            t = textarea; 
        }

        if (appSettings && appSettings.showFullTitles === true) {
            t.classList.add('wrap-enabled');
            t.style.whiteSpace = "pre-wrap";
            t.style.overflow = "hidden";
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
            
            t.oninput = function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                // Sincroniza o textContent para o save n√£o falhar
                this.textContent = this.value; 
            };
        } else {
            t.classList.remove('wrap-enabled');
            t.style.whiteSpace = "nowrap";
            t.style.height = ""; 
            t.style.overflow = "hidden";
            t.oninput = null;
        }
    });
}

// Fun√ß√£o auxiliar para garantir que o campo cresce com o texto
function autoResizeTitle(el) {
    if (!el) return;
    
    if (typeof appSettings !== 'undefined' && !appSettings.showFullTitles) {
        el.style.height = ""; 
        return;
    }

    // TRUQUE ANTI-SALTO:
    // Em vez de zerar a altura para medir (o que causa o salto),
    // usamos o scrollHeight atual. Se ele aumentou, expandimos.
    // Se precisarmos mesmo encolher, fazemos com cuidado.

    const currentHeight = el.offsetHeight;
    
    // Reseta temporariamente para medir o tamanho real do texto
    // Mas guarda o scroll da p√°gina para restaurar se saltar
    const scrollParent = el.closest('#note-content-editor') || document.documentElement;
    const oldScroll = scrollParent.scrollTop;

    el.style.height = 'auto'; 
    const newHeight = el.scrollHeight;

    // Se a diferen√ßa for m√≠nima, n√£o mexe para evitar tremores
    if (Math.abs(newHeight - currentHeight) > 2) {
        el.style.height = newHeight + 'px';
        
        // Se o ajuste de altura fez o scroll saltar, restaura-o
        if (scrollParent.scrollTop !== oldScroll) {
            scrollParent.scrollTop = oldScroll;
        }
    } else {
        // Restaura a altura original se n√£o houve mudan√ßa real
        el.style.height = currentHeight + 'px';
    }
}

// Fun√ß√£o para converter Inputs antigos em Textareas din√¢micos
function convertToTextarea(inputEl) {
    const textarea = document.createElement('textarea');
    textarea.className = inputEl.className;
    textarea.value = inputEl.value;
    textarea.placeholder = inputEl.placeholder;
    textarea.rows = 1;
    // Copia os datasets
    Object.assign(textarea.dataset, inputEl.dataset);
    
    inputEl.parentNode.replaceChild(textarea, inputEl);
    
    textarea.addEventListener('input', () => {
        autoResizeTitle(textarea);
        saveNote();
    });
}

// ============================================================
// FUN√á√ÉO: RENDERIZAR ITENS DA CATEGORIA (COLUNA DO MEIO)
// ============================================================
async function renderListCategoryItems(categoryId, filterText = '') {
    const listElement = middlePanelList;
    const myUid = auth.currentUser.uid;
    
    // Identifica onde estamos na navega√ß√£o
    const lastNav = navigationStack.length > 0 ? navigationStack[navigationStack.length - 1] : null;
    
    // Identifica qual √© a categoria raiz (ex: 'topico', 'personagem')
    const origin = (navigationStack.length > 0) ? navigationStack[0].id : categoryId;
    
    const specialCategories = ['personagem', 'local', 'data', 'cosmos', 'tag', 'topico', 'marcadores'];
    const isSpecialCategory = specialCategories.includes(origin);

    // 1. Limpeza inicial com Spinner
    if (!filterText) {
        listElement.innerHTML = `
            <div class="panel-loader">
                <div class="spinner"></div>
                <span>A carregar ${lastNav ? lastNav.name : 'itens'}...</span>
            </div>`;
    }

    try {
        const { collection, query, where, orderBy, getDocs, limit } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        let items = [];
        let htmlBuffer = '';

        // ==========================================
        // 0. B√çBLIA: NAVEGA√á√ÉO COMPLETA (Aba separada)
        // ==========================================
        if (origin === 'biblia-root') {
            if (!lastNav || lastNav.type === 'list-category') {
                middlePanelTitle.textContent = "B√≠blia: Livros";
                updateAddButtonState(false);
                listElement.innerHTML = '';
                BIBLE_DATA.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>üìñ ${book.nome}</span>`;
                    li.onclick = () => {
                        navigateWithUnsavedCheck(() => {
                            navigationStack.push({ id: book.nome, name: book.nome, type: 'bible-book', caps: book.caps });
                            updateNavigationView(true);
                        });
                    };
                    listElement.appendChild(li);
                });
            } else if (lastNav.type === 'bible-book') {
                middlePanelTitle.textContent = lastNav.name;
                listElement.innerHTML = '<div class="bible-grid"></div>';
                const grid = listElement.querySelector('.bible-grid');
                for (let i = 1; i <= lastNav.caps; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'bible-grid-btn';
                    btn.textContent = i;
                    btn.onclick = () => {
                        navigateWithUnsavedCheck(() => {
                            navigationStack.push({ id: `${lastNav.name} ${i}`, name: `Cap. ${i}`, type: 'bible-chapter', book: lastNav.name, chapter: i });
                            updateNavigationView(true);
                        });
                    };
                    grid.appendChild(btn);
                }
            } else if (lastNav.type === 'bible-chapter') {
                const bookData = BIBLE_DATA.find(b => b.nome === lastNav.book);
                const prefix = `${lastNav.book} ${lastNav.chapter}:`;
                middlePanelTitle.textContent = prefix.replace(':', '');
                listElement.innerHTML = '<div class="bible-grid"></div>';
                const grid = listElement.querySelector('.bible-grid');
                const totalV = bookData?.versiculos?.[lastNav.chapter - 1] || 50;
                const existingVerses = allEntities['textobiblico'] || [];
                for (let v = 1; v <= totalV; v++) {
                    const fullVerse = `${prefix}${v}`;
                    const exists = existingVerses.some(e => e.nome === fullVerse);
                    const isActive = fullVerse === currentlyOpenVerseName;
                    const btn = document.createElement('div');
                    btn.className = `bible-grid-btn ${exists ? 'exists' : ''} ${isActive ? 'active-verse' : ''}`;
                    btn.textContent = v;
                    btn.onclick = () => {
                        navigateWithUnsavedCheck(() => {
                            currentlyOpenVerseName = fullVerse;
                            grid.querySelectorAll('.bible-grid-btn').forEach(b => b.classList.remove('active-verse'));
                            btn.classList.add('active-verse');
                            showReferencesPanel(null, fullVerse, 'textobiblico');
                        });
                    };
                    grid.appendChild(btn);
                }
            }
            return;
        }

        // ==========================================
        // 1. TEXTOS B√çBLICOS (REGISTOS DO UTILIZADOR)
        // ==========================================
        if (origin === 'textobiblico') {
            if (lastNav && lastNav.type === 'bible-record-group') {
                middlePanelTitle.textContent = lastNav.name;
            } else {
                middlePanelTitle.textContent = "Textos B√≠blicos";
            }
            updateAddButtonState(false); 

            // Buscar TODOS os textos
            const q = query(collection(db, 'textosbiblicos'), where('userId', '==', myUid));
            const snapshot = await getDocs(q);
            
            const groupedBooks = {};
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (data.estado === 'desativa') return;
                const match = data.nome.match(/^(.+?)\s+\d+:/);
                const bookName = match ? match[1].trim() : "Outros";
                
                if (!groupedBooks[bookName]) groupedBooks[bookName] = [];
                
                groupedBooks[bookName].push({ 
                    id: docSnap.id, 
                    nome: data.nome, 
                    type: 'textobiblico' 
                });
            });

            // N√çVEL 2: DENTRO DO LIVRO (Vers√≠culos)
            if (lastNav && lastNav.type === 'bible-record-group') {
                const bookName = lastNav.id;
                middlePanelTitle.textContent = bookName;
                const verses = groupedBooks[bookName] || [];
                
                verses.sort((a, b) => {
                    const refA = a.nome.replace(bookName, '').trim();
                    const refB = b.nome.replace(bookName, '').trim();
                    const [capA, verA] = refA.split(':').map(n => parseInt(n));
                    const [capB, verB] = refB.split(':').map(n => parseInt(n));
                    if (capA !== capB) return capA - capB;
                    return verA - verB;
                });
                items = verses; 
            } 
            // N√çVEL 1: LISTA DE LIVROS (RAIZ)
            else {
                const CANONICAL_ORDER = [
                    "G√©nesis", "√äxodo", "Lev√≠tico", "N√∫meros", "Deuteron√≥mio", 
                    "Josu√©", "Ju√≠zes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", 
                    "1 Cr√≥nicas", "2 Cr√≥nicas", "Esdras", "Neemias", "Ester", "J√≥", "Salmos", 
                    "Prov√©rbios", "Eclesiastes", "C√¢ntico de Salom√£o", "Isa√≠as", "Jeremias", 
                    "Lamenta√ß√µes", "Ezequiel", "Daniel", "Oseias", "Joel", "Am√≥s", "Obadias", 
                    "Jonas", "Miqueias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias",
                    "Mateus", "Marcos", "Lucas", "Jo√£o", "Atos", "Romanos", "1 Cor√≠ntios", "2 Cor√≠ntios", 
                    "G√°latas", "Ef√©sios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", 
                    "1 Tim√≥teo", "2 Tim√≥teo", "Tito", "Fil√©mon", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", 
                    "1 Jo√£o", "2 Jo√£o", "3 Jo√£o", "Judas", "Apocalipse"
                ];

                const bookNames = Object.keys(groupedBooks);
                bookNames.sort((a, b) => {
                    const idxA = CANONICAL_ORDER.indexOf(a);
                    const idxB = CANONICAL_ORDER.indexOf(b);
                    if (idxA === -1) return 1;
                    if (idxB === -1) return -1;
                    return idxA - idxB;
                });

                listElement.innerHTML = '';
                if (bookNames.length === 0) {
                    listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum texto b√≠blico guardado.</li>';
                    return;
                }

                bookNames.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<div style="display:flex; justify-content:space-between; width:100%; align-items:center; overflow:hidden;"><span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">üå´Ô∏è ${book}</span></div>`;
                    li.onclick = () => {
                        navigateWithUnsavedCheck(() => {
                            navigationStack.push({ id: book, name: book, type: 'bible-record-group' });
                            updateNavigationView(true);
                        });
                    };
                    listElement.appendChild(li);
                });
                return;
            }
        }

        // ==========================================
        // 2. DESTAQUES (CORES)
        // ==========================================
        else if (categoryId === 'destaque') {
             middlePanelTitle.textContent = "Destaques (Cores)";
             updateAddButtonState(false);
             listElement.innerHTML = '';
             DEFAULT_HIGHLIGHTS.forEach(colorObj => {
                const displayName = userCustomHighlights[colorObj.code] || colorObj.name;
                const li = document.createElement('li');
                li.className = 'list-item';
                const colorDot = `<span style="display:inline-block; width:16px; height:16px; min-width:16px; background:${colorObj.code}; border-radius:50%; margin-right:10px; border:1px solid rgba(255,255,255,0.3); flex: none !important;"></span>`;
                li.innerHTML = `${colorDot} <span>${displayName}</span>`;
                li.onclick = () => {
                    listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                    const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                    li.classList.add(selectionClass);
                    showHighlightReferencesPanel(colorObj.code, displayName);
                };
                listElement.appendChild(li);
            });
            return;
        }

        // =========================================================
        // 3. BARRA DE PESQUISA (Para especiais)
        // =========================================================
        if (isSpecialCategory) {
            htmlBuffer += `
            <li class="list-search-sticky-header">
                <input type="text" 
                       id="category-list-search" 
                       placeholder="üîç Pesquisar em ${categoryId}..." 
                       value="${filterText}" 
                       oninput="window.handleListSearch(this.value, '${categoryId}')"
                       autocomplete="off">
            </li>`;
        }

        // =========================================================
        // 4. L√ìGICA DE DADOS (Resto das Categorias)
        // =========================================================
        if (items.length === 0) {
            
            // --- A. T√ìPICOS (ESTRUTURA EM √ÅRVORE) ---
            if (categoryId === 'topico') {
                middlePanelTitle.textContent = "T√≥picos";
                updateAddButtonState(true, true); 

                let q = query(collection(db, 'topicos'), where('userId', '==', myUid), orderBy('nome'));
                
                if (filterText) {
                    q = query(q, where('nome', '>=', filterText), where('nome', '<=', filterText + '\uf8ff'));
                }
                q = query(q, limit(50));

                const snap = await getDocs(q);
                
                listElement.innerHTML = htmlBuffer; // Adiciona a barra de pesquisa primeiro

                if (snap.empty) {
                    listElement.innerHTML += '<li style="padding:20px; color:#888; text-align:center;">Nenhum t√≥pico encontrado.</li>';
                    return;
                }

                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    if (item.estado !== 'desativa') {
                        
                        // Cria o Item Pai
                        const li = document.createElement('li');
                        li.className = 'list-item topic-parent-item';
                        li.setAttribute('data-id', docSnap.id);
                        li.setAttribute('data-type', 'topico');
                        li.setAttribute('data-name', item.nome);
                        li.setAttribute('data-desc', item.descricao || '');
                        
                        li.innerHTML = `
                            <div style="display:flex; align-items:center; width:100%;">
                                <span class="tree-toggle-icon" style="margin-right:8px; font-size:10px; color:var(--text-muted-color); transition:transform 0.2s;">‚ñ∂</span>
                                <span style="font-weight:600;">${item.nome}</span>
                            </div>
                        `;

                        // Container para os filhos
                        const childrenContainer = document.createElement('div');
                        childrenContainer.id = `subs-${docSnap.id}`;
                        childrenContainer.style.display = 'none';
                        childrenContainer.style.paddingLeft = '20px';
                        childrenContainer.style.borderLeft = '1px solid var(--border-color)';
                        childrenContainer.style.marginLeft = '10px';

                        // CLIQUE NO T√ìPICO
                        li.onclick = async (e) => {
                            e.stopPropagation();
                            
                            // Sele√ß√£o Visual
                            listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                            li.classList.add(selectionClass);

                            // Abre a 4¬™ Coluna
                            showTopicReferencesPanel(docSnap.id, item.nome, item.descricao, 'topico');

                            // Expande a √°rvore
                            await window.toggleTopicTree(docSnap.id, item.nome, childrenContainer, li.querySelector('.tree-toggle-icon'));
                        };

                        listElement.appendChild(li);
                        listElement.appendChild(childrenContainer);
                    }
                });
                return; // Sai aqui para n√£o usar o loop gen√©rico abaixo
            }
            
            // --- B. COSMOS (PAI e FILHO) ---
            else if (categoryId === 'cosmos' && (!lastNav || lastNav.type === 'list-category')) {
                middlePanelTitle.textContent = "üíº Cosmos: Temas";
                updateAddButtonState(true, true); 
                let q = query(collection(db, 'cosmos'), where('userId', '==', myUid), orderBy('nome'));
                if (filterText) q = query(q, where('nome', '>=', filterText), where('nome', '<=', filterText + '\uf8ff'));
                q = query(q, limit(50));
                
                const snap = await getDocs(q);
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    if (item.estado !== 'desativa') {
                        const editHtml = `<button class="item-menu-btn" onclick="event.stopPropagation(); window.openCosmosEditPopup('${docSnap.id}', '${item.nome}', '${item.emoji}', 'cosmos-parent')">‚úèÔ∏è</button>`;
                        items.push({ id: docSnap.id, nome: item.nome, type: 'cosmos-parent', emoji: item.emoji, customHtml: `<span>${item.emoji || 'üíº'} ${item.nome}</span>${editHtml}` });
                    }
                });
            }
            else if (lastNav && lastNav.type === 'cosmos-parent') {
                middlePanelTitle.textContent = `${lastNav.emoji || 'üíº'} ${lastNav.name}`;
                updateAddButtonState(true, true);
                let q = query(collection(db, 'subcosmos'), where('cosmosId', '==', lastNav.id), where('userId', '==', myUid), orderBy('nome'));
                if (filterText) q = query(q, where('nome', '>=', filterText), where('nome', '<=', filterText + '\uf8ff'));
                q = query(q, limit(50));
                
                const snap = await getDocs(q);
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    if (item.estado !== 'desativa') {
                        const editHtml = `<button class="item-menu-btn" onclick="event.stopPropagation(); window.openEditEntityModal('${docSnap.id}', 'subcosmos')">‚úèÔ∏è</button>`;
                        items.push({ id: docSnap.id, nome: item.nome, type: 'subcosmos', emoji: item.emoji, customHtml: `<span>${item.emoji || 'üß¨'} ${item.nome}</span>${editHtml}` });
                    }
                });
            }

            // --- C. MARCADORES ---
            else if (categoryId === 'marcadores') {
                 middlePanelTitle.textContent = "Marcadores";
                 updateAddButtonState(true, true);
                 let q = query(collection(db, 'marcadores'), where('userId', '==', myUid), orderBy('nome'));
                 if (filterText) q = query(q, where('nome', '>=', filterText), where('nome', '<=', filterText + '\uf8ff'));
                 q = query(q, limit(50));
                 const snap = await getDocs(q);
                 snap.forEach(docSnap => items.push({ id: docSnap.id, nome: docSnap.data().nome, type: 'marcadores' }));
            }
            
            // --- D. TAGS ---
            else if (categoryId === 'tag') {
                middlePanelTitle.textContent = "Tags (#)";
                updateAddButtonState(false);
                const q = query(collection(db, 'pastas'), where('tipo', '==', 'nota'), where('userId', '==', myUid));
                const snap = await getDocs(q);
                const tagSet = new Set();
                snap.forEach(doc => { if(doc.data().tags) doc.data().tags.forEach(t => tagSet.add(t)); });
                let allTagsArray = Array.from(tagSet).sort();
                if (filterText) allTagsArray = allTagsArray.filter(t => t.toLowerCase().includes(filterText.toLowerCase()));
                items = allTagsArray.slice(0, 50).map(t => ({ id: t, nome: t, type: 'tag' }));
            }
            
            // --- E. RESTO (Personagens, Locais, Datas) ---
            else if (categoryId !== 'textobiblico') { 
                const config = ENTITY_CONFIG[categoryId];
                if (config) {
                    middlePanelTitle.textContent = config.displayName;
                    updateAddButtonState(true, true);
                    let q = query(collection(db, config.collection), where('userId', '==', myUid), orderBy('nome'));
                    if (isSpecialCategory) {
                        if (filterText) q = query(q, where('nome', '>=', filterText), where('nome', '<=', filterText + '\uf8ff'));
                        q = query(q, limit(50));
                    }
                    const snap = await getDocs(q);
                    snap.forEach(docSnap => {
                        const data = docSnap.data();
                        if (data.estado !== 'desativa') {
                            items.push({ id: docSnap.id, nome: data.nome, type: categoryId });
                        }
                    });
                }
            }
        }

        // ==========================================
        // RENDERIZA√á√ÉO FINAL DA LISTA (Gen√©ricos)
        // ==========================================
        
        if (items.length === 0) {
            htmlBuffer += `<li style="padding:20px; color:#888; text-align:center;">Nada encontrado.</li>`;
        } 
        
        listElement.innerHTML = htmlBuffer;

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-item';
            
            if (activeReferenceEntity && activeReferenceEntity.id === item.id) {
                const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                li.classList.add(selectionClass);
            }

            let icon = 'üîπ';
            if (item.type === 'tag') icon = 'üè∑Ô∏è';
            if (item.type === 'marcadores') icon = 'üîñ';
            if (item.type === 'personagem') icon = 'üë§';
            if (item.type === 'local') icon = 'üìç';
            if (item.type === 'data') icon = 'üìÖ';

            if (item.customHtml) {
                li.innerHTML = item.customHtml;
            } else {
                li.innerHTML = `<span>${icon} ${item.nome}</span>`;
            }

            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;

                if (item.type === 'cosmos-parent') {
                    navigationStack.push({ id: item.id, name: item.nome, type: 'cosmos-parent', emoji: item.emoji });
                    updateNavigationView(true); 
                    return;
                }

                listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
                li.classList.add(selectionClass);

                if (item.type === 'tag') showTagReferencesPanel(item.nome);
                else if (item.type === 'marcadores') showMarkerReferencesPanel(item.id, item.nome);
                else if (item.type === 'subcosmos') showReferencesPanel(item.id, item.nome, 'subcosmos');
                else showReferencesPanel(item.id, item.nome, item.type);
            };

            listElement.appendChild(li);
        });

        if (filterText) {
            const input = document.getElementById('category-list-search');
            if (input) {
                input.focus();
                const val = input.value; input.value = ''; input.value = val;
            }
        }

    } catch (e) {
        console.error("Erro ao renderizar lista:", e);
        listElement.innerHTML = '<li style="color:red; padding:20px; text-align:center;">Erro ao carregar dados.</li>';
    }
}

// ============================================================
// FUN√á√ÉO AUXILIAR: EXPANDIR/RECOLHER SUBT√ìPICOS
// ============================================================
window.toggleTopicTree = async function(topicId, topicName, container, iconElement) {
    // Alternar visibilidade
    const isClosed = container.style.display === 'none';
    
    if (isClosed) {
        // ABRIR
        container.style.display = 'block';
        if (iconElement) iconElement.style.transform = 'rotate(90deg)';
        
        // Se estiver vazio, carrega do Firebase
        if (container.innerHTML === '') {
            container.innerHTML = '<div style="padding:5px; color:#888; font-size:0.8em;">A carregar...</div>';
            
            try {
                const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                const q = query(
                    collection(db, 'subtopicos'), 
                    where('topicId', '==', topicId),
                    where('userId', '==', auth.currentUser.uid), 
                    orderBy('nome')
                );
                
                const snap = await getDocs(q);
                container.innerHTML = '';
                
                if (snap.empty) {
                    container.innerHTML = '<div style="padding:5px; color:#666; font-style:italic; font-size:0.8em;">(Vazio)</div>';
                }

                snap.forEach(doc => {
                    const sub = doc.data();
                    if (sub.estado === 'desativa') return;

                    const subLi = document.createElement('div');
                    subLi.className = 'list-item subtopic-item';
                    subLi.style.padding = "8px 10px";
                    subLi.style.fontSize = "0.95em";
                    
                    // Metadados para o bot√£o "+"
                    subLi.setAttribute('data-id', doc.id);
                    subLi.setAttribute('data-type', 'subtopico');
                    subLi.setAttribute('data-name', sub.nome);
                    subLi.setAttribute('data-parent-id', topicId); // ID do t√≥pico pai
                    subLi.setAttribute('data-parent-name', topicName);

                    subLi.innerHTML = `<span style="color:var(--text-muted-color);">--</span> ${sub.nome}`;

                    subLi.onclick = (e) => {
                        e.stopPropagation();
                        
                        // Sele√ß√£o Visual
                        middlePanelList.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                        subLi.classList.add(currentViewMode === 'shared' ? 'selected-red' : 'selected');

                        // Abre 4¬™ Coluna
                        showTopicReferencesPanel(doc.id, sub.nome, sub.descricao, 'subtopico');
                    };

                    container.appendChild(subLi);
                });

            } catch (e) {
                console.error("Erro ao carregar subt√≥picos:", e);
                container.innerHTML = '<div style="color:red; font-size:0.8em;">Erro.</div>';
            }
        }
    } else {
        // FECHAR
        container.style.display = 'none';
        if (iconElement) iconElement.style.transform = 'rotate(0deg)';
    }
};

// 3. Fun√ß√£o Global para o evento oninput do HTML
window.handleListSearch = function(text, categoryId) {
    clearTimeout(listSearchTimer);
    listSearchTimer = setTimeout(() => {
        renderListCategoryItems(categoryId, text);
    }, 500); // 500ms de espera antes de pesquisar
};


// Fun√ß√£o auxiliar para n√£o repetir c√≥digo de renderiza√ß√£o
function renderStandardList(items) {
    // 1. Limpa apenas a Coluna 2
    middlePanelList.innerHTML = '';
    
    if (items.length === 0) {
        middlePanelList.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nada encontrado.</li>';
        return;
    }
    
    items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-item';
        
        // ============================================================
        // REGRA DE COR DIN√ÇMICA PARA LISTAS (COLUNA 2)
        // ============================================================
        // Verifica se o item √© o que est√° atualmente aberto no painel de refer√™ncias
        if (activeReferenceEntity && activeReferenceEntity.id === item.id) {
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            li.classList.add(selectionClass);
        }

        let icon = 'üîπ';
        if (item.type === 'topico') icon = 'üìë';
        if (item.type === 'tag') icon = 'üè∑Ô∏è';
        if (item.type === 'textobiblico') icon = 'üìú';
        if (item.type === 'marcadores') icon = 'üîñ';
        if (item.type === 'destaque') icon = 'üé®';
        
        li.innerHTML = `<span>${icon} ${item.nome}</span>`;
        
        li.onclick = () => {
            // Limpa a sele√ß√£o visual apenas da Coluna 2 antes de marcar o novo
            document.querySelectorAll('#file-list .list-item').forEach(el => {
                el.classList.remove('selected', 'selected-red');
            });
            
            // Aplica a cor correta baseada no modo
            const selectionClass = (currentViewMode === 'shared') ? 'selected-red' : 'selected';
            li.classList.add(selectionClass);

            // A√ß√£o de abrir as refer√™ncias
            if (item.type === 'topico') showTopicReferencesPanel(item.id, item.nome, item.desc, 'topico');
            else if (item.type === 'tag') showTagReferencesPanel(item.nome);
            else if (item.type === 'destaque') showHighlightReferencesPanel(item.id, item.nome);
            else if (item.type === 'marcadores') showMarkerReferencesPanel(item.id, item.nome); 
            else showReferencesPanel(item.id, item.nome, item.type);
        };
        
        middlePanelList.appendChild(li);
    });
}


// ============================================================
// L√ìGICA DE ARRASTO DO PAINEL DE REFER√äNCIAS (MOBILE) - OTIMIZADA
// ============================================================
const refPanel = document.getElementById('references-panel');

let isDragging = false;
let startY = 0;
let startHeight = 0;
let lastY = 0;
let velocity = 0; // Para detetar "arremessos"

// 1. IN√çCIO
refPanel.addEventListener('touchstart', (e) => {
    // Aumenta a √°rea de pega: Cabe√ßalho OU qualquer parte se estiver fechado
    const isHeader = e.target.closest('.panel-header');
    const isClosedState = refPanel.offsetHeight < window.innerHeight * 0.20;

    if (isHeader || isClosedState || e.target === refPanel) {
        isDragging = true;
        startY = e.touches[0].clientY;
        lastY = startY;
        startHeight = refPanel.offsetHeight;
        
        // MODO ZERO-LAT√äNCIA
        refPanel.classList.add('is-dragging');
    }
}, { passive: false }); // passive: false √© vital para bloquear o scroll nativo

// 2. MOVIMENTO
window.addEventListener('touchmove', (e) => {
    if (!isDragging) return;

    if (e.cancelable) e.preventDefault(); // Mata o scroll da p√°gina

    const currentY = e.touches[0].clientY;
    
    // Calcula velocidade (diferen√ßa entre frames)
    velocity = currentY - lastY;
    lastY = currentY;

    // Movimento direto
    const delta = startY - currentY;
    let newH = startHeight + delta;

    // √önico limite: N√£o sair pelo topo do ecr√£
    if (newH > window.innerHeight) newH = window.innerHeight;
    
    // Sem limite inferior r√≠gido durante o movimento (para sentir elasticidade)
    if (newH < 50) newH = 50; 

    refPanel.style.height = `${newH}px`;
}, { passive: false });

// 3. FIM (LAN√áAMENTO)
window.addEventListener('touchend', () => {
    if (!isDragging) return;
    isDragging = false;
    refPanel.classList.remove('is-dragging');

    // L√≥gica de "Arremesso" (In√©rcia)
    // Se a velocidade for alta para baixo (> 5), fecha logo para 10%
    if (velocity > 10) {
        refPanel.style.transition = "height 0.3s cubic-bezier(0.25, 1, 0.5, 1)"; // Anima√ß√£o r√°pida de queda
        refPanel.style.height = "10vh";
        return;
    }

    // Se largou devagar:
    const currentH = refPanel.offsetHeight;
    const screenH = window.innerHeight;
    
    // Se est√° abaixo de 20%, for√ßa os 10% (Posi√ß√£o de descanso)
    if (currentH < screenH * 0.20) {
        refPanel.style.height = "10vh";
    } else {
        // Sen√£o, fica exatamente onde est√°
        refPanel.style.height = `${currentH}px`;
    }
});



async function showMarkerReferencesPanel(markerId, markerName) {
    
    // 1. Gravar o puzzle anterior se estivesse em modo edi√ß√£o
    await forceSaveAndClosePuzzleMode();

    // 2. CONFIGURAR A ENTIDADE ATIVA (Para o bot√£o +Ref do Quadro saber o que procurar)
    activeReferenceEntity = { 
        id: markerId, 
        type: 'marcadores', 
        name: markerName 
    };

    // 3. Configura√ß√£o Visual da 4¬™ Coluna
    document.getElementById('references-panel-description').style.display = 'none';
    document.getElementById('references-toolbar').style.display = 'flex';
    document.querySelectorAll('.references-separator').forEach(el => el.style.display = 'block');
    
    // Mostra o painel lateral
    notebookContainer.classList.add('references-panel-visible');
    referencesPanelTitle.textContent = `Textos com üîñ ${markerName}`;

    // For√ßa a aba "Refer√™ncias" a abrir para mostrar os vers√≠culos encontrados
    const refTabBtn = document.querySelector('[data-ref-tab="references"]');
    if (refTabBtn) refTabBtn.click();

    // Carrega o Quadro (Puzzle) associado a este Marcador
    loadPuzzleData(markerId, 'marcadores');

    // Limpa a lista e mostra o sinal de carregamento
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <span>A procurar textos b√≠blicos marcados...</span>
        </div>`;

    try {
        // 4. Query ao Firebase: Procura na cole√ß√£o 'textosbiblicos' 
        // onde o ID do marcador existe dentro do mapa 'marcadoresAssociados'
        const q = query(
            collection(db, 'textosbiblicos'),
            where(`marcadoresAssociados.${markerId}`, '==', true),
            where('userId', '==', auth.currentUser.uid)
        );

        const snapshot = await getDocs(q);
        listElement.innerHTML = '';

        if (snapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhum texto b√≠blico foi associado a este marcador ainda.</li>';
            return;
        }

        // 5. Renderizar a lista de Vers√≠culos encontrados
      snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const details = document.createElement('details');
            details.className = 'reference-item';
            
            // Dados para o bot√£o de adicionar ao quadro
            const safeName = encodeURIComponent(data.nome);
            const markerSnippet = `<p style="color:#9b59b2; font-weight:bold;">üîñ Texto marcado como: ${markerName}</p>`;
            const safeSnippet = encodeURIComponent(markerSnippet);

            const summary = document.createElement('summary');
            summary.style.display = 'flex';
            summary.style.alignItems = 'center';
            summary.style.width = '100%';
            summary.style.listStyle = "none";

            // --- CORRE√á√ÉO AQUI ---
            // Substitu√≠mos 'item.id' por 'docSnap.id' e mudamos a fun√ß√£o para showReferencesPanel
            // Isto faz com que a seta abra os detalhes desse vers√≠culo espec√≠fico na 4¬™ coluna
            const goToBtn = `<button class="go-to-note-btn" 
                onclick="event.preventDefault(); event.stopPropagation(); window.showReferencesPanel('${docSnap.id}', '${data.nome}', 'textobiblico')" 
                title="Ver detalhes deste vers√≠culo">‚ûî</button>`;
            // ---------------------

            summary.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; flex-grow:1; overflow:hidden;">
                    <button class="add-to-puzzle-btn" title="Adicionar ao Quadro" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${docSnap.id}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                   <span style="white-space:normal; word-break:break-word; font-weight:500; line-height:1.3;">
                        üìú ${data.nome}
                    </span>
                </div>
                ${goToBtn}
            `;

            const contextDiv = document.createElement('div');
            contextDiv.className = 'reference-context';
            // Mostra a descri√ß√£o do texto b√≠blico se existir
            contextDiv.innerHTML = `<p>${data.descricao || 'Sem anota√ß√µes gerais para este texto.'}</p>`;
            
            details.appendChild(summary);
            details.appendChild(contextDiv);
            listElement.appendChild(details);
        });

    } catch (error) {
        console.error("Erro ao carregar vers√≠culos do marcador:", error);
        listElement.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao carregar refer√™ncias da base de dados.</li>';
    }
}

function updateAddButtonState(visible, yellowMode = false) {
    const btn = document.getElementById('add-item-btn');
    if (!btn) return;

    if (visible) {
        btn.style.display = 'flex';
        if (yellowMode) {
            btn.classList.add('yellow-mode');
        } else {
            btn.classList.remove('yellow-mode');
        }
    } else {
        btn.style.display = 'none';
    }
}

// Fun√ß√£o para varrer o editor e descobrir quais cores de destaque est√£o a ser usadas
function extractUsedColorsFromEditor() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return [];

    // Procura todos os elementos que t√™m o atributo data-highlight
    const coloredElements = editor.querySelectorAll('[data-highlight]');
    const colorsSet = new Set();

    coloredElements.forEach(el => {
        const color = el.getAttribute('data-highlight');
        if (color) {
            // Guardamos sempre em mai√∫sculas para evitar erros de pesquisa (#fff vs #FFF)
            colorsSet.add(color.toUpperCase());
        }
    });

    return Array.from(colorsSet);
}

// ============================================================
// PROTE√á√ÉO DE LIMITES: ESCAPA DE ENTIDADES (PERSONAGENS, TAGS, LINKS)
// ============================================================
function handleBoundaryProtection(event) {
    const selection = window.getSelection();
    if (!selection.rangeCount || !selection.isCollapsed) return;

    const range = selection.getRangeAt(0);
    const currentNode = range.startContainer;
    const offset = range.startOffset;

    // 1. Identificar se o cursor toca numa entidade protegida
    // Adicion√°mos .superlink-dotted √† lista
    let styledEl = currentNode.nodeType === 3 ? currentNode.parentElement : currentNode;
    styledEl = styledEl.closest('.entity-link, .tag, a[data-anexo-id], .idea-span, .superlink-dotted');

    if (!styledEl) return;

    // 2. Teclas de escrita (letras, n√∫meros, espa√ßo, enter)
    // Ignora setas, shift, ctrl, etc.
    if (event.key.length !== 1 && event.key !== 'Enter') return;

    // --- L√ìGICA DE POSI√á√ÉO ---
    const isAtStart = (offset === 0);
    const isAtEnd = (currentNode.nodeType === 3 && offset === currentNode.textContent.length);

    if (isAtStart || isAtEnd) {
        // Previne a escrita DENTRO do span
        // Se n√£o prevenirmos, o browser expande o span
        
        // Se for Enter, deixa o browser lidar (j√° temos outra prote√ß√£o para Enter)
        if (event.key === 'Enter') return;

        // Para escrita normal (Espa√ßo, Letras):
        
        const invisibleBridge = document.createTextNode('\u200B'); // Zero-Width Space (Ponte Invis√≠vel)
        const parent = styledEl.parentNode;

        if (isAtStart) {
            // Insere ANTES do elemento
            parent.insertBefore(invisibleBridge, styledEl);
        } else {
            // Insere DEPOIS do elemento
            if (styledEl.nextSibling) {
                parent.insertBefore(invisibleBridge, styledEl.nextSibling);
            } else {
                parent.appendChild(invisibleBridge);
            }
        }

        // Move o cursor para a ponte invis√≠vel (FORA do link)
        const newRange = document.createRange();
        
        // Se inserimos texto, o cursor deve ficar DEPOIS do caractere invis√≠vel
        newRange.setStart(invisibleBridge, 1); 
        newRange.collapse(true);
        
        selection.removeAllRanges();
        selection.addRange(newRange);
        
        // IMPORTANTE: N√£o fazemos event.preventDefault() aqui.
        // Deixamos a tecla ser escrita, mas agora ela vai cair no n√≥ de texto da ponte,
        // que est√° fora do span colorido/picotado.
    }
}


// --- FUN√á√ïES TORNADAS GLOBAIS PARA O ONCLICK FUNCIONAR ---
window.addSmallField = function(container, label, value = '') {
    const inp = document.createElement('input');
    inp.className = 'codex-input';
    inp.style.width = '45px';
    inp.placeholder = label;
    inp.value = value;
    // Insere antes do bot√£o +
    container.insertBefore(inp, container.lastChild);
};

window.toggleManual = function(btn, type, val = '') {
    const row = btn.closest('.codex-row');
    const area = row.querySelector('.manual-inputs-area');
    
    // Se j√° estiver ativo, removemos
    if (btn.classList.contains('active')) {
        const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : '.manual-time-group');
        const el = area.querySelector(selector)?.closest('.manual-field-group');
        if (el) el.remove();
        btn.classList.remove('active');
        return;
    }

    btn.classList.add('active');

    const group = document.createElement('div');
    group.className = 'manual-field-group';

    if (type === 'A') {
        group.innerHTML = `<input type="text" class="codex-input-manual manual-year" placeholder="Ano" value="${val}" style="width: 45px;">`;
    } 
    else if (type === 'M') {
        group.innerHTML = `
            <select class="codex-input-manual manual-month" style="cursor:pointer;">
                <option value="">M√™s...</option>
                ${MESES_LISTA.map(m => `<option value="${m}" ${val===m?'selected':''}>${m}</option>`).join('')}
            </select>`;
    } 
 else if (type === 'T') {
        const t = val ? val.split(':') : ['', '', ''];
        group.classList.add('manual-time-group');
        group.innerHTML = `
            <input type="text" class="codex-input-manual h-input" 
                   placeholder="00" maxlength="2" value="${t[0]}" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 2) this.nextElementSibling?.focus();"
                   style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual m-input" 
                   placeholder="00" maxlength="2" value="${t[1]}" 
                  oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 2) this.nextElementSibling?.focus();"
                   style="width:20px; text-align:center;">:
            <input type="text" class="codex-input-manual s-input" 
                   placeholder="00" maxlength="2" value="${t[2]}" 
                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                   style="width:20px; text-align:center;">
        `;
    }

    else if (type === 'C') {
    group.innerHTML = `<input type="text" class="codex-input-manual manual-chapter" placeholder="Cap." value="${val}" style="width: 45px;">`;
}

// E atualize a linha do seletor de remo√ß√£o no in√≠cio da fun√ß√£o para incluir o cap√≠tulo:
const selector = type === 'A' ? '.manual-year' : (type === 'M' ? '.manual-month' : (type === 'C' ? '.manual-chapter' : '.manual-time-group'));

    // Adiciona o bot√£o de fechar no final da p√≠lula (como parte do flex)
    group.innerHTML += `<button class="btn-close-manual" onclick="window.removeManualField(this, '${type}')">√ó</button>`;
    area.appendChild(group);
};

window.removeCodexRow = async function(btn) {
    const row = btn.closest('.codex-row');
    const firestoreId = row.getAttribute('data-firestore-id');
    const confirmModal = document.getElementById('confirm-modal');

    // --- CORRE√á√ÉO DE SOBREPOSI√á√ÉO ---
    if (confirmModal) {
        // Define um valor absurdamente alto para passar √† frente do Codex
        confirmModal.style.setProperty('z-index', '999999', 'important');
    }

    const confirmed = await showConfirmation(
        "Eliminar Permanente?", 
        "Deseja remover esta refer√™ncia? Ela ser√° apagada permanentemente da base de dados agora."
    );

    if (confirmed) {
        // 1. ELIMINA√á√ÉO NO FIREBASE
        if (firestoreId) {
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                await deleteDoc(doc(db, 'codex', firestoreId));
                console.log("üî• Documento apagado com sucesso.");
            } catch (e) {
                console.error("‚ùå Erro ao apagar no Firebase:", e);
                alert("Erro ao apagar no servidor.");
                return; // Para aqui se houver erro no banco
            }
        }

        // 2. ELIMINA√á√ÉO NO ECR√É (Anima√ß√£o de sa√≠da)
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(30px)';
        
        setTimeout(() => {
            row.remove();
            saveNote(true); // Atualiza a nota principal
        }, 300);
    }

    if (confirmModal) confirmModal.style.zIndex = "";
};

window.removeManualField = function(closeBtn, type) {
    const row = closeBtn.closest('.codex-row');
    const fieldGroup = closeBtn.closest('.manual-field-group');
    
    // Encontra o bot√£o (A, M ou T) correspondente e desativa a cor azul
    const toggleBtn = row.querySelector(`button[onclick*="'${type}'"]`);
    if (toggleBtn) toggleBtn.classList.remove('active');
    
    fieldGroup.remove();
};

window.openBoxLinkManager = async function(wrapper) {
    // 1. SEGURAN√áA DE ID
    if (!wrapper.id || wrapper.id.trim() === "") {
        const prefix = wrapper.classList.contains('redator-wrapper') ? 'red' : 'mn';
        wrapper.id = `${prefix}_${Date.now()}`;
    }
    const currentBoxId = wrapper.id;
    console.group(`üöÄ [GESTOR LINKS] A abrir caixa: ${currentBoxId}`);

    const modal = document.getElementById('link-modal');
    if (!modal) return console.error("Modal n√£o encontrado");

    // ============================================================
    // 1. LIMPEZA DE ESTADO GLOBAL
    // ============================================================
    window.selectedCategoriesForBox = []; 
    window.tempAssociations = [];
    
    const searchInput = document.getElementById('category-search-input');
    const searchResults = document.getElementById('category-search-results');
    if (searchInput) searchInput.value = "";
    if (searchResults) searchResults.innerHTML = "";

    // ============================================================
    // 2. CONFIGURA√á√ÉO VISUAL DO MODAL
    // ============================================================
    document.body.appendChild(modal); 
    modal.style.cssText = `display: flex !important; z-index: 2147483647 !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; top: 0; left: 0; width: 100vw; height: 100dvh !important; background: rgba(0, 0, 0, 0.9) !important; justify-content: center !important; align-items: center !important;`;

    // --- MANUTEN√á√ÉO DA ABA ASSOCIAR (N√ÉO REMOVER) ---
    const tabHeader = document.getElementById('box-link-tabs');
    
    // Verifica se o bot√£o "Associar" j√° existe, se n√£o, cria-o
    if (!tabHeader.querySelector('[data-box-tab="associar"]')) {
        const assocTabBtn = document.createElement('button');
        assocTabBtn.dataset.boxTab = 'associar';
        assocTabBtn.textContent = 'Associar';
        tabHeader.appendChild(assocTabBtn);

        const assocContent = document.createElement('div');
        assocContent.id = 'box-content-associar';
        assocContent.className = 'box-tab-content';
        assocContent.style.display = 'none';
        
        assocContent.innerHTML = `
            <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px; margin-top: 15px;">
                <label style="font-size:0.8em; color:var(--text-muted-color);">Associar com outra Caixa (Colar ID)</label>
                <div style="display: flex; gap: 0; margin-top: 5px; align-items: stretch;">
                    <input type="text" id="assoc-search-id" class="redator-input" placeholder="mn_12345..." 
                           style="flex:1; border:1px solid var(--border-color); border-right: none; border-radius: 4px 0 0 4px; padding:0 12px; height: 40px; box-sizing: border-box; background-color: var(--bg-color);">
                    <button class="modal-btn primary" id="btn-verify-assoc" 
                            style="padding: 0 20px; height: 40px; display:flex; align-items:center; justify-content:center; box-sizing: border-box; border-radius: 0 4px 4px 0;">üîç</button>
                </div>
                <div id="assoc-search-result" style="margin-top: 10px; display:none;"></div>
            </div>
            <label style="font-size:0.8em; color:var(--text-muted-color); font-weight:bold; text-transform:uppercase;">Caixas Associadas:</label>
            <div id="assoc-list-container" style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
        `;
        
        const catContent = document.getElementById('box-content-categories');
        if (catContent) catContent.after(assocContent);
    }
    // ----------------------------------------------------

    // ============================================================
    // 3. CARREGAR DADOS DO HTML DA CAIXA
    // ============================================================
    let currentData = {};
    const rawAttr = wrapper.getAttribute('data-box-links');
    try {
        currentData = JSON.parse(rawAttr || '{}');
    } catch (e) { currentData = {}; }

    // T√≠tulo e URLs
    document.getElementById('link-title-input').value = currentData.title || "";
    const urlsContainer = document.getElementById('link-urls-container');
    if(urlsContainer) urlsContainer.innerHTML = '';
    const urls = currentData.urls ? Object.values(currentData.urls) : [];
    if (urls.length > 0) urls.forEach(url => window.addUrlField(url));
    else window.addUrlField(); 

    // Codex
    const codexContainer = document.getElementById('codex-rows-container');
    if(codexContainer) codexContainer.innerHTML = '';
    if (currentData.codex && currentData.codex.length > 0) {
        currentData.codex.forEach(item => window.createCodexRow(item));
    } else { 
        window.createCodexRow(); 
    }

    // Associa√ß√µes
    window.tempAssociations = currentData.associations || [];
    if (typeof window.renderExistingAssociationsList === 'function') window.renderExistingAssociationsList();

    // ============================================================
    // 4. CARREGAR CATEGORIAS
    // ============================================================
    const savedCategories = Array.isArray(currentData.categories) ? currentData.categories : [];
    const allKnownEntities = (typeof allEntities !== 'undefined') ? Object.values(allEntities).flat() : [];

    window.selectedCategoriesForBox = savedCategories.map(savedCat => {
        const freshEntity = allKnownEntities.find(e => e.id === savedCat.id);
        return freshEntity 
            ? { id: savedCat.id, name: freshEntity.nome, type: freshEntity.tipo || savedCat.type } 
            : savedCat;
    });

    // Renderiza a lista visualmente
    setTimeout(() => window.renderAttachedCategories(), 50);

    // ============================================================
    // 5. GEST√ÉO DE ABAS (CORRIGIDO: EVENT DELEGATION)
    // ============================================================
    // Clonamos o CONTAINER das abas (n√£o os bot√µes) para limpar listeners velhos
    const newTabHeader = tabHeader.cloneNode(true);
    tabHeader.parentNode.replaceChild(newTabHeader, tabHeader);

    // Adiciona um listener √∫nico ao PAI
    newTabHeader.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return; // Se clicou no vazio entre bot√µes, ignora
        
        e.preventDefault();

        console.log(`üîò Aba clicada: ${btn.dataset.boxTab}`);

        // 1. Atualiza visual dos bot√µes
        newTabHeader.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 2. Esconde todos os conte√∫dos
        document.querySelectorAll('.box-tab-content').forEach(div => div.style.display = 'none');
        
        // 3. Mostra o conte√∫do correto
        const target = btn.dataset.boxTab;
        const targetContentId = `box-content-${target === 'refs' ? 'refs' : target === 'codex' ? 'codex' : target === 'categories' ? 'categories' : 'associar'}`;
        
        const contentDiv = document.getElementById(targetContentId);
        if (contentDiv) {
            contentDiv.style.display = 'block';
            console.log(`‚úÖ Conte√∫do ${targetContentId} vis√≠vel.`);
            
            // Se for Categorias, for√ßa renderiza√ß√£o
            if (target === 'categories') {
                window.renderAttachedCategories();
                // Foca na pesquisa
                setTimeout(() => document.getElementById('category-search-input')?.focus(), 50);
            }
        } else {
            console.error(`‚ùå Erro: ID ${targetContentId} n√£o encontrado!`);
        }
    });

    // Ativa a aba inicial (Refer√™ncias) via simula√ß√£o de clique
    const defaultTab = newTabHeader.querySelector('[data-box-tab="refs"]');
    if(defaultTab) {
        // Simula o estado visual inicial sem disparar o evento completo para ser mais r√°pido
        newTabHeader.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        defaultTab.classList.add('active');
        document.querySelectorAll('.box-tab-content').forEach(div => div.style.display = 'none');
        const refsContent = document.getElementById('box-content-refs');
        if(refsContent) refsContent.style.display = 'block';
    }

    // ============================================================
    // 6. BOT√ÉO GRAVAR
    // ============================================================
    const saveBtn = document.getElementById('link-save-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

     // 2. Configurar Bot√£o REMOVER (Limpar Tudo)
    const removeBtn = document.getElementById('link-remove-btn');
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);

    // 3. Configurar Bot√£o + ADICIONAR URL (CORRIGIDO)
    const addUrlBtn = document.getElementById('add-url-btn');
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    
    newAddUrlBtn.onclick = (e) => { 
        e.preventDefault(); 
        window.addUrlField(); // Chama a fun√ß√£o global que cria o input
    };

    // 4. Configurar Bot√£o + CODEX (CORRIGIDO ANTERIORMENTE)
    const addCodexBtn = document.getElementById('add-codex-row-btn');
    if (addCodexBtn) {
        const newAddCodexBtn = addCodexBtn.cloneNode(true);
        addCodexBtn.parentNode.replaceChild(newAddCodexBtn, addCodexBtn);
        newAddCodexBtn.onclick = (e) => { 
            e.preventDefault(); 
            window.createCodexRow(); 
        };
    }

    newSaveBtn.onclick = async () => {
        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A gravar...";
        
        try {
            const titleInput = document.getElementById('link-title-input');
            const urlsToSave = {}; 
            const urlsContainer = document.getElementById('link-urls-container');
            if(urlsContainer) {
                urlsContainer.querySelectorAll('input').forEach((inp, i) => {
                    if(inp.value.trim()) {
                        let val = inp.value.trim();
                        if(!val.startsWith('http')) val = 'https://' + val;
                        urlsToSave[`url_${Date.now()}_${i}`] = val;
                    }
                });
            }

            const codexToSave = []; 
            modal.querySelectorAll('.codex-row').forEach(row => {
                 if(typeof getCodexDataFromRow === 'function') {
                     const rowData = getCodexDataFromRow(row);
                     if (rowData.serie || rowData.manualYear || rowData.capitulo) {
                         const originalId = row.getAttribute('data-firestore-id');
                         if(originalId) rowData.id = originalId;
                         codexToSave.push(rowData);
                     }
                 }
            });

            // LER CATEGORIAS DA MEM√ìRIA GLOBAL
            const categoriesToSave = window.selectedCategoriesForBox || [];
            console.log("üíæ A gravar categorias:", categoriesToSave);

            const finalJson = { 
                title: titleInput.value.trim(), 
                urls: urlsToSave, 
                codex: codexToSave, 
                categories: categoriesToSave, 
                associations: window.tempAssociations || [] 
            };
            
            wrapper.setAttribute('data-box-links', JSON.stringify(finalJson));
            
            if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(wrapper);
            if (categoriesToSave.length > 0 && typeof syncCategoriesToFirestore === 'function') await syncCategoriesToFirestore(categoriesToSave);
            
            if (window.tempAssociations && window.tempAssociations.length > 0) {
                 if(typeof window.updateRemoteAssociations === 'function') {
                     await window.updateRemoteAssociations(currentBoxId, window.tempAssociations);
                 }
            }

            const isAquarium = document.getElementById('aquarium-environment').style.display !== 'none';
            if (isAquarium) {
                if (typeof window.saveAquariumState === 'function') await window.saveAquariumState();
            } else {
                if (typeof saveNote === 'function') await saveNote(true);
            }

            modal.style.display = 'none';

        } catch (err) {
            console.error("Erro gravar:", err);
            alert("Erro ao gravar.");
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
            console.groupEnd();
        }
    };
};


window.movePanelLink = async function(index, direction) {
    // index: posi√ß√£o atual | direction: -1 (subir) ou 1 (descer)
    const targetIndex = index + direction;
    
    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) return;

        let links = docSnap.data().panelLinks || [];
        
        // Verifica se o movimento √© poss√≠vel
        if (targetIndex < 0 || targetIndex >= links.length) return;

        // TROCA DE POSI√á√ÉO (Destructuring swap)
        [links[index], links[targetIndex]] = [links[targetIndex], links[index]];

        // Grava o array inteiro novamente na ordem certa
        await updateDoc(docRef, { panelLinks: links });
        
        // Atualiza a visualiza√ß√£o
        renderPanelLinks();

    } catch (e) {
        console.error("Erro ao mover link no painel:", e);
    }
};



// --- L√ìGICA DO DOSSI√â ---

// --- VARI√ÅVEIS DE ESTADO DO DOSSI√â (Expostas para o m√≥dulo) ---
// Definimos como window. para que o HTML consiga ler e alterar
window.isDossieEditMode = false;
window.activeMicaId = null;

// 1. Tornar a fun√ß√£o de renderiza√ß√£o global
window.renderDossie = async function() {
    const container = document.getElementById('dossie-list-container');
    const titleEl = document.getElementById('dossie-view-title');
    const editBtn = document.getElementById('toggle-dossie-edit-btn');
    const editActions = document.getElementById('dossie-edit-actions');
    const backBtn = document.getElementById('mica-back-btn');
    const addBtn = document.getElementById('mica-add-content-btn');
    const bibleBtn = document.getElementById('mica-add-bible-btn');

    if (!container) return;

    // --- 1. SEGURAN√áA E LOADING ---
    const thisVersion = ++currentDossieVersion;

    if (container.innerHTML === "") {
        container.innerHTML = `<div class="spinner-container" style="margin-top: 50px; text-align:center;"><div class="spinner"></div></div>`;
    }
    
    container.innerHTML = ''; // Limpeza imediata

    if (!activeReferenceEntity || !activeReferenceEntity.id) {
        container.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Selecione um t√≥pico ou vers√≠culo.</p>';
        return;
    }

    // Mostrar Spinner centralizado
    container.innerHTML = `
        <div class="spinner-container" style="margin-top: 50px; display: flex; flex-direction: column; align-items: center;">
            <div class="spinner"></div>
            <span style="font-style: italic; font-size: 0.9em; margin-top:10px; color: var(--text-muted-color);">A organizar Dossi√©...</span>
        </div>`;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docSnap = await getDoc(doc(db, collectionName, activeReferenceEntity.id));
        
        // Aborta se o utilizador j√° mudou de contexto
        if (thisVersion !== currentDossieVersion) return;

        const dossieData = docSnap.exists() ? (docSnap.data().dossie || []) : [];
        editBtn.textContent = window.isDossieEditMode ? "Salvar" : "Editar";
        
        if (window.activeMicaId) {
            // ==========================================
            // MODO: CONTE√öDO DA MICA (CARDS)
            // ==========================================
            const mica = dossieData.find(m => m.id === window.activeMicaId);
            if (!mica) { window.activeMicaId = null; window.renderDossie(); return; }

            titleEl.textContent = mica.name;
            backBtn.style.display = 'block';
            addBtn.style.display = 'block';
            bibleBtn.style.display = 'block';
            editBtn.style.display = 'none'; 
            editActions.style.display = 'none';

            if (!mica.items || mica.items.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; font-style:italic; margin-top:40px;">Mica vazia. Clique em +Add ou +B√≠blia.</p>';
            } else {
                const tempFragment = document.createDocumentFragment();

             for (let idx = 0; idx < mica.items.length; idx++) {
    const item = mica.items[idx];
    const card = document.createElement('div');
    card.className = 'board-card type-ref';
    card.style.position = 'relative';

    // >>>>>>>>> A CORRE√á√ÉO EST√Å NESTAS DUAS LINHAS: <<<<<<<<<
    // Guardar os dados no pr√≥prio elemento para o bot√£o ‚á± os conseguir ler
    card.dataset.snippet = item.snippet; // O HTML codificado
    card.dataset.noteName = item.noteName || "Nota";
    // >>>>>>>>>>>>>>>>>>>>>>>>>><<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

    let rawSnippet = decodeURIComponent(item.snippet || '');
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = rawSnippet;

    let icon = "üì¶"; let label = "Ref"; let color = "#95a5a6";
    let isBible = rawSnippet.includes('bible-card-mica') || item.noteId === 'bible_internal';
    let bodyText = ""; let titleText = "";

    // L√≥gica de salto: Se tem nota f√≠sica e n√£o √© b√≠blia interna
    const isJumpable = item.noteId && item.noteId !== 'bible_internal';

    if (isBible) {
        icon = "üìñ"; 
        color = "#5d4037"; 
        label = item.title || "B√≠blia";
        titleText = item.noteName;
        // Tentativa de carregar texto b√≠blico (mant√©m l√≥gica existente)
        try {
            // Nota: numa aplica√ß√£o real, isto devia ser async, mas para renderiza√ß√£o r√°pida usamos o que temos
            // ou deixamos vazio para carregar depois. Aqui assumimos texto simples.
            const contentDiv = tempDiv.querySelector('.bible-card-mica'); 
            bodyText = contentDiv ? contentDiv.textContent : "Texto b√≠blico...";
        } catch(e) { bodyText = "Ver B√≠blia..."; }
    } else {
        // Notas normais (Subnotas, Quest√µes, etc)
        if (rawSnippet.includes('question-mode')) { icon = "üìó"; label = "Quest√£o"; color = "#2ecc71"; }
        else if (rawSnippet.includes('free-mode')) { icon = "üìô"; label = "Contentor"; color = "#e67e22"; }
        else if (rawSnippet.includes('toggle-section')) { icon = "‚òÇ"; label = "Sec√ß√£o"; color = "#9b59b6"; }
        else if (rawSnippet.includes('idea-span')) { icon = "üí°"; label = "Ideia"; color = "#e74c3c"; }
        else if (rawSnippet.includes('mini-note-wrapper')) { icon = "üìò"; label = "SubNota"; color = "#3498db"; }

        // Extra√ß√£o de T√≠tulo
        const titleInput = tempDiv.querySelector('.mini-note-title-input') || tempDiv.querySelector('h2');
        titleText = titleInput ? (titleInput.textContent || titleInput.value || titleInput.getAttribute('value')) : "Sem T√≠tulo";

        // Extra√ß√£o de Corpo
        const contentDiv = tempDiv.querySelector('.mini-note-content') || tempDiv.querySelector('.toggle-content') || tempDiv;
        bodyText = contentDiv ? contentDiv.innerText.replace(/\s+/g, ' ').trim() : "";
        if (bodyText.length > 400) bodyText = bodyText.substring(0, 400) + "...";
    }

    card.style.borderLeft = `4px solid ${color}`;
    
    // HTML INTERNO (Com o bot√£o ‚á±)
    card.innerHTML = `
        <!-- CONTROLOS: POPUP ‚á±, SETAS ‚ñ≤ ‚ñº E FECHAR X -->
        <div style="position:absolute; top:8px; right:8px; display:flex; gap:3px; z-index:20; background:var(--panel-color); border-radius:5px; padding:2px;">
            
            <!-- BOT√ÉO POPUP CORRIGIDO -->
            <button class="mica-nav-btn" title="Abrir em Janela" 
                    onclick="event.stopPropagation(); window.openCardPopup(this)" 
                    style="font-size: 11px;">
                ‚á±
            </button>
            
            <!-- Separador -->
            <div style="width:1px; background:var(--border-color); margin:0 2px;"></div>

            <button class="mica-nav-btn" onclick="window.moveMicaItem(${idx}, -1); event.stopPropagation();">‚ñ≤</button>
            <button class="mica-nav-btn" onclick="window.moveMicaItem(${idx}, 1); event.stopPropagation();">‚ñº</button>
            <button class="mica-nav-btn" onclick="window.removeItemFromMica(${idx}); event.stopPropagation();" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='var(--text-muted-color)'">√ó</button>
        </div>

        <div class="ref-card-content ${isBible ? 'bible-clickable-area' : ''}" 
             ${isBible ? `onclick="this.parentElement.classList.toggle('bible-open')"` : ""}>
            <div style="padding-left: 5px; margin-bottom: 2px;">
                <div style="font-size:0.72em; font-weight:bold; color:${color}; text-transform:uppercase; margin-bottom:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">
                    ${icon} ${label}
                </div>
                <div class="ref-title-text" 
                     style="font-weight:bold; font-size:0.95em; color:var(--text-color); padding-right:85px; ${isJumpable ? 'cursor:pointer;' : ''}"
                     onclick="${isJumpable ? `window.openNoteFromBoard('${item.noteId}', '${encodeURIComponent(titleText)}'); event.stopPropagation();` : ''}"
                     onmouseover="${isJumpable ? "this.style.textDecoration='underline'" : ""}"
                     onmouseout="this.style.textDecoration='none'">
                    ${titleText}
                </div>
            </div>
            
            ${isBible ? 
                `<div class="bible-collapsible-content">${bodyText}</div>` : 
                `<div class="post-view-content" style="font-size:0.9em; color:var(--text-muted-color); padding-left: 8px; line-height:1.4; margin-top:8px; user-select:text;">${bodyText}</div>`
            }
        </div>`;
    
    tempFragment.appendChild(card);
}
                
                if (thisVersion === currentDossieVersion) {
                    container.innerHTML = ''; 
                    container.appendChild(tempFragment);
                }
            }
        } else {
            // ==========================================
            // MODO: LISTA DE MICAS (PASTAS)
            // ==========================================
            titleEl.textContent = "Micas";
            backBtn.style.display = 'none';
            addBtn.style.display = 'none';
            bibleBtn.style.display = 'none';
            editBtn.style.display = 'block';
            editActions.style.display = (window.isDossieEditMode) ? 'flex' : 'none';

            if (dossieData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Nenhuma mica criada.</p>';
            } else {
                const listFragment = document.createDocumentFragment();
                dossieData.forEach((mica) => {
                    const div = document.createElement('div');
div.className = 'mica-card';
div.style.borderLeft = `6px solid ${mica.color || '#95a5a6'}`;

// Mantemos o efeito visual de transi√ß√£o suave
div.style.transition = "transform 0.1s, opacity 0.1s";
div.style.padding = "10px 15px"; // Ajuste fino direto aqui para garantir que fique elegante

div.innerHTML = `
    <div style="pointer-events: none;"> 
        <strong style="color:var(--text-color); display:block; font-size: 1.05em;">${mica.name}</strong>
        ${mica.description ? `<p style="margin:2px 0 0 0; font-size:0.82em; color:var(--text-muted-color);">${mica.description}</p>` : ''}
    </div>
    ${window.isDossieEditMode ? `
       <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:8px; border-top:1px solid var(--border-color); padding-top:8px;">
        
        <!-- NOVO BOT√ÉO DE RENOMEAR (√Ä ESQUERDA) -->
        <button onclick="event.stopPropagation(); window.renameMica('${mica.id}', '${mica.name}')" style="font-size:14px; cursor:pointer; background:none; border:none; opacity:0.8;" title="Renomear">‚úèÔ∏è</button>
        
        <!-- BOT√ïES EXISTENTES -->
        <button onclick="event.stopPropagation(); window.changeMicaColor(event, '${mica.id}')" style="font-size:14px; cursor:pointer; background:none; border:none;" title="Mudar Cor">üé®</button>
        <button onclick="event.stopPropagation(); window.moveMica('${mica.id}', -1)" style="font-size:14px; cursor:pointer; background:none; border:none;">‚Üë</button>
        <button onclick="event.stopPropagation(); window.moveMica('${mica.id}', 1)" style="font-size:14px; cursor:pointer; background:none; border:none;">‚Üì</button>
        <button onclick="event.stopPropagation(); window.deleteMica('${mica.id}')" style="color:#e74c3c; font-size:14px; cursor:pointer; background:none; border:none;">üóëÔ∏è</button>
    </div>
    ` : ''}`;

                   // --- O SEGREDO DA ABERTURA IMEDIATA ---
    // Evento de clique para abrir
div.onclick = (e) => {
    if (e.target.closest('button')) return;
    
    // Efeito visual de "apertar"
    div.style.transform = "scale(0.97)";
    div.style.opacity = "0.7";

    window.activeMicaId = mica.id;
    
    // Abertura r√°pida
    setTimeout(() => {
        window.renderDossie();
    }, 50);
};

    listFragment.appendChild(div);
});
                if (thisVersion === currentDossieVersion) {
                    container.innerHTML = '';
                    container.appendChild(listFragment);
                }
            }
        }
    } catch (error) {
        if (thisVersion === currentDossieVersion) {
            console.error("Erro no Dossi√©:", error);
            container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Erro ao carregar dados.</p>';
        }
    }
};

// 2. Outras fun√ß√µes expostas globalmente
window.moveMica = async function(id, dir) {
    const col = getCollectionFromType(activeReferenceEntity.type);
    const docRef = doc(db, col, activeReferenceEntity.id);
    const snap = await getDoc(docRef);
    let dossie = snap.data().dossie || [];
    const idx = dossie.findIndex(m => m.id === id);
    const newIdx = idx + dir;
    if (newIdx >= 0 && newIdx < dossie.length) {
        [dossie[idx], dossie[newIdx]] = [dossie[newIdx], dossie[idx]];
        await updateDoc(docRef, { dossie });
        window.renderDossie();
    }
};

window.deleteMica = async function(id) {
    // AQUI EST√Å A MUDAN√áA: Usa o popup personalizado em vez do nativo
    const confirmed = await showConfirmation(
        "Apagar Mica?", 
        "Tem a certeza que deseja apagar esta Mica e todo o seu conte√∫do? Esta a√ß√£o √© irrevers√≠vel."
    );

    if (!confirmed) return; // Se cancelar, p√°ra aqui

    try {
        const col = getCollectionFromType(activeReferenceEntity.type);
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const docRef = doc(db, col, activeReferenceEntity.id);
        const snap = await getDoc(docRef);
        
        // Filtra para remover a mica com o ID selecionado
        const dossie = (snap.data().dossie || []).filter(m => m.id !== id);
        
        await updateDoc(docRef, { dossie });
        
        // Atualiza a vista
        window.renderDossie();
    } catch (e) {
        console.error("Erro ao apagar mica:", e);
        alert("Erro ao apagar.");
    }
};

window.removeItemFromMica = async function(itemIdx) {
    // Pedimos confirma√ß√£o apenas para evitar cliques acidentais
    if (!confirm("Remover esta cita√ß√£o do Dossi√©?")) return;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const snap = await getDoc(docRef);

        if (!snap.exists()) return;

        let dossie = snap.data().dossie || [];
        // Encontra a mica onde estamos atualmente
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica && mica.items) {
            // Remove o item pelo √≠ndice
            mica.items.splice(itemIdx, 1);

            // Grava o dossie atualizado de volta no documento da entidade
            await updateDoc(docRef, { dossie: dossie });
            
            // Recarrega a interface
            window.renderDossie();
        }
    } catch (e) {
        console.error("Erro ao remover item da mica:", e);
        alert("Erro ao remover item.");
    }
};

// 3. Listeners de bot√µes (IDs fixos)
document.getElementById('add-mica-btn').onclick = async () => {
    // 1. Pedir o nome da Mica (Usa o teu modal de input personalizado)
    const result = await showCustomInput("Nova Mica", "Ex: Promessas, Profecias...");
    
    if (result && result.name) {
        const { id, type, name } = activeReferenceEntity;
        const collectionName = getCollectionFromType(type);
        
        // Refer√™ncia para o documento (pode ser o ID hexadecimal ou o nome do vers√≠culo)
        let docRef = doc(db, collectionName, id);
        let docSnap = await getDoc(docRef);

        // --- AJUSTE PARA VERS√çCULOS NOVOS ---
        // Se o documento n√£o existe (comum em vers√≠culos acabados de abrir), criamos agora
        if (!docSnap.exists()) {
            // Se for vers√≠culo, o 'id' costuma ser o pr√≥prio nome (ex: "Jo√£o 3:16")
            // Criamos o registo privado para o utilizador poder ter o seu Dossi√™/Micas
            await setDoc(docRef, {
                nome: name,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp(),
                dossie: [] 
            }, { merge: true });
            
            // Recarrega o snapshot ap√≥s criar
            docSnap = await getDoc(docRef);
        }

        const dossie = docSnap.data().dossie || [];
        
        // 2. Adicionar a nova Mica ao array
        dossie.push({
            id: 'mica_' + Date.now(),
            name: result.name,
            description: result.description || '',
            color: '#95a5a6', // Cinza padr√£o
            items: []
        });
        
        // 3. Gravar de volta no Firebase
        await updateDoc(docRef, { dossie: dossie });
        
        // 4. Feedback visual e fechar teclado
        if (document.activeElement) document.activeElement.blur();
        window.renderDossie();
    }
};

document.getElementById('mica-back-btn').onclick = () => {
    window.activeMicaId = null;
    window.renderDossie();
};

// --- IMPORTANTE: Coloque estas fun√ß√µes no seu script debaixo das l√≥gicas de Mica ---

// ============================================================
// MOTOR DA B√çBLIA PARA O DOSSI√â (MICAS)
// ============================================================

// 1. A√á√ÉO AO CLICAR NO BOT√ÉO "+B√≠blia"
document.getElementById('mica-add-bible-btn').onclick = () => {
    const modal = document.getElementById('mica-bible-modal');
    const bookSelect = document.getElementById('bible-book-select');
    const chapterSelect = document.getElementById('bible-chapter-select');
    const container = document.getElementById('verse-inputs-container');
    const titleInput = document.getElementById('bible-card-title');

    if (!modal) return;

    // For√ßar o modal para o topo do body (evita ficar escondido)
    document.body.appendChild(modal);
    
    titleInput.value = "";
    container.innerHTML = "";
    
    // Preenche livros
    bookSelect.innerHTML = BIBLE_DATA.map(b => `<option value="${b.nome}">${b.nome}</option>`).join('');
    
    const updateVerseLimits = () => {
        const book = BIBLE_DATA.find(b => b.nome === bookSelect.value);
        chapterSelect.innerHTML = Array.from({length: book.caps}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
        container.innerHTML = "";
        window.addMicaVerseRow('single'); // Nome corrigido aqui
    };

    bookSelect.onchange = updateVerseLimits;
    chapterSelect.onchange = () => { 
        container.innerHTML = ""; 
        window.addMicaVerseRow('single'); // Nome corrigido aqui
    };

    // Inicializa os limites
    updateVerseLimits();

    // Ligar bot√µes internos do modal com nomes corrigidos
    document.getElementById('add-single-verse-btn').onclick = (e) => { 
        e.preventDefault(); 
        window.addMicaVerseRow('single'); 
    };
    document.getElementById('add-range-verse-btn').onclick = (e) => { 
        e.preventDefault(); 
        window.addMicaVerseRow('range'); 
    };

    // MOSTRAR MODAL
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";
};

// 2. ATUALIZAR DROPDOWNS (CAP√çTULOS E LIMITES DE VERS√çCULOS)
function updateMicaBibleDropdowns() {
    const bookName = document.getElementById('bible-book-select').value;
    const chapterSelect = document.getElementById('bible-chapter-select');
    const book = BIBLE_DATA.find(b => b.nome === bookName);

    // Se o cap√≠tulo selecionado for maior que o novo livro permite, reseta para 1
    let currentCap = parseInt(chapterSelect.value) || 1;
    if (currentCap > book.caps) currentCap = 1;

    // Atualizar dropdown de cap√≠tulos
    chapterSelect.innerHTML = Array.from({length: book.caps}, (_, i) => 
        `<option value="${i+1}" ${i+1 === currentCap ? 'selected' : ''}>${i+1}</option>`
    ).join('');

    // Sempre que mudar Livro ou Cap√≠tulo, resetamos as linhas de vers√≠culos para evitar erros de limites
    const container = document.getElementById('verse-inputs-container');
    if (container.innerHTML !== "") {
        container.innerHTML = "";
        addVerseRow('single');
    }
}

// 3. ADICIONAR LINHA DE VERS√çCULO (Simples ou Intervalo)
window.addMicaVerseRow = (type) => {
    const container = document.getElementById('verse-inputs-container');
    const bookSelect = document.getElementById('bible-book-select');
    const chapterSelect = document.getElementById('bible-chapter-select');

    // Preparar as op√ß√µes de vers√≠culos
    const book = BIBLE_DATA.find(b => b.nome === bookSelect.value);
    const totalV = book.versiculos[parseInt(chapterSelect.value) - 1] || 50;
    const options = Array.from({length: totalV}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');

    // Pegamos na √∫ltima linha que est√° no container
    const lastRow = container.lastElementChild;

    // --- SE FOR INTERVALO: TRANSFORMAR A LINHA ATUAL SE ELA FOR SIMPLES ---
    if (type === 'range' && lastRow && lastRow.dataset.type === 'single') {
        console.log("üõ†Ô∏è Transformando linha atual em intervalo...");
        lastRow.dataset.type = 'range'; // Muda o estado para intervalo

        const separator = document.createElement('span');
        separator.textContent = '-';
        separator.style.padding = '0 4px';
        separator.style.color = 'var(--text-muted-color)';

        const selectEnd = document.createElement('select');
        selectEnd.className = 'codex-input-modern v-end';
        selectEnd.style.flex = '1';
        selectEnd.innerHTML = options;

        // Inserir ANTES do bot√£o de apagar (o √∫ltimo elemento da linha)
        const delBtn = lastRow.querySelector('button');
        lastRow.insertBefore(separator, delBtn);
        lastRow.insertBefore(selectEnd, delBtn);
        return; 
    }

    // --- CASO CONTR√ÅRIO: CRIAR LINHA NOVA (Normal) ---
    const row = document.createElement('div');
    row.className = 'verse-selection-row';
    row.style.cssText = "display:flex; align-items:center; gap:8px; margin-bottom:8px;";
    row.dataset.type = type;

    if (type === 'single') {
        row.innerHTML = `<select class="codex-input-modern v-start" style="flex:1">${options}</select>`;
    } else {
        row.innerHTML = `
            <select class="codex-input-modern v-start" style="flex:1">${options}</select>
            <span style="color:var(--text-muted-color);">-</span>
            <select class="codex-input-modern v-end" style="flex:1">${options}</select>
        `;
    }

    const delBtn = document.createElement('button');
    delBtn.innerHTML = '√ó';
    delBtn.style.cssText = "background:none; border:none; color:#e74c3c; cursor:pointer; font-size:22px; font-weight:bold; padding:0 5px;";
    delBtn.onclick = () => {
        if (container.querySelectorAll('.verse-selection-row').length > 1) row.remove();
    };

    row.appendChild(delBtn);
    container.appendChild(row);
};

// Ligar bot√µes de + e - do modal
document.getElementById('add-single-verse-btn').onclick = (e) => { e.preventDefault(); addVerseRow('single'); };
document.getElementById('add-range-verse-btn').onclick = (e) => { e.preventDefault(); addVerseRow('range'); };

// 4. GRAVAR: FIREBASE + 4¬™ COLUNA
document.getElementById('confirm-mica-bible-save').onclick = async () => {
    const book = document.getElementById('bible-book-select').value;
    const chapter = document.getElementById('bible-chapter-select').value;
    const title = document.getElementById('bible-card-title').value.trim();
    const rows = document.querySelectorAll('.verse-selection-row');
    const myUid = auth.currentUser.uid;

    let parts = [];
    rows.forEach(r => {
        const s = r.querySelector('.v-start').value;
        if (r.dataset.type === 'range') {
            const e = r.querySelector('.v-end').value;
            parts.push(s === e ? s : (parseInt(s) < parseInt(e) ? `${s}-${e}` : `${e}-${s}`));
        } else parts.push(s);
    });

    const fullName = `${book} ${chapter}:${parts.join(',')}`;

    try {
        // Verifica se j√° existe no Firebase
        const q = query(collection(db, 'textosbiblicos'), where('userId', '==', myUid), where('nome', '==', fullName));
        const snap = await getDocs(q);
        if (snap.empty) {
            await addDoc(collection(db, 'textosbiblicos'), {
                nome: fullName, userId: myUid, createdAt: serverTimestamp(), referencias: {}
            });
        }

        // Adiciona ao Dossi√©
        const col = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, col, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        const dossie = docSnap.data().dossie || [];
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica) {
            const bibleSnippet = `
                <div class="bible-card-mica" style="border-left: 4px solid #9b59b6; padding-left:10px;">
                    ${title ? `<div style="font-weight:bold; color:var(--accent-color); margin-bottom:4px;">${title}</div>` : ''}
                    <div style="font-size: 1.1em; color:var(--text-color);">üìú ${fullName}</div>
                </div>`;
            
            if (!mica.items) mica.items = [];
            
            // =========================================================
            // MUDAN√áA AQUI: UNSHIFT (TOPO) EM VEZ DE PUSH (FIM)
            // =========================================================
            mica.items.unshift({
                noteId: 'bible_internal', 
                noteName: fullName, 
                title: title, 
                snippet: encodeURIComponent(bibleSnippet)
            });

            await updateDoc(docRef, { dossie });
            
            document.getElementById('mica-bible-modal').style.display = 'none';
            window.renderDossie();
            
            // Faz scroll para o topo da lista
            const listContainer = document.getElementById('dossie-list-container');
            if(listContainer) listContainer.scrollTop = 0;
        }
    } catch (e) { console.error(e); alert("Erro ao gravar."); }
};


async function renderUniversalTextSearch(name) {
    const listElement = document.getElementById('references-list');
    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar notas...</span></div>';

    try {
        const q = query(
            collection(db, 'pastas'), 
            where('tipo', '==', 'nota'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid)
        );
        const snapshot = await getDocs(q);
        allCitationsResults = []; // Limpa resultados anteriores

        const wholeWordRegex = new RegExp(`\\b(${escapeRegExp(name)})\\b`, 'i');
        const parser = new DOMParser();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const content = data.conteudo || "";
            let isProtected = (data.passe && data.passe.trim() !== "");
            if (isProtected && !appSettings.searchAnchorsInProtected) return;

            // 1. Verificamos se o nome aparece no texto bruto (para performance)
            // Se n√£o aparecer no texto mas estiver numa categoria, o passo 2 apanha.
            
            // 2. Analisar o HTML para encontrar as caixas
            const docHTML = parser.parseFromString(content, 'text/html');
            const boxes = docHTML.querySelectorAll('.mini-note-wrapper, details.toggle-section, .redator-wrapper, .journal-sign-wrapper, .journal-id-card');
            
            boxes.forEach(box => {
                let match = false;
                let matchType = ""; // Para debug, se necess√°rio

                if (box.classList.contains('statue-card-wrapper')) return; 

                // A. Verifica Texto dentro da caixa
                if (wholeWordRegex.test(box.textContent)) {
                    match = true;
                    matchType = "text";
                }

                // B. Verifica V√≠nculo de Categoria (‚ö°)
                if (!match) {
                    const boxLinksRaw = box.getAttribute('data-box-links');
                    if (boxLinksRaw) {
                        try {
                            const boxData = JSON.parse(boxLinksRaw);
                            if (boxData.categories && Array.isArray(boxData.categories)) {
                                // Verifica match por ID ou por Nome
                                const catMatch = boxData.categories.some(cat => 
                                    (cat.id && cat.id === activeReferenceEntity.id) || 
                                    (cat.name && cat.name.toLowerCase().trim() === name.toLowerCase().trim())
                                );
                                if (catMatch) {
                                    match = true;
                                    matchType = "category";
                                }
                            }
                        } catch (e) { }
                    }
                }

                // Se encontrou (seja por texto ou categoria), adiciona aos resultados
                if (match) {
                    
                    // --- GERA√á√ÉO DO CONTE√öDO VISUAL (CORRIGIDO) ---
                    // Independentemente de como foi encontrado, mostramos sempre o conte√∫do real.
                    
                    let finalSnippet = "";
                    
                    // Se for match de texto direto, podemos usar o highlight inteligente
                    if (matchType === "text") {
                        finalSnippet = generateReferenceContext(box.outerHTML, name);
                    } 
                    // Se for match de categoria, mostramos o conte√∫do da caixa
                    else {
                        // Tenta extrair texto limpo da caixa
                        const contentDiv = box.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content');
                        let rawText = contentDiv ? contentDiv.innerText : box.innerText;
                        
                        // Limpa espa√ßos e limita tamanho
                        rawText = rawText.replace(/\s+/g, ' ').trim();
                        if (rawText.length > 200) rawText = rawText.substring(0, 200) + "...";
                        
                        // Envolve num par√°grafo para consist√™ncia visual
                        finalSnippet = `<p>${rawText || '<em style="color:gray">Caixa sem texto.</em>'}</p>`;
                    }

                    allCitationsResults.push({
                        id: docSnap.id, 
                        boxId: box.id,  
                        name: data.nome,
                        isProtected: isProtected,
                        snippet: finalSnippet,
                        ultimaedicao: data.ultimaedicao?.toMillis() || data.createdAt?.toMillis() || 0
                    });
                }
            });
        });

        allCitationsResults.sort((a, b) => b.ultimaedicao - a.ultimaedicao);
        window.renderCitationsPage(false);

    } catch (e) {
        console.error("Erro na busca universal:", e);
        listElement.innerHTML = '<li>Erro ao carregar cita√ß√µes.</li>';
    }
}


window.renderCitationsPage = function(append = false) {
    const listElement = document.getElementById('references-list');
    if (!listElement) return;

    // 1. Se n√£o for um "Carregar Mais", limpa a lista e reseta o √≠ndice
    if (!append) {
        listElement.innerHTML = '';
        currentCitationsPageIndex = 0;
    }

    // 2. Remove o bot√£o "Mostrar mais" antigo se ele existir para n√£o ficar duplicado
    const oldBtn = document.getElementById('load-more-citations-btn');
    if (oldBtn) oldBtn.remove();

    // 3. Caso n√£o existam resultados
    if (allCitationsResults.length === 0) {
        listElement.innerHTML = '<li style="padding:40px; color:#888; text-align:center; font-style:italic;">Nenhuma cita√ß√£o encontrada neste contexto.</li>';
        return;
    }

    // 4. Configura√ß√£o de Pagina√ß√£o
    const perPage = 10; // Mostra 10 de cada vez
    const start = currentCitationsPageIndex * perPage;
    const end = start + perPage;
    const pageItems = allCitationsResults.slice(start, end);

    // 5. Gerar os itens no DOM
    pageItems.forEach(item => {
        const details = document.createElement('details');
        details.className = 'reference-item';
        
        // Prote√ß√£o contra caracteres especiais para os atributos de clique
        const safeName = encodeURIComponent(item.name);
        const safeSnippet = encodeURIComponent(item.snippet);

        // O cabe√ßalho (Summary) cont√©m os bot√µes e o t√≠tulo
        details.innerHTML = `
            <summary>
                <div class="ref-item-header">
                    <!-- BOT√ÉO + (Adicionar ao Puzzle) -->
                    <button class="add-to-puzzle-btn" title="Adicionar ao Quadro" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.addItemToPuzzle('${item.id}', decodeURIComponent('${safeName}'), decodeURIComponent('${safeSnippet}'))">+</button>
                    
                    <!-- T√çTULO DA NOTA -->
                    <span class="ref-item-title">${item.isProtected ? 'üîí' : 'üìÑ'} ${item.name}</span>
                    
                    <!-- BOT√ÉO ‚ûî (Ir para a Nota com Highlight) -->
                    <button class="go-to-note-btn" 
                            onclick="event.preventDefault(); event.stopPropagation(); window.handleGoToNote('${item.id}')" 
                            title="Ir para esta nota">‚ûî</button>
                </div>
            </summary>
            <!-- CONTE√öDO (Texto ao redor da palavra encontrada) -->
            <div class="reference-context">${item.snippet}</div>
        `;
        listElement.appendChild(details);
    });

    // 6. Criar bot√£o "Mostrar mais" se ainda sobrarem resultados no array global
    if (end < allCitationsResults.length) {
        currentCitationsPageIndex++;
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'load-more-citations-btn';
        loadMoreBtn.style.cssText = "width: 100%; margin: 15px 0; padding: 12px; border: 1px dashed var(--accent-color); color: var(--accent-color); background: none; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 0.9em;";
        loadMoreBtn.textContent = `+ ver mais (${allCitationsResults.length - end} restantes)`;
        
        loadMoreBtn.onclick = () => window.renderCitationsPage(true);
        listElement.appendChild(loadMoreBtn);
    }
};

// --- FUN√á√ÉO DE APOIO PARA O SALTO INTELIGENTE ---
 // --- FUN√á√ÉO DE APOIO PARA O SALTO INTELIGENTE ---
window.handleGoToNote = async function(noteId, targetBoxId = null) {
    // Se n√£o tivermos um termo de pesquisa expl√≠cito, usamos a entidade ativa
    const searchTerm = activeReferenceEntity ? activeReferenceEntity.name : null;

    // 1. No Mobile, fecha o painel de refer√™ncias para focar no Editor
    if (window.innerWidth <= 768) {
        if (typeof hideReferencesPanel === 'function') {
            hideReferencesPanel();
        }
    }

    // 2. Verifica√ß√£o de grava√ß√£o antes de navegar (Prote√ß√£o contra perda de dados)
    navigateWithUnsavedCheck(async () => {
        // Mostra uma mensagem discreta no status
        const statusEl = document.getElementById('save-status-indicator');
        if(statusEl) {
            statusEl.textContent = "A saltar...";
            statusEl.style.opacity = "1";
        }

        try {
            // --- L√ìGICA DE RECONSTRU√á√ÉO DE CAMINHO (Background) ---
            let currentId = null;
            const path = [];
            let safety = 0;

            // Primeiro, pegamos no pai da nota alvo
            // Importante: Aceder ao m√≥dulo Firestore globalmente se n√£o estiver no escopo
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const noteSnap = await getDoc(doc(db, 'pastas', noteId));
            if (noteSnap.exists()) {
                currentId = noteSnap.data().parentId;
            }

            // Sobe na √°rvore de pastas para criar o "rasto" (breadcrumbs)
            while (currentId && safety < 20) {
                const docSnap = await getDoc(doc(db, 'pastas', currentId));
                if (!docSnap.exists()) break;
                const data = docSnap.data();
                // Adiciona ao IN√çCIO do array
                path.unshift({ id: docSnap.id, name: data.nome });
                currentId = data.parentId;
                safety++;
            }

            // --- ATUALIZA√á√ÉO DA √ÅRVORE DE PASTAS ---
            if (currentTab === 'note') {
                // Se j√° estamos na aba Note, atualiza a lista √† esquerda agora
                navigationStack = path;
                // 'true' = mant√©m o editor aberto
                updateNavigationView(true, noteId);
            } else {
                // Se estivermos em "Lists", n√£o mexemos na vista atual.
                // Atualizamos apenas a MEM√ìRIA da aba Note para quando l√° voltarmos.
                noteStackMemory = path;
                console.log("üìÇ Pastas da aba Note organizadas em segundo plano.");
            }

            // 3. ABRIR A NOTA NO EDITOR (Painel Direito)
            // Se tivermos um ID de caixa (targetBoxId), passamos 'null' no searchTerm
            // para evitar que o displayNote fa√ßa scroll para o primeiro texto encontrado.
            // Queremos controlar o scroll manualmente no passo 4.
            await displayNote(noteId, null, targetBoxId ? null : searchTerm);

            // 4. SCROLL CIR√öRGICO PARA A CAIXA ESPEC√çFICA (Se o ID existir)
            if (targetBoxId) {
                // Pequeno delay para garantir que o HTML da nota carregou e renderizou
                setTimeout(() => {
                    const targetEl = document.getElementById(targetBoxId);
                    
                    if (targetEl) {
                        console.log("üéØ Scroll exato para Caixa ID:", targetBoxId);
                        
                        // Rola at√© ao elemento
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Efeito visual de destaque (Flash Azul)
                        targetEl.style.transition = "box-shadow 0.5s, border-color 0.5s";
                        
                        // Guarda borda antiga para restaurar
                        const oldBorderColor = targetEl.style.borderColor;
                        const oldBoxShadow = targetEl.style.boxShadow;
                        
                        // Aplica destaque
                        targetEl.style.boxShadow = "0 0 40px var(--accent-color)";
                        targetEl.style.borderColor = "var(--accent-color)";
                        targetEl.style.zIndex = "10"; // Garante que fica por cima
                        
                        // Remove destaque ap√≥s 1.5s
                        setTimeout(() => { 
                            targetEl.style.boxShadow = oldBoxShadow; 
                            targetEl.style.borderColor = oldBorderColor;
                            targetEl.style.zIndex = "";
                        }, 1500);

                    } else {
                        console.warn("‚ö†Ô∏è Caixa n√£o encontrada no DOM:", targetBoxId);
                        // Fallback: Se n√£o encontrou o ID, tenta scroll pelo texto
                        if (searchTerm && typeof scrollToAndHighlightText === 'function') {
                            scrollToAndHighlightText(searchTerm);
                        }
                    }
                }, 800); // 800ms d√° tempo seguro ao displayNote
            }
            
            // Restaura o texto de status
            if(statusEl) updateSaveStatus('saved');

        } catch (error) {
            console.error("Erro no salto inteligente:", error);
            if(statusEl) statusEl.textContent = "Erro ao saltar";
        }
    });
};

async function fetchBibleRangeText(fullRef) {
    // Regex para separar Livro Cap√≠tulo:Vers√≠culos
    const match = fullRef.match(/(.+)\s(\d+):(.+)/);
    if (!match) return await fetchBibleText(fullRef);

    const book = match[1];
    const chapter = match[2];
    const versePart = match[3];
    let allTexts = [];

    // Lida com m√∫ltiplos segmentos (ex: 1-3, 5)
    const segments = versePart.split(',');

    for (const segment of segments) {
        if (segment.includes('-')) {
            // √â um intervalo (ex: 1-5)
            const [start, end] = segment.split('-').map(Number);
            for (let v = start; v <= end; v++) {
                const text = await fetchBibleText(`${book} ${chapter}:${v}`);
                if (text) allTexts.push(text.trim());
            }
        } else {
            // √â um vers√≠culo √∫nico
            const text = await fetchBibleText(`${book} ${chapter}:${segment.trim()}`);
            if (text) allTexts.push(text.trim());
        }
    }

    return allTexts.length > 0 ? allTexts.join(' ') : null;
}

// --- L√ìGICA DE REORDENA√á√ÉO DO DOSSI√â ---
const dossieContainer = document.getElementById('dossie-list-container');



// --- L√ìGICA DE MOVIMENTO POR BOT√ïES NO DOSSI√â ---
window.moveMicaItem = async function(oldIdx, direction) {
    const newIdx = oldIdx + direction;
    
    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) return;

        let dossie = docSnap.data().dossie || [];
        const mica = dossie.find(m => m.id === window.activeMicaId);

        if (mica && mica.items) {
            // Verifica se o movimento √© v√°lido (dentro dos limites do array)
            if (newIdx < 0 || newIdx >= mica.items.length) return;

            // Troca os itens de lugar
            const item = mica.items[oldIdx];
            mica.items.splice(oldIdx, 1);
            mica.items.splice(newIdx, 0, item);

            // Grava no Firebase
            await updateDoc(docRef, { dossie: dossie });
            
            // Recarrega a vista imediatamente
            window.renderDossie();
        }
    } catch (e) {
        console.error("Erro ao mover item da mica:", e);
    }
};

// --- GATILHO DO BOT√ÉO EDITAR DO DOSSI√â ---
document.getElementById('toggle-dossie-edit-btn').addEventListener('click', () => {
    // 1. Inverte o valor (se era falso fica verdadeiro, e vice-versa)
    window.isDossieEditMode = !window.isDossieEditMode;
    
    // 2. Chama a fun√ß√£o de renderiza√ß√£o para mostrar as setas e o bot√£o "+ Micas"
    window.renderDossie();
});

// Vari√°vel para saber qual Mica estamos a pintar
let activeMicaIdForColor = null;

// 1. FUN√á√ÉO PARA ABRIR O POPUP DE CORES
window.changeMicaColor = function(event, micaId) {
    // 1. Para o evento aqui tamb√©m por seguran√ßa
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    activeMicaIdForColor = micaId;
    const popup = document.getElementById('mica-color-popup');
    if (!popup) return;

    // 2. Garante que o popup est√° no body para n√£o ser cortado pelo painel lateral
    document.body.appendChild(popup);

    // 3. Preenche as cores se estiver vazio
    if (popup.innerHTML === '') {
        popup.style.display = 'grid'; // Define como grid antes de calcular
        MICA_COLORS.forEach(color => {
            const dot = document.createElement('div');
            dot.className = 'mica-color-dot';
            dot.style.backgroundColor = color.hex;
            dot.title = color.name;
            dot.style.cursor = 'pointer';
            dot.onclick = (e) => {
                e.stopPropagation();
                window.applyColorToMica(color.hex);
            };
            popup.appendChild(dot);
        });
    }

    // 4. Posicionamento Inteligente (Fixed)
    const rect = event.target.getBoundingClientRect();
    popup.style.position = 'fixed';
    popup.style.display = 'grid';
    popup.style.zIndex = '10000000'; // Valor absurdo para ficar √† frente de tudo
    
    // Calcula a posi√ß√£o (ajusta se estiver muito perto do fundo da tela)
    let top = rect.bottom + 5;
    if (top + 150 > window.innerHeight) top = rect.top - 155;

    popup.style.top = top + 'px';
    popup.style.left = (rect.left - 60) + 'px';
};

// 2. FUN√á√ÉO PARA GRAVAR A COR NO FIREBASE
window.applyColorToMica = async function(hexColor) {
    if (!activeMicaIdForColor) return;

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, collectionName, activeReferenceEntity.id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            let dossie = docSnap.data().dossie || [];
            const micaIndex = dossie.findIndex(m => m.id === activeMicaIdForColor);

            if (micaIndex > -1) {
                // Atualiza a cor no array
                dossie[micaIndex].color = hexColor;
                
                // Grava de volta no Firestore
                await updateDoc(docRef, { dossie: dossie });
                
                // Fecha o popup e atualiza a vista
                document.getElementById('mica-color-popup').style.display = 'none';
                window.renderDossie();
            }
        }
    } catch (e) {
        console.error("Erro ao mudar cor da mica:", e);
    }
};

// 3. FECHAR POPUP AO CLICAR FORA
document.addEventListener('click', (e) => {
    const popup = document.getElementById('mica-color-popup');
    if (popup && popup.style.display === 'grid' && !popup.contains(e.target) && !e.target.closest('button')) {
        popup.style.display = 'none';
    }
});


function loadPinsView() {
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }

    const listElement = document.getElementById('left-panel-list');
    
    listElement.innerHTML = `
        <div class="panel-loader">
            <div class="spinner"></div>
            <span>A procurar Pins...</span>
        </div>`;
    
    middlePanelTitle.textContent = "Selecione um Pin";
    middlePanelList.innerHTML = '<li style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Os detalhes aparecer√£o aqui ao clicar.</li>';

    const myUid = auth.currentUser.uid;
    
    const q = query(
        collection(db, 'pastas'), 
        where('userId', '==', myUid), 
        where('isPinned', '==', true),
        where('estado', '==', 'ativa'),
        orderBy('nome')
    );

    unsubscribeShared1 = onSnapshot(q, (snapshot) => {
        const fragment = document.createDocumentFragment();
        
        if (snapshot.empty) {
            listElement.innerHTML = '<li style="padding:20px; color:#888; text-align:center; font-size:0.9em;">Ainda n√£o tens Pins.</li>';
            return;
        }

        snapshot.forEach(doc => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            
            li.setAttribute('data-id', item.id);
             li.setAttribute('data-userid', item.userId); // <--- CR√çTICO PARA SABER QUEM √â O DONO
        li.setAttribute('data-type', item.tipo);     // <--- IMPORTANTE PARA SABER QUE √â 'partilhado'
        li.setAttribute('data-name', item.nome);
            li.setAttribute('data-pinned', 'true'); 
            li.style.borderLeft = "4px solid #ff69b4";

            li.innerHTML = `<span>${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                
                middlePanelList.innerHTML = `
                    <div class="panel-loader">
                        <div class="spinner"></div>
                    </div>`;
                
                navigateWithUnsavedCheck(async () => {
                    currentViewMode = 'local';
                    if (item.tipo === 'nota' || item.tipo === 'arquivo' || item.tipo === 'partilhado') {
                        await navigateToNoteSmart(item.id);
                    } else {
                        await reconstructFolderNavigation(item.id);
                    }

                    if (window.innerWidth <= 768) {
                        if (item.tipo === 'nota') document.body.classList.add('mobile-view-editor');
                        else document.body.classList.add('mobile-view-middle');
                    }
                });
            };

            fragment.appendChild(li);
        });

        // Renderiza√ß√£o Final
        listElement.innerHTML = '';
        listElement.appendChild(fragment);
    });
}

// FUN√á√ÉO UNIVERSAL PARA RENOMEAR VIA POPUP
function openRenameModal(currentName, onConfirm) {
    const modal = document.getElementById('rename-modal');
    const input = document.getElementById('rename-input');
    const confirmBtn = document.getElementById('confirm-rename-btn');

    if (!modal) return;

    // Garante que o modal est√° na raiz do body para visibilidade total
    document.body.appendChild(modal);

    input.value = currentName;
    
    // For√ßa visibilidade e prioridade de camada
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.setProperty('z-index', '20000000', 'important');
    modal.style.setProperty('visibility', 'visible', 'important');
    modal.style.setProperty('opacity', '1', 'important');

    setTimeout(() => { 
        input.focus(); 
        input.select(); 
    }, 200);

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
            onConfirm(newName);
        }
        modal.style.display = 'none';
    };
    
    const cancelBtn = document.getElementById('cancel-rename-btn');
    if (cancelBtn) {
        cancelBtn.onclick = () => {
            modal.style.display = 'none';
        };
    }
}

// Fun√ß√£o para configurar e abrir o modal de cria√ß√£o de Temas/Subtemas
window.openCosmosCreator = function(targetType, parentId = null) {
    const modal = document.getElementById('cosmos-modal');
    if (!modal) return console.error("Modal #cosmos-modal n√£o encontrado!");

    // 1. MOVE PARA O BODY E DEFINE Z-INDEX ALTO
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // 2. RESET DOS CAMPOS
    const nameInput = document.getElementById('cosmos-name-input');
    const descInput = document.getElementById('cosmos-desc-input');
    const title = document.getElementById('cosmos-modal-title');

    nameInput.value = "";
    descInput.value = "";
    selectedCosmosEmoji = targetType === 'cosmos' ? "üíº" : "üîπ"; 

    title.textContent = targetType === 'cosmos' ? "Novo Tema (Cosmos)" : "Novo Subtema";
    
    // Reset da sele√ß√£o de emojis visual
    document.querySelectorAll('#cosmos-emoji-grid .emoji-btn').forEach(b => b.classList.remove('selected'));

    setTimeout(() => nameInput.focus(), 100);

    // 3. RECONFIGURAR BOT√ÉO SALVAR (Clonar para limpar eventos)
    const saveBtn = document.getElementById('save-cosmos-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const nome = nameInput.value.trim();
        if (!nome) return alert("O nome √© obrigat√≥rio.");

        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A gravar...";

        try {
            const collectionName = targetType === 'cosmos' ? 'cosmos' : 'subcosmos';
            const data = {
                nome: nome,
                descricao: descInput.value.trim(),
                emoji: selectedCosmosEmoji,
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            };

            if (targetType === 'subcosmos') data.cosmosId = parentId;

            await addDoc(collection(db, collectionName), data);

            modal.style.display = 'none';
            // Recarrega a lista lateral para o novo item aparecer
            if (typeof renderListCategoryItems === 'function') renderListCategoryItems('cosmos');
            
        } catch (e) {
            console.error("Erro ao criar item no Cosmos:", e);
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Criar";
        }
    };
};

function updateMobileFABVisibility() {
    // 1. Se n√£o for mobile (ecr√£ maior que 768px), n√£o faz nada
    if (window.innerWidth > 768) return;

    // 2. CONDI√á√ïES PARA MOSTRAR OS BOT√ïES:
    // - Tem de estar na aba 'Note'
    // - O modo tem de ser 'Local'
    // - N√£o pode estar dentro de nenhuma pasta (pilha de navega√ß√£o vazia)
    // - N√£o pode estar dentro de uma Superpasta (ID de isolamento nulo)
    const isLocalRoot = (currentTab === 'note') && 
                        (currentViewMode === 'local') && 
                        (navigationStack.length === 0) &&
                        (!SUPERFOLDER_ID);

    // 3. Aplica a classe ao body para o CSS mostrar/esconder
    if (isLocalRoot) {
        document.body.classList.add('show-fab');
    } else {
        document.body.classList.remove('show-fab');
    }
}

// Listener para sele√ß√£o de emojis no modal do Cosmos
document.getElementById('cosmos-emoji-grid').addEventListener('click', (e) => {
    const btn = e.target.closest('.emoji-btn');
    if (!btn || btn.id === 'custom-emoji-btn') return;

    const emoji = btn.dataset.emoji;
    if (emoji) {
        selectedCosmosEmoji = emoji;

        // 1. Remove a classe 'selected' de todos os bot√µes da grelha
        document.querySelectorAll('#cosmos-emoji-grid .emoji-btn').forEach(b => {
            b.classList.remove('selected');
        });

        // 2. Adiciona a classe ao bot√£o atual
        btn.classList.add('selected');
    }
});

// Fun√ß√£o auxiliar para quebrar a string de pesquisa em termos (considerando aspas ou espa√ßos)
function parseSearchQuery(query) {
    const terms = [];
    // Esta regex captura o que est√° entre aspas OU palavras soltas
    const regex = /"([^"]+)"|(\S+)/g;
    let match;

    while ((match = regex.exec(query)) !== null) {
        if (match[1]) {
            // Termo entre aspas (Exato)
            terms.push({ text: match[1], exact: true });
        } else if (match[2]) {
            // Termo solto (Abrangente)
            terms.push({ text: match[2], exact: false });
        }
    }
    return terms;
}

// ============================================================
// GEST√ÉO INTEGRAL DE GAVET√ïES (ARQUIVO) - VERS√ÉO CORRIGIDA
// ============================================================

// 1. FUN√á√ÉO MESTRE PARA ABRIR O MODAL DE CRIA√á√ÉO
function openCreateDrawerModal() {
    console.log("%c[GAVET√ÉO] üü¶ Iniciando Abertura Blindada...", "color: #3498db; font-weight: bold;");
    
    const modal = document.getElementById('create-drawer-modal');
    if (!modal) {
        console.error("ERRO: O elemento 'create-drawer-modal' n√£o existe no HTML!");
        return;
    }

    // --- TRUQUE MESTRE: MOVER O MODAL PARA O BODY ---
    // Isto retira o modal de dentro de qualquer div escondida e p√µe-no na raiz do site
    document.body.appendChild(modal);

    // Limpeza de campos
    document.getElementById('new-drawer-name').value = '';
    document.getElementById('new-drawer-desc').value = '';

    // --- FOR√áAR CSS ABSOLUTO VIA JS (Ignora o ficheiro CSS) ---
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.85) !important;
        z-index: 1000000 !important;
        align-items: center !important;
        justify-content: center !important;
    `;

    console.log("%c[GAVET√ÉO] Modal movido para o <body> e estilos for√ßados.", "color: #3498db;");

    setTimeout(() => {
        const input = document.getElementById('new-drawer-name');
        if(input) {
            input.focus();
            console.log("%c[GAVET√ÉO] Teclado/Foco acionado.", "color: #3498db;");
        }
    }, 200);
}

// 2. CONFIGURA√á√ÉO DOS TRIGGERS (BOT√ïES)
function setupDrawerEventListeners() {
    console.log("%c[SISTEMA] Configurando listeners dos Gavet√µes...", "color: #95a5a6;");

    // Bot√£o das Abas
    const mainBtn = document.getElementById('create-drawer-trigger-btn');
    if (mainBtn) {
        console.log("%c[OK] Bot√£o '+ Gavet√£o' encontrado.", "color: #2ecc71;");
        mainBtn.onclick = (e) => {
            console.log("%c[CLIQUE] Bot√£o '+ Gavet√£o' (Abas) clicado!", "background: #2ecc71; color: white; padding: 2px 5px;");
            e.preventDefault();
            window.postToAssignDrawer = null;
            openCreateDrawerModal();
        };
    } else {
        console.warn("%c[AVISO] Bot√£o 'create-drawer-trigger-btn' n√£o existe nesta vista ainda.", "color: #f39c12;");
    }

    // Bot√£o "+" dentro do seletor
    const popupBtn = document.getElementById('open-create-drawer-btn');
    if (popupBtn) {
        popupBtn.onclick = (e) => {
            console.log("%c[CLIQUE] Bot√£o '+' (Popup) clicado!", "background: #3498db; color: white; padding: 2px 5px;");
            e.preventDefault();
            e.stopPropagation();
            openCreateDrawerModal();
        };
    }
}

// Executa a configura√ß√£o inicial e tenta re-vincular quando muda de aba
setupDrawerEventListeners();

// 3. GRAVA√á√ÉO NO FIREBASE (Bot√£o "Criar")
const confirmCreateBtn = document.getElementById('confirm-create-drawer');
if (confirmCreateBtn) {
    confirmCreateBtn.onclick = async () => {
        console.log("%c[GAVET√ÉO] üíæ Tentando salvar novo Gavet√£o...", "color: #27ae60; font-weight: bold;");
        
        const name = document.getElementById('new-drawer-name').value.trim();
        const desc = document.getElementById('new-drawer-desc').value.trim();
        
        if(!name) {
            console.warn("%c[VALIDA√á√ÉO] Nome vazio. Abortando.", "color: #f39c12;");
            alert("O nome √© obrigat√≥rio.");
            return;
        }

        if (!currentArchiveId) {
            console.error("%c[ERRO] currentArchiveId est√° vazio!", "color: red;");
            alert("Erro: ID do Arquivo n√£o detetado.");
            return;
        }

        confirmCreateBtn.disabled = true;
        confirmCreateBtn.textContent = "A gravar...";

        try {
            const qDrawers = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId));
            const snap = await getDocs(qDrawers);
            
            await addDoc(collection(db, 'gavetoes'), {
                arquivoId: currentArchiveId,
                userId: auth.currentUser.uid,
                nome: name,
                descricao: desc,
                posts: [],
                ordem: snap.size,
                viewMode: 'full',
                createdAt: serverTimestamp()
            });

            console.log("%c[SUCESSO] Gavet√£o gravado no Firebase!", "color: #27ae60;");
            document.getElementById('create-drawer-modal').style.display = 'none';

            if (window.postToAssignDrawer) {
                window.openDrawerSelection(window.postToAssignDrawer);
            } else {
                renderArchiveFeed();
            }
        } catch (e) {
            console.error("Erro na grava√ß√£o:", e);
        } finally {
            confirmCreateBtn.disabled = false;
            confirmCreateBtn.textContent = "Criar";
        }
    };
}

// 4. SELECIONAR GAVET√ÉO (O resto da l√≥gica mant√©m-se est√°vel)
window.openDrawerSelection = async (postId) => {
    window.postToAssignDrawer = postId; 
    const modal = document.getElementById('drawer-selection-modal');
    const list = document.getElementById('drawer-list-select');
    list.innerHTML = '<li style="padding:10px; text-align:center;">A carregar...</li>';
    modal.style.display = 'flex';
    try {
        const q = query(collection(db, 'gavetoes'), where('arquivoId', '==', currentArchiveId), orderBy('ordem', 'asc'));
        const snap = await getDocs(q);
        list.innerHTML = '';
        if (snap.empty) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Sem gavet√µes.</li>';
            return;
        }
        snap.forEach(docSnap => {
            const drawer = { id: docSnap.id, ...docSnap.data() };
            const isInside = drawer.posts && drawer.posts.includes(postId);
            const li = document.createElement('li');
            li.className = 'list-item';
            if (isInside) { li.style.backgroundColor = 'rgba(46, 204, 113, 0.1)'; li.style.borderLeft = '4px solid #2ecc71'; }
            li.innerHTML = `<span>üìÇ ${drawer.nome}</span><span style="color:#2ecc71; font-weight:bold;">${isInside ? '‚úì' : ''}</span>`;
            li.onclick = () => togglePostInDrawer(drawer.id, isInside);
            list.appendChild(li);
        });
    } catch (e) { console.error(e); }
};



window.openGaveta = async (gavetaId) => {
    console.group(`üìÇ [SISTEMA] Abrindo Gaveta: ${gavetaId}`);
    
    // 1. AUTO-SAVE: Se houver algum post em edi√ß√£o (na Prateleira ou noutra Gaveta), 
    // guarda-o e liberta o cadeado antes de mudar de vista.
    const idToSave = activeEditingPostId || window.activeEditingPostId;
    if (idToSave) {
        console.log("üíæ [AUTO-SAVE] Gravando post ativo antes de entrar na gaveta...");
        await window.saveArchivePost(idToSave);
    }

    try {
        // 2. BUSCAR DADOS: Obt√©m os dados da gaveta diretamente do Firestore
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docSnap = await getDoc(doc(db, 'gavetas', gavetaId));
        
        if (docSnap.exists()) {
            const data = docSnap.data();

            // 3. DEFINIR ESTADO GLOBAL: Define o ID no window para que o bot√£o "Voltar"
            // e os scripts de movimento saibam onde estamos.
            window.activeGavetaId = gavetaId;
            
            // 4. PREPARAR DADOS DE VISTA: Carrega os posts e metadados
            window.activeGavetaData = { 
                id: docSnap.id, 
                ...data,
                // Define o modo 'titles' (acorde√£o) como padr√£o ao entrar
                viewMode: data.viewMode || 'titles' 
            };
            
            console.log("‚úÖ Gaveta carregada. Modo atual:", window.activeGavetaData.viewMode);

            // 5. RENDERIZAR: Chama a fun√ß√£o global que desenha o feed
            if (typeof window.renderArchiveFeed === 'function') {
                window.renderArchiveFeed();
            } else {
                console.error("‚ùå Erro: window.renderArchiveFeed n√£o encontrada no escopo global.");
            }

        } else {
            console.error("‚ùå Erro: O documento da gaveta n√£o existe no Firebase.");
        }
    } catch (e) {
        console.error("‚ùå Erro ao abrir gaveta:", e);
        alert("Erro ao aceder √† pasta. Verifique a sua liga√ß√£o.");
    }
    console.groupEnd();
};

function renderOpenedGavetaView(feed, allPosts) {
    if (!window.activeGavetaData) return;

    const viewMode = window.activeGavetaData.viewMode || 'titles';
    const orderArray = window.activeGavetaData.posts || [];
    const sepMetadata = window.activeGavetaData.separatorData || {};
    const isFullView = (viewMode === 'full'); // üëÅÔ∏è modo completo
    
    feed.innerHTML = '';

    // --- CABE√áALHO ---
    const header = document.createElement('div');
    header.style.cssText = "display: flex; align-items: center; padding: 15px; background: var(--panel-color); border-radius: 8px; border-left: 5px solid var(--accent-color); margin-bottom: 20px;";
    header.innerHTML = `
        <button class="mini-btn" onclick="window.activeGavetaId=null; window.renderArchiveFeed();" style="margin-right: 15px;"> ‚Üê Voltar </button>
        <strong style="color: white; font-size: 1.1em;">üìÅ ${window.activeGavetaData.nome}</strong>
        <button onclick="window.toggleGavetaViewMode()" title="Alternar visualiza√ß√£o" 
                style="margin-left: auto; background: none; border: none; font-size: 20px; cursor: pointer; opacity: ${isFullView ? '1' : '0.4'};">
            ${isFullView ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
        </button>
    `;
    feed.appendChild(header);

    if (orderArray.length === 0) {
        feed.innerHTML += `<div style="text-align:center; padding:50px; color:#888; font-style:italic;">Gaveta vazia.</div>`;
        return;
    }

    // --- LISTAGEM ---
    orderArray.forEach((id) => {
        if (id.startsWith('sep_')) {
            // --- RENDERIZAR SEPARADOR VERDE ---
            const info = sepMetadata[id] || { title: "Separador" };
            const sepDiv = document.createElement('div');
            sepDiv.className = 'archive-separator';
            
            // L√≥gica: S√≥ inclui a div 'drawer-controls' se for Full View (üëÅÔ∏è)
            const controlsHTML = isFullView ? `
                <div class="drawer-controls">
                    <button class="mini-btn" onclick="window.movePostInGaveta('${id}', -1)">‚Üë</button>
                    <button class="mini-btn" onclick="window.movePostInGaveta('${id}', 1)">‚Üì</button>
                    <button class="mini-btn" onclick="window.editSeparator('${id}', '${info.title}')">Editar</button>
                    <button class="mini-btn" style="color:#e74c3c" onclick="window.deleteSeparator('${id}')">√ó</button>
                </div>` : '';

            sepDiv.innerHTML = `
                <span class="separator-title"># ${info.title}</span>
                ${controlsHTML}
            `;
            feed.appendChild(sepDiv);

        } else {
            // --- RENDERIZAR POST ---
            const post = allPosts.find(p => p.id === id);
            if (post) {
                const postEl = createPostElement(post);
                const controls = postEl.querySelector('.post-controls');
                
                // Injetar controlos se for Full View, sen√£o limpa-os
                if (controls) {
                    if (isFullView) {
                        controls.innerHTML = `
                            <button class="mini-btn" onclick="window.movePostInGaveta('${post.id}', -1)">‚Üë</button>
                            <button class="mini-btn" onclick="window.movePostInGaveta('${post.id}', 1)">‚Üì</button>
                            <button class="mini-btn" onclick="window.editArchivePost('${post.id}')">Editar</button>
                            <button class="mini-btn" title="Remover da Gaveta" onclick="window.togglePostInGaveta('${window.activeGavetaId}', true, '${post.id}')">√ó</button>
                        `;
                        controls.style.display = 'flex';
                        controls.style.opacity = '1';
                    } else {
                        controls.style.display = 'none';
                    }
                }

                // Modo T√≠tulos (Acorde√£o)
                if (!isFullView) {
                    const content = postEl.querySelector('.post-view-content');
                    const footer = postEl.querySelector('.post-footer');
                    if (content) content.style.display = 'none';
                    if (footer) footer.style.display = 'none';
                    
                    postEl.style.cursor = "pointer";
                    postEl.onclick = (e) => {
                        if (e.target.closest('button')) return;
                        const isCollapsed = content.style.display === 'none';
                        content.style.display = isCollapsed ? 'block' : 'none';
                        footer.style.display = isCollapsed ? 'flex' : 'none';
                        postEl.style.backgroundColor = isCollapsed ? "rgba(255,255,255,0.03)" : "";
                    };
                }
                feed.appendChild(postEl);
            }
        }
    });
}

 





window.togglePostInGaveta = async (gavetaId, alreadyPresent) => {
    if (!window.postToAssignDrawer) return;
    
    try {
        const { arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', gavetaId);
        
        if (alreadyPresent) {
            await updateDoc(gavetaRef, { posts: arrayRemove(window.postToAssignDrawer) });
        } else {
            await updateDoc(gavetaRef, { posts: arrayUnion(window.postToAssignDrawer) });
        }
        
        // --- FEEDBACK IMEDIATO ---
        // Recarrega a lista do popup para o utilizador ver o "visto" (‚úì)
        window.openGavetaSelection(window.postToAssignDrawer);
        
        // Se estivermos a ver a gaveta aberta ao fundo, atualiza a vista para o post aparecer/sumir
        if (window.activeGavetaId) renderArchiveFeed();
        
    } catch (e) {
        console.error("Erro ao vincular post √† gaveta:", e);
    }
};

// --- FUN√á√ïES GLOBAIS PARA O ARQUIVO ---

// 1. Apagar Gavet√£o (O "x" pequeno no canto)
window.deleteGavetao = async (id) => {
    const confirmed = await showConfirmation("Eliminar Gavet√£o?", "Isto apagar√° o Gavet√£o e todas as Gavetas dentro dele.");
    if(confirmed) {
        try {
            // Apaga as gavetas ligadas a ele
            const q = query(collection(db, 'gavetas'), where('gavetaoId', '==', id));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            
            // Apaga o gavet√£o
            batch.delete(doc(db, 'gavetoes', id));
            await batch.commit();
            renderArchiveFeed();
        } catch (e) { console.error("Erro ao apagar:", e); }
    }
};


// 3. Abrir o Modal de Criar Gaveta (O bot√£o "+")
window.openCreateGavetaModal = (gavetaoId) => {
    console.log(`%c[GAVETA] ‚ûï Abrindo modal para o Gavet√£o: ${gavetaoId}`, "color: #3498db; font-weight: bold;");

    const modal = document.getElementById('create-gaveta-modal');
    
    if (!modal) {
        console.error("‚ùå ERRO: Elemento 'create-gaveta-modal' n√£o encontrado!");
        return;
    }

    // 1. Mover o modal para o body para evitar que fique preso em divs com scroll ou z-index baixo
    document.body.appendChild(modal);

    // 2. Limpar campos
    document.getElementById('new-gaveta-name').value = "";
    document.getElementById('new-gaveta-desc').value = "";

    // 3. For√ßar visibilidade m√°xima via JS (ignora conflitos de CSS)
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.85) !important;
        z-index: 2000000 !important; 
        align-items: center !important;
        justify-content: center !important;
    `;

    // 4. Configurar o bot√£o de confirma√ß√£o
    const confirmBtn = document.getElementById('confirm-create-gaveta');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.onclick = async () => {
        const name = document.getElementById('new-gaveta-name').value.trim();
        const desc = document.getElementById('new-gaveta-desc').value.trim();

        if (!name) return alert("O nome da gaveta √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "A criar...";

        try {
            // Conta quantas gavetas j√° existem para definir a ordem
            const q = query(collection(db, 'gavetas'), where('gavetaoId', '==', gavetaoId));
            const snap = await getDocs(q);

            await addDoc(collection(db, 'gavetas'), {
                gavetaoId: gavetaoId,
                nome: name,
                descricao: desc,
                posts: [],
                ordem: snap.size,
                 viewMode: 'titles', 
                viewMode: 'full',
                createdAt: Date.now()
            });

            console.log("‚úÖ Gaveta criada com sucesso!");
            modal.style.display = 'none';
            renderArchiveFeed(); // Recarrega a lista para mostrar a nova pasta
            
        } catch (error) {
            console.error("‚ùå Erro ao salvar gaveta:", error);
            alert("Erro ao salvar no banco de dados.");
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Criar";
        }
    };
    
    // Focar no input ap√≥s abrir
    setTimeout(() => {
        const input = document.getElementById('new-gaveta-name');
        if(input) input.focus();
    }, 200);
};



// 5. Apagar Gaveta interna
window.deleteGaveta = async (id) => {
    if (confirm("Apagar esta gaveta?")) {
        await deleteDoc(doc(db, 'gavetas', id));
        renderArchiveFeed();
    }
};

window.moveGavetao = async (drawerId, direction) => {
    console.log("üì¶ Movendo Gavet√£o:", drawerId);
    try {
        const q = query(
            collection(db, 'gavetoes'), 
            where('arquivoId', '==', currentArchiveId), 
            orderBy('ordem', 'asc')
        );
        const snap = await getDocs(q);
        const drawers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const index = drawers.findIndex(d => d.id === drawerId);
        const targetIndex = index + direction;

        if (targetIndex >= 0 && targetIndex < drawers.length) {
            const batch = writeBatch(db);
            batch.update(doc(db, 'gavetoes', drawers[index].id), { ordem: targetIndex });
            batch.update(doc(db, 'gavetoes', drawers[targetIndex].id), { ordem: index });
            await batch.commit();
            renderArchiveFeed();
        }
    } catch (e) {
        console.error("Erro ao mover gavet√£o:", e);
    }
};



window.openGavetaSelection = async (postId) => {
    console.log("üìÇ [SISTEMA] Abrindo seletor para:", postId);
    
    const modal = document.getElementById('drawer-selection-modal');
    const list = document.getElementById('drawer-list-select');
    const modalTitle = modal.querySelector('h3');
    
    if (!modal || !list) return;

    window.postToAssignDrawer = postId; 
    modalTitle.textContent = "Guardar em qual Gaveta?";
    list.innerHTML = '<li style="padding:20px; text-align:center;"><div class="spinner"></div><p>A organizar...</p></li>';
    
    modal.style.display = 'flex';
    modal.style.zIndex = "1000000"; 
    document.body.appendChild(modal);

    try {
        const arcId = typeof currentArchiveId !== 'undefined' ? currentArchiveId : null;
        if (!arcId) return;

        const qGavetoes = query(
            collection(db, 'gavetoes'), 
            where('arquivoId', '==', arcId), 
            orderBy('ordem', 'asc')
        );
        const snapGavetoes = await getDocs(qGavetoes);
        
        list.innerHTML = '';

        if (snapGavetoes.empty) {
            list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Crie um Gavet√£o primeiro.</li>';
            return;
        }

        for (const gDoc of snapGavetoes.docs) {
            const gavetao = gDoc.data();
            
            const header = document.createElement('div');
            header.className = 'modal-gavetao-header';
            header.innerHTML = `üì¶ GAVET√ÉO: ${gavetao.nome}`;
            list.appendChild(header);

            const groupContainer = document.createElement('div');
            groupContainer.className = 'modal-gavetas-group';

            const qGavetas = query(
                collection(db, 'gavetas'), 
                where('gavetaoId', '==', gDoc.id), 
                orderBy('ordem', 'asc')
            );
            const snapGavetas = await getDocs(qGavetas);

            if (snapGavetas.empty) {
                groupContainer.innerHTML = '<small style="color:#555; padding:5px; font-style:italic;">(Vazio)</small>';
            } else {
                snapGavetas.forEach(gavDoc => {
                    const gaveta = { id: gavDoc.id, ...gavDoc.data() };
                    const isInside = (gaveta.posts || []).includes(postId);
                    
                    const li = document.createElement('li');
                    li.className = 'list-item gaveta-interna';
                    
                    // Reset de estilos para garantir alinhamento √† esquerda
                    li.style.display = "flex";
                    li.style.alignItems = "center";
                    li.style.justifyContent = "flex-start"; // For√ßa in√≠cio √† esquerda
                    li.style.textAlign = "left";
                    li.style.padding = "10px 12px";

                    if (isInside) {
                        li.style.borderLeft = '4px solid #2ecc71';
                        li.style.backgroundColor = 'rgba(46, 204, 113, 0.15)'; 
                    }

                    // Estrutura simplificada e colada √† esquerda
                    li.innerHTML = `
                        <span style="font-size:1.2em; margin-right:10px; flex-shrink:0;">üìÅ</span> 
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white; font-size:0.95em;">
                            ${gaveta.nome}
                        </span>
                    `;
                    
                    li.onclick = (e) => {
                        e.stopPropagation();
                        window.togglePostInGaveta(gaveta.id, isInside);
                    };
                    
                    groupContainer.appendChild(li);
                });
            }
            list.appendChild(groupContainer);
        }
    } catch (e) {
        console.error(e);
        list.innerHTML = '<li style="padding:10px; color:red;">Erro ao carregar dados.</li>';
    }
};

// Localiza o bot√£o + dentro do modal de sele√ß√£o
const manageBtn = document.getElementById('manage-topics-btn');

if (manageBtn) {
    const newManageBtn = manageBtn.cloneNode(true);
    manageBtn.parentNode.replaceChild(newManageBtn, manageBtn);

    newManageBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        // 1. Descobrir qual a aba ativa
        const activeTabBtn = document.querySelector('#topics-modal-tabs button.active');
        const activeTab = activeTabBtn ? activeTabBtn.dataset.tab : 'topics';

        // --- CASO A: ABA √ÇNCORAS (‚öì) ---
        if (activeTab === 'anchors') {
            const createAnchorModal = document.getElementById('create-anchor-modal');
            if (createAnchorModal) {
                document.getElementById('new-anchor-name').value = '';
                document.getElementById('new-anchor-desc').value = '';
                
                document.body.appendChild(createAnchorModal);
                createAnchorModal.style.cssText = "display:flex !important; z-index:9000000 !important; visibility:visible !important; opacity:1 !important; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); justify-content:center; align-items:center;";
                
                setTimeout(() => document.getElementById('new-anchor-name').focus(), 100);
            }
        } 
        
        // --- CASO B: ABA T√ìPICOS (üìë) ---
        else if (activeTab === 'topics') {
            const manageModal = document.getElementById('manage-topics-modal');
            if (!manageModal) return;

            document.body.appendChild(manageModal);
            manageModal.style.cssText = "display:flex !important; z-index:9000000 !important; visibility:visible !important; opacity:1 !important; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); justify-content:center; align-items:center;";

            activeTopicIdForManagement = null;
            if (typeof renderManageTopicsList === 'function') renderManageTopicsList();
            
            document.getElementById('create-new-subtopic-btn').style.display = 'none';
            document.getElementById('subtopics-list-manage').innerHTML = '<li style="color:#888; padding:10px;">Selecione um t√≥pico para ver os subt√≥picos.</li>';
        }

        // --- CASO C: ABA TAGS/AUTO-LINKER (üè∑Ô∏è) --- NEW!
        else if (activeTab === 'autolink') {
            // Usa o seu modal bonito de input
            const result = await showCustomInput("Criar Nova Tag", "Nome da tag (sem #)...");
            
            if (result && result.name) {
                const tagName = result.name.trim().replace(/^#/, ''); // Remove # se o user colocar
                
                // Fun√ß√£o j√° existente no seu sistema para criar Tags
                if (typeof createNewTag === 'function') {
                    await createNewTag(tagName);
                    alert(`Tag #${tagName} criada com sucesso!`);
                    
                    // Opcional: Atualiza o bot√£o de verificar para dar feedback
                    const verifyBtn = document.getElementById('run-auto-linker-btn');
                    if(verifyBtn) {
                        verifyBtn.click(); // Roda a verifica√ß√£o automaticamente
                    }
                }
            }
        }
    });
}

const closeManageBtn = document.getElementById('close-manage-topics-btn');
if (closeManageBtn) {
    closeManageBtn.onclick = () => {
        document.getElementById('manage-topics-modal').style.display = 'none';
        // Atualiza a lista do primeiro modal caso tenhamos criado algo novo
        renderTopicsSelectionList(); 
    };
}


// A. BOT√ÉO CRIAR NOVO T√ìPICO
const createTopicBtn = document.getElementById('create-new-topic-btn');
if (createTopicBtn) {
    const newBtn = createTopicBtn.cloneNode(true);
    createTopicBtn.parentNode.replaceChild(newBtn, createTopicBtn);

    newBtn.addEventListener('click', async () => {
        console.log("üÜï Solicitando input para novo T√≥pico...");
        const result = await showCustomInput("Novo T√≥pico", "Ex: Doutrina, Estudo Pessoal...");
        
        if (result && result.name) {
            try {
                await addDoc(collection(db, 'topicos'), {
                    nome: result.name,
                    descricao: result.description,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                renderManageTopicsList(); // Atualiza a lista
            } catch (e) {
                console.error("Erro ao salvar t√≥pico:", e);
            }
        }
    });
}

// B. BOT√ÉO CRIAR NOVO SUBT√ìPICO
const createSubtopicBtn = document.getElementById('create-new-subtopic-btn');
if (createSubtopicBtn) {
    const newSubBtn = createSubtopicBtn.cloneNode(true);
    createSubtopicBtn.parentNode.replaceChild(newSubBtn, createSubtopicBtn);

    newSubBtn.addEventListener('click', async () => {
        if (!activeTopicIdForManagement) return alert("Selecione um t√≥pico pai primeiro.");

        const result = await showCustomInput("Novo Subt√≥pico", "Ex: Batismo, Ora√ß√£o...");
        
        if (result && result.name) {
            try {
                await addDoc(collection(db, 'subtopicos'), {
                    nome: result.name,
                    descricao: result.description,
                    topicId: activeTopicIdForManagement,
                    userId: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });
                renderManageSubtopicsList(activeTopicIdForManagement); // Atualiza a lista da direita
            } catch (e) {
                console.error("Erro ao salvar subt√≥pico:", e);
            }
        }
    });
}

// No ouvinte de cliques do editor:
noteContentEditor.addEventListener('click', (e) => {
    const colorBtn = e.target.closest('button[data-action="highlight-color"]');
    
    if (colorBtn) {
        e.preventDefault(); 
        e.stopPropagation(); // Impede o editor de fechar o popup
        
        const wrapper = colorBtn.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
        if (wrapper) {
            openHighlightPopup(wrapper);
        }
        return; // Sai da fun√ß√£o para n√£o disparar outros cliques
    }
});

// No ouvinte de cliques do editor (ou arquivo):
noteContentEditor.addEventListener('click', (e) => {
    const appendBtn = e.target.closest('button[data-action="append-mini-note"]');
    
    if (appendBtn) {
        e.preventDefault(); 
        e.stopPropagation(); 
        
        // --- CORRE√á√ÉO AQUI ---
        // Agora procura por ambos os tipos de wrapper
        const wrapper = appendBtn.closest('.mini-note-wrapper, .redator-wrapper');
        
        if (wrapper) {
            // Captura o HTML da caixa
            htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
            openAppendModal();
        } else {
            console.error("‚ùå Erro: Wrapper n√£o encontrado (nem .mini-note-wrapper nem .redator-wrapper).");
        }
        return;
    }
});


const miniNoteShareToggle = document.getElementById('mini-note-share-toggle');
if (miniNoteShareToggle) {
    miniNoteShareToggle.onchange = () => {
        if (activeWrapperForSharing) {
            const newState = miniNoteShareToggle.checked;
            
            // 1. Atualiza o atributo no HTML da caixa
            activeWrapperForSharing.setAttribute('data-shared', newState);
            
            // 2. Atualiza o visual do bot√£o (mudar √≠cone ou cor)
            updateSharingButtonState(activeWrapperForSharing);
            
            console.log(`‚úÖ Partilha da caixa ${activeWrapperForSharing.id} definida como: ${newState}`);
            
            // 3. Grava a nota
            saveNote(true);
        }
    };
}

const customEmojiBtn = document.getElementById('custom-emoji-btn');
if (customEmojiBtn) {
    customEmojiBtn.onclick = () => {
        const modal = document.getElementById('custom-emoji-modal');
        if (!modal) return;

        // MOVE PARA O BODY E Z-INDEX M√ÅXIMO (Para ficar √† frente do modal anterior)
        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "9000000";

        const input = document.getElementById('custom-emoji-input');
        const confirmBtn = document.getElementById('confirm-custom-emoji-btn');

        input.value = "";
        setTimeout(() => input.focus(), 100);

        confirmBtn.onclick = () => {
            const val = input.value.trim();
            if (val) {
                selectedCosmosEmoji = val;
                // Atualiza visualmente o bot√£o do Cosmos para mostrar o emoji escolhido
                customEmojiBtn.textContent = val;
                customEmojiBtn.classList.add('selected');
            }
            modal.style.display = 'none';
        };
    };
}


window.openCosmosEditPopup = function(id, currentName, currentEmoji, type) {
    const modal = document.getElementById('custom-emoji-modal');
    const nameInput = document.getElementById('custom-theme-name-input');
    const emojiInput = document.getElementById('custom-emoji-input');
    const confirmBtn = document.getElementById('confirm-custom-emoji-btn');

    if (!modal) {
        console.error("‚ùå Erro: Modal 'custom-emoji-modal' n√£o encontrado no HTML!");
        return;
    }

    nameInput.value = currentName;
    emojiInput.value = currentEmoji || "üíº";

    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "9999999";

    setTimeout(() => nameInput.focus(), 150);

    // Clonagem para limpar eventos antigos
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    // 3. Grava√ß√£o
    newConfirmBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newEmoji = emojiInput.value.trim();

        if (!newName) return alert("Nome √© obrigat√≥rio.");

        newConfirmBtn.disabled = true;
        newConfirmBtn.textContent = "...";

        try {
            const collectionName = type === 'cosmos-parent' ? 'cosmos' : 'subcosmos';
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            await updateDoc(doc(db, collectionName, id), {
                nome: newName,
                emoji: newEmoji
            });

            modal.style.display = 'none';
            // Recarrega a lista
            renderListCategoryItems('cosmos'); 
        } catch (e) {
            console.error(e);
        } finally {
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = "Confirmar";
        }
    };
    
    // Bot√£o cancelar (opcional, mas recomendado verificar se existe)
    const cancelBtn = modal.querySelector('.secondary');
    if (cancelBtn) {
        cancelBtn.onclick = () => { modal.style.display = 'none'; };
    }
};

async function checkItemProtection(itemId, itemName) {
    // Se o ID for nulo ou inv√°lido, n√£o faz nada
    if (!itemId) return true;
    if (sessionUnlockedFolders.has(itemId)) return true;

    try {
        const docRef = doc(db, 'pastas', itemId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.passe && data.passe.trim() !== "") {
                const authorized = await requestPassword('access', itemId);
                if (authorized === true) {
                    sessionUnlockedFolders.add(itemId);
                    return true;
                }
                return false;
            }
        }
    } catch (e) {
        console.error("Erro na verifica√ß√£o de senha:", e);
    }
    return true; 
}

window.addSeparatorToGaveta = async () => {
    if (!window.activeGavetaId) return;

    const result = await showCustomInput("Novo Separador", "Ex: Parte 1, Refer√™ncias Extras...");
    if (!result || !result.name) return;

    const sepId = 'sep_' + Date.now();
    
    try {
        const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);

        // Salvamos o ID no array de posts e o nome num mapa de metadados
        await updateDoc(gavetaRef, {
            posts: arrayUnion(sepId),
            [`separatorData.${sepId}`]: {
                title: result.name,
                createdAt: Date.now()
            }
        });

        // Atualiza a mem√≥ria local e renderiza
        if (!window.activeGavetaData.posts) window.activeGavetaData.posts = [];
        window.activeGavetaData.posts.push(sepId);
        if (!window.activeGavetaData.separatorData) window.activeGavetaData.separatorData = {};
        window.activeGavetaData.separatorData[sepId] = { title: result.name };

        renderArchiveFeed();
    } catch (e) {
        console.error("Erro ao criar separador:", e);
    }
};

// Ligar o clique do bot√£o
document.getElementById('create-separator-btn').onclick = window.addSeparatorToGaveta;


window.editSeparator = async (id, currentName) => {
    // Passamos 'currentName' como 3¬∫ argumento
    const result = await showCustomInput("Renomear Separador", "Novo nome...", currentName);
    
    if (!result || !result.name) return;

    try {
        const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
        
        await updateDoc(gavetaRef, {
            [`separatorData.${id}.title`]: result.name
        });
        
        // Atualiza mem√≥ria local
        if (window.activeGavetaData && window.activeGavetaData.separatorData && window.activeGavetaData.separatorData[id]) {
            window.activeGavetaData.separatorData[id].title = result.name;
        }
        
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

window.deleteSeparator = async (id) => {
    if (!confirm("Remover este separador?")) return;
    try {
        const { arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
        await updateDoc(gavetaRef, {
            posts: arrayRemove(id),
            [`separatorData.${id}`]: deleteField()
        });
        window.activeGavetaData.posts = window.activeGavetaData.posts.filter(item => item !== id);
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

// Fun√ß√£o de movimento unificada (funciona para posts e separadores)
window.movePostInGaveta = async (id, direction) => {
    const order = [...window.activeGavetaData.posts];
    const index = order.indexOf(id);
    const newIndex = index + direction;

    if (newIndex >= 0 && newIndex < order.length) {
        [order[index], order[newIndex]] = [order[newIndex], order[index]];
        try {
            const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);
            await updateDoc(gavetaRef, { posts: order });
            window.activeGavetaData.posts = order;
            renderArchiveFeed();
        } catch (e) { console.error(e); }
    }
};

document.getElementById('create-separator-btn').onclick = async () => {
    const result = await showCustomInput("Novo Separador", "Ex: Parte 1, Fontes Extra...");
    if (!result || !result.name) return;

    const sepId = 'sep_' + Date.now();
    try {
        const { doc, updateDoc, arrayUnion } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const gavetaRef = doc(db, 'gavetas', window.activeGavetaId);

        await updateDoc(gavetaRef, {
            posts: arrayUnion(sepId),
            [`separatorData.${sepId}`]: { title: result.name }
        });

        // Atualiza cache local para refletir na UI sem refresh
        window.activeGavetaData.posts.push(sepId);
        if(!window.activeGavetaData.separatorData) window.activeGavetaData.separatorData = {};
        window.activeGavetaData.separatorData[sepId] = { title: result.name };
        
        renderArchiveFeed();
    } catch (e) { console.error(e); }
};

// 1. Definir a fun√ß√£o como global para evitar conflitos de nome
window.openShareModalForArchive = async function() {
    if (!selectedNoteId && !currentArchiveId) return;
    const targetId = selectedNoteId || currentArchiveId;

    const modal = document.getElementById('note-share-popup');
    if (!modal) return console.error("Modal #note-share-popup n√£o encontrado!");

    // 1. FOR√áA HIERARQUIA (Move para o body e define Z-Index alto)
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "8500000"; // Acima do editor e abas
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'pastas', targetId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            const myUid = auth.currentUser.uid;

            // üõ°Ô∏è BLOQUEIO DE SEGURAN√áA: Se n√£o for o dono, esconde op√ß√µes
            if (data.userId !== myUid) {
                alert("Apenas o dono do arquivo pode gerir as permiss√µes de partilha.");
                modal.style.display = 'none';
                return;
            }

            // ============================================================
            // 2. INJE√á√ÉO DA OP√á√ÉO "TODAS AS SUBNOTAS" (ALL UNLOCK)
            // ============================================================
            const mainToggleRow = document.getElementById('note-share-toggle').closest('.share-toggle-row');
            let allUnlockWrapper = document.getElementById('allunlock-wrapper');

            if (!allUnlockWrapper && mainToggleRow) {
                allUnlockWrapper = document.createElement('div');
                allUnlockWrapper.id = 'allunlock-wrapper';
                allUnlockWrapper.style.display = 'none'; // Come√ßa escondido (s√≥ aparece se partilha ativa)
                
                // HTML da nova op√ß√£o (Caixa pontilhada azul)
                allUnlockWrapper.innerHTML = `
                    <div style="background-color: rgba(74, 144, 226, 0.05); padding: 8px 12px; border-radius: 8px; border: 1px dashed var(--accent-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 5px;">
                        <div style="padding-right: 10px;">
                            <span style="font-size:0.85em; font-weight:bold; color: var(--accent-color); display:block;">Todas as Subnotas, Quest√µes etc...</span>
                            <small style="color:var(--text-muted-color); font-size:0.7em;"></small>
                        </div>
                        <label class="setting-switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="share-allunlock-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                `;
                // Insere logo abaixo da linha principal
                mainToggleRow.insertAdjacentElement('afterend', allUnlockWrapper);
                
                // Adiciona o listener para gravar assim que mudar
                const newCheck = allUnlockWrapper.querySelector('input');
                newCheck.addEventListener('change', updateSharingSettings);
            }

            // ============================================================
            // 3. CARREGAR DADOS E ESTADOS
            // ============================================================
            
            // A. Link de Leitura (Azul)
            currentNoteShareData = data.shareSettings || { shared: false, shareId: null };
            
            // Define estado da checkbox "All Unlock" (Padr√£o: true)
            const isAllUnlock = (currentNoteShareData.allunlock !== undefined) ? currentNoteShareData.allunlock : true;

            const mainToggle = document.getElementById('note-share-toggle');
            if(mainToggle) mainToggle.checked = currentNoteShareData.shared || false;
            
            const allUnlockToggle = document.getElementById('share-allunlock-toggle');
            if(allUnlockToggle) allUnlockToggle.checked = isAllUnlock;
            
            // Efeitos Visuais (Onda Azul)
            const modalContent = document.querySelector('#note-share-popup .modal-content');
            if (currentNoteShareData.shared) modalContent.classList.add('share-active-wave');
            else modalContent.classList.remove('share-active-wave');

            const linkContainer = document.getElementById('note-share-link-container');
            const unlockContainer = document.getElementById('allunlock-wrapper');

            // Mostrar/Esconder sec√ß√µes baseado no estado principal
            if (currentNoteShareData.shared) {
                if(linkContainer) linkContainer.style.display = 'block';
                if(unlockContainer) unlockContainer.style.display = 'block'; // Mostra a nova op√ß√£o
                
                const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                const shareId = currentNoteShareData.shareId || targetId;
                document.getElementById('note-share-url').value = `${baseUrl}/sharenote.html?id=${shareId}`;
            } else {
                if(linkContainer) linkContainer.style.display = 'none';
                if(unlockContainer) unlockContainer.style.display = 'none';
            }

            // ============================================================
            // B. COLABORA√á√ÉO + GEST√ÉO DE UTILIZADORES (VERMELHO)
            // ============================================================
            const collabSection = document.getElementById('archive-collab-section');
            
            // 1. Limpa qualquer lista de utilizadores antiga que tenha ficado no HTML
            const oldList = document.getElementById('collab-users-manager');
            if (oldList) oldList.remove();

            if (data.tipo === 'partilhado' || data.tipo === 'arquivo') {
                if(collabSection) collabSection.style.display = 'block';
                
                const collabToggle = document.getElementById('collab-share-toggle');
                if(collabToggle) collabToggle.checked = (data.partilhado === "ativo");
                
                const collabLinkContainer = document.getElementById('collab-share-link-container');
                
                if (data.partilhado === "ativo") {
                    if(collabLinkContainer) collabLinkContainer.style.display = 'block';
                    
                    const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                    const collabUrl = `${baseUrl}/note.html?openArchive=${targetId}&mode=collab`;
                    const collabInput = document.getElementById('collab-share-url');
                    if(collabInput) collabInput.value = collabUrl;

                    // >>> INJETAR LISTA DE UTILIZADORES <<<
                    const usersContainer = document.createElement('div');
                    usersContainer.id = 'collab-users-manager';
                    usersContainer.style.cssText = "margin-top: 15px; border-top: 1px dashed #e74c3c; padding-top: 10px;";
                    
                    usersContainer.innerHTML = `
                        <h4 style="font-size:0.8em; color:#e74c3c; text-transform:uppercase; margin-bottom:10px;">üë§ Colaboradores Ativos</h4>
                        <ul id="collab-users-ul" class="move-list" style="max-height:150px; overflow-y:auto; border:1px solid rgba(231, 76, 60, 0.3); border-radius:4px;">
                            <li style="padding:10px; text-align:center; color:#888;">
                                <div class="spinner" style="width:15px; height:15px; border-width:2px; display:inline-block; border-left-color:#e74c3c;"></div>
                                A carregar nomes...
                            </li>
                        </ul>
                    `;
                    
                    collabLinkContainer.appendChild(usersContainer);

                    // Chama a fun√ß√£o ass√≠ncrona para preencher os nomes
                    if (typeof window.renderCollaboratorsList === 'function') {
                        window.renderCollaboratorsList(targetId, data.colaboradores);
                    }

                } else {
                    if(collabLinkContainer) collabLinkContainer.style.display = 'none';
                }
            } else {
                if(collabSection) collabSection.style.display = 'none';
            }
        }
    } catch (err) {
        console.error("üî• Erro ao carregar dados de partilha:", err);
        alert("Erro ao carregar permiss√µes.");
    }
};


// Fun√ß√£o centralizada para abrir o criador de marcadores
function openCreateBookmarkPopup() {
    const modal = document.getElementById('create-bookmark-modal');
    if (!modal) return;

    // Garante que o modal est√° no topo do body
    document.body.appendChild(modal);

    // Limpa os campos
    document.getElementById('new-bookmark-title').value = '';
    document.getElementById('new-bookmark-desc').value = '';

    // For√ßa visibilidade absoluta
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "10000000";
    modal.style.visibility = "visible";
    modal.style.opacity = "1";

    // Foco no input
    setTimeout(() => {
        const input = document.getElementById('new-bookmark-title');
        if (input) input.focus();
    }, 100);
}

// Detectar cliques nos links dentro do Quadro (Puzzle)
document.getElementById('puzzle-board-container').addEventListener('click', (e) => {
    const boardLink = e.target.closest('a.board-link');
    
    if (boardLink) {
        console.log("%cüìç [CLIQUE QUADRO] Detetado clique no texto azul!", "background: #3498db; color: white; padding: 2px 5px;");
        console.log("üìù Texto clicado:", boardLink.textContent);
        
        e.preventDefault();
        e.stopPropagation();
        
        if (typeof viewBoardLink === 'function') {
            console.log("üöÄ Chamando viewBoardLink...");
            viewBoardLink(boardLink);
        } else {
            console.error("‚ùå ERRO: A fun√ß√£o viewBoardLink n√£o est√° definida no c√≥digo!");
        }
    }
}, true);


// ============================================================
// GEST√ÉO DE CATEGORIAS ANEXADAS (FUN√á√ïES GLOBAIS)
// ============================================================

window.searchCategories = async function(queryText) {
    const resultsContainer = document.getElementById('category-search-results');
    const isBibleSearch = document.getElementById('search-bible-toggle')?.checked;
    
    if (!resultsContainer) return;

    // Reset se vazio
    if (!queryText || queryText.length < 2) {
        resultsContainer.innerHTML = '';
        window.categoryFullResults = [];
        window.categoryDisplayCount = 0;
        return;
    }

    const term = queryText.toLowerCase();
    window.categoryFullResults = [];
    window.categoryDisplayCount = 0;

    console.log(`üîç [PESQUISA] Procurando por: "${term}"...`);

    if (isBibleSearch) {
        // --- MODO B√çBLIA ---
        resultsContainer.innerHTML = '<div style="padding:10px; text-align:center;"><div class="spinner"></div></div>';
        try {
            const { collection, query, where, limit, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, "bible_verses_public"), where("nome", ">=", queryText), where("nome", "<=", queryText + '\uf8ff'), limit(50));
            const snap = await getDocs(q);
            snap.forEach(doc => {
                window.categoryFullResults.push({ id: doc.id, name: doc.data().nome, type: 'bible_public' });
            });
        } catch (e) { console.error("Erro b√≠blia:", e); }
    } else {
        // --- MODO LOCAL ---
        // Varre todas as entidades locais carregadas
        Object.keys(allEntities).forEach(type => {
            if (type === 'textobiblico') return; 
            allEntities[type].forEach(ent => {
                if (ent.nome.toLowerCase().includes(term)) {
                    window.categoryFullResults.push({ id: ent.id, name: ent.nome, type: type });
                }
            });
        });

        // Varre Tags
        if (typeof allTags !== 'undefined') {
            allTags.forEach(tag => {
                if (tag.nome.toLowerCase().includes(term)) {
                    window.categoryFullResults.push({ id: tag.id, name: tag.nome, type: 'tag' });
                }
            });
        }
    }

    // Ordena e Renderiza
    window.categoryFullResults.sort((a, b) => a.name.localeCompare(b.name));
    resultsContainer.innerHTML = '';
    window.renderCategoryBatch(); // Chama o renderizador corrigido abaixo
};

// FUN√á√ÉO PARA RENDERIZAR UM LOTE DE 30 ITENS
 window.renderCategoryBatch = function() {
    const resultsContainer = document.getElementById('category-search-results');
    
    // Remove bot√£o "Ver mais" antigo
    const oldBtn = document.getElementById('btn-categories-more');
    if (oldBtn) oldBtn.remove();

    const start = window.categoryDisplayCount || 0;
    const end = start + 30;
    const batch = window.categoryFullResults.slice(start, end);

    batch.forEach(res => {
        // VERIFICA√á√ÉO ROBUSTA: V√™ se j√° est√° no array global
        const isAlreadyAdded = window.selectedCategoriesForBox.some(c => 
            (res.type === 'bible_public' ? c.name === res.name : c.id === res.id)
        );
        
        const div = document.createElement('div');
        
        // Estilos e √çcones
        let icon = "üîπ"; let typeLabel = res.type; let color = "var(--accent-color)";
        if (res.type === 'personagem') { icon = "üë§"; typeLabel = "Personagem"; color="#e67e22"; }
        else if (res.type === 'local') { icon = "üìç"; typeLabel = "Local"; color="#e74c3c"; }
        else if (res.type === 'tag') { icon = "üè∑Ô∏è"; typeLabel = "Tag"; color="#f1c40f"; }
        else if (res.type === 'textobiblico') { icon = "üìñ"; typeLabel = "B√≠blia"; color="#2ecc71"; }

        div.style.cssText = `
            padding: 10px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 12px; transition: all 0.2s;
            opacity: ${isAlreadyAdded ? '0.5' : '1'};
        `;

        div.innerHTML = `
            <span style="font-size: 1.4em;">${icon}</span>
            <div style="display: flex; flex-direction: column; overflow: hidden; flex: 1;">
                <span style="font-size: 0.65em; text-transform: uppercase; color: ${color}; font-weight: bold;">${typeLabel}</span>
                <strong style="color: var(--text-color); font-size: 0.95em;">${res.name}</strong>
            </div>
            <span class="status-icon" style="font-size: 1.2em; font-weight: bold; color: ${isAlreadyAdded ? '#2ecc71' : 'var(--text-muted-color)'};">
                ${isAlreadyAdded ? '‚úì' : '+'}
            </span>
        `;

        // --- OUVINTE DE CLIQUE CORRIGIDO ---
        div.onclick = async (e) => {
            e.preventDefault();
            e.stopPropagation();

            console.log("üëâ [CLIQUE] Item clicado:", res.name);

            // 1. Evita duplicados
            const existsNow = window.selectedCategoriesForBox.some(c => c.id === res.id);
            if (existsNow) {
                console.warn("‚ö†Ô∏è Item j√° estava selecionado.");
                return;
            }

            // 2. ADICIONA AO ARRAY GLOBAL (O Passo que faltava)
            window.selectedCategoriesForBox.push({
                id: res.id,
                name: res.name,
                type: res.type
            });

            console.log("‚úÖ [MEM√ìRIA] Array atualizado:", window.selectedCategoriesForBox);

            // 3. Atualiza Visualmente a Linha (Imediato)
            div.style.opacity = '0.5';
            div.querySelector('.status-icon').textContent = '‚úì';
            div.querySelector('.status-icon').style.color = '#2ecc71';

            // 4. Atualiza os "Chips" na √°rea de cima
            window.renderAttachedCategories();
            
            // 5. Limpa a pesquisa para facilitar a pr√≥xima
            const input = document.getElementById('category-search-input');
            if(input) {
                input.value = "";
                input.focus();
            }
            resultsContainer.innerHTML = ''; // Limpa resultados para for√ßar nova pesquisa limpa
        };
        
        resultsContainer.appendChild(div);
    });

    window.categoryDisplayCount += batch.length;

    // Bot√£o Ver Mais
    if (window.categoryDisplayCount < window.categoryFullResults.length) {
        const moreBtn = document.createElement('button');
        moreBtn.id = 'btn-categories-more';
        moreBtn.textContent = "Ver mais resultados...";
        moreBtn.className = "modal-btn secondary";
        moreBtn.style.width = "100%";
        moreBtn.style.marginTop = "10px";
        moreBtn.onclick = (e) => { e.preventDefault(); window.renderCategoryBatch(); };
        resultsContainer.appendChild(moreBtn);
    }
};


// ============================================================
// NOVO SISTEMA DE HIST√ìRICO: ABAS + TIMELINE + A√á√ïES
// ============================================================

// 1. Gestor de Troca de Abas
document.getElementById('history-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const target = btn.dataset.histTab;

    document.querySelectorAll('#history-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.hist-tab-div').forEach(div => div.style.display = 'none');
    document.getElementById(`hist-content-${target}`).style.display = 'block';

    if (target === 'timeline') renderNoteTimeline();
});

// 2. Abrir o Modal (Fun√ß√£o Global)
window.openHistoryModal = async function() {
    // Usa o ID da nota ou do arquivo atual
    const targetId = selectedNoteId || currentArchiveId;
    if (!targetId) return alert("Selecione um item primeiro.");

    const modal = document.getElementById('history-modal');
    const titleEl = document.getElementById('history-modal-title');
    const backupBtn = document.getElementById('backup-now-btn');
    
    // Detetar se estamos em modo Arquivo ou Nota
    const isArchiveMode = document.getElementById('archive-area').style.display !== 'none';

    if (!modal || !backupBtn) return;

    // 1. Mostrar o Modal
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    modal.style.zIndex = "8000000";

    // Atualiza t√≠tulo do modal
    titleEl.textContent = isArchiveMode ? "Hist√≥rico do Arquivo" : "Hist√≥rico da Nota";

    // 2. Configurar o Bot√£o de Backup (L√≥gica Din√¢mica)
    // Clonamos para remover listeners antigos
    const newBackupBtn = backupBtn.cloneNode(true);
    backupBtn.parentNode.replaceChild(newBackupBtn, backupBtn);

    newBackupBtn.onclick = async () => {
        const originalText = newBackupBtn.textContent;
        newBackupBtn.disabled = true;
        newBackupBtn.textContent = 'A guardar vers√£o...';

        try {
            const backupsRef = collection(db, 'pastas', targetId, 'backups');
            let backupPayload = {
                timestamp: serverTimestamp(),
                isSafetyBackup: false
            };

            // --- L√ìGICA DE DADOS ---
            if (isArchiveMode) {
                // BACKUP DE ARQUIVO (Guarda os posts)
                const title = document.getElementById('archive-title-input').value || "Arquivo Sem T√≠tulo";
                backupPayload.titulo = title;
                backupPayload.posts = currentArchiveData.posts || []; 
                backupPayload.deletedPosts = currentArchiveData.deletedPosts || [];
                backupPayload.type = 'archive_backup';
            } else {
                // BACKUP DE NOTA (Guarda o HTML)
                const title = document.getElementById('note-title-input').value || "Nota Sem T√≠tulo";
                // Sincroniza inputs
                document.querySelectorAll('.mini-note-title-input').forEach(t => {
                    if (t.tagName === 'TEXTAREA') t.textContent = t.value;
                    else t.setAttribute('value', t.value);
                });
                const content = document.getElementById('note-content-editor').innerHTML;
                
                backupPayload.titulo = title;
                backupPayload.conteudo = content;
                backupPayload.type = 'note_backup';
            }

            await addDoc(backupsRef, backupPayload);

            // Feedback de sucesso
            newBackupBtn.textContent = '‚úÖ Vers√£o Guardada!';
            newBackupBtn.style.backgroundColor = '#27ae60';

            // Recarregar a lista
            await loadHistoryData();

            setTimeout(() => {
                newBackupBtn.disabled = false;
                newBackupBtn.textContent = originalText;
                newBackupBtn.style.backgroundColor = '';
            }, 2000);

        } catch (error) {
            console.error("Erro ao criar backup:", error);
            alert("Erro ao criar backup.");
            newBackupBtn.disabled = false;
            newBackupBtn.textContent = originalText;
        }
    };

    // 3. Resetar para a aba Backup e carregar dados
    const tabBackup = document.querySelector('[data-hist-tab="backup"]');
    if(tabBackup) tabBackup.click();
    
    // Chama a fun√ß√£o de carregamento
    await loadHistoryData();
};

// 3. Carregar Dados do Firebase (Backups e Reciclagem)
async function loadHistoryData() {
    const backupList = document.getElementById('history-list-backups');
    const recyclingList = document.getElementById('history-list-recycling');
    const timelineList = document.getElementById('history-list-timeline');
    
    // Indicadores de carregamento
    backupList.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    recyclingList.innerHTML = '<li style="padding:10px;">A carregar...</li>';
    
    // Detetar modo
    const isArchiveMode = document.getElementById('archive-area').style.display !== 'none';
    const targetId = selectedNoteId || currentArchiveId;

    if (!targetId) return;

    try {
        // =================================================================
        // A. BACKUPS (Comum aos dois, muda apenas o conte√∫do do bot√£o "Ver")
        // =================================================================
        const { collection, getDocs, query, orderBy, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const backupsRef = collection(db, 'pastas', targetId, 'backups');
        const qB = query(backupsRef, orderBy('timestamp', 'desc'));
        const snapB = await getDocs(qB);
        
        backupList.innerHTML = snapB.empty ? '<li style="color:#888; padding:10px;">Nenhum backup encontrado.</li>' : '';
        
        snapB.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : '---';
            const li = document.createElement('li');
            li.style.justifyContent = 'space-between';
            
            // Bot√£o de restauro inteligente
            const restoreAction = isArchiveMode 
                ? `alert('Restauro de Arquivo completo ainda em desenvolvimento. Copie os posts manualmente no bot√£o Ver.')` 
                : `restoreBackup('${data.id}')`;

            li.innerHTML = `
                <span>${data.isSafetyBackup ? 'üö®' : 'üíæ'} Vers√£o ${date}</span>
                <div style="display:flex; gap:5px;">
                    <button class="modal-btn secondary" onclick="viewBackup('${data.id}')" style="padding:4px 8px; font-size:12px;">Ver</button>
                    <button class="modal-btn primary" onclick="${restoreAction}" style="padding:4px 8px; font-size:12px;">Restaurar</button>
                </div>
            `;
            backupList.appendChild(li);
        });

        // =================================================================
        // B. RECICLAGEM (CORRIGIDA COM √çCONES ESPEC√çFICOS)
        // =================================================================
        recyclingList.innerHTML = '';
        let hasRecyclingItems = false;

        if (isArchiveMode) {
            // --- MODO ARQUIVO: Posts Eliminados ---
            const deletedPosts = currentArchiveData?.deletedPosts || [];
            
            if (deletedPosts.length > 0) {
                deletedPosts.forEach((item, index) => {
                    const dateStr = item.deletedAt ? new Date(item.deletedAt).toLocaleString() : '---';
                    
                    // √çcone espec√≠fico para posts de arquivo
                    let icon = "üìÑ";
                    if (item.type === 'entity') icon = "üß©"; // Se for entidade (ex: subnota dentro do arquivo)
                    
                    recyclingList.innerHTML += `
                        <li class="list-item" style="flex-direction:column; align-items:flex-start; border-bottom:1px solid #333; padding:10px;">
                            <div style="display:flex; justify-content:space-between; width:100%;">
                                <strong>üóëÔ∏è ${item.title || 'Post Sem T√≠tulo'}</strong>
                                <button class="modal-btn primary" onclick="window.restoreArchiveItem(${index})" style="padding:2px 8px; font-size:0.8em;">Restaurar</button>
                            </div>
                            <small style="color:#888;">${icon} Apagado em: ${dateStr}</small>
                        </li>`;
                });
                hasRecyclingItems = true;
            }

        } else {
            // --- MODO NOTA: Caixas Ocultas (Firebase) ---
            const noteSnap = await getDoc(doc(db, 'pastas', targetId));
            const hidden = noteSnap.exists() ? (noteSnap.data().subnotasocultas || {}) : {};
            
            const boxesArray = Object.values(hidden);
            if (boxesArray.length > 0) {
                // Ordena por data de elimina√ß√£o (mais recente primeiro)
                boxesArray.sort((a,b) => (b.deletedAt?.seconds || 0) - (a.deletedAt?.seconds || 0)).forEach(item => {
                    
                    // --- ATRIBUI√á√ÉO DE √çCONES ---
                    let typeIcon = "üì¶ "; // Padr√£o
                    
                    switch (item.type) {
                        case 'question': typeIcon = "üìó "; break; // Quest√£o
                        case 'free':     typeIcon = "üìô "; break; // Contentor
                        case 'redator':  typeIcon = "üìì "; break; // Redator
                        case 'card':     typeIcon = "ü™™ "; break; // Cart√£o
                        case 'sign':     typeIcon = "ü™ß "; break; // Racioc√≠nio
                        case 'cube':     typeIcon = "üßä "; break; // Cubo
                        case 'toggle':   typeIcon = "‚òÇ ";  break; // Toggle
                        case 'statue':   typeIcon = "üóø "; break; // Est√°tua
                         case 'table':    typeIcon = "üßÆ "; break; 
                        case 'default':  
                        case 'subnote':  typeIcon = "üìò "; break; // Subnota (Azul)
                    }
                    
                    const dateStr = item.deletedAt ? new Date(item.deletedAt.seconds * 1000).toLocaleDateString() : '';

                    recyclingList.innerHTML += `
                        <li class="list-item" style="justify-content:space-between; padding:10px; border-bottom:1px solid #333;">
                            <div style="display:flex; flex-direction:column;">
                                <span style="font-weight:500;">${typeIcon} ${item.titulo || 'Item sem nome'}</span>
                                <small style="color:#666; font-size:0.75em;">${dateStr}</small>
                            </div>
                            <button class="modal-btn primary" onclick="window.restoreHiddenMiniNote('${item.id}')" style="padding:2px 8px; font-size:0.8em;">Restaurar</button>
                        </li>`;
                });
                hasRecyclingItems = true;
            }
        }

        if (!hasRecyclingItems) {
            recyclingList.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">Lixeira vazia.</li>';
        }

        // =================================================================
        // C. TIMELINE (Esconde no Arquivo, Mostra na Nota)
        // =================================================================
        if (isArchiveMode) {
             if(timelineList) timelineList.innerHTML = '<li style="padding:20px; color:#888;">Timeline n√£o dispon√≠vel para Arquivos.</li>';
        } else {
             if (typeof renderNoteTimeline === 'function') renderNoteTimeline();
        }

    } catch (e) { 
        console.error("Erro ao carregar hist√≥rico:", e); 
        backupList.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro de liga√ß√£o.</li>';
    }
}


// 4. L√≥gica da Timeline (Hist√≥rico de Cria√ß√£o)
async function renderNoteTimeline() {
    const infoDiv = document.getElementById('note-creation-info');
    const timelineList = document.getElementById('history-list-timeline');
    timelineList.innerHTML = '<li style="padding:10px;">A analisar...</li>';

    try {
        const noteSnap = await getDoc(doc(db, 'pastas', selectedNoteId));
        if (noteSnap.exists()) {
            const data = noteSnap.data();
            const noteDate = data.createdAt ? new Date(data.createdAt.seconds * 1000) : null;
            infoDiv.innerHTML = `
                <strong style="color:var(--accent-color);">Nota Criada em:</strong><br>
                <span style="font-size:1.1em;">üìÖ ${noteDate ? noteDate.toLocaleDateString('pt-PT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Data desconhecida'}</span>
            `;
        }

        const editor = document.getElementById('note-content-editor');
        const boxes = editor.querySelectorAll('.mini-note-wrapper, details.toggle-section, .jwn-table-wrapper, .jwn-timeline-wrapper');
        
        if (boxes.length === 0) {
            timelineList.innerHTML = '<li style="color:#888; padding:10px;">Nenhuma caixa ativa no momento.</li>';
            return;
        }

        const items = [];
        boxes.forEach(box => {
            const idParts = box.id.split('_');
            const timestamp = (idParts.length > 1 && !isNaN(idParts[1])) ? parseInt(idParts[1]) : null;
            let label = "Bloco"; let icon = "üì¶"; let title = "";

            if (box.classList.contains('question-mode')) { label = "Quest√£o"; icon = "üìó"; title = box.querySelector('textarea, input')?.value; }
            else if (box.classList.contains('free-mode')) { label = "Contentor"; icon = "üìô"; title = box.querySelector('.mini-note-content')?.innerText.substring(0, 30) + "..."; }
            else if (box.classList.contains('mini-note-wrapper')) { label = "SubNota"; icon = "üìò"; title = box.querySelector('textarea, input')?.value; }
            else if (box.tagName === 'DETAILS') { label = "Toggle"; icon = "‚òÇ"; title = box.querySelector('h2')?.textContent; }
            else if (box.classList.contains('jwn-table-wrapper')) { label = "Tabela"; icon = "üßÆ"; }
            else if (box.classList.contains('jwn-timeline-wrapper')) { label = "Linha Cronol√≥gica"; icon = "üå≥"; }

            items.push({ timestamp, icon, label, title: title || 'Sem T√≠tulo' });
        });

        timelineList.innerHTML = '';
        items.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(item => {
            const timeStr = item.timestamp ? new Date(item.timestamp).toLocaleString('pt-PT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}) : 'Data desconhecida';
            const li = document.createElement('li');
            li.style.cssText = "flex-direction:column; align-items:flex-start; padding:10px; border-bottom:1px solid var(--border-color);";
            li.innerHTML = `
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <strong>${item.icon} ${item.label}</strong>
                    <span style="font-size:0.8em; color:var(--text-muted-color);">${timeStr}</span>
                </div>
                <div style="font-size:0.9em; opacity:0.8; margin-top:4px;">${item.title}</div>
            `;
            timelineList.appendChild(li);
        });
    } catch (e) { console.error(e); }
}

// 5. FUN√á√ïES DE A√á√ÉO GLOBAIS (Ver e Restaurar)
window.viewBackup = async function(backupId) {
    const modal = document.getElementById('view-backup-modal');
    const contentEl = document.getElementById('view-backup-content');
    const titleEl = document.getElementById('view-backup-title');
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    modal.style.zIndex = "9999999";
    contentEl.innerHTML = '<p>A carregar...</p>';

    try {
        const backupSnap = await getDoc(doc(db, 'pastas', selectedNoteId, 'backups', backupId));
        if (backupSnap.exists()) {
            const data = backupSnap.data();
            titleEl.textContent = "Conte√∫do da Vers√£o";
            let cleanHTML = (data.conteudo || "").replace(/<div class="mini-note-toolbar".*?<\/div>/g, '');
            contentEl.innerHTML = cleanHTML;
        }
    } catch (e) { console.error(e); }
};

window.restoreBackup = async function(backupId) {
    const confirmed = await showConfirmation("Restaurar?", "Isto criar√° uma NOVA nota baseada nesta vers√£o.");
    if (!confirmed) return;
    try {
        const backupSnap = await getDoc(doc(db, 'pastas', selectedNoteId, 'backups', backupId));
        const data = backupSnap.data();
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const originalSnap = await getDoc(noteRef);
        const parentId = originalSnap.exists() ? originalSnap.data().parentId : null;

        const newDoc = await addDoc(collection(db, 'pastas'), {
            nome: `${data.titulo} (Restaurado)`,
            conteudo: data.conteudo,
            parentId: parentId,
            tipo: 'nota',
            userId: auth.currentUser.uid,
            estado: 'ativa',
            ordem: 0,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp()
        });

        document.getElementById('history-modal').style.display = 'none';
        displayNote(newDoc.id, null);
    } catch (e) { console.error(e); }
};

// ============================================================
// FUN√á√ÉO: RESTAURAR CAIXAS DA RECICLAGEM (CORRIGIDA)
// ============================================================
window.restoreHiddenMiniNote = async function(miniNoteId) {
    if (!selectedNoteId) return;

    const confirmed = await showConfirmation("Restaurar Item?", "O item voltar√° para a nota com todas as defini√ß√µes.");
    if (!confirmed) return;

    try {
        const { doc, getDoc, updateDoc, serverTimestamp, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);
        const noteSnap = await getDoc(noteRef);
        
        if (!noteSnap.exists()) return;
        
        const data = noteSnap.data();
        const hiddenItems = data.subnotasocultas || {};
        const item = hiddenItems[miniNoteId];

        if (!item) { alert("Item n√£o encontrado."); return; }

        let restoredHTML = "";
        const safeId = item.id || `restored_${Date.now()}`;
        
        // --- 1. LIMPEZA INTELIGENTE DE CONTE√öDO ---
        let cleanContent = item.conteudo || "<p><br></p>";
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanContent;
        
        const innerContentDiv = tempDiv.querySelector('.mini-note-content, .redator-content, .sign-content, .card-desc-content, .statue-content-lock, .toggle-content');
        if (innerContentDiv) cleanContent = innerContentDiv.innerHTML;
        
        const titleVal = item.titulo || "";
        
        // DETE√á√ÉO DE TABELAS (Caso tenham sido guardadas como default)
        if (cleanContent.includes('class="jwn-table"') || cleanContent.includes("jwn-table-wrapper")) {
            item.type = 'table';
            if (cleanContent.trim().startsWith('<div class="jwn-table-wrapper"')) {
                const tempTable = document.createElement('div');
                tempTable.innerHTML = cleanContent;
                if (tempTable.firstElementChild.classList.contains('jwn-table-wrapper')) {
                    cleanContent = tempTable.firstElementChild.innerHTML;
                }
            }
        }
        
        // --- 2. RECUPERA√á√ÉO DE METADADOS ---
        const escapeAttr = (str) => (str || "{}").replace(/'/g, "&apos;").replace(/"/g, "&quot;");
        
        const topics = escapeAttr(item.topicsJSON);
        const links = escapeAttr(item.boxLinksJSON);
        const shared = item.sharedState || "false";
        const highlight = item.highlightColor || "";
        const paraId = item.paragraphId || "";

        let styleStr = "";
        if (highlight) {
            styleStr = `border-color: ${highlight}; background-color: rgba(255,255,255,0.05);`;
        }

        const commonAttrs = `id="${safeId}" data-topics='${topics}' data-box-links='${links}' data-shared="${shared}" data-highlight="${highlight}" style="${styleStr}"`;

        const commonToolbar = `
            <div class="mini-note-toolbar" contenteditable="false">
                <button type="button" data-action="sharing-settings" title="Partilha">üîê</button>
                <div class="toolbar-btn-group">
                    <button type="button" data-action="move-up" title="Subir">üî∫</button>
                    <button type="button" data-action="move-down" title="Descer">üîª</button>
                </div>
                <button type="button" data-action="manage-box-links" title="Links/Codex">‚ö°</button>
                <button type="button" data-action="append-mini-note" title="Clonar">üß¨</button>
                <button type="button" data-action="highlight-color" title="Cor">üé®</button>
                <button type="button" data-action="manage-mini-note-topics" title="T√≥picos">üìã</button>
                <button type="button" data-action="delete-mini-note" title="Apagar">üóëÔ∏è</button>
            </div>`;

        // --- 3. RECONSTRU√á√ÉO POR TIPO ---

        if (item.type === 'statue') {
            const jumpAction = `event.preventDefault(); window.handleGoToNote('${item.originNoteId}', '${item.originBoxId}')`;
            restoredHTML = `
                <div class="mini-note-wrapper statue-card-wrapper" ${commonAttrs} 
                     data-origin-note="${item.originNoteId}" 
                     data-origin-box="${item.originBoxId}" 
                     contenteditable="false">
                    <div class="mini-note-toolbar" contenteditable="false">
                        <button type="button" data-action="sharing-settings">üîê</button>
                        <div class="toolbar-btn-group">
                            <button type="button" data-action="move-up">üî∫</button>
                            <button type="button" data-action="move-down">üîª</button>
                        </div>
                        <button type="button" data-action="highlight-color">üé®</button>
                        <button type="button" data-action="delete-mini-note">üóëÔ∏è</button>
                        <button type="button" onclick="${jumpAction}" style="color: #a569bd; font-weight: bold; border-color: #a569bd;">üóø</button>
                    </div>
                    <div class="statue-content-lock">${cleanContent}</div>
                </div><p><br></p>`;
        }
        else if (item.type === 'question') {
            restoredHTML = `
            <div class="mini-note-wrapper question-mode" ${commonAttrs} contenteditable="false">
                <textarea class="mini-note-title-input" rows="1">${titleVal}</textarea>
                ${commonToolbar}
                <div class="mini-note-content" contenteditable="true" style="${highlight ? `background-color:${highlight}; color:#222;` : ''}">${cleanContent}</div>
            </div><p><br></p>`;
        }
        else if (item.type === 'table') {
            // >>> CORRE√á√ÉO APLICADA AQUI <<<
            const tempParser = document.createElement('div');
            tempParser.innerHTML = cleanContent;
            // Garante que todas as c√©lulas s√£o edit√°veis
            tempParser.querySelectorAll('td, th').forEach(cell => {
                cell.setAttribute('contenteditable', 'true');
            });
            const fixedContent = tempParser.innerHTML;

            restoredHTML = `
            <div class="jwn-table-wrapper" ${commonAttrs} contenteditable="false">
                ${fixedContent} 
            </div><p><br></p>`;
        }
        else if (item.type === 'free') {
            restoredHTML = `
            <div class="mini-note-wrapper free-mode" ${commonAttrs} contenteditable="false">
                ${commonToolbar}
                <div class="mini-note-content" contenteditable="true" style="${highlight ? `background-color:${highlight}; color:#222;` : ''}">${cleanContent}</div>
            </div><p><br></p>`;
        }
        else if (item.type === 'redator') {
            restoredHTML = `
            <div class="redator-wrapper" ${commonAttrs} data-paragraph="${paraId}" contenteditable="false">
                <button class="redator-reopen-btn" onclick="window.toggleRedatorHeader('${safeId}', true)">T</button>
                <div class="redator-header" id="header-${safeId}">
                   <input type="text" class="redator-input" value="${titleVal}" oninput="this.setAttribute('value', this.value)">
                    <div class="redator-top-tools">
                        <button class="redator-menu-trigger" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>
                         <div class="redator-slide-menu">
                            <button class="tool-icon-btn" data-action="sharing-settings">üîê</button>
                            <button class="tool-icon-btn" data-action="manage-box-links">‚ö°</button>
                            <button class="tool-icon-btn" data-action="highlight-color">üé®</button>
                            <button class="tool-icon-btn" data-action="manage-mini-note-topics">üìã</button>
                            <button class="tool-icon-btn" data-action="delete-mini-note" style="color:#e74c3c;">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="redator-content" contenteditable="true" oninput="window.checkRedatorFocus(this, '${safeId}')">${cleanContent}</div>
                <div class="redator-dock">
                     <button class="dock-btn" onclick="event.preventDefault(); window.openRedatorFocus('${safeId}')">‚á±</button>
                     <div class="dock-sep"></div>
                     <button class="dock-btn" onclick="event.preventDefault(); window.addRedatorBelow('${safeId}')">+</button>
                </div>
            </div><p><br></p>`;
        }
        else if (item.type === 'toggle') {
             restoredHTML = `
                <details class="toggle-section" open ${commonAttrs}>
                    <summary>
                        <h2>${titleVal || "T√≠tulo"}</h2>
                        <button class="toggle-move-btn" data-action="move-up">üî∫</button>
                        <button class="toggle-move-btn" data-action="move-down">üîª</button>
                        <button class="toggle-color-btn" contenteditable="false">üñåÔ∏è</button>
                        <button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content" contenteditable="true">${cleanContent}</div>
                </details><p><br></p>`;
        }
        else { // Subnota Padr√£o
             restoredHTML = `
             <div class="mini-note-wrapper" ${commonAttrs} contenteditable="false">
                <textarea class="mini-note-title-input" rows="1">${titleVal}</textarea>
                ${commonToolbar}
                <div class="mini-note-content" contenteditable="true" style="${highlight ? `background-color:${highlight}; color:#222;` : ''}">${cleanContent}</div>
             </div><p><br></p>`;
        }

        // --- 4. INSER√á√ÉO E ATUALIZA√á√ÉO ---
        let container = document.getElementById('note-content-editor');
        const marker = document.getElementById(`marker_${miniNoteId}`);
        
        if (marker) marker.outerHTML = restoredHTML;
        else container.insertAdjacentHTML('beforeend', restoredHTML);

        // Atualiza a nota no Firebase
        container.querySelectorAll('textarea, input').forEach(t => {
            if(t.tagName === 'TEXTAREA') t.textContent = t.value;
            else t.setAttribute('value', t.value);
        });

        const finalHTML = container.innerHTML;

        await updateDoc(noteRef, {
            conteudo: finalHTML,
            [`subnotasocultas.${miniNoteId}`]: deleteField(),
            ultimaedicao: serverTimestamp()
        });

        // 5. ATUALIZAR ESTADOS DOS BOT√ïES
        setTimeout(() => {
            const restoredEl = document.getElementById(safeId);
            if (restoredEl) {
                restoredEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                if (typeof updateMiniNoteButtonState === 'function') updateMiniNoteButtonState(restoredEl); 
                if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(restoredEl);
                if (typeof updateSharingButtonState === 'function') updateSharingButtonState(restoredEl);
                if (typeof updateHighlightButtonState === 'function') updateHighlightButtonState(restoredEl);
            }
        }, 100);

        document.getElementById('history-modal').style.display = 'none';

    } catch (error) {
        console.error("Erro restauro:", error);
    }
};

// 1. FUN√á√ÉO PARA ATUALIZAR A HORA DE LEITURA (Firestore)
async function markArchiveAsRead(archiveId) {
    if (!auth.currentUser || !archiveId) return;
    
    let now = Date.now();

    // TRUQUE ANTI-PISCAR REFOR√áADO:
    // Garante que o nosso 'visto' √© sempre superior √† √∫ltima edi√ß√£o,
    // mesmo que haja diferen√ßas de milissegundos entre servidor e cliente.
    if (currentArchiveData && currentArchiveData.ultimaedicao) {
        const serverTime = currentArchiveData.ultimaedicao.toMillis ? currentArchiveData.ultimaedicao.toMillis() : (currentArchiveData.ultimaedicao || 0);
        if (serverTime >= now) {
            now = serverTime + 2000; // Adiciona 2 segundos de margem de seguran√ßa
        }
    }

    // 1. ATUALIZA√á√ÉO IMEDIATA LOCAL (O Segredo)
    // Atualiza o cache local antes mesmo de ir √† base de dados
    userLastSeenArchives[archiveId] = now;
    
    // 2. FOR√áA O APAGAR DA BOLA NA SIDEBAR AGORA
    // Como atualiz√°mos a vari√°vel acima, o rec√°lculo vai dar 0 n√£o lidos.
    recalcGlobalNotification();

    try {
        const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // 3. Grava no Firebase (Silenciosamente)
        const readRef = doc(db, 'users', auth.currentUser.uid, 'archive_reads', archiveId);
        await setDoc(readRef, { 
            lastSeen: now,
            archiveName: currentArchiveData?.nome || "Arquivo" 
        }, { merge: true });
        
    } catch (e) { 
        console.warn("‚ö†Ô∏è Falha ao gravar leitura (offline?):", e); 
    }
}

// 2. FUN√á√ÉO DISPLAY ARCHIVE (ATUALIZADA)
window.displayArchive = async function(id, data, element = null) {
    if (typeof leaveArchivePresence === 'function') await leaveArchivePresence(); 
    console.group(`üìÇ [ABERTURA] A carregar Arquivo: "${data.nome}"`);

    // --- NOVO: REMOVER O LOADING E MOSTRAR A INTERFACE ---
    const archiveArea = document.getElementById('archive-area');
    if (archiveArea) {
        // Remove o spinner de carregamento se existir
        const loader = document.getElementById('archive-loader-overlay');
        if (loader) loader.remove();

        // Restaura a visibilidade dos elementos normais
        Array.from(archiveArea.children).forEach(child => {
            // Ignora elementos que devem ser geridos por l√≥gica espec√≠fica
            if (child.id !== 'archive-mobile-nav' && child.id !== 'collab-bar') {
                // Remove o style="display: none" que pusemos no clique
                child.style.display = ''; 
                
                // Refor√ßo para elementos flex√≠veis
                if (child.id === 'archive-toolbar' || child.classList.contains('archive-tabs')) {
                    child.style.display = 'flex';
                }
            }
        });

        // Refor√ßo espec√≠fico para o Feed
        const feed = document.getElementById('archive-feed');
        if(feed) {
            feed.style.display = 'flex';
            feed.style.flexDirection = 'column';
        }

        // Mobile Nav: S√≥ mostra se for ecr√£ pequeno
        const mobileNav = document.getElementById('archive-mobile-nav');
        if(mobileNav && window.innerWidth <= 768) {
            mobileNav.style.setProperty('display', 'flex', 'important');
        }
    }
    // -----------------------------------------------------
    
    // --- 1. VERIFICA√á√ÉO DE MIGRA√á√ÉO ---
    // Se ainda tiver posts no formato antigo (Array no documento pai), migra primeiro.
    if (data.posts && Array.isArray(data.posts) && data.posts.length > 0) {
        console.warn("‚ö†Ô∏è Formato antigo detetado. A migrar para sub-cole√ß√µes...");
        if (typeof migrateLegacyArchive === 'function') {
             await migrateLegacyArchive(id, data);
             return; 
        }
    }

    sessionStartTimeForArchive = userLastSeenArchives[id] || 0;
    selectedNoteId = id; 
    window.nextSelectedId = null;
    currentArchiveId = id; 
    currentArchiveData = data;
    
    // --- CORRE√á√ÉO DE PERMISS√ïES: BOT√ÉO DE PARTILHA ---
    const shareBtn = document.querySelector('#archive-toolbar button[data-action="archive-share"]');
    if (shareBtn) {
        const myUid = auth.currentUser ? auth.currentUser.uid : null;
        // Se eu n√£o for o dono (userId do arquivo !== meu ID), escondo o bot√£o
        if (data.userId !== myUid) {
            shareBtn.style.setProperty('display', 'none', 'important');
        } else {
            shareBtn.style.display = 'flex'; 
        }
    }
    // -------------------------------------------------

    // Inicializa arrays vazios na mem√≥ria (pois os dados vir√£o do listener)
    currentArchiveData.posts = []; 
    currentArchiveData.deletedPosts = [];

    currentArchiveTab = 'prateleira';
    window.activeGavetaId = null;
    window.activeGavetaData = null;
    
    // Atualiza Abas UI
    document.querySelectorAll('.archive-tab-btn').forEach(btn => {
        if (btn.dataset.archiveTab === 'prateleira') btn.classList.add('active');
        else btn.classList.remove('active');
    });

    // Mostra Bot√µes
    const postBtn = document.getElementById('create-post-btn');
    const drawerBtn = document.getElementById('create-drawer-trigger-btn');
    const separatorBtn = document.getElementById('create-separator-btn');
    if (postBtn) postBtn.style.display = 'block';
    if (drawerBtn) drawerBtn.style.display = 'none';
    if (separatorBtn) separatorBtn.style.display = 'none';

    // UI Layout
    const placeholder = document.getElementById('editor-placeholder');
    const editorArea = document.getElementById('editor-area');
    
    if (placeholder) placeholder.style.setProperty('display', 'none', 'important');
    if (editorArea) editorArea.style.setProperty('display', 'none', 'important');
    if (archiveArea) archiveArea.style.display = 'flex';

    if (document.getElementById('archive-title-input')) {
        document.getElementById('archive-title-input').value = data.nome || "";
    }

    if (typeof initPresenceSystem === 'function') initPresenceSystem(id);
    if (typeof initRealtimeCollab === 'function') initRealtimeCollab(id);
    
    // --- 2. OUVINTE DA SUB-COLE√á√ÉO (MODO CORRETO) ---
    if (collabUnsubscribe) collabUnsubscribe(); // Este limpa o listener de posts, n√£o de locks (que est√° no initRealtimeCollab)

    try {
        const { collection, query, orderBy, onSnapshot } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        console.log(`üì° Conectando √† sub-cole√ß√£o: pastas/${id}/posts`);
        
        const postsRef = collection(db, 'pastas', id, 'posts');
        
        // Ordenamos por 'ordem' ASCENDENTE (do menor para o maior).
        // Como os novos posts t√™m n√∫meros negativos (-1000), eles v√™m primeiro.
        const q = query(postsRef, orderBy('ordem', 'asc')); 

        // Atribu√≠mos a uma nova vari√°vel global ou reutilizamos uma espec√≠fica para posts
        window.postsUnsubscribe = onSnapshot(q, (snapshot) => {
            console.log(`üì• Snapshot recebido. Docs encontrados: ${snapshot.size}`);
            
            const loadedPosts = [];
            snapshot.forEach(doc => {
                loadedPosts.push({ id: doc.id, ...doc.data() });
            });

            // Atualiza mem√≥ria
            currentArchiveData.posts = loadedPosts;
            
            // Renderiza apenas se n√£o estivermos a editar um post (para n√£o interromper escrita)
            if (!activeEditingPostId) {
                renderArchiveFeed();
            }
        }, (error) => {
            console.error("‚ùå Erro no Snapshot do Arquivo:", error);
        });

    } catch (e) {
        console.error("Erro cr√≠tico ao iniciar ouvinte:", e);
    }
    
    console.groupEnd();

    // Ajuste para Mobile
    if (window.innerWidth <= 768) {
        document.body.classList.remove('mobile-view-middle');
        document.body.classList.add('mobile-view-editor');
    }
};



// 3. RENDERIZAR POST VIEW MODE (COM PONTOS)
function renderPostViewMode(container, post) {
    if (!post || !container) return;

    try {
        // --- 1. PREPARA√á√ÉO DE DADOS SEGURA ---
        const getMs = (val) => val && val.toMillis ? val.toMillis() : Number(val || 0);
        
        // Dados do Autor e Datas
        const createdBy = post.createdBy || 'An√≥nimo';
        const postCreated = getMs(post.createdAt);
        const createdDate = postCreated ? new Date(postCreated).toLocaleString() : '---';
        const postUpdated = getMs(post.updatedAt);
        
        // Dados do Utilizador Atual (Seguran√ßa se n√£o houver login)
        const myUid = auth.currentUser ? auth.currentUser.uid : "visitor";
        const lastSeen = Number(sessionStartTimeForArchive || 0);
        
        // Dados do Conte√∫do
        const titleSafe = post.title || 'Sem T√≠tulo';
        const contentSafe = post.content || '<p style="color:red;">[Conte√∫do Vazio]</p>';

        // --- 2. L√ìGICA DE NOTIFICA√á√ÉO (BOLINHAS) ---
        let statusDotHTML = "";
        
        if (postCreated > lastSeen && post.userId !== myUid) {
            statusDotHTML = `<div class="post-status-dot dot-new" title="Novo Post"></div>`;
        } 
        else if (postUpdated > lastSeen && postUpdated > (postCreated + 2000)) { 
            const lastEditor = post.lastEditorId || "unknown";
            if (lastEditor !== myUid) {
                statusDotHTML = `<div class="post-status-dot dot-edited" title="Editado recentemente"></div>`;
            }
        }

        // --- 3. PREPARA√á√ÉO DOS LIKES ---
        // Garante que √© sempre um array, mesmo que venha null da BD
        const likes = Array.isArray(post.likes) ? post.likes : [];
        const likeCount = likes.length;
        const iLiked = likes.includes(myUid);
        const heartIcon = iLiked ? '‚ù§Ô∏è' : 'ü§ç';
        const activeClass = iLiked ? 'active-like' : '';

        // Estilos Inline
        const btnStyle = "position: static !important; background:var(--bg-color); border:1px solid var(--border-color); color:var(--text-muted-color); border-radius:4px; padding:0 10px; cursor:pointer; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px;";

        container.style.position = "relative";

        // HTML do Bot√£o de Like
        const likeBtnHTML = `
            <button class="post-like-btn ${activeClass}" onclick="event.stopPropagation(); window.togglePostLike('${post.id}')" 
                    title="${iLiked ? 'Remover Like' : 'Gostar'}"
                    style="background:none; border:1px solid var(--border-color); border-radius:15px; padding:2px 10px; cursor:pointer; display:flex; align-items:center; gap:5px; transition:all 0.2s; color:var(--text-muted-color);">
                <span style="font-size:1.1em;">${heartIcon}</span>
                <span style="font-size:0.85em; font-weight:bold;">${likeCount > 0 ? likeCount : ''}</span>
            </button>
        `;

        // Agrupamento dos bot√µes da direita (Like + Info)
        const rightActions = `
            <div style="display:flex; align-items:center; gap:8px;">
                ${likeBtnHTML}
                <button class="post-info-btn" onclick="event.stopPropagation(); window.showPostDetails('${post.id}')" title="Ver Detalhes">‚ÑπÔ∏è</button>
            </div>
        `;

        // --- 4. RODAP√â (Condicional) ---
        let footerHTML = '';
        // Verifica se currentArchiveData existe para n√£o dar erro
        const isSharedArchive = currentArchiveData && (currentArchiveData.tipo === 'partilhado' || currentArchiveData.tipo === 'arquivo');

        if (isSharedArchive) {
            // Modo Partilhado: Alinha tudo √† direita
            footerHTML = `<div style="width: 100%; display: flex; justify-content: flex-end;">${rightActions}</div>`;
        } else {
            // Modo Pessoal: Metadados √† esquerda, Bot√µes √† direita
            footerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <div style="display:flex; gap:10px;">
                        <span>Criado por: ${createdBy}</span>
                        <span>${createdDate}</span>
                    </div>
                    ${rightActions}
                </div>`;
        }

        // --- 5. MONTAGEM DO HTML FINAL ---
        container.innerHTML = `
            ${statusDotHTML}
            
            <div class="post-controls" style="position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 5px; opacity: 0.6; z-index:10;">
                <button onclick="moveArchivePost('${post.id}', -1)" title="Subir" style="${btnStyle}">‚Üë</button>
                <button onclick="moveArchivePost('${post.id}', 1)" title="Descer" style="${btnStyle}">‚Üì</button>
                <button class="post-edit-btn" onclick="editArchivePost('${post.id}')" style="${btnStyle}">Editar</button>
            </div>
            
            <div class="post-view-title" style="padding-left: 25px; font-weight:bold; color:var(--accent-color); font-size:1.2em; margin-bottom:10px;">
                ${titleSafe}
            </div>
            
            <div class="post-view-content" style="padding-left: 5px;">${contentSafe}</div>
            
            <div class="post-footer">${footerHTML}</div>
        `;

        // 6. Ativar Observador (Para a bolinha desaparecer ao ler)
        if (statusDotHTML !== "") {
            postObserver.observe(container);
        }

    } catch (err) {
        console.error("Erro ao renderizar post:", post.id, err);
        // Fallback para o post n√£o desaparecer totalmente
        container.innerHTML = `<div style="padding:10px; border:1px solid red; color:red;">Erro ao mostrar post. (Dados corrompidos)</div>`;
    }
}


// 4. ATUALIZAR LISTA LATERAL COM BADGE (Dentro de loadSharedFilesRoot)
// Substitua o loop .forEach de loadSharedFilesRoot por este:
async function updateSharedListWithNotifs(resultsMap) {
    const myUid = auth.currentUser.uid;
    const fragment = document.createDocumentFragment();

 resultsMap.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-item';
        
        // --- ATRIBUTOS ESSENCIAIS (CORRE√á√ÉO AQUI) ---
        li.setAttribute('data-id', item.id);
        li.setAttribute('data-userid', item.userId); // J√° existia, mas √© CR√çTICO
        li.setAttribute('data-partilhado', item.partilhado || 'inativo'); // << NOVO: Guarda o estado (ativo/inativo)
        li.setAttribute('data-type', item.tipo || 'partilhado');
        li.setAttribute('data-name', item.nome);
        
        li.style.position = "relative"; 

        // Estilo de sele√ß√£o
        if (item.id === selectedNoteId) li.classList.add('selected-red');
        else li.style.borderLeft = "4px solid #e74c3c";

        // --- L√ìGICA DO BADGE DE N√öMERO ---
        let notifHTML = "";
        const unreadCount = window.folderUnreadCounts[item.id] || 0;

        if (unreadCount > 0) {
            const displayNum = unreadCount > 9 ? "9+" : unreadCount;
            notifHTML = `<span class="unread-count-badge">${displayNum}</span>`;
        }

        const isOwner = item.userId === myUid;
        
        li.innerHTML = `
            <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 130px;">
                ${isOwner ? 'üëë' : 'ü§ù'} ${item.nome}
            </span>
            ${notifHTML}
            <button class="item-menu-btn">‚Ä¶</button>
        `;
        
        if (isOwner && item.partilhado !== "ativo") li.style.opacity = "0.7";

        // REMOVEMOS O ONCLICK MANUAL DAQUI!
        // O listener global 'middlePanelList.addEventListener' vai apanhar 
        // o clique baseando-se nos atributos data-type e data-id que pusemos acima.
        
        fragment.appendChild(li);
    });

    middlePanelList.innerHTML = '';
    middlePanelList.appendChild(fragment);
}



async function loadSharedFilesRoot() {
    console.log("%c[SISTEMA] Iniciando renderiza√ß√£o da Partilha...", "color: #e74c3c;");
    
    if (unsubscribeShared1) { unsubscribeShared1(); unsubscribeShared1 = null; }
    if (unsubscribeShared2) { unsubscribeShared2(); unsubscribeShared2 = null; }

    middlePanelTitle.textContent = "Arquivos Partilhados";
    
    middlePanelList.innerHTML = `
        <div class="panel-loader">
            <div class="spinner"></div>
            <span>A carregar partilhas...</span>
        </div>`;

    const myUid = auth.currentUser.uid;
    const foldersRef = collection(db, 'pastas');
    let resultsMap = new Map();

    try {
        const readsSnap = await getDocs(collection(db, 'users', myUid, 'archive_reads'));
        if (currentViewMode !== 'shared') return;
        readsSnap.forEach(d => userLastSeenArchives[d.id] = d.data().lastSeen || 0);
    } catch(e) { console.warn("Aviso: Hist√≥rico de leitura inacess√≠vel."); }

    const renderUnifiedList = () => {
        if (currentViewMode !== 'shared') return;

        if (resultsMap.size === 0) {
            middlePanelList.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">Sem arquivos partilhados.</li>';
            return;
        }
        
        // Em vez de limpar e adicionar um a um, usa a fun√ß√£o auxiliar que j√° cria o HTML
        // Vamos alterar a `updateSharedListWithNotifs` abaixo para usar Fragmento tamb√©m.
        updateSharedListWithNotifs(resultsMap);
    };

    const q1 = query(foldersRef, where('userId', '==', myUid), where('tipo', '==', 'partilhado'), where('estado', '==', 'ativa'));
    const q2 = query(foldersRef, where(`colaboradores.${myUid}`, '==', true), where('partilhado', '==', 'ativo'), where('tipo', '==', 'partilhado'), where('estado', '==', 'ativa'));

    unsubscribeShared1 = onSnapshot(q1, (snap) => {
        if (currentViewMode !== 'shared') return;
        snap.docChanges().forEach(c => resultsMap.set(c.doc.id, { ...c.doc.data(), id: c.doc.id }));
        renderUnifiedList();
    });

    unsubscribeShared2 = onSnapshot(q2, (snap) => {
        if (currentViewMode !== 'shared') return;
        snap.docChanges().forEach(c => resultsMap.set(c.doc.id, { ...c.doc.data(), id: c.doc.id }));
        renderUnifiedList();
    });
}



// Fun√ß√£o para converter RGB para Hex (para comparar cores)
function rgbToHex(rgb) {
    if (!rgb || rgb === 'transparent' || rgb === 'rgba(0, 0, 0, 0)') return '#000000'; // Default preto
    // Se j√° vier em hex, devolve logo
    if (rgb.startsWith('#')) return rgb;
    
    const rgbValues = rgb.match(/\d+/g);
    if (!rgbValues) return '#000000';
    
    return "#" + 
        ("0" + parseInt(rgbValues[0], 10).toString(16)).slice(-2) +
        ("0" + parseInt(rgbValues[1], 10).toString(16)).slice(-2) +
        ("0" + parseInt(rgbValues[2], 10).toString(16)).slice(-2);
}


window.toggleJournalToolbar = function(isJournalMode) {
    const popup = document.getElementById('formatting-popup');
    if (!popup) return;

    // Seletores dos bot√µes que queremos mover
    const buttons = {
        toggle: document.querySelector('button[data-action="insert-toggle-h2"]'), // ‚òÇ
        drag:   document.querySelector('button[data-action="make-draggable"]'),   // ·Øì
        check:  document.querySelector('button[data-action="insert-checkbox"]'),  // ‚òëÔ∏è
        hr:     document.querySelector('button[data-cmd-sec="insertHorizontalRule"]'), // ‚Äï
        table:  document.querySelector('button[data-action="insert-table"]'),     // üßÆ
        date:   document.querySelector('button[data-action="insert-date"]'),      // üìÖ
        time:   document.querySelector('button[data-action="insert-timeline"]')   // üå≥
    };

    // Grupos da Toolbar
    const groupStyle   = document.getElementById('group-style');   // Onde est√° a Cor
    const groupSimple  = document.getElementById('group-simple');  // Onde estavam Check/Linha
    const groupComplex = document.getElementById('group-complex'); // Onde estavam Tabela/Data
    const groupJournal = document.getElementById('group-journal-extras'); // Onde est√£o üñºÔ∏è ü™ß ü™™ üßä
    
    // Todos os separadores padr√£o da barra
    const allSeparators = document.querySelectorAll('#secondary-toolbar > .toolbar-separator');

    // === L√ìGICA DO MODO JORNAL ===
    if (isJournalMode) {
        
        // 1. MOSTRAR o grupo do Jornal
        if (groupJournal) groupJournal.style.display = 'flex';

        // 2. ESCONDER os grupos que v√£o ficar vazios (para n√£o ocuparem espa√ßo)
        if (groupSimple)  groupSimple.style.display = 'none';
        if (groupComplex) groupComplex.style.display = 'none';

        // 3. ESCONDER todos os separadores antigos
        allSeparators.forEach(sep => sep.style.display = 'none');

        // 4. CRIAR um separador especial entre a Cor e o grupo Jornal
        if (groupStyle) {
            groupStyle.style.borderRight = "1px solid var(--border-color)";
            groupStyle.style.paddingRight = "6px";
            groupStyle.style.marginRight = "6px";
        }

        // 5. MOVER bot√µes para o Popup
        if (!popup.querySelector('#journal-tools-container')) {
            const topContainer = document.createElement('div');
            topContainer.id = 'journal-tools-container';
            
            let defaultRow = popup.querySelector('.default-tools-row');
            if (!defaultRow) {
                defaultRow = document.createElement('div');
                defaultRow.className = 'default-tools-row';
                while (popup.firstChild) defaultRow.appendChild(popup.firstChild);
                popup.appendChild(defaultRow);
            }
            popup.insertBefore(topContainer, popup.firstChild);
        }

        const container = document.getElementById('journal-tools-container');
        popup.classList.add('journal-mode');

        Object.values(buttons).forEach(btn => {
            if (btn && container && btn.parentElement !== container) {
                container.appendChild(btn);
            }
        });

    } else {
        // === MODO NORMAL (RESTAURAR) ===
        
        popup.classList.remove('journal-mode');
        
        // 1. ESCONDER o grupo do Jornal
        if (groupJournal) groupJournal.style.display = 'none';

        // 2. MOSTRAR os grupos normais
        if (groupSimple)  groupSimple.style.display = 'flex';
        if (groupComplex) groupComplex.style.display = 'flex';

        // 3. MOSTRAR os separadores padr√£o
        allSeparators.forEach(sep => sep.style.display = 'block');

        // 4. REMOVER o estilo de separador do group-style
        if (groupStyle) {
            groupStyle.style.borderRight = "none";
            groupStyle.style.paddingRight = "0";
            groupStyle.style.marginRight = "0";
        }

        // 5. DEVOLVER bot√µes √† barra
        const container = document.getElementById('journal-tools-container');
        
        if (groupStyle) {
            if (buttons.toggle) groupStyle.appendChild(buttons.toggle);
            if (buttons.drag)   groupStyle.appendChild(buttons.drag);
        }
        if (groupSimple) {
            if (buttons.check) groupSimple.appendChild(buttons.check);
            if (buttons.hr)    groupSimple.appendChild(buttons.hr);
        }
        if (groupComplex) {
            if (buttons.table) groupComplex.appendChild(buttons.table);
            if (buttons.date)  groupComplex.appendChild(buttons.date);
            if (buttons.time)  groupComplex.appendChild(buttons.time);
        }
    }
};


// Listener para o bot√£o "Tr√™s Pontos" (‚ãÆ)
const moreOptionsBtn = document.getElementById('more-formatting-btn');

if (moreOptionsBtn) {
    // 1. Limpar ouvintes antigos
    const newBtn = moreOptionsBtn.cloneNode(true);
    moreOptionsBtn.parentNode.replaceChild(newBtn, moreOptionsBtn);

    // 2. OUVINTE BLINDADO
    newBtn.addEventListener('mousedown', (e) => { 
        // A. IMPEDE O ROUBO DE FOCO
        e.preventDefault(); 
        e.stopPropagation();

        // B. GUARDA O CURSOR (Essencial para o Jornal)
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            
            // Verifica se o cursor est√° numa √°rea v√°lida (Editor ou T√≠tulos de Caixas)
            const editor = document.getElementById('note-content-editor');
            const isInEditor = editor && editor.contains(range.commonAncestorContainer);
            
            if (isInEditor) {
                journalCursorRange = range.cloneRange();
                console.log("üìç [JORNAL] Posi√ß√£o do cursor guardada.");
            }
        }
    });

    // Nota: O evento 'click' para abrir o menu continua a ser gerido 
    // pelo listener principal do 'editorToolbar', por isso n√£o precisamos de o adicionar aqui.
}


// ============================================================
// MOTOR DE WIDGETS DO JORNAL (IMAGENS E EXTRAS)
// ============================================================
noteContentEditor.addEventListener('click', (e) => {
    const target = e.target;

    // 1. CONVERTER URL EM IMAGEM (Bot√£o OK)
    if (target.classList.contains('cmd-convert-img')) {
        const wrapper = target.closest('.journal-img-wrapper');
        const input = wrapper.querySelector('input');
        const url = input.value.trim();

        if (!url) return alert("Insira um link de imagem.");

        // Substitui o placeholder pela imagem real + interface de edi√ß√£o
        wrapper.innerHTML = `
            <img src="${url}" onerror="this.src='https://via.placeholder.com/300?text=Erro+Imagem'">
            <button class="journal-img-edit-btn">Editar</button>
            <div class="journal-img-menu">
                <button data-act="change-link">üîó Mudar Link</button>
                <button data-act="resize-sm">‚ñ´Ô∏è Pequena</button>
                <button data-act="resize-md">‚óªÔ∏è M√©dia</button>
                <button data-act="resize-lg">‚¨ú Grande</button>
                <button data-act="resize-xl">‚¨õ Gigante</button>
                <hr style="width:100%; border:0; border-top:1px solid #444; margin:2px 0;">
                <button data-act="remove-img" style="color:#e74c3c;">üóëÔ∏è Remover</button>
            </div>
        `;
        saveNote();
    }

    // 2. ABRIR MENU EDITAR
    else if (target.classList.contains('journal-img-edit-btn')) {
        const wrapper = target.closest('.journal-img-wrapper');
        const menu = wrapper.querySelector('.journal-img-menu');
        
        // Fecha outros menus abertos
        document.querySelectorAll('.journal-img-menu').forEach(m => {
            if(m !== menu) m.classList.remove('visible');
        });

        menu.classList.toggle('visible');
    }

    // 3. A√á√ïES DO MENU
    else if (target.closest('.journal-img-menu')) {
        const btn = target.closest('button');
        if (!btn) return;
        
        const wrapper = btn.closest('.journal-img-wrapper');
        const action = btn.dataset.act;
        const menu = wrapper.querySelector('.journal-img-menu');

        // A. REMOVER
        if (action === 'remove-img') {
            if(confirm("Remover imagem?")) wrapper.remove();
        } 
        
        // B. MUDAR LINK (Volta ao estado input)
        else if (action === 'change-link') {
            const currentSrc = wrapper.querySelector('img').src;
            wrapper.innerHTML = `
                <div class="journal-img-placeholder">
                    <span>üñºÔ∏è</span>
                    <input type="text" value="${currentSrc}" class="img-url-input">
                    <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px;">OK</button>
                </div>`;
        }

        // C. REDIMENSIONAR
        else if (action.startsWith('resize-')) {
            const size = action.split('-')[1]; // sm, md, lg, xl
            // Remove classes antigas
            wrapper.classList.remove('img-size-sm', 'img-size-md', 'img-size-lg', 'img-size-xl');
            // Adiciona a nova
            wrapper.classList.add(`img-size-${size}`);
            menu.classList.remove('visible');
        }

        saveNote();
    }
    
    // Fechar menu se clicar fora (dentro do editor)
    else {
        document.querySelectorAll('.journal-img-menu').forEach(m => m.classList.remove('visible'));
    }
});

// ============================================================
// LISTENER ESPEC√çFICO PARA OS EXTRAS DO JORNAL (Barra Secund√°ria)
// ============================================================
 const secToolbar = document.getElementById('secondary-toolbar');

if (secToolbar) {
    // Removemos listener antigo para garantir que n√£o duplica
    const newSecToolbar = secToolbar.cloneNode(true);
    secToolbar.parentNode.replaceChild(newSecToolbar, secToolbar);

    newSecToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        e.preventDefault(); // Impede perda de foco
        

        // 1. DECLARA√á√ÉO DE VARI√ÅVEIS CR√çTICA
        const action = btn.dataset.action; 
        const cmdSec = btn.dataset.cmdSec;
        const val = btn.dataset.val;

        // Fun√ß√£o auxiliar de inser√ß√£o
        const insertWidget = (html, id, focusSelector) => {
            const editor = document.getElementById('note-content-editor');
            if (document.activeElement !== editor && !editor.contains(document.activeElement)) {
                editor.focus();
            }
            document.execCommand('insertHTML', false, html);
            if (typeof updateSaveStatus === 'function') updateSaveStatus('unsaved');
            
            setTimeout(() => {
                const element = document.getElementById(id);
                if (element) {
                    const inputToFocus = element.querySelector(focusSelector);
                    if (inputToFocus) inputToFocus.focus();
                    requestAnimationFrame(() => {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                }
            }, 50);
            if (typeof saveNote === 'function') saveNote(false);
        };

        // --- A. FORMATA√á√ÉO DE TEXTO (A1, A2, P) ---
        if (cmdSec === 'formatBlock') {
            document.execCommand('formatBlock', false, val);
            // Limpeza de estilos sujos
            const selection = window.getSelection();
            if (selection.anchorNode) {
                let block = selection.anchorNode.parentNode;
                if (block.tagName === val) block.removeAttribute('style');
            }
            saveNote();
        }

        // --- B. OUTROS COMANDOS SIMPLES ---
        else if (cmdSec) {
            document.execCommand(cmdSec, false, null);
            saveNote();
        }

        // --- C. WIDGETS ESPEC√çFICOS ---

        // 1. TOGGLE (‚òÇ) - CORRIGIDO
        else if (action === 'insert-toggle-h2') {
            const uniqueId = 'toggle_' + Date.now();
            const toggleHTML = `
                <details class="toggle-section" open id="${uniqueId}">
                    <summary>
                        <h2>T√≠tulo Expans√≠vel</h2>
                        <button class="toggle-move-btn" data-action="move-up" title="Subir">üî∫</button>
                        <button class="toggle-move-btn" data-action="move-down" title="Descer">üîª</button>
                        <button class="toggle-color-btn" contenteditable="false" title="Cor">üñåÔ∏è</button>
                        <button class="toggle-delete-btn" contenteditable="false" title="Apagar">üóëÔ∏è</button>
                    </summary>
                    <div class="toggle-content" contenteditable="true"><p><br></p></div>
                </details><p><br></p>`;
            
            document.execCommand('insertHTML', false, toggleHTML);
            
            // Foca no H2 (T√≠tulo)
            setTimeout(() => {
                const el = document.getElementById(uniqueId);
                const h2 = el ? el.querySelector('h2') : null;
                if(h2) {
                    const range = document.createRange();
                    range.selectNodeContents(h2);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }, 50);
            saveNote();
        }

        // 2. CHECKBOX (‚òëÔ∏è)
        else if (action === 'insert-checkbox') {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.style.marginRight = '8px';
            if (typeof insertNodeAtCursor === 'function') insertNodeAtCursor(checkbox);
            saveNote();
        }

        // 3. TABELA (üßÆ)
        else if (action === 'insert-table') {
            const tableHTML = `
                <div class="jwn-table-wrapper">
                    <button class="table-settings-btn" contenteditable="false">üõ†Ô∏è Op√ß√µes</button>
                    <table class="jwn-table">
                        <thead><tr><th>T√≠tulo 1</th><th>T√≠tulo 2</th></tr></thead>
                        <tbody><tr><td><br></td><td><br></td></tr></tbody>
                    </table>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, tableHTML);
            saveNote();
        }

        // 4. TIMELINE (üå≥)
        else if (action === 'insert-timeline') {
            const timelineId = `tl_${Date.now()}`;
            const timelineHTML = `
                <div class="jwn-timeline-wrapper" contenteditable="false" id="${timelineId}">
                    <div class="timeline-track"></div>
                    <div class="timeline-container">
                        <div class="timeline-entry">
                            <div class="t-marker"></div>
                            <div class="t-date" contenteditable="true">Data</div>
                            <div class="t-text" contenteditable="true">Evento...</div>
                            <button class="t-btn-del">√ó</button>
                        </div>
                    </div>
                    <button class="t-btn-add">‚ûï Ponto</button>
                </div><p><br></p>`;
            document.execCommand('insertHTML', false, timelineHTML);
            saveNote();
        }

        // 5. CALEND√ÅRIO (üìÖ)
        else if (action === 'insert-date') {
            const calId = `cal_${Date.now()}`;
            const today = new Date();
            const widgetHTML = `
                <div class="jwn-calendar-widget" contenteditable="false" id="${calId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}">
                    <div class="cal-header">
                        <button class="cal-btn cal-prev">‚óÄ</button>
                        <span class="cal-title">Carregando...</span>
                        <div style="display:flex; gap:5px;">
                            <button class="cal-btn cal-next">‚ñ∂</button>
                            <button class="cal-btn cal-settings">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="cal-settings-menu">
                        <button class="cal-delete-btn">üóëÔ∏è Eliminar Agenda</button>
                    </div>
                    <div class="cal-grid"></div>
                </div><p><br></p>`;
            
            document.execCommand('insertHTML', false, widgetHTML);
            setTimeout(() => { if (typeof renderCalendarUI === 'function') renderCalendarUI(document.getElementById(calId)); }, 50);
            saveNote();
        }

        // 6. ARRASTAR (·Øì)
        else if (action === 'make-draggable') {
            const selection = window.getSelection();
            const text = selection.toString() || "Texto arrast√°vel";
            const uniqueId = `drag_${Date.now()}`;
            const draggableHTML = `
                <div class="draggable-line" draggable="true" id="${uniqueId}">
                    <span class="drag-handle-icon" contenteditable="false">·Øì</span>
                    <div class="drag-content-area" contenteditable="true">${text}</div>
                </div>`;
            document.execCommand('insertHTML', false, draggableHTML);
            saveNote();
        }

        // 7. DUAS COLUNAS (‚è∏Ô∏è)
        else if (action === 'insert-2-cols') {
            const uniqueId = `cols_${Date.now()}`;
            const colsHTML = `
                <div class="journal-cols-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="cols-toolbar">
                        <span style="font-size:10px; color:#888; margin-right:5px;">COLUNAS</span>
                        <button class="cols-btn-del" onclick="window.deleteCols(this)" title="Apagar Colunas">üóëÔ∏è</button>
                    </div>
                    <div class="journal-cols-container">
                        <div class="journal-col" contenteditable="true" data-placeholder="Esquerda..."></div>
                        <div class="journal-col" contenteditable="true" data-placeholder="Direita..."></div>
                    </div>
                </div><p><br></p>`;
            insertWidget(colsHTML, uniqueId, '.journal-col');
        }

        // 8. IMAGEM (üñºÔ∏è)
        else if (action === 'insert-image') {
            const uniqueId = `img_${Date.now()}`;
            const widgetHTML = `
                <div class="journal-img-wrapper img-size-md" id="${uniqueId}" contenteditable="false">
                    <div class="journal-img-placeholder">
                        <span style="font-size: 24px;">üñºÔ∏è</span>
                        <input type="text" placeholder="URL da imagem..." class="img-url-input">
                        <button class="cmd-convert-img modal-btn primary" style="padding:2px 8px;">OK</button>
                    </div>
                </div><p><br></p>`;
            insertWidget(widgetHTML, uniqueId, 'input');
        }

        // 9. RACIOC√çNIO (ü™ß)
        else if (action === 'insert-sign') {
            const uniqueId = `sign_${Date.now()}`;
            const signHTML = `
                <div class="journal-sign-wrapper" id="${uniqueId}" contenteditable="false">
                    <div class="sign-toolbar">
                        <span style="font-size: 1.2em; margin-right: auto;">ü™ß Racioc√≠nio</span>
                        <button class="sign-btn-del" onclick="window.confirmSignDelete(this)">üóëÔ∏è</button>
                    </div>
                    <div class="sign-header">
                        <input type="text" class="sign-title-input" placeholder="Linha de Racioc√≠nio...">
                    </div>
                    <div class="sign-content" contenteditable="true" data-placeholder="Escreva aqui..."></div>
                </div><p><br></p>`;
            insertWidget(signHTML, uniqueId, '.sign-title-input');
        }

        // 10. CART√ÉO (ü™™)
        else if (action === 'insert-card') {
            const uniqueId = `card_${Date.now()}`;
            const cardHTML = `
                <div class="journal-id-card" id="${uniqueId}" contenteditable="false">
                    <div class="card-toolbar">
                        <button class="card-del-btn" onclick="window.deleteJournalWidget(this)">üóëÔ∏è</button>
                    </div>
                    <div class="card-body">
                        <div class="card-image-area"><div class="card-img-placeholder" onclick="window.setCardImage(this)"><span>üì∑</span></div></div>
                        <div class="card-text-area">
                            <input type="text" class="card-title-input" placeholder="Nome / T√≠tulo">
                            <div class="card-desc-content" contenteditable="true" data-placeholder="Detalhes..."></div>
                        </div>
                    </div>
                </div><p><br></p>`;
            insertWidget(cardHTML, uniqueId, '.card-title-input');
        }

        // 11. CUBO (üßä)
      else if (action === 'insert-cube') {
    const uniqueId = `cube_${Date.now()}`;
    
    // HTML com novos controlos na Toolbar
    const cubeHTML = `
        <div class="journal-cube-wrapper" id="${uniqueId}" contenteditable="false" style="float:left; width:45%; transform: rotate(0deg); background-color: var(--panel-color);">
            
            <div class="cube-toolbar" contenteditable="false">
                <span class="cube-drag-handle" title="Arrastar" draggable="true" style="cursor:grab;">‚ú•</span>
                
                <div style="width:1px; background:#555; height:15px; margin:0 2px;"></div>
                
                <!-- Alinhamento -->
                <button onclick="this.closest('.journal-cube-wrapper').style.float='left'" title="Esquerda">‚¨Ö</button>
                <button onclick="this.closest('.journal-cube-wrapper').style.float='none'; this.closest('.journal-cube-wrapper').style.width='100%'" title="Centro/Total">‚¨õ</button>
                <button onclick="this.closest('.journal-cube-wrapper').style.float='right'" title="Direita">‚û°</button>
                
                <div style="width:1px; background:#555; height:15px; margin:0 2px;"></div>

                <!-- Largura -->
                <button onclick="window.resizeCube(this, -10)" title="Encolher">‚ûñ</button>
                <button onclick="window.resizeCube(this, 10)" title="Alargar">‚ûï</button>

                <div style="width:1px; background:#555; height:15px; margin:0 2px;"></div>

                <!-- Rota√ß√£o (Tilt) -->
                <button onclick="window.rotateCube(this, -2)" title="Rodar Esq">‚Ü∫</button>
                <button onclick="window.rotateCube(this, 2)" title="Rodar Dir">‚Üª</button>

                <div style="width:1px; background:#555; height:15px; margin:0 2px;"></div>

                <!-- Cor de Fundo -->
                <input type="color" oninput="this.closest('.journal-cube-wrapper').style.backgroundColor = this.value; window.saveNote();" title="Cor de Fundo">

                <div style="width:1px; background:#555; height:15px; margin:0 2px;"></div>
                
                <button onclick="window.deleteJournalWidget(this)" style="color:#e74c3c;">üóëÔ∏è</button>
            </div>

            <div class="cube-content" contenteditable="true">
                <h3 style="margin-top:0;">üßä Destaque</h3>
                <p>Escreva o seu texto aqui...</p>
            </div>
        </div>
        <p style="clear:both;"><br></p>`; // O clear:both √© vital para o texto seguinte n√£o ficar encavalitado
    
    // Usa a tua fun√ß√£o auxiliar se existir, ou execCommand
    if (typeof insertWidget === 'function') {
        insertWidget(cubeHTML, uniqueId, '.cube-content');
    } else {
        document.execCommand('insertHTML', false, cubeHTML);
    }
}
    });

    // LISTENER DE CORES
    newSecToolbar.addEventListener('input', (e) => {
        const target = e.target;
        if (target.tagName === 'INPUT' && target.dataset.command === 'foreColor') {
            document.execCommand('foreColor', false, target.value);
            saveNote(); 
        }
    });
}

 

// ============================================================
// GESTOR DE CLIQUES NO EDITOR (BOT√ïES DAS CAIXAS)
// ============================================================
noteContentEditor.addEventListener('click', async (e) => {
    // Procura por um bot√£o dentro do editor
    const btn = e.target.closest('button');
    const toggleColorBtn = e.target.closest('.toggle-color-btn');
    const toggleDelBtn = e.target.closest('.toggle-delete-btn');

    // Se n√£o clicou num bot√£o, sai
    if (!btn && !toggleColorBtn && !toggleDelBtn) return;

    const action = btn ? btn.dataset.action : null;

    // --- 1. APAGAR SEC√á√ÉO TOGGLE (‚òÇ) ---
    if (toggleDelBtn) {
        e.preventDefault(); e.stopPropagation();
        const detailsElement = toggleDelBtn.closest('details');
        if (!detailsElement) return;

        const confirmed = await showConfirmation("Ocultar Sec√ß√£o?", "Todo o conte√∫do dentro dela ser√° movido para o hist√≥rico.");
        if (confirmed) {
            await archiveMiniNote(detailsElement);
        }
        return;
    }

    // --- 2. APAGAR ENTIDADE/CAIXA (üóëÔ∏è) - CORRE√á√ÉO ---
    if (action === 'delete-mini-note') {
        e.preventDefault(); 
        e.stopPropagation(); 
        
        // Limpa timers de grava√ß√£o para n√£o interferir
        if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);
        
        const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .statue-card-wrapper');
        if (!wrapper) return;

        // Se for uma caixa de Racioc√≠nio (Sign), tem fun√ß√£o pr√≥pria, mas o archiveMiniNote tamb√©m funciona
        if (wrapper.classList.contains('journal-sign-wrapper')) {
            if (typeof window.confirmSignDelete === 'function') {
                window.confirmSignDelete(btn);
                return;
            }
        }

        let label = "Item";
        if (wrapper.classList.contains('redator-wrapper')) label = "Redator";
        else if (wrapper.classList.contains('question-mode')) label = "Quest√£o";
        else if (wrapper.classList.contains('statue-card-wrapper')) label = "Est√°tua";
        else label = "SubNota";

        const confirmed = await showConfirmation("Mover para a Lixeira?", `Deseja ocultar este ${label}?`);
        
        if (confirmed) {
            await archiveMiniNote(wrapper);
        }
        return;
    }

    // --- 3. BOT√ÉO DE COR (üé®) ---
    if (action === 'highlight-color') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper, details.toggle-section, .redator-wrapper');
        if (wrapper) openHighlightPopup(wrapper);
        return;
    }

    // --- 4. BOT√ÉO DE T√ìPICOS (üìã) ---
    if (action === 'manage-mini-note-topics') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper');
        if (wrapper) openTopicsModalForMiniNote(wrapper);
        return;
    }

    // --- 5. BOT√ÉO DE LINKS (‚ö°) ---
    if (action === 'manage-box-links') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
        if (wrapper) openBoxLinkManager(wrapper);
        return;
    }

    // --- 6. BOT√ÉO DE CLONAR (üß¨) ---
    if (action === 'append-mini-note') {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.mini-note-wrapper, .redator-wrapper');
        if (wrapper) {
            window.htmlToAppend = wrapper.outerHTML + "<p><br></p>"; 
            openAppendModal();
        }
        return;
    }

    // --- 7. PINCEL DO TOGGLE (üñåÔ∏è) ---
    if (toggleColorBtn) {
        e.preventDefault(); e.stopPropagation();
        window.activeToggleForColor = toggleColorBtn.closest('details.toggle-section');
        const rect = toggleColorBtn.getBoundingClientRect();
        const popup = document.getElementById('toggle-color-popup');
        popup.style.display = 'block';
        popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
        popup.style.left = `${(rect.left + window.scrollX) - 100}px`;
        return;
    }
});


// ============================================================
// L√ìGICA DA CAIXA DE RACIOC√çNIO (PLACA ü™ß)
// ============================================================

// 1. Fun√ß√£o chamada pelo bot√£o "+"
window.addAttachmentToSign = function(btn) {
    activeSignBtn = btn; // Guarda a refer√™ncia do bot√£o clicado
    
    const modal = document.getElementById('attachment-modal');
    const input = document.getElementById('attachment-url-input');
    
    if (!modal) return;

    // Limpa e prepara o modal
    input.value = "";
    
    // Move para o body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.opacity = "1";
    modal.style.visibility = "visible";
    
    // Foca no input
    setTimeout(() => input.focus(), 100);
};

// 2. L√≥gica do Bot√£o "Adicionar" (Dentro do Modal)
document.getElementById('confirm-attachment-btn').addEventListener('click', () => {
    const input = document.getElementById('attachment-url-input');
    const url = input.value.trim();
    const modal = document.getElementById('attachment-modal');

    if (!url) {
        alert("Por favor, insira um link.");
        return;
    }

    if (activeSignBtn) {
        processAttachment(url, activeSignBtn);
    }

    modal.style.display = 'none';
    activeSignBtn = null; // Limpa a refer√™ncia
});

// 3. L√≥gica do Bot√£o "Cancelar"
document.getElementById('cancel-attachment-btn').addEventListener('click', () => {
    document.getElementById('attachment-modal').style.display = 'none';
    activeSignBtn = null;
});

// 4. Permitir "Enter" no input para confirmar
document.getElementById('attachment-url-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('confirm-attachment-btn').click();
    }
});

// 5. Fun√ß√£o que processa o URL e cria o HTML (Separada para organiza√ß√£o)
function processAttachment(url, btn) {
    const wrapper = btn.closest('.journal-sign-wrapper');
    const container = wrapper.querySelector('.sign-attachments-area');

    // Garante protocolo
    let finalUrl = url.trim();
    if (!finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;

    // Tenta obter um nome curto para mostrar (dom√≠nio ou nome do ficheiro)
    let displayName = finalUrl;
    try {
        const urlObj = new URL(finalUrl);
        displayName = urlObj.hostname.replace('www.', '') + (urlObj.pathname.length > 1 ? '/...' : '');
        // Se for imagem, mostra o nome do ficheiro
        if (/\.(jpeg|jpg|gif|png|webp)$/i.test(finalUrl)) {
            displayName = "üñºÔ∏è " + finalUrl.split('/').pop();
        } else {
            displayName = "üîó " + displayName;
        }
    } catch (e) { }

    const div = document.createElement('div');
    div.className = 'sign-attachment-row';
    
    // HTML da Linha: Texto (que √© o link) + Bot√µes de Editar e Apagar
    div.innerHTML = `
        <a href="${finalUrl}" target="_blank" class="sign-link-text" title="${finalUrl}">${displayName}</a>
        
        <button class="sign-row-btn" title="Editar Link" onclick="window.editSignAttachment(this)">‚úèÔ∏è</button>
        <button class="sign-row-btn delete" title="Remover" onclick="window.deleteSignAttachment(this)">üóëÔ∏è</button>
        
        <input type="hidden" class="real-url-val" value="${finalUrl}">
    `;

    container.appendChild(div);
    
    if (typeof saveNote === 'function') saveNote();
}

// ============================================================
// FUN√á√ÉO PARA MOVER CAIXAS DE RACIOC√çNIO
// ============================================================
window.moveSign = function(btn, direction) {
    // Procura o wrapper pai mais pr√≥ximo que corresponda a QUALQUER tipo de caixa
    const wrapper = btn.closest('.journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper');
    
    if (!wrapper) {
        console.error("Erro: Caixa n√£o encontrada para mover.");
        return;
    }

    const parent = wrapper.parentNode;
    
    // MOVER PARA CIMA
    if (direction === -1) {
        let prev = wrapper.previousElementSibling;
        
        // Salta elementos de espa√ßamento (br ou p vazios)
        while (prev && (prev.tagName === 'BR' || (prev.tagName === 'P' && prev.textContent.trim() === ''))) {
            prev = prev.previousElementSibling;
        }

        if (prev) {
            // Insere antes do elemento anterior
            parent.insertBefore(wrapper, prev);
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if (typeof saveNote === 'function') saveNote();
        }
    } 
    // MOVER PARA BAIXO
    else {
        let next = wrapper.nextElementSibling;
        
        // Salta elementos de espa√ßamento
        while (next && (next.tagName === 'BR' || (next.tagName === 'P' && next.textContent.trim() === ''))) {
            next = next.nextElementSibling;
        }

        if (next) {
            // Insere depois do pr√≥ximo elemento (usando nextSibling do pr√≥ximo)
            parent.insertBefore(wrapper, next.nextSibling);
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if (typeof saveNote === 'function') saveNote();
        }
    }
};


// Fun√ß√£o para Editar um anexo da lista
window.editSignAttachment = function(btn) {
    activeEditRow = btn.closest('.sign-attachment-row');
    const hiddenInput = activeEditRow.querySelector('.real-url-val');
    const modal = document.getElementById('edit-link-modal');
    const input = document.getElementById('edit-link-url-input');

    if (!modal || !hiddenInput) return;

    // Preenche o input com o valor atual
    input.value = hiddenInput.value;

    // Move para o body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';

    setTimeout(() => input.focus(), 100);
};

// Listener do Bot√£o Gravar (Fora da fun√ß√£o para n√£o duplicar eventos)
const confirmEditBtn = document.getElementById('confirm-edit-link-btn');
if (confirmEditBtn) {
    confirmEditBtn.addEventListener('click', () => {
        const input = document.getElementById('edit-link-url-input');
        const modal = document.getElementById('edit-link-modal');
        const newUrl = input.value.trim();

        if (newUrl && activeEditRow) {
            let finalUrl = newUrl;
            if (!finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;

            // Atualiza os elementos na linha
            const linkEl = activeEditRow.querySelector('a.sign-link-text');
            const hiddenInput = activeEditRow.querySelector('.real-url-val');
            const openBtn = activeEditRow.querySelector('button[title="Ir para p√°gina"]');

            linkEl.href = finalUrl;
            linkEl.title = finalUrl;
            hiddenInput.value = finalUrl;
            if(openBtn) openBtn.setAttribute('onclick', `window.open('${finalUrl}', '_blank')`);

            // Atualiza o nome de exibi√ß√£o
            try {
                const urlObj = new URL(finalUrl);
                let displayName = urlObj.hostname.replace('www.', '') + (urlObj.pathname.length > 1 ? '/...' : '');
                if (/\.(jpeg|jpg|gif|png|webp)$/i.test(finalUrl)) {
                    displayName = "üñºÔ∏è " + finalUrl.split('/').pop();
                } else {
                    displayName = "üîó " + displayName;
                }
                linkEl.textContent = displayName;
            } catch(e) { 
                linkEl.textContent = "üîó " + finalUrl; 
            }

            if (typeof saveNote === 'function') saveNote();
        }

        modal.style.display = 'none';
        activeEditRow = null;
    });
}

window.deleteSignAttachment = async function(btn) {
    // Usa o seu modal de confirma√ß√£o existente
    const confirmed = await showConfirmation(
        "Remover Link?", 
        "Deseja remover este anexo da lista?"
    );

    if (confirmed) {
        const row = btn.closest('.sign-attachment-row');
        if (row) row.remove();
        if (typeof saveNote === 'function') saveNote();
    }
};

// Fun√ß√£o para definir a imagem do Cart√£o Tem√°tico
window.setCardImage = function(element) {
    activeCardImageElement = element; // Guarda a refer√™ncia
    
    const modal = document.getElementById('card-image-modal');
    const input = document.getElementById('card-image-url-input');
    
    if (!modal) return;

    // Se j√° tiver imagem, preenche o input com o URL atual
    if (element.tagName === 'IMG') {
        input.value = element.src;
    } else {
        input.value = "";
    }

    // Move para o body e mostra
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    
    setTimeout(() => input.focus(), 100);
};

// 2. L√≥gica do Bot√£o Confirmar
const confirmImgBtn = document.getElementById('confirm-card-image-btn');
if (confirmImgBtn) {
    confirmImgBtn.addEventListener('click', () => {
        const input = document.getElementById('card-image-url-input');
        const modal = document.getElementById('card-image-modal');
        const url = input.value.trim();

        if (url && activeCardImageElement) {
            // Cria a tag de imagem
            const imgHTML = `<img src="${url}" class="card-real-img" onclick="window.setCardImage(this)" title="Clique para alterar" onerror="this.src='https://via.placeholder.com/150?text=Erro'">`;
            
            // Substitui√ß√£o
            if (activeCardImageElement.classList.contains('card-img-placeholder')) {
                activeCardImageElement.outerHTML = imgHTML;
            } 
            else if (activeCardImageElement.tagName === 'IMG') {
                activeCardImageElement.src = url;
            }
            
            if (typeof saveNote === 'function') saveNote();
        }

        modal.style.display = 'none';
        activeCardImageElement = null;
    });
}

// 3. Permitir Enter para confirmar
document.getElementById('card-image-url-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('confirm-card-image-btn').click();
    }
});


// Fun√ß√£o para apagar o bloco de colunas
window.deleteCols = async function(btn) {
    // Usa o modal de confirma√ß√£o bonito
    const confirmed = await showConfirmation(
        "Apagar Colunas?", 
        "Todo o conte√∫do dentro das colunas ser√° perdido."
    );

    if (confirmed) {
        const wrapper = btn.closest('.journal-cols-wrapper');
        if (wrapper) {
            wrapper.remove();
            if (typeof saveNote === 'function') saveNote();
        }
    }
};

// --- FUN√á√ïES DO REDATOR ---

// 1. Adicionar Novo Redator Abaixo (+)
window.addRedatorBelow = function(currentId) {
    const currentWrapper = document.getElementById(currentId);
    if (!currentWrapper) return;

    // 1. Guardar posi√ß√£o atual do scroll para restaurar se necess√°rio
    const editor = document.getElementById('note-content-editor');
    const savedScroll = editor.scrollTop;

    // 2. Criar os elementos novos
    const spacer = document.createElement('p');
    spacer.innerHTML = '<br>';

    // Gera o ID √∫nico para o novo redator
    const newId = `red_${Date.now()}`;
    const inputStyle = "user-select: text; -webkit-user-select: text; pointer-events: auto; touch-action: manipulation;";

    // --- AQUI EST√Å A CORRE√á√ÉO PRINCIPAL ---
    // 1. Usamos a vari√°vel ${newId} em vez de ${uniqueId}
    // 2. Inclu√≠mos a estrutura nova com o bot√£o de menu colapsado
    const newRedatorHTML = `
        <div class="redator-wrapper" id="${newId}" contenteditable="false" data-shared="false" data-box-links='{}' data-paragraph="0">
            
            <!-- BOT√ïES FLUTUANTES (Colapsado) -->
            <button class="redator-reopen-btn" onclick="window.toggleRedatorHeader('${newId}', true)">T</button>
            <button class="redator-collapsed-menu-btn" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>

            <!-- O MENU (Fora do header) -->
            <div class="redator-slide-menu">
                <button class="tool-icon-btn" data-action="sharing-settings" title="Partilha">üîê</button>
                <button class="tool-icon-btn" data-action="manage-box-links" title="Links/Codex">‚ö°</button>
                <button class="tool-icon-btn" data-action="move-up" title="Subir">üî∫</button>
                <button class="tool-icon-btn" data-action="move-down" title="Descer">üîª</button>
                <button class="tool-icon-btn" data-action="highlight-color" title="Cor">üé®</button>
                <button class="tool-icon-btn" data-action="manage-mini-note-topics" title="T√≥picos">üìã</button>
                <button class="tool-icon-btn" data-action="append-mini-note" title="Clonar">üß¨</button>
                <div style="width:1px; background:rgba(255,255,255,0.2); height:15px; margin:0 2px;"></div>
                <button class="tool-icon-btn" data-action="delete-mini-note" style="color:#e74c3c;">üóëÔ∏è</button>
            </div>

            <!-- CABE√áALHO -->
            <div class="redator-header" id="header-${newId}">
               <input type="text" class="redator-input" placeholder="T√≠tulo do Redator..." value="" 
                      oninput="this.setAttribute('value', this.value)" 
                      style="${inputStyle}">
                <div class="redator-top-tools">
                    <button class="redator-menu-trigger" onclick="window.toggleRedatorMenu(this)">‚ãÆ</button>
                </div>
            </div>
            
            <div class="redator-content" contenteditable="true" data-placeholder="" oninput="window.checkRedatorFocus(this, '${newId}')"><p><br></p></div>
            
            <div class="redator-dock">
                 <button class="dock-btn" onclick="event.preventDefault(); window.openRedatorFocus('${newId}')">‚á±</button>
                 <div class="dock-sep"></div>
                 <button class="dock-btn" onclick="event.preventDefault(); window.addRedatorBelow('${newId}')">+</button>
            </div>
        </div>
        <p><br></p>`;

    // 3. Inser√ß√£o
    currentWrapper.insertAdjacentElement('afterend', spacer);
    spacer.insertAdjacentHTML('afterend', newRedatorHTML);

    // 4. Corre√ß√£o de Scroll
    if (editor.scrollTop !== savedScroll) {
        editor.scrollTop = savedScroll;
    }

    // 5. Foco e Scroll Suave para o novo elemento
    setTimeout(() => {
        const newEl = document.getElementById(newId);
        if (newEl) {
            const input = newEl.querySelector('.redator-input');
            if (input) input.focus();
            
            window.requestAnimationFrame(() => {
                newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }
    }, 100);

    // 6. Grava
    if (typeof updateRedatorParagraphs === 'function') updateRedatorParagraphs();
    saveNote();
};

// Vari√°vel para saber qual redator est√° no popup
let activeRedatorFocusId = null;

// 2. Abrir Modo Foco (Popup)
window.openRedatorFocus = function(id) {
    if (activeRedatorPopups.includes(id)) return alert("Este Redator j√° est√° aberto numa janela.");
    if (activeRedatorPopups.length >= MAX_POPUPS) return alert("M√°ximo de 3 janelas abertas simultaneamente.");

    const wrapper = document.getElementById(id);
    if (!wrapper) return;

    wrapper.classList.add('in-popup-mode');
    activeRedatorPopups.push(id);

    const titleVal = wrapper.querySelector('.redator-input').value;
    const contentHTML = wrapper.querySelector('.redator-content').innerHTML;

    const popupId = `popup-${id}`;
    const popup = document.createElement('div');
    popup.className = 'redator-popup-window';
    popup.id = popupId;
    
    // Posi√ß√£o Padr√£o PC
    const offset = activeRedatorPopups.length * 30;
    popup.style.top = `${100 + offset}px`;
    popup.style.left = `${100 + offset}px`;
    popup.style.zIndex = ++highestZIndex;

    popup.innerHTML = `
        <div class="redator-popup-header">
            <span class="popup-title-label">üìì Redator Flutuante</span>
            <button class="btn-close-popup" title="Fechar e Salvar" onclick="window.closeRedatorPopup('${id}')">‚úï</button>
        </div>
        <div class="redator-popup-body">
            <input type="text" class="redator-input" placeholder="T√≠tulo..." value="${titleVal}">
            <div class="redator-content" contenteditable="true" spellcheck="false">${contentHTML}</div>
        </div>
    `;

    document.body.appendChild(popup);

    // ============================================================
    // NOVO: CENTRALIZA√á√ÉO AUTOM√ÅTICA NO MOBILE
    // ============================================================
    if (window.innerWidth <= 768) {
        const rect = popup.getBoundingClientRect();
        const centerX = (window.innerWidth - rect.width) / 2;
        const centerY = (window.innerHeight - rect.height) / 2;
        
        popup.style.top = centerY + 'px';
        popup.style.left = centerX + 'px';
        popup.style.margin = '0';
        popup.style.transform = 'none';
    }
    // ============================================================

    if (typeof makeElementDraggable === 'function') {
        makeElementDraggable(popup);
    }

    popup.onclick = () => { popup.style.zIndex = ++highestZIndex; };
};

// FECHAR POPUP E SINCRONIZAR
window.closeRedatorPopup = function(originalId) {
    const popup = document.getElementById(`popup-${originalId}`);
    const originalWrapper = document.getElementById(originalId);

    if (popup && originalWrapper) {
        // 1. Recuperar Dados
        const newTitle = popup.querySelector('.redator-input').value;
        const newContent = popup.querySelector('.redator-content').innerHTML;

        // 2. Injetar no Original
        originalWrapper.querySelector('.redator-input').value = newTitle;
        originalWrapper.querySelector('.redator-content').innerHTML = newContent;

        // 3. Restaurar Original
        originalWrapper.classList.remove('in-popup-mode');
        
        // 4. Gravar Nota
        saveNote(true);
    }

    // 5. Limpeza
    if (popup) popup.remove();
    activeRedatorPopups = activeRedatorPopups.filter(id => id !== originalId);
};

// 3. Fechar e Gravar Modo Foco
window.closeRedatorFocus = function() {
    const modal = document.getElementById('redator-focus-modal');
    const container = document.getElementById('redator-focus-container');
    const originalWrapper = document.getElementById(activeRedatorFocusId);

    if (originalWrapper && container.children.length > 0) {
        const clone = container.firstElementChild;
        
        // 1. Recuperar dados editados no modal
        const newTitle = clone.querySelector('.redator-input').value;
        const newContent = clone.querySelector('.redator-content').innerHTML;

        // 2. Injetar de volta na nota original
        originalWrapper.querySelector('.redator-input').value = newTitle;
        originalWrapper.querySelector('.redator-content').innerHTML = newContent;

        // 3. Gravar
        saveNote(true);
    }

    modal.style.display = 'none';
    activeRedatorFocusId = null;
};

// --- FUN√á√ÉO DE TOGGLE DO MENU REDATOR ---
window.toggleRedatorMenu = function(btn) {
    // 1. Encontra a caixa principal
    const wrapper = btn.closest('.redator-wrapper');
    if (!wrapper) return;

    // 2. Encontra o menu (agora √© filho direto do wrapper)
    const menu = wrapper.querySelector('.redator-slide-menu');
    if (!menu) return;

    // 3. Fecha outros menus que possam estar abertos noutras caixas
    document.querySelectorAll('.redator-slide-menu.visible').forEach(m => {
        if (m !== menu) m.classList.remove('visible');
    });

    // 4. Abre/Fecha este menu
    menu.classList.toggle('visible');
};



// --- L√ìGICA DE FOCO DO REDATOR ---

// 1. Verifica se deve esconder o t√≠tulo enquanto escreve
window.checkRedatorFocus = function(contentDiv, uniqueId) {
    const wrapper = document.getElementById(uniqueId);
    const titleInput = wrapper.querySelector('.redator-input');
    const header = document.getElementById(`header-${uniqueId}`);

    // Usa trim() para ignorar espa√ßos acidentais do teclado mobile
    const hasNoTitle = titleInput.value.trim() === "";
    const hasBodyContent = contentDiv.innerText.trim().length > 0;

    if (hasNoTitle && hasBodyContent) {
        if (!wrapper.classList.contains('header-hidden')) {
            wrapper.classList.add('header-hidden');
            header.classList.add('collapsed');
        }
    }
};

// 2. Reabre ou Fecha o t√≠tulo manualmente (Bot√£o T)
window.toggleRedatorHeader = function(uniqueId, forceShow = false) {
    const wrapper = document.getElementById(uniqueId);
    const header = document.getElementById(`header-${uniqueId}`);
    const input = wrapper.querySelector('.redator-input');

    if (forceShow) {
        // Mostrar
        wrapper.classList.remove('header-hidden');
        header.classList.remove('collapsed');
        // Foca no input para o user escrever o t√≠tulo logo
        setTimeout(() => input.focus(), 300);
    } else {
        // Esconder (opcional, se quiseres fechar manualmente noutro lugar)
        wrapper.classList.add('header-hidden');
        header.classList.add('collapsed');
    }
};

// --- FUN√á√ÉO: ATUALIZAR PAR√ÅGRAFOS DO REDATOR ---
function updateRedatorParagraphs() {
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    // Seleciona todos os redatores pela ordem em que aparecem no ecr√£
    const redators = editor.querySelectorAll('.redator-wrapper');

    redators.forEach((wrapper, index) => {
        // O √≠ndice come√ßa em 0, por isso somamos 1
        const novoParagrafo = index + 1;
        
        // Atualiza o atributo no HTML (que ser√° salvo no Firebase)
        wrapper.setAttribute('data-paragraph', novoParagrafo);
        
    });
}

// Fun√ß√£o de arrastar janelas (Gen√©rica)
function makeElementDraggable(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    // Tenta encontrar o cabe√ßalho
    const header = elmnt.querySelector(".aq-popup-header") || elmnt.querySelector(".redator-popup-header");
    const dragTarget = header || elmnt;

    if (dragTarget) {
        // PC (Rato)
        dragTarget.onmousedown = dragMouseDown;
        // MOBILE (Toque)
        dragTarget.addEventListener('touchstart', dragTouchStart, { passive: false });
    }

    // ============================
    // L√ìGICA DE COMPUTADOR (RATO)
    // ============================
    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        bringToFront();
        
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        setElementPosition(elmnt.offsetTop - pos2, elmnt.offsetLeft - pos1);
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }

    // ============================
    // L√ìGICA DE MOBILE (TOQUE)
    // ============================
    function dragTouchStart(e) {
        // Se tocou no bot√£o de fechar, n√£o arrasta
        if (e.target.closest('button')) return;

        e.preventDefault(); // Impede scroll da p√°gina
        bringToFront();

        const touch = e.touches[0];
        pos3 = touch.clientX;
        pos4 = touch.clientY;

        document.addEventListener('touchend', closeTouchDrag, { passive: false });
        document.addEventListener('touchmove', touchDrag, { passive: false });
    }

    function touchDrag(e) {
        e.preventDefault(); // Cr√≠tico: Impede o site de mexer

        const touch = e.touches[0];
        
        pos1 = pos3 - touch.clientX;
        pos2 = pos4 - touch.clientY;
        pos3 = touch.clientX;
        pos4 = touch.clientY;

        setElementPosition(elmnt.offsetTop - pos2, elmnt.offsetLeft - pos1);
    }

    function closeTouchDrag() {
        document.removeEventListener('touchend', closeTouchDrag);
        document.removeEventListener('touchmove', touchDrag);
    }

    // ============================
    // AUXILIARES E LIMITES
    // ============================
    function bringToFront() {
        if (typeof highestZIndex !== 'undefined') {
            elmnt.style.zIndex = ++highestZIndex;
        } else {
            elmnt.style.zIndex = new Date().getTime();
        }
    }

    function setElementPosition(newTop, newLeft) {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const rect = elmnt.getBoundingClientRect();

        // Limites (Margem de seguran√ßa de 0px)
        const minTop = 0;
        const maxTop = viewportHeight - rect.height; // N√£o pode descer mais que a altura dele
        const minLeft = 0;
        const maxLeft = viewportWidth - rect.width; // N√£o pode ir mais para a direita que a largura dele

        // Aplica Matem√°tica de Restri√ß√£o (Clamp)
        if (newTop < minTop) newTop = minTop;
        if (newTop > maxTop) newTop = maxTop;
        if (newLeft < minLeft) newLeft = minLeft;
        if (newLeft > maxLeft) newLeft = maxLeft;

        elmnt.style.top = newTop + "px";
        elmnt.style.left = newLeft + "px";
        
        // Remove transforma√ß√µes antigas que possam interferir no posicionamento
        elmnt.style.transform = "none"; 
    }
}

// ============================================================
// GEST√ÉO DAS ABAS DO PAINEL DO MEIO
// ============================================================

// 1. Listener de clique nas abas do fundo
document.querySelector('.middle-bottom-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. ATUALIZA O VISUAL (Remove active de todos, adiciona no clicado)
    document.querySelectorAll('.middle-bottom-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 2. ESCONDE TODAS AS VISTAS
    document.querySelectorAll('.middle-view').forEach(v => v.style.display = 'none');

    // 3. IDENTIFICA A VISTA ALVO
    const viewId = btn.dataset.midTab;
    let targetView;

    if (viewId === 'files') targetView = document.getElementById('file-list');
    else if (viewId === 'index') targetView = document.getElementById('note-index-list');
    else if (viewId === 'texts') targetView = document.getElementById('note-texts-view');
    else if (viewId === 'sources') targetView = document.getElementById('note-sources-list');

    // 4. MOSTRA A VISTA E DISPARA A L√ìGICA
    if (targetView) {
        targetView.style.display = 'block';
        
        // --- A. √çNDICE ---
        if (viewId === 'index') {
            generateNoteIndex();
        }
        
        // --- B. FONTES ---
        else if (viewId === 'sources') {
            generateNoteSources();
        }
        
    // --- C. TEXTOS / NAVEGA (L√≥gica Tripla Corrigida) ---
        else if (viewId === 'texts') {
            
            // Verifica o modo definido no bot√£o (pela fun√ß√£o refreshMiddlePanelTabIcon)
            if (btn.dataset.mode === 'hybrid') {
                generateHybridView(); // <--- FALTAVA ESTA CHAMADA
            } 
            else if (btn.dataset.mode === 'navega') {
                generateAnchorNavigation(); 
            } 
            else {
                generateNoteTexts(); 
            }
        }
    }
});

// 2. FUN√á√ÉO: GERAR √çNDICE (VISTA 2)
 function generateNoteIndex() {
    const list = document.getElementById('note-index-list');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    list.innerHTML = '';
    let hasItems = false;

    // --- MUDAN√áA 1: Adicionei '.idea-span' √† lista de seletores ---
    const elements = editor.querySelectorAll('.mini-note-wrapper, .redator-wrapper, details.toggle-section, .jwn-table-wrapper, .jwn-timeline-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .post-it-note, .idea-span');

    elements.forEach(el => {
        // GARANTIA: Se o elemento n√£o tiver ID, cria um agora
        if (!el.id) el.id = 'idx_' + Math.random().toString(36).substr(2, 9);

        let title = "Sem T√≠tulo";
        let icon = "üü¶";
        let typeLabel = "Item";
        let borderColor = "var(--border-color)";

        // --- L√ìGICA DE IDENTIFICA√á√ÉO ---
        
        // >>> NOVA L√ìGICA PARA IDEIAS (üí°) <<<
        if (el.classList.contains('idea-span')) {
            icon = "üí°"; 
            typeLabel = "Ideia";
            borderColor = "#e74c3c"; // VERMELHO
            
            // L√≥gica das 15 palavras
            const fullText = el.textContent.trim();
            const words = fullText.split(/\s+/); // Divide por espa√ßos
            
            if (words.length > 15) {
                title = words.slice(0, 15).join(" ") + "...";
            } else {
                title = fullText;
            }
        }
        // >>> FIM DO BLOCO IDEIA <<<
        
        else if (el.classList.contains('mini-note-wrapper')) {
            const input = el.querySelector('.mini-note-title-input');
            const content = el.querySelector('.mini-note-content');
            
            if (el.classList.contains('question-mode')) {
                icon = "üìó"; typeLabel = "Quest√£o"; borderColor = "#2ecc71";
                title = input ? (input.value || input.textContent) : "Pergunta";
            } else if (el.classList.contains('free-mode')) {
                icon = "üìô"; typeLabel = "Contentor"; borderColor = "#e67e22";
                title = content ? content.innerText.split('\n')[0].substring(0, 30) : "Texto Livre";
            } else {
                icon = "üìò"; typeLabel = "SubNota"; borderColor = "#3498db";
                title = input ? (input.value || input.textContent) : "SubNota";
            }
        } 
        else if (el.classList.contains('redator-wrapper')) {
            icon = "üìì"; typeLabel = "Redator"; borderColor = "#555555";
            const input = el.querySelector('.redator-input');
            title = input ? input.value : "Redator";
            if(!title || !title.trim()) {
                const content = el.querySelector('.redator-content');
                title = content ? content.innerText.split('\n')[0].substring(0, 30) : "Redator";
            }
        }
        else if (el.tagName === 'DETAILS') {
            icon = "‚òÇ"; typeLabel = "Sec√ß√£o"; borderColor = "#c0392b";
            const h2 = el.querySelector('h2');
            title = h2 ? h2.textContent : "T√≠tulo";
        }
        else if (el.classList.contains('post-it-note')) {
            icon = "üìí"; typeLabel = "Post-it"; borderColor = "#f1c40f"; title = "Post-it";
        }
        else if (el.classList.contains('journal-sign-wrapper')) {
            icon = "ü™ß"; typeLabel = "Racioc√≠nio"; borderColor = "#f1c40f";
            title = el.querySelector('.sign-title-input')?.value || "Racioc√≠nio";
        }
        else if (el.classList.contains('journal-id-card')) {
            icon = "ü™™"; typeLabel = "Cart√£o"; borderColor = "#795548";
            title = el.querySelector('.card-title-input')?.value || "Cart√£o";
        }
        else if (el.classList.contains('jwn-timeline-wrapper')) {
            icon = "üå≥"; typeLabel = "Timeline"; borderColor = "var(--accent-color)"; title = "Linha do Tempo";
        }
        else if (el.classList.contains('jwn-table-wrapper')) {
            icon = "üßÆ"; typeLabel = "Tabela"; borderColor = "var(--text-muted-color)"; title = "Tabela";
        }
        else if (el.classList.contains('journal-cube-wrapper')) {
            icon = "üßä"; typeLabel = "Cubo"; borderColor = "#4a90e2"; title = "Bloco Flutuante";
        }

        hasItems = true;
        const li = document.createElement('li');
        li.className = `index-item`;
        
        li.style.borderLeft = `4px solid ${borderColor}`;
        li.setAttribute('data-target-id', el.id); 
        
        if (!title || title.trim() === "") title = `(${typeLabel} sem t√≠tulo)`;

        li.innerHTML = `
            <span class="index-icon">${icon}</span>
            <div style="display:flex; flex-direction:column; width: 100%;">
                <span style="white-space:normal; word-break:break-word; font-weight:500; line-height:1.3;">${title}</span>
                <small style="color:var(--text-muted-color); font-size:0.8em; margin-top:2px;">${typeLabel}</small>
            </div>
        `;

        li.onclick = () => {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.remove('flash-target'); void el.offsetWidth; el.classList.add('flash-target');
            currentActiveScrollId = el.id;
            updateIndexVisuals(); 
        };

        list.appendChild(li);
    });

    if (!hasItems) {
        list.innerHTML = '<li class="empty-msg">Esta nota n√£o tem caixas nem estrutura especial.</li>';
    }
}



// 4. ATUALIZADOR AUTOM√ÅTICO
// Chame esta fun√ß√£o sempre que gravar a nota ou abrir uma nova
function updateMiddlePanelViews() {
    
    const activeTab = document.querySelector('.middle-bottom-tabs button.active');
    
    if (!activeTab) {
        console.warn("‚ö†Ô∏è [ROUTER] Nenhuma aba ativa encontrada. Abortando.");
        return;
    }

    const view = activeTab.dataset.midTab;

    if (view === 'texts') {

        if (window.currentNoteHybridMode === true) {
            console.log("   -> ‚úÖ CONDI√á√ÉO 1 V√ÅLIDA: Modo Misto. Chamando generateHybridView().");
            activeTab.innerHTML = '<span>üõ≥Ô∏è</span> Misto';
            activeTab.dataset.mode = 'hybrid';
            generateHybridView();
        } 
        else if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
            console.log("   -> ‚úÖ CONDI√á√ÉO 2 V√ÅLIDA: Modo Navega√ß√£o.");
            activeTab.innerHTML = '<span>‚öì</span> Navega';
            activeTab.dataset.mode = 'navega';
            generateAnchorNavigation();
        } 
        else {
            console.log("   -> ‚¨áÔ∏è FALLBACK: Modo Padr√£o (B√≠blia).");
            activeTab.innerHTML = '<span>üìú</span> Textos';
            activeTab.dataset.mode = 'textos';
            generateNoteTexts();
        }
    } else {
    }
}





// --- FUN√á√ïES DE MOTOR B√çBLICO (ABA TEXTOS) ---

// 1. Expande uma refer√™ncia complexa (ex: "Jo√£o 3:1-3, 5") numa lista de vers√≠culos individuais
function expandVerseReference(fullRef) {
    // Regex para capturar: Livro e N√∫meros
    const match = fullRef.match(/^(.+?)\s+(\d+:.*)$/);
    if (!match) return [fullRef];

    const bookName = match[1].trim();
    const numbersPart = match[2]; // ex: "2:13-3:1" ou "3:16, 18"
    
    // Precisamos dos dados do livro para saber os limites dos cap√≠tulos
    // BIBLE_DATA deve estar acess√≠vel globalmente
    const bookData = typeof BIBLE_DATA !== 'undefined' 
        ? BIBLE_DATA.find(b => b.nome === bookName) 
        : null;

    let expandedVerses = [];

    // Separa por v√≠rgulas ou ponto e v√≠rgula
    // (Nota: A fun√ß√£o generateNoteTexts j√° deve ter tratado os ; de cap√≠tulos diferentes,
    // mas aqui tratamos , e intervalos -)
    const groups = numbersPart.split(/[,;]/);

    groups.forEach(group => {
        const g = group.trim();

        // CASO A: Intervalo entre Cap√≠tulos (ex: 2:13-3:1)
        // Procura padr√£o d:d-d:d
        const crossChapterMatch = g.match(/^(\d+):(\d+)\s*[-‚Äì]\s*(\d+):(\d+)$/);

        if (crossChapterMatch && bookData) {
            const startCap = parseInt(crossChapterMatch[1]);
            const startVer = parseInt(crossChapterMatch[2]);
            const endCap = parseInt(crossChapterMatch[3]);
            const endVer = parseInt(crossChapterMatch[4]);

            // Loop pelos cap√≠tulos
            for (let c = startCap; c <= endCap; c++) {
                // Quantos vers√≠culos tem este cap√≠tulo?
                // (Se n√£o houver dados, assume 50 por seguran√ßa)
                const maxVerses = bookData.versiculos ? (bookData.versiculos[c - 1] || 50) : 50;
                
                let vStart = (c === startCap) ? startVer : 1;
                let vEnd = (c === endCap) ? endVer : maxVerses;

                for (let v = vStart; v <= vEnd; v++) {
                    expandedVerses.push(`${bookName} ${c}:${v}`);
                }
            }
            return; // J√° processou este grupo
        }

        // CASO B: Intervalo Simples no mesmo cap√≠tulo (ex: 3:16-18 ou apenas 16-18 se o cap√≠tulo for impl√≠cito)
        // Mas a nossa string principal pode ser "3:16-18".
        
        // Vamos tentar extrair o cap√≠tulo base do in√≠cio do grupo
        // Se o grupo √© "3:16-18", cap √© 3.
        // Se o grupo √© "16-18" (vindo de "3:1, 16-18"), precisamos do contexto.
        // SIMPLIFICA√á√ÉO: Como a nossa regex principal garante "Cap:Vers", assumimos que o grupo come√ßa com Cap.
        // Exceto se for uma lista tipo "3:1, 5". O "5" n√£o tem cap.
        
        // HACK: Para lidar com "3:1, 5", precisamos manter o √∫ltimo cap√≠tulo visto.
        // Mas nesta fun√ß√£o isolada √© dif√≠cil.
        // Para garantir compatibilidade com a regex `\d+:\d+`, vamos assumir que o input
        // j√° vem normalizado ou tratar apenas os que t√™m :.
        
        if (g.includes(':')) {
            const parts = g.split(':');
            const chapter = parts[0];
            const versesPart = parts[1];

            if (versesPart.includes('-') || versesPart.includes('‚Äì')) {
                const [vStart, vEnd] = versesPart.split(/[-‚Äì]/).map(n => parseInt(n));
                for (let v = vStart; v <= vEnd; v++) {
                    expandedVerses.push(`${bookName} ${chapter}:${v}`);
                }
            } else {
                expandedVerses.push(`${bookName} ${chapter}:${versesPart}`);
            }
        } 
        else {
             // Se vier apenas um n√∫mero isolado (o que n√£o devia acontecer com a nova l√≥gica de split),
             // retornamos como est√° para tentar o fallback
             // (Ou implementamos l√≥gica de estado para lembrar o cap√≠tulo anterior, se necess√°rio)
        }
    });

    return expandedVerses.length > 0 ? expandedVerses : [fullRef];
}

// 2. Busca o texto na cole√ß√£o p√∫blica (Cache simples para evitar leituras repetidas na mesma sess√£o)
const bibleTextCache = {}; 

async function fetchPublicBibleText(verseName) {
    // 1. Verifica cache local
    if (bibleTextCache[verseName]) return bibleTextCache[verseName];


    try {
        const { collection, query, where, getDocs, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // --- TENTATIVA A: Busca Exata pelo Nome ---
        const q = query(collection(db, 'bible_verses_public'), where('nome', '==', verseName));
        const snap = await getDocs(q);
        
        if (!snap.empty) {
            const text = snap.docs[0].data().texto;
            bibleTextCache[verseName] = text;
            return text;
        }

        // --- TENTATIVA B: Busca pelo ID Gerado (1_corintios_10_1) ---
        const generatedId = generateBibleId(verseName);
        console.log(`üîÑ Tentando pelo ID: "${generatedId}"`);
        
        const docRef = doc(db, 'bible_verses_public', generatedId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const text = docSnap.data().texto;
            console.log("‚úÖ Encontrado por ID!");
            bibleTextCache[verseName] = text;
            return text;
        }

        console.warn(`‚ùå Texto n√£o encontrado na base de dados: ${verseName} (ID: ${generatedId})`);

    } catch (e) {
        console.error("üî• Erro na busca b√≠blica:", e);
    }
    return null;
}

// 3. FUN√á√ÉO PRINCIPAL: GERAR ABA TEXTOS
function getFlexibleRegexStr(str) {
    return str
        .replace(/[a√°√†√¢√£A√Å√Ä√Ç√É]/g, '[a√°√†√¢√£A√Å√Ä√Ç√É]')
        .replace(/[e√©√®√™E√â√à√ä]/g, '[e√©√®√™E√â√à√ä]')
        .replace(/[i√≠√¨I√ç√å]/g, '[i√≠√¨I√ç√å]')
        .replace(/[o√≥√≤√¥√µO√ì√í√î√ï]/g, '[o√≥√≤√¥√µO√ì√í√î√ï]')
        .replace(/[u√∫√πU√ö√ô]/g, '[u√∫√πU√ö√ô]')
        .replace(/[c√ßC√á]/g, '[c√ßC√á]');
}

// Fun√ß√£o Auxiliar: Remove acentos para compara√ß√£o (Normaliza√ß√£o)
function normalizeStr(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
}

async function generateNoteTexts() {
    const list = document.getElementById('note-texts-view');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    // --- 1. PREPARA√á√ÉO DA REGEX ---
    const canonicalBookMap = {};
    const flexiblePatterns = [];
    
    const sortedBooks = [...BIBLICAL_BOOKS].sort((a, b) => b.length - a.length);

    sortedBooks.forEach(book => {
        const normalized = normalizeStr(book);
        canonicalBookMap[normalized] = book;
        flexiblePatterns.push(getFlexibleRegexStr(book));
    });

    const booksPattern = flexiblePatterns.join('|');

    // Regex que aceita v√≠rgulas para continua√ß√£o
    const regex = new RegExp(
        `(?:^|[\\s"'(])` +
        `(` +
            `(?:${booksPattern})\\s+\\d+:\\d+` + 
            `(?:` +
                `\\s*[-‚Äì]\\s*\\d+(?::\\d+)?` +
                `|` +
                `\\s*;\\s*\\d+(?::\\d+)?` + 
                `|` +
                `\\s*,\\s*\\d+(?!\\s*:)` + 
            `)*` +
        `)`, 
    'gi');

    // --- 2. EXTRA√á√ÉO ---
    let textContent = "";
    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT, {
        acceptNode: (node) => {
            if (node.nodeType === 3) return NodeFilter.FILTER_ACCEPT;
            if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') return NodeFilter.FILTER_ACCEPT;
            return NodeFilter.FILTER_SKIP;
        }
    });

    let currentNode;
    while (currentNode = walker.nextNode()) {
        if (currentNode.nodeType === 3) textContent += currentNode.textContent + " ";
        else textContent += currentNode.value + " ";
    }
    
    // --- 3. PROCESSAMENTO ---
    const rawMatches = textContent.match(regex) || [];
    let processedRefs = [];

    rawMatches.forEach(r => {
        let foundText = r.replace(/^[ "((]+/, '').trim();
        const splitMatch = foundText.match(/^(.+?)\s+(\d+:.*)$/);
        
        if (splitMatch) {
            const originalBookName = splitMatch[1];
            const numbersPart = splitMatch[2];
            
            const normalizedBook = normalizeStr(originalBookName);
            const canonicalBook = canonicalBookMap[normalizedBook] || originalBookName;

            const segments = numbersPart.split(';');
            let currentRefBuffer = ""; 

            segments.forEach((seg, index) => {
                const trimmedSeg = seg.trim();
                
                if (trimmedSeg.includes(':')) {
                    if (currentRefBuffer) processedRefs.push(`${canonicalBook} ${currentRefBuffer}`);
                    currentRefBuffer = trimmedSeg; 
                } else {
                    if (currentRefBuffer) currentRefBuffer += `, ${trimmedSeg}`;
                    else currentRefBuffer = trimmedSeg; 
                }

                if (index === segments.length - 1 && currentRefBuffer) {
                     processedRefs.push(`${canonicalBook} ${currentRefBuffer}`);
                }
            });
        } else {
            processedRefs.push(foundText);
        }
    });

    const uniqueRefs = [...new Set(processedRefs)];
    const prevRefsJSON = list.getAttribute('data-prev-refs') || "[]";
    const prevRefs = JSON.parse(prevRefsJSON);
    const newRefFound = uniqueRefs.find(ref => !prevRefs.includes(ref));

    // --- 4. RENDERIZA√á√ÉO ---
    if (uniqueRefs.length === 0) {
        list.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#888; text-align:center; padding:20px;"><span style="font-size:30px;">üìñ</span><p>Nenhum texto detetado.</p></div>`;
        list.setAttribute('data-prev-refs', "[]");
        return;
    }

    list.innerHTML = ''; 
    let elementToScrollTo = null;
    
    // ARRAY PARA GUARDAR AS PROMESAS (O FIX PARA MOBILE)
    const renderPromises = [];

    for (const cleanRef of uniqueRefs) {
        
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = "padding: 0 15px 15px 15px; border-bottom: 1px solid var(--border-color); text-align: left; position: relative;";
        
        if (newRefFound && cleanRef === newRefFound) elementToScrollTo = itemDiv;

        let displayTitle = cleanRef.split(',')[0].trim();
        if (displayTitle === cleanRef.split(' ')[0]) displayTitle = cleanRef;

        const title = document.createElement('div');
        title.className = 'bible-ref-title';
        title.style.cssText = `font-weight: bold; color: var(--accent-color); cursor: pointer; font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: sticky; top: 0; background-color: var(--panel-color); z-index: 5; padding: 12px 0 8px 0;`;
        
        title.textContent = displayTitle; 
        title.title = cleanRef;
        
        title.onclick = () => {
            if (typeof scrollToAndHighlightText === 'function') {
                scrollToAndHighlightText(displayTitle.split(' ').pop());
            }
        };

        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = "font-size: 0.95em; line-height: 1.5; color: var(--text-color); margin-top: 5px;";
        contentDiv.innerHTML = '<span style="opacity:0.5; font-size:0.8em;">A carregar...</span>';

        itemDiv.appendChild(title);
        itemDiv.appendChild(contentDiv);
        list.appendChild(itemDiv);

        // --- BUSCA ASS√çNCRONA ---
        const individualVerses = expandVerseReference(cleanRef);
        const textPromises = individualVerses.map(v => fetchPublicBibleText(v));
        
        // ADICIONAMOS A PROMESA AO ARRAY DE ESPERA
        const p = Promise.all(textPromises).then(texts => {
            const fullText = texts.filter(t => t).join(" ");
            if (fullText.trim()) {
                contentDiv.textContent = fullText;
            } else {
                contentDiv.innerHTML = '<span style="opacity:0.5; font-size:0.8em;">Texto n√£o dispon√≠vel.</span>';
            }
        });
        
        renderPromises.push(p);
    }

    // Scroll para novo item (se houver)
    if (elementToScrollTo) {
        setTimeout(() => {
            elementToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'start' });
            elementToScrollTo.style.transition = "background-color 0.5s";
            elementToScrollTo.style.backgroundColor = "rgba(46, 204, 113, 0.15)";
            setTimeout(() => elementToScrollTo.style.backgroundColor = "transparent", 1500);
        }, 150);
    }

    list.setAttribute('data-prev-refs', JSON.stringify(uniqueRefs));
    
    // --- O CORA√á√ÉO DA CORRE√á√ÉO ---
    // Aguarda que todos os textos sejam carregados antes de permitir que o c√≥digo do Mobile copie o HTML.
    await Promise.all(renderPromises);
}

// 3. FUN√á√ÉO: GERAR FONTES (VISTA 4)
function generateNoteSources() {
    const list = document.getElementById('note-sources-list');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    list.innerHTML = '';
    let hasSources = false;

    // Procura elementos que tenham o atributo data-box-links
    const elements = editor.querySelectorAll('[data-box-links]');

    elements.forEach(el => {
        const jsonStr = el.getAttribute('data-box-links');
        if (!jsonStr || jsonStr === '{}') return;

        try {
            const data = JSON.parse(jsonStr);
            
            // Verifica se tem URLs, Codex ou Categorias
            const hasUrls = data.urls && Object.keys(data.urls).length > 0;
            const hasCodex = data.codex && data.codex.length > 0;
            const hasCategories = data.categories && data.categories.length > 0;

            if (!hasUrls && !hasCodex && !hasCategories) return;

            hasSources = true;

            // Determina T√≠tulo da Caixa para o Cabe√ßalho
            let boxTitle = data.title; 
            if (!boxTitle) {
                const input = el.querySelector('.mini-note-title-input, .redator-input, .card-title-input, .sign-title-input');
                if (input) boxTitle = input.value || input.textContent;
                else {
                    const content = el.querySelector('.mini-note-content, .redator-content, .cube-content');
                    boxTitle = content ? content.innerText.split('\n')[0].substring(0, 30) : "Caixa Sem T√≠tulo";
                }
            }
            if(!boxTitle || boxTitle.trim() === "") boxTitle = "Caixa Sem T√≠tulo";

            const li = document.createElement('li');
            li.className = 'source-group';

            let itemsHTML = '';
            
            // 1. URLs
            if (hasUrls) {
                Object.values(data.urls).forEach(url => {
                    let linkName = url;
                    try { linkName = new URL(url).hostname.replace('www.',''); } catch(e){}
                    
                    itemsHTML += `
                        <div class="source-link-item" onclick="window.open('${url}', '_blank')">
                            <span>üîó</span> ${linkName} 
                            <span style="font-size:0.7em; color:var(--text-muted-color); margin-left:5px;">‚Üó</span>
                        </div>`;
                });
            }

            // 2. CODEX (AQUI EST√Å A CORRE√á√ÉO)
            if (hasCodex) {
                data.codex.forEach(c => {
                    // Se j√° tivermos o campo 'codiceshow' formatado (nome completo), usamos como tooltip.
                    // Para a lista curta, constru√≠mos a sigla t√©cnica.
                    
                    let shortLabel = c.serie || "Ref.";
                    
                    // Adiciona Cap√≠tulo
                    if (c.capitulo) shortLabel += `, cap ${c.capitulo}`;
                    
                    // Adiciona P√°ginas (pg)
                    if (c.paginas && c.paginas.length > 0) {
                        shortLabel += `, pg ${c.paginas.join(',')}`;
                    }
                    
                    // Adiciona Par√°grafos (pr)
                    if (c.paragrafos && c.paragrafos.length > 0) {
                        shortLabel += `, pr ${c.paragrafos.join(',')}`;
                    }

                    // Adiciona Tempo
                    if (c.tempo) shortLabel += ` [${c.tempo}]`;

                    itemsHTML += `
                        <div class="source-codex-item" title="${c.codiceshow || ''}">
                            <span>üìö</span> ${shortLabel}
                        </div>`;
                });
            }

            // 3. Categorias
            if (hasCategories) {
                data.categories.forEach(c => {
                    let icon = "üîπ";
                    if (c.type === 'personagem') icon = "üë§";
                    if (c.type === 'local') icon = "üìç";
                    if (c.type === 'textobiblico' || c.type === 'bible_public') icon = "üìñ";
                    
                    itemsHTML += `
                        <div class="source-link-item" style="cursor:default; color:var(--text-color);">
                            <span>${icon}</span> ${c.name}
                        </div>`;
                });
            }

            li.innerHTML = `
                <div class="source-header" onclick="document.getElementById('${el.id}').scrollIntoView({behavior:'smooth', block:'center'});">
                    <span style="color:var(--text-muted-color);">‚Ü≥</span> ${boxTitle}
                </div>
                <div class="source-links">${itemsHTML}</div>
            `;

            list.appendChild(li);

        } catch (e) { console.warn("Erro ao parsear links da caixa", e); }
    });

    if (!hasSources) {
        list.innerHTML = '<li class="empty-msg">Nenhuma hiperliga√ß√£o ou Codex encontrado nas caixas (‚ö°).</li>';
    }
}

// Fun√ß√£o auxiliar para criar o ID (ex: "1 Cor√≠ntios 10:1" -> "1_corintios_10_1")
function generateBibleId(name) {
    return name.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos (√≠ -> i)
        .trim()
        .replace(/:/g, '_')       // Substitui : por _
        .replace(/ /g, '_')       // Substitui espa√ßos por _
        .replace(/-/g, '_');      // Substitui tra√ßos por _
}

// ============================================================
// L√ìGICA DO MENU DE VISTAS MOBILE (‚õ∂)
// ============================================================

// 1. Abrir o Modal
document.getElementById('mobile-views-btn').addEventListener('click', (e) => {
    e.preventDefault();
    // Abre o modal
    const modal = document.getElementById('mobile-views-modal');
    modal.style.display = 'flex';
    
    // Abre por defeito na aba "√çndice" ou na √∫ltima usada
    const activeBtn = modal.querySelector('.middle-bottom-tabs button.active') || modal.querySelector('[data-mob-tab="index"]');
    if (activeBtn) activeBtn.click();
});

// 2. Gerir Cliques nas Abas do Modal Mobile
document.addEventListener('click', async (e) => {
    
    const tabsContainer = e.target.closest('#mobile-views-modal .middle-bottom-tabs');
    if (!tabsContainer) return; 

    const btn = e.target.closest('button');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    // GRAVAR NA MEM√ìRIA
    window.lastActiveMobileTab = btn.dataset.mobTab;
    
    // Atualiza Visual
    tabsContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Senha de Seguran√ßa
    const myRequestId = ++currentMobileRequestId;
    const isObsolete = () => myRequestId !== currentMobileRequestId;

    const viewType = btn.dataset.mobTab;
    const titleEl = document.getElementById('mobile-views-title');
    const contentEl = document.getElementById('mobile-views-content');
    
    // Spinner
    contentEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar...</span></div>';

    if (viewType === 'files') {
        titleEl.textContent = "Ficheiros";
        const fileList = document.getElementById('file-list');
        if (fileList) contentEl.innerHTML = fileList.innerHTML;
    } 
    else if (viewType === 'index') {
        titleEl.textContent = "√çndice da Nota";
        detectActiveScrollElement();
        generateNoteIndex(); 
        setTimeout(() => {
            if (isObsolete()) return;
            const source = document.getElementById('note-index-list');
            contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
            if (currentActiveScrollId) {
                const activeItem = contentEl.querySelector(`.index-item[data-target-id="${currentActiveScrollId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active-scroll');
                    activeItem.style.backgroundColor = "rgba(74, 144, 226, 0.3)";
                    activeItem.style.borderLeft = "4px solid #4a90e2";
                    activeItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
            }
        }, 50);
    }
    // --- L√ìGICA MISTO/TEXTOS CORRIGIDA ---
    else if (viewType === 'texts') {
        
        // Verifica se √© MODO MISTO
        if (window.currentNoteHybridMode === true) {
            titleEl.textContent = "Modo Misto (Temas + B√≠blia)";
            
            // O 'await' agora funciona porque atualiz√°mos a fun√ß√£o generateHybridView
            await generateHybridView();
            
            if (isObsolete()) return;

            // Copia o resultado final
            const source = document.getElementById('note-texts-view');
            contentEl.innerHTML = source ? source.innerHTML : '<div style="padding:20px;text-align:center;">Vazio.</div>';
        } 
        
        // MODO NAVEGA√á√ÉO
        else if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
            titleEl.textContent = "Navega√ß√£o por √Çncoras";
            generateAnchorNavigation();
            setTimeout(() => {
                 if (isObsolete()) return;
                 const source = document.getElementById('note-texts-view');
                 contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
            }, 50);
        } 
        
        // MODO PADR√ÉO (TEXTOS)
        else {
            titleEl.textContent = "Textos B√≠blicos";
            await generateNoteTexts();
            if (isObsolete()) return;
            const source = document.getElementById('note-texts-view');
            contentEl.innerHTML = source ? source.innerHTML : '<div style="padding:20px;text-align:center;">Vazio.</div>';
        }
    }
    else if (viewType === 'sources') {
        titleEl.textContent = "Fontes";
        generateNoteSources();
        setTimeout(() => {
            if (isObsolete()) return;
            const source = document.getElementById('note-sources-list');
            contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
        }, 50);
    }
});


// ============================================================
// L√ìGICA DO MENU DE VISTAS MOBILE (‚õ∂)
// ============================================================

// 1. Abrir o Modal
const mobileViewsBtn = document.getElementById('mobile-views-btn');

if (mobileViewsBtn) {
    const newBtn = mobileViewsBtn.cloneNode(true);
    mobileViewsBtn.parentNode.replaceChild(newBtn, mobileViewsBtn);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // 1. For√ßa uma dete√ß√£o de scroll de √∫ltima hora para garantir que a vari√°vel est√° atualizada
        detectActiveScrollElement();

        const modal = document.getElementById('mobile-views-modal');
        if (modal) {
            // For√ßa visibilidade
            document.body.appendChild(modal);
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.85) !important;
                z-index: 2147483647 !important;
                align-items: center !important;
                justify-content: center !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;

            // 2. Simula o clique na aba "√çndice" para carregar o conte√∫do e ativar o scroll
            // (Se j√° estiver ativa, o listener da aba abaixo trata de recarregar)
            const indexBtn = modal.querySelector('[data-mob-tab="index"]');
            if (indexBtn) {
                indexBtn.click();
            }
        }
    });
}

// 2. Gerir Cliques nas Abas
const mobileTabsContainer = document.querySelector('#mobile-views-modal .middle-bottom-tabs');

if (mobileTabsContainer) {
    const newTabs = mobileTabsContainer.cloneNode(true);
    mobileTabsContainer.parentNode.replaceChild(newTabs, mobileTabsContainer);

    newTabs.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        // 1. GERAR SENHA √öNICA (Seguran√ßa contra cliques r√°pidos)
        const myRequestId = ++currentMobileRequestId;
        const isObsolete = () => myRequestId !== currentMobileRequestId;

        // Atualiza visual
        newTabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const viewType = btn.dataset.mobTab;
        const titleEl = document.getElementById('mobile-views-title');
        const contentEl = document.getElementById('mobile-views-content');
        
        // Limpa e p√µe o spinner
        contentEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar...</span></div>';

        // --- ABA: √çNDICE ---
        if (viewType === 'index') {
            titleEl.textContent = "√çndice da Nota";
            detectActiveScrollElement();
            generateNoteIndex(); 
            
            setTimeout(() => {
                if (isObsolete()) return;
                const source = document.getElementById('note-index-list');
                
                if (source && source.innerHTML.trim()) {
                    contentEl.innerHTML = source.innerHTML;
                    // Scrollspy Mobile
                    if (currentActiveScrollId) {
                        const activeItem = contentEl.querySelector(`.index-item[data-target-id="${currentActiveScrollId}"]`);
                        if (activeItem) {
                            activeItem.classList.add('active-scroll');
                            activeItem.style.backgroundColor = "rgba(74, 144, 226, 0.3)";
                            activeItem.style.borderLeft = "4px solid #4a90e2";
                            activeItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                        } 
                    }
                } else {
                    contentEl.innerHTML = "<p style='color:#888; text-align:center; padding:30px;'>Sem estrutura.</p>";
                }
            }, 50);
        }
        
        // --- ABA: TEXTOS / NAVEGA / MISTO (A CORRE√á√ÉO PRINCIPAL) ---
        else if (viewType === 'texts') {
            
            // 1. VERIFICA MODO H√çBRIDO (Prioridade M√°xima)
            if (window.currentNoteHybridMode === true) {
                titleEl.textContent = "Modo Misto (Temas + B√≠blia)";
                
                // Gera no contentor oculto do PC
                await generateHybridView(); 
                
                if (isObsolete()) return;
                
                // Copia para o Mobile
                const source = document.getElementById('note-texts-view');
                contentEl.innerHTML = source ? source.innerHTML : '<div style="padding:20px;text-align:center;">Vazio.</div>';
            }
            
            // 2. VERIFICA MODO NAVEGA√á√ÉO (√Çncoras ativas)
            else if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
                titleEl.textContent = "Navega√ß√£o por √Çncoras";
                
                generateAnchorNavigation();
                
                setTimeout(() => {
                    if (isObsolete()) return;
                    const source = document.getElementById('note-texts-view');
                    contentEl.innerHTML = source ? source.innerHTML : '<div style="padding:20px;text-align:center;">Sem resultados.</div>';
                }, 50);
            } 
            
            // 3. MODO PADR√ÉO (Textos B√≠blicos)
            else {
                titleEl.textContent = "Textos B√≠blicos";
                await generateNoteTexts(); 
                
                if (isObsolete()) return;
                const source = document.getElementById('note-texts-view');
                contentEl.innerHTML = source ? source.innerHTML : '<div style="padding:20px;text-align:center;">Vazio.</div>';
            }
        } 
        
        // --- ABA: FICHEIROS ---
        else if (viewType === 'files') {
            titleEl.textContent = "Ficheiros";
            const fileList = document.getElementById('file-list');
            if (fileList) contentEl.innerHTML = fileList.innerHTML;
        }

        // --- ABA: FONTES ---
        else if (viewType === 'sources') {
            titleEl.textContent = "Fontes";
            generateNoteSources();
            setTimeout(() => {
                if (isObsolete()) return;
                const source = document.getElementById('note-sources-list');
                contentEl.innerHTML = source ? source.innerHTML : "Vazio.";
            }, 50);
        }
    });
}
  
// 3. Delegar Cliques dentro do Conte√∫do Mobile (Vers√£o Final Completa)
const mobileContentArea = document.getElementById('mobile-views-content');

if (mobileContentArea) {
    // 1. Removemos listener antigo clonando
    const newContentArea = mobileContentArea.cloneNode(true);
    mobileContentArea.parentNode.replaceChild(newContentArea, mobileContentArea);

    // 2. Adicionamos o novo evento √∫nico
    newContentArea.addEventListener('click', (e) => {
        
        // --- CASO A: CLIQUE NO √çNDICE (Scroll para a caixa) ---
        const indexItem = e.target.closest('.index-item');
        if (indexItem) {
            const targetId = indexItem.dataset.targetId;
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                document.getElementById('mobile-views-modal').style.display = 'none';
                
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Flash visual
                    const originalBoxShadow = targetElement.style.boxShadow;
                    targetElement.style.transition = "box-shadow 0.5s ease, outline 0.5s ease";
                    targetElement.style.boxShadow = "0 0 20px var(--accent-color)";
                    targetElement.style.outline = "2px solid var(--accent-color)";
                    setTimeout(() => { 
                        targetElement.style.boxShadow = originalBoxShadow || "none"; 
                        targetElement.style.outline = "none";
                    }, 1500);
                }, 150);
                return;
            }
        }

        // --- CASO B: CLIQUE NA LISTA DE FICHEIROS (Navegar) ---
        const listItem = e.target.closest('.list-item');
        if (listItem && listItem.dataset.id) {
            const originalItem = document.querySelector(`#file-list .list-item[data-id="${listItem.dataset.id}"]`);
            if (originalItem) originalItem.click();
            document.getElementById('mobile-views-modal').style.display = 'none';
            return;
        }

        // --- CASO C: OUTROS CLIQUES GERAIS ---
        const otherClickable = e.target.closest('.source-group, .source-link-item, div[onclick]');
        if (otherClickable && !e.target.classList.contains('bible-ref-title')) {
            document.getElementById('mobile-views-modal').style.display = 'none';
        }

        // --- CASO D: CLIQUE EM TEXTO B√çBLICO (SCROLL) ---
        // Este √© o bloco novo para fazer o que pediu
        const bibleTitle = e.target.closest('.bible-ref-title');
        if (bibleTitle) {
            const verseRef = bibleTitle.textContent.trim();
            
            // 1. Fecha o Modal
            document.getElementById('mobile-views-modal').style.display = 'none';
            
            // 2. Chama a fun√ß√£o de pesquisa e scroll que j√° existe
            if (typeof scrollToAndHighlightText === 'function') {
                // Pequeno delay para o modal sair da frente
                setTimeout(() => {
                    scrollToAndHighlightText(verseRef);
                }, 100);
            }
        }
    });
}

// 3. Fechar ao clicar num item
document.getElementById('mobile-views-content')?.addEventListener('click', (e) => {
    // Se clicar num item clic√°vel
    if (e.target.closest('.list-item, .index-item, .source-group, div[onclick]')) {
        
        // Se for um ficheiro da lista, precisamos de disparar o clique original
        const listItem = e.target.closest('.list-item');
        if (listItem && listItem.dataset.id) {
            const originalItem = document.querySelector(`#file-list .list-item[data-id="${listItem.dataset.id}"]`);
            if (originalItem) originalItem.click();
        }
        
        // Fecha o modal
        document.getElementById('mobile-views-modal').style.display = 'none';
    }
});

// ============================================================
// CORRE√á√ÉO DO FECHO DO MODAL MOBILE
// ============================================================

// 1. Configurar o bot√£o "X"
const mobileModal = document.getElementById('mobile-views-modal');
// Procura o bot√£o dentro do cabe√ßalho do modal
const closeMobBtn = mobileModal ? mobileModal.querySelector('button') : null;

if (closeMobBtn && mobileModal) {
    // Removemos o onclick antigo do HTML para evitar conflitos
    closeMobBtn.onclick = null; 

    // Adicionamos um novo evento poderoso
    closeMobBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
    
        
        // For√ßa o fecho sobrepondo qualquer !important anterior
        mobileModal.style.setProperty('display', 'none', 'important');
    });
}

// 2. Configurar fecho ao clicar no fundo escuro (fora da caixa branca)
if (mobileModal) {
    mobileModal.addEventListener('click', (e) => {
        // Se o alvo do clique for o pr√≥prio fundo escuro (id="mobile-views-modal")
        if (e.target === mobileModal) {
            console.log("üåë Clique no fundo detetado. A fechar.");
            mobileModal.style.setProperty('display', 'none', 'important');
        }
    });
}

// ============================================================
// L√ìGICA DE ARRASTO MOBILE PARA O CUBO (üßä)
// ============================================================

// 1. IN√çCIO DO TOQUE (TOUCHSTART)
noteContentEditor.addEventListener('touchstart', (e) => {
    // Verifica se tocou no puxador do cubo
    const handle = e.target.closest('.cube-drag-handle');
    if (!handle) return;

    const cube = handle.closest('.journal-cube-wrapper');
    if (!cube) return;

    // Impede o scroll da p√°gina enquanto arrasta
    e.preventDefault(); 
    e.stopPropagation();

    mDragCube = cube;
    const touch = e.touches[0];
    const rect = cube.getBoundingClientRect();

    // Calcular onde o dedo tocou dentro do cubo
    mTouchOffsetX = touch.clientX - rect.left;
    mTouchOffsetY = touch.clientY - rect.top;

    // Criar o Clone Visual (Fantasma)
    mDragClone = cube.cloneNode(true);
    mDragClone.style.position = 'fixed';
    mDragClone.style.width = `${rect.width}px`;
    mDragClone.style.height = `${rect.height}px`;
    mDragClone.style.zIndex = '999999';
    mDragClone.style.opacity = '0.8';
    mDragClone.style.boxShadow = '0 10px 20px rgba(0,0,0,0.5)';
    mDragClone.style.pointerEvents = 'none'; // Importante para o elementFromPoint funcionar
    mDragClone.style.transform = 'scale(1.05)'; // Efeito de levantamento
    
    // Posicionar inicialmente
    mDragClone.style.left = `${rect.left}px`;
    mDragClone.style.top = `${rect.top}px`;

    document.body.appendChild(mDragClone);

    // Esconde ligeiramente o original
    mDragCube.style.opacity = '0.3';
    
    // Vibra√ß√£o de feedback (se suportado pelo telem√≥vel)
    if (navigator.vibrate) navigator.vibrate(50);
}, { passive: false });

// 2. MOVER O DEDO (TOUCHMOVE)
document.addEventListener('touchmove', (e) => {
    if (!mDragCube || !mDragClone) return;

    e.preventDefault(); // Continua a impedir scroll

    const touch = e.touches[0];

    // Mover o clone
    const x = touch.clientX - mTouchOffsetX;
    const y = touch.clientY - mTouchOffsetY;
    
    mDragClone.style.left = `${x}px`;
    mDragClone.style.top = `${y}px`;

    // Identificar o alvo por baixo do dedo
    // Escondemos o clone momentaneamente para ver o que est√° por baixo
    mDragClone.style.display = 'none';
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    mDragClone.style.display = 'block';

    if (!elementBelow) return;

    // Procura um alvo v√°lido (Par√°grafo, Outro Cubo, Imagem)
    const target = elementBelow.closest('p, .journal-img-wrapper, .journal-cube-wrapper, .url-card-widget');

    // Limpa destaques antigos
    if (mDragTarget && mDragTarget !== target) {
        mDragTarget.style.borderTop = '';
        mDragTarget.style.borderBottom = '';
    }

    if (target && target !== mDragCube && noteContentEditor.contains(target)) {
        mDragTarget = target;
        
        // Calcular se estamos na metade de cima ou de baixo do alvo
        const rect = target.getBoundingClientRect();
        const midY = rect.top + (rect.height / 2);

        if (touch.clientY < midY) {
            target.style.borderTop = '3px solid var(--accent-color)';
            target.style.borderBottom = '';
            target.dataset.dropPos = 'before';
        } else {
            target.style.borderTop = '';
            target.style.borderBottom = '3px solid var(--accent-color)';
            target.dataset.dropPos = 'after';
        }
    } else {
        mDragTarget = null;
    }

}, { passive: false });

// 3. LARGAR (TOUCHEND)
document.addEventListener('touchend', (e) => {
    if (!mDragCube) return;

    // Remove o clone visual
    if (mDragClone) mDragClone.remove();
    mDragClone = null;

    // Restaura o original
    mDragCube.style.opacity = '1';

    // Se houver um alvo v√°lido, move o cubo
    if (mDragTarget) {
        // Limpa as linhas azuis
        mDragTarget.style.borderTop = '';
        mDragTarget.style.borderBottom = '';

        if (mDragTarget.dataset.dropPos === 'before') {
            mDragTarget.parentNode.insertBefore(mDragCube, mDragTarget);
        } else {
            mDragTarget.parentNode.insertBefore(mDragCube, mDragTarget.nextSibling);
        }
        
        // Limpa atributos tempor√°rios
        mDragTarget.removeAttribute('data-drop-pos');
        
        // Grava
        saveNote();
    }

    // Reset final
    mDragCube = null;
    mDragTarget = null;
});


// --- EFEITO DE BORDA AO DIGITAR NO REDATOR ---
const editorForGlow = document.getElementById('note-content-editor');

if (editorForGlow) {
    editorForGlow.addEventListener('input', (e) => {
        // S√≥ ativa se estiver a escrever no corpo do Redator
        if (e.target.classList.contains('redator-content')) {
            
            const wrapper = e.target.closest('.redator-wrapper');
            
            if (wrapper) {
                // Adiciona a classe que faz a borda brilhar
                wrapper.classList.add('typing-border-glow');
                
                // Limpa o temporizador anterior para a luz n√£o apagar enquanto escreve
                if (wrapper.typingTimeout) {
                    clearTimeout(wrapper.typingTimeout);
                }
                
                // Define para apagar a luz 500ms depois de parar de teclar
                wrapper.typingTimeout = setTimeout(() => {
                    wrapper.classList.remove('typing-border-glow');
                }, 500); 
            }
        }
    });
}



// ====================================================================
// L√ìGICA DO MENU MOBILE (BOT√ÉO ‚õ∂ E ABAS)
// ====================================================================

// 1. Configura√ß√£o do Bot√£o de Abrir
const btnOpenMobile = document.getElementById('mobile-views-btn');

if (btnOpenMobile) {
    const newBtn = btnOpenMobile.cloneNode(true);
    btnOpenMobile.parentNode.replaceChild(newBtn, btnOpenMobile);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        console.log("üîò [DEBUG ‚õ∂] Bot√£o clicado. A iniciar abertura...");

        // 1. Dete√ß√£o de posi√ß√£o de scroll
        detectActiveScrollElement();

        // 2. Atualizar √çcones
        refreshMiddlePanelTabIcon();

        const modal = document.getElementById('mobile-views-modal');
        if (modal) {
            // A. For√ßa visibilidade
            document.body.appendChild(modal);
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.85) !important;
                z-index: 2147483647 !important;
                align-items: center !important; justify-content: center !important;
                visibility: visible !important; opacity: 1 !important;
            `;

            // >>> L√ìGICA DE MEM√ìRIA DA ABA <<<
            setTimeout(() => {
                // L√™ o valor cru da vari√°vel
                const rawMemory = window.lastActiveMobileTab;
                console.log("üíæ [DEBUG ‚õ∂] Valor em mem√≥ria (window.lastActiveMobileTab):", rawMemory);

                // Decide qual usar (Mem√≥ria ou Padr√£o)
                const targetTab = rawMemory || 'index';
                console.log("üéØ [DEBUG ‚õ∂] Aba Alvo definida como:", targetTab);
                
                // Tenta encontrar o bot√£o no HTML
                const selector = `.middle-bottom-tabs button[data-mob-tab="${targetTab}"]`;
                const tabToClick = modal.querySelector(selector);

                if (tabToClick) {
                    console.log("‚úÖ [DEBUG ‚õ∂] Bot√£o encontrado no DOM. Simulando clique...");
                    tabToClick.click();
                } else {
                    console.error("‚ùå [DEBUG ‚õ∂] Bot√£o N√ÉO encontrado para o seletor:", selector);
                    console.log("‚ö†Ô∏è [DEBUG ‚õ∂] Ativando fallback (√çndice)...");
                    
                    const defaultBtn = modal.querySelector('[data-mob-tab="index"]');
                    if(defaultBtn) defaultBtn.click();
                }
            }, 50);
        } else {
            console.error("‚ùå [DEBUG ‚õ∂] Erro Cr√≠tico: Modal #mobile-views-modal n√£o existe!");
        }
    });
}


// ============================================================
// GEST√ÉO DE √ÇNCORAS (‚öì)
// ============================================================

// 1. Abrir o Modal de Gest√£o
async function openAnchorManagerModal() {
    console.log("‚öì [GESTOR] Abrindo Gestor de √Çncoras...");
    
    const modal = document.getElementById('anchors-manager-modal');
    const list = document.getElementById('anchors-manager-list');
    
    if (!activeReferenceEntity || !activeReferenceEntity.id) return;
    if (!modal) return console.error("Modal #anchors-manager-modal n√£o encontrado.");

    // 1. FOR√áAR VISIBILIDADE M√ÅXIMA
    document.body.appendChild(modal); // Move para o topo da hierarquia
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
        justify-content: center !important;
        align-items: center !important;
    `;

    list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar √¢ncoras...</span></div>';

    try {
        const myUid = auth.currentUser.uid;
        const { collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // A. Buscar a Entidade Atual
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const entityRef = doc(db, collectionName, activeReferenceEntity.id);
        const entitySnap = await getDoc(entityRef);
        
        let attachedAnchors = {};
        if (entitySnap.exists()) {
            attachedAnchors = entitySnap.data().ancorasAssociadas || {};
        }

        // B. Buscar todas as √Çncoras
        const qAnchors = query(
            collection(db, 'ancoras'),
            where('userId', '==', myUid),
            orderBy('nome')
        );
        const snapAnchors = await getDocs(qAnchors);

        list.innerHTML = '';

        if (snapAnchors.empty) {
            list.innerHTML = `
                <li style="padding: 20px; text-align: center; color: #888;">
                    Nenhuma √¢ncora criada.<br>Use o bot√£o "+" acima para criar.
                </li>`;
            return;
        }

        snapAnchors.forEach(docSnap => {
            const anchor = { id: docSnap.id, ...docSnap.data() };
            if (anchor.estado === 'desativa') return;

            const isSelected = !!attachedAnchors[anchor.id];

            const li = document.createElement('li');
            li.className = `anchor-item-row ${isSelected ? 'selected' : ''}`;
            
            li.innerHTML = `
                <div style="display:flex; flex-direction:column; flex-grow:1;">
                    <span class="anchor-name">${anchor.nome}</span>
                    ${anchor.descricao ? `<small style="color:var(--text-muted-color);">${anchor.descricao}</small>` : ''}
                </div>
                <button class="anchor-edit-btn" title="Editar √Çncora">‚úèÔ∏è</button>
                <div class="anchor-check-icon">‚úì</div>
            `;

            // Toggle
            li.onclick = (e) => {
                if (e.target.closest('.anchor-edit-btn')) return;
                toggleAnchorOnEntity(anchor.id, !li.classList.contains('selected'), li);
            };

            // Editar (Abre o sub-modal, que tamb√©m precisa de z-index alto)
            const editBtn = li.querySelector('.anchor-edit-btn');
            editBtn.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                openEditAnchorModal(anchor); // Esta fun√ß√£o tamb√©m foi corrigida abaixo
            };
            
            list.appendChild(li);
        });

    } catch (e) {
        console.error("Erro ao carregar √¢ncoras:", e);
        list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar dados.</li>';
    }
}

// 2. Alternar Estado (Gravar na Entidade)
async function toggleAnchorOnEntity(anchorId, shouldAdd, liElement) {
    if (!activeReferenceEntity.id) return;

    // 1. Atualiza√ß√£o Visual Imediata (No bot√£o do check)
    if (shouldAdd) liElement.classList.add('selected');
    else liElement.classList.remove('selected');

    // Atualiza listener para o pr√≥ximo clique
    liElement.onclick = () => toggleAnchorOnEntity(anchorId, !shouldAdd, liElement);

    try {
        const collectionName = getCollectionFromType(activeReferenceEntity.type);
        const entityRef = doc(db, collectionName, activeReferenceEntity.id);
        const { updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        // 2. Grava√ß√£o no Firebase
        if (shouldAdd) {
            await updateDoc(entityRef, { [`ancorasAssociadas.${anchorId}`]: true });
        } else {
            await updateDoc(entityRef, { [`ancorasAssociadas.${anchorId}`]: deleteField() });
        }

        // 3. ATUALIZAR CACHE LOCAL (Mem√≥ria)
        const type = activeReferenceEntity.type;
        const id = activeReferenceEntity.id;

        if (allEntities[type]) {
            const entityInCache = allEntities[type].find(e => e.id === id);
            if (entityInCache) {
                if (!entityInCache.ancorasAssociadas) entityInCache.ancorasAssociadas = {};
                if (shouldAdd) entityInCache.ancorasAssociadas[anchorId] = true;
                else delete entityInCache.ancorasAssociadas[anchorId];
            }
        }

        // ============================================================
        // 4. >>> CORRE√á√ÉO MOBILE E DESKTOP <<<
        // ============================================================
        
        // A. Gera a lista com os novos dados (Escreve no contentor do PC)
        generateAnchorNavigation(); 

        // B. Se o Modal Mobile estiver aberto na aba "Navega", copia o conte√∫do para l√°
        const mobileModal = document.getElementById('mobile-views-modal');
        if (mobileModal && mobileModal.style.display !== 'none') {
            const activeMobTab = mobileModal.querySelector('.middle-bottom-tabs button.active');
            
            // S√≥ atualiza se estivermos na aba de textos/navega
            if (activeMobTab && activeMobTab.dataset.mobTab === 'texts') {
                console.log("üì± [MOBILE] Sincronizando lista de navega√ß√£o...");
                const source = document.getElementById('note-texts-view');
                const destination = document.getElementById('mobile-views-content');
                if (source && destination) {
                    destination.innerHTML = source.innerHTML;
                }
            }
        }
        // ============================================================
        
    } catch (error) {
        console.error("Erro ao gravar √¢ncora:", error);
        if (shouldAdd) liElement.classList.remove('selected');
        else liElement.classList.add('selected');
        alert("Erro ao salvar altera√ß√£o.");
    }
}

// 3. Abrir Modal de Cria√ß√£o (+)
const openCreateAnchorBtn = document.getElementById('open-create-anchor-btn');

if (openCreateAnchorBtn) {
    // Clonar para limpar ouvintes antigos e evitar duplica√ß√µes
    const newBtn = openCreateAnchorBtn.cloneNode(true);
    openCreateAnchorBtn.parentNode.replaceChild(newBtn, openCreateAnchorBtn);

    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const modal = document.getElementById('create-anchor-modal');
        const input = document.getElementById('new-anchor-name');
        const desc = document.getElementById('new-anchor-desc');
        
        if (!modal) return;

        // 1. Limpa os campos
        input.value = '';
        desc.value = '';
        
        // 2. CORRE√á√ÉO CR√çTICA DE VISUALIZA√á√ÉO:
        // Move o modal para o final do <body> para garantir que n√£o fica preso em CSS de pais
        document.body.appendChild(modal);
        
        // Aplica o Z-Index M√°ximo (O topo absoluto do navegador)
        modal.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background-color: rgba(0, 0, 0, 0.85) !important;
            z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO */
            align-items: center !important;
            justify-content: center !important;
        `;
        
        // 3. Foca no input para escrever logo
        setTimeout(() => {
            if (input) input.focus();
        }, 100);
    });
}

// 4. Confirmar Cria√ß√£o da √Çncora
document.getElementById('confirm-create-anchor').addEventListener('click', async () => {
    const nameInput = document.getElementById('new-anchor-name');
    const descInput = document.getElementById('new-anchor-desc');
    const btn = document.getElementById('confirm-create-anchor');
    
    const nome = nameInput.value.trim();
    if (!nome) return alert("O nome √© obrigat√≥rio.");
    
    btn.disabled = true;
    btn.textContent = "A criar...";
    
    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        await addDoc(collection(db, 'ancoras'), {
            nome: nome,
            descricao: descInput.value.trim(),
            userId: auth.currentUser.uid,
            estado: 'ativa', // <--- ADICIONE ESTA LINHA
            timestamp: serverTimestamp()
        });
        
        // Fecha e recarrega a lista
        document.getElementById('create-anchor-modal').style.display = 'none';
        openAnchorManagerModal(); // Recarrega a lista anterior
        
    } catch (e) {
        console.error("Erro ao criar √¢ncora:", e);
        alert("Erro ao criar.");
    } finally {
        btn.disabled = false;
        btn.textContent = "Criar";
    }
});


// 1. Alternar Abas no Modal
document.getElementById('topics-modal-tabs').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    // 1. Atualiza visual
    document.querySelectorAll('#topics-modal-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const tab = btn.dataset.tab; 
    
    // ============================================================
    // >>> NOVA L√ìGICA: GRAVAR AO MUDAR PARA √ÇNCORAS OU TAGS <<<
    // ============================================================
    if (tab === 'anchors' || tab === 'autolink') {
        console.log(`üíæ [SISTEMA] Aba "${tab}" selecionada. Gravando nota...`);
        // Chama a fun√ß√£o de grava√ß√£o for√ßada (true = imediato)
        if (typeof saveNote === 'function') {
            await saveNote(true);
        }
    }
    // ============================================================

    // 2. Esconde conte√∫dos
    document.getElementById('tm-content-topics').style.display = 'none';
    document.getElementById('tm-content-anchors').style.display = 'none';
    document.getElementById('tm-content-autolink').style.display = 'none';
    
    // 3. Mostra o alvo
    const targetContent = document.getElementById(`tm-content-${tab}`);
    if (targetContent) targetContent.style.display = 'flex';

    // 4. Configura o Bot√£o "+" do Cabe√ßalho e Toggle H√≠brido
    const plusBtn = document.getElementById('manage-topics-btn');
    const hybridContainer = document.getElementById('hybrid-toggle-container');

    // Reset ao toggle h√≠brido (s√≥ aparece em √Çncoras)
    if (hybridContainer) hybridContainer.style.display = (tab === 'anchors') ? 'flex' : 'none';

    if (plusBtn) {
        plusBtn.style.display = 'block'; // Mostra sempre por padr√£o

        if (tab === 'anchors') {
            // MODO √ÇNCORA: Bot√£o Verde
            plusBtn.title = "Criar Nova √Çncora";
            plusBtn.style.color = "#2ecc71"; 
            plusBtn.style.borderColor = "#2ecc71";

        } else if (tab === 'topics') {
            // MODO T√ìPICOS: Bot√£o Azul
            plusBtn.title = "Criar/Gerir T√≥picos";
            plusBtn.style.color = "var(--accent-color)";
            plusBtn.style.borderColor = "var(--accent-color)";

        } else if (tab === 'autolink') {
            // MODO TAGS (NOVO): Bot√£o Amarelo
            plusBtn.title = "Criar Nova Tag";
            plusBtn.style.color = "#f1c40f"; 
            plusBtn.style.borderColor = "#f1c40f";
        }
    }

    // 5. Carregar dados se necess√°rio
    if (tab === 'anchors') {
        const list = document.getElementById('note-anchors-list');
        // Se a lista estiver vazia ou com spinner, carrega.
        // Se j√° tiver dados, o utilizador pode querer ver o que estava l√°, 
        // mas se quiser for√ßar recarregamento sempre, remova o "if" e chame direto.
        if (list && (list.children.length === 0 || list.querySelector('.spinner'))) {
            if (typeof loadAnchorsForSelection === 'function') loadAnchorsForSelection(true);
        }
    }
    else if (tab === 'topics') {
        // Opcional: Recarregar t√≥picos se necess√°rio
        if (typeof renderTopicsSelectionList === 'function') renderTopicsSelectionList();
    }
});



// 2. Pesquisa de √Çncoras
document.getElementById('anchor-search-input').addEventListener('input', (e) => {
    currentAnchorSearch = e.target.value.trim();
    // Debounce simples (espera 500ms antes de pesquisar)
    clearTimeout(window.anchorSearchTimer);
    window.anchorSearchTimer = setTimeout(() => {
        loadAnchorsForSelection(true); // Recarrega com filtro
    }, 500);
});

// 3. Bot√£o Carregar Mais
document.getElementById('load-more-anchors-btn').addEventListener('click', () => {
    loadAnchorsForSelection(false); // false = append (n√£o limpa)
});

async function loadAnchorsForSelection(isReset = false) {
    const list = document.getElementById('note-anchors-list');
    const loadMoreBtn = document.getElementById('load-more-anchors-btn');
    const myUid = auth.currentUser.uid;

    if (isReset) {
        list.innerHTML = '<li style="padding:15px; text-align:center;"><div class="spinner"></div></li>';
        anchorLastDoc = null;
        loadMoreBtn.style.display = 'none';
    } else {
        loadMoreBtn.textContent = "A carregar...";
        loadMoreBtn.disabled = true;
    }

    try {
        // --- ALTERA√á√ÉO AQUI: Removemos o filtro 'estado' da query do Firebase ---
        // Isto garante que itens sem o campo 'estado' (como o da imagem) aparecem
        const constraints = [
            collection(db, 'ancoras'),
            where('userId', '==', myUid),
            orderBy('nome'), // Ordenamos apenas por nome
            limit(30)
        ];

        if (currentAnchorSearch) {
            constraints.push(where('nome', '>=', currentAnchorSearch));
            constraints.push(where('nome', '<=', currentAnchorSearch + '\uf8ff'));
        }

        if (!isReset && anchorLastDoc) {
            constraints.push(startAfter(anchorLastDoc));
        }

        const q = query(...constraints);
        const snapshot = await getDocs(q);

        if (isReset) list.innerHTML = '';

        if (snapshot.empty) {
            if (isReset) list.innerHTML = '<li style="padding:20px; color:#888; text-align:center;">Nenhuma √¢ncora encontrada.</li>';
            loadMoreBtn.style.display = 'none';
            return;
        }

        anchorLastDoc = snapshot.docs[snapshot.docs.length - 1];

        snapshot.forEach(docSnap => {
            const anchor = { id: docSnap.id, ...docSnap.data() };
            
            // --- FILTRO NO CLIENTE (JAVASCRIPT) ---
            // Se estiver explicitamente "desativa", ignoramos.
            // Se o campo n√£o existir, deixamos passar (assim o seu item "Guerra" vai aparecer).
            if (anchor.estado === 'desativa') return;

            const isSelected = !!currentNoteAnchors[anchor.id];

            const li = document.createElement('li');
            li.className = `anchor-select-item ${isSelected ? 'selected' : ''}`;
            li.dataset.id = anchor.id;
            
            li.innerHTML = `
                <div class="anchor-info-area">
                    <span style="font-size:1.1em;">‚öì ${anchor.nome}</span>
                    ${anchor.descricao ? `<small style="color:var(--text-muted-color);">${anchor.descricao}</small>` : ''}
                </div>
                <button class="anchor-item-edit-btn" title="Editar/Ocultar">‚úèÔ∏è</button>
                <div class="anchor-check">‚úì</div>
            `;

            li.onclick = (e) => {
                if (e.target.closest('.anchor-item-edit-btn')) return;
                const nowSelected = !li.classList.contains('selected');
                if (nowSelected) {
                    li.classList.add('selected');
                    currentNoteAnchors[anchor.id] = true;
                } else {
                    li.classList.remove('selected');
                    delete currentNoteAnchors[anchor.id];
                }
            };

            const editBtn = li.querySelector('.anchor-item-edit-btn');
            editBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                openEditAnchorModal(anchor);
            };

            list.appendChild(li);
        });

        if (snapshot.size === 30) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.textContent = "Carregar mais 30 itens";
            loadMoreBtn.disabled = false;
        } else {
            loadMoreBtn.style.display = 'none';
        }

    } catch (e) {
        console.error("Erro ao carregar √¢ncoras:", e);
        if (isReset) list.innerHTML = '<li style="color:red; padding:10px;">Erro ao carregar.</li>';
    }
}

function generateAnchorNavigation() {
    const list = document.getElementById('note-texts-view');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    // 1. Limpeza Inicial
    list.innerHTML = '';
    
    // Verifica se existem √¢ncoras selecionadas na nota
    if (!activeNoteAnchorsIds || activeNoteAnchorsIds.length === 0) {
        list.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">Sem √¢ncoras definidas na nota.</div>';
        return;
    }

    const textContent = editor.innerText.toLowerCase();
    
    // 2. Juntar todas as entidades conhecidas (Personagens, Locais, Cosmos...)
    const allCandidates = [];
    Object.keys(allEntities).forEach(type => {
        allEntities[type].forEach(entity => {
            allCandidates.push(entity);
        });
    });

    let foundCount = 0;

    // 3. Loop de Cruzamento (Entidades vs √Çncoras vs Texto)
    allCandidates.forEach(entity => {
        
        // A. Verificar se a entidade tem a √Çncora certa
        const entityAnchors = entity.ancorasAssociadas || {};
        const hasMatchingAnchor = activeNoteAnchorsIds.some(noteAnchorId => entityAnchors[noteAnchorId]);

        if (!hasMatchingAnchor) return;

        // B. Verificar se o nome da entidade est√° escrito no Texto da nota
        if (textContent.includes(entity.nome.toLowerCase())) {
            foundCount++;
            
            // Criar o Contentor do Item
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = "padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px;";
            
            // --- L√ìGICA DE √çCONE ---
            let icon = entity.emoji || "üîπ"; 
            if (!entity.emoji) {
                if (entity.tipo === 'personagem') icon = "üë§";
                else if (entity.tipo === 'local') icon = "üìç";
                else if (entity.tipo === 'cosmos') icon = "ü™ê";
                else if (entity.tipo === 'subcosmos') icon = "üß¨";
            }
            
            // --- C. T√çTULO (Clique = Scroll no Editor) ---
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = "font-weight: bold; color: var(--accent-color); cursor: pointer; font-size: 0.95em; display: flex; align-items: center; gap: 6px; width: fit-content;";
            titleDiv.innerHTML = `${icon} ${entity.nome}`;
            titleDiv.title = "Ir para o texto na nota";
            
            titleDiv.onclick = (e) => {
                e.stopPropagation();
                if (typeof scrollToAndHighlightText === 'function') {
                    scrollToAndHighlightText(entity.nome);
                }
            };

            // --- D. DESCRI√á√ÉO (Clique = Abrir 4¬™ Coluna) ---
            const descDiv = document.createElement('div');
            descDiv.style.cssText = "font-size: 0.85em; color: var(--text-muted-color); line-height: 1.4; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;";
            
            const descText = entity.descricao || 'Sem descri√ß√£o (Clique para ver detalhes).';
            descDiv.textContent = descText;
            descDiv.title = "Abrir painel de refer√™ncias";

            descDiv.onmouseover = () => {
                descDiv.style.backgroundColor = "var(--hover-color)";
                descDiv.style.color = "var(--text-color)";
            };
            descDiv.onmouseout = () => {
                descDiv.style.backgroundColor = "transparent";
                descDiv.style.color = "var(--text-muted-color)";
            };

            descDiv.onclick = (e) => {
                e.stopPropagation();
                // Abre o painel lateral com os detalhes
                showReferencesPanel(entity.id, entity.nome, entity.tipo);
            };

            itemDiv.appendChild(titleDiv);
            itemDiv.appendChild(descDiv);
            list.appendChild(itemDiv);
        }
    });

    if (foundCount === 0) {
        list.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#888; text-align:center; padding:20px;">
                <span style="font-size:30px;">‚öì</span>
                <p>Modo Navega√ß√£o</p>
                <small style="opacity:0.6; line-height:1.5;">Nenhuma entidade encontrada no texto com estas √¢ncoras.</small>
            </div>`;
    }
}

function refreshMiddlePanelTabIcon() {
    // Seleciona os bot√µes do PC e do Mobile
    const allTabBtns = document.querySelectorAll('button[data-mid-tab="texts"], button[data-mob-tab="texts"]');

    allTabBtns.forEach(btn => {
        // Verifica a vari√°vel global diretamente
        if (window.currentNoteHybridMode === true) {
            btn.innerHTML = '<span>üõ≥Ô∏è</span> Misto';
            btn.dataset.mode = 'hybrid';
            btn.title = "Modo H√≠brido: Entidades + B√≠blia";
        } 
        else if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
            btn.innerHTML = '<span>‚öì</span> Navega';
            btn.dataset.mode = 'navega';
            btn.title = "Navega√ß√£o por √Çncoras";
        } 
        else {
            btn.innerHTML = '<span>üìú</span> Textos';
            btn.dataset.mode = 'textos';
            btn.title = "Textos B√≠blicos";
        }
    });
}

// 5. Abrir Modal de Edi√ß√£o de √Çncora
function openEditAnchorModal(anchor) {
    const modal = document.getElementById('edit-anchor-modal');
    const nameInput = document.getElementById('edit-anchor-name');
    const descInput = document.getElementById('edit-anchor-desc');
    const saveBtn = document.getElementById('confirm-edit-anchor');
    const deleteBtn = document.getElementById('delete-anchor-btn'); 

    if (!modal) return;

    // 1. Preenche dados atuais
    nameInput.value = anchor.nome;
    descInput.value = anchor.descricao || '';

    // 2. CORRE√á√ÉO DE VISIBILIDADE (Topo Absoluto)
    document.body.appendChild(modal); // Move para a raiz
    
    modal.style.cssText = `
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        z-index: 2147483647 !important; /* Valor M√°ximo */
        align-items: center !important;
        justify-content: center !important;
    `;

    setTimeout(() => nameInput.focus(), 100);

    // --- A√á√ÉO GRAVAR (Editar) ---
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const newName = nameInput.value.trim();
        const newDesc = descInput.value.trim();

        if (!newName) return alert("O nome √© obrigat√≥rio.");

        newSaveBtn.disabled = true;
        newSaveBtn.textContent = "A gravar...";

        try {
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const anchorRef = doc(db, 'ancoras', anchor.id);

            await updateDoc(anchorRef, {
                nome: newName,
                descricao: newDesc,
                ultimaedicao: serverTimestamp()
            });

            modal.style.display = 'none';
            loadAnchorsForSelection(true); // Recarrega a lista do modal de tr√°s

        } catch (error) {
            console.error("Erro ao editar:", error);
            alert("Erro ao gravar.");
        } finally {
            newSaveBtn.disabled = false;
            newSaveBtn.textContent = "Gravar";
        }
    };

    // --- A√á√ÉO OCULTAR (COM POPUP DE CONFIRMA√á√ÉO) ---
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

    newDeleteBtn.textContent = "Ocultar"; 
    newDeleteBtn.style.backgroundColor = "#e74c3c"; 

    newDeleteBtn.onclick = async () => {
        
        // TRUQUE EXTRA: Como o modal de edi√ß√£o est√° no Z-Index m√°ximo,
        // o modal de confirma√ß√£o tamb√©m tem de ir para l√° (e ser o √∫ltimo no DOM).
        const confirmModalElement = document.getElementById('confirm-modal');
        if (confirmModalElement) {
            document.body.appendChild(confirmModalElement); // Move para o fim
            confirmModalElement.style.setProperty('z-index', '2147483647', 'important');
        }

        const confirmed = await showConfirmation(
            "Ocultar √Çncora?",
            `Deseja ocultar a √¢ncora "${anchor.nome}"?\n\nEla desaparecer√° desta lista e ir√° para "Itens Ocultos".`
        );

        if (!confirmed) return;

        newDeleteBtn.textContent = "A ocultar...";
        newDeleteBtn.disabled = true;

        try {
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const anchorRef = doc(db, 'ancoras', anchor.id);
            
            await updateDoc(anchorRef, {
                estado: 'desativa',
                ultimaedicao: serverTimestamp()
            });
            
            modal.style.display = 'none';
            loadAnchorsForSelection(true);

        } catch (error) {
            console.error("Erro ao ocultar:", error);
            alert("Erro ao ocultar a √¢ncora.");
        } finally {
            newDeleteBtn.textContent = "Ocultar";
            newDeleteBtn.disabled = false;
        }
    };
}


// ============================================================
// L√ìGICA DO DEP√ìSITO DE REFER√äNCIAS (üèóÔ∏è)
// ============================================================

// 1. INSERIR O WIDGET
document.querySelector('button[data-action="insert-ref-depot"]').addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation();
    
    const uniqueId = `depot_${Date.now()}`;
    
    const widgetHTML = `
        <div class="ref-depot-wrapper" id="${uniqueId}" contenteditable="false">
            <div class="depot-header">
                <!-- √çcone fixo + T√≠tulo edit√°vel -->
                <div style="display:flex; align-items:center; flex-grow:1;">
                    <span style="font-size:1.4em; margin-right:8px;">üèóÔ∏è</span>
                    <input type="text" class="depot-title" value="GRUA DE REFER√äNCIAS" placeholder="T√çTULO DA GRUA..." oninput="this.setAttribute('value', this.value)">
                </div>
                
                <!-- NOVO BOT√ÉO: Expandir/Recolher Tudo -->
                <button class="depot-btn" title="Expandir/Recolher Tudo" onclick="window.toggleAllDepotNodes(this)">‚ÜïÔ∏è</button>
                
                <button class="depot-btn" onclick="window.addDepotCategory('${uniqueId}')">+ üìÇ Categoria</button>
                <button class="depot-btn btn-del-node" title="Apagar Grua" onclick="window.debugDeleteDepot(this)">üóëÔ∏è</button>
            </div>
            
            <div class="depot-content-area">
                <!-- As categorias ser√£o adicionadas aqui -->
            </div>
        </div>
        <p><br></p>
    `;

    document.execCommand('insertHTML', false, widgetHTML);
    
    document.getElementById('formatting-popup').style.display = 'none';
    document.getElementById('more-formatting-btn').classList.remove('active');
    
    setTimeout(() => window.addDepotCategory(uniqueId), 50);
    
    if (typeof saveNote === 'function') saveNote();
});

// 2. FUN√á√ïES GLOBAIS DE INTERA√á√ÉO

// A. Adicionar Categoria Principal (üìÇ)
window.addDepotCategory = function(depotId) {
    const wrapper = document.getElementById(depotId);
    if (!wrapper) return;
    const container = wrapper.querySelector('.depot-content-area');

    const catDiv = document.createElement('div');
    catDiv.className = 'depot-category';
    
    // MUDAN√áA: Removi o bot√£o "+ Link" do cabe√ßalho e adicionei-o dentro da 'depot-tree-line'
    catDiv.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span class="depot-toggle-icon" onclick="window.toggleDepotNode(this)" title="Clique para fechar/abrir" style="cursor:pointer; margin-right:5px; font-size:1.2em; user-select:none;">üìÇ</span>
            
            <input type="text" class="depot-input-title" placeholder="CATEGORIA..." 
                   oninput="this.setAttribute('value', this.value)">
            
            <button class="depot-btn btn-add-sub" title="Adicionar Subt√≠tulo" 
                    onclick="window.addDepotSubtitle(this.closest('.depot-category'))">+ Sub</button>
            
            <button class="depot-btn btn-del-node" title="Remover Categoria" 
                    onclick="window.deleteDepotNode(this)">√ó</button>
        </div>
        
        <div class="depot-tree-line">
            <!-- O bot√£o de adicionar link fica aqui em baixo -->
            <button class="depot-btn btn-add-link-bottom" style="width:100%; margin-top:5px; border-style:dashed; opacity:0.7;" 
                    title="Adicionar Link no fundo" 
                    onclick="window.addDepotLink(this.closest('.depot-category'))">+ Adicionar Link</button>
        </div>
    `;
    
    container.appendChild(catDiv);
    setTimeout(() => { const i = catDiv.querySelector('input'); if(i) i.focus(); }, 50);
};

// ATUALIZADA: ADICIONAR SUBT√çTULO (üîπ)
window.addDepotSubtitle = function(categoryEl) {
    if (!categoryEl) return;
    
    // Abre a pasta se estiver fechada
    if (categoryEl.classList.contains('is-collapsed')) {
        const toggle = categoryEl.querySelector('.depot-toggle-icon');
        if(toggle) window.toggleDepotNode(toggle);
    }

    // 1. Encontrar o contentor correto
    const container = categoryEl.querySelector('.depot-tree-line');
    if (!container) return;
    
    // 2. CORRE√á√ÉO DO ERRO: Encontrar o bot√£o que √© FILHO DIRETO
    // N√£o usamos querySelector aqui para evitar apanhar bot√µes de outros subt√≠tulos aninhados
    let parentAddBtn = null;
    for (let i = 0; i < container.children.length; i++) {
        if (container.children[i].classList.contains('btn-add-link-bottom')) {
            parentAddBtn = container.children[i];
            break; 
        }
    }

    // 3. Criar o HTML do Subt√≠tulo
    const div = document.createElement('div');
    div.className = 'depot-subtitle';
    
    div.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span class="depot-toggle-icon" onclick="window.toggleDepotNode(this)" style="cursor:pointer; margin-right:5px;">üîπ</span>
            <input type="text" class="depot-input-title" placeholder="Subt√≠tulo..." oninput="this.setAttribute('value', this.value)" style="font-size:0.95em; color: #aab7c4;">
            
            <button class="depot-btn btn-del-node" onclick="window.deleteDepotNode(this)">√ó</button>
        </div>
        
        <!-- O Subt√≠tulo tamb√©m precisa da sua pr√≥pria linha e bot√£o no fundo -->
        <div class="depot-tree-line" style="border-left: 2px solid rgba(52, 152, 219, 0.3);">
             <button class="depot-btn btn-add-link-bottom" style="width:100%; margin-top:5px; border-style:dashed; opacity:0.7;" 
                    onclick="window.addDepotLink(this.closest('.depot-subtitle'))">+ Adicionar Link</button>
        </div>
    `;
    
    // 4. Inser√ß√£o Segura
    if (parentAddBtn) {
        // Insere ANTES do bot√£o "+ Adicionar Link" desta categoria
        container.insertBefore(div, parentAddBtn);
    } else {
        // Se por algum motivo o bot√£o n√£o existir, adiciona no fim
        container.appendChild(div);
    }
    
    // Foca no input
    setTimeout(() => {
        const input = div.querySelector('input');
        if(input) {
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 50);
    
    if (typeof saveNote === 'function') saveNote();
};



// 3. NOVA FUN√á√ÉO: O MOTOR DO TOGGLE
window.toggleDepotNode = function(iconElement) {
    // Previne que o clique se propague e cause problemas de foco
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // Encontra o pai (Categoria ou Subt√≠tulo)
    const parentNode = iconElement.closest('.depot-category, .depot-subtitle');
    
    if (parentNode) {
        // Alterna a classe que o CSS usa para esconder
        parentNode.classList.toggle('is-collapsed');
        console.log("üìÇ Toggle acionado em:", parentNode); // Debug na consola
    }
};

// ============================================================
// FUN√á√ïES EM FALTA DO DEP√ìSITO (LINKS)
// ============================================================

// 1. ADICIONAR LINK (Chamado pelo bot√£o + Link)
 window.addDepotLink = function(containerElement) {
    if (!containerElement) return;

    if (containerElement.classList.contains('is-collapsed')) {
        const toggleIcon = containerElement.querySelector('.depot-toggle-icon');
        if (toggleIcon && typeof window.toggleDepotNode === 'function') {
            window.toggleDepotNode(toggleIcon);
        }
    }

    const treeLine = containerElement.querySelector('.depot-tree-line');
    if (!treeLine) return;

    // Encontra o bot√£o de adicionar que est√° no fundo desta lista
    // Usamos :scope > button para garantir que pegamos o bot√£o direto desta lista e n√£o de sublistas
    let addButton = treeLine.querySelector(':scope > .btn-add-link-bottom');

    // Fallback de seguran√ßa se a estrutura for antiga
    if (!addButton) {
        // Se n√£o encontrar o bot√£o (nota antiga), cria-o agora
        addButton = document.createElement('button');
        addButton.className = 'depot-btn btn-add-link-bottom';
        addButton.style.cssText = "width:100%; margin-top:5px; border-style:dashed; opacity:0.7;";
        addButton.textContent = "+ Adicionar Link";
        addButton.onclick = function() { window.addDepotLink(containerElement); };
        treeLine.appendChild(addButton);
    }

    const card = document.createElement('div');
    card.className = 'depot-link-card';
    
    card.innerHTML = `
        <button class="depot-del-card" onclick="window.deleteDepotLink(this)" title="Remover Link">√ó</button>
        <input type="text" class="depot-link-input depot-desc" placeholder="Descri√ß√£o..." value="" oninput="this.setAttribute('value', this.value)">
        <div class="depot-url-row">
            <input type="text" class="depot-link-input depot-url" placeholder="website.com" value="" oninput="this.setAttribute('value', this.value)">
            <button class="depot-visit-btn" onclick="window.visitDepotLink(this)">‚Üó</button>
        </div>
    `;

    // MUDAN√áA CR√çTICA: Insere o cart√£o ANTES do bot√£o de adicionar
    treeLine.insertBefore(card, addButton);

    setTimeout(() => { const i = card.querySelector('.depot-desc'); if(i) i.focus(); }, 50);
    if (typeof saveNote === 'function') saveNote();
};



  

// 2. VISITAR LINK (Atualizado para ler o campo certo)
window.visitDepotLink = function(btn) {
    // Sobe at√© ao cart√£o para encontrar o input correto
    const card = btn.closest('.depot-link-card');
    const inputUrl = card.querySelector('.depot-url');
    
    let url = inputUrl.value.trim();

    if (!url) {
        alert("Insira um URL primeiro.");
        inputUrl.focus();
        return;
    }

    // Adiciona protocolo se faltar
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }

    window.open(url, '_blank');
};



// ============================================================
// ADICIONAR CATEGORIA (üìÇ) - C√ìDIGO CORRIGIDO
// ============================================================
window.addDepotCategory = function(depotId) {
    const wrapper = document.getElementById(depotId);
    if (!wrapper) return;
    
    // Procura o contentor onde as categorias vivem
    const container = wrapper.querySelector('.depot-content-area');

    const catDiv = document.createElement('div');
    catDiv.className = 'depot-category';
    
    // AQUI EST√Å A CORRE√á√ÉO:
    // 1. Adicionei 'cursor:pointer' diretamente no style para garantir que parece clic√°vel.
    // 2. O 'onclick="window.toggleDepotNode(this)"' est√° aplicado no SPAN do √≠cone.
    catDiv.innerHTML = `
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <span class="depot-toggle-icon" onclick="window.toggleDepotNode(this)" title="Clique para fechar/abrir" style="cursor:pointer; margin-right:5px; font-size:1.2em; user-select:none;">üìÇ</span>
            
            <input type="text" class="depot-input-title" placeholder="CATEGORIA..." 
                   oninput="this.setAttribute('value', this.value)">
            
            <button class="depot-btn btn-add-sub" title="Adicionar Subt√≠tulo" 
                    onclick="window.addDepotSubtitle(this.closest('.depot-category'))">+ Sub</button>
            
            <button class="depot-btn btn-add-link" title="Adicionar Link Direto" 
                    onclick="window.addDepotLink(this.closest('.depot-category'))">+ Link</button>
            
           <button class="depot-btn btn-del-node" title="Remover Subt√≠tulo" 
        onclick="window.deleteDepotNode(this)">√ó</button>
        </div>
        
        <!-- Esta √© a div que vai desaparecer quando fechado -->
        <div class="depot-tree-line"></div>
    `;
    
    container.appendChild(catDiv);
    
    // Foca no input
    setTimeout(() => {
        const input = catDiv.querySelector('input');
        if(input) input.focus();
    }, 50);
};

// ============================================================
// FUN√á√ÉO DE ELIMINAR COM CONFIRMA√á√ÉO (üìÇ e üîπ)
// ============================================================
window.deleteDepotNode = async function(btnElement) {
    // --- DEBUG IN√çCIO ---
    console.clear(); // Limpa a consola para ver melhor
    console.log("%c[DEBUG] Bot√£o X clicado!", "background: yellow; color: black; font-size: 14px;");
    console.log("Elemento clicado:", btnElement);
    // --------------------

    const node = btnElement.closest('.depot-category, .depot-subtitle');
    
    if (!node) {
        console.error("‚ùå ERRO: N√£o encontrei a div pai (.depot-category ou .depot-subtitle)");
        return;
    }

    console.log("‚úÖ Elemento Pai encontrado:", node);

    const isCategory = node.classList.contains('depot-category');
    const typeLabel = isCategory ? "Categoria" : "Subt√≠tulo";
    const nameInput = node.querySelector('input');
    const name = nameInput ? nameInput.value : "";
    
    console.log(`Tipo: ${typeLabel}, Nome: "${name}"`);

    // CHAMA O POPUP
    console.log("‚è≥ A chamar showConfirmation...");
    
    const confirmed = await showConfirmation(
        `Eliminar ${typeLabel}?`, 
        `Deseja eliminar "${name || typeLabel}"?\nIsto apagar√° tudo o que estiver dentro.`
    );

    console.log("Resposta do Popup:", confirmed);

    if (confirmed) {
        console.log("üóëÔ∏è A apagar...");
        node.remove();
        if (typeof saveNote === 'function') saveNote();
    } else {
        console.log("üö´ Cancelado.");
    }
};


window.debugDeleteDepot = async function(btnElement) {
    console.group("üóëÔ∏è [DEP√ìSITO] Iniciar Remo√ß√£o");
    
    // 1. Identificar o Wrapper do Dep√≥sito
    const wrapper = btnElement.closest('.ref-depot-wrapper');
    
    if (!wrapper) {
        console.error("‚ùå ERRO: Wrapper n√£o encontrado.");
        console.groupEnd();
        return;
    }

    // 2. Confirma√ß√£o Explicita (Garante que o utilizador quer mesmo apagar)
    const confirmed = await showConfirmation(
        "Apagar Dep√≥sito?", 
        "Deseja enviar esta Grua de Refer√™ncias para a reciclagem?"
    );

    if (!confirmed) {
        console.log("üö´ Cancelado pelo utilizador.");
        console.groupEnd();
        return;
    }

    // 3. REMO√á√ÉO VISUAL IMEDIATA (O Segredo para a rapidez)
    // Escondemos logo o elemento antes de falar com o servidor
    wrapper.style.display = 'none';

    // 4. Arquivar no Firebase (Modo Silencioso)
    // Passamos 'true' para n√£o pedir confirma√ß√£o de novo nem tentar remover visualmente dentro da fun√ß√£o
    const success = await window.archiveMiniNote(wrapper, true);

    if (success) {
        console.log("‚úÖ Arquivado com sucesso no Firebase. Limpando DOM.");
        
        // Substitui o elemento por um marcador invis√≠vel (para manter a posi√ß√£o no hist√≥rico)
        const marker = document.createElement('span');
        marker.id = `marker_${wrapper.id}`;
        marker.className = 'hidden-note-marker';
        marker.style.display = 'none';
        
        wrapper.replaceWith(marker);
        
        // Grava a nota para oficializar a remo√ß√£o do HTML
        if (typeof saveNote === 'function') saveNote(true);
        
    } else {
        // 5. ERRO: Se falhar, mostra o dep√≥sito de volta
        console.error("‚ùå Falha ao arquivar. Restaurando visual.");
        wrapper.style.display = 'block';
        alert("N√£o foi poss√≠vel apagar (Erro de conex√£o ou permiss√£o).");
    }
    
    console.groupEnd();
};

// ============================================================
// FUN√á√ïES DE ELIMINA√á√ÉO COM CONFIRMA√á√ÉO (DEP√ìSITO)
// ============================================================

// 1. APAGAR CART√ÉO DE LINK (O "√ó" do cart√£o)
window.deleteDepotLink = async function(btn) {
    const card = btn.closest('.depot-link-card');
    if (!card) return;

    // Chama o popup personalizado
    const confirmed = await showConfirmation(
        "Remover Link?", 
        "Deseja apagar este cart√£o de refer√™ncia?"
    );

    if (confirmed) {
        // Efeito visual de sa√≠da
        card.style.transition = "opacity 0.2s, transform 0.2s";
        card.style.opacity = "0";
        card.style.transform = "scale(0.95)";
        
        setTimeout(() => {
            card.remove();
            if (typeof saveNote === 'function') saveNote(); // Grava
        }, 200);
    }
};

// 2. APAGAR N√ìS DA √ÅRVORE (Categorias üìÇ e Subt√≠tulos üîπ)
window.deleteDepotNode = async function(btn) {
    console.log("üî¥ [DEBUG] Bot√£o X clicado!", btn);

    const node = btn.closest('.depot-category, .depot-subtitle');
    if (!node) return console.error("Elemento pai n√£o encontrado");

    const isCategory = node.classList.contains('depot-category');
    const label = isCategory ? "Categoria" : "Subt√≠tulo";
    const nameInput = node.querySelector('input');
    const name = nameInput ? nameInput.value : "";

    // POPUP
    const confirmed = await showConfirmation(
        `Eliminar ${label}?`, 
        `Vai apagar "${name || label}" e todo o conte√∫do dentro.\nContinuar?`
    );

    if (confirmed) {
        console.log("‚úÖ Confirmado. Apagando...");
        
        // Efeito visual
        node.style.transition = "opacity 0.3s, transform 0.3s";
        node.style.opacity = "0";
        node.style.transform = "translateX(20px)";

        setTimeout(() => {
            node.remove();
            if (typeof saveNote === 'function') saveNote();
        }, 300);
    } else {
        console.log("‚ùå Cancelado.");
    }
};



async function handleAutoBackupLogic(noteId, noteData) {
    if (!auth.currentUser) return;

    // Prote√ß√£o Extra: Se a nota nunca foi editada, n√£o vale a pena contar views para backup
    // (Isto evita criar backups de notas vazias que s√≥ abriste por engano)
    if (!noteData.conteudo || noteData.conteudo === "<p><br></p>") return;

    const currentViews = noteData.viewCount || 0;
    const newViewCount = currentViews + 1;
    const noteRef = doc(db, 'pastas', noteId);

    // 1. Atualiza o contador
    updateDoc(noteRef, { viewCount: newViewCount }).catch(err => console.error(err));

    // 2. Verifica o intervalo (Agora a cada 50)
    if (newViewCount % AUTO_BACKUP_INTERVAL === 0) {
        console.log(`ü§ñ [AUTO-BACKUP] Atingiu ${newViewCount} visualiza√ß√µes. Gerando c√≥pia...`);
        
        try {
            const backupsRef = collection(db, 'pastas', noteId, 'backups');
            
            await addDoc(backupsRef, {
                titulo: noteData.nome || "Sem T√≠tulo",
                conteudo: noteData.conteudo || "",
                timestamp: serverTimestamp(),
                isAutoBackup: true,
                triggerReason: `Backup Auto (${newViewCount} views)`
            });
            
            // Feedback discreto
            const statusEl = document.getElementById('save-status-indicator');
            if(statusEl) {
                const originalText = statusEl.textContent;
                statusEl.textContent = "Backup Auto ü§ñ";
                setTimeout(() => statusEl.textContent = originalText, 3000);
            }

        } catch (e) {
            console.error("Erro backup auto:", e);
        }
    }
}

// NOVA FUN√á√ÉO: EXPANDIR/RECOLHER TUDO NA GRUA
window.toggleAllDepotNodes = function(btn) {
    // 1. Encontra a Grua (Wrapper)
    const wrapper = btn.closest('.ref-depot-wrapper');
    if (!wrapper) return;

    // 2. Encontra todas as pastas (Categorias e Subt√≠tulos)
    const allNodes = wrapper.querySelectorAll('.depot-category, .depot-subtitle');
    if (allNodes.length === 0) return;

    // 3. Decide a a√ß√£o: 
    // Se existir pelo menos UMA pasta fechada, vamos ABRIR tudo.
    // Se estiverem todas abertas, vamos FECHAR tudo.
    const shouldExpand = Array.from(allNodes).some(node => node.classList.contains('is-collapsed'));

    // 4. Aplica a todos os n√≥s
    allNodes.forEach(node => {
        if (shouldExpand) {
            node.classList.remove('is-collapsed'); // Abre
        } else {
            node.classList.add('is-collapsed'); // Fecha
        }
    });
};

// --- INJE√á√ÉO DO BOT√ÉO H√çBRIDO NO MODAL DE T√ìPICOS/√ÇNCORAS ---
(function setupHybridToggle() {
    const modalFooter = document.querySelector('#topics-modal .modal-actions');
    if (!modalFooter) return;

    // Cria o contentor do Toggle
    const hybridContainer = document.createElement('div');
    hybridContainer.id = 'hybrid-toggle-container';
    hybridContainer.style.cssText = "display: none; align-items: center; margin-right: auto;"; // Escondido por padr√£o (s√≥ aparece na aba √Çncoras)
    
    hybridContainer.innerHTML = `
        <label class="setting-switch" style="margin-right: 10px;">
            <input type="checkbox" id="hybrid-mode-toggle">
            <span class="slider round"></span>
        </label>
        <span style="font-weight:bold; color:var(--text-muted-color); font-size:0.9em;">‚öì + üìú</span>
    `;

    // Insere no in√≠cio do rodap√© (antes do Cancelar)
    modalFooter.insertBefore(hybridContainer, modalFooter.firstChild);

    // L√≥gica para mostrar/esconder dependendo da aba
    document.getElementById('topics-modal-tabs').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const tab = btn.dataset.tab;
        
        // S√≥ mostra o bot√£o se estiver na aba √Çncoras
        hybridContainer.style.display = (tab === 'anchors') ? 'flex' : 'none';
    });
})();


async function generateHybridView() {
    const list = document.getElementById('note-texts-view');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    // 1. Indicador de Carregamento (S√≥ se n√£o for chamada oculta)
    if (list.offsetParent !== null) {
        list.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar Misto...</span></div>';
    }

    // 2. EXTRA√á√ÉO DE TEXTO
    let textContent = editor.innerText;
    editor.querySelectorAll('input, textarea').forEach(el => {
        if (el.value) textContent += " " + el.value;
    });
    
    textContent = textContent.replace(/\s+/g, ' '); 
    const textContentLower = textContent.toLowerCase();

    // 3. PREPARA√á√ÉO DE DADOS
    let anchorItems = [];
    let bibleItems = [];
    
    // --- FASE A: √ÇNCORAS ---
    if (activeNoteAnchorsIds && activeNoteAnchorsIds.length > 0) {
        const allCandidates = Object.values(allEntities).flat();
        const addedNames = new Set();
        
        allCandidates.forEach(entity => {
            const entityAnchors = entity.ancorasAssociadas || {};
            const hasMatchingAnchor = activeNoteAnchorsIds.some(id => entityAnchors[id]);

            if (!hasMatchingAnchor) return;

            if (textContentLower.includes(entity.nome.toLowerCase())) {
                if (addedNames.has(entity.nome)) return;
                addedNames.add(entity.nome);

                let icon = entity.emoji || "üîπ"; 
                if (!entity.emoji) {
                    if (entity.tipo === 'personagem') icon = "üë§";
                    else if (entity.tipo === 'local') icon = "üìç";
                    else if (entity.tipo === 'cosmos') icon = "ü™ê";
                    else if (entity.tipo === 'subcosmos') icon = "üß¨";
                }

                anchorItems.push({
                    type: 'anchor',
                    name: entity.nome,
                    icon: icon,
                    desc: entity.descricao,
                    id: entity.id,
                    entityType: entity.tipo
                });
            }
        });
    }

    // --- FASE B: B√çBLIA ---
    const renderPromises = []; // Array para esperar textos
    
    if (typeof BIBLICAL_BOOKS !== 'undefined' && BIBLICAL_BOOKS.length > 0) {
        const canonicalBookMap = {};
        const flexiblePatterns = [];
        const sortedBooks = [...BIBLICAL_BOOKS].sort((a, b) => b.length - a.length);

        sortedBooks.forEach(book => {
            const normalized = normalizeStr(book); 
            canonicalBookMap[normalized] = book;   
            flexiblePatterns.push(getFlexibleRegexStr(book));
        });

        const booksPattern = flexiblePatterns.join('|');
        const regex = new RegExp(`(?:^|[\\s"'(])((?:${booksPattern})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)`, 'gi');
        
        const rawMatches = textContent.match(regex) || [];
        const uniqueRefs = [...new Set(rawMatches.map(r => {
            let foundText = r.replace(/^[ "((]+/, '').trim();
            const splitMatch = foundText.match(/^(.+?)\s+(\d+:.*)$/);
            if (splitMatch) {
                const foundBookName = splitMatch[1]; 
                const numbers = splitMatch[2];       
                const normalizedFound = normalizeStr(foundBookName);
                const officialName = canonicalBookMap[normalizedFound];
                if (officialName) return `${officialName} ${numbers}`;
            }
            return foundText;
        }))];

        uniqueRefs.forEach(ref => {
            bibleItems.push({ type: 'bible', name: ref, icon: "üìú", desc: "A carregar..." });
        });
    }

    // --- FASE C: RENDERIZA√á√ÉO FINAL ---
    list.innerHTML = '';

    if (anchorItems.length === 0 && bibleItems.length === 0) {
        list.innerHTML = '<div style="padding:40px 20px; color:#888; text-align:center;">Nenhuma refer√™ncia encontrada.</div>';
        return;
    }

    const createRow = (item) => {
        const div = document.createElement('div');
        div.style.cssText = "padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 4px; position: relative;";
        const borderSide = item.type === 'anchor' ? '4px solid var(--accent-color)' : '4px solid #e67e22';
        div.style.borderLeft = borderSide;
        div.style.paddingLeft = "10px";

        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = "font-weight: bold; color: var(--text-color); cursor: pointer; font-size: 0.95em;";
        titleDiv.innerHTML = `${item.icon} ${item.name}`;
        
        titleDiv.onclick = (e) => {
            e.stopPropagation();
            if (typeof scrollToAndHighlightText === 'function') scrollToAndHighlightText(item.name);
        };

        const descDiv = document.createElement('div');
        descDiv.style.cssText = "font-size: 0.85em; color: var(--text-muted-color); cursor: pointer; line-height: 1.4;";
        if (item.type === 'bible') {
            const safeId = item.name.replace(/[^a-zA-Z0-9]/g, '');
            descDiv.id = `hybrid-preview-${safeId}`;
            
            // --- AQUI EST√Å O TRUQUE: Adiciona a promessa ao array ---
            const verses = typeof expandVerseReference === 'function' ? expandVerseReference(item.name) : [item.name];
            const p = Promise.all(verses.map(v => fetchPublicBibleText(v))).then(texts => {
                const fullText = texts.filter(t => t).join(" ");
                if (document.getElementById(`hybrid-preview-${safeId}`)) {
                    document.getElementById(`hybrid-preview-${safeId}`).textContent = fullText || "Texto n√£o dispon√≠vel.";
                }
            });
            renderPromises.push(p);
        } else {
            descDiv.textContent = item.desc || "Sem descri√ß√£o.";
        }
        
        descDiv.onclick = (e) => {
            e.stopPropagation();
            const targetType = item.type === 'bible' ? 'textobiblico' : item.entityType;
            const targetId = item.type === 'bible' ? null : item.id;
            showReferencesPanel(targetId, item.name, targetType);
        };

        div.appendChild(titleDiv);
        div.appendChild(descDiv);
        return div;
    };

    if (anchorItems.length > 0) {
        const header = document.createElement('div');
        header.innerHTML = "TEMAS";
        header.style.cssText = "font-size:0.7em; font-weight:bold; color:var(--text-muted-color); padding:5px 10px; background:rgba(0,0,0,0.2); letter-spacing:1px; margin-top:0;";
        list.appendChild(header);
        anchorItems.forEach(item => list.appendChild(createRow(item)));
    }

    if (bibleItems.length > 0) {
        const header = document.createElement('div');
        header.innerHTML = "B√çBLIA";
        header.style.cssText = "font-size:0.7em; font-weight:bold; color:var(--text-muted-color); padding:5px 10px; background:rgba(0,0,0,0.2); margin-top:10px; letter-spacing:1px;";
        list.appendChild(header);
        bibleItems.forEach(item => list.appendChild(createRow(item)));
    }
    
    // Espera que todos os textos b√≠blicos carreguem antes de dizer "pronto"
    await Promise.all(renderPromises);
}




// --- OBSERVADOR DE LEITURA (REMOVE PONTOS AO LER) ---
const postObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        // Se o post est√° mais de 60% vis√≠vel no ecr√£
        if (entry.isIntersecting) {
            const postDiv = entry.target;
            const dot = postDiv.querySelector('.post-status-dot');

            // Se tiver um ponto, agendamos o desaparecimento
            if (dot) {
                // Espera 1.5 segundos (Tempo de leitura)
                setTimeout(() => {
                    // Verifica se o ponto ainda l√° est√° e se o post ainda existe
                    if (dot && document.contains(dot)) {
                        // Adiciona classe CSS que faz desaparecer (opacity: 0)
                        dot.classList.add('dot-vanish');
                        
                        // Remove fisicamente do HTML depois da anima√ß√£o acabar
                        setTimeout(() => dot.remove(), 600);
                    }
                }, 1500); 
            }

            // Para de observar este post (j√° foi processado)
            postObserver.unobserve(postDiv);
        }
    });
}, {
    threshold: 0.6 // O post tem de estar 60% vis√≠vel para contar como "visto"
});

// ============================================================
// MOTOR DO AQU√ÅRIO ü™∏ (VERS√ÉO BLINDADA)
// ============================================================

// 1. Fun√ß√£o para Abrir o Ambiente
window.openAquariumEnvironment = async function(id, data) {
    console.group("ü™∏ [ABERTURA BLINDADA] A trocar para: " + data.nome);

    // 1. LIMPEZA DE POPUPS (NOVO)
    window.closeAllFloatingPopups();

    // 2. PARAGEM DE EMERG√äNCIA
    if (typeof aqAutoSaveTimer !== 'undefined') clearTimeout(aqAutoSaveTimer);
    if (typeof aqTitleTimer !== 'undefined') clearTimeout(aqTitleTimer);
    if (typeof saveTimeout !== 'undefined') clearTimeout(saveTimeout);
    
    // 3. GRAVA√á√ÉO SEGURA DA NOTA ANTERIOR
    if (selectedNoteId && selectedNoteId !== id) {
        const isAquariumVisible = document.getElementById('aquarium-environment').style.display !== 'none';
        
        if (isAquariumVisible) {
            await window.saveAquariumState();
        } else {
            await saveNote(true);
        }

        if (unsubscribeCurrentNote) {
            unsubscribeCurrentNote();
            unsubscribeCurrentNote = null;
        }
    }

    // 4. LIMPEZA E TROCA DE ID
    if (typeof window.resetAquariumState === 'function') window.resetAquariumState();
    
    selectedNoteId = id; 
    window.nextSelectedId = null;
    
    // 5. ATUALIZA√á√ÉO VISUAL
    
    // A. T√≠tulo
    const titleGroup = document.querySelector('.aquarium-title-group');
    if (titleGroup) {
        titleGroup.innerHTML = ''; 
        const titleInput = document.createElement('input');
        titleInput.type = 'text';
        titleInput.id = 'aquarium-title-input';
        titleInput.className = 'aquarium-header-input';
        titleInput.value = data.nome || "Sem T√≠tulo";
        titleInput.placeholder = "Nome do Aqu√°rio...";
        
        titleInput.addEventListener('input', (e) => {
            clearTimeout(window.aqTitleTimer);
            window.aqTitleTimer = setTimeout(() => {
                if (typeof window.saveAquariumTitle === 'function') {
                    window.saveAquariumTitle(e.target.value);
                }
            }, 1000);
        });
        titleGroup.appendChild(titleInput);
    }
    
    // B. Conte√∫do (Canvas)
    const canvas = document.getElementById('aquarium-content-canvas');
    if (canvas) {
        if (data.conteudo && data.conteudo.trim() !== "") {
            if (typeof DOMPurify !== 'undefined') {
                canvas.innerHTML = DOMPurify.sanitize(data.conteudo);
            } else {
                canvas.innerHTML = data.conteudo;
            }
        } else {
            canvas.innerHTML = '<div class="ghost-block" contenteditable="true" data-placeholder=""></div>';
        }

        const savedZoom = data.zoomLevel || '100%';
        const aqZoomSelect = document.getElementById('aq-zoom');
        if (aqZoomSelect) aqZoomSelect.value = savedZoom;
        canvas.style.fontSize = savedZoom;

        canvas.querySelectorAll('.ghost-block').forEach(g => {
            g.classList.remove('locked-popup', 'active-selection', 'active-store-target');
            g.style.cssText = "";
            g.setAttribute('contenteditable', 'true');
            if (typeof ensureGhostActions === 'function') ensureGhostActions(g);
        });
    }

    // 6. EXIBI√á√ÉO
    const mainApp = document.querySelector('.notebook-container');
    if (mainApp) mainApp.style.setProperty('display', 'none', 'important');

    const env = document.getElementById('aquarium-environment');
    if (env) {
        document.body.appendChild(env);
        env.style.cssText = `
            display: flex !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important; width: 100vw; height: 100vh !important;
            z-index: 2000000000 !important;
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%) !important;
            opacity: 0; visibility: visible !important;
            transition: opacity 0.5s ease;
        `;
        requestAnimationFrame(() => { setTimeout(() => { env.style.opacity = '1'; }, 10); });
    }

    console.log("üèÅ Carregamento conclu√≠do com seguran√ßa.");
    console.groupEnd();
};

// 2. Corrigir o clique no bot√£o de Salto (Para n√£o gravar duas vezes)
window.loadAquariumNotesList = async function(filterText = "") {
    const list = document.getElementById('aquarium-jump-list');
    if (!list) return;

    list.innerHTML = '<li style="padding:10px; color:#888;">A carregar aqu√°rios...</li>';

    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'aquario'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum outro aqu√°rio encontrado.</li>';
            return;
        }

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const nomeSeguro = data.nome || "Aqu√°rio Sem T√≠tulo";
            const item = { id: docSnap.id, nome: nomeSeguro, ...data };
            
            if (item.id === selectedNoteId) return; // N√£o mostra o atual
            if (filterText && !nomeSeguro.toLowerCase().includes(filterText.toLowerCase())) return;

            const li = document.createElement('li');
            li.style.cssText = "padding:10px; border-bottom:1px solid var(--border-color); cursor:pointer; display:flex; align-items:center; gap:8px;";
            li.innerHTML = `<span style="font-size:1.2em;">ü™∏</span> <span>${nomeSeguro}</span>`;
            
            li.onclick = async () => {
                // 1. Feedback visual
                li.style.backgroundColor = "var(--accent-color)";
                li.style.color = "white";
                li.textContent = "A trocar...";

                // 2. Fecha o popup
                document.getElementById('aquarium-jump-popup').style.display = 'none';

                // 3. Executa a abertura segura (A fun√ß√£o openAquariumEnvironment acima j√° trata da grava√ß√£o do antigo)
                await window.openAquariumEnvironment(item.id, item);
            };

            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erro ao carregar lista:", e);
    }
};


// ============================================================
// FUN√á√ÉO DE GRAVA√á√ÉO DO AQU√ÅRIO
// ============================================================
window.saveAquariumState = async function() {
    // 1. Limpa o temporizador (pois vamos gravar agora)
    clearTimeout(aqAutoSaveTimer);
    
    if (!selectedNoteId) return;
    
    // Atualiza visual para "A guardar..."
    updateAquariumStatus('saving');

    const canvas = document.getElementById('aquarium-content-canvas');
    if (!canvas) return;

    // --- LIMPEZA DE DADOS (CLONE) ---
    const cleanCanvas = canvas.cloneNode(true);
    cleanCanvas.querySelectorAll('.ghost-actions').forEach(el => el.remove());
    cleanCanvas.querySelectorAll('.aq-popup-window').forEach(el => el.remove());

    cleanCanvas.querySelectorAll('.ghost-block').forEach(block => {
        block.classList.remove('locked-popup', 'active-selection', 'active-store-target'); 
        block.style.cssText = ""; // Limpa estilos inline
        block.setAttribute('contenteditable', 'true');
        block.removeAttribute('data-temp-id');
    });

    const content = cleanCanvas.innerHTML;
    const titleInput = document.getElementById('aquarium-title-input');
    const currentTitle = titleInput ? titleInput.value : null;

 const aqZoom = document.getElementById('aq-zoom');
    const currentZoom = aqZoom ? aqZoom.value : '100%';


    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);

        const updatePayload = {
            conteudo: content,
             zoomLevel: currentZoom, 
            ultimaedicao: serverTimestamp()
        };

        if (currentTitle && currentTitle !== "Sem T√≠tulo") {
            updatePayload.nome = currentTitle;
        }

        await updateDoc(noteRef, updatePayload);
        
        // SUCESSO: Atualiza para "Guardado"
        updateAquariumStatus('saved');

    } catch (e) {
        console.error("‚ùå Erro ao gravar Aqu√°rio:", e);
        updateAquariumStatus('error');
    }
};

// ============================================================
// BOT√ÉO VOLTAR (SAIR DO AQU√ÅRIO E RESTAURAR APP)
// ============================================================
const aqBackBtn = document.getElementById('aquarium-back-btn');
if (aqBackBtn) {
    const newBtn = aqBackBtn.cloneNode(true);
    aqBackBtn.parentNode.replaceChild(newBtn, aqBackBtn);

    newBtn.addEventListener('click', async () => {
        // 1. Grava o estado atual (Seguran√ßa)
        if (typeof saveAquariumState === 'function') await saveAquariumState();
        
        // 2. Limpa o ambiente do Aqu√°rio e reseta vari√°veis
        window.resetAquariumState();
        
        // 3. Esconde o ambiente Aqu√°rio
        const env = document.getElementById('aquarium-environment');
        if (env) env.style.display = 'none';
        
        // 4. Restaura a App Principal (Notebook Container)
        const mainApp = document.querySelector('.notebook-container');
        if (mainApp) mainApp.style.setProperty('display', 'flex', 'important');
        document.body.style.overflow = ''; 

        // ============================================================
        // AQUI EST√Å A CORRE√á√ÉO PRINCIPAL
        // ============================================================
        
        // 1. Limpa o ID da nota selecionada para que o sistema saiba que nada est√° aberto
        selectedNoteId = null;

        // 2. Chama resetEditor() para for√ßar o aparecimento do Placeholder (O Livro)
        // e esconder a √°rea de edi√ß√£o.
        resetEditor();

        // 3. Mobile: Garante que volta √† lista de pastas e n√£o fica no ecr√£ branco da direita
        if (window.innerWidth <= 768) {
            document.body.classList.remove('mobile-view-editor');
            document.body.classList.add('mobile-view-middle');
            
            // For√ßamos o contentor a n√£o estar colapsado
            if (mainApp) mainApp.classList.remove('middle-panel-collapsed');
        }

        // 4. Atualiza a lista da esquerda/meio (False = n√£o tenta reabrir o editor)
        updateNavigationView(false); 
        
        console.log("üìÇ [SA√çDA AQU√ÅRIO] Reset completo para o Placeholder.");
    });
}

// ============================================================
// CORRE√á√ÉO: BOT√ïES DE TOPO DO AQU√ÅRIO (Z-INDEX FIX)
// ============================================================

// 1. BOT√ÉO SALTAR (íÜú)
const jumpBtnFix = document.getElementById('aquarium-jump-btn');

if (jumpBtnFix) {
    const newJumpBtn = jumpBtnFix.cloneNode(true);
    jumpBtnFix.parentNode.replaceChild(newJumpBtn, jumpBtnFix);

    newJumpBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        // 1. GRAVA√á√ÉO IMEDIATA DE SEGURAN√áA
        if (typeof window.saveAquariumState === 'function') {
            updateAquariumStatus('saving');
            await window.saveAquariumState();
        }
        
        // 2. Abre o popup normalmente
        const popup = document.getElementById('aquarium-jump-popup');
        if (popup) {
            if (popup.style.display === 'flex') {
                popup.style.display = 'none';
            } else {
                document.body.appendChild(popup);
                popup.style.cssText = `
                    display: flex !important;
                    position: fixed !important;
                    z-index: 2147483647 !important;
                    top: 60px !important;
                    left: 80px !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    background-color: #252528 !important; 
                    box-shadow: 0 10px 50px rgba(0,0,0,1) !important;
                    border: 1px solid var(--accent-color);
                    border-radius: 8px;
                    padding: 10px;
                    flex-direction: column;
                    width: 300px;
                `;
                
                const search = document.getElementById('aquarium-jump-search');
                if (search) {
                    search.value = "";
                    search.focus();
                    search.oninput = (ev) => loadAquariumNotesList(ev.target.value);
                }
                loadAquariumNotesList();
            }
        }
    });
}

// 2. BOT√ïES DE FERRAMENTAS (üîê üìë üïí ‚Ü©Ô∏è ‚Ü™Ô∏è)
const toolsGroupFix = document.querySelector('.aquarium-tools-group');

if (toolsGroupFix) {
    // Limpeza de seguran√ßa (Clonagem)
    const newToolsGroup = toolsGroupFix.cloneNode(true);
    toolsGroupFix.parentNode.replaceChild(newToolsGroup, toolsGroupFix);

    newToolsGroup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const action = btn.dataset.action;
        let modalId = null;

        // --- A√á√ïES DO SISTEMA ---
        if (action === 'note-sharing-settings') {
            if (typeof window.openShareModalForArchive === 'function') {
                window.openShareModalForArchive();
                modalId = 'note-share-popup';
            }
        }
        else if (action === 'show-topics') {
            if (typeof openTopicsModal === 'function') {
                openTopicsModal(selectedNoteId, 'nota');
                modalId = 'topics-modal';
            }
        }
        else if (action === 'show-history') {
            if (typeof openHistoryModal === 'function') {
                openHistoryModal();
                modalId = 'history-modal';
            }
        }

        // --- NOVAS A√á√ïES: UNDO / REDO ---
        else if (action === 'undo') {
            document.execCommand('undo', false, null);
            // Opcional: Gravar o estado ap√≥s desfazer
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }
        else if (action === 'redo') {
            document.execCommand('redo', false, null);
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }

        // --- CORRE√á√ÉO DE VISIBILIDADE DE MODAIS ---
        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                document.body.appendChild(modal);
                modal.style.setProperty('z-index', '2147483647', 'important');
                modal.style.setProperty('display', 'flex', 'important');
                modal.style.setProperty('visibility', 'visible', 'important');
                modal.style.setProperty('opacity', '1', 'important');
            }
        }
    });
}

// ============================================================
// L√ìGICA DA BARRA DE FERRAMENTAS DE BAIXO (WIDGETS DIRECTOS)
// ============================================================

const aqToolbarFix = document.getElementById('aquarium-toolbar');

if (aqToolbarFix) {
    // 1. Remover ouvintes antigos (Clonagem)
    const newToolbar = aqToolbarFix.cloneNode(true);
    aqToolbarFix.parentNode.replaceChild(newToolbar, aqToolbarFix);

    // 2. Novo Listener Unificado
    newToolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        // --- A. MENU DE PONTOS (‚Ä¢‚Ä¢) ---
        if (e.target.classList.contains('dots')) {
            e.stopPropagation();
            const cmd = btn.dataset.cmd;
            const popupId = (cmd === 'boldBlue') ? 'bold-palette-popup' : 'italic-palette-popup';
            
            const popup = document.getElementById(popupId);
            if (popup) {
                document.body.appendChild(popup);
                const rect = btn.getBoundingClientRect();
                popup.style.display = 'block';
                popup.style.top = (rect.bottom + 5) + 'px';
                popup.style.left = rect.left + 'px';
                popup.style.setProperty('z-index', '2147483647', 'important');
            }
            return; // N√£o grava aqui porque abriu um menu, gravar√° quando escolher a cor
        }

        // --- B. COMANDOS DE TEXTO ---
        if (btn.dataset.cmd) {
            const cmd = btn.dataset.cmd;
            if (cmd === 'boldBlue') {
                document.execCommand('bold', false, null);
                document.execCommand('foreColor', false, '#4a90e2');
            } else {
                document.execCommand(cmd, false, null);
            }
        }

        // --- C. A√á√ïES DE WIDGETS E FERRAMENTAS ---
        else if (btn.dataset.action) {
            const action = btn.dataset.action;
            const uniqueId = `aq_${action}_${Date.now()}`;

            // >>> BURACO NEGRO (üï≥Ô∏è) <<<
            if (action === 'black-hole') {
                if (typeof openBlackHoleModal === 'function') {
                    openBlackHoleModal();
                    // Z-Index fix
                    const bhModal = document.getElementById('black-hole-modal');
                    if(bhModal) {
                        document.body.appendChild(bhModal);
                        bhModal.style.setProperty('z-index', '2147483647', 'important');
                        bhModal.style.display = 'flex';
                    }
                }
                return; // N√£o grava, apenas abre modal
            }

            // ... (INSER√á√ïES DE WIDGETS) ...
            if (action === 'bible-scan') {
                if (typeof openUniversalScanner === 'function') {
                    openUniversalScanner();
                    const scanModal = document.getElementById('universal-scan-modal');
                    if (scanModal) {
                        document.body.appendChild(scanModal);
                        scanModal.style.setProperty('z-index', '2147483647', 'important');
                        scanModal.style.setProperty('visibility', 'visible', 'important');
                    }
                }
                return; // N√£o grava, abre modal
            }
            else if (action === 'insert-toggle-h2') {
                document.execCommand('insertHTML', false, `<details class="toggle-section" open id="${uniqueId}"><summary><h2>T√≠tulo</h2><button class="toggle-delete-btn" contenteditable="false">üóëÔ∏è</button></summary><div class="toggle-content" contenteditable="true"><p><br></p></div></details><p><br></p>`);
            }
            else if (action === 'insert-date') {
                const today = new Date();
                document.execCommand('insertHTML', false, `<div class="jwn-calendar-widget" contenteditable="false" id="${uniqueId}" data-view="month" data-month="${today.getMonth()}" data-year="${today.getFullYear()}"><div class="cal-header"><button class="cal-btn cal-prev">‚óÄ</button><span class="cal-title">Carregando...</span><div style="display:flex; gap:5px;"><button class="cal-btn cal-next">‚ñ∂</button><button class="cal-btn cal-settings">‚öôÔ∏è</button></div></div><div class="cal-settings-menu"><button class="cal-delete-btn">üóëÔ∏è Eliminar</button></div><div class="cal-grid"></div></div><p><br></p>`);
                setTimeout(() => { if (typeof renderCalendarUI === 'function') renderCalendarUI(document.getElementById(uniqueId)); }, 50);
            }
            else if (action === 'insert-table') {
                document.execCommand('insertHTML', false, `<div class="jwn-table-wrapper"><button class="table-settings-btn" contenteditable="false">üõ†Ô∏è</button><table class="jwn-table"><thead><tr><th>T1</th><th>T2</th></tr></thead><tbody><tr><td><br></td><td><br></td></tr></tbody></table></div><p><br></p>`);
            }
            else if (action === 'insert-timeline') {
                document.execCommand('insertHTML', false, `<div class="jwn-timeline-wrapper" contenteditable="false" id="${uniqueId}"><div class="timeline-track"></div><div class="timeline-container"><div class="timeline-entry"><div class="t-marker"></div><div class="t-date" contenteditable="true">Data</div><div class="t-text" contenteditable="true">Evento...</div><button class="t-btn-del">√ó</button></div></div><button class="t-btn-add">‚ûï Ponto</button></div><p><br></p>`);
            }
            else if (action === 'make-draggable') {
                const sel = window.getSelection().toString() || "Texto";
                document.execCommand('insertHTML', false, `<div class="draggable-line" draggable="true" id="${uniqueId}"><span class="drag-handle-icon" contenteditable="false">·Øì</span><div class="drag-content-area" contenteditable="true">${sel}</div></div>`);
            }
            else if (action === 'insert-checkbox') {
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.style.marginRight = '8px';
                if (typeof insertNodeAtCursor === 'function') insertNodeAtCursor(cb);
            }
            else if (action === 'insertHorizontalRule') {
                document.execCommand('insertHorizontalRule', false, null);
            }
        }

        // ============================================================
        // 4. GRAVA√á√ÉO IMEDIATA (FOR√áA BRUTA)
        // ============================================================
        // Como alter√°mos a estrutura (negrito, widgets, etc.), gravamos J√Å.
        // N√£o esperamos 2 minutos.
        console.log("üíæ [TOOLBAR] A√ß√£o estrutural detetada. Gravando imediatamente...");
        
        // Limpa o timer de escrita para n√£o gravar duas vezes
        if (typeof aqAutoSaveTimer !== 'undefined') clearTimeout(aqAutoSaveTimer);

        setTimeout(() => {
             if (typeof updateAquariumStatus === 'function') updateAquariumStatus('saving');
             if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }, 100); // Pequeno delay para o DOM processar o comando
    });

    // Re-liga√ß√£o dos inputs (Zoom, Formato, Cor) - Estes tamb√©m devem gravar ao mudar
    const aqZoom = document.getElementById('aq-zoom');
    if (aqZoom) aqZoom.addEventListener('change', (e) => { 
        const c = document.getElementById('aquarium-content-canvas'); 
        if (c) c.style.fontSize = e.target.value; 
        window.saveAquariumState(); // Grava Zoom
    });
    
    const aqFormat = document.getElementById('aq-format');
    if (aqFormat) aqFormat.addEventListener('change', (e) => { 
        document.execCommand('formatBlock', false, e.target.value); 
        window.saveAquariumState(); // Grava Formato
    });
    
    const aqColor = document.getElementById('aq-color');
    if (aqColor) aqColor.addEventListener('input', (e) => { 
        document.execCommand('foreColor', false, e.target.value); 
        // Nota: Cores via input gravam muito, talvez aqui queira um debounce pequeno, 
        // mas como pediu "bot√µes e outros", input imediato √© o mais seguro.
        window.saveAquariumState(); 
    });
}

// ============================================================
// L√ìGICA DOS FANTASMAS (CANVAS)
// ============================================================

// 1. Definir a vari√°vel globalmente para ser acess√≠vel pelos bot√µes
window.activeGhost = null;

// 2. Fun√ß√£o para ativar o bloco e mostrar a barra
window.setActiveGhost = function(ghost) {
    window.activeGhost = ghost;
    
    // --- LIMPEZA DE DESTAQUE DO ARMAZ√âM (Mant√©m a l√≥gica existente) ---
    if (window.activeStoreGhostId && ghost.id !== window.activeStoreGhostId) {
        const oldTarget = document.getElementById(window.activeStoreGhostId);
        if (oldTarget) {
            oldTarget.classList.remove('active-store-target');
            oldTarget.style.border = '';
            oldTarget.style.backgroundColor = '';
            oldTarget.style.boxShadow = '';
        }
    }

    const contextTools = document.getElementById('aq-context-tools');
    
    if (contextTools) {
        contextTools.style.setProperty('display', 'flex', 'important');
        
        // 1. Limpa classes de todos os blocos
        document.querySelectorAll('.ghost-block').forEach(g => {
            g.classList.remove('active-selection');
            g.classList.remove('has-next'); // Remove a permiss√£o do bot√£o +
            
            // Limpezas de estilo inline
            g.style.borderTop = '';
            g.style.border = '';
            g.style.outline = '';
        });
        
        // 2. Adiciona classe de sele√ß√£o ao atual
        ghost.classList.add('active-selection');
        
        // ============================================================
        // NOVA L√ìGICA DO BOT√ÉO "+"
        // ============================================================
        // Verifica se existe um elemento irm√£o seguinte E se √© um ghost-block
        const nextBlock = ghost.nextElementSibling;
        
        if (nextBlock && nextBlock.classList.contains('ghost-block')) {
            // Se houver um bloco a seguir, adiciona a classe que faz o CSS mostrar o bot√£o
            ghost.classList.add('has-next');
        }
        // ============================================================

        // 3. SEGURAN√áA M√ÅXIMA (Mant√©m l√≥gica existente)
        ghost.style.removeProperty('border-top');
        ghost.style.removeProperty('border');
        ghost.style.removeProperty('outline');
        
    } else {
        console.warn("‚ö†Ô∏è Barra de ferramentas #aq-context-tools n√£o encontrada.");
    }
};

// Fun√ß√£o auxiliar para injetar os bot√µes se n√£o existirem
function ensureGhostActions(ghost) {
    
    // 1. Bot√µes de Topo (Menu e Armaz√©m)
    if (!ghost.querySelector('.ghost-actions')) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'ghost-actions';
        actionsDiv.setAttribute('contenteditable', 'false'); // Atributo HTML expl√≠cito
        actionsDiv.innerHTML = `
            <button class="ghost-action-btn" title="Armaz√©m (Notas Anexadas)" onclick="window.openGhostStore(this)">üêö</button>
            <button class="ghost-action-btn" title="Abrir Popup" onclick="window.openGhostPopup(this)">‚á±</button>
        `;
        ghost.prepend(actionsDiv);
    }

    // 2. Limpeza de bot√µes antigos soltos
    const oldAddBtn = ghost.querySelector(':scope > .ghost-add-between-btn');
    if (oldAddBtn) oldAddBtn.remove();

    // 3. CONTROLOS LATERAIS (Setas + Bot√£o Adicionar)
    let sideControls = ghost.querySelector('.ghost-side-controls');
    
    if (!sideControls) {
        console.log("üõ†Ô∏è [DEBUG] Criando barra lateral (Secure Mode)...");
        
        sideControls = document.createElement('div');
        sideControls.className = 'ghost-side-controls';
        sideControls.setAttribute('contenteditable', 'false'); // BLINDAGEM 1

        // Bot√£o Subir (üî∫)
        const upBtn = document.createElement('button');
        upBtn.className = 'ghost-move-btn';
        upBtn.innerHTML = '‚ñ≤';
        upBtn.setAttribute('contenteditable', 'false'); // BLINDAGEM 2
        
        upBtn.onclick = (e) => {
            console.log("üî∫ [CLIQUE] Bot√£o SUBIR!");
            e.preventDefault(); e.stopPropagation(); 
            window.moveGhostBlock(ghost, -1);
        };
        // O mousedown previne que o foco mude para o texto
        upBtn.onmousedown = (e) => { e.preventDefault(); e.stopPropagation(); };

        // Bot√£o Descer (üîª)
        const downBtn = document.createElement('button');
        downBtn.className = 'ghost-move-btn';
        downBtn.innerHTML = '‚ñº';
        downBtn.setAttribute('contenteditable', 'false'); // BLINDAGEM 2
        
        downBtn.onclick = (e) => {
            console.log("üîª [CLIQUE] Bot√£o DESCER!");
            e.preventDefault(); e.stopPropagation();
            window.moveGhostBlock(ghost, 1);
        };
        downBtn.onmousedown = (e) => { e.preventDefault(); e.stopPropagation(); };

        // Bot√£o Adicionar (+)
        const addBtn = document.createElement('div');
        addBtn.className = 'ghost-add-between-btn';
        addBtn.setAttribute('contenteditable', 'false'); // BLINDAGEM 2
        
        addBtn.onclick = (e) => {
            console.log("‚ûï [CLIQUE] Bot√£o ADICIONAR!");
            e.preventDefault(); e.stopPropagation();
            window.insertBlockBelow(ghost);
        };
        addBtn.onmousedown = (e) => { e.preventDefault(); e.stopPropagation(); };

        sideControls.appendChild(upBtn);
        sideControls.appendChild(downBtn);
        sideControls.appendChild(addBtn);
        
        ghost.prepend(sideControls);
    }

    // 4. Garantia de Cursor
    let hasContent = false;
    ghost.childNodes.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') hasContent = true;
    });

    if (!hasContent && !ghost.querySelector('br')) {
        const br = document.createElement('br');
        ghost.appendChild(br);
    }
}

// Atualiza a cria√ß√£o de novos blocos
function createNewGhost() {
    const canvas = document.getElementById('aquarium-content-canvas');
    if (!canvas) return;
    
    const newGhost = document.createElement('div');
    newGhost.className = 'ghost-block';
    newGhost.setAttribute('contenteditable', 'true');
    newGhost.dataset.placeholder = ""; 
    
    if (typeof ensureGhostActions === 'function') {
        ensureGhostActions(newGhost);
    }
    
    canvas.appendChild(newGhost);
    
    // Foco e Scroll
    newGhost.focus();
    // Truque do Range para cursor
    const range = document.createRange();
    range.selectNodeContents(newGhost);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    
    window.setActiveGhost(newGhost);
    newGhost.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // --- GRAVA√á√ÉO IMEDIATA ---
    updateAquariumStatus('saving');
    window.saveAquariumState();
}

window.insertBlockBelow = function(currentBlock) {
    console.log("üöÄ A criar novo bloco...");
    
    const newGhost = document.createElement('div');
    newGhost.className = 'ghost-block';
    newGhost.id = 'ghost_' + Date.now();
    newGhost.setAttribute('contenteditable', 'true');
    newGhost.dataset.placeholder = "";
    
    currentBlock.insertAdjacentElement('afterend', newGhost);

    ensureGhostActions(newGhost);

    setTimeout(() => {
        newGhost.focus();
        if (typeof window.setActiveGhost === 'function') {
            window.setActiveGhost(newGhost);
        }
    }, 10);
    
    // --- GRAVA√á√ÉO IMEDIATA ---
    updateAquariumStatus('saving');
    if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
};

// 4. Configurar Listeners do Canvas (com atraso para garantir que o HTML existe)
 setTimeout(() => {
        const canvas = document.getElementById('aquarium-content-canvas');
        const scrollArea = document.getElementById('aquarium-scroll-area');

  if (canvas) {
            // A. DETETAR CLIQUE NO BLOCO
            canvas.addEventListener('click', (e) => {
                
                // >>> NOVA PROTE√á√ÉO: BLOCOS BLOQUEADOS <<<
                // Se clicou num bloco que est√° aberto em popup (.locked-popup), P√ÅRA TUDO.
                if (e.target.closest('.locked-popup')) {
                    console.log("üö´ Clique em bloco bloqueado ignorado.");
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                // >>> FIM DA PROTE√á√ÉO <<<

                const ghost = e.target.closest('.ghost-block');
                if (ghost) {
                    window.setActiveGhost(ghost);
                    e.stopPropagation();
                } 
            });

            // B. DETETAR CLIQUE NO VAZIO (Criar Novo) - >> CORRE√á√ÉO APLICADA AQUI <<
        if (scrollArea) {
                scrollArea.addEventListener('click', (e) => {
                    
                    // 1. Prote√ß√µes B√°sicas
                    const selection = window.getSelection();
                    if (selection && selection.toString().length > 0) return;
                    if (e.target.closest('.locked-popup')) return;

                    // 2. Verifica se clicou na estrutura base
                    if (e.target === scrollArea || e.target === canvas) {
                        
                        // --- NOVA L√ìGICA GEOM√âTRICA ---
                        const lastBlock = canvas.lastElementChild;

                        // Se o canvas tiver conte√∫do, verificamos a posi√ß√£o do clique
                        if (lastBlock) {
                            const rect = lastBlock.getBoundingClientRect();
                            const clickY = e.clientY;

                            // Se o clique foi ACIMA da linha inferior do √∫ltimo bloco,
                            // significa que foi numa margem lateral. IGNORAMOS.
                            if (clickY < rect.bottom) {
                                return; 
                            }
                        }
                        // -----------------------------

                        e.preventDefault(); 
                        
                        // Limpa sele√ß√£o visual
                        document.querySelectorAll('.ghost-block').forEach(g => {
                            g.classList.remove('active-selection');
                            g.style.outline = '';
                        });

                        // L√ìGICA DE CRIA√á√ÉO (Manteve-se igual)
                        if (lastBlock && lastBlock.classList.contains('ghost-block') && lastBlock.textContent.trim() === '') {
                            lastBlock.focus();
                            window.setActiveGhost(lastBlock);
                            
                            const range = document.createRange();
                            range.selectNodeContents(lastBlock);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        } 
                        else {
                            createNewGhost();
                        }
                    }
                });
            }

            // C. DETETAR FOCO (Tab ou Sele√ß√£o)
            canvas.addEventListener('focusin', (e) => {
                const ghost = e.target.closest('.ghost-block');
                if (ghost) window.setActiveGhost(ghost);
            });

      // D. DETETAR ESCRITA (L√≥gica de "Por Guardar")
           canvas.addEventListener('input', (e) => {
    const ghost = e.target.closest('.ghost-block');
    if (ghost) window.setActiveGhost(ghost);

    // 1. Muda status visual para "por guardar..." imediatamente
    // O utilizador sabe que h√° altera√ß√µes pendentes
    if (typeof updateAquariumStatus === 'function') {
        updateAquariumStatus('unsaved');
    }

    // 2. Limpa o temporizador anterior
    // (Isto √© o "Debounce": se escrever outra letra antes dos 2 min, o rel√≥gio volta ao zero)
    if (typeof aqAutoSaveTimer !== 'undefined') clearTimeout(aqAutoSaveTimer);

    // 3. Define novo temporizador para 2 MINUTOS (120.000 ms)
    aqAutoSaveTimer = setTimeout(() => {
        console.log("‚è∞ [AUTO-SAVE] 2 minutos de inatividade. A gravar...");
        if (typeof window.saveAquariumState === 'function') {
            window.saveAquariumState();
        }
    }, 120000); 
});

            // Listener para clicar no texto "por guardar..." para for√ßar grava√ß√£o
            const statusBtn = document.getElementById('aq-save-status');
            if (statusBtn) {
                statusBtn.addEventListener('click', () => {
                    if (statusBtn.textContent === 'por guardar...') {
                        window.saveAquariumState();
                    }
                });
            }

            // E. TECLADO (L√≥gica Sem√¢ntica de Enter)
            canvas.addEventListener('keydown', (e) => {
                const currentGhost = e.target.closest('.ghost-block');
                if (!currentGhost) return;

                // --- DETETOR DE ENTER ---
                if (e.key === 'Enter' && !e.shiftKey) {
                    
                    // 1. Verificar o tipo sem√¢ntico atual
                    // Se n√£o tiver atributo, assume 'p' (Par√°grafo Normal)
                    const type = currentGhost.dataset.semantic || 'p';

                    // --- COMPORTAMENTO A: MANTER NA MESMA CAIXA ---
                    // Aplica-se a: Par√°grafo (p) e Nota (note)
                    if (type === 'p' || type === 'note') {
                        // Previne a cria√ß√£o de div/bloco novo
                        e.preventDefault(); 
                        
                        // Insere uma quebra de linha manual (<br>)
                        document.execCommand('insertLineBreak');
                        return; // Fica aqui, n√£o cria novo fantasma
                    }

                    // --- COMPORTAMENTO B: CRIAR NOVA CAIXA EM BAIXO ---
                    // Aplica-se a: Subpar√°grafo (sub), H1 e H2
                    if (type === 'sub' || type === 'h1' || type === 'h2') {
                        e.preventDefault();
                        
                        const newGhost = document.createElement('div');
                        newGhost.className = 'ghost-block';
                        newGhost.setAttribute('contenteditable', 'true');
                        newGhost.dataset.placeholder = "";
                        
                        // Se o atual era um Subpar√°grafo, o pr√≥ximo tamb√©m ser√° por conveni√™ncia
                        if (type === 'sub') {
                            newGhost.setAttribute('data-semantic', 'sub');
                        }
                        // Se era H1 ou H2, o pr√≥ximo volta a ser Par√°grafo (padr√£o, sem atributo)

                        if (currentGhost.nextSibling) {
                            canvas.insertBefore(newGhost, currentGhost.nextSibling);
                        } else {
                            canvas.appendChild(newGhost);
                        }
                        
                        setTimeout(() => {
                            newGhost.focus();
                            window.setActiveGhost(newGhost);
                        }, 10);
                    }
                }
                
                // BACKSPACE: Apagar se vazio
                if (e.key === 'Backspace' && currentGhost.textContent === '') {
                    if (canvas.children.length > 1) {
                        e.preventDefault();
                        if (typeof sendToBlackHole === 'function') sendToBlackHole(currentGhost);
                        const prev = currentGhost.previousElementSibling;
                        currentGhost.remove();
                        
                        const tools = document.getElementById('aq-context-tools');
                        if(tools) tools.style.setProperty('display', 'none', 'important');

                        if (prev) {
                            prev.focus();
                            const range = document.createRange();
                            range.selectNodeContents(prev);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                            window.setActiveGhost(prev);
                        }
                    }
                }
                
                // SETAS
                if (e.key === 'ArrowUp') {
                    const prev = currentGhost.previousElementSibling;
                    if (prev) setTimeout(() => { prev.focus(); window.setActiveGhost(prev); }, 10);
                }
                if (e.key === 'ArrowDown') {
                    const next = currentGhost.nextElementSibling;
                    if (next) setTimeout(() => { next.focus(); window.setActiveGhost(next); }, 10);
                }
            });
        }
    }, 500);


// Fun√ß√£o para inserir um bloco novo entre A e B
window.insertBlockBelow = function(currentBlock) {
    console.log("üöÄ A criar novo bloco...");
    
    // 1. Criar
    const newGhost = document.createElement('div');
    newGhost.className = 'ghost-block';
    newGhost.id = 'ghost_' + Date.now();
    newGhost.setAttribute('contenteditable', 'true');
    newGhost.dataset.placeholder = "";
    
    // 2. Inserir
    currentBlock.insertAdjacentElement('afterend', newGhost);

    // 3. Adicionar bot√µes ao novo bloco
    ensureGhostActions(newGhost);

    // 4. Focar
    setTimeout(() => {
        newGhost.focus();
        // Ativa o novo bloco (isto vai mover o bot√£o + para o s√≠tio certo)
        if (typeof window.setActiveGhost === 'function') {
            window.setActiveGhost(newGhost);
        }
    }, 10);
    
    // 5. Gravar
    if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
};


// ============================================================
// L√ìGICA DA BARRA DE CONTEXTO DO FANTASMA (CORRE√á√ÉO DE TEMPO)
// ============================================================

setTimeout(() => {
    const contextToolbarElement = document.getElementById('aq-context-tools');

    if (contextToolbarElement) {
        console.log("üîß [INIT] Barra de ferramentas do Aqu√°rio encontrada e pronta.");

        // Clonamos para limpar ouvintes antigos e evitar duplicados
        const newContextToolbar = contextToolbarElement.cloneNode(true);
        contextToolbarElement.parentNode.replaceChild(newContextToolbar, contextToolbarElement);

        // --- FUN√á√ÉO NUCLEAR PARA FOR√áAR VISIBILIDADE ---
        const forceModalToTop = (modalId) => {
            console.log(`üöÄ [NUCLEAR] Tentando for√ßar o modal '${modalId}' para a frente...`);
            
            const modal = document.getElementById(modalId);
            if (modal) {
                // 1. Move para o fim do corpo (garante prioridade DOM)
                document.body.appendChild(modal); 
                
                // 2. Aplica estilos com prioridade m√°xima (!important) e SEM DELAY
                modal.style.cssText = `
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    z-index: 2147483647 !important; /* M√ÅXIMO ABSOLUTO DE 32-BIT */
                    background-color: rgba(0, 0, 0, 0.7) !important;
                    justify-content: center !important;
                    align-items: center !important;
                    pointer-events: auto !important;
                `;

                console.log(`‚úÖ [NUCLEAR] Estilos aplicados ao modal '${modalId}'. Z-Index: 2147483647`);

                // Corre√ß√£o extra para o modal de Cores que tem CSS diferente
                if (modalId === 'highlight-modal') {
                    const content = modal.querySelector('.modal-content');
                    if (content) content.style.display = 'block';
                }
            } else {
                console.error(`‚ùå [ERRO] Modal com ID '${modalId}' n√£o foi encontrado no DOM!`);
            }
        };

        // --- LISTENER DOS BOT√ïES ---
        newContextToolbar.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation(); 

            const btn = e.target.closest('button');
            if (!btn) return;
            
            const action = btn.dataset.ctx;
            const ghost = window.activeGhost;

            console.group("üîò [CLIQUE DETETADO] Bot√£o da Barra de Contexto");
            console.log("A√ß√£o:", action);
            console.log("Bloco Fantasma Ativo:", ghost);

            if (!ghost) {
                console.warn("‚ö†Ô∏è Nenhum bloco fantasma selecionado na vari√°vel window.activeGhost");
                alert("Selecione um bloco primeiro.");
                console.groupEnd();
                return;
            }
            
            // "Engana" as fun√ß√µes antigas adicionando a classe necess√°ria ao bloco simples
            ghost.classList.add('mini-note-wrapper'); 
            
            // Garante atributos obrigat√≥rios para as fun√ß√µes n√£o falharem
            if (!ghost.hasAttribute('data-topics')) ghost.setAttribute('data-topics', '{}');
            if (!ghost.hasAttribute('data-shared')) ghost.setAttribute('data-shared', 'false');
            if (!ghost.hasAttribute('data-box-links')) ghost.setAttribute('data-box-links', '{}');

            // --- 1. LINKS (‚ö°) ---
            if (action === 'links') {
                console.log("‚ö° Iniciando processo de abertura de Links...");
                
                if (typeof window.openBoxLinkManager === 'function') {
                    console.log("‚ñ∂Ô∏è Chamando window.openBoxLinkManager()...");
                    try {
                        window.openBoxLinkManager(ghost);
                        console.log("‚úÖ openBoxLinkManager executado com sucesso.");
                    } catch (err) {
                        console.error("‚ùå ERRO ao executar openBoxLinkManager:", err);
                    }

                    console.log("‚ñ∂Ô∏è Chamando forceModalToTop('link-modal')...");
                    forceModalToTop('link-modal'); // For√ßa imediata
                } else {
                    console.error("‚ùå ERRO CR√çTICO: A fun√ß√£o 'window.openBoxLinkManager' n√£o existe!");
                }
            }
            
            // --- 2. CLONAR (üß¨) ---
            else if (action === 'clone') {
                if (typeof window.openAppendModal === 'function') {
                    window.htmlToAppend = ghost.outerHTML;
                    window.openAppendModal();
                    forceModalToTop('append-to-note-modal');
                }
            }
            
            // --- 3. COR (üé®) ---
            else if (action === 'color') {
                if (typeof window.openHighlightPopup === 'function') {
                    window.activeWrapperForColor = ghost; 
                    window.openHighlightPopup(ghost);
                    forceModalToTop('highlight-modal');
                }
            }
            
            // --- 4. T√ìPICOS (üìã) ---
            else if (action === 'topics') {
                if (typeof window.openTopicsModalForMiniNote === 'function') {
                    window.openTopicsModalForMiniNote(ghost);
                    forceModalToTop('topics-modal');
                }
            }

            // --- 5. PARTILHA (üîê) ---
            else if (action === 'sharing') {
                // Configura o toggle antes de mostrar
                const isShared = ghost.getAttribute('data-shared') === 'true';
                const toggle = document.getElementById('mini-note-share-toggle');
                if(toggle) toggle.checked = isShared;
                
                window.activeWrapperForSharing = ghost;
                
                // Abre e for√ßa o topo
                const shareModal = document.getElementById('share-settings-popup');
                if (shareModal) {
                    // O popup de partilha √© posicionado, por isso usamos l√≥gica diferente
                    document.body.appendChild(shareModal);
                    const rect = btn.getBoundingClientRect();
                    shareModal.style.cssText = `
                        display: flex !important;
                        position: fixed !important;
                        top: ${rect.bottom + 10}px !important;
                        left: ${rect.left}px !important;
                        z-index: 2147483647 !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        background: var(--sidebar-color);
                        padding: 15px;
                        border: 1px solid var(--accent-color);
                        box-shadow: 0 10px 40px rgba(0,0,0,1);
                    `;
                }
            }
            
            // --- 6. SEM√ÇNTICA (‚òÑÔ∏é) ---
          else if (action === 'semantic-type') {
                const semPopup = document.getElementById('semantic-type-popup');
                
                if (semPopup) {
                    // 1. Move e Posiciona (Igual a antes)
                    document.body.appendChild(semPopup);
                    const rect = btn.getBoundingClientRect();
                    
          semPopup.style.cssText = `
                        display: flex !important;
                        flex-direction: column !important;
                        position: fixed !important;
                        top: ${rect.bottom + 10}px !important;
                        left: ${rect.left}px !important;
                        z-index: 2147483647 !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        
                        /* FUNDO S√ìLIDO OBRIGAT√ìRIO */
                        background-color: #252528 !important; 
                        
                        border: 1px solid var(--accent-color);
                        width: 150px;
                        padding: 5px;
                        border-radius: 6px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.9) !important;
                    `;

                    // 2. DETETAR O TIPO ATUAL
                    // Se n√£o tiver atributo, assume 'p' (Par√°grafo Normal)
                    const currentType = ghost.getAttribute('data-semantic') || 'p';

                    // 3. ATUALIZAR VISUAL DOS BOT√ïES
                    const buttons = semPopup.querySelectorAll('button');
                    buttons.forEach(b => {
                        // Remove a classe de todos primeiro
                        b.classList.remove('active');
                        
                        // Se o data-sem deste bot√£o for igual ao tipo atual, ativa-o
                        if (b.dataset.sem === currentType) {
                            b.classList.add('active');
                        }
                    });
                }
            }
            
            // --- 7. APAGAR (üóëÔ∏è) ---
  else if (action === 'delete') {
                
                // 1. GARANTIA DE ID (Crucial para o erro do Firebase)
                if (!ghost.id) ghost.id = 'ghost_' + Date.now();

                // 2. Inicia a chamada
                const confirmationPromise = showConfirmation(
                    "Mover para o Buraco Negro?", 
                    "Este bloco ser√° removido. Pode recuper√°-lo no Hist√≥rico."
                );

                const confirmModal = document.getElementById('confirm-modal');
                if (confirmModal) confirmModal.style.setProperty('z-index', '2147483647', 'important');

                const confirmed = await confirmationPromise;

                if (confirmed) {
                    // 3. PREPARAR PARA ARQUIVO (Sem transformar em Subnota)
                    // Adicionamos classe tempor√°ria s√≥ para a fun√ß√£o de arquivo saber o que fazer,
                    // mas definimos o tipo manualmente abaixo.
                    
                    // --- CORRE√á√ÉO: Fun√ß√£o de Arquivo Adaptada ---
                    // Como a fun√ß√£o archiveMiniNote √© gen√©rica, vamos injetar o tipo 'ghost'
                    // manipulando o elemento antes de enviar.
                    ghost.setAttribute('data-archive-type', 'ghost'); 
                    
                    if (typeof window.archiveMiniNote === 'function') {
                        // Passamos 'true' para saltar confirma√ß√£o interna (j√° fizemos aqui)
                        await window.archiveMiniNote(ghost, true);
                    }

                    // 4. Remover visualmente e limpar
                    ghost.remove();
                    const tools = document.getElementById('aq-context-tools');
                    if (tools) tools.style.setProperty('display', 'none', 'important');
                    window.activeGhost = null;

                    if (typeof window.saveAquariumState === 'function') {
                        await window.saveAquariumState();
                    }
                }
                
                if (confirmModal) confirmModal.style.zIndex = ''; 
            }


             // --- 9. LINK DE TEXTO (üîó) ---
            else if (action === 'text-link') {
                // 1. Verifica se h√° sele√ß√£o ou se estamos num link
                const selection = window.getSelection();
                let anchorNode = selection.anchorNode;
                // Garante que pegamos o elemento HTML
                if (anchorNode && anchorNode.nodeType === 3) anchorNode = anchorNode.parentNode;
                
                const existingLink = anchorNode.closest('a.silent-link');

                if (existingLink) {
                    // MODO EDI√á√ÉO: J√° estamos num link
                    window.manageAquariumTextLink(existingLink);
                } else if (!selection.isCollapsed && selection.toString().trim().length > 0) {
                    // MODO CRIA√á√ÉO: Temos texto selecionado
                    window.manageAquariumTextLink(null);
                } else {
                    alert("Selecione o texto que quer transformar em link.");
                }
            }
            

            console.groupEnd(); // Fecha o grupo de logs
        });
    } else {
        console.error("‚ùå ERRO FATAL: Barra #aq-context-tools n√£o encontrada no HTML.");
    }
}, 500);
        
     

// --- POPUP SEM√ÇNTICO (COM SEGURAN√áA) ---
const semPopup = document.getElementById('semantic-type-popup');
if (semPopup) {
    const newSemPopup = semPopup.cloneNode(true);
    semPopup.parentNode.replaceChild(newSemPopup, semPopup);

    newSemPopup.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !window.activeGhost) return;

        const type = btn.dataset.sem;
        
        // Aplica o tipo √† caixa ativa
        if (type === 'p') {
            // Par√°grafo √© o padr√£o (sem atributo)
            window.activeGhost.removeAttribute('data-semantic');
        } else {
            window.activeGhost.setAttribute('data-semantic', type);
        }

        console.log(`‚òÑÔ∏é Bloco definido como: ${type}`);
        
        // Esconde o popup
        newSemPopup.style.setProperty('display', 'none', 'important');
        
        // Grava o estado
        if (typeof saveAquariumState === 'function') saveAquariumState();
        
        // Refoca na caixa para o utilizador continuar a escrever
        window.activeGhost.focus();
    });
}

// Fecho de popups globais
document.addEventListener('click', (e) => {
    // 1. Popup Sem√¢ntico (‚òÑÔ∏é)
    const semPop = document.getElementById('semantic-type-popup');
    const semBtn = e.target.closest('button[data-ctx="semantic-type"]');
    
    // Se o popup estiver vis√≠vel E o clique N√ÉO for dentro dele E N√ÉO for no bot√£o que o abre
    if (semPop && semPop.style.display !== 'none' && !semPop.contains(e.target) && !semBtn) {
        semPop.style.setProperty('display', 'none', 'important');
    }
    
    // 2. Popup Salto (íÜú)
    const jumpPop = document.getElementById('aquarium-jump-popup');
    const jumpBtn = document.getElementById('aquarium-jump-btn');
    if (jumpPop && jumpPop.style.display !== 'none' && !jumpPop.contains(e.target) && e.target !== jumpBtn) {
        jumpPop.style.setProperty('display', 'none', 'important');
    }
    
    // 3. Popup de Partilha (üîê)
    const sharePop = document.getElementById('share-settings-popup');
    const shareBtn = e.target.closest('button[data-ctx="sharing"]');
    if (sharePop && sharePop.style.display !== 'none' && !sharePop.contains(e.target) && !shareBtn) {
        sharePop.style.setProperty('display', 'none', 'important');
    }
}, true); // Use 'true' (fase de captura) para garantir que apanha o clique antes de qualquer stopPropagation

// ============================================================
// CARREGAR LISTA DE AQU√ÅRIOS PARA SALTO R√ÅPIDO
// ============================================================
window.loadAquariumNotesList = async function(filterText = "") {
    const list = document.getElementById('aquarium-jump-list');
    if (!list) return;

    list.innerHTML = '<li style="padding:10px; color:#888;">A carregar aqu√°rios...</li>';

    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'pastas'),
            where('tipo', '==', 'aquario'),
            where('estado', '==', 'ativa'),
            where('userId', '==', auth.currentUser.uid),
            orderBy('nome')
        );

        const snapshot = await getDocs(q);
        list.innerHTML = '';

        if (snapshot.empty) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum outro aqu√°rio encontrado.</li>';
            return;
        }

        let count = 0;
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            // GARANTIA DE NOME: Se n√£o tiver nome, usa "Sem T√≠tulo"
            const nomeSeguro = data.nome || "Aqu√°rio Sem T√≠tulo"; 
            
            const item = { 
                id: docSnap.id, 
                nome: nomeSeguro, // For√ßa o uso do nome validado
                ...data 
            };
            
            if (item.id === selectedNoteId) return;

            if (filterText && !nomeSeguro.toLowerCase().includes(filterText.toLowerCase())) return;

            const li = document.createElement('li');
            li.style.cssText = "padding:10px; border-bottom:1px solid var(--border-color); cursor:pointer; display:flex; align-items:center; gap:8px;";
            li.innerHTML = `<span style="font-size:1.2em;">ü™∏</span> <span>${nomeSeguro}</span>`;
            
           li.onclick = async () => {
                // 1. Feedback visual
            li.style.backgroundColor = "var(--accent-color)";
    li.style.color = "white";
    li.textContent = "A trocar...";

    // 2. Grava o estado atual antes de sair (IMPORTANTE)
    if (typeof saveAquariumState === 'function') {
        await saveAquariumState();
    }

    // 3. Fecha o popup
    document.getElementById('aquarium-jump-popup').style.display = 'none';

    // 4. O reset ser√° chamado automaticamente dentro do openAquariumEnvironment
    await window.openAquariumEnvironment(item.id, item);
};

            list.appendChild(li);
            count++;
        });

        if (count === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888;">Nenhum resultado.</li>';
        }

    } catch (e) {
        console.error("Erro ao carregar aqu√°rios:", e);
        list.innerHTML = '<li style="padding:10px; color:red;">Erro de liga√ß√£o.</li>';
    }
};

// ============================================================
// L√ìGICA DA SIDEBAR MEDUSA (ü™º)
// ============================================================

// 1. Toggle Sidebar (Abrir/Fechar)
const aqSidebarBtn = document.getElementById('aquarium-sidebar-toggle');
if (aqSidebarBtn) {
    const newBtn = aqSidebarBtn.cloneNode(true);
    aqSidebarBtn.parentNode.replaceChild(newBtn, aqSidebarBtn);

    newBtn.addEventListener('click', () => {
        const env = document.getElementById('aquarium-environment');
        
        // Alterna o estado do painel
        env.classList.toggle('sidebar-open');
        newBtn.classList.toggle('active');

        // --- NOVO: Adiciona a classe para empurrar o texto ---
        env.classList.toggle('left-open'); 
        // ---------------------------------------------------
        
        if (env.classList.contains('sidebar-open')) {
            const activeTab = document.querySelector('.aq-tab.active');
            if (activeTab) loadAquariumTab(activeTab.dataset.tab);
        } else {
            // Limpezas de fecho...
            window.activeStoreGhostId = null;
            document.querySelectorAll('.ghost-block.active-store-target').forEach(g => {
                g.classList.remove('active-store-target');
                g.style.cssText = "";
            });
        }
    });
}

// 2. Gest√£o de Abas
document.querySelector('.aq-tabs-header').addEventListener('click', (e) => {
    const btn = e.target.closest('.aq-tab');
    if (!btn) return;

    // UI Update
    document.querySelectorAll('.aq-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.querySelectorAll('.aq-view').forEach(v => v.style.display = 'none');
    
    // Mostra conte√∫do e carrega
    const tabId = btn.dataset.tab;
    const view = document.getElementById(getAqViewId(tabId));
    if (view) {
        view.style.display = 'block';
        loadAquariumTab(tabId);
    }
});

function getAqViewId(tab) {
    const map = {
        'listas': 'aq-list-view',
        'indice': 'aq-index-view',
        'textos': 'aq-texts-view',
        'navega': 'aq-nav-view',
        'links': 'aq-links-view',
        'armazem': 'aq-store-view'
    };
    return map[tab];
}

// 3. Router de Carregamento
function loadAquariumTab(tab) {
    const canvas = document.getElementById('aquarium-content-canvas');
    
    // 1. Esconde rigorosamente todas as visualiza√ß√µes antes de mostrar a nova
    document.querySelectorAll('.aq-view').forEach(v => {
        v.style.display = 'none';
    });

    // 2. Localiza a vista alvo
    const viewId = getAqViewId(tab);
    const view = document.getElementById(viewId);
    
    if (view) {
        // O Armaz√©m precisa de flex-direction para o cabe√ßalho n√£o bugar
        if (tab === 'armazem') {
            view.style.display = 'flex';
            window.renderAquariumStore();
        } else {
            view.style.display = 'block';
            
            // Chama o renderizador correspondente
            if (tab === 'listas') renderAquariumLists();
            else if (tab === 'indice') renderAquariumIndex(canvas);
            else if (tab === 'textos') renderAquariumTexts();
            else if (tab === 'navega') renderAquariumNav(canvas);
            else if (tab === 'links') renderAquariumLinks(canvas);
        }
    }
}

// Ponto de entrada (Chamado quando clica na aba)
function renderAquariumLists() {
    // Se a stack estiver vazia, carrega a raiz
    if (aqListStack.length === 0) {
        renderAqListRoot();
    } else {
        // Se j√° tiver navega√ß√£o, re-renderiza o √∫ltimo n√≠vel (√∫til ao reabrir a sidebar)
        const current = aqListStack[aqListStack.length - 1];
        if (current.type === 'category') renderAqSubList(current.id, current.name);
        else if (current.type === 'bible-book') renderAqBibleChapters(current.data);
        else if (current.type === 'bible-chapter') renderAqBibleVerses(current.data);
    }
}

// N√çVEL 1: RA√çZ (Categorias)
function renderAqListRoot() {
    const list = document.getElementById('aq-list-view');
    if (!list) return;

    list.innerHTML = '';
    aqListStack = []; // Reset stack

    const categories = [
        { id: 'topico', icon: 'üìë', name: 'T√≥picos' },
        { id: 'destaque', icon: 'üé®', name: 'Destaques' },
        { separator: true },
        { id: 'biblia-root', icon: 'üìñ', name: 'B√≠blia' },
        { id: 'textobiblico', icon: 'üìú', name: 'Textos B√≠blicos' },
        { id: 'marcadores', icon: 'üîñ', name: 'Marcadores' },
        { separator: true },
        { id: 'personagem', icon: 'üë§', name: 'Personagens' },
        { id: 'local', icon: 'üìç', name: 'Locais' },
        { id: 'data', icon: 'üìÖ', name: 'Datas' },
        { id: 'cosmos', icon: 'ü™ê', name: 'Cosmos' },
        { id: 'tag', icon: 'üè∑Ô∏è', name: 'Tags' }
    ];

    categories.forEach(cat => {
        if (cat.separator) {
            const hr = document.createElement('hr');
            hr.style.cssText = "border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 5px 0;";
            list.appendChild(hr);
        } else {
            const li = document.createElement('li');
            li.innerHTML = `${cat.icon} ${cat.name}`;
            
            // Atribui√ß√£o direta do evento de clique (Mais seguro)
            li.onclick = (e) => {
                e.stopPropagation(); // Evita conflitos
                console.log(`üß≠ Navegando para: ${cat.name}`);
                
                if (cat.id === 'biblia-root') {
                    if (typeof renderAqBibleBooks === 'function') renderAqBibleBooks();
                    else console.error("Fun√ß√£o renderAqBibleBooks n√£o encontrada!");
                } 
                else if (cat.id === 'destaque') {
                     // Destaques n√£o t√™m sublista, abrem modal de cores ou lista direta de cores?
                     // Assumindo lista de cores:
                     renderAqColorList(); // Vamos criar esta pequena fun√ß√£o abaixo
                }
                else {
                    if (typeof renderAqSubList === 'function') renderAqSubList(cat.id, cat.name);
                    else console.error("Fun√ß√£o renderAqSubList n√£o encontrada!");
                }
            };
            list.appendChild(li);
        }
    });
}

// N√çVEL 2: DESTAQUES (Lista de Cores)
function renderAqColorList() {
    const list = document.getElementById('aq-list-view');
    aqListStack.push({ type: 'category', id: 'destaque', name: 'Destaques' });

    list.innerHTML = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">Destaques (Cores)</span>
        </div>
        <ul id="aq-colors-content"></ul>
    `;
    
    const ul = document.getElementById('aq-colors-content');
    
    // Usa a constante global DEFAULT_HIGHLIGHTS que j√° existe no seu c√≥digo
    if (typeof DEFAULT_HIGHLIGHTS !== 'undefined') {
        DEFAULT_HIGHLIGHTS.forEach(color => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span style="display:inline-block; width:12px; height:12px; background:${color.code}; border-radius:50%; margin-right:8px; border:1px solid #555;"></span>
                ${color.name}
            `;
            li.onclick = () => {
                showHighlightReferencesPanel(color.code, color.name);
            };
            ul.appendChild(li);
        });
    } else {
        ul.innerHTML = '<li style="color:red">Erro: Cores n√£o definidas.</li>';
    }
}

// N√çVEL 2: SUBLISTA (Entidades: T√≥picos, Personagens, etc.)
async function renderAqSubList(type, name) {
    const list = document.getElementById('aq-list-view');
    
    // Atualiza Stack
    if (aqListStack.length === 0 || aqListStack[aqListStack.length - 1].id !== type) {
        aqListStack.push({ type: 'category', id: type, name: name });
    }

    // Header com Voltar
    list.innerHTML = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${name}</span>
        </div>
        <div id="aq-sublist-content"><div class="spinner-container"><div class="spinner"></div></div></div>
    `;

    const contentDiv = document.getElementById('aq-sublist-content');
    const myUid = auth.currentUser.uid;
    let items = [];

    try {
        // --- CASO ESPECIAL: T√ìPICOS (T√™m Subt√≥picos) ---
        if (type === 'topico') {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'topicos'), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, hasChildren: true });
            });
        }
        
        // --- CASO ESPECIAL: COSMOS (T√™m Subtemas) ---
        else if (type === 'cosmos') {
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'cosmos'), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, hasChildren: true, emoji: d.emoji });
            });
        }

        // --- CASO ESPECIAL: TAGS (Extra√≠das das Notas) ---
        else if (type === 'tag') {
            const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, 'pastas'), where('tipo', '==', 'nota'), where('userId', '==', myUid));
            const snap = await getDocs(q);
            const tagSet = new Set();
            snap.forEach(doc => { if(doc.data().tags) doc.data().tags.forEach(t => tagSet.add(t)); });
            items = Array.from(tagSet).sort().map(t => ({ id: t, nome: t, isFinal: true }));
        } 
        
        // --- OUTROS (Personagens, Locais, Datas, Marcadores) ---
        // Estes s√£o finais, abrem logo a 4¬™ coluna
        else {
            const collectionName = getCollectionFromType(type);
            if (!collectionName) { contentDiv.innerHTML = '<p style="padding:10px;">Erro de tipo.</p>'; return; }
            
            const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const q = query(collection(db, collectionName), where('userId', '==', myUid), orderBy('nome'));
            const snap = await getDocs(q);
            
            snap.forEach(doc => {
                const d = doc.data();
                if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, isFinal: true });
            });
        }

        // RENDERIZA√á√ÉO
        contentDiv.innerHTML = '';
        if (items.length === 0) {
            contentDiv.innerHTML = '<p style="padding:20px; color:#888; text-align:center;">Vazio.</p>';
            return;
        }

        const ul = document.createElement('ul');
        items.forEach(item => {
            const li = document.createElement('li');
            const icon = item.emoji || (item.hasChildren ? "üìÇ" : "üîπ");
            li.textContent = `${icon} ${item.nome}`;
            
            li.onclick = () => {
                // SE TIVER FILHOS (T√≥picos/Cosmos), NAVEGA PARA DENTRO (N√≠vel 3)
                if (item.hasChildren) {
                    renderAqDeepLevel(type, item.id, item.nome);
                } 
                // SE FOR FINAL (Tags/Personagens), ABRE A 4¬™ COLUNA
                else {
                    showReferencesPanel(item.id, item.nome, type);
                }
            };
            ul.appendChild(li);
        });
        contentDiv.appendChild(ul);

    } catch (e) {
        console.error(e);
        contentDiv.innerHTML = '<p style="padding:10px; color:red;">Erro ao carregar.</p>';
    }
}

// N√çVEL 3: PROFUNDIDADE (Subt√≥picos e Sub-Cosmos)
async function renderAqDeepLevel(parentType, parentId, parentName) {
    const list = document.getElementById('aq-list-view');
    
    // Atualiza Stack
    aqListStack.push({ type: 'deep', id: parentId, name: parentName, parentType: parentType });

    list.innerHTML = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${parentName}</span>
        </div>
        <div id="aq-deep-content"><div class="spinner-container"><div class="spinner"></div></div></div>
    `;

    const contentDiv = document.getElementById('aq-deep-content');
    const myUid = auth.currentUser.uid;
    let items = [];

    try {
        const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        let targetCollection = '';
        let foreignKey = '';
        let finalType = ''; // O tipo que ser√° enviado para a 4¬™ coluna

        if (parentType === 'topico') {
            targetCollection = 'subtopicos';
            foreignKey = 'topicId';
            finalType = 'subtopico'; // Usa este tipo para a 4¬™ coluna saber o que procurar
        } else if (parentType === 'cosmos') {
            targetCollection = 'subcosmos';
            foreignKey = 'cosmosId';
            finalType = 'subcosmos';
        }

        const q = query(collection(db, targetCollection), where(foreignKey, '==', parentId), where('userId', '==', myUid), orderBy('nome'));
        const snap = await getDocs(q);

        snap.forEach(doc => {
            const d = doc.data();
            if (d.estado !== 'desativa') items.push({ id: doc.id, nome: d.nome, emoji: d.emoji });
        });

        // RENDERIZA√á√ÉO
        contentDiv.innerHTML = '';
        if (items.length === 0) {
            contentDiv.innerHTML = '<p style="padding:20px; color:#888; text-align:center;">Vazio.</p>';
            return;
        }

        const ul = document.createElement('ul');
        items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.emoji || 'üîπ'} ${item.nome}`;
            
            li.onclick = () => {
                // AGORA SIM, ABRE A 4¬™ COLUNA
                // Passamos o ID do subt√≥pico/subtema e o tipo correto
                showReferencesPanel(item.id, item.nome, finalType);
            };
            ul.appendChild(li);
        });
        contentDiv.appendChild(ul);

    } catch (e) {
        console.error(e);
        contentDiv.innerHTML = '<p style="padding:10px; color:red;">Erro ao carregar.</p>';
    }
}

// B√çBLIA: NIVEL 2 - LIVROS
function renderAqBibleBooks() {
    const list = document.getElementById('aq-list-view');
    aqListStack.push({ type: 'bible-root', name: 'B√≠blia' });

    let html = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">Livros da B√≠blia</span>
        </div>
        <ul>`;

    BIBLE_DATA.forEach(book => {
        // Criamos um elemento tempor√°rio para ligar o onclick via JS (evita strings complexas)
        // Mas para simplificar a string HTML:
        html += `<li onclick="renderAqBibleChapters('${book.nome}', ${book.caps})">${book.nome}</li>`;
    });
    
    html += `</ul>`;
    list.innerHTML = html;
}

// B√çBLIA: NIVEL 3 - CAP√çTULOS
window.renderAqBibleChapters = function(bookName, totalCaps) {
    const list = document.getElementById('aq-list-view');
    aqListStack.push({ type: 'bible-book', name: bookName, data: {name: bookName, caps: totalCaps} });

    let html = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${bookName}</span>
        </div>
        <div class="aq-grid-container">`;

    for (let i = 1; i <= totalCaps; i++) {
        html += `<div class="aq-grid-btn" onclick="renderAqBibleVerses('${bookName}', ${i})">${i}</div>`;
    }

    html += `</div>`;
    list.innerHTML = html;
};

// B√çBLIA: NIVEL 4 - VERS√çCULOS
window.renderAqBibleVerses = function(bookName, chapter) {
    const list = document.getElementById('aq-list-view');
    
    // Obter total de versiculos
    const bookData = BIBLE_DATA.find(b => b.nome === bookName);
    const totalV = bookData ? (bookData.versiculos[chapter - 1] || 50) : 50;

    aqListStack.push({ type: 'bible-chapter', name: `${bookName} ${chapter}`, data: {book: bookName, cap: chapter} });

    let html = `
        <div class="aq-nav-header">
            <button class="aq-nav-back-btn" onclick="aqNavBack()">‚¨Ö</button>
            <span class="aq-nav-title">${bookName} ${chapter}</span>
        </div>
        <div class="aq-grid-container"></div>`; // Container vazio para encher via JS

    list.innerHTML = html;
    const grid = list.querySelector('.aq-grid-container');

    for (let i = 1; i <= totalV; i++) {
        const fullName = `${bookName} ${chapter}:${i}`;
        
        const btn = document.createElement('div');
        btn.className = 'aq-grid-btn';
        btn.textContent = i;
        
        // --- AQUI EST√Å A LIGA√á√ÉO CR√çTICA ---
        btn.onclick = () => {
            console.log(`üìñ Abrindo vers√≠culo: ${fullName}`);
            
            // Chama a fun√ß√£o global que abre a 4¬™ Coluna
            if (typeof showReferencesPanel === 'function') {
                // Passamos null no ID porque vers√≠culos usam o nome como chave
                showReferencesPanel(null, fullName, 'textobiblico');
            } else {
                console.error("Fun√ß√£o showReferencesPanel n√£o encontrada!");
            }
        };

        grid.appendChild(btn);
    }
};

// FUN√á√ÉO DE VOLTAR
window.aqNavBack = function() {
    if (aqListStack.length > 0) {
        aqListStack.pop(); // Remove o n√≠vel atual
        
        if (aqListStack.length === 0) {
            renderAqListRoot();
        } else {
            // Renderiza o n√≠vel anterior
            const prev = aqListStack[aqListStack.length - 1];
            
            // Removemos temporariamente o item atual para o render n√£o o duplicar na stack
            aqListStack.pop(); 
            
            if (prev.type === 'category') renderAqSubList(prev.id, prev.name);
            else if (prev.type === 'deep') renderAqDeepLevel(prev.parentType, prev.id, prev.name);
            else if (prev.type === 'bible-root') renderAqBibleBooks();
            else if (prev.type === 'bible-book') renderAqBibleChapters(prev.data.name, prev.data.caps);
        }
    } else {
        renderAqListRoot();
    }
};

// --- ABA: √çNDICE (Cards dos Blocos Fantasma) ---
function renderAquariumIndex(canvas) {
    const container = document.getElementById('aq-index-view');
    container.innerHTML = '';
    
    const blocks = canvas.querySelectorAll('.ghost-block');
    let count = 0;

    blocks.forEach((block, index) => {
        // --- CORRE√á√ÉO: Limpeza dos Bot√µes ---
        // 1. Clona o bloco para n√£o afetar o original no ecr√£
        const clone = block.cloneNode(true);
        
        // 2. Remove a div dos bot√µes de a√ß√£o (onde est√£o o üêö e o ‚á±)
        const actionsDiv = clone.querySelector('.ghost-actions');
        if (actionsDiv) actionsDiv.remove();

        // 3. Remove o bot√£o de adicionar entre linhas (o + pequeno) se existir
        const addBtn = clone.querySelector('.ghost-add-between-btn');
        if (addBtn) addBtn.remove();

        // 4. L√™ o texto limpo
        const text = clone.innerText.trim();
        // -------------------------------------

        if (!text) return;

        // Tenta obter t√≠tulo: ou atributo sem√¢ntico ou primeira frase
        let title = "Bloco de Texto";
        let semantic = block.getAttribute('data-semantic');
        
        if (semantic) {
            title = semantic.toUpperCase();
        } else {
            // Pega a primeira frase at√© ponto ou quebra de linha
            const split = text.split(/[\.\n]/);
            title = split[0].substring(0, 30) + (split[0].length > 30 ? "..." : "");
        }

        const card = document.createElement('div');
        card.className = 'aq-index-card';
        card.innerHTML = `
            <span class="aq-card-title">${count + 1}. ${title}</span>
            <div class="aq-card-preview">${text.substring(0, 80)}...</div>
        `;

        card.onclick = () => {
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight tempor√°rio
            block.style.transition = "background 0.5s";
            block.style.background = "rgba(74, 144, 226, 0.2)";
            setTimeout(() => block.style.background = "transparent", 1000);
        };

        container.appendChild(card);
        count++;
    });

    if (count === 0) container.innerHTML = '<p style="padding:20px; color:#888; text-align:center;">Aqu√°rio vazio.</p>';
}

// --- ABA: TEXTOS (Motor B√≠blico Adaptado) ---
async function renderAquariumTexts() {
    const container = document.getElementById('aq-texts-view');
    const canvas = document.getElementById('aquarium-content-canvas'); 
    
    if (!container || !canvas) return;

    // Spinner
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar textos...</span></div>';

    // 1. Extrair texto todo do Aqu√°rio
    // O innerText apanha o conte√∫do vis√≠vel e o conte√∫do dos blocos bloqueados (popups)
    let fullText = canvas.innerText;
    
    // Varre inputs de t√≠tulos dentro do Aqu√°rio para apanhar refer√™ncias l√° tamb√©m
    canvas.querySelectorAll('input, textarea').forEach(el => {
        if (el.value) fullText += " " + el.value;
    });
    
    // 2. Regex B√≠blica
    const sortedBooks = (typeof BIBLICAL_BOOKS !== 'undefined') ? [...BIBLICAL_BOOKS].sort((a, b) => b.length - a.length) : [];
    
    if(sortedBooks.length === 0) {
         container.innerHTML = '<p style="padding:20px; color:red;">Erro: Dados b√≠blicos n√£o carregados.</p>';
         return;
    }

    // Regex para "Livro Cap:Vers" (ex: Jo√£o 3:16, Jo√£o 3:16-18)
    const regex = new RegExp(`\\b((?:${sortedBooks.join('|')})\\s+\\d+:\\d+(?:\\s*[-‚Äì,;]\\s*\\d+)*)`, 'gi');
    
    // Encontra e remove duplicados
    const matches = [...new Set(fullText.match(regex) || [])];

    container.innerHTML = '';
    
    if (matches.length === 0) {
        container.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; color:#888; text-align:center;">
                <span style="font-size:30px; margin-bottom:10px;">üìñ</span>
                <p>Nenhum texto detetado.</p>
                <small style="opacity:0.5;">Escreva ex: "Jo√£o 3:16"</small>
            </div>`;
        return;
    }

    // 3. Renderiza cada texto encontrado
    for (const ref of matches) {
        const div = document.createElement('div');
        div.style.cssText = "padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); text-align: left;";
        
        // T√≠tulo clic√°vel
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = "font-weight:bold; color:var(--accent-color); cursor:pointer; margin-bottom:6px; display:flex; justify-content:space-between;";
        titleDiv.innerHTML = `<span>üìú ${ref}</span> <span style="opacity:0.5; font-size:0.8em;">‚ûî</span>`;
        
        // A√ß√£o: Abrir na 4¬™ Coluna ao clicar
        titleDiv.onclick = () => {
            // Expande refer√™ncias complexas (ex: 1-3) para abrir o primeiro vers√≠culo
            const firstVerse = ref.split(/[-‚Äì,]/)[0].trim(); 
            if (typeof showReferencesPanel === 'function') {
                showReferencesPanel(null, firstVerse, 'textobiblico');
            }
        };

        const contentDiv = document.createElement('div');
        contentDiv.className = 'aq-verse-text';
        contentDiv.style.cssText = "font-size:0.9em; line-height:1.5; color:#ccc; opacity:0.8;";
        contentDiv.innerHTML = '<em>A carregar...</em>';

        div.appendChild(titleDiv);
        div.appendChild(contentDiv);
        container.appendChild(div);

        // 4. Buscar Texto (Async)
        if (typeof expandVerseReference === 'function' && typeof fetchPublicBibleText === 'function') {
            const expanded = expandVerseReference(ref);
            const promises = expanded.map(v => fetchPublicBibleText(v));
            
            // Carrega em paralelo
            Promise.all(promises).then(texts => {
                const finalText = texts.filter(t => t).join(" ");
                contentDiv.textContent = finalText || "Texto n√£o dispon√≠vel na biblioteca.";
            });
        } else {
            contentDiv.textContent = "Fun√ß√µes de biblioteca indispon√≠veis.";
        }
    }
}

// --- ABA: NAVEGA (Entidades / David) ---
function renderAquariumNav(canvas) {
    const container = document.getElementById('aq-nav-view');
    // Se o canvas n√£o for passado, tenta apanhar do DOM
    const targetCanvas = canvas || document.getElementById('aquarium-content-canvas');
    
    if (!container || !targetCanvas) return;

    // 1. Limpeza
    container.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A analisar entidades...</span></div>';

    // 2. PREPARA√á√ÉO DO TEXTO
    // Junta texto do corpo + inputs para garantir que apanha tudo
    let textContent = targetCanvas.innerText;
    targetCanvas.querySelectorAll('input, textarea').forEach(el => {
        if (el.value) textContent += " " + el.value;
    });
    const textContentLower = textContent.toLowerCase();

    // 3. Juntar todas as entidades conhecidas
    if (typeof allEntities === 'undefined') {
         container.innerHTML = '<p style="padding:20px; color:#888;">Cache de entidades vazio.</p>';
         return;
    }

    const allCandidates = Object.values(allEntities).flat();
    
    // Array para guardar resultados
    const foundItems = [];
    // Set para evitar duplicados (ex: se "David" aparecer 3 vezes, mostra s√≥ uma)
    const seenNames = new Set();

    // 4. LOOP DE VERIFICA√á√ÉO
    allCandidates.forEach(entity => {
        // Verifica se o nome da entidade est√° escrito no texto
        if (textContentLower.includes(entity.nome.toLowerCase())) {
            
            // Evita duplicados na lista visual
            if (!seenNames.has(entity.nome)) {
                foundItems.push(entity);
                seenNames.add(entity.nome);
            }
        }
    });

    container.innerHTML = '';

    if (foundItems.length === 0) {
        container.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; color:#888; text-align:center;">
                <span style="font-size:30px; margin-bottom:10px;">‚öì</span>
                <p>Nenhuma entidade encontrada.</p>
                <small style="opacity:0.5;">Escreva ex: "David", "Jerusal√©m"</small>
            </div>`;
        return;
    }

    // 5. RENDERIZAR ITENS ENCONTRADOS
    // Ordena alfabeticamente para ficar organizado
    foundItems.sort((a, b) => a.nome.localeCompare(b.nome));

    foundItems.forEach(entity => {
        const div = document.createElement('div');
        div.style.cssText = "padding:12px 15px; border-bottom:1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 4px; transition: background 0.2s;";
        
        // --- √çCONE ---
        let icon = entity.emoji || "üîπ"; 
        if (!entity.emoji) {
            if (entity.tipo === 'personagem') icon = "üë§";
            else if (entity.tipo === 'local') icon = "üìç";
            else if (entity.tipo === 'cosmos') icon = "ü™ê";
            else if (entity.tipo === 'subcosmos') icon = "üß¨";
        }

        // --- T√çTULO ---
        const titleHtml = `<strong style="color:var(--text-color); cursor:pointer; font-size:0.95em;">${icon} ${entity.nome}</strong>`;
        
        // --- DESCRI√á√ÉO ---
        const descText = entity.descricao || 'Sem descri√ß√£o (Clique para ver detalhes).';
        const descHtml = `<div style="font-size:0.85em; color:#888; cursor:pointer; line-height:1.4;">${descText}</div>`;

        div.innerHTML = titleHtml + descHtml;

        // --- INTERA√á√ïES ---
        div.onmouseover = () => { div.style.backgroundColor = "rgba(255,255,255,0.05)"; };
        div.onmouseout = () => { div.style.backgroundColor = "transparent"; };

        // Clique no Card Inteiro: Abre a 4¬™ Coluna (Refer√™ncias)
        div.onclick = (e) => {
            e.stopPropagation();
            if (typeof showReferencesPanel === 'function') {
                showReferencesPanel(entity.id, entity.nome, entity.tipo);
            }
        };

        container.appendChild(div);
    });
}



// --- ABA: LINKS (Fontes das caixas) ---
window.currentLinkSubTab = 'boxes'; // 'boxes' (‚ö°) ou 'text' (üìé)

window.renderAquariumLinks = async function(canvas) {
    const list = document.getElementById('aq-links-view');
    // Se o canvas n√£o for passado, tenta apanhar
    const targetCanvas = canvas || document.getElementById('aquarium-content-canvas');
    
    if (!list) return;

    // 1. RENDERIZAR CABE√áALHO DAS SUB-ABAS
    list.innerHTML = `
        <div style="display:flex; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px; background:rgba(0,0,0,0.2);">
            <button onclick="window.switchLinkSubTab('boxes')" 
                    style="flex:1; padding:10px; background:none; border:none; border-bottom:2px solid ${window.currentLinkSubTab === 'boxes' ? 'var(--accent-color)' : 'transparent'}; color:${window.currentLinkSubTab === 'boxes' ? 'white' : '#888'}; cursor:pointer; font-size:1.2em;">
                ‚ö° Caixas
            </button>
            <button onclick="window.switchLinkSubTab('text')" 
                    style="flex:1; padding:10px; background:none; border:none; border-bottom:2px solid ${window.currentLinkSubTab === 'text' ? 'var(--accent-color)' : 'transparent'}; color:${window.currentLinkSubTab === 'text' ? 'white' : '#888'}; cursor:pointer; font-size:1.2em;">
                üìé Texto
            </button>
        </div>
        <div id="aq-links-content" style="padding:0 10px;">
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    `;

    const contentDiv = document.getElementById('aq-links-content');

    // ============================================================
    // ABA 1: CAIXAS (‚ö°) - L√≥gica Original
    // ============================================================
    if (window.currentLinkSubTab === 'boxes') {
        contentDiv.innerHTML = '';
        let hasSources = false;
        
        if (targetCanvas) {
            const boxes = targetCanvas.querySelectorAll('[data-box-links]');
            boxes.forEach(el => {
                const jsonStr = el.getAttribute('data-box-links');
                if (!jsonStr || jsonStr === '{}') return;

                try {
                    const data = JSON.parse(jsonStr);
                    const hasUrls = data.urls && Object.keys(data.urls).length > 0;
                    const hasCodex = data.codex && data.codex.length > 0;
                    const hasCategories = data.categories && data.categories.length > 0;

                    if (!hasUrls && !hasCodex && !hasCategories) return;
                    hasSources = true;

                    // Determina T√≠tulo
                    let boxTitle = data.title;
                    if (!boxTitle) {
                        const input = el.querySelector('.mini-note-title-input, .redator-input, .card-title-input, .sign-title-input');
                        if (input) boxTitle = input.value;
                        else boxTitle = "Caixa Sem T√≠tulo";
                    }

                    // Renderiza Grupo
                    let itemsHTML = '';
                    
                    if (hasUrls) {
                        Object.values(data.urls).forEach(url => {
                            let linkName = url;
                            try { linkName = new URL(url).hostname.replace('www.',''); } catch(e){}
                            itemsHTML += `<div onclick="window.open('${url}', '_blank')" style="cursor:pointer; color:var(--text-color); font-size:0.9em; padding:4px 0; display:flex; gap:6px;"><span>üîó</span> <span style="text-decoration:underline; color:var(--accent-color);">${linkName}</span></div>`;
                        });
                    }
                    if (hasCodex) {
                        data.codex.forEach(c => {
                             // --- AQUI APLICA A TUA CORRE√á√ÉO "de" SE AINDA N√ÉO ESTIVER FEITA ---
                             // (Assume-se que o codiceshow j√° vem correto da grava√ß√£o)
                             itemsHTML += `<div style="font-size:0.9em; padding:4px 0; color:#e67e22;"><span>üìö</span> ${c.codiceshow || c.serie}</div>`;
                        });
                    }
                    if (hasCategories) {
                        data.categories.forEach(c => {
                             itemsHTML += `<div style="font-size:0.9em; padding:4px 0; color:var(--text-color);"><span>üîπ</span> ${c.name}</div>`;
                        });
                    }

                    const li = document.createElement('div');
                    li.style.cssText = "margin-bottom:15px; border:1px solid rgba(255,255,255,0.05); border-radius:6px; overflow:hidden;";
                    li.innerHTML = `
                        <div style="padding:8px 10px; background:rgba(255,255,255,0.05); font-weight:bold; color:#ccc; font-size:0.9em; cursor:pointer;"
                             onclick="document.getElementById('${el.id}').scrollIntoView({behavior:'smooth', block:'center'});">
                            ${boxTitle}
                        </div>
                        <div style="padding:10px;">${itemsHTML}</div>
                    `;
                    contentDiv.appendChild(li);

                } catch (e) {}
            });
        }

        if (!hasSources) contentDiv.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Sem links em caixas.</p>';
    }

    // ============================================================
    // ABA 2: LINKS DE TEXTO (üìé) - Com Persist√™ncia
    // ============================================================
// ============================================================
    // ABA 2: LINKS DE TEXTO (üìé) - ORDENADOS POR POSI√á√ÉO NO TEXTO
    // ============================================================
    else if (window.currentLinkSubTab === 'text') {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        try {
            // 1. Ler Registo do Firebase
            const docRef = doc(db, 'pastas', selectedNoteId);
            const docSnap = await getDoc(docRef);
            const registry = docSnap.exists() ? (docSnap.data().textLinksRegistry || {}) : {};

            contentDiv.innerHTML = '';
            
            // Converter objeto em array
            let linkItems = Object.keys(registry).map(uid => ({ 
                uid, 
                ...registry[uid] 
            }));

            if (linkItems.length === 0) {
                contentDiv.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Sem links de texto.</p>';
                return;
            }

            // 2. ORDENAR PELA POSI√á√ÉO NO TEXTO (A M√ÅGICA EST√Å AQUI)
            // Para cada link, tentamos encontrar o elemento correspondente no DOM.
            // Se encontrar, calculamos a sua posi√ß√£o relativa.
            
            // Cria um mapa de posi√ß√µes
            const positions = new Map();
            
            if (targetCanvas) {
                // Encontra todos os links no texto DE UMA S√ì VEZ e na ordem correta
                const linksInDom = Array.from(targetCanvas.querySelectorAll('a.silent-link'));
                
                linksInDom.forEach((el, index) => {
                    const uid = el.dataset.uid;
                    if (uid) {
                        // O √≠ndice no array do querySelectorAll reflete a ordem no documento
                        positions.set(uid, index);
                    }
                });
            }

            linkItems.sort((a, b) => {
                const posA = positions.has(a.uid) ? positions.get(a.uid) : 999999; // √ìrf√£os v√£o para o fim
                const posB = positions.has(b.uid) ? positions.get(b.uid) : 999999;
                
                // Se ambos existem no texto, ordena pela posi√ß√£o
                if (posA !== posB) return posA - posB;
                
                // Se ambos s√£o √≥rf√£os (ou t√™m a mesma posi√ß√£o por erro), ordena por data (mais recente primeiro)
                return (b.timestamp || 0) - (a.timestamp || 0);
            });


            // 3. RENDERIZAR LISTA (Mant√©m-se igual)
            linkItems.forEach(data => {
                // Verificar se ainda existe no DOM (para pintar de vermelho)
                const isOrphan = !positions.has(data.uid);

                const card = document.createElement('div');
                card.style.cssText = `
                    margin-bottom: 15px; 
                    border-left: 3px solid ${isOrphan ? '#e74c3c' : 'var(--accent-color)'}; 
                    background: rgba(255,255,255,0.02);
                    padding: 10px;
                    border-radius: 0 6px 6px 0;
                `;

                // T√≠tulo + Bot√£o Editar
                const headerHtml = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong style="color:${isOrphan ? '#e74c3c' : 'var(--text-color)'}; font-size:1em;">
                            ${isOrphan ? '‚ö†Ô∏è ' : ''}${data.title}
                        </strong>
                        <button onclick='window.manageAquariumTextLink(null, ${JSON.stringify(data).replace(/'/g, "&apos;")})' 
                                title="Editar Lista de Links"
                                style="background:none; border:1px solid var(--border-color); color:var(--text-muted-color); border-radius:4px; cursor:pointer; padding:2px 6px;">
                            ‚úèÔ∏è
                        </button>
                    </div>
                `;

                // Lista Numerada de Links
                let linksHtml = '';
                if (data.urls && data.urls.length > 0) {
                    data.urls.forEach((url, idx) => {
                        let displayUrl = url;
                        try { displayUrl = new URL(url).hostname; } catch(e){}
                        
                        linksHtml += `
                            <div style="display:flex; gap:8px; margin-top:4px; font-size:0.9em;">
                                <span style="color:var(--text-muted-color); font-weight:bold;">${idx + 1}.</span>
                                <a href="${url}" target="_blank" style="color:var(--accent-color); text-decoration:none; word-break:break-all;">
                                    ${displayUrl}
                                </a>
                            </div>
                        `;
                    });
                } else {
                    linksHtml = '<small style="color:#666;">Sem URLs</small>';
                }

                card.innerHTML = headerHtml + linksHtml;
                
                // --- NOVO: Clique no t√≠tulo faz scroll para o texto ---
                if (!isOrphan) {
                    const titleEl = card.querySelector('strong');
                    titleEl.style.cursor = 'pointer';
                    titleEl.onclick = () => {
                        const targetEl = targetCanvas.querySelector(`a[data-uid="${data.uid}"]`);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Flash visual
                            targetEl.style.backgroundColor = "rgba(241, 196, 15, 0.5)";
                            setTimeout(() => targetEl.style.backgroundColor = "", 1000);
                        }
                    };
                }
                
                contentDiv.appendChild(card);
            });

        } catch (e) {
            console.error("Erro ao carregar links de texto:", e);
            contentDiv.innerHTML = '<p style="color:red;">Erro ao ler base de dados.</p>';
        }
    }
};

// Helper para trocar aba
window.switchLinkSubTab = function(tab) {
    window.currentLinkSubTab = tab;
    // O render chama a fun√ß√£o principal que j√° decide o que mostrar
    window.renderAquariumLinks(); 
};



if (aqCanvasListener) {
    aqCanvasListener.addEventListener('input', () => {
        
        // 1. Verifica qual a aba ativa
        const activeTabBtn = document.querySelector('.aq-tab.active');
        const tabType = activeTabBtn ? activeTabBtn.dataset.tab : null;
        
        // 2. Verifica se a sidebar est√° aberta
        const sidebar = document.getElementById('aquarium-sidebar');
        const isSidebarOpen = sidebar && sidebar.offsetWidth > 0;

        // Adicionado: verifica√ß√£o para 'links'
        if (isSidebarOpen && (tabType === 'textos' || tabType === 'navega' || tabType === 'links')) {
            
            clearTimeout(aqLiveTimer);
            
            aqLiveTimer = setTimeout(() => {
                const canvas = document.getElementById('aquarium-content-canvas');
                
                if (tabType === 'textos') {
                    console.log("üìú [LIVE] Atualizando textos b√≠blicos...");
                    renderAquariumTexts(); // J√° usa o canvas internamente
                } 
                else if (tabType === 'navega') {
                    console.log("‚öì [LIVE] Atualizando navega√ß√£o...");
                    renderAquariumNav(canvas);
                }
                else if (tabType === 'links') {
                    console.log("‚ö° [LIVE] Atualizando links e fontes...");
                    renderAquariumLinks(canvas);
                }
            }, 1000); 
        }
    });
}

function updateAquariumLinkButtonState(ghost) {
    // Seleciona o bot√£o ‚ö° na barra de ferramentas do Aqu√°rio
    const btn = document.querySelector('#aq-context-tools button[data-ctx="links"]');
    
    if (!btn || !ghost) return;

    const json = ghost.getAttribute('data-box-links');
    let hasLinks = false;

    if (json && json !== '{}') {
        try {
            const data = JSON.parse(json);
            if ((data.urls && Object.keys(data.urls).length > 0) ||
                (data.codex && data.codex.length > 0) ||
                (data.categories && data.categories.length > 0)) {
                hasLinks = true;
            }
        } catch (e) {}
    }

    if (hasLinks) {
        btn.classList.add('has-links-sparkle'); // Ativa a anima√ß√£o CSS
    } else {
        btn.classList.remove('has-links-sparkle');
    }
}

// 1. ABRIR POPUP
window.openGhostPopup = function(btn) {
    // --- SEGURAN√áA CONTRA ERROS ---
    if (!btn || typeof btn.closest !== 'function') {
        console.error("‚ùå ERRO CR√çTICO: 'btn' inv√°lido recebido em openGhostPopup:", btn);
        return; 
    }

    console.log("üöÄ [POPUP] A processar abertura...");
    
    // 1. Encontra o bloco pai
    const ghost = btn.closest('.ghost-block');
    if (!ghost) return console.error("‚ùå Bloco fantasma n√£o encontrado.");

    // 2. Garante ID
    if (!ghost.id) ghost.id = 'ghost_' + Date.now();
    
    // 3. Verifica se J√Å est√° aberto (Foca nele)
    if (activeAquariumPopups.includes(ghost.id)) {
        const existing = document.getElementById(`popup_${ghost.id}`);
        if (existing) {
            existing.style.zIndex = ++highestZIndex;
            existing.style.transform = "scale(1.05)";
            existing.style.boxShadow = "0 0 30px var(--accent-color)";
            setTimeout(() => {
                existing.style.transform = "scale(1)";
                existing.style.boxShadow = "0 20px 50px rgba(0, 0, 0, 0.9)";
            }, 200);
            return;
        }
    }

    // 4. VERIFICA√á√ÉO DO LIMITE DE 6
    if (activeAquariumPopups.length >= MAX_AQ_POPUPS) {
        alert(`‚ö†Ô∏è Limite de ${MAX_AQ_POPUPS} janelas atingido.\nPor favor, feche alguma janela antes de abrir outra.`);
        return;
    }

    // 5. BLOQUEAR O ORIGINAL
    ghost.classList.add('locked-popup'); 
    ghost.setAttribute('contenteditable', 'false'); 
    activeAquariumPopups.push(ghost.id);

    // 6. Criar a Janela
    const popupId = `popup_${ghost.id}`;
    const popup = document.createElement('div');
    popup.className = 'aq-popup-window';
    popup.id = popupId;
    
    // Posi√ß√£o padr√£o para PC (Cascata)
    const offset = activeAquariumPopups.length * 30;
    popup.style.top = `${120 + offset}px`;
    popup.style.left = `${120 + offset}px`;
    popup.style.zIndex = ++highestZIndex;

    // Limpa o conte√∫do (remove os bot√µes para n√£o duplicar na janela)
    const cloneContent = ghost.innerHTML.replace(/<div class="ghost-actions".*?<\/div>/g, '');

    popup.innerHTML = `
        <div class="aq-popup-header">
            <span class="aq-popup-title">Janela ${activeAquariumPopups.length} / ${MAX_AQ_POPUPS}</span>
            <button class="aq-popup-close" onclick="window.closeGhostPopup('${ghost.id}')">‚úï</button>
        </div>
        <div class="aq-popup-content" contenteditable="true" spellcheck="false">
            ${cloneContent}
        </div>
    `;

    // 7. Inserir no Body
    document.body.appendChild(popup);

    // ============================================================
    // NOVO: CENTRALIZA√á√ÉO AUTOM√ÅTICA NO MOBILE
    // ============================================================
    if (window.innerWidth <= 768) {
        // 1. Obt√©m as dimens√µes reais da janela acabada de criar
        const rect = popup.getBoundingClientRect();
        
        // 2. Calcula o centro exato
        const centerX = (window.innerWidth - rect.width) / 2;
        const centerY = (window.innerHeight - rect.height) / 2;
        
        // 3. Aplica as coordenadas
        popup.style.top = centerY + 'px';
        popup.style.left = centerX + 'px';
        popup.style.margin = '0'; // Garante que margens n√£o estragam a conta
        popup.style.transform = 'none'; // Remove qualquer transform CSS
    }
    // ============================================================
    
    // Ativa o arrasto
    if (typeof makeElementDraggable === 'function') {
        makeElementDraggable(popup);
    }

    // 8. Sincroniza√ß√£o (Janela -> Bloco Original)
    const editor = popup.querySelector('.aq-popup-content');
    editor.addEventListener('input', () => {
        const actionsHTML = ghost.querySelector('.ghost-actions')?.outerHTML || '';
        
        if (!ghost.querySelector('.ghost-actions')) {
            ghost.innerHTML = editor.innerHTML;
            if(typeof ensureGhostActions === 'function') ensureGhostActions(ghost);
        } else {
            ghost.innerHTML = editor.innerHTML + actionsHTML;
        }
        
        if (typeof saveAquariumState === 'function') saveAquariumState();
        
        const canvas = document.getElementById('aquarium-content-canvas');
        if (canvas) canvas.dispatchEvent(new Event('input', { bubbles: true }));
    });

    editor.focus();
};

// 2. FECHAR POPUP
window.closeGhostPopup = function(ghostId) {
    const popup = document.getElementById(`popup_${ghostId}`);
    const ghost = document.getElementById(ghostId);

    // 1. Remove a janela
    if (popup) popup.remove();

    // 2. DESBLOQUEIA O ORIGINAL
    if (ghost) {
        ghost.classList.remove('locked-popup');
        ghost.setAttribute('contenteditable', 'true'); // VOLTA A PERMITIR ESCRITA
        
        // Garante que os bot√µes de a√ß√£o (üêö ‚á±) est√£o l√°
        if (typeof ensureGhostActions === 'function') {
            ensureGhostActions(ghost);
        }
    }

    // 3. Remove da lista ativa
    activeAquariumPopups = activeAquariumPopups.filter(id => id !== ghostId);
};

// --- FUN√á√ÉO DE LIMPEZA PROFUNDA DO AQU√ÅRIO ---
window.resetAquariumState = function() {
    console.log("üßπ [RESET] A limpar estado do Aqu√°rio...");

    // 1. Fechar Sidebar e Resetar Margens do Texto
    const env = document.getElementById('aquarium-environment');
    if (env) {
        env.classList.remove('sidebar-open');
        
        // --- NOVO: Remove as classes que empurram o texto ---
        env.classList.remove('left-open');
        env.classList.remove('right-open');
    }
    
    // Reset do bot√£o da Medusa
    const sideBtn = document.getElementById('aquarium-sidebar-toggle');
    if (sideBtn) sideBtn.classList.remove('active');

    // Volta para a aba de listas por defeito na sidebar
    const listTab = document.querySelector('.aq-tab[data-tab="listas"]');
    if (listTab) listTab.click();

    // 2. DESTRUIR TODOS OS POPUPS FLUTUANTES
    document.querySelectorAll('.aq-popup-window').forEach(popup => popup.remove());
    
    // --- LIMPEZA TOTAL DOS EFEITOS VISUAIS AZUIS (Armaz√©m) ---
    document.querySelectorAll('.ghost-block.active-store-target').forEach(g => {
        g.classList.remove('active-store-target');
        // Remove estilos inline for√ßados para garantir limpeza absoluta
        g.style.border = '';
        g.style.backgroundColor = '';
        g.style.boxShadow = '';
    });
    // Zera a vari√°vel de controlo
    window.activeStoreGhostId = null;

    // 3. DESBLOQUEAR BLOCOS ORIGINAIS (Que estavam em janelas flutuantes)
    document.querySelectorAll('.ghost-block.locked-popup').forEach(block => {
        block.classList.remove('locked-popup');
        block.setAttribute('contenteditable', 'true'); // Devolve a capacidade de editar
    });

    // 4. RESETAR VARI√ÅVEIS GLOBAIS
    activeAquariumPopups = []; 
    aqListStack = [];          
    window.activeGhost = null; 

    // 5. Esconder Barras de Contexto e Modais de Sistema
    const contextTools = document.getElementById('aq-context-tools');
    if (contextTools) contextTools.style.setProperty('display', 'none', 'important');

    const systemModals = [
        'aquarium-jump-popup', 'share-settings-popup', 'link-modal', 
        'black-hole-modal', 'semantic-type-popup', 'universal-scan-modal'
    ];
    systemModals.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // 6. Fechar o Painel de Refer√™ncias (Direita) e devolv√™-lo √† app principal
    if (typeof hideReferencesPanel === 'function') {
        hideReferencesPanel();
    }
};

// Permite clicar noutros blocos mesmo com popups abertos
document.getElementById('aquarium-content-canvas').addEventListener('mousedown', (e) => {
    // Se o alvo for um bloco fantasma E N√ÉO estiver bloqueado
    const targetBlock = e.target.closest('.ghost-block');
    
    if (targetBlock && !targetBlock.classList.contains('locked-popup')) {
        // For√ßa a ativa√ß√£o desse bloco
        window.setActiveGhost(targetBlock);
    }
});

window.openGhostStore = async function(btn) {
    const ghost = btn.closest('.ghost-block');
    if (!ghost) return;
    
    if (!ghost.id) ghost.id = 'ghost_' + Date.now();
    window.activeStoreGhostId = ghost.id;
    
    // 1. Destaque visual no par√°grafo
    document.querySelectorAll('.ghost-block').forEach(g => g.classList.remove('active-store-target'));
    ghost.classList.add('active-store-target');
    
    // 2. Abrir Sidebar se estiver fechada
    const env = document.getElementById('aquarium-environment');
    if (env && !env.classList.contains('sidebar-open')) {
        env.classList.add('sidebar-open');
        document.getElementById('aquarium-sidebar-toggle')?.classList.add('active');
    }
    
    // 3. --- CORRE√á√ÉO DE NAVEGA√á√ÉO ---
    // Remove o estado ativo de todos os bot√µes de TOPO e coloca na Concha
    document.querySelectorAll('.aq-tab').forEach(b => b.classList.remove('active'));
    const storeTabBtn = document.querySelector('.aq-tab[data-tab="armazem"]');
    if (storeTabBtn) storeTabBtn.classList.add('active');

    // Esconde TODAS as vistas (incluindo a de Listas/T√≥picos que aparece na tua imagem)
    document.querySelectorAll('.aq-view').forEach(v => v.style.display = 'none');
    
    // Mostra apenas a do Armaz√©m
    const storeView = document.getElementById('aq-store-view');
    if (storeView) {
        storeView.style.display = 'flex'; // Flex para as sub-abas funcionarem
    }

    // 4. Define a sub-aba como Par√°grafos
    window.currentStoreTab = 'paragraphs';
    window.currentShellId = null;

    // 5. Cria o card autom√°tico
    await window.createStoreItem('note', { 
        title: "", 
        autoCreated: true 
    });
};


// Criar Nota Vinculada ao Bloco
window.createAttachedNote = async function() {
    if (!window.activeStoreGhostId) return alert("Erro: Nenhum bloco selecionado.");

    const title = prompt("Nome da nova nota anexa:");
    if (!title) return;

    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Cria nota vinculada ao ID do bloco (parentBlockId)
        await addDoc(collection(db, 'pastas'), {
            nome: title,
            tipo: 'nota',
            conteudo: '',
            userId: auth.currentUser.uid,
            createdAt: serverTimestamp(),
            ultimaedicao: serverTimestamp(),
            estado: 'ativa',
            parentBlockId: window.activeStoreGhostId, // V√çNCULO
            originAquariumId: selectedNoteId
        });
        
        // Atualiza a lista
        if(typeof renderAquariumStore === 'function') renderAquariumStore();

    } catch (e) {
        console.error(e);
        alert("Erro ao criar nota.");
    }
};

// --- ABA: ARMAZ√âM (Notas Anexadas ao Bloco) ---
// --- VARI√ÅVEIS GLOBAIS DO ARMAZ√âM ---
window.currentStoreTab = 'notes'; // Abas: notes, shells, paragraphs, media
window.currentShellId = null; // null = Raiz, ID = Dentro da Concha

// 1. FUN√á√ÉO MESTRA: RENDERIZAR ARMAZ√âM
window.renderAquariumStore = async function() {
    const container = document.getElementById('aq-store-view');
    if (!container) return;

    container.style.cssText = "display: flex; flex-direction: column; height: 100%; overflow: hidden;";

    if (window.currentShellId) {
        await renderInsideShell(container);
        return;
    }

    // Gerar HTML das abas internas
    container.innerHTML = `
        <div class="store-tabs-header">
            <button class="store-tab-btn ${window.currentStoreTab === 'notes' ? 'active' : ''}" onclick="window.switchStoreTab('notes')">üóíÔ∏è</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'shells' ? 'active' : ''}" onclick="window.switchStoreTab('shells')">ü´ß</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'paragraphs' ? 'active' : ''}" onclick="window.switchStoreTab('paragraphs')">üéê</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'media' ? 'active' : ''}" onclick="window.switchStoreTab('media')">üì∑</button>
            <button class="store-tab-btn ${window.currentStoreTab === 'squid' ? 'active' : ''}" onclick="window.switchStoreTab('squid')" style="margin-left:auto; color:#9b59b6;">ü¶ë</button>
        </div>
        <div id="store-content-list" class="store-content-area" style="flex:1; overflow-y:auto;">
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    `;

    // Carregar os dados reais
    await loadStoreContent();
};
  

// 2. FUN√á√ÉO PARA MUDAR DE ABA
window.switchStoreTab = function(tab) {
    window.currentStoreTab = tab;
    // Re-renderiza para atualizar a classe .active no bot√£o e carregar o conte√∫do novo
    window.renderAquariumStore();
};

// 3. CARREGAR CONTE√öDO (CONSOANTE A ABA)
async function loadStoreContent() {
    const listDiv = document.getElementById('store-content-list');
    if (!listDiv) return console.error("‚ùå [ARMAZ√âM] Div 'store-content-list' n√£o encontrada.");

    console.log(`üìÇ [ARMAZ√âM] A preparar aba: ${window.currentStoreTab}`);

    // 1. Limpeza e Spinner
    listDiv.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

    // 2. IMPORTA√á√ÉO DOS M√ìDULOS
    const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    // --- ID GLOBAL EXCLUSIVO DO UTILIZADOR ---
    // Isto garante que a "Mochila" √© transversal a todos os aqu√°rios DESTE user,
    // mas n√£o mistura com as mochilas de outros users.
    const GLOBAL_SQUID_ID = 'SHARED_SQUID_' + auth.currentUser.uid;

    try {
        listDiv.innerHTML = ''; 
        const collRef = collection(db, 'aquarium_annotations');
        let q;

        // ============================================================
        // [ESTRAT√âGIA] DELEGA√á√ÉO DE CLIQUES (BOT√ïES DE CRIA√á√ÉO)
        // ============================================================
        // Removemos ouvintes antigos clonando o elemento
        const newListDiv = listDiv.cloneNode(true);
        listDiv.parentNode.replaceChild(newListDiv, listDiv);
        
        // Atualiza a refer√™ncia para usar no resto da fun√ß√£o
        const activeListDiv = document.getElementById('store-content-list');

        activeListDiv.addEventListener('click', async (e) => {
            const btn = e.target.closest('.store-create-btn');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            const action = btn.dataset.action;
            console.log("%cüéØ [CLIQUE] A√ß√£o Armaz√©m: " + action, "color: yellow; font-weight: bold;");

            // --- A√á√ïES GLOBAIS (SQUID) ---
            if (action === 'add-global-shell') {
                const res = await window.showCustomInput("Nova Concha Partilhada", "Nome da concha...");
                if (res && res.name) window.createStoreItem('shell', { name: res.name });
            }
            // --- A√á√ïES LOCAIS ---
            else if (action === 'add-global-note') {
                const res = await window.showCustomInput("Nova Anota√ß√£o Global", "T√≠tulo da nota...");
                if (res && res.name) window.createStoreItem('note', { title: res.name });
            } 
            else if (action === 'add-shell') {
                const res = await window.showCustomInput("Criar Concha", "Nome da concha...");
                if (res && res.name) window.createStoreItem('shell', { name: res.name });
            }
            else if (action === 'add-media-image') {
                const res = await window.showCustomInput("Inserir Imagem", "URL da imagem...");
                if (res && res.name) window.createStoreItem('media', { url: res.name, mediaType: 'image' });
            }
            else if (action === 'add-media-video') {
                const res = await window.showCustomInput("Inserir V√≠deo", "Link YouTube...");
                if (res && res.name) window.createStoreItem('media', { url: res.name, mediaType: 'video' });
            }
        });

        // ============================================================
        // CONFIGURA√á√ÉO DAS QUERIES E BOT√ïES POR ABA
        // ============================================================
        
        // --- ABA SQUID (ü¶ë) ---
        if (window.currentStoreTab === 'squid') {
            const btn = document.createElement('button');
            btn.className = 'store-create-btn';
            btn.dataset.action = 'add-global-shell';
            btn.innerHTML = "<strong style='color:#9b59b6;'>+ Concha Partilhada</strong>";
            btn.style.borderColor = "#9b59b6";
            btn.style.backgroundColor = "rgba(155, 89, 182, 0.1)";
            activeListDiv.appendChild(btn);

            // Query: Usa o ID Global + Filtro de Raiz (parentId == null)
            q = query(collRef, 
                where('noteId', '==', GLOBAL_SQUID_ID),
                where('type', '==', 'store_shell'),
                where('parentId', '==', null), // OBRIGAT√ìRIO: Esconde subconchas da raiz
                orderBy('createdAt', 'desc')
            );
        }
        
        // --- ABA NOTAS (üóíÔ∏è) ---
        else if (window.currentStoreTab === 'notes') {
            const btn = document.createElement('button');
            btn.className = 'store-create-btn';
            btn.dataset.action = 'add-global-note';
            btn.innerHTML = "<strong>+ Anota√ß√£o Global</strong>";
            activeListDiv.appendChild(btn);

           q = query(collRef, 
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_note'),
                where('blockId', '==', null), // N√£o mostra notas de par√°grafos
                where('parentId', '==', null), // S√≥ mostra notas que N√ÉO t√™m concha
                orderBy('createdAt', 'desc')
            );
        }

        // --- ABA CONCHAS (ü´ß) ---
        else if (window.currentStoreTab === 'shells') {
            const btn = document.createElement('button');
            btn.className = 'store-create-btn';
            btn.dataset.action = 'add-shell';
            btn.innerHTML = "<strong style='color:#e67e22;'>+ Concha</strong>";
            btn.style.borderColor = "#e67e22";
            activeListDiv.appendChild(btn);

            q = query(collRef, 
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_shell'),
                where('parentId', '==', null), // OBRIGAT√ìRIO: Esconde subconchas locais
                orderBy('createdAt', 'desc')
            );
        }

        // --- ABA PAR√ÅGRAFOS (üéê) ---
        else if (window.currentStoreTab === 'paragraphs') {
            // Sem bot√£o de criar (cria-se via contexto do bloco)
            q = query(collRef,
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_note'),
                orderBy('createdAt', 'desc')
            );
        }

        // --- ABA MEDIA (üì∑) ---
        else if (window.currentStoreTab === 'media') {
            const btnDiv = document.createElement('div');
            btnDiv.style.cssText = "display:flex; gap:10px; margin-bottom:15px;";
            
            const btnImg = document.createElement('button');
            btnImg.className = 'store-create-btn'; 
            btnImg.style.flex = "1";
            btnImg.dataset.action = 'add-media-image';
            btnImg.innerHTML = "<strong>+ Imagem</strong>";

            const btnVid = document.createElement('button');
            btnVid.className = 'store-create-btn'; 
            btnVid.style.flex = "1";
            btnVid.dataset.action = 'add-media-video';
            btnVid.innerHTML = "<strong>+ V√≠deo</strong>";

            btnDiv.append(btnImg, btnVid);
            activeListDiv.appendChild(btnDiv);

            q = query(collRef, 
                where('noteId', '==', selectedNoteId),
                where('type', '==', 'store_media'),
                where('parentId', '==', null), // Apenas items na raiz
                orderBy('createdAt', 'desc')
            );
        }

        // ============================================================
        // [PARTE 2] BUSCA E RENDERIZA√á√ÉO DOS CARDS
        // ============================================================
        if (!q) return;

        const snap = await getDocs(q);
        let hasItems = false;

        snap.forEach(docSnap => {
            const data = docSnap.data();
            
            // Filtros manuais extra para garantir limpeza
            if (window.currentStoreTab === 'paragraphs' && !data.blockId) return;
            if (window.currentStoreTab === 'notes' && data.blockId) return;

            hasItems = true;
            
            if (data.type === 'store_shell') {
                activeListDiv.appendChild(createStoreShellCard(docSnap.id, data));
            } else if (data.type === 'store_media') {
                activeListDiv.appendChild(createStoreMediaCard(docSnap.id, data));
            } else {
                const card = createStoreNoteCard(docSnap.id, data);
                
                // Injeta alvo üéØ se tiver v√≠nculo com par√°grafo
                if (data.blockId) {
                    const h = card.querySelector('div'); // Header
                    const locateBtn = document.createElement('button');
                    locateBtn.className = 'store-link-indicator-btn';
                    locateBtn.innerHTML = 'üéØ';
                    locateBtn.title = "Localizar no texto";
                    locateBtn.onclick = (e) => {
                        e.stopPropagation();
                        const el = document.getElementById(data.blockId);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            el.style.transition = "box-shadow 0.5s";
                            el.style.boxShadow = "0 0 30px var(--accent-color)";
                            setTimeout(() => el.style.boxShadow = "", 2000);
                        } else {
                            alert("O bloco original foi apagado.");
                        }
                    };
                    if(h) h.insertBefore(locateBtn, h.firstChild);
                }
                activeListDiv.appendChild(card);
            }
        });

        if (!hasItems) {
            activeListDiv.innerHTML += '<p style="text-align:center; color:#666; margin-top:40px; font-style:italic;">Vazio.</p>';
        }

    } catch (e) {
        console.error("‚ùå [ERRO CR√çTICO] Falha ao carregar Armaz√©m:", e);
        listDiv.innerHTML = `<p style="color:red; text-align:center; padding:20px;">Erro ao carregar dados.<br><small>${e.message}</small></p>`;
    }
}
    



// 4. CRIAR ITEM NO FIREBASE
window.createStoreItem = async function(type, extraData = {}) {
    const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    if (typeof updateAquariumStatus === 'function') updateAquariumStatus('saving');

    // --- CORRE√á√ÉO AQUI ---
    const GLOBAL_SQUID_ID = 'SHARED_SQUID_' + auth.currentUser.uid;
    const targetNoteId = (window.currentStoreTab === 'squid') ? GLOBAL_SQUID_ID : selectedNoteId;

    const baseData = {
        noteId: targetNoteId, // Grava no ID pessoal do Squid
        type: `store_${type}`, 
        createdAt: serverTimestamp(),
        parentId: window.currentShellId || null,
        userId: auth.currentUser.uid,
        blockId: (window.currentStoreTab === 'paragraphs' && window.currentStoreTab !== 'squid') ? window.activeStoreGhostId : null
    };

    if (type === 'note') {
        baseData.title = extraData.title || ""; 
        baseData.content = "";
    } else if (type === 'shell') {
        baseData.name = extraData.name || "Nova Concha";
    } else if (type === 'media') {
        baseData.url = extraData.url || "";
        baseData.mediaType = extraData.mediaType || "image";
    }

    try {
        await addDoc(collection(db, 'aquarium_annotations'), baseData);
        if (typeof updateAquariumStatus === 'function') updateAquariumStatus('saved');
        
        if (window.currentShellId) {
            renderInsideShell(document.getElementById('aq-store-view'));
        } else {
            window.renderAquariumStore();
        }
    } catch (e) {
        console.error(e);
        if (typeof updateAquariumStatus === 'function') updateAquariumStatus('error');
    }
};

// 5. RENDERIZAR CARD DE NOTA
function createStoreNoteCard(id, data) {
    const card = document.createElement('div');
    card.className = 'store-note-card';
    card.id = `store-note-${id}`;

    // --- VERIFICA√á√ÉO DE BLOQUEIO ---
    const isLocked = window.activeStorePopups && window.activeStorePopups.includes(id);
    const readOnlyAttr = isLocked ? 'readonly' : '';
    const contentEditableAttr = isLocked ? 'false' : 'true';

    if (isLocked) card.classList.add('locked-card');
    
    // --- VERIFICA√á√ÉO DE ESTADO "FEITO" ---
    if (data.isDone) {
        card.classList.add('state-done');
    }

    // T√≠tulo e Bot√µes de Topo
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.gap = '5px';
    header.style.alignItems = 'center';

    // √çcone do Checkbox (Quadrado)
    const checkIcon = data.isDone ? '‚òëÔ∏è' : '‚¨ú';

    header.innerHTML = `
        <input type="text" class="store-note-title" placeholder="T√≠tulo" value="${data.title || ''}" ${readOnlyAttr} style="flex-grow: 1;">
        
        <!-- NOVO BOT√ÉO CHECKBOX -->
        <button class="store-icon-btn btn-check-toggle" title="Marcar como feito" 
                style="font-size: 16px; margin-right: 2px;">
            ${checkIcon}
        </button>

        <button class="store-icon-btn" title="Abrir Popup" onclick="window.openStoreNotePopup('${id}')">‚á±</button>
        <button class="store-icon-btn" title="Apagar" style="color:#e74c3c" onclick="window.deleteStoreItem('${id}')">üóëÔ∏è</button>
    `;

    // --- L√ìGICA DO CHECKBOX ---
    const checkBtn = header.querySelector('.btn-check-toggle');
    checkBtn.onclick = () => {
        // 1. Alterna estado visual
        const isNowDone = !card.classList.contains('state-done');
        
        if (isNowDone) {
            card.classList.add('state-done');
            checkBtn.textContent = '‚òëÔ∏è';
        } else {
            card.classList.remove('state-done');
            checkBtn.textContent = '‚¨ú';
        }

        // 2. Grava no Firebase
        window.updateStoreItem(id, { isDone: isNowDone });
    };

    // Corpo
    const body = document.createElement('div');
    body.className = 'store-note-body';
    body.contentEditable = contentEditableAttr;
    body.innerHTML = data.content || "";

    // Rodap√© (Links)
 const footer = document.createElement('div');
    footer.className = 'store-card-footer';
    
    // √Årea onde os links vivem
    const linksArea = document.createElement('div');
    linksArea.className = 'store-links-area';
    
    // Renderiza links existentes (vindos do Firebase)
    if (data.links) {
        data.links.forEach((link, idx) => {
            // Passamos o valor guardado
            linksArea.appendChild(createLinkRow(id, idx, link.url));
        });
    }

    const addLinkBtn = document.createElement('button');
    addLinkBtn.className = 'store-icon-btn';
    addLinkBtn.textContent = "+ Link";
    
    // --- CORRE√á√ÉO DO BOT√ÉO + LINK ---
    addLinkBtn.onclick = () => {
        if (card.classList.contains('locked-card')) return;
        
        // 1. Calcula o novo √≠ndice
        const newIdx = linksArea.childElementCount;
        
        // 2. Cria o novo campo visualmente (Vazio)
        const newRow = createLinkRow(id, newIdx, "");
        linksArea.appendChild(newRow);
        
        // 3. Foca no novo input
        const input = newRow.querySelector('input');
        if(input) input.focus();

        // 4. (Opcional) Cria espa√ßo vazio no array do Firebase para reservar o lugar
        // Mas o mais seguro √© deixar o evento 'change' do input tratar da grava√ß√£o real.
    };

    footer.appendChild(linksArea);
    footer.appendChild(addLinkBtn);

    // Auto-Save Listeners
    const titleInput = header.querySelector('input');
    titleInput.addEventListener('input', () => {
        if (card.classList.contains('locked-card')) return;
        clearTimeout(card.saveTimer);
        card.saveTimer = setTimeout(() => window.updateStoreItem(id, { title: titleInput.value }), 1000);
    });

    body.addEventListener('input', () => {
        if (card.classList.contains('locked-card')) return;
        clearTimeout(card.saveTimer);
        card.saveTimer = setTimeout(() => {
            window.updateStoreItem(id, { content: body.innerHTML });
            const popupBody = document.getElementById(`popup-body-${id}`);
            if(popupBody) popupBody.innerHTML = body.innerHTML;
        }, 1000);
    });

   card.appendChild(header);
    card.appendChild(body);
    card.appendChild(footer);

    return card;
}


function createLinkRow(noteId, idx, urlVal) {
    const div = document.createElement('div');
    div.className = 'store-link-row';
    // Adicionamos um ID √∫nico √† linha para a encontrarmos facilmente
    div.dataset.index = idx; 

    div.innerHTML = `
        <input type="text" class="store-link-input" placeholder="URL..." value="${urlVal}">
        <button class="store-icon-btn" onclick="window.open(this.previousElementSibling.value, '_blank')">‚Üó</button>
        <button class="store-icon-btn" style="color:#e74c3c" onclick="window.removeStoreLink('${noteId}', this)">√ó</button>
    `;
    
    // Auto-save INTELIGENTE
    const input = div.querySelector('input');
    input.addEventListener('change', async () => {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const ref = doc(db, 'aquarium_annotations', noteId);
        const snap = await getDoc(ref);
        
        if (snap.exists()) {
            // Obt√©m o array atual do servidor (para n√£o perder links de outros users)
            let links = snap.data().links || [];
            
            // Garante que o array tem tamanho suficiente
            while (links.length <= idx) {
                links.push({ url: "" });
            }
            
            // Atualiza apenas este link
            links[idx] = { url: input.value.trim() };
            
            // Grava
            await updateDoc(ref, { links });
        }
    });

    return div;
}


// 6. RENDERIZAR CONCHA
function createStoreShellCard(id, data) {
    const div = document.createElement('div');
    div.className = 'store-shell-card';
    div.innerHTML = `
        <span class="shell-icon">üêö</span>
        <span class="shell-name">${data.name}</span>
        <div style="display:flex; gap:5px;">
            <button class="store-icon-btn" onclick="event.stopPropagation(); window.editShellName('${id}', '${data.name}')">‚úèÔ∏è</button>
            <button class="store-icon-btn" style="color:#e74c3c" onclick="event.stopPropagation(); window.deleteStoreItem('${id}')">üóëÔ∏è</button>
        </div>
    `;
    div.onclick = () => window.enterShell(id, data.name);
    return div;
}

// 7. RENDERIZAR MULTIM√âDIA
function createStoreMediaCard(id, data) {
    const div = document.createElement('div');
    div.className = 'store-media-card';
    
    // 1. Determina o conte√∫do visual
    let mediaContent = '';
    const url = data.url || '';
    const isVideo = data.mediaType === 'video';

    if (url) {
        if (isVideo) {
            // Tenta detetar YouTube para embutir
            // Suporta: , , 
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            
            if (ytMatch && ytMatch[1]) {
                // √â YouTube: Mostra Iframe
                mediaContent = `
                    <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:4px; margin-bottom:5px;">
                        <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                                src=" 
                                frameborder="0" allowfullscreen></iframe>
                    </div>`;
            } else {
                // Outro V√≠deo: Mostra Link Gen√©rico com √çcone
                mediaContent = `
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:4px; text-align:center; margin-bottom:5px;">
                        <span style="font-size:2em;">üé•</span>
                        <br>
                        <a href="${url}" target="_blank" style="color:var(--accent-color); word-break:break-all;">${url}</a>
                    </div>`;
            }
        } else {
            // Imagem
            mediaContent = `<img src="${url}" class="store-media-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                            <div style="display:none; color:red; font-size:0.8em;">Erro ao carregar imagem.</div>`;
        }
    }

    // 2. HTML do Card (Input + Bot√µes)
    const placeholderText = isVideo ? "Cole o link do v√≠deo (YouTube...)" : "URL da Imagem...";
    const icon = isVideo ? "üé•" : "üñºÔ∏è";

    div.innerHTML = `
        ${mediaContent}
        
        <div style="display:flex; gap:5px; align-items:center;">
            <span style="font-size:1.2em;">${icon}</span>
            <input type="text" class="store-media-input" placeholder="${placeholderText}" value="${url}">
            
            <!-- Bot√£o Ver (Abre link original) -->
            ${url ? `<button class="store-icon-btn" onclick="window.open('${url}', '_blank')" title="Abrir Link">‚Üó</button>` : ''}
            
            <button class="store-icon-btn" style="color:#e74c3c" onclick="window.deleteStoreItem('${id}')">üóëÔ∏è</button>
        </div>
    `;

    // 3. Listener para Gravar Altera√ß√µes
    const input = div.querySelector('input');
    input.addEventListener('change', () => {
        let newUrl = input.value.trim();
        // Adiciona https se faltar
        if (newUrl && !newUrl.startsWith('http')) newUrl = 'https://' + newUrl;
        
        window.updateStoreItem(id, { url: newUrl });
        
        // Recarrega a vista para processar o novo link (mostrar iframe ou imagem)
        if(window.currentShellId) {
            renderInsideShell(document.getElementById('aq-store-view'));
        } else {
            loadStoreContent();
        }
    });

    return div;
}

// 8. NAVEGA√á√ÉO NA CONCHA
window.enterShell = function(id, name) {
    // Guarda o local onde est√°vamos antes de entrar
    window.shellStack.push({
        id: window.currentShellId, // Pode ser null (Raiz) ou um ID (Concha Pai)
        name: window.currentShellName
    });

    window.currentShellId = id;
    window.currentShellName = name;
    
    // Atualiza a vista
    window.renderAquariumStore();
};

// Voltar atr√°s (Um n√≠vel de cada vez)
window.backToStoreRoot = function() {
    if (window.shellStack.length > 0) {
        // Tira o √∫ltimo local da mem√≥ria
        const prev = window.shellStack.pop();
        
        window.currentShellId = prev.id;
        window.currentShellName = prev.name;
        
        // Se o ID for null, significa que volt√°mos √† raiz das abas
        if (window.currentShellId === null) {
            window.renderAquariumStore(); // Renderiza abas (renderAquariumStore lida com null)
        } else {
            // Se ainda tem ID, renderiza o interior da concha pai
            renderInsideShell(document.getElementById('aq-store-view'));
        }
    } else {
        // Seguran√ßa: Se a pilha estiver vazia, vai para a raiz absoluta
        window.currentShellId = null;
        window.renderAquariumStore();
    }
};

async function renderInsideShell(container) {
    const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    const isSquid = window.currentStoreTab === 'squid';
    const themeColor = isSquid ? '#9b59b6' : '#e67e22';

    // (O HTML do Header mant√©m-se igual...)
    container.innerHTML = `
        <div class="store-nav-header" style="border-bottom-color:${themeColor};">
            <button class="store-icon-btn" style="font-size:18px; margin-right:10px;" onclick="window.backToStoreRoot()">‚¨Ö</button>
            <span style="font-weight:bold; color:${themeColor};">
                ${isSquid ? 'ü¶ë' : 'üêö'} ${window.currentShellName || 'Concha'}
            </span>
        </div>
        <div class="store-content-area" id="shell-content">
             <!-- BOT√ïES (Mant√™m-se iguais) -->
             <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                <button class="store-create-btn" data-action="add-sub-shell" style="flex:1; margin:0; padding:8px; border-color:${themeColor}; color:${themeColor}; min-width: 45%;"><strong>+ SubConcha</strong></button>
                <button class="store-create-btn" data-action="add-sub-note" style="flex:1; margin:0; padding:8px; min-width: 45%;">+ Nota</button>
                <button class="store-create-btn" data-action="add-sub-video" style="flex:1; margin:0; padding:8px;">+ V√≠deo</button>
                <button class="store-create-btn" data-action="add-sub-image" style="flex:1; margin:0; padding:8px;">+ Img</button>
            </div>
            <div class="spinner-container"><div class="spinner"></div></div>
        </div>
    `;

    const contentDiv = document.getElementById('shell-content');

    // ============================================================
    // 2. LISTENER DE EVENTOS (AQUI EST√Å A M√ÅGICA DOS POPUPS)
    // ============================================================
    // Clonamos para limpar listeners antigos
   const newContentDiv = contentDiv.cloneNode(true);
    contentDiv.parentNode.replaceChild(newContentDiv, contentDiv);
    
    newContentDiv.addEventListener('click', async (e) => {
        const btn = e.target.closest('.store-create-btn');
        if (!btn) return;
        e.preventDefault(); e.stopPropagation();
        const action = btn.dataset.action;

        if (action === 'add-sub-note') window.createStoreItem('note');
        else if (action === 'add-sub-video') {
             const res = await window.showCustomInput("Inserir V√≠deo", "Link do YouTube...");
             if (res && res.name) window.createStoreItem('media', { mediaType: 'video', url: res.name });
        }
        else if (action === 'add-sub-image') {
             const res = await window.showCustomInput("Inserir Imagem", "Link da Imagem...");
             if (res && res.name) window.createStoreItem('media', { mediaType: 'image', url: res.name });
        }
        else if (action === 'add-sub-shell') window.createSubShell();
    });

    // --- CORRE√á√ÉO AQUI ---
    const GLOBAL_SQUID_ID = 'SHARED_SQUID_' + auth.currentUser.uid;
    const targetNoteId = isSquid ? GLOBAL_SQUID_ID : selectedNoteId;

    try {
        const q = query(
            collection(db, 'aquarium_annotations'),
            where('noteId', '==', targetNoteId), // <--- Usa o ID privado do user
            where('parentId', '==', window.currentShellId)
        );

        const snap = await getDocs(q);
        const spinner = newContentDiv.querySelector('.spinner-container');
        if(spinner) spinner.remove();

        if (snap.empty) {
            const msg = document.createElement('p');
            msg.style.cssText = 'text-align:center; color:#666; margin-top:20px; font-style:italic;';
            msg.textContent = 'Concha vazia.';
            newContentDiv.appendChild(msg);
            return;
        }

        let items = [];
        snap.forEach(docSnap => items.push({ id: docSnap.id, ...docSnap.data() }));

        items.sort((a, b) => {
            if (a.type === 'store_shell' && b.type !== 'store_shell') return -1;
            if (a.type !== 'store_shell' && b.type === 'store_shell') return 1;
            return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
        });

        items.forEach(item => {
            if (item.type === 'store_shell') {
                newContentDiv.appendChild(createStoreShellCard(item.id, item));
            } else if (item.type === 'store_note') {
                newContentDiv.appendChild(createStoreNoteCard(item.id, item));
            } else if (item.type === 'store_media') {
                newContentDiv.appendChild(createStoreMediaCard(item.id, item));
            }
        });

    } catch (e) {
        console.error(e);
        newContentDiv.innerHTML += `<p style="color:red;">Erro ao ler dados.</p>`;
    }
}


window.createSubShell = async function() {
    const isSquid = window.currentStoreTab === 'squid';
    const contextName = isSquid ? "SubConcha Global" : "SubConcha";
    
    // Pede o nome
    const res = await window.showCustomInput(contextName, "Nome da pasta...");
    
    if (res && res.name) {
        // Chama a fun√ß√£o principal. 
        // Como 'currentShellId' j√° est√° definido (porque estamos dentro de uma), 
        // o createStoreItem vai usar esse ID como parentId automaticamente.
        window.createStoreItem('shell', { name: res.name });
    }
};

window.backToStoreRoot = function() {
    window.currentShellId = null;
    window.renderAquariumStore();
};

// 9. POPUP FLUTUANTE DA NOTA
window.openStoreNotePopup = function(id) {
    // 1. Verificar se j√° existe
    if (document.getElementById(`store-popup-${id}`)) {
        alert("Esta nota j√° est√° aberta.");
        return;
    }

    const card = document.getElementById(`store-note-${id}`);
    if (!card) return;

    // 2. Bloquear o Card Original
    card.classList.add('locked-card');
    card.querySelector('.store-note-title').setAttribute('readonly', 'true');
    card.querySelector('.store-note-body').setAttribute('contenteditable', 'false');
    
    // Adicionar √† lista de ativos
    if (!window.activeStorePopups.includes(id)) {
        window.activeStorePopups.push(id);
    }

    // 3. Criar Popup
    const titleVal = card.querySelector('.store-note-title').value;
    const bodyVal = card.querySelector('.store-note-body').innerHTML;

    const popup = document.createElement('div');
    popup.className = 'aq-popup-window';
    popup.id = `store-popup-${id}`;
    
    // Posi√ß√£o em cascata para n√£o ficarem uns cima dos outros
    const offset = window.activeStorePopups.length * 20;
    popup.style.zIndex = '30000000';
    popup.style.position = 'fixed';
    popup.style.top = `${150 + offset}px`;
    popup.style.left = `${200 + offset}px`;

    // Bot√£o de fechar chama a nova fun√ß√£o closeStorePopup
    popup.innerHTML = `
        <div class="aq-popup-header" style="cursor: move;">
            <span class="aq-popup-title">üìù Anota√ß√£o</span>
            <button class="aq-popup-close" onclick="window.closeStorePopup('${id}')">‚úï</button>
        </div>
        <div style="padding:10px; flex-grow:1; display:flex; flex-direction:column; gap:10px; overflow:hidden;">
             <input type="text" class="store-note-title" value="${titleVal}" 
                    style="background:rgba(0,0,0,0.3); border:1px solid #444; color:white; padding:5px;"
                    oninput="window.syncPopupToCard('${id}', 'title', this.value)">
             
             <div class="store-note-body" id="popup-body-${id}" contenteditable="true" 
                  style="flex-grow:1; background:rgba(0,0,0,0.2); color:#ddd; padding:10px; overflow-y:auto;"
                  oninput="window.syncPopupToCard('${id}', 'content', this.innerHTML)">${bodyVal}</div>
        </div>
    `;

    document.body.appendChild(popup);

    if (typeof makeElementDraggable === 'function') {
        makeElementDraggable(popup);
    }
};

// Sincroniza Popup -> Card -> Firebase
window.syncPopupToCard = function(id, field, value) {
    // Atualiza o card visualmente (se estiver vis√≠vel)
    const card = document.getElementById(`store-note-${id}`);
    if (card) {
        if (field === 'title') card.querySelector('.store-note-title').value = value;
        if (field === 'content') card.querySelector('.store-note-body').innerHTML = value;
    }
    
    // Debounce para gravar no Firebase
    clearTimeout(window[`timer_${id}`]);
    window[`timer_${id}`] = setTimeout(() => {
        window.updateStoreItem(id, { [field]: value });
    }, 1000);
};

// 10. HELPER: ATUALIZAR/APAGAR
window.updateStoreItem = async function(id, data) {
    const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    const ref = doc(db, 'aquarium_annotations', id);
    await updateDoc(ref, data);
};

window.deleteStoreItem = async function(id) {
    // 1. Usa o teu modal personalizado
    const confirmed = await showConfirmation(
        "Apagar Item?", 
        "Tem a certeza que deseja eliminar este item do Armaz√©m?"
    );

    if (!confirmed) return; // Se cancelar, n√£o faz nada

    try {
        const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // 2. Apaga no Firebase
        await deleteDoc(doc(db, 'aquarium_annotations', id));
        
        // 3. Remove visualmente (sem precisar de recarregar tudo)
        const el = document.getElementById(`store-note-${id}`) || 
                   document.querySelector(`.store-shell-card button[onclick*="${id}"]`)?.closest('.store-shell-card') ||
                   document.querySelector(`.store-media-card button[onclick*="${id}"]`)?.closest('.store-media-card');
        
        if (el) {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
        } else {
            // Fallback: recarrega a lista se n√£o encontrar o elemento
            if(window.currentShellId) renderInsideShell(document.getElementById('aq-store-view'));
            else loadStoreContent();
        }

    } catch (e) {
        console.error("Erro ao apagar:", e);
        alert("Erro ao apagar.");
    }
};

window.editShellName = async function(id, oldName) {
    // 1. Usa o teu modal de input personalizado
    // Par√¢metros: (T√≠tulo, Placeholder, Valor Inicial)
    const result = await showCustomInput("Renomear Concha", "Nome da concha...", oldName);
    
    if (result && result.name) {
        const newName = result.name.trim();
        if (newName === oldName) return;

        // 2. Atualiza no Firebase
        await window.updateStoreItem(id, { name: newName });
        
        // 3. Atualiza a lista
        loadStoreContent();
    }
};

window.removeStoreLink = async function(noteId, btnElement) {
    const row = btnElement.closest('.store-link-row');
    if (!row) return;

    // Confirma√ß√£o r√°pida
    if (!confirm("Apagar este link?")) return;

    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const ref = doc(db, 'aquarium_annotations', noteId);
        const snap = await getDoc(ref);
        
        if (snap.exists()) {
            let links = snap.data().links || [];
            
            // Descobre o √≠ndice real desta linha no DOM
            // (Porque se apagou o link #2, o link #3 passa a ser o #2 visualmente)
            const allRows = Array.from(row.parentNode.children);
            const realIndex = allRows.indexOf(row);
            
            if (realIndex > -1) {
                links.splice(realIndex, 1); // Remove do array
                await updateDoc(ref, { links }); // Grava
                row.remove(); // Remove do ecr√£
            }
        }
    } catch (e) {
        console.error("Erro ao remover link:", e);
    }
};


// ============================================================
// CORRE√á√ÉO DE CLIQUE: FOR√áA O BOT√ÉO POPUP A FUNCIONAR
// ============================================================
setTimeout(() => {
    const canvas = document.getElementById('aquarium-content-canvas');
    if (canvas) {
        canvas.addEventListener('click', (e) => {
            
            // 1. Tenta encontrar o bot√£o pelo m√©todo padr√£o
            let popupBtn = e.target.closest('button[onclick*="openGhostPopup"]');
            
            // 2. CORRE√á√ÉO: Fallback expl√≠cito que retorna o ELEMENTO, n√£o "true"
            if (!popupBtn) {
                // Se clicou diretamente no bot√£o que tem a classe e o √≠cone
                if (e.target.classList.contains('ghost-action-btn') && e.target.innerHTML.includes('‚á±')) {
                    popupBtn = e.target;
                }
            }

            if (popupBtn) {
                console.log("üñ±Ô∏è Clique for√ßado no bot√£o Popup detetado!", popupBtn);
                
                // P√°ra tudo o resto
                e.preventDefault();
                e.stopPropagation(); 
                e.stopImmediatePropagation(); 

                // Chama a fun√ß√£o passando o ELEMENTO HTML (agora garantido)
                if (typeof window.openGhostPopup === 'function') {
                    window.openGhostPopup(popupBtn);
                } else {
                    console.error("‚ùå Erro: Fun√ß√£o window.openGhostPopup n√£o encontrada.");
                }
                return false;
            }
        }, true); // Fase de captura (prioridade m√°xima)
    }
}, 1000);


// Listener Espec√≠fico para o Aqu√°rio
const aquariumCanvas = document.getElementById('aquarium-content-canvas');
if (aquariumCanvas) {
    aquariumCanvas.addEventListener('paste', (e) => {
        // Verifica se o alvo √© um bloco fantasma
        if (e.target.classList.contains('ghost-block') || e.target.closest('.ghost-block')) {
            
            // 1. Tenta obter HTML do clipboard
            const htmlData = (e.clipboardData || window.clipboardData).getData('text/html');
            const textData = (e.clipboardData || window.clipboardData).getData('text/plain');

            // 2. Verifica se o HTML cont√©m os nossos links especiais
            if (htmlData && htmlData.includes('silent-link')) {
                // Se for um link interno nosso, deixa o navegador lidar com isso (preserva o HTML)
                // N√£o fazemos preventDefault aqui.
                return; 
            }

            // 3. Se for lixo externo ou texto normal, for√ßa Texto Limpo
            e.preventDefault();
            document.execCommand("insertText", false, textData);
            
            // For√ßa uma grava√ß√£o do estado
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
    });
}

// ============================================================
// MOTOR DE SCROLL INFINITO (AQU√ÅRIO)
// ============================================================

function checkAquariumScroll() {
    const scrollArea = document.getElementById('aquarium-scroll-area');
    const canvas = document.getElementById('aquarium-content-canvas');

    if (!scrollArea || !canvas) return;

    // --- 1. DADOS DE MEDI√á√ÉO ---
    const windowHeight = window.innerHeight;
    const scrollPos = scrollArea.scrollTop;
    const totalHeight = scrollArea.scrollHeight;
    const clientHeight = scrollArea.clientHeight;
    
    const distanceToBottom = totalHeight - (scrollPos + clientHeight);

    // --- 2. L√ìGICA DE EXPANS√ÉO (CRESCER) ---
    // Mantemos igual: se chegar perto do fundo, cria espa√ßo para n√£o travar
    if (distanceToBottom < 400) {
        const currentMin = parseFloat(window.getComputedStyle(canvas).minHeight) || 0;
        canvas.style.minHeight = (currentMin + (windowHeight * 0.6)) + 'px';
        return; 
    }

    // --- 3. L√ìGICA DE CONTRA√á√ÉO (LIMPEZA RIGOROSA) ---
    clearTimeout(scrollTimer);
    
    scrollTimer = setTimeout(() => {
        const lastBlock = canvas.lastElementChild;
        
        // Se n√£o houver nada, reseta para tamanho padr√£o
        if (!lastBlock) {
            canvas.style.minHeight = "80vh";
            return;
        }

        // Onde acaba o √∫ltimo texto
        const contentBottom = lastBlock.offsetTop + lastBlock.offsetHeight;
        const currentCanvasHeight = canvas.offsetHeight;
        const emptySpace = currentCanvasHeight - contentBottom;

        // CONFIGURA√á√ÉO PEDIDA:
        // Limite para limpar: 1 tela inteira (1.0)
        const maxAllowedEmpty = windowHeight * 1.0;
        
        // Quanto sobra depois de limpar: 60% de uma tela (0.6)
        // (D√° espa√ßo para continuar a escrever sem cortar a inspira√ß√£o)
        const bufferToKeep = windowHeight * 0.6; 
        
        // Se o espa√ßo vazio for maior que 1 tela...
        if (emptySpace > maxAllowedEmpty) {
            
            const newHeight = contentBottom + bufferToKeep;
            
            // Seguran√ßa: Nunca cortar o que est√° vis√≠vel no ecr√£ neste momento
            // (Posi√ß√£o atual + Altura da Janela + Margem de 100px)
            const visibleBottom = scrollPos + windowHeight + 100;

            if (newHeight > visibleBottom) {
                // console.log("‚úÇÔ∏è Ajustando altura: cortando excesso.");
                canvas.style.minHeight = newHeight + 'px';
            }
        }
    }, 200);
}

// Inicializa√ß√£o
setTimeout(() => {
    const scrollArea = document.getElementById('aquarium-scroll-area');
    
    if (scrollArea) {
        // Usamos 'mousedown' em vez de 'click' para ser mais r√°pido e impedir
        // que o evento se propague para l√≥gicas de cria√ß√£o de novos blocos
        scrollArea.addEventListener('mousedown', (e) => {
            
            // 1. VERIFICA√á√ÉO DE ALVO
            // Se clicou num bloco, num bot√£o ou numa popup, N√ÉO faz nada (deixa o clique funcionar)
            if (e.target.closest('.ghost-block') || 
                e.target.closest('button') || 
                e.target.closest('.aq-popup-window') ||
                e.target.closest('.ghost-actions') ||
                e.target.closest('.ghost-side-controls')) {
                return;
            }

            // 2. VERIFICA SE H√Å ALGO SELECIONADO
            const activeBlock = document.querySelector('.ghost-block.active-selection');
            const activeStore = document.querySelector('.ghost-block.active-store-target');

            if (activeBlock || activeStore) {
                console.log("üñ±Ô∏è Clique na margem detetado. A limpar sele√ß√£o...");

                // --- A. LIMPA SELE√á√ÉO VISUAL ---
                document.querySelectorAll('.ghost-block').forEach(g => {
                    g.classList.remove('active-selection');
                    g.classList.remove('has-next'); // Esconde o bot√£o (+)
                    g.classList.remove('active-store-target'); // Limpa sele√ß√£o do armaz√©m
                    
                    // Limpa estilos inline (bordas azuis)
                    g.style.borderTop = '';
                    g.style.border = '';
                    g.style.outline = '';
                    g.style.boxShadow = '';
                    g.style.backgroundColor = '';
                });

                // --- B. LIMPA ESTADO GLOBAL ---
                window.activeGhost = null;
                window.activeStoreGhostId = null;

                // --- C. ESCONDE BARRA DE FERRAMENTAS ---
                const contextTools = document.getElementById('aq-context-tools');
                if (contextTools) {
                    contextTools.style.setProperty('display', 'none', 'important');
                }
                
                // (Opcional) Remove foco do teclado para garantir que o cursor pisca desaparece
                if (document.activeElement) {
                    document.activeElement.blur();
                }
            }
            
        });
    }
}, 1000); // Delay de seguran√ßa para garantir que o HTML existe


// Fun√ß√£o para controlar o texto visual no Aqu√°rio
function updateAquariumStatus(status) {
    const el = document.getElementById('aq-save-status');
    if (!el) return;

    el.classList.remove('status-saved', 'status-error');
    
    switch (status) {
        case 'unsaved':
            el.textContent = 'por guardar...';
            el.style.color = '#text-muted-color'; // Cinza/Branco
            el.style.opacity = '0.7';
            break;
        case 'saving':
            el.textContent = 'A guardar...';
            el.style.color = 'var(--accent-color)'; // Azul
            el.style.opacity = '1';
            break;
        case 'saved':
            el.textContent = 'Guardado';
            el.classList.add('status-saved'); // Verde (via CSS existente)
            el.style.color = '#2ecc71'; 
            el.style.opacity = '1';
            break;
        case 'error':
            el.textContent = 'Erro ao guardar';
            el.classList.add('status-error'); // Vermelho
            break;
        default:
            el.textContent = '';
    }
}

// Fun√ß√£o para criar Backup de Seguran√ßa Autom√°tico
async function performSafetyBackup(noteId, content, title) {
    try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const backupsRef = collection(db, 'pastas', noteId, 'backups');
        
        await addDoc(backupsRef, {
            titulo: title || "Sem T√≠tulo",
            conteudo: content,
            timestamp: serverTimestamp(),
            isSafetyBackup: true, // Marca como backup de emerg√™ncia
            triggerReason: 'Apagar Tudo (Seguran√ßa)' // Aparecer√° na lista
        });
        
        console.log("üö® [SAFETY] Backup de emerg√™ncia criado com sucesso.");
        return true;
    } catch (e) {
        console.error("Erro ao criar backup de seguran√ßa:", e);
        return false;
    }
}

// Fun√ß√£o para fechar popup e desbloquear o card
window.closeStorePopup = function(id) {
    // 1. Remover o popup do ecr√£
    const popup = document.getElementById(`store-popup-${id}`);
    if (popup) popup.remove();

    // 2. Remover da lista de ativos
    window.activeStorePopups = window.activeStorePopups.filter(pid => pid !== id);

    // 3. Desbloquear o Card Original (se ele estiver vis√≠vel no ecr√£)
    const card = document.getElementById(`store-note-${id}`);
    if (card) {
        card.classList.remove('locked-card');
        card.querySelector('.store-note-title').removeAttribute('readonly');
        card.querySelector('.store-note-body').setAttribute('contenteditable', 'true');
    }
};

window.saveAquariumTitle = async function(newName) {
    if (!selectedNoteId || !newName.trim()) return;

    try {
        const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);

        await updateDoc(noteRef, { 
            nome: newName.trim(),
            ultimaedicao: serverTimestamp()
        });
        
        console.log("‚úèÔ∏è T√≠tulo do Aqu√°rio atualizado.");
        
        // Sincroniza com o input do editor principal (caso esteja escondido por tr√°s)
        const mainInput = document.getElementById('note-title-input');
        if (mainInput) mainInput.value = newName.trim();

    } catch (e) {
        console.error("Erro ao mudar t√≠tulo:", e);
    }
};

// Fun√ß√£o para disparar o efeito de bolhas
window.triggerAquariumBubbles = function() {
    const bubbleCount = 25; // Quantidade de bolhas
    
    for (let i = 0; i < bubbleCount; i++) {
        const bubble = document.createElement('div');
        bubble.className = 'aquarium-bubble';
        
        // Tamanho aleat√≥rio entre 10px e 60px
        const size = Math.random() * 50 + 10;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        
        // Posi√ß√£o horizontal aleat√≥ria (0% a 100%)
        bubble.style.left = `${Math.random() * 100}vw`;
        
        // Dura√ß√£o da anima√ß√£o (velocidade) entre 3s e 8s
        const duration = Math.random() * 5 + 3;
        bubble.style.animationDuration = `${duration}s`;
        
        // Atraso inicial para n√£o subirem todas ao mesmo tempo
        bubble.style.animationDelay = `${Math.random() * 2}s`;
        
        document.body.appendChild(bubble);
        
        // Remove do DOM quando a anima√ß√£o acabar para n√£o poluir a mem√≥ria
        setTimeout(() => {
            bubble.remove();
        }, duration * 1000 + 2000);
    }
};

// ============================================================
// CORRE√á√ÉO DE FOCO E TECLADO (MOBILE)
// ============================================================
const editorTouchHandler = document.getElementById('note-content-editor');

if (editorTouchHandler) {
    editorTouchHandler.addEventListener('touchstart', (e) => {
        const target = e.target;

        // 1. SE TOCOU NA √ÅREA DE TEXTO (Conte√∫do)
        if (target.classList.contains('mini-note-content') || 
            target.classList.contains('redator-content') ||
            target.classList.contains('toggle-content') ||
            target.closest('.mini-note-content') ||
            target.closest('.redator-content')) {
            
            // A. P√°ra a propaga√ß√£o.
            // Isto impede que a caixa pai (o wrapper) receba o toque e tente arrastar/selecionar tudo.
            e.stopPropagation(); 
            
            // B. Identifica o elemento exato
            const editableDiv = target.classList.contains('mini-note-content') || target.classList.contains('redator-content') 
                                ? target 
                                : target.closest('[contenteditable="true"]');

            if (editableDiv) {
                // C. For√ßa o foco imediatamente
                editableDiv.focus();
                
                // D. Truque para abrir o teclado em alguns Androids teimosos
                // Se o elemento estiver vazio, simulamos uma sele√ß√£o
                if (editableDiv.innerText.trim() === "") {
                    const range = document.createRange();
                    range.selectNodeContents(editableDiv);
                    range.collapse(false);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
            // NOTA: N√£o usamos e.preventDefault() aqui para permitir que o teclado nativo abra
            return;
        }

        // 2. SE TOCOU EM BOT√ïES (A√ß√£o sem teclado)
        if (target.closest('button')) {
            const btn = target.closest('button');
            // Se for bot√£o de ferramentas, a√≠ sim prevenimos o foco
            if (btn.closest('.mini-note-toolbar') || btn.closest('.redator-dock')) {
                e.preventDefault(); 
                e.stopPropagation(); 
                btn.click(); 
            }
        }
    }, { passive: false });
}

// ============================================================
// CORRE√á√ÉO SUPREMA DE FOCO E MENU NATIVO (MOBILE)
// ============================================================

// 1. Impedir que o "Long Press" (Menu de contexto) seja bloqueado em √°reas de texto
window.addEventListener('contextmenu', (e) => {
    const target = e.target;

    // 1. Verifica se √© um campo de Input/T√≠tulo
    const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
    
    // 2. Verifica se √© o pr√≥prio Editor ou um Par√°grafo de texto
    const isEditorBody = target.id === 'note-content-editor';
    const isParagraph = target.tagName === 'P' || target.tagName === 'SPAN' || target.tagName === 'DIV';
    
    // 3. Verifica se o elemento (ou pai) √© edit√°vel
    const isContentEditable = target.isContentEditable || (target.closest && target.closest('[contenteditable="true"]'));

    // SE FOR QUALQUER UM DESTES CASOS, PERMITE O MENU NATIVO
    if (isInput || (isContentEditable && (isEditorBody || isParagraph))) {
        
        // P√°ra a propaga√ß√£o para que o nosso menu personalizado (dos 3 pontos) n√£o tente abrir por cima
        e.stopPropagation(); 
        
        // Retorna true para dizer ao navegador "Podes abrir o teu menu"
        return true; 
    }

    // Caso contr√°rio (ex: clicou na borda de uma caixa), deixa o comportamento padr√£o ou bloqueia se quiser
}, true); // 'true' d√° prioridade a este evento sobre outros

// 2. FOR√áAR O FOCO NO TOQUE (TOUCHSTART)
const editorMobileFix = document.getElementById('note-content-editor');

if (editorMobileFix) {
    
    // Vari√°veis para medir se o dedo se mexeu
    let touchStartY = 0;
    let touchStartX = 0;
    let isScrolling = false;

    // 1. IN√çCIO DO TOQUE: Apenas registamos a posi√ß√£o, N√ÉO FOCAMOS AINDA
    editorMobileFix.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
        isScrolling = false; // Assumimos que √© um clique at√© prova em contr√°rio

        // NOTA: Removemos o e.stopPropagation() daqui para permitir que o 
        // browser inicie o scroll nativo se o utilizador arrastar o dedo.
    }, { passive: true }); // 'passive: true' melhora a performance do scroll

    // 2. MOVIMENTO: Se o dedo mexer mais de 10px, √© Scroll
    editorMobileFix.addEventListener('touchmove', (e) => {
        const moveY = e.touches[0].clientY;
        const moveX = e.touches[0].clientX;

        // Se a diferen√ßa for maior que 10px, consideramos que est√° a fazer scroll
        if (Math.abs(moveY - touchStartY) > 10 || Math.abs(moveX - touchStartX) > 10) {
            isScrolling = true;
        }
    }, { passive: true });

    // 3. FIM DO TOQUE: Decis√£o (Abrir Teclado ou N√£o?)
    editorMobileFix.addEventListener('touchend', (e) => {
        const target = e.target;

        // Se o utilizador fez SCROLL, n√£o fazemos nada (o teclado n√£o abre)
        if (isScrolling) return;

        // --- SE FOI UM TOQUE R√ÅPIDO (TAP) ---
        
        // Verifica se tocou num Input ou Texto Edit√°vel
        const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
        const isEditableDiv = target.isContentEditable || (target.closest && target.closest('[contenteditable="true"]'));

        if (isInput || isEditableDiv) {
            // AQUI SIM: Como foi um toque parado, for√ßamos o foco para abrir o teclado
            // e paramos a propaga√ß√£o para a caixa n√£o tentar arrastar.
            
            // Pequeno delay para garantir que o browser n√£o est√° confuso com eventos de clique
            setTimeout(() => {
                if (document.activeElement !== target) {
                    target.focus();
                }
            }, 10);
            
            // Se for um Input de t√≠tulo, isto ajuda a garantir que o teclado abre no iOS
            if (isInput) {
                e.stopPropagation(); 
            }
        }
    });
}

// ============================================================
// SISTEMA DE GPS DE CURSOR (DOM PATH) - CORRE√á√ÉO PROFISSIONAL
// ============================================================

window.lastCursorGPS = {
    active: false,
    containerId: null,
    editableClass: null,
    path: [],
    offset: 0,
    timestamp: 0
};

function trackCursorPosition(e) {
    const eventType = e ? e.type : 'manual';
    if (eventType === 'mousemove') return;

    // 1. INPUTS (T√≠tulo)
    const activeEl = document.activeElement;
    if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
        const wrapper = activeEl.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card');
        if (wrapper && wrapper.id) {
            window.lastCursorGPS = {
                active: true,
                type: 'input',
                containerId: wrapper.id,
                path: [], 
                offset: 0,
                timestamp: Date.now()
            };
            return;
        }
    }

    // 2. CONTE√öDO (Divs)
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const anchorNode = selection.anchorNode;
    const element = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;

    const contentDiv = element.closest('[contenteditable="true"]');
    const wrapper = element.closest('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, details.toggle-section');

    if (contentDiv && wrapper && wrapper.id) {
        const path = [];
        let currentNode = anchorNode;
        while (currentNode && currentNode !== contentDiv) {
            const parent = currentNode.parentNode;
            if (!parent) break;
            const index = Array.prototype.indexOf.call(parent.childNodes, currentNode);
            path.unshift(index);
            currentNode = parent;
        }

        let targetClass = "";
        if (contentDiv.classList.contains('mini-note-content')) targetClass = '.mini-note-content';
        else if (contentDiv.classList.contains('redator-content')) targetClass = '.redator-content';
        else if (contentDiv.classList.contains('toggle-content')) targetClass = '.toggle-content';
        else if (contentDiv.classList.contains('sign-content')) targetClass = '.sign-content';
        else if (contentDiv.classList.contains('cube-content')) targetClass = '.cube-content';
        else if (contentDiv.classList.contains('card-desc-content')) targetClass = '.card-desc-content';

        window.lastCursorGPS = {
            active: true,
            type: 'content',
            containerId: wrapper.id,
            editableClass: targetClass,
            path: path,
            offset: selection.anchorOffset,
            timestamp: Date.now()
        };
        return;
    }

    // 3. ZONA SEGURA (Nota Principal) -> Desativa o GPS
    if (element.id === 'note-content-editor' || element.closest('#note-content-editor')) {
        window.lastCursorGPS.active = false; 
        window.lastCursorGPS.containerId = null;
    }
}



// 2. FUN√á√ÉO DE RESTAURO (Navega pelo HTML para achar o s√≠tio)
function restoreCursorFromGPS() {
    if (!window.lastCursorGPS.active) return;
    
    const gps = window.lastCursorGPS;
    const wrapper = document.getElementById(gps.containerId);

    if (!wrapper) return; 

    // --- RESTAURAR INPUT ---
    if (gps.type === 'input') {
        const input = wrapper.querySelector('input, textarea');
        if (input) {
            input.focus();
        }
    }

    // --- RESTAURAR CONTE√öDO ---
    else if (gps.type === 'content') {
        let contentDiv = null;
        if (gps.editableClass) contentDiv = wrapper.querySelector(gps.editableClass);
        if (!contentDiv) contentDiv = wrapper.querySelector('[contenteditable="true"]');

        if (contentDiv) {
            contentDiv.focus();

            let targetNode = contentDiv;
            let pathValid = true;

            for (const index of gps.path) {
                if (targetNode.childNodes && targetNode.childNodes[index]) {
                    targetNode = targetNode.childNodes[index];
                } else {
                    pathValid = false;
                    break;
                }
            }

            const sel = window.getSelection();
            const range = document.createRange();

            if (pathValid) {
                try {
                    const maxOffset = targetNode.length || targetNode.childNodes.length || 0;
                    const safeOffset = Math.min(gps.offset, maxOffset);
                    range.setStart(targetNode, safeOffset);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } catch (e) {
                    placeCaretAtEnd(contentDiv);
                }
            } else {
                placeCaretAtEnd(contentDiv);
            }
        }
    }
}

// Auxiliar para colocar cursor no fim
function placeCaretAtEnd(el) {
    el.focus();
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
}

// 3. LISTENERS CONSTANTES (Para manter o GPS atualizado)
const editorForGPS = document.getElementById('note-content-editor');

if (editorForGPS) {
    // Passamos a fun√ß√£o diretamente para receber o argumento 'e'
    editorForGPS.addEventListener('keyup', trackCursorPosition);
    editorForGPS.addEventListener('mouseup', trackCursorPosition);
    editorForGPS.addEventListener('input', trackCursorPosition);
    
    // O evento CR√çTICO para a sua corre√ß√£o
    editorForGPS.addEventListener('mousedown', trackCursorPosition);
    
    editorForGPS.addEventListener('touchend', (e) => setTimeout(() => trackCursorPosition(e), 100));
}

// 4. GATILHO DE REGRESSO (Quando volta √† aba)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        const aquariumEnv = document.getElementById('aquarium-environment');
        
        // Verifica se o Aqu√°rio est√° vis√≠vel
        if (aquariumEnv && aquariumEnv.style.display !== 'none' && selectedNoteId) {
            console.log("üåä [SA√çDA] Aba escondida. A gravar Aqu√°rio imediatamente...");
            
            // Limpa o timer de 2 minutos para n√£o gravar duas vezes
            if (typeof aqAutoSaveTimer !== 'undefined') clearTimeout(aqAutoSaveTimer);
            
            // Grava J√Å
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
    }
});


// Gravar ao Fechar Janela ou Refresh (Aviso de Seguran√ßa)
window.addEventListener('beforeunload', (event) => {
    const aquariumEnv = document.getElementById('aquarium-environment');
    if (aquariumEnv && aquariumEnv.style.display !== 'none') {
        // Verifica se h√° texto pendente
        const aqStatus = document.getElementById('aq-save-status');
        
        if (aqStatus && (aqStatus.textContent === 'por guardar...' || aqStatus.textContent === 'A guardar...')) {
            console.log("üåä [REFRESH] Aqu√°rio por guardar. For√ßando...");
            // Dispara grava√ß√£o (Best Effort)
            window.saveAquariumState();
            
            // (Opcional) Pede confirma√ß√£o ao browser se a grava√ß√£o demorar
            // event.preventDefault();
            // event.returnValue = ''; 
        }
    }
});

// Gravar ao fechar a janela
window.addEventListener('beforeunload', () => {
    if (activeEditingPostId || window.activeEditingPostId) {
        // Tenta gravar s√≠ncronamente (best effort)
        forceUnlockAndSaveOnExit();
    }
});




// Refor√ßo ao focar a janela
window.addEventListener('focus', () => {
    // Mesma prote√ß√£o para o evento de foco da janela
    const linkModal = document.getElementById('link-modal');
    if (linkModal && linkModal.style.display !== 'none') return;
    
    // (Opcional: Pode adicionar as outras verifica√ß√µes aqui tamb√©m se necess√°rio, 
    // mas o link-modal √© o mais cr√≠tico porque tem inputs de texto)

    setTimeout(restoreCursorFromGPS, 150);
});
// ============================================================
// MOTOR DE SCROLLSPY (√çNDICE AUTOM√ÅTICO) - VERS√ÉO √öNICA
// ============================================================

// Vari√°vel de controlo (s√≥ pode haver uma destas no c√≥digo todo)
// Se j√° tiver "let currentActiveScrollId" l√° em cima nas vari√°veis globais, apague esta linha.
// Se n√£o tiver, deixe estar.
var currentActiveScrollId = null; 

// 1. OUVINTE DE SCROLL NO EDITOR
const spyEditor = document.getElementById('note-content-editor');

if (spyEditor) {
    // Removemos listener antigo para garantir que n√£o duplica
    spyEditor.onscroll = null; 
    
    spyEditor.addEventListener('scroll', () => {
        // Usa requestAnimationFrame para ser suave e n√£o travar o browser
        requestAnimationFrame(detectActiveScrollElement);
    });
}

// 2. FUN√á√ÉO DE C√ÅLCULO
function detectActiveScrollElement() {
    const editor = document.getElementById('note-content-editor');
    const list = document.getElementById('note-index-list');
    
    // S√≥ executa se a lista do √≠ndice estiver vis√≠vel no ecr√£
    // (Ou se estivermos no mobile com o modal aberto)
    const isMobileModalOpen = document.getElementById('mobile-views-modal')?.style.display === 'flex';
    if (!editor || (!isMobileModalOpen && (!list || list.style.display === 'none'))) return;

    // Seleciona todos os itens que aparecem no √≠ndice
    const targets = editor.querySelectorAll('.mini-note-wrapper, .redator-wrapper, details.toggle-section, .jwn-table-wrapper, .jwn-timeline-wrapper, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .post-it-note');
    
    if (targets.length === 0) return;

    // Ponto de gatilho: 150px abaixo do topo do editor (zona de leitura)
    const triggerPoint = editor.scrollTop + 150; 
    
    let activeId = null;

    // A. Verifica se chegou ao fundo da p√°gina (Seleciona o √∫ltimo obrigatoriamente)
    // Margem de 50px para garantir
    if (Math.ceil(editor.scrollTop + editor.clientHeight) >= editor.scrollHeight - 50) {
        const lastItem = targets[targets.length - 1];
        activeId = lastItem.id;
    } 
    // B. C√°lculo normal
    else {
        for (let i = 0; i < targets.length; i++) {
            const el = targets[i];
            // Se a posi√ß√£o do elemento for menor que a linha de leitura, √© o candidato atual
            if (el.offsetTop < triggerPoint) {
                activeId = el.id; 
            } else {
                // Se j√° passou, paramos. O anterior era o correto.
                break; 
            }
        }
    }

    // Se estamos no topo e nada passou a linha, ativa o primeiro
    if (!activeId && targets.length > 0) {
        activeId = targets[0].id;
    }

    // S√≥ atualiza o visual se o ID mudou (Performance)
    if (activeId && currentActiveScrollId !== activeId) {
        currentActiveScrollId = activeId;
        updateIndexVisuals();
    }
}

// 3. ATUALIZA√á√ÉO VISUAL (Pinta de Azul e Mexe a Lista)
function updateIndexVisuals() {
    // Tenta atualizar a lista do PC
    const pcList = document.getElementById('note-index-list');
    applyVisualsToList(pcList);

    // Tenta atualizar a lista do Mobile (se o modal estiver aberto)
    const mobileList = document.getElementById('mobile-views-content');
    if (mobileList) {
        applyVisualsToList(mobileList);
    }
}

// Fun√ß√£o auxiliar para aplicar o estilo em qualquer lista
function applyVisualsToList(listContainer) {
    if (!listContainer || listContainer.style.display === 'none') return;

    // 1. Limpa apenas o ESTILO DE SELE√á√ÉO (Fundo), mantendo a borda original
    listContainer.querySelectorAll('.index-item').forEach(li => {
        li.classList.remove('active-scroll');
        li.style.backgroundColor = ""; 
        // NOTA: Removemos a linha que limpava o borderLeft
    });

    // 2. Aplica novo estilo de sele√ß√£o (Apenas Fundo)
    if (currentActiveScrollId) {
        const activeLi = listContainer.querySelector(`.index-item[data-target-id="${currentActiveScrollId}"]`);
        
        if (activeLi) {
            activeLi.classList.add('active-scroll');
            // Fundo azul suave para indicar onde estamos
            activeLi.style.backgroundColor = "rgba(74, 144, 226, 0.15)"; 
            
            // Opcional: Se quiseres que a borda fique "Brilhante" ou "Mais Grossa" ao selecionar:
            // activeLi.style.borderLeftWidth = "6px"; 
            
            // --- A M√ÅGICA: OBRIGA A LISTA A RODAR ---
            activeLi.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Fun√ß√£o para carregar itens da aba Flash
function loadFlashItems() {
    const listElement = document.getElementById('file-list');
    if (!auth.currentUser) return;

    listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div><span>A carregar Flash...</span></div>';

    // Query para buscar TUDO o que tem "oque == 'flash'", independentemente da pasta
    const q = query(
        collection(db, 'pastas'),
        where('userId', '==', auth.currentUser.uid),
        where('oque', '==', 'flash'), // FILTRO CR√çTICO
        where('estado', '==', 'ativa'),
        orderBy('ultimaedicao', 'desc') // Ordenar por mais recente primeiro
    );

    // Usa onSnapshot para atualiza√ß√£o em tempo real
    unsubscribeMiddlePanel = onSnapshot(q, (querySnapshot) => {
        listElement.innerHTML = '';
        
        if (querySnapshot.empty) {
            listElement.innerHTML = `
                <li style="padding:40px 20px; text-align:center; color:#e67e22; list-style:none;">
                    <div style="font-size:30px; margin-bottom:10px;">‚ö°</div>
                    <strong>Sem Itens Flash</strong><br>
                    <small style="color:var(--text-muted-color);">Tudo o que criar aqui aparecer√° nesta lista r√°pida.</small>
                </li>`;
            return;
        }

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.className = 'list-item';
            
            // Adiciona a classe para borda laranja se estiver selecionado
            if (item.id === selectedNoteId) li.classList.add('selected-orange'); // Vamos criar este estilo CSS
            
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo);
            li.setAttribute('data-name', item.nome);
            li.setAttribute('data-oque', item.oque || ""); 
            
            // √çcone baseado no tipo
            let icon = 'üìÑ';
            if (item.tipo === 'jornal') icon = 'üì∞';
            
            li.innerHTML = `<span>${icon} ${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            // L√≥gica de clique (igual √† normal)
            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                
                // Limpa sele√ß√µes
                listElement.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red', 'selected-orange'));
                li.classList.add('selected-orange');
                
                if (window.innerWidth <= 768) {
                    document.body.classList.add('mobile-view-editor');
                }
                
                displayNote(item.id, li);
            };

            listElement.appendChild(li);
        });
    });
}

function loadFlashListLeftPanel() {
    const listElement = document.getElementById('left-panel-list');
    if (!auth.currentUser) return;

    listElement.innerHTML = `
        <div class="panel-loader">
            <div class="spinner"></div>
            <span>A carregar Flash...</span>
        </div>`;

    const q = query(
        collection(db, 'pastas'),
        where('userId', '==', auth.currentUser.uid),
        where('oque', '==', 'flash'),
        where('estado', '==', 'ativa'),
        orderBy('ultimaedicao', 'desc')
    );

    unsubscribeLeftPanel = onSnapshot(q, (querySnapshot) => {
        const fragment = document.createDocumentFragment();
        
        if (querySnapshot.empty) {
            listElement.innerHTML = `
                <li style="padding:20px; text-align:center; color:#666; font-style:italic;">
                    Sem itens Flash.
                </li>`;
            return;
        }

        let currentMonthYear = null;

        querySnapshot.forEach((doc) => {
            const item = { id: doc.id, ...doc.data() };
            
            // L√≥gica de cabe√ßalho de data
            const timestamp = item.ultimaedicao?.toMillis() || item.createdAt?.toMillis() || Date.now();
            const dateObj = new Date(timestamp);
            const monthYearString = dateObj.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
            
            if (monthYearString !== currentMonthYear) {
                currentMonthYear = monthYearString;
                const headerLi = document.createElement('li');
                headerLi.style.cssText = `font-size: 10px; text-transform: uppercase; color: var(--text-muted-color); font-weight: bold; padding: 15px 10px 5px 10px; letter-spacing: 1px; cursor: default; pointer-events: none; opacity: 0.6;`;
                headerLi.textContent = monthYearString;
                fragment.appendChild(headerLi);
            }

            const li = document.createElement('li');
            li.className = 'list-item';
            li.style.borderLeft = "4px solid #e67e22"; 
            
            // Sele√ß√£o visual (Aplicada em Mem√≥ria)
            if (item.id === selectedNoteId) li.classList.add('selected-orange');
            
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.tipo); 
            li.setAttribute('data-name', item.nome);

            // CORRE√á√ÉO AQUI: Removemos a vari√°vel 'icon' do HTML
            // O CSS encarrega-se de mostrar o √≠cone via 'data-type'
            li.innerHTML = `<span>${item.nome}</span><button class="item-menu-btn">‚Ä¶</button>`;

            li.onclick = (e) => {
                if (e.target.closest('.item-menu-btn')) return;
                document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red', 'selected-orange'));
                li.classList.add('selected-orange');
                displayNote(item.id, li);
                if (window.innerWidth <= 768) document.body.classList.add('mobile-view-editor');
            };
            fragment.appendChild(li);
        });

        // Renderiza√ß√£o Final
        listElement.innerHTML = '';
        listElement.appendChild(fragment);
    });
}

function startGlobalNotificationListener() {
    if (!auth.currentUser) return;
    const myUid = auth.currentUser.uid;

    // 1. OUVINTE DE LEITURAS (O que eu j√° vi)
    onSnapshot(collection(db, 'users', myUid, 'archive_reads'), (readSnap) => {
        const lastSeenMap = {};
        readSnap.forEach(doc => {
            lastSeenMap[doc.id] = doc.data().lastSeen || 0;
        });
        
        // Atualiza a mem√≥ria
        userLastSeenArchives = lastSeenMap;
        
        // Recalcula a bola
        recalcGlobalNotification();
    });

    // 2. OUVINTE DE PASTAS (O que existe)
    const q1 = query(
        collection(db, 'pastas'), 
        where('tipo', 'in', ['partilhado', 'arquivo']), 
        where('estado', '==', 'ativa')
    );
    
    onSnapshot(q1, (folderSnap) => {
        const folders = [];
        folderSnap.forEach(doc => {
            folders.push({ id: doc.id, ...doc.data() });
        });

        // Atualiza a mem√≥ria
        globalFoldersCache = folders;

        // Recalcula a bola
        recalcGlobalNotification();
    });
}

// 3. FUN√á√ÉO DE C√ÅLCULO CENTRALIZADA
function recalcGlobalNotification() {
    if (!auth.currentUser) return;
    
    const myUid = auth.currentUser.uid;
    let totalUnreadGlobal = 0;
    const TIME_BUFFER = 2000; 

    // Limpa contagens anteriores
    window.folderUnreadCounts = {};

    globalFoldersCache.forEach(folder => {
        if (folder.tipo !== 'partilhado') return;

        const isOwner = folder.userId === myUid;
        const isCollab = folder.colaboradores && folder.colaboradores[myUid];

        if (isOwner || isCollab) {
            const myLastSeen = userLastSeenArchives[folder.id] || 0;
            
            // Verifica a √∫ltima edi√ß√£o da pasta inteira
            const folderLastUpdate = folder.ultimaedicao?.toMillis 
                                   ? folder.ultimaedicao.toMillis() 
                                   : (folder.ultimaedicao || 0);

            // Se houve movimento recente que n√£o foi meu
            if (folderLastUpdate > (myLastSeen + TIME_BUFFER)) {
                const lastEditor = folder.lastEditorId || "unknown";
                
                if (lastEditor !== myUid) {
                    // C√ÅLCULO ESTIMADO: 
                    // Como n√£o podemos ler todos os posts de todas as pastas sem gastar muita quota,
                    // marcamos com "1+" se houver update.
                    // Se a pasta estiver aberta em mem√≥ria (currentArchiveData), podemos contar exato.
                    
                    let count = 1; // Pelo menos 1 altera√ß√£o houve
                    
                    // Se temos os dados desta pasta carregados, contamos exatamente
                    if (currentArchiveId === folder.id && currentArchiveData && currentArchiveData.posts) {
                         count = currentArchiveData.posts.filter(p => {
                            const pUp = p.updatedAt?.toMillis ? p.updatedAt.toMillis() : p.updatedAt;
                            const pUser = p.lastEditorId || p.userId;
                            return pUp > myLastSeen && pUser !== myUid;
                         }).length;
                         
                         if (count === 0) count = 1; // Fallback se o update for no metadado
                    }

                    window.folderUnreadCounts[folder.id] = count;
                    totalUnreadGlobal += count;
                }
            }
        }
    });

    // Atualiza a bola vermelha da Aba "Partilhado"
    hasGlobalShareNotification = totalUnreadGlobal > 0;
    updateShareTabDot();
    
    // Se a lista do meio estiver vis√≠vel, atualiza os n√∫meros l√° tamb√©m
    if (currentViewMode === 'shared') {
        loadSharedFilesRoot(); // Re-renderiza a lista para mostrar os n√∫meros
    }
}

// Fun√ß√£o visual (Mant√©m-se igual, mas garante que existe)
function updateShareTabDot() {
    // Procura o elemento da aba Share
    const shareTabs = document.querySelectorAll('.folder-mode-item');
    
    shareTabs.forEach(tab => {
        // >>> ALTERA√á√ÉO AQUI: Procura por 'Share' em vez de 'Partilha' <<<
        if (tab.textContent.includes('Share')) {
            let dot = tab.querySelector('.tab-notification-dot');
            if (!dot) {
                dot = document.createElement('div');
                dot.className = 'tab-notification-dot';
                tab.appendChild(dot);
            }

            if (hasGlobalShareNotification) {
                dot.classList.add('visible');
            } else {
                dot.classList.remove('visible');
            }
        }
    });
}

// Fun√ß√£o para limpar refer√™ncias de uma nota inteira em todas as entidades conectadas
async function cleanUpHiddenNoteReferences(noteId) {
    if (!noteId) return;
    console.log(`üßπ [LIMPEZA GLOBAL] Removendo refer√™ncias da nota ${noteId} nos Puzzles...`);

    try {
        const { collection, query, where, getDocs, doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const myUid = auth.currentUser.uid;

        // Lista de cole√ß√µes que podem ter Puzzles
        const collectionsToCheck = ['textosbiblicos', 'topicos', 'personagens', 'locais', 'cosmos', 'subcosmos'];

        for (const colName of collectionsToCheck) {
            // Procura entidades que tenham esta nota referenciada
            const q = query(
                collection(db, colName),
                where(`referencias.${noteId}`, '==', true),
                where('userId', '==', myUid)
            );

            const snap = await getDocs(q);

            // Processa em paralelo
            const updatePromises = snap.docs.map(async (docSnap) => {
                const data = docSnap.data();
                let puzzleBoard = data.puzzleBoard || [];
                const initialLen = puzzleBoard.length;

                // Remove TODOS os cart√µes que venham desta nota
                puzzleBoard = puzzleBoard.filter(item => item.noteId !== noteId);

                if (puzzleBoard.length !== initialLen) {
                    console.log(`   - Atualizando entidade: ${data.nome} (${colName})`);
                    const docRef = doc(db, colName, docSnap.id);
                     // Atualiza
    await updateDoc(docRef, { puzzleBoard: puzzleBoard });

    // >>> LINHA NOVA: Verifica se ficou vazio <<<
    if (colName === 'textosbiblicos') {
        await checkAndCleanVerseState(docSnap.id);
    }
                    
                    return updateDoc(docRef, { puzzleBoard: puzzleBoard });
                }
            });

            await Promise.all(updatePromises);
        }
        console.log("‚úÖ Limpeza global conclu√≠da.");

    } catch (e) {
        console.error("‚ùå Erro na limpeza global:", e);
    }
}

// --- CONFIGURA√á√ÉO DA PESQUISA DE CATEGORIAS (ABRIR COM O ‚ö°) ---

// 1. Listener para quando se escreve na caixa de texto
const catSearchInput = document.getElementById('category-search-input');
if (catSearchInput) {
    // Removemos clones antigos para evitar duplicar pesquisas
    const newInput = catSearchInput.cloneNode(true);
    catSearchInput.parentNode.replaceChild(newInput, catSearchInput);

    newInput.addEventListener('input', (e) => {
        // Chama a fun√ß√£o de pesquisa com o que est√° escrito
        searchCategories(e.target.value);
    });
}

// 2. Listener para o Toggle (Interruptor) da B√≠blia
const bibleSearchToggle = document.getElementById('search-bible-toggle');
if (bibleSearchToggle) {
    bibleSearchToggle.addEventListener('change', () => {
        // Quando muda o interruptor, refaz a pesquisa com o texto que j√° l√° est√°
        const currentText = document.getElementById('category-search-input').value;
        searchCategories(currentText);
        
        // Foca novamente na caixa para continuar a escrever
        document.getElementById('category-search-input').focus();
    });
}

// ============================================================
// CORRE√á√ÉO: CLIQUES NOS DIAS DO CALEND√ÅRIO
// ============================================================
document.getElementById('note-content-editor').addEventListener('click', async (e) => { // <--- ADICIONADO ASYNC
    
    // 1. Encontra o SuperLink (mesmo que clique no sublinhado vermelho de erro)
    const el = e.target.closest('.superlink-dotted');
    
    if (el) {
        // --- CORRE√á√ÉO: For√ßa o fecho de qualquer menu de contexto nativo ---
        e.preventDefault(); 
        e.stopPropagation();
        
        const id = el.dataset.slId;
        const isSource = el.classList.contains('source');
        
        console.log(`üñáÔ∏è Clique em SuperLink (Corre√ß√£o). ID: ${id}`);

        // 2. DEFINE O ALVO DO SALTO
        let targetEl = null;

        if (isSource) {
            targetEl = document.querySelector(`.superlink-dotted.target[data-sl-id="${id}"]`);
        } else {
            targetEl = document.querySelector(`.superlink-dotted.source[data-sl-id="${id}"]`);
            
            if (!targetEl) {
                const allTargets = Array.from(document.querySelectorAll(`.superlink-dotted.target[data-sl-id="${id}"]`));
                const currentIndex = allTargets.indexOf(el);
                const nextIndex = (currentIndex + 1) % allTargets.length;
                targetEl = allTargets[nextIndex];
                if (targetEl === el) targetEl = null;
            }
        }
        
        // 3. EXECU√á√ÉO
        if (targetEl) {
            // Scroll e Flash
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetEl.style.transition = "background-color 0.3s ease, color 0.3s ease";
            
            const oldBg = targetEl.style.backgroundColor;
            const oldColor = targetEl.style.color;

            targetEl.style.backgroundColor = "#e67e22"; 
            targetEl.style.color = "white";
            targetEl.style.boxShadow = "0 0 15px rgba(230, 126, 34, 0.6)";
            targetEl.style.borderRadius = "3px";

            setTimeout(() => { 
                targetEl.style.backgroundColor = oldBg; 
                targetEl.style.color = oldColor;
                targetEl.style.boxShadow = "none";
                setTimeout(() => { targetEl.style.transition = ""; }, 300);
            }, 1500);

        } else {
            // --- REPARA√á√ÉO AUTOM√ÅTICA COM POPUP ---
            
            // 1. Z-Index m√°ximo para garantir que aparece
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) confirmModal.style.zIndex = "2147483647";

            // 2. Chama o popup
            const fixIt = await showConfirmation(
                "Link √ìrf√£o", 
                "Este link n√£o leva a lado nenhum.\nDeseja abrir o editor para ligar frases a ele agora?"
            );

            // 3. Restaura o Z-Index
            if (confirmModal) confirmModal.style.zIndex = "";
            
            if (fixIt) {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                if (typeof window.openSourceManager === 'function') {
                    window.openSourceManager();
                }
            }
        }
    }
});

// ============================================================
// L√ìGICA DO BOT√ÉO TR√äS PONTOS (‚ãÆ) - COM PROTE√á√ÉO DE CURSOR
// ============================================================
const moreFormattingBtn = document.getElementById('more-formatting-btn');

if (moreFormattingBtn) {
    // 1. Clonar para limpar ouvintes antigos e garantir exclusividade
    const newBtn = moreFormattingBtn.cloneNode(true);
    moreFormattingBtn.parentNode.replaceChild(newBtn, moreFormattingBtn);

    // 2. OUVINTE DE MOUSEDOWN (O Segredo para n√£o perder o cursor)
    newBtn.addEventListener('mousedown', (e) => {
        // A. Esta linha impede que o bot√£o roube o foco do editor
        e.preventDefault(); 
        // B. P√°ra a propaga√ß√£o para n√£o ativar outros listeners
        e.stopPropagation();

        // C. Guarda a posi√ß√£o exata do cursor numa vari√°vel global
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const editor = document.getElementById('note-content-editor');

            // S√≥ guarda se o cursor estiver realmente dentro do editor ou de um t√≠tulo
            if (editor && editor.contains(range.commonAncestorContainer)) {
                window.journalCursorRange = range.cloneRange();
                console.log("üìç Cursor guardado antes de abrir menu.");
            }
        }
    });

    // 3. OUVINTE DE CLIQUE (Abrir o Menu)
    newBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const popup = document.getElementById('formatting-popup');
        if (!popup) return;

        const isVisible = popup.style.display === 'block';

        if (isVisible) {
            popup.style.display = 'none';
            newBtn.classList.remove('active');
        } else {
            // FOR√áA O POPUP PARA O TOPO (Body) para evitar cortes
            document.body.appendChild(popup);

            const rect = newBtn.getBoundingClientRect();
            popup.style.display = 'block';
            popup.style.position = 'fixed';
            popup.style.zIndex = "9999999";

            // Posicionamento inteligente (evita sair do ecr√£ √† direita)
            let leftPos = rect.left;
            if (leftPos + 250 > window.innerWidth) {
                leftPos = window.innerWidth - 260;
            }

            // Posiciona logo abaixo do bot√£o
            popup.style.top = `${rect.bottom + 8}px`;
            popup.style.left = `${leftPos}px`;

            newBtn.classList.add('active');
        }
    });
}

// ============================================================
// FUN√á√ÉO: CONFIRMAR E ARQUIVAR RACIOC√çNIO (ü™ß)
// ============================================================
window.confirmSignDelete = async function(btn) {
    const wrapper = btn.closest('.journal-sign-wrapper');
    if (!wrapper) return;

    // 1. AJUSTE DE Z-INDEX
    // Garante que o modal de confirma√ß√£o fica por cima de tudo
    const confirmModal = document.getElementById('confirm-modal');
    if (confirmModal) {
        confirmModal.style.setProperty('z-index', '2147483647', 'important');
    }

    // 2. MOSTRAR POPUP
    const confirmed = await showConfirmation(
        "Mover para a Reciclagem?", 
        "O Racioc√≠nio ser√° removido da nota e guardado no Hist√≥rico (Gest√£o da Nota). Deseja continuar?"
    );

    // 3. RESET DO Z-INDEX
    if (confirmModal) {
        confirmModal.style.zIndex = ""; 
    }

    // 4. SE CONFIRMADO, ARQUIVAR
    if (confirmed) {
        // Muda o √≠cone para feedback visual
        btn.textContent = "‚è≥";
        btn.style.opacity = "1";
        
        // Chama a fun√ß√£o de arquivo existente passando 'true' para saltar logs extras
        await window.archiveMiniNote(wrapper, true);
    }
};

// ============================================================
// FUN√á√ÉO EM FALTA: APAGAR CART√ÉO E CUBO (ü™™ üßä)
// ============================================================
window.deleteJournalWidget = async function(btn) {
    // 1. Procura o elemento pai (Cart√£o ou Cubo)
    const wrapper = btn.closest('.journal-id-card, .journal-cube-wrapper');

    if (!wrapper) {
        console.error("‚ùå Erro: Wrapper do widget n√£o encontrado.");
        return;
    }

    // 2. Ajuste de Z-Index para o popup aparecer por cima de tudo
    const confirmModal = document.getElementById('confirm-modal');
    if (confirmModal) {
        confirmModal.style.setProperty('z-index', '2147483647', 'important');
    }

    // 3. Define o nome do item para a mensagem
    let label = "Item";
    if (wrapper.classList.contains('journal-id-card')) label = "Cart√£o Tem√°tico";
    else if (wrapper.classList.contains('journal-cube-wrapper')) label = "Bloco Flutuante";

    // 4. Pede confirma√ß√£o
    const confirmed = await showConfirmation(
        "Mover para a Reciclagem?",
        `O ${label} ser√° removido e guardado no Hist√≥rico. Deseja continuar?`
    );

    // 5. Restaura o Z-Index
    if (confirmModal) {
        confirmModal.style.zIndex = "";
    }

    // 6. Executa o arquivo
    if (confirmed) {
        // Feedback visual tempor√°rio
        btn.textContent = "‚è≥";
        
        // Chama a fun√ß√£o principal de arquivo (que j√° atualiz√°mos para reconhecer 'card')
        await window.archiveMiniNote(wrapper, true);
    }
};

// ============================================================
// OBSERVADOR AUTOM√ÅTICO DO √çNDICE (ATUALIZA√á√ÉO EM TEMPO REAL)
// ============================================================

// 1. Configura√ß√£o do Observador
const indexObserver = new MutationObserver((mutations) => {
    const indexList = document.getElementById('note-index-list');
    
    if (!indexList || indexList.style.display === 'none') return;

    let shouldUpdate = false;

    for (const mutation of mutations) {
        if (mutation.type === 'childList') {
            if (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0) {
                
                const relevantChanges = Array.from(mutation.addedNodes).some(node => {
                    return node.nodeType === 1 && ( 
                        node.classList.contains('mini-note-wrapper') ||
                        node.classList.contains('redator-wrapper') ||
                        node.classList.contains('idea-span') || // <--- ADICIONADO AQUI
                        node.tagName === 'DETAILS' ||
                        node.classList.contains('journal-sign-wrapper') ||
                        node.classList.contains('journal-id-card') ||
                        node.classList.contains('jwn-timeline-wrapper') ||
                        node.classList.contains('jwn-table-wrapper') ||
                        node.classList.contains('post-it-note')
                    );
                });

                if (relevantChanges || mutation.removedNodes.length > 0) {
                    shouldUpdate = true;
                    break; 
                }
            }
        }
    }

    if (shouldUpdate) {
        setTimeout(() => {
            generateNoteIndex();
            if (typeof updateIndexVisuals === 'function') updateIndexVisuals();
        }, 100);
    }
});


// 4. Ligar o Observador ao Editor
const editorToObserve = document.getElementById('note-content-editor');

if (editorToObserve) {
    indexObserver.observe(editorToObserve, { 
        childList: true, // Vigia adi√ß√£o/remo√ß√£o de filhos diretos
        subtree: true    // Vigia tamb√©m dentro de divs (caso a estrutura seja complexa)
    });
}

window.manageAquariumTextLink = function(existingLinkElement, registryData = null) {
    const modal = document.getElementById('text-link-modal');
    const titleInput = document.getElementById('text-link-name');
    const listContainer = document.getElementById('text-link-list');
    const addBtn = document.getElementById('add-text-url-btn');
    const saveBtn = document.getElementById('save-text-link-btn');
    const actionsDiv = modal.querySelector('.modal-actions');

    if (!modal) return;

    // 1. Guardar sele√ß√£o
    const selection = window.getSelection();
    let savedRange = null;
    if (selection.rangeCount > 0) {
        savedRange = selection.getRangeAt(0).cloneRange();
    }

    // 2. Preparar Interface
    listContainer.innerHTML = ''; 
    
    const addRow = (value = "") => {
        const div = document.createElement('div');
        div.className = 'dynamic-url-row';
        const openBtn = value ? `<button class="btn-remove-url" style="border-color:#555; color:#888;" onclick="window.open('${value}', '_blank')" title="Testar Link">‚Üó</button>` : '';
        div.innerHTML = `
            <input type="text" placeholder="https://..." value="${value}">
            ${openBtn}
            <button class="btn-remove-url" onclick="this.parentElement.remove()" title="Remover Link">√ó</button>
        `;
        listContainer.appendChild(div);
        if (!value) setTimeout(() => div.querySelector('input').focus(), 50);
    };

    // 3. Preencher Dados
    let linkUID = null;
    let initialData = { title: "", urls: [] };

    if (existingLinkElement) {
        linkUID = existingLinkElement.dataset.uid || `lnk_${Date.now()}`;
        const rawJson = existingLinkElement.dataset.json;
        try {
            if (rawJson) initialData = JSON.parse(decodeURIComponent(rawJson));
            else initialData.urls = [existingLinkElement.href];
        } catch(e) {}
        
        // Usa o t√≠tulo guardado no JSON, ou o texto se n√£o houver t√≠tulo ainda
        initialData.title = initialData.title || existingLinkElement.textContent;
    } 
    else if (registryData) {
        linkUID = registryData.uid;
        initialData = registryData;
    }
    else {
        linkUID = `lnk_${Date.now()}`;
        initialData.title = selection.toString().trim();
    }

    titleInput.value = initialData.title;
    
    if (initialData.urls && initialData.urls.length > 0) {
        initialData.urls.forEach(url => addRow(url));
    } else {
        addRow();
    }

    // 4. Mostrar Modal
    document.body.appendChild(modal);
    modal.style.setProperty('display', 'flex', 'important');
    modal.style.zIndex = "2147483647";
    modal.style.opacity = "1";
    modal.style.visibility = "visible";

    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.onclick = (e) => { e.preventDefault(); addRow(); };

    // 5. INJETAR BOT√ÉO DE ELIMINAR (Mant√©m a l√≥gica anterior)
    const oldDelBtn = actionsDiv.querySelector('.btn-delete-link-ref');
    if (oldDelBtn) oldDelBtn.remove();

    if (existingLinkElement || registryData) {
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete-link-ref';
        delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.title = "Apagar Refer√™ncia";
        actionsDiv.insertBefore(delBtn, actionsDiv.firstChild);

        delBtn.onclick = async () => {
            const confirmModal = document.getElementById('confirm-modal');
            if (confirmModal) confirmModal.style.zIndex = "2147483650";
            const confirmed = await showConfirmation("Apagar Refer√™ncia?", "Remover o link e o registo?");
            if (confirmModal) confirmModal.style.zIndex = "";

            if (confirmed) {
                const { doc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                const noteRef = doc(db, 'pastas', selectedNoteId);
                await updateDoc(noteRef, { [`textLinksRegistry.${linkUID}`]: deleteField() });

                if (existingLinkElement) {
                    const textNode = document.createTextNode(existingLinkElement.textContent);
                    existingLinkElement.replaceWith(textNode);
                } else {
                    const orphan = document.querySelector(`a[data-uid="${linkUID}"]`);
                    if (orphan) {
                        const tNode = document.createTextNode(orphan.textContent);
                        orphan.replaceWith(tNode);
                    }
                }
                if (typeof saveAquariumState === 'function') await window.saveAquariumState();
                const linksTab = document.querySelector('.aq-tab[data-tab="links"]');
                if (linksTab && linksTab.classList.contains('active')) {
                     if (typeof window.renderAquariumLinks === 'function') window.renderAquariumLinks();
                }
                modal.style.display = 'none';
            }
        };
    }

    // 6. BOT√ÉO GRAVAR (CORRIGIDO)
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    newSaveBtn.onclick = async () => {
        const titleVal = titleInput.value.trim();
        const urls = [];
        listContainer.querySelectorAll('input').forEach(inp => {
            let u = inp.value.trim();
            if (u) {
                if (!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (savedRange) {
            selection.removeAllRanges();
            selection.addRange(savedRange);
        }

        const { doc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const noteRef = doc(db, 'pastas', selectedNoteId);

        if (urls.length === 0) {
            alert("A lista est√° vazia. Use o lixo para apagar.");
            return;
        } 

        const finalData = { uid: linkUID, title: titleVal, urls: urls, timestamp: Date.now() };
        const jsonString = encodeURIComponent(JSON.stringify(finalData));
        const primaryUrl = urls[0];

        // A. Atualizar Existente
        if (existingLinkElement) {
            existingLinkElement.href = primaryUrl;
            existingLinkElement.dataset.json = jsonString;
            existingLinkElement.dataset.uid = linkUID;
            existingLinkElement.className = 'silent-link';
            existingLinkElement.style.cursor = 'text';
            
            // --- CORRE√á√ÉO: N√ÉO ATUALIZA O TEXTCONTENT ---
            // existingLinkElement.textContent = titleVal; // <--- REMOVIDO
        } 
        // B. Criar Novo
        else if (!registryData) {
            const tempHref = "temp_id_" + Date.now();
            document.execCommand('createLink', false, tempHref);
            const createdAnchor = document.querySelector(`a[href="${tempHref}"]`);

            if (createdAnchor) {
                createdAnchor.href = primaryUrl;
                createdAnchor.className = 'silent-link';
                createdAnchor.dataset.uid = linkUID;
                createdAnchor.dataset.json = jsonString;
                createdAnchor.style.cursor = 'text';
                createdAnchor.target = "_blank";
                
                // --- CORRE√á√ÉO: N√ÉO FOR√áA O T√çTULO NA CRIA√á√ÉO ---
                // O texto selecionado mant√©m-se como est√°
            }
        }
        else {
             // Atualiza via Sidebar: Apenas atributos, n√£o texto visual
             const el = document.querySelector(`a[data-uid="${linkUID}"]`);
             if (el) {
                 el.dataset.json = jsonString;
                 el.href = primaryUrl;
                 // el.textContent = titleVal; // <--- REMOVIDO
             }
        }

        await updateDoc(noteRef, { [`textLinksRegistry.${linkUID}`]: finalData });

        if (typeof saveAquariumState === 'function') await window.saveAquariumState();
        
        const linksTab = document.querySelector('.aq-tab[data-tab="links"]');
        if (linksTab && linksTab.classList.contains('active')) {
             if (typeof window.renderAquariumLinks === 'function') window.renderAquariumLinks();
        }

        modal.style.display = 'none';
    };
    
    const cancelBtn = document.getElementById('cancel-text-link-btn') || modal.querySelector('.secondary');
    if(cancelBtn) cancelBtn.onclick = () => { modal.style.display = 'none'; };
};

// Listener de clique para links "Silent" no Aqu√°rio
const aqCanvasLinkHandler = document.getElementById('aquarium-content-canvas');
if (aqCanvasLinkHandler) {
    // Removemos qualquer listener antigo clonando o elemento (seguran√ßa)
    /* 
       Nota: Se j√° tiveres outros listeners importantes no canvas que n√£o queres perder, 
       n√£o fa√ßas o cloneNode. Apenas garante que apagas o c√≥digo antigo que fazia window.open.
    */
    
    aqCanvasLinkHandler.addEventListener('click', (e) => {
        const link = e.target.closest('a.silent-link');
        
        if (link) {
            // 1. IMPEDE A NAVEGA√á√ÉO (N√£o abre nova aba)
            e.preventDefault(); 
            
            // 2. O comportamento padr√£o do browser em contenteditable 
            // j√° √© colocar o cursor onde clicaste, por isso n√£o precisamos de fazer mais nada.
            // Agora podes editar o texto livremente.
        }
    });
}

// Fun√ß√£o para mover blocos no Aqu√°rio
window.moveGhostBlock = function(block, direction) {
    const parent = block.parentNode;
    
    // Mover para CIMA
    if (direction === -1) {
        const prev = block.previousElementSibling;
        if (prev && prev.classList.contains('ghost-block')) {
            // Insere o bloco atual ANTES do anterior
            parent.insertBefore(block, prev);
            
            // Scroll suave para acompanhar o movimento
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Grava
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }
    } 
    // Mover para BAIXO
    else if (direction === 1) {
        const next = block.nextElementSibling;
        if (next && next.classList.contains('ghost-block')) {
            // Insere o bloco atual DEPOIS do seguinte (ou seja, antes do "seguinte do seguinte")
            parent.insertBefore(block, next.nextSibling);
            
            // Scroll suave
            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Grava
            if (typeof window.saveAquariumState === 'function') window.saveAquariumState();
        }
    }
};

// ============================================================
// ESPI√ÉO DE CLIQUES (DIAGN√ìSTICO)
// ============================================================
document.addEventListener('click', (e) => {
    // S√≥ nos interessa cliques dentro do canvas do aqu√°rio
    if (e.target.closest('#aquarium-content-canvas')) {
        
        // Verifica se √© um dos nossos bot√µes
        if (e.target.classList.contains('ghost-move-btn')) {
        } else if (e.target.classList.contains('ghost-add-between-btn')) {
        } else {
        }
        console.groupEnd();
    }
}, true); // 'true' = Fase de captura (apanha o clique antes de qualquer outra coisa)

// ============================================================
// INTERCETOR DE CLIQUES DE CONTROLO (FOR√áA BRUTA)
// ============================================================
document.getElementById('aquarium-content-canvas').addEventListener('click', (e) => {
    // Verifica se clicou num dos nossos bot√µes rebeldes
    const target = e.target.closest('.ghost-move-btn, .ghost-add-between-btn');
    
    if (target) {

        
        // 1. P√°ra tudo o que o browser ia fazer (como p√¥r o cursor)
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // 2. Encontra o bloco pai
        const ghost = target.closest('.ghost-block');
        if (!ghost) return;

        // 3. Executa a a√ß√£o manualmente
        if (target.classList.contains('ghost-add-between-btn')) {
            window.insertBlockBelow(ghost);
        }
        else if (target.textContent === '‚ñ≤') {
            window.moveGhostBlock(ghost, -1);
        }
        else if (target.textContent === '‚ñº') {
            window.moveGhostBlock(ghost, 1);
        }
        
        return false; // Garante que morre aqui
    }
}, true); // 'true' ativa a fase de captura (acontece antes de tudo!)

const aqZoom = document.getElementById('aq-zoom');

if (aqZoom) {
    // 1. Removemos clones antigos para evitar duplica√ß√£o de eventos
    const newAqZoom = aqZoom.cloneNode(true);
    aqZoom.parentNode.replaceChild(newAqZoom, aqZoom);

    // 2. Adicionamos o novo Listener
    newAqZoom.addEventListener('change', (e) => { 
        const val = e.target.value; // Ex: '100%' ou '18px'
        const canvas = document.getElementById('aquarium-content-canvas'); 
        
        if (canvas) {
            // A. Aplica o tamanho da fonte ao contentor principal
            canvas.style.fontSize = val;
            
            // B. Ajuste de altura da linha para melhor leitura
            if (val.includes('%')) {
                 canvas.style.lineHeight = '1.6'; // Padr√£o percentual
            } else {
                 const sizeNum = parseInt(val);
                 // Se for pixels, a linha deve ser maior que a fonte (1.5x)
                 if (!isNaN(sizeNum)) {
                     canvas.style.lineHeight = (sizeNum * 1.5) + 'px';
                 }
            }
            
            // C. Grava imediatamente o estado do aqu√°rio para persistir a mudan√ßa
            if (typeof window.saveAquariumState === 'function') {
                window.saveAquariumState();
            }
        }
    });
}

// ============================================================
// CORRE√á√ÉO FINAL: ZOOM E FORMATO (PERSISTENTE)
// ============================================================

(function fixToolbarBehaviors() {
    const editor = document.getElementById('note-content-editor');
    const zoomSelect = document.getElementById('editor-zoom');
    const formatSelect = document.getElementById('editor-format');

    // 1. L√ìGICA DE ZOOM (PERCENTAGENS)
    if (zoomSelect && editor) {
        // Remove ouvintes antigos
        const newZoom = zoomSelect.cloneNode(true);
        zoomSelect.parentNode.replaceChild(newZoom, zoomSelect);

        newZoom.addEventListener('change', async (e) => {
            e.preventDefault();
            const val = newZoom.value; // Ex: "110%"
            
            // Aplica o tamanho (matem√°tica do browser trata do resto)
            editor.style.fontSize = val;
            
            // Mant√©m altura da linha confort√°vel
            editor.style.lineHeight = '1.6';
            
            // CR√çTICO: Devolve o cursor ao editor para escrever
            editor.focus();

            // Grava na base de dados
            if (typeof executeSave === 'function') {
                await executeSave();
            }
        });
    }

    // 2. L√ìGICA DE FORMATO (T√≠tulos H1, H2)
    if (formatSelect && editor) {
        const newFormat = formatSelect.cloneNode(true);
        formatSelect.parentNode.replaceChild(newFormat, formatSelect);

        newFormat.addEventListener('change', async (e) => {
            e.preventDefault();
            const tag = newFormat.value; // H1, H2, P

            // Recupera foco antes de aplicar
            editor.focus();
            
            // Aplica o formato
            document.execCommand('formatBlock', false, tag);

            // Limpa estilos antigos que possam "prender" o tamanho
            const selection = window.getSelection();
            if (selection.anchorNode) {
                let block = selection.anchorNode;
                if (block.nodeType === 3) block = block.parentNode;
                
                // Encontra o bloco atual (H1, P, etc)
                while(block && block.id !== 'note-content-editor' && block.tagName !== tag) {
                    block = block.parentNode;
                }

                if (block && block.tagName === tag) {
                    // Remove font-size fixo para respeitar o H1/H2 do tema
                    block.style.fontSize = ""; 
                    block.removeAttribute('size');
                    
                    // Limpa formata√ß√£o interna
                    block.querySelectorAll('span, font, b, i, u').forEach(child => {
                        child.style.fontSize = '';
                    });
                }
            }

            if (typeof saveNote === 'function') saveNote(true);
        });
    }
})();

// ============================================================
// 1. SYNC VISUAL (PAINEL ABERTO) - M√âTODO DOM PARSER
// ============================================================
async function syncPuzzleRealTime() {
    console.group("üîç [SYNC DEBUG] Iniciando Ciclo de Sincroniza√ß√£o");

    const puzzleContainer = document.getElementById('puzzle-board-container');
    const editor = document.getElementById('note-content-editor');
    
    if (!puzzleContainer || puzzleContainer.offsetParent === null) {
        console.log("‚ÑπÔ∏è Painel fechado. Passando para Background Sync.");
        console.groupEnd();
        await backgroundSyncCurrentPuzzle();
        return;
    }

    const cards = puzzleContainer.querySelectorAll('.board-card.type-ref');
    console.log(`üìä Cart√µes encontrados no painel: ${cards.length}`);

    let hasUpdates = false;

    cards.forEach((card, index) => {
        console.groupCollapsed(`üÉè Analisando Cart√£o #${index + 1}`);

        // 1. Ler o snippet antigo
        let snippet = "";
        try { snippet = decodeURIComponent(card.dataset.snippet || ""); } 
        catch(e) { snippet = card.dataset.snippet || ""; }

        // 2. Extrair ID usando DOM Parser
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = snippet;
        const savedWrapper = tempContainer.querySelector('[id]');
        
        if (!savedWrapper || !savedWrapper.id) {
            console.warn("‚ùå N√£o foi poss√≠vel encontrar um ID dentro do c√≥digo do cart√£o.");
            console.groupEnd();
            return;
        }

        const originalId = savedWrapper.id;
        console.log(`üÜî ID Original Identificado: "${originalId}"`);

        // 3. Buscar o elemento VIVO
        const liveEl = document.getElementById(originalId);

        if (!liveEl) {
            console.warn(`‚ùå O elemento com ID "${originalId}" N√ÉO existe no editor atual.`);
            console.groupEnd();
            return;
        }


        // 4. Extra√ß√£o de Texto (EDITOR)
        const contentEl = liveEl.querySelector('.mini-note-content, .toggle-content, .redator-content, .sign-content, .card-desc-content');
        // Normaliza espa√ßos para evitar falsos negativos (troca quebras de linha por espa√ßo)
        let editorText = contentEl ? contentEl.innerText.replace(/\s+/g, ' ').trim() : "";
        
        // Extra√ß√£o de Texto (CART√ÉO)
        const cardBodyEl = card.querySelector('.post-view-content, .bible-collapsible-content') || card.querySelector('.ref-card-content > div:last-child');
        let cardText = cardBodyEl ? cardBodyEl.textContent.replace(/\s+/g, ' ').trim() : "";

        // T√≠tulo
        const titleEl = liveEl.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
        let editorTitle = "";
        if (titleEl) editorTitle = (titleEl.value || titleEl.textContent || "").trim();

        const cardTitleEl = card.querySelector('.ref-title-text');
        let cardTitle = cardTitleEl ? cardTitleEl.textContent.trim() : "";

        // 5. COMPARA√á√ÉO (LOG CR√çTICO)
        
        const textChanged = editorText !== cardText;
        const titleChanged = editorTitle && (editorTitle !== cardTitle);


        // 6. A√á√ÉO
        if (textChanged || titleChanged) {
            
            // Atualiza Texto
            if (cardBodyEl) {
                // Limita tamanho visual
                const finalText = editorText.length > 300 ? editorText.substring(0, 300) + "..." : editorText;
                cardBodyEl.textContent = finalText;
            }
            
            // Atualiza T√≠tulo
            if (cardTitleEl && editorTitle) cardTitleEl.textContent = editorTitle;

            // Atualiza Snippet Oculto
            card.dataset.snippet = encodeURIComponent(liveEl.outerHTML);
            

            // 1. Guardar a cor original da borda esquerda antes do flash
const originalBorderLeft = card.style.borderLeft;

            // Flash Visual
            card.style.border = "2px solid #e74c3c"; // VERMELHO PARA TESTE (Bem vis√≠vel)
          setTimeout(() => { 
    card.style.border = ""; // Limpa a borda completa (vermelha)
    card.style.borderLeft = originalBorderLeft; // RESTAURA A COR ESPEC√çFICA (Laranja/Azul/Etc)
}, 1000);

            hasUpdates = true;
        } else {
        }

        console.groupEnd(); // Fim do grupo do cart√£o
    });


    console.groupEnd();

    // 7. Grava√ß√£o
    if (hasUpdates) {
        if (typeof savePuzzleData === 'function') {
            setTimeout(() => savePuzzleData(), 500);
        }
    }
}

// ============================================================
// 2. SYNC BACKGROUND (PAINEL FECHADO) - M√âTODO DOM PARSER
// ============================================================
async function backgroundSyncCurrentPuzzle() {
    if (!activeReferenceEntity || !activeReferenceEntity.id) return;
    
    const editor = document.getElementById('note-content-editor');
    if (!editor) return;

    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const colName = getCollectionFromType(activeReferenceEntity.type);
        const docRef = doc(db, colName, activeReferenceEntity.id);
        const snap = await getDoc(docRef);

        if (!snap.exists()) return;

        let board = snap.data().puzzleBoard || [];
        let changed = false;

        // Varre o array de dados
        const updatedBoard = board.map(item => {
            if (item.type === 'ref' && item.noteId === selectedNoteId) {
                try {
                    // Parser em mem√≥ria
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = decodeURIComponent(item.snippet);
                    
                    // Encontra o ID
                    const savedWrapper = tempDiv.querySelector('[id]');
                    
                    if (savedWrapper && savedWrapper.id) {
                        const liveEl = document.getElementById(savedWrapper.id);
                        
                        if (liveEl) {
                            // Compara o HTML completo novo com o antigo
                            const newHTML = liveEl.outerHTML;
                            
                            // Se o HTML mudou, atualiza o array
                            if (encodeURIComponent(newHTML) !== item.snippet) {
                                console.log(`‚òÅÔ∏è [BG] Atualizando dados de: ${savedWrapper.id}`);
                                item.snippet = encodeURIComponent(newHTML);
                                changed = true;
                            }
                        }
                    }
                } catch(err) { console.warn(err); }
            }
            return item;
        });

        // Se houve mudan√ßas, envia para o Firebase
        if (changed) {
            await updateDoc(docRef, { puzzleBoard: updatedBoard });
            console.log("‚úÖ [BG] Firebase atualizado.");
        }

    } catch (e) {
        console.error("Erro background sync:", e);
    }
}

// ============================================================
// 3. GATILHO (SAVE NOTE)
// ============================================================
const originalSaveNote = window.saveNote || saveNote;

window.saveNote = async function(forceImmediate = false) {
    // 1. Grava a nota primeiro (Prioridade)
    const res = await originalSaveNote(forceImmediate);
    
    // 2. Dispara o Sync
    await syncPuzzleRealTime();
    
    return res;
};

// ============================================================
// FOR√áA BRUTA: DETETOR DE ESCRITA DIRETO
// ============================================================

const directEditorListener = document.getElementById('note-content-editor');

if (directEditorListener) {
    let syncTimer = null;

    directEditorListener.addEventListener('input', () => {
        // Debounce: Espera 1 segundo ap√≥s parar de escrever
        clearTimeout(syncTimer);
        
        syncTimer = setTimeout(() => {
            console.log("‚ö° [FOR√áA BRUTA] Input detetado. Disparando Sync...");
            
            // Chama a fun√ß√£o de diagn√≥stico que cri√°mos
            if (typeof syncPuzzleRealTime === 'function') {
                syncPuzzleRealTime();
            } else {
                console.error("‚ùå A fun√ß√£o syncPuzzleRealTime n√£o existe!");
            }
        }, 1500); // 1.5 segundos depois de parar de escrever
    });

} else {
    console.error("‚ùå ERRO: Editor n√£o encontrado para instalar o detetor.");
}

// ============================================================
// SISTEMA DE PROPAGA√á√ÉO DE ATUALIZA√á√ïES PARA MICAS
// ============================================================
async function propagateUpdatesToMicas(noteId, fullContent) {
    console.group("üìÇ [MICAS SYNC] A propagar altera√ß√µes (Modo Cir√∫rgico)...");

    try {
        const { collection, query, where, getDocs, doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const myUid = auth.currentUser.uid;

        // 1. MAPEAR O CONTE√öDO VIVO (O que est√° no editor agora)
        const parser = new DOMParser();
        const docDOM = parser.parseFromString(fullContent, 'text/html');
        
        // Seleciona TODOS os tipos de caixas poss√≠veis
        const wrappers = docDOM.querySelectorAll('.mini-note-wrapper, .redator-wrapper, details.toggle-section, .journal-sign-wrapper, .journal-id-card, .journal-cube-wrapper, .jwn-timeline-wrapper, .jwn-table-wrapper');
        
        const liveBlocksMap = {};
        wrappers.forEach(el => {
            if (el.id) liveBlocksMap[el.id] = el.outerHTML;
        });

        // 2. LISTA DE COLE√á√ïES ONDE PODEM EXISTIR MICAS
        const collectionsToCheck = [
            'textosbiblicos', 'topicos', 'personagens', 'locais', 
            'marcadores', 'cosmos', 'subcosmos'
        ];

        let totalUpdates = 0;

        // 3. VARREDURA GLOBAL
        for (const colName of collectionsToCheck) {
            const q = query(
                collection(db, colName),
                where('userId', '==', myUid)
            );

            const snapshot = await getDocs(q);
            
            const updatePromises = snapshot.docs.map(async (docSnap) => {
                const entityData = docSnap.data();
                
                // Se n√£o tem dossi√™, passa √† frente
                if (!entityData.dossie || !Array.isArray(entityData.dossie) || entityData.dossie.length === 0) return;

                let dossieChanged = false;
                let needsReferenceFix = false;
                const dossie = entityData.dossie;

                // Loop pelas Micas (Pastas dentro da entidade)
                dossie.forEach(mica => {
                    if (!mica.items || !Array.isArray(mica.items)) return;

                    // Loop pelos Itens dentro da Mica
                    mica.items.forEach(item => {
                        // Verifica se este item pertence √† nota que estamos a editar
                        if (item.noteId === noteId) {
                            
                            // Se encontr√°mos um item desta nota, o v√≠nculo de refer√™ncia deve existir
                            if (!entityData.referencias || !entityData.referencias[noteId]) {
                                needsReferenceFix = true;
                            }

                            // --- A CORRE√á√ÉO EST√Å AQUI: ENCONTRAR O ID ESPEC√çFICO ---
                            let savedID = null;
                            try {
                                const decodedSnippet = decodeURIComponent(item.snippet);
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = decodedSnippet;
                                // Encontra o primeiro elemento com ID no HTML guardado
                                const savedWrapper = tempDiv.firstElementChild; 
                                // (Ou usa querySelector('[id]') para ser mais gen√©rico)
                                if (savedWrapper && savedWrapper.id) savedID = savedWrapper.id;
                            } catch(e) { }

                            // S√≥ atualiza se o ID guardado na Mica existir na Nota atual
                            if (savedID && liveBlocksMap[savedID]) {
                                const newHTML = liveBlocksMap[savedID];
                                const encodedNewHTML = encodeURIComponent(newHTML);

                                // Se o conte√∫do mudou
                                if (item.snippet !== encodedNewHTML) {
                                    console.log(`   üîÑ Atualizando Mica [${mica.name}] Item [${savedID}]`);
                                    item.snippet = encodedNewHTML;
                                    
                                    // Atualiza t√≠tulo se poss√≠vel (para a lista ficar bonita)
                                    const tempLive = document.createElement('div');
                                    tempLive.innerHTML = newHTML;
                                    const titleInput = tempLive.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
                                    
                                    if(titleInput) {
                                        const newTitle = titleInput.value || titleInput.textContent;
                                        if(newTitle) item.title = newTitle;
                                    }

                                    dossieChanged = true;
                                    totalUpdates++;
                                }
                            }
                        }
                    });
                });

                // Se alter√°mos algo neste documento, grava no Firebase
                if (dossieChanged || needsReferenceFix) {
                    const docRef = doc(db, colName, docSnap.id);
                    const updatePayload = {};
                    
                    if (dossieChanged) updatePayload.dossie = dossie;
                    
                    if (needsReferenceFix) {
                        updatePayload[`referencias.${noteId}`] = true;
                    }
                    
                    await updateDoc(docRef, updatePayload);
                }
            });

            await Promise.all(updatePromises);
        }

        // Se o painel Dossi√© estiver aberto no ecr√£, atualiza-o visualmente
        if (totalUpdates > 0) {
            const dossiePanel = document.getElementById('ref-content-dossie');
            if (dossiePanel && dossiePanel.style.display !== 'none' && window.activeMicaId) {
                console.log("‚ú® Atualizando vista do Dossi√© em tempo real...");
                if (typeof window.renderDossie === 'function') window.renderDossie();
            }
        } else {
            console.log("‚ÑπÔ∏è Nenhuma altera√ß√£o necess√°ria nas Micas.");
        }

    } catch (e) {
        console.error("üî• Erro na Sync Micas:", e);
    }
    console.groupEnd();
}


// ============================================================
// SISTEMA DE PROPAGA√á√ÉO DE ATUALIZA√á√ïES PARA A B√çBLIA (TEXTOS)
// ============================================================
async function propagateUpdatesToBible(noteId, fullContent, noteTitle) {
    console.group("üìñ [BIBLE SYNC] A propagar altera√ß√µes (Modo Cir√∫rgico)...");
    
    try {
        const { collection, query, where, getDocs, doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const myUid = auth.currentUser.uid;

        // 1. MAPEAMENTO DO CONTE√öDO VIVO (ID -> HTML)
        const parser = new DOMParser();
        const docDOM = parser.parseFromString(fullContent, 'text/html');
        
        // Encontra TODAS as caixas na nota atual
        const wrappers = docDOM.querySelectorAll('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper, .journal-id-card, details.toggle-section');
        
        const liveBlocksMap = {};
        wrappers.forEach(el => {
            if (el.id) liveBlocksMap[el.id] = el.outerHTML;
        });

        // 2. BUSCAR VERS√çCULOS QUE REFERENCIAM ESTA NOTA
        const q = query(
            collection(db, 'textosbiblicos'),
            where('userId', '==', myUid)
        );

        const snapshot = await getDocs(q);
        let updatesCount = 0;

        const updatePromises = snapshot.docs.map(async (docSnap) => {
            const data = docSnap.data();
            
            // Se n√£o tem quadro, ignora
            if (!data.puzzleBoard || !Array.isArray(data.puzzleBoard) || data.puzzleBoard.length === 0) return;

            let boardChanged = false;
            
            // Percorre o quadro para encontrar refer√™ncias a esta nota
            const newBoard = data.puzzleBoard.map(item => {
                // Se encontrar um item que vem desta nota
                if (item.noteId === noteId) {
                    
                    // --- CORRE√á√ÉO: TENTAR ENCONTRAR O ID DA CAIXA NO SNIPPET ANTIGO ---
                    let savedID = null;
                    try {
                        const decodedSnippet = decodeURIComponent(item.snippet);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = decodedSnippet;
                        const savedWrapper = tempDiv.firstElementChild;
                        if (savedWrapper) savedID = savedWrapper.id;
                    } catch(e) { }

                    // --- L√ìGICA DE DECIS√ÉO ---
                    let newSnippetEncoded = item.snippet; // Por defeito mant√©m o antigo

                    if (savedID && liveBlocksMap[savedID]) {
                        // CASO A: Encontr√°mos a caixa exata pelo ID! Atualiza com o conte√∫do dessa caixa.
                        newSnippetEncoded = encodeURIComponent(liveBlocksMap[savedID]);
                    } 
                    else if (!savedID) {
                        // CASO B: O item antigo n√£o era uma caixa (era texto solto da nota toda).
                        // Se a nota agora tem caixas, talvez dev√™ssemos manter o texto antigo ou atualizar tudo.
                        // Para seguran√ßa, se n√£o identificamos o ID, mantemos o texto antigo para n√£o estragar.
                        // (Ou opcionalmente: newSnippetEncoded = encodeURIComponent(fullContent));
                    }

                    // Verifica se houve mudan√ßa real
                    if (item.snippet !== newSnippetEncoded || item.noteName !== noteTitle) {
                        console.log(`   üîÑ Atualizando refer√™ncia exata [${savedID}] em: ${data.nome}`);
                        
                        item.snippet = newSnippetEncoded;
                        item.noteName = noteTitle;
                        
                        // Atualiza a cor se poss√≠vel
                        if (savedID && liveBlocksMap[savedID]) {
                            const tempDOM = document.createElement('div');
                            tempDOM.innerHTML = liveBlocksMap[savedID];
                            const wrapper = tempDOM.firstElementChild;
                            if (wrapper && wrapper.getAttribute('data-highlight')) {
                                item.noteColor = wrapper.getAttribute('data-highlight');
                            }
                        }

                        boardChanged = true;
                        updatesCount++;
                    }
                }
                return item;
            });

            // Se houve altera√ß√£o, grava no Firebase
            if (boardChanged) {
                const verseRef = doc(db, 'textosbiblicos', docSnap.id);
                return updateDoc(verseRef, { puzzleBoard: newBoard });
            }
        });

        await Promise.all(updatePromises);
        
        if (updatesCount > 0) {
            console.log(`‚úÖ ${updatesCount} refer√™ncias sincronizadas com sucesso.`);
        } else {
            console.log("‚ÑπÔ∏è Nenhuma altera√ß√£o necess√°ria nas refer√™ncias.");
        }

    } catch (e) {
        console.error("üî• Erro na Sync B√≠blia:", e);
    }
    console.groupEnd();
}

// ============================================================
// EXTRA: PROTE√á√ÉO CONTRA IDs DUPLICADOS NO COLAR (CR√çTICO)
// ============================================================
// Se copiar e colar uma caixa, o ID vem igual. Isso baralha o sistema.
// Este listener regenera IDs ao colar HTML.

document.getElementById('note-content-editor').addEventListener('paste', (e) => {
    // Atraso para processar depois do conte√∫do entrar
    setTimeout(() => {
        const editor = document.getElementById('note-content-editor');
        const wrappers = editor.querySelectorAll('.mini-note-wrapper, .redator-wrapper, .journal-sign-wrapper');
        
        const seenIds = new Set();
        let changed = false;

        wrappers.forEach(wrapper => {
            if (seenIds.has(wrapper.id)) {
                // ID Duplicado detetado! Regenerar.
                const oldId = wrapper.id;
                const prefix = oldId.split('_')[0] || 'box';
                const newId = `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
                
                wrapper.id = newId;
                
                // Atualiza tamb√©m os bot√µes internos que usam o ID (ex: Redator)
                if (wrapper.classList.contains('redator-wrapper')) {
                    const header = wrapper.querySelector('.redator-header');
                    if (header) header.id = `header-${newId}`;
                    const btn = wrapper.querySelector('.redator-reopen-btn');
                    if (btn) btn.setAttribute('onclick', `window.toggleRedatorHeader('${newId}', true)`);
                    const content = wrapper.querySelector('.redator-content');
                    if (content) content.setAttribute('oninput', `window.checkRedatorFocus(this, '${newId}')`);
                }
                
                console.log(`üîß ID duplicado corrigido: ${oldId} -> ${newId}`);
                changed = true;
            } else {
                seenIds.add(wrapper.id);
            }
        });

        if (changed && typeof saveNote === 'function') {
            saveNote();
        }
    }, 100);
});

// ============================================================
// FUN√á√ÉO DE ALERTA PERSONALIZADO (APENAS BOT√ÉO OK)
// ============================================================
window.showSuccessAlert = function(title, message) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        if (!modal) {
            alert(message); // Fallback se o modal n√£o existir
            return resolve();
        }

        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const confirmBtn = modal.querySelector('[data-action="confirm"]');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');

        // 1. Configurar Texto
        titleEl.textContent = title;
        messageEl.textContent = message;

        // 2. Configurar Bot√µes (Esconder o Cancelar)
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (confirmBtn) confirmBtn.textContent = "OK";

        // 3. For√ßar Visibilidade e Topo
        document.body.appendChild(modal);
        modal.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: fixed !important;
            z-index: 2147483647 !important;
            background-color: rgba(0, 0, 0, 0.85) !important;
            justify-content: center !important;
            align-items: center !important;
            top: 0; left: 0; width: 100vw; height: 100vh;
        `;

        // 4. L√≥gica do Clique (Resetar ao fechar)
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.onclick = () => {
            modal.style.display = 'none';
            
            // RESET IMPORTANTE: Restaurar o modal para o estado original (para confirma√ß√µes futuras)
            if (cancelBtn) cancelBtn.style.display = ''; // Volta ao padr√£o (flex/inline)
            if (confirmBtn) confirmBtn.textContent = "Confirmar";
            
            resolve();
        };
    });
};

// Listener para o Toggle de Partilha (Atualiza√ß√£o Visual em Tempo Real)
const shareToggleBtn = document.getElementById('note-share-toggle');

if (shareToggleBtn) {
    const newToggle = shareToggleBtn.cloneNode(true);
    shareToggleBtn.parentNode.replaceChild(newToggle, shareToggleBtn);

    newToggle.addEventListener('change', async () => {
        const isChecked = newToggle.checked;
        const modalContent = document.querySelector('#note-share-popup .modal-content');
        const linkContainer = document.getElementById('note-share-link-container');
        
        // NOVO: Refer√™ncia ao contentor da checkbox
        const allUnlockWrapper = document.getElementById('allunlock-wrapper');
        
        const urlInput = document.getElementById('note-share-url');
        const toolbarLockBtn = document.querySelector('button[data-action="note-sharing-settings"]');

        if (isChecked) {
            // Ativa
            modalContent.classList.add('share-active-wave');
            
            if(linkContainer) {
                linkContainer.style.display = 'block';
                linkContainer.style.opacity = '0';
                linkContainer.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    linkContainer.style.transition = 'all 0.3s ease';
                    linkContainer.style.opacity = '1';
                    linkContainer.style.transform = 'translateY(0)';
                }, 10);
            }

            // MOSTRA A NOVA OP√á√ÉO
            if (allUnlockWrapper) {
                allUnlockWrapper.style.display = 'block';
            }

            if (urlInput) {
                urlInput.style.color = "#4a90e2";
                urlInput.style.borderColor = "#4a90e2";
                urlInput.style.fontWeight = "bold";
            }
            if (toolbarLockBtn) toolbarLockBtn.textContent = 'üîì';

        } else {
            // Desativa
            modalContent.classList.remove('share-active-wave');
            if(linkContainer) linkContainer.style.display = 'none';
            
            // ESCONDE A NOVA OP√á√ÉO
            if (allUnlockWrapper) {
                allUnlockWrapper.style.display = 'none';
            }

            if (urlInput) {
                urlInput.style.color = "";
                urlInput.style.borderColor = "";
                urlInput.style.fontWeight = "";
            }
            if (toolbarLockBtn) toolbarLockBtn.textContent = 'üîê';
        }

        await updateSharingSettings();
    });
}

// Fun√ß√£o para mostrar detalhes do post (Data/Hora) ao clicar no 'i'
window.showPostDetails = function(postId) {
    if (!currentArchiveData || !currentArchiveData.posts) return;

    const post = currentArchiveData.posts.find(p => p.id === postId);
    if (!post) return;

    // 1. Converter datas
    const getMs = (val) => val && val.toMillis ? val.toMillis() : Number(val || 0);
    const created = post.createdAt ? new Date(getMs(post.createdAt)).toLocaleString() : 'Desconhecido';
    
    // Verifica se foi editado (se a data de update for muito diferente da cria√ß√£o)
    const updatedMs = getMs(post.updatedAt);
    const createdMs = getMs(post.createdAt);
    const wasEdited = updatedMs > (createdMs + 5000); // margem de 5s
    const updated = wasEdited ? new Date(updatedMs).toLocaleString() : 'Nunca editado';

    // 2. Preencher o HTML do Modal
    const grid = document.getElementById('p-info-grid');
    
    grid.innerHTML = `
        <div class="info-row">
            <span class="info-icon">üë§</span>
            <div class="info-data">
                <span class="info-label">Autor</span>
                <span>${post.createdBy || 'An√≥nimo'}</span>
            </div>
        </div>

        <div class="info-row">
            <span class="info-icon">üìÖ</span>
            <div class="info-data">
                <span class="info-label">Criado em</span>
                <span>${created}</span>
            </div>
        </div>

        <div class="info-row" style="${!wasEdited ? 'opacity: 0.5;' : ''}">
            <span class="info-icon">üîÑ</span>
            <div class="info-data">
                <span class="info-label">√öltima Edi√ß√£o</span>
                <span>${updated}</span>
            </div>
        </div>
    `;

    // 3. Mostrar o Modal
    const modal = document.getElementById('post-info-modal');
    document.body.appendChild(modal); // Garante topo
    modal.style.display = 'flex';
};


// --- GESTOR DE VISIBILIDADE DA ABA (Mudar de aba apaga a bola) ---
document.addEventListener('visibilitychange', async () => {
    // S√≥ executa se estivermos num arquivo (presenceRef existe)
    if (!presenceRef || !selectedNoteId) return;

    const { setDoc, deleteDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    const userName = currentUserData?.nome || "User";

    if (document.visibilityState === 'hidden') {
        // ESCONDIDO: Apaga a bola para os outros verem que sa√≠
        deleteDoc(presenceRef).catch(e => {});
    } else {
        // VIS√çVEL: Recria a bola imediatamente
        setDoc(presenceRef, {
            name: userName,
            lastSeen: serverTimestamp(),
            status: 'online'
        }, { merge: true }).catch(e => {});
    }
});

// Refor√ßo: Ao fechar a janela do browser
window.addEventListener('beforeunload', () => {
    if (presenceRef) {
        // Tenta limpar antes de fechar
        leaveArchivePresence(); 
    }
});

// --- FUN√á√ÉO DE SEGURAN√áA: GRAVAR E DESBLOQUEAR AO SAIR ---
async function forceUnlockAndSaveOnExit() {
    // Verifica se estamos a editar algum post neste momento
    const postId = activeEditingPostId || window.activeEditingPostId;

    if (postId) {
        console.log(`üö® [SA√çDA DE EMERG√äNCIA] Post ${postId} detetado aberto. A libertar...`);
        
        // Feedback Visual
        const statusEl = document.getElementById('archive-save-status');
        if(statusEl) statusEl.textContent = "A gravar e sair...";

        // 1. Tenta capturar o texto que est√° no ecr√£ (mesmo que n√£o tenha clicado em Salvar)
        const postDiv = document.getElementById(`post-${postId}`);
        let contentToSave = null;
        let titleToSave = null;

        if (postDiv) {
            const editor = postDiv.querySelector('.post-editor-content');
            const titleInput = postDiv.querySelector('.post-title-input');
            
            if (editor && titleInput) {
                // Sincroniza inputs internos (para entidades/redator)
                editor.querySelectorAll('.mini-note-title-input, .redator-input').forEach(t => {
                    if (t.tagName === 'INPUT') t.setAttribute('value', t.value);
                    else t.textContent = t.value;
                });
                
                contentToSave = editor.innerHTML;
                titleToSave = titleInput.value;
            }
        }

        // 2. Limpa as vari√°veis globais IMEDIATAMENTE para impedir loops
        activeEditingPostId = null;
        window.activeEditingPostId = null;
        window.livePostDraft = null;
        localStorage.removeItem(`draft_${postId}`);

        try {
            // 3. Se conseguimos ler o conte√∫do, gravamos (Auto-Save)
            if (contentToSave !== null) {
                // Chama a fun√ß√£o de save passando os dados explicitamente
                // (Nota: a fun√ß√£o saveArchivePost j√° chama o unlockPost no final)
                await window.saveArchivePost(postId, contentToSave, titleToSave);
            } else {
                // Se o elemento j√° n√£o existe (raro), for√ßamos apenas o desbloqueio
                await unlockPost(postId);
            }
            console.log("‚úÖ Post guardado e desbloqueado com sucesso.");
            
        } catch (e) {
            console.warn("‚ö†Ô∏è Falha ao gravar na sa√≠da (poss√≠vel falha de rede):", e);
            // Tentativa final de desbloqueio simples para n√£o prender o post
            unlockPost(postId).catch(() => {}); 
        }
    }
}

// Fun√ß√£o para manter o cadeado vivo
function startLockHeartbeat(postId) {
    // Limpa anterior se existir
    if (lockHeartbeatInterval) clearInterval(lockHeartbeatInterval);

    // Cria um novo intervalo: A cada 60 segundos, renova o bloqueio
    lockHeartbeatInterval = setInterval(async () => {
        if (activeEditingPostId === postId && currentArchiveId) {
            console.log("üíì [LOCK] A renovar cadeado...");
            
            // Reutiliza a fun√ß√£o lockPost existente, que atualiza o timestamp
            await lockPost(postId); 
        }
    }, 60000); // 60 segundos
}

// Fun√ß√£o para parar o cora√ß√£o quando sais
function stopLockHeartbeat() {
    if (lockHeartbeatInterval) {
        clearInterval(lockHeartbeatInterval);
        lockHeartbeatInterval = null;
    }
}

// Listener para quando a p√°gina est√° prestes a desaparecer
window.addEventListener('pagehide', () => {
    // Se estivermos a editar um post
    if (activeEditingPostId && currentArchiveId) {
        // Envia um pedido "Beacon" (funciona mesmo depois da aba fechar) para apagar o lock
        // Nota: Isto requer uma Cloud Function ou uma l√≥gica backend espec√≠fica.
        // Como estamos a usar Firestore Client SDK, o melhor que podemos fazer √©:
        
        // Tenta desbloquear s√≠ncronamente (Best effort)
        stopLockHeartbeat();
        
        // Em √∫ltimo caso, como implement√°mos o Passo 2 (Timeout), 
        // mesmo que isto falhe, o post ficar√° livre ap√≥s 5 minutos.
    }
});

// --- FUN√á√ÉO DE BUSCA DO PAI (ORIGINAL) ---
async function findOriginalNoteLocation(originId) {
    if (!auth.currentUser || !originId) return null;
    
    // 1. VERIFICA√á√ÉO VISUAL (No Ecr√£ Atual)
    // Procuramos se o elemento com o ID original existe fisicamente nesta p√°gina.
    const originalElement = document.getElementById(originId);
    
    if (originalElement) {
        // TRUQUE DE SEGURAN√áA:
        // Se o elemento que encontr√°mos TAMB√âM tem um 'data-origin-id', ent√£o ele √© um clone mal formatado 
        // ou uma c√≥pia local. N√£o √© o "Verdadeiro Original". Ignoramos.
        // Se N√ÉO tiver 'data-origin-id', ent√£o √© o original puro e duro.
        if (!originalElement.hasAttribute('data-origin-id')) {
            console.log("üìç Original encontrado visualmente nesta nota!");
            return {
                id: selectedNoteId, 
                name: "üìç ESTA NOTA (Clique para ir)", 
                type: 'source',
                boxId: originId,
                icon: 'üéØ'
            };
        }
    }

    // 2. VERIFICA√á√ÉO NA BASE DE DADOS (Excluindo a nota atual)
    const myUid = auth.currentUser.uid;
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const q = query(
            collection(db, 'pastas'),
            where('userId', '==', myUid),
            where('estado', '==', 'ativa'),
            where('tipo', 'in', ['nota', 'arquivo', 'partilhado', 'jornal', 'aquario'])
        );

        const snapshot = await getDocs(q);
        
        for (const doc of snapshot.docs) {
            
            // >>> A CORRE√á√ÉO EST√Å AQUI <<<
            // Se o ID do documento for igual √† nota onde estamos agora, PULA.
            // N√≥s j√° verific√°mos a nota atual visualmente no passo 1. 
            // Se n√£o estava l√°, n√£o vale a pena ver no texto guardado da mesma nota.
            if (doc.id === selectedNoteId) continue; 
            // -----------------------------

            const data = doc.data();
            const content = data.conteudo || "";
            
            // Procura o ID no HTML: id="mn_12345..."
            if (content.includes(`id="${originId}"`)) {
                return {
                    id: doc.id,
                    name: data.nome || "Sem T√≠tulo",
                    type: 'source', 
                    boxId: originId,
                    icon: 'üìÑ'
                };
            }
            
            // Se for arquivo/partilhado, procurar nos posts
            if (data.posts && Array.isArray(data.posts)) {
                const foundPost = data.posts.find(p => p.content && p.content.includes(`id="${originId}"`));
                if (foundPost) {
                    return {
                        id: doc.id,
                        name: `${data.nome} (Post: ${foundPost.title})`,
                        type: 'source',
                        boxId: originId,
                        icon: 'üóÑÔ∏è'
                    };
                }
            }
        }
    } catch (e) {
        console.error("Erro ao procurar original:", e);
    }
    return null;
}


function highlightLeftPanelItem(activeId) {
    const list = document.getElementById('left-panel-list');
    if (!list) return;

    // 1. Remove sele√ß√£o de todos
    list.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));

    // 2. Se houver um ID ativo, adiciona a sele√ß√£o
    if (activeId) {
        const target = list.querySelector(`.list-item[data-id="${activeId}"]`);
        if (target) {
            target.classList.add('selected');
            // Garante que est√° vis√≠vel se a lista for longa
            target.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
}

const editorTouchFix = document.getElementById('note-content-editor');

if (editorTouchFix) {
    editorTouchFix.addEventListener('touchstart', (e) => {
        // Se tocou num par√°grafo simples (o espa√ßo entre notas)
        if (e.target.tagName === 'P' || e.target.id === 'note-content-editor') {
            e.stopPropagation(); // Impede que a app tente interpretar como "arrasto"
            // N√£o usamos preventDefault() -> Deixamos o browser colocar o cursor
        }
    }, { passive: false });
}

// ============================================================
// CORRE√á√ÉO DE FOCO NO CORPO DA ENTIDADE (MOBILE)
// ============================================================

const editorFocusFix = document.getElementById('note-content-editor');

if (editorFocusFix) {
    editorFocusFix.addEventListener('click', (e) => {
        // Verifica se clicou no CORPO de uma entidade (Subnota, Redator, etc.)
        const contentDiv = e.target.closest('.mini-note-content, .redator-content, .sign-content, .toggle-content');
        
        if (contentDiv && contentDiv.isContentEditable) {
            
            // Se o elemento j√° tem o foco, n√£o faz nada (deixa o cursor mover-se normalmente)
            if (document.activeElement === contentDiv) return;

            // Se N√ÉO tem o foco, for√ßa-o agora
            contentDiv.focus();

            // --- TRUQUE PARA MANTER A POSI√á√ÉO ---
            // O clique do utilizador j√° define a posi√ß√£o do cursor nativamente.
            // Mas se o teclado abrir e empurrar o layout, o foco pode perder-se.
            // Aqui garantimos que o foco fica preso neste elemento.
            
            e.stopPropagation(); // Impede que o evento suba para o editor pai e cause o salto
        }
    });

    // Refor√ßo para Touch (Toque direto)
    editorFocusFix.addEventListener('touchstart', (e) => {
        const contentDiv = e.target.closest('.mini-note-content, .redator-content, .sign-content, .toggle-content');
        
        if (contentDiv && contentDiv.isContentEditable) {
            // P√°ra a propaga√ß√£o IMEDIATAMENTE.
            // Isto diz ao editor principal: "N√£o te metas, este toque √© meu".
            e.stopPropagation(); 
        }
    }, { passive: true });
}

// ============================================================
// MOTOR DE TOQUE INTELIGENTE (SCROLL vs EDI√á√ÉO)
// ============================================================

const smartTouchEditor = document.getElementById('note-content-editor');

if (smartTouchEditor) {
    
    let touchStartX = 0;
    let touchStartY = 0;
    let isMoving = false;

    // 1. IN√çCIO DO TOQUE
    smartTouchEditor.addEventListener('touchstart', (e) => {
        // Guarda posi√ß√£o inicial
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        isMoving = false; 

        // N√ÉO usamos preventDefault(). 
        // Se us√°ssemos, o scroll nativo n√£o come√ßava.
    }, { passive: true });

    // 2. MOVIMENTO
    smartTouchEditor.addEventListener('touchmove', (e) => {
        const moveX = e.touches[0].clientX;
        const moveY = e.touches[0].clientY;

        // Se mover mais de 10px, √© Scroll
        if (Math.abs(moveY - touchStartY) > 10 || Math.abs(moveX - touchStartX) > 10) {
            isMoving = true;
        }
    }, { passive: true });

    // 3. FIM DO TOQUE (L√≥gica de Decis√£o)
    smartTouchEditor.addEventListener('touchend', (e) => {
        
        // A. Se foi Scroll, ignora e sai. O teclado N√ÉO abre.
        if (isMoving) return;

        // B. Se foi um Toque R√°pido (Tap)
        const target = e.target;
        
        // Procura se tocou em algo edit√°vel (T√≠tulo, Corpo, Input)
        const editableItem = target.closest('input, textarea, [contenteditable="true"]');

        if (editableItem) {
            
            // For√ßa o foco para abrir o teclado
            setTimeout(() => {
                editableItem.focus();
                
                // Truque extra para Inputs/Textareas no iOS
                if (editableItem.tagName === 'INPUT' || editableItem.tagName === 'TEXTAREA') {
                    editableItem.click();
                }
            }, 10); // Pequeno delay para o sistema n√£o confundir com o fim do scroll
        }
    });
}

// ============================================================
// PROTE√á√ÉO DE LIMITES: BARREIRA DO BACKSPACE (MOBILE & PC)
// ============================================================

const protectedEditor = document.getElementById('note-content-editor');

if (protectedEditor) {
    
    // Lista de classes que funcionam como barreiras (o corpo das entidades)
    const protectedClasses = [
        '.mini-note-content', 
        '.redator-content', 
        '.sign-content', 
        '.toggle-content',
        '.card-desc-content',
        '.cube-content'
    ];

    // FUN√á√ÉO: Verifica se o cursor est√° no in√≠cio absoluto da caixa
    function isCursorAtStart(selection, contentDiv) {
        if (!selection.isCollapsed) return false; // Se selecionou texto, deixa apagar
        
        const range = selection.getRangeAt(0);
        const node = range.startContainer;
        const offset = range.startOffset;

        // 1. Se o offset > 0, n√£o estamos no in√≠cio
        if (offset > 0) return false;

        // 2. Se o n√≥ atual n√£o for o primeiro filho, verifica se os anteriores est√£o vazios
        // (Simplifica√ß√£o: Se estamos no primeiro par√°grafo <p>, √© o in√≠cio)
        const firstBlock = contentDiv.firstElementChild; // Geralmente um <p>
        
        // Verifica se o n√≥ onde est√° o cursor est√° dentro do primeiro bloco
        if (firstBlock && (firstBlock === node || firstBlock.contains(node))) {
            return true;
        }
        
        // Caso n√£o tenha <p> e seja texto direto
        if (contentDiv.firstChild === node && offset === 0) {
            return true;
        }

        return false;
    }

    // 1. EVENTO MODERNO (MOBILE - iOS/Android)
    protectedEditor.addEventListener('beforeinput', (e) => {
        // S√≥ nos interessa se a a√ß√£o for "Apagar para tr√°s"
        if (e.inputType === 'deleteContentBackward') {
            
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const anchorNode = selection.anchorNode;
            // Garante que pegamos o elemento HTML
            const el = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
            
            // Encontra a caixa de conte√∫do mais pr√≥xima
            const contentDiv = el.closest(protectedClasses.join(','));

            if (contentDiv) {
                // Se estamos no in√≠cio absoluto da caixa
                if (isCursorAtStart(selection, contentDiv)) {
                    console.log("üõ°Ô∏è [BARREIRA] Backspace bloqueado no topo da entidade.");
                    e.preventDefault(); // IMPEDE A A√á√ÉO
                    e.stopPropagation();
                }
            }
        }
    });

    // 2. EVENTO CL√ÅSSICO (PC / Teclados F√≠sicos no Mobile)
    protectedEditor.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
            
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const anchorNode = selection.anchorNode;
            const el = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
            
            const contentDiv = el.closest(protectedClasses.join(','));

            if (contentDiv) {
                if (isCursorAtStart(selection, contentDiv)) {
                    // Impede de apagar a fronteira
                    e.preventDefault(); 
                    e.stopPropagation();
                }
            }
        }
    });
}

window.renameMica = async function(id, currentName) {
    // Usa o seu modal bonito de input
    const result = await showCustomInput("Renomear Mica", "Novo nome...", currentName);
    
    // Se o utilizador confirmar e houver um nome v√°lido
    if (result && result.name && result.name.trim() !== "") {
        try {
            const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            
            const col = getCollectionFromType(activeReferenceEntity.type);
            const docRef = doc(db, col, activeReferenceEntity.id);
            const snap = await getDoc(docRef);

            if (snap.exists()) {
                let dossie = snap.data().dossie || [];
                const index = dossie.findIndex(m => m.id === id);

                if (index > -1) {
                    // Atualiza o nome
                    dossie[index].name = result.name.trim();
                    
                    // Se quiser permitir editar a descri√ß√£o tamb√©m, adicione esta linha:
                    if (result.description !== undefined) dossie[index].description = result.description.trim();

                    // Grava no Firebase
                    await updateDoc(docRef, { dossie });
                    
                    // Atualiza a lista visualmente
                    window.renderDossie();
                }
            }
        } catch (e) {
            console.error("Erro ao renomear mica:", e);
            alert("Erro ao gravar o novo nome.");
        }
    }
};

// --- FUN√á√ÉO DE LIKE ---
window.togglePostLike = async function(postId) {
    if (!auth.currentUser || !currentArchiveId) return;
    const myUid = auth.currentUser.uid;

    const post = currentArchiveData.posts.find(p => p.id === postId);
    if (!post) return;

    if (!post.likes) post.likes = [];
    const wasLiked = post.likes.includes(myUid);

    // 1. ANIMA√á√ÉO VISUAL (Antes de atualizar dados)
    const btn = document.querySelector(`#post-${postId} .post-like-btn`);
    
    if (btn) {
        // A. Efeito de Escala (Bounce)
        btn.style.transition = "transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
        btn.style.transform = "scale(1.4)";
        setTimeout(() => btn.style.transform = "scale(1)", 150);

        // B. Efeito de Part√≠culas (S√≥ se for dar Like)
        if (!wasLiked) {
            createLikeExplosion(btn);
        }
    }

    // 2. ATUALIZA√á√ÉO L√ìGICA (Optimistic UI)
    if (wasLiked) {
        post.likes = post.likes.filter(id => id !== myUid);
    } else {
        post.likes.push(myUid);
    }

    // 3. Atualizar o DOM sem destruir o bot√£o (para n√£o cortar a anima√ß√£o)
    if (btn) {
        const countSpan = btn.querySelectorAll('span')[1];
        const iconSpan = btn.querySelectorAll('span')[0];
        
        // Atualiza contador
        countSpan.textContent = post.likes.length > 0 ? post.likes.length : '';
        
        // Atualiza √≠cone e classe
        if (!wasLiked) { // Agora tem like
            iconSpan.textContent = '‚ù§Ô∏è';
            btn.classList.add('active-like');
        } else { // Removeu like
            iconSpan.textContent = 'ü§ç';
            btn.classList.remove('active-like');
        }
    }

    // 4. ATUALIZA√á√ÉO NO FIREBASE
    try {
        const { doc, updateDoc, arrayUnion, arrayRemove } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const postRef = doc(db, 'pastas', currentArchiveId, 'posts', postId);

        if (wasLiked) {
            await updateDoc(postRef, { likes: arrayRemove(myUid) });
        } else {
            await updateDoc(postRef, { likes: arrayUnion(myUid) });
        }
    } catch (e) {
        console.error("Erro ao dar like:", e);
        // Reverte se falhar
    }
};

// --- FUN√á√ÉO DE PART√çCULAS (EXPLOS√ÉO) ---
function createLikeExplosion(btnElement) {
    const rect = btnElement.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.classList.add('like-particle');
        document.body.appendChild(particle);

        // Posi√ß√£o inicial (centro do bot√£o)
        particle.style.left = `${centerX}px`;
        particle.style.top = `${centerY}px`;

        // Dire√ß√£o aleat√≥ria
        const angle = Math.random() * Math.PI * 2;
        const velocity = 30 + Math.random() * 30; // Dist√¢ncia
        const tx = Math.cos(angle) * velocity;
        const ty = Math.sin(angle) * velocity;

        // Anima√ß√£o
        particle.animate([
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
        ], {
            duration: 600,
            easing: 'cubic-bezier(0, .9, .57, 1)',
        }).onfinish = () => particle.remove();
    }
}

// 1. RENDERIZAR LISTA DE COLABORADORES (Busca nomes na cole√ß√£o 'users')
window.renderCollaboratorsList = async function(docId, colaboradoresMap) {
    const listUl = document.getElementById('collab-users-ul');
    if (!listUl) return;

    if (!colaboradoresMap || Object.keys(colaboradoresMap).length === 0) {
        listUl.innerHTML = '<li style="padding:10px; text-align:center; color:#888;">Ainda sem colaboradores.</li>';
        return;
    }

    const myUid = auth.currentUser.uid;
    // Filtra o pr√≥prio dono da lista (n√£o faz sentido o dono remover-se a si mesmo aqui)
    const userIds = Object.keys(colaboradoresMap).filter(uid => uid !== myUid);

    if (userIds.length === 0) {
        listUl.innerHTML = '<li style="padding:10px; text-align:center; color:#888;">Ainda sem colaboradores convidados.</li>';
        return;
    }

    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Limpa lista
        listUl.innerHTML = '';

        // Busca dados de cada utilizador
        // Nota: Isto pode ser otimizado com query 'in', mas Promise.all √© seguro para listas pequenas
        const promises = userIds.map(async (uid) => {
            try {
                const userSnap = await getDoc(doc(db, 'users', uid));
                if (userSnap.exists()) {
                    return { id: uid, name: userSnap.data().nome, email: userSnap.data().email };
                }
            } catch(e) {}
            return { id: uid, name: "Utilizador Desconhecido", email: "---" };
        });

        const usersData = await Promise.all(promises);

        // Renderiza cada linha
        usersData.forEach(user => {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:8px 10px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--border-color);";
            
            li.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="width:24px; height:24px; background:${stringToColor(user.name)}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; color:white; font-weight:bold;">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:500; font-size:0.9em; color:var(--text-color);">${user.name}</span>
                        <span style="font-size:0.7em; color:var(--text-muted-color);">${user.email}</span>
                    </div>
                </div>
                <button onclick="window.removeCollaborator('${docId}', '${user.id}', this)" 
                        title="Remover Acesso"
                        style="background:none; border:1px solid #c0392b; color:#c0392b; border-radius:4px; padding:2px 8px; cursor:pointer; font-size:0.8em; transition:all 0.2s;">
                    Remover
                </button>
            `;
            
            // Hover effect no bot√£o
            const btn = li.querySelector('button');
            btn.onmouseover = () => { btn.style.background = "#c0392b"; btn.style.color = "white"; };
            btn.onmouseout = () => { btn.style.background = "none"; btn.style.color = "#c0392b"; };

            listUl.appendChild(li);
        });

    } catch (e) {
        console.error("Erro ao carregar utilizadores:", e);
        listUl.innerHTML = '<li style="color:#e74c3c; padding:10px;">Erro ao carregar lista.</li>';
    }
};

// 2. FUN√á√ÉO PARA REMOVER COLABORADOR
window.removeCollaborator = async function(docId, userIdToRemove, btnElement) {
    // Confirma√ß√£o
    const confirmed = await showConfirmation(
        "Remover Acesso?", 
        "Este utilizador deixar√° de poder ver e editar este arquivo. O arquivo ser√° removido da lista dele."
    );

    if (!confirmed) return;

    // Feedback Visual
    btnElement.textContent = "...";
    btnElement.disabled = true;

    try {
        const { doc, updateDoc, deleteField } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'pastas', docId);

        // Remove o ID do mapa de colaboradores
        await updateDoc(docRef, {
            [`colaboradores.${userIdToRemove}`]: deleteField()
        });

        // Remove a linha visualmente
        const li = btnElement.closest('li');
        li.style.opacity = '0';
        setTimeout(() => li.remove(), 300);

        // Se quiser ser muito minucioso, pode tamb√©m for√ßar o fecho do "Cadeado" desse utilizador se ele estiver online, 
        // mas o sistema de realtime (onSnapshot) do lado dele vai tratar disso automaticamente (vai receber erro de permiss√£o e ser expulso).

    } catch (e) {
        console.error("Erro ao remover colaborador:", e);
        alert("Erro ao remover. Verifique a sua liga√ß√£o.");
        btnElement.textContent = "Remover";
        btnElement.disabled = false;
    }
};

// 1. ABRIR O GESTOR
window.openSourceManager = function() {
    const modal = document.getElementById('source-manager-modal');
    const nameInput = document.getElementById('source-link-name');
    const removeBtn = document.getElementById('source-remove-btn');
    const saveBtn = document.getElementById('source-save-btn');
    const addUrlBtn = document.getElementById('source-add-url-btn');
    const actionsDiv = modal.querySelector('.modal-actions');
    
    // ============================================================
    // CORRE√á√ÉO CR√çTICA DE SELE√á√ÉO
    // ============================================================
    // 1. Tenta usar a sele√ß√£o nativa do browser AGORA
    let selection = window.getSelection();
    
    // 2. Se n√£o houver, tenta usar a vari√°vel global (backup)
    if ((!selection || selection.rangeCount === 0) && currentSelectionRange) {
        selection.removeAllRanges();
        selection.addRange(currentSelectionRange);
        selection = window.getSelection(); // Atualiza a refer√™ncia
    }

    // 3. Garante que guardamos o range para usar no bot√£o gravar
    savedRange = (selection && selection.rangeCount > 0) ? selection.getRangeAt(0).cloneRange() : null;
    
    // Se mesmo assim for null, avisa (mas deixa abrir para edi√ß√£o manual)
    if (!savedRange) {
        console.warn("‚ö†Ô∏è Nenhuma sele√ß√£o de texto encontrada.");
    }
    // ============================================================

    let existingLink = null;
    let existingSuperLink = null;

    if (selection.rangeCount > 0 && selection.anchorNode) {
        const node = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
        existingLink = node.closest('a[data-anexo-id]');
        existingSuperLink = node.closest('.superlink-dotted');
    }

    // Reset UI
    document.getElementById('source-urls-list').innerHTML = '';
    currentEditingSuperLinkId = null;
    selectedSentenceNodes = [];
    removeBtn.style.display = 'none';

    // LIMPEZA DE BOT√ïES ANTIGOS DE APAGAR (Para n√£o duplicar)
    const oldDelRefBtn = actionsDiv.querySelector('.btn-delete-link-ref');
    if (oldDelRefBtn) oldDelRefBtn.remove();

    // --- MODO EDI√á√ÉO (LINK NORMAL) ---
    if (existingLink) {
        switchSourceTab('links');
        nameInput.value = existingLink.textContent;
        
        try {
            const data = JSON.parse(decodeURIComponent(existingLink.dataset.json || '{}'));
            if (Array.isArray(data)) {
                data.forEach(url => window.addSourceUrlField(url));
            } else if (data.urls) {
                Object.values(data.urls).forEach(url => window.addSourceUrlField(url));
            } else {
                window.addSourceUrlField(existingLink.href);
            }
        } catch (e) {
            window.addSourceUrlField(existingLink.href);
        }

    } 
    // --- MODO EDI√á√ÉO (SUPERLINK) ---
    else if (existingSuperLink) {
        switchSourceTab('superlink');
        nameInput.value = existingSuperLink.textContent;
        currentEditingSuperLinkId = existingSuperLink.dataset.slId;
        removeBtn.style.display = 'block';
        
        // Carrega frases para edi√ß√£o/repara√ß√£o
        loadEditorSentences(currentEditingSuperLinkId);
    } 
    // --- MODO CRIA√á√ÉO ---
    else {
        switchSourceTab('links');
        // Se houver sele√ß√£o, usa o texto como t√≠tulo inicial
        nameInput.value = selection.toString().trim();
        window.addSourceUrlField();
        loadEditorSentences(null);
    }

    // Configurar Bot√£o URL
    const newAddUrlBtn = addUrlBtn.cloneNode(true);
    addUrlBtn.parentNode.replaceChild(newAddUrlBtn, addUrlBtn);
    newAddUrlBtn.onclick = (e) => { e.preventDefault(); window.addSourceUrlField(); };

    // Configurar Bot√£o Remover
    const newRemoveBtn = removeBtn.cloneNode(true);
    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);
    
    newRemoveBtn.onclick = async () => {
        const confirmModal = document.getElementById('confirm-modal');
        if (confirmModal) document.body.appendChild(confirmModal);
        
        const confirmed = await showConfirmation(
            "Remover V√≠nculo?", 
            "Isto ir√° apagar a liga√ß√£o entre estes textos."
        );

        if (confirmed) {
            if (currentEditingSuperLinkId) {
                deleteSuperLink(currentEditingSuperLinkId);
            }
            modal.style.display = 'none';
        }
    };

    // ============================================================
    // BOT√ÉO GRAVAR (CORRIGIDO COM INSERT HTML)
    // ============================================================
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

newSaveBtn.onclick = async () => {
        const activeTabBtn = document.querySelector('#source-tabs button.active');
        const activeTab = activeTabBtn ? activeTabBtn.dataset.tab : 'links';

        if (activeTab === 'superlink') {
            saveSuperLink();
            return;
        }

        const titleVal = nameInput.value.trim();
        const urls = [];
        document.querySelectorAll('.source-url-input').forEach(inp => {
            let u = inp.value.trim();
            if (u) {
                if (!u.startsWith('http')) u = 'https://' + u;
                urls.push(u);
            }
        });

        if (!titleVal) return alert("Insira um nome para o link.");
        if (urls.length === 0) return alert("Insira pelo menos um URL.");

        // Dados e Estilo
        const jsonEncoded = encodeURIComponent(JSON.stringify(urls));
        const linkStyle = "color:inherit; text-decoration:none; border-bottom:1px solid rgba(200, 200, 200, 0.4); cursor:pointer;";

        // 1. APLICA√á√ÉO NO DOM
        if (existingLink) {
            // Edi√ß√£o
            existingLink.textContent = titleVal;
            existingLink.href = urls[0];
            existingLink.dataset.json = jsonEncoded;
            existingLink.style.cssText = linkStyle;
        } else {
            // Cria√ß√£o (DOM Injection)
            if (savedRange) {
                try {
                    savedRange.deleteContents(); // Limpa sele√ß√£o
                    
                    const a = document.createElement('a');
                    a.href = urls[0];
                    a.target = "_blank";
                    a.dataset.anexoId = 'lnk_' + Date.now();
                    a.dataset.json = jsonEncoded;
                    a.textContent = titleVal;
                    a.style.cssText = linkStyle;

                    savedRange.insertNode(a);
                    
                    // Normaliza para fundir n√≥s de texto adjacentes
                    a.parentNode.normalize(); 
                } catch(e) {
                    console.error("Erro DOM:", e);
                }
            }
        }

        // 2. FECHAR MODAL IMEDIATAMENTE (Visual)
        modal.style.display = 'none';

        // 3. GRAVA√á√ÉO COM DELAY DE SEGURAN√áA
        // Isto d√° tempo ao browser para renderizar o novo elemento <a> antes de o lermos
        if (typeof saveNote === 'function') {
            setTimeout(() => {
                console.log("üíæ Grava√ß√£o atrasada executada (Link Seguro).");
                saveNote(true);
            }, 100); 
        }
    };




    // Mostrar Modal
    document.body.appendChild(modal);
    modal.style.display = 'flex';
};



// 2. GEST√ÉO DE ABAS
document.getElementById('source-tabs').addEventListener('click', (e) => {
    if(e.target.tagName === 'BUTTON') switchSourceTab(e.target.dataset.tab);
});

function switchSourceTab(tab) {
    console.log(`%c[TAB] A mudar para a aba: ${tab}`, "color: yellow; font-weight: bold;");

    // 1. Atualiza visual dos bot√µes
    document.querySelectorAll('#source-tabs button').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector(`#source-tabs button[data-tab="${tab}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    // 2. Alterna pain√©is
    const linksPanel = document.getElementById('source-content-links');
    const superPanel = document.getElementById('source-content-superlink');

    if (tab === 'links') {
        if(linksPanel) linksPanel.style.display = 'block';
        if(superPanel) superPanel.style.display = 'none'; 
    } else {
        if(linksPanel) linksPanel.style.display = 'none';
        
        if(superPanel) {
            superPanel.style.display = 'flex';
            console.log("[TAB] Painel SuperLink vis√≠vel.");

            // --- AQUI EST√Å A CHAMADA ---
            if (typeof window.loadEditorSentences === 'function') {
                console.log("[TAB] A chamar window.loadEditorSentences()...");
                window.loadEditorSentences(currentEditingSuperLinkId);
            } else {
                console.error("‚ùå [ERRO] A fun√ß√£o window.loadEditorSentences n√£o existe!");
            }
        } else {
            console.error("‚ùå [ERRO] Elemento #source-content-superlink n√£o encontrado no HTML!");
        }
    }
}

// 3. CARREGAR FRASES DO EDITOR (SEM FIREBASE)
 window.loadEditorSentences = function(activeId) {
    console.group("üöÄ [DEBUG] Carregando Frases (Modo Detalhado)...");

    const modal = document.getElementById('source-manager-modal');
    let list = modal ? modal.querySelector('#superlink-sentences-list') : document.getElementById('superlink-sentences-list');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) {
        console.error("‚ùå ERRO: Editor ou Lista n√£o encontrados.");
        console.groupEnd();
        return;
    }

    list.innerHTML = ''; 
    selectedSentenceNodes = []; 

    // Limpa IDs tempor√°rios antigos
    editor.querySelectorAll('[data-temp-sl]').forEach(el => el.removeAttribute('data-temp-sl'));

    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, {
        acceptNode: (node) => {
            const text = node.textContent.trim();
            const parent = node.parentElement;

            if (!text || text.length < 2) return NodeFilter.FILTER_REJECT;
            if (['STYLE', 'SCRIPT', 'BUTTON', 'TEXTAREA', 'SELECT', 'INPUT'].includes(parent.tagName)) return NodeFilter.FILTER_REJECT;
            if (parent.closest('.mini-note-toolbar')) return NodeFilter.FILTER_REJECT;
            
            return NodeFilter.FILTER_ACCEPT;
        }
    });

    let node;
    let count = 0;

    while (node = walker.nextNode()) {
        const fullText = node.textContent; // Texto original completo (com espa√ßos)
        const parent = node.parentElement;
        
        // 1. GERA ID TEMPOR√ÅRIO NO PAI
        const tempId = `temp_${Date.now()}_${count}`;
        
        // Marca o local no DOM
        if (parent.childNodes.length === 1 && parent.tagName !== 'BODY') {
            parent.dataset.tempSl = tempId;
        } else {
            const span = document.createElement('span');
            span.dataset.tempSl = tempId;
            span.textContent = fullText;
            node.replaceWith(span);
        }

        // 2. DIVIDIR O TEXTO EM FRASES (REGEX INTELIGENTE)
        // Procura sequ√™ncias de texto que terminam em pontua√ß√£o (. ! ?) ou fim de linha
        // A Regex abaixo apanha: Texto + Pontua√ß√£o + Espa√ßo(opcional)
        const sentences = fullText.match(/[^.!?]+[.!?]+(\s|$)|[^.!?]+$/g) || [fullText];

        sentences.forEach((sentence) => {
            const cleanSentence = sentence.trim();
            if (cleanSentence.length < 2) return; // Ignora pontua√ß√£o solta

            const isLinked = parent.classList.contains('superlink-dotted') 
                             && parent.classList.contains('target') 
                             && parent.dataset.slId === activeId;

            const div = document.createElement('div');
            div.className = `sentence-item ${isLinked ? 'selected' : ''}`;
            div.style.cssText = "padding: 10px; border-bottom: 1px solid #444; cursor: pointer; color: white; display: block;";
            
            // DADOS CR√çTICOS PARA A GRAVA√á√ÉO
            div.dataset.targetTempId = tempId; // Onde est√° (n√≥ pai)
            div.dataset.sentenceText = cleanSentence; // O que √© (texto exato)

            let icon = "üìÑ";
            if (parent.closest('.question-mode')) icon = "üìó";
            else if (parent.tagName === 'H1' || parent.tagName === 'H2') icon = "üîπ";
            
            // Visual na lista (corta se for muito grande)
            div.innerHTML = `<span style="opacity:0.6; margin-right:8px;">${icon}</span>${cleanSentence.substring(0, 100)}${cleanSentence.length > 100 ? "..." : ""}`;
            
            div.onclick = () => {
                div.classList.toggle('selected');
                
                // Cria um objeto √∫nico para identificar esta sele√ß√£o espec√≠fica
                // (ID do Pai + Texto da Frase)
                const selectionData = {
                    tempId: tempId,
                    text: cleanSentence
                };
                
                // Verifica se j√° est√° no array (comparando strings JSON para facilidade)
                const selectionStr = JSON.stringify(selectionData);
                const idx = selectedSentenceNodes.findIndex(item => JSON.stringify(item) === selectionStr);

                if (div.classList.contains('selected')) {
                    div.style.backgroundColor = "rgba(74, 144, 226, 0.2)";
                    div.style.borderLeft = "3px solid #4a90e2";
                    if (idx === -1) selectedSentenceNodes.push(selectionData);
                } else {
                    div.style.backgroundColor = "transparent";
                    div.style.borderLeft = "none";
                    if (idx > -1) selectedSentenceNodes.splice(idx, 1);
                }
            };
            
            if (isLinked) {
                // Se j√° estava linkado, adiciona ao array de sele√ß√£o inicial
                 selectedSentenceNodes.push({ tempId: tempId, text: cleanSentence });
                 div.style.backgroundColor = "rgba(74, 144, 226, 0.2)";
                 div.style.borderLeft = "3px solid #4a90e2";
            }
            
            list.appendChild(div);
        });

        count++;
    }
    console.log(`‚úÖ Processado. ${count} blocos de texto analisados.`);
    console.groupEnd();
};


// Fun√ß√£o auxiliar para gerir o clique na lista
function setupSentenceClick(divElement, textNode) {
    divElement.onclick = () => {
        // 1. Alterna visual
        divElement.classList.toggle('selected');
        const isSelected = divElement.classList.contains('selected');

        // 2. Atualiza o array global
        if (isSelected) {
            // Adiciona se n√£o existir
            if (!selectedSentenceNodes.includes(textNode)) {
                selectedSentenceNodes.push(textNode);
            }
        } else {
            // Remove
            selectedSentenceNodes = selectedSentenceNodes.filter(n => n !== textNode);
        }
        
        console.log("Alvos selecionados:", selectedSentenceNodes.length);
    };
}

// 4. GRAVAR SUPERLINK (A MAGIA)
function saveSuperLink() {
    console.group("üíæ [SUPERLINK] Grava√ß√£o Frase-a-Frase...");

    const modal = document.getElementById('source-manager-modal');
    // Se for edi√ß√£o, usa o ID existente. Se for novo, gera um.
    const linkId = currentEditingSuperLinkId || `sl_${Date.now()}`;
    console.log(`üÜî ID do Link: ${linkId}`);

    let targetsCreated = 0;

    // 1. APLICA NOS ALVOS (Frases da lista)
    // selectedSentenceNodes agora √© um array de objetos: { tempId: "...", text: "Frase..." }
    
    // Filtra duplicados (para evitar erros se clicou duas vezes sem querer)
    // A fun√ß√£o findIndex compara se j√° existe um objeto com o mesmo ID tempor√°rio e o mesmo texto
    const uniqueSelections = selectedSentenceNodes.filter((v,i,a) => 
        a.findIndex(t => (t.tempId === v.tempId && t.text === v.text)) === i
    );
    
    console.log(`üéØ Frases a processar: ${uniqueSelections.length}`);
    
    uniqueSelections.forEach(selection => {
        const { tempId, text } = selection;
        
        // 1. Encontra o contentor pai onde a frase vive (marcado com ID tempor√°rio)
        const container = document.querySelector(`[data-temp-sl="${tempId}"]`);

        if (container) {
            // 2. Procura o n√≥ de texto exato que cont√©m a frase dentro do pai
            // Usamos TreeWalker porque o pai pode ter outros spans, links ou negritos misturados
            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
            let targetNode = null;
            
            while(targetNode = walker.nextNode()) {
                // Verifica se este peda√ßo de texto cont√©m a nossa frase
                if (targetNode.textContent.includes(text)) {
                    
                    // --- AQUI ACONTECE A MAGIA (RANGE) ---
                    // Criamos um intervalo de sele√ß√£o invis√≠vel √† volta apenas da frase
                    const range = document.createRange();
                    const startPos = targetNode.textContent.indexOf(text);
                    const endPos = startPos + text.length;
                    
                    try {
                        range.setStart(targetNode, startPos);
                        range.setEnd(targetNode, endPos);
                        
                        // Verifica se o pai imediato j√° √© um superlink (para evitar aninhar links)
                        const parent = targetNode.parentElement;
                        if (parent.classList.contains('superlink-dotted') && parent.textContent === text) {
                            // Se j√° √© um link, s√≥ atualiza o ID e garante que √© 'target'
                            parent.dataset.slId = linkId;
                            parent.classList.add('target');
                            parent.classList.remove('source');
                            console.log(`‚ÑπÔ∏è Atualizado link existente: "${text}"`);
                        } else {
                            // Se √© texto limpo, envolve num novo span picotado
                            const span = document.createElement('span');
                            span.className = "superlink-dotted target";
                            span.dataset.slId = linkId;
                            
                            // surroundContents remove o texto do n√≥ original e p√µe dentro do span
                            range.surroundContents(span);
                            console.log(`‚úÖ Criado novo link: "${text}"`);
                        }
                        targetsCreated++;
                        
                        // Sai do loop while assim que encontrar e processar a frase
                        break; 
                    } catch(e) {
                        console.warn(`‚ö†Ô∏è Erro ao envolver "${text}":`, e);
                        // Geralmente acontece se a frase estiver dividida por tags (ex: metade bold, metade normal)
                    }
                }
            }
            
            // Remove o ID tempor√°rio do pai (limpeza)
            container.removeAttribute('data-temp-sl');
        } else {
            console.warn(`‚ö†Ô∏è Contentor original ${tempId} n√£o encontrado.`);
        }
    });

    console.log(`‚úÖ Sucesso Total: ${targetsCreated} frases picotadas.`);

    // 2. APLICA NA ORIGEM (Apenas se for Novo)
    // Se for edi√ß√£o/repara√ß√£o, a origem j√° existe, n√£o mexemos nela
    if (!currentEditingSuperLinkId && currentSuperLinkRange) {
        console.log("üÜï Criando Origem (Pai)...");
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(currentSuperLinkRange);
        
        const html = `<span class="superlink-dotted source" data-sl-id="${linkId}">${currentSuperLinkRange.toString()}</span>`;
        document.execCommand('insertHTML', false, html);
    }

    // 3. LIMPEZA FINAL DE LIXO
    // Remove spans tempor√°rios vazios que possam ter sobrado da fun√ß√£o load
    // (ex: spans criados para envolver texto solto mas que n√£o foram selecionados)
    document.querySelectorAll('span[data-temp-sl]').forEach(el => {
        // Se for um span que cri√°mos s√≥ para isto (sem classe de link), desfazemo-lo
        if (el.tagName === 'SPAN' && !el.classList.contains('superlink-dotted')) {
            const parent = el.parentNode;
            while (el.firstChild) parent.insertBefore(el.firstChild, el);
            el.remove();
        } else {
            // Se for um elemento estrutural (p, div), s√≥ remove o atributo
            el.removeAttribute('data-temp-sl');
        }
    });

    // 4. AVISO DE ERRO
    if (targetsCreated === 0 && uniqueSelections.length > 0) {
        alert("Aviso: Algumas frases n√£o puderam ser vinculadas.\nO texto pode ter sido alterado ou estar dividido por formata√ß√£o complexa.");
    }

    // 5. GRAVAR NO FIREBASE
    if (typeof saveNote === 'function') {
        console.log("üíæ A enviar para a base de dados...");
        saveNote(true);
    }
    
    // Fechar modal e resetar vari√°veis
    modal.style.display = 'none';
    selectedSentenceNodes = [];
    currentEditingSuperLinkId = null;
    
    console.log("üèÅ Processo conclu√≠do.");
    console.groupEnd();
}



// 5. APAGAR SUPERLINK
function deleteSuperLink(linkId) {
    // Remove formata√ß√£o da Origem
    const sources = document.querySelectorAll(`.superlink-dotted.source[data-sl-id="${linkId}"]`);
    sources.forEach(unwrapElement);

    // Remove formata√ß√£o dos Alvos
    const targets = document.querySelectorAll(`.superlink-dotted.target[data-sl-id="${linkId}"]`);
    targets.forEach(unwrapElement);

    saveNote();
}

// Auxiliar para remover o span mas manter o texto
function unwrapElement(el) {
    const parent = el.parentNode;
    while (el.firstChild) parent.insertBefore(el.firstChild, el);
    parent.removeChild(el);
}

// 1. Fun√ß√£o auxiliar para remover o estilo (unwrap) mantendo o texto
function unwrapSuperLink(element) {
    const parent = element.parentNode;
    // Move o texto para fora do span
    while (element.firstChild) {
        parent.insertBefore(element.firstChild, element);
    }
    // Remove o span vazio
    element.remove();
    // Funde o texto para ficar limpo no HTML
    parent.normalize();
}

// 2. O Observador (O Guarda)
const superLinkObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        // Para cada n√≥ removido da p√°gina
        mutation.removedNodes.forEach((node) => {
            
            // Verifica se o que foi apagado era um Elemento HTML e se era uma ORIGEM (.source)
            if (node.nodeType === 1 && 
                node.classList.contains('superlink-dotted') && 
                node.classList.contains('source')) {
                
                const linkId = node.dataset.slId;
                console.log(`‚ôªÔ∏è [LIMPEZA] A origem do SuperLink foi apagada (ID: ${linkId}). Limpando as frases anexas...`);

                // Encontra todas as frases alvo (.target) que ficaram √≥rf√£s na p√°gina
                const orphans = document.querySelectorAll(`.superlink-dotted.target[data-sl-id="${linkId}"]`);
                
                orphans.forEach((orphan) => {
                    // Remove o estilo picotado imediatamente
                    unwrapSuperLink(orphan);
                });
                
                // Grava a nota para oficializar a limpeza
                if (typeof saveNote === 'function') saveNote();
            }
        });
    });
});

// 3. Ligar o motor
setTimeout(() => {
    const editor = document.getElementById('note-content-editor');
    if (editor) {
        superLinkObserver.observe(editor, { 
            childList: true,  // Vigia filhos diretos
            subtree: true     // Vigia tudo l√° dentro (profundidade)
        });
        console.log("üëÄ Vigilante de SuperLinks ativado.");
    }
}, 1000);




// 7. INTERA√á√ÉO DE CLIQUE (SCROLL)
document.getElementById('note-content-editor').addEventListener('click', (e) => {
    const target = e.target;
    
    // --- CEN√ÅRIO A: LINK NORMAL (üîó) ---
    const normalLink = target.closest('a[data-anexo-id]');
    if (normalLink) {
        e.preventDefault(); e.stopPropagation();
        openLinkModal(true, { id: normalLink.dataset.anexoId });
        return;
    }

    // --- CEN√ÅRIO B: SUPERLINK (üñáÔ∏è) ---
    const superLink = target.closest('.superlink-dotted');
    if (superLink) {
        e.preventDefault(); 
        e.stopPropagation();
        
        const id = superLink.dataset.slId;
        const isSource = superLink.classList.contains('source');
        let targetEl = null;

        if (isSource) {
            targetEl = document.querySelector(`.superlink-dotted.target[data-sl-id="${id}"]`);
        } else {
            targetEl = document.querySelector(`.superlink-dotted.source[data-sl-id="${id}"]`);
            if (!targetEl) {
                const allTargets = Array.from(document.querySelectorAll(`.superlink-dotted.target[data-sl-id="${id}"]`));
                const currentIndex = allTargets.indexOf(superLink);
                targetEl = allTargets[(currentIndex + 1) % allTargets.length];
                if (targetEl === superLink) targetEl = null; 
            }
        }
        
        if (targetEl) {
            // 1. LIMPEZA NUCLEAR (O FIX)
            // Remove o laranja de TODOS os superlinks na p√°gina imediatamente
            document.querySelectorAll('.superlink-dotted').forEach(el => {
                if (el.flashTimer) clearTimeout(el.flashTimer); // Cancela contagem
                el.flashTimer = null;
                el.style.transition = "none"; // Remove anima√ß√£o para limpar instantaneamente
                el.style.backgroundColor = "";
                el.style.color = "";
                el.style.boxShadow = "";
                el.style.borderRadius = "";
            });

            // 2. Scroll Suave
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 3. Aplica o Destaque no Novo Alvo
            // Pequeno delay para garantir que a limpeza acima foi processada visualmente
            requestAnimationFrame(() => {
                targetEl.style.backgroundColor = "#e67e22"; // Laranja
                targetEl.style.color = "white";
                targetEl.style.boxShadow = "0 0 15px rgba(230, 126, 34, 0.8)";
                targetEl.style.borderRadius = "3px";

                // Prepara a sa√≠da suave
                // Adicionamos a transi√ß√£o AP√ìS aplicar a cor, para o "fade out" funcionar depois
                setTimeout(() => {
                    targetEl.style.transition = "background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease";
                }, 50);

                // 4. Temporizador de 1 Segundo exato
                targetEl.flashTimer = setTimeout(() => { 
                    targetEl.style.backgroundColor = ""; 
                    targetEl.style.color = "";
                    targetEl.style.boxShadow = "";
                    targetEl.style.borderRadius = "";
                    
                    // Limpa a refer√™ncia
                    targetEl.flashTimer = null;
                    
                    // Limpa a transi√ß√£o do HTML depois do efeito acabar
                    setTimeout(() => { targetEl.style.transition = ""; }, 500);
                }, 1000); 
            });

        } else {
            // Repara√ß√£o (C√≥digo original mant√©m-se aqui)
       const fixIt = confirm("‚ö†Ô∏è Link √ìrf√£o.\nDeseja abrir o editor para ligar frases a ele?");
            if (fixIt) {
                const range = document.createRange();
                range.selectNodeContents(superLink);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                if (typeof window.openSourceManager === 'function') window.openSourceManager();
            }
        }
        return;
    }
});


window.addSourceUrlField = function(val = "") {
    const container = document.getElementById('source-urls-list');
    if (!container) return;

    const div = document.createElement('div');
    div.style.cssText = "display:flex; gap:5px; align-items:center;";
    
    div.innerHTML = `
        <input type="text" value="${val}" placeholder="https://..." class="source-url-input" 
               style="flex:1; padding:10px; background:var(--bg-color); border:1px solid var(--border-color); border-radius:4px; color:var(--text-color);">
        
        <button onclick="this.parentElement.remove()" tabindex="-1"
                style="color:#e74c3c; border:1px solid #e74c3c; background:rgba(231, 76, 60, 0.1); cursor:pointer; padding:0 12px; height:38px; border-radius:4px; font-weight:bold;">
            √ó
        </button>
    `;
    container.appendChild(div);
    
    // Foca no input se for novo (vazio)
    if (!val) {
        setTimeout(() => {
            const input = div.querySelector('input');
            if(input) input.focus();
        }, 50);
    }
};


async function saveStandardLink() {
    const modal = document.getElementById('source-manager-modal');
    const title = document.getElementById('source-link-name').value.trim();
    const inputs = document.querySelectorAll('.source-url-input');
    const urls = [];

    // 1. Recolhe URLs
    inputs.forEach(input => {
        let u = input.value.trim();
        if (u) {
            if (!u.startsWith('http')) u = 'https://' + u;
            urls.push(u);
        }
    });

    if (!title) return alert("Insira um nome para o link.");
    if (urls.length === 0) return alert("Insira pelo menos um URL.");

    // 2. Cria/Atualiza no DOM
    const selection = window.getSelection();
    let linkElement = null;

    // Se j√° existe um link selecionado, atualiza-o
    if (selection.anchorNode) {
        const node = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
        linkElement = node.closest('a[data-anexo-id]');
    }

    if (linkElement) {
        // ATUALIZAR
        linkElement.textContent = title;
        linkElement.href = urls[0]; // O href √© apenas o primeiro link (fallback)
        linkElement.dataset.json = encodeURIComponent(JSON.stringify(urls));
    } else {
        // CRIAR NOVO (Se houver sele√ß√£o guardada)
        if (currentSuperLinkRange) {
            selection.removeAllRanges();
            selection.addRange(currentSuperLinkRange);
            document.execCommand('createLink', false, urls[0]);
            
            // Encontra o link acabado de criar
            const newLink = selection.anchorNode.parentElement.closest('a');
            if (newLink) {
                newLink.textContent = title; 
                newLink.dataset.anexoId = 'lnk_' + Date.now(); 
                newLink.dataset.json = encodeURIComponent(JSON.stringify(urls));
                newLink.target = "_blank";
                newLink.style.color = "var(--accent-color)";
                newLink.style.textDecoration = "underline";
            }
        }
    }

    // 3. Grava e Fecha
    if (typeof saveNote === 'function') saveNote();
    modal.style.display = 'none';
}

// ============================================================
// FUN√á√ÉO EM FALTA: ABRIR VISUALIZADOR DE LINKS (TEXTO)
// ============================================================
window.openViewLinkModal = function(anexoId) {
    console.log("üîó A abrir visualizador de link:", anexoId);
    
    const modal = document.getElementById('view-link-modal');
    const list = document.getElementById('view-link-urls-list');
    const titleEl = document.getElementById('view-link-title');
    const editBtn = document.getElementById('view-link-edit-btn');
    
    if (!modal || !list) return console.error("Modal de visualiza√ß√£o n√£o encontrado.");

    // 1. Encontra o elemento no DOM para ler os dados
    const linkEl = document.querySelector(`a[data-anexo-id="${anexoId}"]`);
    if (!linkEl) return alert("Link n√£o encontrado no texto.");

    // 2. Prepara o conte√∫do
    titleEl.textContent = linkEl.textContent;
    list.innerHTML = '';
    
    try {
        const rawJson = linkEl.dataset.json || "[]";
        let urls = JSON.parse(decodeURIComponent(rawJson));
        
        // Compatibilidade com formatos antigos (objeto vs array)
        if (!Array.isArray(urls) && urls.urls) {
             urls = Object.values(urls.urls);
        } else if (!Array.isArray(urls)) {
             urls = [linkEl.href];
        }

        urls.forEach((url, idx) => {
            const li = document.createElement('li');
            li.style.cssText = "padding:12px; border-bottom:1px solid var(--border-color); cursor:pointer; display:flex; justify-content:space-between; align-items:center;";
            
            li.innerHTML = `
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <span style="font-weight:bold; font-size:0.9em; color:var(--text-color);">Op√ß√£o ${idx + 1}</span>
                    <span style="font-size:0.8em; color:var(--accent-color); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${url}</span>
                </div>
                <span style="font-size:1.2em;">‚Üó</span>
            `;
            
            li.onclick = () => window.open(url, '_blank');
            list.appendChild(li);
        });

        // 3. Configura bot√£o Editar
        if (editBtn) {
            // Remove listeners antigos
            const newEditBtn = editBtn.cloneNode(true);
            editBtn.parentNode.replaceChild(newEditBtn, editBtn);
            
            newEditBtn.onclick = () => {
                modal.style.display = 'none';
                // Abre o gestor em modo de edi√ß√£o
                if (typeof openSourceManager === 'function') {
                    // Seleciona o link visualmente para o gestor o apanhar
                    const range = document.createRange();
                    range.selectNode(linkEl);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                    
                    window.openSourceManager();
                }
            };
        }

        // 4. Mostra o modal
        document.body.appendChild(modal);
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.zIndex = "2147483647"; // Topo absoluto

    } catch (e) {
        console.error("Erro ao ler dados do link:", e);
        alert("Dados do link inv√°lidos.");
    }
};


// ============================================================
// üß† MOTOR DO AUTO-LINKER (ZERO READS)
// ============================================================

// Listener do Bot√£o M√°gico
document.getElementById('run-auto-linker-btn').addEventListener('click', (e) => {
    e.preventDefault();
    runAutoLinkerScanner();
});

function runAutoLinkerScanner() {
    const list = document.getElementById('auto-linker-results');
    const editor = document.getElementById('note-content-editor');
    
    if (!editor || !list) return;

    list.innerHTML = '<li style="padding:15px; text-align:center;"><div class="spinner"></div><br>A comparar...</li>';

    // 1. Preparar Candidatos (Tags e Entidades)
    let candidates = [];
    
    // A. Adiciona Tags Globais
    if (typeof allTags !== 'undefined') {
        allTags.forEach(tag => {
            candidates.push({ name: tag.nome, type: 'tag', id: tag.id });
        });
    }

    // B. Adiciona Entidades (EXCLUINDO 'textobiblico')
    Object.keys(allEntities).forEach(type => {
        
        // >>> AQUI EST√Å A CORRE√á√ÉO: Ignora textos b√≠blicos <<<
        if (type === 'textobiblico') return; 

        allEntities[type].forEach(ent => {
            candidates.push({ name: ent.nome, type: type, id: ent.id });
        });
    });

    // 2. Analisar Texto
    const textContent = editor.innerText.toLowerCase();
    const suggestions = [];
    const processedNames = new Set();

    candidates.forEach(cand => {
        const lowerName = cand.name.toLowerCase();
        
        // Crit√©rio: Ou est√° no texto, OU J√Å EST√Å GRAVADO NA NOTA
        const isPresentInText = textContent.includes(lowerName);
        const isAlreadySaved = currentNoteTags.includes(cand.name);

        if (isPresentInText || isAlreadySaved) {
            if (!processedNames.has(lowerName)) {
                suggestions.push({
                    ...cand,
                    isSaved: isAlreadySaved // Marca se j√° est√° ativo
                });
                processedNames.add(lowerName);
            }
        }
    });

    // 3. Renderizar
    list.innerHTML = '';

    if (suggestions.length === 0) {
        list.innerHTML = `<li style="padding: 20px; text-align: center; color: #888;">Nada encontrado.</li>`;
        return;
    }

    // Ordenar: Primeiro os ativos/guardados
    suggestions.sort((a, b) => (b.isSaved === a.isSaved) ? 0 : b.isSaved ? 1 : -1);

    suggestions.forEach(item => {
        const li = document.createElement('li');
        li.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);";
        
        // Se estiver guardado, fundo verde claro
        if (item.isSaved) {
            li.style.backgroundColor = "rgba(46, 204, 113, 0.1)";
        }

        let icon = item.type === 'tag' ? "üè∑Ô∏è" : "üîπ";
        
        // Bot√£o Din√¢mico
        const btnText = item.isSaved ? "‚úÖ Ativo" : "‚ú® Aplicar";
        const btnColor = item.isSaved ? "#2ecc71" : "var(--accent-color)";
        const btnBorder = item.isSaved ? "none" : "1px solid var(--accent-color)";

        li.innerHTML = `
            <div style="display:flex; flex-direction:column;">
                <span style="font-weight:bold; font-size:1em; color:var(--text-color);">${icon} ${item.name}</span>
                <small style="color:var(--text-muted-color); font-size:0.75em;">${item.type}</small>
            </div>
            <button class="modal-btn secondary action-btn" style="padding: 4px 12px; font-size: 0.85em; border: ${btnBorder}; color: ${btnColor}; background:transparent;">
                ${btnText}
            </button>
        `;

        // A√ß√£o do Bot√£o
  const btn = li.querySelector('.action-btn');
        btn.onclick = async () => {
            // Desabilita o bot√£o temporariamente para evitar duplo clique
            btn.disabled = true;
            
            // Chama a fun√ß√£o de toggle (agora ass√≠ncrona)
            await toggleTagState(item, btn, li);
            
            // Reabilita
            btn.disabled = false;
        };

        list.appendChild(li);
    });
}

// Fun√ß√£o para aplicar a sugest√£o no texto real
function applyAutoSuggestion(item) {
    const editor = document.getElementById('note-content-editor');
    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, {
        acceptNode: (node) => {
            if (node.parentElement.closest('.entity-link, .tag, a, button')) return NodeFilter.FILTER_REJECT;
            return NodeFilter.FILTER_ACCEPT;
        }
    });

    const regex = new RegExp(`\\b(${escapeRegExp(item.name)})\\b`, 'gi');
    let nodesToReplace = [];

    // Fase 1: Identificar n√≥s (n√£o podemos alterar enquanto caminhamos)
    let node;
    while (node = walker.nextNode()) {
        if (regex.test(node.textContent)) {
            nodesToReplace.push(node);
        }
    }

    // Fase 2: Substituir
    let appliedCount = 0;
    nodesToReplace.forEach(textNode => {
        const span = document.createElement('span');
        
        // Se for tag, usa estrutura de tag, sen√£o usa entity-link
        if (item.type === 'tag') {
            // Nota: Se a tag for "Jesus", o replace vai criar <span class="tag">#Jesus</span>
            // Adicionamos o # visualmente se n√£o existir
            const replacement = `<span class="tag" contenteditable="false">#$1</span>`;
            span.innerHTML = textNode.textContent.replace(regex, replacement);
        } else {
            const replacement = `<span class="entity-link" data-entity-type="${item.type}" data-entity-name="$1">$1</span>`;
            span.innerHTML = textNode.textContent.replace(regex, replacement);
        }

        // Substitui o n√≥ de texto pelo novo HTML (que pode conter m√∫ltiplos spans se a palavra aparecer 2x no mesmo n√≥)
        // Precisamos ter cuidado para n√£o perder texto √† volta.
        // O m√©todo mais seguro √© substituir o n√≥ pai se for simples, ou usar replaceWith
        
        // Estrat√©gia Segura: 
        // Como o innerHTML do span cont√©m o texto original todo com as substitui√ß√µes feitas,
        // podemos substituir o textNode por fragmentos.
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = span.innerHTML;
        
        const fragment = document.createDocumentFragment();
        while (tempDiv.firstChild) {
            fragment.appendChild(tempDiv.firstChild);
        }
        
        textNode.replaceWith(fragment);
        appliedCount++;
    });

    if (appliedCount > 0) {
        if (typeof saveNote === 'function') saveNote();
        
        // Se for entidade, atualiza a refer√™ncia na base de dados
        if (item.type !== 'tag') {
             // (Opcional: chamar a fun√ß√£o que atualiza o array de refer√™ncias no documento da entidade)
             // Como √© um processo local, podemos assumir que o "scan" do servidor tratar√° disso depois,
             // ou podemos for√ßar aqui se quiser perfei√ß√£o imediata.
             ensureEntityReference(item.type, item.name);
        }
    }
}

async function toggleTagState(item, btn, li) {
    const tagName = item.name;
    const index = currentNoteTags.indexOf(tagName);
    
    // --- 1. ALTERAR O ARRAY LOCAL ---
    if (index === -1) {
        // ATIVAR
        
        // Verifica/Cria a Tag Global se n√£o existir
        const tagExists = allTags.some(t => t.nome.toLowerCase() === tagName.toLowerCase());
        if (!tagExists && typeof createNewTag === 'function') {
            btn.textContent = "A criar tag...";
            await createNewTag(tagName);
        }

        currentNoteTags.push(tagName);
        
        // Atualiza Visual
        btn.textContent = "‚úÖ Ativo";
        btn.style.color = "#2ecc71";
        btn.style.border = "none";
        li.style.backgroundColor = "rgba(46, 204, 113, 0.1)";
        
        applyAutoSuggestion(item);

    } else {
        // DESATIVAR
        currentNoteTags.splice(index, 1);
        
        // Atualiza Visual
        btn.textContent = "‚ú® Aplicar";
        btn.style.color = "var(--accent-color)";
        btn.style.border = "1px solid var(--accent-color)";
        li.style.backgroundColor = "transparent";
    }

    // =========================================================
    // 2. GRAVAR IMEDIATAMENTE NA NOTA (O FIX)
    // =========================================================
    // Isto garante que se fechares e voltares, o estado est√° salvo no servidor.
    if (selectedNoteId) {
        console.log("üíæ [AUTO-SAVE] Gravando Tags atualizadas...");
        try {
            const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
            const noteRef = doc(db, 'pastas', selectedNoteId);
            
            await updateDoc(noteRef, {
                tags: currentNoteTags,
                ultimaedicao: serverTimestamp()
            });
            
            // Opcional: Atualiza o bot√£o Gravar principal para "Guardado" para dar feedback
            updateSaveStatus('saved');
            
        } catch (e) {
            console.error("Erro ao gravar tags:", e);
        }
    }
}

async function syncStatueCardsInCurrentNote() {
    const myRequestId = window.currentNavRequest;
    const startingNoteId = selectedNoteId;
    const editor = document.getElementById('note-content-editor');
    
    if (!editor) return;

    // 1. VERIFICAR SE EXISTEM EST√ÅTUAS PARA ATUALIZAR
    const statues = editor.querySelectorAll('.statue-card-wrapper');
    if (statues.length === 0) return;

    console.log(`üóø [SYNC START] Encontradas ${statues.length} est√°tuas. A ativar escudo...`);

    // ============================================================
    // üõ°Ô∏è ATIVAR ESCUDO DE BLOQUEIO (MODAL PRETO)
    // ============================================================
    const blockingModal = document.getElementById('forcing-save-modal');
    const loadingText = blockingModal ? blockingModal.querySelector('h3') : null;
    let originalText = "A Guardar...";

    if (blockingModal) {
        if (loadingText) {
            originalText = loadingText.textContent;
            loadingText.textContent = "A Sincronizar Est√°tuas..."; // Muda o texto para informar o user
        }
        
        // For√ßa bruta de visibilidade
        document.body.appendChild(blockingModal);
        blockingModal.style.setProperty('display', 'flex', 'important');
        blockingModal.style.setProperty('z-index', '2147483647', 'important');
        blockingModal.style.setProperty('opacity', '1', 'important');
        blockingModal.style.setProperty('visibility', 'visible', 'important');
    }
    // ============================================================

    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    let changesMade = false;

    try {
        // Processa cada est√°tua
        for (const statue of statues) {
            
            // Verifica√ß√£o de Seguran√ßa de Navega√ß√£o
            if (window.currentNavRequest !== myRequestId || selectedNoteId !== startingNoteId) {
                console.warn("üõë Navega√ß√£o detetada durante sync. Abortando.");
                return; // O modal ser√° limpo pela nova nota que est√° a abrir
            }

            const originNoteId = statue.dataset.originNote;
            const originBoxId = statue.dataset.originBox;

            if (!originNoteId || !originBoxId) continue;

            // Busca a nota original
            const originRef = doc(db, 'pastas', originNoteId);
            const originSnap = await getDoc(originRef);

            if (originSnap.exists()) {
                const originContent = originSnap.data().conteudo || "";
                
                // Parse do HTML original
                const parser = new DOMParser();
                const docDOM = parser.parseFromString(originContent, 'text/html');
                const originalBox = docDOM.getElementById(originBoxId);

                const lockContainer = statue.querySelector('.statue-content-lock');
                if (!lockContainer) continue;

                if (originalBox) {
                    // Extra√ß√£o de dados da origem
                    const titleInput = originalBox.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
                    const originTitle = titleInput ? (titleInput.value || titleInput.textContent || "").trim() : "";
                    
                    const bodyDiv = originalBox.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content, .cube-content');
                    const originBodyHTML = bodyDiv ? bodyDiv.innerHTML : "";

                    // Dados atuais no ecr√£
                    const currentTitleEl = lockContainer.querySelector('strong');
                    const currentTitle = currentTitleEl ? currentTitleEl.textContent.trim() : "";
                    
                    const currentBodyEl = lockContainer.querySelector('div');
                    const currentBodyHTML = currentBodyEl ? currentBodyEl.innerHTML : "";

                    // Compara√ß√£o (Remove espa√ßos para evitar falsos positivos)
                    const isTitleDiff = originTitle !== currentTitle;
                    const isBodyDiff = originBodyHTML.replace(/\s/g, '') !== currentBodyHTML.replace(/\s/g, '');

                    if (isTitleDiff || isBodyDiff) {
                        console.log(`üîÑ Atualizando Est√°tua: ${originTitle}`);

                        // Reconstr√≥i o HTML
                        const newInnerHtml = `
                            ${originTitle ? `<strong style="display:block; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:3px;">${originTitle}</strong>` : ''}
                            <div>${originBodyHTML}</div>
                        `;

                        lockContainer.innerHTML = newInnerHtml;
                        
                        // Flash visual Verde
                        statue.style.borderColor = "#2ecc71"; 
                        
                        changesMade = true;
                    }
                } else {
                    // Origem apagada
                    if (!lockContainer.innerHTML.includes('origem deste card foi eliminada')) {
                        lockContainer.innerHTML = "<em style='color:#e74c3c'>A origem deste card foi eliminada.</em>";
                        changesMade = true;
                    }
                }
            }
        }

        // ============================================================
        // GRAVA√á√ÉO DE SEGURAN√áA (Enquanto ainda est√° bloqueado)
        // ============================================================
        if (changesMade) {
            console.log("üíæ [SYNC] Altera√ß√µes aplicadas. Gravando no servidor...");
            if (loadingText) loadingText.textContent = "A Guardar Atualiza√ß√µes...";
            
            // For√ßa a grava√ß√£o imediata
            await saveNote(true);
            console.log("‚úÖ Grava√ß√£o conclu√≠da.");
        }

    } catch (e) {
        console.error("üî• Erro na Sync Est√°tuas:", e);
    } finally {
        // ============================================================
        // üîì DESATIVAR ESCUDO (LIBERTAR O UTILIZADOR)
        // ============================================================
        if (blockingModal) {
            // Pequeno delay para o utilizador ver que terminou
            setTimeout(() => {
                blockingModal.style.display = 'none';
                if (loadingText) loadingText.textContent = originalText; // Restaura texto original "A Guardar..."
                
                // Limpa o flash verde das est√°tuas
                document.querySelectorAll('.statue-card-wrapper').forEach(s => {
                     s.style.borderColor = "rgba(165, 105, 189, 0.3)";
                });
            }, 500);
        }
        console.log("üóø [SYNC END] Processo terminado.");
    }
}

async function findBoxDetailsById(targetBoxId) {
    try {
        const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Procura em todas as notas do utilizador
        // NOTA: Esta query pode ser pesada se tiver milhares de notas. 
        // Em produ√ß√£o real, usaria-se Algolia ou ElasticSearch.
        // Aqui, filtramos primeiro pelo 'userId' e 'ativa'.
        const q = query(
            collection(db, 'pastas'),
            where('userId', '==', auth.currentUser.uid),
            where('estado', '==', 'ativa'),
            where('tipo', '==', 'nota') // Apenas notas
        );

        const snapshot = await getDocs(q);
        
        // Itera sobre os documentos (no cliente) para encontrar o ID dentro do HTML
        for (const doc of snapshot.docs) {
            const content = doc.data().conteudo || "";
            
            // Verifica se o ID existe na string de conte√∫do
            if (content.includes(`id="${targetBoxId}"`)) {
                
                // Parse do HTML para extrair detalhes
                const parser = new DOMParser();
                const docDOM = parser.parseFromString(content, 'text/html');
                const box = docDOM.getElementById(targetBoxId);
                
                if (box) {
                    // Determina o T√≠tulo
                    const titleInput = box.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
                    let title = titleInput ? (titleInput.value || titleInput.textContent) : "Sem T√≠tulo";
                    
                    // Determina o Tipo
                    let type = "Caixa Gen√©rica";
                    if (box.classList.contains('question-mode')) type = "Quest√£o";
                    else if (box.classList.contains('free-mode')) type = "Contentor";
                    else if (box.classList.contains('redator-wrapper')) type = "Redator";
                    else if (box.tagName === 'DETAILS') type = "Toggle";

                    return {
                        id: targetBoxId,
                        title: title,
                        type: type,
                        noteId: doc.id,
                        noteName: doc.data().nome
                    };
                }
            }
        }
    } catch (e) {
        console.error("Erro na pesquisa de ID:", e);
    }
    return null; // N√£o encontrado
}

window.renderExistingAssociationsList = async function() {
    const container = document.getElementById('assoc-list-container');
    if (!container) return;
    
    const ids = window.tempAssociations || [];
    container.innerHTML = '';

    if (ids.length === 0) {
        container.innerHTML = '<small style="color:#888; font-style:italic;">Nenhuma associa√ß√£o.</small>';
        return;
    }

    ids.forEach(id => {
        const div = document.createElement('div');
        div.style.cssText = "background:var(--bg-color); border:1px solid var(--border-color); padding:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;";
        
        div.innerHTML = `
            <div style="display:flex; flex-direction:column; overflow:hidden;">
                <strong style="font-size:0.9em; color:var(--text-color);">üîó ${id}</strong>
                <small style="color:var(--text-muted-color); font-size:0.75em;" class="assoc-details-text">(A carregar...)</small>
            </div>
            
            <div style="display:flex; gap:8px;">
                <button class="btn-assoc-view" style="color:var(--accent-color); background:none; border:none; cursor:pointer; font-size:1.4em; padding:0 5px;" title="Ver Conte√∫do">üõ©Ô∏è</button>
                <button class="btn-assoc-remove" style="color:#e74c3c; background:none; border:none; cursor:pointer; font-size:1.4em; padding:0 5px;" title="Remover">√ó</button>
            </div>
        `;
        container.appendChild(div);

        // --- LISTENERS DOS BOT√ïES ---

        // 1. Remover com Confirma√ß√£o
        div.querySelector('.btn-assoc-remove').onclick = async (e) => {
            e.stopPropagation();
            const confirmModal = document.getElementById('confirm-modal');
            if(confirmModal) confirmModal.style.zIndex = '2147483650';

            const confirmed = await window.showConfirmation("Remover Associa√ß√£o?", "Esta caixa deixar√° de estar ligada √† atual.");
            
            if(confirmModal) confirmModal.style.zIndex = '';

            if (confirmed) window.removeAssociation(id);
        };

        // 2. Visualizar Conte√∫do (Popup Arrast√°vel)
        div.querySelector('.btn-assoc-view').onclick = async (e) => {
            e.stopPropagation();
            
            // Verifica se j√° est√° aberto
            const existingPopup = document.getElementById(`store-popup-${id}`);
            if (existingPopup) {
                if(typeof highestZIndex === 'undefined') highestZIndex = 30000000;
                existingPopup.style.zIndex = ++highestZIndex;
                return;
            }

            // Busca conte√∫do
            const btn = e.currentTarget;
            const originalIcon = btn.textContent;
            btn.textContent = "‚åõ"; // Feedback visual

            const details = await window.findBoxDetailsById(id);
            btn.textContent = originalIcon;
            
            if (details) {
                const popup = document.createElement('div');
                popup.className = 'aq-popup-window';
                popup.id = `store-popup-${id}`;
                
                if(typeof highestZIndex === 'undefined') highestZIndex = 30000000;
                const zIdx = ++highestZIndex;

                const randX = 50 + Math.floor(Math.random() * 100);
                const randY = 100 + Math.floor(Math.random() * 100);
                
                popup.style.cssText = `
                    position: fixed; z-index: ${zIdx}; 
                    top: ${randY}px; left: ${randX}px;
                    width: 400px; height: 350px;
                    background-color: rgba(30, 30, 35, 0.98);
                    border: 1px solid var(--accent-color);
                    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
                    border-radius: 8px;
                    display: flex; flex-direction: column; overflow: hidden;
                    animation: popIn 0.2s ease;
                `;

                // INJETA O CONTE√öDO EXTRA√çDO
                popup.innerHTML = `
                    <div class="aq-popup-header" style="padding:10px; background:rgba(255,255,255,0.05); border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; cursor:move; align-items:center;">
                        <span class="aq-popup-title" style="font-weight:bold; color:var(--accent-color); font-size:0.9em;">üìù ${details.title}</span>
                        <button onclick="this.closest('.aq-popup-window').remove()" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:1.2em;">‚úï</button>
                    </div>
                    
                    <div style="background:var(--bg-color); padding:5px 10px; font-size:0.75em; color:var(--text-muted-color); border-bottom:1px solid rgba(255,255,255,0.05);">
                        Local: ${details.noteName} (${details.type})
                    </div>

                    <div class="aq-popup-content" style="padding:15px; color:#e0e0e0; overflow-y:auto; flex-grow:1; line-height:1.5; white-space:pre-wrap;">
                        ${details.content}
                    </div>
                `;

                document.body.appendChild(popup);
                if (typeof makeElementDraggable === 'function') makeElementDraggable(popup);
                popup.onmousedown = () => { popup.style.zIndex = ++highestZIndex; };
            } else {
                alert("Erro: Conte√∫do n√£o encontrado na base de dados.");
            }
        };

        // Carrega o t√≠tulo na lista em background
        window.findBoxDetailsById(id).then(details => {
            if (details) {
                const infoDiv = div.querySelector('div');
                const titleSpan = infoDiv.querySelector('strong');
                const smallSpan = infoDiv.querySelector('.assoc-details-text');
                
                titleSpan.textContent = details.title;
                titleSpan.style.color = "var(--accent-color)";
                smallSpan.textContent = `${details.type} ‚Ä¢ ${details.noteName}`;
            }
        });
    });
};

window.removeAssociation = function(idToRemove) {
    window.tempAssociations = window.tempAssociations.filter(id => id !== idToRemove);
    renderExistingAssociationsList();
};

// --- FUN√á√ÉO AUXILIAR: ADICIONAR CAMPO DE URL ---
// (Necess√°ria para a aba "Refer√™ncias" funcionar)
window.addUrlField = function(urlValue = '') {
    const container = document.getElementById('link-urls-container');
    if (!container) return;

    const div = document.createElement('div');
    div.className = 'url-field-wrapper';
    // Align-items center garante alinhamento vertical
    div.style.cssText = "display:flex; gap:5px; align-items:center; margin-bottom:8px;";
    
    // 1. O Input (Altura fixa 42px)
    const input = document.createElement('input');
    input.type = "text";
    input.value = urlValue;
    input.placeholder = "https://...";
    input.className = "source-url-input"; 
    // box-sizing: border-box √© crucial para a altura incluir a borda
    input.style.cssText = "flex:1; height:42px; padding:0 12px; background:var(--bg-color); border:1px solid var(--border-color); border-radius:4px; color:var(--text-color); box-sizing:border-box;";
    
    // 2. O Bot√£o de Remover (Altura fixa 42px)
    const removeBtn = document.createElement('button');
    removeBtn.innerHTML = "√ó";
    removeBtn.tabIndex = -1;
    // Largura m√≠nima e altura iguais ao input
    removeBtn.style.cssText = "width:42px; height:42px; color:#e74c3c; border:1px solid #e74c3c; background:rgba(231, 76, 60, 0.1); cursor:pointer; border-radius:4px; font-weight:bold; font-size:20px; display:flex; align-items:center; justify-content:center; padding:0; box-sizing:border-box;";
    
    // 3. L√≥gica de Confirma√ß√£o
    removeBtn.onclick = async function() {
        // Truque de Z-Index: P√µe a confirma√ß√£o acima do modal de links (que tem z-index alto)
        const confirmModal = document.getElementById('confirm-modal');
        if(confirmModal) confirmModal.style.zIndex = "2147483650";

        const confirmed = await showConfirmation("Remover URL?", "Tem a certeza que deseja remover esta linha?");
        
        // Restaura Z-Index
        if(confirmModal) confirmModal.style.zIndex = "";

        if (confirmed) {
            div.remove();
        }
    };

    div.appendChild(input);
    div.appendChild(removeBtn);
    container.appendChild(div);
    
    // Foca no input se for novo
    if (!urlValue) {
        setTimeout(() => input.focus(), 50);
    }
};

// ============================================================
// FUN√á√ÉO EM FALTA: COPIAR PARA A √ÅREA DE TRANSFER√äNCIA
// ============================================================
window.copyToClipboard = function(text) {
    // Usa a API moderna de Clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            console.log("üìã ID copiado:", text);
            
            // Feedback Visual Simples (sem bloquear o ecr√£)
            const btn = document.activeElement; // O bot√£o que foi clicado
            if (btn && btn.tagName === 'BUTTON') {
                const originalText = btn.textContent;
                btn.textContent = "‚úÖ";
                setTimeout(() => btn.textContent = originalText, 1500);
            }
            
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            alert("N√£o foi poss√≠vel copiar automaticamente.");
        });
    } else {
        // Fallback para navegadores antigos ou contextos n√£o seguros
        // (Cria uma √°rea de texto tempor√°ria, seleciona e copia)
        let textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            const btn = document.activeElement;
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = "‚úÖ";
                setTimeout(() => btn.textContent = originalText, 1500);
            }
        } catch (err) {
            console.error('Erro ao copiar (fallback):', err);
        }
        
        document.body.removeChild(textArea);
    }
};

// ============================================================
// FUN√á√ÉO EM FALTA: PROCURAR DETALHES DA CAIXA POR ID
// ============================================================
window.findBoxDetailsById = async function(targetBoxId) {
    console.log(`üîç A procurar ID: ${targetBoxId} em TODA a base de dados...`);

    if (!auth.currentUser) return null;

    try {
        const { collection, query, where, getDocs, collectionGroup } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const myUid = auth.currentUser.uid;
        
        // --- FUN√á√ÉO AUXILIAR DE PARSE HTML ---
        // Extrai t√≠tulo e tipo do HTML encontrado
        const parseBoxInfo = (contentHtml, parentDocId, parentDocName, isPost = false) => {
            const parser = new DOMParser();
            const docDOM = parser.parseFromString(contentHtml, 'text/html');
            const box = docDOM.getElementById(targetBoxId);

            if (box) {
                // 1. TIPO
                let type = "Caixa Gen√©rica";
                if (box.classList.contains('question-mode')) type = "Quest√£o";
                else if (box.classList.contains('mini-note-wrapper')) { 
                    if (box.classList.contains('free-mode')) type = "Contentor";
                    else if (box.classList.contains('statue-card-wrapper')) type = "Est√°tua";
                    else type = "SubNota";
                } 
                else if (box.classList.contains('redator-wrapper')) type = "Redator"; 
                else if (box.classList.contains('journal-sign-wrapper')) type = "Racioc√≠nio";
                else if (box.classList.contains('journal-id-card')) type = "Cart√£o";
                else if (box.classList.contains('journal-cube-wrapper')) type = "Cubo";
                else if (box.tagName === 'DETAILS') type = "Sec√ß√£o";

                // 2. T√çTULO
                const titleInput = box.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2, strong');
                let title = titleInput ? (titleInput.value || titleInput.textContent || "").trim() : "";

                // T√≠tulo Fallback (conte√∫do)
                if (!title) {
                    const contentDiv = box.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content, .cube-content');
                    if (contentDiv) {
                        const text = contentDiv.innerText.replace(/\s+/g, ' ').trim();
                        title = text.substring(0, 15) + (text.length > 15 ? "..." : "");
                    }
                }
                if (!title) title = "Sem T√≠tulo";

                // 3. CONTE√öDO (Para o popup de preview)
                let bodyHTML = "";
                const contentDiv = box.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content, .cube-content');
                if (contentDiv) bodyHTML = contentDiv.innerHTML;
                else bodyHTML = "<em style='color:#888'>Conte√∫do n√£o textual.</em>";

                return {
                    id: targetBoxId,
                    title: title,
                    content: bodyHTML,
                    type: type,
                    noteId: parentDocId,
                    noteName: parentDocName + (isPost ? " (Post)" : "") // Indica se vem de um post
                };
            }
            return null;
        };

        // =========================================================
        // FASE 1: PROCURAR EM NOTAS, JORNAIS E AQU√ÅRIOS (Conte√∫do Direto)
        // =========================================================
        const qMain = query(
            collection(db, 'pastas'),
            where('userId', '==', myUid),
            where('estado', '==', 'ativa'),
            where('tipo', 'in', ['nota', 'jornal', 'aquario']) 
        );

        const snapMain = await getDocs(qMain);
        
        for (const doc of snapMain.docs) {
            const content = doc.data().conteudo || "";
            // Verifica√ß√£o r√°pida de string antes de parsear HTML (Performance)
            if (content.includes(`id="${targetBoxId}"`)) {
                const result = parseBoxInfo(content, doc.id, doc.data().nome);
                if (result) return result;
            }
        }

        // =========================================================
        // FASE 2: PROCURAR EM ARQUIVOS (Cole√ß√£o de Posts)
        // =========================================================
        // Usamos collectionGroup para procurar em TODAS as sub-cole√ß√µes 'posts'
        // independentemente de qual arquivo pertencem.
        const qPosts = query(
            collectionGroup(db, 'posts'),
            where('userId', '==', myUid)
        );

        const snapPosts = await getDocs(qPosts);
        
        for (const postDoc of snapPosts.docs) {
            const postData = postDoc.data();
            const content = postData.content || "";

            if (content.includes(`id="${targetBoxId}"`)) {
                // Para saber o nome do Arquivo pai, precisamos de subir na refer√™ncia
                // postDoc.ref.parent.parent -> Documento da Pasta/Arquivo
                const parentArchiveRef = postDoc.ref.parent.parent; 
                let archiveName = "Arquivo";
                
                // Tenta obter o nome do arquivo pai (opcional, pode ser lento, usamos cache ou gen√©rico)
                // Para ser r√°pido, usamos o t√≠tulo do Post como refer√™ncia principal
                const contextName = postData.title || "Post Sem T√≠tulo";

                const result = parseBoxInfo(content, parentArchiveRef.id, contextName, true);
                if (result) return result;
            }
        }

    } catch (e) {
        console.error("‚ùå Erro na pesquisa profunda de ID:", e);
    }
    
    return null; // N√£o encontrado
};

// ============================================================
// FUN√á√ÉO DE LIMPEZA DE POPUPS (GLOBAL)
// ============================================================
window.closeAllFloatingPopups = function() {
    console.log("üßπ [LIMPEZA] Fechando todas as janelas flutuantes...");

    // 1. Fecha Janelas Flutuantes (Associa√ß√µes e Redatores)
    document.querySelectorAll('.aq-popup-window, .redator-popup-window').forEach(popup => {
        popup.remove();
    });

    // 2. Esconde Modais de Sistema
    const systemModals = [
        'link-modal', 
        'share-settings-popup', 
        'selection-popup', 
        'insertion-popup', 
        'idea-actions-popup',
        'table-tools-popup'
    ];
    
    systemModals.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // 3. Reseta listas de controlo
    if (typeof window.activeRedatorPopups !== 'undefined') window.activeRedatorPopups = [];
    if (typeof window.activeStorePopups !== 'undefined') window.activeStorePopups = [];
    
    // 4. Desbloqueia blocos que estavam abertos em janelas
    document.querySelectorAll('.locked-popup').forEach(el => {
        el.classList.remove('locked-popup');
        el.setAttribute('contenteditable', 'true');
    });
};

// ============================================================
// FUN√á√ÉO: ATUALIZA√á√ÉO BIDIRECIONAL DE ASSOCIA√á√ïES
// ============================================================
window.updateRemoteAssociations = async function(currentBoxId, associationList) {
    if (!associationList || associationList.length === 0) return;

    console.log(`üîó [ASSOC] A criar liga√ß√µes rec√≠procas para ${currentBoxId}...`);

    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Itera sobre cada ID que foi associado (ex: Caixa B, Caixa C...)
        for (const remoteId of associationList) {
            
            // 1. VERIFICA√á√ÉO LOCAL: Se a caixa remota estiver no ecr√£ agora
            const localBox = document.getElementById(remoteId);
            if (localBox) {
                console.log(`   ‚Ü≥ Atualizando localmente: ${remoteId}`);
                let localData = {};
                try { localData = JSON.parse(localBox.getAttribute('data-box-links') || '{}'); } catch(e){}
                
                if (!localData.associations) localData.associations = [];
                
                if (!localData.associations.includes(currentBoxId)) {
                    localData.associations.push(currentBoxId);
                    localBox.setAttribute('data-box-links', JSON.stringify(localData));
                    if (typeof updateBoxLinkButtonState === 'function') updateBoxLinkButtonState(localBox);
                }
                continue; // Passa para o pr√≥ximo ID
            }

            // 2. VERIFICA√á√ÉO REMOTA: Se a caixa estiver noutra nota
            const remoteBoxDetails = await window.findBoxDetailsById(remoteId);
            
            if (remoteBoxDetails && remoteBoxDetails.noteId) {
                // Determina se √© uma Nota ou um Arquivo (via parent collection)
                // O findBoxDetailsById retorna noteId. Assumimos cole√ß√£o 'pastas'.
                const remoteNoteRef = doc(db, 'pastas', remoteBoxDetails.noteId);
                const remoteSnap = await getDoc(remoteNoteRef);

                if (remoteSnap.exists()) {
                    let content = remoteSnap.data().conteudo || "";
                    let isPostUpdate = false;
                    let targetPostId = null;

                    // Se n√£o encontrou no conte√∫do principal, verifica se √© um Arquivo com Posts
                    if (!content.includes(`id="${remoteId}"`) && remoteSnap.data().posts) {
                         // Procura nos posts (Arquivos antigos ou estrutura h√≠brida)
                         // Nota: A fun√ß√£o findBoxDetailsById moderna j√° lida com posts, mas aqui precisamos saber ONDE escrever.
                         // Se for um sistema de posts em sub-cole√ß√£o, ter√≠amos de ir l√° buscar.
                         // Para simplificar: Este c√≥digo funciona garantidamente em Notas Normais.
                    }

                    // Parse do HTML da nota remota
                    const parser = new DOMParser();
                    const docDOM = parser.parseFromString(content, 'text/html');
                    const remoteBoxEl = docDOM.getElementById(remoteId);

                    if (remoteBoxEl) {
                        // 3. L√™ os dados atuais da caixa remota
                        let remoteData = {};
                        try {
                            remoteData = JSON.parse(remoteBoxEl.getAttribute('data-box-links') || '{}');
                        } catch(e) {}

                        // Garante que existe o array de associa√ß√µes
                        if (!remoteData.associations) remoteData.associations = [];

                        // 4. Adiciona o NOSSO ID l√° (se ainda n√£o tiver)
                        if (!remoteData.associations.includes(currentBoxId)) {
                            remoteData.associations.push(currentBoxId);
                            
                            // Atualiza o atributo HTML na c√≥pia virtual
                            // Usamos setAttribute com JSON stringify
                            // IMPORTANTE: encodeURIComponent n√£o √© necess√°rio aqui pois o DOM trata disso, 
                            // mas ao gravar de volta como string HTML, as aspas s√£o escapadas automaticamente.
                            // Para seguran√ßa m√°xima, usamos replace das aspas simples para HTML entities se necess√°rio, 
                            // mas o JSON.stringify padr√£o costuma funcionar bem dentro de aspas simples se escaparmos.
                            
                            // A forma mais segura de injetar JSON em atributo HTML:
                            remoteBoxEl.setAttribute('data-box-links', JSON.stringify(remoteData).replace(/"/g, '&quot;'));
                            
                            // Reconstr√≥i o HTML do corpo da nota
                            const newContent = docDOM.body.innerHTML;
                            
                            // Grava no Firebase sem mexer no resto da nota
                            await updateDoc(remoteNoteRef, { conteudo: newContent });
                            console.log(`‚úÖ [ASSOC] Liga√ß√£o criada remotamente em ${remoteId} (Nota: ${remoteBoxDetails.noteName})`);
                        }
                    }
                }
            }
        }
    } catch (e) {
        console.error("‚ùå Erro ao criar associa√ß√µes remotas:", e);
    }
};

// ============================================================
// FUN√á√ÉO: LIMPEZA DE ASSOCIA√á√ïES ORF√ÉS (AO APAGAR)
// ============================================================
window.cleanDeadAssociations = async function(deadBoxId, associationList) {
    if (!associationList || associationList.length === 0) return;

    console.log(`üßπ [LIMPEZA] Removendo refer√™ncias √† caixa morta: ${deadBoxId}`);

    try {
        const { doc, getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

        for (const remoteId of associationList) {
            const remoteBoxDetails = await window.findBoxDetailsById(remoteId);
            
            if (remoteBoxDetails && remoteBoxDetails.noteId) {
                const remoteNoteRef = doc(db, 'pastas', remoteBoxDetails.noteId);
                const remoteSnap = await getDoc(remoteNoteRef);

                if (remoteSnap.exists()) {
                    const content = remoteSnap.data().conteudo || "";
                    const parser = new DOMParser();
                    const docDOM = parser.parseFromString(content, 'text/html');
                    const remoteBoxEl = docDOM.getElementById(remoteId);

                    if (remoteBoxEl) {
                        let remoteData = {};
                        try {
                            remoteData = JSON.parse(remoteBoxEl.getAttribute('data-box-links') || '{}');
                        } catch(e) {}

                        if (remoteData.associations && remoteData.associations.includes(deadBoxId)) {
                            // Remove o ID morto
                            remoteData.associations = remoteData.associations.filter(id => id !== deadBoxId);
                            
                            remoteBoxEl.setAttribute('data-box-links', JSON.stringify(remoteData));
                            
                            await updateDoc(remoteNoteRef, { conteudo: docDOM.body.innerHTML });
                            console.log(`‚úÖ [LIMPEZA] Removido de ${remoteId}`);
                        }
                    }
                }
            }
        }
    } catch (e) {
        console.error("‚ùå Erro na limpeza de associa√ß√µes:", e);
    }
};

window.previewReferenceNote = async function(noteId, encodedNoteName) {
    const noteName = decodeURIComponent(encodedNoteName);
    
    // 1. Fechar popup antigo se existir (garante apenas um aberto)
    const existingPopup = document.getElementById('ref-preview-popup');
    if (existingPopup) existingPopup.remove();

    // 2. Criar HTML do Popup
    const popup = document.createElement('div');
    popup.id = 'ref-preview-popup';
    popup.className = 'ref-preview-popup';
    
    popup.innerHTML = `
        <div class="ref-preview-header">
            <span>üìÑ ${noteName}</span>
            <button onclick="this.closest('.ref-preview-popup').remove()" 
                    style="background:none; border:none; color:var(--text-muted-color); font-size:24px; cursor:pointer;">
                &times;
            </button>
        </div>
        <div class="ref-preview-body">
            <div class="spinner-container">
                <div class="spinner"></div>
                <span>A carregar conte√∫do...</span>
            </div>
        </div>
    `;

    document.body.appendChild(popup);

    // 3. Buscar Conte√∫do no Firestore
    try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        const docRef = doc(db, 'pastas', noteId);
        const docSnap = await getDoc(docRef);

        const bodyDiv = popup.querySelector('.ref-preview-body');

        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Verifica se est√° protegida
            if (data.passe && data.passe.trim() !== "") {
                 bodyDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">üîí Esta nota est√° protegida por palavra-passe.</div>';
            } else if (data.conteudo) {
                // Injeta o HTML da nota
                bodyDiv.innerHTML = data.conteudo;
                
                // Limpeza visual: remove editabilidade para ser apenas leitura
                bodyDiv.querySelectorAll('[contenteditable]').forEach(el => {
                    el.removeAttribute('contenteditable');
                });
                
                // Scroll para o topo
                bodyDiv.scrollTop = 0;
            } else {
                bodyDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Nota vazia.</div>';
            }
        } else {
            bodyDiv.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Nota n√£o encontrada.</div>';
        }
    } catch (e) {
        console.error("Erro ao carregar preview:", e);
        const bodyDiv = popup.querySelector('.ref-preview-body');
        if(bodyDiv) bodyDiv.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Erro de conex√£o.</div>';
    }
};


window.previewReferenceBox = function(encodedSnippet, typeName) {
    // 1. Fechar popup antigo
    const existingPopup = document.getElementById('ref-preview-popup');
    if (existingPopup) existingPopup.remove();

    // 2. Preparar Conte√∫do
    let snippetHTML = decodeURIComponent(encodedSnippet);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = snippetHTML;

    const titleEl = tempDiv.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
    let cleanTitle = titleEl ? (titleEl.value || titleEl.textContent) : "Sem T√≠tulo";
    cleanTitle = cleanTitle.trim();

    const bodyEl = tempDiv.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content, .cube-content');
    let cleanContent = bodyEl ? bodyEl.innerHTML : tempDiv.innerHTML;

    if (!bodyEl) {
        cleanContent = cleanContent.replace(/<button.*?>.*?<\/button>/g, "");
        cleanContent = cleanContent.replace(/<div class="mini-note-toolbar".*?>.*?<\/div>/g, "");
    }
    cleanContent = cleanContent.replace(/^(<p><br><\/p>|<br>|\s)+/i, "");

    // 3. Criar Popup
    const popup = document.createElement('div');
    popup.id = 'ref-preview-popup';
    popup.className = 'ref-preview-popup';
    
    // Z-Index Inicial (M√°ximo)
    popup.style.zIndex = "2147483650";

    // *** CORRE√á√ÉO DO Z-INDEX AO CLICAR ***
    // Isto impede que ele v√° para tr√°s quando clica para arrastar
    popup.onmousedown = function() {
        this.style.zIndex = "2147483650";
    };

    popup.innerHTML = `
        <div class="ref-preview-header">
            <span class="ref-preview-title">üëÅ ${typeName}</span>
            <button onclick="this.closest('.ref-preview-popup').remove()" 
                    style="background:none; border:none; color:#e74c3c; font-size:1.2em; cursor:pointer; font-weight:bold;">
                ‚úï
            </button>
        </div>
        
        <div class="ref-preview-body">
            <div class="preview-clean-title">${cleanTitle}</div>
            <div class="preview-clean-text">${cleanContent}</div>
        </div>
    `;

    // 4. Inserir no DOM (Invis√≠vel primeiro para calcular tamanho)
    popup.style.opacity = '0';
    document.body.appendChild(popup);

    // 5. C√ÅLCULO DE CENTRALIZA√á√ÉO PERFEITA (MATEM√ÅTICA)
    // Evita o "salto" do canto para o meio
    const width = popup.offsetWidth;
    const height = popup.offsetHeight;
    const screenW = window.innerWidth;
    const screenH = window.innerHeight;

    const leftPos = (screenW / 2) - (width / 2);
    const topPos = (screenH / 2) - (height / 2);

    popup.style.left = leftPos + 'px';
    popup.style.top = topPos + 'px';
    
    // Torna vis√≠vel agora que est√° posicionado
    popup.style.opacity = '1';

    // 6. Ativar Arrasto
    if (typeof makeElementDraggable === 'function') {
        makeElementDraggable(popup);
    }

    // 7. Bloquear edi√ß√£o visual nos inputs clonados
    const body = popup.querySelector('.ref-preview-body');
    body.querySelectorAll('input, textarea').forEach(el => {
        el.setAttribute('readonly', 'true');
        el.style.border = "1px solid rgba(255,255,255,0.1)";
        el.style.background = "rgba(0,0,0,0.2)";
        el.style.color = "#ccc";
        el.style.pointerEvents = "none";
    });
    body.querySelectorAll('[contenteditable]').forEach(el => {
        el.setAttribute('contenteditable', 'false');
    });
};

// ============================================================
// FUN√á√ÉO: POPUP DE PREVIEW DO CART√ÉO (‚á±)
// ============================================================
window.openCardPopup = function(btn) {
    // 1. Encontrar o cart√£o pai
    const card = btn.closest('.board-card');
    if (!card) return;

    // 2. Extrair dados
    const noteName = card.dataset.noteName || "Nota Desconhecida";
    let snippetHTML = "";
    let title = "Refer√™ncia";
    let typeLabel = "Conte√∫do";

    try {
        const raw = card.dataset.snippet || "";
        snippetHTML = decodeURIComponent(raw);
    } catch (e) {
        snippetHTML = card.dataset.snippet || "";
    }

    // 3. Parse e Limpeza do HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = snippetHTML;

    // Tenta encontrar o t√≠tulo
    const titleInput = tempDiv.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2');
    if (titleInput) title = titleInput.value || titleInput.textContent;

    // Tenta encontrar o corpo
    const contentDiv = tempDiv.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content, .cube-content');
    
    let cleanBody = "";
    if (contentDiv) {
        cleanBody = contentDiv.innerHTML;
        
        // Identifica tipo
        if (snippetHTML.includes('question-mode')) typeLabel = "Quest√£o";
        else if (snippetHTML.includes('redator-wrapper')) typeLabel = "Redator";
        else if (snippetHTML.includes('free-mode')) typeLabel = "Contentor";
        else if (snippetHTML.includes('statue-card-wrapper')) typeLabel = "Est√°tua";
        else typeLabel = "Bloco";
    } else {
        // Fallback
        cleanBody = tempDiv.innerHTML; 
        if (card.classList.contains('type-text')) typeLabel = "Texto Livre";
        if (snippetHTML.includes('bible-card-mica')) typeLabel = "B√≠blia";
    }

    // ============================================================
    // üßπ ZONA DE LIMPEZA DO GAP (O C√ìDIGO NOVO)
    // ============================================================
    
    // 1. Remove a barra de ferramentas se tiver vindo junto
    cleanBody = cleanBody.replace(/<div class="mini-note-toolbar".*?>.*?<\/div>/g, "");
    cleanBody = cleanBody.replace(/<button.*?<\/button>/g, "");

    // 2. Remove par√°grafos vazios e quebras de linha do IN√çCIO da string
    // Remove: <p><br></p>, <br>, espa√ßos, <p></p>
    cleanBody = cleanBody.replace(/^(<p><br><\/p>|<p>&nbsp;<\/p>|<p>\s*<\/p>|<br>|\s)+/i, "");
    
    // ============================================================

    // 4. Criar a Janela Flutuante
    const popup = document.createElement('div');
    popup.className = 'aq-popup-window';
    
    if (typeof highestZIndex === 'undefined') window.highestZIndex = 30000000;
    const zIdx = ++window.highestZIndex;
    
    // Posi√ß√£o aleat√≥ria ligeira para n√£o empilhar perfeitamente
    const randX = 100 + Math.floor(Math.random() * 40);
    const randY = 100 + Math.floor(Math.random() * 40);

    popup.style.cssText = `
        position: fixed; z-index: ${zIdx}; 
        top: ${randY}px; left: ${randX}px;
        width: 400px; height: 350px;
        background-color: rgba(30, 30, 35, 0.98);
        border: 1px solid var(--accent-color);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
        border-radius: 8px;
        display: flex; flex-direction: column; overflow: hidden;
        animation: popIn 0.2s ease;
    `;

    // INJE√á√ÉO DE ESTILO CSS PARA REMOVER MARGEM DO PRIMEIRO ELEMENTO
    const noGapStyle = `
        <style>
            #popup-body-${zIdx} > :first-child { margin-top: 0 !important; padding-top: 0 !important; }
            #popup-body-${zIdx} p { margin-bottom: 8px; } 
        </style>
    `;

    popup.innerHTML = `
        ${noGapStyle}
        <!-- CABE√áALHO -->
        <div class="aq-popup-header" style="padding:10px; background:rgba(255,255,255,0.05); border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; cursor:move; align-items:center;">
            <span class="aq-popup-title" style="font-weight:bold; color:var(--accent-color); font-size:0.9em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:280px;">
                üìù ${title}
            </span>
            <button onclick="this.closest('.aq-popup-window').remove()" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:1.2em;">‚úï</button>
        </div>
        
        <!-- BARRA DE CONTEXTO -->
        <div style="background:var(--bg-color); padding:5px 10px; font-size:0.75em; color:var(--text-muted-color); border-bottom:1px solid rgba(255,255,255,0.05);">
            Local: ${noteName} (${typeLabel})
        </div>

        <!-- CORPO (Com ID √∫nico para o CSS funcionar) -->
        <div id="popup-body-${zIdx}" class="aq-popup-content" style="padding:15px; color:#e0e0e0; overflow-y:auto; flex-grow:1; line-height:1.5; white-space:pre-wrap;">
            ${cleanBody}
        </div>
    `;

    document.body.appendChild(popup);
    
    if (typeof makeElementDraggable === 'function') makeElementDraggable(popup);
    popup.onmousedown = () => { popup.style.zIndex = ++window.highestZIndex; };
};

// ============================================================
// FUN√á√ÉO OTIMIZADA: PESQUISA CIR√öRGICA (GPS)
// ============================================================
window.findBoxDetailsById = async function(targetBoxId) {
    if (!auth.currentUser) return null;
    
    console.log(`üõ∞Ô∏è [GPS] Localizando ID: ${targetBoxId}...`);
    const myUid = auth.currentUser.uid;

    try {
        const { collection, query, where, getDocs, collectionGroup } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // --- TENTATIVA 1: PROCURAR EM NOTAS (Usando √çndice) ---
        // Esta query custa apenas o n√∫mero de documentos encontrados (geralmente 1)
        const qNotes = query(
            collection(db, 'pastas'),
            where('userId', '==', myUid),
            where('boxIds', 'array-contains', targetBoxId) // <--- A M√ÅGICA
        );

        const snapNotes = await getDocs(qNotes);

        if (!snapNotes.empty) {
            // Encontrou!
            const doc = snapNotes.docs[0];
            return parseBoxDetails(doc.data().conteudo, targetBoxId, doc.id, doc.data().nome, false);
        }

        // --- TENTATIVA 2: PROCURAR EM POSTS (Arquivos) ---
        // Procura em todas as sub-cole√ß√µes 'posts' que tenham este ID na lista
        const qPosts = query(
            collectionGroup(db, 'posts'),
            where('userId', '==', myUid),
            where('boxIds', 'array-contains', targetBoxId) // <--- A M√ÅGICA NOS POSTS
        );

        const snapPosts = await getDocs(qPosts);

        if (!snapPosts.empty) {
            const doc = snapPosts.docs[0];
            // Para posts, precisamos do nome do arquivo pai ou do t√≠tulo do post
            const postTitle = doc.data().title || "Post no Arquivo";
            // O parentId √© o ID do arquivo (pasta pai)
            const archiveId = doc.ref.parent.parent.id;
            
            return parseBoxDetails(doc.data().content, targetBoxId, archiveId, postTitle, true);
        }

    } catch (e) {
        console.error("‚ùå Erro na pesquisa GPS:", e);
        // Se der erro (ex: √≠ndice em falta), pode fazer fallback para a pesquisa lenta aqui
    }
    
    console.log("‚ùå ID n√£o encontrado (ou ainda n√£o indexado).");
    return null;
};

// Fun√ß√£o auxiliar para extrair t√≠tulo e tipo do HTML (para n√£o repetir c√≥digo)
function parseBoxDetails(html, id, noteId, noteName, isPost) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const box = doc.getElementById(id);

    if (box) {
        let type = "Caixa";
        if (box.classList.contains('question-mode')) type = "Quest√£o";
        else if (box.classList.contains('mini-note-wrapper')) type = "SubNota";
        else if (box.classList.contains('redator-wrapper')) type = "Redator";
        else if (box.classList.contains('journal-sign-wrapper')) type = "Racioc√≠nio";
        else if (box.classList.contains('journal-id-card')) type = "Cart√£o";
        else if (box.tagName === 'DETAILS') type = "Sec√ß√£o";

        const titleInput = box.querySelector('.mini-note-title-input, .redator-input, .sign-title-input, .card-title-input, h2, strong');
        let title = titleInput ? (titleInput.value || titleInput.textContent || "").trim() : "Sem T√≠tulo";
        
        let bodyHTML = "";
        const contentDiv = box.querySelector('.mini-note-content, .redator-content, .sign-content, .toggle-content, .card-desc-content');
        if (contentDiv) bodyHTML = contentDiv.innerHTML;

        return {
            id: id,
            title: title,
            content: bodyHTML,
            type: type,
            noteId: noteId,
            noteName: noteName + (isPost ? " (Post)" : "")
        };
    }
    return null;
}



// --- SCRIPT DE MIGRA√á√ÉO (Correr uma vez) ---
async function indexAllNotesForGPS() {
    console.log("üöÄ Iniciando indexa√ß√£o de todas as notas...");
    
    if (!auth.currentUser) return;
    const { collection, getDocs, writeBatch, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
    
    // 1. Buscar todas as notas
    const q = query(collection(db, 'pastas'), where('userId', '==', auth.currentUser.uid), where('tipo', 'in', ['nota', 'jornal', 'aquario']));
    const snapshot = await getDocs(q);
    
    const batchSize = 400; 
    let batch = writeBatch(db);
    let count = 0;
    let totalUpdated = 0;

    for (const docSnap of snapshot.docs) {
        const data = docSnap.data();
        
        // S√≥ processa se ainda n√£o tiver indexado ou se quiser for√ßar
        if (!data.boxIds) { 
            const ids = extractBoxIdsFromHTML(data.conteudo || "");
            
            if (ids.length > 0) {
                const ref = doc(db, 'pastas', docSnap.id);
                batch.update(ref, { boxIds: ids });
                count++;
                totalUpdated++;
            }
        }

        // Commit a cada 400 opera√ß√µes
        if (count >= batchSize) {
            await batch.commit();
            console.log(`üíæ Lote gravado: ${count} notas indexadas.`);
            batch = writeBatch(db);
            count = 0;
        }
    }

    if (count > 0) {
        await batch.commit();
    }
    
    console.log(`‚úÖ Indexa√ß√£o conclu√≠da! Total atualizado: ${totalUpdated} notas.`);
    alert("Indexa√ß√£o GPS conclu√≠da. A pesquisa r√°pida est√° ativa.");
}

// ============================================================
// SOLU√á√ÉO PROBLEMA 1: SINCRONIZAR CATEGORIAS (BIDIRECIONAL)
// ============================================================
async function syncCategoriesToFirestore(categories) {
    if (!categories || categories.length === 0 || !selectedNoteId) return;

    console.log("üîÑ [SYNC] A criar refer√™ncias inversas nas entidades...");

    // Importa√ß√£o necess√°ria para falar com a base de dados
    const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");

    // Fun√ß√£o para saber qual a tabela correta
    const getCollectionName = (type) => {
        if (type === 'personagem') return 'personagens';
        if (type === 'local') return 'locais';
        if (type === 'data') return 'datas';
        if (type === 'cosmos') return 'cosmos';
        if (type === 'subcosmos') return 'subcosmos';
        if (type === 'textobiblico' || type === 'bible_public') return 'textosbiblicos';
        if (type === 'tag') return 'tags';
        if (type === 'topico') return 'topicos';
        if (type === 'marcadores') return 'marcadores';
        return null; // Tipo desconhecido
    };

    // Percorre cada categoria escolhida (ex: David, Jerusal√©m)
    for (const cat of categories) {
        const collectionName = getCollectionName(cat.type);
        
        if (collectionName && cat.id) {
            try {
                const ref = doc(db, collectionName, cat.id);
                
                // Escreve na ficha da entidade que esta nota a est√° a usar
                // A sintaxe [`referencias.${selectedNoteId}`] cria ou atualiza esse campo espec√≠fico
                await updateDoc(ref, {
                    [`referencias.${selectedNoteId}`]: true
                });
                
                console.log(`‚úÖ Refer√™ncia criada em: ${cat.name} (${collectionName})`);
            } catch (e) {
                console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel atualizar ${cat.name}:`, e);
            }
        }
    }
}

window.renderAttachedCategories = function() {
    console.log("üé® [RENDER] A desenhar lista de categorias anexadas...");
    
    let list = document.getElementById('attached-categories-list');
    
    // --- CORRE√á√ÉO: SE A DIV N√ÉO EXISTE, CRIA-A ---
    // Isto acontece porque √†s vezes o HTML √© re-escrito e perde-se a div
    if (!list) {
        console.warn("‚ö†Ô∏è Contentor n√£o encontrado. A criar novo...");
        const boxContentCats = document.getElementById('box-content-categories');
        if (boxContentCats) {
            const label = boxContentCats.querySelectorAll('label')[0]; // "Categorias Anexadas:"
            list = document.createElement('div');
            list.id = 'attached-categories-list';
            list.style.cssText = "display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; min-height: 40px;";
            if (label) label.after(list);
            else boxContentCats.appendChild(list);
        } else {
            console.error("‚ùå Aba 'box-content-categories' n√£o existe no DOM.");
            return;
        }
    }

    list.innerHTML = '';
    
    // Verifica se h√° dados
    if (!window.selectedCategoriesForBox || window.selectedCategoriesForBox.length === 0) {
        console.log("‚ÑπÔ∏è Lista vazia.");
        list.innerHTML = '<span style="color:#666; font-size:0.85em; font-style:italic; padding:5px;">Nenhuma categoria selecionada.</span>';
        return;
    }

    console.log("üî¢ Itens a desenhar:", window.selectedCategoriesForBox.length);

    // Desenha os chips
    window.selectedCategoriesForBox.forEach(cat => {
        const chip = document.createElement('div');
        
        // Cores por tipo
        let color = "var(--selected-color)";
        if (cat.type === 'bible_public' || cat.type === 'textobiblico') color = "rgba(46, 204, 113, 0.2)";
        if (cat.type === 'personagem') color = "rgba(230, 126, 34, 0.2)";
        
        chip.style.cssText = `
            background: ${color}; 
            color: white; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.85em; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
        `;
        
        chip.innerHTML = `
            <span>${cat.name}</span> 
            <span class="remove-cat-btn" style="cursor:pointer; font-weight:bold; font-size:1.2em; opacity:0.7;">√ó</span>
        `;
        
        // Bot√£o Remover
        chip.querySelector('.remove-cat-btn').onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log("üóëÔ∏è Removendo:", cat.name);
            
            window.selectedCategoriesForBox = window.selectedCategoriesForBox.filter(c => c.id !== cat.id);
            window.renderAttachedCategories();
            
            // Atualiza os "+" na pesquisa se estiverem vis√≠veis
            const input = document.getElementById('category-search-input');
            if (input && input.value && typeof searchCategories === 'function') {
                 searchCategories(input.value); 
            }
        };
        
        list.appendChild(chip);
    });
};

// Fun√ß√£o para carregar e alternar subt√≥picos
window.toggleTopicTree = async function(topicId, topicName, container, iconElement) {
    // Alternar visibilidade
    const isClosed = container.style.display === 'none';
    
    if (isClosed) {
        // ABRIR
        container.style.display = 'block';
        if (iconElement) iconElement.style.transform = 'rotate(90deg)'; // Roda a seta para baixo
        
        // Se estiver vazio, carrega do Firebase
        if (container.innerHTML === '') {
            container.innerHTML = '<div style="padding:5px; color:#888; font-size:0.8em;">A carregar...</div>';
            
            try {
                const { collection, query, where, orderBy, getDocs } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                const q = query(
                    collection(db, 'subtopicos'), 
                    where('topicId', '==', topicId),
                    where('userId', '==', auth.currentUser.uid), 
                    orderBy('nome')
                );
                
                const snap = await getDocs(q);
                container.innerHTML = ''; // Limpa o loader
                
                if (snap.empty) {
                    container.innerHTML = '<div style="padding:5px; color:#666; font-style:italic; font-size:0.8em;">(Vazio)</div>';
                }

                snap.forEach(doc => {
                    const sub = doc.data();
                    if (sub.estado === 'desativa') return;

                    const subLi = document.createElement('div');
                    subLi.className = 'list-item subtopic-item';
                    subLi.style.padding = "8px 10px";
                    subLi.style.fontSize = "0.95em";
                    
                    // Metadados importantes para o bot√£o "+" saber quem √© o pai
                    subLi.setAttribute('data-id', doc.id);
                    subLi.setAttribute('data-type', 'subtopico');
                    subLi.setAttribute('data-name', sub.nome);
                    subLi.setAttribute('data-parent-id', topicId); // <--- O SEGREDO
                    subLi.setAttribute('data-parent-name', topicName);

                    subLi.innerHTML = `<span style="color:var(--text-muted-color);">--</span> ${sub.nome}`;

                    subLi.onclick = (e) => {
                        e.stopPropagation(); // N√£o dispara o clique do pai
                        
                        // Sele√ß√£o Visual
                        document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected', 'selected-red'));
                        subLi.classList.add(currentViewMode === 'shared' ? 'selected-red' : 'selected');

                        // Abre 4¬™ Coluna
                        showTopicReferencesPanel(doc.id, sub.nome, sub.descricao, 'subtopico');
                    };

                    container.appendChild(subLi);
                });

            } catch (e) {
                console.error("Erro ao carregar subt√≥picos:", e);
                container.innerHTML = '<div style="color:red; font-size:0.8em;">Erro.</div>';
            }
        }
    } else {
        // FECHAR
        container.style.display = 'none';
        if (iconElement) iconElement.style.transform = 'rotate(0deg)';
    }
};
// --- FUN√á√ïES DE CONTROLO DO CUBO ---

// 1. Redimensionar (Largura %)
window.resizeCube = function(btn, change) {
    const cube = btn.closest('.journal-cube-wrapper');
    // Obt√©m a largura atual (remove o % e converte para int)
    let currentW = parseInt(cube.style.width) || 45; // Padr√£o 45%
    
    let newW = currentW + change;
    if (newW < 20) newW = 20;   // M√≠nimo
    if (newW > 100) newW = 100; // M√°ximo

    cube.style.width = newW + '%';
    
    if (typeof saveNote === 'function') saveNote();
};

// 2. Rodar (Transform Rotate)
window.rotateCube = function(btn, degChange) {
    const cube = btn.closest('.journal-cube-wrapper');
    
    // Tenta ler a rota√ß√£o atual da string transform
    const transform = cube.style.transform || '';
    const match = transform.match(/rotate\((-?\d+)deg\)/);
    let currentDeg = match ? parseInt(match[1]) : 0;

    let newDeg = currentDeg + degChange;
    // Limite de sanidade (-15 a 15 graus para n√£o ficar ileg√≠vel)
    if (newDeg < -15) newDeg = -15;
    if (newDeg > 15) newDeg = 15;

    cube.style.transform = `rotate(${newDeg}deg)`;
    
    if (typeof saveNote === 'function') saveNote();
};


// ============================================================
// L√ìGICA DE ARRASTO MOBILE (F√çSICA DA B√çBLIA - V2)
// ============================================================
(function initMobilePanelPhysics() {
    const panel = document.getElementById('references-panel');
    if (!panel) return;

    let isDragging = false;
    let startY = 0;
    let startHeight = 0;
    let lastY = 0;
    let velocity = 0;

    // 1. IN√çCIO
    panel.addEventListener('touchstart', (e) => {
        // Permite arrastar pelo cabe√ßalho OU se o painel estiver minimizado (10%)
        const isHeader = e.target.closest('.panel-header');
        const isMinimized = panel.offsetHeight < window.innerHeight * 0.20;

        if (isHeader || isMinimized || e.target === panel) {
            isDragging = true;
            startY = e.touches[0].clientY;
            lastY = startY;
            startHeight = panel.offsetHeight;
            
            // Ativa modo f√≠sica (sem lag)
            panel.classList.add('is-dragging');
        }
    }, { passive: false });

    // 2. MOVIMENTO
    window.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        if (e.cancelable) e.preventDefault();

        const currentY = e.touches[0].clientY;
        velocity = currentY - lastY; // Calcula a velocidade do "arremesso"
        lastY = currentY;

        const delta = startY - currentY; // Positivo = Cima
        let newHeight = startHeight + delta;
        const screenH = window.innerHeight;

        // REQUISITO 3: Subir mais (at√© 100%)
        if (newHeight > screenH) newHeight = screenH;
        
        // Limite m√≠nimo durante o arrasto (para n√£o inverter)
        if (newHeight < 50) newHeight = 50; 

        panel.style.height = `${newHeight}px`;
    }, { passive: false });

    // 3. SOLTAR (DECIS√ÉO INTELIGENTE)
    window.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        panel.classList.remove('is-dragging'); // Reativa a anima√ß√£o suave

        const currentH = panel.offsetHeight;
        const screenH = window.innerHeight;

        // --- L√ìGICA DE DECIS√ÉO ---
        
        // A. Se atirou para baixo r√°pido OU est√° abaixo de 40%
        if (velocity > 10 || currentH < screenH * 0.40) {
            // REQUISITO 2: N√ÉO FECHA! FICA NOS 10% (Minimizado)
            // 12vh √© seguro para mostrar o cabe√ßalho e bot√µes
            panel.style.height = "12vh"; 
        } 
        // B. Se atirou para cima r√°pido OU est√° acima de 75%
        else if (velocity < -10 || currentH > screenH * 0.75) {
            // REQUISITO 3: MAXIMIZA (Quase tela toda)
            panel.style.height = "95vh";
        }
        // C. Caso contr√°rio (meio termo), vai para uma altura confort√°vel de leitura
        else {
            panel.style.height = "60vh";
        }
    });
})();

// REQUISITO 2: Fechar APENAS com o bot√£o X
const closeBtn = document.getElementById('references-panel-close-btn');
if (closeBtn) {
    // Remove listeners antigos para evitar conflitos
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

    newCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const panel = document.getElementById('references-panel');
        
        // Anima√ß√£o de sa√≠da: Desliza para baixo
        panel.style.transform = "translateY(100%)";
        
        // Espera a anima√ß√£o acabar e reseta
        setTimeout(() => {
            if (typeof hideReferencesPanel === 'function') {
                hideReferencesPanel();
            } else {
                panel.style.height = "0";
                document.querySelector('.notebook-container').classList.remove('references-panel-visible');
            }
        }, 300);
    });
}

    </script>
</body>
</html>
